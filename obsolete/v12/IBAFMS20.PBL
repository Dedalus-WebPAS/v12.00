. **********************************************************************
. * System    :   Accounting System                                    *
. * Program   :   IBAFMS20                                             *
. * Desc      :   General Accounting Enquiries                         *
. **********************************************************************
. * Date      :   17.10.1990                                           *
. * Author    :   Neeriem Dye (IBA)                                    *
. * Mods      :                                                        *
. **********************************************************************
. * V9.02.01  26.03.2003  Mike Laming  CAR 37206                       *
. *           Add calc. variables CALCVAR and CALCPVA for FMSENSCR     *
. *           - recompile for FMSENSCR                                 *
. * V9.02.00  03.05.2002 Glenn Saunders                                *
. *           Export to new release i.e. v9.02 from vf.09              *
. **********************************************************************
. * VF.01.02  19.09.2000 Charles Handaya                               *
. *           Add new feature of Date Search in Monthly Analysis Screen*
. *           srf 3535                                                 *
. * VF.01.01  04.07.2000 Sandra Barcham                                *
. *           Fix screen keys                                          *
. **********************************************************************
. * VF.00.04  05.01.2000 Charles Handaya                               *
. *           Recompiled for APSMASIO                                  *
. * VF.00.03  23.12.1999 Sandra Barcham                                *
. *           Recompiled for FMSCCAFD                                  *
. *           srf 646145                                               *
. * VF.00.02  24.11.1999 Charles Handaya                               *
. *           Show cents for Print option                              *
. *           srf 633977                                               *
. * VF.00.01  30.06.1999 Sandra Barcham                                *
. *           Use FMAMTYPE to determine stat not FMAMAYTD              *
. *           srf 645778                                               *
. **********************************************************************
.$$$$$$
.        PROGRAM IBAFMS20
.             open files and initialise variables
.             do program
.        END
.$$$$$$
. Standard FMS Accounting System Include
.---------------------------------------
          INC       FMSSTDDF
.
.==============================================================================
.FILE DESCRIPTION INCLUDES
.-------------------------
          INC       APSCEAFD/INC       * committed expenditure
          INC       APSCEBFD/INC       * committed expenditure
          INC       APSCIOFD/INC       * committed expenditure
          INC       APSMASFD/INC
          INC       APSORDFD/INC       * committed expenditure
          INC       APSPPDFD/INC
          INC       FMSBPFFD/INC
          INC       FMSAMAFD/INC       * account
          INC       FMSBNKFD/INC       * bank rec
          INC       FMSBTYFD/INC       * budget data
          INC       FMSBUDFD/INC       * budget data
          INC       FMSCHQFD/INC       * cheque
          INC       FMSCONFD/INC       * controlf
          INC       FMSCSAFD/INC
          INC       FMSDSFFD/INC       * dissection accrual summary file
          INC       FMSFPSFD/INC       * period summary file
          INC       FMSLMAFD/INC       * ledger
          INC       FMSLMCFD/INC       * ledger financial calendar
          INC       FMSSQUFD/INC       * enquiry security
          INC       FMSSBUFD/INC       * stat budget
          INC       FMSSMAFD/INC       * stat summary
          INC       FMSTRNFD/INC       * transaction
          INC       FMSUWPFD/INC       * wp file
          INC       FMSCODFD/INC       * codes file
          INC       FMSLMBFD/INC       * report
          INC       FMSONCFD/INC       * oncost code
          INC       FMSPRCFD/INC       * print code
          INC       FMSLEVFD/INC       * level code
          INC       FMSRSFFD/INC       * account report seq
          INC       FMSSTRFD/INC       * stats transactions
          INC       FMSTCFFD/INC       * total calc
          INC       FMSDISFD/INC       * dissection
          INC       FMSRESFD/INC       * responsibility
          INC       FMSCTRFD/INC       * cash transactions
          INC       FMSCCAFD/INC       * cost centre
          INC       FMSSBAFD/INC       * subjective
.
.==============================================================================
.LOCAL VARIABLE DEFINITION
.-------------------------
.-- New Variables for srf 125513 --
APEBOVER  FORM      1
APODOVER  FORM      1
APEBSKEY  DIM       26
APODSKEY  DIM       26  * Not Include Receival number
APCBSKEY  DIM      28
CALCPVA   FORM      5                  * needed for FMSENSCR           *I-f0901
CALCVAR   FORM     12.6                * needed for FMSENSCR           *I-f0901
COMDESC   DIM      26
COMRAISD  FORM     12                  * committed expenditure
COMRECVD  FORM     12                  * committed expenditure
COMRASP2  FORM     12.2                * committed expenditure
COMRECP2  FORM     12.2                * committed expenditure
LOMRAS    FORM     12.6  
LOMREC    FORM     12.6  
SKEY14    DIM       14                 * key save for Screen A
TWELVE    FORM     "12.00"
THIRTEEN  FORM     "13.00"
TAMTRAS   FORM     12.2
TAMTREC   FORM     12.2
DOMRAS    DIM       12
DOMREC    DIM       12
DOMRAISD  DIM       12                 * committed expenditure
DOMRECVD  DIM       12                 * committed expenditure
DOMRASP2  DIM       15                 * committed expenditure
DOMRECP2  DIM       15                 * committed expenditure
RDAPEB    FORM      1
.-- End of New Variables for srf 125513 --
.
FMSTMP01  FILE      ASCII,FIXED=70     * WP Holding File Def'n 1
FILENAM1  DIM       8
NAME1     INIT      "fmstm1"
.
FMSTMP02  FILE      ASCII,FIXED=70     * WP Holding File Def'n 2
FILENAM2  DIM       8
NAME2     INIT      "fmstm2"
.
CP        INIT      "cp "              * word processor variables
TXT       INIT      ".txt "
.WP        INIT      "wp "
.WPDAT     INIT      ".txt 999 7 -1 70 14"
WPSTAT    FORM       2
.
FMSA      INIT      "fmsa"             * stat transaction file prefix
FMSB      INIT      "fmsb"             * budget file prefix
FMSC      INIT      "fmsc"             * stat budget file prefix
FMSD      INIT      "fmsd"             * dissection file prefix
FMSP      INIT      "fmsp"             * period file prefix
FMSS      INIT      "fmss"             * stat summary file prefix
FMST      INIT      "fmst"             * transaction file prefix
FMSR      INIT      "fmsr"             * cash transaction file prefix
FMSZ      INIT      "fmsz"             * stats cash transaction file prefix
.
ABPDESC   INIT      "                 "
ABPDESC0  INIT      "Dollars Only"
ABPDESC1  INIT      "Dollars and Cents"
.
MAXITEMA  FORM      "18"               * maximum no. of items on screen A + 1
MAXITEMD  FORM      "14"               * maximum no. of items on screen D + 1
MAXITEME  FORM      "14"               * maximum no. of items on screen E + 1
MAXITEMH  FORM      "15"               * maximum no. of items on screen H + 1
MAXITEMI  FORM      "15"               * maximum no. of items on screen I + 1
MAXITEMP  FORM      "13"               * maximum no. of items on screen P + 1
MAXITEMY  FORM      "14"               * maximum no. of items on screen Y + 1
MAXITEMZ  FORM      "14"               * maximum no. of items on screen Z + 1
PROGNO    FORM      "1"                * program number (for screens)
.
ADDT      INIT      "        "
ADDT0     INIT      "Add     "
ADDT1     INIT      "Subtract"
ADDT2     INIT      "Divide  "
ADDT3     INIT      "Multiply"
.
ACCEPT    FORM      1                  * accept mode (1=on)
ACTFILE   INIT      "        "         * current period file
ACTUAL    FORM     12.6                * store vars for actual period data
ACTUAL01  FORM     12.6  
ACTUAL02  FORM     12.6  
ACTUAL03  FORM     12.6  
ACTUAL04  FORM     12.6  
ACTUAL05  FORM     12.6  
ACTUAL06  FORM     12.6  
ACTUAL07  FORM     12.6  
ACTUAL08  FORM     12.6  
ACTUAL09  FORM     12.6  
ACTUAL10  FORM     12.6  
ACTUAL11  FORM     12.6  
ACTUAL12  FORM     12.6  
ACTUAL13  FORM     12.6  
BRFWD     FORM     12.2                * brought forward
BUDFILE   INIT      "        "         * current budget file
BUDGET    FORM     12.6                * store vars for BUDGET period data
BUDGET01  FORM     12.6  
BUDGET02  FORM     12.6  
BUDGET03  FORM     12.6  
BUDGET04  FORM     12.6  
BUDGET05  FORM     12.6  
BUDGET06  FORM     12.6  
BUDGET07  FORM     12.6  
BUDGET08  FORM     12.6  
BUDGET09  FORM     12.6  
BUDGET10  FORM     12.6  
BUDGET11  FORM     12.6  
BUDGET12  FORM     12.6  
BUDGET13  FORM     12.6  
COMMIT    FORM     12                  * committed expenditure
COMMITP2  FORM     12.2                * committed expenditure form 12.2
CREDIT    FORM     12.2                * credit amount
CURRDISP  DIM       5                  * current item for display (DATK & DATL)
CURPAGE   FORM      3                  * current page number
DEBCRED   FORM      1                  * 1=debit, 2=credit
DEBIT     FORM     12.2                * debit amount
DISPERR   FORM      1
DISFILE   INIT      "        "         * current dissection file
END       DIM       8                  * end date (for screen Z)
FILENAM   INIT      "        "         * filename
FORMAT    FORM      1                  * normal account format
FORMFLAG  FORM      1                  * to format or not to format !!
ITEMNUM   FORM      2                  * item number
LACTFILE  INIT      "        "         * current last year period file
LBUDFILE  INIT      "        "         * current last year budget file
LASACT    FORM     12.6                * last period totals
LASBUD    FORM     12.6
LASPVA    FORM      5 
LASVAR    FORM     12.6
LMORE     FORM      1                  * pervious data (1=yes)
MORE      FORM      1                  * more data (1=yes)
OPTIONA   FORM      2                  * screen A selection keyin var
OPTIONB   FORM      2                  * screen B selection
OPTIONC   FORM      2                  * screen C selection
OPTIOND   FORM      2                  * screen D selection
OPTIONY   FORM      2                  * screen Y selection
OPTIONZ   FORM      2                  * screen Z selection
PAGENO    FORM      3                  * current page number
PERVAR    FORM      5                  * store vars for PERVAR period data
PERVAR01  FORM      5 
PERVAR02  FORM      5 
PERVAR03  FORM      5 
PERVAR04  FORM      5 
PERVAR05  FORM      5 
PERVAR06  FORM      5 
PERVAR07  FORM      5 
PERVAR08  FORM      5 
PERVAR09  FORM      5 
PERVAR10  FORM      5 
PERVAR11  FORM      5 
PERVAR12  FORM      5 
PERVAR13  FORM      5 
PERIODNO  FORM      2                  * current period number
PROACT    FORM     12.6                * projected totals
PROBUD    FORM     12.6
PROPVA    FORM      5 
PROVAR    FORM     12.6
PROHEAD1  DIM       20                 * Projection heading 1
PROHEAD2  DIM       20                 * Projection heading 2
REPNO     FORM      2                  * report number
SAVITEM   FORM      2                  * item number for Screen A
SAVTYPE   DIM       1                  * save for account type
SSAVTYPE  DIM       1                  * save for account type
SCRNO     FORM      1                  * screen number being executed
SKEY      DIM       35                 * key save for Screen A
SKEY1     DIM       35                 * key save for parameters
SRTDATZ   DIM       8                  * date search (for screen Z)
START     DIM       8                  * start date (for screen Z)
TOTALACT  FORM     12.6                * total var for actual period data
TOTALBUD  FORM     12.6                * total var for budget period data
TOTALVAR  FORM     12.6                * total var for variance period data
TOTALPVA  FORM      5                  * total var for % variance data
TRANFILE  INIT      "        "         * current transaction file
TRANTYPE  DIM       12                 * transaction description
VARIAN    FORM     12.6                * store vars for VARIAN period data
VARIAN01  FORM     12.6  
VARIAN02  FORM     12.6  
VARIAN03  FORM     12.6  
VARIAN04  FORM     12.6  
VARIAN05  FORM     12.6  
VARIAN06  FORM     12.6  
VARIAN07  FORM     12.6  
VARIAN08  FORM     12.6  
VARIAN09  FORM     12.6  
VARIAN10  FORM     12.6  
VARIAN11  FORM     12.6  
VARIAN12  FORM     12.6  
VARIAN13  FORM     12.6  
XACTUAL   FORM     12.6                * store vars for ACTUAL period data
XBUDGET   FORM     12.6                * store vars for BUDGET period data
XPERVAR   FORM      5                  * store vars for PERVAR period data
XVARIAN   FORM     12.6                * store vars for VARIAN period data
YTDACT    FORM     12.6                * ytd totals
YTDBUD    FORM     12.6
YTDVAR    FORM     12.6
YTDPVA    FORM      5 
.
FORMATP0  INIT      "(999,999,999,999 "     * format variables
FORMATP1  INIT      "(9,999,999,999.9 "
FORMATP2  INIT      " (999,999,999.99 "
FORMATP3  INIT      "(999,999,999.999 "
FORMATP4  INIT      "(99,999,999.9999 "
FORMATP5  INIT      "(9,999,999.99999 "
FORMATP6  INIT      " (999,999.999999 "
.
ZORMATP0  INIT      "99999999999999999"     * format variables
ZORMATP1  INIT      "999999999999999.9"
ZORMATP2  INIT      "99999999999999.99"
ZORMATP3  INIT      "9999999999999.999"
ZORMATP4  INIT      "999999999999.9999"
ZORMATP5  INIT      "99999999999.99999"
ZORMATP6  INIT      "9999999999.999999"
.
FORMDAT2  INIT      "(999,999,999.99 "
ZORMDAT2  INIT      "9999999999999.99"
.
F17       FORM      17
F15P1     FORM      15.1
F14P2     FORM      14.2
F13P3     FORM      13.3
....F12P4     FORM      12.4
F11P5     FORM      11.5
F10P6     FORM      10.6
.
FA12      FORM      12
.
TYTDACT   FORM     11.6
TACTUAL   FORM     11.6
TBUDGET   FORM     11.6
TCOMMIT   FORM     12.2
TCREDIT   FORM     12.2
TDEBIT    FORM     12.2
.
DTDACT    DIM       11
DTDACT2   DIM       16
DTDACT3   DIM       17
DTDBUD    DIM       11
DTDBUD3   DIM       17
DTDVAR    DIM       11
DTDVAR3   DIM       17
DASACT    DIM       12
DASACT3   DIM       17
DASBUD    DIM       12
DASBUD3   DIM       17
DASVAR    DIM       12
DASVAR3   DIM       17
DCURASP2  DIM       15                 * committed expenditure
DCURECP2  DIM       15                 * committed expenditure
TEMPAMT   FORM      12.2               * Temporary Amount
DROACT    DIM       12
DROACT3   DIM       17
DROBUD    DIM       12
DROBUD3   DIM       17
DROVAR    DIM       12
DROVAR3   DIM       17
DOMMIT    DIM       12
DOMMITP2  DIM       15
DPROPVA   DIM       5
DDEBIT    DIM       15
DCREDIT   DIM       15
DOTALACT  DIM       16
DOTALBUD  DIM       16
DOTALVAR  DIM       16
DCTUAL    DIM       12
DCTUAL3   DIM       17
DCTUAL01  DIM       16
DCTUAL02  DIM       16
DCTUAL03  DIM       16
DCTUAL04  DIM       16
DCTUAL05  DIM       16
DCTUAL06  DIM       16
DCTUAL07  DIM       16
DCTUAL08  DIM       16
DCTUAL09  DIM       16
DCTUAL10  DIM       16
DCTUAL11  DIM       16
DCTUAL12  DIM       16
DCTUAL13  DIM       16
DUDGET    DIM       12
DUDGET3   DIM       17
DUDGET01  DIM       16
DUDGET02  DIM       16
DUDGET03  DIM       16
DUDGET04  DIM       16
DUDGET05  DIM       16
DUDGET06  DIM       16
DUDGET07  DIM       16
DUDGET08  DIM       16
DUDGET09  DIM       16
DUDGET10  DIM       16
DUDGET11  DIM       16
DUDGET12  DIM       16
DUDGET13  DIM       16
DARIAN    DIM       12
DARIAN3   DIM       17
DARIAN01  DIM       16
DARIAN02  DIM       16
DARIAN03  DIM       16
DARIAN04  DIM       16
DARIAN05  DIM       16
DARIAN06  DIM       16
DARIAN07  DIM       16
DARIAN08  DIM       16
DARIAN09  DIM       16
DARIAN10  DIM       16
DARIAN11  DIM       16
DARIAN12  DIM       16
DARIAN13  DIM       16
XIM2      DIM       2
XIM4      DIM       4                  * general dim 4
XIM8      DIM       8 
XIM31     DIM       31
.
XIM11     DIM       11
XIM12     DIM       12
XIM13     DIM       13
XIM14     DIM       14
XIM15     DIM       15
XIM16     DIM       16
XIM17     DIM       17
XIM18     DIM       18
.
ZIM11     DIM       11
ZIM12     DIM       12
ZIM13     DIM       13
ZIM14     DIM       14
ZIM15     DIM       15
ZIM16     DIM       16
ZIM17     DIM       17
ZIM18     DIM       18
.
FMSTMP0A  IFILE     SQL, FIXED=15, KEY="U1-2,3-6"     * parameter variables
NAMEA     INIT      "fmstmA"
FILENAMA  DIM       8
KILLTMPA  DIM       80
MAKETMPA  DIM       80
.
TYPDESC   INIT      "                        "   * projection type
TYPDESC0  INIT      "Not Active"
TYPDESC1  INIT      "% Var Extrapolation"
TYPDESC2  INIT      "Simple Linear Projection"
.
.
BUDG1     DIM       4                  * budget 1
DESC1     DIM       28                 * description 1
KPERIOD   FORM      2                  * period number
MAXPERDS  FORM      2                  * maximum no. of periods
OPTIONP   FORM      2                  * screen selection keyin var
PERDDESC  DIM       20                 * period description
.
STATUS    INIT      "                      "  * status
STATUS0   INIT      "Open"
STATUS1   INIT      "Open for Journals Only"
STATUS2   INIT      "Closed"
.
NOADD     INIT      "No Add to Account Allocated        "
Z20       INIT      "ZZZZZZZZZZZZZZZZZZZZ"
.
ACCOUNT   DIM       12                 * account
AMOUNTNO  FORM      1                  * amount number (param for DAMT, GAMT)
AGSTNAME  DIM       35
AVYTD     FORM      1                  * average ytd ? (1=yes)
AVYTDD0   INIT      "Total  "
AVYTDD1   INIT      "Average"
AVYTDDIS  INIT      "       "
BANKNAME  DIM       35
CGSTNAME  DIM       35
CEAFILE   FORM      1
COSTCODE  DIM       12                 * cost centre
CREDNAME  DIM       35
CURDIS    FORM      12.2
DACCOUNT  DIM       35                 * temp account description
DEBTNAME  DIM       35
DISCNAME  DIM       35
FIRSTHRU  FORM      1
OPTNO     FORM      2                  * option no.
PAYMNAME  DIM       35
ROBLEDG   DIM       2                  * display period
SUBJCODE  DIM       12                 * subjective
TEMPDPLA  FORM      1                  * temp var for no. of decimal places
TEMPTYPE  DIM       1                  * temp var for account type
TOTPERS   FORM      2                  * total period number
TOTALTYP  FORM      1                  * 0=total, 1=subj, 2=cc
TCURDIS   FORM      12.2
TYTDDIS   FORM      12.2
YTDDIS    FORM      12.2
.
.
PRGID     INIT      "IBAFMS20"
PRGNAM    INIT      "General Accounting Enquiries"
VERSION   INIT      "V12.00.00"
.
.******************************************************************************
.*  MAINLINE - Controlling Logic                                              *
.******************************************************************************
ML0000    CALL      INIT0000           * display heading and open files
.
ML0100    CALL      SELA0000           * perform screen A
          BRANCH    EXIT,ML9999        * exit program
          PACK      FMLALEDG,SKEY
          CALL      PERD0000           * set current per to last unlocked per
          MOVE      "1",SCRNO          * go into screen B first
.
ML1000    CALL      VSCR0000           * valid screen ?
          BRANCH    SCRNO,ML1100,ML1200,ML1300,ML1400,ML0100,ML1600,ML1700
.
ML1100    CALL      SELB0000           * perform screen B - summary screen
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
ML1200    CALL      SELC0000           * perform screen C - analysis by period
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
ML1300    CALL      SELD0000           * perform screen D - ytd analysis screen
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
ML1400    CALL      SELE0000           * perform screen E - committed det screen
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
ML1600    CALL      SELK0000           * perform screen K - dissection analysis
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
ML1700    CALL      SELL0000           * perform screen L - resp analysis
          BRANCH    EXIT,ML0100        * return to screen A
          GOTO      ML1000             * display desired screen
.
.
ML9999    CALL      CLOS0000 * close some files to stop I*M*024-0(pblog.log)
          CLOSE     FMSTMP0A
          EXECUTE   KILLTMPA,TASKID
.
          CHAIN      PGM            * not forking
.
.******************************************************************************
.* INIT - Open Files                             Called by ML0000             *
.******************************************************************************
INIT0000  CALL      DISPHEAD
.
          DISPLAY   *P56:24,"Opening controlf";  * control file
          OPEN      CONTROLF,"controlf"
          CALL      RDFMCO50
          CALL      RDFMCO51
          CALL      RDFMCO52
          CALL      RDFMCO65
          CALL      RDFMCO66
          LOAD      FMCOUST,PROGNO,FMCOUST,ZERO,ONE
.
          DISPLAY   *P64:24,"fmsbpfaf";  * report seq file
          OPEN      FMSBPFA1,"fmsbpfaf"
.
          DISPLAY   *P64:24,"fmsamaaf";  * account
          OPEN      FMSAMAA1,"fmsamaaf"
.
          DISPLAY   *P64:24,"fmsrsfaf";  * account report seq
          OPEN      FMSRSFA1,"fmsrsfaf"
          OPEN      FMSRSFA2,"fmsrsfaf"
.
          DISPLAY   *P64:24,"fmstcfaf";  * total calc
          OPEN      FMSTCFA1,"fmstcfaf"
          OPEN      FMSTCFA2,"fmstcfaf"
.
          DISPLAY   *P64:24,"fmssquaf";  * enquiry security
          OPEN      FMSSQUA1,"fmssquaf"
.
          DISPLAY   *P64:24,"fmslmaaf";  * ledger
          OPEN      FMSLMAA1,"fmslmaaf"
.
          DISPLAY   *P64:24,"fmslmcaf";  * ledger calendar
          OPEN      FMSLMCA1,"fmslmcaf"
.
          DISPLAY   *P64:24,"fmsuwpaf";  * wp file
          OPEN      FMSUWPA1,"fmsuwpaf"
.
          DISPLAY   *P64:24,"fmsbtyaf";  * budget file
          OPEN      FMSBTYA1,"fmsbtyaf"
.
          DISPLAY   *P64:24,"fmscodaf";  * codes file
          OPEN      FMSCODA1,"fmscodaf"
.
          DISPLAY   *P64:24,"fmslmbaf";  * report file
          OPEN      FMSLMBA1,"fmslmbaf"
.
          DISPLAY   *P64:24,"fmsoncaf";  * oncost file
          OPEN      FMSONCA1,"fmsoncaf"
.
          DISPLAY   *P64:24,"fmsprcaf";  * print code file
          OPEN      FMSPRCA1,"fmsprcaf"
.
          DISPLAY   *P64:24,"fmslevaf";  * level code file
          OPEN      FMSLEVA1,"fmslevaf"
.
          DISPLAY   *P64:24,"fmsdisaf";  * dissection file
          OPEN      FMSDISA1,"fmsdisaf"
.
          DISPLAY   *P64:24,"fmsresaf";  * responsibility file
          OPEN      FMSRESA1,"fmsresaf"
.
          DISPLAY   *P64:24,"apsceaaf";  * commited expenditure file
          OPEN      APSCEAA1,"apsceaaf"
.
          DISPLAY   *P64:24,"apscebaf";  * commited expenditure file
          OPEN      APSCEBA2,"apscebaf"
.
          DISPLAY   *P64:24,"apscioaf";  * commited expenditure file
          OPEN      APSCIOA1,"apscioaf"
.
          DISPLAY   *P64:24,"apsordaf";  * commited expenditure file
          OPEN      APSORDA2,"apsordaf"
.
          DISPLAY   *P64:24,"fmsbnkaf";  * bank rec file
          OPEN      FMSBNKA2,"fmsbnkaf"
.
          DISPLAY   *P64:24,"fmschqaf";  * cheque account file
          OPEN      FMSCHQA1,"fmschqaf"
.
          DISPLAY   *P64:24,"fmsccaaf";  * cost centre file
          OPEN      FMSCCAA1,"fmsccaaf"
.
          DISPLAY   *P64:24,"fmssbaaf";  * subjective file
          OPEN      FMSSBAA1,"fmssbaaf"
.
          DISPLAY   *P64:24,"apsmasaf";
          OPEN      APSMASA1,"apsmasaf"
.
          DISPLAY   *P64:24,"fmscsaaf";
          OPEN      FMSCSAA1,"fmscsaaf"
.
          UNPACK    SP70,ACTFILE,BUDFILE,TRANFILE,LACTFILE,LBUDFILE *clear files
.
          PACK      FILENAMA,NAMEA,PORT
          REP       " 0",FILENAMA
.
          CLEAR     MAKETMPA
          APPEND    "isbuild ",MAKETMPA
          APPEND    FILENAMA,MAKETMPA
          APPEND    " 15 u1-2,3-6",MAKETMPA
          RESET     MAKETMPA
.
          CLEAR     KILLTMPA
          APPEND    "iserase ",KILLTMPA
          APPEND    FILENAMA,KILLTMPA
          RESET     KILLTMPA
.
          EXECUTE   KILLTMPA,TASKID
          EXECUTE   MAKETMPA,TASKID
          OPEN      FMSTMP0A,FILENAMA
.
INIT9999  DISPLAY   *P1:24,*EL;
          RETURN
.******************************************************************************
.* SCRA - Display Screen A                       Called by SELA               *
.******************************************************************************
SCRA0000  MOVE      ZERO,EXIT
          DISPLAY   *P60:3,*V2LON,*EL,*HOFF:
                    *P1:4,*EF,*V2LON,*ULON,"Item",*P6:4,"Description":
                    *P42:4,"Ytd Actual",*P57:4,"Budget",*P66:4,"Variance":
                    *P76:4,"% Var";
.
SCRA9999  RETURN
.******************************************************************************
.* SCAB - Display Screen A part B                Called by SELA               *
.******************************************************************************
SCAB0000  MOVE      FALSE,EXIT
.
          PACK      KEY2,ROBLEDG                                                
          CALL      RDFMLA1 
          BRANCH    OVRCD,SCAB9000
.
          DISPLAY   *P1:3,"Financial Year ",*V2LON,FMLACYRR
          GOTO      SCAB9999
.
SCAB9000  DISPLAY   *P1:24,*EL,*B,"Invalid Ledger Account ":
                    "Found : '",ROBLEDG,"'.  ";
          CALL      HITENTER
          MOVE      TRUE,EXIT
.
SCAB9999  RETURN
.******************************************************************************
.* SELA - Perform Screen A                       Called By ML                 *
.*        Returns : SKEY     (ledger/account selected)                        *
.*                  EXIT     (1=quit)                                         *
.******************************************************************************
SELA0000  MOVE      "0",SCRNO          * this is screen 0
          CALL      SCRA0000           * display Screen A
          BRANCH    EXIT,SELA9999      * Exit program - invalid ledger
.
          MOVE      "1",PAGENO         * start at page 1
          CALL      DATA0000           * display data
          BRANCH    EXIT,SELA9500      * quit ?
          MATCH     SP70,ST1
          GOTO      SELA9300 IF EQUAL  * no valid selections ?
.
          CALL      SCAB0000           * Display current Year
.
SELA1000  CALL      MQSA0000           * get desired action
          BRANCH    EXIT,SELA9500      * quit screen ?
          MOVE      SP70,SKEY
          LOAD      SKEY,OPTIONA,ST1,ST2,ST3,ST4,ST5,ST6,ST7: 
                                 ST8,ST9,ST10,ST11,ST12,ST13: 
                                 ST14,ST15,ST16,ST17
.
          MATCH     SKEY,SP70
          GOTO      SELA5000 IF NOT EQUAL   * valid selection ?
          BEEP
          GOTO      SELA1000                * get another selection
.
SELA5000  UNPACK    SKEY,KEY2
          CALL      RDFMLA1                 * get ledger data
.
          PACK      KEY6,FMLALEDG,CURYEAR,SP70
          CALL      RDFMLC1                 * get ledger calendar data

          CALL      RTMA0000                * Write to temp file
.
          PACK      KEY14,SKEY,SP70
          CALL      RDFMAM1                 * get account data
          MOVE      ZERO,DECPLACE
          MOVE      FMAMDPLA,DECPLACE       * get no. of decimal places
          MOVE      FMAMTYPE,SAVTYPE
          MATCH     "7",FMAMTYPE
          GOTO      SELA5100 IF NOT EQUAL
          DISPLAY   *P1:24,*EL,*B,"This is a Heading Only - ";
          CALL      HITENTER
          GOTO      SELA1000
.
SELA5100  MOVE      ZERO,TOTALTYP           * default to normal tot type
          MATCH     "6",FMAMTYPE
          GOTO      SELA5200 IF NOT EQUAL
.
          MOVE      ONE,TOTALTYP
          PACK      KEY14,SKEY,SP70
          CALL      RDFMSA1                 * get account data
          COMPARE   ONE,OVRCD
          GOTO      SELA5200 IF NOT EQUAL   * subjective ?
.
          MOVE      TWO,TOTALTYP
          PACK      KEY14,SKEY,SP70
          CALL      RDFMCC1                 * get account data
          COMPARE   ONE,OVRCD
          GOTO      SELA5200 IF NOT EQUAL   * cost centre ?
          MOVE      ZERO,TOTALTYP           * normal
.
SELA5200  MOVE      ZERO,EXIT               * continue
          GOTO      SELA9999
.
SELA9300  DISPLAY   *P1:24,*EL,*B,"Access Denied - ";
          CALL      HITENTER
.
SELA9500  MOVE      ONE,EXIT                * quit
.
SELA9999  RETURN
.******************************************************************************
.* DATA - display Screen A data                  Called By MQSA,SELA          *
.*       Requires - PAGENO   (page to display)                                *
.*                  MAXITEMA (maximum no. of items per page + 1)              *
.*        Returns - ITEMNUM  (number of data items displayed)                 *
.*                  ST1..ST17 (save keys for displayed data)                  *
.*                  MORE     (1=more data)                                    *
.*        Uses    - CURPAGE  (page counter)                                   *
.*                  LINENO   (line to display data)                           *
.******************************************************************************
DATA0000  UNPACK    SP70,ST1,ST2                 * clear save keys
          UNPACK    SP70,ST3,ST4
          UNPACK    SP70,ST5,ST6
          UNPACK    SP70,ST7,ST8
          UNPACK    SP70,ST9,ST10
          UNPACK    SP70,ST11,ST12
          UNPACK    SP70,ST13,ST14
          UNPACK    SP70,ST15,ST16
          UNPACK    SP70,ST17,SKEY
          MOVE      TRUE,FIRSTHRU               * First thru
          PACK      KEY21,PASSCODE,SP70
          CALL      RSFMSQ1                      * go to start of records
          MOVE      "4",LINENO
          MOVE      "1",CURPAGE                  * start at page 1
          MOVE      "0",ITEMNUM                  * start at item 1
          DISPLAY   *P1:5,*EF;                   * clear data area on screen
.
DATA1000  CALL      RKFMSQ1                      * get next record
          BRANCH    OVRCD,DATA9000               * no more records ?
          MATCH     PASSCODE,FMSQSEC
          GOTO      DATA9000 IF NOT EQUAL        * no more records ?
.
          ADD       "1",ITEMNUM                  * increment item number
          COMPARE   MAXITEMA,ITEMNUM
          GOTO      DATA2000 IF LESS             * at start of next screen ?
.
          MOVE      "1",ITEMNUM
          ADD       ONE,CURPAGE
.
DATA2000  COMPARE   PAGENO,CURPAGE
          GOTO      DATA1000 IF LESS             * not up to current page ?
          GOTO      DATA9500 IF NOT EQUAL        * past current page ?
.
.---- display data ----
.
          ADD       "1",LINENO
          MOVE      SP70,FMAMDESC
          PACK      KEY14,FMSQLEDG,FMSQACCT,SP70
          CALL      RDFMAM1
          MOVE      ZERO,AVYTD
          MOVE      FMAMAYTD,AVYTD     * save ytd type
.
          PACK      FMLALEDG,FMSQLEDG,SP70
.
          IF        FIRSTHRU=1
            MOVE      FMSQLEDG,ROBLEDG
            MOVE      FALSE,FIRSTHRU
          ENDIF
.
          CALL      PERD0000           * set current period
          BRANCH    EXIT,DATA9900      * exit program
.
          PACK      KEY14,FMSQLEDG,FMSQACCT,SP70  * save key
          STORE     KEY14,ITEMNUM,ST1,ST2,ST3,ST4,ST5,ST6,ST7: 
                                  ST8,ST9,ST10,ST11,ST12,ST13: 
                                  ST14,ST15,ST16,ST17
          MATCH     "7",FMAMTYPE
          GOTO      DATA3000 IF EQUAL
          CALL      GDAT0000
          DISPLAY   *P1:LINENO,*V2LON,ITEMNUM,*HOFF,DOT:
                    *P6:LINENO,FMAMDESC:
                    DTDACT,DTDBUD,DTDVAR,SP2,YTDPVA;
.
          GOTO      DATA1000                     * get next record
.
. Heading Only Display Name
.
DATA3000  DISPLAY   *P1:LINENO,*V2LON,ITEMNUM,*HOFF,DOT:
                    *P6:LINENO,FMAMDESC
          GOTO      DATA1000                     * get next record
.
.---- reached EOF before EOP ----
.
DATA9000  MOVE      ZERO,ITEMNUM                 * reset pointer
          MOVE      ZERO,MORE                    * no more data
          GOTO      DATA9990
.
.---- reached EOP before EOF ----
.
DATA9500  MOVE      ONE,MORE                     * more data
          MOVE      MAXITEMA,ITEMNUM
          GOTO      DATA9990
.
DATA9900  MOVE      ONE,EXIT                     * quit
          GOTO      DATA9999
.
DATA9990  MOVE      ZERO,EXIT                    * continue
.
DATA9999  RETURN
.******************************************************************************
.* MQSA - Main question for Screen A             Called By SELA               *
.******************************************************************************
MQSA0000  DISPLAY   *P1:24,"Select Item";        * display prompt
          MOVE      "11",CCOL
          COMPARE   ONE,MORE
          GOTO      MQSA1000 IF NOT EQUAL
.
          DISPLAY   ", (",*V2LON,"N",*HOFF,")ext Page";
          ADD       "13",CCOL
.
MQSA1000  COMPARE   PAGENO,ONE
          GOTO      MQSA2000 IF EQUAL
.
          DISPLAY   ", (",*V2LON,"P",*HOFF,")revious Page";
          ADD       "17",CCOL
.
MQSA2000  DISPLAY   ", e(",*V2LON,"X",*HOFF,")it :  ";
          ADD       "12",CCOL
.
MQSA3000  KEYIN     *PCCOL:24,"__",*PCCOL:24,*JR,*V2LON,XIM2,*EL; * get option
          PACK      XIM2,XIM2,SP70
          REP       UPPLOW,XIM2
          COMPARE   ONE,MORE
          GOTO      MQSA4000 IF NOT EQUAL
.
          MATCH     " N",XIM2
          GOTO      MQSA4000 IF NOT EQUAL
          ADD       ONE,PAGENO         * get next page
          CALL      DATA0000
          BRANCH    EXIT,MQSA9500      * quit ?
          GOTO      MQSA0000
.
MQSA4000  COMPARE   PAGENO,ONE
          GOTO      MQSA5000 IF EQUAL
.
          MATCH     " P",XIM2
          GOTO      MQSA5000 IF NOT EQUAL
          SUB       ONE,PAGENO         * get last page
          CALL      DATA0000
          BRANCH    EXIT,MQSA9500      * quit ?
          GOTO      MQSA0000
.
MQSA5000  MATCH     " X",XIM2
          GOTO      MQSA9500 IF EQUAL
.
          MOVE      ZERO,OPTIONA
          MOVE      XIM2,OPTIONA
          COMPARE   OPTIONA,ZERO
          GOTO      MQSA9000 IF LESS   * valid number input ?
          BEEP                         * illegal option
          GOTO      MQSA3000           * get another option
.
MQSA9000  MOVE      ZERO,EXIT          * continue
          GOTO      MQSA9999
.
MQSA9500  MOVE      ONE,EXIT           * quit
.
MQSA9999  RETURN
.**********************************************************************
.  PERD - Set current period to last unlocked period   Called By ML
.        Requires - Control File sector 52 read
.                   FMLALEDG (ledger)
.        Returns  - EXIT     (1=quit)
.**********************************************************************
PERD0000  
          PACK      KEY2,FMLALEDG,SP70
          CALL      RDFMLA1
          PACK      KEY6,FMLALEDG,FMLACYRR,SP70
          CALL      RDFMLC1
          MOVE      FMLACYRR,CURYEAR   * start at current year
          MOVE      FMLAPER,PERIODNO   * start at current period
.
PERD0100  LOAD      F1,PERIODNO,FMLC01IN,FMLC02IN,FMLC03IN,FMLC04IN,FMLC05IN:
                                FMLC06IN,FMLC07IN,FMLC08IN,FMLC09IN,FMLC10IN:
                                FMLC11IN,FMLC12IN,FMLC13IN
          BRANCH    F1,PERD9000        * continue if period locked
.
          MOVE      ONE,DISPERR
          CALL      LPER0000           * get last period
          BRANCH    OVRCD,PERD9500     * no more periods (error) ?
          GOTO      PERD0100           * check current period
.
PERD9000  MOVE      ZERO,EXIT          * continue
          GOTO      PERD9999
.
PERD9500  DISPLAY   *P1:24,*B,*EF:
                    "Could Not Find A Locked Period In Ledger ":
                    FMLALEDG," - ";
          CALL      HITENTER
          MOVE      ONE,EXIT           * quit
.
PERD9999  RETURN
.******************************************************************************
.* INCLUDES FOR I/O'S                                                         *
.******************************************************************************
.
          INC       APSCEAIO/INC       * committed expenditure
          INC       APSCEBIO/INC       * committed expenditure
          INC       APSCIOIO/INC       * committed expenditure
          INC       APSMASIO/INC
          INC       APSORDIO/INC       * committed expenditure
          INC       APSPPDIO/INC
          INC       FMSBPFIO/INC
          INC       FMSAMAIO/INC       * account
          INC       FMSBNKIO/INC       * bank rec
          INC       FMSBTYIO/INC       * budget data
          INC       FMSBUDIO/INC       * budget data
          INC       FMSCHQIO/INC       * cheque
          INC       FMSCONIO/INC       * controlf
          INC       FMSCSAIO/INC
          INC       FMSDSFIO/INC       * dissection accrual summary file
          INC       FMSFPSIO/INC       * period summary file
          INC       FMSLMAIO/INC       * ledger
          INC       FMSLMCIO/INC       * ledger financial calendar
          INC       FMSSQUIO/INC       * enquiry security
          INC       FMSSBUIO/INC       * stat budget
          INC       FMSSMAIO/INC       * stat summary
          INC       FMSTRNIO/INC       * transaction
          INC       FMSUWPIO/INC       * wp file
          INC       FMSCODIO/INC       * codes file
          INC       FMSLMBIO/INC       * report
          INC       FMSONCIO/INC       * oncost code
          INC       FMSPRCIO/INC       * print code
          INC       FMSLEVIO/INC       * level code
          INC       FMSRSFIO/INC       * account report seq
          INC       FMSSTRIO/INC       * stats transactions
          INC       FMSTCFIO/INC       * total calc
          INC       FMSDISIO/INC       * dissection
          INC       FMSRESIO/INC       * responsibility
          INC       FMSCTRIO/INC       * cash transactions
          INC       FMSCCAIO/INC       * cost centre
          INC       FMSSBAIO/INC       * subjective
.
          INC       FMSAMAKY           * account
          INC       FMSBTYKY           * budget data
          INC       FMSLMAKY           * ledger
          INC       FMSLMCKY           * ledger callendar
.
          INC       FMSENSCR           * enquiry screens
          INC       FMSSTDCD           * FMS standard include
