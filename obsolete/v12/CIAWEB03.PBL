.----------------------------------------------------------------------
. Program       : CIAWEB03
.
. Function      : Casemix Generation - Enquiry
.
. Modifications : 
.----------------------------------------------------------------------
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.01 16/07/2013  Jill Parkinson CAR 287923
.           Added include of PATCONFD
.----------------------------------------------------------------------
. V10.00.01 03/06/2010  Ebon Clements CAR 217427
.           Recompiled for CCSEPSTM - Admission and discharge transfer source
.----------------------------------------------------------------------
. V9.12.01  13/08/2009  Ebon Clements CAR 198266
.           Recompiled for CCSEPSTM
.----------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.03.01  16/03/2004  Sylvek Litewka           CAR 46509
.           Added report number 4 - Casemix Extract Reports.
. V9.03.00  14/01/2004  Sylvek Litewka           CAR 46508
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       RSHWEBDF
          INC       PATCONFD/INC
          INC       CCSCEAFD/INC
          INC       CCSCEATD/INC
          INC       CCSCEBFD/INC
          INC       CCSCECFD/INC
          INC       CCSCEDFD/INC
          INC       CCSCEEFD/INC
          INC       CCSCEFFD/INC
          INC       CCSCEGFD/INC
          INC       CCSCEXFD/INC
          INC       CCSCONFD/INC
          INC       CCSEPSFD/INC
          INC       CCSHCDFD/INC
          INC       CCSIADFD/INC
          INC       CCSSTYFD/INC
          INC       CCSXHDFD/INC
          INC       CCSCEXTD/INC
.
          INC       CEAPPMFD/INC
.
          INC       PATDO1FD/INC            * Doctors file
          INC       PATVADFD/INC            * Transfer Source Codes
          INC       PMSHCPFD/INC            * HCP file
.
.----------------------------------------------------------------------
AGEYRS    DIM       3
AGEOTH    DIM       2
BDTOTF    FORM      12.2
BDTOTT    FORM      12.2
CEXLEVEL  DIM       1
CEXTRKEY  DIM       30
CEXLVKEY  DIM       127
CCFACTOR  FORM      5.5
CCSTDDEV  FORM      12.4
CCTSTVAR  FORM      12.4
CCVARIAN  FORM      12.4
CSMXTYPE  DIM       3
CSMXCODE  DIM       10
DESCVAR   DIM       127
DISINC    FORM      12       * Dollars Only
DISCST    FORM      12       * Dollars Only
DISBED    FORM      10
DISALS    FORM      10.1
DISAGE    FORM      3
DOCTCODE  DIM       6
EPSDENUM  DIM       16
EXTRACID  DIM       4
FUNCLNK1  DIM       127
FUNCLNK2  DIM       127
NEXTPAGE  DIM       1        * Nextpage parameter CGI parameter
OVERFLOW  FORM      1        * Overflow indicator
RESULT    FORM      12.2
ROWCOUNT  FORM      3
TEMPLTNO  FORM      3        * Template number as a FORM field.
UPDTTYPE  DIM       1        * Update Type
.
COSTETH   FORM      8.2
COSTEA1   FORM      8.2
COSTEA2   FORM      8.2
COSTEA3   FORM      8.2
COSTEAO   FORM      8.2
COSTEM1   FORM      8.2
COSTEM2   FORM      8.2
COSTEM3   FORM      8.2
COSTEMO   FORM      8.2
TOTINC    FORM     12.2
TOTCST    FORM     12.2
TOTCST1   FORM     12.2
TOTCST2   FORM     12.2
TOTCST3   FORM     12.2
TOTCST4   FORM     12.2
TOTCST5   FORM     12.2
.
. Variables for casemix reports
.
RPAVRLOS  DIM       1                  * Report Average Length of Stay
RPAVRINC  DIM       1                  * Report Average Income
RPAVRCST  DIM       1                  * Report Average Cost
RPFORMAT  DIM       2                  * Report Format
RPCNFINT  DIM       1                  * Report Confidence Interval
RPSEQNCE  DIM       2                  * Report Sequence
RPLV1CFR  DIM       10                 * Report Level 1 Code From
RPLV1CTO  DIM       10                 * Report Level 1 Code To
RPLV2CFR  DIM       10                 * Report Level 2 Code From
RPLV2CTO  DIM       10                 * Report Level 2 Code To
RPLV3CFR  DIM       10                 * Report Level 3 Code From
RPLV3CTO  DIM       10                 * Report Level 3 Code To
RPLV1PBR  DIM       1                  * Report Level 1 Page Break
RPLV2PBR  DIM       1                  * Report Level 2 Page Break
RPOPTION  DIM       1                  * Report Option
RPCSTYPE  DIM       3                  * Report Casemix Type
RPDELAUD  DIM       1                  * Report Delete Audit file Flag 
.
.----------------------------------------------------------------------
PRGID     INIT      "CIAWEB03"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "Casemix Generation - Enquiry"
.----------------------------------------------------------------------
.
          CALL      WEBINT00           * Initialise Fifo Etc.
          CALL      INIT0000           * Open Files
.
MAIN1000  CALL      WEBRED00           * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO     * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      CCSCOPCL           * Close Casemix Files
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      EXTENQ00           * Extract Enquiries 
          CALL      CCSCOPCL           * Close Casemix Files
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      EXTSTA00           * Extract Statistical Details 
          CALL      CCSCOPCL           * Close Casemix Files
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      EXTEPS00           * Extract Single Episode Details 
          CALL      CCSCOPCL           * Close Casemix Files
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      EXTRPT00           * Casemix Extract Reports
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      CONTROLF,"controlf"
.
          MOVE      "   64",AUDTSECT
          MOVE      " 37",AUDTPOST
          READ      CONTROLF,AUDTSECT;*AUDTPOST,AUDTFLAG
          IF        AUDTFLAG=1
            DISPLAY   *P56:24,"Opening ccsaudep";
            OPEN      CCSAUDEP,"ccsaudep"
          ENDIF
.
          MOVE      "   64",AUDTSECT
          MOVE      " 38",AUDTPOST
          READ      CONTROLF,AUDTSECT;*AUDTPOST,AUDTFLAG
          IF        AUDTFLAG=1
            DISPLAY   *P56:24,"Opening ccsaudia";
            OPEN      CCSAUDIA,"ccsaudia"
          ENDIF
.
          MOVE      "64",SECTOR
          READ      CONTROLF,SECTOR;*59,CCCOCD1,CCCOCD2,CCCOCD3,CCCOCD4:
                                        CCCOCD5,CCCOIA1,CCCOIA2,CCCOIA3:
                                        CCCOIM1,CCCOIM2,CCCOIM3
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          OPEN      CCSCEAA1,"ccsceaaf"
          OPEN      CCSCEXA1,"ccscexaf"
          OPEN      CCSEPSA1,"ccsepsaf"
          OPEN      CCSEPSA2,"ccsepsaf"
          OPEN      CCSEPSA3,"ccsepsaf"
          OPEN      CCSEPSA4,"ccsepsaf"
          OPEN      CCSEPSA5,"ccsepsaf"
          OPEN      CCSHCDA1,"ccshcdaf"
          OPEN      CCSHCDA2,"ccshcdaf"
          OPEN      CCSIADA1,"ccsiadaf"
          OPEN      CCSSTYA1,"ccsstyaf"
          OPEN      CCSXHDA1,"ccsxhdaf"
          OPEN      CCSXHDA2,"ccsxhdaf"
.
          OPEN      CEAPPMA1,"ceappmaf"
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATVADA1,"patvadaf"
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
.
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      ZERO,TEMPLTNO
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
.
          MOVE      SP70,CEXLEVEL 
          MOVE      SP70,CEXTRKEY
          MOVE      SP70,EPSDENUM
          MOVE      SP70,EXTRACID
.
          MOVE      SP70,RPAVRLOS
          MOVE      SP70,RPAVRINC
          MOVE      SP70,RPAVRCST
          MOVE      SP70,RPFORMAT
          MOVE      SP70,RPCNFINT
          MOVE      SP70,RPSEQNCE
          MOVE      SP70,RPLV1CFR
          MOVE      SP70,RPLV1CTO
          MOVE      SP70,RPLV2CFR
          MOVE      SP70,RPLV2CTO
          MOVE      SP70,RPLV3CFR
          MOVE      SP70,RPLV3CTO
          MOVE      SP70,RPLV1PBR
          MOVE      SP70,RPLV2PBR
          MOVE      SP70,RPOPTION
          MOVE      SP70,RPCSTYPE
          MOVE      SP70,RPDELAUD
.
CLRPAR99  RETURN
.
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cexlevel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CEXLEVEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cextrkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CEXTRKEY
            PACK      CEXTRKEY,CEXTRKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extracid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTRACID
            PACK      EXTRACID,EXTRACID,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epsdenum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSDENUM
            PACK      EPSDENUM,EPSDENUM,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpavrlos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPAVRLOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpavrinc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPAVRINC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpavrcst=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPAVRCST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpformat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPFORMAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpcnfint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPCNFINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpseqnce=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPSEQNCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv1cfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV1CFR
            PACK      RPLV1CFR,RPLV1CFR,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv1cto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV1CTO
            PACK      RPLV1CTO,RPLV1CTO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv2cfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV2CFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv2cto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV2CTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv3cfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV3CFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv3cto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV3CTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv1pbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV1PBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rplv2pbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPLV2PBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpoption=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPOPTION
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpcstype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPCSTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rpdelaud=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPDELAUD
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Extract Enquiries
.------------------------------------------------------------
EXTENQ00  PACK      KEY4,EXTRACID,SP70
          CALL      RDCCEA1
          IF        OVRCD=1
            CALL      CLCCEA00                   * Clear CCSCEAFD variables
          ENDIF
.   
          MATCH     "1",CCEASTAT                 * Extract not generated
          GOTO      EXTENQ91 IF EQUAL
.
          MATCH     "2",CCEASTAT                 * Process generation error
          GOTO      EXTENQ92 IF EQUAL
.
          MOVE      TEMPLATE,TEMPLTNO
          COMPARE   THREE,TEMPLTNO               * Level 2 Summary
          IF        @EQUAL
            MATCH     SP70,CCEALV2               
            GOTO      EXTENQ93 IF EQUAL          * No Level 2 for this extract
          ENDIF
.
          COMPARE   FIVE,TEMPLTNO                * Level 3 Summary
          IF        @EQUAL
            MATCH     SP70,CCEALV3               
            GOTO      EXTENQ93 IF EQUAL          * No Level 3 for this extract
          ENDIF
.
          CALL      CCSCOPOP                     * Open Casemix Files     
          BRANCH    EXIT,EXTENQ91
.
          PACK      KEY4,CCEAEID,SP70
          CALL      RDCCEX1
          IF        OVRCD=1
            CALL      CLCCEX00                   * Clear CCSCEXFD variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Casemix Generation - Enquiries",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXTENQ99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EXTENQ99
.
EXTENQ90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTENQ99
.
EXTENQ91  MOVE      "Invalid Action - Extract Files not generated",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTENQ99
.
EXTENQ92  MOVE      "Invalid Action - Extract Generation Error",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTENQ99
.
EXTENQ93  MOVE      "No More Levels in this Extract.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTENQ99
.
EXTENQ99  RETURN
.
.------------------------------------------------------------
. Extract Statistical Details
.------------------------------------------------------------
EXTSTA00  PACK      KEY4,EXTRACID,SP70
          CALL      RDCCEA1
          BRANCH    OVRCD,EXTSTA90
.
          PACK      KEY4,CCEAEID,SP70
          CALL      RDCCEX1
          IF        OVRCD=1
            CALL      CLCCEX00              * Clear CCSCEXFD variables
          ENDIF
.
          MOVE      CEXLEVEL,F1
          BRANCH    F1,EXTSTA10,EXTSTA20,EXTSTA30
.
          GOTO      EXTSTA91
.
EXTSTA10  MOVE      "cceb",KEY4             * Open Level 1 Summary file
          PACK      FILENAME,KEY4,CCEAEID
          REP       " 0",FILENAME
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CCSCEBA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,EXTSTA92
.
          PACK      KEY10,CEXTRKEY,SP70     * Read Level 1 Summary File
          CALL      RDCCEB1
          BRANCH    OVRCD,EXTSTA93
.
          GOTO      EXTSTA50
.
EXTSTA20  MOVE      "cced",KEY4             * Open Level 2 Summary file
          PACK      FILENAME,KEY4,CCEAEID
          REP       " 0",FILENAME
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CCSCEDA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,EXTSTA92
.
          PACK      KEY20,CEXTRKEY,SP70     * Read Level 2 Summary File
          CALL      RDCCED1
          BRANCH    OVRCD,EXTSTA93
.
          GOTO      EXTSTA50
.
EXTSTA30  MOVE      "ccee",KEY4             * Open Level 3 Summary file
          PACK      FILENAME,KEY4,CCEAEID
          REP       " 0",FILENAME
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CCSCEEA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,EXTSTA92
.
          PACK      KEY30,CEXTRKEY,SP70     * Read Level 3 Summary File
          CALL      RDCCEE1
          BRANCH    OVRCD,EXTSTA93
.
          GOTO      EXTSTA50
.
EXTSTA50  CLEAR     WEBTITLE
          MOVE      "Casemix Generation - Statistical Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXTENQ99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EXTSTA99
.
EXTSTA90  MOVE      "Invalid Casemix Extract Id.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTSTA99
.
EXTSTA91  MOVE      "Invalid Casemix Extract Level.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTSTA99
.
EXTSTA92  MOVE      "Can not Open Extract Level Summary File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTSTA99
.
EXTSTA93  MOVE      "Code not Found on Extract Level Summary File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTSTA99
.
EXTSTA99  RETURN
.
.------------------------------------------------------------
. Extract Single Episode Details
.------------------------------------------------------------
EXTEPS00  PACK      KEY4,EXTRACID,SP70
          CALL      RDCCEA1
          BRANCH    OVRCD,EXTEPS90
.
          PACK      KEY4,CCEAEID,SP70
          CALL      RDCCEX1
          IF        OVRCD=1
            CALL      CLCCEX00              * Clear CCSCEXFD variables
          ENDIF
.
          CALL      CCSCOPOP                * Open Casemix Files
          BRANCH    EXIT,EXTEPS92
.
          PACK      KEY18,CCEAHCD,EPSDENUM,SP70
          CALL      RDCCEC1                 * Read Episode Costing Details
          BRANCH    OVRCD,EXTEPS91
.
          PACK      KEY18,CCEAHCD,EPSDENUM,SP70
          CALL      RDCCEP1                 * Read Episode Basic Details
          BRANCH    OVRCD,EXTEPS91
.
          PACK      KEY18,CCEAHCD,EPSDENUM,SP70
          CALL      RDCCIA1                 * Clinical Costing Income Details
          IF        OVRCD=1
            CALL      CLRIAD00
          ENDIF
.
          CALL      IADTOT00                * Claculate CCSAID totals
.
EXTEPS50  CLEAR     WEBTITLE
          MOVE      "Casemix Generation - Statistical Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXTENQ99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTEPS90  MOVE      "Invalid Casemix Extract Id.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTEPS91  MOVE      "Invalid Episode Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTEPS92  MOVE      "Invalid Action - Extract Files not generated.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
EXTEPS99  RETURN
.
.------------------------------------------------------------
. CIAS Reporting
.------------------------------------------------------------
EXTRPT00  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EXTRPT80 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Income Analysis Level 1
          GOTO      EXTRPT05 IF EQUAL
.
          MATCH     "B",UPDTTYPE       * Income Analysis Level 2
          GOTO      EXTRPT10 IF EQUAL
.
          MATCH     "C",UPDTTYPE       * Income Analysis Level 3
          GOTO      EXTRPT15 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Length of Stay Analysis Level 1
          GOTO      EXTRPT20 IF EQUAL
.
          MATCH     "E",UPDTTYPE       * Length of Stay Analysis Level 2
          GOTO      EXTRPT25 IF EQUAL
.
          MATCH     "F",UPDTTYPE       * Length of Stay Analysis Level 3
          GOTO      EXTRPT30 IF EQUAL
.
          MATCH     "G",UPDTTYPE       * Episode Outlier Analysis
          GOTO      EXTRPT35 IF EQUAL
.
          MATCH     "H",UPDTTYPE       * Extract Excluded Episodes
          GOTO      EXTRPT40 IF EQUAL
.
          MATCH     "I",UPDTTYPE       * Code File Listings
          GOTO      EXTRPT45 IF EQUAL
.
          MATCH     "J",UPDTTYPE       * Episode Audit Listing
          GOTO      EXTRPT50 IF EQUAL
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      EXTRPT99
.
EXTRPT05  MOVE      "IBACIA58",SCHDPGID  
          MOVE      "CIAS - Income Analysis Level 1",SCHDDESC
          CALL      LVL1AN00        
          GOTO      EXTRPT99
.
EXTRPT10  MOVE      "IBACIA59",SCHDPGID    
          MOVE      "CIAS - Income Analysis Level 2",SCHDDESC
          CALL      LVL2AN00              
          GOTO      EXTRPT99
.
EXTRPT15  MOVE      "IBACIA60",SCHDPGID
          MOVE      "CIAS - Income Analysis Level 3",SCHDDESC
          CALL      LVL3AN00            
          GOTO      EXTRPT99
.
EXTRPT20  MOVE      "IBACIA61",SCHDPGID    
          MOVE      "CIAS - Length of Stay Analysis Level 1",SCHDDESC
          CALL      LVL1AN00          
          GOTO      EXTRPT99
.
EXTRPT25  MOVE      "IBACIA62",SCHDPGID 
          MOVE      "CIAS - Length of Stay Analysis Level 2",SCHDDESC
          CALL      LVL2AN00        
          GOTO      EXTRPT99
.
EXTRPT30  MOVE      "IBACIA63",SCHDPGID
          MOVE      "CIAS - Length of Stay Analysis Level 3",SCHDDESC
          CALL      LVL3AN00        
          GOTO      EXTRPT99
.
EXTRPT35  CALL      EOUTAN00           * Episode Outlier Analysis
          GOTO      EXTRPT99
.
EXTRPT40  CALL      EXCEPS00           * Extract Excluded Episodes Listing
          GOTO      EXTRPT99
.
EXTRPT45  CALL      CODLST00           * Code Listings
          GOTO      EXTRPT99
.
EXTRPT50  CALL      AUDLST00           * Episode Audit Listing
          GOTO      EXTRPT99
.
EXTRPT80  MOVE      TEMPLATE,TEMPLTNO
          COMPARE   NINE,TEMPLTNO      * Not an Extract level report.
          GOTO      EXTRPT85 IF EQUAL  * Skip read of Extract Masterfile.
.
          COMPARE   TEN,TEMPLTNO       * Not an Extract level report.
          GOTO      EXTRPT85 IF EQUAL  * Skip read of Extract Masterfile.
.
          PACK      KEY4,EXTRACID,SP70
          CALL      RDCCEA1
          BRANCH    OVRCD,EXTRPT90
.
          COMPARE   TWO,TEMPLTNO
          IF        @EQUAL
            MATCH     SP70,CCEALV2
            GOTO      EXTRPT91 IF EQUAL
          ENDIF
.
          COMPARE   THREE,TEMPLTNO
          IF        @EQUAL
            MATCH     SP70,CCEALV3
            GOTO      EXTRPT92 IF EQUAL
          ENDIF
.
          COMPARE   FIVE,TEMPLTNO
          IF        @EQUAL
            MATCH     SP70,CCEALV2
            GOTO      EXTRPT91 IF EQUAL
          ENDIF
.
          COMPARE   SIX,TEMPLTNO
          IF        @EQUAL
            MATCH     SP70,CCEALV3
            GOTO      EXTRPT92 IF EQUAL
          ENDIF
.
          PACK      KEY4,CCEAEID,SP70
          CALL      RDCCEX1
          IF        OVRCD=1
            CALL      CLCCEX00              * Clear CCSCEXFD variables
          ENDIF
.
EXTRPT85  CLEAR     WEBTITLE
          MOVE      "Casemix Enquiry - Reports",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXTENQ99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTRPT90  MOVE      "Invalid Casemix Extract Id.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTRPT91  MOVE      "Level 2 Analysis not Available for this Extract.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTRPT92  MOVE      "Level 3 Analysis not Available for this Extract.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTEPS99
.
EXTRPT99  RETURN
.
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40
.
          GOTO      PROFLD99 
.
. Report 1
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      CSCA0000           * Casemix Extract Master File   
          GOTO      PROFLD99
.
PROFLD12  CALL      EXLS0000           * Extract Lists
          GOTO      PROFLD99
.
PROFLD13  CALL      MISC0000           * Miscelaneous Display Fields
          GOTO      PROFLD99
.
. Report 2
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24,PROFLD25
          GOTO      PROFLD99
.
PROFLD21  CALL      CSCA0000           * Casemix Extract Master File   
          GOTO      PROFLD99
.
PROFLD22  CALL      MISC0000           * Miscelaneous Display Fields
          GOTO      PROFLD99
.
PROFLD23  CALL      CCEB0000           * Level 1 Statistical Details   
          GOTO      PROFLD99
.
PROFLD24  CALL      CCED0000           * Level 2 Statistical Details   
          GOTO      PROFLD99
.
PROFLD25  CALL      CCEE0000           * Level 3 Statistical Details   
          GOTO      PROFLD99
.
. Report 3
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35
          GOTO      PROFLD99
.
PROFLD31  CALL      CSCA0000           * Casemix Extract Master File   
          GOTO      PROFLD99
.
PROFLD32  CALL      MISC0000           * Miscelaneous Display Fields
          GOTO      PROFLD99
.
PROFLD33  CALL      CCEP0000           * Episode Basic Details
          GOTO      PROFLD99
.
PROFLD34  CALL      CCEC0000           * Episode Costing Details
          GOTO      PROFLD99
.
PROFLD35  CALL      CCIA0000           * Clinical Costing Income Details
          GOTO      PROFLD99
.
.
. Report 4
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41
          GOTO      PROFLD99
.
PROFLD41  CALL      CSCA0000           * Casemix Extract Master File
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------------------------
. Extract Lists
.------------------------------------------------------------------------------
EXLS0000  BRANCH    FLDITMNO,EXLS0010,EXLS0020,EXLS0030,EXLS0040,EXLS0050:
                             EXLS0060
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      EXLS9999
.
EXLS0010  CALL      L1SUMT00           * Level 1 Summary Table
          GOTO      EXLS9999
.
EXLS0020  CALL      L2SUMT00           * Level 2 Summary Table
          GOTO      EXLS9999
.
EXLS0030  CALL      L3SUMT00           * Level 3 Summary Table
          GOTO      EXLS9999
.
EXLS0040  CALL      EPSTAB00           * Episodes Table for all levels
          GOTO      EXLS9999
.
EXLS0050  COMPARE   ONE,OVERFLOW       * Table-End Line colour
          IF        @EQUAL
            WRITE     HTMLFILE;"Red";
          ELSE
            WRITE     HTMLFILE;"SteelBlue";
          ENDIF
          GOTO      EXLS9999
.
EXLS0060  COMPARE   ONE,OVERFLOW       * Table-End Line text
          IF        @EQUAL
            WRITE     HTMLFILE;"Too Many Rows to Display";
          ELSE
            WRITE     HTMLFILE;"No More Data to Display";
          ENDIF
          GOTO      EXLS9999
.
EXLS9999  RETURN
.
.------------------------------------------------------------------------------
. Casemix Extract - Level 1 Summary Table
.------------------------------------------------------------------------------
L1SUMT00  MOVE      ZERO,ROWCOUNT
          MOVE      ZERO,OVERFLOW
          PACK      KEY10,SP70
          CALL      RSCCEB1
L1SUMT10  CALL      RKCCEB1
          BRANCH    OVRCD,L1SUMT99
.
          ADD       ONE,ROWCOUNT
          COMPARE   HUND01,ROWCOUNT
          GOTO      L1SUMT90 IF EQUAL
.
          PACK      KEY13,CCEALV1,CCEBLV1,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            PACK      CCXHDES,CCEALV1,SP1,CCEBLV1,SP70
            MATCH     "~~~~~~~~~~",CCEBLV1
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          STRIP     CCXHDES
          MOVELPTR  CCXHDES,LENGTH
          SFORMAT   DESCVAR,LENGTH
          MOVE      CCXHDES,DESCVAR
.
          PACK      KEY30,CCEBLV1,SP70
          CLEAR     FUNCLNK1
          APPEND    "javascript:ShowExtract('",FUNCLNK1
          APPEND    KEY30,FUNCLNK1
          APPEND    "','",FUNCLNK1
          APPEND    ONE,FUNCLNK1
          APPEND    "')",FUNCLNK1
          RESET     FUNCLNK1
.
          CLEAR     FUNCLNK2
          APPEND    "javascript:ShowEpisodes('",FUNCLNK2
          APPEND    KEY30,FUNCLNK2
          APPEND    "','",FUNCLNK2
          APPEND    ONE,FUNCLNK2
          APPEND    "')",FUNCLNK2
          RESET     FUNCLNK2
.
          MOVE      CCEBFTC,DISINC
          MOVE      CCEBTTC,DISCST
          MOVE      CCEBLTO,DISBED
          ASSIGN    CCEBLTO/CCEBNEP,DISALS
          WRITE     HTMLFILE;"t.addRow(",QUOTE,DESCVAR,QUOTE,COMMA:
                                         QUOTE,CCEBLV1,QUOTE,COMMA:
                                         QUOTE,CCEBNEP,QUOTE,COMMA:
                                         QUOTE,DISINC,QUOTE,COMMA:
                                         QUOTE,DISCST,QUOTE,COMMA:
                                         QUOTE,DISBED,QUOTE,COMMA:
                                         QUOTE,DISALS,QUOTE,COMMA:
                                         QUOTE,ONE,QUOTE,COMMA:
                                         QUOTE,FUNCLNK1,QUOTE,COMMA:
                                         QUOTE,FUNCLNK2,QUOTE,");"
          SFORMAT   DESCVAR,127
          GOTO      L1SUMT10
.
L1SUMT90  MOVE      ONE,OVERFLOW
.
L1SUMT99  RETURN
.
.------------------------------------------------------------------------------
. Casemix Extract - Level 2 Summary Table
.------------------------------------------------------------------------------
L2SUMT00  MOVE      ZERO,ROWCOUNT
          MOVE      ZERO,OVERFLOW
          PACK      KEY10,CEXTRKEY,SP70
          PACK      KEY20,KEY10,SP70
          CALL      RSCCED1
L2SUMT10  CALL      RKCCED1
          BRANCH    OVRCD,L2SUMT99
          PACK      KEY10,CEXTRKEY,SP70
          MATCH     KEY10,CCEDLV1
          GOTO      L2SUMT99 IF NOT EQUAL
.
          ADD       ONE,ROWCOUNT
          COMPARE   HUND01,ROWCOUNT
          GOTO      L2SUMT90 IF EQUAL
.
          PACK      KEY13,CCEALV2,CCEDLV2,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            PACK      CCXHDES,CCEALV2,SP1,CCEDLV2,SP70
            MATCH     "~~~~~~~~~~",CCEDLV2
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          STRIP     CCXHDES
          MOVELPTR  CCXHDES,LENGTH
          SFORMAT   DESCVAR,LENGTH
          MOVE      CCXHDES,DESCVAR
.
          PACK      KEY30,CCEDLV1,CCEDLV2,SP70
          CLEAR     FUNCLNK1
          APPEND    "javascript:ShowExtract('",FUNCLNK1
          APPEND    KEY30,FUNCLNK1
          APPEND    "','",FUNCLNK1
          APPEND    TWO,FUNCLNK1
          APPEND    "')",FUNCLNK1
          RESET     FUNCLNK1
.
          CLEAR     FUNCLNK2
          APPEND    "javascript:ShowEpisodes('",FUNCLNK2
          APPEND    KEY30,FUNCLNK2
          APPEND    "','",FUNCLNK2
          APPEND    TWO,FUNCLNK2
          APPEND    "')",FUNCLNK2
          RESET     FUNCLNK2
.
          MOVE      CCEDFTC,DISINC
          MOVE      CCEDTTC,DISCST
          MOVE      CCEDLTO,DISBED
          ASSIGN    CCEDLTO/CCEDNEP,DISALS
          WRITE     HTMLFILE;"t.addRow(",QUOTE,DESCVAR,QUOTE,COMMA:
                                         QUOTE,CCEDLV1,CCEDLV2,QUOTE,COMMA:
                                         QUOTE,CCEDNEP,QUOTE,COMMA:
                                         QUOTE,DISINC,QUOTE,COMMA:
                                         QUOTE,DISCST,QUOTE,COMMA:
                                         QUOTE,DISBED,QUOTE,COMMA:
                                         QUOTE,DISALS,QUOTE,COMMA:
                                         QUOTE,TWO,QUOTE,COMMA:
                                         QUOTE,FUNCLNK1,QUOTE,COMMA:
                                         QUOTE,FUNCLNK2,QUOTE,COMMA:
                                         QUOTE,CCEDLV2,QUOTE,");"
          SFORMAT   DESCVAR,127
          GOTO      L2SUMT10
.
L2SUMT90  MOVE      ONE,OVERFLOW
.
L2SUMT99  RETURN
.
.----------------------------------------------------------------------
. Casemix Extract - Level 3 Summary Table
.----------------------------------------------------------------------
L3SUMT00  MOVE      ZERO,ROWCOUNT
          MOVE      ZERO,OVERFLOW
          PACK      KEY20,CEXTRKEY,SP70
          PACK      KEY30,KEY20,SP70
          CALL      RSCCEE1
L3SUMT10  CALL      RKCCEE1
          BRANCH    OVRCD,L3SUMT99
          PACK      KEY20,CCEELV1,CCEELV2,SP70
          MATCH     CEXTRKEY,KEY20
          GOTO      L3SUMT99 IF NOT EQUAL
.
          ADD       ONE,ROWCOUNT
          COMPARE   HUND01,ROWCOUNT
          GOTO      L3SUMT90 IF EQUAL
.
          PACK      KEY13,CCEALV3,CCEELV3,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEELV3
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          STRIP     CCXHDES
          MOVELPTR  CCXHDES,LENGTH
          SFORMAT   DESCVAR,LENGTH
          MOVE      CCXHDES,DESCVAR
.
          PACK      KEY30,CCEELV1,CCEELV2,CCEELV3,SP70
          CLEAR     FUNCLNK1
          APPEND    "javascript:ShowExtract('",FUNCLNK1
          APPEND    KEY30,FUNCLNK1
          APPEND    "','",FUNCLNK1
          APPEND    THREE,FUNCLNK1
          APPEND    "')",FUNCLNK1
          RESET     FUNCLNK1
.
          CLEAR     FUNCLNK2
          APPEND    "javascript:ShowEpisodes('",FUNCLNK2
          APPEND    KEY30,FUNCLNK2
          APPEND    "','",FUNCLNK2
          APPEND    THREE,FUNCLNK2
          APPEND    "')",FUNCLNK2
          RESET     FUNCLNK2
.
          MOVE      CCEEFTC,DISINC
          MOVE      CCEETTC,DISCST
          MOVE      CCEELTO,DISBED
          ASSIGN    CCEELTO/CCEENEP,DISALS
          WRITE     HTMLFILE;"t.addRow(",QUOTE,DESCVAR,QUOTE,COMMA:
                                         QUOTE,CCEELV1,CCEELV2,CCEELV3,QUOTE:
                                               COMMA:
                                         QUOTE,CCEENEP,QUOTE,COMMA:
                                         QUOTE,DISINC,QUOTE,COMMA:
                                         QUOTE,DISCST,QUOTE,COMMA:
                                         QUOTE,DISBED,QUOTE,COMMA:
                                         QUOTE,DISALS,QUOTE,COMMA:
                                         QUOTE,THREE,QUOTE,COMMA:
                                         QUOTE,FUNCLNK1,QUOTE,COMMA:
                                         QUOTE,FUNCLNK2,QUOTE,COMMA:
                                         QUOTE,CCEELV3,QUOTE,");"
          SFORMAT   DESCVAR,127
          GOTO      L3SUMT10
.
L3SUMT90  MOVE      ONE,OVERFLOW
.
L3SUMT99  RETURN
.
.------------------------------------------------------------------------------
. Episodes Table (for all Casemix Levels)
.------------------------------------------------------------------------------
EPSTAB00  MATCH     "1",CEXLEVEL
          IF        @EQUAL
            SFORMAT   CEXLVKEY,TEN          * Level 1, Key length = 10
            GOTO      EPSTAB10
          ENDIF
.
          MATCH     "2",CEXLEVEL
          IF        @EQUAL
            SFORMAT   CEXLVKEY,TWENTY       * Level 2, Key length = 20
            GOTO      EPSTAB10
          ENDIF
.
          MATCH     "3",CEXLEVEL
          IF        @EQUAL
            SFORMAT   CEXLVKEY,THIRTY       * Level 3, Key length = 30
            GOTO      EPSTAB10
          ENDIF
.
          GOTO      EPSTAB90
.
EPSTAB10  MOVE      ZERO,ROWCOUNT
          MOVE      ZERO,OVERFLOW
          MOVE      CEXTRKEY,CEXLVKEY            * Set Extract Level Key
          PACK      KEY48,CEXTRKEY,SP70
          CALL      RSCCEC2
EPSTAB20  CALL      RKCCEC2                      * Read Casemix Episode Details
          BRANCH    OVRCD,EPSTAB90
          PACK      KEY30,CCECLV1,CCECLV2,CCECLV3,SP70
.
          MATCH     CEXLVKEY,KEY30
          GOTO      EPSTAB90 IF NOT EQUAL
.
          ADD       ONE,ROWCOUNT
          COMPARE   HUND01,ROWCOUNT
          GOTO      EPSTAB80 IF EQUAL
.
          PACK      KEY18,CCECHCD,CCECEPS,SP70
          CALL      RDCCEP1                      * Read Episode Basic Details
          BRANCH    OVRCD,EPSTAB20
.
          CLEAR     FUNCLNK1
          APPEND    "javascript:EpisodeDetails('",FUNCLNK1
          APPEND    CCEPEPS,FUNCLNK1
          APPEND    "','",FUNCLNK1
          APPEND    CEXLEVEL,FUNCLNK1
          APPEND    "')",FUNCLNK1
          RESET     FUNCLNK1
.
          MOVE      CCEPAGEY,DISAGE
          MOVE      CCECLOS,DISBED
          MOVE      CCECFTC,DISINC
          MOVE      CCECTTC,DISCST
          WRITE     HTMLFILE;"t.addRow(",QUOTE,CCECEPS,QUOTE,COMMA:
                                         QUOTE,CCECLV1,CCECLV2,CCECLV3,QUOTE:
                                               COMMA:
                                         QUOTE,DISAGE,QUOTE,COMMA:
                                         QUOTE,CCEPSEX,QUOTE,COMMA:
                                         QUOTE,DISBED,QUOTE,COMMA:
                                         QUOTE,DISINC,QUOTE,COMMA:
                                         QUOTE,DISCST,QUOTE,COMMA:
                                         QUOTE,CEXLEVEL,QUOTE,COMMA:
                                         QUOTE,FUNCLNK1,QUOTE,COMMA:
                                         QUOTE,CCEPSUR,QUOTE,");"
.
          GOTO      EPSTAB20
.
EPSTAB80  MOVE      ONE,OVERFLOW
.
EPSTAB90  SFORMAT   CEXLVKEY,127
.
EPSTAB99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Level 1 Income/L.O.S Analysis
.------------------------------------------------------------------------------
LVL1AN00  PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      EXTRACID,KEYSTARR[1]    * Extract ID
          MOVE      RPFORMAT,KEYSTARR[2]    * Report Format
          MOVE      RPCNFINT,KEYSTARR[3]    * Confidence Interval
          MOVE      RPSEQNCE,KEYSTARR[4]    * Report Sequence
          MOVE      FIVE,KEYSTARR[5]        * Select Opn 5 - Set Level 1 Range
          MOVE      RPLV1CFR,KEYSTARR[6]    * Level 1 Code From
          MOVE      RPLV1CTO,KEYSTARR[7]    * Level 1 Code To
          MOVE      "P",KEYSTARR[8]         * P - Print Report
          MOVE      EIGHT,KEYSTCNT
.
          CALL      SCHPRO00   * Schedule Extract
.
LVL1AN99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Level 2 Income/L.O.S Analysis
.------------------------------------------------------------------------------
LVL2AN00  PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      EXTRACID,KEYSTARR[1]    * Extract ID
          MOVE      RPFORMAT,KEYSTARR[2]    * Report Format
          MOVE      RPCNFINT,KEYSTARR[3]    * Confidence Interval
          MOVE      RPSEQNCE,KEYSTARR[4]    * Report Sequence
          MOVE      RPLV1PBR,KEYSTARR[5]    * Level 1 Page Break
          MOVE      FIVE,KEYSTARR[6]        * Select Opn 5 - Set Level 1 Range
          MOVE      RPLV1CFR,KEYSTARR[7]    * Level 1 Code From
          MOVE      RPLV1CTO,KEYSTARR[8]    * Level 1 Code To
          MOVE      SIX,KEYSTARR[9]         * Select Opn 6 - Set Level 2 Range
          MOVE      RPLV2CFR,KEYSTARR[10]   * Level 2 Code From
          MOVE      RPLV2CTO,KEYSTARR[11]   * Level 2 Code To
          MOVE      "P",KEYSTARR[12]        * P - Print Report
          MOVE      TEN2,KEYSTCNT
.
          CALL      SCHPRO00   * Schedule Extract
.
LVL2AN99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Level 3 Income/L.O.S Analysis
.------------------------------------------------------------------------------
LVL3AN00  PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      EXTRACID,KEYSTARR[1]    * Extract ID
          MOVE      RPFORMAT,KEYSTARR[2]    * Report Format
          MOVE      RPCNFINT,KEYSTARR[3]    * Confidence Interval
          MOVE      RPSEQNCE,KEYSTARR[4]    * Report Sequence
          MOVE      RPLV1PBR,KEYSTARR[5]    * Level 1 Page Break
          MOVE      RPLV2PBR,KEYSTARR[6]    * Level 2 Page Break
          MOVE      FIVE,KEYSTARR[7]        * Select Opn 5 - Set Level 1 Range
          MOVE      RPLV1CFR,KEYSTARR[8]    * Level 1 Code From
          MOVE      RPLV1CTO,KEYSTARR[9]    * Level 1 Code To
          MOVE      SIX,KEYSTARR[10]        * Select Opn 6 - Set Level 2 Range
          MOVE      RPLV2CFR,KEYSTARR[11]   * Level 2 Code From
          MOVE      RPLV2CTO,KEYSTARR[12]   * Level 2 Code To
          MOVE      SEVEN,KEYSTARR[13]      * Select Opn 7 - Set Level 3 Range
          MOVE      RPLV3CFR,KEYSTARR[14]   * Level 3 Code From
          MOVE      RPLV3CTO,KEYSTARR[15]   * Level 3 Code To
          MOVE      "P",KEYSTARR[16]        * P - Print Report
          MOVE      TEN6,KEYSTCNT
.
          CALL      SCHPRO00   * Schedule Extract
.
LVL3AN99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Episode Outlier Analysis
.------------------------------------------------------------------------------
EOUTAN00  MOVE      "IBACIA54",SCHDPGID
          MOVE      "CIAS - Episode Outlier Analysis",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      EXTRACID,KEYSTARR[1]    * Extract ID
          MOVE      RPAVRLOS,KEYSTARR[2]    * Average Length of Stay
          MOVE      RPAVRINC,KEYSTARR[3]    * Average Income
          MOVE      RPAVRCST,KEYSTARR[4]    * Average Cost
          MOVE      RPLV1PBR,KEYSTARR[5]    * Page Break
          MOVE      TWO,KEYSTARR[6]         * Select Opn 2 - Set Level 1 Range
          MOVE      RPLV1CFR,KEYSTARR[7]    * Level 1 Code From
          MOVE      RPLV1CTO,KEYSTARR[8]    * Level 1 Code To
          MOVE      "P",KEYSTARR[9]         * P - Print Report
          MOVE      NINE,KEYSTCNT
.
          CALL      SCHPRO00   * Schedule Extract
.
EOUTAN99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Extract Excluded Episodes Listing
.------------------------------------------------------------------------------
EXCEPS00  MOVE      "IBACIA66",SCHDPGID
          MOVE      "CIAS - Extract Excluded Episodes",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      EXTRACID,KEYSTARR[1]    * Extract ID
          MOVE      TWO,KEYSTARR[2]         * Select Opn 2 - Set Level 1 Range
          MOVE      RPLV1CFR,KEYSTARR[3]    * Level 1 Code From
          MOVE      RPLV1CTO,KEYSTARR[4]    * Level 1 Code To
          MOVE      "P",KEYSTARR[5]         * P - Print Report
          MOVE      FIVE,KEYSTCNT
.
          CALL      SCHPRO00   * Schedule Extract
.
EXCEPS99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Code Listings
.------------------------------------------------------------------------------
CODLST00  MOVE      "IBACIA97",SCHDPGID
          MOVE      "CIAS - Code Listings",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      RPOPTION,KEYSTARR[1]    * Report Option 
          MATCH     "5",RPOPTION
          IF        @EQUAL
            MOVE      RPCSTYPE,KEYSTARR[2]  * Casemix Type
            MOVE      TWO,KEYSTCNT
          ELSE
            MOVE      ONE,KEYSTCNT
          ENDIF
. 
          CALL      SCHPRO00   * Schedule Extract
.
CODLST99  RETURN
.
.------------------------------------------------------------------------------
. Schedule Report for Episode Audit Listing
.------------------------------------------------------------------------------
AUDLST00  MOVE      "IBACIA96",SCHDPGID
          MOVE      "CIAS - Episode Audit Listing",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      RPOPTION,KEYSTARR[1]    * Report Option 
          MATCH     "3",RPOPTION
          IF        @EQUAL
            MOVE      SP70,KEYSTARR[2]      * Exit from program
            MOVE      TWO,KEYSTCNT
          ELSE
            MOVE      RPDELAUD,KEYSTARR[2]  * Delete Audit File Flag
            MOVE      SP70,KEYSTARR[3]      * Exit from program
            MOVE      THREE,KEYSTCNT
          ENDIF
.
          CALL      SCHPRO00   * Schedule Extract
.
AUDLST99  RETURN
.
.------------------------------------------------------------------------------
. Misc
.------------------------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0010,MISC0020,MISC0030,MISC0040,MISC0050:
                             MISC0060,MISC0070,MISC0080,MISC0090,MISC0100:
                             MISC0110,MISC0120,MISC0130,MISC0140,MISC0150:
                             MISC0160
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      MISC9999
.
MISC0010  CALL      GRTTL000                * Get Graph Title
          GOTO      MISC9999
.
MISC0020  CALL      LCDSC000                * Get Level Code Description
          GOTO      MISC9999
.
MISC0030  CALL      CLVLNK00                * Casemix Level Link
          GOTO      MISC9999
.
MISC0040  WRITE     HTMLFILE;CEXLEVEL;      * Current Extract Level
          GOTO      MISC9999
.
MISC0050  WRITE     HTMLFILE;CEXTRKEY;      * Current Extract Key
          GOTO      MISC9999
.
MISC0060  WRITE     HTMLFILE;CCCOCD1;       * Cost Component Desc 1
          GOTO      MISC9999
.
MISC0070  WRITE     HTMLFILE;CCCOCD2;       * Cost Component Desc 2
          GOTO      MISC9999
.
MISC0080  WRITE     HTMLFILE;CCCOCD3;       * Cost Component Desc 3
          GOTO      MISC9999
.
MISC0090  WRITE     HTMLFILE;CCCOCD4;       * Cost Component Desc 4
          GOTO      MISC9999
.
MISC0100  WRITE     HTMLFILE;CCCOCD5;       * Cost Component Desc 5
          GOTO      MISC9999
.
MISC0110  WRITE     HTMLFILE;CCCOIA1;       * User Def Accom 1 Desc
          GOTO      MISC9999
.
MISC0120  WRITE     HTMLFILE;CCCOIA2;       * User Def Accom 2 Desc
          GOTO      MISC9999
.
MISC0130  WRITE     HTMLFILE;CCCOIA3;       * User Def Accom 3 Desc
          GOTO      MISC9999
.
MISC0140  WRITE     HTMLFILE;CCCOIM1;       * User Def Misc 1 Desc
          GOTO      MISC9999
.
MISC0150  WRITE     HTMLFILE;CCCOIM2;       * User Def Misc 2 Desc
          GOTO      MISC9999
.
MISC0160  WRITE     HTMLFILE;CCCOIM3;       * User Def Misc 3 Desc
          GOTO      MISC9999
.
MISC9999  RETURN
.
.------------------------------------------------------------------------------
. Graph Title
.------------------------------------------------------------------------------
GRTTL000  MOVE      CEXLEVEL,F1
          UNPACK    CEXTRKEY,CCEBLV1,CCEDLV2,CCEELV3
          BRANCH    F1,GRTTL010,GRTTL020,GRTTL030
          WRITE     HTMLFILE;CCEADES;
          GOTO      GRTTL999
.
GRTTL010  MOVE      CCEALV1,KEY3
          CALL      RDCCST1
          STRIP     CCSTDES
          MOVELPTR  CCSTDES,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      CCSTDES,VAR
          WRITE     HTMLFILE;VAR," - ";
          SFORMAT   VAR,127
.
          PACK      KEY13,CCEALV1,CCEBLV1,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEBLV1
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          GOTO      GRTTL040
.
GRTTL020  MOVE      CCEALV2,KEY3
          CALL      RDCCST1
          STRIP     CCSTDES
          MOVELPTR  CCSTDES,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      CCSTDES,VAR
          WRITE     HTMLFILE;VAR," - ";
          SFORMAT   VAR,127
.
          PACK      KEY13,CCEALV2,CCEDLV2,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEDLV2
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          GOTO      GRTTL040
.
GRTTL030  MOVE      CCEALV3,KEY3
          CALL      RDCCST1
          STRIP     CCSTDES
          MOVELPTR  CCSTDES,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      CCSTDES,VAR
          WRITE     HTMLFILE;VAR," - ";
          SFORMAT   VAR,127
.
          PACK      KEY13,CCEALV3,CCEELV3,SP70
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEELV3
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
GRTTL040  STRIP     CCXHDES
          MOVELPTR  CCXHDES,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      CCXHDES,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
.
GRTTL999  RETURN
.
.------------------------------------------------------------------------------
. Level Code Description
.------------------------------------------------------------------------------
LCDSC000  MOVE      SP70,CCXHDES            * Initialize Description Field
          UNPACK    CEXTRKEY,CCEBLV1,CCEDLV2,CCEELV3
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,LCDSC010,LCDSC020,LCDSC030
          GOTO      LCDSC999
.
LCDSC010  MATCH     SP70,CCEBLV1
          GOTO      LCDSC040 IF EQUAL
.
          PACK      KEY13,CCEALV1,CCEBLV1,SP70   * Level 1 Code Desc
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEBLV1
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          GOTO      LCDSC040
.
LCDSC020  MATCH     SP70,CCEDLV2
          GOTO      LCDSC040 IF EQUAL
.
          PACK      KEY13,CCEALV2,CCEDLV2,SP70   * Level 2 Code Desc
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEDLV2
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
          GOTO      LCDSC040
.
LCDSC030  MATCH     SP70,CCEELV3
          GOTO      LCDSC040 IF EQUAL
.
          PACK      KEY13,CCEALV3,CCEELV3,SP70   * Level 3 Code Desc
          CALL      RDCCXH1
          IF        OVRCD=1
            MOVE      KEY13,CCXHDES
            MATCH     "~~~~~~~~~~",CCEELV3
            IF        @EQUAL
              MOVE      "Other",CCXHDES
            ENDIF
          ENDIF
.
LCDSC040  STRIP     CCXHDES
          MOVELPTR  CCXHDES,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      CCXHDES,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
.
LCDSC999  RETURN
.
.------------------------------------------------------------------------------
. Casemix Level Link
.------------------------------------------------------------------------------
CLVLNK00  UNPACK    CEXTRKEY,CCEBLV1,CCEDLV2,CCEELV3
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,CLVLNK10,CLVLNK20,CLVLNK30
          GOTO      CLVLNK99
.
CLVLNK10  CLEAR     FUNCLNK1
          APPEND    "ciaweb03.pbl?reportno=1&template=1&extracid=",FUNCLNK1
          APPEND    EXTRACID,FUNCLNK1
          RESET     FUNCLNK1
          WRITE     HTMLFILE;FUNCLNK1;
          GOTO      CLVLNK99
.
CLVLNK20  CLEAR     FUNCLNK1
          APPEND    "ciaweb03.pbl?reportno=1&template=3&extracid=",FUNCLNK1
          APPEND    EXTRACID,FUNCLNK1
          APPEND    "&cextrkey=",FUNCLNK1
          APPEND    CCEBLV1,FUNCLNK1
          APPEND    "&cexlevel=",FUNCLNK1
          APPEND    ONE,FUNCLNK1
          RESET     FUNCLNK1
          WRITE     HTMLFILE;FUNCLNK1;
          GOTO      CLVLNK99
.
CLVLNK30  CLEAR     FUNCLNK1
          APPEND    "ciaweb03.pbl?reportno=1&template=5&extracid=",FUNCLNK1
          APPEND    EXTRACID,FUNCLNK1
          APPEND    "&cextrkey=",FUNCLNK1
          APPEND    CCEBLV1,FUNCLNK1
          APPEND    CCEDLV2,FUNCLNK1
          APPEND    "&cexlevel=",FUNCLNK1
          APPEND    TWO,FUNCLNK1
          RESET     FUNCLNK1
          WRITE     HTMLFILE;FUNCLNK1;
          GOTO      CLVLNK99
.
CLVLNK99  RETURN
.
.------------------------------------------------------------
. Routine to Calculate Standard Deviation (CCSTDDEV)
.          given the Statistical Variance (CCVARIAN)
.------------------------------------------------------------
CALSD000  MOVE      ZERO,CCSTDDEV
          COMPARE   ZERO,CCVARIAN
          GOTO      CALSD999 IF EQUAL
          GOTO      CALSD999 IF LESS
          COMPARE   "999999999999.9999",CCVARIAN  * Out of Bounds
          GOTO      CALSD999 IF EQUAL
.
          MOVE      "10000",CCFACTOR
.
CALSD100  ADD       CCFACTOR,CCSTDDEV
          ASSIGN    (CCSTDDEV*CCSTDDEV),CCTSTVAR
          COMPARE   CCVARIAN,CCTSTVAR
          GOTO      CALSD999 IF EQUAL           * have the root
          GOTO      CALSD100 IF LESS
.
          SUB       CCFACTOR,CCSTDDEV
.
          DIV       "10",CCFACTOR
          COMPARE   ".01",CCFACTOR
          GOTO      CALSD100 IF NOT EQUAL
.
CALSD999  RETURN
.
.-------------------------------
. Includes for I/O 
.-------------------------------
          INC       IBAWEBCD
          INC       RSHWEBCD
          INC       CCSCEATM
          INC       CCSCEXTM
          INC       CCSCEBTM
          INC       CCSCEDTM
          INC       CCSCEETM
          INC       CCSCECTM
          INC       CCSEPSTM
          INC       CCSIADTM
.
          INC       CCSCEAIO/INC
          INC       CCSCEBIO/INC
          INC       CCSCECIO/INC
          INC       CCSCEDIO/INC
          INC       CCSCEEIO/INC
          INC       CCSCEFIO/INC
          INC       CCSCEGIO/INC
          INC       CCSCEXIO/INC
          INC       CCSCOPCD
          INC       CCSEPSIO/INC
          INC       CCSHCDIO/INC
          INC       CCSIADIO/INC
          INC       CCSSTYIO/INC
          INC       CCSXHDIO/INC
.
          INC       CEAPPMIO/INC
.
          INC       PATDO1IO/INC            * Doctors file
          INC       PATVADIO/INC            * Transfer Source Codes
          INC       PMSHCPIO/INC            * HCP file
          INC       NAMSTRCD                * Create Name String
          INC       PATDOCTM
          INC       PATDOCCD
