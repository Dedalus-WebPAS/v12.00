.*****************************************************************************
.*    Program      : F11PMQVI                                                *
.*    Description  : Conversion pmsqviaf to new File layout                  *
.*                                                                           *
.*    Author       : Davin Sloan                                             *
.*    Date         : 22/10/2008                                              *
.*    Modifications: V9.11.01  Ebon Clements  CAR 184296                     *
.*                             Changed PKNAME from 20 to 30 characters       *
.*                   V9.11.00  Davin          CAR 175736                     *
.*                             Created program                               *
.*****************************************************************************
.
.  Global change F11PMQVI  eg F57PTDOC
.  Global change PMSQVIFD  eg PATDOCFD (new layout)
.  Global change pmsqviaf  eg patdoctf
.  Global change PMSQVIA1  eg PATDOCT1
.  Global change KEY22     eg KEY8
.  Global change WRPMQVI1  eg WRDOCT1
.  Global change spmqviaf  eg sptdoctf
.
.  vi Global change command  :%s/FromString/ToString/g
.
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
. Enter the first or the shortest index from the original FD and rename
. the index OLDFILE
.   
OLDFILE   IFILE SQL, FIXED=1568, KEY="U1-20,21-22"
.
.                                     ******** copy the old FD here *******
.                                     * comment out all continuing fields and
.                                     * prefix changing fields with "OLD" -
.                                     * remove old Indexes and Redefines     
.Name      Type   Length  Physical Start Description
.----      ----   ------  -------- ----- -----------
.DPMQVMES  DIM     20       20        1  Message Id
.....
XXPKNAME   DIM      20       20    1320   PERSON RESP FOR A/C NAME
.
OLDSPAR    DIM      8        8     1560  Spare Variable
.
.End of Record                     1568
.
.
.                                     ******** copy the new FD here *******
.>>>>
PMSQVIA1   IFILE SQL, FIXED=1615, KEY="U1-20,21-22"
.
.Name      Type   Length  Physical Start Description
.----      ----   ------  -------- ----- -----------
DPMQVMES   DIM      20       20       1  Message Id
DPMQVTRN   DIM       2        2      21  Transaction Number
.
.          PATMI1FD variables
.
AADMNO    FORM      8        5      23  PATIENT ADMISSION NO.
AURNO     DIM       8        8      28  PATIENT U.R NO.
ADATE     DIM       8        8      36  Admission Date (CCYYMMDD)
ATIME     DIM       8        8      44  PATIENT ADMISSION TIME
AINVPRT   FORM      2        2      52  NUMBER OF INVOICES PRINTED
ALACDTE   DIM       8        8      54  last accom date invd (CCYYMMDD)
ACANCEL   DIM       3        3      62  REASON PRE-ADMMSS CANCELATION
ADOCTR    DIM       6        6      65  DOCTOR REFERRED BY.
ADOCTL    DIM      30       30      71  LOCAL DOCTOR
ASRCE     DIM       3        3     101  PATIENT ADMISSIONS SOURCE  (CAT S )
ACLSS     DIM       3        3     104  PATIENT ADMISSIONS CLASS   (CAT P )
ACARE     DIM       3        3     107  PATIENT CARE CLASS         (CAT CC)
AFUNDH    DIM       6        6     110  PATIENT HEALTH FUND
AFNDTB    DIM       8        8     116  PATIENT FUND TABLE
AFNDMM    DIM      10       10     124  PATIENT FUND MEMBERSHIP NO
AELIG     FORM      1        2     134  PATIENT ELIGABILITY FOR GOV'T
.                                         REBATE. 1 = YES  2 = NO
.                                         STH - DISCHARGE DIAG.PRINTED
AVISIT    FORM      1        2     136  PATIENT RELIGIOUS VISIT
.                                                 1 = YES, 2 = NO
AALERG    FORM      1        2     138  PATIENT ALLERGIES (Y/N)
.                                                 1 = YES, 2 = NO
AILLN     FORM      1        2     140  PRE-EXISTING ILLNESS
.                                                 1 = YES, 2 = NO
ADIAG1    DIM      50       50     142  PATIENTS ADMITTING DIAG 1
ADIAG2    DIM      50       50     192   "   "     "   "     "  2
ADISC     FORM      6.2      5     242  PATIENT DISCOUNT PERCENTAGE
ADOCTT    DIM       6        6     247  TREATING DOCTOR
AALLOW    DIM       2        2     253  PATIENT ALLOWANCE CODE
AMBS      DIM       9        9     255  ADMITTING MBS CODE
ACLAIM    DIM       3        3     264  CLAIM CODE (CAT CL)
ADIET     DIM       3        3     267  DIET CODE (CAT DC)
APLOCCR   DIM       3        3     270  PLACE OF OCCR (CATEGORY PO)
ASTAY     FORM      3        3     273  EXPECTED LENGTH OF STAY (DAYS)
ADYHOSP   FORM      3        3     276  No OF DAYS OF HOSPITALIZATION
AMEMB     FORM      1        2     279  DIAMOND VALLEY MEMBERSHIP
.                                                 1 = YES, 2 = NO
AMEMBNO   FORM      6        4     281  MEMBERSHIP NUMBER
ACOMM1    DIM      40       40     285  COMMENTS FIELD 1
ACOMM2    DIM      30       30     325  COMMENTS FIELD 2
APLUR     FORM      1        2     355  PLURATILY OF BABY (0=NORMAL)
APURGE    FORM      1        2     357  PURGE INDICATOR
.                                                 OTHER = NO PURGE
.                                                 1     = PARTIAL
.                                                 2     = FULLY
AUSR1     DIM       3        3     359  USER DEFINED FIELD 1 (CAT U1)
AUSR2     DIM       3        3     362  USER DEFINED FIELD 2 (CAT U2)
AUSR3     DIM       3        3     365  USER DEFINED FIELD 3 (CAT U3)
AUSR4     DIM       3        3     368  USER DEFINED FIELD 4 (CAT U4)
AUSR5     DIM       3        3     371  USER DEFINED FIELD 5 (CAT U5)
AUSR6     DIM       3        3     374  USER DEFINED FIELD 6 (CAT U6)
.                                                 - Clinic Unit No. for Publics
AUSR7     DIM       3        3     377  USER DEFINED FIELD 7 (CAT U7)
.                                                 - Coding status for Publics
ADSCHI    FORM      1        2     380  DISCHARGE INVOICE INDICATOR
.                                                 0 = Discharge inv not printed
.                                                 1 = Have printed discharge inv
ARDRNAM   DIM      22       22     382  FREE FORMAT REFERRING DOCTOR
AFNDYY    DIM       2        2     404  YRS OF FUND MEMBERSHIP (JR,DE)
AFNDCG    DIM       6        6     406  fund cover change (CCYYMM)
AOCCDTE   DIM       8        8     412  DATE OF OCCURANCE (CCYYMMDD)
ACODDTE   DIM       8        8     420  DATE CODING COMPLETED
ARETDTE   DIM       8        8     428  EXPECTED RETURN DATE FROM LVE
AMUMADM   FORM      8        5     436  MOTHERS ADMSS NUMBER(IF BABY)
PTMIPVIS  FORM      3        3     441  No of prev. visits charged
ABWGHT    DIM       6        6     444  Baby's /Admission weight
PTMSRFGP  DIM       8        8     450  Referring GP.
PTMSGPPC  DIM       6        6     458  GP Practice Code
PTMSFHAN  DIM      20       20     464  GPFH Approval Number
PTMSECRA  DIM      20       20     484  ECR Approval Number
PTMSMGIN  DIM       3        3     504  Management Intent   (CAT MI)
PTMIDDIG  FORM      1        2     507  Discharged diagnosis printed?
PTMIGPPT  DIM       2        2     509  GP Practice count
PTMIDOFR  DIM       3        3     511  District of Residence (Cat DA)
PTMIREFD  DIM       8        8     514  Date of Referral (EDI nz)
PTMIDFCN  DIM       8        8     522  Date of 1st consultation (EDI nz)
PTMIPHPU  DIM       3        3     530  Principle Health Service Purchaser
.                                         (EDI nz) (CAT HP)
PTMIAGNC  DIM       3        3     533  Health Agency (EDI nz) (CAT HA)
PTMIESSF  DIM       1        1     536  Event Summary supress flag Y/N(EDI nz)
.                                         "Y" = Suppress event summary
.                                         "N" = Don't supress
PTMIUSR8  DIM       3        3     537  User defined field 8 (CAT U8)
PTMIUSR9  DIM       3        3     540  User defined field 9 (CAT U9)
PTMIUSR0  DIM       3        3     543  User defined field 0 (CAT U0)
PTMIPDRG  DIM       4        4     546  Provisional DRG
PTMIOPER  DIM       4        4     550  Operator who pre-admitted patient
PTMIXWRD  DIM       3        3     554  Expected Ward for Pre-Admission
PTMIADOC  DIM       6        6     557  Associated Doctor
PTMIREGS  DIM       6        6     563  Registrar
PTMIUYN1  FORM      1        2     569  User Defined Y/N Field (1=Yes, 0=No)
PTMIUYN2  FORM      1        2     571  User Defined Y/N Field (1=Yes, 0=No)
.
.         PATTRNFD variables
.
TWARD     DIM       3        3     573  TRANSFER WARD NUMBER
TBED      DIM       3        3     576  TRANSFER BED NUMBER
TDATE     DIM       8        8     579  TRANSFER DATE (CCYYMMDD)
TTIME     DIM       8        8     587  TRANSFER TIME (HH:MM)
TURNO     DIM       8        8     595  PATIENT U/R  NUMBER
TADMN     FORM      8        5     603  PATIENT ADMISSION  NUMBER
TRATEF    FORM      12.2     8     608  PAT PORTION OF DAILY CHARGE
.                                             Daily rate = TRATEF + TRATEH
.                                                          - TDISC - TALLW
.                                          Accommodation Charge - Nursing Home
TRATEG    FORM      12.2     8     616  GOVERNMENT  CHARGEABLE
TDISC     FORM      12.2     8     624  PAT DISC (SUB FROM TRATEF)
TALLW     FORM      12.2     8     632  PAT ALLOW (SUB FROM TRATEF)
TATYPE    DIM       3        3     640  ADMISSION TYPE
TADOCT    DIM       6        6     643  ATTENDING DOCTOR
TRATEH    FORM      12.2     8     649  H/FND PORTION OF DAILY CHARGE
TEXTRA    FORM      12.2     8     657  EXTRA CHGE PER DAY (PUB HOSP)
TRBTYP    DIM       3        3     665  E.F.R. BED TYPE FOR THIS BED
TRBEND    FORM      3        3     668  END DAY IN RNGE FOR THIS RATE
TCHSTAT   DIM       3        3     671  CHRGEABLE STATUS (USER DEF.2)
.                                          (PUBLIC HOSPITAL ONLY)
TDEPT     DIM       3        3     674  DEPARTMENT CODE (CAT AC)
PTTRLTYP  DIM       3        3     677  Type of Patient leave (Cat TL)
PTTREPNO  FORM      2        2     680  Episode number
.
.         PMSVX1FD variables
.
PMVXVLOC  DIM      40       40     682  Valuables Location
PMVXCFSG  DIM       1        1     722  Claim Form Signed (0=NO,1=YES)
PMVXINGP  DIM       1        1     723  Inform Registered GP (0=NO,1=YES)
PMVXCPTH  DIM       3        3     724  Critical Pathway (Cat PW)
PMVXHCP1  DIM       1        1     727  Notify HCP1 (0=NO,1=YES)
PMVXHCP2  DIM       1        1     728  Notify HCP2 (0=NO,1=YES)
PMVXHCP3  DIM       1        1     729  Notify HCP3 (0=NO,1=YES)
PMVXHCP4  DIM       1        1     730  Notify HCP4 (0=NO,1=YES)
PMVXRHC1  DIM      10       10     731  Referring HCP 1 (pmshcpaf)
PMVXRHC2  DIM      10       10     741  Referring HCP 2 (pmshcpaf)
PMVXRHC3  DIM      10       10     751  Referring HCP 3 (pmshcpaf)
PMVXRHC4  DIM      10       10     761  Referring HCP 4 (pmshcpaf)
PMVXCADM  DIM       3        3     771  Admission Criterion (PRS/2) (Cat VB
PMVXIRAD  DIM       3        3     774  Intent to Readmit (PRS/2) (Cat VR)
PMVXIDUS  DIM       3        3     777  Intend Stay Duration (PRS/2) Cat VI
PMVXCRAV  DIM       3        3     780  Carer Availability (PRS/2) (Cat VK)
PMVXRCCT  DIM       3        3     783  Crit. Care Xfer Reason (PRS/2) (VJ)
PMVXAPWD  DIM       3        3     786  Admitting Point Ward (patwr1af)
PMVXAPBD  DIM       3        3     789  Admitting Point Bed (patwr1af)
PMVXPOWD  DIM       3        3     792  Post-Op Ward (patwr1af)
PMVXPOBD  DIM       3        3     795  Post-Op Bed (patwr1af)
PMVXPSTY  DIM       1        1     798  Parent Staying (0=NO,1=YES)
PMVXVALW  DIM       1        1     799  Visitor Allowed (0=NO,1=YES)
PMVXPALW  DIM       1        1     800  Phone Calls Allowed? (0=NO,1=YES)
PMVXINDC  DIM       1        1     801  Intended Day Case (0=NO,1=YES)
PMVXMDAV  DIM       3        3     802  Mode of Arrival (Cat VM)
PMVXFRMS  DIM       3        3     805  Forms (Cat VF)
PMVXEDC1  DIM      10       10     808  Extra Doctor Code 1 (patdo1af)
PMVXEDC2  DIM      10       10     818  Extra Doctor Code 2 (patdo1af)
PMVXEDC3  DIM      10       10     828  Extra Doctor Code 3 (patdo1af)
PMVXUDF1  DIM      50       50     838  User Defined Free Format 1
PMVXUDF2  DIM      50       50     888  User Defined Free Format 2
PMVXUDF3  DIM      50       50     938  User Defined Free Format 3
PMVXUDF4  DIM      50       50     988  User Defined Free Format 4
PMVXUDT1  DIM      13       13    1038  User Def. Date/Time 1 ccyymmddhh:mm
PMVXUDT2  DIM      13       13    1051  User Def. Date/Time 2 ccyymmddhh:mm
PMVXUDT3  DIM      13       13    1064  User Def. Date/Time 3 ccyymmddhh:mm
PMVXUDT4  DIM      13       13    1077  User Def. Date/Time 4 ccyymmddhh:mm
PMVXUDT5  DIM      13       13    1090  User Def. Date/Time 5 ccyymmddhh:mm
PMVXUDT6  DIM      13       13    1103  User Def. Date/time 6 ccyymmddhh:mm
.
.          PATDSCFD variables
.
DDATE     DIM       8        8    1116   PATIENT DIS. DATE (CCYYMMDD)
DTIME     DIM       8        8    1124   PATIENT DISCHARGE TIME
DSTAT     DIM       3        3    1132   DISCHARGE STATUS      (CAT D )
DDEST     DIM       3        3    1135   DISCHARGE DESTINATION (CAT DD)
DDIAG     DIM      50       50    1138   DISCHARGE DIAGNOSIS
DDIAG2    DIM      50       50    1188   DISCHARGE DIAGNOSIS (PART 2)
DUSD1     DIM       3        3    1238   USER DEFINED FIELD 1 (CAT D1)
DUSD2     DIM       3        3    1241   USER DEFINED FIELD 2 (CAT D2)
DUSD3     DIM       3        3    1244   USER DEFINED FIELD 3 (CAT D3)
DUSD4     DIM       3        3    1247   USER DEFINED FIELD 4 (CAT D4)
DUSD5     DIM       3        3    1250   USER DEFINED FIELD 5 (CAT D5)
DFMBS     DIM       9        9    1253   DISCHARGE DIAGNOSIS CODE
PTDSDMDC  DIM       4        4    1262   MDC code
PTDSDDRG  DIM       4        4    1266   DRG code
DWLREASN  DIM       3        3    1270   Reason Discharged Patient was
.                                                put back on Waiting List (RW)
PTDSSIDX  DIM       1        1    1273   DRG severity index
PTDSVOGU  DIM       3        3    1274   Vers grouper used when grouping
PTDSOPER  DIM       4        4    1277   Operator who discharged patie
PTDSUYN1  FORM      1        2    1281   User Defined Y/N Field 1
PTDSUYN2  FORM      1        2    1283   User Defined Y/N Field 2
PTDSUYN3  FORM      1        2    1285   User Defined Y/N Field 3
PTDSUYN4  FORM      1        2    1287   User Defined Y/N Field 4
.
.          MEHLERFD variables
.
MHLRCODE  DIM       3        3    1289  Leave end reason code (CAT LE)
.
PMVXRH1G  DIM      10       10    1292  Referring HCP 1 Practice (pmshclaf)
PMVXRH1C  DIM       2        2    1302  Referring HCP 1 Grp Count (pmshcgaf
.
.          Other variables
.
PMQVTDAT   DIM      8        8     1304   Transfer Date (for cancelled transfer)
.                                                       (ccyymmdd)
PMQVTTIM   DIM      8        8     1312   Transfer Date (for cancelled transfer)
.                                                       (hh:mm:ss)
.
.          PATRE1FD variables
.
PKNAME    DIM      30       30    1320   PERSON RESP FOR A/C NAME
PKADD1    DIM      35       35    1350   P.R.A ADDRESS LINE 1
PKADD2    DIM      35       35    1385   P.R.A ADDRESS LINE 2
PKSUBR    DIM      35       35    1420   P.R.A SUBURB
PKADD4    DIM      35       35    1455   P.R.A ADDRESS LINE 2
PKPOST    DIM       8        8    1490   P.R.A POSTCODE
PKTELEP   DIM      20       20    1498   P.R.A PRIVATE TELEPHONE
PKTELEB   DIM      20       20    1518   P.R.A BUSINESS TELEPHONE
PKRELP    DIM      10       10    1538   P.R.A RELATIONSHIP
.
ASTAT     FORM     1        2     1548   Admission Status
.                                             1 = Pre-Admission
.                                             2 = Current Admission
.                                             3 = Discharged
.                                             4 = On Leave
.                                             5 = Cancelled
.
PTREMOBL  DIM      20       20    1550   P.R.A MOBILE TELEPHONE
.
.          PATWR1FD variables
.
WSTBY     FORM     8        5     1570   Standby Number
PMQVSPAR   DIM      40       40    1575   Spare Variable
.
.End of Record                     1615
.
. Redefine form fields from key
. -----------------------------
PMQVMESI  FORM      20
PMQVTRAN  FORM      2
.>>>>
.
CMDLINE   DIM       100
DIM4      DIM       4
DIM4A     DIM       4
DIM6      DIM       6
DIM6A     DIM       6
DIM60     DIM       60
DDCENT    DIM       2
.
RECNUM    FORM      8
NEWFILE   DIM       60
NEWPATH   DIM       60
OLDPATH   DIM       60
DEFPATH   DIM       60
SAVEFLG   FORM      1
SP50      INIT    "                                                  "
SP60      INIT    "                                                            "
.
PRGNAM    INIT      "CONVERSION PMSQVIFD"
PRGID     INIT      "F11PMQVI"
VERSION   INIT      "V12.00.00"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      KDIR0000                      * Keyin directory
          BRANCH    EXIT,MAIN9999
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
MAIN1000  CALL      PREP0000                      * preparing files
          BRANCH    EXIT,MAIN9999
.
. Loop thru old file and write records to new file
.
          CALL      READ0000                      * read old records and write
          CALL      ENDP0000                      * save/compress saved file
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
          
INIT9999  RETURN
.
.********************************************************************
.*                          KDIR0000                                *
.*  Keyin directories                                               *
.********************************************************************
KDIR0000  MOVE      ONE,SAVEFLG        * Default to keep file
          KEYIN     *P1:10,*EL,"Do you want to save the original file (Y/N) ? ":
                    ANS;
          REP       "yYnN",ANS
          CMATCH    "Y",ANS
          GOTO      KDIR1000 IF EQUAL
          MOVE      ZERO,SAVEFLG       * not to keep file
          CMATCH    "N",ANS
          GOTO      KDIR1000 IF EQUAL
          BEEP
          GOTO      KDIR0000
.
KDIR1000  CALL      DEFT0000                * Get the default path
          BRANCH    EXIT,KDIR9999
          MOVE      SP60,OLDPATH
.
          DISPLAY   *P1:24,*EL,"The directory path must end with a slash (/) ";
.
          MOVE      DEFPATH,OLDPATH
          BRANCH    SAVEFLG,KDIR2000
.
.         Keyin the path for the original file
.
          KEYIN     *P1:12,*EL,"Keyin path for temporarily saving original ":
                    "file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
          GOTO      KDIR3000
.
KDIR2000  KEYIN     *P1:12,*EL,"Keyin path for saving original file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
.
KDIR3000  ENDSET    OLDPATH
          APPEND    SP60,OLDPATH
          RESET     OLDPATH
.
          MATCH     SP60,OLDPATH
          IF        @EQUAL
            PACK      OLDPATH,DEFPATH      * use the default
            DISPLAY   *P10:13,*EL,*V2LON,OLDPATH;
          ENDIF
.
          SQUEEZE   OLDPATH
          CMATCH    EXITCHAR,OLDPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,OLDPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR1000
.
.         Keyin the path for the new file
.
KDIR5000  MOVE      SP60,NEWPATH
          MOVE      DEFPATH,NEWPATH
          KEYIN     *P1:15,*EL,"Keyin path for the new file: ":
                    *P10:16,*EL,*DV,*RV,NEWPATH:
                    *P10:16,NEWPATH;
          ENDSET    NEWPATH
          APPEND    SP60,NEWPATH
          RESET     NEWPATH
.
          MATCH     SP60,NEWPATH
          IF        @EQUAL
            PACK      NEWPATH,DEFPATH      * use the default
            DISPLAY   *P10:16,*V2LON,NEWPATH;
          ENDIF
.
          SQUEEZE   NEWPATH
          CMATCH    EXITCHAR,NEWPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,NEWPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR5000
          GOTO      KDIR9999
.
KDIR9000  MOVE      ONE,EXIT
KDIR9999  DISPLAY   *P1:24,*EL;
          RETURN
+
.
.********************************************************************
.*                          PREP0000                                *
.*  Preparing files                                                 *
.********************************************************************
PREP0000 
. open old file
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE,"pmsqviaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PREP5000       * Original file does not exist
          CLOSE     OLDFILE
          DISPLAY   *P1:24,*EL,"Copying files ... Please wait !! ";
.
. Copy old file to the keyin directory
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmsqviaf.dat` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmqviaf.dat",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmsqviaf.idx` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmqviaf.idx",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
. remove the original files
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    DEFPATH,CMDLINE
          APPEND    "pmsqviaf",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Unable to remove the original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Opening old file after being copied
.
          MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60
          APPEND    "spmqviaf",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE,DIM60
          TRAPCLR   IO
          IF        OVRCD = 1
            DISPLAY   *P1:24,*EL,*B,"Unable to open saved original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Create the new file
.
          DISPLAY   *P1:24,*EL,"Creating new files ... Please wait !! ";
          PACK      NEWFILE,SP60
          CLEAR     NEWFILE
          APPEND    NEWPATH,NEWFILE
          APPEND    "pmsqviaf",NEWFILE
          APPEND    SP60,NEWFILE
          RESET     NEWFILE
          SQUEEZE   NEWFILE
.
PREP1000  PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    NEWFILE,CMDLINE
.
.  The files new record length and unique key must be written here
.      eg    APPEND    " 195 UC9-16",CMDLINE
.
          APPEND    " 1615 UC1-20,21-22",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.  If the file has more than one index, this piece of code below has 
.  to be repeated with for each individual index
.
.
.
          OPEN      PMSQVIA1,NEWFILE
.
. set the flag to say we want to continue
.
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,"Record : "
          GOTO      PREP9999
.
PREP5000  DISPLAY   *P1:24,*EL,*B,"Old file not found.  ";
          CALL      HITENTER
          GOTO      PREP9000
.
PREP8000  DISPLAY   *P1:24,*EL,*B,"Unable to copy original file.  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
.
PREP9000  MOVE      ONE,EXIT
PREP9999  RETURN
+
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
          PACK      KEY22,SP60
          CALL      READSOLD                      * position at start
READ1000  CALL      READKOLD                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
          ADD       ONE,RECNUM                    * update record counter
.
.  All necessary changes to the files field lengths, date changes
.  or any other sort of modification must be made here
.
.    eg    PACK      DSPARE,SP50
.          PACK      PTDSDMDC,SP10
.          PACK      PTDSDDRG,SP10
.
          PACK      PKNAME,XXPKNAME,SP70
          MOVE      ZERO,WSTBY
          MOVE      OLDSPAR,WSTBY
          MOVE      SP70,PMQVSPAR
.                                             
          PACK      KEY22,PMQVMESI,PMQVTRAN,SP70
          CALL      WRPMQVI1                    * write to new file
.
          IF        (RECNUM%1000) = 0
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     PMSQVIA1                      * close new file
          CLOSE     OLDFILE                       * close old file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
.
READ9999  RETURN
.
+
.**********************************************************************
.*                               VALD0000                             *
.*        Check if it a valid directory                               *
.**********************************************************************
VALD0000  MOVE      ZERO,EXIT
          SQUEEZE   DIM60
          ENDSET    DIM60
          CMATCH    SLASH,DIM60
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory path must end with a slash (/) ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          RESET     DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cd ",CMDLINE
          APPEND    DIM60,CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory does not exist ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          GOTO      VALD9999
.
VALD9000  MOVE      ONE,EXIT            * Not valid
VALD9999  RETURN
+
.**********************************************************************
.*                               ENDP0000                             *
.*        Remove or compress save file                                *
.**********************************************************************
ENDP0000  MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60        * set up the saved file with path
          APPEND    "spmqviaf*",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
          SQUEEZE   DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          IF        SAVEFLG = 1
            APPEND    "compress -f ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Compressing original file.. ":
                      "Please wait !!  ";
          ELSE
            APPEND    "rm ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Removing original file.. Please wait !!  ";
          ENDIF
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Saved file not compressed or removed.  ";
            CALL      HITENTER
            GOTO      ENDP9999
          ENDIF
.
          CALL      IBACLOCK
          DISPLAY   *P1:24,*EL,*B,"Finish processing.  ";
          CALL      HITENTER
.
ENDP9999  RETURN
+
.**********************************************************************
.         Get the default directory
.**********************************************************************
DEFT0000  EXECUTE   "ldat pmsqviaf.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding pmsqviaf.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
DEFT9999  RETURN
+
.
.                  ******************************    OLD IO ROUTINES
.                  Copy the Positional Read (RS or RDS) from original I/O file,
.                  - change Label to READSOLD and the index name to OLDFILE
.
.READSOLD  MOVE      ZERO,OVRCD
.          RESET     KEY6
.          PACK      KEY8,SP2,KEY6
.          READ      OLDFILE,KEY8;;
.          RETURN
.
READSOLD  RESET     KEY22
          READ      OLDFILE,KEY22;;
          RETURN    
.
.
.                  Copy the Read Next (RK or RDK) from the original I/O file
.                  - change Label to READKOLD and the index name to OLDFILE
.                  - change any fields that are changing to a prefix of OLD,
.                    eg. PTEDSPAR becomes OLDDSPAR
.
.READKOLD  MOVE      ZERO,OVRCD
.          READKS    OLDFILE;DDURNO,DDADMNO:
.                             DIM6,DTIME,DSTAT,DDEST:
.                             PTDSVOGU,DSPARE
.          GOTO      OVERCOND IF OVER
.          MOVE      QDURNO,DURNO
.          RETURN
.
READKOLD  MOVE      ZERO,OVRCD    
          READKS    OLDFILE;DPMQVMES,DPMQVTRN,AADMNO,AURNO,ADATE:
                                  ATIME,AINVPRT,ALACDTE,ACANCEL,ADOCTR:
                                  ADOCTL,ASRCE,ACLSS,ACARE,AFUNDH:
                                  AFNDTB,AFNDMM,AELIG,AVISIT,AALERG:
                                  AILLN,ADIAG1,ADIAG2,ADISC,ADOCTT:
                                  AALLOW,AMBS,ACLAIM,ADIET,APLOCCR:
                                  ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                                  ACOMM2,APLUR,APURGE,AUSR1,AUSR2:
                                  AUSR3,AUSR4,AUSR5,AUSR6,AUSR7:
                                  ADSCHI,ARDRNAM,AFNDYY,AFNDCG,AOCCDTE:
                                  ACODDTE,ARETDTE,AMUMADM,PTMIPVIS,ABWGHT:
                                  PTMSRFGP,PTMSGPPC,PTMSFHAN,PTMSECRA,PTMSMGIN:
                                  PTMIDDIG,PTMIGPPT,PTMIDOFR,PTMIREFD,PTMIDFCN:
                                  PTMIPHPU,PTMIAGNC,PTMIESSF,PTMIUSR8,PTMIUSR9:
                                  PTMIUSR0,PTMIPDRG,PTMIOPER,PTMIXWRD,PTMIADOC:
                                  PTMIREGS,PTMIUYN1,PTMIUYN2,TWARD,TBED:
                                  TDATE,TTIME,TURNO,TADMN,TRATEF:
                                  TRATEG,TDISC,TALLW,TATYPE,TADOCT:
                                  TRATEH,TEXTRA,TRBTYP,TRBEND,TCHSTAT:
                                  TDEPT,PTTRLTYP,PTTREPNO,PMVXVLOC,PMVXCFSG:
                                  PMVXINGP,PMVXCPTH,PMVXHCP1,PMVXHCP2,PMVXHCP3:
                                  PMVXHCP4,PMVXRHC1,PMVXRHC2,PMVXRHC3,PMVXRHC4:
                                  PMVXCADM,PMVXIRAD,PMVXIDUS,PMVXCRAV,PMVXRCCT:
                                  PMVXAPWD,PMVXAPBD,PMVXPOWD,PMVXPOBD,PMVXPSTY:
                                  PMVXVALW,PMVXPALW,PMVXINDC,PMVXMDAV,PMVXFRMS:
                                  PMVXEDC1,PMVXEDC2,PMVXEDC3,PMVXUDF1,PMVXUDF2:
                                  PMVXUDF3,PMVXUDF4,PMVXUDT1,PMVXUDT2,PMVXUDT3:
                                  PMVXUDT4,PMVXUDT5,PMVXUDT6,DDATE,DTIME:
                                  DSTAT,DDEST,DDIAG,DDIAG2,DUSD1:
                                  DUSD2,DUSD3,DUSD4,DUSD5,DFMBS:
                                  PTDSDMDC,PTDSDDRG,DWLREASN,PTDSSIDX,PTDSVOGU:
                                  PTDSOPER,PTDSUYN1,PTDSUYN2,PTDSUYN3,PTDSUYN4:
                                  MHLRCODE,PMVXRH1G,PMVXRH1C,PMQVTDAT,PMQVTTIM:
                                  XXPKNAME,PKADD1,PKADD2,PKSUBR,PKADD4:
                                  PKPOST,PKTELEP,PKTELEB,PKRELP,ASTAT:
                                  PTREMOBL,OLDSPAR
          GOTO      OVERCOND IF OVER
          MOVE      DPMQVMES,PMQVMESI
          MOVE      DPMQVTRN,PMQVTRAN
          RETURN
.
.                  ******************************    NEW IO ROUTINES
.                  Copy the Write statement from the new I/O file           
.                  (no changes are needed to this routine)               
.
WRPMQVI1  RESET     KEY22
          MOVE      PMQVMESI,DPMQVMES
          MOVE      PMQVTRAN,DPMQVTRN
          WRITE     PMSQVIA1,KEY22;DPMQVMES,DPMQVTRN,AADMNO,AURNO,ADATE:
                                  ATIME,AINVPRT,ALACDTE,ACANCEL,ADOCTR:
                                  ADOCTL,ASRCE,ACLSS,ACARE,AFUNDH:
                                  AFNDTB,AFNDMM,AELIG,AVISIT,AALERG:
                                  AILLN,ADIAG1,ADIAG2,ADISC,ADOCTT:
                                  AALLOW,AMBS,ACLAIM,ADIET,APLOCCR:
                                  ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                                  ACOMM2,APLUR,APURGE,AUSR1,AUSR2:
                                  AUSR3,AUSR4,AUSR5,AUSR6,AUSR7:
                                  ADSCHI,ARDRNAM,AFNDYY,AFNDCG,AOCCDTE:
                                  ACODDTE,ARETDTE,AMUMADM,PTMIPVIS,ABWGHT:
                                  PTMSRFGP,PTMSGPPC,PTMSFHAN,PTMSECRA,PTMSMGIN:
                                  PTMIDDIG,PTMIGPPT,PTMIDOFR,PTMIREFD,PTMIDFCN:
                                  PTMIPHPU,PTMIAGNC,PTMIESSF,PTMIUSR8,PTMIUSR9:
                                  PTMIUSR0,PTMIPDRG,PTMIOPER,PTMIXWRD,PTMIADOC:
                                  PTMIREGS,PTMIUYN1,PTMIUYN2,TWARD,TBED:
                                  TDATE,TTIME,TURNO,TADMN,TRATEF:
                                  TRATEG,TDISC,TALLW,TATYPE,TADOCT:
                                  TRATEH,TEXTRA,TRBTYP,TRBEND,TCHSTAT:
                                  TDEPT,PTTRLTYP,PTTREPNO,PMVXVLOC,PMVXCFSG:
                                  PMVXINGP,PMVXCPTH,PMVXHCP1,PMVXHCP2,PMVXHCP3:
                                  PMVXHCP4,PMVXRHC1,PMVXRHC2,PMVXRHC3,PMVXRHC4:
                                  PMVXCADM,PMVXIRAD,PMVXIDUS,PMVXCRAV,PMVXRCCT:
                                  PMVXAPWD,PMVXAPBD,PMVXPOWD,PMVXPOBD,PMVXPSTY:
                                  PMVXVALW,PMVXPALW,PMVXINDC,PMVXMDAV,PMVXFRMS:
                                  PMVXEDC1,PMVXEDC2,PMVXEDC3,PMVXUDF1,PMVXUDF2:
                                  PMVXUDF3,PMVXUDF4,PMVXUDT1,PMVXUDT2,PMVXUDT3:
                                  PMVXUDT4,PMVXUDT5,PMVXUDT6,DDATE,DTIME:
                                  DSTAT,DDEST,DDIAG,DDIAG2,DUSD1:
                                  DUSD2,DUSD3,DUSD4,DUSD5,DFMBS:
                                  PTDSDMDC,PTDSDDRG,DWLREASN,PTDSSIDX,PTDSVOGU:
                                  PTDSOPER,PTDSUYN1,PTDSUYN2,PTDSUYN3,PTDSUYN4:
                                  MHLRCODE,PMVXRH1G,PMVXRH1C,PMQVTDAT,PMQVTTIM:
                                  PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4:
                                  PKPOST,PKTELEP,PKTELEB,PKRELP,ASTAT:
                                  PTREMOBL,WSTBY,PMQVSPAR
          RETURN
.
          INC       STD001IO
