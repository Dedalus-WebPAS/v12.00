.******************************************************************************
.* System         : Outpatients                                               *
.*                                                                            *
.* Include Name   : KYOUTDET.PBL                                              *
.*                                                                            *
.* Function       : To keyin the Outpatient details                           *
.*                : also contains MYOUTDET which loads up the variable DIM80  *
.*                  for the routine 'spck0000' for mandatory fields check     *
.*                                                                            *
.* Author         : Justin Coates      14/12/1992                             *
.*                                                                            *
.* Parameters     : SCRPSTFD/SCRSLTFD records                                 *
.*                  ORIGVISI      original number of visits                   *
.*                  ACCEPT        1=insert mode, 2=change mode                *
.*                                                                            *
.* Modifications  :                                                           *
.*        V11.00.01 10/03/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*        V9.03.01  15/08/2003  Jill Habasque CAR 40347                       *
.*                  Fixed default of referring gp                             *
.*        V9.02.02  03/02/2003  Tracey Nguyen  SRF 22709                      *
.*                  Changed open OUTBOKA3 to use site prefix                  *
.*        V9.02.01  20/11/2002  J.Tan                                         *
.*                  Fixed reading hcp file                                    *
.*----------------------------------------------------------------------------*
.*        V5.09.B01 05/01/2001  Greg Horvat                                   *
.*                  Replaced certain variables with KEY?? variables cause     *
.*                  OUT66 couldnt compile                                     *
.*        V5.08.01  2806/2000 Jill Habasque SRF 646875                        *
.*                  Mods to check referral date is not in the future          *
.*        V5.07.00  23/06/99 J.Tan      SRF  632510                           *
.*                  Mods referral date to todays day for non-booked attendaes *
.*        V5.04.04  26/05/1997   Howellsy         rha   
.*                 added obaoutno             
.*        V5.04.03  21/04/1997   Howellsy         rha   
.*                 added otbbrank,obousr5-8
.*        V5.04.02  31/01/1997  Howellsy            NZ                        *
.*                  Added Variables for Screen Painted Labels.                *
.*        V5.04.01  23/08/1996  Howellsy            SRF 641980                *
.*                  Don't default current century for exemption type.         *
.******************************************************************************
.*                  23/03/93 WHIRLPOOL WORLDS BEST SURFER                     *
.*                  Modified GP keyin                                         *
.*                  06/04/93 WHIRLPOOL                                        *
.*                  Fixed EXITCHAR in GP keyin                                *
.*                  02/07/93 WHIRLPOOL                                        *
.*                  Added system default to cat "CL" keyin                    *
.*                  27/10/1993    Justin Coates  (DUDLEY A&E changes)         *
.*                  allow for default value (OTMADFSL) for send letter keyin  *
.*                  allow for the parameter STCNOUTB in MYOUTDET              *
.*                  03/11/1993    Justin Coates  QUOTE 440017 SRF 440204      *
.*                  set up new GP Practice count variable                     *
.*                  07/03/1994    Justin Coates  SRF 440719                   *
.*                  added OTBBDOFR                                            *
.*                  30/03/1994    Justin Coates                               *
.*                  added GP code - not related to a practice                 *
.*                  05/04/1994  Steve Armstrong                               *
.*                  Mods for PATCODKY to PATCODKY                             *
.*                  and PATFNDKY to PATFNDKY                                  *
.*                  04/05/1994  Matt Surridge                                 *
.*                  Fixed Keyin of Health Board.                              *
.*                  22/06/1994  Rob Leonard  SRF 440640                       *
.*                  Fixed Keyin of GP Practice Code                           *
.*----------------------------------------------------------------------------*
.*        V5.02.00  27/09/1994    Rob Leonard  SRF 120024 (Bul23)             *
.*                  Default Claim Code from most Previous Visit               * 
.*        V5.02.01  23/03/1995  Graeme Williams  SRF 135688                   *
.*                  Recompiled for changes to PATFNDKY - blank HF's are now   *
.*                  distinguished from no HF entered.                         *
.*        V5.02.02  03/05/1995    Justin Coates                               *
.*                  made it call SCRKYFRE and not KFREEF00                    *
.*                  added CLOUTDET to clear the keyin variables               *
.*                  change to use patitemn NOT patitemnf                      *
.******************************************************************************
KYOUTDET  MOVE      SCPSITM,FIELDNO
          MOVE      SCPSROW,EVERT
          MOVE      SCPSCOL,ECOL
          MOVE      SCPSROW,CVERT
          MOVE      SCPSCOL,CCOL
          MOVE      SCPSMAN,CKYIMAND
          SFORMAT   KEYFIELD,127
          MOVE      ZERO,EXIT
          BRANCH    FIELDNO,KOTDT001,KOTDT999,KOTDT003,KOTDT999,KOTDT005:
                            KOTDT999,KOTDT007,KOTDT999,KOTDT009,KOTDT999:   10
                            KOTDT011,KOTDT999,KOTDT013,KOTDT014,KOTDT015:
                            KOTDT999,KOTDT017,KOTDT018,KOTDT019,KOTDT999:   20
                            KOTDT021,KOTDT999,KOTDT023,KOTDT999,KOTDT025:
                            KOTDT999,KOTDT027,KOTDT999,KOTDT029,KOTDT999:   30
                            KOTDT031,KOTDT999,KOTDT033,KOTDT034,KOTDT999:
                            KOTDT036,KOTDT037,KOTDT999,KOTDT039,KOTDT999:   40
                            KOTDT041,KOTDT042,KOTDT043,KOTDT044,KOTDT045:
                            KOTDT999,KOTDT047,KOTDT999,KOTDT049,KOTDT999:   50
                            KOTDT051,KOTDT052,KOTDT999,KOTDT054,KOTDT999:
                            KOTDT999,KOTDT999,KOTDT999,KOTDT999,KOTDT999:   60
                            KOTDT999,KOTDT999,KOTDT999,KOTDT999,KOTDT999:     
                            KOTDT999,KOTDT999,KOTDT999,KOTDT999,KOTDT999:   70
                            KOTDT999,KOTDT999,KOTDT999,KOTDT074,KOTDT999:
                            KOTDT076,KOTDT999,KOTDT078,KOTDT999,KOTDT080:   80
                            KOTDT999,KOTDT082,KOTDT999
          BEEP
          GOTO      KOTDT999
.
KOTDT001  CALL      KSOURC00
          GOTO      KOTDT999
KOTDT003  CALL      KCLASS00
          GOTO      KOTDT999
KOTDT005  CALL      KPCATG00
          GOTO      KOTDT999
KOTDT007  CALL      KPPRTY00
          GOTO      KOTDT999
KOTDT009  CALL      KPRESI00
          GOTO      KOTDT999
KOTDT011  CALL      KCOMPC00
          GOTO      KOTDT999
KOTDT013  CALL      KCARDN00
          GOTO      KOTDT999
KOTDT014  CALL      KEXPDT00
          GOTO      KOTDT999
KOTDT015  CALL      KEXEMP00
          GOTO      KOTDT999
KOTDT017  CALL      KPRVIS00
          GOTO      KOTDT999
KOTDT018  CALL      KFAMID00
          GOTO      KOTDT999
KOTDT019  CALL      KU1USR00
          GOTO      KOTDT999
KOTDT021  CALL      KO1USR00
          GOTO      KOTDT999
KOTDT023  CALL      KO2USR00
          GOTO      KOTDT999
KOTDT025  CALL      KO3USR00
          GOTO      KOTDT999
KOTDT027  CALL      KO4USR00
          GOTO      KOTDT999
KOTDT029  CALL      KHFUND00
          GOTO      KOTDT999
KOTDT031  CALL      KBDEPT00
          GOTO      KOTDT999
KOTDT033  CALL      KCOMMT00
          GOTO      KOTDT999
KOTDT034  CALL      KODIAG00
          GOTO      KOTDT999
KOTDT036  CALL      KRFDAT00
          GOTO      KOTDT999
. and now for the new fields...
KOTDT037  CALL      KTRNAL00
          GOTO      KOTDT999
KOTDT039  CALL      KLANGI00
          GOTO      KOTDT999
KOTDT041  CALL      KTFSEN00
          GOTO      KOTDT999
KOTDT042  CALL      KTBOKO00
          GOTO      KOTDT999
KOTDT043  CALL      KGPFHA00
          GOTO      KOTDT999
KOTDT044  CALL      KECRAN00
          GOTO      KOTDT999
KOTDT045  CALL      KREFGP00
          GOTO      KOTDT999
KOTDT047  CALL      KGPCOD00
          GOTO      KOTDT999
KOTDT049  CALL      KVISTY00
          GOTO      KOTDT999
KOTDT051  CALL      KSNDLT00                * Send Letter
          GOTO      KOTDT999
KOTDT052  CALL      KODOFR00                * District of Residence
          GOTO      KOTDT999
KOTDT054  CALL      KGPNPR00                * GP not using practice
          GOTO      KOTDT999
.
KOTDT074  CALL      KO5USR00
          GOTO      KOTDT999
.
KOTDT076  CALL      KO6USR00
          GOTO      KOTDT999
.
KOTDT078  CALL      KO7USR00
          GOTO      KOTDT999
.
KOTDT080  CALL      KO8USR00
          GOTO      KOTDT999
.
KOTDT082  CALL      KPRANK00                * Patient Rank         
          GOTO      KOTDT999
.
KOTDT999  RETURN
+
.*********************************************************************
.         clear the outpatient booking details
.         this should also call DCMN0000 to delete comments
.*********************************************************************
CLOUTDET  UNPACK    SP30,OBASRCR,OBACOMP,OBACLASS,OBAINS,OBAATTN,OBADOCT
          UNPACK    SP30,OBACAT,OBBPORT,OBBCTYP,OBBBOOK,OBAPRTY,OBARSCHD
          UNPACK    SP30,OBACOMM
          UNPACK    SP30,OBOUSR1,OBOUSR2,OBOUSR3,OBOUSR4,OBALADMN,HASCMNS
          UNPACK    SP30,OPDICODE,OTBBFUND,OTBBTBLE,OTBBDEPT
          UNPACK    SP30,OTBCRDAT
          MOVE      ZERO,OTBBPVIS
          MOVE      ZERO,OBAOUTNO
          PACK      OPDIDESC,SP30,SP30
          UNPACK    SP30,OTBBTRAN,OTBBLNGI,OTBBTMFS,OTBBTMBO
          MOVE      SP20,OTBBGPFA
          MOVE      SP20,OTBBECRA
          UNPACK    SP30,OTBBRFGP,OTBBGPPC,OTBBGPPT
          UNPACK    SP30,OTBBADCS,OTBBCITM,OTBBASTM,OTBBDPTM,OTBBOUTC
          UNPACK    SP30,OBOUSR5,OBOUSR6,OBOUSR7,OBOUSR8
          MOVE      "     0",OTBBRANK
          RETURN
+
+
.*********************************************************************
.         loads up the variable for mandatory field check
.         Para's  : FORM5         the variable number to check for
.*********************************************************************
MYOUTDET  LOAD      DIM80,FORM5,OBASRCR,ANSA,OBACLASS,ANSA,OBACAT:
                                ANSA,OBAPRTY,ANSA,PTYPE,ANSA:              10
                                OBACOMP,ANSA,PTVKCARD,PTVKCEXP,PTVKCXMP:
                                ANSA,OTBBPVIS,PTVKFMLY,OBAINS,ANSA:        20
                                OBOUSR1,ANSA,OBOUSR2,ANSA,OBOUSR3:
                                ANSA,OBOUSR4,ANSA,OTBBFUND,ANSA:           30
                                OTBBDEPT,ANSA,ANSA,OPDICODE,OPDIDESC:
                                OTBCRDAT,OTBBTRAN,ANSA,OTBBLNGI,ANSA:      40
                                OTBBTMFS,OTBBTMBO,OTBBGPFA,OTBBECRA,OTBBRFGP:
                                ANSA,OTBBGPPC,ANSA,OBAVISIT,ANSA:          50
                                OTBBSNDL,OTBBDOFR,ANSA,OTBBRFGP,ANSA:
                                ANSA,ANSA,ANSA,ANSA,ANSA:                  60
                                ANSA,ANSA,ANSA,ANSA,ANSA:                  
                                ANSA,ANSA,ANSA,ANSA,ANSA:                  70
                                ANSA,ANSA,ANSA,OBOUSR5,ANSA:
                                OBOUSR6,ANSA,OBOUSR7,ANSA,OBOUSR8:       80
                                ANSA,OTBBRANK,ANSA
          RETURN
+
.------------------------------------------------------------------------------
.         Source of Referral - OBASRCR
.------------------------------------------------------------------------------
KSOURC00  MOVE      OSTCATG,CODE            * Category 
          MOVE      OBASRCR,CKYIDEF3        * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KSOURC95 IF EQUAL       * EXITCHAR entered
          BRANCH    ABORT,KSOURC99          * abort
.
          MOVE      ACODE,OBASRCR           * the code
          CALL      DISPVARS                * redisplay code
.
          MOVE      "    2",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KSOURC90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KSOURC90  MOVE      ZERO,EXIT
          GOTO      KSOURC99
KSOURC95  MOVE      ONE,EXIT
.
KSOURC99  RETURN
.
.------------------------------------------------------------------------------
.         Patient Classification - OBACLASS
.------------------------------------------------------------------------------
KCLASS00  PACK      CODE,ANSA,SP1           * Category 
          MOVE      OBACLASS,CKYIDEF3        * Default code
          IF        OBASTAT=4
            MOVE      ONE,CKYIMAND             * field is mand. for attenede
          ENDIF
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KCLASS95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KCLASS99          * abort
.
          MOVE      ACODE,OBACLASS          * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "    4",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KCLASS90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KCLASS90  MOVE      ZERO,EXIT
          GOTO      KCLASS99
KCLASS95  MOVE      ONE,EXIT
.
KCLASS99  RETURN
+
.------------------------------------------------------------------------------
.         Patient Category - OBACAT
.------------------------------------------------------------------------------
KPCATG00  PACK      CODE,ANSP,SP1           * Category 
          MOVE      OBACAT,CKYIDEF3          * Default code
          IF        OBASTAT=4
            MOVE      ONE,CKYIMAND             * field is mandatory for attended
          ENDIF
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KPCATG95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KPCATG99          * EXITCHAR input
.
          MOVE      ACODE,OBACAT            * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "    6",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KPCATG90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
KPCATG90  MOVE      ZERO,EXIT
          GOTO      KPCATG99
KPCATG95  MOVE      ONE,EXIT
.
KPCATG99  RETURN
.
.------------------------------------------------------------------------------
.         Priority Code - OBAPRTY
.------------------------------------------------------------------------------
KPPRTY00  MOVE      CODEPR,CODE             * Category 
          MOVE      OBAPRTY,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KPPRTY95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KPPRTY99          * EXITCHAR input
.
          MOVE      ACODE,OBAPRTY           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "    8",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KPPRTY95           * dont display
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KPPRTY90  MOVE      ZERO,EXIT
          GOTO      KPPRTY99
KPPRTY95  MOVE      ONE,EXIT
.
KPPRTY99  RETURN
.
.------------------------------------------------------------------------------
.         Resident Status - PTYPE
.------------------------------------------------------------------------------
KPRESI00  PACK      KEY5,CODEC,PCONT        * Check Indicator in codes file
          CALL      RDCODE1                 * on Country of Birth to see if
          BRANCH    OVRCD,KPRESI10          * patient is a resident 
.
          MATCH     "3",TCINDC1             * Patient is a resident if the 
          GOTO      KPRESI02 IF EQUAL       * indicator is set to "3"
.
          COMPARE   HNONRES,PYRRES          * check with the years resident
          GOTO      KPRESI05 IF LESS        * for non charging
.
KPRESI02  MOVE      CRESIDT,PTYPE           * Make Default Res. Status a
          GOTO      KPRESI10                * Resident
.
KPRESI05  MOVE      CNONRES,PTYPE           * Default Res. Status to Non-Res.
.
KPRESI10  IF        OPTION = 1 & SELECT = 2
            LOAD      PTYPE,OTCNCRSR,SP10     * reappointments only
          ENDIF
          MOVE      PTYPE,CKYIDEF3          * default code
          MOVE      CODET,CODE              * category
.
          CALL      PATCODKY                * enter code
          COMPARE   TWO,EXIT
          GOTO      KPRESI95 IF EQUAL       * Input aborted
.
          MOVE      ACODE,PTYPE             * set up value
          CALL      DISPVARS 
.
          MOVE      ONE,CHGPMI              * Write to U/R audit file
          MOVE      "   10",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KPRESI90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KPRESI90  MOVE      ZERO,EXIT
          GOTO      KPRESI99
KPRESI95  MOVE      ONE,EXIT
.
KPRESI99  RETURN
+
.------------------------------------------------------------------------------
.         Compensation Eligibility / Claim Code - OBACOMP
.------------------------------------------------------------------------------
KCOMPC00  PACK      CODE,ANSC,ANSL             * Category
          MATCH     SP3,OTCNDACL
          IF        !@EQUAL
            MATCH      SP3,OBACOMP
            IF         @EQUAL
              MOVE       OTCNDACL,CKYIDEF3
            ELSE
              MOVE       OBACOMP,CKYIDEF3
            ENDIF
          ELSE
            MOVE      OBACOMP,CKYIDEF3         * Default code
          ENDIF
          IF        OBASTAT=4
            MOVE      ONE,CKYIMAND             * field is mandatory for attended
          ENDIF
.
KCOMPC10  COMPARE   PTCNDFCL,ONE                * default claim code from last -
          GOTO      KCOMPC40 IF NOT EQUAL       * visit ?
.
          COMPARE   ACCEPT,ZERO                 * change mode ? 
          GOTO      KCOMPC40 IF EQUAL            
.
          PACK      CFNAME,UID,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
          PACK      KEY36,OBAURNO,Z70            * get last OUTPATIENT visit
          CALL      RDSBOKA3
KCOMPC20  CALL      RDPBKA3O                     * just get outpatient number
          BRANCH    OVRCD,KCOMPC40
          MATCH     DIM8,OBAURNO                 * same U/R ?
          GOTO      KCOMPC40 IF NOT EQUAL  
          CALL      RDBOKB1C                     * just read claim code
          BRANCH    OVRCD,KCOMPC40               * (dont want to read over vars 
          MOVE      OBACOMP,CKYIDEF3             *  already set up)
.
KCOMPC40  CALL      PATCODKY                     * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KCOMPC95 IF EQUAL            *  EXITCHAR entered
          BRANCH    ABORT,KCOMPC99               * abort
.
          MOVE      ACODE,OBACOMP                * the code
          CALL      DISPVARS                     * redisplay variable
.
          MOVE      "   12",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KCOMPC50           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
.         see if there should be an exemption code
.
KCOMPC50  PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      ANSE,KEY5
          IF        !@EQUAL 
            MOVE      SP3,PTVKCXMP            * should be no exemption code
            MOVE      "   15",KEY5            * set for exemption code
            CALL      SCRCKFLD                * see if to display description
            IF        EXIT = ZERO
              PACK      VAR,SP30,SP30,SP20
              CALL      DISPITEM                * display field
            ENDIF
            MOVE      "   16",KEY5            * set for exemption code desc'n
            CALL      SCRCKFLD                * see if to display description
            IF        EXIT = ZERO
              PACK      VAR,SP30,SP30,SP20
              CALL      DISPITEM                * display field
            ENDIF
          ENDIF
.
KCOMPC90  MOVE      ZERO,EXIT
          GOTO      KCOMPC99
KCOMPC95  MOVE      ONE,EXIT
.
KCOMPC99  RETURN
.
.---------------------------------------------------------------------
.         keyin the card number - PTVKCARD
.---------------------------------------------------------------------
KCARDN00  MOVE      ZERO,EXIT
          PACK      KEYFIELD,PTVKCARD,SP30,SP30,SP20
          CALL      SCRKYFRE
          PACK      PTVKCARD,KEYFIELD,SP20
.
          MATCH     SP20,PTVKCARD
          GOTO      KCARDN50 IF EQUAL
.
          REP       UPPLOW,PTVKCARD
          PACK      VAR,PTVKCARD,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.>>>          DISPLAY   *PCCOL:CVERT,*V2LON,PTVKCARD * redisplay in UPPERCASE
          PROC      VALKCARD                * validate card number
          OPEN      CONTROLF,"controlf"     * re-open controlf file
          COMPARE   ZERO,EXIT
          GOTO      KCARDN99 IF EQUAL       * valid card number
.
          DISPLAY   *P1:24,*EL,*B,"Invalid Card Number.  ";
          CALL      HITENTER 
          GOTO      KCARDN00
.
KCARDN50  
.>>>         DISPLAY   *PCCOL:CVERT,SP20;
          MOVE      SP20,PTVKCARD           * clear card
          MOVE      SP8,PTVKCEXP            * clear expiry date
          PACK      VAR,PTVKCARD,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KCARDN99  RETURN
+
.---------------------------------------------------------------------
.         keyin card expiry date - PTVKCEXP
.---------------------------------------------------------------------
KEXPDT00  MOVE      PTVKCARD,ANS            * get the card type
          REP       "C1H2G3 4",ANS          * get valid ones as numbers
.>>>          DISPLAY   *PCCOL:CVERT,SP10       * clear line
          CALL      IBACLOCK                * get current date
.
          UNPACK    PTVKCEXP,CCENT,CYEAR,CMON,CDAY
          REP       BLTOZERO,CCENT
          RESET     CDAY
          RESET     CMON
.
          MOVE      CCENT,FORM2
          IF        FORM2 = ZERO
            MOVE      CCC,FORM2               * default cent to current
          ENDIF
          MOVE      FORM2,CCENT
.
          MOVE      ANS,EXIT                * get as a form
          BRANCH    EXIT,KEXPDT40,KEXPDT40,KEXPDT40,KEXPDT97
.
. ------- enter date as month and year -------
.
KEXPDT10  MOVE      CCOL,ECOL 
          MOVE      CVERT,EVERT
.
          CALL      KEYMONTH
          BRANCH    OVRCD,KEXPDT30          * nothing entered
          MOVE      "00",CDAY               * day of zero
.
          MOVE      CCENT,FORM2
          COMPARE   CCC,FORM2
          GOTO      KEXPDT80 IF LESS        * entered cent is back dated
          GOTO      KEXPDT15 IF EQUAL       * entered cent is current
          GOTO      KEXPDT95                * entered cent in the future
.
KEXPDT15  MOVE      CYEAR,FORM2
          COMPARE   CYY,FORM2
          GOTO      KEXPDT80 IF LESS        * entered year is back dated
          GOTO      KEXPDT20 IF EQUAL       * entered year is current year
          GOTO      KEXPDT95                * entered year in the future
.
KEXPDT20  MOVE      CMON,FORM2
          COMPARE   FORM2,CMM
          GOTO      KEXPDT80 IF NOT LESS    * card has expired
          GOTO      KEXPDT95                * valid card
.
.         If card number was entered, expiry date must be entered as well
.
KEXPDT30  MATCH     SP20,PTVKCARD
          GOTO      KEXPDT10 IF NOT EQUAL
          UNPACK    SP10,CCENT,CYEAR,CMON,CDAY
          GOTO      KEXPDT95
.
. ------- enter date as day and month and year -------
.
KEXPDT40  MOVE      CCOL,ECOL 
          MOVE      CVERT,EVERT
          CALL      KEYDATE 
          BRANCH    OVRCD,KEXPDT90          * nothing entered
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY   * entered date
          REP       BLTOZERO,KEY8 
          PACK      CPDATE,CCC,CYY,CMM,CDD       * current date
          REP       BLTOZERO,CPDATE
          MATCH     CPDATE,KEY8
          GOTO      KEXPDT95 IF NOT LESS     * current >= card date
.
KEXPDT80  DISPLAY   *P1:24,*EL,*B,*V2LON,*BLINKON,"WARNING",*HOFF:
                    ": This card has expired.  ";
          CALL      HITENTER 
          GOTO      KEXPDT95
.
.         If card number was entered, expiry date must be entered as well
.
KEXPDT90  MATCH     SP20,PTVKCARD
          GOTO      KEXPDT40 IF NOT EQUAL
          UNPACK    SP10,CCENT,CYEAR,CMON,CDAY
.
.         valid card date
.
KEXPDT95  MOVE      ECOL,CCOL
          MOVE      EVERT,CVERT
          PACK      PTVKCEXP,CCENT,CYEAR,CMON,CDAY
          REP       BLTOZERO,PTVKCEXP
.
KEXPDT97  MOVE      ZERO,EXIT
.
KEXPDT99  RETURN
+
.---------------------------------------------------------------------
.         Keyin exemption code - PTVKCXMP - Cat XM 
.         Only key it in if the Comp. Elig/Claim Cocde (Cat CL) has 
.         an indicator of "E"
.---------------------------------------------------------------------
KEXEMP00  UNPACK    SP30,ACODE,TDESC
          MATCH     SP3,OBACOMP
          GOTO      KEXEMP40 IF EQUAL       * dont key it in
.
          PACK      KEY5,ANSC,ANSL,OBACOMP
          CALL      RDCODE1
          UNPACK    SP30,ACODE,TDESC        * clear the codes
          BRANCH    OVRCD,KEXEMP40          * invalid code
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      ANSE,KEY5
          GOTO      KEXEMP40 IF NOT EQUAL   * no match found
.
.         keyin the exemption code
.
KEXEMP20  PACK      CODE,ANSX,ANSM          * Category for exemption code
          MOVE      PTVKCXMP,CKYIDEF3       * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KEXEMP95 IF EQUAL       * EXITCHAR input
.
KEXEMP40  MOVE      ACODE,PTVKCXMP          * the code
          CALL      DISPVARS
.
          MOVE      "   16",KEY5           * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KEXEMP90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KEXEMP90  MOVE      ZERO,EXIT
          GOTO      KEXEMP99
KEXEMP95  MOVE      ONE,EXIT
.
KEXEMP99  RETURN
+
.---------------------------------------------------------------------
.         Number of previous visits - OTBBPVIS
.---------------------------------------------------------------------
KPRVIS00  KEYIN     *PCCOL:CVERT,"   ":
                    *PCCOL:CVERT,*V2LON,*RV,OTBBPVIS:
                    *PCCOL:CVERT,*DV,OTBBPVIS
.                   
          COMPARE   ZERO,OTBBPVIS
          GOTO      KPRVIS70 IF NOT LESS    * >= 0 so valid
.
          BEEP
          GOTO      KPRVIS00
.
KPRVIS70  IF        OTBBPVIS < ORIGVISI
            DISPLAY   *P1:24,*B,*V2LON,"WARNING",*HOFF:
                      ": Number of visits is less than default.  ",*EL;
            CALL      HITENTER 
          ENDIF
          CALL      DISPVARS                * redisplay variable
.
KPRVIS99  RETURN
+
.---------------------------------------------------------------------
.         Enter the Family Id - PTVKFMLY
.---------------------------------------------------------------------
KFAMID00  PACK      KEYFIELD,PTVKFMLY,SP30,SP30,SP20
          CALL      SCRKYFRE
          MOVE      KEYFIELD,PTVKFMLY
          RETURN
+
.------------------------------------------------------------------------------
.         User Defined 1 - OBAINS
.------------------------------------------------------------------------------
KU1USR00  PACK      CODE,ANSU,ONE           * Category 
          MOVE      OBAINS,CKYIDEF3          * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KU1USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KU1USR99          * EXITCHAR input
.
          MOVE      ACODE,OBAINS            * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   20",KEY5              * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KU1USR90           * dont display
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KU1USR90  MOVE      ZERO,EXIT
          GOTO      KU1USR99
KU1USR95  MOVE      ONE,EXIT
.
KU1USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O1 - OBOUSR1
.------------------------------------------------------------------------------
KO1USR00  PACK      CODE,ANSO,ONE           * Category 
          MOVE      OBOUSR1,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO1USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO1USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR1           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   22",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO1USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO1USR90  MOVE      ZERO,EXIT
          GOTO      KO1USR99
KO1USR95  MOVE      ONE,EXIT
.
KO1USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O2 - OBOUSR2
.------------------------------------------------------------------------------
KO2USR00  PACK      CODE,ANSO,TWO           * Category 
          MOVE      OBOUSR2,CKYIDEF3         * Default code
          MOVE      OTCNSQO2,SUPRSQST       * suppress "?" ?
.
          CALL      KCODNQST                * Keyin the code suppress "?"
          COMPARE   TWO,EXIT
          GOTO      KO2USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO2USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR2           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   24",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO2USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO2USR90  MOVE      ZERO,EXIT
          GOTO      KO2USR99
KO2USR95  MOVE      ONE,EXIT
.
KO2USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O3 - OBOUSR3
.------------------------------------------------------------------------------
KO3USR00  PACK      CODE,ANSO,THREE         * Category 
          MOVE      OBOUSR3,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO3USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO3USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR3           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   26",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO3USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO3USR90  MOVE      ZERO,EXIT
          GOTO      KO3USR99
KO3USR95  MOVE      ONE,EXIT
KO3USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O4 - OBOUSR4
.------------------------------------------------------------------------------
KO4USR00  PACK      CODE,ANSO,FOUR          * Category 
          MOVE      OBOUSR4,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO4USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO4USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR4           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   28",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO4USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO4USR90  MOVE      ZERO,EXIT
          GOTO      KO4USR99
KO4USR95  MOVE      ONE,EXIT
.
KO4USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O5 - OBOUSR5
.------------------------------------------------------------------------------
KO5USR00  PACK      CODE,ANSO,FIVE          * Category 
          MOVE      OBOUSR5,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO5USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO5USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR5           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   75",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO5USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO5USR90  MOVE      ZERO,EXIT
          GOTO      KO5USR99
KO5USR95  MOVE      ONE,EXIT
.
KO5USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O6 - OBOUSR6
.------------------------------------------------------------------------------
KO6USR00  PACK      CODE,ANSO,SIX           * Category 
          MOVE      OBOUSR6,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO6USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO6USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR6           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   77",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO6USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO6USR90  MOVE      ZERO,EXIT
          GOTO      KO6USR99
KO6USR95  MOVE      ONE,EXIT
.
KO6USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O7 - OBOUSR7
.------------------------------------------------------------------------------
KO7USR00  PACK      CODE,ANSO,SEVEN         * Category 
          MOVE      OBOUSR7,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO7USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO7USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR7           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   79",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO7USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO7USR90  MOVE      ZERO,EXIT
          GOTO      KO7USR99
KO7USR95  MOVE      ONE,EXIT
.
KO7USR99  RETURN
.
.------------------------------------------------------------------------------
.         User defined O8 - OBOUSR8
.------------------------------------------------------------------------------
KO8USR00  PACK      CODE,ANSO,EIGHT         * Category 
          MOVE      OBOUSR8,CKYIDEF3         * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KO8USR95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KO8USR99          * EXITCHAR input
.
          MOVE      ACODE,OBOUSR8           * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   81",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KO8USR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KO8USR90  MOVE      ZERO,EXIT
          GOTO      KO8USR99
KO8USR95  MOVE      ONE,EXIT
.
KO8USR99  RETURN
.
.******************************************************************************
.* KPRANK00 - Keyin Patient Rank                                    
.******************************************************************************
KPRANK00  MOVE      OTBBRANK,FORM6 
          KEYIN     *PCCOL:CVERT,*V2LON,*DV,FORM6:   
                    *PCCOL:CVERT,*RV,FORM6:
                    *PCCOL:CVERT,*DV,FORM6;
.
          COMPARE   ZERO,FORM6      * test less than zero
          IF        @LESS
            DISPLAY   *P1:24,*EL,*B,"Cannot be Less Than Zero. ";
            CALL      HITENTER
            GOTO      KPRANK00
          ENDIF
.
          MOVE      FORM6,OTBBRANK
.
KPRANK99  RETURN
.---------------------------------------------------------------------
.         keyin health fund - OTBBFUND
.---------------------------------------------------------------------
KHFUND00  MOVE      OTBBFUND,CKYIDEF6
.
          CALL      PATFNDKY
          COMPARE   TWO,EXIT
          GOTO      KHFUND96 IF EQUAL
          BRANCH    ABORT,KHFUND96
.
          MOVE      HCODE,OTBBFUND
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   30",KEY5            * set for desc'n
          CALL      SCRCKFLD                * see if desc displayed
          BRANCH    EXIT,KHFUND90           * dont display
.
          PACK      VAR,HFNAME,SP30,SP30,SP20
          CALL      DISPITEM
.
.         set exit flags
.
KHFUND90  MOVE      ZERO,EXIT               * valid code
          GOTO      KHFUND99
.
KHFUND96  MOVE      ONE,EXIT                * exitchar
.
KHFUND99  RETURN
+
.---------------------------------------------------------------------
.         Keyin department code - OTBBDEPT 
.---------------------------------------------------------------------
KBDEPT00  PACK      CODE,ANSA,ANSC          * Category for religion
          MOVE      OTBBDEPT,CKYIDEF3       * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KBDEPT95 IF EQUAL       *  EXITCHAR entered
          BRANCH    ABORT,KBDEPT99          * EXITCHAR input
.
          MOVE      ACODE,OTBBDEPT          * the code
          CALL      DISPVARS                * redisplay variable
.
          MOVE      "   32",KEY5            * set for desc
          CALL      SCRCKFLD                * see if to display description
          BRANCH    EXIT,KBDEPT90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KBDEPT90  MOVE      ZERO,EXIT
          GOTO      KBDEPT99
KBDEPT95  MOVE      ONE,EXIT
.
KBDEPT99  RETURN
+
.-------------------------------------------------------------------------
.         see what type of comments to enter
.-------------------------------------------------------------------------
KCOMMT00  BRANCH    HWORDPRO,KCOMMT10,KCOMMT20   * WP Comments or FF DIM40
.
KCOMMT10  CALL      KPCMNT00                 * WP comments
          BRANCH    ABORT,KCOMMT99           * Input aborted
          MOVE      ZERO,EXIT
          GOTO      KCOMMT99
.
KCOMMT20  CALL      FFCMNT00                 * Free Format Comments
          BRANCH    ABORT,KCOMMT99           * Input aborted
          MOVE      ZERO,EXIT
.
KCOMMT99  RETURN
+
.------------------------------------------------------------------------------
.         Diagnosis
.------------------------------------------------------------------------------
KODIAG00  MOVE      CCOL,ECOL                * set default keyin column
          MOVE      CVERT,EVERT              * set default row
.
          BRANCH    HDIAFLG,KODIAG10,KODIAG20    * MBS / ICD
          MOVE      SP9,OPDICODE             * No code, using free format
          GOTO      KODIAG30
.
.         Input an MBS code
.
KODIAG10  KEYIN     *PECOL:EVERT,*DV,UNDLN9:
                    *PECOL:EVERT,*V2LON,OPDICODE:
                    *PECOL:EVERT,*DV,OPDICODE
          MOVE      ECOL,CCOL
          ADD       TEN,CCOL                * description column
.
          ENDSET    OPDICODE
          APPEND    SP9,OPDICODE
          RESET     OPDICODE
.
          MATCH     SP9,OPDICODE
          GOTO      KODIAG30 IF EQUAL        * No MBS code entered
.
          PACK      KEY17,OPDICODE,SP70
          OPEN      PATITEM1,"patitemn"
          CALL      PATITMRD
          CLOSE     PATITEM1
          BRANCH    OVRCD,KODIAG18
.
          PACK      OPDIDESC,IDESC,SP30
          GOTO      KODIAG30
.
KODIAG18  DISPLAY   *P1:24,*EL,*B,"Invalid MBS Code.  ";
          CALL      HITENTER
          GOTO      KODIAG10
.
.         Input an ICD9CM code
.
KODIAG20  KEYIN     *PECOL:EVERT,*DV,UNDLN9:
                    *PECOL:EVERT,*V2LON,OPDICODE:
                    *PECOL:EVERT,*DV,OPDICODE
          MOVE      ECOL,CCOL
          ADD       TEN,CCOL                * description column
.
          ENDSET    OPDICODE
          APPEND    SP9,OPDICODE
          RESET     OPDICODE
.
          MATCH     SP9,OPDICODE
          GOTO      KODIAG30 IF EQUAL        * No MBS code entered
.
          MOVE      OPDICODE,KEY9
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
          CALL      RD10T9D1
          IF        OVRCD=1
              CALL      RDPT10D1
          ENDIF
          CLOSE     PATICDD1
          CLOSE     PATI10D1
          BRANCH    OVRCD,KODIAG28
.
          PACK      OPDIDESC,DDESC,SP30
          GOTO      KODIAG30
.
KODIAG28  DISPLAY   *P1:24,*EL,*B,"Invalid ICD9 Code.  ";
          CALL      HITENTER
          GOTO      KODIAG20
.
.         Input the free format description, using a retain variable on keyin
.         If we are using code input, the keyin will be at column 30 (after the
.         code). If we are using free format input, the keyin will be at
.         column 20 (to line up with all the other keyin's).
.
KODIAG30  MATCH     SP30,OPDIDESC
          GOTO      KODIAG40 IF EQUAL
.
          KEYIN     *PCCOL:EVERT,*DV,OPDIDESC:
                    *PCCOL:EVERT,*RV,*V2LON,OPDIDESC:
                    *PCCOL:EVERT,*DV,OPDIDESC
          GOTO      KODIAG60
.
KODIAG40  KEYIN     *PCCOL:EVERT,*DV,UNDLN30,*DV,UNDLN20:
                    *PCCOL:EVERT,*V2LON,OPDIDESC:
                    *PCCOL:EVERT,*DV,OPDIDESC
.
KODIAG60  ENDSET    OPDIDESC
          APPEND    SP30,OPDIDESC
          APPEND    SP30,OPDIDESC
          RESET     OPDIDESC
.
          MOVE      ONE,CHGDIA               * Diagnosis changed
.
KODIAG99  RETURN
.
.---------------------------------------------------------------------
.         referral date
.---------------------------------------------------------------------
KRFDAT00  IF        SCPSLEN = 10
          ELSE
          ENDIF
          MOVE      ZERO,CHIGHLT            * highlight
          MOVE      ONE,CDEFDTE             * one enter for default
          MOVE      ONE,CCANLDTE            * cancel default with spaces
.
.-----  Set up default as today if doing a new booking/non-booked attendance ---
.
          IF (SELECT=1 & OPTION=1 & VOUTNO=0) | (SELECT=5 & OPTION=1 & VOUTNO=0)
            MOVE      CDD,CDAY
            MOVE      CMM,CMON
            MOVE      CYY,CYEAR
            MOVE      CCC,CCENT
          ELSE
            PACK      OTBCRDAT,OTBCRDAT,SP8
            UNPACK    OTBCRDAT,CCENT,CYEAR,CMON,CDAY  * else default to current
          ENDIF
.
          MATCH     SP2,CCENT
          IF        @EQUAL
            MOVE      CCC,CCENT
          ENDIF
          CALL      KEYDATE
          IF        OVRCD = ONE
            MOVE      SP8,OTBCRDAT
          ELSE
            PACK      OTBCRDAT,CCENT,CYEAR,CMON,CDAY
            REP       BLTOZERO,OTBCRDAT
          ENDIF
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
          MATCH     OTBCRDAT,DIM8
          GOTO      KRFDAT90 IF NOT LESS
.   
          DISPLAY   *P1:24,*B,"Date Must Not be in the Future.  ",*EL;
          CALL      HITENTER
          GOTO      KRFDAT00
.
KRFDAT90  CALL      DISPVARS
.
KRFDAT99  RETURN
+
.------------------------------------------------------------------------------
.         Transport Allocation
.------------------------------------------------------------------------------
KTRNAL00  MOVE      "OB",CODE               * Category 
          MOVE      OTBBTRAN,CKYIDEF3       * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KTRNAL95 IF EQUAL       * EXITCHAR entered
          BRANCH    ABORT,KTRNAL99          * abort
.
          MOVE      ACODE,OTBBTRAN          * the code
          CALL      DISPVARS                * redisplay code
.
          MOVE      "   38",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KTRNAL90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KTRNAL90  MOVE      ZERO,EXIT
          GOTO      KTRNAL99
KTRNAL95  MOVE      ONE,EXIT
.
KTRNAL99  RETURN
+
.------------------------------------------------------------------------------
.         Language of Interpreter
.------------------------------------------------------------------------------
KLANGI00  MOVE      "OL",CODE               * Category 
          MOVE      OTBBLNGI,CKYIDEF3       * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KLANGI95 IF EQUAL       * EXITCHAR entered
          BRANCH    ABORT,KLANGI99          * abort
.
          MOVE      ACODE,OTBBLNGI          * the code
          CALL      DISPVARS                * redisplay code
.
          MOVE      "   40",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KLANGI90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KLANGI90  MOVE      ZERO,EXIT
          GOTO      KLANGI99
KLANGI95  MOVE      ONE,EXIT
.
KLANGI99  RETURN
+
.------------------------------------------------------------------------------
.         Time First Seen
.------------------------------------------------------------------------------
KTFSEN00  UNPACK    OTBBTMFS,CHOUR,ANS,CMIN
          CALL      KEYTIME
          BRANCH    CQUEST,KTFSEN00
          IF        OVRCD=1
            MOVE      SP8,OTBBTMFS
          ELSE
            PACK      OTBBTMFS,CHOUR,COLON,CMIN,SP8
          ENDIF
KTFSEN99  RETURN
+
.------------------------------------------------------------------------------
.         Time Booked Out 
.------------------------------------------------------------------------------
KTBOKO00  UNPACK    OTBBTMBO,CHOUR,ANS,CMIN
          CALL      KEYTIME
          BRANCH    CQUEST,KTBOKO00
          IF        OVRCD=1
            MOVE      SP8,OTBBTMBO
          ELSE
            PACK      OTBBTMBO,CHOUR,COLON,CMIN,SP8
          ENDIF
KTBOKO99  RETURN
+
.---------------------------------------------------------------------
.         Keyin GPFH Approval Number    
.---------------------------------------------------------------------
KGPFHA00  MOVE      ONE,YESDFLTS
          PACK      KEYFIELD,OTBBGPFA,SP30,SP30,SP20
          CALL      SCRKYFRE
          MOVE      KEYFIELD,OTBBGPFA
          RETURN
+
.---------------------------------------------------------------------
.         Keyin ECR Approval Number    
.---------------------------------------------------------------------
KECRAN00  MOVE      ONE,YESDFLTS
          PACK      KEYFIELD,OTBBECRA,SP30,SP30,SP20
          CALL      SCRKYFRE
          MOVE      KEYFIELD,OTBBECRA
          RETURN
+
.*********************************************************************
.     GP Practice code which is linked to a practice
.*********************************************************************
KGPCOD00  OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
.
          MOVE      OTBBRFGP,CKYIDEF8             * Referring GP
          MOVE      OTBBGPPC,CKYIDEF6             * default Practice code
          MOVE      OTBBGPPT,CKYIDEF2             * default Practice count
          MOVE      SCPSMAN,CKYIMAND              * mandatory
.
          MOVE      ZERO,CKACTIVE
          CALL      PMSHCGKY                      * keyin a GP Practice code
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KGPCOD99
          ENDIF
          MOVE      CKYIDEF6,OTBBGPPC       * set GP Practice code
          MOVE      CKYIDEF2,OTBBGPPT       * set GP Practice count
          CALL      DISPVARS
.
          MOVE      "   48",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KGPCOD78
          PACK      VAR,PMHGPNAM,SP70,SP10
          CALL      DISPITEM
.
KGPCOD78  MOVE      ZERO,EXIT
.
KGPCOD99  RETURN
+
.*********************************************************************
.  Referring GP                   
.*********************************************************************
KREFGP00  OPEN      PMSHCPA1,"pmshcpaf"
          IF        ACCEPT = 1 & VOUTNO = 0
            MOVE      PMPXRHC1,CKYIDEF8       * insert and not from referral
...         MOVE      PMPXRH1G,CKYIDEF6
...         MOVE      PMPXR1GC,CKYIDEF2
          ELSE
            PACK      OTBBRFGP,OTBBRFGP,SP8   * change mode or have a referral
            MATCH     SP8,OTBBRFGP
            IF        @EQUAL
              MOVE      PMPXRHC1,CKYIDEF8
...           MOVE      PMPXRH1G,CKYIDEF6
...           MOVE      PMPXR1GC,CKYIDEF2
            ELSE
              MOVE      OTBBRFGP,CKYIDEF8
...           MOVE      OTBBGPPC,CKYIDEF6
...           MOVE      OTBBGPPT,CKYIDEF2
            ENDIF
          ENDIF
          MOVE      SCPSMAN,CKYIMAND
.
          MOVE      ZERO,CKACTIVE
          CALL      PMSHCPKY                    * keyin a referring GP code
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KREFGP99
          ENDIF
.
          MOVE      PMHCHCPC,OTBBRFGP
...       MOVE      CKYIDEF6,OTBBGPPC
...       MOVE      CKYIDEF2,OTBBGPPT
.
          MOVE      "   45",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KREFGP80
          PACK      VAR,OTBBRFGP,SP70,SP10
          CALL      DISPITEM
.
          MOVE      "   46",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KREFGP80
          PACK      VAR,PMHCSNAM,SP70,SP10
          STRIP     VAR
          ENDSET    VAR
          APPEND    SP1,VAR
          APPEND    PMHCGNAM,VAR
          APPEND    SP70,VAR
          RESET     VAR
          CALL      DISPITEM
      
KREFGP80  IF        ACCEPT = 0
            MOVE      "   47",KEY5
            CALL      SCRCKFLD
            BRANCH    EXIT,KREFGP90
            CALL      KGPCOD00
          ENDIF

KREFGP90  MOVE      ZERO,EXIT
.
KREFGP99  RETURN
+
.------------------------------------------------------------------------------
.         Visit Type                
.------------------------------------------------------------------------------
KVISTY00  MOVE      "CV",CODE               * Category 
          MOVE      OBAVISIT,CKYIDEF3       * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KVISTY95 IF EQUAL       * EXITCHAR entered
          BRANCH    ABORT,KVISTY99          * abort
.
          MOVE      ACODE,OBAVISIT          * the code
          CALL      DISPVARS                * redisplay code
.
          MOVE      "   50",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KVISTY90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KVISTY90  MOVE      ZERO,EXIT
          GOTO      KVISTY99
KVISTY95  MOVE      ONE,EXIT
.
KVISTY99  RETURN
+
.*********************************************************************
.         send letter (Y/N)
.*********************************************************************
KSNDLT00  MOVE      OTMADFSL,ANS
          KEYIN     *PECOL:EVERT,*EL,*V2LON,*RV,ANS;
          REP       UPPLOW,ANS
          PACK      ANS,ANS,SP1
          MATCH     ANSY,ANS
          GOTO      KSNDLT10 IF EQUAL       * yes
          MATCH     ANSN,ANS
          GOTO      KSNDLT20 IF EQUAL       * no 
          BEEP
          GOTO      KSNDLT00
.
KSNDLT10  MOVE      ANSY,OTBBSNDL
          GOTO      KSNDLT40
.
KSNDLT20  MOVE      ANSN,OTBBSNDL
.
KSNDLT40  CALL      DISPVARS
.
KSNDLT99  RETURN
+
.------------------------------------------------------------------------------
.         District of Residence - OTBBDOFR
.------------------------------------------------------------------------------
KODOFR00  MOVE      "DA",CODE               * Category 
          MOVE      OTBBDOFR,CKYIDEF3        * Default code
.
          CALL      PATCODKY                * Keyin the code
          COMPARE   TWO,EXIT
          GOTO      KODOFR95 IF EQUAL       * EXITCHAR entered
          BRANCH    ABORT,KODOFR99          * abort
.
          MOVE      ACODE,OTBBDOFR          * the code
          CALL      DISPVARS                * redisplay code
.
          MOVE      "   53",KEY5            * set for desc
          CALL      SCRCKFLD                * see if field displayable
          BRANCH    EXIT,KODOFR90           * dont display
.
          PACK      VAR,TDESC,SP30,SP30,SP20
          CALL      DISPITEM                * display field
.
KODOFR90  MOVE      ZERO,EXIT
          GOTO      KODOFR99
KODOFR95  MOVE      ONE,EXIT
.
KODOFR99  RETURN
+
.---------------------------------------------------------------------
.  Referring GP - no practice     
.---------------------------------------------------------------------
KGPNPR00  OPEN      PMSHCPA1,"pmshcpaf"
          IF        ACCEPT = 1 & VOUTNO = 0
            MOVE      PMPXRHC1,CKYIDEF8    * insert mode and not a referral
          ELSE
            PACK      OTBBRFGP,OTBBRFGP,SP70  * change mode or have a referral
            MATCH     SP8,OTBBRFGP
            IF        @EQUAL
              MOVE      PMPXRHC1,CKYIDEF8
            ELSE
              MOVE      OTBBRFGP,CKYIDEF8
            ENDIF
          ENDIF
          MOVE      SCPSMAN,CKYIMAND
.
          CALL      PMSHCPKY                      * keyin registered GP code
          IF        EXIT = 2
            MOVE      SP8,OTBBRFGP
            MOVE      ONE,EXIT
            GOTO      KGPNPR99
          ENDIF
.
          MOVE      PMHCHCPC,OTBBRFGP
          UNPACK    SP70,OTBBGPPC,OTBBGPPT
          CALL      DISPVARS
.
          MOVE      "   46",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KGPNPR90
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
          PACK      VAR,PACFNAME,SP30,SP30,SP30
          CALL      DISPITEM
.
KGPNPR90  MOVE      ZERO,EXIT
.
KGPNPR99  RETURN
+
.
. The following reads are used so as to not read over the variables which are
. already set up for the current visit.
.
RDBOKB1C  MOVE      ZERO,OVRCD                 * Only wish to read claim code !
          RESET     KEY8
          READ      OUTBB1A1,KEY8;DIM10,DIM1,OBACOMP
          GOTO      OVERCOND IF OVER
          RETURN
.
RDPBKA3O  MOVE      ZERO,OVRCD
          READKP    OUTBOKA3;KEY39,DIM8,DIM3,KEY8     * DIM8 = U/R Numb
          GOTO      OVERCOND IF OVER                  * KEY8 = Outpat Numb
          RETURN
.
