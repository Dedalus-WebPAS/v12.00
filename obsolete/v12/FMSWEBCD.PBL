.******************************************************************************
.* System    :   Accounting System                                            *
.* Routines  :   ACCBAL00
.* Desc      :   Extract Balances for Web Display                             *
.* Used in   :   
.* Date      :   14.02.98                                                     *
.* Author    :   B.G.Ackland (IBA)                                            *
.******************************************************************************
FINDET00  MOVE     ONE,INCOMEFL
          MOVE     FMAMTYPE,F1
........  IF       F1=1|F1=3                                      * D-CAR 42285
          IF       F1=1
            MOVE     SEQ,INCOMEFL
          ENDIF
          MATCH    "7",FMAMTYPE
          GOTO     FINDET10 IF LESS
.
          CALL     TYACTS00                * This Year Actual
.
          CALL     LYACTS00                * Last Year Actual
.
          CALL     TYBUDS00                * This Year Budget
.
          CALL     LYBUDS00                * Last Year Budget
.
          CALL     DPER0000
.
          MOVE     FMAMTYPE,F1
          IF       F1=9
            CALL     GETINC00
          ENDIF
.
          GOTO     FINDET99  
.
FINDET10  MATCH    "7",FMAMTYPE            * Heading Account
          GOTO     FINDET99 IF EQUAL
.
          CALL     TYACT000                * This Year Actual
.
          CALL     LYACT000                * Last Year Actual
.
          CALL     TYBUD000                * This Year Budget
.
          CALL     LYBUD000                * Last Year Budget
.
          CALL     DPER0000
.
          MOVE     FMAMTYPE,F1
          IF       F1=6
            CALL     GETINC00
          ENDIF
.
FINDET99  RETURN 
.------------------------------------------------------------
. Get Income Flag for Total Accounts
.------------------------------------------------------------
GETINC00  PACK      KEY26,FMAMLEDG,FMAMACCT,SP70
          CALL      RSFMRF2            * read in report seq data
          CALL      RKFMRF2            * read in report seq data
          BRANCH    OVRCD,GETINC80     * record found ?
          PACK      KEY16,FMRFLED,FMRFACC,SP70
          MATCH     KEY16,KEY26
          GOTO      GETINC80 IF NOT EQUAL
.
          MATCH     "1",FMRFCRP
          IF        @EQUAL
            MOVE      SEQ,INCOMEFL
          ENDIF
          GOTO      GETINC99
.
GETINC80  IF       CURAYTD<0
            MOVE     SEQ,INCOMEFL
          ENDIF
          IF       CURBYTD<0
            MOVE     SEQ,INCOMEFL
          ENDIF
.
GETINC99  RETURN
.------------------------------------------------------------
. Get This Year Actual
.------------------------------------------------------------
TYACT000  CALL    ZACT0000                * Clear Fields
          PACK    KEY14,FMAMLEDG,FMAMACCT,SP70
          IF      FLGFMSP1=0
            CALL    RDFMFP1
          ENDIF
          MOVE    FMFPABF,CURABF
          MOVE    FMFPA01,CURA01
          MOVE    FMFPA02,CURA02
          MOVE    FMFPA03,CURA03
          MOVE    FMFPA04,CURA04
          MOVE    FMFPA05,CURA05
          MOVE    FMFPA06,CURA06
          MOVE    FMFPA07,CURA07
          MOVE    FMFPA08,CURA08
          MOVE    FMFPA09,CURA09
          MOVE    FMFPA10,CURA10
          MOVE    FMFPA11,CURA11
          MOVE    FMFPA12,CURA12
          MOVE    FMFPA13,CURA13
          MOVE    FMFPCOM,CURACM
          MOVE    FMFPCOM2,CURACMC2
          RETURN
.------------------------------------------------------------
. Get Last Year Actual
.------------------------------------------------------------
LYACT000  CALL    ZACT0000                * Clear Fields
          PACK    KEY14,FMAMLEDG,FMAMACCT,SP70
          IF      FLGFMSP2=0
            CALL    RDFMFP2
          ENDIF
.
          MOVE    FMFPABF,LYRABF
          MOVE    FMFPA01,LYRA01
          MOVE    FMFPA02,LYRA02
          MOVE    FMFPA03,LYRA03
          MOVE    FMFPA04,LYRA04
          MOVE    FMFPA05,LYRA05
          MOVE    FMFPA06,LYRA06
          MOVE    FMFPA07,LYRA07
          MOVE    FMFPA08,LYRA08
          MOVE    FMFPA09,LYRA09
          MOVE    FMFPA10,LYRA10
          MOVE    FMFPA11,LYRA11
          MOVE    FMFPA12,LYRA12
          MOVE    FMFPA13,LYRA13
          MOVE    FMFPCOM,LYRACM
          MOVE    FMFPCOM2,LYRACMC2
          RETURN
.------------------------------------------------------------
. Get This Year Budget
.------------------------------------------------------------
TYBUD000  CALL      ZBUD0000                * Clear Fields
          PACK      KEY14,FMAMLEDG,FMAMACCT
          IF        FLGFMSB1=0
            CALL      RDFMBU1
          ENDIF
          MOVE      FMBUCA01,CURB01
          MOVE      FMBUCA02,CURB02
          MOVE      FMBUCA03,CURB03
          MOVE      FMBUCA04,CURB04
          MOVE      FMBUCA05,CURB05
          MOVE      FMBUCA06,CURB06
          MOVE      FMBUCA07,CURB07
          MOVE      FMBUCA08,CURB08
          MOVE      FMBUCA09,CURB09
          MOVE      FMBUCA10,CURB10
          MOVE      FMBUCA11,CURB11
          MOVE      FMBUCA12,CURB12
          MOVE      FMBUCA13,CURB13
          RETURN
.------------------------------------------------------------
. Get Last Year Budget
.------------------------------------------------------------
LYBUD000  CALL      ZBUD0000
          PACK      KEY14,FMAMLEDG,FMAMACCT
          IF        FLGFMSB3=0
            CALL      RDFMBU3
          ENDIF
          MOVE      FMBUCA01,LYRB01
          MOVE      FMBUCA02,LYRB02
          MOVE      FMBUCA03,LYRB03
          MOVE      FMBUCA04,LYRB04
          MOVE      FMBUCA05,LYRB05
          MOVE      FMBUCA06,LYRB06
          MOVE      FMBUCA07,LYRB07
          MOVE      FMBUCA08,LYRB08
          MOVE      FMBUCA09,LYRB09
          MOVE      FMBUCA10,LYRB10
          MOVE      FMBUCA11,LYRB11
          MOVE      FMBUCA12,LYRB12
          MOVE      FMBUCA13,LYRB13
          RETURN
.------------------------------------------------------------
. Clear Actual
.------------------------------------------------------------
ZACT0000  MOVE      ZERO,FMFPABF
          MOVE      ZERO,FMFPA01
          MOVE      ZERO,FMFPA02
          MOVE      ZERO,FMFPA03
          MOVE      ZERO,FMFPA04
          MOVE      ZERO,FMFPA05
          MOVE      ZERO,FMFPA06
          MOVE      ZERO,FMFPA07
          MOVE      ZERO,FMFPA08
          MOVE      ZERO,FMFPA09
          MOVE      ZERO,FMFPA10
          MOVE      ZERO,FMFPA11
          MOVE      ZERO,FMFPA12
          MOVE      ZERO,FMFPA13
          RETURN
.------------------------------------------------------------
. Clear Budget 
.------------------------------------------------------------
ZBUD0000  MOVE      ZERO,FMBUCA01
          MOVE      ZERO,FMBUCA02
          MOVE      ZERO,FMBUCA03
          MOVE      ZERO,FMBUCA04
          MOVE      ZERO,FMBUCA05
          MOVE      ZERO,FMBUCA06
          MOVE      ZERO,FMBUCA07
          MOVE      ZERO,FMBUCA08
          MOVE      ZERO,FMBUCA09
          MOVE      ZERO,FMBUCA10
          MOVE      ZERO,FMBUCA11
          MOVE      ZERO,FMBUCA12
          MOVE      ZERO,FMBUCA13
          RETURN
.------------------------------------------------------------
. Get This Year Stats Actuals
.------------------------------------------------------------
TYACTS00  CALL    ZSTA0000
          PACK    KEY14,FMAMLEDG,FMAMACCT
          IF      FLGFMSS1=0
            CALL    RDFMSS1 
          ENDIF
          MOVE    FMSSA1,CURA01
          MOVE    FMSSA2,CURA02
          MOVE    FMSSA3,CURA03
          MOVE    FMSSA4,CURA04
          MOVE    FMSSA5,CURA05
          MOVE    FMSSA6,CURA06
          MOVE    FMSSA7,CURA07
          MOVE    FMSSA8,CURA08
          MOVE    FMSSA9,CURA09
          MOVE    FMSSA10,CURA10
          MOVE    FMSSA11,CURA11
          MOVE    FMSSA12,CURA12
          MOVE    FMSSA13,CURA13
          MOVE    ZERO,CURABF
          MOVE    ZERO,CURACM
          MOVE    ZERO,CURACMC2
          RETURN 
.------------------------------------------------------------
. Get Last Year Stats Actuals
.------------------------------------------------------------
LYACTS00  CALL    ZSTA0000
          PACK    KEY14,FMAMLEDG,FMAMACCT
          IF      FLGFMSS2=0
            CALL    RDFMSS2 
          ENDIF
          MOVE    FMSSA1,LYRA01
          MOVE    FMSSA2,LYRA02
          MOVE    FMSSA3,LYRA03
          MOVE    FMSSA4,LYRA04
          MOVE    FMSSA5,LYRA05
          MOVE    FMSSA6,LYRA06
          MOVE    FMSSA7,LYRA07
          MOVE    FMSSA8,LYRA08
          MOVE    FMSSA9,LYRA09
          MOVE    FMSSA10,LYRA10
          MOVE    FMSSA11,LYRA11
          MOVE    FMSSA12,LYRA12
          MOVE    FMSSA13,LYRA13
          MOVE    ZERO,LYRABF
          MOVE    ZERO,LYRACM
          MOVE    ZERO,LYRACMC2
          RETURN 
.------------------------------------------------------------
. Get This Year Stats Budgets
.------------------------------------------------------------
TYBUDS00  CALL    ZSBU0000
          PACK    KEY14,FMAMLEDG,FMAMACCT
          IF      FLGFMSC1=0
            CALL    RDFMST1 
          ENDIF
          MOVE    FMSTCA01,CURB01
          MOVE    FMSTCA02,CURB02
          MOVE    FMSTCA03,CURB03
          MOVE    FMSTCA04,CURB04
          MOVE    FMSTCA05,CURB05
          MOVE    FMSTCA06,CURB06
          MOVE    FMSTCA07,CURB07
          MOVE    FMSTCA08,CURB08
          MOVE    FMSTCA09,CURB09
          MOVE    FMSTCA10,CURB10
          MOVE    FMSTCA11,CURB11
          MOVE    FMSTCA12,CURB12
          MOVE    FMSTCA13,CURB13
          RETURN
.------------------------------------------------------------
. Get Last Year Stats Budgets
.------------------------------------------------------------
LYBUDS00  CALL    ZSBU0000
          PACK    KEY14,FMAMLEDG,FMAMACCT
          IF      FLGFMSC3=0
            CALL    RDFMST3 
          ENDIF
          MOVE    FMSTCA01,LYRB01
          MOVE    FMSTCA02,LYRB02
          MOVE    FMSTCA03,LYRB03
          MOVE    FMSTCA04,LYRB04
          MOVE    FMSTCA05,LYRB05
          MOVE    FMSTCA06,LYRB06
          MOVE    FMSTCA07,LYRB07
          MOVE    FMSTCA08,LYRB08
          MOVE    FMSTCA09,LYRB09
          MOVE    FMSTCA10,LYRB10
          MOVE    FMSTCA11,LYRB11
          MOVE    FMSTCA12,LYRB12
          MOVE    FMSTCA13,LYRB13
          RETURN 
.------------------------------------------------------------
. Clear Stats Budgets
.------------------------------------------------------------
ZSBU0000  MOVE    ZERO,FMSTCA01
          MOVE    ZERO,FMSTCA02
          MOVE    ZERO,FMSTCA03
          MOVE    ZERO,FMSTCA04
          MOVE    ZERO,FMSTCA05
          MOVE    ZERO,FMSTCA06
          MOVE    ZERO,FMSTCA07
          MOVE    ZERO,FMSTCA08
          MOVE    ZERO,FMSTCA09
          MOVE    ZERO,FMSTCA10
          MOVE    ZERO,FMSTCA11
          MOVE    ZERO,FMSTCA12
          MOVE    ZERO,FMSTCA13
          RETURN
.------------------------------------------------------------
. Clear Stats Actuals
.------------------------------------------------------------
ZSTA0000  MOVE    ZERO,FMSSA1
          MOVE    ZERO,FMSSA2
          MOVE    ZERO,FMSSA3
          MOVE    ZERO,FMSSA4
          MOVE    ZERO,FMSSA5
          MOVE    ZERO,FMSSA6
          MOVE    ZERO,FMSSA7
          MOVE    ZERO,FMSSA8
          MOVE    ZERO,FMSSA9
          MOVE    ZERO,FMSSA10
          MOVE    ZERO,FMSSA11
          MOVE    ZERO,FMSSA12
          MOVE    ZERO,FMSSA13
          RETURN
.------------------------------------------------------------
. Open Financial Summary Tables
.------------------------------------------------------------
OPENFS00  PACK      FILENAME,FMSP,CURYEAR,SP70     * Current Year Actuals
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSP1
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSP1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSFPSA1,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSP1       
          ENDIF
.
          PACK      FILENAME,FMSS,CURYEAR,SP70    * Current Year Stats
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSS1
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSS1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSSMAA1,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSS1       
          ENDIF
.
          MOVE      CURYEAR,FORM4
          SUB       ONE,FORM4
          PACK      FILENAME,FMSP,FORM4,SP70      * Last Year Actuals
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSP2
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSP2
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSFPSA2,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSP2       
          ENDIF
.
          PACK      FILENAME,FMSS,FORM4,SP70      * Last Year Stats
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSS2
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSS2
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSSMAA2,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSS2       
          ENDIF
.
          PACK      FILENAME,FMSB,FMLCBUDG,SP70    * Current Budget
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSB1
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSB1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSBUDA1,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSB1      
          ENDIF
.
          PACK      FILENAME,FMSC,FMLCBUDG,SP70  * Stats Current Budget
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSC1
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSC1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSSBUA1,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSC1      
          ENDIF
.
          MOVE      CURYEAR,FORM4
          SUB       ONE,FORM4
          PACK      KEY6,FMLALEDG,F4
          CALL      RDFMLC1
          PACK      FILENAME,FMSB,FMLCBUDG,SP70   * Budget Last Year
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSB3
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSB3
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSBUDA3,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSB3       
          ENDIF
.
          PACK      FILENAME,FMSC,FMLCBUDG,SP70  * Stats Alternate Budget
          REP       " 0",FILENAME
          MATCH     FILENAME,NAMFMSC3
          IF        !@EQUAL
            MOVE      FILENAME,NAMFMSC3
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FMSSBUA3,FILENAME
            TRAPCLR   IO
            MOVE      OVRCD,FLGFMSC3       
          ENDIF
          PACK      KEY6,FMLALEDG,CURYEAR
          CALL      RDFMLC1
.
OPENFS99  RETURN
.------------------------------------------------------------
. Set Period & Year for Enquiry 
.    This is determine from the enquiry parameters or
.    FINCYEAR & FINCPERD if they are set.
.------------------------------------------------------------
SETPER00  MATCH     SP70,ACCTKEYS
          GOTO      SETPER10 IF EQUAL
          MOVE      ACCTKEYS,KEY2
          CALL      RDFMLA1
          BRANCH    OVRCD,SETPER10
          GOTO      SETPER20
.
SETPER10  PACK      KEY21,PASSCODE,SP70
          CALL      RSFMWA1                      * go to start of records
          CALL      RKFMWA1                      * get next record
          BRANCH    OVRCD,SETPER95               * no more records ?
          MATCH     PASSCODE,FMWASEC
          GOTO      SETPER95 IF NOT EQUAL        * no more records ?
.
          PACK      KEY2,FMWALEDG,SP70
          CALL      RDFMLA1
.
SETPER20  PACK      KEY6,FMLALEDG,FMLACYRR,SP70
          MATCH     SP70,FINCYEAR
          IF        !@EQUAL
            PACK      KEY6,FMLALEDG,FINCYEAR,SP70
            UNPACK    KEY6,FMLALEDG,FMLACYRR
          ENDIF
          CALL      RDFMLC1
          MOVE      FMLACYRR,CURYEAR   * start at current year
          MATCH     SP70,FINCPERD
          IF        @EQUAL
            MOVE      FMLAPER,PERIODNO   * start at current period
          ELSE
            MOVE      FINCPERD,PERIODNO   * start at current period
          ENDIF
.
SETPER30  
.          LOAD      F1,PERIODNO,FMLC01IN,FMLC02IN,FMLC03IN,FMLC04IN,FMLC05IN:
.                                FMLC06IN,FMLC07IN,FMLC08IN,FMLC09IN,FMLC10IN:
.                                FMLC11IN,FMLC12IN,FMLC13IN
.          BRANCH    F1,SETPER90        * continue if period locked
.          IF        PERIODNO=1
.            CALL      RPFMLC1
.            BRANCH    OVRCD,SETPER95          * no more data ?
.            MATCH     FMLALEDG,FMLCLEDG
.            GOTO      SETPER95 IF NOT EQUAL   * no more data
.            MOVE      "12",PERIODNO
.            ADD       FMLAPERS,PERIODNO
.          ELSE
.            SUB       ONE,PERIODNO
.          ENDIF
.          GOTO      SETPER30           * check current period
.
SETPER90  MOVE      ZERO,EXIT          * continue
          GOTO      SETPER99
.
SETPER95  MOVE      ONE,EXIT           * quit
.
SETPER99  RETURN
.------------------------------------------------------------
. Calculate Period and YTD 
.------------------------------------------------------------
DPER0000  MOVE      CURABF,CURAYTD
          MOVE      LYRABF,LYRAYTD
          MOVE      ZERO,CURBYTD
          MOVE      ZERO,LYRBYTD
          MOVE      PERIODNO,F2
.
DPER1000  COMPARE   ONE,F2
          GOTO      DPER1500 IF LESS   * at current period
.
          LOAD      F12P5,F2,CURA01,CURA02,CURA03,CURA04:
                             CURA05,CURA06,CURA07,CURA08:
                             CURA09,CURA10,CURA11,CURA12,CURA13
          ADD       F12P5,CURAYTD
.
          LOAD      F12P5,F2,LYRA01,LYRA02,LYRA03,LYRA04:
                             LYRA05,LYRA06,LYRA07,LYRA08:
                             LYRA09,LYRA10,LYRA11,LYRA12,LYRA13
          ADD       F12P5,LYRAYTD
.
          LOAD      F12P5,F2,CURB01,CURB02,CURB03,CURB04:
                            CURB05,CURB06,CURB07,CURB08:
                            CURB09,CURB10,CURB11,CURB12,CURB13
          ADD       F12P5,CURBYTD
.
          LOAD      F12P5,F2,LYRB01,LYRB02,LYRB03,LYRB04:
                             LYRB05,LYRB06,LYRB07,LYRB08:
                             LYRB09,LYRB10,LYRB11,LYRB12,LYRB13
          ADD       F12P5,LYRBYTD
.
          SUB       ONE,F2
          GOTO      DPER1000
.
DPER1500  LOAD      CURAPER,PERIODNO,CURA01,CURA02,CURA03,CURA04:
                                     CURA05,CURA06,CURA07,CURA08:
                                     CURA09,CURA10,CURA11,CURA12,CURA13
.
          LOAD      LYRAPER,PERIODNO,LYRA01,LYRA02,LYRA03,LYRA04:
                                     LYRA05,LYRA06,LYRA07,LYRA08:
                                     LYRA09,LYRA10,LYRA11,LYRA12,LYRA13
.
          LOAD      CURBPER,PERIODNO,CURB01,CURB02,CURB03,CURB04:
                                     CURB05,CURB06,CURB07,CURB08:
                                     CURB09,CURB10,CURB11,CURB12,CURB13
.
          LOAD      LYRBPER,PERIODNO,LYRB01,LYRB02,LYRB03,LYRB04:
                                     LYRB05,LYRB06,LYRB07,LYRB08:
                                     LYRB09,LYRB10,LYRB11,LYRB12,LYRB13
.
          MOVE      FMAMTYPE,F1
          IF        F1=9|F1=8
            IF        FMAMAYTD=1
              DIV       PERIODNO,CURAYTD
              DIV       PERIODNO,CURBYTD
              DIV       PERIODNO,LYRAYTD
              DIV       PERIODNO,LYRBYTD
            ENDIF
          ENDIF
          RETURN
.
