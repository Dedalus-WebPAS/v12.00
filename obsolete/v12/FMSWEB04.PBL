. **********************************************************************
. * System    :   Web Finance System                                   *
. * Program   :   FMSWEB04                                             *
. * Desc      :   Financial Server - Drill Down                        *
. * Mods      :                                                        *
. **********************************************************************
. * V10.04.01 31.03.2014  B.G.Ackland  CAR 299363                      *
. *           Replace META Tag Redirect with Javascript in Common      *
. *           RDIREC00 Rountine                                        *
. **********************************************************************
. * V10.03.01 16/07/2013  Jill Parkinson CAR 287923                    *
. *           Added include of PATCONFD                                *
. **********************************************************************
. * V9.08.01  14/07/2007  Ebon Clements CAR 144647                     *
. *           Added WRONLY mode to RDIREC00 HTMLFILE open              *
. **********************************************************************
. * V9.05.B01 30/01/2006  Ebon Clements CAR 93186                      *
. *           Mods for REDIRECT length change. Recompiled for IBAWEBDF *
. **********************************************************************
. * V9.03.02  23.09.2003 Steve Downing  CAR 42285    (VF.11.01)        *
. *           Recompiled for FMSWEBCD                                  *
. * V9.03.01  21.10.2003 Ebon Clements  CAR 44461                      *
. *           Changed server to use the finance passcode WBSEFPCD      *
. **********************************************************************
. * V9.02.00  10.05.2002 Glenn Saunders                                *
. *           Export to new release i.e. v9.02 from vf.09              *
. **********************************************************************
. * VF.09.03  03.05.2002 Raghunandan Surve,HPS - SRF14716              *
. *           Recompiled for FMSAMATM - Fixed Current graph display    *
. *           03.05.2002  Steve Downing  SRF 12406                     *
. *           Recompiled for FMSAMBTM - Fixed display of account names *
. * VF.09.02  02.05.2002 Raghunandan Surve,HPS - SRF14716              *
. *           Recompiled for FMSAMATM                                  *
. * VF.09.01  18.04.2002 Raghunandan Surve,HPS - SRF14716              *
. *           Recompiled for FMSAMATM                                  *
. **********************************************************************
. * VF.01.01  18.10.2000 Sandra Barcham                                *
. *           Enable Annual Budget or Last Columns for detail A/C's    *
. **********************************************************************
. * VF.00.08  11.01.2000 Charles Handaya                               *
. *           Recompiled for Audit Files date                          *
. * VF.00.07  23.12.1999 Sandra Barcham                                *
. *           Recompiled for change to FMSCCAFD                        *
. *           srf 646145                                               *
. * VF.00.06  12.11.1999 B.G.Ackland                                   *
. *           Fix Links to Account Codes with Spaces included          *
. * VF.00.05  05.11.1999 B.G.Ackland                                   *
. *           Enable Annual Budget or Last Year Columns for summary A/C*
. * VF.00.04  20.09.1999 B.G.Ackland                                   *
. *           Ignore Accounts with Zero Balances                       *
. * VF.00.03  20.09.1999 B.G.Ackland                                   *
. *           Try to Fix Variance                                      *
. * VF.00.02  30.08.1999 B.G.Ackland                                   *
. *           Try to Fix Variance                                      *
. **********************************************************************
.
          INC       IBAWEBDF    
          INC       FMSWEBDF
.
          INC       PATCONFD/INC
          INC       FMSAMAFD/INC       * account
          INC       FMSBTYFD/INC       * budget data
          INC       FMSBUDFD/INC       * budget data
          INC       FMSCONFD/INC       * controlf
          INC       FMSFPSFD/INC       * period summary file
          INC       FMSLMAFD/INC       * ledger
          INC       FMSLMCFD/INC       * ledger financial calendar
          INC       FMSSBUFD/INC       * stat budget
          INC       FMSSMAFD/INC       * stat summary
          INC       FMSUWPFD/INC       * wp file
          INC       FMSCODFD/INC       * codes file
          INC       FMSLMBFD/INC       * report
          INC       FMSCCAFD/INC       * cost centre
          INC       FMSRSFFD/INC       * subjective
          INC       FMSSBAFD/INC       * subjective
          INC       FMSTCFFD/INC       * subjective
          INC       FMSWASFD/INC       * enquiry security
          INC       FMSWCFFD/INC       * Variance Flag
          INC       FMSWBCFD/INC       * enquiry security comments
.
LASTCOL   FORM      1
FMTACCT   DIM       25
WRKKEY14  DIM       14
NEXTYEAR  DIM       4  
LASTYEAR  DIM       4  
NEXTPERD  DIM       2
LASTPERD  DIM       2
SELNAME   DIM       12
SELPERD   FORM      2
SELYEAR   DIM       4
YEAREND   FORM      2
.
LOCKFLAG  FORM      1
ACCARR    DIM       14[250]
NAMARR    DIM       35[250]
COLARR    DIM       6[250]
LNKARR    DIM       87[250]
LASTARRY  FORM      3
ARRYCNT   FORM      3
.
TOTLLEDG  DIM       2
TOTLACCT  DIM       12
TOTLTYPE  DIM       1
TOTLDESC  DIM       35
.
MTH301    DIM       3
MTH302    DIM       3
MTH303    DIM       3
MTH304    DIM       3
MTH305    DIM       3
MTH306    DIM       3
MTH307    DIM       3
MTH308    DIM       3
MTH309    DIM       3
MTH310    DIM       3
MTH311    DIM       3
MTH312    DIM       3
MTH313    DIM       3
.
DSETVALU  FORM      1
DSETNUM   DIM       1
DSETAXIS  DIM       1
NUMPER    FORM      2
TAGBEF    DIM       6
TAGAFT    DIM       6
PERIODNO  FORM      2                  * current period number
.
NEXTLINK  DIM       127
LASTLINK  DIM       127
.
LEDGCODE  DIM       2
ACCTCODE  DIM       12
COSTHEAD  DIM       12
SUBJHEAD  DIM       12
COSTCODE  DIM       12
SUBJCODE  DIM       12
ACCOUNTN  DIM       35
BGRED     INIT      "#"##FF0000#""
BGGREEN   INIT      "#"##008000#""
BGGOOD    DIM       10
BGBAD     DIM       10
YTDBGC    DIM       9
CURBGC    DIM       9
.
CHARTOPT  FORM      1
ACCTKEYS  DIM       14
LINKUSER  DIM       4
FINCYEAR  DIM       4
FINCPERD  DIM       2
MAXVALUE  FORM      10
STEPVAL   FORM      10
PERNAME   DIM       12
PERNAME3  DIM       3 
.
AMTCOL01  FORM      12.5
AMTCOL02  FORM      12.5
AMTCOL03  FORM      12.5
AMTCOL04  FORM      12.5
AMTCOL05  FORM      12.5
AMTCOL06  FORM      12.5
AMTCOL07  FORM      12.5
OUTSTR18  DIM       18
FMTCOL01  DIM       18
FMTCOL02  DIM       18
FMTCOL03  DIM       18
FMTCOL04  DIM       18
FMTCOL05  DIM       18
FMTCOL06  DIM       18
FMTCOL07  DIM       18
EDITTYPE  FORM      1
FORMATTY  FORM      1
.
EDITSTR0  DIM       18
EDITSTR1  DIM       18
EDITSTR2  DIM       18
EDITSTR3  DIM       18
EDITSTR4  DIM       18
EDITSTR5  DIM       18
.
EDITSTA0  INIT      "(9999,999,999,999 "
EDITSTA1  INIT      "(99,999,999,999.9 "
EDITSTA2  INIT      "(9,999,999,999.99 "
EDITSTA3  INIT      "(9999,999,999.999 " 
EDITSTA4  INIT      "(999,999,999.9999 " 
EDITSTA5  INIT      "(99,999,999.99999 "
.
EDITSTB0  INIT      "99,999,999,999,999"
EDITSTB1  INIT      "9,99,999,999,999.9"
EDITSTB2  INIT      "999,999,999,999.99"
EDITSTB3  INIT      "99,999,999,999.999" 
EDITSTB4  INIT      "9,999,999,999.9999" 
EDITSTB5  INIT      "9999,999,999.99999"
.
AMT12P0   FORM      12
AMT12P1   FORM      12.1
AMT12P2   FORM      12.2
AMT12P3   FORM      12.3
AMT12P4   FORM      12.4
AMT12P5   FORM      12.5
.
INCOMEFL  FORM      2
ACTUAL    FORM      12.2
BUDGET    FORM      12.2
ACTUALCP  FORM      12.2
BUDGETCP  FORM      12.2
VARIANCP  FORM      12.2
PERVARCP  FORM      6.1 
.
ACTUALLY  FORM      12.2
ACTUALYD  FORM      12.2
BUDGETYD  FORM      12.2
VARIANYD  FORM      12.2
PERVARYD  FORM      6.1 
.
INDEX2    FORM      2
JAVATMPN  DIM       30
JAVATMPF  FILE      ASCII, FIXED=250
SAVTYPE   FORM      1
AVYTD     FORM      1
HEADTYPE  FORM      1
.
PRGID     INIT      "FMSWEB04"
PRGNAM    INIT      "Financial Server - Drill Down"
VERSION   INIT      "V12.00.00"
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          MATCH     SP70,WBSEFPCD       
          IF        !@EQUAL
            MOVE      WBSEFPCD,PASSCODE     * Web security finance passcode
          ENDIF
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      TEMACC00    * Account
          GOTO      MAIN1000
.
MAIN1200  CALL      TEMSUM00    * Summary Account
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      CONTROLF,"controlf"
          CALL      RDFMCO50
          CALL      RDFMCO51
          CALL      RDFMCO52
          CALL      RDFMCO65
          CALL      RDFMCO66
.
          OPEN      FMSAMAA1,"fmsamaaf"
          OPEN      FMSWASA1,"fmswasaf"
          OPEN      FMSWCFA1,"fmswcfaf"
          OPEN      FMSWBCA1,"fmswbcaf"
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      FMSLMCA1,"fmslmcaf"
          OPEN      FMSUWPA1,"fmsuwpaf"
          OPEN      FMSCODA1,"fmscodaf"
          OPEN      FMSLMBA1,"fmslmbaf"
          OPEN      FMSCCAA1,"fmsccaaf"
          OPEN      FMSTCFA1,"fmstcfaf"
          OPEN      FMSTCFA2,"fmstcfaf"
          OPEN      FMSRSFA2,"fmsrsfaf"
          OPEN      FMSSBAA1,"fmssbaaf"
.
          CALL      SETCOL00
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,CHARTOPT
          MOVE      SP70,ACCTKEYS
          MOVE      SP70,FINCYEAR
          MOVE      SP70,FINCPERD
          MOVE      "000",TEMPLATE
          MOVE      SP70,LINKUSER
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acctkeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCTKEYS
            REP       "a&",ACCTKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chartopt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHARTOPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fincyear=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FINCYEAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fincperd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FINCPERD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkuser=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKUSER
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Process Body of Template
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20
.
PROFLD10  CALL      FMSA0000
          GOTO      PROFLD99
.
PROFLD20  CALL      FMSB0000
          GOTO      PROFLD99
PROFLD99  RETURN
.------------------------------------------------------------
. Graph Account Code Details
.------------------------------------------------------------
TEMACC00  PACK      KEY14,ACCTKEYS,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,TEMACC95
.
          MOVE      FMAMDESC,WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,TEMACC95
.
          CALL      SETPER00   * Set Period and Year
          CALL      OPENFS00   * Open Summary Files
          CALL      FINDET00   * Get Financial Data
.
          CALL      WEBBOD00   * Process Body of HTML
.
TEMACC90  CALL      WEBEND00
          GOTO      TEMACC99
.
TEMACC95  CLEAR     WEBTITLE
          APPEND    "INVALID ACCOUNT - ",WEBTITLE
          APPEND    KEY14,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
.
TEMACC99  RETURN
.------------------------------------------------------------
. Graph Account Code Details
.------------------------------------------------------------
TEMSUM00  PACK      KEY14,ACCTKEYS,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,TEMSUM95
.
          MOVE      FMAMTYPE,F1
          BRANCH    F1,TEMSUM80,TEMSUM80,TEMSUM80,TEMSUM80,TEMSUM80:
                       TEMSUM10,TEMSUM10,TEMSUM80,TEMSUM10

.
TEMSUM10  MOVE      FMAMLEDG,TOTLLEDG
          MOVE      FMAMACCT,TOTLACCT
          MOVE      FMAMDESC,TOTLDESC
          MOVE      FMAMTYPE,TOTLTYPE
.
          MOVE      FMAMDESC,WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,TEMSUM95
.
          CALL      SETPER00   * Set Period and Year
          CALL      OPENFS00   * Open Summary Files
.
          MOVE      PERIODNO,F2
          LOAD      PERNAME,F2,FMLC01DE,FMLC02DE,FMLC03DE,FMLC04DE,FMLC05DE:
                               FMLC06DE,FMLC07DE,FMLC08DE,FMLC09DE,FMLC10DE:
                               FMLC11DE,FMLC12DE
          LOAD      KEY8,PERIODNO,FMLC01TO,FMLC02TO,FMLC03TO,FMLC04TO:
                                  FMLC05TO,FMLC06TO,FMLC07TO,FMLC08TO:
                                  FMLC09TO,FMLC10TO,FMLC11TO,FMLC12TO,FMLC13TO
          LOAD      LOCKFLAG,F2,FMLC01IN,FMLC02IN,FMLC03IN,FMLC04IN,FMLC05IN:
                                FMLC06IN,FMLC07IN,FMLC08IN,FMLC09IN,FMLC10IN:
                                FMLC11IN,FMLC12IN
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CALL      NXTLST00
.
          CALL      FINDET00   * Get Financial Data
          CALL      BLDARR00   * Get Financial Data
.
          CALL      WEBBOD00   * Process Body of HTML
.
          CALL      WEBEND00
          GOTO      TEMSUM99
.
TEMSUM80  MOVE      ACCTKEYS,KEY14
          CALL      SETACC00
          REP       " +",FMTACCT
          CLEAR     REDIRECT
          APPEND    "fmsweb01.pbl?reportno=1&template=1",REDIRECT
          APPEND    "&fincyear=",REDIRECT
          APPEND    FINCYEAR,REDIRECT
          APPEND    "&fincperd=",REDIRECT
          APPEND    FINCPERD,REDIRECT
          APPEND    "&acctkeys=",REDIRECT
          APPEND    FMTACCT,REDIRECT
          RESET     REDIRECT
.
          CALL      RDIREC00   * Posting Account Redirect to Transactions
          GOTO      TEMSUM99
.
TEMSUM95  CLEAR     WEBTITLE
          APPEND    "INVALID ACCOUNT - ",WEBTITLE
          APPEND    KEY14,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
.
TEMSUM99  RETURN
.
.------------------------------------------------------------
. Create Links to Next and Last Period
.------------------------------------------------------------
NXTLST00  MOVE      PERIODNO,F2
          MOVE      CURYEAR,F4
          SUB       ONE,F2
          IF        F2=0
            MOVE      "12",F2
            SUB       ONE,F4
          ENDIF
          MOVE      F2,LASTPERD
          REP       " 0",LASTPERD
          MOVE      F4,LASTYEAR
          REP       " 0",LASTYEAR
.
          MOVE      PERIODNO,F2
          MOVE      CURYEAR,F4
          ADD       ONE,F2
          IF        F2=13
            MOVE      "1",F2
            ADD       ONE,F4
          ENDIF
          MOVE      F2,NEXTPERD
          REP       " 0",NEXTPERD
          MOVE      F4,NEXTYEAR
          REP       " 0",NEXTYEAR
.
NXTLST99  RETURN
.------------------------------------------------------------
          INC       FMSAMATM
          INC       FMSAMBTM
          INC       FMSAMAIO/INC       * account
          INC       FMSBUDIO/INC       * budget data
          INC       FMSCONIO/INC       * controlf
          INC       FMSFPSIO/INC       * period summary file
          INC       FMSLMAIO/INC       * ledger
          INC       FMSLMCIO/INC       * ledger financial calendar
          INC       FMSSBUIO/INC       * stat budget
          INC       FMSSMAIO/INC       * stat summary
          INC       FMSUWPIO/INC       * wp file
          INC       FMSCODIO/INC       * codes file
          INC       FMSLMBIO/INC       * report
          INC       FMSCCAIO/INC       * cost centre
          INC       FMSRSFIO/INC       * subjective
          INC       FMSSBAIO/INC       * subjective
          INC       FMSTCFIO/INC       * subjective
          INC       FMSWASIO/INC       * enquiry security
          INC       FMSWBCIO/INC       * enquiry security comments
          INC       FMSWCFIO/INC       * Variance Flag
.
          INC       FMSWEBCD
          INC       NAMSTRCD
          INC       IBAWEBCD    
