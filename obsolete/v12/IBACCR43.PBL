.-------------------------------------------------------
          INC       STDGENDF     * Required Include
.
VERSION   INIT      "V12.00.00"
.-------------------------------------------------------
. V10.01.01 10/03/2011 Jill Parkinson CAR 233088
.           Added pmsvx1af 
. V9.02.00  04.07.2002  Glenn Saunders
.           Export to new release i.e. v9.02 from r5.09
.-------------------------------------------------------
. V5.08.02  16/08/2000  Caleb Sharman
.           Changed Health Fund variables to be 8 chars
. V5.08.01  22.08.2000  Sandra Barcham
.           Changed to allow new layout of ccshlcaf
.-------------------------------------------------------
. V5.08.B01 16.03.2000  Greg Horvat
.           Changed to get the coding from the episode coding files
. V5.07.01  11.09.1999 Steve Downing
.           Mods to use DAYSEP, Y2K mods to index keys (KEY30)
. V6.00.06  04.07.1996 B.G.Ackland
.           Hospital Prefix Changes
. V6.00.05  04.07.1996 B.G.Ackland
.           Hospital Prefix Changes
. V6.00.04  01.11.1993 B.G.Ackland
.           Change "Procedure" to Patient Service
. V6.00.03  27.09.1993 B.G.Ackland
.           New Program Generation Options
.-------------------------------------------------------
. Temp Variables for CCR43
.
ASDATDAY  FORM    4
ASDATEPS  DIM    16
ASDATTYP  FORM    1
BSDATDAY  FORM    4
BSDATEPS  DIM    16
BSDATTYP  FORM    1
CLINDEPT  DIM     3
DAYSDIFF  FORM    4
DAYSOVR   FORM    4
DAYSUND   FORM    4
LOCATION  DIM     4
PATDOCOP  FORM    1
PREFIX    FORM    1
SERVYEAR  FORM    4
SERVDAY   FORM    3
UPDFILE   FORM    1
VISADAY   FORM    3
VISAYEAR  FORM    4
.-------------------------------------------------------
.@@@@@ Start of Generated Code @@@@@
. NB - Code & Comments Included Before the above line 
.      will not be overwritten by the generation of a 
.      program. The STDGENDF file and VERSION must appear
.      before the line. 
.-----------------------------------------
.   Program       :   IBACCR43
.   Function      :   Patient Service Details Check           
.   Generated  On :   10/03/2011
.-----------------------------------------
.=========================
.File Description Includes
.-------------------------
          INC       CCSHCDFD/INC
          INC       CCSHLCFD/INC
          INC       CCSUPDFD/INC
          INC       PMS502FD    
          INC       PMSVX1FD/INC
.=========================
.Local Variable Definition
.-------------------------
PATMASOP  FORM      1 * Scr 00 Fld     4
PATTRNOP  FORM      1 * Scr 00 Fld     5
PATMISOP  FORM      1 * Scr 00 Fld     6
PATDSCOP  FORM      1 * Scr 00 Fld     7
AAEDEAOP  FORM      1 * Scr 00 Fld     8
OUTSITOP  FORM      1 * Scr 00 Fld     9
OUTBOBOP  FORM      1 * Scr 00 Fld    10
PATVISOP  FORM      1 * Scr 00 Fld    11
AAEDISOP  FORM      1 * Scr 00 Fld    12
PATECOOP  FORM      1 * Scr 00 Fld    13
PATECDOP  FORM      1 * Scr 00 Fld    14
CCIDPTOP  FORM      1 * Scr 00 Fld    15
RUNNUMB   FORM      4 * Scr 00 Fld    18
PATICUOP  FORM      1 * Scr 00 Fld    21
.
ACCEPT    FORM      1
SACCEPT   FORM      1
.
PRGID     INIT      "IBACCR43"
PRGNAM    INIT      "Patient Service Details Check           "
.
.--------------------------------
. MAINLINE - Controlling Logic
.--------------------------------
          TOPIC     PRGID
          MOVE      PORT,PARENTID
          CLOCK     PORT,DIM2
          MOVE      DIM2,PORT
ML0000
          CALL      INIT0000
          CALL      SC00L000
          CHAIN     PGM
.---------------------------------------
. INIT - Open Files & Display Heading
.---------------------------------------
INIT0000  CALL      DISPHEAD
          MOVE      ONE,CCENTRY
          MOVE      ONE,CCANLDTE
          MOVE      ONE,CDEFDTE
          MOVE      ZERO,CHIGHLT
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
          DISPLAY   *P56:24,"Opening scrsbga1";
          OPEN      SCRSBGA1,"scrsbgaf"
          DISPLAY   *P56:24,"Opening scrpsta1";
          OPEN      SCRPSTA1,"scrpstaf"
          DISPLAY   *P56:24,"Opening scrpsta1";
          OPEN      SCRPSTA2,"scrpstaf"
          DISPLAY   *P56:24,"Opening scrslta1";
          OPEN      SCRSLTA1,"scrsltaf"
          DISPLAY   *P56:24,"Opening ccshcdaf";
          OPEN      CCSHCDA1,"ccshcdaf"
          DISPLAY   *P56:24,"Opening ccshcdaf";
          OPEN      CCSHCDA2,"ccshcdaf"
          DISPLAY   *P56:24,"Opening ccshlcaf";
          OPEN      CCSHLCA1,"ccshlcaf"
          DISPLAY   *P56:24,"Opening ccsupdaf";
          OPEN      CCSUPDA1,"ccsupdaf"
          DISPLAY   *P56:24,"Opening ccsupdaf";
          OPEN      CCSUPDA2,"ccsupdaf"
          DISPLAY   *P56:24,"Opening ccsupdaf";
          OPEN      CCSUPDA3,"ccsupdaf"
          DISPLAY   *P56:24,"Opening ccsupdaf";
          OPEN      CCSUPDA4,"ccsupdaf"
          DISPLAY   *P56:24,"Opening pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
          DISPLAY   *P56:24,"Opening pmsvx1af";
          OPEN      PMSVX1A2,"pmsvx1af"
          DISPLAY   *P56:24,"Opening pmsvx1af";
          OPEN      PMSVX1A3,"pmsvx1af"
INIT9999  DISPLAY   *P1:24,*EL;
          RETURN
.
.------------------------------------
. Called for Print Screen Routine 
.------------------------------------
PRTSVARS
          MATCH     "00",SCRID
          IF         @EQUAL
            CALL       PS00L000   * Options                            
          ENDIF
          RETURN
.--------------------------------
. Screen - Options                            
.--------------------------------
SC00L000
SC00L100
          MOVE      "00",SCRID
          MOVE      ZERO,PRCOL
          MOVE      ZERO,PRVERT
          MOVE      "    1",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE     SCPSCOL,PRCOL
            MOVE     SCPSROW,PRVERT
          ENDIF
          CALL      SBACK000 * Display Background
.
SC00L200
          CALL      CF00L000 * Clear Fields
SC00L300
          CALL      KY00L000 * Enter Key Fields
          BRANCH    EXIT,SC00L999,SC00L999
SC00L400
          CALL      WP00L000 * Load any WP Details
SC00L500
          CALL      LM00L000 * Load any Batch Details
SC00L600
          CALL      DF00L000 * Display Fields
SC00L700
          CALL      SF00L000 * Select Fields
          BRANCH    EXIT,SC00L100,SC00L100,SC00L200
SC00L800
SC00L900
SC00L999  RETURN
.--------------------------------------------------------
. Clear Fields for Screen : Options                            
.-------------------------------------------------------
CF00L000
          MOVE      ZERO,PATMASOP
          MOVE      ZERO,PATTRNOP
          MOVE      ZERO,PATMISOP
          MOVE      ZERO,PATDSCOP
          MOVE      ZERO,AAEDEAOP
          MOVE      ZERO,OUTSITOP
          MOVE      ZERO,OUTBOBOP
          MOVE      ZERO,PATVISOP
          MOVE      ZERO,AAEDISOP
          MOVE      ZERO,PATECOOP
          MOVE      ZERO,PATECDOP
          MOVE      ZERO,CCIDPTOP
          MOVE      SP70,CCHCHCD 
          MOVE      SP70,CCHCDES 
          MOVE      ZERO,RUNNUMB 
          MOVE      ZERO,PATICUOP
CF00L999  RETURN
.--------------------------------------------------------
. Enter Key Fields for Options                            
.--------------------------------------------------------
KY00L000
.
KY00L110
.
.
          MOVE      "   17",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE     SP70,CCHCDES 
            PACK      VAR,SP70,SP70
            CALL      DISPITEM
          ENDIF
          MOVE      "   16",FLDID
          CALL      GETPOSIT
          IF        EXIT=1
            MOVE      "Mandatory Field Missing. Fatal - ",DISPMSG
            BEEP
            CALL      MESSAGE1
            GOTO      FATALERR
          ENDIF
          MOVE      "0",CKEYTYP
          CALL      EHCD0000
          BRANCH    EXIT,KY00L900,KY00L900
          MOVE      ZERO,ACCEPT
          MOVE      CCHCHCD,VAR      
          CALL      DISPITEM
.
.
          MOVE      "   17",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE      CCHCDES,VAR      
            CALL      DISPITEM
          ENDIF
.
KY00L120
          MOVE      "   18",FLDID
          CALL      GETPOSIT
          IF        EXIT=1
            MOVE      "Mandatory Field Missing. Fatal - ",DISPMSG
            BEEP
            CALL      MESSAGE1
            GOTO      FATALERR
          ENDIF
          MOVE      "0",CKEYTYP
          CALL      ERUNN000
          BRANCH    EXIT,KY00L110,KY00L900
          MOVE      ZERO,ACCEPT
          MOVE      RUNNUMB,VAR      
          CALL      DISPITEM
          MOVE      ZERO,EXIT
          GOTO      KY00L999
.
KY00L900  MOVE      ONE,EXIT
KY00L999  RETURN
.---------------------------------------------------------
. Load WP files for : Options                            
.---------------------------------------------------------
WP00L000
          RETURN
.---------------------------------------------------------
. Load Batch Screen for : Options                            
.---------------------------------------------------------
LM00L000
          RETURN
.---------------------------------------------------------
. Display Fields for : Options                            
.---------------------------------------------------------
DF00L000
          BRANCH   ACCEPT,DF00L999
          PACK     KEY15,PRGID,SCRID,SP70
          CALL     RSSCPS1
DF00L010
          CALL     RKSCPS1
          BRANCH   OVRCD,DF00L900
          MATCH    PRGID,SCPSPID
          GOTO     DF00L900 IF NOT EQUAL
          MATCH    SCRID,SCPSSID
          GOTO     DF00L900 IF NOT EQUAL
          MATCH    SP70,SCPSMTY
          GOTO     DF00L010 IF NOT EQUAL
.
          CALL     PS00L000 * Display Field
          GOTO     DF00L010
DF00L900
DF00L999
          RETURN
.---------------------------------------------------------
. Display/Print Fields for : Options                            
.---------------------------------------------------------
PS00L000   PACK      VAR,SP70,SP70
          PACK     PRINTVAR,SP70,SP70
          MOVE     SCPSITM,FIELDNO
          BRANCH    FIELDNO,PS00L999,PS00L999,PS00L999,PS00L101:
                            PS00L102,PS00L103,PS00L104,PS00L105:
                            PS00L106,PS00L107,PS00L108,PS00L109:
                            PS00L110,PS00L111,PS00L112,PS00L999:
                            PS00L113,PS00L999,PS00L999,PS00L999:
                            PS00L114
          GOTO     PS00L999
.
PS00L101
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATMASOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L102
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATTRNOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L103
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATMISOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L104
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATDSCOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L105
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      AAEDEAOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L106
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      OUTSITOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L107
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      OUTBOBOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L108
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATVISOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L109
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      AAEDISOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L110
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATECOOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L111
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATECDOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L112
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      CCIDPTOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L113
          MOVE      CCHCDES,VAR      
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L114
          MOVE      YES,YESNO
          MOVE      ZERO,FORM2
          MOVE      PATICUOP,FORM2   
          LOAD      YESNO,FORM2,NO
          MOVE      YESNO,VAR
          CALL      DISPITEM
          GOTO     PS00L999
PS00L999
          RETURN
.---------------------------------------------------------
. Selections for : Options                            
.---------------------------------------------------------
SF00L000  PACK     KEY13,PRGID,SCRID,SP70
          CALL     RSSCSL1
SF00L001  BRANCH   ACCEPT,SF00L020
.
SF00L005  CALL     MTSTQ000
          MOVE     SCSLITM,FIELDNO
          BRANCH    FIELDNO,SF00L006,SF00L101,SF00L102,SF00L006:
                            SF00L006,SF00L006,SF00L006,SF00L006:
                            SF00L006,SF00L006,SF00L006,SF00L006:
                            SF00L006,SF00L006,SF00L006,SF00L006:
                            SF00L006,SF00L006,SF00L103,SF00L104:
                            SF00L006
SF00L006  BEEP
          GOTO     SF00L005
SF00L020  CALL     RKSCSL1
          BRANCH   OVRCD,SF00L090
          MATCH    PRGID,SCSLPID
          GOTO     SF00L090 IF NOT EQUAL
          MATCH    SCRID,SCSLSID
          GOTO     SF00L090 IF NOT EQUAL
          MOVE     SCSLITM,FIELDNO
          BRANCH    FIELDNO,SF00L020,SF00L020,SF00L020,SF00L020:
                            SF00L020,SF00L020,SF00L020,SF00L020:
                            SF00L020,SF00L020,SF00L020,SF00L020:
                            SF00L020,SF00L020,SF00L020,SF00L020:
                            SF00L020,SF00L020,SF00L020,SF00L020:
                            SF00L020
          GOTO     SF00L020
SF00L090  MOVE     ZERO,ACCEPT
          GOTO     SF00L001
.
SF00L101
          MOVE      ZERO,EXIT
          GOTO      SF00L999
.
SF00L102
          CALL      LOCAT000
          MOVE      ZERO,EXIT
          GOTO      SF00L999
.
SF00L103
          CALL      CEPS0000
          MOVE      ZERO,EXIT
          GOTO      SF00L999
.
SF00L104
          CALL      UEPS0000
          MOVE      ZERO,EXIT
          GOTO      SF00L999
SF00L990  MOVE      ONE,EXIT * Exit Char Restart
SF00L999  RETURN
.@@@@@ Function Restart Point @@@@@
.----------------------------------------------------------------------------
. Check Loacations Against the Transfer file
.----------------------------------------------------------------------------
LOCAT000  MOVE     "99",CLNO
          CLOCK    TIME,CTIMEIS
          MOVE     ZERO,PREFIX
          MATCH    "1",CCHCPUSE           * Prefix for Episode in Use
          IF       @EQUAL
            MOVE     ONE,PREFIX
          ENDIF
.
          CALL     OPNCHK00      * Check to see if files Available
          BRANCH   EXIT,LOCAT999
.
          DISPLAY  *P1:24,*EL,"Processing  : "
          MOVE     ZERO,SECTOR
          PACK     KEY12,RUNNUMB,SP70
          MOVE     RUNNUMB,KEY4
          CALL     RSCCUP1
LOCAT100  CALL     RKCCUP1
          BRANCH   OVRCD,LOCAT700
          COMPARE  ZERO,RUNNUMB
          GOTO     LOCAT110 IF EQUAL
          MATCH    KEY4,CCUPRUN
          GOTO     LOCAT700 IF NOT EQUAL
.
LOCAT110  IF        PREFIX=0
            MATCH    CCHCHCD,CCUPHCD
            GOTO     LOCAT100 IF NOT EQUAL
          ELSE
            MATCH    CCHCPREF,CCUPENC       * Check for Matching Prefix
            GOTO     LOCAT100 IF NOT EQUAL
          ENDIF
.
          ADD      ONE,SECTOR
          IF       (SECTOR%1000=0)
           DISPLAY   *P20:24,*V2LON,SECTOR
           MOVE      "Y",ANS
           KEYIN     *P40:24,*EL,"Continue (Y/N) ? ",*T10,ANS
           REP       UPPLOW,ANS
           MATCH     "N",ANS
           IF        @EQUAL
             CHAIN     PGM
           ENDIF
          ENDIF
.
          CALL     LOCGET00
          BRANCH   EXIT,LOCAT100
.
          MOVE     LOCATION,CCUPCL4
          CALL     UPCCUP1
          GOTO     LOCAT100
.
LOCAT700
.
LOCAT999  RETURN
.---------------------------------------------------------------------------
. Check File Opens
.---------------------------------------------------------------------------
OPNCHK00  MOVE     ZERO,EXIT
          BRANCH   PATMISOP,OPNCHK90
          BRANCH   PATVISOP,OPNCHK90
          BRANCH   PATTRNOP,OPNCHK90
          GOTO     OPNCHK99
OPNCHK90  BEEP
          MOVE     "Insufficent Files Available to Process. - ",DISPMSG
          CALL     MESSAGE1
          MOVE     ONE,EXIT
OPNCHK99  RETURN
.---------------------------------------------------------------------------
. Determine Location etc
.---------------------------------------------------------------------------
LOCGET00  MATCH     SP70,CCUPENC
          GOTO      LOCGET85 IF EQUAL
          MATCH     SP70,CCUPURN
          GOTO      LOCGET85 IF EQUAL
.
          IF        PREFIX=1
            UNPACK    CCUPENC,KEY1,KEY15
            SQUEEZE   KEY15
            MOVE      KEY15,PVIBILL
          ELSE
            SQUEEZE   CCUPENC
            MOVE      CCUPENC,PVIBILL
          ENDIF
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,LOCGET85
.
          MOVE      SP70,LOCATION
          BRANCH    PVITYPE,LOCGET20,LOCGET40,LOCGET60
          GOTO      LOCGET85
.
. A & E
.------------------------------------------------------------
LOCGET20  MOVE      "A&E ",LOCATION
          GOTO      LOCGET80
.
. Outpatients
.------------------------------------------------------------
LOCGET40  MOVE      "OPD ",LOCATION
          GOTO      LOCGET80
.
. Inpatient
.------------------------------------------------------------
LOCGET60  SQUEEZE   CCUPENC
          MOVE      CCUPENC,PVIBILL
          PACK      KEY30,PVIBILL,CCUPDAT,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2              * red bed transfer file
          BRANCH    OVRCD,LOCGET65
          COMPARE   PVIBILL,TADMN        * test same admission number
          GOTO      LOCGET65 IF NOT EQUAL
          MOVE      TWARD,LOCATION       * Location Dept. at Date of Service
          GOTO      LOCGET80
.
LOCGET65  PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,LOCGET85
.
          COMPARE   ONE,ASTAT
          GOTO      LOCGET70 IF EQUAL
.
          PACK      KEY30,PVIBILL,CCUPDAT,SP70
          CALL      RDSTRAN2              * red bed transfer file
LOCGET68  CALL      RDKTRAN2              * red bed transfer file
          BRANCH    OVRCD,LOCGET85
          COMPARE   PVIBILL,TADMN         * test same admission number
          GOTO      LOCGET85 IF NOT EQUAL
.
          MATCH     "D",TMOVE
          GOTO      LOCGET68 IF NOT EQUAL
          MOVE      TWARD,LOCATION       * Location Dept. at Date of Service
          GOTO      LOCGET80
.
LOCGET70  PACK      KEY30,PVIBILL,CCUPDAT,SP70
          CALL      RDSTRAN2              * red bed transfer file
LOCGET71  CALL      RDKTRAN2              * red bed transfer file
          BRANCH    OVRCD,LOCGET75
          COMPARE   PVIBILL,TADMN         * test same admission number
          GOTO      LOCGET75 IF NOT EQUAL
          MATCH     "A",TMOVE
          GOTO      LOCGET71 IF NOT EQUAL
          MOVE      TWARD,LOCATION       * Location Dept. at Date of Service
          GOTO      LOCGET80
.
LOCGET75  MOVE      AWARD,LOCATION        * Location Dept. at Date of Service
.
LOCGET80  MATCH     CCUPCL4,LOCATION
          GOTO      LOCGET90 IF EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      LOCGET99
.
LOCGET85  MOVE      "UNK ",LOCATION
          MATCH     CCUPCL4,LOCATION
          GOTO      LOCGET90 IF EQUAL
          MOVE      ZERO,EXIT
          GOTO      LOCGET99
.
LOCGET90  MOVE      ONE,EXIT
.
LOCGET99  RETURN
.
.------------------------------------------------------------
. Enter Hospital Code
.------------------------------------------------------------
EHCD0000  MOVE    ZERO,CKEYTYP
          CALL    KCCHCA00
          BRANCH  EXIT,EHCD9999,EHCD9999
.
          MOVE    CCHCHCD,KEY2
          CALL    RDCCHL1
          IF      OVRCD=1
            MOVE    SP70,CCHLHCD
            MOVE    SP70,CCHLPMA
            MOVE    SP70,CCHLPTR
            MOVE    SP70,CCHLPMI
            MOVE    SP70,CCHLPDS
            MOVE    SP70,CCHLPVI
            MOVE    SP70,CCHLPMO
            MOVE    SP70,CCHLPMD
            MOVE    SP70,CCHLADE
            MOVE    SP70,CCHLADI
            MOVE    SP70,CCHLOSI
            MOVE    SP70,CCHLOBB
            MOVE    SP70,CCHLCDP
            MOVE    SP70,CCHLPMX
            MOVE    SP70,CCHLPIN
            MOVE    SP70,CCHLPDT
            MOVE    SP70,CCHLPCD
            MOVE    SP70,CCHLPMB
            MOVE    SP70,CCHLPDC
            MOVE    SP70,CCHLPIC
          ENDIF
.
          CALL    OPPMS000
.
EHCD9999  RETURN
.---------------------------------------------------------------------
. Open Patient Management Files
.------------------------------
. Flag Files That Could Be Opened
.--------------------------------
. PATVISOP FORM 1 0=Yes Visit File
. PATMASOP FORM 1 0=Yes Patient Master File
. PATTRNOP FORM 1 0=Yes Bed Transfer File
. PATMISOP FORM 1 0=Yes Admissions File
. PATECDOP FORM 1 0=Yes Diagnosis
. PATECOOP FORM 1 0=Yes Operations
. PATDSCOP FORM 1 0=Yes Discharge File
. PATICUOP FORM 1 0=Yes Intensive Care Unit
. AAEDEAOP FORM 1 0=Yes Accident and Emergency Masterfile
. AAEDISOP FORM 1 0=Yes Accident and Emergency Discharge File
. OUTSITOP FORM 1 0=Yes Outpatient Site File
. OUTBOBOP FORM 1 0=Yes Outpatient File B with "out" default prefix
.---------------------------------------------------------------------
OPPMS000  MOVE     ONE,PATVISOP
          MOVE     ONE,PATMASOP
          MOVE     ONE,PATTRNOP
          MOVE     ONE,PATMISOP
          MOVE     ONE,PATECDOP
          MOVE     ONE,PATECOOP
          MOVE     ONE,PATDSCOP
          MOVE     ONE,PATICUOP
          MOVE     ONE,AAEDEAOP
          MOVE     ONE,AAEDISOP
          MOVE     ONE,OUTSITOP
          MOVE     ONE,OUTBOBOP
          MOVE     ONE,CCIDPTOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLCDP
          IF       @EQUAL
            OPEN     CCIDPTA1,"ccidptaf"
          ELSE
            MOVE     "ccidptaf",KEY8
            STRIP    CCHLCDP
            PACK     KEY80,CCHLCDP,KEY8
            OPEN     CCIDPTA1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,CCIDPTOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPVI
          IF       @EQUAL
            OPEN     PATVISA1,"patvisaf"
            OPEN     PATVISA2,"patvisaf"
          ELSE
            MOVE     "patvisaf",KEY8
            STRIP    CCHLPVI
            PACK     KEY80,CCHLPVI,KEY8
            OPEN     PATVISA1,KEY80
            OPEN     PATVISA2,KEY80
          ENDIF
          TRAPCLR  IO
          TRAPCLR  IO
          MOVE     OVRCD,PATVISOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPMA
          IF       @EQUAL
            OPEN     PATMA1A1,"patma1af"
          ELSE
            MOVE     "patma1af",KEY8
            STRIP    CCHLPMA
            PACK     KEY80,CCHLPMA,KEY8
            OPEN     PATMA1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATMASOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPMX
          IF       @EQUAL
            OPEN     PATMX1A1,"patmx1af"
          ELSE
            MOVE     "patmx1af",KEY8
            STRIP    CCHLPMX
            PACK     KEY80,CCHLPMX,KEY8
            OPEN     PATMX1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATMASOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPTR
          IF       @EQUAL
            OPEN     PATTRAN2,"pattranf"
          ELSE
            MOVE     "pattranf",KEY8
            STRIP    CCHLPTR
            PACK     KEY80,CCHLPTR,KEY8
            OPEN     PATTRAN2,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATTRNOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPMI
          IF       @EQUAL
            OPEN     PATMI1A1,"patmi1af"
          ELSE
            MOVE     "patmi1af",KEY8
            STRIP    CCHLPMI
            PACK     KEY80,CCHLPMI,KEY8
            OPEN     PATMI1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATMISOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPMD
          IF       @EQUAL
            OPEN     PATECDA2,"patecdaf"
          ELSE
            MOVE     "patecdaf",KEY8
            STRIP    CCHLPMD
            PACK     KEY80,CCHLPMD,KEY8
            OPEN     PATECDA2,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATECDOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPMO
          IF       @EQUAL
            OPEN     PATECOA2,"patecoaf"
          ELSE
            MOVE     "patecoaf",KEY8
            STRIP    CCHLPMO
            PACK     KEY80,CCHLPMO,KEY8
            OPEN     PATECOA2,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATECOOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPDS
          IF       @EQUAL
            OPEN     PATDSCH1,"patdschf"
          ELSE
            MOVE     "patdschf",KEY8
            STRIP    CCHLPDS
            PACK     KEY80,CCHLPDS,KEY8
            OPEN     PATDSCH1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATDSCOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLPIC
          IF       @EQUAL
            OPEN     PATICUA1,"paticuaf"
          ELSE
            MOVE     "paticuaf",KEY8
            STRIP    CCHLPIC
            PACK     KEY80,CCHLPIC,KEY8
            OPEN     PATICUA1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,PATICUOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLADE
          IF       @EQUAL
            OPEN     AAEDE1A1,"aaede1af"
          ELSE
            MOVE     "aaede1af",KEY8
            STRIP    CCHLADE
            PACK     KEY80,CCHLADE,KEY8
            OPEN     AAEDE1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,AAEDEAOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLADI
          IF       @EQUAL
            OPEN     AAEDI1A1,"aaedi1af"
          ELSE
            MOVE     "aaedi1af",KEY8
            STRIP    CCHLADI
            PACK     KEY80,CCHLADI,KEY8
            OPEN     AAEDI1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,AAEDISOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLOSI
          IF       @EQUAL
            OPEN     OUTSITA1,"outsitaf"
          ELSE
            MOVE     "outsitaf",KEY8
            STRIP    CCHLOSI
            PACK     KEY80,CCHLOSI,KEY8
            OPEN     OUTSITA1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,OUTSITOP
.
          MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          MATCH    SP70,CCHLOBB
          IF       @EQUAL
            OPEN     OUTBB1A1,"outbb1af"
          ELSE
            MOVE     "outbb1af",KEY8
            STRIP    CCHLOBB
            PACK     KEY80,CCHLOBB,KEY8
            OPEN     OUTBB1A1,KEY80
          ENDIF
          TRAPCLR  IO
          MOVE     OVRCD,OUTBOBOP
.
          RETURN
.------------------------------------------------------------
. Keyin Run Number
.------------------------------------------------------------
ERUNN000  KEYIN     *PCCOL:CVERT,*V2LON,*MASK,RUNNUMB
          MOVE      RUNNUMB,CCUPRUN
          IF        RUNNUMB=0
            MOVE      ZERO,EXIT
            GOTO      ERUNN999
          ENDIF
          MOVE      RUNNUMB,CCUPRUN
          MOVE      RUNNUMB,KEY4
          PACK      KEY12,KEY4,SP70
          CALL      RSCCUP1
          CALL      RKCCUP1
          BRANCH    OVRCD,ERUNN010
          MATCH     KEY4,CCUPRUN
          GOTO      ERUNN010 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      ERUNN999
.
ERUNN010  MOVE      "No Records for Run. - ",DISPMSG
          BEEP
          CALL      MESSAGE1
          GOTO      ERUNN000
.
ERUNN999  RETURN
.------------------------------------------------------------
. Check Visit File for Blank Episodes
.------------------------------------------------------------
CEPS0000 MOVE     ZERO,UPDFILE
         MOVE     ZERO,DAYSUND
         MOVE     ZERO,DAYSOVR
         CALL     PEPS0000
         RETURN
.------------------------------------------------------------
. Process Visit File for Blank Episodes
.------------------------------------------------------------
PEPS0000 MOVE     "99",CLNO
         CLOCK    TIME,CTIMEIS
         MOVE     ZERO,PREFIX
         MATCH    "1",CCHCPUSE           * Prefix for Episode in Use
         IF       @EQUAL
           MOVE     ONE,PREFIX
         ENDIF
.
         CALL     CHKOPN00      * Check to see if files Available
         BRANCH   EXIT,PEPS9999
.
         DISPLAY  *P1:24,*EL,"Printing Page : "
.
         COMPARE  ZERO,RUNNUMB
         GOTO     PEPS5000 IF EQUAL
.
. Process A single Run
.------------------------------------------------------------
         PACK     KEY12,RUNNUMB,SP70
         CALL     RSCCUP1
PEPS1000 CALL     RKCCUP1
         BRANCH   OVRCD,PEPS7000
         MOVE     RUNNUMB,KEY4
         MATCH    KEY4,CCUPRUN
         GOTO     PEPS7000 IF NOT EQUAL
         MATCH    SP70,CCUPENC
         GOTO     PEPS1000 IF NOT EQUAL
         IF       PREFIX=0
           MATCH    CCHCHCD,CCUPHCD
           GOTO     PEPS1000 IF NOT EQUAL
         ELSE
           MATCH    CCHCPREF,CCUPENC       * Check for Matching Prefix
           GOTO     PEPS1000 IF NOT EQUAL
         ENDIF
.
         CALL     CHKVIS00
.
         GOTO     PEPS1000
.
. Process All Blank Episode Numbers
.------------------------------------------------------------
PEPS5000 IF       PREFIX=1
           MOVE     "1 ",CCHCHCD
         ENDIF
         PACK     KEY31,CCHCHCD,SP70
         CALL     RDCCUP2
         IF       OVRCD=0
           CALL     RPCCUP2
         ENDIF
.
PEPS6000 CALL     RKCCUP2
         BRANCH   OVRCD,PEPS7000
         MATCH    CCHCHCD,CCUPHCD
         GOTO     PEPS7000 IF NOT EQUAL
         MATCH    SP70,CCUPENC
         GOTO     PEPS7000 IF NOT EQUAL
.
         CALL     CHKVIS00
.
         GOTO     PEPS6000
.
PEPS7000
         CALL      UND132
         PRINT     *50,"***  End of Report  ***"
.
PEPS9999 RETURN
.------------------------------------------------------------
. Check File Opens
.------------------------------------------------------------
CHKOPN00 MOVE     ZERO,EXIT
         BRANCH   PATVISOP,CHKOPN90
         GOTO     CHKOPN99
CHKOPN90 BEEP
         MOVE     "Insufficent Files Available to Process. - ",DISPMSG
         CALL     MESSAGE1
         MOVE     ONE,EXIT
CHKOPN99 RETURN
.------------------------------------------------------------
. Check Visit File
.------------------------------------------------------------
CHKVIS00 MOVE     SP70,BSDATEPS   * Before Service Date Episode
         MOVE     SP70,ASDATEPS   * After  Service Date Episode
         MOVE     ZERO,BSDATTYP   * Before Service Date Visit Type
         MOVE     ZERO,ASDATTYP   * After  Service Date Visit Type
.
         MATCH    SP70,CCUPURN
         GOTO     CHKVIS99 IF EQUAL * Ignore Records With Blank UR No
.
         MATCH    "       0",CCUPURN
         GOTO     CHKVIS99 IF EQUAL * Ignore Records With Blank UR No
.
         MATCH    "0       ",CCUPURN
         GOTO     CHKVIS99 IF EQUAL * Ignore Records With Blank UR No
.
         STRIP    CCUPURN
         MOVELPTR CCUPURN,F2
         ASSIGN   8-F2,F2
         MOVE     SP70,KEY8
         RESET    KEY8,F2
         APPEND   CCUPURN,KEY8
         RESET    KEY8
.
         PACK     KEY24,KEY8,CCUPDAT,Z70
         CALL     RDVISA2
         IF       OVRCD=0
           CALL     RDKVISA2
         ENDIF
         CALL     RDPVISA2
         BRANCH   OVRCD,CHKVIS20
         MATCH    KEY8,PVIURNO
         GOTO     CHKVIS20 IF NOT EQUAL
         MOVE     PVIBILL,BSDATEPS
         MOVE     PVITYPE,BSDATTYP
.
CHKVIS20 PACK     KEY24,KEY8,CCUPDAT,SP70
         CALL     RDVISA2
         IF       OVRCD=0
           CALL     RDPVISA2
         ENDIF
         CALL     RDKVISA2
         BRANCH   OVRCD,CHKVIS40
         MATCH    KEY8,PVIURNO
         GOTO     CHKVIS40 IF NOT EQUAL
         MOVE     PVIBILL,ASDATEPS
         MOVE     PVITYPE,ASDATTYP
.
CHKVIS40 IF       ((ASDATTYP=0)&(BSDATTYP=0))
           GOTO      CHKVIS80     * No Visit Record Found
         ENDIF
.
         UNPACK   CCUPDAT,CCENT,CYEAR,CMON,CDAY
         CALL     PACDATE
         MOVE     CPCDATE,KEY10
         IF       BSDATTYP>0
           MOVE     BSDATEPS,CCUPENC
           MOVE     BSDATEPS,KEY8
           CALL     RDVISA1
           COMPARE  "55",CLNO
           CALL     HEDVIS00 IF NOT LESS
           ADD      ONE,CLNO
           CALL     NDAY0000
           UNPACK   PVIDATE,CCENT,CYEAR,CMON,CDAY
           CALL     PACDATE
           PRINT    CCUPRUN,"/",CCUPREC,SP3,CCUPURN:
                    *30,"Service Date: ",KEY10:
                    " Visit Date: ",CPCDATE," Type : ",PVITYPE:
                    " Adm:",PVIBILL:
                    " Days:",DAYSDIFF
           MOVE     DAYSDIFF,BSDATDAY
         ENDIF
.
         IF       ASDATTYP>0
           MOVE     ASDATEPS,CCUPENC
           MOVE     ASDATEPS,KEY8
           CALL     RDVISA1
           COMPARE  "55",CLNO
           CALL     HEDVIS00 IF NOT LESS
           ADD      ONE,CLNO
           CALL     NDAY0000
           UNPACK   PVIDATE,CCENT,CYEAR,CMON,CDAY
           CALL     PACDATE
           PRINT    CCUPRUN,"/",CCUPREC,SP3,CCUPURN:
                    *30,"Service Date: ",KEY10:
                    " Visit Date: ",CPCDATE," Type : ",PVITYPE:
                    " Adm:",PVIBILL:
                    " Days:",DAYSDIFF
           MOVE     DAYSDIFF,ASDATDAY
         ENDIF
.
         COMPARE   ZERO,UPDFILE      * Print Only
         GOTO      CHKVIS90 IF EQUAL
.
. Update Patient Services File
.
         IF        ((ASDATTYP>0)&(BSDATTYP>0))
           IF        ((ASDATDAY*SEQ)<BSDATDAY)
             MOVE      ASDATEPS,CCUPENC
             MOVE      ASDATDAY,DAYSDIFF
           ELSE
             MOVE      BSDATEPS,CCUPENC
             MOVE      BSDATDAY,DAYSDIFF
           ENDIF
         ENDIF
.
         IF        ((DAYSDIFF>DAYSOVR)&(DAYSDIFF<DAYSUND))
           PACK      KEY12,CCUPRUN,CCUPREC
           MOVE      CCUPENC,KEY16
           CALL      RDCCUP1
           IF        OVRCD=0
.
              MOVE      KEY16,CCUPENC
              MOVE      CCUPENC,KEY8
              CALL      RDVISA1
              CALL      GETLOC00     * Get Location/Clinical Dept/Service
              IF        EXIT=0
                MOVE      CCUPENC,KEY8
                IF        PREFIX=1
                  PACK      KEY15,KEY8,SP70
                  SQUEEZE   KEY15
                  PACK      KEY16,CCHCPREF,KEY15
                  MOVE      "1 ",KEY2
                  PACK      KEY18,KEY2,KEY16,SP70
                ELSE
                  PACK      KEY16,KEY8,SP70
                  SQUEEZE   KEY16
                  PACK      KEY18,CCHCHCD,KEY16,SP70
                ENDIF
                SQUEEZE   KEY16
                MOVE      KEY16,CCUPENC
                CALL      UPCCUP1
                ADD       ONE,CLNO
                PRINT     "Update : ",CCUPENC,"/",CCUPCL1,"/",CCUPCL2,"/":
                                                    CCUPCL3,"/",CCUPCL4
              ELSE
                ADD       ONE,CLNO
                PRINT     "NO UPDATE: ",CCUPENC," No Source System Details"
              ENDIF
           ENDIF
         ENDIF
         GOTO      CHKVIS90
.
. No Matching Visit Record Found
.--------------------------------
CHKVIS80  COMPARE  "55",CLNO
          CALL     HEDVIS00 IF NOT LESS
          ADD      ONE,CLNO
          PRINT    CCUPRUN,"/",CCUPREC,SP3,CCUPURN:
                   *30,"No Matching Visit Record Found."
          GOTO     CHKVIS99
CHKVIS90
.
CHKVIS99 RETURN
.------------------------------------------------------------
. Heading for Update Report
.------------------------------------------------------------
HEDVIS00 CALL      HEAD132
         CALL      UND132
         PRINT     "Run/Record      U/R Number   Action"
         CALL      UND132
         DISPLAY   *P17:24,*V2LON,CPAGENO
         IF        (CPAGENO%10=0)
           MOVE      "Y",ANS
           KEYIN     *P40:24,*EL,"Continue (Y/N) ? ",*T10,ANS
           REP       UPPLOW,ANS
           MATCH     "N",ANS
           IF        @EQUAL
             PRINT     "**** Report Aborted ****"
             CHAIN     PGM
           ENDIF
         ENDIF
         ADD       "3",CLNO
         RETURN
.------------------------------------------------------------
. Calculate Days Between Service Date and Visit Date
.------------------------------------------------------------
NDAY0000  DAYSEP    PVIDATE,CCUPDAT,DAYSDIFF
.
NDAY9999  RETURN
.------------------------------------------------------------
. Determine Location etc
.------------------------------------------------------------
GETLOC00  MOVE      "UNK",LOCATION
          MOVE      SP70,CLINDEPT
          BRANCH    PVITYPE,GETLOC20,GETLOC40,GETLOC60
          GOTO      GETLOC90
.
. A & E
.------------------------------------------------------------
GETLOC20  MOVE      "A&E ",LOCATION
          MOVE      "AE  ",CCUPCL1
          BRANCH    AAEDEAOP,GETLOC90
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GETLOC90
          MOVE      ADACLASS,CLINDEPT
          GOTO      GETLOC80
.
. Outpatients
.------------------------------------------------------------
GETLOC40  MOVE      "OPD ",LOCATION
          MOVE      "OP  ",CCUPCL1
          BRANCH    OUTSITOP,GETLOC90
          BRANCH    OUTBOBOP,GETLOC90
          PACK      KEY6,PVISITE             * Site code is the key
          CALL      RDSITA1                  * Read site file for file prefix
          BRANCH    OVRCD,GETLOC90           * No site rec - use curr event no
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO           * Set trap to catch missing files
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          OPEN      OUTBB1A1,CFNAME
          TRAPCLR   IO                       * Clear file open trap
          BRANCH    OVRCD,GETLOC90
.
          PACK      KEY8,PVIBILL             * Current event no
          CALL      RDBOKB1                  * Read bookings extension file
          CLOSE     OUTBB1A1
          BRANCH    OVRCD,GETLOC90           * No record - use current event no
          MOVE      OBACLASS,CLINDEPT        * Clinical Department
          GOTO      GETLOC80
.
. Inpatient
.------------------------------------------------------------
GETLOC60  MOVE      "IP  ",CCUPCL1
          BRANCH    PATMISOP,GETLOC90
          BRANCH    PATDSCOP,GETLOC90
          BRANCH    PATTRNOP,GETLOC90
          PACK      KEY8,PVIBILL
          CALL      RDMISS1
          BRANCH    OVRCD,GETLOC90
          CALL      RDDSCH1
          BRANCH    OVRCD,GETLOC90
          MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      "DC  ",CCUPCL1
          ENDIF
.
          MOVE      ATYPE,CLINDEPT
          UNPACK    CCUPDAT,CCENT,CYEAR,CMON,CDAY
          PACK      KEY30,PVIBILL,CCUPDAT,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2                 * Red bed transfer file
          BRANCH    OVRCD,GETLOC65
          COMPARE   PVIBILL,TADMN            * Test same admission number
          GOTO      GETLOC65 IF NOT EQUAL
          MOVE      TATYPE,CLINDEPT          * Clinical Dept. at Date of Service
          MOVE      TWARD,LOCATION           * Location Dept. at Date of Service
          GOTO      GETLOC80
.
GETLOC65  COMPARE   ONE,ASTAT
          GOTO      GETLOC70 IF EQUAL
.
          PACK      KEY30,PVIBILL,CCUPDAT,SP70
          CALL      RDSTRAN2                 * red bed transfer file
GETLOC68  CALL      RDKTRAN2                 * red bed transfer file
          BRANCH    OVRCD,GETLOC80
          COMPARE   PVIBILL,TADMN            * test same admission number
          GOTO      GETLOC80 IF NOT EQUAL
.
          MATCH     "D",TMOVE
          GOTO      GETLOC68 IF NOT EQUAL
.
          MOVE      TWARD,LOCATION           * Location Dept. at Date of Service
          MOVE      TATYPE,CLINDEPT          * Clinical Dept. at Date of Service
          GOTO      GETLOC80
.
GETLOC70  PACK      KEY30,PVIBILL,CCUPDAT,SP70
          CALL      RDSTRAN2                 * red bed transfer file
GETLOC71  CALL      RDKTRAN2                 * red bed transfer file
          BRANCH    OVRCD,GETLOC75
          COMPARE   PVIBILL,TADMN            * test same admission number
          GOTO      GETLOC75 IF NOT EQUAL
          MATCH     "A",TMOVE
          GOTO      GETLOC71 IF NOT EQUAL
          MOVE      TWARD,LOCATION           * Location Dept. at Date of Service
          MOVE      TATYPE,CLINDEPT          * Clinical Dept. at Date of Service
          GOTO      GETLOC80
.
GETLOC75  MOVE      AWARD,LOCATION           * Location Dept. at Date of Service
          MOVE      ATYPE,CLINDEPT           * Clinical Dept. at Date of Service
.
GETLOC80  PACK      CCUPCL2,CLINDEPT,SP20    * Clinical Department
          MOVE      SP20,CCUPCL3
.
          PACK      KEY3,CLINDEPT
          CALL      RDCCDPT1
          IF        OVRCD=0
            PACK      CCUPCL3,CCDTSERV,SP20  * Service Code
          ENDIF
          MOVE      LOCATION,CCUPCL4
.
          MOVE      ZERO,EXIT
          GOTO      GETLOC99
.
GETLOC90  MOVE      ONE,EXIT
.
GETLOC99  RETURN
.
.------------------------------------------------------------
. Check Visit File for Blank Episodes
.------------------------------------------------------------
UEPS0000 DISPLAY  *P1:18,*EF:
                  *P1:19,*V2LON,*ULON,"Service Date to Visit Date Range"
         KEYIN    *P1:21,"Number of Days Must be  Over  (eg -35) : ":
                  *P42:21,*V2LON,DAYSOVR:
                  *P42:21,*DV,DAYSOVR,*HOFF:
                  *P1:22,"                    and Under (eg  35) : ":
                  *P42:22,*V2LON,DAYSUND:
                  *P42:22,*DV,DAYSUND
.
UEPS0100 KEYIN    *P1:24,"Ok to Process (":
                  *V2LON,"Y",*HOFF,"/":
                  *V2LON,"N",*HOFF,") ? ",*V2LON,ANS
         REP      UPPLOW,ANS
         MATCH    ANSN,ANS
         GOTO     UEPS0000 IF EQUAL
         MATCH    ANSY,ANS
         GOTO     UEPS0100 IF NOT EQUAL
.
         MOVE     ONE,UPDFILE
.
         CALL     PEPS0000
.
         RETURN
.-------------------------------
. Includes for I/O and Keyins
.-------------------------------
          INC       CCSHCDIO/INC
          INC       CCSHCDKY    
          INC       CCSHLCIO/INC
          INC       CCSUPDIO/INC
          INC       PMS502IO    
          INC       PMSVX1IO/INC
.
          INC       STDGENCD
.
