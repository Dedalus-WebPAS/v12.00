.*****************************************************************************
.*    Program      : F02MHDAU                                                *
.*    Description  : Conversion mehaudda to new File layout                  *
.*                                                                           *
.*    Author       : Mike Laming                                             *
.*    Date         : 05/12/2011                                              *
.*    Modifications:                                                         *
.*        V10.02.01 05/12/2011  Mike Laming                                  *
.*                  Special Fixit to correct Audit file for missing fields   *
.*                  MHDLACTV, MHDLEDAT & MHDLETIM                            *
.*****************************************************************************
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
.
MEHAUDDA   IFILE    SQL, FIXED=487, KEY="D28-35,36-43,1-8,9-16"
..MEHAUDDB   IFILE    SQL, FIXED=487, KEY="D1-8,9-16,28-35,36-43"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
MHDLMDAT  DIM       8      8        1     Date of Change
MHDLMTIM  DIM       8      8        9     Time of Change
MHDLRTYP  DIM       1      1        17    Record Type
.                                              A = Added
.                                              B = Before image
.                                              C = After Image
.                                              D = Delete (Inactive)
MHDLMUID  DIM      10     10        18    WEB User ID Changed (websecaf)
.MHDLURNO DIM       8      8        28    U/R Number
.MHDLUNIQ DIM       8      8        36    Unique Number
.
.Data File Definition
.--------------------
.MEHDLSA1   IFILE    SQL, FIXED=460, KEY="U1-8,9-16,17-24,25-32"
.MEHDLSA2   IFILE    SQL, FIXED=460, KEY="U79-86,1-8,9-16,17-24,25-32"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
MHDLURNO  DIM       8      8        1     U/R Number
MHDLUNIQ  DIM       8      8        9     Unique Number
MHDLSDAT  DIM       8      8        17    Start Date (ccyymmdd)
MHDLSTIM  DIM       8      8        25    Start Time (hh:mm:ss)
MHDLACTV  DIM       1      1        33    Status 0-Active 1-Inactive
MHDLSCOD  DIM       3      3        34    Section Code (category LS)
MHDLSTAT  DIM       3      3        37    Review Status (category LR)
MHDLRDAT  DIM       8      8        40    Review Date (ccyymmdd)
MHDLRTIM  DIM       8      8        48    Review Time (hh:mm:ss)
MHDLHCPC  DIM       10     10       56    HCP Code
MHDLCASE  DIM       10     10       66    Case Team
MHDLPOCC  DIM       3      3        76    Place of Occurrence (category PO)
MHDLREMD  DIM       8      8        79    Reminder Date (ccyymmdd)
MHDLDRIV  DIM       1      1        87    Is the patient allowed to drive?
.                                         0-No, 1-Yes
MHDLRESD  DIM       1      1        88    Residential Admission?
.                                         0-No, 1-Yes
MHDLRCOD  DIM       6      6        89    Place of Resident(meheoraf.mheotype=R)
MHDLCUID  DIM       10     10       95    WEB User ID created (websecaf)
MHDLCDAT  DIM       8      8        105   Date Record created (ccyymmdd)
MHDLCTIM  DIM       8      8        113   Time Record created (hh:mm:ss)
MHDLUUID  DIM       10     10       121   WEB User ID updated (websecaf)
MHDLUDAT  DIM       8      8        131   Date record updated
MHDLUTIM  DIM       8      8        139   Time record update
MHDLCMNT  DIM       100    100      147   Comments
MHDLSENT  DIM       1      1        247   Mental Health data sent
.                                         Y-Yes, N or blank-No
MHDLEDAT  DIM       8      8        248   End Date (ccyymmdd)
MHDLETIM  DIM       8      8        256   End Time (hh:mm:ss)
MHDLSULS  DIM       3      3        264   Supp. Legal Status - Cat."LS"
MHDLSLSD  DIM       8      8        267   Supp. Legal Status Effective Date
MHDLRPDT  DIM       8      8        275   Date Review performed
MHDLCNSD  DIM       8      8        283   Court Notices Sent Date
MHDLTRDT  DIM       8      8        291   Tribunal Date
MHDLLWCD  DIM       8      8        299   Lodged with Court Date
MHDLCTCD  DIM       3      3        307   Court Time Code - Cat."xy"
MHDLCMN2  DIM       100    100      310   Comments 2
MHDLSPRE  DIM       50     50       410   Spare Variable
.
.End of Record                      460
.
. The following fields are stored in spare variable
.
MHDLDOCG  DIM       3                     Pt Documentation Given (Catg to)
MHDLSPSY  DIM       10                    Supervising Psychiatrist
MHDLRESP  DIM       10                    Responsible Practitioner
MHDLLDOC  DIM       10                    Locum Doctor
.
. ----------------------------------------------------------------------------
.                                      * Modified MEHDLSFD so that this program
.                                      * can read mehdlsaf at the same time
MEHDLSA1   IFILE    SQL, FIXED=460, KEY="U1-8,9-16,17-24,25-32"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
MXDLURNO  DIM       8      8        1     U/R Number
MXDLUNIQ  DIM       8      8        9     Unique Number
MXDLSDAT  DIM       8      8        17    Start Date (ccyymmdd)
MXDLSTIM  DIM       8      8        25    Start Time (hh:mm:ss)
MXDLACTV  DIM       1      1        33    Status 0-Active 1-Inactive
MXDLSCOD  DIM       3      3        34    Section Code (category LS)
MXDLSTAT  DIM       3      3        37    Review Status (category LR)
MXDLRDAT  DIM       8      8        40    Review Date (ccyymmdd)
MXDLRTIM  DIM       8      8        48    Review Time (hh:mm:ss)
MXDLHCPC  DIM       10     10       56    HCP Code
MXDLCASE  DIM       10     10       66    Case Team
MXDLPOCC  DIM       3      3        76    Place of Occurrence (category PO)
MXDLREMD  DIM       8      8        79    Reminder Date (ccyymmdd)
MXDLDRIV  DIM       1      1        87    Is the patient allowed to drive?
.                                         0-No, 1-Yes
MXDLRESD  DIM       1      1        88    Residential Admission?
.                                         0-No, 1-Yes
MXDLRCOD  DIM       6      6        89    Place of Resident(meheoraf.mheotype=R)
MXDLCUID  DIM       10     10       95    WEB User ID created (websecaf)
MXDLCDAT  DIM       8      8        105   Date Record created (ccyymmdd)
MXDLCTIM  DIM       8      8        113   Time Record created (hh:mm:ss)
MXDLUUID  DIM       10     10       121   WEB User ID updated (websecaf)
MXDLUDAT  DIM       8      8        131   Date record updated
MXDLUTIM  DIM       8      8        139   Time record update
MXDLCMNT  DIM       100    100      147   Comments
MXDLSENT  DIM       1      1        247   Mental Health data sent
.                                         Y-Yes, N or blank-No
MXDLEDAT  DIM       8      8        248   End Date (ccyymmdd)
MXDLETIM  DIM       8      8        256   End Time (hh:mm:ss)
MXDLSULS  DIM       3      3        264   Supp. Legal Status - Cat."LS"
MXDLSLSD  DIM       8      8        267   Supp. Legal Status Effective Date
MXDLRPDT  DIM       8      8        275   Date Review performed
MXDLCNSD  DIM       8      8        283   Court Notices Sent Date
MXDLTRDT  DIM       8      8        291   Tribunal Date
MXDLLWCD  DIM       8      8        299   Lodged with Court Date
MXDLCTCD  DIM       3      3        307   Court Time Code - Cat."xy"
MXDLCMN2  DIM       100    100      310   Comments 2
MXDLSPRE  DIM       50     50       410   Spare Variable
.
.End of Record                      460
.
. The following fields are stored in spare variable
.
MXDLDOCG  DIM       3                     Pt Documentation Given (Catg to)
MXDLSPSY  DIM       10                    Supervising Psychiatrist
MXDLRESP  DIM       10                    Responsible Practitioner
MXDLLDOC  DIM       10                    Locum Doctor
. ----------------------------------------------------------------------------
.
.
.         patcodes File Definition
.
PATCODE1   IFILE SQL, FIXED=244, KEY="U1-2,3-5"
.
. NAME    TYPE    LENGTH   PHYSICAL  START LOC.   DESCRIPTION
. ----    ----    ------   --------  ----------   -----------
TCODE     DIM       2          2          1       TYPE OF CODE TO TABLE
ACODE     DIM       3          3          3       ACTUAL CODE
.
TDESC     DIM       20        20          6       TABLE DESCRIPTION
THCSCOD   DIM       4          4         26       HCS EQUIVALENT
.                                                 (Journal Type for Journals)
TCFORM6   FORM      6          4         30       FORM 6 USING ANYWHERE
TCINDC1   DIM       1          1         34       SPECIAL INDIC 1 (Categ depend)
TCINDC2   DIM       1          1         35       SPECIAL INDIC 2 (Categ depend)
TCINDC3   DIM       1          1         36       SPECIAL INDIC 3 (Categ depend)
TCINDC4   DIM       1          1         37       SPECIAL INDIC 4 (Categ depend)
TCINDC5   DIM       1          1         38       SPECIAL INDIC 5 (Categ depend)
PTCOACTV  DIM       1          1         39       ACTIVE INDICATOR, A = Active
.                                                                   I = Inactive
TCINDC6   DIM       1          1         40       SPECIAL INDIC 6 (Categ depend)
TCINDC7   DIM       1          1         41       SPECIAL INDIC 7 (Categ depend)
TCINDC8   DIM       1          1         42       SPECIAL INDIC 8 (Categ depend)
TCINDC9   DIM       1          1         43       SPECIAL INDIC 9 (Categ depend)
TCINDC10  DIM       1          1         44       SPECIAL INDIC10 (Categ depend)
TCINDC11  DIM       1          1         45       SPECIAL INDIC11 (Categ depend)
PTCDGRPV  DIM       3          3         46       GROUPER VERSION (031 or 041)
PTCDDEFT  DIM       1          1         49       DEFAULT CODE (0=NO 1=YES)
PTCDNHCP  DIM       4          4         50       National HCP Equivalent
PTCDHOSS  DIM       1          1         54       Hospital Specific Code
.                                                 (0=NO 1=YES) mltcodaf
PTCDLDES  DIM      50         50         55       Long Description
PTCDDFIC  DIM       6          6        105       Default Fee Information Code
.                                                 (Stationery Code - Type 3)
TCINDC12  DIM       1          1        111       SPECIAL INDIC12 (Categ depend)
TCINDC13  DIM       1          1        112       SPECIAL INDIC13 (Categ depend)
TCINDC14  DIM       1          1        113       SPECIAL INDIC14 (Categ depend)
TCINDC15  DIM       1          1        114       SPECIAL INDIC15 (Categ depend)
TCINDC16  DIM       1          1        115       SPECIAL INDIC16 (Categ depend)
TCINDC17  DIM       1          1        116       SPECIAL INDIC17 (Categ depend)
TCINDC18  DIM       1          1        117       SPECIAL INDIC18 (Categ depend)
TCINDC19  DIM       1          1        118       SPECIAL INDIC19 (Categ depend)
TCINDC20  DIM       1          1        119       SPECIAL INDIC20 (Categ depend)
TCINDC21  DIM       1          1        120       SPECIAL INDIC21 (Categ depend)
PTCDFELC  DIM      10         10        121       Financial Election Stationery
.                                                 Template Form
PTCDUDF2  DIM      10         10        131       User Defined Field 2
PTCDUDF3  DIM      10         10        141       User Defined Field 3
PTCDUDF4  DIM      10         10        151       User Defined Field 4
PTCDCRSC  FORM      2.2        3        161       % Credit Card Surcharge
PTCDASC1  DIM       6          6        164       Associated Number 1
PTCDASC2  DIM       6          6        170       Associated Number 2
PTCDASC3  DIM       6          6        176       Associated Number 3
PTCDASC4  DIM       6          6        182       Associated Number 4
PTCDASC5  DIM       6          6        188       Associated Number 5
TCSPARE   DIM      50         50        194       SPARE VARIABLE
.
.End of Record                          244
.
.
OLDLSPRE  DIM       50     50       410   Spare Variable
.
CMDLINE   DIM       100
DIM4      DIM       4
DIM4A     DIM       4
DIM6      DIM       6
DIM6A     DIM       6
DIM60     DIM       60
DDCENT    DIM       2
.
INPFILE   DIM       8
RECNUM    FORM      8
FIXNUM    FORM      8
NEWFILE   DIM       60
NEWPATH   DIM       60
OLDPATH   DIM       60
DEFPATH   DIM       60
PREVURNO  DIM       8
SAVEFLG   FORM      1
SP50      INIT    "                                                  "
SP60      INIT    "                                                            "
YR2004    FORM      4
YR2013    FORM      4
Z40       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
PRGNAM    INIT      "CORRECT MEHAUDDA DATA"
PRGID     INIT      "F00MHDAU"
VERSION   INIT      "V12.00.00"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      *
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
MAIN1000  
.
. Loop thru old file and write records to new file
.
          CALL      READ0000                      * read old records and write
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
.
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      PATCODE1,"patcodes"
.
          MOVE      "2004",YR2004
          MOVE      "2013",YR2013
.          
INIT9999  RETURN
.
.**********************************************************************
.*                               READ0000                             *
.*             loop thru file and move data to correct fields         *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
          MOVE      ZERO,FIXNUM
          MOVE      ZERO,RECNUM
          OPEN      MEHAUDDA,"mehaudda"
.
          MOVE      SP8,PREVURNO
.
          PACK      KEY32,Z40
          CALL      ASMHDL                        * position at start
READ1000  CALL      APMHDL                        * previous next record
          BRANCH    OVRCD,READ6000                * no more records
          ADD       ONE,RECNUM                    * update record counter
.
          IF        (RECNUM%1000) = 0
            DISPLAY   *P1:20,"Records Read     : ",*V2LON,RECNUM
          ENDIF
.
.                                           * check if valid data fields
...       MOVE      "LS",KEY2
...       PACK      KEY5,KEY2,MHDLSCOD
...       CALL      RDCODE1
...       BRANCH    OVRCD,READ1000          * Cat LS format not right, bypass
.
READ1800  MOVE      ZERO,FORM4              * check the Create Date
          UNPACK    MHDLCDAT,KEY4
          MOVE      KEY4,FORM4
          COMPARE   YR2004,FORM4
          GOTO      READ1000 IF LESS
          COMPARE   YR2013,FORM4
          GOTO      READ2000 IF LESS        * format is correct, push on
          GOTO      READ1000
.
.                                           * data needs to be corrected 
READ2000  MOVE      "0",MHDLACTV
          PACK      MHDLEDAT,SP70
          PACK      MHDLETIM,SP70
          MATCH     MHDLURNO,PREVURNO
          IF        !@EQUAL
            PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
            CALL      RDMHDLS1
            IF        OVRCD <> 1
              MOVE      MXDLACTV,MHDLACTV
              MOVE      MXDLEDAT,MHDLEDAT
              MOVE      MXDLETIM,MHDLETIM
            ENDIF
          ENDIF
          MOVE      MHDLURNO,PREVURNO
.
          PACK      MHDLSPRE,SP70
          PACK      MHDLSPRE,MHDLDOCG,MHDLSPSY,MHDLRESP,MHDLLDOC,SP70
.                                               * Pack key here
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM,SP70
          CALL      AUMHDL                      * update record
.
          ADD       ONE,FIXNUM
          IF        (FIXNUM%1000) = 0
            DISPLAY   *P1:19,"Records Modified : ",*V2LON,FIXNUM
          ENDIF
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     MEHAUDDA                      * close new file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:19,"Records Modified : ",*V2LON,FIXNUM:
                    *P1:20,"Records Read     : ",*V2LON,RECNUM:
                    *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
. 
          DISPLAY   *P1:24,*EF;
          CALL      HITENTER
.
READ9999  RETURN
.
+
.**********************************************************************
.         Get the default directory
.**********************************************************************
DEFT0000  EXECUTE   "ldat mehaudda.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding 'mehaudda'.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
DEFT9999  RETURN
+
.
.                  ******************************    OLD IO ROUTINES
.
ASMHDL    RESET     KEY32
          READ      MEHAUDDA,KEY32;;
          RETURN
.
.
AKMHDL    MOVE      ZERO,OVRCD
          READKS    MEHAUDDA;MHDLMDAT,MHDLMTIM,MHDLRTYP,MHDLMUID:
                        MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,MHDLSCOD:
                        MHDLSTAT,MHDLRDAT,MHDLRTIM,MHDLHCPC,MHDLCASE,MHDLPOCC:
                        MHDLREMD,MHDLDRIV,MHDLRESD,MHDLRCOD,MHDLCUID,MHDLCDAT:
                        MHDLCTIM,MHDLUUID,MHDLUDAT,MHDLUTIM,MHDLCMNT,MHDLSENT:
                        MHDLSULS,MHDLSLSD,MHDLRPDT,MHDLCNSD,MHDLTRDT,MHDLLWCD:
                        MHDLCTCD,MHDLCMN2,OLDLSPRE
          GOTO      OVERCOND IF OVER
          UNPACK    OLDLSPRE,MHDLDOCG,MHDLSPSY,MHDLRESP,MHDLLDOC
          RETURN
.
APMHDL    MOVE      ZERO,OVRCD
          READKP    MEHAUDDA;MHDLMDAT,MHDLMTIM,MHDLRTYP,MHDLMUID:
                        MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,MHDLSCOD:
                        MHDLSTAT,MHDLRDAT,MHDLRTIM,MHDLHCPC,MHDLCASE,MHDLPOCC:
                        MHDLREMD,MHDLDRIV,MHDLRESD,MHDLRCOD,MHDLCUID,MHDLCDAT:
                        MHDLCTIM,MHDLUUID,MHDLUDAT,MHDLUTIM,MHDLCMNT,MHDLSENT:
                        MHDLSULS,MHDLSLSD,MHDLRPDT,MHDLCNSD,MHDLTRDT,MHDLLWCD:
                        MHDLCTCD,MHDLCMN2,MHDLSPRE
          GOTO      OVERCOND IF OVER
          UNPACK    MHDLSPRE,MHDLDOCG,MHDLSPSY,MHDLRESP,MHDLLDOC
          RETURN
.
.                  ******************************    NEW IO ROUTINES

AUMHDL    PACK      MHDLSPRE,MHDLDOCG,MHDLSPSY,MHDLRESP,MHDLLDOC,SP70
          UPDATE    MEHAUDDA;MHDLMDAT,MHDLMTIM,MHDLRTYP,MHDLMUID:
                        MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,MHDLACTV,MHDLSCOD:
                        MHDLSTAT,MHDLRDAT,MHDLRTIM,MHDLHCPC,MHDLCASE,MHDLPOCC:
                        MHDLREMD,MHDLDRIV,MHDLRESD,MHDLRCOD,MHDLCUID,MHDLCDAT:
                        MHDLCTIM,MHDLUUID,MHDLUDAT,MHDLUTIM,MHDLCMNT,MHDLSENT:
                        MHDLEDAT,MHDLETIM,MHDLSULS,MHDLSLSD,MHDLRPDT,MHDLCNSD:
                        MHDLTRDT,MHDLLWCD,MHDLCTCD,MHDLCMN2,MHDLSPRE
          RETURN
.
.----------------------------------------------------------------------------
.                                           * special Read to access MEHDLSaf
RDMHDLS1  RESET     KEY32
          MOVE      ZERO,OVRCD
          READ      MEHDLSA1,KEY32;MXDLURNO,MXDLUNIQ,MXDLSDAT,MXDLSTIM,MXDLACTV:
                        MXDLSCOD,MXDLSTAT,MXDLRDAT,MXDLRTIM,MXDLHCPC,MXDLCASE:
                        MXDLPOCC,MXDLREMD,MXDLDRIV,MXDLRESD,MXDLRCOD,MXDLCUID:
                        MXDLCDAT,MXDLCTIM,MXDLUUID,MXDLUDAT,MXDLUTIM,MXDLCMNT:
                        MXDLSENT,MXDLEDAT,MXDLETIM,MXDLSULS,MXDLSLSD,MXDLRPDT:
                        MXDLCNSD,MXDLTRDT,MXDLLWCD,MXDLCTCD,MXDLCMN2,MXDLSPRE
          GOTO      OVERCOND IF OVER
          UNPACK    MXDLSPRE,MXDLDOCG,MXDLSPSY,MXDLRESP,MHDLLDOC
          RETURN
.
.        patcodes I/O routines
.
RDCODE1  MOVE      ZERO,OVRCD
         RESET     KEY5
         READ      PATCODE1,KEY5;TCODE,ACODE,TDESC,THCSCOD,TCFORM6:
                            TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5,PTCOACTV:
                            TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10,TCINDC11:
                            PTCDGRPV,PTCDDEFT,PTCDNHCP,PTCDHOSS,PTCDLDES:
                            PTCDDFIC,TCINDC12,TCINDC13,TCINDC14,TCINDC15:
                            TCINDC16,TCINDC17,TCINDC18,TCINDC19,TCINDC20:
                            TCINDC21,PTCDFELC,PTCDUDF2,PTCDUDF3,PTCDUDF4:
                            PTCDCRSC,PTCDASC1,PTCDASC2,PTCDASC3,PTCDASC4:
                            PTCDASC5,TCSPARE
         GOTO      OVERCOND IF OVER
         RETURN
.
          INC       STD001IO
