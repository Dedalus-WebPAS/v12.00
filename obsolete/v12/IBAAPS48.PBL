.-------------------------------------------------------
          INC       STDGENDF     * Required Include
.
VERSION   INIT      "V12.00.00"
.-------------------------------------------------------
. V9.02.00  03.05.2002  Glenn Saunders
.           Export to new release i.e. v9.02 from vf.09
.-------------------------------------------------------
. VF.00.02  05.01.2000 Charles Handaya
.           Recompiled for APSMASIO change
.           22.11.1999 Sandra Barcham
.           Make program case tools and screen painted
.           Allow for cancelling direct debits for a creditor
.           srf 635048
.           For Direct Debits don't print creditor and creditor name
.           srf 635825
. VF.00.01  12.08.1999 Sandra Barcham
.           Fix printing of cash transfers
.           srf 632402
.-------------------------------------------------------
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.
FMSTMP01  IFILE     SQL, FIXED=150, KEY="U58-58,21-35,36-37,38-49"
FILEDAT1  INIT      " 150 UC58-58,21-35,36-37,38-49"
NAME1     INIT      "aps481"
FILENAM1  DIM       8
KILLTMP1  DIM       80
MAKETMP1  DIM       80
FORMAT    INIT      "(999,999,999,999.99 "
FORMAT2   INIT      "(99,999,999,999,999.99 "
PAMT      DIM       20
PAMT2     DIM       23
FCHQ      DIM       23
LASTCHEQ  DIM       15
LASTCHST  DIM       1
CHQTOTAL  FORM      14.2
.
FMSTMP02  IFILE     SQL, FIXED=87, KEY="U1-2,3-14"
FILEDAT2  INIT      " 87 UC1-2,3-14"
NAME2     INIT      "aps482"
FILENAM2  DIM       8
KILLTMP2  DIM       80
MAKETMP2  DIM       80
.
FMSTMP03  IFILE     SQL, FIXED=80, KEY="U1-15,16-20"
FILEDAT3  INIT      " 80 UC1-15,16-20"
NAME3     INIT      "aps483"
FILENAM3  DIM       8
KILLTMP3  DIM       80
MAKETMP3  DIM       80
.
TP3REF    DIM       15
TP3CRE    DIM       5
TP3DAT    DIM       8
TP3PDT    DIM       8
TP3NAM    DIM       35
TP3AMT    FORM      12.2
.
SAVTEMP   FORM     12.2
.
TCHQTOT   FORM     14.2
TRECTOT   FORM     14.2
TCANTOT   FORM     14.2
TCANTOTC  FORM     14.2
TTRNTOT   FORM     14.2
TJNLTOT   FORM     14.2
.
CHQTOT    FORM     14.2
RECTOT    FORM     14.2
CANTOT    FORM     14.2
CANTOTCR  FORM     14.2
TRNTOTD   FORM     14.2
TRNTOTC   FORM     14.2
JNLTOTD   FORM     14.2
JNLTOTC   FORM     14.2
.
RECFLAG   FORM      1
FORM9P2   FORM      9.2
.
PRES      DIM       14              * presented vars
PRESDESC  DIM       3
PRES0     INIT      "No "
PRES1     INIT      "Yes"
PRES2     INIT      "Can"
FORM15    FORM      15       * general form 15
FROMDAT1  DIM       15       * from data 1
FROMDAT2  DIM       8        * from data 2
FROMDAT3  DIM       8        * from data 3
FROMDES1  DIM       35       * from description 1
FROMDES2  DIM       10       * from description 2
FROMDES3  DIM       10       * from description 3
TOTAL1    FORM      17.2     * grand total
AMOUNT    FORM      12.2
.
SAVEAMT    FORM     10.2
SFMBNBNK   DIM       15     15       1     Cheque Account
SFMBNUNQ   DIM       5      5        16    Unique Id
SFMBNREF   DIM       15     15       21    Reference (Cheque No etc )
SFMBNLED   DIM       2      2        36    Ledger
SFMBNACC   DIM       12     12       38    Bank Account
SFMBNDAT   DIM       8      8        50    Transaction Date CCYYMMDD
.
SFMBNTYP   DIM       1      1        58    Type 0 - Cheque 1 - Receipt 2 - Adj.
SFMBNPRE   DIM       1      1        59    Presented 0 = No 1 = Yes 2 = Cancel
SFMBNPDT   DIM       8      8        60    Statement/Cancelled Date CCYYMMDD
.
SFMBNAMT   FORM      12.2   8        68    Amount
.
SFMBNFYR   DIM       4      4        76    Financial Year (Cash Trans File)
SFMBNBCH   DIM       5      5        80    Batch Number
SFMBNLNO   DIM       5      5        85    Batch Line Number
.
SFMBNCRE   DIM       5      5        90    Creditor/Debtor Code
SFMBNNAM   DIM       35     35       95    Creditor/Debtor Name
.
AGSTNAME   DIM       35
BANKNAME   DIM       35
BNKTOT     FORM      14.2
CGSTNAME   DIM       35
CREDNAME   DIM       35
DEBTNAME   DIM       35
DISCNAME   DIM       35
FILENAME   DIM       8
FMST       INIT      "fmst"
INTERFND   FORM      1
ISSDATE    DIM       10
LASTTYPE   DIM       1
PAYMNAME   DIM       35
OPTIONA    FORM      2
SP12       INIT      "            "
DATRANGE   DIM       30
ENDDAT     DIM       8
LASTDAT    DIM       8
STRDAT     DIM       8
.-------------------------------------------------------
.@@@@@ Start of Generated Code @@@@@
. NB - Code & Comments Included Before the above line 
.      will not be overwritten by the generation of a 
.      program. The STDGENDF file and VERSION must appear
.      before the line. 
.-----------------------------------------
.   Program       :   IBAAPS48
.   Function      :   Cash Book Summary                       
.   Generated  On :   13/12/2005
.-----------------------------------------
.=========================
.File Description Includes
.-------------------------
          INC       APSMASFD/INC
          INC       FMSAMAFD/INC
          INC       FMSBNKFD/INC
          INC       FMSCAFFD/INC
          INC       FMSCHQFD/INC
          INC       FMSCONFD/INC
          INC       FMSCSAFD/INC
          INC       FMSGENDF    
          INC       FMSLMAFD/INC
          INC       FMSLMCFD/INC
          INC       FMSTRNFD/INC
.=========================
.Local Variable Definition
.-------------------------
FROMDAT   DIM      10 * Scr 00 Fld     4
TODAT     DIM      10 * Scr 00 Fld     5
.
ACCEPT    FORM      1
SACCEPT   FORM      1
.
PRGID     INIT      "IBAAPS48"
PRGNAM    INIT      "Cash Book Summary                       "
.
.--------------------------------
. MAINLINE - Controlling Logic
.--------------------------------
          TOPIC     PRGID
          MOVE      PORT,PARENTID
          CLOCK     PORT,DIM2
          MOVE      DIM2,PORT
ML0000
          CALL      INIT0000
          CALL      REDPAR00
          CALL      SC00L000
          CHAIN     PGM
.---------------------------------------
. INIT - Open Files & Display Heading
.---------------------------------------
INIT0000  CALL      DISPHEAD
          MOVE      ONE,CCENTRY
          MOVE      ONE,CCANLDTE
          MOVE      ONE,CDEFDTE
          MOVE      ZERO,CHIGHLT
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
          DISPLAY   *P56:24,"Opening scrsbga1";
          OPEN      SCRSBGA1,"scrsbgaf"
          DISPLAY   *P56:24,"Opening scrpsta1";
          OPEN      SCRPSTA1,"scrpstaf"
          DISPLAY   *P56:24,"Opening scrpsta1";
          OPEN      SCRPSTA2,"scrpstaf"
          DISPLAY   *P56:24,"Opening scrslta1";
          OPEN      SCRSLTA1,"scrsltaf"
          DISPLAY   *P56:24,"Opening apsmasaf";
          OPEN      APSMASA1,"apsmasaf"
          DISPLAY   *P56:24,"Opening apsmasaf";
          OPEN      APSMASA2,"apsmasaf"
          DISPLAY   *P56:24,"Opening apsmasaf";
          OPEN      APSMASA3,"apsmasaf"
          DISPLAY   *P56:24,"Opening fmsamaaf";
          OPEN      FMSAMAA1,"fmsamaaf"
          DISPLAY   *P56:24,"Opening fmsamaaf";
          OPEN      FMSAMAA2,"fmsamaaf"
          DISPLAY   *P56:24,"Opening fmsamaaf";
          OPEN      FMSAMAA3,"fmsamaaf"
          DISPLAY   *P56:24,"Opening fmsamaaf";
          OPEN      FMSAMAA4,"fmsamaaf"
          MOVE      "   51",AUDTSECT
          MOVE      " 46",AUDTPOST
          READ      CONTROLF,AUDTSECT;*AUDTPOST,AUDTFLAG
          IF        AUDTFLAG=1
            DISPLAY   *P56:24,"Opening fmsaudla";
            OPEN      FMSAUDLA,"fmsaudla"
          ENDIF
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA1,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA2,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA3,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA4,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA5,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmsbnkaf";
          OPEN      FMSBNKA6,"fmsbnkaf"
          DISPLAY   *P56:24,"Opening fmscafaf";
          OPEN      FMSCAFA1,"fmscafaf"
          DISPLAY   *P56:24,"Opening fmscafaf";
          OPEN      FMSCAFA2,"fmscafaf"
          DISPLAY   *P56:24,"Opening fmschqaf";
          OPEN      FMSCHQA1,"fmschqaf"
          DISPLAY   *P56:24,"Opening fmscsaaf";
          OPEN      FMSCSAA1,"fmscsaaf"
          DISPLAY   *P56:24,"Opening fmslmaaf";
          OPEN      FMSLMAA1,"fmslmaaf"
          DISPLAY   *P56:24,"Opening fmslmcaf";
          OPEN      FMSLMCA1,"fmslmcaf"
INIT9999  DISPLAY   *P1:24,*EL;
          RETURN
.
.------------------------------------
. Called for Print Screen Routine 
.------------------------------------
PRTSVARS
          MATCH     "00",SCRID
          IF         @EQUAL
            CALL       PS00L000   * Menu Options                       
          ENDIF
          RETURN
.--------------------------------
. Screen - Menu Options                       
.--------------------------------
SC00L000
SC00L100
          MOVE      "00",SCRID
          MOVE      ZERO,PRCOL
          MOVE      ZERO,PRVERT
          MOVE      "    1",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE     SCPSCOL,PRCOL
            MOVE     SCPSROW,PRVERT
          ENDIF
          CALL      SBACK000 * Display Background
.
SC00L200
          CALL      CF00L000 * Clear Fields
          CALL      DEFPAR00
SC00L300
          CALL      KY00L000 * Enter Key Fields
          BRANCH    EXIT,SC00L999,SC00L999
SC00L400
          CALL      WP00L000 * Load any WP Details
SC00L500
          CALL      LM00L000 * Load any Batch Details
SC00L600
          CALL      DF00L000 * Display Fields
SC00L700
          CALL      SF00L000 * Select Fields
          BRANCH    EXIT,SC00L100,SC00L100,SC00L200
          IF        EXIT=4
            MOVE      ONE,EXIT
          ENDIF
SC00L800
SC00L900
SC00L999  RETURN
.--------------------------------------------------------
. Clear Fields for Screen : Menu Options                       
.-------------------------------------------------------
CF00L000
          MOVE      SP70,FROMDAT 
          MOVE      SP70,TODAT   
          MOVE      SP70,FMCHCHQ 
          MOVE      SP70,FMCHDES 
CF00L999  RETURN
.--------------------------------------------------------
. Enter Key Fields for Menu Options                       
.--------------------------------------------------------
KY00L000
          MOVE      ZERO,EXIT
          GOTO      KY00L999
.
KY00L900  MOVE      ONE,EXIT
KY00L999  RETURN
.---------------------------------------------------------
. Load WP files for : Menu Options                       
.---------------------------------------------------------
WP00L000
          RETURN
.---------------------------------------------------------
. Load Batch Screen for : Menu Options                       
.---------------------------------------------------------
LM00L000
          RETURN
.---------------------------------------------------------
. Display Fields for : Menu Options                       
.---------------------------------------------------------
DF00L000
          BRANCH   ACCEPT,DF00L999
          PACK     KEY15,PRGID,SCRID,SP70
          CALL     RSSCPS1
DF00L010
          CALL     RKSCPS1
          BRANCH   OVRCD,DF00L900
          MATCH    PRGID,SCPSPID
          GOTO     DF00L900 IF NOT EQUAL
          MATCH    SCRID,SCPSSID
          GOTO     DF00L900 IF NOT EQUAL
          MATCH    SP70,SCPSMTY
          GOTO     DF00L010 IF NOT EQUAL
.
          CALL     PS00L000 * Display Field
          GOTO     DF00L010
DF00L900
DF00L999
          RETURN
.---------------------------------------------------------
. Display/Print Fields for : Menu Options                       
.---------------------------------------------------------
PS00L000   PACK      VAR,SP70,SP70
          PACK     PRINTVAR,SP70,SP70
          MOVE     SCPSITM,FIELDNO
          BRANCH    FIELDNO,PS00L999,PS00L999,PS00L999,PS00L101:
                            PS00L102,PS00L103,PS00L104
          GOTO     PS00L999
.
PS00L101
          MOVE      FROMDAT,VAR      
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L102
          MOVE      TODAT,VAR        
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L103
          MOVE      FMCHCHQ,VAR      
          CALL      DISPITEM
          GOTO     PS00L999
.
PS00L104
          MOVE      FMCHDES,VAR      
          CALL      DISPITEM
          GOTO     PS00L999
PS00L999
          RETURN
.---------------------------------------------------------
. Selections for : Menu Options                       
.---------------------------------------------------------
SF00L000  PACK     KEY13,PRGID,SCRID,SP70
          CALL     RSSCSL1
SF00L001  BRANCH   ACCEPT,SF00L020
.
SF00L005  CALL     MTSTQ000
          MOVE     SCSLITM,FIELDNO
          BRANCH    FIELDNO,SF00L006,SF00L101,SF00L102,SF00L103:
                            SF00L006,SF00L104,SF00L006
SF00L006  BEEP
          GOTO     SF00L005
SF00L020  CALL     RKSCSL1
          BRANCH   OVRCD,SF00L090
          MATCH    PRGID,SCSLPID
          GOTO     SF00L090 IF NOT EQUAL
          MATCH    SCRID,SCSLSID
          GOTO     SF00L090 IF NOT EQUAL
          MOVE     SCSLITM,FIELDNO
          BRANCH    FIELDNO,SF00L020,SF00L020,SF00L020,SF00L103:
                            SF00L020,SF00L104,SF00L020
          GOTO     SF00L020
SF00L090  MOVE     ZERO,ACCEPT
          GOTO     SF00L001
.
SF00L101
          MOVE      ZERO,EXIT
          GOTO      SF00L999
.
SF00L102
          CALL      REPT0000
          MOVE      ZERO,EXIT
          GOTO      SF00L999
.
SF00L103
.
.
          MOVE      "    5",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE     SP70,TODAT   
            PACK      VAR,SP70,SP70
            CALL      DISPITEM
          ENDIF
          CALL     SELECTED
          MOVE      "0",CKEYTYP
          CALL      RDAT0000
          IF        SCPSMAN=1
            IF        EXIT=1
              MOVE      "Mandatory Field - ",DISPMSG
              BEEP
              CALL      MESSAGE1
              GOTO      SF00L103
            ENDIF
            BRANCH    EXIT,SF00L103,SF00L990
          ELSE
            COMPARE   TWO,EXIT
            GOTO      SF00L990 IF EQUAL
          ENDIF
          MOVE      FROMDAT,VAR      
          CALL      DISPITEM
.
.
          MOVE      "    5",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE      TODAT,VAR        
            CALL      DISPITEM
          ENDIF
          GOTO     SF00L001
.
SF00L104
.
.
          MOVE      "    7",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE     SP70,FMCHDES 
            PACK      VAR,SP70,SP70
            CALL      DISPITEM
          ENDIF
          CALL     SELECTED
          MOVE      "0",CKEYTYP
          CALL      KCHQ0000
          IF        SCPSMAN=1
            IF        EXIT=1
              MOVE      "Mandatory Field - ",DISPMSG
              BEEP
              CALL      MESSAGE1
              GOTO      SF00L104
            ENDIF
            BRANCH    EXIT,SF00L104,SF00L990
          ELSE
            COMPARE   TWO,EXIT
            GOTO      SF00L990 IF EQUAL
          ENDIF
          MOVE      FMCHCHQ,VAR      
          CALL      DISPITEM
.
.
          MOVE      "    7",FLDID
          CALL      GETPOSIT
          IF        EXIT=0
            MOVE      FMCHDES,VAR      
            CALL      DISPITEM
          ENDIF
          GOTO     SF00L001
SF00L990  MOVE      FOUR,EXIT * Exit Char Exit
SF00L999  RETURN
.@@@@@ Function Restart Point @@@@@
.---------------------------------------
. Read Parameters in controlf
.---------------------------------------
REDPAR00  OPEN      CONTROLF,"controlf"
          CALL      RDFMCO50
          CALL      RDFMCO51
          CALL      RDFMCO52
          RETURN
.
.---------------------------------------
. Setup Defaults for Invoice Generation
.---------------------------------------
DEFPAR00  MOVE      ONE,ACCEPT
          PACK      STRDAT,CCC,CYY,CMM,CDD
          REP       " 0",STRDAT
          UNPACK    STRDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,FROMDAT
          MOVE      CPCDATE,TODAT
          PACK      ENDDAT,CCC,CYY,CMM,CDD
          REP       " 0",ENDDAT
          RETURN
.
.---------------------------------------
. Print Report
.---------------------------------------
REPT0000  STRIP     FROMDAT
          STRIP     TODAT
          MOVE      SP70,LASTDAT
          MOVE      " to ",KEY4
          PACK      DATRANGE,FROMDAT,KEY4,TODAT
.
          CALL      EXTR0000
          CALL      PRNT0000
.
REPT9000  CLOSE     FMSTMP01
          EXECUTE   KILLTMP1,TASKID         * create file
          CLOSE     FMSTMP02
          EXECUTE   KILLTMP2,TASKID         * create file
          CLOSE     FMSTMP03
          EXECUTE   KILLTMP3,TASKID         * create file
REPT9999  RETURN
.
.---------------------------------------
.EXTR0000 - Extract Report
.---------------------------------------
EXTR0000  DISPLAY   *P1:24,"Clearing Temp File : ",*EL;
          PACK      FILENAM1,NAME1,PORT
          REP       " 0",FILENAM1
          PACK      KILLTMP1,ISERASE,FILENAM1
          PACK      MAKETMP1,ISBUILD,FILENAM1,FILEDAT1
          CLOSE     FMSTMP01
          EXECUTE   KILLTMP1,TASKID         * create file
          EXECUTE   MAKETMP1,TASKID
          OPEN      FMSTMP01,FILENAM1
.
          CLOSE     FMSTMP02
          PACK      FILENAM2,NAME2,PORT
          REP       " 0",FILENAM2
          PACK      KILLTMP2,ISERASE,FILENAM2
          PACK      MAKETMP2,ISBUILD,FILENAM2,FILEDAT2
          EXECUTE   KILLTMP2,TASKID         * create file
          EXECUTE   MAKETMP2,TASKID
          OPEN      FMSTMP02,FILENAM2
.
          CLOSE     FMSTMP03
          PACK      FILENAM3,NAME3,PORT
          REP       " 0",FILENAM3
          PACK      KILLTMP3,ISERASE,FILENAM3
          PACK      MAKETMP3,ISBUILD,FILENAM3,FILEDAT3
          EXECUTE   KILLTMP3,TASKID         * create file
          EXECUTE   MAKETMP3,TASKID
          OPEN      FMSTMP03,FILENAM3
.
          MOVE      ZERO,INTERFND
          PACK      KEY2,SP70
          CALL      RSFMLA1
.
EXTR0100  CALL      RKFMLA1
          BRANCH    OVRCD,EXTR0200
.
          MATCH     SP12,FMLAIFT
          GOTO      EXTR0100 IF EQUAL
.
          PACK      KEY14,FMLALEDG,FMLAIFT,SP70
          CALL      RDFMCA1
          BRANCH    OVRCD,EXTR0100
          COMPARE   ONE,FMCATYP
          GOTO      EXTR0100 IF NOT EQUAL
          MATCH     FMCACHQ,FMCHCHQ
          GOTO      EXTR0100 IF NOT EQUAL
          MOVE      ONE,INTERFND
.
EXTR0200  COMPARE   ZERO,INTERFND
          GOTO      EXTR1000 IF EQUAL
.
          MOVE      STRDAT,WORKDATE
          REP       " 0",WORKDATE
          CALL      CFYR0000
.
          PACK      FILENAME,FMST,CURYEAR
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FMSTRNA2,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,EXTR0300
          GOTO      EXTR1000
.
EXTR0300  MOVE      ZERO,INTERFND
.
EXTR1000  DISPLAY   *P1:24,"Extracting Data    :",*EL;
          PACK      KEY44,FMCHCHQ,ZERO,STRDAT,SP70
          CALL      RSFMBN3            * get desired records
.
EXTR1100  CALL      RKFMBN3            * get next record
          BRANCH    OVRCD,EXTR2000     * no more files ?
          MATCH     FMCHCHQ,FMBNBNK   * at end of account
          GOTO      EXTR2000 IF NOT EQUAL
          MATCH     "0",FMBNTYP        * at end cheq records
          GOTO      EXTR2000 IF NOT EQUAL
.
          MATCH     FMBNDAT,ENDDAT   * at end of date range
          GOTO      EXTR2000 IF LESS
.
          DISPLAY   *P22:24,*V2LON,FMBNREF,*EL;
.
          MOVE      ZERO,F1
          MOVE      FMBNPRE,F1
          MATCH     FMBNPDT,ENDDAT * treat as unpres if cancelled after period
          IF        @LESS & F1=2 & FMBNAMT<>0
            MOVE      "0",FMBNPRE
          ENDIF
.
          MATCH     "2",FMBNPRE
          GOTO      EXTR1100 IF EQUAL
.
          PACK      KEY30,FMBNTYP,FMBNREF,FMBNLED,FMBNACC,SP70
          CALL      RDTEMP1
          BRANCH    OVRCD,EXTR1200
          ADD       AMOUNT,FMBNAMT
          CALL      UPTEMP1
          SUB       AMOUNT,FMBNAMT
          GOTO      EXTR1300
.
EXTR1200  CALL      WRTEMP1            * delete record
.
EXTR1300  PACK      KEY14,FMBNLED,FMBNACC
          MOVE      ZERO,RECTOT
          MOVE      ZERO,CHQTOT
          MOVE      ZERO,CANTOT
          MOVE      ZERO,CANTOTCR
          MOVE      ZERO,TRNTOTD
          MOVE      ZERO,TRNTOTC
          MOVE      ZERO,JNLTOTD
          MOVE      ZERO,JNLTOTC
.
          CALL      RDFMTM2
          ADD       FMBNAMT,CHQTOT
          CALL      DEFMTM2
          CALL      WRFMTM2
          GOTO      EXTR1100
.
EXTR2000  PACK      KEY24,FMCHCHQ,TWO,STRDAT
          CALL      RDFMBN6
          COMPARE   ZERO,OVRCD
          GOTO      EXTR2020 IF EQUAL
.
EXTR2010  CALL      RKFMBN6
          BRANCH    OVRCD,EXTR3000
.
EXTR2020  MATCH     FMBNBNK,FMCHCHQ
          GOTO      EXTR3000 IF NOT EQUAL
          MATCH     "2",FMBNPRE
          GOTO      EXTR3000 IF NOT EQUAL
          MATCH     FMBNPDT,ENDDAT
          GOTO      EXTR3000 IF LESS
.
. Write cancelled Payments to temporary file 3
.
          PACK      KEY20,FMBNREF,FMBNCRE,SP70
          CALL      RDTEMP3
          IF        OVRCD=1
            MOVE      FMBNREF,TP3REF
            MOVE      FMBNCRE,TP3CRE
            MOVE      FMBNDAT,TP3DAT
            MOVE      FMBNPDT,TP3PDT
            MOVE      FMBNNAM,TP3NAM
            MOVE      FMBNAMT,TP3AMT
            CALL      WRTEMP3
          ELSE
            ADD       FMBNAMT,TP3AMT
            CALL      UPTEMP3
          ENDIF
.
          MATCH     STRDAT,FMBNDAT
          IF        @LESS
            COMPARE   ZERO,FMBNAMT
            GOTO      EXTR2010 IF EQUAL
            MOVE      FMBNAMT,SAVEAMT
            MOVE      ZERO,FMBNAMT
          ENDIF
.
          PACK      KEY30,FMBNTYP,FMBNREF,FMBNLED,FMBNACC,SP70
          CALL      RDTEMP1
          BRANCH    OVRCD,EXTR2100
          ADD       AMOUNT,FMBNAMT
          CALL      UPTEMP1
.
EXTR2040  SUB       AMOUNT,FMBNAMT
          GOTO      EXTR2200
.
EXTR2100  CALL      WRTEMP1            * delete record
.
EXTR2200  PACK      KEY14,FMBNLED,FMBNACC
          MOVE      ZERO,RECTOT
          MOVE      ZERO,CHQTOT
          MOVE      ZERO,CANTOT
          MOVE      ZERO,CANTOTCR
          MOVE      ZERO,TRNTOTD
          MOVE      ZERO,TRNTOTC
          MOVE      ZERO,JNLTOTD
          MOVE      ZERO,JNLTOTC
.
          CALL      RDFMTM2
.
          IF        FMBNAMT=0
            ADD       SAVEAMT,CANTOT
            MOVE      ZERO,SAVEAMT
          ELSE
            ADD       FMBNAMT,CANTOT
            ADD       FMBNAMT,CANTOTCR
            ADD       FMBNAMT,CHQTOT
          ENDIF
.
          CALL      DEFMTM2
          CALL      WRFMTM2
          GOTO      EXTR2010
.
EXTR3000  PACK      KEY44,FMCHCHQ,ONE,STRDAT,SP70
          CALL      RSFMBN3            * get desired records
.
EXTR3100  CALL      RKFMBN3            * get next record
          BRANCH    OVRCD,EXTR4000     * no more files ?
          MATCH     FMCHCHQ,FMBNBNK   * at end of account
          GOTO      EXTR4000 IF NOT EQUAL
          MATCH     "1",FMBNTYP        * at end receipts records
          GOTO      EXTR4000 IF NOT EQUAL
          MATCH     FMBNDAT,ENDDAT   * at end of date range
          GOTO      EXTR4000 IF LESS
.
          MATCH     "CASH",FMBNREF
          IF        @EQUAL
            CLEAR     FMBNREF
            APPEND    "Cash Bch",FMBNREF
            APPEND    FMBNBCH,FMBNREF
            APPEND    SP70,FMBNREF
            RESET     FMBNREF
          ENDIF
.
          DISPLAY   *P22:24,*V2LON,FMBNREF,*EL;
.
          PACK      KEY30,FMBNTYP,FMBNREF,FMBNLED,FMBNACC,SP70
          CALL      RDTEMP1
          BRANCH    OVRCD,EXTR3200
          ADD       AMOUNT,FMBNAMT
          CALL      UPTEMP1
          SUB       AMOUNT,FMBNAMT
          GOTO      EXTR3300
.
EXTR3200  CALL      WRTEMP1            * delete record
.
EXTR3300  PACK      KEY14,FMBNLED,FMBNACC
          MOVE      ZERO,RECTOT
          MOVE      ZERO,CHQTOT
          MOVE      ZERO,CANTOT
          MOVE      ZERO,CANTOTCR
          MOVE      ZERO,TRNTOTD
          MOVE      ZERO,TRNTOTC
          MOVE      ZERO,JNLTOTD
          MOVE      ZERO,JNLTOTC
.
          CALL      RDFMTM2
          ADD       FMBNAMT,RECTOT
          CALL      DEFMTM2
          CALL      WRFMTM2
          GOTO      EXTR3100
.
EXTR4000  PACK      KEY44,FMCHCHQ,TWO,STRDAT,SP70
          CALL      RSFMBN3            * get desired records
.
EXTR4100  CALL      RKFMBN3            * get next record
          BRANCH    OVRCD,EXTR5000     * no more files ?
          MATCH     FMCHCHQ,FMBNBNK   * at end of account
          GOTO      EXTR5000 IF NOT EQUAL
          MATCH     "2",FMBNTYP        * at end adj records
          GOTO      EXTR5000 IF NOT EQUAL
          MATCH     FMBNDAT,ENDDAT   * at end of date range
          GOTO      EXTR5000 IF LESS
.
          DISPLAY   *P22:24,*V2LON,FMBNREF,*EL;
.
          PACK      KEY30,FMBNTYP,FMBNREF,FMBNLED,FMBNACC,SP70
          CALL      RDTEMP1
          BRANCH    OVRCD,EXTR4200
          ADD       AMOUNT,FMBNAMT
          CALL      UPTEMP1
          SUB       AMOUNT,FMBNAMT
          GOTO      EXTR4300
.
EXTR4200  CALL      WRTEMP1            * delete record
.
EXTR4300  PACK      KEY14,FMBNLED,FMBNACC
          MOVE      ZERO,RECTOT
          MOVE      ZERO,CHQTOT
          MOVE      ZERO,CANTOT
          MOVE      ZERO,CANTOTCR
          MOVE      ZERO,TRNTOTD
          MOVE      ZERO,TRNTOTC
          MOVE      ZERO,JNLTOTD
          MOVE      ZERO,JNLTOTC
          CALL      RDFMTM2
.
          CALL      CJNLS000           * check type of journal (1=inter,2=other)
          COMPARE   ZERO,FMBNAMT
          GOTO      EXTR4400 IF LESS
.
          LOAD      F12P2,EXIT,TRNTOTD,JNLTOTD
          ADD       FMBNAMT,F12P2
          STORE     F12P2,EXIT,TRNTOTD,JNLTOTD
          GOTO      EXTR4500
.
EXTR4400  LOAD      F12P2,EXIT,TRNTOTC,JNLTOTC
          SUB       FMBNAMT,F12P2
          STORE     F12P2,EXIT,TRNTOTC,JNLTOTC
.
EXTR4500  CALL      DEFMTM2
          CALL      WRFMTM2
          GOTO      EXTR4100
.
EXTR5000  COMPARE   ZERO,INTERFND
          GOTO      EXTR9999 IF EQUAL
.
          PACK      KEY2,SP10
          CALL      RSFMLA1
.
EXTR5100  CALL      RKFMLA1
          BRANCH    OVRCD,EXTR9999
.
          MATCH     SP12,FMLAIFT
          GOTO      EXTR5100 IF EQUAL
.
          PACK      KEY14,FMLALEDG,FMLAIFT,SP70
          CALL      RDFMCA1
          BRANCH    OVRCD,EXTR5100
          COMPARE   ONE,FMCATYP
          GOTO      EXTR5100 IF NOT EQUAL
          MATCH     FMCACHQ,FMCHCHQ
          GOTO      EXTR5100 IF NOT EQUAL
.
          PACK      KEY32,FMLALEDG,FMLAIFT,STRDAT,SP70
          CALL      RSFMTR2
.
EXTR5200  CALL      RKFMTR2
          BRANCH    OVRCD,EXTR5100
.
          MATCH     FMLALEDG,FMTRLEDG
          GOTO      EXTR5100 IF NOT EQUAL
          MATCH     FMLAIFT,FMTRACCT
          GOTO      EXTR5100 IF NOT EQUAL
          MATCH     ENDDAT,FMTRPDAT
          GOTO      EXTR5210 IF EQUAL
          GOTO      EXTR5100 IF NOT LESS
.
EXTR5210  MATCH     "Stock Usage",FMTRDOCR
          GOTO      EXTR5200 IF NOT EQUAL
.
          DISPLAY   *P22:24,*V2LON,FMTRDOCR,*EL;
.
          MOVE      "3",FMBNTYP
          MOVE      FMTRDOCR,FMBNREF
          MOVE      FMTRLEDG,FMBNLED
          MOVE      FMTRACCT,FMBNACC
.
          PACK      KEY30,FMBNTYP,FMBNREF,FMBNLED,FMBNACC,SP70
          CALL      RDTEMP1
          BRANCH    OVRCD,EXTR5300
          MATCH     "JC",FMTRTYPE
          IF        @EQUAL
            ASSIGN    AMOUNT+FMTRAMT,FMBNAMT
          ELSE
            ASSIGN    AMOUNT-FMTRAMT,FMBNAMT
          ENDIF
.
          CALL      UPTEMP1
          GOTO      EXTR5400
.
EXTR5300  PACK      FMBNBNK,SP70
          PACK      FMBNUNQ,SP70
          MOVE      FMTRPDAT,FMBNDAT
          MOVE      ZERO,FMBNPRE
          PACK      FMBNPDT,SP70
          MOVE      ZERO,FMBNAMT
          MATCH     "JC",FMTRTYPE
          IF        @EQUAL
            ASSIGN    FMTRAMT*SEQ,FMBNAMT
          ELSE
            MOVE      FMTRAMT,FMBNAMT
          ENDIF
          MOVE      CURYEAR,FMBNFYR
          MOVE      FMTRBAT,FMBNBCH
          MOVE      FMTRUNIQ,FMBNLNO
          PACK      FMBNCRE,SP70
          PACK      FMBNNAM,SP70
          PACK      FMBNSPAR,SP70
          CALL      WRTEMP1
.
EXTR5400  PACK      KEY14,FMBNLED,FMBNACC
          MOVE      ZERO,RECTOT
          MOVE      ZERO,CHQTOT
          MOVE      ZERO,CANTOT
          MOVE      ZERO,CANTOTCR
          MOVE      ZERO,TRNTOTD
          MOVE      ZERO,TRNTOTC
          MOVE      ZERO,JNLTOTD
          MOVE      ZERO,JNLTOTC
          CALL      RDFMTM2
.
          MATCH     "JC",FMTRTYPE
          GOTO      EXTR5500 IF EQUAL
.
          ADD       FMTRAMT,JNLTOTD
          GOTO      EXTR5600
.
EXTR5500  ADD       FMTRAMT,JNLTOTC
.
EXTR5600  CALL      DEFMTM2
          CALL      WRFMTM2
          GOTO      EXTR5200
.
EXTR9999  RETURN
.
.---------------------------------------
. CJNLS000 - Check Journal Type
.---------------------------------------
CJNLS000  RESET     FMBNREF
.
CJNLS100  CMATCH    "-",FMBNREF
          GOTO      CJNLS200 IF EQUAL
          BUMP      FMBNREF
          GOTO      CJNLS300 IF EOS
          GOTO      CJNLS100
.
CJNLS200  BUMP      FMBNREF
          CMATCH    FMJOPRE4,FMBNREF
          GOTO      CJNLS300 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CJNLS999
.
CJNLS300  MOVE      TWO,EXIT
.
CJNLS999  RETURN
.---------------------------------------
. PRNT0000 - Print Report
.---------------------------------------
PRNT0000  DISPLAY   *P1:24,"Printing Report    : ",*EL;
          MOVE      ZERO,CPAGENO                 * reset page no.
          MOVE      ZERO,CNOUNDLN
          MOVE      SP70,LASTCHEQ                * reset cheque no.
          MOVE      SP70,LASTCHST                * reset cheque no. stat
          MOVE      ZERO,TOTAL1                  * reset total
          CLOCK     TIME,CTIMEIS                 * get current time
.
          CALL      FILE0000                    * go to correct position in file
          MOVE      ZERO,RECFLAG
          MOVE      ZERO,LASTTYPE
          CALL      HEAD0000                     * print header
.
PRNT1000  CALL      RKTEMP1                      * get next code record
          BRANCH    OVRCD,PRNT9000               * end of file ?
.
          MATCH     "3",FMBNTYP
          IF        @EQUAL
            MOVE      TWO,FMBNTYP
          ENDIF
          MATCH     LASTTYPE,FMBNTYP
          GOTO      PRNT1200 IF EQUAL
.
PRNT1100  CALL      BTOT0000
.
          MOVE      FMBNTYP,LASTTYPE
          ADD       ONE,RECFLAG
          CALL      HEAD0000
          MOVE      ZERO,CHQTOTAL
          MOVE      SP70,LASTCHEQ                * reset cheque no.
          MOVE      SP70,LASTCHST                * reset cheque no. stat
          MOVE      RECFLAG,ANS
          MATCH     ANS,LASTTYPE
          GOTO      PRNT1100 IF NOT EQUAL
.
PRNT1200  DISPLAY   *P22:24,*V2LON,FMBNREF,*EL;
          BRANCH    RECFLAG,PRNT1400,PRNT1600,PRNT1600
.
          CALL      WPAY0000                     * print payment details
          GOTO      PRNT1000                     * get next record
.
PRNT1400  CALL      WREC0000                     * print receipt details
          GOTO      PRNT1000                     * get next record
.
PRNT1600  CALL      WADJ0000                     * print adj details
          GOTO      PRNT1000                     * get next record
.
PRNT9000  CALL      BTOT0000
          CALL      PTOA0000                     * print totals
          CALL      PTOB0000                     * print totals
.
PRNT9999  RETURN
.---------------------------------------
. FILE0000 - Go to start of records                       Called By PRNT
.---------------------------------------
FILE0000  PACK      KEY30,SP70
          MOVE      SP70,SFMBNLED
          MOVE      SP70,SFMBNACC
          CALL      RSTEMP1
          CALL      RKTEMP1
          CALL      SAVE0000
          PACK      KEY30,SP70
          CALL      RSTEMP1
.
FILE9999  RETURN
.---------------------------------------
. PTOA0000 - Print totals                                 Called By PRNT
.---------------------------------------
PTOA0000  MOVE      THREE,RECFLAG
          CALL      HEAD0000                     * print line
          MOVE      SP70,KEY14
          MOVE      ZERO,TCHQTOT
          MOVE      ZERO,TRECTOT
          MOVE      ZERO,TCANTOT
          MOVE      ZERO,TCANTOTC
          MOVE      ZERO,TTRNTOT
          MOVE      ZERO,TJNLTOT
          CALL      RSFMTM2
.
PTOA1000  CALL      RKFMTM2
          BRANCH    OVRCD,PTOA9000
          PACK      KEY14,FMBNLED,FMBNACC
          CALL      RDFMAM1
          ADD       CHQTOT,TCHQTOT
          ADD       RECTOT,TRECTOT
          ADD       CANTOTCR,TCANTOTC
          ADD       TRNTOTC,TTRNTOT
          ADD       JNLTOTC,TJNLTOT
          MOVE      FORMAT2,PAMT2
          FEDIT     CHQTOT,PAMT2
          PRINT     *N,FMBNLED,"/",FMBNACC;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     CHQTOT,PAMT2
          PRINT     *18,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     CANTOTCR,PAMT2
          PRINT     *40,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TRNTOTC,PAMT2
          PRINT     *63,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     JNLTOTC,PAMT2
          PRINT     *86,PAMT2;
.
          MOVE      CHQTOT,RECTOT
          ADD       TRNTOTC,RECTOT
          ADD       JNLTOTC,RECTOT
          MOVE      FORMAT2,PAMT2
          FEDIT     RECTOT,PAMT2
          PRINT     *110,PAMT2
.
          ADD       THREE,CLNO
          COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS
.
          GOTO      PTOA1000
.
PTOA9000  MOVE      FORMAT2,PAMT2
          FEDIT     TCHQTOT,PAMT2
          CALL      UND132
          PRINT     *1,"Total",*18,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TCANTOTC,PAMT2
          PRINT     *40,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TTRNTOT,PAMT2
          PRINT     *63,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TJNLTOT,PAMT2
          PRINT     *86,PAMT2;
.
          MOVE      TCHQTOT,TRECTOT
          ADD       TTRNTOT,TRECTOT
          ADD       TJNLTOT,TRECTOT
          MOVE      FORMAT2,PAMT2
          FEDIT     TRECTOT,PAMT2
          PRINT     *110,PAMT2
.
PTOA9999  RETURN
.---------------------------------------
. PTOB0000 - Print totals                                 Called By PRNT
.---------------------------------------
PTOB0000  MOVE      FOUR,RECFLAG
          CALL      HEAD0000                     * print line
          MOVE      SP70,KEY14
          MOVE      ZERO,TCHQTOT
          MOVE      ZERO,TRECTOT
          MOVE      ZERO,TCANTOT
          MOVE      ZERO,TCANTOTC
          MOVE      ZERO,TTRNTOT
          MOVE      ZERO,TJNLTOT
          CALL      RSFMTM2
.
PTOB1000  CALL      RKFMTM2
          BRANCH    OVRCD,PTOB9000
          PACK      KEY14,FMBNLED,FMBNACC
          CALL      RDFMAM1
          ADD       CHQTOT,TCHQTOT
          ADD       RECTOT,TRECTOT
          ADD       CANTOT,TCANTOT
          ADD       TRNTOTD,TTRNTOT
          ADD       JNLTOTD,TJNLTOT
.
          PRINT     *N,FMBNLED,"/",FMBNACC;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     RECTOT,PAMT2
          PRINT     *18,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     CANTOT,PAMT2
          PRINT     *40,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TRNTOTD,PAMT2
          PRINT     *63,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     JNLTOTD,PAMT2
          PRINT     *86,PAMT2;
.
          ADD       CANTOT,RECTOT
          ADD       TRNTOTD,RECTOT
          ADD       JNLTOTD,RECTOT
          MOVE      FORMAT2,PAMT2
          FEDIT     RECTOT,PAMT2
          PRINT     *110,PAMT2
.
          ADD       THREE,CLNO
          COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS
.
          GOTO      PTOB1000
.
PTOB9000  MOVE      FORMAT2,PAMT2
          FEDIT     TRECTOT,PAMT2
          CALL      UND132
          PRINT     *1,"Total",*18,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TCANTOT,PAMT2
          PRINT     *40,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TTRNTOT,PAMT2
          PRINT     *63,PAMT2;
.
          MOVE      FORMAT2,PAMT2
          FEDIT     TJNLTOT,PAMT2
          PRINT     *86,PAMT2;
.
          ADD       TCANTOT,TRECTOT
          ADD       TTRNTOT,TRECTOT
          ADD       TJNLTOT,TRECTOT
          MOVE      FORMAT2,PAMT2
          FEDIT     TRECTOT,PAMT2
          PRINT     *110,PAMT2
.
          CALL      UND132
          PRINT     *N,"****   End of Report   ****"
.
PTOB9999  RETURN
.---------------------------------------
. HEAD0000 - Print page heading                           Called By PRNT
.---------------------------------------
HEAD0000  CALL      HEAD132            * print header
          PRINT     "Cheque Account : ",FMCHCHQ,SP2,FMCHDES,*N:
                    "Period         : ",DATRANGE
          CALL      UND132           * print line
.
          BRANCH    RECFLAG,HEAD3000,HEAD5000,HEAD7000,HEAD8000
          PRINT     *50,"Cash Payments",*N:
                    "    Payment No. Paid to                         ":
                    " Issued     Presented    Bank Account             Bank ":
                    "Total          Payment Total"
          ADD       ONE,CLNO
          CALL      UND132           * print line
          GOTO      HEAD9999
.
HEAD3000  PRINT     *50,"Cash Receipts",*N:
                    "Receipt Ref.     Comment                           ":
                    " Received    Presented    Bank Account             Bank ":
                    "Total      Receipt Total"
          ADD       "2",CLNO
          CALL      UND132           * print line
          GOTO      HEAD9999
.
HEAD5000  PRINT     *50,"Cash Transfers",*N:
                    "Reference           ":
                    "Date           Bank Account         ":
                    "                                                Amount":
                    "       Transfer Total"
          ADD       "2",CLNO
          CALL      UND132           * print line
          GOTO      HEAD9999
.
HEAD7000  PRINT     "Bank Control Account      ":
                    "Cash Payments     Cancelled Payment         ":
                    "Int-Fund Trans               ":
                    "Journals            Credit Total":
                 *N,"                           ":
                    "                   (Current Period)                      ":
                    "                         "
          ADD       "1",CLNO
          CALL      UND132
          GOTO      HEAD9999
.
HEAD8000  PRINT     "Bank Control Account      ":
                    "Cash Receipts     Cancelled Payment         ":
                    "Int-Fund Trans               ":
                    "Journals             Debit Total":
                 *N,"                          ":
                    "                  (Current & Prior)                 ":
                    "                         "
          ADD       "1",CLNO
          CALL      UND132
          GOTO      HEAD9999
.
HEAD9999  RETURN
.---------------------------------------
. BTOT0000 - Print totals                                 Called By PRNT
.---------------------------------------
BTOT0000  MATCH     "2",LASTCHST
          IF        @EQUAL
            MOVE      SP70,FCHQ
          ELSE
            MOVE      FORMAT2,FCHQ
            FEDIT     CHQTOTAL,FCHQ
          ENDIF
          PRINT     *110,FCHQ
          BRANCH    RECFLAG,BTOT1000,BTOT2000
.
          MOVE      FORMAT2,PAMT2
          FEDIT     BNKTOT,PAMT2
          PRINT     *99,"               ------------------",*N:
                    *95,"Payments Total ",PAMT2
          ADD       ONE,CLNO
          MOVE      ZERO,BNKTOT
          CALL      CANDB000
          GOTO      BTOT9999
.
BTOT1000  MOVE      FORMAT2,PAMT2
          FEDIT     BNKTOT,PAMT2
          PRINT     *99,"               ------------------",*N:
                    *95,"Receipts Total ",PAMT2
          ADD       ONE,CLNO
          MOVE      ZERO,BNKTOT
          GOTO      BTOT9999
.
BTOT2000  MOVE      FORMAT2,PAMT2
          FEDIT     BNKTOT,PAMT2
          PRINT     *99,"               ------------------",*N:
                    *95,"Transfer Total ",PAMT2
          ADD       ONE,CLNO
          MOVE      ZERO,BNKTOT
          GOTO      BTOT9999
.
BTOT9999  RETURN
.---------------------------------------
. WPAY0000 - Print data                                   Called By PRNT
.---------------------------------------
WPAY0000  UNPACK    FMBNDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,ISSDATE
.
          MATCH     "DD-",FMBNREF
          GOTO      WPAY0100 IF NOT EQUAL
.
          MOVE      ONE,FMBNPRE
          UNPACK    FMBNDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PACK      PRES,PRES1,SP1,CPCDATE
          GOTO      WPAY0900
.
WPAY0100  MOVE      ZERO,F1
          MOVE      FMBNPRE,F1
          MOVE      PRES0,PRESDESC
          LOAD      PRESDESC,F1,PRES1,PRES2
          MOVE      SP10,CPCDATE
          IF        F1=1 | F1=2
            MATCH     FMBNPDT,SP8
            IF        @EQUAL
              UNPACK    FMBNDAT,CCENT,CYEAR,CMON,CDAY
            ELSE
              UNPACK    FMBNPDT,CCENT,CYEAR,CMON,CDAY
            ENDIF
            CALL      PACDATE
          ENDIF
.
          PACK      PRES,PRESDESC,SP1,CPCDATE
.
          MATCH     "00000",FMBNCRE
          GOTO      WPAY0900 IF EQUAL
          MATCH     SP5,FMBNCRE
          GOTO      WPAY1000 IF EQUAL
.
          MOVE      FMBNCRE,KEY5
          CALL      RDAPMA1
          BRANCH    OVRCD,WPAY1000
          MOVE      APMACN1,FMBNNAM
          GOTO      WPAY1000
.
WPAY0900  MOVE      SP5,FMBNCRE
.
WPAY1000  MOVE      SP70,PAMT
          MOVE      FORMAT,PAMT
          FEDIT     FMBNAMT,PAMT
.
          PACK      KEY14,FMBNLED,FMBNACC
          CALL      RDFMAM1
          MATCH     SP70,LASTCHEQ
          GOTO      WPAY2000 IF NOT EQUAL
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          GOTO      WPAY3100
.
WPAY2000  MATCH     FMBNREF,LASTCHEQ
          GOTO      WPAY3000 IF NOT EQUAL
.
          PRINT     *N,*74,FMBNLED,"/",FMBNACC,SP1,PAMT;
          ADD       ONE,CLNO           * increment line number
          ADD       FMBNAMT,CHQTOTAL
          GOTO      WPAY4000
.
WPAY3000  MOVE      SP70,FCHQ
          MATCH     "2",LASTCHST
          GOTO      WPAY3030 IF NOT EQUAL
.
          COMPARE   ZERO,CHQTOTAL
          GOTO      WPAY3050 IF EQUAL
.
WPAY3030  MOVE      FORMAT2,FCHQ
          FEDIT     CHQTOTAL,FCHQ
.
WPAY3050  PRINT     *110,FCHQ;
.
WPAY3100  COMPARE   "55",CLNO                    * end of page ?
          GOTO      WPAY3200 IF LESS             * start new page
          PRINT     SP1
          CALL      HEAD0000
.
WPAY3200  MOVE      FMBNNAM,KEY24
          PRINT     *N,FMBNREF,SP1,FMBNCRE,SP1,KEY24,SP1,ISSDATE,SP1,PRES:
                    SP1,FMBNLED,"/",FMBNACC,SP1,PAMT;
          ADD       ONE,CLNO           * increment line number
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          MOVE      FMBNAMT,CHQTOTAL
.
WPAY4000  ADD       FMBNAMT,TOTAL1     * add to total
          ADD       FMBNAMT,BNKTOT     * add to total
.
WPAY9999  RETURN
.---------------------------------------
. WADJ0000 - Print data                                   Called By PRNT
.---------------------------------------
WADJ0000  UNPACK    FMBNDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          PACK      FMAMDESC,SP70
          PACK      KEY14,FMBNLED,FMBNACC,SP70
          CALL      RDFMAM1
.
          MOVE      FORMAT,PAMT
          FEDIT     FMBNAMT,PAMT
          MATCH     SP70,LASTCHEQ
          GOTO      WADJ2000 IF NOT EQUAL
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          GOTO      WADJ3100
.
WADJ2000  MATCH     FMBNREF,LASTCHEQ
          GOTO      WADJ3000 IF NOT EQUAL
.
          COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS
.
          PRINT     *N,*36,FMBNLED,"/",FMBNACC,SP1,FMAMDESC,SP5,PAMT;
          ADD       ONE,CLNO           * increment line number
          ADD       FMBNAMT,CHQTOTAL
          GOTO      WADJ4000
.
WADJ3000  MOVE      FORMAT2,FCHQ
          FEDIT     CHQTOTAL,FCHQ
          PRINT     *110,FCHQ;
.
WADJ3100  COMPARE   "55",CLNO                    * end of page ?
          GOTO      WADJ3200 IF LESS             * start new page
          PRINT     SP1
          CALL      HEAD0000
.
WADJ3200  PRINT     *N,FMBNREF,SP5,CPCDATE:
                    SP5,FMBNLED,"/",FMBNACC,SP1,FMAMDESC,SP5,PAMT;
          ADD       ONE,CLNO           * increment line number
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          MOVE      FMBNAMT,CHQTOTAL
.
WADJ4000  ADD       FMBNAMT,TOTAL1     * add to total
          ADD       FMBNAMT,BNKTOT     * add to total
.
WADJ9999  RETURN
.---------------------------------------
. WREC0000 - Print data                                   Called By PRNT
.---------------------------------------
WREC0000  UNPACK    FMBNDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,ISSDATE
          MOVE      ZERO,F1
          MOVE      FMBNPRE,F1
          MOVE      PRES0,PRESDESC
          LOAD      PRESDESC,F1,PRES1,PRES2
          MOVE      SP10,CPCDATE
          IF        F1=1 | F1=2
            UNPACK    FMBNPDT,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
          ENDIF
.
          PACK      PRES,PRESDESC,SP1,CPCDATE
.
          MOVE      FORMAT,PAMT
          FEDIT     FMBNAMT,PAMT
          MATCH     SP70,LASTCHEQ
          GOTO      WREC2000 IF NOT EQUAL
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          GOTO      WREC3100
.
WREC2000  MATCH     FMBNREF,LASTCHEQ
          GOTO      WREC3000 IF NOT EQUAL
.
          PRINT     *N,*78,FMBNLED,"/",FMBNACC,SP1,PAMT;
          ADD       ONE,CLNO           * increment line number
          ADD       FMBNAMT,CHQTOTAL
          GOTO      WREC4000
.
WREC3000  MOVE      FORMAT2,FCHQ
          FEDIT     CHQTOTAL,FCHQ
          PRINT     *110,FCHQ;
.
WREC3100  COMPARE   "55",CLNO                    * end of page ?
          GOTO      WREC3200 IF LESS             * start new page
          PRINT     SP1
          CALL      HEAD0000
.
WREC3200  PRINT     *N,FMBNREF,SP1,FMBNNAM,SP1,ISSDATE,SP1,PRES:
                    SP2,FMBNLED,"/",FMBNACC,SP1,PAMT;
          ADD       ONE,CLNO           * increment line number
          MOVE      FMBNREF,LASTCHEQ
          MOVE      FMBNPRE,LASTCHST
          MOVE      FMBNAMT,CHQTOTAL
.
WREC4000  ADD       FMBNAMT,TOTAL1     * add to total
          ADD       FMBNAMT,BNKTOT     * add to total
.
WREC9999  RETURN
.---------------------------------------
. Save temp file variables
.---------------------------------------
SAVE0000  MOVE    FMBNBNK,SFMBNBNK
          MOVE    FMBNREF,SFMBNREF
          MOVE    FMBNLED,SFMBNLED
          MOVE    FMBNACC,SFMBNACC
          MOVE    FMBNDAT,SFMBNDAT
          MOVE    FMBNTYP,SFMBNTYP
          MOVE    FMBNPRE,SFMBNPRE
          MOVE    FMBNPDT,SFMBNPDT
          MOVE    FMBNFYR,SFMBNFYR
          MOVE    FMBNBCH,SFMBNBCH
          MOVE    FMBNLNO,SFMBNLNO
          MOVE    FMBNCRE,SFMBNCRE
          MOVE    FMBNNAM,SFMBNNAM
.
SAVE9999  RETURN
.
.---------------------------------------
. Routines for temp file
.---------------------------------------
RSTEMP1   RESET     KEY30
          READ      FMSTMP01,KEY30;;
          RETURN
.
RDTEMP1   RESET     KEY30
          MOVE      ZERO,OVRCD
          READ      FMSTMP01,KEY30;FMBNBNK,FMBNUNQ,FMBNREF,FMBNLED:
                                   FMBNACC,FMBNDAT,FMBNTYP,FMBNPRE,FMBNPDT:
                                   AMOUNT,FMBNFYR,FMBNBCH,FMBNLNO,FMBNCRE:
                                   FMBNNAM,FMBNSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    FMSTMP01;FMBNBNK,FMBNUNQ,FMBNREF,FMBNLED:
                             FMBNACC,FMBNDAT,FMBNTYP,FMBNPRE,FMBNPDT:
                             FMBNAMT,FMBNFYR,FMBNBCH,FMBNLNO,FMBNCRE:
                             FMBNNAM,FMBNSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTEMP1   UPDATE    FMSTMP01;FMBNBNK,FMBNUNQ,FMBNREF,FMBNLED:
                             FMBNACC,FMBNDAT,FMBNTYP,FMBNPRE,FMBNPDT:
                             FMBNAMT,FMBNFYR,FMBNBCH,FMBNLNO,FMBNCRE:
                             FMBNNAM,FMBNSPAR
          RETURN
.
RPTEMP1   MOVE      ZERO,OVRCD
          READKP    FMSTMP01;FMBNBNK,FMBNUNQ,FMBNREF,FMBNLED:
                             FMBNACC,FMBNDAT,FMBNTYP,FMBNPRE,FMBNPDT:
                             FMBNAMT,FMBNFYR,FMBNBCH,FMBNLNO,FMBNCRE:
                             FMBNNAM,FMBNSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   RESET     KEY30
          WRITE     FMSTMP01,KEY30;FMBNBNK,FMBNUNQ,FMBNREF,FMBNLED:
                                   FMBNACC,FMBNDAT,FMBNTYP,FMBNPRE,FMBNPDT:
                                   FMBNAMT,FMBNFYR,FMBNBCH,FMBNLNO,FMBNCRE:
                                   FMBNNAM,FMBNSPAR
          RETURN
.
DETEMP1   RESET     KEY30
          DELETE    FMSTMP01,KEY30
          RETURN
.
RSFMTM2   RESET     KEY14
          READ      FMSTMP02,KEY14;;
          RETURN
.
RDFMTM2   RESET     KEY14
          MOVE      ZERO,OVRCD
          READ      FMSTMP02,KEY14;KEY14,CHQTOT,RECTOT,CANTOT,TRNTOTD:
                                   TRNTOTC,JNLTOTD,JNLTOTC,CANTOTCR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKFMTM2   MOVE      ZERO,OVRCD
          READKS    FMSTMP02;FMBNLED,FMBNACC,CHQTOT,RECTOT,CANTOT,TRNTOTD:
                             TRNTOTC,JNLTOTD,JNLTOTC,CANTOTCR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRFMTM2   RESET     KEY14
          WRITE     FMSTMP02,KEY14;KEY14,CHQTOT,RECTOT,CANTOT,TRNTOTD:
                                   TRNTOTC,JNLTOTD,JNLTOTC,CANTOTCR
          RETURN
.
UPFMTM2   UPDATE    FMSTMP02;KEY14,CHQTOT,RECTOT,CANTOT,TRNTOTD:
                             TRNTOTC,JNLTOTD,JNLTOTC,CANTOTCR
          RETURN
.
DEFMTM2   RESET     KEY14
          DELETE    FMSTMP02,KEY14
          RETURN
.
RSTEMP3   RESET     KEY20
          READ      FMSTMP03,KEY20;;
          RETURN
.
RDTEMP3   RESET     KEY20
          MOVE      ZERO,OVRCD
          READ      FMSTMP03,KEY20;TP3REF,TP3CRE,TP3DAT,TP3PDT,TP3NAM,TP3AMT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP3   MOVE      ZERO,OVRCD
          READKS    FMSTMP03;TP3REF,TP3CRE,TP3DAT,TP3PDT,TP3NAM,TP3AMT
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTEMP3   UPDATE    FMSTMP03;TP3REF,TP3CRE,TP3DAT,TP3PDT,TP3NAM,TP3AMT
          RETURN
.
RPTEMP3   MOVE      ZERO,OVRCD
          READKP    FMSTMP03;TP3REF,TP3CRE,TP3DAT,TP3PDT,TP3NAM,TP3AMT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP3   RESET     KEY20
          WRITE     FMSTMP03,KEY20;TP3REF,TP3CRE,TP3DAT,TP3PDT,TP3NAM,TP3AMT
          RETURN
.
DETEMP3   RESET     KEY20
          DELETE    FMSTMP03,KEY20
          RETURN
.---------------------------------------
. Print Cancelled Direct Debits
.---------------------------------------
CANDB000  MOVE      SIXTY,CLNO
          MOVE      ZERO,BNKTOT
          PACK      KEY20,SP70
          CALL      RSTEMP3
.
CANDB100  CALL      RKTEMP3
          BRANCH    OVRCD,CANDB900
.
          MOVE      TP3NAM,APMACN1
          PACK      KEY5,TP3CRE,SP70
          CALL      RDAPMA1
.
          COMPARE   "56",CLNO
          CALL      DBHEAD00 IF NOT LESS
.
          UNPACK    TP3DAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,KEY10
          UNPACK    TP3PDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      FORMAT2,PAMT2
          FEDIT     TP3AMT,PAMT2
.
          PRINT     *1,TP3REF,*20,TP3CRE,*30,APMACN1,*65,KEY10:
                    *82,CPCDATE,*110,PAMT2
          ADD       TP3AMT,BNKTOT
          ADD       ONE,CLNO
          GOTO      CANDB100
.
CANDB900  COMPARE   ZERO,BNKTOT
          GOTO      CANDB999 IF EQUAL
.
          MOVE      FORMAT2,PAMT2
          FEDIT     BNKTOT,PAMT2
          PRINT     *99,"               ------------------",*N:
                    *95,"Payments Total ",PAMT2
          ADD       ONE,CLNO
          MOVE      ZERO,BNKTOT
.
CANDB999  RETURN
.
DBHEAD00  CALL      HEAD132            * print header
          PRINT     "Cheque Account : ",FMCHCHQ,SP2,FMCHDES,*N:
                    "Period         : ",DATRANGE
          CALL      UND132           * print line
          PRINT     *50,"Cancelled Payments",*N:
                    "Payment No.        Paid To":
                    *65,"Date Issued":
                    *80,"Date Cancelled":
                    *119,"Payment Total"
          ADD       ONE,CLNO
          CALL      UND132           * print line
          RETURN
.
.----------------------------------------
. Enter Date Range
.----------------------------------------
RDAT0000   MOVE     "    4",FLDID
           CALL     GETPOSIT
           MOVE     SP70,CDAY
           MOVE     CMM,CMON
           MOVE     CYY,CYEAR
           MOVE     CCC,CCENT
           CALL     KEYDATE
           BRANCH   OVRCD,RDAT0100
           MATCH    SP2,CDAY
           GOTO     RDAT0100 IF EQUAL
           PACK     STRDAT,CCENT,CYEAR,CMON,CDAY
           REP      " 0",STRDAT
           CALL     PACDATE
           MOVE     CPCDATE,FROMDAT
           GOTO     RDAT0140
.
RDAT0100   MOVE     "Start             ",FROMDAT
           MOVE     SP70,STRDAT
.
RDAT0140   MOVE     FROMDAT,VAR
           CALL     DISPITEM
.
RDAT0150   MOVE     "    5",FLDID
           CALL     GETPOSIT
           MOVE     SP70,CDAY
           MOVE     CMM,CMON
           MOVE     CYY,CYEAR
           MOVE     CCC,CCENT
           CALL     KEYDATE
           BRANCH   OVRCD,RDAT0200
           MATCH    SP2,CDAY
           GOTO     RDAT0200 IF EQUAL
           PACK     ENDDAT,CCENT,CYEAR,CMON,CDAY
           REP      " 0",ENDDAT
           CALL     PACDATE
           MOVE     CPCDATE,TODAT
           MATCH    STRDAT,ENDDAT
           GOTO     RDAT0999 IF EQUAL
           GOTO     RDAT0999 IF NOT LESS
           BEEP
           MOVE     "To Date Must Be > From Date - ",DISPMSG
           CALL     MESSAGE1
           GOTO     RDAT0000
.
RDAT0200   MOVE     "Finish             ",TODAT
           MOVE     "99999999",ENDDAT
.
RDAT0999   MOVE     "    4",FLDID
           CALL     GETPOSIT
           RETURN
.----------------------------------------------------------------------
. Enter Cheque Account
.----------------------------------------------------------------------
KCHQ0000  MOVE      ZERO,CKEYTYP
          CALL      KFMCHA00
.
KCHQ9999  RETURN
.
.-------------------------------
. Includes for I/O and Keyins
.-------------------------------
          INC       APSMASIO/INC
          INC       FMSAMAIO/INC
          INC       FMSBNKIO/INC
          INC       FMSCAFIO/INC
          INC       FMSCHQIO/INC
          INC       FMSCHQKY    
          INC       FMSCONIO/INC
          INC       FMSCSAIO/INC
          INC       FMSLMAIO/INC
          INC       FMSLMCIO/INC
          INC       FMSLMCKY    
          INC       FMSTRNIO/INC
.
          INC       STDGENCD
.
