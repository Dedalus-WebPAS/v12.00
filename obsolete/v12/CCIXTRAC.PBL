.******************************************************************************
.* System         : CCI                                                       *
.*                                                                            *
.* Include        : CCIXTRAC.PBL                                              *
.*                                                                            *
.* Function       : This include contains the code for the extraction of      *
.*                  CCIUTL records for all patient types.                     *
.*                                                                            *
.*                  It is the main program include for:                       *
.*                                                                            *
.*                              IBACCI69.PBL                                  *
.*                              IBACCI79.PBL                                  *
.*                                                                            *
.*           NOTE : the batch number (CCUTBATN) will ALWAYS be set to ZERO    * 
.*                                                                            *
.* Created        : 08/04/1992                                                *
.*                                                                            *
.* Entry Points   : AAE0000       do the extract for A&E patients             *
.*                  INP0000       do the extract for Inpatients               *
.*                  OUT0000       do the extract for Outpatients              *
.*                  THET0000      do the extract for Theatre patients         *
.*                  OPX0000       do the extract for O/P extra screens        *
.*                  DEPN0000      do the extract for Dependancy               *
.*                                                                            *
.******************************************************************************
.* Mods     :                                                                 *
.*        V11.03.01 20.03.2023  DA Sarkies     TSK 0909393                    *
.*                  Added Effective from and to date to MBS Item file         *
.*        V11.00.01 10/03/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*        V10.03.01 05/09/2012  J.Tan          CAR 267784                     *
.*                  Mods Checking for TCINDC19 Claim Code                     *
.*        V10.01.01 01/12/2010  J.Tan  CAR 233034                             *
.*                  Mods to Bed fees file to use HF type                      *
.*        V9.04.01  06/10/2004  Davin  CAR 53798                              *
.*                  Use pthsdclm instead of ptcndclm for multihospital        *
.*        V9.03.02  30/10/2003  J.Tan                                         *
.*                  Mods for pmsmtiaf                                         *
.*        V9.03.01  07/08/2003  Jill Habasque CAR 41815                       *
.*                  Changed match for opdastat                                *
.*        V5.08.01  06/06/2000  Jill Habasque                                 *
.*                  Changed from key10 to key14 for the health fund file      *
.*        V5.07.02  16/07/1999  Steve Downing                                 *
.*                  Modified CALC to use DAYSEP command                       *
.*        V5.07.01  07/12/1998  Steve Armstrong    SRF 644142                 *
.*                  Mods to add new implant codes 6 -10                       *
.*        V5.07.00  06/10/98  Jim Stathopoulos                                *
.*                  507 Changes                                               *
.******************************************************************************
.*        V5.05.01  02/10/1997  Steve Armnstrong   SRF 643603                 *
.*                  Mods to calculate fiscal year & period                    *
.******************************************************************************
.*        V5.04.05  03/08/1997  Steve Armstrong   WHL Mods                    *
.*                  Mods for Service Code                                     *
.*        V5.04.04  25/05/1997  Steve Armstrong   WHL Mods                    *
.*                  Mods for Ordering Doctor                                  *
.*        V5.04.03  09/12/1996  Steve Armstrong                               *
.*                  Fixed problem positioning on temp file                    *
.*        V5.04.02  23/09/1996  Steve Armstrong   SRF 642100                  *
.*                  Mods to accumulate transfer hour totals                   *
.*        V5.04.01  24.06.1996    B.G.Ackland                                 *
.*                  Changed CCUTSPAR to CCUTHPRE                              *
.*        V5.03.06  28/02/1996    Matt                Quote 8587              *
.*                  make sure IBA sent Flag is recorded as Zero for New Rec.  *
.*        V5.03.05  22.08.1995    B.G.Ackland                                 *
.*                  make sure IBA sent Flag is recorded as Zero for New Rec.  *
.*        V5.03.04  28/07/1995    Justin Coates                               *
.*                  add the error report to Outpatient Extra Screen extract   *
.*        V5.03.03  21/07/1995    ROD                 SRF 640537              *
.*                  fixed I*C (outma1af)   and fixed I*I while i was there    *
.*        V5.03.02  19/07/1995    Justin Coates                               *
.*                  added the set up of CCUTORIG to Procedure Type Number     *
.*        V5.03.01  17/07/1995    Justin Coates  (Quote 8436)                 *
.*                  Added var. 7 for procedure types 6 and 28                 *
.******************************************************************************
.*        V5.02.02  09/05/1995    Justin Coates                              * 
.*                  remove debug                                             *
.*        V5.02.01  24/04/1995    Justin Coates   (Quote 8372)               * 
.*                  for proc type 32, the TO time is a Pre-Op time (CDUR0000)*
.*        V5.02.00  24/04/1995    Justin Coates   (Quote 8372)               * 
.*                  added variables for types 4/5/8/9                        *
.*                  added procedure type 32                                  *
.*****************************************************************************
.*                  14/04/1992  Graeme Williams                              *
.*                  Altered quantity types to 0, 1, 2                        *
.*                  17/08/92    Peter Eddey                                  *
.*                  Changed cciutlaf to use key42                            *
.*                  21/08/92    Graeme Williams             SRF 116849       *
.*                  Fixed setting of UAGEDEPT and UAGEPROC vars              *
.*                  29/10/92    Graeme Williams                              *
.*                  Added special cases for proc types 21 & 22               *
.*                  05/11/92    Whirlpool                                    *
.*                  Changed extract of dietary procedures                    *
.*                  19/03/1993  Steve Armstrong                              *
.*                  Recompiled for STEPDOWN (new episode field)              *
.*                  25/06/1993  Glenn Berry                                  * 
.*                  Changes for Procedure Type 25   (O/P Extra Screen)       *
.*                  15/12/1993    Justin Coates                              * 
.*                  in the SETP0000 routine, before assigning as a daycase   *
.*                  check to see if the system parameter is blank            *
.*                  01/03/1994    Justin Coates  (Hawkes Bay mods)           * 
.*                  add procedure type 26 and 27                             *
.*                  added the report to show error & success records         *
.*                  06/05/1994    Justin Coates  (Hawkes Bay mods)           * 
.*                  add procedure type 28 - same as procedure type 6         *
.*                  10/06/1994    Justin Coates                              * 
.*                  if a cciutlaf records already exists,                    *
.*                      if it is already HANDED OVER, dont touch it          *
.*                      else DONT add to the quantity, move the amount       *
.*                  06/07/1994    Justin Coates                              * 
.*                  added procedure type 29,30,31                            *
.*                  13/12/1994    Justin Coates                              * 
.*                  put displays in inpatient extract for diff. types of pat.*
.*****************************************************************************
.*  ANY NEW VARIABLE NUMBERS OR PROC. TYPES MUST ALSO BE ADDED TO "CCIGROUP" *
.*****************************************************************************
.
.**********************************************************************
.*                                AAE0000                             *
.*                  Routine to extract the A & E details              *
.**********************************************************************
AAE0000   PACK      KEY16,REPDATE,SP8
          DISPLAY   *P40:24,REPDATE
          CALL      RDSDISA2             * position on A & E discharge file
.
.------ read through A & E discharge file ------
.
AAE1000   CALL      RDKDISA2
          BRANCH    OVRCD,AAE9999
          MATCH     ADSDATE,REPDATE      * test dates
          GOTO      AAE9999 IF LESS
          MOVE      ADSNUMB,KEY8
          CALL      RDDETA1              * read details file
          BRANCH    OVRCD,AAE1000
          DISPLAY   *P22:24,*V2LON,ADSNUMB
          MOVE      ADADOCT,ORDDOCT      * save ordering doctor
          CALL      WRTA0000             * write patient details to CCIUTL file
          GOTO      AAE1000
.
AAE9999   RETURN
+
.**********************************************************************
.*                                INP0000                             *
.*                  Routine to extract the inpatient details          *
.**********************************************************************
INP0000   DISPLAY   *P40:24,REPDATE
          CALL      CADM0000              * extract current admission details
          CALL      DISC0000              * extract discharged patients details
          CALL      LEAV0000              * extract on leave patients details
          CALL      MISC0000              * extract miscellaneous charges
.         IF        CDIETCD = 1
.           CALL      DIET0000            * extract dietary procedures
.         ENDIF
          IF        USINGDEP = 0          
            CALL      DEPN0000            * extract dependency procedures
          ENDIF
          DISPLAY   *P1:23,*EL;
.
INP9999   RETURN
+
.**********************************************************************
.*                              CADM0000                              *
.*           routine to extract current patient details               *
.**********************************************************************
CADM0000  DISPLAY   *P1:23,*EL,"Current Admissions"
          PACK      KEY9,TWO,SP8
          CALL      RDSMISS2             * position on admissions file
.
.------ read through admissions file ------
.
CADM1000  CALL      RDKMISS2
          BRANCH    OVRCD,CADM9999
.
          COMPARE   TWO,ASTAT            * test admission status
          GOTO      CADM9999 IF NOT EQUAL
.
          MOVE      ADATE,ADMISDTE
          MATCH     ADMISDTE,REPDATE     * test admission date
          GOTO      CADM1000 IF LESS
.
          CALL      ONLV0000             * check to see if patient was on leave
          BRANCH    EXIT,CADM1000
          BRANCH    FLAGONLV,CADM1000
.
.         Set patient type and procedure code
.
          CALL      SETP0000
          BRANCH    EXIT,CADM9999
.
          MOVE      ADOCTA,ORDDOCT       * save ordering doctor
          DISPLAY   *P22:24,*V2LON,AADMNO 
          CALL      WRTI0000             * write patient details to CCIUTL file
          GOTO      CADM1000
.
CADM9999  RETURN
.
.**********************************************************************
.*                  SETP0000                                          *
.*        Routine to extract the set the patient type and procedure   *
.*        codes for an inpatient. This will check for boarders and    *
.*        for day cases.                                              *
.**********************************************************************
SETP0000  MOVE      ZERO,EXIT
          MATCH     ACLSS,CCCNBRDR
          GOTO      SETP1000 IF NOT EQUAL   * patient is not a boarder
.
.         This patient is a boarder
.
SETP0200  MOVE      CCCNBDCD,TMPPTYP        * patient is a boarder
          MOVE      THREE,INPTYPE           * patient is a boarder
          GOTO      SETP2000
.
.         This patient is an inpatient.
.
SETP1000  MOVE      CCCNIPCD,TMPPTYP        * patient is an inpatient
          MOVE      TWO,INPTYPE             * patient is an inpatient
.
.         Check if the patient is discharged
.
SETP2000  COMPARE   THREE,ASTAT
          GOTO      SETP9999 IF NOT EQUAL   * not discharged
.
.         Check for a day case patient
.
          MATCH     ADATE,DDATE
          GOTO      SETP9999 IF NOT EQUAL   * not a daycase
.
          MATCH     SP2,CCCNDCCD
          GOTO      SETP9999 IF EQUAL       * no parameter set so leave type
.
.         This patient is a day case
.
          MOVE      CCCNDCCD,TMPPTYP        * patient is a daycase
          MOVE      ONE,INPTYPE             * patient is a daycase
.
SETP9999  RETURN
+
.**********************************************************************
.*                              DISC0000                              *
.*       Routine to extract the details of the patients who are       *
.*       currently discharged                                         *
.**********************************************************************
DISC0000  DISPLAY   *P1:23,*EL,"Discharges"
          PACK      KEY16,REPDIM8,SP8
          CALL      RDSDSCH2             * position on discharge file
.
.------ read through discharge file ------
.
DISC1000  CALL      RDKDSCH2
          BRANCH    OVRCD,DISC9999
.
          MOVE      DADMNO,KEY8
          CALL      RDMISS1              * read admissions file
          BRANCH    OVRCD,DISC1000
.
          MOVE      ADATE,ADMISDTE
          MATCH     ADMISDTE,REPDATE     * test admission date
          GOTO      DISC1000 IF LESS
.
          CALL      ONLV0000             * check to see if patient was on leave
          BRANCH    EXIT,DISC1000
.
.------   If a patient is put on leave the day he was admitted and   ------- 
.------   returns form leave on the same day he was discharged then  -------
.------   we desire to treat this patient as a daycase.              -------
.
          IF        FLAGONLV = 1
            MATCH     ONLVDATE,ADMISDTE  * put on leave same day as admitted?
            IF        @EQUAL
              CALL      RFLV0000         * get date they returned from leave
              BRANCH    EXIT,DISC1000
              MOVE      DDATE,DISDATE
              REP       " 0",DISDATE
              MATCH     DISDATE,RFLVDATE * return from leave the day discharged?
              GOTO      DISC1000 IF NOT EQUAL
              MOVE      DDATE,ADATE      * set date to indicate a daycase
              GOTO      DISC2000
            ELSE
              GOTO      DISC1000
            ENDIF
          ENDIF
.
          MOVE      DDATE,DISDATE
          MATCH     DISDATE,ADMISDTE     * see if patient was a day case
          GOTO      DISC2000 IF EQUAL
.
          MATCH     REPDIM8,DDATE        * we want to ignore the day of 
          GOTO      DISC1000 IF EQUAL      discharge if not a day case
.
.         Set the patient type and procedure code
.
DISC2000  CALL      SETP0000
.
.------ write patient details to CCIUTL file ------
.
          MOVE      ADOCTA,ORDDOCT       * save ordering doctor
          DISPLAY   *P22:24,*V2LON,AADMNO 
          CALL      WRTI0000             * write patient details to CCIUTL file
          GOTO      DISC1000
.
DISC9999  RETURN
+
.**********************************************************************
.*                              LEAV0000                              *
.*       Routine to extract details of patients who are currently     *
.*       on leave                                                     *
.**********************************************************************
LEAV0000  DISPLAY   *P1:23,*EL,"On Leave"
          PACK      KEY9,FOUR,SP8
          CALL      RDSMISS2             * position on admissions file
.
.------ read through admissions file ------
.
LEAV1000  CALL      RDKMISS2
          BRANCH    OVRCD,LEAV9999
.
          COMPARE   FOUR,ASTAT           * test admission status
          GOTO      LEAV9999 IF NOT EQUAL
.
          MOVE      ADATE,ADMISDTE
          MATCH     ADMISDTE,REPDATE     * test admisison date
          GOTO      LEAV1000 IF LESS
.
          CALL      ONLV0000             * check to see if patient was on leave
          BRANCH    EXIT,LEAV1000
          BRANCH    FLAGONLV,LEAV1000
.
          CALL      SETP0000             * set patient type and procedure
          MOVE      ADOCTA,ORDDOCT       * save ordering doctor
          DISPLAY   *P22:24,*V2LON,AADMNO 
          CALL      WRTI0000             * write patient details to CCIUTL file
          GOTO      LEAV1000
.
LEAV9999  RETURN
+
.**********************************************************************
.*                              FUCK0000                              *
.**********************************************************************
FUCK0000  MOVE       " 37",KEY3
          CALL       RDCCPAR1
          COMPARE    ZERO,OVRCD
          GOTO       FUCK0500 IF EQUAL
          MOVE       " 38",KEY3
          CALL       RDCCPAR1
          BRANCH     OVRCD,FUCK9999
.
FUCK0500  PACK       KEY30,AADMNO,REPDIM8,SP20
          CALL       RDSTRAN2
FUCK1000  CALL       RDKTRAN2
          BRANCH     OVRCD,FUCK9999
          COMPARE    TADMN,AADMNO
          GOTO       FUCK9999 IF NOT EQUAL
.
          MATCH      REPDIM8,TDATE
          GOTO       FUCK9999 IF NOT EQUAL
.
FUCK2000  MOVE       TWARD,SAVWARD
          MOVE       TTIME,SAVTIME
          MOVE       TDATE,SAVDATE
          MOVE       TATYPE,SAVATYPE
          MOVE       TADOCT,SAVDOCT
.
FUCK3000  CALL       RDKTRAN2
          BRANCH     OVRCD,FUCK9999
.
          COMPARE    TADMN,AADMNO
          GOTO       FUCK9999 IF NOT EQUAL
.
          MATCH      REPDIM8,TDATE
          GOTO       FUCK9999 IF NOT EQUAL
.
          MATCH      TWARD,SAVWARD
          GOTO       FUCK4000 IF NOT EQUAL
          MATCH      ANSR,TMOVE                    * CHeck for ret. from leave
          GOTO       FUCK2000 IF EQUAL
          MATCH      ANSC,TMOVE                    * CHeck for on leave or disc.
          GOTO       FUCK3000 IF EQUAL
.
FUCK4000  MOVE       " 37",KEY3
          CALL       GPDQ0000
          BRANCH     EXIT,FUCK5000
          CALL       WUUT0000
.
FUCK5000  MOVE       " 38",KEY3
          CALL       GPDQ0000
          BRANCH     EXIT,FUCK2000
          CALL       WUUT0000
.
          GOTO       FUCK2000
.
FUCK9999  RETURN
.**********************************************************************
.*                              ONLV0000                              *
.*           Routine to see if a given patient was onleave            *
.*           for a given date.                                        *
.**********************************************************************
ONLV0000  MOVE      FALSE,EXIT
          PACK      KEY30,AADMNO,REPDIM8,Z20     * position on transfer file
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,ONLV9000
.
          COMPARE   TADMN,AADMNO                 * compare admission numbers
          GOTO      ONLV9000 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE                   * test transfer movement
          GOTO      ONLV7000 IF EQUAL
          GOTO      ONLV8000
.
.------ patient was on leave for report date ------
.
ONLV7000  MOVE      TRUE,FLAGONLV
          MOVE      TDATE,ONLVDATE
          REP       " 0",ONLVDATE
          GOTO      ONLV9999
.
.------ patient was not on leave for report date ------
.
ONLV8000  MOVE      FALSE,FLAGONLV
          MOVE      SP8,ONLVDATE
          GOTO      ONLV9999
.
.------ error - patient has no transfer details ------
.
ONLV9000  MOVE      TRUE,EXIT
.
ONLV9999  RETURN
+
.**********************************************************************
.*                              RFLV0000                              *
.*           Routine to get the date a patient returned from leave.   *
.**********************************************************************
RFLV0000  MOVE      FALSE,EXIT
          MOVE      SP8,RFLVDATE
          PACK      KEY30,AADMNO,REPDIM8,Z20     * position on transfer file
          CALL      RDSTRAN2
RFLV1000  CALL      RDKTRAN2
          BRANCH    OVRCD,RFLV9000
.
          COMPARE   TADMN,AADMNO                 * compare admission numbers
          GOTO      RFLV9000 IF NOT EQUAL
.
          MATCH     ANSR,TMOVE                   * test transfer movement
          GOTO      RFLV7000 IF EQUAL
.
          GOTO      RFLV1000
.
.------ patient was on leave for report date ------
.
RFLV7000  MOVE      TDATE,RFLVDATE
          REP       " 0",RFLVDATE
          GOTO      RFLV9999
.
.------ error - patient has no transfer details ------
.
RFLV9000  MOVE      TRUE,EXIT
.
RFLV9999  RETURN
.
.****************************************************************************
.*                                 MISC0000                                 *
.*                  Get miscellaneous charges for wards/Theatre             *
.****************************************************************************
.
.-------  Extract Miscellaneous charges that are a applicable to a ward ------
.
MISC0000  DISPLAY   *P1:23,*EL,"Miscellaneous"
          OPEN      PMSMTIA2,"pmsmtiaf"
          PACK      KEY16,REPDIM8,SP20
          CALL      RDSDSCH2
MISC1000  CALL      RDKDSCH2
          BRANCH    OVRCD,MISC9999
.
          MATCH     REPDIM8,DDATE          * test if correct date
          GOTO      MISC9999 IF NOT EQUAL
.
          MOVE      ZERO,MTIFLAG
          MOVE      ZERO,TPATAMTT
          PACK      KEY22,DADMNO,SP30
          CALL      RDSDTRN1
.
MISC3000  MOVE      ZERO,TPATAMTT
          CALL      RDKDTRN1
          BRANCH    OVRCD,MISC8000
.
          COMPARE   DADMNO,TADMNO           * test for the same patient
          GOTO      MISC8000 IF NOT EQUAL
.
          COMPARE   THREE,TRECTYPE          * test for miscellaneous charge
          GOTO      MISC3000 IF NOT EQUAL
.
MISC4000  MOVE      "N",CCUTSENT
          MOVE      SP30,CCUTCOMM
          MOVE      SP20,CCUTHPRE
          MOVE      TMPPTYP,CCUTPTYP
.
. ** extract ward
.
          PACK      KEY30,DADMNO,REPDIM8,Z20  * position on transfer file
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,MISC9000
.
          COMPARE   TADMN,DADMNO            * test admission numbers
          GOTO      MISC9999 IF NOT EQUAL

          MATCH     "THEATRE ",TBATCHN      * we don't want theatre items
          GOTO      MISC5000 IF EQUAL
.
          MOVE      ZERO,QUANTITY
          MOVE      " 21",KEY3
          CALL      GPDQ0000                * get procedure and department
          BRANCH    EXIT,MISC9000
.
          DISPLAY   *P22:24,*V2LON,DADMNO 
          CALL      WUUT0000                * write a record to cciutlaf
          GOTO      MISC9000
.
.------  Extract Theatre Miscellaneous charges           -------
.------  Try and get the theatre code for a patient      ---------
.
MISC5000  OPEN      OPRDETA2,"oprdetaf"     * op. details file
          OPEN      OPRSESA1,"oprsesaf"     * session file
.
          PACK      DIM8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       "0 ",DIM8
          PACK      KEY22,WBSEHOSP,DIM8,SP30
          CALL      RSOPSES1
MISC5100  CALL      RKOPSES1
          BRANCH    OVRCD,MISC9000
.
          MATCH     WBSEHOSP,OPSEHOSP
          GOTO      MISC9000 IF NOT EQUAL
.
          MATCH     DIM8,OPSEDATE
          GOTO      MISC9000 IF NOT EQUAL
.
          PACK      KEY31,DADMNO,ZERO,OPSEDATE,OPSETIME,OPSECLIN
          CALL      RDOPDEA2
          BRANCH    OVRCD,MISC5100
.
MISC7000  MOVE      ZERO,QUANTITY
          MOVE      " 22",KEY3
          CALL      GPDQ0000                * get procedure and department
          BRANCH    EXIT,MISC9000
.
          DISPLAY   *P22:24,*V2LON,DADMNO 
          CALL      WUUT0000                * write a record to cciutlaf
          GOTO      MISC9000
.
MISC8000  MOVE      ONE,MTIFLAG
          MOVE      DADMNO,PMMIVISN
          MOVE      "3",PMMIRTYP
          PACK      KEY15,DADMNO,PMMIRTYP,SP30
          CALL      RSPMMTI2
.
MISC8200  MOVE      ZERO,TPATAMTT
          CALL      RKPMMTI2
          BRANCH    OVRCD,MISC1000
.
          MOVE      DADMNO,DDADMNO
          MATCH     DDADMNO,PMMIVISN         * test for the same patient
          GOTO      MISC1000 IF NOT EQUAL
.
          MATCH     "3",PMMIRTYP          * test for miscellaneous charge
          GOTO      MISC1000 IF NOT EQUAL
.
          CALL      MTDT0000              * move fields from pmsmtiaf to dtraf
          GOTO      MISC4000
.
MISC9000  BRANCH    MTIFLAG,MISC8200
          GOTO      MISC3000
.
MISC9999  CLOSE     OPRDETA2                * op. details file
          CLOSE     OPRSESA1                * session file
          RETURN   
.
.****************************************************************************
.*                                DIET0000                                  *
.*                     Extract the dietary procedures                       *
.****************************************************************************
.
.DIET0000  DISPLAY   *P1:23,*EL,"Dietary"
.          PACK      KEY20,REPDATE,SP30 
.          CALL      RSCTCOM2
.DIET1000  CALL      RKCTCOM2                * read the completed menus file
.          BRANCH    OVRCD,DIET9999
..
.          MATCH     REPDATE,CTCODATE        * test that its required date
.          GOTO      DIET9999 IF NOT EQUAL
..
.          COMPARE   FOUR,CTCOSIZE           * Patient is fasting?
.          GOTO      DIET1000 IF EQUAL
..
.          BRANCH    CTCOSTAT,DIET1000,DIET2000   * only want meal status 2
.          GOTO      DIET1000
..
.DIET2000  PACK      KEY8,CTCOADMN
.          CALL      RDMISS1
.          BRANCH    OVRCD,DIET1000
..
.          CALL      SETP0000                * set patient type
..
..-------- Get the tran file record for this patient --------
..
.          PACK      KEY30,AADMNO,REPDIM8,Z20       * position on transfer file
.          CALL      RDSTRAN2
.          CALL      RDPTRAN2
.          BRANCH    OVRCD,DIET1000
..
.          COMPARE   TADMN,AADMNO                   * test admission numbers
.          GOTO      DIET1000 IF NOT EQUAL
..
.          MOVE      "N",CCUTSENT
.          MOVE      ONE,CCUTCHRG
.          MOVE      ONE,TPATAMTT
.          MOVE      SP30,CCUTCOMM
.          MOVE      SP20,CCUTHPRE
.          MOVE      TMPPTYP,CCUTPTYP
..
.          PACK      KEY8,AURNO
.          CALL      RDMAST1
..
.          IF        INPTYPE = 3       
.            GOTO      DIET1000
.          ELSE
..                                             * patient is inpatient ?
.            IF        INPTYPE = 2 
.              MOVE      " 19",KEY3
.            ELSE
..  
.              MOVE      " 18",KEY3            * daycase patient
.            ENDIF
.          ENDIF
..
.          CALL      GPDQ0000                  * get procedure,quantity
.          BRANCH    EXIT,DIET1000
..
.          CALL      WUUT0000                  * write or update CCIUTL
.          GOTO      DIET1000
..
.DIET9999  RETURN
.
.****************************************************************************
.*                                DEPN0000                                  *
.*                          Extract the dependency                          *
.****************************************************************************
.
DEPN0000  DISPLAY   *P1:23,*EL,"Dependency ";       
.
.*****  Do direct services ******
.
          PACK      KEY27,REPDATE,SP30 
          CALL      RSDPCPH1
DEPN1000  CALL      RKDPCPH1                * read the completed menus file
          BRANCH    OVRCD,DEPN9999
.
          MATCH     REPDATE,DPPCDATE        * test that its required date
          GOTO      DEPN9999 IF NOT EQUAL
.
          MOVE      DPPCADM,KEY8
          CALL      RDMISS1                 * get visit record for UR
          BRANCH    OVRCD,DEPN1000          
.
          CALL      SETP00000               * set patient type
.
          MOVE      "N",CCUTSENT
          MOVE      ONE,CCUTCHRG
          MOVE      ONE,TPATAMTT
          MOVE      SP30,CCUTCOMM
          MOVE      SP20,CCUTHPRE
          MOVE      TMPPTYP,CCUTPTYP
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
.
          PACK      KEY3,DPPCCATG
          CALL      RDDPCAT1
          BRANCH    OVRCD,DEPN1000        * Invalid dependency category
.
. ** extract ward
.
          PACK      KEY30,AADMNO,REPDIM8,Z20       * position on transfer file
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,DEPN1000
.
          COMPARE   TADMN,AADMNO                   * test admission numbers
          GOTO      DEPN1000 IF NOT EQUAL
.
          MOVE      " 36",KEY3
          CALL      GPDQ0000
          BRANCH    EXIT,DEPN1000
.
          DISPLAY   *P22:24,*V2LON,AADMNO 
          CALL      WUUT0000
          GOTO      DEPN1000
.
DEPN9999  RETURN
.
.**********************************************************************
.*                             WRTA0000                               *
.*        Routine to write the patient details to the CCIUTL file     *
.*        for the A & E extraction                                    *
.**********************************************************************
WRTA0000  MOVE      "N",CCUTSENT
          MOVE      ONE,CCUTCHRG
          MOVE      ONE,TPATAMTT
          MOVE      SP30,CCUTCOMM
          MOVE      SP20,CCUTHPRE
          MOVE      CCCNAECO,CCUTPTYP
.
          MOVE      ZERO,PSAGE
          PACK      KEY8,ADAURNO              * read master file in case "age"
          CALL      RDMAST1                     is required 
.
.         normal A&E discharge
.
          MOVE      "  7",KEY3                * set key for A&E
          CALL      GPDQ0000                  * get the costing
          BRANCH    EXIT,WRTA4000               procedure, quantity and
.                                               department
.
          PACK      KEY42,REPDATE,DEPTCODE,ADANUMB,PROCCODE,ADAURNO,ZEROUR
          CALL      MUTL0000                * maintain cciutlaf
.
.         A&E discharge for Doctor
.
WRTA4000  MOVE      " 29",KEY3                * set key for A&E
          CALL      GPDQ0000                  * get the costing
          BRANCH    EXIT,WRTA9999               procedure, quantity and
.                                               department
.
          PACK      KEY42,REPDATE,DEPTCODE,ADANUMB,PROCCODE,ADAURNO,ZEROUR
          CALL      MUTL0000                * maintain cciutlaf
.
WRTA9999  RETURN
+
.**********************************************************************
.*                             WRTI0000                               *
.*        Routine to write the patient details to the CCIUTL file     *
.*        for the inpatient extraction                                *
.**********************************************************************
WRTI0000  MOVE      "N",CCUTSENT
          MOVE      ONE,CCUTCHRG
          MOVE      ONE,TPATAMTT
          MOVE      SP30,CCUTCOMM
          MOVE      SP20,CCUTHPRE
          MOVE      TMPPTYP,CCUTPTYP
.
. ** extract ward
.
          PACK      KEY30,AADMNO,REPDIM8,Z20       * position on transfer file
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,WRTI9999
.
          COMPARE   TADMN,AADMNO                   * test admission numbers
          GOTO      WRTI9999 IF NOT EQUAL
.
          MOVE      ZERO,PSAGE
          PACK      KEY8,AURNO
          CALL      RDMAST1                   * read master file record in case
.                                               "Age" is required
          IF        INPTYPE = 3  
            MOVE      "  3",KEY3              * set as a boarder
          ELSE
            IF        INPTYPE = 2        
              MOVE      "  2",KEY3              * patient is a inpatient
            ELSE
              MOVE      "  1",KEY3              * patient is a daycase 
            ENDIF
          ENDIF
.
          CALL      GPDQ0000                  * get procedure,quantity
          BRANCH    EXIT,WRTI2000
.
          CALL      WUUT0000                  * write or update CCIUTL
.
.------ set up details for the attending doctor records 1 and 2 ------
.
WRTI2000  MATCH     ACLSS,CCCNBRDR       * is patient a boarder?
          GOTO      WRTI8000 IF EQUAL    * Yes?
.
WRTI2300  IF        INPTYPE = 3       
            GOTO      WRTI8000
          ELSE
.                                             * patient is inpatient ?
            IF        INPTYPE = 2 
              MOVE      "  5",KEY3
            ELSE
.  
              MOVE      "  4",KEY3            * daycase patient
            ENDIF
          ENDIF
.
          CALL      GPDQ0000                  * get procedure,quantity
          BRANCH    EXIT,WRTI3000
.
          CALL      WUUT0000                  * write or update CCIUTL
.
.------ Write attending doctor details 2 -> procedures 15 & 16 -----
.
WRTI3000  IF        INPTYPE = 3       
            GOTO      WRTI8000
          ELSE
.                                             * patient is inpatient ?
            IF        INPTYPE = 2 
              MOVE      " 16",KEY3
            ELSE
.  
              MOVE      " 15",KEY3            * daycase patient
            ENDIF
          ENDIF
.
          CALL      GPDQ0000                  * get procedure,quantity
          BRANCH    EXIT,WRTI6000
.
          CALL      WUUT0000                  * write or update CCIUTL
.
.------  Extract the bed fee details for procedure type 20 ------
.
WRTI6000  COMPARE   TWO,ASTAT
          GOTO      WRTI8000 IF NOT EQUAL 
.
          CALL      STEP0000                * calculate the stepdown range
          BRANCH    EXIT,WRTI8000
.
          MOVE      " 20",KEY3
          CALL      GPDQ0000
          BRANCH    EXIT,WRTI8000
.
          ASSIGN    (TRATEF+TRATEG-TDISC-TALLW),CCUTCHRG
          CALL      WUUT0000
.
WRTI8000  CALL      FUCK0000
.
WRTI9999  RETURN
.
.**********************************************************************
.*                             WUUT0000                               *
.*                write or update the CCIUTL record                   *
.**********************************************************************
WUUT0000  PACK      KEY42,REPDATE,DEPTCODE,AADMNO,PROCCODE,AURNO,ZEROUR
          CALL      MUTL0000
WUUT9999  RETURN
+
.****************************************************************************
.*                             STEP0000                                     *
.*             Calculate the stepdown range for extract 20                  *
.****************************************************************************
STEP0000  MOVE      ZERO,EXIT
          MOVE      ACLAIM,SCLAIM
          MOVE      AFUNDH,SFUNDH
.
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            MOVE      AADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD<>1
              MOVE      SP10,PTHSDCLM
              MOVE      PMVXMHOS,KEY3
              CALL      RDPTHSP1
              IF        OVRCD<>1
                MOVE      PTHSDCLM,PTCNDCLM        * use hospital default claim
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,DDATE
          IF        ASTAT=3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1
          ENDIF
.
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          IF        OVRCD = 1        
            MOVE      ONE,EXIT
            GOTO      STEP9999
          ENDIF
          IF        TADMN <> AADMNO
            MOVE      ONE,EXIT
            GOTO      STEP9999
          ENDIF

          MOVE      ONE,PROGFLAG
          MOVE      SP10,LSTDATE
          MOVE      ZERO,STEPDFLD
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
STEP1000  CALL      RDKTRAN2
          IF        OVRCD = 1        
            GOTO      STEP2000
          ENDIF
.
          IF        TADMN <> AADMNO
            GOTO      STEP2000
          ENDIF
.
          BRANCH    CFEETYP,STEP1800,STEP1800,STEP1800,STEP1500,STEP1500
.
STEP1500  MOVE      TDATE,XDATE1
          MOVE      TDATE,LSTDATE
.
          COMPARE   ONE,CSTDOWN
          CALL      STEPDOWN IF EQUAL 
.
STEP1800  MATCH     TDATE,REPDIM8
          GOTO      STEP5000 IF LESS 

          MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
          MOVE      TRBEND,STRBEND
          MOVE      TMOVE,STMOVE
          GOTO      STEP1000
.
STEP2000  MATCH     ANSD,STMOVE
          GOTO      STEP5000 IF EQUAL
          BRANCH    CFEETYP,STEP5000,STEP5000,STEP5000,STEP3000,STEP3000
.
STEP3000  COMPARE   ONE,CSTDOWN
          GOTO      STEP5000 IF NOT EQUAL
.
          PACK      XDATE1,CCC,CYY,CMM,CDD
          REP       " 0",XDATE1
          MOVE      SP1,TMOVE
          LOAD      TMOVE,ASTAT,ANSC,ANSC,ANSC,ANSR
          MOVE      XDATE1,TDATE
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          CALL      STEPDOWN
.
          MATCH     TDATE,XDATE1
          GOTO      STEP5000 IF EQUAL
          GOTO      STEP1800
.
.------  Calculate the stepdown range that is in use  ---------------
.
STEP5000  MOVE      ZERO,STEPDFLD
          IF        STRBEND = 0
            GOTO      STEP9999
          ENDIF
          OPEN      PATBFEE1,"patbfeef"
.
          PACK      KEY9,SCLAIM,SFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,STEP9999
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,SFUNDH,AFNDTB,SP70
          CALL      RDFUND1
.
STEP5200  PACK      KEY26,SCLAIM,SFUNDH,AFNDTB,TATYPE,TRBTYP,SP30
          PACK      KEY27,SCLAIM,SFUNDH,PTHFBCAT,TATYPE,TRBTYP,SP30
          IF        CFEETYP=5
            OPEN      JHSBFEA1,"jhsbfeaf"
            CALL      RSJHBFE1
          ELSE
            CALL      RDSBFEE1
          ENDIF
STEP6000  IF        CFEETYP=5
            CALL      RKJHBFE1
            PACK      DIM27,BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE,SP30
            MATCH     DIM27,KEY27
          ELSE
            CALL      RDKBFEE1
            PACK      DIM26,BFCLM,BFHFUND,BFHFTAB,BFATYPE,BFBTYPE,SP30
            MATCH     DIM26,KEY26
          ENDIF
          IF        OVRCD = 1 | !@EQUAL
            PACK      SFUNDH,SFUNDH,SP6
            MATCH     SFUNDH,SP6
            IF        @EQUAL
              MATCH     PTCNDCLM,SCLAIM
              IF        @EQUAL
                MOVE      ONE,STEPDFLD
                GOTO      STEP9999
              ELSE
                MOVE      PTCNDCLM,SCLAIM
                GOTO      STEP5200
              ENDIF
            ELSE
              UNPACK    SP70,SFUNDH,AFNDTB,PTHFBCAT
              GOTO      STEP5200
            ENDIF
          ENDIF
.
          COMPARE   NINE,CFEETYP
          GOTO      STEP8000 IF EQUAL       * Johns hopkins has no Contract ID
.
.         Set the Effective date used for calculation
.
          MOVE      TDATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,CODECL,SCLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          MOVE      PTBFCNID,KEY6           * Contract ID
          CALL      VALCONTR               * Validate Contract ID
          BRANCH    EXIT,STEP6000
.
STEP8000  COMPARE   ZERO,BFENDDY
          GOTO      STEP6000 IF EQUAL
.
          ADD       ONE,STEPDFLD
.
          COMPARE   TRBEND,BFENDDY
          GOTO      STEP9999 IF NOT LESS
          GOTO      STEP6000
.
STEP9999  RETURN
+
.*********************************************************************
.                   OUT0000
.         Routine to extract the outpatient Details
.         does procedure type 6, 26, 27 and 28
.*********************************************************************
OUT0000   DISPLAY   *P40:24,REPDATE
          MOVE      SP6,KEY6
          CALL      RDSSITA1
.
OUT1000   CALL      RDKSITA1
          BRANCH    OVRCD,OUT9999
.
. ------- open site dependant files -------
.
          CLOSE     OUTBB1A2
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILBB1A2
          TRAP      OVERCOND IF IO
          CALL      OPOTBB12
          TRAPCLR   IO
          BRANCH    OVRCD,OUT1000
.
          CLOSE     OUTBOKA3
          PACK      CFNAME,OSTFILE,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
.
          CLOSE     OUTBOKA2
          PACK      CFNAME,OSTFILE,FILBOKA2
          OPEN      OUTBOKA2,CFNAME
.
          CLOSE     OUTMA1A1
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILMA1A1
          TRAP      OVERCOND IF IO
          CALL      OPOTMA11
          TRAPCLR   IO
          BRANCH    OVRCD,OUT1000
.
. ******* get all bookings in the date range *******
.
          PACK      KEY16,REPDATE,SP30
          CALL      RDSBOKB2
.
OUT2000   CALL      RDKBOKB2
          BRANCH    OVRCD,OUT7000           * check for cancellations
          MATCH     OBADATE,REPDATE
          GOTO      OUT7000 IF NOT EQUAL    * check for cancellations
.
.         if not on visit file, see if a non-attendance 
.
          PACK      KEY8,OBAOUTNO
          CALL      RDVISA1
          BRANCH    OVRCD,OUT5000           * non-attendance ????
.
.         get the boka record 
.
          PACK      KEY36,PVIURNO,REPDATE,SP30
          CALL      RDSBOKA3
.
OUT3000   CALL      RDKBOKA3
          BRANCH    OVRCD,OUT2000
          MATCH     PVIURNO,OBAURNO
          GOTO      OUT2000 IF NOT EQUAL    * wrong UR number
          MATCH     REPDATE,OBADATE
          GOTO      OUT2000 IF NOT EQUAL    * wrong date
.
          MATCH     OSTSITE,OBASITE
          GOTO      OUT3000 IF NOT EQUAL    * different site
          COMPARE   PVIBILL,OBAOUTNO
          GOTO      OUT3000 IF NOT EQUAL    * different visit
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL      RDMASA1
          BRANCH    OVRCD,OUT2000
.
          MOVE      ZERO,PSAGE
          PACK      KEY8,PVIURNO            * read master file incase age is 
          CALL      RDMAST1                   required
.
          DISPLAY   *P22:24,*V2LON,OBAOUTNO
          MOVE      "  6",KEY3
          MOVE      OBADOCT,ORDDOCT         * save ordering doctor
          CALL      WOUT0000                * Write an Outpatient Extraction
          MOVE      " 28",KEY3
          CALL      WOUT0000                * O/P Attendance for doctor
          GOTO      OUT2000
.
. ******* see if an O/P Non-Attendance *******
.
OUT5000   MOVE      " 26",KEY3
          CALL      RDCCPAR1
          BRANCH    OVRCD,OUT2000           * not using OP non-attendances
.
          MOVE      OBAOUTNO,PVIBILL        * save O/P number
          PACK      KEY35,OSTSITE,OBBCTYP,FIVE,OBADATE,SP30
          CALL      RDSBOKA2
.
OUT5100   CALL      RDKBOKA2
          BRANCH    OVRCD,OUT2000
.
          PACK      KEY21,OBASITE,OBACTYP,OBASTAT,OBADATE
          MATCH     KEY21,KEY35
          GOTO      OUT2000 IF NOT EQUAL    * different details
.
          COMPARE   OBAOUTNO,PVIBILL
          GOTO      OUT5100 IF NOT EQUAL    * not the same booking
.
          DISPLAY   *P22:24,*V2LON,OBAOUTNO
          MOVE      " 26",KEY3              * set for O/P non-attendance
          CALL      WOUT0000
          GOTO      OUT2000
.
. ******* find the O/P cancellations for the site prefix *******
.
OUT7000   MOVE      " 27",KEY3
          CALL      RDCCPAR1
          BRANCH    OVRCD,OUT1000           * not using OP cancellations
.
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILCANA5
          TRAP      OVERCOND IF IO
          OPEN      OUTCANA5,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OUT1000
.
          PACK      KEY22,OSTSITE,REPDATE,SP10
          CALL      RSOTCAN5
.
OUT7100   CALL      RKOTCAN5
          BRANCH    OVRCD,OUT1000           * end of file
          MATCH     OPCNSITE,OSTSITE
          GOTO      OUT1000 IF NOT EQUAL    * different site
          MATCH     OPCNDATE,REPDATE
          GOTO      OUT1000 IF NOT EQUAL    * different date
.
.         have a valid record, set up BOKA vars using outcan vars
.
          MOVE      OPCNSITE,OBASITE        * set the site
          MOVE      OPCNCLIN,OBACLIN        * set the clinic
          MOVE      OPCNOUTN,OBAOUTNO       * set the O/P number
          MOVE      OPCNURNO,OBAURNO        * set the U/R number
.
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DATECONV
.
          PACK      KEY18,OPCNSITE,OPCNCLIN,WEEKDAY,OPCNSTRT
          CALL      RDMASA1
          BRANCH    OVRCD,OUT7100
.
          MOVE      OMATYP,OBACTYP          * set clinic type
          MOVE      SP3,OBAVISIT            * clear the visit type
          DISPLAY   *P22:24,*V2LON,OBAOUTNO
          MOVE      " 27",KEY3              * set for O/P cancellation
          CALL      WOUT0000
          GOTO      OUT7100
.
OUT9999   RETURN
+
.***************************************************************************
.* OPX0000 : Routine to extract the O/P extra screen details 
.***************************************************************************
OPX0000   CALL      CTMP0000                * Create Prefix Temp File
          MOVE      SP3,KEY3
          CALL      RDSTEMP1
.
OPX1000   CALL      RDKTEMP1
          BRANCH    OVRCD,OPX9999
.
.--- open site dependant files
.
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILBB1A2
          RESET     CFNAME
          TRAP      OVERCOND IF IO
          CALL      OPOTBB12
          TRAPCLR   IO
          BRANCH    OVRCD,OPX1000
.
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILBOKA3
          RESET     CFNAME
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA3,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OPX1000
.
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILCTYA1
          RESET     CFNAME
          TRAP      OVERCOND IF IO
          OPEN      OUTCTYA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OPX1000
.
          CLOSE     OUTMA1A1
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILMA1A1
          TRAP      OVERCOND IF IO
          CALL      OPOTMA11
          TRAPCLR   IO
          BRANCH    OVRCD,OPX1000
.
          PACK      KEY16,REPDATE,SP30
          CALL      RDSBOKB2
.
OPX2000   CALL      RDKBOKB2
          BRANCH    OVRCD,OPX1000
.
          MATCH     OBADATE,REPDATE
          GOTO      OPX1000 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO
          CALL      RDVISA1
          BRANCH    OVRCD,OPX2000
.
          PACK      KEY36,PVIURNO,REPDATE,SP30
          CALL      RDSBOKA3
.
OPX3000   CALL      RDKBOKA3
          BRANCH    OVRCD,OPX2000
.
          MATCH     PVIURNO,OBAURNO
          GOTO      OPX2000 IF NOT EQUAL
.
          MATCH     REPDATE,OBADATE
          GOTO      OPX2000 IF NOT EQUAL
.
          COMPARE   PVIBILL,OBAOUTNO
          GOTO      OPX3000 IF NOT EQUAL
.
.--- get required screen id
.
          PACK      KEY12,OBASITE,OBACTYP
          CALL      RDCTYA1                  
          BRANCH    OVRCD,OPX4000
          MATCH     SP2,OCTXATT              * blank?
          GOTO      OPX4000 IF EQUAL
          MOVE      OCTXATT,CCXASCID
          GOTO      OPX5000
.
OPX4000   PACK      KEY6,OBASITE
          CALL      RDSITA1
          BRANCH    OVRCD,OPX2000            * no screen id, ignore
          MATCH     OTSTXATT,SP2
          GOTO      OPX2000 IF EQUAL         * no screen id, ignore
          MOVE      OTSTXATT,CCXASCID
.
OPX5000   PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL      RDMASA1
          BRANCH    OVRCD,OPX2000
.
          PACK      KEY8,PVIURNO            * read master file incase age is 
          CALL      RDMAST1                   required
.
          DISPLAY   *P22:24,*V2LON,OBAOUTNO
          MOVE      " 25",KEY3
.
.---- loop thru each unique count and write an outpatient record  
.
          MOVE      CCXASCID,SAVESCID
          PACK      KEY13,DEFPRID,CCXASCID,SP3
          CALL      RSCCXPA1
.
OPX6000   CALL      RKCCXPA1
          BRANCH    OVRCD,OPX2000
          MATCH     CCXASCID,SAVESCID       * same screen id?
          GOTO      OPX2000 IF NOT EQUAL
.
          CALL      WOUT0000                * Write an Outpatient Extraction
          GOTO      OPX6000
.
OPX9999   RETURN
+
.***************************************************************************
.*  CTMP0000  -  Build & Load Temp File for site prefixes                  *
.***************************************************************************
CTMP0000  CALL      KILL0000                * Kill the Temp File
          CALL      BULD0000                * Build the Temp File
          OPEN      TEMP1,FNAMER
          PACK      KEY6,SP6
          CALL      RDSSITA1
.
CTMP1000  CALL      RDKSITA1
          BRANCH    OVRCD,CTMP9999
.
          PACK      KEY3,OSTFILE
          CALL      RDATEMP1
          BRANCH    OVRCD,CTMP2000
          GOTO      CTMP1000
.
CTMP2000  CALL      WRTEMP1
          GOTO      CTMP1000
.
CTMP9999  RETURN
+
.***************************************************************************
.*  KILL0000  -  Kill the Temp File                                        *
.***************************************************************************
KILL0000  CLOSE     TEMP1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMER,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.***************************************************************************
.*  BULD0000  -  Build the Temp File                                       *
.***************************************************************************
BULD0000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMER,CMDLINE
          APPEND    " 4 u1-3",CMDLINE
          APPEND    SP30,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.***************************************************************************
.*  WOUT0000  -  Write an Outpatient Extraction Record                     *
.* parameters : KEY3 - procedure type                                      *
.***************************************************************************
.
.------ set up variables ------
.
WOUT0000  MOVE      "N",CCUTSENT
          MOVE      ONE,CCUTCHRG
          MOVE      ONE,TPATAMTT
          MOVE      SP30,CCUTCOMM
          MOVE      SP20,CCUTHPRE
          MOVE      CCCNOPCD,CCUTPTYP
.
          MATCH     " 25",KEY3
          IF        @EQUAL
            CALL      XPDQ0000
            MOVE      TWENTY5,CCPATYPE      * set the Procedure Type
          ELSE
            CALL      GPDQ0000
          ENDIF
          BRANCH    EXIT,WOUT9999
.
          PACK      KEY42,REPDATE,DEPTCODE,OBAOUTNO,PROCCODE,OBAURNO,ZEROUR
          CALL      MUTL0000
.
WOUT9999  RETURN
+
.*********************************************************************
.*                  THET0000                    Called by : ML1000   *
.*        Get the extraction for theatre patients                    *
.*********************************************************************
THET0000  OPEN      OPRDETA1,"oprdetaf"     * op. details file
          OPEN      OPRDETB1,"oprdetbf"     * op. team file
          OPEN      OPRDETC1,"oprdetcf"     * op. usage file
          OPEN      OPRSESA1,"oprsesaf"     * session file
          OPEN      OPREXPA1,"oprexpaf"     * expensive item
          OPEN      PATCODE1,"patcodes"     * codes file
          OPEN      PATMA1A1,"patma1af"                * master file
          OPEN      PATMX1A1,"patmx1af"                * master extension file
          OPEN      PATMI1A1,"patmi1af"                * admission file
.
          PACK      KEY22,WBSEHOSP,REPDATE,SP20
          CALL      RSOPSES1                * positional read
.
.         loop over session file
.
THET1000  CALL      RKOPSES1                * next read
          BRANCH    OVRCD,THET9999          * end of file
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      THET9999 IF NOT EQUAL   * different hospital
.
          MATCH     OPSEDATE,REPDATE
          GOTO      THET9999 IF NOT EQUAL   * different date
.
          PACK      CURSESS,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN
          PACK      KEY26,CURSESS,ZERO,SP3
          CALL      RSOPDEA1                * positional read
.
.         loop over details file
.
THET2000  CALL      RKOPDEA1                * next read
          BRANCH    OVRCD,THET1000          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     CURSESS,KEY22
          GOTO      THET1000 IF NOT EQUAL   * different session
.
          COMPARE   THREE,OPDASTAT
          GOTO      THET2000 IF EQUAL       * not a booking
.
          DISPLAY   *P22:24,*V2LON,OPDAADMN
          CALL      SVOP0000                * set common CCI variables
.
          MOVE      ZERO,PSAGE
          PACK      KEY8,AURNO              * read master file in case age is
          CALL      RDMAST1                   required 
.
          PERFORM   CCCNOPO3,KINF0000
          PERFORM   CCCNOPO5,RECC0000
          MOVE      " 13",KEY3              * anaesthetic 1
          PERFORM   CCCNOPO6,ANTH0000
          MOVE      " 17",KEY3              * anaesthetic 2
          PERFORM   CCCNOPO6,ANTH0000
          MOVE      " 31",KEY3              * anaesthetic for Doctor
          PERFORM   CCCNOPO6,ANTH0000
          PERFORM   CCCNOPO7,AFTH0000
.
.         see if booking has usage details
.
          PACK      KEY11,OPDAUNIQ,SP1
          CALL      RSOPDEC1                * positional read
.
THET3000  CALL      RKOPDEC1                * next read
          BRANCH    OVRCD,THET2000          * end of usage for booking
.
          MATCH     OPDAUNIQ,OPDCUNIQ
          GOTO      THET2000 IF NOT EQUAL   * end of usage for booking
.
          PERFORM   CCCNOPO1,SETU0000
          MOVE      "  9",KEY3              * operation
          PERFORM   CCCNOPO2,OPER0000
          MOVE      " 30",KEY3              * operation for Doctor
          PERFORM   CCCNOPO2,OPER0000
          MOVE      " 32",KEY3              * waiting time
          PERFORM   CCCNOPO2,OPER0000
.
          PERFORM   CCCNOPO4,EXPI0000
          CALL      MBSB0000                * MBS Items and bandings etc
.
.******* Generate the procedures for "per team" *********
.
          PACK      KEY11,OPDAUNIQ,SP1
          CALL      RSOPDEC1                * positional read
.
THET4000  CALL      RKOPDEC1                * next read
          BRANCH    OVRCD,THET2000          * end of usage for booking
.
          MATCH     OPDAUNIQ,OPDCUNIQ
          GOTO      THET2000 IF NOT EQUAL   * end of usage for booking
.
          IF        CCCNOPO1 = 0
            CALL      SETU0000              * setup procedure
          ENDIF
          IF        CCCNOPO2 = 0
            MOVE      "  9",KEY3            * operation duration
            CALL      OPER0000
            MOVE      " 30",KEY3            * operation duration for Doctor
            CALL      OPER0000
            MOVE      " 32",KEY3            * waiting time
            CALL      OPER0000
          ENDIF
          IF        CCCNOPO3 = 0
            CALL      KINF0000              * known infection procedure
          ENDIF
          IF        CCCNOPO4 = 0
            CALL      EXPI0000              * expensive item procedure
          ENDIF
          IF        CCCNOPO5 = 0
            CALL      RECC0000              * recovery procedure
          ENDIF
          IF        CCCNOPO6 = 0
            MOVE      " 13",KEY3
            CALL      ANTH0000              * anaesthetic procedure 1
            MOVE      " 17",KEY3
            CALL      ANTH0000              * anaesthetic procedure 2
            MOVE      " 31",KEY3
            CALL      ANTH0000              * anaesthetic for Doctor 
          ENDIF
          IF        CCCNOPO7 = 0
            CALL      AFTH0000              * after hours procedure
          ENDIF
          GOTO      THET4000
.
THET9999  RETURN
+
.*********************************************************************
.*                  SVOP0000                    Called by : THET2000 *
.*        Set up the common CCI variables for theatre                *
.*********************************************************************
SVOP0000  MOVE      OPDADATE,CCUTDATE       * date
.
SVOP1000  MOVE      OPDAADMN,CCUTEVNT       * event number
          MOVE      CCCNIPCD,CCUTPTYP       * default patient type
.
.         now have to check if admission & discharge dates match
.
          MOVE      SP8,AURNO               * clear UR number
          MOVE      OPDAADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,SVOP2000          * not admitted
.
          MOVE      OPDAADMN,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,SVOP2000          * not discharged
.
          MATCH     ADATE,DDATE
          GOTO      SVOP2000 IF NOT EQUAL   * not a day case
.
          MOVE      CCCNDCCD,CCUTPTYP       * set as day case patient type
.
SVOP2000  MOVE      AURNO,CCUTURNO          * UR number
          MOVE      SP30,CCUTCOMM           * no comments
          MOVE      "N",CCUTSENT            * not sent
.
SVOP9999  RETURN
+
.*********************************************************************
.                   ANTH0000                    Called by : THET2000 
.         Anaesthetic Procedure
.         Para's  : KEY3          the procedure type
.*********************************************************************
ANTH0000  MATCH     SP3,OPDAANAE
          GOTO      ANTH9999 IF EQUAL       * no anaesthetic
.
          MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,ANTH9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
ANTH9999  RETURN
.
.*********************************************************************
.*                          RECC0000                                 *
.*                       recovery procedure                          *
.*********************************************************************
RECC0000  MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
          MOVE      " 12",KEY3
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,RECC9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
RECC9999  RETURN
+
.*********************************************************************
.*                       SETU0000               Called by : THET3000 *
.*                    Setup Procedure
.*********************************************************************
SETU0000  MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
          MOVE      "  8",KEY3
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,SETU9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
SETU9999  RETURN
.
.*********************************************************************
.*                       OPER0000                                    *
.*                    Operation procedure                            *
.*        Para's  : KEY3       the procedure type                    *
.*********************************************************************
OPER0000  MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,OPER9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
OPER9999  RETURN
.
.*********************************************************************
.*                       EXPI0000                                    *
.*                    Implant procedure                              *
.*********************************************************************
EXPI0000  MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
          MOVE      SP6,IMPLCODE 
          MOVE      ZERO,COUNTER
.
.******* Test if any of the codes is using implant codes ***********
.
          MOVE        " 11",KEY3
          CALL        RDCCPAR1
          BRANCH      OVRCD,EXPI9999
.
          REPEAT
            ADD       ONE,COUNTER
            LOAD      FORM3,COUNTER,CCPADCD1,CCPADCD2,CCPAPCD1,CCPAPCD2:
                                  CCPAPCD3
            IF        FORM3 = 3
              GOTO      EXPI4500
            ENDIF
.
          UNTIL     COUNTER = 5
          MOVE      FOUR,COUNTER
          GOTO      EXPI5000
.
EXPI4500  MOVE      ZERO,COUNTER
.
EXPI5000  REPEAT
.
            ADD       ONE,COUNTER
            LOAD      IMPLCODE,COUNTER,OPDCIMC1,OPDCIMC2,OPDCIMC3:
                                     OPDCIMC4,OPDCIMC5,OPDCIMC6,OPDCIMC7:
                                     OPDCIMC8,OPDCIMC9,OPDCIM10
            MOVE      " 11",KEY3
            CALL      GPDQ0000                * set department, quantity
            BRANCH    EXIT,EXPI6200
.
            CALL      GCHG0000                * get patient charge
.
            MOVE      PROCCODE,CCUTPROC
            MOVE      DEPTCODE,CCUTDEPT
            PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO:
                      ZEROUR
            CALL      MUTL0000
.
EXPI6200    MOVE      ONE,ANS
          UNTIL     COUNTER = 10
.
EXPI9999  RETURN
.
.*********************************************************************
.*                       KINF0000                                    *
.*                    Known infection                                *
.*********************************************************************
KINF0000  MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * clear the charge
          MOVE      " 10",KEY3
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,KINF9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
KINF9999  RETURN
.
.*********************************************************************
.*                       AFTH0000                                    *
.*                    after hours procedure                          *
.*********************************************************************
AFTH0000  MOVE      "SP",CODE
          PACK      KEY5,CODE,OPSETPER
          CALL      RDCODE1
          BRANCH    OVRCD,AFTH9999
.
          MATCH     ANSA,TCINDC1             * indicator for after hour
          GOTO      AFTH9999 IF NOT EQUAL
.
          MOVE      ZERO,CCUTQUNT           * clear quantity
          MOVE      ONE,TPATAMTT            * set the charge
.
          MOVE      " 14",KEY3
          CALL      GPDQ0000                * set department, quantity
          BRANCH    EXIT,AFTH9999
.
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
AFTH9999  RETURN
.
.****************************************************************************
.*                                 MBSB0000                                 *
.*                  Get MBS items and bandings for theatre                  *
.****************************************************************************
MBSB0000  MOVE      ZERO,COUNTER
.
MBSB1000  ADD       ONE,COUNTER
          COMPARE   SEVEN,COUNTER
          GOTO      MBSB9999 IF NOT LESS    * finished
.
          MOVE      SP10,MBSCODE
          LOAD      MBSCODE,COUNTER,OPDCICD1,OPDCICD2,OPDCICD3,OPDCICD4:
                                    OPDCICD5,OPDCICD6
.
          MOVE      ZERO,QUANTITY           * initialise quantity
          MOVE      " 23",KEY3
          CALL      GPDQ0000                * get procedure and department
          BRANCH    EXIT,MBSB1000
.
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,CCUTCHRG
          MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
.
.------ Get the theatre banding extract --------
.
          PACK      KEY17,MBSCODE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,MBSB1000
.
          MOVE      ZERO,TCFORM6
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          MOVE      TCFORM6,HFBAND
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
.
          MOVE      SP3,BAND
          LOAD      BAND,HFBAND,IBAND1,IBAND2,IBAND3,IBAND4:
                                IBAND5,IBAND6,IBAND7,IBAND8:
                                IBAND9,IBAND10,IBAND11,IBAND12:
                                IBAND13,IBAND14,IBAND15,IBAND16
.
          MOVE      ZERO,QUANTITY           * initialise quantity
          MOVE      " 24",KEY3
          CALL      GPDQ0000                * get procedure and department
          BRANCH    EXIT,MBSB1000
.
.------ Get charge form patient account ------
.
          MOVE      ZERO,CCUTCHRG
          MOVE      ZERO,TPATAMTT
          PACK      KEY22,OPDAADMN,SP30
          CALL      RDSDTRN1
.
MBSB3500  CALL      RDKDTRN1
          BRANCH    OVRCD,MBSB4000
.
          MOVE      OPDAADMN,FORM8
          COMPARE   FORM8,TADMNO           * test for the same patient
          GOTO      MBSB4000 IF NOT EQUAL
.
          PACK      DIM8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",DIM8
          MATCH     DIM8,OPSEDATE          * test for the correct session
          GOTO      MBSB3500 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE           * test for miscellaneous charge
          GOTO      MBSB3500 IF NOT EQUAL
.
          MATCH     MBSCODE,TITEMNO
          GOTO      MBSB3500 IF NOT EQUAL
.
          MOVE      TPATAMTT,CCUTCHRG        * set patient charge
.
MBSB4000  MOVE      PROCCODE,CCUTPROC
          MOVE      DEPTCODE,CCUTDEPT
.
          PACK      KEY42,CCUTDATE,CCUTDEPT,CCUTEVNT,CCUTPROC,CCUTURNO,ZEROUR
          CALL      MUTL0000
          GOTO      MBSB1000
.
MBSB9999  RETURN
.
.***************************************************************************
.*                               GCHG0000                                  *
.*                        Get the patient charge                           *
.***************************************************************************
GCHG0000  MOVE      ZERO,CCUTCHRG
          MOVE      ZERO,TPATAMTT
          PACK      KEY22,OPDAADMN,SP30
          CALL      RDSDTRN1
GCHG3500  MOVE      ZERO,TPATAMTT
          CALL      RDKDTRN1
          BRANCH    OVRCD,GCHG9999
.
          MOVE      OPDAADMN,FORM8
          COMPARE   FORM8,TADMNO           * test for the same patient
          GOTO      GCHG9999 IF NOT EQUAL
.
          PACK      DIM8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",DIM8
          MATCH     DIM8,OPSEDATE          * test for the correct session
          GOTO      GCHG3500 IF NOT EQUAL
.
          COMPARE   THREE,TRECTYPE         * test for miscellaneous charge
          GOTO      GCHG3500 IF NOT EQUAL
.
          MOVE      "I:",DIM2
          PACK      DIM8A,DIM2,IMPLCODE
          MATCH     DIM8A,TBATCHN 
          GOTO      GCHG3500 IF NOT EQUAL
.
          MOVE      TPATAMTT,CCUTCHRG        * set patient charge
.
GCHG9999  RETURN
.
.**********************************************************************
.*                              GPDQ0000                              *
.*        get the procedure and the department and quantity           *
.* Note : KEY3 must be "passed" to this routine with the correct      *
.*        procedure type.   (Not type 25)                             *
.**********************************************************************
GPDQ0000  UNPACK    SP20,SAVECOD1,SAVECOD2
          UNPACK    SP20,SAVECOD3,SAVECOD4
          MOVE      SP10,CCGDCOD1
          MOVE      SP10,CCGDCOD2
          MOVE      SP10,CCGPCOD1
          MOVE      SP10,CCGPCOD2
          MOVE      SP10,CCGPCOD3
          MOVE      SP10,PROCCODE
          MOVE      SP10,DEPTCODE
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,QUANTITY
          MOVE      ZERO,FORM1           * are we using an age range in the
.                                             key 0 = no , 1 = yes
          MOVE      ZERO,FORM1A
. 
          MOVE      ZERO,UAGEDEPT        * age field number for department
.                                          0,1 or 2
          MOVE      ZERO,UAGEPROC        * age field number for procedure
.                                          0,1,2 or 3
.
.------   Read in the parameters for this procedure type -----
.
          CALL      RDCCPAR1
          BRANCH    OVRCD,GPDQ9990          * no details set up
.
.------   Is this an extract record ------
.
          COMPARE   ZERO,CCPAAUTO
          GOTO      GPDQ9990 IF EQUAL       * not an auto extract
.
.         set up the required dept/proc variables
.
          CALL      FAGE0000                * format the age field
          PERFORM   CCPATYPE,GPDQ0100,GPDQ0200,GPDQ0300,GPDQ0400,GPDQ0500:
                             GPDQ0600,GPDQ0700,GPDQ0800,GPDQ0900,GPDQ1000: 10
                             GPDQ1100,GPDQ1200,GPDQ1300,GPDQ1400,GPDQ1500:
                             GPDQ1600,GPDQ1700,GPDQ1800,GPDQ1900,GPDQ2000: 20
                             GPDQ2100,GPDQ2200,GPDQ2300,GPDQ2400,GPDQ2500:
                             GPDQ2600,GPDQ2700,GPDQ0600,GPDQ2900,GPDQ0900: 30
                             GPDQ1300,GPDQ0900,GPDQ3300,GPDQ3400,GPDQ3500:
                             GPDQ3600,GPDQ3700,GPDQ3800
.
          PACK      CCGDCOD1,CCGDCOD1,SP10
          PACK      CCGDCOD2,CCGDCOD2,SP10
          PACK      CCGPCOD1,CCGPCOD1,SP10
          PACK      CCGPCOD2,CCGPCOD2,SP10
          PACK      CCGPCOD3,CCGPCOD3,SP10
.
. ------- see if the current values are set up on the CCIGDPFD -------
.
          MOVE      ONE,ERDEPPRO            * set to department error
          PACK      KEY21,CCPATYPE,CCGDCOD1,CCGDCOD2
          CALL      RDCCGDP1
          IF        OVRCD = 1
.
            MOVE      CCGDCOD1,SAVECOD1       * save the current codes
            MOVE      CCGDCOD2,SAVECOD2
            MOVE      SP9,SAVECOD3
            MOVE      SP9,SAVECOD4
.
            IF        UAGEDEPT = 0
               MOVE      ONE,EXIT           * no record and we are not using
               GOTO      GPDQ9900             an age range so exit
            ENDIF
.
.
            CALL      RKCCGDP1                * read next department record
            BRANCH    OVRCD,GPDQ9900          * no record so exit
            COMPARE   CCPATYPE,CCGDTYPE
            GOTO      GPDQ9900 IF NOT EQUAL   * different Proc. Type
.
            IF        UAGEDEPT = 2          
              MATCH     SAVECOD1,CCGDCOD1
              GOTO      GPDQ9900 IF NOT EQUAL   * diff. first field so error
            ENDIF
.
          ENDIF
.
. ------- see if the current values are set up on the CCIGPRFD -------
.
          MOVE      TWO,ERDEPPRO            * set to procedure error
          PACK      KEY30,CCPATYPE,CCGPCOD1,CCGPCOD2,CCGPCOD3
          CALL      RDCCGPR1
          IF        OVRCD = 1 
.
            MOVE      CCGPCOD1,SAVECOD1     * save the current codes
            MOVE      CCGPCOD2,SAVECOD2
            MOVE      CCGPCOD3,SAVECOD3
            MOVE      SP9,SAVECOD4
.
            IF        UAGEPROC = 0
              MOVE      ONE,EXIT            * We have no record and are not 
              GOTO      GPDQ9900              using an age range so exit
            ENDIF
.
            CALL      RKCCGPR1
            BRANCH    OVRCD,GPDQ9900          * no procedure record
            COMPARE   CCPATYPE,CCGPTYPE
            GOTO      GPDQ9900 IF NOT EQUAL   * different procedure type
.
            IF        UAGEPROC = 2
              MATCH     SAVECOD1,CCGPCOD1
              GOTO      GPDQ9900 IF NOT EQUAL   * first codes are different
            ENDIF
            IF        UAGEPROC = 3
              PACK      DIM18,SAVECOD1,SAVECOD2
              PACK      DIM18A,CCGPCOD1,CCGPCOD2
              MATCH     DIM18,DIM18A
              GOTO      GPDQ9900 IF NOT EQUAL   * first two codes are diff.
            ENDIF
          ENDIF
.
.         see if we have a quantity
.
          MOVE      THREE,ERDEPPRO          * set to quantity error
          COMPARE   ZERO,CCGPQNTY
          GOTO      GPDQ9900 IF EQUAL       * invalid quantity
.
          IF          CCGPQNTY = 1
            MOVE        CCGPQNTY,QUANTITY     * use default quantity
          ELSE
            CALL        SPEC0000              * handle special cases
          ENDIF
.
          PACK      DEPTCODE,CCGDDEPT,SP10
          PACK      PROCCODE,CCGPPROC,SP10
          MOVE      ZERO,EXIT
          GOTO      GPDQ9999
.      
.*******  Procedure type  1 ********
.
. Variables
. 1 = Ward
. 2 = Age
.
GPDQ0100  LOAD      CCGDCOD1,CCPADCD1,TWARD,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,THREE
          RETURN            
.
.*******  Procedure type  2 ********
.
. Variables
. 1 = Ward
. 2 = Age
.
GPDQ0200  LOAD      CCGDCOD1,CCPADCD1,TWARD,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type  3 ********
.
. Variables
. 1 = Ward
. 2 = Age
.
GPDQ0300  LOAD      CCGDCOD1,CCPADCD1,TWARD,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type  4 ********
.
. Variables
. 1 = Ward
. 2 = Attending Doctor
. 3 = Age
. 4 = Department (A)
.
GPDQ0400  LOAD      CCGDCOD1,CCPADCD1,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TADOCT,AGEFIELD,TATYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type  5 ********
.
. Variables
. 1 = Ward
. 2 = Attending Doctor
. 3 = Age
. 4 = Department (A)
.
GPDQ0500  LOAD      CCGDCOD1,CCPADCD1,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TADOCT,AGEFIELD,TATYPE
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TADOCT,AGEFIELD,TATYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type  6 and 28 ********
.
.Variables
. 1 = site
. 2 = Clinic Id
. 3 = Clinic Indicator (CI)
. 4 = Visit Type       (CV)
. 5 = Clinic Type
. 6 = Age
. 7 = Patient Category (P) 
.
GPDQ0600  LOAD      CCGDCOD1,CCPADCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBACAT
          LOAD      CCGDCOD2,CCPADCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBACAT
          LOAD      CCGPCOD1,CCPAPCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBACAT
          LOAD      CCGPCOD2,CCPAPCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBACAT
          LOAD      CCGPCOD3,CCPAPCD3,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBACAT
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,ONE,UAGEDEPT
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,TWO,UAGEDEPT
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,THREE,UAGEDEPT
          RETURN
.
.*******  Procedure type  7 ********
.
.Variables
. 1 = Discharge Status         (ED)
. 2 = Situation Code           (ES)
. 3 = Location code indicator  (A1)
. 4 = Age
.
GPDQ0700  LOAD      CCGDCOD1,CCPADCD1,ADSDISC,ADASIT,ADAUSR1,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,ADSDISC,ADASIT,ADAUSR1,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,ADSDISC,ADASIT,ADAUSR1,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,ADSDISC,ADASIT,ADAUSR1,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,ADSDISC,ADASIT,ADAUSR1,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE
          RETURN
.   
.*******  Procedure type  8 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = User defined field 4 (Z4)
. 4 = Session type         (ST)
. 5 = Age
. 6 = Operation Type       (OY)
.
GPDQ0800  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC,ONE
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC,TWO
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.
.*******  Procedure type  9 and 30 and 32 ********
.
. Variables
.  1 = Theatre Code
.  2 = Clinic Surgeon
.  3 = User defined field 1 (Z1)
.  4 = User defined field 1 (Z2)
.  5 = User defined field 1 (Z3)
.  6 = User defined field 1 (Z4)
.  7 = Session type         (ST)
.  8 = Age
.  9 = Operation Type       (OY)
. 10 = Department           (A) 
.
GPDQ0900  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,KEY6
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,OPDCUSR1,OPDCUSR2:
                                      OPDCUSR3,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE,ATYPE
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,OPDCUSR1,OPDCUSR2:
                                      OPDCUSR3,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE,ATYPE
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,OPDCUSR1,OPDCUSR2:
                                      OPDCUSR3,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE,ATYPE
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,OPDCUSR1,OPDCUSR2:
                                      OPDCUSR3,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE,ATYPE
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,OPDCUSR1,OPDCUSR2:
                                      OPDCUSR3,OPDCUSR4,OPSETYPE,AGEFIELD:
                                      OPDATYPE,ATYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE:
                                      UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO:
                                      UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,UAGEPROC,UAGEPROC,ONE:
                                      UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,UAGEPROC,UAGEPROC,TWO:
                                      UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,UAGEPROC,UAGEPROC,THREE:
                                      UAGEPROC
          RETURN
.
.*******  Procedure type 10 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Known infection (OK)
. 4 = Age
.
GPDQ1000  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,OPDAKNOW,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,OPDAKNOW,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,OPDAKNOW,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,OPDAKNOW,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,OPDAKNOW,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 11 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Expensive item 1 - 8
. 4 = Age
.
GPDQ1100  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,IMPLCODE,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,IMPLCODE,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,IMPLCODE,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,IMPLCODE,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,IMPLCODE,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 12 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Age
. 4 = Session Type (ST)
.
GPDQ1200  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,AGEFIELD,OPSETYPE
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,AGEFIELD,OPSETYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE,UAGEDEPT
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO,UAGEDEPT
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE,UAGEDEPT
          RETURN
.
.*******  Procedure type 13 and 31 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Anaesthetic code (OA)
. 4 = Age
. 5 = Session Type     (ST)
.
GPDQ1300  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,OPDAANAE,AGEFIELD,OPSETYPE
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,OPDAANAE,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,OPDAANAE,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,OPDAANAE,AGEFIELD,OPSETYPE
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,OPDAANAE,AGEFIELD,OPSETYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE,UAGEPROC
          RETURN
.
.*******  Procedure type 14 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Age
.
GPDQ1400  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 15 ********
. Variables
. 1 = Ward
. 2 = Attending Doctor
. 3 = Age

GPDQ1500  LOAD      CCGDCOD1,CCPADCD1,TWARD,TADOCT,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TADOCT,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 16 ********
.
. Variables
. 1 = Ward
. 2 = Attending Doctor
. 3 = Age
.
GPDQ1600  LOAD      CCGDCOD1,CCPADCD1,TWARD,TADOCT,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TADOCT,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TADOCT,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 17 ********
.
. Variables
. 1 = Theatre Code
. 2 = Clinic Surgeon
. 3 = Anaesthetic code (OA)
. 4 = Age
.
GPDQ1700  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,OPDACLIN,OPDAANAE,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,KEY6,OPDACLIN,OPDAANAE,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,OPDACLIN,OPDAANAE,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,OPDACLIN,OPDAANAE,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,OPDACLIN,OPDAANAE,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 18 ********
.
. Variables
. 1 = Ward        
. 2 = Diet Code (DC)
. 3 = Age              
.
GPDQ1800  
.         LOAD      CCGDCOD1,CCPADCD1,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGDCOD2,CCPADCD2,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD1,CCPAPCD1,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD2,CCPAPCD2,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD3,CCPAPCD3,TWARD,CTCODIET,AGEFIELD            
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 19 ********
.
. Variables
. 1 = Ward        
. 2 = Diet Code (DC)
. 3 = Age              
.
GPDQ1900 
.         LOAD      CCGDCOD1,CCPADCD1,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGDCOD2,CCPADCD2,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD1,CCPAPCD1,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD2,CCPAPCD2,TWARD,CTCODIET,AGEFIELD            
.         LOAD      CCGPCOD3,CCPAPCD3,TWARD,CTCODIET,AGEFIELD            
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE
          RETURN
.
.*******  Procedure type 20 ********
.
. Variables
. 1 = Ward
. 2 = Admission Type (A)
. 3 = Bed Type (BT)
. 4 = Stepdown Range
.
GPDQ2000  LOAD      CCGDCOD1,CCPADCD1,TWARD,TATYPE,TRBTYP,STEPDFLD
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TATYPE,TRBTYP,STEPDFLD
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TATYPE,TRBTYP,STEPDFLD
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TATYPE,TRBTYP,STEPDFLD
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TATYPE,TRBTYP,STEPDFLD
          RETURN
.
.*******  Procedure type 21 ********
.
. Variables
. 1 = Ward
. 2 = Miscellaneous Charge  
.
GPDQ2100  LOAD      CCGDCOD1,CCPADCD1,TWARD,TITEMNO
          LOAD      CCGDCOD2,CCPADCD2,TWARD,TITEMNO
          LOAD      CCGPCOD1,CCPAPCD1,TWARD,TITEMNO
          LOAD      CCGPCOD2,CCPAPCD2,TWARD,TITEMNO
          LOAD      CCGPCOD3,CCPAPCD3,TWARD,TITEMNO
          RETURN
.
.*******  Procedure type 22 ********
.
. Variables
. 1 = Theatre code
. 2 = Miscellaneous Charge  
.
GPDQ2200  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
.
          LOAD      CCGDCOD1,CCPADCD1,KEY6,TITEMNO
          LOAD      CCGDCOD2,CCPADCD2,KEY6,TITEMNO
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,TITEMNO
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,TITEMNO
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,TITEMNO
.
GPDQ2240  RETURN
.
.*******  Procedure type 23 ********
.
. Variables
. 1 = Theatre code
. 2 = MBS Item number       
.
GPDQ2300  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,MBSCODE
          LOAD      CCGDCOD2,CCPADCD2,KEY6,MBSCODE
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,MBSCODE
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,MBSCODE
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,MBSCODE
.
GPDQ2340  RETURN
.
.*******  Procedure type 24 ********
.
. Variables
. 1 = Theatre code
. 2 = Theatre Banding code  
.
GPDQ2400  PACK      OPDATHET,OPDATHET,SP6
          MOVE      OPDATHET,KEY6
          MATCH     SP6,OPDATHET
          IF        @EQUAL
            MOVE      OPSETHET,KEY6
          ENDIF
          LOAD      CCGDCOD1,CCPADCD1,KEY6,BAND
          LOAD      CCGDCOD2,CCPADCD2,KEY6,BAND
          LOAD      CCGPCOD1,CCPAPCD1,KEY6,BAND
          LOAD      CCGPCOD2,CCPAPCD2,KEY6,BAND
          LOAD      CCGPCOD3,CCPAPCD3,KEY6,BAND

GPDQ2440  RETURN
.
.*******  Procedure type 25 ********
.
GPDQ2500  RETURN
.
.*******  Procedure type 26 ********
.
.Variables
. 1 = site
. 2 = Clinic Id
. 3 = Clinic Indicator    (CI)
. 4 = Visit Type          (CV)
. 5 = Clinic Type
. 6 = Age
. 7 = Non-Attendance code (CA)
.
GPDQ2600  LOAD      CCGDCOD1,CCPADCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBAATTN
          LOAD      CCGDCOD2,CCPADCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBAATTN
          LOAD      CCGPCOD1,CCPAPCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBAATTN
          LOAD      CCGPCOD2,CCPAPCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBAATTN
          LOAD      CCGPCOD3,CCPAPCD3,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OBAATTN
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,ONE,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,TWO,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,THREE,UAGEPROC
          RETURN
.
.*******  Procedure type 27 ********
.
.Variables
. 1 = site
. 2 = Clinic Id
. 3 = Clinic Indicator  (CI)
. 4 = Clinic Type
. 5 = Age
. 6 = Cancellation code (CB)
.
GPDQ2700  LOAD      CCGDCOD1,CCPADCD1,OBASITE,OBACLIN,OMACIND,OBACTYP:
                                      AGEFIELD,OPCNREAS
          LOAD      CCGDCOD2,CCPADCD2,OBASITE,OBACLIN,OMACIND,OBACTYP:
                                      AGEFIELD,OPCNREAS
          LOAD      CCGPCOD1,CCPAPCD1,OBASITE,OBACLIN,OMACIND,OBACTYP:
                                      AGEFIELD,OPCNREAS
          LOAD      CCGPCOD2,CCPAPCD2,OBASITE,OBACLIN,OMACIND,OBACTYP:
                                      AGEFIELD,OPCNREAS
          LOAD      CCGPCOD3,CCPAPCD3,OBASITE,OBACLIN,OMACIND,OBACTYP:
                                      AGEFIELD,OPCNREAS
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,ONE,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,TWO,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,THREE,UAGEPROC
          RETURN
.
.*******  Procedure type  29 ********
.
.Variables
. 1 = Discharge Status         (ED)
. 2 = Situation Code           (ES)
. 3 = Location code indicator  (A1)
. 4 = Age
. 5 = Doctor
.
GPDQ2900  LOAD      CCGDCOD1,CCPADCD1,ADSDISC,ADASIT,ADAUSR1,AGEFIELD,ADADOCT
          LOAD      CCGDCOD2,CCPADCD2,ADSDISC,ADASIT,ADAUSR1,AGEFIELD,ADADOCT
          LOAD      CCGPCOD1,CCPAPCD1,ADSDISC,ADASIT,ADAUSR1,AGEFIELD,ADADOCT
          LOAD      CCGPCOD2,CCPAPCD2,ADSDISC,ADASIT,ADAUSR1,AGEFIELD,ADADOCT
          LOAD      CCGPCOD3,CCPAPCD3,ADSDISC,ADASIT,ADAUSR1,AGEFIELD,ADADOCT
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,ONE,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,TWO,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,THREE,UAGEPROC
          RETURN
.
.******  Procedure Type 33 *******
.
GPDQ3300  
GPDQ3399  RETURN
.
.******  Procedure Type 34 *******
.
GPDQ3400  
GPDQ3499  RETURN
.
.******  Procedure Type 35 *******
.
GPDQ3500  
GPDQ3599  RETURN
.
.******  Procedure Type 36 *******
. Variables
. 1 = Dependency Category
. 2 = Ward
.
GPDQ3600  LOAD      CCGDCOD1,CCPADCD1,DPPCCATG,TWARD                         
          LOAD      CCGDCOD2,CCPADCD2,DPPCCATG,TWARD                         
          LOAD      CCGPCOD1,CCPAPCD1,DPPCCATG,TWARD                         
          LOAD      CCGPCOD2,CCPAPCD2,DPPCCATG,TWARD                         
          LOAD      CCGPCOD3,CCPAPCD3,DPPCCATG,TWARD                         
GPDQ3699  RETURN
.      
.*******  Procedure type  37 ********
.
. Variables
. 1 = Ward
. 2 = Age
.
GPDQ3700  LOAD      CCGDCOD1,CCPADCD1,SAVWARD,AGEFIELD
          LOAD      CCGDCOD2,CCPADCD2,SAVWARD,AGEFIELD
          LOAD      CCGPCOD1,CCPAPCD1,SAVWARD,AGEFIELD
          LOAD      CCGPCOD2,CCPAPCD2,SAVWARD,AGEFIELD
          LOAD      CCGPCOD3,CCPAPCD3,SAVWARD,AGEFIELD
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,TWO       
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,ONE       
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,TWO       
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,THREE
          RETURN            
.
.*******  Procedure type 38 ********
.
. Variables
. 1 = Ward
. 2 = Attending Doctor
. 3 = Age
. 4 = Department (A)
.
GPDQ3800  LOAD      CCGDCOD1,CCPADCD1,SAVWARD,SAVDOCT,AGEFIELD,SAVATYPE
          LOAD      CCGDCOD2,CCPADCD2,SAVWARD,SAVDOCT,AGEFIELD,SAVATYPE
          LOAD      CCGPCOD1,CCPAPCD1,SAVWARD,SAVDOCT,AGEFIELD,SAVATYPE
          LOAD      CCGPCOD2,CCPAPCD2,SAVWARD,SAVDOCT,AGEFIELD,SAVATYPE
          LOAD      CCGPCOD3,CCPAPCD3,SAVWARD,SAVDOCT,AGEFIELD,SAVATYPE
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCPADCD1,UAGEDEPT,UAGEDEPT,ONE,UAGEDEPT
          LOAD      UAGEDEPT,CCPADCD2,UAGEDEPT,UAGEDEPT,TWO,UAGEDEPT
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCPAPCD1,UAGEPROC,UAGEPROC,ONE,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD2,UAGEPROC,UAGEPROC,TWO,UAGEPROC
          LOAD      UAGEPROC,CCPAPCD3,UAGEPROC,UAGEPROC,THREE,UAGEPROC
          RETURN
.
.         have an invalid record where the data is not set up in either
.         the CCIGDPFD or CCIGPRFD or the quantity is zero.
.
GPDQ9900  CALL      PTPF0000                * post to failure temp file
GPDQ9990  MOVE      ONE,EXIT
GPDQ9999  RETURN     
+
.**********************************************************************
.* XCLR0000 : Clear Extra Variables
.**********************************************************************
XCLR0000  MOVE      SP3,UNIQCNT
          UNPACK    SP20,SAVECOD1,SAVECOD2
          UNPACK    SP20,SAVECOD3,SAVECOD4
          MOVE      SP10,CCXDCOD1
          MOVE      SP10,CCXDCOD2
          MOVE      SP10,CCXDCOD3
          MOVE      SP10,CCXPCOD1
          MOVE      SP10,CCXPCOD2
          MOVE      SP10,CCXPCOD3
          MOVE      SP10,CCXPCOD4
          MOVE      SP10,PROCCODE
          MOVE      SP10,DEPTCODE
          MOVE      ZERO,EXIT
          MOVE      ZERO,QUANTITY
          MOVE      ZERO,FORM1           * are we using an age range in the
.                                             key 0 = no , 1 = yes
          MOVE      ZERO,FORM1A
          MOVE      ZERO,UAGEDEPT        * age field number for department
.                                          0,1,2 or 3
          MOVE      ZERO,UAGEPROC        * age field number for procedure
.                                          0,1,2,3 or 4
XCLR9999  RETURN
+
.**********************************************************************
.* XPDQ0000  get the procedure and the department and quantity 
.*           for the O/P extra screen (procedure type 25).  
.* parameters: Parameter Record (CCXIPAFD)
.**********************************************************************
XPDQ0000  CALL      XCLR0000                 * Clear variables 
.
          COMPARE   ZERO,CCXAAUTO
          GOTO      XPDQ9990 IF EQUAL       * not an auto extract
.
          CALL      FAGE0000                * format the age field
.
.--- open OUTXSCFD with prefix
.
          MOVE      ZERO,OVRCD
          PACK      CFNAME,OSTFILE,FILXSCA1
          RESET     CFNAME
          TRAP      OVERCOND IF IO
          OPEN      OUTXSCA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,XPDQ9990
.
          PACK      KEY8,OBAOUTNO,SP8
          CALL      RDOTXSC1
          BRANCH    OVRCD,XPDQ9990          * no extra screen record

.*******  Procedure type  25 ********
.
.Variables
. 1 = site
. 2 = Clinic Id
. 3 = Clinic Indicator (CI)
. 4 = Visit Type       (CV)
. 5 = Clinic Type
. 6 = Age
. 7 = Code 1 ... 26 = Code 20
.27 = Doctor Code 1 ... 29 = Doctor Code 3 
.30 = Amount 1  (not used here)
.31 = Amount 2  (not used here)
.
.
          LOAD      CCXDCOD1,CCXADCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXDCOD2,CCXADCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXDCOD3,CCXADCD3,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXPCOD1,CCXAPCD1,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXPCOD2,CCXAPCD2,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXPCOD3,CCXAPCD3,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
          LOAD      CCXPCOD4,CCXAPCD4,OBASITE,OBACLIN,OMACIND,OBAVISIT:
                                      OBACTYP,AGEFIELD,OTXSCO01,OTXSCO02:
                                      OTXSCO03,OTXSCO04,OTXSCO05,OTXSCO06:
                                      OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                                      OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14:
                                      OTXSCO15,OTXSCO16,OTXSCO17,OTXSCO18:
                                      OTXSCO19,OTXSCO20,OTXSDOC1,OTXSDOC2:
                                      OTXSDOC3
.
.------   Are we using age in the department ------
.
          LOAD      UAGEDEPT,CCXADCD1,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,ONE       
          LOAD      UAGEDEPT,CCXADCD2,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,TWO       
          LOAD      UAGEDEPT,CCXADCD3,UAGEDEPT,UAGEDEPT,UAGEDEPT,UAGEDEPT:
                                      UAGEDEPT,THREE
.
.------   Are we using age in the procedure  ------
.
          LOAD      UAGEPROC,CCXAPCD1,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,ONE       
          LOAD      UAGEPROC,CCXAPCD2,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,TWO       
          LOAD      UAGEPROC,CCXAPCD3,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,THREE
          LOAD      UAGEPROC,CCXAPCD4,UAGEPROC,UAGEPROC,UAGEPROC,UAGEPROC:
                                      UAGEPROC,FOUR
.
. ------- have all the required values for each code -------
.
          PACK      CCXDCOD1,CCXDCOD1,SP10
          PACK      CCXDCOD2,CCXDCOD2,SP10
          PACK      CCXDCOD3,CCXDCOD3,SP10
          PACK      CCXPCOD1,CCXPCOD1,SP10
          PACK      CCXPCOD2,CCXPCOD2,SP10
          PACK      CCXPCOD3,CCXPCOD3,SP10
          PACK      CCXPCOD4,CCXPCOD4,SP10
.
. ------- get the department translation -------
.
          MOVE      ONE,ERDEPPRO            * set to department error
          PACK      KEY13,DEFPRID,CCXASCID,CCXAUNIQ
          PACK      KEY40,KEY13,CCXDCOD1,CCXDCOD2,CCXDCOD3
          CALL      RDCCXGD1
          IF        OVRCD = 1
            MOVE      CCXDCOD1,SAVECOD1     * save the current codes
            MOVE      CCXDCOD2,SAVECOD2
            MOVE      CCXDCOD3,SAVECOD3
            MOVE      SP9,SAVECOD4
            IF        UAGEDEPT = 0
              MOVE      ONE,EXIT            * no record and we are not using
              GOTO      XPDQ9900             an age range so exit
            ENDIF
            CALL      RKCCGDP1              * read next department record
            IF        OVRCD = 1
              MOVE      ONE,EXIT            * no record so exit
              GOTO      XPDQ9900
            ENDIF
            IF        UAGEDEPT = 2          
              MATCH     SAVECOD1,CCXDCOD1   * 2nd field is "age" so test
.                                             the first field is the same
              IF        !@EQUAL
                MOVE      ONE,EXIT          * 1st field not the same exit
                GOTO      XPDQ9900
              ENDIF
            ENDIF
          ENDIF
.
. ------- get the procedure translation -------
.
          MOVE      TWO,ERDEPPRO            * set to procedure error
          PACK      KEY13,DEFPRID,CCXASCID,CCXAUNIQ
          PACK      KEY49,KEY13,CCXPCOD1,CCXPCOD2,CCXPCOD3,CCXPCOD4
          CALL      RDCCXGP1
          IF        OVRCD = 1 
            MOVE      CCXPCOD1,SAVECOD1     * save the current codes
            MOVE      CCXPCOD2,SAVECOD2
            MOVE      CCXPCOD3,SAVECOD3
            MOVE      CCXPCOD4,SAVECOD4
            IF        UAGEPROC = 0
              MOVE      ONE,EXIT            * We have no record and are not 
              GOTO      XPDQ9900              using an age range so exit
            ENDIF
            CALL      RKCCXGP1              * read next procedure record
            IF        OVRCD = 1
              MOVE      ONE,EXIT            * no record so exit
              GOTO      XPDQ9900
            ENDIF
            IF        UAGEPROC = 2
              MATCH     SAVECOD1,CCXPCOD1   * age is 2nd field so test that
.                                             1st field is the same
              IF        !@EQUAL
                MOVE      ONE,EXIT          * not equal so exit
                GOTO      XPDQ9900
              ENDIF
            ENDIF
            IF        UAGEPROC = 3
              PACK      DIM18,SAVECOD1,SAVECOD2
              PACK      DIM18A,CCXPCOD1,CCXPCOD2
              MATCH     DIM18,DIM18A        * age is 3rd field so test that the 
.                                             first two fields are the same
              IF        !@EQUAL
                MOVE      ONE,EXIT          * not the same so exit
                GOTO      XPDQ9900
              ENDIF
            ENDIF
          ENDIF
.
. ------- see if there is a quantity -------
.
          MOVE      THREE,ERDEPPRO          * set to quantity error
          IF        CCXPQNTY = 0
            MOVE      ONE,EXIT                * quantity=0 so don't extract
            GOTO      XPDQ9900
          ELSE
            IF          CCXPQNTY = 1
              MOVE        CCXPQNTY,QUANTITY   * use default quantity
              GOTO        XPDQ0400
            ELSE
              CALL        XSPE0000            * handle special cases
            ENDIF
          ENDIF
                             
XPDQ0400  PACK      DEPTCODE,CCXDDEPT,SP10
          PACK      PROCCODE,CCXPPROC,SP10
          MOVE      ZERO,EXIT
          GOTO      XPDQ9999
.
.         have an invalid record where the data is not set up in either
.         the CCIXDPFD or CCIXGPFD or the quantity is zero.
.
XPDQ9900  MOVE      TWENTY5,CCPATYPE        * set procedure type
          CALL      PTPF0000                * post to failure temp file
XPDQ9990  MOVE      ONE,EXIT
XPDQ9999  RETURN     
+
.********************************************************************
.*                       FAGE0000                                   *
.*                 Format the age field                             *
.********************************************************************
FAGE0000  PACK      AGEFIELD,PSAGE,ANSY,SP5
FAGE9999  RETURN
+
.********************************************************************
.*                       CDUR0000                                  
.*       Calculate the duration between required times              
.*       NOTE : procedure type 12 uses a Post Op time as its From Time
.*       NOTE : procedure type 32 uses a Pre  Op time as its To   Time
.********************************************************************
CDUR0000  MOVE      ZERO,QUANTITY
.
. ******* set up the FROM time *******
.
          MATCH     ANSP,FROMTYPE           * is it a Pre-Op time
          IF        @EQUAL
.
. ------- Recovery procedure use post-op times as "from time" -------
.
            IF        CCPATYPE = 12
              LOAD      FROMTIME,FROMNUMB,OPDAPOS1,OPDAPOS2,OPDAPOS3,OPDAPOS4
            ELSE 
              LOAD      FROMTIME,FROMNUMB,OPDAPRE1,OPDAPRE2,OPDAPRE3:
                                          OPDAPRE4,OPDAPRE5
            ENDIF
          ELSE
            LOAD      FROMTIME,FROMNUMB,OPDCOTM1,OPDCOTM2,OPDCOTM3:
                                        OPDCOTM4
          ENDIF
.
. ******* set up the TO time *******
.
          MATCH     ANSP,TOTYPE             * is it a Post Op time
          IF        @EQUAL
.
. ------- Waiting Time procedure uses Pre-Op time as TO time -------
.
            IF        CCPATYPE = 32
              LOAD      TOTIME,TONUMB,OPDAPRE1,OPDAPRE2,OPDAPRE3:
                                      OPDAPRE4,OPDAPRE5
            ELSE
              LOAD      TOTIME,TONUMB,OPDAPOS1,OPDAPOS2,OPDAPOS3,OPDAPOS4
            ENDIF
          ELSE
            LOAD      TOTIME,TONUMB,OPDCOTM1,OPDCOTM2,OPDCOTM3,OPDCOTM4
          ENDIF
.
.******* Test if the from time or to time is blank and if so *******
.******* exit with quantity still set to zero                *******
.
          PACK        FROMTIME,FROMTIME,SP5
          MATCH       SP5,FROMTIME
          GOTO        CDUR9999 IF EQUAL
.
          PACK        TOTIME,TOTIME,SP5
          MATCH       SP5,TOTIME
          GOTO        CDUR9999 IF EQUAL
.
.******* Unpack the from time and the to time and move them to *****
.******* numeric fields for the calculation                    *****
.
          UNPACK      FROMTIME,DIM2,DIM1,DIM2A  
          MOVE        DIM2,FROMHOUR
          MOVE        DIM2A,FROMMIN
          UNPACK      TOTIME,DIM2,DIM1,DIM2A
          MOVE        DIM2,TOHOUR
          MOVE        DIM2A,TOMIN
.
.******* If the totime is less than the from time then assume that *****
.******* the duration has run over midnight.                       *****
.
          MATCH       FROMTIME,TOTIME
          IF          @LESS               
            ADD         "24",TOHOUR
          ENDIF
.
.******* Calculate the quantity in minutes                        *****
.
          ASSIGN      ((TOHOUR * 60)+ TOMIN)-((FROMHOUR * 60)+ FROMMIN),QUANTITY
.
CDUR9999  RETURN
. 
GDUR0000  MOVE        ZERO,QUANTITY 
          UNPACK      FROMTIME,DIM2,DIM1,DIM2A  
          MOVE        DIM2,FROMHOUR
          MOVE        DIM2A,FROMMIN
          UNPACK      TOTIME,DIM2,DIM1,DIM2A
          MOVE        DIM2,TOHOUR
          MOVE        DIM2A,TOMIN
          ASSIGN      ((TOHOUR * 60)+ TOMIN)-((FROMHOUR * 60)+ FROMMIN),QUANTITY
.
GDUR9999  RETURN
.*********************************************************************
.*                          SPEC0000                                 *
.*                  handle special cases ( for quantity )            *
.*********************************************************************
SPEC0000  IF        CCPATYPE = 8
            UNPACK    CCCN008A,FROMTYPE,DIM1    
            MOVE      DIM1,FROMNUMB
            UNPACK    CCCN008B,TOTYPE,DIM1  
            MOVE      DIM1,TONUMB
            CALL      CDUR0000                * Calculate the duration
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 9 | CCPATYPE = 30
            UNPACK    CCCN009A,FROMTYPE,DIM1    
            MOVE      DIM1,FROMNUMB
            UNPACK    CCCN009B,TOTYPE,DIM1  
            MOVE      DIM1,TONUMB
            CALL      CDUR0000                * Calculate the duration
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 11
            LOAD      QUANTITY,COUNTER,OPDCIMQ1,OPDCIMQ2,OPDCIMQ3:
                                     OPDCIMQ4,OPDCIMQ5,OPDCIMQ6,OPDCIMQ7:
                                     OPDCIMQ8,OPDCIMQ9,OPDCIQ10
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 12
            UNPACK    CCCN012A,FROMTYPE,DIM1    
            MOVE      DIM1,FROMNUMB
            UNPACK    CCCN012B,TOTYPE,DIM1  
            MOVE      DIM1,TONUMB
            CALL      CDUR0000                * Calculate the duration
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 13 | CCPATYPE = 31
            UNPACK    CCCN013A,FROMTYPE,DIM1    
            MOVE      DIM1,FROMNUMB
            UNPACK    CCCN013B,TOTYPE,DIM1  
            MOVE      DIM1,TONUMB
            CALL      CDUR0000                * Calculate the duration
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 21 | CCPATYPE = 22
            IF        TSERVS <= 0
              MOVE      ONE,QUANTITY
            ELSE
              MOVE      TSERVS,QUANTITY
            ENDIF
          ENDIF
          IF        CCPATYPE = 32
            UNPACK    CCCN032A,FROMTYPE,DIM1    
            MOVE      DIM1,FROMNUMB
            UNPACK    CCCN032B,TOTYPE,DIM1  
            MOVE      DIM1,TONUMB
            CALL      CDUR0000                * Calculate the duration
            GOTO      SPEC9999
          ENDIF
          IF        CCPATYPE = 36 
            MOVE      DPPCTOTL,QUANTITY
          ENDIF
          IF        CCPATYPE = 37 | CCPATYPE = 38
            MOVE      SAVTIME,FROMTIME
            MOVE      TTIME,TOTIME
            CALL      GDUR0000
          ENDIF
.
SPEC9999  RETURN
+
.*********************************************************************
.* XSPE0000 : handle special cases (for quantity )  
.*            for the O/P extra screen details
.*********************************************************************
XSPE0000
.---      if CCXAQTYV is a codes file entry, use associated number;
.---      if numeric, use it's value;
.---      else use "1"
.
.
.*******  Procedure type  25 ********
.
.Variables
. 1 = Site
. 2 = Clinic Id
. 3 = Clinic Indicator                       (codes file entry)
. 4 = Visit Type                             (codes file entry)
. 5 = Clinic Type
. 6 = Age
. 7 = Code 1 ... 26 = Code 20                (Codes file entrys)
.27 = Doctor Code 1 ... 29 = Doctor Code 3   
.30 = Amount 1                               (Numeric)
.31 = Amount 2                               (Numeric)
.
.----- branch off depending if a codes file entry, numeric or other.
.
          BRANCH    CCXAQTYV,XSPE2000,XSPE2000,XSPE1300,XSPE1300,XSPE2000:
                             XSPE2000,XSPE1300,XSPE1300,XSPE1300,XSPE1300:
                             XSPE1300,XSPE1300,XSPE1300,XSPE1300,XSPE1300:
                             XSPE1300,XSPE1300,XSPE1300,XSPE1300,XSPE1300:
                             XSPE1300,XSPE1300,XSPE1300,XSPE1300,XSPE1300:
                             XSPE1300,XSPE2000,XSPE2000,XSPE2000,XSPE3000:
                             XSPE3100
.
          GOTO      XSPE2000                 * unknown variable number
.
.--- set up categories for codes file entries
XSPE1300  PACK      CAT,SP2
          PACK      KEY6,OBASITE             * site from boka record
          CALL      RDOTSIP1
          LOAD      CAT,CCXAQTYV,SP2,SP2,CATCI,CATCV,SP2,SP2:
                                 OTSPXC01,OTSPXC02,OTSPXC03,OTSPXC04:
                                 OTSPXC05,OTSPXC06,OTSPXC07,OTSPXC08:
                                 OTSPXC09,OTSPXC10,OTSPXC11,OTSPXC12:
                                 OTSPXC13,OTSPXC14,OTSPXC15,OTSPXC16:
                                 OTSPXC17,OTSPXC18,OTSPXC19,OTSPXC20 
.
.--- now set up code
.
          LOAD      DIM3,CCXAQTYV,SP2,SP2,OMACIND,OBAVISIT,SP2,SP2:
                                 OTXSCO01,OTXSCO02,OTXSCO03,OTXSCO04:
                                 OTXSCO05,OTXSCO06,OTXSCO07,OTXSCO08:
                                 OTXSCO09,OTXSCO10,OTXSCO11,OTXSCO12:
                                 OTXSCO13,OTXSCO14,OTXSCO15,OTXSCO16:
                                 OTXSCO17,OTXSCO18,OTXSCO19,OTXSCO20
.
XSPE1900  PACK      KEY5,CAT,DIM3,SP5
          CALL      RDCODE1
          BRANCH    OVRCD,XSPE1990           * not found
          MOVE      TCFORM6,QUANTITY
          GOTO      XSPE9999
XSPE1990  MOVE      ZERO,QUANTITY
          GOTO      XSPE9999
.
XSPE2000
.--- not a codes file entry or numeric
          MOVE      ONE,QUANTITY
          GOTO      XSPE9999
.
XSPE3000 
.--- Numeric, Set quantity to corresponing numeric value.
.
          MOVE      OTXSAMT1,QUANTITY
          GOTO      XSPE9999
XSPE3100
          MOVE      OTXSAMT2,QUANTITY
          GOTO      XSPE9999
.
XSPE9999  RETURN 
+
.
.*********************************************************************
. CALC :  CALCULATE DATES DIFFERENCE
.         Returns: NBRDAYS = Number of days between dates
.*********************************************************************
.
CALC      DAYSEP    WDATE2,WDATE1,NBRDAYS
.
          RETURN
+
.***************************************************************************
.*                      Temp File I/O Routines                             *
.***************************************************************************
.
RDATEMP1  RESET     KEY3
          MOVE      ZERO,OVRCD
          READ      TEMP1,KEY3;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDSTEMP1  RESET     KEY3
          READ      TEMP1,KEY3;;
          RETURN
.
RDKTEMP1  MOVE      ZERO,OVRCD
          READKS    TEMP1;OSTFILE
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   RESET     KEY3
          WRITE     TEMP1,KEY3;OSTFILE
          RETURN
...............................................................................
.*********************************************************************
.         print the reports
.*********************************************************************
REPT0000  COMPARE   ZERO,SUMMFULL
          GOTO      REPT9999 IF EQUAL       * not doing reporting
.
          MOVE      ONE,REPTTYPE            * do failure report
          PACK      KEY40,SP20,SP20
          READ      TEMPF,KEY40;;
.
REPT1000  READKS    TEMPF;KEY3,KEY1,SAVECOD1,SAVECOD2,SAVECOD3,SAVECOD4
          GOTO      REPT5000 IF OVER
.
          MOVE      KEY3,CCPATYPE           * set the procedure type
          MOVE      KEY1,ERDEPPRO           * set the error type
          CALL      PLIN0000
          GOTO      REPT1000
.
REPT5000  CALL      UND80
          PRINT     *N,"Total number of failed records : ",CNTFAIL
.
          COMPARE   TWO,SUMMFULL
          GOTO      REPT9995 IF NOT EQUAL   * not doing full reporting
.
          MOVE      "70",CLNO               * do a new page
          MOVE      TWO,REPTTYPE            * do success report
          PACK      KEY42,SP30,SP20
          READ      TEMPS,KEY42;;
.
REPT6000  READKS    TEMPS;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                          XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                          XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
          GOTO      REPT9000 IF OVER
          MOVE      DXSBATN,XSBATN
.
          CALL      PLIN0000
          GOTO      REPT6000
.
REPT9000  CALL      UND80
          PRINT     *N,"Total number of successful records : ",CNTSUCC
.
REPT9995  PRINT     *N,"*** End of Report ***",*N
.
REPT9999  RETURN
+
.*********************************************************************
.         print a page header
.*********************************************************************
HEAD0000  CALL      HEAD80
.
          IF        REPTTYPE = ONE
            PRINT     *20,"Invalid records from Extract."
            CALL      UND80
            PRINT     *1,"| Proc Type | Type of Error        |":
                         " Variables                                 |"
            CALL      UND80
            ADD       TWO,CLNO
          ELSE
            PRINT     *20,"Records successfully extracted."
            CALL      UND80
            PRINT     *1,"| U/R no.  | Event    | Type |    Date    ":
                         "| Department | Procedure | Quantity  |"
            ADD       TWO,CLNO
            CALL      UND80
          ENDIF
.
HEAD9999  RETURN
+
.*********************************************************************
.         print a line of the report
.*********************************************************************
PLIN0000  COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS    * print a new page
.
          BRANCH    REPTTYPE,PLIN5000       * do failure line
.
. ------- success report -------
.
          MOVE      SP4,CCDTCSDP
          MOVE      XSDEPT,KEY3
          CALL      RDCCDPT1
          UNPACK    XSDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *1,"| ",XSURNO," | ",XSEVNT," | ",XSPTYP," | ":
                    CPCDATE," | ",XSDEPT," = ",CCDTCSDP," | ",XSPROC:
                    "   | ",XSQUNT,"  |"
          ADD       ONE,CLNO
          GOTO      PLIN9999
.
. ------- failure report -------
.
PLIN5000  IF        ERDEPPRO = ONE
            MOVE      "No Department Transln",KEY20
          ENDIF
          IF        ERDEPPRO = TWO
            MOVE      "No Procedure Transln",KEY20
          ENDIF
          IF        ERDEPPRO = THREE
            MOVE      "No Quantity         ",KEY20
          ENDIF
          PRINT     *1,"|   ",CCPATYPE,*13,"| ",KEY20," | ":
                    SAVECOD1,"*",SAVECOD2,"*",SAVECOD3,"*",SAVECOD4,"*  |"
          ADD       ONE,CLNO
.
PLIN9999  RETURN
+
.*********************************************************************
.         post a record to the failure temp file
.*********************************************************************
PTPF0000  COMPARE   ZERO,SUMMFULL
          GOTO      PTPF9999 IF EQUAL       * not doing reporting
.
          MOVE      CCPATYPE,XFPTYP         * procedure type
          MOVE      ERDEPPRO,XFETYP         * error type
          PACK      KEY40,XFPTYP,XFETYP,SAVECOD1,SAVECOD2,SAVECOD3,SAVECOD4
          READ      TEMPF,KEY40;ANS
          GOTO      PTPF9999 IF NOT OVER
          WRITE     TEMPF,KEY40;KEY40
          ADD       ONE,CNTFAIL             * add to failure counter
.
PTPF9999  RETURN
+
.*********************************************************************
.         post a record to the success temp file
.*********************************************************************
.
PTPS0000  ADD       ONE,CNTSUCC
          READ      TEMPS,KEY42;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                               XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                               XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
.
          IF        @OVER
            PACK      XSSPAR,SP20,SP20
            MOVE      ZERO,XSBATN
            MOVE      QUANTITY,XSQUNT
            MOVE      CCUTPTYP,XSPTYP
.
.           SRF 643603 - Mods to set fiscal year and period from service date
.
            MOVE      XSDATE,CPTDATE
            CALL      GPERD
            IF        EXIT = 0
              MOVE      DRGYR,XSFSYR
              MOVE      DRGNUM,XSFSPR
            ELSE
              MOVE      SP4,XSFSYR
              MOVE      SP2,XSFSPR
            ENDIF
.
            MOVE      SP30,XSCOMM
            MOVE      TPATAMTT,XSCHRG
            MOVE      CCPATYPE,XSORIG
            MOVE      ANSN,XSSENT
            MOVE      SP1,XSHPRE
            MOVE      ZERO,XSSIBA
            MOVE      XSBATN,DXSBATN
            MOVE      ORDDOCT,XSORDD
            WRITE     TEMPS,KEY42;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                                  XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                                  XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
          ELSE
            MOVE      DXSBATN,XSBATN
            ADD       QUANTITY,XSQUNT
            ADD       TPATAMTT,XSCHRG
            UPDATE    TEMPS;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                            XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                            XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
          ENDIF
.
PTPS9999  RETURN
+
.*********************************************************************
.         Create a temp file
.*********************************************************************
CTPF0000  CALL      DTPF0000                * delete temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISBUILD,CFNAMEF,KEYF,SP30      * set command
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * build the temp file
          OPEN      TEMPF,CFNAMEF           * open the temp file
.
CTPF9999  RETURN
+
.*********************************************************************
.         Delete temp file F
.*********************************************************************
DTPF0000  CLOSE     TEMPF                   * close temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISERASE,CFNAMEF * set command line for erase
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * delete the temp file
.
DTPF9999  RETURN
+
.*********************************************************************
.         Create a temp file
.*********************************************************************
CTPS0000  CALL      DTPS0000                * delete temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISBUILD,CFNAMES,KEYS,SP30      * set command
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * build the temp file
          OPEN      TEMPS,CFNAMES           * open the temp file
.
CTPS9999  RETURN
+
.*********************************************************************
.         Delete temp file S
.*********************************************************************
DTPS0000  CLOSE     TEMPS                   * close temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISERASE,CFNAMES * set command line for erase
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * delete the temp file
.
DTPS9999  RETURN
+
.*********************************************************************
.         maintain the cciutlaf file
.         Para's  : KEY42              the key for cciutlaf
.                   QUANTITY           the quantity
.                   TPATAMTT           the charge
.                   CCPATYPE           the Procedure Type Number
.*********************************************************************
.
MUTL0000  UNPACK    KEY42,XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,DXSBATN
.
.          post to success temp file
.
MUTL9000  CALL      PTPS0000
.
MUTL9999  RETURN
+
.****************************************************************************
.*                            PROC0000                                      *
.*                   Process all the temp file records                      *
.****************************************************************************
.
.         Loop through the temp file records
.
PROC0000  PACK      KEY42,SP20,SP20,SP2
          READ      TEMPS,KEY42;;
PROC0500  READKS    TEMPS;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                          XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                          XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
          GOTO      PROC9999 IF OVER
          MOVE      DXSBATN,XSBATN
.
.         See if the record is on the utl file
.
          PACK      KEY42,XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSBATN
          CALL      RDCCUTL1                     * record on file ?
          IF        OVRCD = 0
            MATCH     ANSN,CCUTSENT              * yes - already handed over ?
            GOTO      PROC5000 IF NOT EQUAL      * yes - ignore
.
            MATCH     "1",CCUTSIBA               * already handed over ?
            GOTO      PROC5000 IF EQUAL          * yes - ignore 
          ENDIF
.
          MOVE      XSQUNT,CCUTQUNT
          MOVE      XSPTYP,CCUTPTYP
          MOVE      XSFSYR,CCUTFSYR
          MOVE      XSFSPR,CCUTFSPR
          MOVE      XSCOMM,CCUTCOMM
          MOVE      XSSENT,CCUTSENT
          MOVE      XSCHRG,CCUTCHRG
          MOVE      XSORIG,CCUTORIG
          MOVE      XSHPRE,CCUTHPRE
          MOVE      XSSIBA,CCUTSIBA
          MOVE      XSORDD,CCUTORDD
          IF        OVRCD = 0
            CALL      UPCCUTL1                   * update record
          ELSE
            UNPACK    KEY42,CCUTDATE,CCUTDEPT,DCCUTEVN,CCUTPROC,CCUTURNO:
                            DCCUTBAT
            MOVE      DCCUTEVN,CCUTEVNT
            MOVE      DCCUTBAT,CCUTBATN
            MOVE      SP1,CCUTSERV
            CALL      WRCCUTL1                   * write new utl record
          ENDIF
.
          GOTO      PROC0500                     * get next temp file record
.
.         This record should be ignored as it has already been handed
.         over, so should not appear in success report
.
PROC5000  PACK      SAVKEY42,XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSBATN
          DELETE    TEMPS,KEY42                  * delete temp file record
          SUB       ONE,CNTSUCC                  * update success count
.
.         Reposition in temp file for next record
.
          MOVE      SAVKEY42,KEY42
          READ      TEMPS,KEY42;XSDATE,XSDEPT,XSEVNT,XSPROC,XSURNO,XSQUNT:
                               XSPTYP,XSFSYR,XSFSPR,XSCOMM,XSSENT,DXSBATN:
                               XSCHRG,XSORIG,XSHPRE,XSSIBA,XSORDD,XSSPAR
          GOTO      PROC0500                     * get next temp file record
.
PROC9999  RETURN
+
.*******************************************************************************
.         Move ptmimtiaf to patdtraf fields
.*******************************************************************************
MTDT0000  MOVE      PMMIVISN,TADMNO
          MOVE      PMMIITEM,TITEMNO
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          MOVE      PMMIRTYP,TRECTYPE
          MOVE      PMMIAMTT,TPATAMTT
          MOVE      PMMISERV,TSERVS
MTDT9999  RETURN
+
.*******************************************************************************
.
