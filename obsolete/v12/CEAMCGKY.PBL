.---------------------------------------------------------------------------
.   System    :   Patient System (New Standards)     
.   Include   :   CEAMCGKY
.   Routine   :   KPMCHA00 Keyin Misc. Charge Code   
.   Parameter :   CKEYTYP 0 = Keyin , 1 = Accept, 2 = Either
.   Return    :   EXIT = 1 null entry, 2 EXITCHAR entered
.   Mods.     :
.       V10.01.01 16/12/2010  Mike Laming   CAR 233046
.                 Mods to Misc.Charges PATMCHFD - Key change, logic changes
.       V10.00.01 29/04/2010  J.Tan        CAR 220887 
.                 Checking for Active/Inactive of Misc.charge 
.       V9.03.01  19/09/2003 Lina Vo
.                 Changed index and read of patmchgf.
.-------------------------------------------------------------------------------
KPMCHA00  TOPIC     "MCHARGE "
          MOVE      UNDLN70,MCHARGE 
          KEYIN     *PCCOL:CVERT,*DV,MCHARGE:                                   
                    *PCCOL:CVERT,*V2LON,MCHARGE:                                
                    *PCCOL:CVERT,*DV,MCHARGE 
.
          ENDSET    MCHARGE 
          APPEND    SP70,MCHARGE 
          RESET     MCHARGE 
.
          MOVE      MCHARGE,KEY9                 * save original misc charge
.
          MATCH     SP70,MCHARGE 
          GOTO      KPMCHA90 IF EQUAL            * input blank
.
          CMATCH    EXITCHAR,MCHARGE             * input exit (/)
          GOTO      KPMCHA95 IF EQUAL
.
          CMATCH    QUEST,MCHARGE                * input code
          GOTO      KPMCHA10 IF NOT EQUAL
.
          MOVE      CCITEM,SCCITEM
          CALL      HPMCHA00                     * input ?
          MOVE      SCCITEM,CCITEM
.
          ENDSET    MCHARGE 
          APPEND    SP70,MCHARGE 
          RESET     MCHARGE 
.
          MATCH     SP70,MCHARGE 
          GOTO      KPMCHA00 IF EQUAL
.
          DISPLAY   *PCCOL:CVERT,*V2LON,MCHARGE                                 
.
.         Validate Misc Charge Code
.
KPMCHA10  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          PACK      KEY29,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,CURRDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      KPMCHA60 IF EQUAL
          GOTO      KPMCHA80                * invalid (inactive or out of date)
.
KPMCHA60  BRANCH    CKEYTYP,KPMCHA75
KPMCHA70
          MOVE      ZERO,EXIT
          GOTO      KPMCHA99
KPMCHA75
          MOVE      "Misc. Charge Code Already Exist - ",DISPMSG                                     
          CALL      MESSAGE1
          GOTO      KPMCHA00
KPMCHA80
          MOVE      ZERO,EXIT
          BRANCH    CKEYTYP,KPMCHA99,KPMCHA99
          MOVE      "Misc. Charge Code Does Not Exist - ",DISPMSG                                    
          CALL      MESSAGE1
          GOTO      KPMCHA00
KPMCHA90
          MOVE      ONE,EXIT
          GOTO      KPMCHA99
KPMCHA95
          MOVE      TWO,EXIT
KPMCHA99  TOPIC     PRGID
          RETURN
.
.---------------------------------------------------------------------------
.   System    :   Patient System (New Standards)     
.   Include   :   CEAMCGKY
.   Routine   :   HPMCHA00 Misc. Charge Code   
.   Return    :           
.-------------------------------------------------------------------------------
HPMCHA00
          MOVE      ZERO,CSCRSIZ
          IF        HTOP<3
            MOVE      "10",HTOP
            MOVE      "24",HBOT
            MOVE      "40",HLEF
            MOVE      "80",HRIG
          ENDIF
HPMCHA04
          CALL      GSCRN000
          BRANCH    EXIT,HPMCHA99
          MOVE      STDCOL00,STDCOL01
          ADD       " 5",STDCOL01
          DISPLAY   *PSTDCOL01:STDROW,*V2LON,*ULON,"Misc Code"          
.
          MOVE      STDCOL01,STDCOL02
          ADD       "10",STDCOL02
          DISPLAY   *PSTDCOL02:STDROW,*V2LON,*ULON,"Description"        
.
          MOVE      STDCOL02,STDCOL03
          ADD       "31",STDCOL03
.
HPMCHA08  MOVE      ZERO,XITEMNO
          MOVE      MINITEM,STDROW
...       SETLPTR   SAVKEY80,26                                                 
          PACK      KEY21,SP30
          PACK      KEY29,SP30
          CALL      RDSMCHG1 
.
HPMCHA10  CALL      RDKMCHG1 
          BRANCH    OVRCD,HPMCHA15
.
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70
          MATCH     KEY21,KEY21A
          GOTO      HPMCHA15 IF NOT EQUAL                                       
.
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA15 IF EQUAL        * Inactive
.
          BRANCH    CSEARCH,HPMCHA12
          CALL      HPMCHA60
          BRANCH    OVRCD,HPMCHA10
.
HPMCHA12  ADD       ONE,XITEMNO
          ADD       ONE,STDROW
          STORE     KEY26,XITEMNO,ST1,ST2,ST3,ST4,ST5:                          
                                ST6,ST7,ST8,ST9,ST10:
                                ST11,ST12,ST13,ST14,ST15:
                                ST16,ST17
          DISPLAY   *PSTDCOL00:STDROW,SP1,*V2LON,XITEMNO,DOT
          DISPLAY   *PSTDCOL01:STDROW,MCHARGE 
          DISPLAY   *PSTDCOL02:STDROW,MDESC
          COMPARE   MAXITEM,XITEMNO
          GOTO      HPMCHA10 IF NOT EQUAL
HPMCHA15
          UNPACK    KEY21,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE                     
...       UNPACK    SP30,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE                     
          MOVE      ONE,DITEM
          MOVE      MINITEM,DROW
          ADD       ONE,DROW
          DISPLAY   *PSTDCOL00:DROW,*V2LON,*HON,SP1,DITEM,DOT
          CLIP
          FLUSH     HLEF,HTOP,HRIG,HBOT
.
HPMCHA20
          CALL      HSCRI000
          BRANCH    EXIT,HPMCHA30,HPMCHA35,HPMCHA40,HPMCHA45,HPMCHA04:
                              HPMCHA91,HPMCHA50
          GOTO      HPMCHA92
HPMCHA30
          CALL      RDKMCHG1 
          BRANCH    OVRCD,HPMCHA85
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70                   
          MATCH     KEY21,KEY21A                                                
          GOTO      HPMCHA85 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA85 IF EQUAL        * Inactive
.
          CALL      RDPMCHG1 
          MOVE      ZERO,XITEMNO
          MOVE      MINITEM,STDROW
          SUSPEND
          CLIP      1,1,CRIG,24
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          GOTO      HPMCHA10
HPMCHA35
          MOVE      ST1,KEY26
          PACK      KEY34,KEY26,SP70
          CALL      RDMCHG1 
          CALL      RDPMCHG1 
          BRANCH    OVRCD,HPMCHA85
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70
          MATCH     KEY21,KEY21A
          GOTO      HPMCHA85 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA85 IF EQUAL        * Inactive
          MATCH     SP70,MCHARGE                                                
          GOTO      HPMCHA85 IF EQUAL                                           
          SUSPEND
          CLIP      1,1,CRIG,24
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          MOVE      MINITEM,STDROW
          MOVE      MAXITEM,XITEMNO
HPMCHA36
          CALL      RDPMCHG1 
          BRANCH    OVRCD,HPMCHA37
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70                   
          MATCH     KEY21,KEY21A                                             
          GOTO      HPMCHA37 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA37 IF EQUAL        * Inactive
          SUB       ONE,XITEMNO
          COMPARE   ZERO,XITEMNO
          GOTO      HPMCHA36 IF NOT EQUAL
HPMCHA37
          MOVE      ZERO,XITEMNO
          GOTO      HPMCHA10
HPMCHA40
          MOVE      ST1,KEY26
          PACK      KEY34,KEY26,SP70
          CALL      RDMCHG1 
          CALL      RDPMCHG1 
          BRANCH    OVRCD,HPMCHA85
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70
          MATCH     KEY21,KEY21A
          GOTO      HPMCHA85 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA85 IF EQUAL        * Inactive
          SUSPEND
          CLIP      1,1,CRIG,24
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          GOTO      HPMCHA08
HPMCHA45
          CALL      RDKMCHG1 
          BRANCH    OVRCD,HPMCHA85
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70                   
          MATCH     KEY21,KEY21A
          GOTO      HPMCHA85 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA85 IF EQUAL        * Inactive
          SUSPEND
          CLIP      1,1,CRIG,24
.
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          MOVE      ZERO,XITEMNO
          PACK      KEY29,KEY21,Z70                                          
          MOVE      MINITEM,STDROW
          MOVE      MAXITEM,XITEMNO
          CALL      RDSMCHG1 
.
HPMCHA46  CALL      RDPMCHG1 
          BRANCH    OVRCD,HPMCHA47
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70                   
          MATCH     KEY21,KEY21A
          GOTO      HPMCHA47 IF NOT EQUAL                                       
          MATCH     "1",PTMCACTV
          GOTO      HPMCHA47 IF EQUAL        * Inactive
          SUB       ONE,XITEMNO
          COMPARE   ZERO,XITEMNO
          GOTO      HPMCHA46 IF NOT EQUAL
HPMCHA47
          MOVE      ZERO,XITEMNO
          GOTO      HPMCHA10
HPMCHA50  COMPARE   ZERO,CSEARCH
          GOTO      HPMCHA55 IF EQUAL
          MOVE      ZERO,CSEARCH
          MOVE      ZERO,XITEMNO
          MOVE      MINITEM,STDROW
          ADD       ONE,STDROW
          UNPACK    SP70,SCHFLD01,SCHFLD02,SCHFLD03,SCHFLD04,SCHFLD05
          UNPACK    SP70,SCHFLD06,SCHFLD07,SCHFLD08,SCHFLD09,SCHFLD10
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          DISPLAY   *PSTDCOL00:STDROW,*V2LON,*HON,"Sch"
          KEYIN     *PSTDCOL01:STDROW,*V2LON,SCHFLD01
          RESET     SCHFLD01
          KEYIN     *PSTDCOL02:STDROW,*V2LON,SCHFLD02
          RESET     SCHFLD02
          PACK      KEY8,SP70
          SUSPEND
          CLIP      1,1,CRIG,24
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          GOTO      HPMCHA08
HPMCHA55  MOVE      ONE,CSEARCH
          PACK      KEY8,SP70
          SUSPEND
          CLIP      1,1,CRIG,24
          BOXCLR    CLEF,CTOP,CRIG,CBOT
          GOTO      HPMCHA08
HPMCHA60  MOVE      ZERO,OVRCD
          MATCH     SP70,SCHFLD01
          GOTO      HPMCHA61 IF EQUAL
          MATCH     SCHFLD01,MCHARGE 
          GOTO      HPMCHA72 IF NOT EQUAL
HPMCHA61
          MATCH     SP70,SCHFLD02
          GOTO      HPMCHA62 IF EQUAL
          MATCH     SCHFLD02,MDESC 
          GOTO      HPMCHA72 IF NOT EQUAL
HPMCHA62
HPMCHA63
HPMCHA64
HPMCHA65
HPMCHA66
HPMCHA67
HPMCHA68
HPMCHA69
HPMCHA70
          GOTO      HPMCHA75
HPMCHA72  MOVE      ONE,OVRCD
HPMCHA75  RETURN
HPMCHA85
          LOAD      KEY21A,XITEMNO,ST1,ST2,ST3,ST4,ST5:              
                                ST6,ST7,ST8,ST9,ST10:
                                ST11,ST12,ST13,ST14,ST15:
                                ST16,ST17
          UNPACK    KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE
          PACK      KEY29,KEY26,SP70
          CALL      RDMCHG1 
HPMCHA90
          UNPACK    KEY21,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE                     
          GOTO      HPMCHA20
HPMCHA91
          MOVE      SP70,MDESC
          MOVE      ZERO,MITMTYP 
          MOVE      SP70,MMSCGRP
          MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      ZERO,MNINV 
          MOVE      ZERO,MINDIC 
          MOVE      ZERO,PTMCGSTA
          MOVE      SP70,PTMCGSTC
          MOVE      SP70,PTMCEDIE
          MOVE      ZERO,PTMCCFCY
          MOVE      SP70,PTMCSPAR
          MOVE      SP70,KEY26
          MOVE      SP70,MCHARGE 
          GOTO      HPMCHA96
HPMCHA92
          MOVE      SP70,KEY26
          MOVE      SP70,MCHARGE 
          LOAD      KEY21A,CCITEM,ST1,ST2,ST3,ST4,ST5:
                                ST6,ST7,ST8,ST9,ST10:
                                ST11,ST12,ST13,ST14,ST15:
                                ST16,ST17
          UNPACK    KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE                        
HPMCHA96
          PUTSCR    CSSCRNUM,HLEF,HTOP,HRIG,HBOT
          CALL      FRESCR00
          MOVE      ZERO,HTOP
          MOVE      ZERO,HLEF
          MOVE      ZERO,HBOT
          MOVE      ZERO,HRIG
HPMCHA99
          RETURN
