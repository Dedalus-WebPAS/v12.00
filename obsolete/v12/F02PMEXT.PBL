.*****************************************************************************
.*    Program      : F02PMEXT                                                *
.*    Description  : Conversion pmsextaf to new File layout                  *
.*                                                                           *
.*    Author       : J.Tan                                                   *
.*    Date         : 13/05/2011                                              *
.*    Modifications:                                                         *
.*        V10.02.01 23/06/2011  J.Tan         CAR 239592                     *
.*                  Added 3rd index                                          *
.*        V10.02.00 13/05/2011  J.Tan         CAR 239592                     *
.*                  Programe created                                         *
.*****************************************************************************
.
.  Global change F02PMEXT  eg F57PTDOC
.  Global change PMSEXTFD  eg PATDOCFD (new layout)
.  Global change pmsextaf  eg patdoctf
.  Global change PMSEXTA1  eg PATDOCT1
.  Global change KEY11   eg KEY8
.  Global change WRPMEXT1  eg WRDOCT1
.  Global change spmextaf  eg sptdoctf
.
.  vi Global change command  :%s/FromString/ToString/g
.
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
. Enter the first or the shortest index from the original FD and rename
. the index OLDFILE1
.
.                                     ******** copy the old FD here *******
.                                     * comment out all continuing fields and
.                                     * prefix changing fields with "OLD" -
.                                     * remove old Indexes and Redefines     
.
OLDFILE1   IFILE    SQL, FIXED=1669, KEY="U1-8,9-11"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
.PMEXVISN  DIM       8      8        1     Visit Number
.PMEXCLAM  DIM       3      3        9     Claim Code (Cat CL)
OLDXNAME  DIM       30     30       12    Employer Name
.PMEXADD1  DIM       35     35       42    Employer Address Line 1
.PMEXADD2  DIM       35     35       77    Employer Address Line 2
.PMEXADD3  DIM       35     35       112   Employer Address Line 3
.PMEXADD4  DIM       35     35       147   Employer Address Line 4
.PMEXPOST  DIM       8      8        182   Employer Post Code
.PMEXTELE  DIM       20     20       190   Employer Telephone
.PMEXADAT  DIM       8      8        210   Date of Accident (CCYYMMDD)
.PMEXABIC  DIM       1      1        218   Accepted by Insurance Company
.                                         0 = No, 1 = Yes
.PMEXICOD  DIM       6      6        219   Insurance Company Code
.PMEXCLMN  DIM       20     20       225   Insurance Claim Number
OLDXICON  DIM       40     40       245   Insurance Contact Name
.PMEXCOM1  DIM       40     40       285   Comment 1
.PMEXCOM2  DIM       40     40       325   Comment 2
.PMEXURNO  DIM       8      8        365   U/R
.PMEXVDAT  DIM       8      8        373   Visit Date (CCYYMMDD)
.PMEXODIN  DIM       1      1        381   Off Duty Injury
.                                         0 = No, 1 = Yes, 2 = N/A
.PMEXSERV  DIM       3      3        382   Service (Cat Ve)
.PMEXRANK  DIM       50     50       385   Rank
.PMEXSNUM  DIM       20     20       435   Service Number
.PMEXBASE  DIM       50     50       455   Barracks / Bases
.PMEXMCOM  DIM       3      3        505   Millitary Compensation (Cat Vf)
.PMEXUNIT  DIM       50     50       508   Unit
.PMEXMCNM  DIM       80     80       558   Millitary Comments
.PMEXSSNM  DIM       20     20       638   Social Security Number
.PMEXCONT  DIM       3      3        658   Country (Cat C)
.PMEXCTEL  DIM       20     20       661   Contact Telephone
.PMEXOMEM  DIM       20     20       681   O/S Membership (Health Fund)
.PMEXIEDT  DIM       8      8        701   Insurance Expiry Date (CCYYMMDD)
.PMEXSBIL  DIM       1      1        709   Send Bill to Local Address
.                                         0 = No, 1 = Yes
.PMEXTINS  DIM       1      1        710   Travel Insurance
.                                         0 = No, 1 = Yes
.PMEXIPOL  DIM       20     20       711   Travel Insurance Policy Number
.PMEXIEXD  DIM       8      8        731   Policy Number Expiry Date(CCYYMMDD)
.PMEXSNAM  DIM       50     50       739   Ships Name
.PMEXSAGN  DIM       50     50       789   Shipping Agent Name
.PMEXSCON  DIM       50     50       839   Contact Name
.PMEXDAT1  DIM       8      8        889   User Defined Date 1 (CCYYMMDD)
.PMEXDAT2  DIM       8      8        897   User Defined Date 1 (CCYYMMDD)
.PMEXDAT3  DIM       8      8        905   User Defined Date 3 (CCYYMMDD)
.PMEXDAT4  DIM       8      8        913   User Defined Date 4 (CCYYMMDD)
.PMEXDAT5  DIM       8      8        921   User Defined Date 5 (CCYYMMDD)
.PMEXTIM1  DIM       8      8        929   User Defined Time 1 (hh:mm:ss)
.PMEXTIM2  DIM       8      8        937   User Defined Time 2 (hh:mm:ss)
.PMEXTIM3  DIM       8      8        945   User Defined Time 3 (hh:mm:ss)
.PMEXTIM4  DIM       8      8        953   User Defined Time 4 (hh:mm:ss)
.PMEXTIM5  DIM       8      8        961   User Defined time 5 (hh:mm:ss)
.PMEXUYN1  DIM       1      1        969   User Defined Y/N 1
..                                         0 = No, 1 = Yes
.PMEXUYN2  DIM       1      1        970   User Defined Y/N 2
..                                         0 = No, 1 = Yes
.PMEXUYN3  DIM       1      1        971   User Defined Y/N 3
..                                         0 = No, 1 = Yes
.PMEXUYN4  DIM       1      1        972   User Defined Y/N 4
..                                         0 = No, 1 = Yes
.PMEXUYN5  DIM       1      1        973   User Defined Y/N 5
..                                         0 = No, 1 = Yes
.PMEXCAT1  DIM       3      3        974   User Defined Cat 1 (Cat Vg)
.PMEXCAT2  DIM       3      3        977   User Defined Cat 2 (Cat Vh)
.PMEXCAT3  DIM       3      3        980   User Defined Cat 3 (Cat Vi)
.PMEXCAT4  DIM       3      3        983   User Defined Cat 4 (Cat Vj)
.PMEXCAT5  DIM       3      3        986   User Defined Cat 5 (Cat Vk)
.PMEXUCM1  DIM       50     50       989   User Defined Comment 1
.PMEXUCM2  DIM       50     50       1039  User Defined Comment 2
.PMEXUCM3  DIM       50     50       1089  User Defined Comment 3
.PMEXUCM4  DIM       50     50       1139  User Defined Comment 4
.PMEXUCM5  DIM       50     50       1189  User Defined Comment 5
OLDXSLNM  DIM       30     30       1239  Solicitor Name
.PMEXSAD1  DIM       35     35       1269  Solicitor Address Line 1
.PMEXSAD2  DIM       35     35       1304  Solicitor Address Line 2
.PMEXSAD3  DIM       35     35       1339  Solicitor Address Line 3
.PMEXSAD4  DIM       35     35       1374  Solicitor Address Line 4
.PMEXSPOS  DIM       8      8        1409  Solicitor Post Code
.PMEXSTEL  DIM       20     20       1417  Solicitor Telephone
OLDXSCNM  DIM       40     40       1437  Solicitor Contact Name
.PMEXVTYP  DIM       3      3        1477  Visa Type (Cat vt)
.PMEXVEXP  DIM       8      8        1480  Visa Expiry Date (CCYYMMDD)
.PMEXPASN  DIM       20     20       1488  Passport Number
.PMEXPASC  DIM       3      3        1508  Passport Country (Cat C)
.PMEXOSVS  DIM       3      3        1511  Overseas Visitor Status (Cat Vl)
OLDXFSRC  DIM       3      3        1514  Funding Source (Cat Vm)
.PMEXCUID  DIM       10     10       1517  WEB User ID Created (websecaf)
.PMEXCDAT  DIM       8      8        1527  Date Record Created (CCYYMMDD)
.PMEXCTIM  DIM       8      8        1535  Time Record Created (hh:mm:ss)
.PMEXUUID  DIM       10     10       1543  WEB User ID Updated (websecaf)
.PMEXUDAT  DIM       8      8        1553  Update Date (CCYYMMDD)
.PMEXUTIM  DIM       8      8        1561  Update Time (hh:mm:ss)
.PMEXSPAR  DIM       100    100      1569  Spare
.
.End of Record                      1669
.
.                                     ******** copy the new FD here *******
.Data File Definition
.--------------------
PMSEXTA1   IFILE    SQL, FIXED=2676, KEY="U1-8,9-11"
PMSEXTA2   IFILE    SQL, FIXED=2676, KEY="U395-402,1-8,9-11"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
PMEXVISN  DIM       8      8        1     Visit Number
PMEXCLAM  DIM       3      3        9     Claim Code (Cat CL)
PMEXNAME  DIM       50     50       12    Employer Name
PMEXADD1  DIM       35     35       62    Employer Address Line 1
PMEXADD2  DIM       35     35       97    Employer Address Line 2
PMEXADD3  DIM       35     35       132   Employer Address Line 3
PMEXADD4  DIM       35     35       167   Employer Address Line 4
PMEXPOST  DIM       8      8        202   Employer Post Code
PMEXTELE  DIM       20     20       210   Employer Telephone
PMEXADAT  DIM       8      8        230   Date of Accident (CCYYMMDD)
PMEXABIC  DIM       1      1        238   Accepted by Insurance Company
.                                         0 = No, 1 = Yes
PMEXICOD  DIM       6      6        239   Insurance Company Code
PMEXCLMN  DIM       20     20       245   Insurance Claim Number
PMEXICON  DIM       50     50       265   Insurance Contact Name
PMEXCOM1  DIM       40     40       315   Comment 1
PMEXCOM2  DIM       40     40       355   Comment 2
PMEXURNO  DIM       8      8        395   U/R
PMEXVDAT  DIM       8      8        403   Visit Date (CCYYMMDD)
PMEXODIN  DIM       1      1        411   Off Duty Injury
.                                         0 = No, 1 = Yes, 2 = N/A
PMEXSERV  DIM       3      3        412   Service (Cat Ve)
PMEXRANK  DIM       50     50       415   Rank
PMEXSNUM  DIM       20     20       465   Service Number
PMEXBASE  DIM       50     50       485   Barracks / Bases
PMEXMCOM  DIM       3      3        535   Military Compensation (Cat Vf)
PMEXUNIT  DIM       50     50       538   Unit
PMEXMCNM  DIM       80     80       588   Military Comments
PMEXSSNM  DIM       20     20       668   Social Security Number
PMEXCONT  DIM       3      3        688   Country (Cat C)
PMEXCTEL  DIM       20     20       691   Contact Telephone
PMEXOMEM  DIM       20     20       711   O/S Membership (Health Fund)
PMEXIEDT  DIM       8      8        731   Insurance Expiry Date (CCYYMMDD)
PMEXSBIL  DIM       1      1        739   Send Bill to Local Address
.                                         0 = No, 1 = Yes
PMEXTINS  DIM       1      1        740   Travel Insurance
.                                         0 = No, 1 = Yes
PMEXIPOL  DIM       20     20       741   Travel Insurance Policy Number
PMEXIEXD  DIM       8      8        761   Policy Number Expiry Date(CCYYMMDD)
PMEXSNAM  DIM       50     50       769   Ships Name
PMEXSAGN  DIM       50     50       819   Shipping Agent Name
PMEXSCON  DIM       50     50       869   Contact Name
PMEXDAT1  DIM       8      8        919   User Defined Date 1 (CCYYMMDD)
PMEXDAT2  DIM       8      8        927   User Defined Date 1 (CCYYMMDD)
PMEXDAT3  DIM       8      8        935   User Defined Date 3 (CCYYMMDD)
PMEXDAT4  DIM       8      8        943   User Defined Date 4 (CCYYMMDD)
PMEXDAT5  DIM       8      8        951   User Defined Date 5 (CCYYMMDD)
PMEXTIM1  DIM       8      8        959   User Defined Time 1 (hh:mm:ss)
PMEXTIM2  DIM       8      8        967   User Defined Time 2 (hh:mm:ss)
PMEXTIM3  DIM       8      8        975   User Defined Time 3 (hh:mm:ss)
PMEXTIM4  DIM       8      8        983   User Defined Time 4 (hh:mm:ss)
PMEXTIM5  DIM       8      8        991   User Defined time 5 (hh:mm:ss)
PMEXUYN1  DIM       1      1        999   User Defined Y/N 1
.                                         0 = No, 1 = Yes
PMEXUYN2  DIM       1      1        1000  User Defined Y/N 2
.                                         0 = No, 1 = Yes
PMEXUYN3  DIM       1      1        1001  User Defined Y/N 3
.                                         0 = No, 1 = Yes
PMEXUYN4  DIM       1      1        1002  User Defined Y/N 4
.                                         0 = No, 1 = Yes
PMEXUYN5  DIM       1      1        1003  User Defined Y/N 5
.                                         0 = No, 1 = Yes
PMEXCAT1  DIM       3      3        1004  User Defined Cat 1 (Cat Vg)
PMEXCAT2  DIM       3      3        1007  User Defined Cat 2 (Cat Vh)
PMEXCAT3  DIM       3      3        1010  User Defined Cat 3 (Cat Vi)
PMEXCAT4  DIM       3      3        1013  User Defined Cat 4 (Cat Vj)
PMEXCAT5  DIM       3      3        1016  User Defined Cat 5 (Cat Vk)
PMEXUCM1  DIM       50     50       1019  User Defined Comment 1
PMEXUCM2  DIM       50     50       1069  User Defined Comment 2
PMEXUCM3  DIM       50     50       1119  User Defined Comment 3
PMEXUCM4  DIM       50     50       1169  User Defined Comment 4
PMEXUCM5  DIM       50     50       1219  User Defined Comment 5
PMEXSLNM  DIM       50     50       1269  Solicitor Name
PMEXSAD1  DIM       35     35       1319  Solicitor Address Line 1
PMEXSAD2  DIM       35     35       1354  Solicitor Address Line 2
PMEXSAD3  DIM       35     35       1389  Solicitor Address Line 3
PMEXSAD4  DIM       35     35       1424  Solicitor Address Line 4
PMEXSPOS  DIM       8      8        1459  Solicitor Post Code
PMEXSTEL  DIM       20     20       1467  Solicitor Telephone
PMEXSCNM  DIM       50     50       1487  Solicitor Contact Name
PMEXVTYP  DIM       3      3        1537  Visa Type (Cat vt)
PMEXVEXP  DIM       8      8        1540  Visa Expiry Date (CCYYMMDD)
PMEXPASN  DIM       20     20       1548  Passport Number
PMEXPASC  DIM       3      3        1568  Passport Country (Cat C)
PMEXOSVS  DIM       3      3        1571  Overseas Visitor Status (Cat Vl)
PMEXBASC  DIM       3      3        1574  Barracks / Bases Code (Cat Br)
PMEXECON  DIM       50     50       1577  Employer Contact Name
PMEXEPHN  DIM       20     20       1627  Employer Contact Phone
PMEXCAD1  DIM       35     35       1647  Free Format Address Line 1
PMEXCAD2  DIM       35     35       1682  Free Format Address Line 2
PMEXCAD3  DIM       35     35       1717  Free Format Address Line 3
PMEXCAD4  DIM       35     35       1752  Free Format Address Line 4
PMEXCPCD  DIM       8      8        1787  Free Format Postcode
PMEXCNAM  DIM       50     50       1795  Free Format Contact Name
PMEXCPHN  DIM       20     20       1845  Free Format Contact Phone Number
PMEXCINJ  DIM       3      3        1865  Cause of Injury (Cat IK)
PMEXINCD  DIM       3      3        1868  Injury Code (Cat IJ)
PMEXACCF  DIM       3      3        1871  Work Related (Cat IQ)
PMEXPLIN  DIM       3      3        1874  Place injury occured (Cat IP)
PMEXACTI  DIM       3      3        1877  Activity when injured (Cat IO)
PMEXADTE  DIM       8      8        1880  ACC Decline Date (ccyymmdd)
PMEXATME  DIM       8      8        1888  Accident Time (hh:mm:ss)
PMEXACLC  DIM       3      3        1896  Accident Location (Cat IM)
PMEXALOC  DIM       50     50       1899  Accident Location
PMEXAINZ  DIM       1      1        1949  Accident in NZ Y/N (0=No,1=Yes)
PMEXMOVV  DIM       1      1        1950  Involves Moving Vehicle on Pub.Road
.                                         0=No 1=Yes
PMEXSPTI  DIM       1      1        1951  Sporting Injury Y/N
.                                         0=No 1=Yes
PMEXSPRT  DIM       3      3        1952  Sport Name (Cat IB)
PMEXRECI  DIM       1      1        1955  Recurring Injury Indicator Y/N
.                                         0=No 1=Yes
PMEXTRIC  DIM       1      1        1956  Treatment Injury Claim Y/N
.                                         0=No 1=Yes
PMEXESTA  DIM       3      3        1957  Employment Status (Cat IF)
PMEXPDDT  DIM       8      8        1960  Patient Declaration Date
PMEXARG1  DIM       40     40       1968  Authorized Representative Giv.Name1
PMEXARG2  DIM       40     40       2008  Authorized Representative Giv.Name2
PMEXARSN  DIM       40     40       2048  Authorized Representative Surname
PMEXARTL  DIM       4      4        2088  Authorized Representative Title
PMEXARRP  DIM       10     10       2092  Authorized Representative Relation
PMEXASST  DIM       1      1        2102  Assistance is Required (Y/N)
.                                         0=No 1=Yes
PMEXNEED  DIM       1      1        2103  Need to call HP Y/N 0=No,1=Yes
PMEXCNOR  DIM       1      1        2104  Continue Normal Hours of Work Y/N
.                                         0=No 1=Yes
PMEXALTW  DIM       1      1        2105  Alternative Work Indicator Y/N
.                                         0=No 1=Yes
PMEXTYPA  DIM       3      3        2106  Type of Alternative Work (Cat IH)
PMEXSALT  DIM       8      8        2109  Start Date of Alternative Work
PMEXHPDA  DIM       2      2        2117  Hours per day of Alternative Work
PMEXUNFD  DIM       3      3        2119  Unfit for Work For Duration
PMEXUNFT  DIM       3      3        2122  Unfit for Work for Type(Cat UI)
PMEXFISD  DIM       8      8        2125  Full Incapacity Start Date
PMEXRNWD  DIM       8      8        2133  Return to Normal Work Date
PMEXCSTA  DIM       1      1        2141  Claim Status
.                                         0=Existing 1=Parked 2=Completed
PMEXTWRK  DIM       3      3        2142  Type of Work (Cat IX)
PMEXOEST  DIM       50     50       2145  Other Employment Status
PMEXTPRO  DIM       10     10       2195  HCP Treatment Provider
PMEXAUTH  DIM       20     20       2205  Authorisation Number
PMEXAUDA  DIM       8      8        2225  Authorisation Date
PMEXREFN  DIM       20     20       2233  M.A.B. Reference Number
PMEXPOLI  DIM       20     20       2253  Police Station Accident reported to
PMEXREGO  DIM       36     36       2273  Car Rego Number involved
PMEXDRPS  DIM       1      1        2309  1=Driver 2=Passenger
PMEXENGD  DIM       20     20       2310  While Eng.in-free format entry
PMEXINJR  DIM       30     30       2330  Patient Injured when
PMEXMTRN  DIM       10     10       2360  Mode of Transport
PMEXMSEV  DIM       30     30       2370  Mechanism of severist injury
PMEXRSEV  DIM       20     20       2400  Region of severist injury
PMEXODD1  DIM       30     30       2420  Other Driver details line 1
PMEXODD2  DIM       30     30       2450  Other Driver details line 2
PMEXODD3  DIM       30     30       2480  Other Driver details line 3
PMEXTCLM  DIM       1      1        2510  TAC Clm Form completed/Settle MVIT?
.                                         0=No 1=Yes
PMEXMTYP  DIM       3      3        2511  Role in Accident (Cat RA)
PMEXALEL  DIM       3      3        2514  Alternate Election (Cat CL)
PMEXPOLC  DIM       1      1        2517  Police Officer 1=Yes 0=No
PMEXIDNO  DIM       20     20       2518  ID Number
PMEXSCHL  DIM       6      6        2538  Name of School (pateoraf)
PMEXCUID  DIM       10     10       2544  WEB User ID Created (websecaf)
PMEXCDAT  DIM       8      8        2554  Date Record Created (CCYYMMDD)
PMEXCTIM  DIM       8      8        2562  Time Record Created (hh:mm:ss)
PMEXUUID  DIM       10     10       2570  WEB User ID Updated (websecaf)
PMEXUDAT  DIM       8      8        2580  Date Record Updated (CCYYMMDD)
PMEXUTIM  DIM       8      8        2588  Time Record Updated (hh:mm:ss)
PMEXSPAR  DIM       80     80       2596  Spare variable
.
.End of Record                      2676
.
.
.                                           * standard Fixit variables
CMDLINE   DIM       100
DIM4      DIM       4
DIM4A     DIM       4
DIM6      DIM       6
DIM6A     DIM       6
DIM60     DIM       60
DDCENT    DIM       2
.
FORM3     FORM      3
.
INPFILE   DIM       8
RECNUM    FORM      8
NEWFILE   DIM       60
NEWPATH   DIM       60
OLDPATH   DIM       60
DEFPATH   DIM       60
SAVEFLG   FORM      1
SP50      INIT    "                                                  "
SP60      INIT    "                                                            "
.
PRGNAM    INIT      "CONVERSION PMSEXTFD"
PRGID     INIT      "F02PMEXT"
VERSION   INIT      "V12.00.00"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      KDIR0000                      * Keyin directory
          BRANCH    EXIT,MAIN9999
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
MAIN1000  CALL      PREP0000                      * preparing files
          BRANCH    EXIT,MAIN9999
.
. Loop thru old file and write records to new file
.
          CALL      READ0000                      * read old records and write
          CALL      ENDP0000                      * save/compress saved file
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
          
INIT9999  RETURN
.
.********************************************************************
.*                          KDIR0000                                *
.*  Keyin directories                                               *
.********************************************************************
KDIR0000  MOVE      ONE,SAVEFLG        * Default to keep file
          KEYIN     *P1:10,*EL,"Do you want to save the original file (Y/N) ? ":
                    ANS;
          REP       "yYnN",ANS
          CMATCH    "Y",ANS
          GOTO      KDIR1000 IF EQUAL
          MOVE      ZERO,SAVEFLG       * not to keep file
          CMATCH    "N",ANS
          GOTO      KDIR1000 IF EQUAL
          BEEP
          GOTO      KDIR0000
.
KDIR1000  CALL      DEFT0000                * Get the default path
          BRANCH    EXIT,KDIR9999
          MOVE      SP60,OLDPATH
.
          DISPLAY   *P1:24,*EL,"The directory path must end with a slash (/) ";
.
          MOVE      DEFPATH,OLDPATH
          BRANCH    SAVEFLG,KDIR2000
.
.         Keyin the path for the original file
.
          KEYIN     *P1:12,*EL,"Keyin path for temporarily saving original ":
                    "file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
          GOTO      KDIR3000
.
KDIR2000  KEYIN     *P1:12,*EL,"Keyin path for saving original file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
.
KDIR3000  ENDSET    OLDPATH
          APPEND    SP60,OLDPATH
          RESET     OLDPATH
.
          MATCH     SP60,OLDPATH
          IF        @EQUAL
            PACK      OLDPATH,DEFPATH      * use the default
            DISPLAY   *P10:13,*EL,*V2LON,OLDPATH;
          ENDIF
.
          SQUEEZE   OLDPATH
          CMATCH    EXITCHAR,OLDPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,OLDPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR1000
.
.         Keyin the path for the new file
.
KDIR5000  MOVE      SP60,NEWPATH
          MOVE      DEFPATH,NEWPATH
          KEYIN     *P1:15,*EL,"Keyin path for the new file: ":
                    *P10:16,*EL,*DV,*RV,NEWPATH:
                    *P10:16,NEWPATH;
          ENDSET    NEWPATH
          APPEND    SP60,NEWPATH
          RESET     NEWPATH
.
          MATCH     SP60,NEWPATH
          IF        @EQUAL
            PACK      NEWPATH,DEFPATH      * use the default
            DISPLAY   *P10:16,*V2LON,NEWPATH;
          ENDIF
.
          SQUEEZE   NEWPATH
          CMATCH    EXITCHAR,NEWPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,NEWPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR5000
          GOTO      KDIR9999
.
KDIR9000  MOVE      ONE,EXIT
KDIR9999  DISPLAY   *P1:24,*EL;
          RETURN
+
.********************************************************************
.*                          PREP0000                                *
.*  Preparing files                                                 *
.********************************************************************
PREP0000 
. open old file
          MOVE      "pmsextaf",INPFILE
          CALL      CHEK0000             * check file exists or has been changed
          BRANCH    EXIT,PREP9000
.
          CLOSE     OLDFILE1
          DISPLAY   *P1:24,*EL,"Copying files ... Please wait !! ";
.
. Copy old file to the keyin directory
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmsextaf.dat` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmextaf.dat",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmsextaf.idx` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmextaf.idx",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
. remove the original files
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    DEFPATH,CMDLINE
          APPEND    "pmsextaf",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Unable to remove the original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Opening old file after being copied
.
          MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60
          APPEND    "spmextaf",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE1,DIM60
          TRAPCLR   IO
          IF        OVRCD = 1
            DISPLAY   *P1:24,*EL,*B,"Unable to open saved original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Create the new file
.
          DISPLAY   *P1:24,*EL,"Creating new files ... Please wait !! ";
          PACK      NEWFILE,SP60
          CLEAR     NEWFILE
          APPEND    NEWPATH,NEWFILE
          APPEND    "pmsextaf",NEWFILE
          APPEND    SP60,NEWFILE
          RESET     NEWFILE
          SQUEEZE   NEWFILE
.
PREP1000  PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    NEWFILE,CMDLINE
.
.  The files new record length and unique key must be written here
.      eg    APPEND    " 195 UC9-16",CMDLINE
.
          APPEND    " 2676 UC1-8,9-11",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.  If the file has more than one index, this piece of code below has 
.  to be repeated with for each individual index
.
           PACK      CMDLINE,SP60,SP60
           CLEAR     CMDLINE
           APPEND    "isadd ",CMDLINE
           APPEND    NEWFILE,CMDLINE
           APPEND    " UC395-402,1-8,9-11",CMDLINE
           APPEND    SP60,CMDLINE
           RESET     CMDLINE
           EXECUTE   CMDLINE,TASKID
.
           PACK      CMDLINE,SP60,SP60
           CLEAR     CMDLINE
           APPEND    "isadd ",CMDLINE
           APPEND    NEWFILE,CMDLINE
           APPEND    " UC395-402,230-237,1-8,9-11",CMDLINE
           APPEND    SP60,CMDLINE
           RESET     CMDLINE
           EXECUTE   CMDLINE,TASKID
.
          OPEN      PMSEXTA1,NEWFILE
.
. set the flag to say we want to continue
.
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,"Record : "
          GOTO      PREP9999
.
PREP5000  DISPLAY   *P1:24,*EL,*B,"Old file not found.  ";
          CALL      HITENTER
          GOTO      PREP9000
.
PREP8000  DISPLAY   *P1:24,*EL,*B,"Unable to copy original file.  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
.
PREP9000  MOVE      ONE,EXIT
PREP9999  RETURN
+
.********************************************************************
.*                          CHEK0000                                *
.*  Check if file exists, or has already been converted             *
.********************************************************************
CHEK0000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND GIVING DIM60 IF IO
          OPEN      OLDFILE1,INPFILE
          TRAPCLR   IO
          BRANCH    OVRCD,CHEK2000       * Original file does not exist
          CLOSE     OLDFILE1
          GOTO      CHEK9999
.
CHEK2000  RESET     DIM60
          SCAN      "I * I",DIM60
          DISPLAY   *P1:23,*EF,"File '",INPFILE,"' ";
          IF        @EQUAL
            DISPLAY   "does not exist - ";
          ELSE
            RESET     DIM60
            SCAN      "I * L",DIM60
            IF        @EQUAL
              DISPLAY   "has already been converted - ";
            ELSE
              DISPLAY   "has caused an IO error - ";
            ENDIF
          ENDIF
          DISPLAY   "File will be bypassed"
.
          CALL      HITENTER
          DISPLAY   *P1:23,*EF;
.
CHEK9000  MOVE      ONE,EXIT
.
CHEK9999  RETURN
.
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
          PACK      KEY11,SP60
          CALL      READSOLD                      * position at start
READ1000  CALL      READKOLD                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
          ADD       ONE,RECNUM                    * update record counter
.
.  All necessary changes to the files field lengths, date changes
.  or any other sort of modification must be made here
.
          UNPACK    SP70,PMEXBASC
          UNPACK    SP70,PMEXECON,PMEXEPHN
          UNPACK    SP70,PMEXCAD1,PMEXCAD2
          UNPACK    SP70,PMEXCAD3,PMEXCAD4
          UNPACK    SP70,PMEXCPCD,PMEXCNAM
          UNPACK    SP70,PMEXCPHN,PMEXCINJ,PMEXINCD,PMEXACCF,PMEXPLIN,PMEXACTI
          UNPACK    SP70,PMEXALOC,PMEXADTE,PMEXATME,PMEXACLC,PMEXALOC,
          UNPACK    SP70,PMEXAINZ,PMEXMOVV
          UNPACK    SP70,PMEXSPTI,PMEXSPRT,PMEXRECI,PMEXTRIC,PMEXESTA,PMEXPDDT
          UNPACK    SP70,PMEXARG1
          UNPACK    SP70,PMEXARG2
          UNPACK    SP70,PMEXARSN,PMEXARTL
          UNPACK    SP70,PMEXARRP,PMEXASST,PMEXNEED,PMEXCNOR,PMEXALTW,PMEXTYPA
          UNPACK    SP70,PMEXSALT,PMEXHPDA,PMEXUNFD,PMEXUNFT,PMEXFISD,PMEXRNWD
          UNPACK    SP70,PMEXCSTA,PMEXTWRK,PMEXOEST
          UNPACK    SP70,PMEXTPRO,PMEXAUTH,PMEXAUDA,PMEXREFN
          UNPACK    SP70,PMEXPOLI,PMEXREGO
          UNPACK    SP70,PMEXDRPS,PMEXENGD
          UNPACK    SP70,PMEXINJR,PMEXMTRN,PMEXMSEV
          UNPACK    SP70,PMEXRSEV,PMEXODD1
          UNPACK    SP70,PMEXODD2,PMEXODD3
          UNPACK    SP70,PMEXTCLM,PMEXMTYP
          UNPACK    SP70,PMEXALEL,PMEXPOLC
          UNPACK    SP70,PMEXIDNO,PMEXSCHL
          UNPACK    SP70,PMEXICON,PMEXSCNM
          PACK      PMEXSPAR,SP70,SP70
.                                               * Pack key here
          PACK      KEY11,PMEXVISN,PMEXCLAM,SP70
          CALL      WRPMEXT1                    * write to new file
.
          IF        (RECNUM%1000) = 0
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     PMSEXTA1                      * close new file
          CLOSE     OLDFILE1                      * close old file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
.
READ9999  RETURN
.
+
.**********************************************************************
.*                               VALD0000                             *
.*        Check if it a valid directory                               *
.**********************************************************************
VALD0000  MOVE      ZERO,EXIT
          SQUEEZE   DIM60
          ENDSET    DIM60
          CMATCH    SLASH,DIM60
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory path must end with a slash (/) ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          RESET     DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cd ",CMDLINE
          APPEND    DIM60,CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory does not exist ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          GOTO      VALD9999
.
VALD9000  MOVE      ONE,EXIT            * Not valid
VALD9999  RETURN
+
.**********************************************************************
.*                               ENDP0000                             *
.*        Remove or compress save file                                *
.**********************************************************************
ENDP0000  MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60        * set up the saved file with path
          APPEND    "spmextaf*",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
          SQUEEZE   DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          IF        SAVEFLG = 1
            APPEND    "compress -f ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Compressing original file.. ":
                      "Please wait !!  ";
          ELSE
            APPEND    "rm ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Removing original file.. Please wait !!  ";
          ENDIF
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Saved file not compressed or removed.  ";
            CALL      HITENTER
            GOTO      ENDP9999
          ENDIF
.
          CALL      IBACLOCK
          DISPLAY   *P1:24,*EL,*B,"Finish processing.  ";
          CALL      HITENTER
.
ENDP9999  RETURN
+
.**********************************************************************
.         Get the default directory
.**********************************************************************
DEFT0000  EXECUTE   "ldat pmsextaf.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding 'pmsextaf'.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
DEFT9999  RETURN
+
.
.                  ******************************    OLD IO ROUTINES
.                  Copy the Positional Read (RS or RDS) from original I/O file,
.                  - change Label to READSOLD and the index name to OLDFILE1
.
READSOLD  RESET     KEY11
          READ      OLDFILE1,KEY11;;
          RETURN
.
.                  Copy the Read Next (RK or RDK) from the original I/O file
.                  - change Label to READKOLD and the index name to OLDFILE1
.                  - change any fields that are changing to a prefix of OLD,
.                    eg. PTEDSPAR becomes OLDDSPAR
.
READKOLD  MOVE      ZERO,OVRCD
          READKS    OLDFILE1;PMEXVISN,PMEXCLAM,OLDXNAME,PMEXADD1,PMEXADD2:
                        PMEXADD3,PMEXADD4,PMEXPOST,PMEXTELE,PMEXADAT,PMEXABIC:
                        PMEXICOD,PMEXCLMN,OLDXICON,PMEXCOM1,PMEXCOM2,PMEXURNO:
                        PMEXVDAT,PMEXODIN,PMEXSERV,PMEXRANK,PMEXSNUM,PMEXBASE:
                        PMEXMCOM,PMEXUNIT,PMEXMCNM,PMEXSSNM,PMEXCONT,PMEXCTEL:
                        PMEXOMEM,PMEXIEDT,PMEXSBIL,PMEXTINS,PMEXIPOL,PMEXIEXD:
                        PMEXSNAM,PMEXSAGN,PMEXSCON,PMEXDAT1,PMEXDAT2,PMEXDAT3:
                        PMEXDAT4,PMEXDAT5,PMEXTIM1,PMEXTIM2,PMEXTIM3,PMEXTIM4:
                        PMEXTIM5,PMEXUYN1,PMEXUYN2,PMEXUYN3,PMEXUYN4,PMEXUYN5:
                        PMEXCAT1,PMEXCAT2,PMEXCAT3,PMEXCAT4,PMEXCAT5,PMEXUCM1:
                        PMEXUCM2,PMEXUCM3,PMEXUCM4,PMEXUCM5,OLDXSLNM,PMEXSAD1:
                        PMEXSAD2,PMEXSAD3,PMEXSAD4,PMEXSPOS,PMEXSTEL,OLDXSCNM:
                        PMEXVTYP,PMEXVEXP,PMEXPASN,PMEXPASC,PMEXOSVS,OLDXFSRC:
                        PMEXCUID,PMEXCDAT,PMEXCTIM,PMEXUUID,PMEXUDAT,PMEXUTIM:
                        PMEXSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
.                  ******************************    NEW IO ROUTINES
.                  Copy the Write statement from the new I/O file           
.                  (no changes are needed to this routine)               
.
WRPMEXT1  RESET     KEY11
          WRITE     PMSEXTA1,KEY11;PMEXVISN,PMEXCLAM,PMEXNAME,PMEXADD1,PMEXADD2:
                        PMEXADD3,PMEXADD4,PMEXPOST,PMEXTELE,PMEXADAT,PMEXABIC:
                        PMEXICOD,PMEXCLMN,PMEXICON,PMEXCOM1,PMEXCOM2,PMEXURNO:
                        PMEXVDAT,PMEXODIN,PMEXSERV,PMEXRANK,PMEXSNUM,PMEXBASE:
                        PMEXMCOM,PMEXUNIT,PMEXMCNM,PMEXSSNM,PMEXCONT,PMEXCTEL:
                        PMEXOMEM,PMEXIEDT,PMEXSBIL,PMEXTINS,PMEXIPOL,PMEXIEXD:
                        PMEXSNAM,PMEXSAGN,PMEXSCON,PMEXDAT1,PMEXDAT2,PMEXDAT3:
                        PMEXDAT4,PMEXDAT5,PMEXTIM1,PMEXTIM2,PMEXTIM3,PMEXTIM4:
                        PMEXTIM5,PMEXUYN1,PMEXUYN2,PMEXUYN3,PMEXUYN4,PMEXUYN5:
                        PMEXCAT1,PMEXCAT2,PMEXCAT3,PMEXCAT4,PMEXCAT5,PMEXUCM1:
                        PMEXUCM2,PMEXUCM3,PMEXUCM4,PMEXUCM5,PMEXSLNM,PMEXSAD1:
                        PMEXSAD2,PMEXSAD3,PMEXSAD4,PMEXSPOS,PMEXSTEL,PMEXSCNM:
                        PMEXVTYP,PMEXVEXP,PMEXPASN,PMEXPASC,PMEXOSVS,PMEXBASC:
                        PMEXECON,PMEXEPHN,PMEXCAD1,PMEXCAD2,PMEXCAD3,PMEXCAD4:
                        PMEXCPCD,PMEXCNAM,PMEXCPHN,PMEXCINJ,PMEXINCD,PMEXACCF:
                        PMEXPLIN,PMEXACTI,PMEXADTE,PMEXATME,PMEXACLC,PMEXALOC:
                        PMEXAINZ,PMEXMOVV,PMEXSPTI,PMEXSPRT,PMEXRECI,PMEXTRIC:
                        PMEXESTA,PMEXPDDT,PMEXARG1,PMEXARG2,PMEXARSN,PMEXARTL:
                        PMEXARRP,PMEXASST,PMEXNEED,PMEXCNOR,PMEXALTW,PMEXTYPA:
                        PMEXSALT,PMEXHPDA,PMEXUNFD,PMEXUNFT,PMEXFISD,PMEXRNWD:
                        PMEXCSTA,PMEXTWRK,PMEXOEST,PMEXTPRO,PMEXAUTH,PMEXAUDA:
                        PMEXREFN,PMEXPOLI,PMEXREGO,PMEXDRPS,PMEXENGD,PMEXINJR:
                        PMEXMTRN,PMEXMSEV,PMEXRSEV,PMEXODD1,PMEXODD2,PMEXODD3:
                        PMEXTCLM,PMEXMTYP,PMEXALEL,PMEXPOLC,PMEXIDNO,PMEXSCHL:
                        PMEXCUID,PMEXCDAT,PMEXCTIM,PMEXUUID,PMEXUDAT,PMEXUTIM:
                        PMEXSPAR
          RETURN
.
          INC       STD001IO
