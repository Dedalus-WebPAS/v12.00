.******************************************************************************
.* System         : Waiting Lists                                             *
.*                                                                            *
.* Include Name   : KYWATDET.PBL                                              *
.*                                                                            *
.* Function       : To keyin the Waiting List details                         *
.*                  This routine has the main branch statement, so when an WAT*
.*                  field is to be entered, just call kywatdet and the item   *
.*                  will be entered.                                          *
.*                : also contains MYWATDET which loads up the variable DIM80  *
.*                  for the routine 'spck0000' for mandatory fields check     *
.*                : also contains CLWATDET which clears all variables         *
.*                                                                            *
.* Author         : ROD IS GAY 03/12/92                                       *
.*                                                                            *
.* Modifications  :                                                           *
.*                 07/08/2000 Steve Downing  SRF 646108                       *
.*                            Added extra items to mandatory field check      *
.*                 11/07/2000 J Habasque                                      *
.*                            Changed Decision to admit to not mandatory      *
.*                 13/06/000  J Habasque                                      *
.*                            Added WTWMDRSA,WTWMDOSA,WTWMPHSP                *
.*       V5.08.B01 17/03/2000 Tonii   SRF 646506                              *
.*                            Moved "ONE" into CKYINACT, check for active flag*
.*                            when a doctor code is entered                   *
.******************************************************************************
.*                  25/10/99  J Habasque                                      *
.*                            Added test for inactive codes                   *
.*                  22/09/99  J Habasque                                      *
.*                            Added PTCNCSRL for source of referral           *
.*                  12/08/99  J.Tan                                           *
.*                            Added  source of referral                       *
.*                  22/03/93  Whirlpool - worlds best surfer                  *
.*                            Added not available keyin                       *
.*                  24/03/93  Whirlpool                                       *
.*                            added default for refering GP keyin             *
.*                  06/04/93  Whirlpool                                       *
.*                            Added Exitchar facility for GP keyin            *
.*                  04/06/93  ROD                                             *
.*                            Removed default for Guaranteed Admission date   *
.*                  07/07/93  WHIRLPOOL    SRF 440197   &  123440             *
.*                            List type error in KUNCLI00 routine             *
.*                            Fixed bug in Deffered admission date            *
.*                  20/07/93  WHIRLPOOL    SRF 123257                         *
.*                            Added WMDATE3  Scheduled Admission Date         *
.*                            Added WMSTAT   Procedure status                 *
.*                  03/11/1993    Justin Coates  QUOTE 440017 SRF 440204      *
.*                  set up new GP Practice count variable                     *
.*                  10/02/94  Rob Leonard  SRF 600152                         *
.*                  set up Date of Removal and Removal Reason                 *
.*                  07/03/1994    Justin Coates  SRF 440719                   *
.*                  added keyin of WTWMDOFR                                   *
.*                  25/03/1994  Rob Leonard  SRF 440768                       *
.*                  Waiting list changes UK (exclude non planned patients)    *
.*                  28/03/1994    Justin Coates                               *
.*                  new keyin for GP Code to not look at Practice             *
.*                  06/04/1994  Steve Armstrong                               *
.*                  Mods for change from PATCODKY to PATCODKY                 *
.*                  26/04/1994  Rob Leonard  SRF 128919                       *
.*                  Dont set priority in change mode (UK)                     *
.*                  20/05/1994  ROD          SRF 601066                       *
.*                  fix priority keyin                                        *
.*                  29/07/1994  bez              wgh                          *
.*                  Added items 36 & 37 for wattr1af                          *
. *                 13/10/1995   Howellsy         suht  
. *                 added wtwmoper & desc 
. *                 07/03/1997   Howellsy     SRF 642638
. *                 fixed wmtime & wpestls
. *                 14/04/97 Howellsy        RHA        
. *                 Added wmudef5-8, wtwmrdt3, wtwmrank             
.******************************************************************************
.
KYWATDET  MOVE      SCPSITM,FIELDNO
          MOVE      SCPSROW,EVERT
          MOVE      SCPSCOL,ECOL
          MOVE      SCPSROW,CVERT
          MOVE      SCPSCOL,CCOL
          MOVE      SCPSMAN,CKYIMAND
          SFORMAT   KEYFIELD,127
          MOVE      ZERO,EXIT
          BRANCH    FIELDNO,KWTDT003,KWTDT006,KWTDT009,KWTDT012,KWTDT015:
                            KWTDT018,KWTDT999,KWTDT021,KWTDT999,KWTDT024:   10
                            KWTDT027,KWTDT999,KWTDT030,KWTDT999,KWTDT033:
                            KWTDT999,KWTDT036,KWTDT999,KWTDT039,KWTDT999:   20
                            KWTDT042,KWTDT999,KWTDT045,KWTDT999,KWTDT048:
                            KWTDT999,KWTDT051,KWTDT054,KWTDT057,KWTDT999:   30
                            KWTDT060,KWTDT063,KWTDT999,KWTDT066,KWTDT069:
                            KWTDT072,KWTDT999,KWTDT075,KWTDT999,KWTDT078:   40
                            KWTDT081,KWTDT084,KWTDT999,KWTDT087,KWTDT999:
                            KWTDT090,KWTDT093,KWTDT999,KWTDT999,KWTDT999:   50
                            KWTDT999,KWTDT096,KWTDT999,KWTDT099,KWTDT999:
                            KWTDT999,KWTDT102,KWTDT999,KWTDT104,KWTDT999:   60
                            KWTDT106,KWTDT999,KWTDT108,KWTDT999,KWTDT110:
                            KWTDT111,KWTDT999,KWTDT113,KWTDT114,KWTDT115:   70
                            KWTDT999
          BEEP
          GOTO      KWTDT999
.
KWTDT003  CALL      KPTIME00                * procedure time
          GOTO      KWTDT999
.
KWTDT006  CALL      KPDESC00                * procedure description
          GOTO      KWTDT999
.
KWTDT009  CALL      KPREAS00                * procedure reason
          GOTO      KWTDT999
.
KWTDT012  CALL      KDOLST00                * date on list
          GOTO      KWTDT999
.
KWTDT015  CALL      KDLRVW00                * date of last review
          GOTO      KWTDT999
.
KWTDT018  CALL      KUNCLI00                * unit/clinic
          GOTO      KWTDT999
.
KWTDT021  CALL      KATDOC00                * attending doctor
          IF        ICMODE=1 & EXIT=0
            MOVE      "    6",KEY5
            CALL      SCRCKFLD
            BRANCH    OVRCD,KWTDT999
            MOVE      CCOL,ECOL
            MOVE      CVERT,EVERT
            CALL      KUNCLI00
          ENDIF
          GOTO      KWTDT999
.
KWTDT024  CALL      KESTST00                * estimated stay
          GOTO      KWTDT999
.
KWTDT027  CALL      KPRITY00                * priority
          GOTO      KWTDT999
.
KWTDT030  CALL      KSHNOT00                * short notice
          GOTO      KWTDT999
.
KWTDT033  CALL      KRESID00                * resident status
          GOTO      KWTDT999
.
KWTDT036  CALL      KPTCLS00                * patient classification
          GOTO      KWTDT999
.
KWTDT039  CALL      KW1USR00                * user defined field 1
          GOTO      KWTDT999
.
KWTDT042  CALL      KW2USR00                * user defined field 2
          GOTO      KWTDT999
.
KWTDT045  CALL      KW3USR00                * user defined field 3
          GOTO      KWTDT999
.
KWTDT048  CALL      KW4USR00                * user defined field 4
          GOTO      KWTDT999
.
KWTDT051  CALL      KREDAT00                * reassessment date
          GOTO      KWTDT999
.
KWTDT054  CALL      KSTGAD00                * deferred/staged admission date
          GOTO      KWTDT999
.
KWTDT057  CALL      KPTCAT00                * patient category
          GOTO      KWTDT999
.
KWTDT060  CALL      KDCDAT00                * decision to admit date
          GOTO      KWTDT999
.
KWTDT063  CALL      KADMCT00                * administrative category
          GOTO      KWTDT999
.
KWTDT066  CALL      KGADMD00                * guaranteed admission date
          GOTO      KWTDT999
.
KWTDT069  CALL      KDNABD00                * do not admit before date
          GOTO      KWTDT999
.
KWTDT072  CALL      KELADT00                * elective admission type
          GOTO      KWTDT999
.
KWTDT075  CALL      KADCAT00                * admission category
          GOTO      KWTDT999
.
KWTDT078  CALL      KECRAN00                * ECR approval number
          GOTO      KWTDT999
.
KWTDT081  CALL      KGPFHN00                * GPFH approval number
          GOTO      KWTDT999
.
KWTDT084  CALL      KREFGP00                * referring GP
          GOTO      KWTDT999
.
KWTDT087  CALL      KGPCOD00                * GP practice code
          GOTO      KWTDT999
.
KWTDT090  CALL      KNAVRG00                * Not available date range
          GOTO      KWTDT999
.
KWTDT093  CALL      KSADAT00                * Scheduled Admission date
          GOTO      KWTDT999
.
KWTDT096  CALL      KWDOFR00                * District of Residence
          GOTO      KWTDT999
.
KWTDT099  CALL      KGPNPR00                * GP not using practice
          GOTO      KWTDT999
.
KWTDT102  CALL      KW5USR00                * user defined field 5
          GOTO      KWTDT999
.
KWTDT104  CALL      KW6USR00                * user defined field 6
          GOTO      KWTDT999
.
KWTDT106  CALL      KW7USR00                * user defined field 7
          GOTO      KWTDT999
.
KWTDT108  CALL      KW8USR00                * user defined field 8
          GOTO      KWTDT999
.
KWTDT110  CALL      KPRANK00                * Patient Rank         
          GOTO      KWTDT999
.
KWTDT111  CALL      KASRCE00                * Source of referral
          GOTO      KWTDT999
.
KWTDT113  CALL      KDRFSA00                * Date of ref 1st spec assessment
          GOTO      KWTDT999
.
KWTDT114  CALL      KDOFSA00                * Date of 1st specialist assessment
          GOTO      KWTDT999
.
KWTDT115  CALL      KPHSP000                * Principal Health service purchaser
          GOTO      KWTDT999
.
KWTDT999  RETURN
+
.*******************************************************************************
. ----  Keyin procedure time (minutes) ----        * not mandatory
.
KPTIME00  BRANCH    MODEFLAG,KEYT2006,KEYT2002,KPTIME99
.                            Add      Change   Delete
.
KEYT2002  MOVE      WMTIME,WPTIME
.
KEYT2006  KEYIN     *PCCOL:CVERT,*V2LON,*DV,WPTIME:
                    *PCCOL:CVERT,*V2LON,*RV,WPTIME:
                    *PCCOL:CVERT,*V2LON,*DV,WPTIME;
.
          COMPARE   ZERO,WPTIME
          GOTO      KPTIME21 IF EQUAL
          GOTO      KPTIME00 IF LESS
          MOVE      WPTIME,WMTIME
          GOTO      KPTIME99
.
KPTIME21  MOVE      ZERO,WPTIME
          MOVE      ZERO,WMTIME
          PACK      KEY9,PROCCODE,SP9
          CALL      RDPROA1
          BRANCH    OVRCD,KPTIME99
          MOVE      WPTIME,WMTIME
          PACK      VAR,WMTIME,SP30,SP30
          CALL      DISPITEM
KPTIME99  RETURN
.
.*******************************************************************************
. ----  Keyin procedure description  ----            * not mandatory, def WPDESC
.
KPDESC00  
          MOVE      ZERO,YESDFLTS
          PACK      KEY9,PROCCODE
          CALL      RDPROA1
          IF        OVRCD=1
            MOVE      SP30,WMDESC
          ELSE
            MOVE      WPDESC,WMDESC
            MOVE      ONE,YESDFLTS
          ENDIF
.
          PACK      KEYFIELD,WMDESC,SP70,SP70
          CALL      KFREEF00
          PACK      WMDESC,KEYFIELD,SP20,SP10
          MOVE      ZERO,YESDFLTS
.
          PACK      VAR,WMDESC,SP30,SP30
          CALL      DISPITEM
.
          PACK      KEY60,QUEST,SP70
          MATCH     KEY60,WMDESC
          IF        @EQUAL & PCVERT<>0
            CALL      KPROCC00                   * keyin procedure code
            GOTO      KPDESC00
          ENDIF
.
KPDESC99  RETURN
.
.*******************************************************************************
. ----  Keyin Procedure reason  ----               * not mandatory
.
KPREAS00  PACK      KEYFIELD,WMREASON,SP70,SP70
          CALL      KFREEF00
          PACK      WMREASON,KEYFIELD,SP20,SP10
KPREAS99  RETURN
.
.*******************************************************************************
.   Keyin date on list : default = today    modified 15/06/1990 Bill Dew
.
KDOLST00
KEYT6000  UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,CHIGHLT
.
          CALL      KEYDATE
          PACK      WMDATE1,CCENT,CYEAR,CMON,CDAY
          REP       " 0",WMDATE1
          MATCH     WMDATE1,TODAY
          GOTO      KEYT6280 IF LESS
KEYT6250  
          MOVE      WMDATE1,WMDATE
          MOVE      WMDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD
          BRANCH    EXIT,NPERD
          RETURN
.
KEYT6280  DISPLAY   *P1:24,*EL,*B,"Date must be today's or past date.  ";
          CALL      HITENTER
.
KEYT6QQQ  MATCH     "*",ANS
          GOTO      KEYT6250 IF EQUAL
          GOTO      KEYT6000
.
NPERD     UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          DISPLAY   *P1:24,*EL,*B,*BLINKON,"Error",*HOFF,*V2LON:
                    " : ",CPCDATE," not found in Period file.  ";
          CALL      HITENTER
          GOTO      KEYT6000
.
.*******************************************************************************
. ----  Keyin date last review  ----               * not mandatory
.                                                  * default = today
KDLRVW00
KEYT6300  MOVE      ZERO,CHIGHLT
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
          REP       " 0",CDAY
          REP       " 0",CMON
.
          CALL      KEYDATE
          PACK      WMDATE2,CCENT,CYEAR,CMON,CDAY
          REP       " 0",WMDATE2
          MATCH     WMDATE2,TODAY
          GOTO      KEYT6380 IF LESS
.
KEYT6325  MATCH     WMDATE1,WMDATE2
          GOTO      KEYT6390 IF LESS
          RETURN
.
KEYT6380  DISPLAY   *P1:24,*EL,*B,"Date cannot be in the future.  ";
          CALL      HITENTER
          GOTO      KEYT6300
.
KEYT6390  DISPLAY   *P1:24,*EL,*B,"Date must be after Date-on-List.  ";
          CALL      HITENTER
          GOTO      KEYT6300
.
.*******************************************************************************
.  Keyin Re-Assessment Date : not mandatory
.
KREDAT00
KEYT6600  
.....     COMPARE   ONE,WTCNREAS       * test sys param for re-assessment date
.....     GOTO      KEYT6999 IF NOT EQUAL
.
.....     MOVE      "25",CCOL
.....     MOVE      TWENTY,CVERT
          MOVE      ZERO,CHIGHLT
          UNPACK    SP8,CDAY,CMON,CYEAR
          MOVE      CCC,CCENT
          CALL      KEYDATE
.
          MATCH     SP2,CDAY
          GOTO      KEYT6930 IF EQUAL
          PACK      WTWMREAD,CCENT,CYEAR,CMON,CDAY
          REPLACE   " 0",WTWMREAD
          MATCH     WMDATE1,WTWMREAD
          GOTO      KEYT6920 IF LESS
          MATCH     TODAY,WTWMREAD
          GOTO      KEYT6910 IF LESS
          GOTO      KEYT6999
KEYT6910
          DISPLAY   *P1:24,*EL,*B:
                    "Re-Assessment Date must be in the future.  ";
          CALL      HITENTER
          GOTO      KEYT6600
KEYT6920
          DISPLAY   *P1:24,*EL,*B:
                    "Re-Assessment Date must be after Date-on-List.  ";
          CALL      HITENTER
          GOTO      KEYT6600
.
KEYT6930  BRANCH    SCPSMAN,KREDAT00              * mandatory?
          MOVE      SP8,WTWMREAD
.
KEYT6999  RETURN
.
.*******************************************************************************
. ----  Keyin estimated stay (days)  ----          * not mandatory
.
.    Modified by Bill Dew 16/08/1990 fix estimated stay to FORM 3 even if
.    WPESTLS is a FORM 5 
.
KESTST00  BRANCH    MODEFLAG,KEYT9006,KEYT9002,KEYT9999
.                            Add      Change   Delete
.
KEYT9002  MOVE      WMSTAY,WPESTLS
.
KEYT9006  KEYIN     *PCCOL:CVERT,*V2LON,*DV,WPESTLS:
                    *PCCOL:CVERT,*RV,WPESTLS:
                    *PCCOL:CVERT,*DV,WPESTLS;
.
          COMPARE   ZERO,WPESTLS       * test less than zero
          GOTO      KESTST00 IF LESS   * Invalid
.
          MOVE      WPESTLS,WMSTAY     * copy keyin estimated stay 
KEYT9999  RETURN
+
.*********************************************************************
.  clinic/unit number    
.*********************************************************************
KUNCLI00
          MOVE      "WU",CODE              * category
          MOVE      WMUNIT,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KUNCLI95 IF EQUAL
          MOVE      ACODE,WMUNIT
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          IF        WTCNWLVW=1
            PACK      KEY9,WMDOCTOR,WMUNIT
            CALL      RDWTVWL1
            IF        OVRCD=1
              DISPLAY   *P1:24,*EL,*B,"Invalid Consultant/List type ":
                        "combination.  ";
              CALL      HITENTER
              GOTO      KUNCLI000
            ELSE
              IF        WTVWSTAT=1
                DISPLAY   *P1:24,*EL,*B,"Consultant/List type is no longer ":
                          "active.  ";
                CALL      HITENTER
                GOTO      KUNCLI000
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ONE,WTCNWLSC            * using security?
          GOTO      KUNCLI50 IF NOT EQUAL
.
          PACK      KEY4,PASSCODE                 * check for ALL Access
          CALL      RDWTSEA1
          COMPARE   ZERO,OVRCD                   
          GOTO      KUNCLI50 IF EQUAL             * ALL Access
          PACK      KEY13,PASSCODE,WMDOCTOR,WMUNIT
          CALL      RDWTSEI2
          BRANCH    OVRCD,KUNCLI70                * no access
.
KUNCLI50  MOVE      "    7",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KUNCLI90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
          GOTO      KUNCLI90
.
KUNCLI70  DISPLAY   *P1:24,*EL,*B,"Invalid security clearance.  ";
          CALL      HITENTER
          GOTO      KUNCLI00
.
KUNCLI90  MOVE      ZERO,EXIT
          GOTO      KUNCLI99
KUNCLI95  MOVE      ONE,EXIT                * EXITCHAR
KUNCLI99  RETURN
+
.***************************************************************************
.*  KATDOC00  :  Attending Doctor                                          *
.***************************************************************************
KATDOC00  MOVE      SP6,CKYIDEF6               * default
          MOVE      ONE,CKYINACT               * SRF 646506
.
          OPEN      PATDO1A2,"patdo1af"
          CALL      PATDOCKY                      * keyin a Doctors code
          CLOSE     PATDO1A2
          COMPARE   TWO,EXIT                      * EXITCHAR ?
          GOTO      KATDOC90 IF EQUAL
          MOVE      DOCCODE,WMDOCTOR
.
          COMPARE   ONE,WTCNWLSC                  * using security?
          GOTO      KATDOC50 IF NOT EQUAL         * no
.
          PACK      KEY4,PASSCODE                 * check for ALL Access
          CALL      RDWTSEA1
          COMPARE   ZERO,OVRCD                   
          GOTO      KATDOC50 IF EQUAL             * ALL Access
          PACK      KEY13,PASSCODE,DOCCODE,SP20
          CALL      RSWTSEI2
          CALL      RKWTSEI2
          BRANCH    OVRCD,KATDOC70                * no access
          MATCH     PASSCODE,WTSIUSER
          GOTO      KATDOC70 IF NOT EQUAL
          MATCH     DOCCODE,WTSICONS
          GOTO      KATDOC70 IF NOT EQUAL
.
KATDOC50  MOVE      "    8",KEY5
          CALL      SCRCKFLD                      * Display code?
          BRANCH    EXIT,KATDOC60                 * no 
          PACK      VAR,DOCCODE,SP70,SP10
          CALL      DISPITEM                      * Display code
.
KATDOC60  MOVE      "    9",KEY5
          CALL      SCRCKFLD                      * Display description?
          BRANCH    EXIT,KATDOC80                 * No
          CALL      DOCN0000                      * set up Doctor's name
          PACK      VAR,PACFNAME,SP70,SP10
          CALL      DISPITEM                      * Display description
          GOTO      KATDOC80
.
KATDOC70  DISPLAY   *P1:24,*EL,*B,"Invalid security clearance.  ";
          CALL      HITENTER
          GOTO      KATDOC00
.
KATDOC80  MOVE      ZERO,EXIT
          GOTO      KATDOC99
.
KATDOC90  MOVE      ONE,EXIT                      * EXITCHAR
.
KATDOC99  RETURN
+
.*********************************************************************
.    Get Priority                    
.*********************************************************************
KPRITY00  MOVE      CODETP,CODE              * category
          MOVE      WMPTY,CKYIDEF3
          MOVE      WMPTY,SAVEPTY 
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KPRITY95 IF EQUAL
          MOVE      ACODE,WMPTY
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   12",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KPRITY90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
KPRITY90  
.    If a new priority code is chosen the routine checks if second indicator
.    is deferred or staged admission if so keyin the date.  Else the WTWMDEDA
.    becomes todays date.
          CALL      DSAD0000                * keyin deferred/stage admiss date
          COMPARE   ONE,MODEFLAG
          GOTO      KPRITY92 IF NOT EQUAL
.
          MOVE      WMPTY,PRIORITY         * insert mode set Priority codes same
KPRITY92  MOVE      ZERO,EXIT
          GOTO      KPRITY99
.
KPRITY95  MOVE      ONE,EXIT                * EXITCHAR

KPRITY99  RETURN
+
.*********************************************************************
.    Get Short Notice code           
.*********************************************************************
KSHNOT00  MOVE      CODEWS,CODE              * category
          MOVE      WMNOTICE,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KSHNOT95 IF EQUAL
          MOVE      ACODE,WMNOTICE
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   14",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KSHNOT90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KSHNOT90  MOVE      ZERO,EXIT
          GOTO      KSHNOT99
KSHNOT95  MOVE      ONE,EXIT                * EXITCHAR
KSHNOT99  RETURN
+
.*********************************************************************
.    Get Patient Classification Code
.*********************************************************************
KPTCLS00  MOVE      CODEA,CODE              * category
          MOVE      WMPCAT,CKYIDEF3
          MOVE      WMPCAT,SDIM3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KPTCLS95 IF EQUAL
          MOVE      ACODE,WMPCAT
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   18",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KPTCLS90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KPTCLS90  MOVE      ZERO,EXIT
          GOTO      KPTCLS99
KPTCLS95  MOVE      ONE,EXIT                * EXITCHAR
KPTCLS99  MATCH     WMPCAT,SDIM3
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
+
.*********************************************************************
.         resident status
.*********************************************************************
KRESID00  MOVE      CODET,CODE              * category
          MOVE      WMPTYPE,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KRESID95 IF EQUAL
          MOVE      ACODE,WMPTYPE
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   16",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KRESID90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KRESID90  MOVE      ZERO,EXIT
          GOTO      KRESID99
KRESID95  MOVE      ONE,EXIT                * EXITCHAR
KRESID99  RETURN
+
.*********************************************************************
.         Patient Category / Admission class
.*********************************************************************
KPTCAT00  MOVE      CODEP,CODE              * category
          MOVE      WTWMCLSS,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KPTCAT95 IF EQUAL
          MOVE      ACODE,WTWMCLSS
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   30",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KPTCAT90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KPTCAT90  MOVE      ZERO,EXIT
          GOTO      KPTCAT99
KPTCAT95  MOVE      ONE,EXIT                * EXITCHAR
KPTCAT99  RETURN
.*******************************************************************************
.                                 DSAD0000
.    keyin deferred or staged admission date.
.    Get the date if in option 4 change procedure details and the priority code
.    has change and then check the second indicator for D P or T
.*******************************************************************************
KSTGAD00
DSAD0000
          COMPARE   TWO,MODEFLAG        * test if the change mode 
          GOTO      DSAD9999 IF NOT EQUAL
          MATCH     PRIORITY,WMPTY     * test for a change in priority code
          GOTO      DSAD9999 IF EQUAL
.
          MOVE      "   28",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,DSAD9999           * Not on the screen
.
          MATCH     ANSD,TCINDC2
          GOTO      DSAD1111 IF EQUAL
          MATCH     ANSP,TCINDC2
          GOTO      DSAD1111 IF EQUAL
          MATCH     ANST,TCINDC2
          GOTO      DSAD1111 IF EQUAL
          GOTO      DSAD8888           * exit routine if not D P T
DSAD1111
          MOVE      SCPSROW,CVERT
          MOVE      SCPSCOL,CCOL
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY

          MOVE      ZERO,CHIGHLT

          CALL      KEYDATE
          BRANCH    OVRCD,DSAD1111
.
          PACK      WTWMDEDA,CCENT,CYEAR,CMON,CDAY
          REP       " 0",WTWMDEDA
          MATCH     TODAY,WTWMDEDA     * test greater than date on list
          GOTO      DSAD6666 IF LESS
          GOTO      DSAD9999
DSAD6666
          DISPLAY   *P1:24,*EL,*B,"Date must be present or future.  ";
          CALL      HITENTER
          GOTO      DSAD1111
DSAD8888
          MOVE      TODAY,WTWMDEDA    * set deferred or stage admission date
          UNPACK    WTWMDEDA,CCENT,CYEAR,CMON,CDAY
          MOVE      "   28",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,DSAD9999           * Not on the screen
          CALL      PACDATE
          PACK      VAR,CPCDATE,SP30,SP30
          CALL      DISPITEM
.
DSAD9999  RETURN
+
.*********************************************************************
.    User defined 1      
.*********************************************************************
KW1USR00  MOVE      "W1",CODE              * category
          MOVE      WMUDEF1,CKYIDEF3
          MOVE      WMUDEF1,SAVEDEF1
.
          MOVE      WTCNSQW1,SUPRSQST       * supress ? value
          CALL      KCODNQST                * keyin a codes field suppress "?"
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW1USR95 IF EQUAL
          MOVE      ACODE,WMUDEF1
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   20",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW1USR90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "1",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW1USR90  MOVE      ZERO,EXIT
          GOTO      KW1USR99
KW1USR95  MOVE      ONE,EXIT                * EXITCHAR
KW1USR99  MATCH     SAVEDEF1,WMUDEF1
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 2      
.*********************************************************************
KW2USR00  MOVE      "W2",CODE              * category
          MOVE      WMUDEF2,CKYIDEF3
          MOVE      WMUDEF2,SAVEDEF2
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW2USR95 IF EQUAL
          MOVE      ACODE,WMUDEF2
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   22",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW2USR90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "2",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW2USR90  MOVE      ZERO,EXIT
          GOTO      KW2USR99
KW2USR95  MOVE      ONE,EXIT                * EXITCHAR
KW2USR99  MATCH     SAVEDEF2,WMUDEF2
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 3      
.*********************************************************************
KW3USR00  MOVE      "W3",CODE              * category
          MOVE      WMUDEF3,CKYIDEF3
          MOVE      WMUDEF3,SAVEDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW3USR95 IF EQUAL
          MOVE      ACODE,WMUDEF3
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   24",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW3USR90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "3",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW3USR90  MOVE      ZERO,EXIT
          GOTO      KW3USR99
KW3USR95  MOVE      ONE,EXIT                * EXITCHAR
KW3USR99  MATCH     SAVEDEF3,WMUDEF3
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 4      
.*********************************************************************
KW4USR00
          MOVE      "W4",CODE              * category
          MOVE      WMUDEF4,CKYIDEF3
          MOVE      WMUDEF4,SAVEDEF4
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW4USR95 IF EQUAL
          MOVE      ACODE,WMUDEF4
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   26",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW4USR90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "4",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW4USR90  MOVE      ZERO,EXIT
          GOTO      KW4USR99
KW4USR95  MOVE      ONE,EXIT                * EXITCHAR
KW4USR99  MATCH     SAVEDEF4,WMUDEF4
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 5      
.*********************************************************************
KW5USR00  MOVE      "X5",CODE              * category
          MOVE      WMUDEF5,CKYIDEF3
          MOVE      WMUDEF5,SAVEDEF5
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW5USR95 IF EQUAL
.
          MOVE      ACODE,WMUDEF5
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   58",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW5USR90           * No
.
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "5",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW5USR90  MOVE      ZERO,EXIT
          GOTO      KW5USR99
.
KW5USR95  MOVE      ONE,EXIT                * EXITCHAR
.
KW5USR99  MATCH     SAVEDEF5,WMUDEF5
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 6      
.*********************************************************************
KW6USR00  MOVE      "X6",CODE              * category
          MOVE      WMUDEF6,CKYIDEF3
          MOVE      WMUDEF6,SAVEDEF6
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW6USR95 IF EQUAL
.
          MOVE      ACODE,WMUDEF6
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   60",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW6USR90           * No
.
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "6",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW6USR90  MOVE      ZERO,EXIT
          GOTO      KW6USR99
.
KW6USR95  MOVE      ONE,EXIT                * EXITCHAR
.
KW6USR99  MATCH     SAVEDEF6,WMUDEF6
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 7      
.*********************************************************************
KW7USR00  MOVE      "X7",CODE              * category
          MOVE      WMUDEF7,CKYIDEF3
          MOVE      WMUDEF7,SAVEDEF7
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW7USR95 IF EQUAL
.
          MOVE      ACODE,WMUDEF7
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   62",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW7USR90           * No
.
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "7",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW7USR90  MOVE      ZERO,EXIT
          GOTO      KW7USR99
.
KW7USR95  MOVE      ONE,EXIT                * EXITCHAR
.
KW7USR99  MATCH     SAVEDEF7,WMUDEF7
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.*********************************************************************
.    User defined 8      
.*********************************************************************
KW8USR00  MOVE      "X8",CODE              * category
          MOVE      WMUDEF8,CKYIDEF3
          MOVE      WMUDEF8,SAVEDEF8
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KW8USR95 IF EQUAL
.
          MOVE      ACODE,WMUDEF8
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   64",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KW8USR90           * No
.
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
          COMPARE   "8",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
.
KW8USR90  MOVE      ZERO,EXIT
          GOTO      KW8USR99
.
KW8USR95  MOVE      ONE,EXIT                * EXITCHAR
.
KW8USR99  MATCH     SAVEDEF8,WMUDEF8
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
.
.*********************************************************************
.    decision to admit date
.*********************************************************************
KDCDAT00  MOVE      ZERO,CHIGHLT
          MOVE      ONE,CCANLDTE
          MOVE      WTWMDTAD,SAVEDTAD
          CALL      IBACLOCK
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
.
          CALL      KEYDATE
          IF        OVRCD = 0 
            PACK      WTWMDTAD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDTAD
          ELSE
            MOVE      SP10,WTWMDTAD
            IF        SCPSMAN=1
              BEEP
              GOTO      KDCDAT00
            ENDIF
            GOTO        KDCDAT99
          ENDIF
.
          MATCH     TODAY,WTWMDTAD
          GOTO      KDCDAT90 IF EQUAL
          GOTO      KDCDAT90 IF LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date must not be into future.  ";
          CALL      HITENTER
          GOTO      KDCDAT00
.
KDCDAT90  MATCH     WMDATE1,WTWMDTAD
          IF        @LESS
            DISPLAY   *P1:24,*EL,*B,"Date must not be before date on list. ";
            CALL      HITENTER
            GOTO      KDCDAT00
          ENDIF
.
KDCDAT99  RETURN
.
.*********************************************************************
.    Guaranteed admission date
.*********************************************************************
KGADMD00  MOVE      ZERO,CHIGHLT
          MOVE      CCC,CCENT
          UNPACK    SP30,CMON,CDAY,CYEAR
.
          CALL      KEYDATE
          IF        OVRCD = 0 
            PACK      WTWMGADD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMGADD
          ELSE
            MOVE      SP10,WTWMGADD
            GOTO      KGADMD99
          ENDIF
.
........  MOVE      "   35",KEY5            * Do Not Admit Before Date
........  CALL      SCRCKFLD                * Check if Painted on the screen
........  BRANCH    EXIT,KGASMD10           * No
.
          MATCH     SP10,WTWMDABD           * Check if Field is Blank
          GOTO      KGASMD10 IF EQUAL
.
          MATCH     WTWMDABD,WTWMGADD       * Check if Field is Valid
          GOTO      KGASMD10 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date may not be before Do Not Admit":
                                  " Before Date.  ";
          CALL      HITENTER
          GOTO      KGADMD00
.
KGASMD10  MATCH     TODAY,WTWMGADD
          GOTO      KGADMD99 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date must be into future.  ";
          CALL      HITENTER
          GOTO      KGADMD00
.
KGADMD99  RETURN
.
.*********************************************************************
.    Do not admit before date
.*********************************************************************
KDNABD00  
.
          MOVE      ONE,SCPSMAN
.         Only Keyin if it is a planned patient
.
          PACK      KEY5,ANSC,ANSC,WTWMEATY,SP5
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSP,TCINDC3
            IF        !@EQUAL
              MOVE      SP10,WTWMDABD
              GOTO      KDNABD99                 * exclude non planned patients
            ENDIF
          ENDIF
.
          MOVE      ZERO,CHIGHLT
          MOVE      CCC,CCENT
          IF        SCPSMAN = 0
            MOVE      ONE,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
          ELSE
            MOVE      ZERO,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
            MOVE      CCC,CCENT
          ENDIF
.
          CALL      KEYDATE
          IF        OVRCD = 0 
            PACK      WTWMDABD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDABD
          ELSE
            MOVE      SP10,WTWMDABD
            IF        SCPSMAN=1
              BEEP
              GOTO      KDNABD00
            ENDIF
          ENDIF
          BRANCH    OVRCD,KDNABD99
.
........  MOVE      "   34",KEY5            * Guaranteed Admission Date
........  CALL      SCRCKFLD                * Check if Painted on the screen
........  BRANCH    EXIT,KDNABD10           * No
.
          MATCH     SP10,WTWMGADD           * Check if Field is Blank
          GOTO      KDNABD10 IF EQUAL
.
          MATCH     WTWMDABD,WTWMGADD       * Check if Field is Valid
          GOTO      KDNABD10 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date may not be after Guarteed Admission":
                                  " Date.  ";
          CALL      HITENTER
          GOTO      KDNABD00
.
KDNABD10  MATCH     TODAY,WTWMDABD
          GOTO      KDNABD99 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date must be into future.  ";
          CALL      HITENTER
          GOTO      KDNABD00
.
KDNABD99  RETURN
.*********************************************************************
.    Administrative category
.*********************************************************************
KADMCT00  MOVE      "CL",CODE              * category
          MOVE      WTWMACAT,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KADMCT95 IF EQUAL
          MOVE      ACODE,WTWMACAT
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   33",KEY5
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KADMCT90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KADMCT90  MOVE      ZERO,EXIT
          GOTO      KADMCT99
KADMCT95  MOVE      ONE,EXIT                * EXITCHAR
KADMCT99  RETURN
+
.
.*********************************************************************
.    Elective Admission type
.*********************************************************************
KELADT00  MOVE      "CC",CODE              * category
          MOVE      WTWMEATY,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KELADT95 IF EQUAL
          MOVE      ACODE,WTWMEATY
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   37",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KELADT90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KELADT90  MOVE      ZERO,EXIT
          GOTO      KELADT99
KELADT95  MOVE      ONE,EXIT                * EXITCHAR
KELADT99  RETURN
.*********************************************************************
.    Admission Category  
.*********************************************************************
KADCAT00  MOVE      "WA",CODE              * category
          MOVE      WTWMADMC,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KADCAT95 IF EQUAL
          MOVE      ACODE,WTWMADMC
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   39",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KADCAT90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KADCAT90  MOVE      ZERO,EXIT
          GOTO      KADCAT99
KADCAT95  MOVE      ONE,EXIT                * EXITCHAR
KADCAT99  RETURN
+
.*******************************************************************************
. ----  Keyin ECR Approval Number -- 
.
KECRAN00  PACK      KEYFIELD,WTWMECRA,SP70,SP70
          CALL      KFREEF00
          PACK      WTWMECRA,KEYFIELD,SP20,SP10
KECRAN99  RETURN
.*******************************************************************************
. ----  Keyin GPFH Approval Number ---
.
KGPFHN00  PACK      KEYFIELD,WTWMGPFA,SP70,SP70
          CALL      KFREEF00
          PACK      WTWMGPFA,KEYFIELD,SP20,SP10
KGPFHN99  RETURN
+
.*********************************************************************
.  KGPCOD00  :  GP Practice code        
.*********************************************************************
KGPCOD00  MOVE      WTWMRFGP,CKYIDEF8       * Referring GP default
          MOVE      WTWMGPPC,CKYIDEF6       * default practice code
          MOVE      WTWMGPPT,CKYIDEF2       * default practice count
          MOVE      SCPSMAN,CKYIMAND        * mandatory?
.
          MOVE      ZERO,CKACTIVE
          CALL      PMSHCGKY                * keyin GP Practice code
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KGPCOD99
          ENDIF
.
          MOVE      CKYIDEF6,WTWMGPPC       * set GP practice code
          MOVE      CKYIDEF2,WTWMGPPT       * set GP practice count
          CALL      DISPVARS
.
          MOVE      "   45",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KGPCOD90
          PACK      VAR,PMHGPNAM,SP70,SP10
          CALL      DISPITEM
.
KGPCOD90  MOVE      ZERO,EXIT
          GOTO      KGPCOD99
.
KGPCOD95  MOVE      ONE,EXIT
.
KGPCOD99  RETURN
+
.*********************************************************************
.  Referring GP                   
.*********************************************************************
KREFGP00  IF        ICMODE = 0
            MOVE      PMPXRHC1,CKYIDEF8
            MOVE      PMPXRH1G,CKYIDEF6
            MOVE      PMPXR1GC,CKYIDEF2
          ELSE
            PACK      WTWMRFGP,WTWMRFGP,SP8
            MATCH     WTWMRFGP,SP8
            IF        @EQUAL
              MOVE      PMPXRHC1,CKYIDEF8
              MOVE      PMPXRH1G,CKYIDEF6
              MOVE      PMPXR1GC,CKYIDEF2
            ELSE
              MOVE      WTWMRFGP,CKYIDEF8
              MOVE      WTWMGPPC,CKYIDEF6
              MOVE      WTWMGPPT,CKYIDEF2
            ENDIF
          ENDIF
          MOVE      SCPSMAN,CKYIMAND
.
          MOVE      ZERO,CKACTIVE
          CALL      PMSHCPKY                      * keyin registered GP code
          IF        EXIT = 2
            MOVE      SP8,WTWMRFGP
            MOVE      ONE,EXIT
            GOTO      KREFGP99
          ENDIF
.
          MOVE      CKYIDEF8,WTWMRFGP
          MOVE      CKYIDEF6,WTWMGPPC
          MOVE      CKYIDEF2,WTWMGPPT
          CALL      DISPVARS
.
          MOVE      "   43",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KREFGP60
          PACK      VAR,PMHCSNAM,SP70,SP10
          STRIP     VAR
          ENDSET    VAR
          APPEND    SP1,VAR
          APPEND    PMHCGNAM,VAR
          APPEND    SP70,VAR
          RESET     VAR
          CALL      DISPITEM
.
KREFGP60  IF        ICMODE = 1
            MOVE      "   44",KEY5
            CALL      SCRCKFLD
            BRANCH    EXIT,KREFGP90
.
            CALL      KGPCOD00
          ENDIF
.
KREFGP90  MOVE      ZERO,EXIT
.
KREFGP99  RETURN
.
.*********************************************************************
.         routine to load varible for mandatary check
.*********************************************************************
MYWATTRE  MOVE      SCPSITM,FORM5
          LOAD      DIM80,FORM5,WMTIME,WMDESC,WMREASON,WMDATE1,WMDATE2:      
                                WMUNIT,ANSA,WMDOCTOR,ANSA,WMSTAY:           10
                                WMPTY,ANSA,WMNOTICE,ANSA,WMPTYPE:
                                ANSA,WMPCAT,ANSA,WMUDEF1,ANSA:              20
                                WMUDEF2,ANSA,WMUDEF3,ANSA,WMUDEF4:
                                ANSA,WTWMREAD,WTWMDEDA,WTWMCLSS,ANSA:       30
                                WTWMDTAD,WTWMACAT,ANSA,WTWMGADD,WTWMDABD:
                                WTWMEATY,ANSA,WTWMADMC,ANSA,WTWMECRA:       40
                                WTWMGPFA,WTWMRFGP,ANSA,WTWMGPPC,ANSA:
                                WTWMNAFR,WMDATE3,ANSA,WMDATE4,WMREASON:     50
                                ANSA,WTWMDOFR,ANSA,WTWMRFGP,ANSA:
                                ANSA,WMUDEF5,ANSA,WMUDEF6,ANSA:             60
                                WMUDEF7,ANSA,WMUDEF8,ANSA,WTWMRANK:
                                ANSA,ANSA,ANSA,ANSA,ANSA:                   70
                                ANSA
          RETURN
+
.*********************************************************************
.         clear all the input variables
.*********************************************************************
CLWATDET  MOVE      ZEROUR,WMURNO
          MOVE      SP30,WMCODE
          MOVE      ZERO,WMCNT
          MOVE      ZERO,WMTIME
          PACK      WMDESC,SP30,SP30
          PACK      WMREASON,SP30,SP30
          MOVE      ZERO,WMSTAT
          UNPACK    SP20,WMDATE1,WMDATE2
          UNPACK    SP20,WMDATE3,WMDATE4
          UNPACK    SP20,WMREMOVE,WMUNIT,WMDOCTOR
          MOVE      ZERO,WMSTAY
          UNPACK    SP30,WMPTY,WMNOTICE,WMPTYPE,WMPCAT,WMUDEF1,WMUDEF2:
                         WMUDEF3,WMUDEF4
          MOVE      ZERO,WMBOOK
          UNPACK    SP30,WMKEYDT,WTWMPORT,WTWMREAD,WTWMDEDA
          MOVE      ZERO,WTWMSENT
          UNPACK    SP30,WTWMCLSS,WTWMDTAD,WTWMACAT,WTWMGADD,WTWMDABD
          MOVE      SP3,WTWMEATY
          MOVE      SP3,WTWMADMC
          MOVE      SP20,WTWMECRA
          MOVE      SP20,WTWMGPFA
          UNPACK    SP20,WTWMRFGP,WTWMGPPC,WTWMGPPT
          UNPACK    SP20,WTWMNAFR,WTWMNATO
          MOVE      SP3,WTWMDOFR
          MOVE      SP3,WMUDEF5
          MOVE      SP3,WMUDEF6
          MOVE      SP3,WMUDEF7
          MOVE      SP3,WMUDEF8
          MOVE      "     0",WTWMRANK
          UNPACK    SP30,WTWMSRCR,WTWMDRSA,WTWMDOSA
          UNPACK    SP30,WTWMPHSP,WTWMBSCD,WTWMRSFL
          RETURN
+
.*********************************************************************
.         Keyin Procedure Code
.*********************************************************************
KPROCC00  
          PACK      SAVPROC,PROCCODE,SP70
.
KPROCC20
          PACK      WMDESC,SP30,SP30             * initialise defaults
          PACK      WPDESC,SP30,SP30
          PACK      DDESCWU,SP30,SP30
          MOVE      ZERO,WMTIME                  * initialise defaults
          MOVE      ZERO,WPTIME
          DISPLAY   *P25:PCVERT,*EL,UNDLN9;
.
          KEYIN     *P25:PCVERT,*V2LON,PROCCODE;
          ENDSET    PROCCODE
          APPEND    SP30,PROCCODE
          RESET     PROCCODE
.
          MATCH     SP9,PROCCODE                 * nothing entered
          IF        @EQUAL
            MATCH     SP9,SAVPROC                * any default ?
            GOTO      KPROCC60 IF EQUAL
            PACK      PROCCODE,SAVPROC,SP70
          ENDIF
.
          CMATCH    EXITCHAR,PROCCODE            * exitchar "\"
          IF        @EQUAL
            MATCH     SP9,SAVPROC                * any default ?
            GOTO      KPROCC90 IF EQUAL
            PACK      PROCCODE,SAVPROC,SP70
          ENDIF
.
          DISPLAY   *P25:PCVERT,*V2LON,PROCCODE;
.
          CMATCH    QUEST,PROCCODE               * ? option
          GOTO      KPROCC30 IF EQUAL
          PACK      KEY9,PROCCODE                * code must exist in WATPROFD
          CALL      RDPROA1
          BRANCH    OVRCD,KPROCC60
          COMPARE   ONE,WTWPACTV
          IF        @EQUAL
            DISPLAY   *P1:24,*V2LON,"Inactive Code.";
            CALL      HITENTER
            GOTO      KPROCC20
          ENDIF
          GOTO      KPROCC95
.
KPROCC30  MOVE      ZERO,HLEF                    * Whole Screen
          CALL      GETSCR00                     * save screen
.
KPROCC40  MOVE      ZERO,DISPACT
          CALL      WATDSPRO                     * display all codes + descrip
.
KPROCC50  DISPLAY   *P1:24,*EL,WTCNTPDS," code : ",UNDLN9;
          KEYIN     *P18:24,*V2LON,PROCCODE;
          ENDSET    PROCCODE
          APPEND    SP30,PROCCODE
          RESET     PROCCODE
.
          CMATCH    QUEST,PROCCODE               * ? option
          GOTO      KPROCC40 IF EQUAL
.
          MATCH     SP9,PROCCODE                 * nothing entered
          IF        @EQUAL
            PACK      PROCCODE,SAVPROC,SP70      * use default (if set)
          ENDIF
.
          CMATCH    EXITCHAR,PROCCODE            * exitchar "\"
          IF        @EQUAL
            MATCH     SP9,SAVPROC                * any default ?
            GOTO      KPROCC80 IF EQUAL
            PACK      PROCCODE,SAVPROC,SP70
          ENDIF
.
          PACK      KEY9,PROCCODE                * code must exist in WATPROFD
          CALL      RDPROA1
          BRANCH    OVRCD,KPROCC70
.
          COMPARE   ONE,WTWPACTV
          GOTO      KPROCC65 IF EQUAL
.
          CALL      PUTSCR00                     * restore screen
          DISPLAY   *P25:PCVERT,*V2LON,PROCCODE
          GOTO      KPROCC95                     * exit routine
.
KPROCC60  DISPLAY   *P1:24,*EL,*B,"Invalid ",WTCNTPDS," Code.  ";
          CALL      HITENTER
          GOTO      KPROCC20
.
KPROCC65  DISPLAY   *P1:24,*EL,*B,"Inactive Code. ";
          CALL      HITENTER
          GOTO      KPROCC50
.
KPROCC70  DISPLAY   *P1:24,*EL,*B,"Invalid ",WTCNTPDS," Code.  ";
          CALL      HITENTER
          GOTO      KPROCC50
.
KPROCC80  CALL      FRESCR00                * Free the Saved the Screen
.
KPROCC90  MOVE      TRUE,EXIT
          GOTO      KPROCC99
.
KPROCC95  
          MOVE      WPDESC,WMDESC                * stick WP.. default in WM..
          MOVE      WPTIME,WMTIME
          MOVE      WPESTLS,WMSTAY
.
.
KPROCC99  RETURN
+
.*********************************************************************
.    Keyin the not available dates
.*********************************************************************
KNAVRG00  DISPLAY   *PCCOL:CVERT,SP20,SP5
          MOVE      ZERO,CHIGHLT
          MOVE      CCC,CCENT
          UNPACK    SP20,WTWMNAFR,WTWMNATO
          IF        SCPSMAN = 0
            MOVE      ONE,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
          ELSE
            MOVE      ZERO,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
            MOVE      CCC,CCENT
          ENDIF
.
          CALL      KEYDATE
          IF        OVRCD = 0 
            PACK      WTWMNAFR,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMNAFR
          ELSE
            MOVE      SP10,WTWMNAFR
            IF        SCPSMAN=1
              BEEP
              GOTO      KNAVRG00
            ENDIF
          ENDIF
.
          MATCH     SP8,WTWMNAFR           * Check if Field is Blank
          GOTO      KNAVRG99 IF EQUAL
          BRANCH    OVRCD,KNAVRG00
.
          MOVE      CCOL,FORM2
          ADD       TEN1,CCOL
          DISPLAY   *PCCOL:CVERT,"to"
          ADD       THREE,CCOL
          CALL      KEYDATE
          
          IF        OVRCD = 0 
            PACK      WTWMNATO,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMNATO
          ELSE
            MOVE      SP10,WTWMNATO
            IF        SCPSMAN=1
              BEEP
              MOVE      FORM2,CCOL
              GOTO      KNAVRG00
            ENDIF
          ENDIF
          BRANCH    OVRCD,KNAVRG00
.
.
KNAVRG90  MATCH     WTWMNAFR,WTWMNATO
          GOTO      KNAVRG99 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date must be in sequence.  ";
          CALL      HITENTER
          MOVE      FORM2,CCOL
          GOTO      KNAVRG00
.
KNAVRG99  RETURN
.
.*********************************************************************
.    SCHEDULED ADMISSION DATE
.*********************************************************************
.
KSADAT00 MOVE      ZERO,CHIGHLT
          MOVE      CCC,CCENT
          IF        SCPSMAN = 0
            MOVE      ONE,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
          ELSE
            MOVE      ZERO,CCANLDTE
            UNPACK    SP30,CMON,CDAY,CYEAR
            MOVE      CCC,CCENT
          ENDIF
.
          CALL      KEYDATE
          IF        OVRCD = 0 
            PACK      WMDATE3,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WMDATE3
          ELSE
            MOVE      SP10,WMDATE3
            IF        SCPSMAN=1
              BEEP
              GOTO      KSADAT00
            ENDIF
          ENDIF
          BRANCH    OVRCD,KSADAT95
.
KSADAT10  MATCH     TODAY,WMDATE3  
          GOTO      KSADAT95 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Date must be into future.  ";
          CALL      HITENTER
          GOTO      KSADAT00
.
KSADAT95  IF        MODEFLAG = 2 
            CALL      GETRSC00              * get reason for change
          ENDIF
          MOVE      WMDATE3,SAVESCHA
.
KSADAT99  RETURN
.
.*********************************************************************
.         District of Residence
.*********************************************************************
KWDOFR00  MOVE      "DA",CODE              * category
          MOVE      WTWMDOFR,CKYIDEF3
.
          CALL      PATCODKY                * keyin a codes field
          COMPARE   TWO,EXIT                * EXITCHAR?
          GOTO      KWDOFR95 IF EQUAL
          MOVE      ACODE,WTWMDOFR
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   53",KEY5  
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KWDOFR90           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
KWDOFR90  MOVE      ZERO,EXIT
          GOTO      KWDOFR99
KWDOFR95  MOVE      ONE,EXIT                * EXITCHAR
KWDOFR99  RETURN
+
.*********************************************************************
.  Referring GP - not related to a practice
.*********************************************************************
KGPNPR00  IF        ICMODE = 0
            MOVE      PMPXRHC1,CKYIDEF8
          ELSE
            PACK      WTWMRFGP,WTWMRFGP,SP8
            MATCH     WTWMRFGP,SP8
            IF        @EQUAL
              MOVE      PMPXRHC1,CKYIDEF8
            ELSE
              MOVE      WTWMRFGP,CKYIDEF8
            ENDIF
          ENDIF
          MOVE      SCPSMAN,CKYIMAND
.
          CALL      KYPMHCPB                      * keyin registered GP code
          IF        EXIT = 2
            MOVE      SP8,WTWMRFGP
            MOVE      ONE,EXIT
            GOTO      KGPNPR99
          ENDIF
.
          MOVE      PMHCHCPC,WTWMRFGP
          UNPACK    SP70,WTWMGPPC,WTWMGPPT
          CALL      DISPVARS
.
          MOVE      "   43",KEY5
          CALL      SCRCKFLD
          BRANCH    EXIT,KGPNPR90
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
          PACK      VAR,PACFNAME,SP30,SP30,SP30
          CALL      DISPITEM
.
KGPNPR90  MOVE      ZERO,EXIT
.
KGPNPR99  RETURN
.******************************************************************************
.* KPRANK00 - Keyin Patient Rank                                    
.******************************************************************************
KPRANK00  MOVE      WTWMRANK,FORM6 
          KEYIN     *PCCOL:CVERT,*V2LON,*DV,FORM6:   
                    *PCCOL:CVERT,*RV,FORM6:
                    *PCCOL:CVERT,*DV,FORM6;
.
          COMPARE   ZERO,FORM6      * test less than zero
          IF        @LESS
            DISPLAY   *P1:24,*EL,*B,"Cannot be Less Than Zero. ";
            CALL      HITENTER
            GOTO      KPRANK00
          ENDIF
.
          MOVE      FORM6,WTWMRANK
.
KPRANK99  RETURN
+
.******************************************************************************
.* KSRREF00 - Keyin Source of referral
.******************************************************************************
KASRCE00  MOVE      CATS,CODE 
          PACK      CKYIDEF3,WTWMSRCR
.
          CALL      PATCODKY                     * keyin a codes field
          COMPARE   TWO,EXIT                     * EXITCHAR ?
          GOTO      KASRCE30 IF EQUAL
          MOVE      ACODE,WTWMSRCR 
.
          MOVE      "   67",KEY5
          CALL      SCRCKFLD                     * display description
          BRANCH    EXIT,KASRCE30                * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM
.
KASRCE20  COMPARE   "9",PTCNCSRL
          GOTO      KTSRCC00 IF EQUAL
          GOTO      KASRCE99
.
KASRCE30  MOVE      ONE,EXIT                     * EXITCHAR input
.
KASRCE99  RETURN
+
.******************************************************************************
.* KSRREF00 - Transfer Source Code    
.******************************************************************************
. check if we want to keyin the Transfer Source code
.
KTSRCC00  MOVE      SP10,WTRTREFR
          COMPARE   ONE,PTCNUADT
          GOTO      KTSRCC99 IF NOT EQUAL
.
          MATCH     SP3,ACODE   
          GOTO      KTSRCC99 IF EQUAL
.
          MATCH     "1",TCINDC2                  * Adm. Source's ind. 2 = "1" ?
          GOTO      KTSRCC99 IF NOT EQUAL        * no
.
          CALL      KRFHOS00                     * Keyin referring hospital
          MOVE      ZERO,EXIT
          GOTO      KTSRCC99
.
KTSRCC30  MOVE      ONE,EXIT                     * EXITCHAR input
.
KTSRCC99  RETURN
+
.****************************************************************************
.*  KRFHOS00  :   Keyin referring hospital                                  *
.****************************************************************************
KRFHOS00  OPEN      PATVADA1,"patvadaf"
          OPEN      PATVADA2,"patvadaf"
KRFHOS10  DISPLAY   *P1:24,*EL,"Referring Hospital :";
.
          KEYIN     *P22:24,*DV,UNDLN5,*P22:24,*V2LON,WTRTREFR;
          ENDSET    WTRTREFR
          APPEND    SP5,WTRTREFR
          RESET     WTRTREFR
.
          MATCH     SP5,WTRTREFR
          GOTO      KRFHOS20 IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Input Is Mandatory. ";
          CALL      HITENTER
          GOTO      KRFHOS10
.
KRFHOS20  DISPLAY   *P22:24,*V2LON,WTRTREFR;
          CMATCH    QUEST,WTRTREFR
          GOTO      KRFHOS30 IF NOT EQUAL
          MOVE      ZERO,HLEF
          CALL      GETSCR00                      * save screen
.
KRFHOS21  CALL      PATVADDS                      * PATVADFD file scan
          BRANCH    OVRCD,KRFHOS50
.
KRFHOS22  MOVE      SP5,WTRTREFR
          DISPLAY   *P1:24,*EL,"Referring Hospital :";
.
          KEYIN     *P22:24,*DV,UNDLN5,*P22:24,*V2LON,WTRTREFR;
          ENDSET    WTRTREFR
          APPEND    SP5,WTRTREFR
          RESET     WTRTREFR
.
          MATCH     SP5,WTRTREFR
          GOTO      KRFHOS23 IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Input Is Mandatory. ";
          CALL      HITENTER
          GOTO      KRFHOS22
.
KRFHOS23  CMATCH    QUEST,WTRTREFR
          GOTO      KRFHOS21 IF EQUAL
          MOVE      WTRTREFR,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,KRFHOS24
          MOVE      PTVADESC,DSRCE
          CALL      PUTSCR00                      * restore screen
          GOTO      KRFHOS55
.
KRFHOS24  DISPLAY   *P1:24,*EL,*B,"Invalid Referring Hospital. ";
          CALL      HITENTER
          GOTO      KRFHOS22
.
KRFHOS30  MOVE      WTRTREFR,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,KRFHOS40
          MOVE      PTVADESC,DSRCE
          GOTO      KRFHOS55
.
KRFHOS40  DISPLAY   *P1:24,*EL,*B,"Invalid Referring Hospital. ";
          CALL      HITENTER
          GOTO      KRFHOS10
.
KRFHOS50  MOVE      SP5,WTRTREFR
          MOVE      TDESC,DSRCE
          CALL      PUTSCR00                      * restore screen
.
KRFHOS55  LOAD      KEY5,PTCNCSRL,DISW1,DISW2,DISW3,DISW4,DISX5:
                                  DISX6,DISX7,DISX8,DISS
          CALL      SCRCKFLD                      * display description
          BRANCH    EXIT,KRFHOS90                 * No.
          PACK      VAR,DSRCE,SP70,SP10
          CALL      DISPITEM
.
KRFHOS90  DISPLAY   *P1:24,*EL;
          CLOSE     PATVADA1
          CLOSE     PATVADA2
KRFHOS99  RETURN
+
.*******************************************************************************
.*      Keyin Date of Referral for First Specialist Assessment    
.*******************************************************************************
KDRFSA00  MOVE      ZERO,CHIGHLT
          MOVE      WTWMDRSA,SDIM8
          MOVE      CCC,CCENT
          UNPACK    SP30,CDAY,CMON,CYEAR
          UNPACK    WTWMDRSA,CCENT,CYEAR,CMON,CDAY
.
          CALL      KEYDATE
          IF        OVRCD = 0
            PACK      WTWMDRSA,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDRSA
          ELSE
            MOVE      SP10,WTWMDRSA
          ENDIF
.
KDRFSA99  MATCH     WTWMDRSA,SDIM8
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
+
.*******************************************************************************
.*      Keyin Date of First Specialist Assessment    
.*******************************************************************************
KDOFSA00  MOVE      ZERO,CHIGHLT
          MOVE      WTWMDOSA,SDIM8
          UNPACK    SP30,CDAY,CMON,CYEAR
          MOVE      CCC,CCENT
          UNPACK    WTWMDOSA,CCENT,CYEAR,CMON,CDAY
.
          CALL      KEYDATE
          IF        OVRCD = 0
            PACK      WTWMDOSA,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDOSA
          ELSE
            MOVE      SP10,WTWMDOSA
          ENDIF
.
          RESET     WTWMDRSA            * Date of referral null?
          GOTO      KDOFSA99 IF EOS
.
          MATCH     WTWMDOSA,WTWMDRSA   * Date of ref must be less than
          GOTO      KDOFSA99 IF LESS    * assessment date
          GOTO      KDOFSA99 IF EQUAL   * assessment date
.
          DISPLAY   *P1:24,*EL,"Date of Referral for FSA must be less than ":
                               "FSA date ";
          CALL      HITENTER
          GOTO      KDOFSA00
.
KDOFSA99  MATCH     WTWMDOSA,SDIM8
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
+
.*********************************************************************
.    Principal Health Service Provider (Cat HP)
.*********************************************************************
KPHSP000  MOVE      CODEHP,CODE              * category
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*124,PTCNHPCD
          MOVE      WTWMPHSP,CKYIDEF3
          MOVE      WTWMPHSP,SDIM3
          MATCH     SP3,WTWMPHSP            * default code
          IF        @EQUAL
            MOVE      PTCNHPCD,CKYIDEF3
          ENDIF
.
          CALL      PATCODKY                * keyin a codes field
          MOVE      ACODE,WTWMPHSP
          PACK      VAR,ACODE,SP70,SP10
          CALL      DISPITEM                * Display code
.
          MOVE      "   71",KEY5
          CALL      SCRCKFLD                * Display description?
          BRANCH    EXIT,KPHSP999           * No
          PACK      VAR,TDESC,SP70,SP10
          CALL      DISPITEM                * Display description
.
KPHSP999  MATCH     WTWMPHSP,SDIM3
          IF        !@EQUAL
            MOVE      ONE,CHGFLAG
          ENDIF
          RETURN
+
