.******************************************************************************
.* System         : Patient Management                                        *
.* Program        : IBAADT13.PBL                                              *
.* Name           : Patient Search                                            *
.******************************************************************************
.* Date           : 03.07.1996                                                *
.* Author         : B.G.Ackland                                               *
.* Function       : Allow a Surname Search on the Patient Master              *
.*                  for Sundry Debtors. This program will exist in each       *
.*                  release of the Patient System.                            *
.*                                                                            *
.*                  This programs is designed to be FORKed to from programs   *
.*                  that need to perform a Surname Search. The COMMON         *
.*                  variable ERROR is used to pass a temporary file name      *
.*                  from the calling program. If a Patient is Selected the    *
.*                  U/R will be written to the temporary file.                *
.*                                                                            *
.* Modifications  :                                                           *
.*                                                                            *
.* V10.13.01 05/12/2018  Don Nguyen       TSK 0838558                         *
.*           Deleted temp file (RETURNFL) on program exit                     *
.* V10.02.01 07/07/2011  Steve Armstrong  CAR 240722                          *
.*           Added RDPMPX21 prior to calling PMIHEAD                          *
.******************************************************************************
.* V10.01.01 03/02/2011 Jill Parkinson CAR 233088                             *
.*           Added pmsvx1af                                                   *
.******************************************************************************
.* V9.03.01  29/10/2003 Sandra Barcham     43783                              *
.*           Recompiled for NZHISIIO and NZHISIUP                             *
.******************************************************************************
.* V9.02.01  06/02/2003  Lina Vo        SRF22709                              *
.*           Remove open of outpreaf. Not used.                               *
.* V9.02.00  10/12/2002  Tracey Nguyen  SRF34292                              *
.*           Ported program from V5.10 to V9.02                               *
.*           Removed all references to PATSURFD and PTCNSNDX replaced         *
.*           with references to PATGSRFD/PATGSRIO.                            *
.*           Included PMSVX1FD as required by routine ACTCOMN1.PBL            *
.*============================================================================*
.*        V5.08.01  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.04.02  14/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.******************************************************************************
.
.         FD's required
.
          INC       STD001FD/PBL
          INC       NZHISIFD/INC            * NZ HIS Definitions
          INC       BOKRC1FD/INC            * booking file
          INC       OUTPREFD/INC            * OP pre-attendance file
          INC       NHIMASFD/INC            * patient Alerts for 0 U/R's
          INC       PATALRFD/INC            * patient Alerts for 0 U/R's
          INC       PATCALAG/INC            * for calcage
          INC       PATCODFD/INC            * patient codes file
          INC       PATCOMM/INC             * variables for surname search
          INC       PATCONFD/INC            * control file
          INC       PATDHEAD/INC            * for PMI head
          INC       PATDNRFD/INC            * patient donor details file
          INC       PATMA1FD/INC            * patient master file
          INC       PATMI1FD/INC            * admission file
          INC       PATNIDFD/INC            * patient national number file (nz)
          INC       PATPR1FD/INC            * pre-admission file
          INC       PATSDNFD/INC            * donor (booking) file
          INC       PATSMWFD/INC            * medical warning for 0 U/R's
          INC       PATGSRFD/INC            * surname & given name file
          INC       PMIVARS/INC
          INC       PMSPX2FD/INC
          INC       SCRPSTFD/INC
.
. ------- include needed for 'ACTCOMN1.PBL' -------
.
          INC       PMSVX1FD/INC

.
Z15       INIT      "zzzzzzzzzzzzzzz"
.
BJDAY     FORM      4
CHG       FORM      1
CJDAY     FORM      4
CMDLINE   DIM       80
COUNT     FORM      3
FORM3     FORM      3
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
MODE1     DIM       1
FILENAME  DIM       8
RETURNFL  FILE      ASCII, FIXED=100
SCNDGNAM  DIM       40
.
PRGID     INIT      "IBAADT13"
PRGNAM    INIT      "Patient Search"
VERSION   INIT      "V12.00.00"
.*********************************************************************
.*                  MAINLINE                                         *
.*********************************************************************
          MOVE      ERROR,FILENAME
          MATCH     SP70,ERROR
          IF        @EQUAL
            MOVE      "testfile",FILENAME
          ENDIF
.
          CALL      INIT0000
.
ML1000    DISPLAY   *P1:3,*EF
          CALL      KURSCH00                * ? Selected
          IF        FORM1=0
            BRANCH    EXIT,ML9000,ML9000
          ELSE
            BRANCH    EXIT,ML1000,ML1000
          ENDIF
.
. Validate the U/R number Selected from ?
.
          MOVE      ZERO,EXIT               * U/R number entered
          MOVE      CPPURNO,PURNO           * Move to the master file variable
          IF        PTCNNHII=1
            CALL      KURNHI00
            BRANCH    EXIT,ML1000,ML9000   * re-enter,doesnt exist
            GOTO      ML2000
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1                 * Validate U/R number against PMI
          COMPARE   ZERO,OVRCD
          GOTO      ML2000 IF EQUAL       * Valid UR so Continue
.
          MOVE      ZERO,OVRCD
          COMPARE   ZERO,PTCNNMPI
          PROC      VALURNMP IF NOT EQUAL   * check if on patnmpaf
          BRANCH    OVRCD,ML9000,ML1000
.
. Check if this is an associated U/R number
.-------------------------------------------
ML2000    MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ML9000
.
          COMPARE   ONE,PSTAT               * Is this an associated U/R number ?
          GOTO      ML2500 IF NOT EQUAL   * No
.
          CALL      ASSURN00                * Yes, Get Associated UR Details
          BRANCH    EXIT,KURN0000           * Abort Selected
.
          DISPLAY   *PCCOL:CVERT,*V2LON,CPPURNO
.
ML2500    PROC      KNWLUE00                * write last U/R entered
.
          CALL      PMIHEAD
          DISPLAY   *P1:24,*EL;
ML8000    KEYIN     *P1:24,"Correct Patient (",*V2LON,"Y",*HOFF,"/":
                                    *V2LON,"N",*HOFF,") ? ",*V2LON,ANS
          REP       UPPLOW,ANS
          MATCH     ANSN,ANS
          GOTO      ML1000 IF EQUAL
          MATCH     ANSY,ANS
          GOTO      ML8000 IF NOT EQUAL
.
          PREP      RETURNFL,FILENAME       * Write U/R to Return File
          WRITE     RETURNFL,SEQ;PURNO,SP30
          GOTO      ML9999
.
ML9000    PREP      RETURNFL,FILENAME       * Make Sure File is Deleted
          CLOSE     RETURNFL,DELETE
          GOTO      ML9999
.
ML9999    MOVE      SP30,ERROR              * Clear Common Field
          CLOCK      FORK,KEY2
          MATCH      " 0",KEY2
          IF         @EQUAL
            CHAIN     PGM
          ELSE
            STOP
          ENDIF
.
REDISPS   
GETSVAR   RETURN
+
.
INIT0000  CALL      DISPHEAD
          DISPLAY   *P50:24,"Opening "
          DISPLAY   *P58:24,"controlf"
          OPEN      CONTROLF,"controlf"          * files to open
          DISPLAY   *P58:24,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
.         DISPLAY   *P58:24,"outpreaf"
.         OPEN      OUTPREA1,"outpreaf"
          DISPLAY   *P58:24,"patma1af"
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P58:24,"patmx1af"
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P58:24,"pmspx2af"
          OPEN      PMSPX2A1,"pmspx2af"
          DISPLAY   *P58:24,"patmi1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          DISPLAY   *P58:24,"patpramf"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
          DISPLAY   *P58:24,"patpraxf"
.
          READ      CONTROLF,TEN9;*75,CCNOTES
          READ      CONTROLF,FIFTY9;*132,CALRDESC,*231,PTCNRGNS
.
          DISPLAY   *P58:24,"patgsrnf"
          OPEN      PATGSRN1,"patgsrnf"     * surname & given name
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          CALL      SRCHCLR             * Clear the surname search parameters
          MOVE      SP8,CPPURNO         * Initialise U/R Number ( 8 chars)
          MOVE      SP8,PURNO           * Initialise U/R Number ( 8 chars)
          MOVE      SP20,C12URNO        * Initialise U/R Number (12 chars)
          MOVE      SP20,C17URNO        * Initialise U/R Number (17 chars)
          MOVE      SP20,CMPURNO        * Initialise U/R Number (20 chars)
          MOVE      SP20,NMPNUMB
          MOVE      ONE,NZHISMOD        * clear for NZHIS Change Indicator
          READ      CONTROLF,FIFTY9;*234,CPNMPICK
          READ      CONTROLF,TWENTY1;*55,SRCHDOBS,*138,PTCNNHII
          READ      CONTROLF,FIFTY9;*234,PTCNNMPI
          RETURN
.
OPEN0000
CLOS0000  RETURN
.
.         I/O includes needed
.
          INC       STD001IO/PBL
.
          INC       AGECHK
          INC       BOKRC1IO/INC            * booking file
          INC       CALCAGE                 * calculate age
          INC       CLPATMAS                * 
          INC       NHIMASIO/INC            * national/iba code translation file
          INC       NZHISIIO                * 
          INC       NZIBSRCH                * 
          INC       OUTPREIO/INC            * OP pre-attendance file
          INC       PATALERT
          INC       PATALRIO/INC            * patient Alerts for 0 U/R's
          INC       PATCOMN1/PBL            * holds KURN
          INC       PATDNRIO/INC            * patient donor details file
          INC       PATCODIO/INC            * patient codes file
          INC       PATMA1IO/INC            * patient master file
          INC       PATMI1IO/INC            * admission file
          INC       PMSVX1IO/INC            * admission file
          INC       PATPR1IO/INC            * pre-admission file
          INC       PATGSRIO/INC            * surname & given name file
          INC       PATNIDIO/INC            * patient national number file
          INC       PATSDNIO/INC            * donor (booking) file
          INC       PATSMWIO/INC            * medical warning for 0 U/R's
          INC       PATSNDX/PBL             * ? for surnames only
          INC       PATSNX2/PBL             * ? for surnames/given names
          INC       PMIHEAD
          INC       PMSPX2IO/INC
.
