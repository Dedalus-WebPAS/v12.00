.------------------------------------------------------------------------------
. Program       : FMSWEB05
.
. Function      : Financial Management Account Maintenance Server for 
.                 Report 1: Cheque Account Maintenance                    
.                 Report 2: Remote script - validate Cheque Account 
.                 Report 3: Account Search
.                 Report 4: EFTPOS Terminal Maintenance
.
. Modifications :
. V11.03.01  09/01/2023  Bella Turco    TSK 0921957
.            Added NOMORE00 - Display "No more records" at end of list
.            Added PTCNNRTD - Displays number of rows set by parameter value
. V10.04.01  31.03.2014  B.G.Ackland  CAR 299363
.            Replace META Tag Redirect with Javascript in Common RDIREC00
.            Routine
.------------------------------------------------------------------------------
. V10.03.01  23/11/2012  Ania P.       CAR 274932
.            Added Report option 4
.------------------------------------------------------------------------------
. V9.05.B01  30/01/2006  Ebon Clements CAR 93186
.            Mods for REDIRECT length change. Recompiled for IBAWEBDF
.------------------------------------------------------------------------------
. V9.03.02   24.04.2004 Lina Vo        CAR 49281
.            Increased size of STARTKEY from 3 to 25.
. V9.03.01   06.11.2003 Lina Vo        CAR 36497
.            Added Account Search from PRIWEB01.
.------------------------------------------------------------------------------
.
.------------------------------------------------------------------------------
. FD Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       RSHWEBDF
.
          INC       FMSAMAFD/INC            * Accounts
          INC       FMSCAFFD/INC
          INC       FMSCHQFD/INC
          INC       FMSCSAFD/INC
          INC       FMSLMAFD/INC            * Ledger
          INC       FMSEPTFD/INC            * EFTPOS Terminals
.
          INC       PATCOMM/INC             * IBA Control file
          INC       PATCONFD/INC            * Patient Control file
.
.-----------------------------------------------------------------------------
. Variable Declarations
.-----------------------------------------------------------------------------
.
. CGI Parameters
. **************
.
NEXTPAGE  FORM      1         * Nextpage parameter
UPDTTYPE  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
STARTKEY  DIM       25        * Starting Key for search
VALDACCT  DIM       15        * Account Number           
LEDGERCD  DIM       2         * Ledger Code              
ACCTTYPE  DIM       1         * Account Type           
VALDETID  DIM       3         * Terminal ID
.
FMCHQ001  DIM       15        * Cheque Account
FMCHQ002  DIM       40        * Description
FMCHQ003  FORM      12.2      * Balance
FMCHQ004  DIM       8         * Balance Date
FMCHQ005  FORM      2         * Bank Transfer Format
FMCHQ006  DIM       6         * Bank State Branch
FMCHQ007  DIM       9         * Account Number
FMCHQ008  DIM       16        * NZ Account Number
FMCHQ009  DIM       35        * Description
FMCHQ010  DIM       25        * Address Line 1
FMCHQ011  DIM       25        * Address Line 2
FMCHQ012  DIM       20        * Address Line 3
FMCHQ013  DIM       4         * Post Code   
FMCHQ014  DIM       1         * Format Disk/Tape/Direct
FMCHQ015  DIM       3         * Bank Name  
FMCHQ016  DIM       6         * Number of Users Supplying Tape
FMCHQ017  DIM       12        * Description of Entries in File
FMCHQ018  FORM      1         * Format of Data Records
FMCHQ019  DIM       25        * User Def Ref 1
FMCHQ020  DIM       25        * User Def Ref 2
FMCHQ021  DIM       8         * User Def Date 1
FMCHQ022  DIM       8         * User Def Date 2
FMCHQ023  DIM       1         * User Def Y/N 1
FMCHQ024  DIM       1         * User Def Y/N 2
.
FMEPT001  DIM       15        * Cheque Account
FMEPT002  DIM       3         * EFTPOS Terminal ID
FMEPT003  DIM       1         * 1=active, 0=not active
FMEPT004  DIM       40        * URL/ipv address of terminal
FMEPT005  DIM       5         * Port Number
FMEPT006  DIM       30        * Description
. 
. Program Variables
. *****************
.
DIM3A     DIM       3
DIM3B     DIM       3
DIM8      DIM       8
BNKLEDNO  DIM       15
BNKLEDSC  DIM       35
DEBLEDNO  DIM       15
DEBLEDSC  DIM       35
GSTLEDNO  DIM       15
GSTLEDSC  DIM       35
INCOMDSC  DIM       35
JAVSNAME  DIM       35
LINK2PRT  FORM      1       * Key for Keyword index
SAVKEY3   DIM       3         
SKEY14    DIM       14
STRTNAME  DIM       70
ENDNAME   DIM       70
.
. Program Constants
. *****************
FIVE9     FORM      "59"
SEVEN9    FORM      "79"
NBSP      INIT      "&nbsp;"
+
.-----------------------------------------------------------------------------
.
PRGID     INIT      "FMSWEB05"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "Financial Management Account Maintenance Server"
+
.------------------------------------------------------------------------------
.
          CALL      WEBINT00                * Initialise Fifo Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO          * End Server Process if Option=999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00                * Output File & Write HTML Pg Header
          GOTO      MAIN1000
.
MAIN1100  CALL      FMSCHQ00                * Cheque Account Maintenance  
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1200  CALL      VALCHQ00                * Remote script validate chq a/c
          GOTO      MAIN1000
.
MAIN1300  CALL      ACCSRH00                * Search routine for account
          GOTO      MAIN1000
.
MAIN1400  CALL      FMSET000                * EFTPOS Terminal Maintenance 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
+
.------------------------------------------------------------------------------
.  Next Page URL
.------------------------------------------------------------------------------
.
NXTPG000  IF        NEXTPAGE=0
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF

          IF        NEXTPAGE=1
            CALL      RSAVED00              * Redirect URL
          ENDIF
.
          IF        NEXTPAGE=2
            CALL      GOBACK00              * Go Back 1 html page
          ENDIF
.
          IF        NEXTPAGE=3
            CALL      DAH20000              * Go Back 2 html pages
          ENDIF
.
NXTPG999  RETURN
.------------------------------------------------------------------------------
.  Goes back 1 page
.------------------------------------------------------------------------------
.
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"

          CALL      CLOSHTML
.
GOBACK99  RETURN
+
.------------------------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------------------------
.
INIT0000  OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
.
          OPEN      FMSCAFA1,"fmscafaf"
          OPEN      FMSCAFA2,"fmscafaf"
          OPEN      FMSCHQA1,"fmschqaf"
          OPEN      FMSCSAA1,"fmscsaaf"
          OPEN      FMSAMAA1,"fmsamaaf"
          OPEN      FMSAMAA3,"fmsamaaf"
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      FMSEPTA1,"fmseptaf"
.
.-------------------------------------------------------------------------------
. Open and Read the Control file variables
.-------------------------------------------------------------------------------
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
INIT9999  RETURN
+
.------------------------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------------------------
.
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,STARTKEY
          MOVE      SP70,VALDACCT
          MOVE      SP70,LEDGERCD
          MOVE      SP70,ACCTTYPE
.
          MOVE      SP70,FMCHQ001
          MOVE      SP70,FMCHQ002
          MOVE      ZERO,FMCHQ003
          MOVE      SP70,FMCHQ004
          MOVE      ZERO,FMCHQ005
          MOVE      SP70,FMCHQ006
          MOVE      SP70,FMCHQ007
          MOVE      SP70,FMCHQ008
          MOVE      SP70,FMCHQ009
          MOVE      SP70,FMCHQ010
          MOVE      SP70,FMCHQ011
          MOVE      SP70,FMCHQ012
          MOVE      SP70,FMCHQ013
          MOVE      SP70,FMCHQ014
          MOVE      SP70,FMCHQ015
          MOVE      SP70,FMCHQ016
          MOVE      SP70,FMCHQ017
          MOVE      ZERO,FMCHQ018
          MOVE      SP70,FMCHQ019
          MOVE      SP70,FMCHQ020
          MOVE      SP70,FMCHQ021
          MOVE      SP70,FMCHQ022
          MOVE      SP70,FMCHQ023
          MOVE      SP70,FMCHQ024
.
          MOVE      SP70,FMEPT001
          MOVE      SP70,FMEPT002
          MOVE      SP70,FMEPT003
          MOVE      SP70,FMEPT004
          MOVE      SP70,FMEPT005
          MOVE      SP70,FMEPT006
.
CLRPAR99  RETURN
+
.------------------------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------------------------
.
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdacct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDACCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fmchq",QRYNAME
          IF        @EQUAL
            CALL      STCHQ000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "fmept",QRYNAME
          IF        @EQUAL
            CALL      STEPT000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ledgercd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEDGERCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdetid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDETID
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.-------------------------------------------------------------------------------
.   Set Parameters for Cheque Account Table
.-------------------------------------------------------------------------------
STCHQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STCHQ001,STCHQ002,STCHQ003,STCHQ004,STCHQ005:
                       STCHQ006,STCHQ007,STCHQ008,STCHQ009,STCHQ010:
                       STCHQ011,STCHQ012,STCHQ013,STCHQ014,STCHQ015:
                       STCHQ016,STCHQ017,STCHQ018,STCHQ019,STCHQ020:
                       STCHQ021,STCHQ022,STCHQ023,STCHQ024
.
          MOVE      ONE,EXIT
          GOTO      STCHQ999
.
STCHQ001  MOVE      QRYDATA,FMCHQ001
          PACK      FMCHQ001,FMCHQ001,SP70
          GOTO      STCHQ999
.
STCHQ002  MOVE      QRYDATA,FMCHQ002
          PACK      FMCHQ002,FMCHQ002,SP70
          GOTO      STCHQ999
.
STCHQ003  MOVE      QRYDATA,FMCHQ003
          GOTO      STCHQ999
.
STCHQ004  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      FMCHQ004,CCENT,CYEAR,CMON,CDAY
          GOTO      STCHQ999
.
STCHQ005  MOVE      QRYDATA,FMCHQ005
          GOTO      STCHQ999
.
STCHQ006  PACK      QRYDATA,QRYDATA,SP70
          UNPACK    QRYDATA,DIM3A,DIM1,DIM3B
          PACK      FMCHQ006,DIM3A,DIM3B
          GOTO      STCHQ999
.
STCHQ007  MOVE      QRYDATA,FMCHQ007
          GOTO      STCHQ999
.
STCHQ008  MOVE      QRYDATA,FMCHQ008
          GOTO      STCHQ999
.
STCHQ009  MOVE      QRYDATA,FMCHQ009
          PACK      FMCHQ009,FMCHQ009,SP70
          GOTO      STCHQ999
.
STCHQ010  MOVE      QRYDATA,FMCHQ010
          GOTO      STCHQ999
.
STCHQ011  MOVE      QRYDATA,FMCHQ011
          GOTO      STCHQ999
.
STCHQ012  MOVE      QRYDATA,FMCHQ012
          GOTO      STCHQ999
.
STCHQ013  MOVE      QRYDATA,FMCHQ013
          GOTO      STCHQ999
.
STCHQ014  MOVE      QRYDATA,FMCHQ014
          GOTO      STCHQ999
.
STCHQ015  MOVE      QRYDATA,FMCHQ015
          GOTO      STCHQ999
.
STCHQ016  MOVE      QRYDATA,FMCHQ016
          GOTO      STCHQ999
.
STCHQ017  MOVE      QRYDATA,FMCHQ017
          PACK      FMCHQ017,FMCHQ017,SP70
          GOTO      STCHQ999
.
STCHQ018  MOVE      QRYDATA,FMCHQ018
          GOTO      STCHQ999
.
STCHQ019  MOVE      QRYDATA,FMCHQ019
          GOTO      STCHQ999
.
STCHQ020  MOVE      QRYDATA,FMCHQ020
          GOTO      STCHQ999
.
STCHQ021  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      FMCHQ021,CCENT,CYEAR,CMON,CDAY
          GOTO      STCHQ999
.
STCHQ022  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      FMCHQ022,CCENT,CYEAR,CMON,CDAY
          GOTO      STCHQ999
.
STCHQ023  MOVE      QRYDATA,FMCHQ023
          GOTO      STCHQ999
.
STCHQ024  MOVE      QRYDATA,FMCHQ024
          GOTO      STCHQ999
.
STCHQ999  RETURN
+
.-------------------------------------------------------------------------------
.   Set Parameters for EFTPOS Terminal Table
.-------------------------------------------------------------------------------
STEPT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STEPT001,STEPT002,STEPT003,STEPT004,STEPT005:
                       STEPT006
.
          MOVE      ONE,EXIT
          GOTO      STEPT999
.
STEPT001  PACK      FMEPT001,QRYDATA,SP70 
          GOTO      STEPT999
.
STEPT002  PACK      FMEPT002,QRYDATA,SP70
          GOTO      STEPT999
.
STEPT003  PACK      FMEPT003,QRYDATA,SP70
          GOTO      STEPT999
.
STEPT004  PACK      FMEPT004,QRYDATA,SP70
          GOTO      STEPT999
.
STEPT005  PACK      FMEPT005,QRYDATA,SP70
          GOTO      STEPT999
.
STEPT006  PACK      FMEPT006,QRYDATA,SP70
          GOTO      STEPT999
.
STEPT999  RETURN
.
.------------------------------------------------------------------------------
. Financial Management Cheque Account Maintenance 
.------------------------------------------------------------------------------
.
FMSCHQ00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      FMSCHQ40 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * 
          GOTO      FMSCHQ10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            *
          GOTO      FMSCHQ20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * 
          GOTO      FMSCHQ30 IF EQUAL
.
          GOTO      FMSCHQ90
.
FMSCHQ10  PACK      KEY15,FMCHQ001,SP70
          CALL      RDFMCH1
          COMPARE   ZERO,OVRCD
          GOTO      FMSCHQ92 IF EQUAL
.
          CALL      CHQSAV00      * Moves input variables to file variables
          PACK      KEY15,FMCHQ001,SP70
          CALL      WRFMCH1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ20  PACK      KEY15,FMCHQ001,SP70   * Update Formaction
          CALL      RDFMCH1
          BRANCH    OVRCD,FMSCHQ91
.
          CALL      CHQSAV00      * Moves input variables to file variables
          CALL      UPFMCH1       * Writes away the data
          IF        OVRCD=2
            GOTO      FMSCHQ94
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ30  PACK      KEY15,FMCHQ001,SP70   * Delete Formaction
          CALL      RDFMCH1
          BRANCH    OVRCD,FMSCHQ91
.
.         Check A/C does not exist in Control A/C Master Table before deleting
.
          PACK      KEY29,FMCHQ001,SP70
          CALL      RSFMCA2               
          CALL      RKFMCA2
          BRANCH    OVRCD,FMSCHQ31
.
          MATCH     FMCHQ001,FMCACHQ 
          GOTO      FMSCHQ93 IF EQUAL
.
FMSCHQ31  PACK      KEY15,FMCHQ001,SP70   * Delete Cheque account
          CALL      DEFMCH1
          MOVE      ZERO,EXIT
          GOTO      FMSCHQ99
.
.         ************ DISPLAY FORMACTION **********
.
FMSCHQ40  PACK      KEY15,FMCHQ001,SP70
          CALL      RDFMCH1
          IF        OVRCD=1
            CALL      CLRCHQ00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Cheque Account Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,FMSCHQ99
.
          CALL      WEBBOD00                * Process Web Body
.
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
FMSCHQ90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ91  MOVE      "Cheque Account does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ92  MOVE      "Cheque Account record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ93  CLEAR     WEBTITLE
          APPEND    "Cannot Delete - Allocated to ",WEBTITLE
          APPEND    FMCALED,WEBTITLE
          APPEND    SLASH,WEBTITLE
          APPEND    FMCAACC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ94  MOVE      "ERROR: Locked - Record not updated.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSCHQ99
.
FMSCHQ99  RETURN
+
.------------------------------------------------------------------------------
. Financial Management EFTPOS Terminal Maintenance
.------------------------------------------------------------------------------
.
FMSET000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      FMSET400 IF EQUAL
.
          MATCH     "A",UPDTTYPE            *
          GOTO      FMSET100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            *
          GOTO      FMSET200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            *
          GOTO      FMSET300 IF EQUAL
.
          GOTO      FMSET900
.
FMSET100  CALL      CLREPT00
          CALL      EPTSAV00
.
          PACK      KEY18,FMEPCHQA,FMEPPPID,SP70       * Add Formaction
          CALL      RDFMEPT1
          COMPARE   ONE,OVRCD
          GOTO      FMSET910 IF NOT EQUAL             * Record already exists!
.
          CALL      IBACLOCK
          PACK      FMEPCDAT,CCC,CYY,CMM,CDD
          REP       " 0",FMEPCDAT
          MOVE      CTIMEIS,FMEPCTIM
          MOVE      WBSEUID,FMEPCUID       
          CALL      WRFMEPT1
          MOVE      ZERO,EXIT
          GOTO      FMSET999 
.
FMSET200  PACK      KEY18,FMEPT001,FMEPT002,SP70      * Update Formaction
          CALL      RDFMEPT1                          * Check if record exists
          GOTO      FMSET920 IF OVER                   
.
          CALL      CLREPT00
          CALL      EPTSAV00
          CALL      IBACLOCK
          PACK      FMEPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",FMEPUDAT
          MOVE      CTIMEIS,FMEPUTIM
          MOVE      WBSEUID,FMEPUUID       
          CALL      UPFMEPT1                          *  Update record
.
          MOVE      ZERO,EXIT
          GOTO      FMSET999
.
FMSET300  PACK      KEY18,FMEPT001,FMEPT002,SP70      * Delete Formaction
          CALL      RDFMCH1
          BRANCH    OVRCD,FMSET920
.
          CALL      CLREPT00
          CALL      EPTSAV00
          PACK      KEY18,FMEPCHQA,FMEPPPID,SP70   
          CALL      DEFMEPT1
.
          MOVE      ZERO,EXIT
          GOTO      FMSET999
.
FMSET400  CLEAR     WEBTITLE                          * Clear file variables
          MOVE      "EFTPOS Terminal Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                          * Output File/HTML Header
          BRANCH    EXIT,FMSET999
.
          CALL      WEBBOD00                          * Process Web Body
          CALL      WEBEND00                          * Process End of HTML File
          MOVE      ONE,EXIT                          * Listing Completed, exit
          GOTO      FMSET999        
.
FMSET900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSET999
.
FMSET910  MOVE      "Terminal ID already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSET999
.
FMSET920  MOVE      "Terminal ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FMSET999
.
FMSET999  RETURN
+
.-----------------------------------------------------------
. Option 4: EFTPOS Maintenance
.-----------------------------------------------------------
EFTT0000  BRANCH    FLDITMNO,EFTT0100:          * Output List of EFTPOS Terminals
                             EFTT0200:          * List Screen - Prev button
                             EFTT0300:          * List Screen - Next button
                             EFTT0400:          * Cheque Account Number
                             EFTT0500:          * Key of first item on page
                             EFTT0600:          * Terminal ID
                             EFTT0700:          * Active?
                             EFTT0800:          * Address
                             EFTT0900:          * Port
                             EFTT1000           * Description
.
EFTT0100  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        STARTNUM=-1
            CALL      GETSN000
          ENDIF

          IF        NORECORD=0
            MOVE      "10",NORECORD             * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY18,FMEPT001,SP70
          CALL      RSFMEPT1
EFTT0110  CALL      RKFMEPT1
          BRANCH    OVRCD,EFTT9999

          MATCH     FMEPT001,FMEPCHQA
          GOTO      EFTT9999 IF NOT EQUAL
.
          MOVE      "Inactive",DIM8
          MATCH     "1",FMEPACTV
          IF        @EQUAL
            MOVE      "Active  ",DIM8
          ENDIF  
           
.         GOTO      EFTT0110 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      EFTT0110
          ELSE
            MOVE      FMEPPPID,STARTKEY
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail01":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&fmept001=",FMEPCHQA:
                             "&fmept002=",FMEPPPID,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                                    FMEPPPID,"&nbsp;</td>":
                             "<td>",FMEPDESC,"&nbsp;</td>":
                             "<td>",FMEPADDR,"&nbsp;</td>":
                             "<td>",FMEPPORT,"&nbsp;</td>":
                             "<td>",DIM8,"&nbsp;</td>":
                             "</tr>"

          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      EFTT0110 IF NOT EQUAL
.
          GOTO      EFTT9999
.
EFTT0200  CALL      PREVEG00 
          GOTO      EFTT9999
.
EFTT0300  CALL      NEXTEG00
          GOTO      EFTT9999
.
EFTT0400  CALL      CLREPT00
          CALL      EPTSAV00
          PACK      KEY18,FMEPCHQA,FMEPPPID,SP70
          CALL      RDFMEPT1
          WRITE     HTMLFILE;FMEPCHQA;
          GOTO      EFTT9999
.
EFTT0500  WRITE     HTMLFILE;STARTKEY;
          GOTO      EFTT9999
.
EFTT0600  WRITE     HTMLFILE;FMEPPPID;
          GOTO      EFTT9999
.
EFTT0700  MATCH     "1",FMEPACTV
          IF        @EQUAL
            WRITE     HTMLFILE;"checked";
          ENDIF
          GOTO      EFTT9999
.
EFTT0800  WRITE     HTMLFILE;FMEPADDR;
          GOTO      EFTT9999
.
EFTT0900  WRITE     HTMLFILE;FMEPPORT;
          GOTO      EFTT9999
.
EFTT1000  WRITE     HTMLFILE;FMEPDESC;
          GOTO      EFTT9999
.
EFTT9999  RETURN
.
.-------------------------------------------------------------------------------
. Determine the startnumber of a given keycode
.-------------------------------------------------------------------------------
GETSN000  MOVE      ZERO,STARTNUM
          PACK      KEY18,FMEPCHQA,SP70
          CALL      RSFMEPT1
.
GETSN001  CALL      RKFMEPT1
          GOTO      GETSN999 IF OVER 
.
          MATCH     FMEPT001,FMEPCHQA
          GOTO      GETSN999 IF NOT EQUAL
.
          MATCH     FMEPT002,FMEPPPID
          IF        !@EQUAL
            ADD       ONE,STARTNUM
            GOTO      GETSN001
          ENDIF
.
GETSN999  RETURN
.
.--------------------------------------------------------
. Clear Fields for Screen : Cheque Account Maintenance
.-------------------------------------------------------
CLRCHQ00  MOVE      SP70,FMCHCHQ
          MOVE      SP70,FMCHDES
          MOVE      ZERO,FMCHBAL
          MOVE      SP70,FMCHBDT
          MOVE      ZERO,FMCHFMT
          MOVE      SP70,FMCHBSB
          MOVE      SP70,FMCHACCT
          MOVE      SP70,FMCHNZAC
          MOVE      SP70,FMCHDESC
          MOVE      SP70,FMCHADD1
          MOVE      SP70,FMCHADD2
          MOVE      SP70,FMCHADD3
          MOVE      SP70,FMCHADD4
          MOVE      SP70,FMCHFRMT
          MOVE      SP70,FMCHBNAM
          MOVE      SP70,FMCHUSER
          MOVE      SP70,FMCHEDSC
          MOVE      ZERO,FMCHDFRM
          MOVE      SP70,FMCHUR1
          MOVE      SP70,FMCHUR2
          MOVE      SP70,FMCHUD1
          MOVE      SP70,FMCHUD2
          MOVE      SP70,FMCHUY1
          MOVE      SP70,FMCHUY2
.
CLRCHQ99
.--------------------------------------------------------
. Clear file variables : EFTPOS Terminal Maintenance
.-------------------------------------------------------
CLREPT00  MOVE      SP70,FMEPCHQA
          MOVE      SP70,FMEPPPID
          MOVE      SP70,FMEPACTV
          MOVE      SP70,FMEPADDR
          MOVE      SP70,FMEPPORT
          MOVE      SP70,FMEPDESC
.
CLREPT99  RETURN
.------------------------------------------------------------
. Moves cgi variables into file variables
.------------------------------------------------------------
CHQSAV00  MOVE      FMCHQ001,FMCHCHQ
          MOVE      FMCHQ002,FMCHDES
          MOVE      FMCHQ003,FMCHBAL
          MOVE      FMCHQ004,FMCHBDT
          MOVE      FMCHQ005,FMCHFMT
          MOVE      FMCHQ006,FMCHBSB
          MOVE      FMCHQ007,FMCHACCT
          MOVE      FMCHQ008,FMCHNZAC
          MOVE      FMCHQ009,FMCHDESC
          MOVE      FMCHQ010,FMCHADD1
          MOVE      FMCHQ011,FMCHADD2
          MOVE      FMCHQ012,FMCHADD3
          MOVE      FMCHQ013,FMCHADD4
          MOVE      FMCHQ014,FMCHFRMT
          MOVE      FMCHQ015,FMCHBNAM
          MOVE      FMCHQ016,FMCHUSER
          MOVE      FMCHQ017,FMCHEDSC
          MOVE      FMCHQ018,FMCHDFRM
          MOVE      FMCHQ019,FMCHUR1
          MOVE      FMCHQ020,FMCHUR2
          MOVE      FMCHQ021,FMCHUD1
          MOVE      FMCHQ022,FMCHUD2
          MOVE      FMCHQ023,FMCHUY1
          MOVE      FMCHQ024,FMCHUY2
          MOVE      SP70,FMCHSPA
.
CHQSAV99  RETURN
.------------------------------------------------------------
. Moves cgi variables into file variables
.------------------------------------------------------------
EPTSAV00  PACK      FMEPCHQA,FMEPT001,SP70
          PACK      FMEPPPID,FMEPT002,SP70
          PACK      FMEPACTV,FMEPT003,SP70
          PACK      FMEPADDR,FMEPT004,SP70
          PACK      FMEPPORT,FMEPT005,SP70
          PACK      FMEPDESC,FMEPT006,SP70
.
EPTSAV99  RETURN
.-----------------------------------------------------------------------------
. Remote Script to validate Cheque Account        
. Required Parameters: VALDACCT - cheque account   
.-----------------------------------------------------------------------------
VALCHQ00  CALL      XMLHED00
          BRANCH    EXIT,VALCHQ99
          PACK      KEY15,VALDACCT,SP70
          CALL      RDFMCH1
          BRANCH    OVRCD,VALCHQ90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FMCHDES:
                             "</RETURN_VALUE>"
.
          GOTO      VALCHQ98
.
VALCHQ90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Account - ",KEY15:
                             "</RETURN_VALUE>"
          GOTO      VALCHQ98
.
VALCHQ98  CALL      XMLEND00
VALCHQ99  RETURN
.-----------------------------------------------------------------------------
. Remote Script to validate EFTPOS Terminal Id
. Required Parameters: VALDETID - EFTPOS Terminal ID
.-----------------------------------------------------------------------------
VALEPT00  CALL      XMLHED00
          BRANCH    EXIT,VALEPT99
          PACK      KEY18,VALDETID,SP70
          CALL      RDFMEPT1
          BRANCH    OVRCD,VALEPT90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FMCHDES:
                             "</RETURN_VALUE>"
.
          GOTO      VALEPT98
.
VALEPT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Terminal ID </RETURN_VALUE>"
          GOTO      VALEPT98
.
VALEPT98  CALL      XMLEND00
.
VALEPT99  RETURN
.------------------------------------------------------------
. Account Search - Option 4
.------------------------------------------------------------
ACCSRH00  MOVE      "Account Code Search",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ACCSRH99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
ACCSRH99  RETURN
.
.------------------------------------------------------------------------------
. Process Fields called from WEBBOD00
.------------------------------------------------------------------------------
.
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40
.
          GOTO      PROFLD99
.
.       Cheque Account Maintenance
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  CALL      CHQA0000                       
          GOTO      PROFLD99
.
.       Account Search
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
.
PROFLD31  CALL      ASRH0000       * Account Search
          GOTO      PROFLD99
.
PROFLD40  CALL      EFTT0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.-----------------------------------------------------------
. Option 1: Cheque Account
.-----------------------------------------------------------
CHQA0000  BRANCH    FLDITMNO,CHQA0100,CHQA0200,CHQA0300,CHQA0400,CHQA0500:
                             CHQA0600,CHQA0700,CHQA0800,CHQA0900,CHQA1000:
                             CHQA1100,CHQA1200,CHQA1300,CHQA1400,CHQA1500:
                             CHQA1600,CHQA1700,CHQA1800,CHQA1900,CHQA2000:
                             CHQA2100,CHQA2200,CHQA2300,CHQA2400,CHQA2500: 
                             CHQA2600,CHQA2700,CHQA2800 

          GOTO      CHQA9999
.
CHQA0100  WRITE     HTMLFILE;FMCHCHQ;
          GOTO      CHQA9999
.
CHQA0200  MATCH     SP70,FMCHDES
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHDES;
          GOTO      CHQA9999
.
CHQA0300  WRITE     HTMLFILE;FMCHBAL;
          GOTO      CHQA9999
.
CHQA0400  MATCH     SP70,FMCHBDT
          GOTO      CHQA9999 IF EQUAL
          GOTO      CHQA9999 IF EOS
          UNPACK    FMCHBDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      CHQA9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CHQA9999
.
CHQA0500  WRITE     HTMLFILE;FMCHFMT;
          GOTO      CHQA9999
.
CHQA0600  MATCH     SP70,FMCHBSB
          GOTO      CHQA9999 IF EQUAL
          UNPACK    FMCHBSB,DIM3A,DIM3B
          WRITE     HTMLFILE;DIM3A,"-",DIM3B;
          GOTO      CHQA9999
.
CHQA0700  MATCH     SP70,FMCHACCT
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHACCT;
          GOTO      CHQA9999
.
CHQA0800  MATCH     SP70,FMCHNZAC
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHNZAC;
          GOTO      CHQA9999
.
CHQA0900  MATCH     SP70,FMCHDESC
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHDESC;
          GOTO      CHQA9999
.
CHQA1000  MATCH     SP70,FMCHADD1
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHADD1;
          GOTO      CHQA9999
.
CHQA1100  MATCH     SP70,FMCHADD2
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHADD2;
          GOTO      CHQA9999
.
CHQA1200  MATCH     SP70,FMCHADD3
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHADD3;
          GOTO      CHQA9999
.
CHQA1300  MATCH     SP70,FMCHADD4
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHADD4;
          GOTO      CHQA9999
.
CHQA1400  MATCH     SP70,FMCHFRMT
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHFRMT;
          GOTO      CHQA9999
.
CHQA1500  MATCH     SP70,FMCHBNAM
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHBNAM;
          GOTO      CHQA9999
.
CHQA1600  MATCH     SP70,FMCHUSER
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHUSER;
          GOTO      CHQA9999
.
CHQA1700  MATCH     SP70,FMCHEDSC
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHEDSC;
          GOTO      CHQA9999
.
CHQA1800  WRITE     HTMLFILE;FMCHDFRM;
          GOTO      CHQA9999
.
CHQA1900  MATCH     SP70,FMCHUR1
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHUR1;
          GOTO      CHQA9999
.
CHQA2000  MATCH     SP70,FMCHUR2
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHUR2;
          GOTO      CHQA9999
.
CHQA2100  MATCH     SP70,FMCHUD1
          GOTO      CHQA9999 IF EQUAL
          GOTO      CHQA9999 IF EOS
          UNPACK    FMCHUD1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      CHQA9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CHQA9999
.
CHQA2200  MATCH     SP70,FMCHUD2
          GOTO      CHQA9999 IF EQUAL
          GOTO      CHQA9999 IF EOS
          UNPACK    FMCHUD2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      CHQA9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CHQA9999
.
CHQA2300  MATCH     SP70,FMCHUY1
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHUY1;
          GOTO      CHQA9999
.
CHQA2400  MATCH     SP70,FMCHUY2
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;FMCHUY2;
          GOTO      CHQA9999
.
CHQA2500  CALL      CHQNO000        * Table of Cheque AC by Number
          GOTO      CHQA9999
.
CHQA2600  CALL      NEXTGR00
          GOTO      CHQA9999
.
CHQA2700  CALL      PREVGR00
          GOTO      CHQA9999
.
CHQA2800  MATCH     SP70,STARTKEY
          GOTO      CHQA9999 IF EQUAL
          WRITE     HTMLFILE;STARTKEY;
          GOTO      CHQA9999
.
CHQA9999  RETURN
.------------------------------------------------------------
. Table of Cheque Account by Number
.------------------------------------------------------------
CHQNO000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      CTHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY15,STARTKEY,SP70
          CALL      RSFMCH1
          IF        OVRCD=0
            CALL      RPFMCH1
          ENDIF
CHQNO100  CALL      RKFMCH1
          BRANCH    OVRCD,CHQNO900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CHQNO100
          ENDIF
.
          CALL      CTROW000      * Display Category Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CHQNO100 IF NOT EQUAL
          GOTO      CHQNO999
.
CHQNO900  CALL      NOMORE00      * Display No More Records Message
.
CHQNO999  RETURN
.------------------------------------------------------------
. Cheque Account Maintenance (TABLE HEADING)
.------------------------------------------------------------
t
CTHED000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Cheque Account":
                             "</td>":
                             "<td class=HeadingCell width=40%>Description":
                             "</td>":
                             "<td class=HeadingCell width=20%>Direct Debit<br>":
                             "Bank Name Abbreviation</td>":
                             "<td class=HeadingCell width=20%>Direct Debit<br>":
                             "Company ID Number</td>":
                             "</tr>"
.
CTHED999  RETURN
.------------------------------------------------------------
. Category Maintenance (TABLE ROW)
.------------------------------------------------------------
CTROW000  MATCH     SP70,FMCHDES
          IF        @EQUAL
            MOVE      NBSP,FMCHDES
          ENDIF
.
          MATCH     SP70,FMCHBNAM
          IF        @EQUAL
            MOVE      NBSP,KEY6
          ELSE
            MOVE      FMCHBNAM,KEY6
          ENDIF
.
          MATCH     SP70,FMCHUSER
          IF        @EQUAL
            MOVE      "&nbsp;",FMCHUSER
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail01":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&fmchq001=",FMCHCHQ,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             FMCHCHQ,"</td>":
                             "<td>",FMCHDES,"</td>":
                             "<td>",KEY6,"</td>":
                             "<td>",FMCHUSER,"</td>":
                             "</tr>"
.
CTROW999  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
NEXTGR99  RETURN
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
PREVGR99  RETURN
+
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTEG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&fmept001=",FMEPT001;
.                                "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
NEXTEG99  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVEG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&fmept001=",FMEPT001;
.                                "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
PREVEG99  RETURN
+
.---------------------------------------------------------------
.      Option - 4 Account Code Search
.---------------------------------------------------------------
ASRH0000  BRANCH    FLDITMNO,ASRH0100,ASRH0200,ASRH0300,ASRH0400,ASRH0500:
                             ASRH0600
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      ASRH9999
.
ASRH0100  MOVE      ZERO,LINK2PRT           * Link to alternate Program
          CALL      ACTAB000                * Table of item code
          GOTO      ASRH9999
.
ASRH0200  MOVE      ONE,LINK2PRT            * Link to Parent
          CALL      ACTAB000                * Table of item code
          GOTO      ASRH9999
.
ASRH0300  MOVE      TWO,LINK2PRT            * Link to Window
          CALL      ACTAB000                * Table of item code
          GOTO      ASRH9999
.
ASRH0400  CALL      PREVAC00                * Link to Prev Set of Codes
          GOTO      ASRH9999
.
ASRH0500  CALL      NEXTAC00                * Link to Next Set of Codes
          GOTO      ASRH9999
.
ASRH0600  MOVE      THREE,LINK2PRT          * Update Parent with extra vars
          CALL      ACTAB000                * Table of item code
          GOTO      ASRH9999
.
ASRH9999  RETURN
.-------------------------------------------------------------
.        Table of Account Code
.-------------------------------------------------------------
ACTAB000  IF        LINK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          CALL      ACHED000                 * Table heading
.
          MATCH     SP70,LEDGERCD
          GOTO      ACTAB999  IF EQUAL
.
          IF        NORECORD=0
            MOVE      "12",NORECORD         * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY50,LEDGERCD,ACCTTYPE,STARTKEY,SP70
          CALL      RSFMAM3
          IF        OVRCD=0
            CALL      RPFMAM3
          ENDIF
ACTAB100  CALL      RKFMAM3
          BRANCH    OVRCD,ACTAB999
.
          MATCH     LEDGERCD,FMAMLEDG
          GOTO      ACTAB999 IF NOT EQUAL
.
          MATCH     ACCTTYPE,FMAMTYPE
          GOTO      ACTAB999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO     ACTAB100
          ENDIF
.
          CALL      ACROW000    * Display Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ACTAB100 IF NOT EQUAL
.
ACTAB999  RETURN
.------------------------------------------------------------
. Account Code Table Details (TABLE HEADING)
.------------------------------------------------------------
ACHED000   WRITE     HTMLFILE;"<tr>":
                              "<td colspan=2 class=HeadingCell align=center>":
                              " You Searched for ":
                              STARTKEY,"</td></tr>"
.
           WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=30%>":
                               "Account Code</td>":
                               "<td class=HeadingCell width=70%>":
                               "Account Description</td>":
                               "</tr>"
.
ACHED999  RETURN
.------------------------------------------------------------
.  Account Code Row (TABLE ROW)
.------------------------------------------------------------
ACROW000  BRANCH    LINK2PRT,ACROW010,ACROW020,ACROW030
.
          WRITE     HTMLFILE;"<tr valign=top>":
                                "<td nowrap><a href=",LINKPRG,".pbl?":
                                "&reportno=",LINKREP:
                                "&template=",LINKTEM:
                                "&ledgercd=",LEDGERCD:
                                "&accttype=",ACCTTYPE,">":
                                FMAMACCT,"</a></td>":
                                "<td>",FMAMDESC,"</td>":
                              "</tr>";
          GOTO      ACROW999
.
ACROW010  WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<A HREF='javascript:updateParent":
                               "(#"",FMAMACCT,"#",#"":
                               FMAMDESC,"#")'>":
                               FMAMACCT,"</a></td>":
                               "<td>",FMAMDESC,"</td>":
                             "</tr>";
          GOTO      ACROW999
.
ACROW020  WRITE     HTMLFILE;"<tr valign=top>":
                               "<td nowrap><a href=#"":
                               "javascript:ShowDetail('":
                               LINKPRG,".pbl?":
                               "&reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&ledgercd=",LEDGERCD:
                               "&accttype=",ACCTTYPE:
                               "');#">":
                               FMAMACCT,"</a></td>":
                               "<td>",FMAMDESC,"</td>":
                             "</tr>";
          GOTO      ACROW999
.
ACROW030  PACK      SKEY14,FMAMLEDG,FMAMACCT
          MOVE      SP70,BNKLEDNO
          MOVE      SP70,BNKLEDSC
          MOVE      SP70,DEBLEDNO
          MOVE      SP70,DEBLEDSC
          MOVE      SP70,FMCHCHQ
          MOVE      SP70,FMCHDES
          MOVE      SP70,GSTLEDNO
          MOVE      SP70,GSTLEDSC
.
          CALL      GETC0000    * Get Control Account Details
.
.  Get Bank Ledger/Account Code and Name
.
          PACK      KEY14,FMAMLEDG,FMCSBNK,SP20
          CALL      RDFMAM1              * Account Master Details
          BRANCH    OVRCD,ACROW031
.
          PACK      BNKLEDNO,FMLALEDG,SLASH,FMCSBNK  * Bank Ledger/Acc Code
          MOVE      FMAMDESC,BNKLEDSC                * Bank Ledger/Acc Desc
.
.  Get Cheque Account
.
ACROW031  PACK      KEY14,FMLALEDG,FMCSBNK,SP70
          CALL      RDFMCA1              * Control Account Master Table
          BRANCH    OVRCD,ACROW032

          PACK      KEY15,FMCACHQ,SP70
          CALL      RDFMCH1              * Cheque Account Master Details
          BRANCH    OVRCD,ACROW032
.
.  Get Debtor Control Ledger/Account
.
ACROW032  PACK      KEY14,FMAMLEDG,FMCSDEB,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,ACROW033
.
          PACK      DEBLEDNO,FMLALEDG,SLASH,FMCSDEB  * Debtors Cont Ledger/Acc
          MOVE      FMAMDESC,DEBLEDSC                * Desc
.
.  Get GST Control Account
.
ACROW033  PACK      KEY14,FMAMLEDG,FMCSAGST,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,ACROW034
.
          PACK      GSTLEDNO,FMLALEDG,SLASH,FMCSAGST * Debtors Cont Ledger/Acc
          MOVE      FMAMDESC,GSTLEDSC                * Desc
.
ACROW034  PACK      KEY14,SKEY14,SP70
          CALL      RDFMAM1
.
          MOVE      FMAMDESC,JAVSNAME
          CALL      JAVDSC00
          MOVE      JAVSNAME,INCOMDSC
.
          WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<A HREF='javascript:updateParent":
                               "(#"",FMAMACCT,"#",#"",INCOMDSC,"#",#"":
                               BNKLEDNO,"#",#"",BNKLEDSC,"#",#"":
                               FMCHCHQ,"#",#"",FMCHDES,"#",#"":
                               DEBLEDNO,"#",#"",DEBLEDSC,"#",#"":
                               GSTLEDNO,"#",#"",GSTLEDSC,"#")'>":
                               FMAMACCT,"</a></td>":
                               "<td>",FMAMDESC,"</td>":
                             "</tr>"
          GOTO      ACROW999
.
ACROW999  RETURN
.------------------------------------------------------------------------
.    Strip Appostrophies
.------------------------------------------------------------------------
JAVDSC00
          SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVDSC99 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVDSC99  RETURN
.------------------------------------------------------------------------
. Get Control Account Details
.------------------------------------------------------------------------
GETC0000  PACK      KEY2,FMAMLEDG
          CALL      RDFMLA1              * Ledger Master Details
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
          PACK      KEY14,FMAMLEDG,FMAMACCT,SP70
          CALL      RDFMCS1              * Selected Control Accounts
          BRANCH    OVRCD,GETC9000
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
.
          MOVE      FMLABNK,FMCSBNK
.
GETC0010  MATCH     SP70,FMCSDEB
          GOTO      GETC0020 IF NOT EQUAL
.
          MOVE      FMLADEB,FMCSDEB
.
          GOTO      GETC9999
.
GETC0020  MATCH     SP70,FMCSAGST
          GOTO      GETC9999 IF NOT EQUAL
.
          MOVE      FMLAAGST,FMCSAGST
.
          GOTO      GETC9999
.
GETC9000  MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
GETC9999  RETURN
.-------------------------------------------------------------
. Link to Prev Group option 3 (Account Search)
.-------------------------------------------------------------
PREVAC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",LEDGERCD
          REP       " +",ACCTTYPE
          REP       " +",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                "?reportno=",F1:
                                "&template=",FLDPARA:
                                "&startnum=",KEY3:
                                "&norecord=",KEY2:
                                "&ledgercd=",LEDGERCD:
                                "&accttype=",ACCTTYPE:
                                "&startkey=",STARTKEY;
.
          REP       "+ ",LEDGERCD
          REP       "+ ",ACCTTYPE
          REP       "+ ",STARTKEY
.
PREVAC99  RETURN
.-------------------------------------------------------------
. Link to Next Group option 4 (Account Search)
.-------------------------------------------------------------
NEXTAC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,D3,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",LEDGERCD
          REP       " +",ACCTTYPE
          REP       " +",STARTKEY
.
          WRITE     HTMLFILE;"fmsweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",D3:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ledgercd=",LEDGERCD:
                                 "&accttype=",ACCTTYPE:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",LEDGERCD
          REP       "+ ",ACCTTYPE
          REP       "+ ",STARTKEY
.
NEXTAC99  RETURN
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
.
.------------------------------------------------------------------------------
. I/O and Subroutine Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       DAYOFWEK
          INC       RSHWEBCD
          INC       WEBDATCD
.
          INC       FMSAMAIO/INC            * Accounts
          INC       FMSCAFIO/INC
          INC       FMSCHQIO/INC
          INC       FMSCSAIO/INC
          INC       FMSLMAIO/INC            * Ledger
          INC       FMSEPTIO/INC
+
.------------------------------------------------------------------------------
. End Of Program
.------------------------------------------------------------------------------
