.*****************************************************************************
.*    Program      : F04PMPX2                                                *
.*    Description  : Conversion of pmspx2af to new file layout               *
.*                                                                           *
.*    Author       : Patrick Adair CAR 292935                                *
.*    Date         : 27/02/2014                                              *
.*    Modifications:                                                         *
.*                   Created using Automated Shell script                    *
.*                   Incorporates CAR 294471 changes as well                 *
.*****************************************************************************
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
.                                     ******** copy the old FD here *******
OLDFILE1   IFILE    SQL, FIXED=1805, KEY="U1-8"                                 
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
.PMPXURNO  DIM       8      8        1     Patient U/R Number                 
.PMPXRHC1  DIM       10     10       9     Registered HCP 1 (pmshcpaf)        
.PMPXRH1G  DIM       10     10       19    Registered HCP 1 Group (pmshcgaf)  
.PMPXR1GC  DIM       2      2        29    Reg. HCP 1 Group Count (pmshclaf)  
.PMPXINTR  DIM       1      1        31    Interpreter Required?              
.                                         0 = No
.                                         1 = Yes
.                                         U = Unknown (Not Stated)
.PMPXLNG1  DIM       3      3        32    Preferred Language 1 (Cat LA)      
.PMPXLNG2  DIM       3      3        35    Preferred Language 2 (Cat LA)      
.PMPXLNG3  DIM       3      3        38    Preferred Language 3 (Cat LA)      
.PMPXPEML  DIM       80     80       41    Patient's Email Address            
.PMPXEDOB  DIM       1      1        121   Date of Birth Estimated? 0=NO,1=YES
.PMPXCMOB  DIM       20     20       122   Emergency Contact Mobile Number    
.PMPXCEML  DIM       80     80       142   Emergency Contact Email Address    
.PMPXCCRP  DIM       1      1        222   Emer. Contact Corres. (0=NO,1=YES) 
.PMPXKMOB  DIM       20     20       223   NOK Mobile Number                  
.PMPXKEML  DIM       80     80       243   NOK Email Address                  
.PMPXKCRP  DIM       1      1        323   NOK Correspondence (0=NO,1=YES)    
.PMPXRMOB  DIM       20     20       324   Nearest Relative Mobile Number     
.PMPXREML  DIM       80     80       344   Nearest Relative Email Address     
.PMPXRCRP  DIM       1      1        424   Nearest Relative Corres. 0=NO,1=YES
.PMPXMEDC  DIM       8      8        425   Medicare Card Valid to (CCYYMMDD)  
.PMPXDETY  DIM       3      3        433   Death Type (Cat DY)                
.PMPXPRIS  DIM       15     15       436   PRISM Number                       
.PMPXCSER  DIM       15     15       451   Correctional Services Number       
.PMPXPHEI  FORM      6      4        466   Patient Height                     
.PMPXPWEI  FORM      6      4        470   Patient Weight                     
.PMPXDREC  DIM       8      8        474   Date Weight & Height Rec.(CCYYMMDD)
.PMPXMSNA  DIM       20     20       482   Mother's Surname                   
.PMPXMGNA  DIM       25     25       502   Mother's Given Name                
.PMPXMTLE  DIM       4      4        527   Mother's Title                     
.PMPXMAD1  DIM       35     35       531   Mother's Address Line 1            
.PMPXMAD2  DIM       35     35       566   Mother's Address Line 2            
.PMPXMAD3  DIM       35     35       601   Mother's Address Line 3            
.PMPXMAD4  DIM       35     35       636   Mother's Address Line 4            
.PMPXMPOS  DIM       8      8        671   Mother's Address Post Code         
.PMPXMPNO  DIM       20     20       679   Mother's Private Number            
.PMPXMBNO  DIM       20     20       699   Mother's Business Number           
.PMPXMMNO  DIM       20     20       719   Mother's Mobile Number             
.PMPXMEML  DIM       80     80       739   Mother's Email Address             
.PMPXMCNT  DIM       3      3        819   Mother's Country of Birth (Cat C)  
.PMPXMCRP  DIM       1      1        822   Mother's Correspondence  0=NO,1=YES
.PMPXMLAB  DIM       1      1        823   Mother's Name on Labels  0=NO,1=YES
.PMPXMREL  DIM       10     10       824   Relationship to Patient            
.PMPXFSNA  DIM       20     20       834   Father's Surname                   
.PMPXFGNA  DIM       25     25       854   Father's Given Name                
.PMPXFTLE  DIM       4      4        879   Father's Title                     
.PMPXFAD1  DIM       35     35       883   Father's Address Line 1            
.PMPXFAD2  DIM       35     35       918   Father's Address Line 2            
.PMPXFAD3  DIM       35     35       953   Father's Address Line 3            
.PMPXFAD4  DIM       35     35       988   Father's Address Line 4            
.PMPXFPOS  DIM       8      8        1023  Father's Address Post Code         
.PMPXFPNO  DIM       20     20       1031  Father's Private Number            
.PMPXFBNO  DIM       20     20       1051  Father's Business Number           
.PMPXFMNO  DIM       20     20       1071  Father's Mobile Number             
.PMPXFEML  DIM       80     80       1091  Father's Email Address             
.PMPXFCNT  DIM       3      3        1171  Father's Country of Birth (Cat C)  
.PMPXFCRP  DIM       1      1        1174  Father's Correspondence 0=NO,1=YES 
.PMPXFLAB  DIM       1      1        1175  Father's Name on Labels 0=NO,1=YES 
.PMPXFREL  DIM       10     10       1176  Relationship to Patient            
.PMPXTDIG  DIM       2      2        1186  Terminal Digit (Last 2 chrs of U/R)
.PMPXWBID  DIM       10     10       1188  WEB User Id re. creator (websecaf) 
.PMPXDVAC  DIM       3      3        1198  DVA Card Colour (Cat DX)           
.PMPXPNSD  DIM       8      8        1201  Pension Start Date (CCYYMMDD)      
.PMPXUYN4  DIM       1      1        1209  User Defined Y/N field 4 0=NO,1=YES
.PMPXUYN5  DIM       1      1        1210  User Defined Y/N field 5 0=NO,1=YES
.PMPXUYN6  DIM       1      1        1211  Not for Resusitation Y/N 0=NO,1=YES
.PMPXABRG  DIM       3      3        1212  Aboriginality (Cat VA)             
.PMPXPRVI  DIM       3      3        1215  Privacy Indicator (Cat PV)         
.PMPXCRIN  DIM       1      1        1218  Consent Release of Info? 0=NO,1=YES
.PMPXHOML  DIM       1      1        1219  Homeless? (0=NO,1=YES)             
.PMPXUDC1  DIM       50     50       1220  User Defined Comments 1            
.PMPXUDC2  DIM       50     50       1270  User Defined Comments 2            
.PMPXUDC3  DIM       50     50       1320  User Defined Comments 3            
.PMPXUSR7  DIM       3      3        1370  User Defined 7 (Category P7)       
.PMPXUSR8  DIM       3      3        1373  User Defined 8 (Category P8)       
.PMPXUSR9  DIM       3      3        1376  User Defined 9 (Category P9)       
.PMPXMSNO  DIM       10     10       1379  Medicare Safety Net Number         
.PMPXCONP  DIM       1      1        1389  Which contact for PRA              
.                                         0=Patient                            
.                                         1=Mother (this file)                 
.                                         2=Father (this file)                 
.                                         3=Next of Kin (patma1af)             
.                                         4=Emergency Contact (patmx1af)       
.                                         5=Nearest Relative (patmx1af)        
.                                         6=PRA (priinvof)                     
.                                         7=Postal                             
.PMPXFLDR  DIM       3      3        1390  Folder Selection (Category FS)     
.PMPXIWI1  DIM       3      3        1393  Iwi 1 (Category iw)                
.PMPXIWI2  DIM       3      3        1396  Iwi 2 (Category iw)                
.PMPXIWI3  DIM       3      3        1399  Iwi 3 (Category iw)                
.PMPXIHOS  DIM       3      3        1402  Hospital which initiated UR        
.PMPXPFSN  DIM       20     20       1405  Preferred Surname                  
.PMPXPFGN  DIM       25     25       1425  Preferred Given Name               
.PMPXSIN6  DIM       1      1        1450  Transport Required - 1=Yes         
.PMPXSIN7  DIM       1      1        1451  Medical Alert (wahealth) - 1=Yes   
.PMPXSIN8  DIM       1      1        1452  Micro Alert (wahealth) - 1=Yes     
.PMPXSIN9  DIM       1      1        1453  Risk Alert (wahealth) - 1=Yes      
.PMPXSN10  DIM       1      1        1454  Status Ind 10 - 1=Yes              
.PMPXSN11  DIM       1      1        1455  Status Ind 11 - 1=Yes              
.PMPXSN12  DIM       1      1        1456  Patient Debt Only - 1=Yes          
.PMPXSN13  DIM       1      1        1457  Set Payment Plan - 1=Yes           
.PMPXSN14  DIM       1      1        1458  Debt Collection Agency - 1=Yes     
.PMPXSN15  DIM       1      1        1459  Outstanding Debt Ind. 1=Yes        
.PMPXPFAX  DIM       20     20       1460  Patient Fax Number                 
.PMPXFNAM  DIM       40     40       1480  Patient First Name                 
.PMPXSNAM  DIM       40     40       1520  Patient Second Name                
.PMPXHFGN  DIM       40     40       1560  Health Fund First Given Name Alias 
.PMPXHFSN  DIM       40     40       1600  Health Fund Surname Alias          
.PMPXFUPI  DIM       2      2        1640  Health Fund UPI                    
.PMPXVGPC  DIM       10     10       1642  Verified GP Code (pmshcpaf)        
.PMPXVGPP  DIM       10     10       1652  Verified GP Practice (pmshcgaf)    
.PMPXVGPG  DIM       2      2        1662  Verified GP Group Count (pmshclaf) 
.PMPXASNO  DIM       15     15       1664  Ambulance Subscriber No.           
.PMPXMAID  DIM       20     20       1679  Maiden Name                        
.PMPXETHN  DIM       3      3        1699  Ethnicity (Cat EN)                 
.PMPXHFCN  DIM       40     40       1702  Health Fund Contributor Name       
.PMPXLUBH  DIM       3      3        1742  Last Updated By Hospital (pathspaf)
OLD1SPAR  DIM       60     60       1745  Spare                              
.
.End of Record                      1805 
.
.                                     ******** copy the new FD here *******
.Data File Definition
.--------------------
PMSPX2A1   IFILE    SQL, FIXED=1806, KEY="U1-8"                                 
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
PMPXURNO  DIM       8      8        1     Patient U/R Number                 
PMPXRHC1  DIM       10     10       9     Registered HCP 1 (pmshcpaf)        
PMPXRH1G  DIM       10     10       19    Registered HCP 1 Group (pmshcgaf)  
PMPXR1GC  DIM       2      2        29    Reg. HCP 1 Group Count (pmshclaf)  
PMPXINTR  DIM       1      1        31    Interpreter Required?              
.                                         0 = No                               
.                                         1 = Yes                              
.                                         U = Unknown (Not Stated)             
PMPXLNG1  DIM       3      3        32    Preferred Language 1 (Cat LA)      
PMPXLNG2  DIM       3      3        35    Preferred Language 2 (Cat LA)      
PMPXLNG3  DIM       3      3        38    Preferred Language 3 (Cat LA)      
PMPXPEML  DIM       80     80       41    Patient's Email Address            
PMPXEDOB  DIM       1      1        121   Date of Birth Estimated? 0=NO,1=YES
PMPXCMOB  DIM       20     20       122   Emergency Contact Mobile Number    
PMPXCEML  DIM       80     80       142   Emergency Contact Email Address    
PMPXCCRP  DIM       1      1        222   Emer. Contact Corres. (0=NO,1=YES) 
PMPXKMOB  DIM       20     20       223   NOK Mobile Number                  
PMPXKEML  DIM       80     80       243   NOK Email Address                  
PMPXKCRP  DIM       1      1        323   NOK Correspondence (0=NO,1=YES)    
PMPXRMOB  DIM       20     20       324   Nearest Relative Mobile Number     
PMPXREML  DIM       80     80       344   Nearest Relative Email Address     
PMPXRCRP  DIM       1      1        424   Nearest Relative Corres. 0=NO,1=YES
PMPXMEDC  DIM       8      8        425   Medicare Card Valid to (CCYYMMDD)  
PMPXDETY  DIM       3      3        433   Death Type (Cat DY)                
PMPXPRIS  DIM       15     15       436   PRISM Number                       
PMPXCSER  DIM       15     15       451   Correctional Services Number       
PMPXPHEI  FORM      6      4        466   Patient Height                     
PMPXPWEI  FORM      6      4        470   Patient Weight                     
PMPXDREC  DIM       8      8        474   Date Weight & Height Rec.(CCYYMMDD)
PMPXMSNA  DIM       20     20       482   Mother's Surname                   
PMPXMGNA  DIM       25     25       502   Mother's Given Name                
PMPXMTLE  DIM       4      4        527   Mother's Title                     
PMPXMAD1  DIM       35     35       531   Mother's Address Line 1            
PMPXMAD2  DIM       35     35       566   Mother's Address Line 2            
PMPXMAD3  DIM       35     35       601   Mother's Address Line 3            
PMPXMAD4  DIM       35     35       636   Mother's Address Line 4            
PMPXMPOS  DIM       8      8        671   Mother's Address Post Code         
PMPXMPNO  DIM       20     20       679   Mother's Private Number            
PMPXMBNO  DIM       20     20       699   Mother's Business Number           
PMPXMMNO  DIM       20     20       719   Mother's Mobile Number             
PMPXMEML  DIM       80     80       739   Mother's Email Address             
PMPXMCNT  DIM       3      3        819   Mother's Country of Birth (Cat C)  
PMPXMCRP  DIM       1      1        822   Mother's Correspondence  0=NO,1=YES
PMPXMLAB  DIM       1      1        823   Mother's Name on Labels  0=NO,1=YES
PMPXMREL  DIM       10     10       824   Relationship to Patient            
PMPXFSNA  DIM       20     20       834   Father's Surname                   
PMPXFGNA  DIM       25     25       854   Father's Given Name                
PMPXFTLE  DIM       4      4        879   Father's Title                     
PMPXFAD1  DIM       35     35       883   Father's Address Line 1            
PMPXFAD2  DIM       35     35       918   Father's Address Line 2            
PMPXFAD3  DIM       35     35       953   Father's Address Line 3            
PMPXFAD4  DIM       35     35       988   Father's Address Line 4            
PMPXFPOS  DIM       8      8        1023  Father's Address Post Code         
PMPXFPNO  DIM       20     20       1031  Father's Private Number            
PMPXFBNO  DIM       20     20       1051  Father's Business Number           
PMPXFMNO  DIM       20     20       1071  Father's Mobile Number             
PMPXFEML  DIM       80     80       1091  Father's Email Address             
PMPXFCNT  DIM       3      3        1171  Father's Country of Birth (Cat C)  
PMPXFCRP  DIM       1      1        1174  Father's Correspondence 0=NO,1=YES 
PMPXFLAB  DIM       1      1        1175  Father's Name on Labels 0=NO,1=YES 
PMPXFREL  DIM       10     10       1176  Relationship to Patient            
PMPXTDIG  DIM       2      2        1186  Terminal Digit (Last 2 chrs of U/R)
PMPXWBID  DIM       10     10       1188  WEB User Id re. creator (websecaf) 
PMPXDVAC  DIM       3      3        1198  DVA Card Colour (Cat DX)           
PMPXPNSD  DIM       8      8        1201  Pension Start Date (CCYYMMDD)      
PMPXUYN4  DIM       1      1        1209  User Defined Y/N field 4 0=NO,1=YES
PMPXUYN5  DIM       1      1        1210  User Defined Y/N field 5 0=NO,1=YES
PMPXUYN6  DIM       1      1        1211  Not for Resusitation Y/N 0=NO,1=YES
PMPXABRG  DIM       3      3        1212  Aboriginality (Cat VA)             
PMPXPRVI  DIM       3      3        1215  Privacy Indicator (Cat PV)         
PMPXCRIN  DIM       1      1        1218  Consent Release of Info? 0=NO,1=YES
PMPXHOML  DIM       1      1        1219  Homeless? (0=NO,1=YES)             
PMPXUDC1  DIM       50     50       1220  User Defined Comments 1            
PMPXUDC2  DIM       50     50       1270  User Defined Comments 2            
PMPXUDC3  DIM       50     50       1320  User Defined Comments 3            
PMPXUSR7  DIM       3      3        1370  User Defined 7 (Category P7)       
PMPXUSR8  DIM       3      3        1373  User Defined 8 (Category P8)       
PMPXUSR9  DIM       3      3        1376  User Defined 9 (Category P9)       
PMPXMSNO  DIM       10     10       1379  Medicare Safety Net Number         
PMPXCONP  DIM       1      1        1389  Which contact for PRA              
.                                         0=Patient                            
.                                         1=Mother (this file)                 
.                                         2=Father (this file)                 
.                                         3=Next of Kin (patma1af)             
.                                         4=Emergency Contact (patmx1af)       
.                                         5=Nearest Relative (patmx1af)        
.                                         6=PRA (priinvof)                     
.                                         7=Postal                             
PMPXFLDR  DIM       3      3        1390  Folder Selection (Category FS)     
PMPXIWI1  DIM       3      3        1393  Iwi 1 (Category iw)                
PMPXIWI2  DIM       3      3        1396  Iwi 2 (Category iw)                
PMPXIWI3  DIM       3      3        1399  Iwi 3 (Category iw)                
PMPXIHOS  DIM       3      3        1402  Hospital which initiated UR        
PMPXPFSN  DIM       20     20       1405  Preferred Surname                  
PMPXPFGN  DIM       25     25       1425  Preferred Given Name               
PMPXSIN6  DIM       1      1        1450  Transport Required - 1=Yes         
PMPXSIN7  DIM       1      1        1451  Medical Alert (wahealth) - 1=Yes   
PMPXSIN8  DIM       1      1        1452  Micro Alert (wahealth) - 1=Yes     
PMPXSIN9  DIM       1      1        1453  Risk Alert (wahealth) - 1=Yes      
PMPXSN10  DIM       1      1        1454  Status Ind 10 - 1=Yes              
PMPXSN11  DIM       1      1        1455  Status Ind 11 - 1=Yes              
PMPXSN12  DIM       1      1        1456  Patient Debt Only - 1=Yes          
PMPXSN13  DIM       1      1        1457  Set Payment Plan - 1=Yes           
PMPXSN14  DIM       1      1        1458  Debt Collection Agency - 1=Yes     
PMPXSN15  DIM       1      1        1459  Outstanding Debt Ind. 1=Yes        
PMPXPFAX  DIM       20     20       1460  Patient Fax Number                 
PMPXFNAM  DIM       40     40       1480  Patient First Name                 
PMPXSNAM  DIM       40     40       1520  Patient Second Name                
PMPXHFGN  DIM       40     40       1560  Health Fund First Given Name Alias 
PMPXHFSN  DIM       40     40       1600  Health Fund Surname Alias          
PMPXFUPI  DIM       2      2        1640  Health Fund UPI                    
PMPXVGPC  DIM       10     10       1642  Verified GP Code (pmshcpaf)        
PMPXVGPP  DIM       10     10       1652  Verified GP Practice (pmshcgaf)    
PMPXVGPG  DIM       2      2        1662  Verified GP Group Count (pmshclaf) 
PMPXASNO  DIM       15     15       1664  Ambulance Subscriber No.           
PMPXMAID  DIM       20     20       1679  Maiden Name                        
PMPXETHN  DIM       3      3        1699  Ethnicity (Cat EN)                 
PMPXHFCN  DIM       40     40       1702  Health Fund Contributor Name       
PMPXLUBH  DIM       3      3        1742  Last Updated By Hospital (pathspaf)
PMPXPMCN  DIM       3      3        1745  Preferred Method of Contact (Cat Pn
PMPXPMCR  DIM       3      3        1748  Preferred Method of Correspondence 
PMPXCRN1  DIM       1      1        1751  Consent of Release of Info to HCP1 
.                                         0=NO,1=YES                           
PMPXCRN2  DIM       1      1        1752  Consent of Release of Info to HCP2 
.                                         0=NO,1=YES                           
PMPXCRN3  DIM       1      1        1753  Consent of Release of Info to HCP3 
.                                         0=NO,1=YES                           
PMPXCRN4  DIM       1      1        1754  Consent of Release of Info to HCP4 
.                                         0=NO,1=YES                           
PMPXCRN5  DIM       1      1        1755  Consent of Release of Info to HCP5 
.                                         0=NO,1=YES                           
PMPXSPAR  DIM       50     50       1756  Spare                              
.
.End of Record                      1806 
.
.
. LOCAL VARIABLES
. ---------------
CMDLINE   DIM       200
.
DEFPATH   DIM       60
DIM60     DIM       60
DISNUM    FORM      4
.
INPFILE   DIM       8
.
NEWFILE   DIM       60
NEWPATH   DIM       60
.
OLDPATH   DIM       60
.
RECNUM    FORM      8
.
SAVEFLG   FORM      1
.
USINGORC  DIM       1
.
. PROGRAM CONSTANTS
. -----------------
SP60      INIT    "                                                            "
.
PRGNAM    INIT      "CONVERSION PMSPX2FD"
PRGID     INIT      "F04PMPX2"
VERSION   INIT      "V12.00.00"
+
.*****************************************************************************
.*                             MAIN0000                                      *
.*                         Program Mainline                                  *
.*****************************************************************************
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      OPTN0000                      * get option
          BRANCH    COPTION,MAIN1000:             * run c-isam fixit
                            MAIN2000              * run oracle fixit
          GOTO      MAIN9999                      * exit selected
.
MAIN1000  CALL      KDIR0000                      * Keyin directory
          BRANCH    EXIT,MAIN9999
.
MAIN2000  CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN5000:               * yes
                          MAIN0000:               * no
                          MAIN9999                * cancel
.
MAIN5000  BRANCH    COPTION,MAIN6000:             * c-isam fixit
                            MAIN7000              * oracle fixit
.
.         Running c-isam fix
.
MAIN6000  CALL      PREP0000                      * preparing files
          BRANCH    EXIT,MAIN9999
.
          CALL      READ0000                      * read old records and write
          CALL      ENDP0000                      * save/zip saved file
          GOTO      MAIN9999
.
.         Running oracle fix
.
MAIN7000  CALL      OFIX0000                      * run oracle fix
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
.
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
          MOVE      ZERO,DISNUM
          
INIT9999  RETURN
+
.*****************************************************************************
.*                                OPTN0000             Called by: MAIN0000   *
.*                        Get user options or exit                           *
.*    Returns:  EXIT    = FALSE (0)  Ok to proceed                           *
.*                        TRUE  (1)  Exit option selected                    *
.*              COPTION - option selected                                    *
.*****************************************************************************
.
OPTN0000  MOVE      "No",USINGORC
          REP       "yYnN",USINGORC
          MOVE      USINGORC,KEY1
          REP       "Y-N-",KEY1
          MATCH     "-",KEY1
          GOTO      OPTN9200 IF NOT EQUAL
.
          DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Run Fixit (c-isam only)"
          MATCH     "Y",USINGORC
          IF        @EQUAL
            DISPLAY   *P1:6,*V2LON,TWO,*HOFF,". Run Fixit (Oracle only)"
          ENDIF
.
OPTN0500  KEYIN     *P1:8,*EL,"Select Option : ":
                    *P17:8,*V2LON,COPTION
.
          COMPARE   ZERO,COPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    COPTION,OPTN9000:            * run c-isam fixit
                            OPTN9000             * run oracle fixit
.
          BEEP
          GOTO      OPTN0500
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9200  DISPLAY   *P1:3,*EF,*P1:4," Oracle Option has not been set up ":
                          "correctly":
                    *P1:6," Program will terminate    - ";
          CALL      HITENTER
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.********************************************************************
.*                          KDIR0000                                *
.*  Keyin directories                                               *
.********************************************************************
.
KDIR0000  MOVE      ONE,SAVEFLG        * Default to keep file
          KEYIN     *P1:10,*EL,"Do you want to save the original file (Y/N) ? ":
                    ANS;
          REP       "yYnN",ANS
          CMATCH    "Y",ANS
          GOTO      KDIR1000 IF EQUAL
          MOVE      ZERO,SAVEFLG       * not to keep file
          CMATCH    "N",ANS
          GOTO      KDIR1000 IF EQUAL
          BEEP
          GOTO      KDIR0000
.
KDIR1000  CALL      DEFT0000                * Get the default path
          BRANCH    EXIT,KDIR9999
          MOVE      SP60,OLDPATH
.
          DISPLAY   *P1:24,*EL,"The directory path must end with a slash (/) ";
.
          MOVE      DEFPATH,OLDPATH
          BRANCH    SAVEFLG,KDIR2000
.
.         Keyin the path for the original file
.
          KEYIN     *P1:12,*EL,"Keyin path for temporarily saving original ":
                    "file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
          GOTO      KDIR3000
.
KDIR2000  KEYIN     *P1:12,*EL,"Keyin path for saving original file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
.
KDIR3000  ENDSET    OLDPATH
          APPEND    SP60,OLDPATH
          RESET     OLDPATH
.
          MATCH     SP60,OLDPATH
          IF        @EQUAL
            PACK      OLDPATH,DEFPATH      * use the default
            DISPLAY   *P10:13,*EL,*V2LON,OLDPATH;
          ENDIF
.
          SQUEEZE   OLDPATH
          CMATCH    EXITCHAR,OLDPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,OLDPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR1000
.
.         Keyin the path for the new file
.
KDIR5000  MOVE      SP60,NEWPATH
          MOVE      DEFPATH,NEWPATH
          KEYIN     *P1:15,*EL,"Keyin path for the new file: ":
                    *P10:16,*EL,*DV,*RV,NEWPATH:
                    *P10:16,NEWPATH;
          ENDSET    NEWPATH
          APPEND    SP60,NEWPATH
          RESET     NEWPATH
.
          MATCH     SP60,NEWPATH
          IF        @EQUAL
            PACK      NEWPATH,DEFPATH      * use the default
            DISPLAY   *P10:16,*V2LON,NEWPATH;
          ENDIF
.
          SQUEEZE   NEWPATH
          CMATCH    EXITCHAR,NEWPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,NEWPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR5000
          GOTO      KDIR9999
.
KDIR9000  MOVE      ONE,EXIT
.
KDIR9999  DISPLAY   *P1:24,*EL;
          RETURN
+
.********************************************************************
.*                          PREP0000                                *
.*  Preparing files                                                 *
.********************************************************************
.
PREP0000  MOVE      "pmspx2af",INPFILE
          CALL      CHEK0000             * check file exists or has been changed
          BRANCH    EXIT,PREP9000
.
          CLOSE     OLDFILE1
          DISPLAY   *P1:24,*EL,"Copying files ... Please wait !! ";
.
.         Copy old file to the keyin directory
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmspx2af.dat` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmpx2af.dat",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat pmspx2af.idx` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "spmpx2af.idx",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
.         Remove the original files
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    DEFPATH,CMDLINE
          APPEND    "pmspx2af",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Unable to remove the original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
.         Opening old file after being copied
.
          MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60
          APPEND    "spmpx2af",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE1,DIM60
          TRAPCLR   IO
          IF        OVRCD = 1
            DISPLAY   *P1:24,*EL,*B,"Unable to open saved original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
.         Create the new file
.
          DISPLAY   *P1:24,*EL,"Creating new files ... Please wait !! ";
          PACK      NEWFILE,SP60
          CLEAR     NEWFILE
          APPEND    NEWPATH,NEWFILE
          APPEND    "pmspx2af",NEWFILE
          APPEND    SP60,NEWFILE
          RESET     NEWFILE
          SQUEEZE   NEWFILE
.
PREP1000  PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    NEWFILE,CMDLINE
.
.  The files new record length and unique key must be written here
.      eg    APPEND    " 195 UC9-16",CMDLINE
.
          APPEND    " 1806 UC1-8",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      PMSPX2A1,NEWFILE
.
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,"Record : "
          GOTO      PREP9999
.
PREP5000  DISPLAY   *P1:24,*EL,*B,"Old file not found.  ";
          CALL      HITENTER
          GOTO      PREP9000
.
PREP8000  DISPLAY   *P1:24,*EL,*B,"Unable to copy original file.  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
.
PREP9000  MOVE      ONE,EXIT
.
PREP9999  RETURN
+
.********************************************************************
.*                          CHEK0000                                *
.*  Check if file exists, or has already been converted             *
.********************************************************************
.
CHEK0000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND GIVING DIM60 IF IO
          OPEN      OLDFILE1,INPFILE
          TRAPCLR   IO
          BRANCH    OVRCD,CHEK2000       * Original file does not exist
          CLOSE     OLDFILE1
          GOTO      CHEK9999
.
CHEK2000  RESET     DIM60
          SCAN      "I * I",DIM60
          DISPLAY   *P1:23,*EF,"File '",INPFILE,"' ";
          IF        @EQUAL
            DISPLAY   "does not exist - ";
          ELSE
            RESET     DIM60
            SCAN      "I * L",DIM60
            IF        @EQUAL
              DISPLAY   "has already been converted - ";
            ELSE
              DISPLAY   "has caused an IO error - ";
            ENDIF
          ENDIF
          DISPLAY   "File will be bypassed"
.
          CALL      HITENTER
          DISPLAY   *P1:23,*EF;
.
CHEK9000  MOVE      ONE,EXIT
.
CHEK9999  RETURN
+
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
.
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
.
          PACK      KEY8,SP60
          CALL      READSOLD                      * position at start
READ1000  CALL      READKOLD                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
.
          ADD       ONE,RECNUM                    * update record counter
          ADD       ONE,DISNUM                    * Display counter
.
          IF        DISNUM = 5000  | RECNUM = 1
            MOVE      ZERO,DISNUM
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
.  All necessary changes to the files field lengths, date changes
.  or any other sort of modification must be made here
.
          PACK      PMPXCRN1,SP10
          PACK      PMPXCRN2,SP10
          PACK      PMPXCRN3,SP10
          PACK      PMPXCRN4,SP10
          PACK      PMPXCRN5,SP10
          PACK      PMPXSPAR,SP70  
.                                               * Pack key here
          PACK      KEY8,PMPXURNO,SP70
          CALL      WRPMPX21                    * write to new file
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     PMSPX2A1                      * close new file
          CLOSE     OLDFILE1                      * close old file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P15:20,*V2LON,RECNUM,*HOFF:
                    *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS:
                    *P1:24;
          CALL      HITENTER
.
READ9999  RETURN
+
.**********************************************************************
.*                               VALD0000                             *
.*        Check if it a valid directory                               *
.**********************************************************************
.
VALD0000  MOVE      ZERO,EXIT
.
          SQUEEZE   DIM60
          ENDSET    DIM60
          CMATCH    SLASH,DIM60
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory path must end with a slash (/) ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          RESET     DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cd ",CMDLINE
          APPEND    DIM60,CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory does not exist ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          GOTO      VALD9999
.
VALD9000  MOVE      ONE,EXIT            * Not valid
.
VALD9999  RETURN
+
.**********************************************************************
.*                               ENDP0000                             *
.*        Remove or zip save file                                     *
.**********************************************************************
.
ENDP0000  MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60        * set up the saved file with path
          APPEND    "spmpx2af*",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
          SQUEEZE   DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          IF        SAVEFLG = 1
            APPEND    "gzip ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Compressing original file.. ":
                      "Please wait !!  ";
          ELSE
            APPEND    "rm ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Removing original file.. Please wait !!  ";
          ENDIF
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Saved file not zipped or removed.  ";
            CALL      HITENTER
            GOTO      ENDP9999
          ENDIF
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:24,*EL,*B,"Finished processing  ",CDATE,SP1,CTIMEIS:
                    ".  ";
          CALL      HITENTER
.
ENDP9999  RETURN
+
.**********************************************************************
.*        DEFT0000 -  Get the default directory                       *
.**********************************************************************
.
DEFT0000  EXECUTE   "ldat pmspx2af.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding 'pmspx2af'.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
.
DEFT9999  RETURN
+
.*****************************************************************************
.*                            OFIX0000                                       *
.*                    Oracle fix to "PMSPX2FD"                               *
.*****************************************************************************
.
OFIX0000  DISPLAY   *P1:24,*EL;
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,*EL,"Record No. :";
          OPEN      PMSPX2A1,"pmspx2af"
.
          PACK      KEY8,SP70
          CALL      OFDUMYIO                      * position at start of file
OFIX0500  CALL      OFDUMYIO                      * read next record
          BRANCH    OVRCD,OFIX9000                * eof - finished
.
          ADD       ONE,RECNUM                    * increment record counter
          ADD       ONE,DISNUM                    * Display counter
.         
          IF        DISNUM = 5000  | RECNUM = 1
            MOVE      ZERO,DISNUM 
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
.>>>>>>>  Add code here to populate/update variables
.
          CALL      OFDUMYIO
.
          GOTO      OFIX0500                     * get next record
.         
OFIX9000  CLOSE     PMSPX2A1
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P15:20,*V2LON,RECNUM,*HOFF:
                    *P1:22,"Update completed ",CDATE,SP1,CTIMEIS:
                    *P1:24;
          CALL      HITENTER
.
OFIX9999  RETURN
.
OFDUMYIO  RETURN
+
.*****************************************************************************
.*        I/O Routines                                                       *
.*****************************************************************************
.
.                  ******************************    OLD IO ROUTINES
READSOLD  RESET     KEY8                                                        
          READ      OLDFILE1,KEY8;;                                             
          RETURN
.
READKOLD  MOVE      ZERO,OVRCD                                                  
          READKS    OLDFILE1;PMPXURNO,PMPXRHC1,PMPXRH1G,PMPXR1GC,PMPXINTR:      
                        PMPXLNG1,PMPXLNG2,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:  
                        PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP,PMPXRMOB:  
                        PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER:  
                        PMPXPHEI,PMPXPWEI,PMPXDREC,PMPXMSNA,PMPXMGNA,PMPXMTLE:  
                        PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO:  
                        PMPXMBNO,PMPXMMNO,PMPXMEML,PMPXMCNT,PMPXMCRP,PMPXMLAB:  
                        PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1,PMPXFAD2:  
                        PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO:  
                        PMPXFEML,PMPXFCNT,PMPXFCRP,PMPXFLAB,PMPXFREL,PMPXTDIG:  
                        PMPXWBID,PMPXDVAC,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:  
                        PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1,PMPXUDC2:  
                        PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9,PMPXMSNO,PMPXCONP:  
                        PMPXFLDR,PMPXIWI1,PMPXIWI2,PMPXIWI3,PMPXIHOS,PMPXPFSN:  
                        PMPXPFGN,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:  
                        PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,PMPXPFAX:  
                        PMPXFNAM,PMPXSNAM,PMPXHFGN,PMPXHFSN,PMPXFUPI,PMPXVGPC:  
                        PMPXVGPP,PMPXVGPG,PMPXASNO,PMPXMAID,PMPXETHN,PMPXHFCN:  
                        PMPXLUBH,OLD1SPAR                
          GOTO      OVERCOND IF OVER
          UNPACK    OLD1SPAR,PMPXPMCN,PMPXPMCR
          RETURN
.
.                  ******************************    NEW IO ROUTINES
WRPMPX21  RESET     KEY8                                                        
          WRITE     PMSPX2A1,KEY8;PMPXURNO,PMPXRHC1,PMPXRH1G,PMPXR1GC,PMPXINTR: 
                        PMPXLNG1,PMPXLNG2,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:  
                        PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP,PMPXRMOB:  
                        PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER:  
                        PMPXPHEI,PMPXPWEI,PMPXDREC,PMPXMSNA,PMPXMGNA,PMPXMTLE:  
                        PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO:  
                        PMPXMBNO,PMPXMMNO,PMPXMEML,PMPXMCNT,PMPXMCRP,PMPXMLAB:  
                        PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1,PMPXFAD2:  
                        PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO:  
                        PMPXFEML,PMPXFCNT,PMPXFCRP,PMPXFLAB,PMPXFREL,PMPXTDIG:  
                        PMPXWBID,PMPXDVAC,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:  
                        PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1,PMPXUDC2:  
                        PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9,PMPXMSNO,PMPXCONP:  
                        PMPXFLDR,PMPXIWI1,PMPXIWI2,PMPXIWI3,PMPXIHOS,PMPXPFSN:  
                        PMPXPFGN,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:  
                        PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,PMPXPFAX:  
                        PMPXFNAM,PMPXSNAM,PMPXHFGN,PMPXHFSN,PMPXFUPI,PMPXVGPC:  
                        PMPXVGPP,PMPXVGPG,PMPXASNO,PMPXMAID,PMPXETHN,PMPXHFCN:  
                        PMPXLUBH,PMPXPMCN,PMPXPMCR,PMPXCRN1,PMPXCRN2,PMPXCRN3:  
                        PMPXCRN4,PMPXCRN5,PMPXSPAR                              
          RETURN
.
          INC       STD001IO
