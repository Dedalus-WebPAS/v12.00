.*****************************************************************************
.*    Program      : F02PTGSR                                                *
.*    Description  : Conversion patgsrnf to new File layout                  *
.*                                                                           *
.*    Author       : Steve Armstrong   CAR 240722                            *
.*    Date         : 07/06/2011                                              *
.*    Modifications:                                                         *
.*        V10.04.01  Steve Armstrong   CAR 300030                            *
.*                   Mods to load SVKEY115 using DGSRBILL instead of         *
.*                   GSRBILL for the OFIX0000 routine.                       *
.*****************************************************************************
.*        V10.03.04  Steve Armstrong   CAR 286413                            *
.*                   Mods to only read PMI records when U/R changes          *
.*                   (READ0000 only).                                        *
.*                   Also moved call to CLPMSPX2 to only be called where a   *
.*                   pmspx2af record doesn't exist for a U/R.                *
.*                   Also removed display of records during processing (to   *
.*                   reduce time taken due to modulus calculation on every   *
.*                   record).                                                *
.*        V10.03.03  Steve Armstrong   CAR 283815                            *
.*                   Mods to delete records giving I*U error on UPDATE.      *
.*                   Mods to print a report for unprocessed records.         *
.*        V10.03.02  Steve Armstrong   CAR 283667                            *
.*                   Mods to only read PMI records when U/R changes          *
.*                   (OFIX0000 only)                                         *
.*        V10.03.01  Steve Armstrong   CAR 280773                            *
.*                   Extended CMDLINE from 100 to 200 bytes.                 *
.*****************************************************************************
.*        V10.02.01  Steve Armstrong   CAR 240722                            *
.*                   Mods to cater for second given name being added to      *
.*                   PATGSRFD keys.                                          *
.*****************************************************************************
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
.         Old file definition
.         
OLDFILE1  IFILE SQL, FIXED=109, KEY="U1-8,9-16,17-36,37-61,90-97,98-98"
.
. NAME     TYPE   LENGTH   PHYSICAL   START LOC.   DESCRIPTION          
. ----     ----   ------   --------   ----------   ----------- 
.GSRURNO   DIM       8           8         1       U/R NUMBER           
.DGSRBILL  DIM       8           8         9       BILLING NUMBER (IF NO U/R)
OLDSNAM    DIM      20          20        17       SURNAME              
OLDGNAM    DIM      25          25        37       GIVEN NAMES          
.GSRSKEY   DIM      10          10        62       SOUND-EX KEY
.GSRGKEY1  DIM       8           8        72       SOUND-EX KEY for 1st giv. nam
.GSRGKEY2  DIM       8           8        80       SOUND-EX KEY for 2nd giv. nam
.GSRSYS    FORM      1           2        88       SYSTEM (IF NO U/R)
.GSRDOB    DIM       8           8        90       Date of Birth
.GSRSEX    DIM       1           1        98       Sex
OLDSPARE   DIM      10          10        99       spare
.
.End of Record                           109
.
.
.         New file definition
.
PATGSRN1   IFILE SQL, FIXED=194, KEY="U1-8,9-16,17-46,47-76,114-143,105-112,113-113"
.
. NAME     TYPE   LENGTH   PHYSICAL   START LOC.   DESCRIPTION
. ----     ----   ------   --------   ----------   -----------
GSRURNO    DIM       8           8         1       U/R NUMBER
DGSRBILL   DIM       8           8         9       BILLING NUMBER (IF NO U/R)
GSRSNAM    DIM      30          30        17       SURNAME
GSRGNAM    DIM      30          30        47       FIRST GIVEN NAME
GSRSKEY    DIM      10          10        77       SOUND-EX KEY
GSRGKEY1   DIM       8           8        87       SOUND-EX KEY for 1st giv. nam
GSRGKEY2   DIM       8           8        95       SOUND-EX KEY for 2nd giv. nam
GSRSYS     FORM      1           2       103       SYSTEM (IF NO U/R)
GSRDOB     DIM       8           8       105       Date of Birth
GSRSEX     DIM       1           1       113       Sex
PTGSGNM2   DIM      30          30       114       SECOND GIVEN NAME
GSRSPARE   DIM      50          50       144       spare
.
.End of Record                           194
.
.
.         Other File definitions
.
PATMA1A1   IFILE SQL, FIXED=1045, KEY="U1-8"    
.
. NAME     TYPE  LENGTH  PHYSICAL  START LOC.   DESCRIPTION
. ----     ----  ------  --------  ----------   -----------
PURNO      DIM      8         8          1      PATIENT U.R NO.
PPORT      DIM      2         2          9      PORT CURRENTLY UPDATING U/R
PCHGDTE    DIM      8         8         11      date of last change   (ccyymmdd)
PTITL      DIM      4         4         19      PATIENT TITLE
PHOSP      FORM     1         2         23      HOSPITAL LAST 12 MONTHS
.                                               1-YES,0-NO
PLDAYS     FORM     3         3         25      NO DAYS LAST IN HOSPITAL
PBDEBT     FORM     1         2         28      BAD DEBTOR INDICATOR 0-NO 1-YES
PSNAME     DIM     20        20         30      PATIENT SURNAME
PGNAME     DIM     25        25         50      PATIENTS GIVEN NAMES
PPSNAME    DIM     19        19         75      PATIENTS PREVIOUS SURNAME
PADD1      DIM     35        35         94      PATIENT ADDRESS LINE 1
PADD2      DIM     35        35        129      PATIENT ADDRESS LINE 2
PSUBRB     DIM     35        35        164      PATIENT ADDRESS LINE 3
PADD4      DIM     35        35        199      PATIENT ADDRESS LINE 4
PPOST      DIM      8         8        234      PATIENT POSTCODE
PTELEP     DIM     20        20        242      TELEPHONE PRIVATE
PTELEB     DIM     20        20        262      TELEPHONE BUSINESS
PSEX       DIM      1         1        282      PATIENTS SEX
PMSTAT     DIM      3         3        283      PATIENTS MARTIAL STATUS (Cat M)
PBDATE     DIM      8         8        286      date of birth         (ccyymmdd)
PSAGE      FORM     3         3        294      PATIENTS AGE
PCONT      DIM      3         3        297      COUNTRY OF BIRTH (Cat C)
PREG       DIM      3         3        300      PATIENTS RELIGION (Cat R)
PTYPE      DIM      3         3        303      PATIENTS TYPE (Cat T)
POCCUP     DIM     14        14        306      PATIENTS OCCUPATION
PLDDATE    DIM      8         8        320      last discharge date   (ccyymmdd)
PMEDI      DIM     10        10        328      MEDICARE NUMBER
PPENNO     DIM     15        15        338      PENSION NUMBER
PPNDTE     DIM      6         6        353      pension no expiry date  (ccyymm)
PREPAT     DIM     10        10        359      REPATRIATION NUMBER
PSMOK     FORM      1         2        369      PATIENT SMOKER
.                                               1 = YES
.                                               2 = NO
PSTAT      FORM     1         2        371      PATIENT STATUS
.                                               0 - VALID U/R  (IN MASTER FILE)
.                                               1 - CANCELLED U/R
.                                               2 - ASSOCIATED U/R
.                                               NOTE :- ASSOCIATED U/R IS NOW
.                                                       PLACED IN THE PADMNO
.                                               3 - NOT YET ALLOCATED
.                                               ****** (IN PRAM FILE) ********
PMICRO     DIM     20        20        373      MICROFILM ADDRESS
.                                               1 -  6  U.R. NO.
.                                               7 - 10  ROLL NO.
.                                               11 - 14  POSITION NO.
.                                               15 - 16  YEAR
PCEASE     FORM     1         2        393      DECEASED INDICATOR
.                                               0 = NO
.                                               1 = YES
PCASE      FORM     1         2        395      CASE NOTES INDICATOR
PAUTOPY    FORM     1         2        397      AUTOPSY INDICATOR
.                                               0 = NO
.                                               1 = YES
.
PHIGH1     DIM      3         3        399      HIGHLIGHT CODE 1 (Cat H1)
PHIGH2     DIM      3         3        402      HIGHLIGHT CODE 2 (Cat H2)
PHIGH3     DIM      3         3        405      HIGHLIGHT CODE 3 (Cat H3)
.
PLOCDOC    DIM     30        30        408      LOCAL DOCTOR
.
PFUNDH     DIM      6         6        438      HEALTH FUND
PFNDTB     DIM      8         8        444      HEALTH FUND TABLE
PTMASPAR   DIM     10        10        452      Spare - was HF membership no
.
PUSR1      DIM      3         3        462      USER DEFINED FIELD 1 (Cat P1)
PUSR2      DIM      3         3        465      USER DEFINED FIELD 2 (Cat P2)
PUSR3      DIM      3         3        468      USER DEFINED FIELD 3 (Cat P3)
PUSR4      DIM      3         3        471      USER DEFINED FIELD 4 (Cat P4)
PUSR5      DIM      3         3        474      USER DEFINED FIELD 5 (Cat P5)
PUSR6      DIM      3         3        477      USER DEFINED FIELD 6 (Cat P6)
PUYN1      FORM     1         2        480      USER DEFINED Y/N FIELD 1
.                                               (1=Y,0=N)
PUYN2      FORM     1         2        482      USER DEFINED Y/N FIELD 2
.                                               (1=Y,0=N)
PUYN3      FORM     1         2        484      USER DEFINED Y/N FIELD 3
.                                               (1=Y,0=N)
PYRRES     FORM     2         2        486      NUMBER OF YEARS RESIDENT
.
.              NEXT OF KIN DATA
.
PNKNAME    DIM     20        20        488      NEXT OF KIN 1 NAME
PNKADD1    DIM     35        35        508      N.O.K 1 ADDRESS LINE 1
PNKADD2    DIM     35        35        543      N.O.K 1 ADDRESS LINE 2
PNKSUBR    DIM     35        35        578      N.O.K 1 ADDRESS LINE 3
PNKADD4    DIM     35        35        613      N.O.K 1 ADDRESS LINE 4
PNKPOST    DIM      8         8        648      N.O.K 1 POSTCODE
PNKTELP    DIM     20        20        656      N.O.K 1 PRIVATE TELEPHONE
PNKTELB    DIM     20        20        676      N.O.K 1 BUSINESS TELEPHONE
PNKRELP    DIM     10        10        696      N.O.K 1 RELATIONSHIP
.
PLSTINP    FORM     8         5        706      LAST INPATIENT  VISIT NUMBER
PLSTOUT    FORM     8         5        711      LAST OUTPATIENT VISIT NUMBER
PNXRAY     FORM     3         3        716      NUMBER OF PREVIOUS X-RAYS
.
.          Additional Health Fund details
.
PFNDYY     DIM      2         2        719      YRS OF FUND MEMBERSHIP (JR,DE)
PFNDCG     DIM      6         6        721      fund cover change       (ccyymm)
.
PDECDTE    DIM      8         8        727      date of death         (ccyymmdd)
PHCNOTES   DIM     20        20        735      CASE NOTES INDICATORS
PDIET      DIM      3         3        755      DEFAULT DIET CODE (Cat DC)
PINITHOS   DIM      2         2        758      HOSPITAL U/R INITIATED FROM
PHKADUNI   DIM     10        10        760      HONG KONG UNIQUE ADDRESS ID
PTMAEMPC   DIM      6         6        770      PATIENT EMPLOYER CODE
PTMANOKO   DIM     14        14        776      NEXT OF KIN OCCUPATION
PTMANOKE   DIM      6         6        790      NEXT OF KIN EMPLOYER CODE
PTMADCNO   DIM     10        10        796      DEATH CERTIFICATE NUMBER
PTMAUKDB   DIM      1         1        806      Unknown Date of Birth (Y/N)
PTMAUKDD   DIM      1         1        807      Unknown Date of Death (Y/N)
PFNDMM     DIM     19        19        808      Health Fund Membership no.
PTMADCDT   DIM      8         8        827      Demographics Conf Date CCYYMMDD
PTMAHCP1   DIM     10        10        835      HCP 1 (pmshcpaf)
PTMAHCL1   DIM     10        10        845      HCP 1 Practice (pmshclaf)
PTMAHCG1   DIM      2         2        855      HCP 1 Grp Count (pmshcgaf
PTMAHCP2   DIM     10        10        857      HCP 2 (pmshcpaf)
PTMAHCL2   DIM     10        10        867      HCP 2 Practice (pmshclaf)
PTMAHCG2   DIM      2         2        877      HCP 2 Grp Count (pmshcgaf
PTMAHCP3   DIM     10        10        879      HCP 3 (pmshcpaf)
PTMAHCL3   DIM     10        10        889      HCP 3 Practice (pmshclaf)
PTMAHCG3   DIM      2         2        899      HCP 3 Grp Count (pmshcgaf
PTMAHCP4   DIM     10        10        901      HCP 4 (pmshcpaf)
PTMAHCL4   DIM     10        10        911      HCP 4 Practice (pmshclaf)
PTMAHCG4   DIM      2         2        921      HCP 4 Grp Count (pmshcgaf
PTMAHCP5   DIM     10        10        923      HCP 5 (pmshcpaf)
PTMAHCL5   DIM     10        10        933      HCP 5 Practice (pmshclaf)
PTMAHCG5   DIM      2         2        943      HCP 5 Grp Count (pmshcgaf
PTMASNAM   DIM     40        40        945      Patient Surname
PTMADCUD   DIM      8         8        985      Demog. Conf Upd Date (CCYYMMDD)
PTMADCUT   DIM      8         8        993      Demog. Conf Upd Time (HH:MM:SS)
PTMADCUU   DIM      10       10       1001      Demog. Conf Upd User (websecaf)
PTMASPA2   DIM     34        34       1011      Spare
.
.End of Record                        1045
.
.
PATMX1A1  IFILE     SQL, FIXED=850, KEY="U1-8"
.
.NAME     Type      Length  PHYS.  START  DESCRIPTION
.----     ----      ------  -----  -----  -------------------------------
.PURNO    DIM       8           8      1  Patient U/R No.
PTMXRDAT  DIM       8           8      9  Registration Date
PTMXMEAL  DIM       30         30     17  Special Meal Requirements
PTMXLGA   DIM       4           4     47  LGA Code
PTMXLS    DIM       3           3     51  Current Legal status (Cat LS)
PTMXLSDT  DIM       8           8     54  Date of legal status (ccyymmdd)
PTMXFHMD  DIM       1           1     62  Familial history of mental disorder ?
.                                           1 = Yes ; 2 = No
PTMXMHU1  DIM       3           3     63  M.H. User defined field 1 (Cat V6)
PTMXMHU2  DIM       3           3     66  M.H. User defined field 2 (Cat V7)
PTMXMHU3  DIM       3           3     69  M.H. User defined field 3 (Cat V8)
PTMXECNM  DIM       20         20     72  Emergency contact name
PTMXECA1  DIM       35         35     92  Emergency contact address line 1
PTMXECA2  DIM       35         35    127  Emergency contact address line 2
PTMXECA3  DIM       35         35    162  Emergency contact address line 3
PTMXECA4  DIM       35         35    197  Emergency contact address line 4
PTMXECPC  DIM       8           8    232  Emergency contact postcode
PTMXECPP  DIM       20         20    240  Emergency contact private phone
PTMXECBP  DIM       20         20    260  Emergency contact business phone
PTMXECRE  DIM       10         10    280  Emergency contact relationship
PTMXNRNM  DIM       20         20    290  Nearest relative name
PTMXNRA1  DIM       35         35    310  Nearest relative address line 1
PTMXNRA2  DIM       35         35    345  Nearest relative address line 2
PTMXNRA3  DIM       35         35    380  Nearest relative address line 3
PTMXNRA4  DIM       35         35    415  Nearest relative address line 4
PTMXNRPC  DIM       8           8    450  Nearest relative postcode
PTMXNRPP  DIM       20         20    458  Nearest relative private phone
PTMXNRBP  DIM       20         20    478  Nearest relative business phone
PTMXNRRE  DIM       10         10    498  Nearest relative relationship
PTMX3BEX  DIM       8          8     508  3B certificate expiry date
PTMXCARD  DIM       20         20    516  Card number (NZ billing)
PTMXCEXP  DIM       8          8     536  Card expiry date (NZ billing)
PTMXCXMP  DIM       3          3     544  Card exemption type (Cat XM)
PTMXFMLY  DIM       12         12    547  Family id
PTMXCHNM  DIM       20         20    559  Chinese Name
PTMXDOFR  DIM       3          3     579  District of Residence (Cat DA)
PTMXREGP  DIM       8          8     582  Registered GP
PTMXGPPC  DIM       6          6     590  GP Practice Code
PTMXSPID  DIM       20         20    596  Supplementary Id
PTMXGPPT  DIM       2          2     616  GP Practice count
PTMXOSDT  DIM       8          8     618  Date Arrived from Overseas (CCYYMMDD)
PTMXOPER  DIM       4          4     626  Sec. Code Operator who Created Record
PTMXUKDO  DIM       1          1     630  Unknown Date Arrived from O/S (Y/N)
PTMXCELL  DIM       20         20    631  Patient's Mobile Phone No.
PTMXADD1  DIM       35         35    651  Postal Address Line 1
PTMXADD2  DIM       35         35    686  Postal Address Line 2
PTMXADD3  DIM       35         35    721  Postal Address Line 3
PTMXADD4  DIM       35         35    756  Postal Address Line 4
PTMXPOST  DIM       8          8     791  Postal Address Post Code
PTMXMCCD  DIM       2          2     799  Medicare Code
PTMXSIN1  DIM       1          1     801  Status Ind 1 - Alerts present(1=yes)
.                                         2=Security alerts 3=Deleted Alerts
.                                         or lowest indicator 4 alert assigned
PTMXSIN2  DIM       1          1     802  Status Ind 2 - Results present(1=yes)
PTMXSIN3  DIM       1          1     803  Status Ind 3 - Clinical notes present
PTMXSIN4  DIM       1          1     804  Status Ind 4 - Clinical Documentation
PTMXSIN5  DIM       1          1     805  Status Ind 5 - Legacy Visits (1=yes)
PTMXCTIM  DIM       20         20    806  Time/Date Change(ccyymmddhh:mm:ss:mmm)
PTMXSLAC  DIM       8          8     826  Year last Psych adm (was SLA Code)
PTMXFILN  DIM       3          3     834  Filing Required
PTMXDEAF  DIM       3          3     837  Deaf  (Category DK)
PTMXSPAR  DIM       10         10    840  Spare Variable
.
.End of Record                       850
.
.
PMSPX2A1   IFILE    SQL, FIXED=1805, KEY="U1-8"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
PMPXURNO  DIM       8      8        1     Patient U/R Number
PMPXRHC1  DIM       10     10       9     Registered HCP 1 (pmshcpaf)
PMPXRH1G  DIM       10     10       19    Registered HCP 1 Group (pmshcgaf)
PMPXR1GC  DIM       2      2        29    Reg. HCP 1 Group Count (pmshclaf)
PMPXINTR  DIM       1      1        31    Interpreter Required? (0=NO,1=YES)
PMPXLNG1  DIM       3      3        32    Preferred Language 1 (Cat LA)
PMPXLNG2  DIM       3      3        35    Preferred Language 2 (Cat LA)
PMPXLNG3  DIM       3      3        38    Preferred Language 3 (Cat LA)
PMPXPEML  DIM       80     80       41    Patient's Email Address
PMPXEDOB  DIM       1      1        121   Date of Birth Estimated? 0=NO,1=YES
PMPXCMOB  DIM       20     20       122   Emergency Contact Mobile Number
PMPXCEML  DIM       80     80       142   Emergency Contact Email Address
PMPXCCRP  DIM       1      1        222   Emer. Contact Corres. (0=NO,1=YES)
PMPXKMOB  DIM       20     20       223   NOK Mobile Number
PMPXKEML  DIM       80     80       243   NOK Email Address
PMPXKCRP  DIM       1      1        323   NOK Correspondence (0=NO,1=YES)
PMPXRMOB  DIM       20     20       324   Nearest Relative Mobile Number
PMPXREML  DIM       80     80       344   Nearest Relative Email Address
PMPXRCRP  DIM       1      1        424   Nearest Relative Corres. 0=NO,1=YES
PMPXMEDC  DIM       8      8        425   Medicare Card Valid to (CCYYMMDD)
PMPXDETY  DIM       3      3        433   Death Type (Cat DY)
PMPXPRIS  DIM       15     15       436   PRISM Number
PMPXCSER  DIM       15     15       451   Correctional Services Number
PMPXPHEI  FORM      6      4        466   Patient Height
PMPXPWEI  FORM      6      4        470   Patient Weight
PMPXDREC  DIM       8      8        474   Date Weight & Height Rec.(CCYYMMDD)
PMPXMSNA  DIM       20     20       482   Mother's Surname
PMPXMGNA  DIM       25     25       502   Mother's Given Name
PMPXMTLE  DIM       4      4        527   Mother's Title
PMPXMAD1  DIM       35     35       531   Mother's Address Line 1
PMPXMAD2  DIM       35     35       566   Mother's Address Line 2
PMPXMAD3  DIM       35     35       601   Mother's Address Line 3
PMPXMAD4  DIM       35     35       636   Mother's Address Line 4
PMPXMPOS  DIM       8      8        671   Mother's Address Post Code
PMPXMPNO  DIM       20     20       679   Mother's Private Number
PMPXMBNO  DIM       20     20       699   Mother's Business Number
PMPXMMNO  DIM       20     20       719   Mother's Mobile Number
PMPXMEML  DIM       80     80       739   Mother's Email Address
PMPXMCNT  DIM       3      3        819   Mother's Country of Birth (Cat C)
PMPXMCRP  DIM       1      1        822   Mother's Correspondence  0=NO,1=YES
PMPXMLAB  DIM       1      1        823   Mother's Name on Labels  0=NO,1=YES
PMPXMREL  DIM       10     10       824   Relationship to Patient
PMPXFSNA  DIM       20     20       834   Father's Surname
PMPXFGNA  DIM       25     25       854   Father's Given Name
PMPXFTLE  DIM       4      4        879   Father's Title
PMPXFAD1  DIM       35     35       883   Father's Address Line 1
PMPXFAD2  DIM       35     35       918   Father's Address Line 2
PMPXFAD3  DIM       35     35       953   Father's Address Line 3
PMPXFAD4  DIM       35     35       988   Father's Address Line 4
PMPXFPOS  DIM       8      8        1023  Father's Address Post Code
PMPXFPNO  DIM       20     20       1031  Father's Private Number
PMPXFBNO  DIM       20     20       1051  Father's Business Number
PMPXFMNO  DIM       20     20       1071  Father's Mobile Number
PMPXFEML  DIM       80     80       1091  Father's Email Address
PMPXFCNT  DIM       3      3        1171  Father's Country of Birth (Cat C)
PMPXFCRP  DIM       1      1        1174  Father's Correspondence 0=NO,1=YES
PMPXFLAB  DIM       1      1        1175  Father's Name on Labels 0=NO,1=YES
PMPXFREL  DIM       10     10       1176  Relationship to Patient
PMPXTDIG  DIM       2      2        1186  Terminal Digit (Last 2 chrs of U/R)
PMPXWBID  DIM       10     10       1188  WEB User Id re. creator (websecaf)
PMPXDVAC  DIM       3      3        1198  DVA Card Colour (Cat DX)
PMPXPNSD  DIM       8      8        1201  Pension Start Date (CCYYMMDD)
PMPXUYN4  DIM       1      1        1209  User Defined Y/N field 4 0=NO,1=YES
PMPXUYN5  DIM       1      1        1210  User Defined Y/N field 5 0=NO,1=YES
PMPXUYN6  DIM       1      1        1211  Not for Resusitation Y/N 0=NO,1=YES
PMPXABRG  DIM       3      3        1212  Aboriginality (Cat VA)
PMPXPRVI  DIM       3      3        1215  Privacy Indicator (Cat PV)
PMPXCRIN  DIM       1      1        1218  Consent Release of Info? 0=NO,1=YES
PMPXHOML  DIM       1      1        1219  Homeless? (0=NO,1=YES)
PMPXUDC1  DIM       50     50       1220  User Defined Comments 1
PMPXUDC2  DIM       50     50       1270  User Defined Comments 2
PMPXUDC3  DIM       50     50       1320  User Defined Comments 3
PMPXUSR7  DIM       3      3        1370  User Defined 7 (Category P7)
PMPXUSR8  DIM       3      3        1373  User Defined 8 (Category P8)
PMPXUSR9  DIM       3      3        1376  User Defined 9 (Category P9)
PMPXMSNO  DIM       10     10       1379  Medicare Safety Net Number
PMPXCONP  DIM       1      1        1389  Which contact for PRA
.                                         0=Patient
.                                         1=Mother (this file)
.                                         2=Father (this file)
.                                         3=Next of Kin (patma1af)
.                                         4=Emergency Contact (patmx1af)
.                                         5=Nearest Relative (patmx1af)
.                                         6=PRA (priinvof)
.                                         7=Postal
PMPXFLDR  DIM       3      3        1390  Folder Selection (Category FS)
PMPXIWI1  DIM       3      3        1393  Iwi 1 (Category iw)
PMPXIWI2  DIM       3      3        1396  Iwi 2 (Category iw)
PMPXIWI3  DIM       3      3        1399  Iwi 3 (Category iw)
PMPXIHOS  DIM       3      3        1402  Hospital which initiated UR
PMPXPFSN  DIM       20     20       1405  Preferred Surname
PMPXPFGN  DIM       25     25       1425  Preferred Given Name
PMPXSIN6  DIM       1      1        1450  Transport Required - 1=Yes
PMPXSIN7  DIM       1      1        1451  Medical Alert (wahealth) - 1=Yes
PMPXSIN8  DIM       1      1        1452  Micro Alert (wahealth) - 1=Yes
PMPXSIN9  DIM       1      1        1453  Risk Alert (wahealth) - 1=Yes
PMPXSN10  DIM       1      1        1454  Status Ind 10 - 1=Yes
PMPXSN11  DIM       1      1        1455  Status Ind 11 - 1=Yes
PMPXSN12  DIM       1      1        1456  Patient Debt Only - 1=Yes
PMPXSN13  DIM       1      1        1457  Set Payment Plan - 1=Yes
PMPXSN14  DIM       1      1        1458  Debt Collection Agency - 1=Yes
PMPXSN15  DIM       1      1        1459  Outstanding Debt Ind. 1=Yes
PMPXPFAX  DIM       20     20       1460  Patient Fax Number
PMPXFNAM  DIM       40     40       1480  Patient First Name
PMPXSNAM  DIM       40     40       1520  Patient Second Name
PMPXHFGN  DIM       40     40       1560  Health Fund First Given Name Alias
PMPXHFSN  DIM       40     40       1600  Health Fund Surname Alias
PMPXFUPI  DIM       2      2        1640  Health Fund UPI
PMPXVGPC  DIM       10     10       1642  Verified GP Code (pmshcpaf)
PMPXVGPP  DIM       10     10       1652  Verified GP Practice (pmshcgaf)
PMPXVGPG  DIM       2      2        1662  Verified GP Group Count (pmshclaf)
PMPXASNO  DIM       15     15       1664  Ambulance Subscriber No.
PMPXMAID  DIM       20     20       1679  Maiden Name
PMPXETHN  DIM       3      3        1699  Ethnicity (Cat EN)
PMPXHFCN  DIM       40     40       1702  Health Fund Contributor Name
PMPXLUBH  DIM       3      3        1742  Last Updated By Hospital (pathspaf)
PMPXSPAR  DIM       60     60       1745  Spare
.
.End of Record                      1805
.
.
. Redefine form fields for key
. ----------------------------
GSRBILL    FORM         8      
.
.
. LOCAL VARIABLES
. ---------------
CMDLINE   DIM       200
.
DEFPATH   DIM       60
DIM60     DIM       60
.
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
.
INPFILE   DIM       8
.
NEWFILE   DIM       60
NEWPATH   DIM       60
.
OLDPATH   DIM       60
.
RECNUM    FORM      8
.
SAVEFLG   FORM      1
SAVEURNO  DIM       8
SVKEY115  DIM       115
SCNDGNAM  DIM       40
.
.
. PROGRAM CONSTANTS
. -----------------
PIPE      INIT      "|"
SP60      INIT    "                                                            "
.
.
.
PRGNAM    INIT      "CONVERSION PATGSRFD"
PRGID     INIT      "F02PTGSR"
VERSION   INIT      "V12.00.00"
+
.*****************************************************************************
.*                             MAIN0000                                      *
.*                         Program Mainline                                  *
.*****************************************************************************
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      OPTN0000                      * get option
          BRANCH    COPTION,MAIN1000:             * run c-isam fixit
                            MAIN2000              * run oracle fixit
          GOTO      MAIN9999                      * exit selected
.
MAIN1000  CALL      KDIR0000                      * Keyin directory
          BRANCH    EXIT,MAIN9999
.
MAIN2000  CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN5000:               * yes
                          MAIN0000:               * no
                          MAIN9999                * cancel
.
MAIN5000  BRANCH    COPTION,MAIN6000:             * c-isam fixit
                            MAIN7000              * oracle fixit
.
.         Running c-isam fix
.
MAIN6000  CALL      PREP0000                      * preparing files
          BRANCH    EXIT,MAIN9999
.
          CALL      READ0000                      * read old records and write
          CALL      ENDP0000                      * save/compress saved file
          GOTO      MAIN9999
.
.         Running oracle fix
.
MAIN7000  CALL      OFIX0000                      * run oracle fix
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
.
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
.
          DISPLAY   *P56:24,"Opening":
                    *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
INIT9999  RETURN
+
.*****************************************************************************
.*                                OPTN0000             Called by: MAIN0000   *
.*                        Get user options or exit                           *
.*    Returns:  EXIT    = FALSE (0)  Ok to proceed                           *
.*                        TRUE  (1)  Exit option selected                    *
.*              COPTION - option selected                                    *
.*****************************************************************************
.
OPTN0000  DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Run Fixit (c-isam only)":
                    *P1:6,*V2LON,TWO,*HOFF,". Run Fixit (Oracle only)"
.
OPTN0500  KEYIN     *P1:8,*EL,"Select Option : ":
                    *P17:8,*V2LON,COPTION
.
          COMPARE   ZERO,COPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    COPTION,OPTN9000:            * run c-isam fixit
                            OPTN9000             * run oracle fixit
.
          BEEP
          GOTO      OPTN0500
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.********************************************************************
.*                          KDIR0000                                *
.*  Keyin directories                                               *
.********************************************************************
.
KDIR0000  MOVE      ONE,SAVEFLG        * Default to keep file
          KEYIN     *P1:10,*EL,"Do you want to save the original file (Y/N) ? ":
                    ANS;
          REP       "yYnN",ANS
          CMATCH    "Y",ANS
          GOTO      KDIR1000 IF EQUAL
          MOVE      ZERO,SAVEFLG       * not to keep file
          CMATCH    "N",ANS
          GOTO      KDIR1000 IF EQUAL
          BEEP
          GOTO      KDIR0000
.
KDIR1000  CALL      DEFT0000                * Get the default path
          BRANCH    EXIT,KDIR9999
          MOVE      SP60,OLDPATH
.
          DISPLAY   *P1:24,*EL,"The directory path must end with a slash (/) ";
.
          MOVE      DEFPATH,OLDPATH
          BRANCH    SAVEFLG,KDIR2000
.
.         Keyin the path for the original file
.
          KEYIN     *P1:12,*EL,"Keyin path for temporarily saving original ":
                    "file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
          GOTO      KDIR3000
.
KDIR2000  KEYIN     *P1:12,*EL,"Keyin path for saving original file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
.
KDIR3000  ENDSET    OLDPATH
          APPEND    SP60,OLDPATH
          RESET     OLDPATH
.
          MATCH     SP60,OLDPATH
          IF        @EQUAL
            PACK      OLDPATH,DEFPATH      * use the default
            DISPLAY   *P10:13,*EL,*V2LON,OLDPATH;
          ENDIF
.
          SQUEEZE   OLDPATH
          CMATCH    EXITCHAR,OLDPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,OLDPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR1000
.
.         Keyin the path for the new file
.
KDIR5000  MOVE      SP60,NEWPATH
          MOVE      DEFPATH,NEWPATH
          KEYIN     *P1:15,*EL,"Keyin path for the new file: ":
                    *P10:16,*EL,*DV,*RV,NEWPATH:
                    *P10:16,NEWPATH;
          ENDSET    NEWPATH
          APPEND    SP60,NEWPATH
          RESET     NEWPATH
.
          MATCH     SP60,NEWPATH
          IF        @EQUAL
            PACK      NEWPATH,DEFPATH      * use the default
            DISPLAY   *P10:16,*V2LON,NEWPATH;
          ENDIF
.
          SQUEEZE   NEWPATH
          CMATCH    EXITCHAR,NEWPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,NEWPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR5000
          GOTO      KDIR9999
.
KDIR9000  MOVE      ONE,EXIT
.
KDIR9999  DISPLAY   *P1:24,*EL;
          RETURN
+
.********************************************************************
.*                          PREP0000                                *
.*  Preparing files                                                 *
.********************************************************************
.
PREP0000  MOVE      "patgsrnf",INPFILE
          CALL      CHEK0000             * check file exists or has been changed
          BRANCH    EXIT,PREP9000
.
          CLOSE     OLDFILE1
          DISPLAY   *P1:24,*EL,"Copying files ... Please wait !! ";
.
.         Copy old file to the keyin directory
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat patgsrnf.dat` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "sptgsrnf.dat",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat patgsrnf.idx` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "sptgsrnf.idx",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
.         Remove the original files
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    DEFPATH,CMDLINE
          APPEND    "patgsrnf",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Unable to remove the original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
.         Opening old file after being copied
.
          MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60
          APPEND    "sptgsrnf",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE1,DIM60
          TRAPCLR   IO
          IF        OVRCD = 1
            DISPLAY   *P1:24,*EL,*B,"Unable to open saved original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
.         Create the new file
.
          DISPLAY   *P1:24,*EL,"Creating new files ... Please wait !! ";
          PACK      NEWFILE,SP60
          CLEAR     NEWFILE
          APPEND    NEWPATH,NEWFILE
          APPEND    "patgsrnf",NEWFILE
          APPEND    SP60,NEWFILE
          RESET     NEWFILE
          SQUEEZE   NEWFILE
.
PREP1000  PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND   " 194 UC1-8,9-16,17-46,47-76,114-143,105-112,113-113",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 2
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D17-46,47-76,114-143,105-112",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 3
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D77-86,87-94,95-102,105-112",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 4
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D77-86,95-102,87-94,105-112",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 5
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D77-86,17-46,47-76,114-143",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 6
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D105-112,17-46,47-76,114-143",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 7
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D105-112,77-86,17-46,47-76,114-143",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          PACK      CMDLINE,SP60,SP60            * index 8
          CLEAR     CMDLINE
          APPEND    "isadd ",CMDLINE
          APPEND    NEWFILE,CMDLINE
          APPEND    " D77-86,47-76,114-143,105-112,17-46",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      PATGSRN1,NEWFILE
.
.         Set the flag to say we want to continue
.
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,"Record : "
          GOTO      PREP9999
.
PREP5000  DISPLAY   *P1:24,*EL,*B,"Old file not found.  ";
          CALL      HITENTER
          GOTO      PREP9000
.
PREP8000  DISPLAY   *P1:24,*EL,*B,"Unable to copy original file.  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
.
PREP9000  MOVE      ONE,EXIT
.
PREP9999  RETURN
+
.********************************************************************
.*                          CHEK0000                                *
.*  Check if file exists, or has already been converted             *
.********************************************************************
.
CHEK0000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND GIVING DIM60 IF IO
          OPEN      OLDFILE1,INPFILE
          TRAPCLR   IO
          BRANCH    OVRCD,CHEK2000       * Original file does not exist
          CLOSE     OLDFILE1
          GOTO      CHEK9999
.
CHEK2000  RESET     DIM60
          SCAN      "I * I",DIM60
          DISPLAY   *P1:23,*EF,"File '",INPFILE,"' ";
          IF        @EQUAL
            DISPLAY   "does not exist - ";
          ELSE
            RESET     DIM60
            SCAN      "I * L",DIM60
            IF        @EQUAL
              DISPLAY   "has already been converted - ";
            ELSE
              DISPLAY   "has caused an IO error - ";
            ENDIF
          ENDIF
          DISPLAY   "File will be bypassed"
.
          CALL      HITENTER
          DISPLAY   *P1:23,*EF;
.
CHEK9000  MOVE      ONE,EXIT
.
CHEK9999  RETURN
+
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
.
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ":
                    *P1:24,*EL,"Processing, please wait....";
.
          MOVE      SP8,SAVEURNO                  * initialise saved U/R
.
          MOVE      SP70,KEY70
          CALL      READSOLD                      * position at start
READ1000  CALL      READKOLD                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
.
          ADD       ONE,RECNUM                    * update record counter
.
.         IF        (RECNUM%1000) = 0 | RECNUM = 1
.           DISPLAY   *P15:20,*V2LON,RECNUM
.         ENDIF
.
          MATCH     SAVEURNO,GSRURNO             * same U/R still ?
          GOTO      READ1500 IF EQUAL            * yes
.
          MOVE      GSRURNO,KEY8
          CALL      RDMAST1                      * U/R on file ?
          BRANCH    OVRCD,READ1000               * no - ignore record
.
          MOVE      GSRURNO,SAVEURNO             * save new U/R number
.
          MOVE      GSRURNO,KEY8
          CALL      RDPMPX21                     * U/R on file ?
          IF        OVRCD = 1
            CALL      CLPMSPX2
            PACK      FULLGNAM,PGNAME,SP70,SP70
            CALL      SEPRNAME                   * separate given names
            PACK      PMPXFNAM,FRSTGNAM,SP70     * load first given name
            PACK      PMPXSNAM,SCNDGNAM,SP70     * load second given name
            MOVE      PURNO,PMPXURNO
            CALL      WRPMPX21                   * write pmspx2af record
          ENDIF
.
.         Check to see if this is the current patient record
.
READ1500  MATCH     PSNAME,OLDSNAM               * same surname ?
          GOTO      READ2000 IF NOT EQUAL        * no
.
          MATCH     PGNAME,OLDGNAM               * same given names ?
          GOTO      READ2000 IF NOT EQUAL        * no
.
          MATCH     PBDATE,GSRDOB                * same dob ?
          GOTO      READ2000 IF NOT EQUAL        * no
.
          MATCH     PSEX,GSRSEX                  * same sex ?
          GOTO      READ2000 IF NOT EQUAL        * no
.
.         This is the current record for this patient, so use the
.         first and second given name fields from the pmi to make
.         sure that we have an exact match in patgsrnf.
.
          MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          GOTO      READ3000
.
.         Load changed and new fields
.
READ2000  PACK      GSRSNAM,OLDSNAM,SP70         * load surname
          PACK      FULLGNAM,OLDGNAM,SP70,SP70
          CALL      SEPRNAME                     * separate given names
          PACK      GSRGNAM,FRSTGNAM,SP70        * load first given name
          PACK      PTGSGNM2,SCNDGNAM,SP70       * load second given name
READ3000  MOVE      SP70,GSRSPARE
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1
          IF        OVRCD = 1
            CALL      WRPTGSR1                   * write to new file
          ENDIF
.
          GOTO      READ1000                     * get next record
.
READ6000  CLOSE     PATGSRN1                     * close new file
          CLOSE     OLDFILE1                     * close old file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
.
READ9999  RETURN
+
.**********************************************************************
.*                               VALD0000                             *
.*        Check if it a valid directory                               *
.**********************************************************************
.
VALD0000  MOVE      ZERO,EXIT
.
          SQUEEZE   DIM60
          ENDSET    DIM60
          CMATCH    SLASH,DIM60
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory path must end with a slash (/) ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          RESET     DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cd ",CMDLINE
          APPEND    DIM60,CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory does not exist ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          GOTO      VALD9999
.
VALD9000  MOVE      ONE,EXIT            * Not valid
.
VALD9999  RETURN
+
.**********************************************************************
.*                               ENDP0000                             *
.*        Remove or compress save file                                *
.**********************************************************************
.
ENDP0000  MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60        * set up the saved file with path
          APPEND    "sptgsrnf*",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
          SQUEEZE   DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          IF        SAVEFLG = 1
            APPEND    "compress -f ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Compressing original file.. ":
                      "Please wait !!  ";
          ELSE
            APPEND    "rm ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Removing original file.. Please wait !!  ";
          ENDIF
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Saved file not compressed or removed.  ";
            CALL      HITENTER
            GOTO      ENDP9999
          ENDIF
.
          CALL      IBACLOCK
          DISPLAY   *P1:24,*EL,*B,"Finish processing.  ";
          CALL      HITENTER
.
ENDP9999  RETURN
+
.**********************************************************************
.*        DEFT0000 - Get the default directory                        *
.**********************************************************************
.
DEFT0000  EXECUTE   "ldat patgsrnf.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding 'patgsrnf'.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
.
DEFT9999  RETURN
+
.*****************************************************************************
.*                            OFIX0000                                       *
.*            Oracle fix to loop through the new patgsrnf table and          *
.*            separate out the given name into first and second given name   *
.*            fields.                                                        *
.*****************************************************************************
.
OFIX0000  DISPLAY   *P1:20,*EL,"Record No. :":
                    *P1:24,*EL,"Processing, please wait....";
.
          MOVE      ZERO,CPAGENO                  * initialise print variables
          MOVE      ZERO,CNOUNDLN
          CALL      IBACLOCK
.
          CALL      HEAD0000
.
          MOVE      SP8,SAVEURNO                  * initialise saved U/R
          OPEN      PATGSRN1,"patgsrnf"
.         
          PACK      KEY115,SP70,SP70
OFIX0500  CALL      RSPTGSR1                      * position at start of file
OFIX1000  CALL      RKPTGSR1                      * read next record
          BRANCH    OVRCD,OFIX9000                * eof - finished
.
          ADD       ONE,RECNUM                    * increment record counter
          PACK      SVKEY115,GSRURNO,DGSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
.
.         IF        (RECNUM%1000) = 0 | RECNUM = 1
.           DISPLAY   *P15:20,*V2LON,RECNUM 
.         ENDIF
.
          MATCH     SAVEURNO,GSRURNO             * same U/R still ?
          GOTO      OFIX1500 IF EQUAL            * yes
.
          MOVE      GSRURNO,KEY8
          CALL      RDMAST1                      * U/R on file ?
          IF        OVRCD = 1
            MOVE      SVKEY115,KEY115
            CALL      DEPTGSR1
            GOTO      OFIX0500
          ENDIF
.
          MOVE      GSRURNO,SAVEURNO             * save new U/R number
.
          MOVE      GSRURNO,KEY8
          CALL      RDPMPX21                     * U/R on file ?
          IF        OVRCD = 1
            CALL      CLPMSPX2
            PACK      FULLGNAM,PGNAME,SP70,SP70
            CALL      SEPRNAME                   * separate given names
            PACK      PMPXFNAM,FRSTGNAM,SP70     * load first given name
            PACK      PMPXSNAM,SCNDGNAM,SP70     * load second given name
            MOVE      PURNO,PMPXURNO
            CALL      WRPMPX21                   * write pmspx2af record
          ENDIF
.
.         Check to see if this is the current patient record
.
OFIX1500  MATCH     PSNAME,GSRSNAM               * same surname ?
          GOTO      OFIX2000 IF NOT EQUAL        * no
.
          MATCH     PGNAME,GSRGNAM               * same given names ?
          GOTO      OFIX2000 IF NOT EQUAL        * no
.         
          MATCH     PBDATE,GSRDOB                * same dob ?
          GOTO      OFIX2000 IF NOT EQUAL        * no
.         
          MATCH     PSEX,GSRSEX                  * same sex ?
          GOTO      OFIX2000 IF NOT EQUAL        * no
.         
.         This is the current record for this patient, so use the
.         first and second given name fields from the pmi to make
.         sure that we have an exact match in patgsrnf.
.         
          MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          GOTO      OFIX3000
.         
.         Load changed and new fields
.         
OFIX2000  PACK      FULLGNAM,GSRGNAM,SP70,SP70   
          CALL      SEPRNAME                     * separate given names
          PACK      GSRGNAM,FRSTGNAM,SP70        * load first given name
          PACK      PTGSGNM2,SCNDGNAM,SP70       * load second given name
OFIX3000  MOVE      SP70,GSRSPARE
.
.         When updating the record, we need to make sure that it doesn't
.         already exist.  For example, there may be two patgsrnf records for
.         a U/R where the only difference is that one record has a single
.         space between the first and second given name, while the other
.         record has two spaces.  This will result in two records being
.         identical.
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND GIVING DIM60 IF IO
          CALL      UPPTGSR1
          TRAPCLR   IO
          COMPARE   ZERO,OVRCD                   * IO Error ?
          GOTO      OFIX8000 IF EQUAL            * no - get next record
.
          RESET     DIM60
          SCAN      "I * U",DIM60                * duplicate record ?
          IF        @EQUAL
            MOVE      SVKEY115,KEY115            * yes - delete
            CALL      DEPTGSR1
          ELSE
            CALL      PRIN0000                   * no - print error
          ENDIF
.         
OFIX8000  MOVE      SVKEY115,KEY115              * re-position for next record
          GOTO      OFIX0500
.
OFIX9000  CLOSE     PATGSRN1
          DISPLAY   *P15:20,*V2LON,RECNUM,*HOFF:
                    *P1:24,*EL,"Update completed.  ";
          CALL      HITENTER
          PRINT     *N,*1,"*** End of Report ***"
.
OFIX9999  RETURN
+
.*****************************************************************************
.*                                CLPMSPX2                                   *
.*                 Clear routine for pmspx2af variables                      *
.*****************************************************************************
.         
CLPMSPX2  MOVE      SP70,PMPXURNO
          MOVE      SP70,PMPXRHC1
          MOVE      SP70,PMPXRH1G
          MOVE      SP70,PMPXR1GC
          MOVE      SP70,PMPXINTR
          MOVE      SP70,PMPXLNG1
          MOVE      SP70,PMPXLNG2
          MOVE      SP70,PMPXLNG3
          PACK      PMPXPEML,SP70,SP70
          MOVE      ZERO,PMPXEDOB
          MOVE      SP70,PMPXCMOB
          PACK      PMPXCEML,SP70,SP70
          MOVE      ZERO,PMPXCCRP
          MOVE      SP70,PMPXKMOB
          PACK      PMPXKEML,SP70,SP70
          MOVE      ZERO,PMPXKCRP
          MOVE      SP70,PMPXRMOB
          PACK      PMPXREML,SP70,SP70
          MOVE      ZERO,PMPXRCRP
          MOVE      SP70,PMPXMEDC
          MOVE      SP70,PMPXDETY
          MOVE      SP70,PMPXPRIS
          MOVE      SP70,PMPXCSER
          MOVE      ZERO,PMPXPHEI
          MOVE      ZERO,PMPXPWEI
          MOVE      SP70,PMPXDREC
          MOVE      SP70,PMPXMSNA
          MOVE      SP70,PMPXMGNA
          MOVE      SP70,PMPXMTLE
          MOVE      SP70,PMPXMAD1
          MOVE      SP70,PMPXMAD2
          MOVE      SP70,PMPXMAD3
          MOVE      SP70,PMPXMAD4
          MOVE      SP70,PMPXMPOS
          MOVE      SP70,PMPXMPNO
          MOVE      SP70,PMPXMBNO
          MOVE      SP70,PMPXMMNO
          PACK      PMPXMEML,SP70,SP70
          MOVE      SP70,PMPXMCNT
          MOVE      ZERO,PMPXMCRP
          MOVE      ZERO,PMPXMLAB
          MOVE      SP70,PMPXMREL
          MOVE      SP70,PMPXFSNA
          MOVE      SP70,PMPXFGNA
          MOVE      SP70,PMPXFTLE
          MOVE      SP70,PMPXFAD1
          MOVE      SP70,PMPXFAD2
          MOVE      SP70,PMPXFAD3
          MOVE      SP70,PMPXFAD4
          MOVE      SP70,PMPXFPOS
          MOVE      SP70,PMPXFPNO
          MOVE      SP70,PMPXFBNO
          MOVE      SP70,PMPXFMNO
          PACK      PMPXFEML,SP70,SP70
          MOVE      SP70,PMPXFCNT
          MOVE      ZERO,PMPXFCRP
          MOVE      ZERO,PMPXFLAB
          MOVE      SP70,PMPXFREL
          MOVE      SP70,PMPXTDIG
          MOVE      SP70,PMPXWBID
          MOVE      SP70,PMPXDVAC
          MOVE      SP70,PMPXPNSD
          MOVE      ZERO,PMPXUYN4
          MOVE      ZERO,PMPXUYN5
          MOVE      ZERO,PMPXUYN6
          MOVE      SP70,PMPXABRG
          MOVE      SP70,PMPXPRVI
          MOVE      ZERO,PMPXCRIN
          MOVE      ZERO,PMPXHOML
          MOVE      SP70,PMPXUDC1
          MOVE      SP70,PMPXUDC2
          MOVE      SP70,PMPXUDC3
          MOVE      SP70,PMPXUSR7
          MOVE      SP70,PMPXUSR8
          MOVE      SP70,PMPXUSR9
          MOVE      SP70,PMPXMSNO
          MOVE      SP70,PMPXCONP
          MOVE      SP70,PMPXFLDR
          MOVE      SP70,PMPXIWI1
          MOVE      SP70,PMPXIWI2
          MOVE      SP70,PMPXIWI3
          MOVE      SP70,PMPXIHOS
          MOVE      SP70,PMPXPFSN
          MOVE      SP70,PMPXPFGN
          MOVE      SP70,PMPXSIN6
          MOVE      SP70,PMPXSIN7
          MOVE      SP70,PMPXSIN8
          MOVE      SP70,PMPXSIN9
          MOVE      SP70,PMPXSN10
          MOVE      SP70,PMPXSN11
          MOVE      SP70,PMPXSN12
          MOVE      SP70,PMPXSN13
          MOVE      SP70,PMPXSN14
          MOVE      SP70,PMPXSN15
          MOVE      SP70,PMPXPFAX
          MOVE      SP70,PMPXSPAR
          MOVE      SP70,PMPXFNAM
          MOVE      SP70,PMPXSNAM
          MOVE      SP70,PMPXHFGN
          MOVE      SP70,PMPXHFSN
          MOVE      SP70,PMPXFUPI
          MOVE      SP70,PMPXVGPC
          MOVE      SP70,PMPXVGPP
          MOVE      SP70,PMPXVGPG
          MOVE      SP70,PMPXASNO
          MOVE      SP70,PMPXMAID
          MOVE      SP70,PMPXETHN
          MOVE      SP70,PMPXHFCN
          MOVE      SP70,PMPXLUBH
.
          RETURN
+
.****************************************************************************
.*                            PRIN0000                 Called by: OFIX0000  *
.*                  Valid record so print it                                *
.****************************************************************************
.
PRIN0000  COMPARE   FIFTY5,CLNO                  * page full ?
          CALL      HEAD0000 IF NOT LESS         * yes
.
          PRINT     *1,PIPE,*3,SVKEY115,*132,PIPE,*N:
                    *1,PIPE,*3,DIM60,*132,PIPE
.
          CALL      LINE0000
          ADD       TWO,CLNO                     * increment line count
.
PRIN9999  RETURN
+
.****************************************************************************
.*                            HEAD0000                 Called by: OFIX0000  *
.*                       Print page heading                       PRIN0000  *
.****************************************************************************
.
HEAD0000  CALL      HEAD132                      * display page header
.
          PRINT     *40,"Unprocessed Records ",*N
.
          CALL      LINE0000                     * draw line across page
.
          PRINT     *1,PIPE,*3,"Record Key - U/R, Billing No., Surname, ":
                    "First Given Name, Second Given Name, DOB, Gender":
                    *132,PIPE,*N:
                    *1,PIPE,*3,"Error Message",*132,PIPE
.
          CALL      LINE0000                     * draw line across page
.
          MOVE      NINE,CLNO                    * increment line count
.
HEAD9999  RETURN
+
.****************************************************************************
.*                            LINE0000                 Called by: OFIX0000  *
.*                      Draw line across page                     HEAD0000  *
.****************************************************************************
.
LINE0000  PRINT     "*-----------------------------------------------":
                    "------------------------------------------------":
                    "-----------------------------------*"
.
LINE9999  RETURN
+
.*****************************************************************************
.*        I/O Routines                                                       *
.*****************************************************************************
.
.         Old I/O Routines
.
READSOLD  RESET     KEY70
          READ      OLDFILE1,KEY70;;
          RETURN
.
READKOLD  MOVE      ZERO,OVRCD
          READKS    OLDFILE1;GSRURNO,DGSRBILL,OLDSNAM,OLDGNAM,GSRSKEY:
                             GSRGKEY1,GSRGKEY2,GSRSYS,GSRDOB,GSRSEX,OLDSPARE
          GOTO      OVERCOND IF OVER
          MOVE      DGSRBILL,GSRBILL
          RETURN
.
.         New I/O Routines
.
RAPTGSR1  MOVE      ZERO,OVRCD
          RESET     KEY115
          READ      PATGSRN1,KEY115;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSPTGSR1  RESET     KEY115
          READ      PATGSRN1,KEY115;;
          RETURN
.
RKPTGSR1  MOVE      ZERO,OVRCD
          READKS    PATGSRN1;GSRURNO,DGSRBILL,GSRSNAM,GSRGNAM,GSRSKEY,GSRGKEY1:
                             GSRGKEY2,GSRSYS,GSRDOB,GSRSEX,PTGSGNM2,GSRSPARE
          GOTO      OVERCOND IF OVER
          MOVE      DGSRBILL,GSRBILL
          RETURN
.
WRPTGSR1  MOVE      GSRBILL,DGSRBILL
          WRITE     PATGSRN1,KEY115;GSRURNO,DGSRBILL,GSRSNAM,GSRGNAM,GSRSKEY:
                                    GSRGKEY1,GSRGKEY2,GSRSYS,GSRDOB,GSRSEX:
                                    PTGSGNM2,GSRSPARE
          RETURN
.
UPPTGSR1  MOVE      GSRBILL,DGSRBILL
          UPDATE    PATGSRN1;GSRURNO,DGSRBILL,GSRSNAM,GSRGNAM,GSRSKEY,GSRGKEY1:
                             GSRGKEY2,GSRSYS,GSRDOB,GSRSEX,PTGSGNM2,GSRSPARE
          RETURN
.
DEPTGSR1  DELETE    PATGSRN1,KEY115
          RETURN
.
.         Other I/O's
.                                 
RDMAST1   MOVE      ZERO,OVRCD    
          RESET     KEY8          
          READ      PATMA1A1,KEY8;PURNO,PPORT,PCHGDTE,PTITL,PHOSP:
                                  PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                  PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                  PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                  PSAGE,PCONT,PREG,PTYPE:
                                  POCCUP,PLDDATE,PMEDI,PPENNO,PPNDTE:
                                  PREPAT,PSMOK,PSTAT,PMICRO,PCEASE:
                                  PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                                  PLOCDOC,PFUNDH,PFNDTB,PTMASPAR,PUSR1:
                                  PUSR2,PUSR3,PUSR4,PUSR5,PUSR6:
                                  PUYN1,PUYN2,PUYN3,PYRRES,PNKNAME:
                                  PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                                  PNKTELP,PNKTELB,PNKRELP,PLSTINP,PLSTOUT:
                                  PNXRAY,PFNDYY,PFNDCG,PDECDTE,PHCNOTES:
                                  PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                                  PTMANOKE,PTMADCNO,PTMAUKDB,PTMAUKDD:
                                  PFNDMM,PTMADCDT,PTMAHCP1,PTMAHCL1,PTMAHCG1:
                                  PTMAHCP2,PTMAHCL2,PTMAHCG2,PTMAHCP3,PTMAHCL3:
                                  PTMAHCG3,PTMAHCP4,PTMAHCL4,PTMAHCG4,PTMAHCP5:
                                  PTMAHCL5,PTMAHCG5,PTMASNAM,PTMADCUD,PTMADCUT:
                                  PTMADCUU,PTMASPA2
          GOTO      OVERCOND IF OVER
.
.         Read the Extension File
.
          CALL      RDPTMSX1
          GOTO      OVERCOND IF OVER
          RETURN
.
RDPTMSX1  READ      PATMX1A1,KEY8;PURNO,PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS:
                             PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3:
                             PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4:
                             PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                             PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                             PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE:
                             PTMX3BEX,PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY:
                             PTMXCHNM,PTMXDOFR,PTMXREGP,PTMXGPPC,PTMXSPID:
                             PTMXGPPT,PTMXOSDT,PTMXOPER,PTMXUKDO,PTMXCELL:
                             PTMXADD1,PTMXADD2,PTMXADD3,PTMXADD4,PTMXPOST:
                             PTMXMCCD,PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                             PTMXSIN5,PTMXCTIM,PTMXSLAC,PTMXFILN,PTMXDEAF:
                             PTMXSPAR
          RETURN
.
RDPMPX21  RESET     KEY8
          MOVE      ZERO,OVRCD
          READ      PMSPX2A1,KEY8;PMPXURNO,PMPXRHC1,PMPXRH1G,PMPXR1GC,PMPXINTR:
                        PMPXLNG1,PMPXLNG2,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                        PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP,PMPXRMOB:
                        PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER:
                        PMPXPHEI,PMPXPWEI,PMPXDREC,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                        PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO:
                        PMPXMBNO,PMPXMMNO,PMPXMEML,PMPXMCNT,PMPXMCRP,PMPXMLAB:
                        PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1,PMPXFAD2:
                        PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO:
                        PMPXFEML,PMPXFCNT,PMPXFCRP,PMPXFLAB,PMPXFREL,PMPXTDIG:
                        PMPXWBID,PMPXDVAC,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                        PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1,PMPXUDC2:
                        PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9,PMPXMSNO,PMPXCONP:
                        PMPXFLDR,PMPXIWI1,PMPXIWI2,PMPXIWI3,PMPXIHOS,PMPXPFSN:
                        PMPXPFGN,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:
                        PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,PMPXPFAX:
                        PMPXFNAM,PMPXSNAM,PMPXHFGN,PMPXHFSN,PMPXFUPI,PMPXVGPC:
                        PMPXVGPP,PMPXVGPG,PMPXASNO,PMPXMAID,PMPXETHN,PMPXHFCN:
                        PMPXLUBH,PMPXSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRPMPX21  RESET     KEY8                                                      
          WRITE     PMSPX2A1,KEY8;PMPXURNO,PMPXRHC1,PMPXRH1G,PMPXR1GC,PMPXINTR:
                        PMPXLNG1,PMPXLNG2,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                        PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP,PMPXRMOB:
                        PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER:
                        PMPXPHEI,PMPXPWEI,PMPXDREC,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                        PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO:
                        PMPXMBNO,PMPXMMNO,PMPXMEML,PMPXMCNT,PMPXMCRP,PMPXMLAB:
                        PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1,PMPXFAD2:
                        PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO:
                        PMPXFEML,PMPXFCNT,PMPXFCRP,PMPXFLAB,PMPXFREL,PMPXTDIG:
                        PMPXWBID,PMPXDVAC,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                        PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1,PMPXUDC2:
                        PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9,PMPXMSNO,PMPXCONP:
                        PMPXFLDR,PMPXIWI1,PMPXIWI2,PMPXIWI3,PMPXIHOS,PMPXPFSN:
                        PMPXPFGN,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:
                        PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,PMPXPFAX:
                        PMPXFNAM,PMPXSNAM,PMPXHFGN,PMPXHFSN,PMPXFUPI,PMPXVGPC:
                        PMPXVGPP,PMPXVGPG,PMPXASNO,PMPXMAID,PMPXETHN,PMPXHFCN:
                        PMPXLUBH,PMPXSPAR
          RETURN
+
          INC       STD001IO
.
          INC       SEPRNAME
