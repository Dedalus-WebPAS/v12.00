.*****************************************************************************
.*    Program      : F01PTMA1                                                *
.*    Description  : Conversion patma1af to new File layout                  *
.*                                                                           *
.*    Author       : Jill Parkinson                                          *
.*    Date         : 23.11.2010                                              *
.*    Modifications:                                                         *
.*        V10.01.01  13.01.2011 Jill Parkinson CAR 236279                    *
.*                   Added PTMASNAM                                          *
.*        V10.01.00  23.11.2010 Jill Parkinson CAR 233088                    *
.*                   Created program                                         *
.*****************************************************************************
.
.
          INC       STD001FD
.
FINDFILE  FILE      ASCII, FIXED=256
.
. Enter the first or the shortest index from the original FD and rename
. the index OLDFILE1
OLDFILE1   IFILE SQL, FIXED=808, KEY="U1-8"
.
.PURNO      DIM      8         8          1      PATIENT U.R NO.
.PPORT      DIM      2         2          9      PORT CURRENTLY UPDATING U/R
.PCHGDTE    DIM      8         8         11      date of last change  (ccyymmdd)
.PTITL      DIM      4         4         19      PATIENT TITLE
.PHOSP      FORM     1         2         23      HOSPITAL LAST 12 MONTHS
.PLDAYS     FORM     3         3         25      NO DAYS LAST IN HOSPITAL
.PBDEBT     FORM     1         2         28      BAD DEBTOR INDICATOR 0-NO 1-YES
.PSNAME     DIM     20        20         30      PATIENT SURNAME
.PGNAME     DIM     25        25         50      PATIENTS GIVEN NAMES
.PPSNAME    DIM     19        19         75      PATIENTS PREVIOUS SURNAME
.PADD1      DIM     35        35         94      PATIENT ADDRESS LINE 1
.PADD2      DIM     35        35        129      PATIENT ADDRESS LINE 2
.PSUBRB     DIM     35        35        164      PATIENT ADDRESS LINE 3
.PADD4      DIM     35        35        199      PATIENT ADDRESS LINE 4
.PPOST      DIM      8         8        234      PATIENT POSTCODE
.PTELEP     DIM     20        20        242      TELEPHONE PRIVATE
.PTELEB     DIM     20        20        262      TELEPHONE BUSINESS
.PSEX       DIM      1         1        282      PATIENTS SEX
.PMSTAT     DIM      3         3        283      PATIENTS MARTIAL STATUS (Cat M)
.PBDATE     DIM      8         8        286      date of birth        (ccyymmdd)
.PSAGE      FORM     3         3        294      PATIENTS AGE
.PCONT      DIM      3         3        297      COUNTRY OF BIRTH (Cat C)
.PREG       DIM      3         3        300      PATIENTS RELIGION (Cat R)
.PTYPE      DIM      3         3        303      PATIENTS TYPE (Cat T)
.POCCUP     DIM     14        14        306      PATIENTS OCCUPATION
.PLDDATE    DIM      8         8        320      last discharge date (ccyymmdd)
.PMEDI      DIM     10        10        328      MEDICARE NUMBER
.PPENNO     DIM     15        15        338      PENSION NUMBER
.PPNDTE     DIM      6         6        353      pension no expiry date (ccyymm)
.PREPAT     DIM     10        10        359      REPATRIATION NUMBER
.PSMOK     FORM      1         2        369      PATIENT SMOKER
.PSTAT      FORM     1         2        371      PATIENT STATUS
.PMICRO     DIM     20        20        373      MICROFILM ADDRESS
.PCEASE     FORM     1         2        393      DECEASED INDICATOR
.PCASE      FORM     1         2        395      CASE NOTES INDICATOR
.PAUTOPY    FORM     1         2        397      AUTOPSY INDICATOR
.PHIGH1     DIM      3         3        399      HIGHLIGHT CODE 1 (Cat H1)
.PHIGH2     DIM      3         3        402      HIGHLIGHT CODE 2 (Cat H2)
.PHIGH3     DIM      3         3        405      HIGHLIGHT CODE 3 (Cat H3)
.PLOCDOC    DIM     30        30        408      LOCAL DOCTOR
.PFUNDH     DIM      6         6        438      HEALTH FUND
.PFNDTB     DIM      8         8        444      HEALTH FUND TABLE
OLDFNDMM    DIM     10        10        452      FUND MEMBERSHIP NUMBER
.PUSR1      DIM      3         3        462      USER DEFINED FIELD 1 (Cat P1)
.PUSR2      DIM      3         3        465      USER DEFINED FIELD 2 (Cat P2)
.PUSR3      DIM      3         3        468      USER DEFINED FIELD 3 (Cat P3)
.PUSR4      DIM      3         3        471      USER DEFINED FIELD 4 (Cat P4)
.PUSR5      DIM      3         3        474      USER DEFINED FIELD 5 (Cat P5)
.PUSR6      DIM      3         3        477      USER DEFINED FIELD 6 (Cat P6)
.PUYN1      FORM     1         2        480      USER DEFINED Y/N FIELD 1
.PUYN2      FORM     1         2        482      USER DEFINED Y/N FIELD 2
.PUYN3      FORM     1         2        484      USER DEFINED Y/N FIELD 3
.PYRRES     FORM     2         2        486      NUMBER OF YEARS RESIDENT
.PNKNAME    DIM     20        20        488      NEXT OF KIN 1 NAME
.PNKADD1    DIM     35        35        508      N.O.K 1 ADDRESS LINE 1
.PNKADD2    DIM     35        35        543      N.O.K 1 ADDRESS LINE 2
.PNKSUBR    DIM     35        35        578      N.O.K 1 ADDRESS LINE 3
.PNKADD4    DIM     35        35        613      N.O.K 1 ADDRESS LINE 4
.PNKPOST    DIM      8         8        648      N.O.K 1 POSTCODE
.PNKTELP    DIM     20        20        656      N.O.K 1 PRIVATE TELEPHONE
.PNKTELB    DIM     20        20        676      N.O.K 1 BUSINESS TELEPHONE
.PNKRELP    DIM     10        10        696      N.O.K 1 RELATIONSHIP
.PLSTINP    FORM     8         5        706      LAST INPATIENT  VISIT NUMBER
.PLSTOUT    FORM     8         5        711      LAST OUTPATIENT VISIT NUMBER
.PNXRAY     FORM     3         3        716      NUMBER OF PREVIOUS X-RAYS
.PFNDYY     DIM      2         2        719      YRS OF FUND MEMBERSHIP (JR,DE)
.PFNDCG     DIM      6         6        721      fund cover change  (ccyymm)
.PDECDTE    DIM      8         8        727      date of death  (ccyymmdd)
.PHCNOTES   DIM     20        20        735      CASE NOTES INDICATORS
.PDIET      DIM      3         3        755      DEFAULT DIET CODE (Cat DC)
.PINITHOS   DIM      2         2        758      HOSPITAL U/R INITIATED FROM
.PHKADUNI   DIM     10        10        760      HONG KONG UNIQUE ADDRESS ID
.PTMAEMPC   DIM      6         6        770      PATIENT EMPLOYER CODE
.PTMANOKO   DIM     14        14        776      NEXT OF KIN OCCUPATION
.PTMANOKE   DIM      6         6        790      NEXT OF KIN EMPLOYER CODE
.PTMADCNO   DIM     10        10        796      DEATH CERTIFICATE NUMBER
.PTMAUKDB   DIM      1         1        806      Unknown Date of Birth (Y/N)
.PTMAUKDD   DIM      1         1        807      Unknown Date of Death (Y/N)
.
PATMA1A1   IFILE SQL, FIXED=1045, KEY="U1-8"
PATMA1A2   IFILE SQL, FIXED=1045, KEY="D286-293"
PATMA1A3   IFILE SQL, FIXED=1045, KEY="U328-337,1-8"
PATMA1A4   IFILE SQL, FIXED=1045, KEY="U75-93,1-8"
.
PURNO      DIM      8         8          1      PATIENT U.R NO.
PPORT      DIM      2         2          9      PORT CURRENTLY UPDATING U/R
PCHGDTE    DIM      8         8         11      date of last change  (ccyymmdd)
PTITL      DIM      4         4         19      PATIENT TITLE
PHOSP      FORM     1         2         23      HOSPITAL LAST 12 MONTHS
PLDAYS     FORM     3         3         25      NO DAYS LAST IN HOSPITAL
PBDEBT     FORM     1         2         28      BAD DEBTOR INDICATOR 0-NO 1-YES
PSNAME     DIM     20        20         30      PATIENT SURNAME
PGNAME     DIM     25        25         50      PATIENTS GIVEN NAMES
PPSNAME    DIM     19        19         75      PATIENTS PREVIOUS SURNAME
PADD1      DIM     35        35         94      PATIENT ADDRESS LINE 1
PADD2      DIM     35        35        129      PATIENT ADDRESS LINE 2
PSUBRB     DIM     35        35        164      PATIENT ADDRESS LINE 3
PADD4      DIM     35        35        199      PATIENT ADDRESS LINE 4
PPOST      DIM      8         8        234      PATIENT POSTCODE
PTELEP     DIM     20        20        242      TELEPHONE PRIVATE
PTELEB     DIM     20        20        262      TELEPHONE BUSINESS
PSEX       DIM      1         1        282      PATIENTS SEX
PMSTAT     DIM      3         3        283      PATIENTS MARTIAL STATUS (Cat M)
PBDATE     DIM      8         8        286      date of birth        (ccyymmdd)
PSAGE      FORM     3         3        294      PATIENTS AGE
PCONT      DIM      3         3        297      COUNTRY OF BIRTH (Cat C)
PREG       DIM      3         3        300      PATIENTS RELIGION (Cat R)
PTYPE      DIM      3         3        303      PATIENTS TYPE (Cat T)
POCCUP     DIM     14        14        306      PATIENTS OCCUPATION
PLDDATE    DIM      8         8        320      last discharge date (ccyymmdd)
PMEDI      DIM     10        10        328      MEDICARE NUMBER
PPENNO     DIM     15        15        338      PENSION NUMBER
PPNDTE     DIM      6         6        353      pension no expiry date (ccyymm)
PREPAT     DIM     10        10        359      REPATRIATION NUMBER
PSMOK     FORM      1         2        369      PATIENT SMOKER
PSTAT      FORM     1         2        371      PATIENT STATUS
PMICRO     DIM     20        20        373      MICROFILM ADDRESS
PCEASE     FORM     1         2        393      DECEASED INDICATOR
PCASE      FORM     1         2        395      CASE NOTES INDICATOR
PAUTOPY    FORM     1         2        397      AUTOPSY INDICATOR
PHIGH1     DIM      3         3        399      HIGHLIGHT CODE 1 (Cat H1)
PHIGH2     DIM      3         3        402      HIGHLIGHT CODE 2 (Cat H2)
PHIGH3     DIM      3         3        405      HIGHLIGHT CODE 3 (Cat H3)
PLOCDOC    DIM     30        30        408      LOCAL DOCTOR
PFUNDH     DIM      6         6        438      HEALTH FUND
PFNDTB     DIM      8         8        444      HEALTH FUND TABLE
PTMASPAR   DIM     10        10        452      Spare
PUSR1      DIM      3         3        462      USER DEFINED FIELD 1 (Cat P1)
PUSR2      DIM      3         3        465      USER DEFINED FIELD 2 (Cat P2)
PUSR3      DIM      3         3        468      USER DEFINED FIELD 3 (Cat P3)
PUSR4      DIM      3         3        471      USER DEFINED FIELD 4 (Cat P4)
PUSR5      DIM      3         3        474      USER DEFINED FIELD 5 (Cat P5)
PUSR6      DIM      3         3        477      USER DEFINED FIELD 6 (Cat P6)
PUYN1      FORM     1         2        480      USER DEFINED Y/N FIELD 1
PUYN2      FORM     1         2        482      USER DEFINED Y/N FIELD 2
PUYN3      FORM     1         2        484      USER DEFINED Y/N FIELD 3
PYRRES     FORM     2         2        486      NUMBER OF YEARS RESIDENT
PNKNAME    DIM     20        20        488      NEXT OF KIN 1 NAME
PNKADD1    DIM     35        35        508      N.O.K 1 ADDRESS LINE 1
PNKADD2    DIM     35        35        543      N.O.K 1 ADDRESS LINE 2
PNKSUBR    DIM     35        35        578      N.O.K 1 ADDRESS LINE 3
PNKADD4    DIM     35        35        613      N.O.K 1 ADDRESS LINE 4
PNKPOST    DIM      8         8        648      N.O.K 1 POSTCODE
PNKTELP    DIM     20        20        656      N.O.K 1 PRIVATE TELEPHONE
PNKTELB    DIM     20        20        676      N.O.K 1 BUSINESS TELEPHONE
PNKRELP    DIM     10        10        696      N.O.K 1 RELATIONSHIP
PLSTINP    FORM     8         5        706      LAST INPATIENT  VISIT NUMBER
PLSTOUT    FORM     8         5        711      LAST OUTPATIENT VISIT NUMBER
PNXRAY     FORM     3         3        716      NUMBER OF PREVIOUS X-RAYS
PFNDYY     DIM      2         2        719      YRS OF FUND MEMBERSHIP (JR,DE)
PFNDCG     DIM      6         6        721      fund cover change  (ccyymm)
PDECDTE    DIM      8         8        727      date of death  (ccyymmdd)
PHCNOTES   DIM     20        20        735      CASE NOTES INDICATORS
PDIET      DIM      3         3        755      DEFAULT DIET CODE (Cat DC)
PINITHOS   DIM      2         2        758      HOSPITAL U/R INITIATED FROM
PHKADUNI   DIM     10        10        760      HONG KONG UNIQUE ADDRESS ID
PTMAEMPC   DIM      6         6        770      PATIENT EMPLOYER CODE
PTMANOKO   DIM     14        14        776      NEXT OF KIN OCCUPATION
PTMANOKE   DIM      6         6        790      NEXT OF KIN EMPLOYER CODE
PTMADCNO   DIM     10        10        796      DEATH CERTIFICATE NUMBER
PTMAUKDB   DIM      1         1        806      Unknown Date of Birth (Y/N)
PTMAUKDD   DIM      1         1        807      Unknown Date of Death (Y/N)
PFNDMM     DIM     19        19        808      Health Fund Membership no.
PTMADCDT   DIM      8         8        827      Demographics Conf Date CCYYMMDD
PTMAHCP1   DIM     10        10        835      HCP 1 (pmshcpaf)
PTMAHCL1   DIM     10        10        845      HCP 1 Practice (pmshclaf)
PTMAHCG1   DIM      2         2        855      HCP 1 Grp Count (pmshcgaf
PTMAHCP2   DIM     10        10        857      HCP 2 (pmshcpaf)
PTMAHCL2   DIM     10        10        867      HCP 2 Practice (pmshclaf)
PTMAHCG2   DIM      2         2        877      HCP 2 Grp Count (pmshcgaf
PTMAHCP3   DIM     10        10        879      HCP 3 (pmshcpaf)
PTMAHCL3   DIM     10        10        889      HCP 3 Practice (pmshclaf)
PTMAHCG3   DIM      2         2        899      HCP 3 Grp Count (pmshcgaf
PTMAHCP4   DIM     10        10        901      HCP 4 (pmshcpaf)
PTMAHCL4   DIM     10        10        911      HCP 4 Practice (pmshclaf)
PTMAHCG4   DIM      2         2        921      HCP 4 Grp Count (pmshcgaf
PTMAHCP5   DIM     10        10        923      HCP 5 (pmshcpaf)
PTMAHCL5   DIM     10        10        933      HCP 5 Practice (pmshclaf)
PTMAHCG5   DIM      2         2        943      HCP 5 Grp Count (pmshcgaf
PTMASNAM   DIM     40        40        945      Patient Surname
PTMASPA2   DIM     60        60        985      Spare
.End of Record                        1045
.
.
CMDLINE   DIM       100
DIM4      DIM       4
DIM4A     DIM       4
DIM6      DIM       6
DIM6A     DIM       6
DIM60     DIM       60
DDCENT    DIM       2
.
INPFILE   DIM       8
RECNUM    FORM      8
NEWFILE   DIM       60
NEWPATH   DIM       60
OLDPATH   DIM       60
DEFPATH   DIM       60
SAVEFLG   FORM      1
SP50      INIT    "                                                  "
SP60      INIT    "                                                            "
.
PRGNAM    INIT      "CONVERSION PATMA1FD"
PRGID     INIT      "F01PTMA1"
VERSION   INIT      "V12.00.00"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      KDIR0000                      * Keyin directory
          BRANCH    EXIT,MAIN9999
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
MAIN1000  CALL      PREP0000                      * preparing files
          BRANCH    EXIT,MAIN9999
.
. Loop thru old file and write records to new file
.
          CALL      READ0000                      * read old records and write
          CALL      ENDP0000                      * save/compress saved file
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
          
INIT9999  RETURN
.
.********************************************************************
.*                          KDIR0000                                *
.*  Keyin directories                                               *
.********************************************************************
KDIR0000  MOVE      ONE,SAVEFLG        * Default to keep file
          KEYIN     *P1:10,*EL,"Do you want to save the original file (Y/N) ? ":
                    ANS;
          REP       "yYnN",ANS
          CMATCH    "Y",ANS
          GOTO      KDIR1000 IF EQUAL
          MOVE      ZERO,SAVEFLG       * not to keep file
          CMATCH    "N",ANS
          GOTO      KDIR1000 IF EQUAL
          BEEP
          GOTO      KDIR0000
.
KDIR1000  CALL      DEFT0000                * Get the default path
          BRANCH    EXIT,KDIR9999
          MOVE      SP60,OLDPATH
.
          DISPLAY   *P1:24,*EL,"The directory path must end with a slash (/) ";
.
          MOVE      DEFPATH,OLDPATH
          BRANCH    SAVEFLG,KDIR2000
.
.         Keyin the path for the original file
.
          KEYIN     *P1:12,*EL,"Keyin path for temporarily saving original ":
                    "file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
          GOTO      KDIR3000
.
KDIR2000  KEYIN     *P1:12,*EL,"Keyin path for saving original file: ":
                    *P10:13,*EL,*DV,*RV,OLDPATH:
                    *P10:13,OLDPATH;
.
KDIR3000  ENDSET    OLDPATH
          APPEND    SP60,OLDPATH
          RESET     OLDPATH
.
          MATCH     SP60,OLDPATH
          IF        @EQUAL
            PACK      OLDPATH,DEFPATH      * use the default
            DISPLAY   *P10:13,*EL,*V2LON,OLDPATH;
          ENDIF
.
          SQUEEZE   OLDPATH
          CMATCH    EXITCHAR,OLDPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,OLDPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR1000
.
.         Keyin the path for the new file
.
KDIR5000  MOVE      SP60,NEWPATH
          MOVE      DEFPATH,NEWPATH
          KEYIN     *P1:15,*EL,"Keyin path for the new file: ":
                    *P10:16,*EL,*DV,*RV,NEWPATH:
                    *P10:16,NEWPATH;
          ENDSET    NEWPATH
          APPEND    SP60,NEWPATH
          RESET     NEWPATH
.
          MATCH     SP60,NEWPATH
          IF        @EQUAL
            PACK      NEWPATH,DEFPATH      * use the default
            DISPLAY   *P10:16,*V2LON,NEWPATH;
          ENDIF
.
          SQUEEZE   NEWPATH
          CMATCH    EXITCHAR,NEWPATH
          GOTO      KDIR9000 IF EQUAL
.
          PACK      DIM60,NEWPATH,SP60
          CALL      VALD0000         * check if it's a valid directory
          BRANCH    EXIT,KDIR5000
          GOTO      KDIR9999
.
KDIR9000  MOVE      ONE,EXIT
KDIR9999  DISPLAY   *P1:24,*EL;
          RETURN
+
.********************************************************************
.*                          PREP0000                                *
.*  Preparing files                                                 *
.********************************************************************
PREP0000 
. open old file
          MOVE      "patma1af",INPFILE
          CALL      CHEK0000             * check file exists or has been changed
          BRANCH    EXIT,PREP9000
.
          CLOSE     OLDFILE1
          DISPLAY   *P1:24,*EL,"Copying files ... Please wait !! ";
.
. Copy old file to the keyin directory
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat patma1af.dat` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "sptma1af.dat",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cp `ldat patma1af.idx` ",CMDLINE
          APPEND    OLDPATH,CMDLINE
          APPEND    "sptma1af.idx",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      PREP8000
          ENDIF
.
. remove the original files
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    DEFPATH,CMDLINE
          APPEND    "patma1af",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Unable to remove the original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Opening old file after being copied
.
          MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60
          APPEND    "sptma1af",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OLDFILE1,DIM60
          TRAPCLR   IO
          IF        OVRCD = 1
            DISPLAY   *P1:24,*EL,*B,"Unable to open saved original file.  ";
            CALL      HITENTER
            GOTO      PREP9000
          ENDIF
.
. Create the new file
.
          DISPLAY   *P1:24,*EL,"Creating new files ... Please wait !! ";
          PACK      NEWFILE,SP60
          CLEAR     NEWFILE
          APPEND    NEWPATH,NEWFILE
          APPEND    "patma1af",NEWFILE
          APPEND    SP60,NEWFILE
          RESET     NEWFILE
          SQUEEZE   NEWFILE
.
PREP1000  PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    NEWFILE,CMDLINE
.
.  The files new record length and unique key must be written here
.      eg    APPEND    " 195 UC9-16",CMDLINE
.
          APPEND    " 1045 UC1-8",CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.  If the file has more than one index, this piece of code below has 
.  to be repeated with for each individual index
.
           PACK      CMDLINE,SP60,SP60
           CLEAR     CMDLINE
           APPEND    "isadd ",CMDLINE
           APPEND    NEWFILE,CMDLINE
           APPEND    " D286-293",CMDLINE
           APPEND    SP60,CMDLINE
           RESET     CMDLINE
           EXECUTE   CMDLINE,TASKID
.
           PACK      CMDLINE,SP60,SP60
           CLEAR     CMDLINE
           APPEND    "isadd ",CMDLINE
           APPEND    NEWFILE,CMDLINE
           APPEND    " UC328-337,1-8",CMDLINE
           APPEND    SP60,CMDLINE
           RESET     CMDLINE
           EXECUTE   CMDLINE,TASKID
.
           PACK      CMDLINE,SP60,SP60
           CLEAR     CMDLINE
           APPEND    "isadd ",CMDLINE
           APPEND    NEWFILE,CMDLINE
           APPEND    " U75-93,1-8",CMDLINE
           APPEND    SP60,CMDLINE
           RESET     CMDLINE
           EXECUTE   CMDLINE,TASKID
.
          OPEN      PATMA1A1,NEWFILE
.
. set the flag to say we want to continue
.
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started : ",CDATE,SP1,CTIMEIS:
                    *P1:20,"Record : "
          GOTO      PREP9999
.
PREP5000  DISPLAY   *P1:24,*EL,*B,"Old file not found.  ";
          CALL      HITENTER
          GOTO      PREP9000
.
PREP8000  DISPLAY   *P1:24,*EL,*B,"Unable to copy original file.  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
.
PREP9000  MOVE      ONE,EXIT
PREP9999  RETURN
+
.********************************************************************
.*                          CHEK0000                                *
.*  Check if file exists, or has already been converted             *
.********************************************************************
CHEK0000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND GIVING DIM60 IF IO
          OPEN      OLDFILE1,INPFILE
          TRAPCLR   IO
          BRANCH    OVRCD,CHEK2000       * Original file does not exist
          CLOSE     OLDFILE1
          GOTO      CHEK9999
.
CHEK2000  SCAN      "I * I",DIM60
          DISPLAY   *P1:23,*EF,"File '",INPFILE,"' ";
          IF        @EQUAL
            DISPLAY   "does not exist - ";
          ELSE
            SCAN      "I * L",DIM60
            IF        @EQUAL
              DISPLAY   "has already been converted - ";
            ELSE
              DISPLAY   "has caused an IO error - ";
            ENDIF
          ENDIF
          DISPLAY   "File will be bypassed"
.
          IF        FORM2 < 17
            CALL      HITENTER
          ENDIF
          DISPLAY   *P1:23,*EF
.
CHEK9000  MOVE      ONE,EXIT
.
CHEK9999  RETURN
.
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
          PACK      KEY8,SP60
          CALL      READSOLD                      * position at start
READ1000  CALL      READKOLD                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
          ADD       ONE,RECNUM                    * update record counter
.
.  All necessary changes to the files field lengths, date changes
.  or any other sort of modification must be made here
.
          PACK       PFNDMM,OLDFNDMM,SP70
          PACK       PTMASPAR,SP70
          PACK       PTMADCDT,SP70
          PACK       PTMAHCP1,SP70
          PACK       PTMAHCL1,SP70
          PACK       PTMAHCG1,SP70
          PACK       PTMAHCP2,SP70
          PACK       PTMAHCL2,SP70
          PACK       PTMAHCG2,SP70
          PACK       PTMAHCP3,SP70
          PACK       PTMAHCL3,SP70
          PACK       PTMAHCG3,SP70
          PACK       PTMAHCP4,SP70
          PACK       PTMAHCL4,SP70
          PACK       PTMAHCG4,SP70
          PACK       PTMAHCP5,SP70
          PACK       PTMAHCL5,SP70
          PACK       PTMAHCG5,SP70
          PACK       PTMASNAM,PSNAME,SP70
          PACK       PTMASPA2,SP70
      
          PACK      KEY8,PURNO,SP70
          CALL      WRMAST1                    * write to new file
.
          IF        (RECNUM%1000) = 0
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     PATMA1A1                      * close new file
          CLOSE     OLDFILE1                      * close old file
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
.
READ9999  RETURN
.
+
.**********************************************************************
.*                               VALD0000                             *
.*        Check if it a valid directory                               *
.**********************************************************************
VALD0000  MOVE      ZERO,EXIT
          SQUEEZE   DIM60
          ENDSET    DIM60
          CMATCH    SLASH,DIM60
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory path must end with a slash (/) ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          RESET     DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          APPEND    "cd ",CMDLINE
          APPEND    DIM60,CMDLINE
          APPEND    SP60,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Directory does not exist ";
            CALL      HITENTER
            GOTO      VALD9000
          ENDIF
          GOTO      VALD9999
.
VALD9000  MOVE      ONE,EXIT            * Not valid
VALD9999  RETURN
+
.**********************************************************************
.*                               ENDP0000                             *
.*        Remove or compress save file                                *
.**********************************************************************
ENDP0000  MOVE      SP60,DIM60
          CLEAR     DIM60
          APPEND    OLDPATH,DIM60        * set up the saved file with path
          APPEND    "sptma1af*",DIM60
          APPEND    SP60,DIM60
          RESET     DIM60
          SQUEEZE   DIM60
.
          PACK      CMDLINE,SP60,SP60
          CLEAR     CMDLINE
          IF        SAVEFLG = 1
            APPEND    "compress -f ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Compressing original file.. ":
                      "Please wait !!  ";
          ELSE
            APPEND    "rm ",CMDLINE
            APPEND    DIM60,CMDLINE
            APPEND    SP60,CMDLINE
            RESET     CMDLINE
            DISPLAY   *P1:24,*EL,"Removing original file.. Please wait !!  ";
          ENDIF
          EXECUTE   CMDLINE,TASKID      * check if exists
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"Saved file not compressed or removed.  ";
            CALL      HITENTER
            GOTO      ENDP9999
          ENDIF
.
          CALL      IBACLOCK
          DISPLAY   *P1:24,*EL,*B,"Finish processing.  ";
          CALL      HITENTER
.
ENDP9999  RETURN
+
.**********************************************************************
.         Get the default directory
.**********************************************************************
DEFT0000  EXECUTE   "ldat patma1af.dat > temp.txt",TASKID
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  DISPLAY   *P1:24,*EL,*B,"Error finding 'patma1af'.  ";
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
DEFT9999  RETURN
+
.
.                  ******************************    OLD IO ROUTINES
. ------- positional read -------
.
READSOLD  RESET     KEY8
          READ      OLDFILE1,KEY8;;
          RETURN
.
READKOLD  MOVE      ZERO,OVRCD
          READKS    OLDFILE1;PURNO,PPORT,PCHGDTE,PTITL,PHOSP:
                             PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                             PADD1,PADD2,PSUBRB,PADD4,PPOST:
                             PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                             PSAGE,PCONT,PREG,PTYPE:
                             POCCUP,PLDDATE,PMEDI,PPENNO,PPNDTE:
                             PREPAT,PSMOK,PSTAT,PMICRO,PCEASE:
                             PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                             PLOCDOC,PFUNDH,PFNDTB,OLDFNDMM,PUSR1:
                             PUSR2,PUSR3,PUSR4,PUSR5,PUSR6:
                             PUYN1,PUYN2,PUYN3,PYRRES,PNKNAME:
                             PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                             PNKTELP,PNKTELB,PNKRELP,PLSTINP,PLSTOUT:
                             PNXRAY,PFNDYY,PFNDCG,PDECDTE,PHCNOTES:
                             PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                             PTMANOKE,PTMADCNO,PTMAUKDB,PTMAUKDD
          GOTO      OVERCOND IF OVER
          RESET     PHCNOTES,CHOSINDX
          MOVE      PHCNOTES,ANS
          MOVE      ANS,PCASE
          RETURN
.
.                  ******************************    NEW IO ROUTINES
WRMAST1   MOVE      SP2,PPORT
.
WRMAST1A  RESET     KEY8
          RESET     PHCNOTES,CHOSINDX
          MOVE      PCASE,ANS
          CMOVE     ANS,PHCNOTES
          WRITE     PATMA1A1,KEY8;KEY8,PPORT,PCHGDTE,PTITL,PHOSP:
                                  PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                  PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                  PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                  PSAGE,PCONT,PREG,PTYPE:
                                  POCCUP,PLDDATE,PMEDI,PPENNO,PPNDTE:
                                  PREPAT,PSMOK,PSTAT,PMICRO,PCEASE:
                                  PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                                  PLOCDOC,PFUNDH,PFNDTB,PTMASPAR,PUSR1:
                                  PUSR2,PUSR3,PUSR4,PUSR5,PUSR6:
                                  PUYN1,PUYN2,PUYN3,PYRRES,PNKNAME:
                                  PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                                  PNKTELP,PNKTELB,PNKRELP,PLSTINP,PLSTOUT:
                                  PNXRAY,PFNDYY,PFNDCG,PDECDTE,PHCNOTES:
                                  PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                                  PTMANOKE,PTMADCNO,PTMAUKDB,PTMAUKDD:
                                  PFNDMM,PTMADCDT,PTMAHCP1,PTMAHCL1,PTMAHCG1:
                                  PTMAHCP2,PTMAHCL2,PTMAHCG2,PTMAHCP3,PTMAHCL3:
                                  PTMAHCG3,PTMAHCP4,PTMAHCL4,PTMAHCG4,PTMAHCP5:
                                  PTMAHCL5,PTMAHCG5,PTMASNAM,PTMASPA2
.
          RETURN
+
          INC       STD001IO
