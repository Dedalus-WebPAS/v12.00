.------------------------------------------------------------
. Modifications: 
. V10.14.01 28/03/2019  Peter Vela       TSK 0839663
.           Recompiled for OPRSESTM
. V10.12.01 20/03/2018  Peter Vela     TSK 0842991
.           Recompiled for OPRSESTM
. V10.06.01 24/06/2015  Don Nguyen     CAR 318454
.           Recompiled for OPRSESTM - Added OPSES078 in MOVSES00
. V10.05.02 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.01 04.09.2014  Ania P         CAR 298084
.           Recompiled for OPRSESTM
. V10.03.02 04/10/2013  Patrick Adair  CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.01 16/07/2013  Jill Parkinson CAR 287923
.           Added include of PATCONFD
.                   V9.12.02  11/12/2009  Ebon Clements  CAR 210196
.                             Recompiled for OPRSESTM - Default start/end 
.                             time for duration
.                   V9.12.01  07/12/2009  Peter McMullen CAR 210130
.                             replace call to DOCNAM00 with newer DOCNM000
.                   V9.09.01  20/07/2007  Ebon Clements  CAR 145544
.                             Recompiled for OPRSESTM - display theatres
.                             with no hospital
.                   V9.08.01  02/10/2006  Ebon Clements CAR 7119992
.                             Added multi hospital functionality
.                   V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                             Mods for PATCODTM - Hospital specific category
.                             codes
.                   V9.04.02  05/09/2005  Ebon Clements CAR 73209
.                             Recompiled for OPRSESTM - Session usage
.                             default times
.                   V9.04.01  18.03.2005  Guomin Fu
.                             Recompiled for OPRSESTM
.                   V5.07.01  20.12.1999  Katie Nelson
.                             Recompiled for IBAWEBDF/IBAWEBCD 
.------------------------------------------------------------
          INC       IBAWEBDF    
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PATHSPFD/INC
          INC       OPR001FD/INC
          INC       OPRCLIFD/INC
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDECFD/INC
          INC       OPRSESFD/INC
          INC       OPRSESTD/INC
          INC       OPROPRFD/INC
          INC       OPRNURFD/INC
          INC       OPRSRGFD/INC
          INC       OPRARDFD/INC
.
CLINCODE  DIM       6
DIM3      DIM       3
FORM4D    FORM      4
SESSKEYS  DIM       19
OPRWEBSR  FORM      1                       * Used in OPRSESTM
.
PRGID     INIT      "OPRWEB99"
VERSION   INIT      "V10.14.01"
PRGNAM    INIT      "Session Enquiry Template Server"
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID & Set Para
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      GETSES00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
PROFLD00  BRANCH    REPORTNO,PROFLD10
          GOTO      PROFLD99
.
PROFLD10  CALL      OSES0000      * Add Session File Field
.
PROFLD99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATDO1A1,"patdo1af"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATCODE2,"patcodes" 
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
.
          READ      CONTROLF,SIXTY8;*241,OPCNSTCT,*245,OPCNDSAS,*247,OPCNDSAE
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,SESSKEYS
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Display Doctor Details
.------------------------------------------------------------
GETSES00  PACK      KEY19,SESSKEYS
          CALL      RDOPSES1 
          IF        OVRCD=1
            MOVE      "INVALID SESSION",WEBTITLE
            CALL      WEBERR00   * Output Error
            GOTO      GETSES99
          ENDIF
          MOVE      OPSECLIN,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      "INVALID DOCTOR",WEBTITLE
            CALL      WEBERR00   * Output Error
            GOTO      GETSES99
          ENDIF
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          CLEAR     WEBTITLE
          APPEND    "Theatre Session for ",WEBTITLE
          APPEND    DOCFNAME,WEBTITLE
          APPEND    " on the ",WEBTITLE
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F3,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GETSES99
.
          CALL      WEBBOD00   * Create Output File and Write HTML Page Header
.
          CALL      WEBEND00
.
GETSES99  RETURN
NURDET00  UNPACK    DIM127,D1,ANS,DIM127  
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,NURDET10,NURDET20
          MATCH     SP70,NURSCODE
          GOTO      NURDET99 IF EQUAL
          MOVE      NURSCODE,KEY6
          CALL      RDOPNUR1
          IF        OVRCD=0
            WRITE     HTMLFILE;OPNRSNAM,",",OPNRGNAM;
          ENDIF
          GOTO      NURDET99
NURDET10  MATCH     SP70,NURSCODE
          GOTO      NURDET99 IF EQUAL
          WRITE     HTMLFILE;NURSCODE;
          GOTO      NURDET99
.
NURDET20  PACK      KEY36,SP70
          CALL      RSOPNUR2
NURDET25  CALL      RKOPNUR2
          BRANCH    OVRCD,NURDET99
          BRANCH    OPNRSTAT,NURDET25
          MOVE      OPNRGNAM,ANS
          MATCH     OPNRCODE,NURSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OPNRCODE,"#" selected>":
                               OPNRSNAM,COMMA,ANS,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OPNRCODE,"#">":
                               OPNRSNAM,COMMA,ANS,"</option>"
          ENDIF
          GOTO      NURDET25
.
NURDET99  RETURN
.------------------------------------------------------------
          INC       PATDO1IO/INC
          INC       PATHSPIO/INC
          INC       OPRCLIIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDECIO/INC
          INC       OPROPRIO/INC
          INC       OPRNURIO/INC
          INC       OPRSESIO/INC
          INC       OPRSRGIO/INC
          INC       OPRARDIO/INC
          INC       OPRSESTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       IBAWEBCD    
.
