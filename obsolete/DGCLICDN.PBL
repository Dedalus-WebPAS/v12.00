.************************************************************************
.*  Procedure: DGCLIDNR  -  Send New Donor details                      *
.*                                                                      *
.*  Author   : Steve Armstrong  (25/02/1998)                            *
.*                                                                      *
.*  Requires : Valid read on nhidnraf                                   *
.*             FORM1    -  (1=Add, 2=Delete)                            *
.*  Mods     :                                                          *
.*  V9.02.01   02/10/2001  Davin                                        *
.*             Mods to use message holding file                         *
.*             26/03/1998  Steve Armstrong                              *
.*             Mods to send donor contact details also (new message     *
.*             format).                                                 *
.*                                                                      *
.************************************************************************
.
          DEFPROC   DGCLICDN
.
COUNTR    FORM      2
DIM8      DIM       8
.
          INC       HL7BMTFD/INC
.
DGCLI000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,EIGHTY8;*54,PTCNDGDN
.
.         Check if we are broadcasting donor messages & NHI is on
.
          IF        PTCNDGDN <> 1 | PTCNNHII <> 1
            GOTO      DGCLI999
          ENDIF
.
.         Open the broadcast message holding table file
.
          OPEN      HL7BMTA1,"hl7bmtaf"
.
.         Write message
.
          MOVE      "CDN",HLBMTYPE
          PACK      HLBMURNO,SP1,NHDNNMPI
          PACK      HLBMVISN,SP30
          PACK      HLBMTKEY,SP30,SP30
.
          PACK      HLBMDATE,CCC,CYY,CMM,CDD
          REP       " 0",HLBMDATE
          PACK      HLBMSPAR,SP30,SP30,SP30
.
DGCLI100  CLOCK     TIME,KEY8
          REP       ": ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,HLBMTIME
          PACK      KEY14,HLBMDATE,HLBMTIME,SP30
          CALL      RAHLBM1
          COMPARE   ZERO,OVRCD             * Must be a Unique Record
          GOTO      DGCLI100 IF EQUAL      * So get Time Again
.
          CALL      WRHLBM1
          CLOSE     HL7BMTA1
.
DGCLI999  GOTO      DGCLIEND                        * end procedure
.
.         IO's go in here
.
          INC       HL7BMTIO/INC
          INC       IBAOVRIO/INC
.
DGCLIEND  ENDPROC

