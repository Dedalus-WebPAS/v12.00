.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*     PROGRAM NAME:     IBABIL55                                             *
.*                                                                            *
.*     FUNCTION:         HEALTH DEPARTMENT TRANSMISSIONS (NSW)                *
.*                                                                            *
.*     DATE PORTED:      19/10/2004                                           *
.*                                                                            *
.*     PORTED BY:        GUOMIN FU                                            *
.*                                                                            *
.*     MODIFICATIONS:                                                         *
.*       V10.10.01  16/03/2017 Richa Phogat    TSK 0832066                    *
.*                  Changed DVA Card Number and DVA Card colour to be         *
.*                  collected from PMCDCNUM.PMSCCDFD and PMCDDVAC.PMSPX2FD    *
.*                  instead of PREPAT.PMIMA1FD and PMPXDVAC.PMIMA1FD          *
.*       V10.05.02  10/12/2012 J.Tan           CAR 306325                     *
.*                  Mods to print error for blank PMVXCADM - Adm.Criterion    *
.*       V10.05.01  05/12/2012 J.Tan           CAR 303664                     *
.*                  Get drg from patpgraf based on discharge date grouper     *
.*                  version. (GDRG000)                                        *
.*       V10.03.03  17/02/2012 Sandra Barcham  CAR 260291                     *
.*                  Fix post code functionality                               *
.*       V10.03.01  18/11/2011  Mike Laming     CAR 240184                    *
.*                  Changes to IBAPOSTF Post Code table - added State to Keys *
.*       V10.02.02  31/10/2011  Mike Laming    CAR 250267                     *
.*                  Correct vars for changed length of PTICUMEC at DSCD3000   *
.*       V10.02.01  28/03/2011  Mike Laming   CAR 240107                      *
.*                  Mods to PATECDaf & PATECOaf variables & Keys - file change*
.*       V10.01.01  23/12/2010  Davin       Incident 500296                   *
.*                  Added routine to source dva card number/type from         *
.*                  pmsccdaf if it exists (concd000)                          *
.*       V10.00.10  14/09/2010  Steve Armstrong  CAR 229945                   *
.*                  Fixed GOTO labels which were going outside subroutines    *
.*       V10.00.09  08/09/2010 Davin S         CAR 229858                     *
.*                  Always populate Date of Principal Procedure (TPRDATE8)    *
.*                  even if date is not mandatory in pati10o7f (PT0ODTMN = 1) *
.*       V10.00.08  20/07/2010 Sandra Barcham  CAR 224065                     *
.*                  Stopped post code looping                                 *
.*       V10.00.07  06/07/2010 Jill Parkinson  CAR 225495                     *
.*                  Fixed paticuaf lengths                                    *
.*       V10.00.06  02/07/2010 Sandra Barcham  CAR 224065                     *
.*                  Exclude any postcode with OS in state                     *
.*       V10.00.05  11/06/2010  Mike Laming    CAR 222931                     *
.*                  Change DVA test if Private - at DVACT00                   *
.*       V10.00.04  10/06/2010  Mike Laming    CAR 222092                     *
.*                  Mods to fix PUBPRIV indicator                             *
.*       V10.00.03  28/05/2010  Peter Vela     CAR 222865                     *
.*                  Do not include boarders in the extract                    *
.*       V10.00.02  29/04/2010  Sandra Barcham CAR 219321                     *
.*                  Default to private for category VB                        *
.*       V10.00.01  29/03/2010  Davin          CAR 211914                     *
.*                  Tighten editing so trlegst always defaults to 19          *
.*        V9.12.03  16/10/2009  Jill Parkinson CAR 207820                     *
.*                  Removed REP line for TREADMN                              *
.*        V9.12.02  02/10/2009  Mike Laming   CAR 206821                      *
.*                  Add test of Ind. PTMORBDT at VALD8000                     *
.*        V9.12.01  07/08/2009 Sandra Barcham CAR 203253                      *
.*                  Default unplanned readmission                             *
.*        V9.11.04  30/04/2009  Jill Habasque CAR 195766                      *
.*                  July 2009 mods                                            *
.*        V9.11.03  28/04/2009  Mike Laming   CAR 195595                      *
.*                  Correct Read statement for parameter PTCNDSCI             *
.*        V9.11.02  08/04/2009  Jill Habasque  CAR 194155                     *
.*                  Removed error for health ins status based on atype        *
.*        V9.11.01  27/10/2008 Sandra Barcham  CAR 181754                     *
.*                  Change report to use correct hospital number (CFILENO)    *
.*        V9.10.02  14/07/2008 Jill Habasque   CAR 169032                     *
.*                  Added CHIH0000 - Hospital in the hotel                    *
.*        V9.10.01  19/05/2008 Jill Habasque   CAR 167813                     *
.*                  Changed  TREADMN to be mapped (as HCP uses it)            *
.*        V9.09.04  09/04/2008 Sandra Barcham     165873                      *
.*                  Fix read of diagnosis and procedures                      *
.*        V9.09.03  17/03/2008 Sandra Barcham     163677                      *
.*                  Change Category KN to VI                                  *
.*                  12/03/2008 Sandra Barcham     163668                      *
.*                  Ensure correct values are send for payment status on      *
.*                  separation                                                *
.*        V9.09.02  11/03/2008 Jill Habasque  CAR 163612                      *
.*                  Changed admission status to allow 4 and 5                 *
.*        V9.09.01  09/08/2007 Sandra Barcham CAR 147529                      *
.*                  In Re-Admission within 28 day should be KO not KM         *
.*        V9.08.01  20/04/2007 Jill Habasque  CAR 139025                      *
.*                  Mods to use PTVANHSC if populated                         *
.*        V9.05.B01 01/12/2005  Peter Vela    CAR 83928                       *
.*                  Changed DVA Card Number (TDVACN) to be collected from     *
.*                  PREPAT.PATMASFD instead of VCLMNO.PATWVEFD                *
.*        V9.04.04  25/05/2005  Mike Laming  CAR 62056                        *
.*                  Change RMDT0000 so that Morphology codes retain "/"       *
.*        V9.04.03  19/05/2005  Mike Laming  CAR 62056                        *
.*                  Change Morphology Codes to return EXIT=0 from VDIS5000 to *
.*                  allow these to be written to extract                      *
.*        V9.04.02  22/02/2005  Guomin Fu         CAR 58552                   *
.*                  Fixed NSW HDP extract not updating new run date           *
.*        V9.04.01  22/12/2004  Guomin Fu         CAR 55938                   *
.*                  Send 2 spaces for Service unit type on admission (TSUTADM)*
.*                  since it is not required by Health department anymore     *
.*                  21/12/2004  Davin             CAR 55946                   *
.*                  Added routine to move extract to web directory            *
.*        V9.04.00  19/10/2004  Guomin Fu         CAR 54416                   *
.*                  Porting IBABIL55 into V9.03                               *
.*        V6.12.01  27/07/2004  Mike Laming       CAR 50644                   *
.*                  Added PTCNCDVA - Hospital Contracted for Veteran Affairs  *
.*                  to make DCV edits mandatory at DVC00                      *
.*        V6.12.00  17/05/2004  Mike Laming   CAR 49016                       *
.*                  July 2004 PRS/2 - changed to use sex routine SEXDSC00     *
.*        V6.11.02  07/04/2004  Mike Laming  CAR 48330                        *
.*                  Correct LEAD0000 for Leave period to be >=2 calendar days *
.*        V6.11.01  07/04/2004  Mike Laming  CAR 44050                        *
.*                  Add code to test DVA Payment Status and extract all reqd  *
.*                  data when Payment Status = "50"                           *
.*        V6.10.04  10/06/2003  Guomin  CAR 11748                             *
.*                  Fixed when leave days >= 2 days then allocate a leave     *
.*                  period to it.                                             *
.*        V6.10.03  11/10/2002  Guomin  SRF 22524 Rebound                     *
.*                  Fixed a bug when postcode is one of "2540","6798","6799"  *
.*                  state is extracted as"5" instead of "9"                   *
.*        V6.10.02  08/10/2002  Guomin  SRF 22524 rebound                     *
.*                  Fixed a bug when postcode of 9999, data field for "state" *
.*                  is blank and when postcode is '0", "state"is extracted as *
.*                  "2" = VIC                                                 *
.*        V6.10.01  03/10/2002  Guomin  SRF 22524
.*                  Fixed a bug that for all patients where the address
.*                  is overseas, the extract is putting a value"1" in the 
.*                  state field instead of "0"
.*        V6.09.01  06/06/2002  Davin  2002/2003 changes                      *
.*                  Recompiled for change to paticuaf                         *
.*        V6.09.B03 23/02/2001  Jill Habasque                                 *
.*                  Mods for ABWGHT - changes to unpack into 4 characters     *
.*        V6.09.B02 03/01/2001  Steve Downing                                 *
.*                  Mods to use user def. fields P4-6 for CNSWLNG             *
.*        V6.09.B01 12/12/2000  Jill Habasque SRF 7697                        *
.*                  Added clear of TUSUACC usual accomodation                 *
.*                  Added clear of TRAPSYC if not a psych visit               *
.*        V6.07.10  12/10/2000  Dean Cramer                                   *
.*                  "Activity when injured required " print message has been  *
.*                  removed for external code missing/additional requirements *
.*                  code 6 as place of occurance only is neended for code 6   *
.*        V6.07.09  19/09/2000  Jill Habasque                                 *
.*                  Added clear of place of occurence & activity              *
.*        V6.07.08  18/09/2000  Jill Habasque                                 *
.*                  Added type 6,7 & 8 to be external cause codes             *
.*        V6.07.07  15/09/2000  Jill Habasque                                 *
.*                  Added GDRG0000 routine                                    *
.*        V6.07.06  01/09/2000  Steve Downing                                 *
.*                  Mods to include Indeterminate sex                         *
.*        V6.07.05  19/07/2000  Jill Habasque                                 *
.*                  Added check of newfile before validating activity when inj*
.*        V6.07.04  13/07/2000  Jill Habasque                                 *
.*                  Fixed TSTATE if no postcode in patmastf                   *
.*        V6.07.03  28/06/2000  Jill Habasque                                 *
.*                  2000/2001 Mods                                            *
.*        V6.07.02  22/06/2000  Jill Habasque                                 *
.*                  Fixed date of principal procedure                         *
.*        V6.07.01  17/04/2000  Jill Habasque SRF 637710 & 637674             *
.*                  Added clear of TIDUMH,fixed error for unplanned theatre   *
.*        V6.07.B02 02/02/2000  Jill Habasque SRF 637339                      *
.*                  Mods for unqualified newborns (added check of Cat BT)     *
.*        V6.06.28  27/01/1999  Greg Horvat      SRF 637083                   *
.*                  Recompiled for PATECDFD & PATECOIO                        *
.*                  27/01/1999  Greg Horvat                                   *
.*                  Changed to only validate the involuntary days if a        *
.*                  psychiatric patient                                       *
.*        V6.06.27  14/01/2000  J Habasque  SRF 637083                        *
.*                  Mods to TREFTO if a statistical separation                *
.*        V6.06.26  23/12/1999  Davin                                         *
.*                  Leave default health insurance status (THCOVER = 0 or 5)  *
.*                  if no record on patfundf                                  *
.*        V6.06.25  16/12/1999  Davin  SRF 636492                             *
.*                  Fixed bug in extracting health insurance status           *
.*        V6.06.24  14/12/1999  Davin  SRF 636365                             *
.*                  Fixed bug in checking if public patient (for DVA)         *
.*        V6.06.23  14/12/1999  Greg Horvat                                   *
.*                  Recompiled for PATM10T9 - Fixed obstetric & tendon injury *
.*                  complex mapping bugs                                      *
.*        V6.06.22  30/11/1999  J Habasque                                    *
.*                  Commented out tests for episode number so that 2nd episodes*
.*                  would be in the extract                                   *
.*        V6.06.21  22/11/1999  Jill Habasque                                 *
.*                  Changed Discharge Intention to use HDP                    *
.*        V6.06.20  11/11/1999  Jill Habasque                                 *
.*                  Changed THCOVER to default to 0 for private patients      *
.*        V6.06.19  08/11/1999  Jill Habasque                                 *
.*                  Changed to use PTCNDSCI instead of PTCNUDIN               *
.*        V6.06.18  05/11/1999  Jill Habasque SRF 635694                      *
.*                  Mods to only fill in DVA details if public patient        *
.*        V6.06.17  03/11/1999  Jill Habasque                                 *
.*                  Changed to extract Medicare no for all patients           *
.*        V6.06.16  16/10/1999  Greg Horvat                                   *
.*                  - Recompiled for PATIOICD & PATIOICO                      *
.*                  - Recompiled for PATM10T9 - Changed for new complex       *
.*                    mapping file structure & added more complex maps        *
.*        V6.06.15  06/10/1999  Jill Habasque                                 *
.*                  Mods to old file layout                                   *
.*        V6.06.14  05/10/1999  Jill Habasque                                 *
.*                  Fixed Medicare Ref to be at the end                       *
.*        V6.06.13  28/09/1999  Jill Habasque                                 *
.*                  Changed Transferred To to be left justified               *
.*        V6.06.12  23/09/1999  Jill Habasque                                 *
.*                  Added default of one for Medicare Reference               *
.*        V6.06.11  15/09/1999  Steve Downing                                 *
.*                  Redundant code removed                                    *
.*        V6.06.10  10/09/1999  Davin                                         *
.*                  Changes for 4 character DRGs                              *
.*        V6.06.09  30/08/1999  Jill Habasque                                 *
.*                  Changed Pension status to allow zero                      *
.*        V6.06.08  24/06/1999  Jill Habasque                                 *
.*                  Fixed validation to allow blank                           *
.*        V6.06.07  24/06/1999  Jill Habasque                                 *
.*                  Fixed payment status validation                           *
.*        V6.06.06  23/08/1999  Jill Habasque                                 *
.*                  Fixed Pension Status separation                           *
.*        V6.06.05  17/08/1999  Davin  SRFs 630686 & 633983                   *
.*                  - Set TREADMN (readmit. < 28 days) to 1 instead of 2 for  *
.*                  type change admissions                                    *
.*                  - Fixed bug in calculation of psych. bed days             *
.*        V6.06.04  30/07/1999  Jill Habasque                                 *
.*                  Added zero fill for some fields                           *
.*        V6.06.03  28/05/1999  Jill Habasque SRF 631798                      *
.*                  Changed CNSWRACE to use PNSWRACE to allow all Adm UDF's   *
.*        V6.06.02  11/05/1999  Jill Habasque                                 *
.*                  07/99 Health department changes                           *
.*        V6.06.01  14/04/1999  Greg Horvat                                   *
.*                  Fixed problem a problem validating ICD10 codes            *
.*        V6.06.B02 02/03/1999  Greg Horvat      SRF 628620                   *
.*                  Changed to send E codes as they werent being sent before  *
.*        V6.06.B01 10/02/1999  Jill Habasque                                 *
.*                  Fixed DISPHEAD display                                    *
.*        V6.05.12  08/12/1998 Jill Habasque                                  *
.*                  Removed CCENTRY                                           *
.*        V6.05.11  26/10/1998  Greg Horvat                                   *
.*                  Changed to display & calculate dates using the century    *
.*        V6.05.10  21/10/1998  J.Tan  SRF 628623                             *
.*                  Mods unq.baby days temp.variable to have more than 9 days *
.*        V6.05.09  10/10/1998  J.Tan  SRF 628372                             *
.*                  Fixed not to add an extra day to unqual.beddays for disch.*
.*        V6.05.08  02/10/1998  Steve Armstrong                               *
.*                  Fixed checking of date range spanning ICD10 golive date   *
.*        V6.05.07  17/09/98 J.Tan                                            *
.*                  Mods checking date to use new/old file layout             *
.*        V6.05.06  15/09/98 J.Tan                                            *
.*                  Mods to check for ICD9 or ICD10                           *
.*        V6.05.05  08/09/1998  Davin  SRF 627821                             *
.*                  Check patient coding date when validating ICD codes       *
.*        V6.05.04  27/08/1998  Davin  SRF 627527                             *
.*                  Mods for icd10                                            *
.*        V6.05.03  28/07/98 J.Tan    SRF 627086                              *
.*                  Fixed fromdate to D8 and 2nd key for operation file       *
.*        V6.05.02  27/07/1998  Greg Horvat                                   *
.*                  Changed to not extract X operation types                  *
.*        V6.05.01  10/07/98 J.Tan                                            *
.*                  Mods to 1998 changes                                      *
.*        V6.04.20  15/05/1998  Greg Horvat                                   *
.*                  Changed unplanned visit to theatre validation             *
.*        V6.04.19  21/04/98 J.Tan     SRF 625330                             *
.*                  Mods to initialise hospital refer from if source ref = 09 *
.*        V6.04.18  25/03/98 J.Tan                                            *
.*                  Fixed legal status to default to 9                        *
.*        V6.04.17  17/03/98 J.Tan                                            *
.*                  Fixed legal status                                        *
.*        V6.04.16  03/03/1998  Greg Horvat      SRF 624437                   *
.*                  Not extracting the service unit type on admin correctly   *
.*        V6.04.15  17/02/1998  Greg Horvat      SRF 623461                   *
.*                  Changed to pick up changes to the parameter CNSWRACE      *
.*        V6.04.14  04/02/1998  Davin                                         *
.*                  Mode of separation = '09' for all type changes except     *
.*                  when patient discharged.                                  *
.*                  Source of referral = '09' for all episodes after first    *
.*                  Add one to 'unqualified baby bed days' for daystays       *
.*        V6.04.13  23/01/1998  Davin                                         *
.*                  Only show operation coding as missing if episode = zero   *
.*        V6.04.12  21/01/1998  Davin                                         *
.*                  Really fixed unqualified baby days figures                *
.*        V6.04.11  11/12/1997  Davin                                         *
.*                  Fixed mode of separation (category 'D' error)             *
.*                  Can now exit from sub-option                              *
.*        V6.04.10  19/11/1997  Davin                                         *
.*                  Fixed invalid aboriginality, operation coding errors      *
.*        V6.04.09  23/10/1997  Davin                                         *
.*                  Fixed unqualified baby days figures                       *
.*        V6.04.08  21/07/1997  Greg Horvat                                   *
.*                  Changes for 97/98                                         *
.*        V6.04.07  05/08/97 J.Tan    SRF 621120                              *
.*                  Added a new parameter for referred to on separation       *
.*        V6.04.06  12/05/97 J.Tan    SRF 619888                              *
.*                  Mods to get operation date from operation system          *
.*        V6.04.05  17/01/97 J.Tan    SRF 618600                              *
.*                  Fixed place of occurence                                  *
.*        V6.04.04  17/01/97 J.Tan    SRF 618566                              *
.*                  To use actual adm.date when validating source of referral *
.*        V6.04.03  10/01/97 J.Tan                                            *
.*                  Mods to allow zero unqualified baby bed days for source   *
.*                  of ref.= 0                                                *
.*        V6.04.02  06/01/97 J.Tan    SRF 618477                              *
.*                  Mods to allow zero unqualified baby bed days is DOB=ADATE *
.*        V6.04.01  04/12/96 J.Tan                                            *
.*                  Fixed first psychiatric visit field                       *
.******************************************************************************
.
          INC       STD001FD
.
          INC       IBAPOSFD/INC
          INC       OPRDEAFD/INC
          INC       PATCALAG/INC
          INC       PATCMPFD/INC
          INC       PATCONFD/INC
          INC       PATCODFD/INC
          INC       PATDADFD/INC   
          INC       PATVADFD/INC   
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATFN1FD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       HL7BMTFD/INC
          INC       PATMI1FD/INC
          INC       PATPGRFD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC      * Visit Extension File
          INC       PMSCCDFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PATDHEAD/INC
+
.
.         Transmission file layout
.
.
.
WORK1     FILE      ASCII, FIXED=521
.
.NAME     TYPE    LENGTH    START   DESCRIPTION
.----     ----    ------    -----   -----------
.TRECNO    DIM       5         1   * Sequence Number
.THOSCOD   DIM       4         6   * Hospital Code
.TRURNO    DIM      10        10   * Medical Record Number (U/R No.)
.TMEDINO   DIM      11        20   * Medicare Number
.TSTRNO    DIM       5        31   * Street Number
.TSTRNM    DIM       39       36   * Street Name
.TLOCAL    DIM       40       75   * Locality
.TPOST     DIM       4       115   * Post Code
.TBDATE8   DIM       8       119   * Birthdate (DDMMCCYY)
.TRSEX     DIM       1       127   * Sex
.TCNTRY    DIM       3       128   * Country of Birth
.TRLANG    DIM       2       131   * Language used at home
.TRACE     DIM       1       133   * Race
.TMSTAT    DIM       1       134   * Marital Status
.TREADMN   DIM       1       135   * Re-admission within 28 Days?
.THCOVER   DIM       1       136   * Level of Health Insurance
.TRLEGST   DIM       2       137   * Mental Health Legal Status on admission
.TRADAT8   DIM       8       139   * Admission Date
.TRADMTM   DIM       4       147   * Admission Time
.TREMERG   DIM       1       151   * Emergency Status
.TRCONST   DIM       1       152   * Contract Status
.TRDSCHI   DIM       1       153   * Discharge Intention
.TRSREF    DIM       2       154   * Source of Referral
.TRHREFF   DIM       4       156   * Hospital referred from
.TSUTADM   DIM       2       160   * Service unit type on admission
.TRAMBNO   DIM       6       162   * Ambulance Client Number
.TDDATE8   DIM       8       168   * Date of Separation
.TRSEPTM   DIM       4       176   * Separation Time
.TPSTAT    DIM       2       180   * Patient Status
.TRHRICU   DIM       4       182   * Hours in ICU
.TFINPRG   DIM       1       186   * Financial Program (Public Hosp. only)
.TRLEAVE   DIM       3       187   * Total leave days
.TDSMODE   DIM       2       190   * Separation Mode
.TAREAT    DIM       4       192   * Hospital Transfered to
.TREFTO    DIM       2       196   * Referral To
.TIDUMH    DIM       5       198   * Total involuntary days under MH Act
.TRBWGHT   DIM       4       203   * Birth Weight in grams (if<=29 days)
.TRBDAYS   DIM       1       207   * Unqualified Baby bed days
.TRAPSYC   DIM       1       208   * First admission to a psych.unit
.TYRPSYC   DIM       2       209   * Year of last admission to a psych.unit
.TPSYDAYS  DIM       5       211   * Psych. bed days
TRPENST   DIM       1       216   * Pension Status
.TDVACT    DIM       1       217   * DVA Card Type
.TDVACN    DIM       9       218   * DVA Card Number
.TPRDIAG   DIM       5       227   * Principal Diag.
TLOSDIA   DIM       5       232   * Diagnosis Responsible for Length of Stay.
OTRCOND1   DIM       5       237   * Secondary Diagnosis 1
OTRCOND2   DIM       5       242   * Secondary Diagnosis 2
OTRCOND3   DIM       5       247   * Secondary Diagnosis 3
OTRCOND4   DIM       5       252   * Secondary Diagnosis 4
OTRCOND5   DIM       5       257   * Secondary Diagnosis 5
OTRCOND6   DIM       5       262   * Secondary Diagnosis 6
OTRCOND7   DIM       5       267   * Secondary Diagnosis 7
OTRCOND8   DIM       5       272   * Secondary Diagnosis 8
OTRCOND9   DIM       5       277   * Secondary Diagnosis 9
OTRCON10  DIM       5       282   * Secondary Diagnosis 10
OTRCON11  DIM       5       287   * Secondary Diagnosis 11
OTRCON12  DIM       5       292   * Secondary Diagnosis 12
OTRCON13  DIM       5       297   * Secondary Diagnosis 13
OTRCON14  DIM       5       302   * Secondary Diagnosis 14
OTRCON15  DIM       5       307   * Secondary Diagnosis 15
OTRCON16  DIM       5       312   * Secondary Diagnosis 16
OTRCON17  DIM       5       317   * Secondary Diagnosis 17
OTRCON18  DIM       5       322   * Secondary Diagnosis 18
OTRCON19  DIM       5       327   * Secondary Diagnosis 19
.TPRPROX   DIM       7       332   * Principal Proc.
.TRPPLOC   DIM       1       339   * Principal Procedure Location
.TPRDATE8  DIM       8       340   * Date of principal procedure
.TRPROX1   DIM       7       348   * Other Proc. 1    
.TROLOC1   DIM       1       355   * Other Procedure Location 1
.TRPROX2   DIM       7       356   * Other Proc. 2
.TROLOC2   DIM       1       363   * Other Procedure Location 2
.TRPROX3   DIM       7       364   * Other Proc. 3
.TROLOC3   DIM       1       371   * Other Procedure Location 3
.TRPROX4   DIM       7       372   * Other Proc. 4    
.TROLOC4   DIM       1       379   * Other Procedure Location 4
.TRPROX5   DIM       7       380   * Other Proc. 5
.TROLOC5   DIM       1       387   * Other Procedure Location 5
.TRPROX6   DIM       7       388   * Other Proc. 6
.TROLOC6   DIM       1       395   * Other Procedure Location 6
.TRPROX7   DIM       7       396   * Other Proc. 7    
.TROLOC7   DIM       1       403   * Other Procedure Location 7
.TRPROX8   DIM       7       404   * Other Proc. 8
.TROLOC8   DIM       1       411   * Other Procedure Location 8
.TRPROX9   DIM       7       412   * Other Proc. 9
.TROLOC9   DIM       1       419   * Other Procedure Location 9
.TRPROX10  DIM       7       420   * Other Proc. 10
.TROLOC10  DIM       1       427   * Other Procedure Location 10
.TRPROX11  DIM       7       428   * Other Proc. 11
.TROLOC11  DIM       1       435   * Other Procedure Location 11
.TRPROX12  DIM       7       436   * Other Proc. 12
.TROLOC12  DIM       1       443   * Other Procedure Location 12
.TRPROX13  DIM       7       445   * Other Proc. 13
.TROLOC13  DIM       1       451   * Other Procedure Location 13
.TRPROX14  DIM       7       452   * Other Proc. 14
.TROLOC14  DIM       1       459   * Other Procedure Location 14
.TRPROX15  DIM       7       460   * Other Proc. 15
.TROLOC15  DIM       1       467   * Other Procedure Location 15
.TRPROX16  DIM       7       468   * Other Proc. 16
.TROLOC16  DIM       1       475   * Other Procedure Location 16
.TRPROX17  DIM       7       476   * Other Proc. 17
.TROLOC17  DIM       1       483   * Other Procedure Location 17
.TRPROX18  DIM       7       484   * Other Proc. 18
.TROLOC18  DIM       1       491   * Other Procedure Location 18
.TRPROX19  DIM       7       492   * Other Proc. 19
.TROLOC19  DIM       1       499   * Other Procedure Location 19
.TUPLTHEA  DIM       1       500   * Unplanned visit to theatre
.TPALCARE  DIM       1       501   * Involvement of Palliative Care Team
.TREXTC1   DIM       5       502   * External Cause 1
.TREXTC2   DIM       5       507   * External Cause 2
.TREXTC3   DIM       5       512   * External Cause 3
TRDRG     DIM       3       517   * DRG code
.TRATYPE   DIM       1       520   * Patient Type on admission
.End of Record              521
.
+
WORK2     FILE      ASCII, FIXED=692
.
.NAME     TYPE    LENGTH    START   DESCRIPTION
.----     ----    ------    -----   -----------
TRECNO    DIM       5         1   * Sequence Number
THOSCOD   DIM       4         6   * Hospital Code
TRURNO    DIM      10        10   * Medical Record Number (U/R No.)
TMEDINO   DIM      11        20   * Medicare Number
TFNAME    DIM      25        31   * Patients First Name
TMNAME    DIM      25        56   * Patients Middle Name
TSNAME    DIM      25        81   * Patients Surname
TSTRNO    DIM       5       106   * Street Number
TSTRNM    DIM       39      111   * Street Name
TLOCAL    DIM       40      150   * Locality
TSTATE    DIM       1       190   * State
TPOST     DIM       4       191   * Post Code
TBDATE8   DIM       8       195   * Birthdate (DDMMCCYY)
TRSEX     DIM       1       203   * Sex
TCNTRY    DIM       3       204   * Country of Birth
TRLANG    DIM       2       207   * Language used at home
TRACE     DIM       1       209   * Race
TMSTAT    DIM       1       210   * Marital Status
TREADMN   DIM       1       211   * Re-admission within 28 Days?
THCOVER   DIM       1       212   * Level of Health Insurance
TRLEGST   DIM       2       213   * Mental Health Legal Status on admission
THFUND    DIM       3       215   * Health fund
THFNUM    DIM      24       218   * Health fund membership number
TRADAT8   DIM       8       242   * Admission Date
TRADMTM   DIM       4       250   * Admission Time
TREMERG   DIM       1       254   * Emergency Status
TRCONST   DIM       1       255   * Contract Status
TRDSCHI   DIM       1       256   * Discharge Intention
TRSREF    DIM       2       257   * Source of Referral
TRHREFF   DIM       4       259   * Hospital referred from
TSUTADM   DIM       2       263   * Service unit type on admission
TRAMBNO   DIM       6       265   * Ambulance Client Number
TDDATE8   DIM       8       271   * Date of Separation
TRSEPTM   DIM       4       279   * Separation Time
TPSTAT    DIM       2       283   * Patient Status
TRHRICU   DIM       4       285   * Hours in ICU
TFINPRG   DIM       1       289   * Financial Program (Public Hosp. only)
TRLEAVE   DIM       3       290   * Total leave days
TNLEAVE   DIM       2       293   * Number of leave periods
TDSMODE   DIM       2       295   * Separation Mode
TAREAT    DIM       4       297   * Hospital Transfered to
TREFTO    DIM       2       301   * Referral To
TIDUMH    DIM       5       303   * Total involuntary days under MH Act
TDRGMH    DIM       1       308   * DRG Mental Health Legal status
THRSMV    DIM       4       309   * Total hours on mechanical ventilation
TPHIC     DIM       1       313   * Private health insurance claim
TRBWGHT   DIM       4       314   * Birth Weight in grams (if<=29 days)
TRBDAYS   DIM       1       318   * Unqualified Baby bed days
TRAPSYC   DIM       1       319   * First admission to a psych.unit
TYRPSYC   DIM       2       320   * Year of last admission to a psych.unit
TPSYDAYS  DIM       5       322   * Psych. bed days
TUSUACC   DIM       2       327   * Usual accommodation
TDVACT    DIM       1       329   * DVA Card Type
TDVACN    DIM       9       330   * DVA Card Number
TPRDIAG   DIM       5       339   * Principal Diag.
TRCOND1   DIM       7       344   * Secondary Diagnosis 1
TRCOND2   DIM       7       351   * Secondary Diagnosis 2
TRCOND3   DIM       7       358   * Secondary Diagnosis 3
TRCOND4   DIM       7       365   * Secondary Diagnosis 4
TRCOND5   DIM       7       372   * Secondary Diagnosis 5
TRCOND6   DIM       7       379   * Secondary Diagnosis 6
TRCOND7   DIM       7       386   * Secondary Diagnosis 7
TRCOND8   DIM       7       393   * Secondary Diagnosis 8
TRCOND9   DIM       7       400   * Secondary Diagnosis 9
TRCOND10  DIM       7       407   * Secondary Diagnosis 10
TRCOND11  DIM       7       414   * Secondary Diagnosis 11
TRCOND12  DIM       7       421   * Secondary Diagnosis 12
TRCOND13  DIM       7       428   * Secondary Diagnosis 13
TRCOND14  DIM       7       435   * Secondary Diagnosis 14
TRCOND15  DIM       7       442   * Secondary Diagnosis 15
TRCOND16  DIM       7       449   * Secondary Diagnosis 16
TRCOND17  DIM       7       456   * Secondary Diagnosis 17
TRCOND18  DIM       7       463   * Secondary Diagnosis 18
TRCOND19  DIM       7       470   * Secondary Diagnosis 19
TPRPROX   DIM       7       477   * Principal Proc.
TRPPLOC   DIM       1       484   * Principal Procedure Location
TPRDATE8  DIM       8       485   * Date of principal procedure
TRPROX1   DIM       7       493   * Other Proc. 1
TROLOC1   DIM       1       500   * Other Procedure Location 1
TRPROX2   DIM       7       501   * Other Proc. 2
TROLOC2   DIM       1       508   * Other Procedure Location 2
TRPROX3   DIM       7       509   * Other Proc. 3
TROLOC3   DIM       1       516   * Other Procedure Location 3
TRPROX4   DIM       7       517   * Other Proc. 4
TROLOC4   DIM       1       524   * Other Procedure Location 4
TRPROX5   DIM       7       525   * Other Proc. 5
TROLOC5   DIM       1       532   * Other Procedure Location 5
TRPROX6   DIM       7       533   * Other Proc. 6
TROLOC6   DIM       1       540   * Other Procedure Location 6
TRPROX7   DIM       7       541   * Other Proc. 7
TROLOC7   DIM       1       548   * Other Procedure Location 7
TRPROX8   DIM       7       519   * Other Proc. 8
TROLOC8   DIM       1       556   * Other Procedure Location 8
TRPROX9   DIM       7       557   * Other Proc. 9
TROLOC9   DIM       1       564   * Other Procedure Location 9
TRPROX10  DIM       7       565   * Other Proc. 10
TROLOC10  DIM       1       572   * Other Procedure Location 10
TRPROX11  DIM       7       573   * Other Proc. 11
TROLOC11  DIM       1       580   * Other Procedure Location 11
TRPROX12  DIM       7       581   * Other Proc. 12
TROLOC12  DIM       1       588   * Other Procedure Location 12
TRPROX13  DIM       7       589   * Other Proc. 13
TROLOC13  DIM       1       596   * Other Procedure Location 13
TRPROX14  DIM       7       597   * Other Proc. 14
TROLOC14  DIM       1       604   * Other Procedure Location 14
TRPROX15  DIM       7       605   * Other Proc. 15
TROLOC15  DIM       1       612   * Other Procedure Location 15
TRPROX16  DIM       7       613   * Other Proc. 16
TROLOC16  DIM       1       620   * Other Procedure Location 16
TRPROX17  DIM       7       621   * Other Proc. 17
TROLOC17  DIM       1       628   * Other Procedure Location 17
TRPROX18  DIM       7       629   * Other Proc. 18
TROLOC18  DIM       1       636   * Other Procedure Location 18
TRPROX19  DIM       7       637   * Other Proc. 19
TROLOC19  DIM       1       644   * Other Procedure Location 19
TUPLTHEA  DIM       1       645   * Unplanned visit to theatre
TPALCARE  DIM       1       646   * Involvement of Palliative Care Team
TREXTC1   DIM       5       647   * External Cause 1
TPLOC1    DIM       5       652   * Place of occurence 1
TACCINJ1  DIM       5       657   * Activity when injured 1
TREXTC2   DIM       5       662   * External Cause 1
TPLOC2    DIM       5       667   * Place of occurence 1
TACCINJ2  DIM       5       672   * Activity when injured 1
TREXTC3   DIM       5       677   * External Cause 1
TPLOC3    DIM       5       682   * Place of occurence 1
TACCINJ3  DIM       5       687   * Activity when injured 1
TRATYPE   DIM       1       692   * Service category
.End of Record              692
.
.
.         WORK AREA
.
BABYFLAG  FORM      1
BJDAY     FORM      3
.
CARDTYPE  FORM      1             * concession card type
CALDAYS   FORM      6
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CJDAY     FORM      3
CMDLINE   DIM       100
CMPCNT    FORM      1
CODE      DIM       3 
CODEFLG   FORM      1
CODEIN10  FORM      1                       * Coded in ICD10 ? 0 = No, 1 = Yes
COUNT     FORM      2
CURDATE   DIM       8
.
DRG041    INIT      "041"
DRG042    INIT      "042"
DRG050    INIT      "050"
DRG051    INIT      "051"
DRG052    INIT      "052"
DRG060    INIT      "060"
DRG062    INIT      "062"
DRG070    INIT      "070"
DRGVERS   DIM       3
DATETIME  DIM       14
DIM1A     DIM       1
DIM3      DIM       3
DIM4A     DIM       4
DIM6A     DIM       6
DIM8      DIM       8
DIM20     DIM       20
DISCADMN  FORM      1
DISKNAME  DIM       9                  * (NSW,CFILENO)
DAYCASE   FORM      1
DOYR2009  FORM      1
DVAFLAG   FORM      1                                                  *I-44050
.
EPSCODE   FORM      1                       * Episode coding flag
EPSNO     FORM      2                       * Episode no
EXTFLAG   FORM      1
PLOFLAG   FORM      1
ACTFLAG   FORM      1
.
FILENAME  DIM       8
FNDRECA   FORM      1
FNDRECB   FORM      1
FORM1A    FORM      1
FORM1B    FORM      1
FORM5     FORM      5
FORM8     FORM      8
FORM10    FORM      10
FROMDATE  DIM       8                  * From Date in CCYYMMDD format
FTRLEAVE  FORM      3
FTNLEAVE  FORM      2
FTRBWGHT  FORM      4
FTPSYDAY  FORM      5
.
HIHFOUND  FORM      1
INVPSOS   FORM      1                  * 1=Invalid Pension status on sep
INVTRAP   FORM      1
INVTRPS   FORM      1
.
LEAVDATE  DIM       8
LATSEP    DIM       10
.
MRCNEPSC  FORM      1
OLDATYPE  DIM       3
PAGNNO    FORM      5
PRMFLAG   FORM      1
PUBPRIV   FORM      1                  * 1=Public,2=Private    
.
QUALADOB  FORM      1                       * Qualified after DOB flag
QUALODOB  FORM      1                       * Qualified on DOB flag
.
RETNDATE  DIM       8
STRING    DIM       4
SAVADMN   FORM      8
SAVDATE   DIM       8
STRDATE   DIM       8                  * psychiatric starting date
ENDDATE   DIM       8                  * psychiatric ending date
.
TRBABYS   DIM       1
TPSYFLG   FORM      1                  * flag for psychiatric
TODATE    DIM       8
TRBATCH   DIM       5
TYPC1     DIM       1
USACCODE  DIM       3
USACCAT   DIM       2
USENFILE  FORM      1                  * Using New file layout ?
.                                        0 = No
.                                        1 = Yes
UNQBDAYS  FORM      5
.
.         CONSTANTS
.
CATBT     INIT      "BT"
CATCC     INIT      "CC"
CATP1     INIT      "P1"
CATP2     INIT      "P2"
CATP3     INIT      "P3"
CATP4     INIT      "P4"
CATP5     INIT      "P5"
CATP6     INIT      "P6"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATU8     INIT      "U8"
CATU9     INIT      "U9"
CATU10    INIT      "V1"
CATU11    INIT      "V2"
CATVI     INIT      "VI"
CATCT     INIT      "ct"
.
OYEAR     FORM      "365"
.
ERRDESC   DIM       70
SEPDATE   DIM       10
ERRFND    FORM      1
Z20       INIT      "ZZZZZZZZZZZZZZZZZZZZ"
.
CNTLOC    FORM      1
CNTACT    FORM      1
ECODE     DIM       1
.
PRGID     INIT      "IBABIL55"
PRGNAM    INIT      "NSW Health Dept Transmission"
VERSION   INIT      "V10.10.01"
+
.**********************************************************************
.*                           MAINLINE                                 *
.**********************************************************************
ML0000    CALL      INIT0000                * initialization and open files
ML1000    CALL      OPTN0000                * select options
          BRANCH    OPTION,ML2000,ML2000
          GOTO      ML9999
.
ML2000    CALL      KEYD0000                * Keyin ending date
          BRANCH    EXIT,ML1000
.
ML3000    CALL      FILE0000                * Keyin the filename
          BRANCH    EXIT,ML2000
.
ML4000    CALL      KPPP0000                * Keyin private or public patients
          BRANCH    EXIT,ML1000
.
          CALL      CONTQST                 * Ok to Continue (Y/N/C) ?
          BRANCH    CEXIT,ML5000,ML4000,ML1000
.                         Yes    No     Cancel
.
ML5000    CALL      PROC0000                * Processing discharged patients
          BRANCH    EXIT,ML1000
          CALL      ENDP0000                * End of processing
.
          CALL      MVEXT000                * Move Extract to Web Directory
.
ML9999    CHAIN     PGM
          STOP
+
.******************************************************************************
.*                                  INIT0000                                  *
.*                      Initialization routine                                *
.******************************************************************************
INIT0000  CALL      DISPHEAD
          CALL      IBACLOCK
          DISPLAY   *P56:24,"Opening patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"ibapostf";
          OPEN      IBAPOST1,"ibapostf"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patdadaf";
          OPEN      PATDADA1,"patdadaf"
.
          DISPLAY   *P64:24,"patvadaf";
          OPEN      PATVADA1,"patvadaf"
.
          DISPLAY   *P64:24,"patecdaf";
          OPEN      PATECDA1,"patecdaf"
.
          DISPLAY   *P64:24,"patecoaf";
          OPEN      PATECOA1,"patecoaf"
.
          DISPLAY   *P64:24,"paticuaf";
          OPEN      PATICUA1,"paticuaf"
.
          DISPLAY   *P64:24,"paticddf";
          CALL      OPICD1
.
          DISPLAY   *P64:24,"paticdof";
          CALL      OPICO1
.
          DISPLAY   *P64:24,"patfn1af";
          OPEN      PATFN1A1,"patfn1af"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
          
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patpgraf";
          OPEN      PATPGRA1,"patpgraf"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"pmsccdaf";
          OPEN      PMSCCDA1,"pmsccdaf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"patwvetf";
          OPEN      PATWVET1,"patwvetf"
.
          DISPLAY   *P64:24,"oprdetaf";
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
....      READ      CONTROLF,EIGHTY;*1,HLBMDGUP,HLBMDGUA,HLBMDGMU:
.......                                HLBMDGUU:
....                              *105,HLBMDGAD,HLBMDGDS,HLBMDGTR:
....                                   HLBMDGRG
.
.         Get the Hospital file number
.
          READ      CONTROLF,TEN;*54,CFILENO
          READ      CONTROLF,TEN3;*213,CHCSCOD,*245,CHOSTYP 
          READ      CONTROLF,TEN8;*249,CNXBTCH
          READ      CONTROLF,TWENTY1;*210,PTCNHOSP,*214,PTCNUREA:
                                     *215,PTCNUDIN,PTCNDTRF:
                                     *220,PTNSWHDP,CNSWLOC
          READ      CONTROLF,FIFTY9;*218,PTMORBDT                     *I-206821
          READ      CONTROLF,SIXTY;*133,MRCNEPSC
          READ      CONTROLF,SEVENTY7;*216,PTCNPALC,PTCNFINP
          READ      CONTROLF,SEVENTY9;*82,PTCNDSCI,*114,PTCNPPPT               
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*237,PTCNEMPL,*239,PTCNOCCP:
                    *241,PTCNCSTA
          READ      CONTROLF,NINTY8;*85,PTCNPSOS
          READ      CONTROLF,HUND05;*178,PTCNVETR
          READ      CONTROLF,HUND19;*183,PTCNED41,*191,PTCNED42,*199,PTCNED50:
                                    *207,PTCNED51,*215,PTCNED52,*223,PTCNED60:
                                    *231,PTCNED62,*239,PTCNED70
.
          MOVE      ZERO,EPSCODE            * Epsiode coding flag - no
          IF        MRCNEPSC=1 & PTCNHDPS=2
            MOVE      ONE,EPSCODE           * Epsiode coding flag - yes
          ENDIF
.
          MOVE      CFILENO,THOSCOD         * Hospital code
          PACK      CURDATE WITH CCC,CYY,CMM,CDD
          REP       " 0",CURDATE
.
....      MOVE      PTCNCDVA,DVAFLAG                                   *I-50644
.
INIT9999  RETURN
+
.******************************************************************************
.*                                  OPTN0000                                  *
.*                      Main options                                          *
.******************************************************************************
OPTN0000  READ      CONTROLF,EIGHTY8;*124,CHCSST,*132,CHCSED
          MOVE      ZERO,ERRFND
          MOVE      "60",CLNO
.
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Processing the new Run":
                    *P1:6,*V2LON,TWO,*HOFF," = Re-processing the last Run":
                    *P1:8,"Select Option : ";
.
OPTN1000  KEYIN     *P17:8,*EL,*DV,UNDLN1,*P17:8,*V2LON,OPTION;
.
          COMPARE   ZERO TO OPTION
          GOTO      OPTN9000 IF EQUAL
.
          MOVE      ZERO,EXIT
          BRANCH    OPTION OF OPTN9999,OPTN9999
          BEEP
          GOTO      OPTN1000
.
OPTN9000  MOVE      ONE,EXIT
OPTN9999  RETURN
+
.******************************************************************************
.*                                  KDAT0000                                  *
.*                      Keyin ending date                                     *
.******************************************************************************
KEYD0000  COMPARE   ONE,OPTION
          GOTO      KEYD5000 IF NOT EQUAL
.
          MOVE      "10",CVERT
          DISPLAY   *P1:CVERT,*EL,"Ending Date : ";
          MOVE      "15",CCOL
          UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      ZERO,CHIGHLT
          MOVE      ZERO,CDEFDTE
          CALL      KEYDATE
          BRANCH    OVRCD,KEYD9500
.
          PACK      SAVDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",SAVDATE
.
.        The new ending date should be greater than the Last Ending Date
.
          MATCH     SAVDATE,CHCSED
          GOTO      KEYD1000 IF LESS
.
          UNPACK    CHCSED,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P1:24,*EL,*B,*V2LON,"Ending Date must be greater than ":
                    CPCDATE,".  ";
          CALL      HITENTER
          GOTO      KEYD0000
.
.         Processing a new Run - Starting Date is one day after the previous
.                                Ending Date
.
KEYD1000  MATCH     SP8,CHCSED
          GOTO      KEYD3000 IF EQUAL              * The first time running HDP
.
          UNPACK    CHCSED,XCENT,XYEAR,XMON,XDAY
.
          MOVE      XDAY,DD
          MOVE      XMON,MM
          MOVE      XYEAR,YY
          MOVE      XCENT,CC
          CALL      DMYCON
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
.
.         Update date range in control file
.
          PACK      CHCSST,CC,YY,MM,DD
          REP       " 0",CHCSST
.
KEYD3000  MOVE      SAVDATE,CHCSED
.
.         Set up the todate and fromdate
.
KEYD5000  MOVE      CHCSST,FROMDATE
          REP       " 0",FROMDATE
.
          MOVE      CHCSED,TODATE
          REP       " 0",TODATE
.
.         Check that the start and end dates are valid for icd10 coding
.         date and set the USENFILE parameter accordingly
.
          MOVE      ONE,USENFILE                 * Default to use new file
          MATCH     "20090701",FROMDATE
          IF        @LESS
            MOVE      ZERO,USENFILE
          ENDIF
.
.         Display date range of data
.
KEYD9000  UNPACK    CHCSST,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P53:2,*V2LON,"- ",CPCDATE," to ";
          UNPACK    CHCSED,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *V2LON,CPCDATE;
.
          MOVE      ZERO,EXIT
          GOTO      KEYD9999
.
KEYD9500  MOVE      ONE,EXIT
KEYD9999  RETURN
+
.******************************************************************************
.*                                  FILE0000              Called by: ML0000   *
.*                            Get Extract Filename                            *
.******************************************************************************
FILE0000  MOVE      "12",CVERT
          DISPLAY   *P1:CVERT,*EL,"Extract File Name : ";
FILE1000  
          MOVE      "NSW",KEY3
          UNPACK    TODATE,CCENT,CYEAR,CMON,CDAY
          PACK      FILENAME,KEY3,CDAY,CMON
          KEYIN     *P21:CVERT,*EL,*V2LON,*RV,FILENAME;
.
          ENDSET    FILENAME
          APPEND    SP8,FILENAME
          RESET     FILENAME
.
          CMATCH    EXITCHAR,FILENAME
          GOTO      FILE9500 IF EQUAL       * Exit
.
          MATCH     SP8,FILENAME
          GOTO      FILE9500 IF EQUAL       * Exit
.
          STRIP     FILENAME
          SQUEEZE   FILENAME
          DISPLAY   *P21:CVERT,*EL,*V2LON,*+,FILENAME,".txt";
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WORK2,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,FILE8000          * File doesnt exist
.
          CLOSE     WORK2
.
FILE2000  KEYIN     *P1:24,*B,*EL,"An extraction file with this name":
                    " already exists. Overwrite it (",*V2LON,*DV,ANSY:
                    *HOFF,"/",*V2LON,*DV,ANSN,*HOFF,") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          GOTO      FILE8000 IF EQUAL       * Overwrite file
.
          MATCH     ANSN,ANS
          GOTO      FILE1000 IF EQUAL       * Keyin filename again
.
          BEEP
          GOTO      FILE2000
.
FILE8000  PREP      WORK2,FILENAME
FILE9000  MOVE      ZERO,EXIT
          GOTO      FILE9999
.
FILE9500  MOVE      ONE,EXIT
FILE9999  RETURN
+
.******************************************************************************
.*                                  KPPP0000                                  *
.*                      Keyin Private Or Public Patients                      *
.******************************************************************************
KPPP0000  DISPLAY   *P1:14,*EF,*V2LON,"0",*HOFF," = Exit":
                    *P1:15,*V2LON,"1",*HOFF," = Extract All Patients":
                    *P1:16,*V2LON,"2",*HOFF," = Extract Public Patients":
                    *P1:17,*V2LON,"3",*HOFF," = Extract Private Patients":
                    *P1:19,"Select Option :";
KPPP1000  MOVE      ONE,COPTION
          KEYIN     *P17:19,*V2LON,*DV,UNDLN2,*P17:19,*RV,COPTION;
.
          COMPARE   ZERO,COPTION
          GOTO      KPPP9500 IF EQUAL
.
          BRANCH    COPTION,KPPP9000,KPPP9000,KPPP9000
.                           All      Public   Private
          BEEP
          GOTO      KPPP1000
.
KPPP9000  MOVE      ZERO,EXIT
          GOTO      KPPP9999
.
KPPP9500  MOVE      ONE,EXIT
KPPP9999  RETURN
.
.******************************************************************************
.*                                  PROC0000                                  *
.*                      Processing discharges patients                        *
.******************************************************************************
.        Create the header record for the transmission file
.
PROC0000  MOVE      ZERO,CPAGENO
          UNPACK    TODATE,XCENT,XYEAR,XMON,XDAY
.
          CLOSE     WORK2
          PREP      WORK2,FILENAME
          WRITE     WORK2,SEQ;"HEAD00000",THOSCOD:
                           SP30,SP30,SP30,SP30,SP30,SP10:
                           SP30,SP30,SP20,SP10,SP4
.
.
          DISPLAY   *P1:24,*EL,*P20:24,*V2LON,"** Processing Discharges **",*W:
                    *P20:24,*EL,"Discharged Admission No. : ";
.
          MOVE      ZERO,PAGNNO                  * Record number
          MOVE      ZERO,TRECNO                  * Record number
          MOVE      SP8,TDDATE8
.
          PACK      KEY16,FROMDATE,SP8
          CALL      RDSDSCH2
PROC1000  CALL      RDKDSCH2
          BRANCH    OVRCD OF PROC9000
.
          MATCH     DDATE,TODATE
          GOTO      PROC9000 IF LESS
.
          MOVE      ZERO,BABYFLAG
.
.         Only process the patient discharged in the keyin month
.
          DISPLAY   *P45:24,*V2LON,DADMNO;
          MOVE      DURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF PROC3000
.
.... I-54416 
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,PROC3000 
...  End I
          MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF PROC4000
.
          MOVE      SP1,TCINDC3
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "B",TCINDC3
            GOTO      PROC1000 IF EQUAL
          ENDIF
.
..... I - CAR 54416   Added read of visit and visit extension file 
          MOVE      ZERO,PUBPRIV
          MOVE      SP3,ACODE                   
          MOVE      DAADMNO,KEY8
          CALL      RDPTVIS1 
          BRANCH    OVRCD,PROC1000
          MOVE      DPVIBILL,KEY8
          CALL      RDPMVX11 
          BRANCH    OVRCD,PROC2500
          MOVE      PMVXCADM,ACODE          
          MATCH     SP3,ACODE
          GOTO      PROC1200 IF EQUAL        * blank code
.
          MOVE      SP1,TCINDC2
          PACK      TCODE,ANSV,ANSB          * Cat VB - ind02 Private/Public
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1                  * Read the codes file
          COMPARE   ZERO,OVRCD
          GOTO      PROC1500 IF EQUAL
.
PROC1200  MOVE      "3" TO TCINDC2           * Blank/invalide code
          MOVE      TCINDC2,PUBPRIV
          GOTO      PROC2000

PROC1500  MOVE      TCINDC2,PUBPRIV
.                                            * COPTION = 2 - Public
          IF        COPTION=2
            MATCH     "1",TCINDC2
            GOTO      PROC1000 IF NOT EQUAL  * Not a public patient
          ENDIF
.                                            * COPTION = 3 - Private
          IF        COPTION=3
            MATCH     "2",TCINDC2
            GOTO      PROC1000 IF NOT EQUAL  * Not a private patient
          ENDIF
.... END I-54416
.
PROC2000  MOVE      ZERO,DVAFLAG                              *I-44050  D-50644
          CALL      PYSP0000                 * Payment Status on Sep.  *I-44050
          MATCH     "50",TPSTAT              * is Status "50" for DVA? *I-44050
          GOTO      PROC2500 IF NOT EQUAL                              *I-44050
          MOVE      ONE,DVAFLAG                               *I-44050  D-50644
.
PROC2500  MOVE      SP4,THCSCOD              * Admission Status        *C-44050
          PACK      KEY5,ANSP,SP1,ACLSS
          CALL      RDCODE1
          MOVE      THCSCOD,TREMERG
.
          CALL      CHKC0000                * Check if the patient coded
          BRANCH    CODEFLG,PROC1000
.
          CALL      GDRG0000                * get drg
          MOVE      ZERO,DAYCASE
          MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      ONE,DAYCASE
          ENDIF
          CALL      WRIT0000
.
          GOTO      PROC1000
.
PROC3000  DISPLAY   *P1:22,*B,*EL,"** Discharge ",*V2LON,DADMNO,*HOFF:
                    " has an invalid U/R ",*V2LON,DURNO,*HOFF:
                    "..  Please Contact I.B.A. **";
          GOTO      PROC5000
.
PROC4000  DISPLAY   *P1:22,*B,*EL,"** Discharge ",*V2LON,DADMNO,*HOFF:
                    " has an invalid U/R ",*V2LON,DURNO,*HOFF:
                    "..  Please Contact I.B.A. **";
.
PROC5000  KEYIN     *P1:23,*EL,"(",*V2LON,*DV,ANSS,*HOFF,")kip this record, (":
                           *V2LON,*DV,ANSA,*HOFF,")bort process ? ",*V2LON,ANS;
.
          REP       UPPLOW,ANS
          MATCH     "S" TO ANS
          GOTO      PROC6000 IF EQUAL
          MATCH     "A" TO ANS
          GOTO      PROC7000 IF EQUAL
          BEEP
          GOTO      PROC5000
.
PROC6000  DISPLAY   *P1:22,*EL,*P1:23,*EL;
          GOTO      PROC1000
.
PROC7000  CLOSE     WORK2
          PREP      WORK2,FILENAME
          MOVE      ONE,EXIT
          GOTO      PROC9999
.
PROC9000  MOVE      ZERO,EXIT
PROC9999  RETURN
+
.******************************************************************************
.*                                  CHKC0000              Called by: PROC0000 *
.*                           Check If Patients Coded                          *
.******************************************************************************
CHKC0000  MOVE      ZERO,CODEFLG            * Default to coded
          PACK      KEY13,AADMNO,SP20                                 *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,CHKC1000
.
          COMPARE   AADMNO,PTEDADMN
          GOTO      CHKC9000 IF EQUAL
.
CHKC1000  PACK      KEY13,AADMNO,SP20                                 *C-240107
          CALL      RSPTECO1
CHKC2000  CALL      RKPTECO1
          BRANCH    OVRCD,CHKC3000
.
          COMPARE   AADMNO,PTEOADMN
          GOTO      CHKC3000 IF NOT EQUAL
.
          MATCH     ANSX,PTEOTYPE
          GOTO      CHKC2000 IF EQUAL
          GOTO      CHKC9000
.
CHKC3000  MOVE      ONE,CODEFLG             * Not coded
.
CHKC9000  MOVE      ZERO,EXIT
CHKC9999  RETURN
+
.******************************************************************************
.*                                  WRIT0000              Called by: PROC0000 *
.*                      Write the admission details                           *
.******************************************************************************
WRIT0000  CALL      MSTD0000                * extract master details
          CALL      ADMD0000                * extract admission details
          CALL      DSCD0000                * extract discharged details
          CALL      VIST0000                * check for previous psych.visits
          CALL      TRAN0000                * looping through transaction file
WRIT9999  RETURN
+
.******************************************************************************
.*                                  MSTD0000              Called by: WRIT0000 *
.*                         Extract master details                             *
.******************************************************************************
MSTD0000  MOVE      "0000000000",TRURNO       * U/R Number
          MOVE      PURNO,FORM10
          MOVE      FORM10,TRURNO
          REP       " 0",TRURNO
          MOVE      SP1,DIM1
.
          MOVE      SP30,TSNAME            
          MOVE      SP30,TFNAME
.         
          IF        DVAFLAG = 1                               
            MOVE      PSNAME,TSNAME         * Surname
            MOVE      PGNAME,TFNAME         * First Name 
          ENDIF     
.         
          COMPARE   ONE,PUBPRIV             * 1=Public, 2=Private patients
          GOTO      MSTD0500 IF NOT EQUAL
.                                           * Public Patients
          MOVE      PSNAME,TSNAME           * Surname
          MOVE      PGNAME,TFNAME           * First Name
.
          MATCH     SP2,PTMXMCCD            * C-54416
          IF        @EQUAL
            MOVE      ONE,PTMXMCCD
          ENDIF
          SQUEEZE   PTMXMCCD
          MOVE      PTMXMCCD,DIM1
          MOVE      SP20,TMEDINO            * Medicare Number
          PACK      TMEDINO,PMEDI,DIM1
.
MSTD0500  REP       " 0",TMEDINO
.
.* ****************************************** Start of Changes         *I-49016
.                                           * original code for sex desc. has
.                                           * been deleted & replaced by :-
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXNO,TRSEX
          IF        DSEXNO = 9
            MOVE      ZERO,TRSEX
          ENDIF
.* ******************************************   End of Changes         *I-49016
.
.         Marital Status
.
MSTD1000  MOVE      SIX,TMSTAT
          MATCH     SP3,PMSTAT
          GOTO      MSTD2000 IF EQUAL
.
          PACK      KEY5,ANSM,SP1,PMSTAT
          CALL      RDCODE1
          BRANCH    OVRCD OF MSTD2000
.
          MATCH     SP4,THCSCOD
          GOTO      MSTD2000 IF EQUAL
          MOVE      THCSCOD,TMSTAT          * Marital status
.
MSTD2000  MOVE      SP10,TSTRNO             * Street No.
          PACK      TSTRNM WITH SP20,SP20   * Street Name
          CALL      GETSTR00                * Get street number/name
.
          MOVE      SP20,TLOCAL             * Locality
.
.         Check with indicator whether we are using address line one or
.         address line two as the Locality
.
          MOVE      PSUBRB,TLOCAL           * Using address line 3(suburb)
          BRANCH    CNSWLOC OF MSTD3000
          MOVE      PADD2,TLOCAL            * Using address line 2
.
MSTD3000  MOVE      PPOST,TPOST             * Post Code
.
          MATCH     SP4,PPOST
          IF        @EQUAL
            MOVE      ZERO,TSTATE
            GOTO      MSTD3500
          ENDIF
          MATCH     "2540",PPOST
          IF        @EQUAL
            MOVE      ONE,TSTATE
            GOTO      MSTD3500
          ENDIF
          MATCH     "6798",PPOST
          IF        @EQUAL
            MOVE      NINE,TSTATE
            GOTO      MSTD3500
          ENDIF
          MATCH     "6799",PPOST
          IF        @EQUAL
            MOVE      NINE,TSTATE
            GOTO      MSTD3500
          ENDIF
.
          MOVE      ZERO,TSTATE           
          PACK      KEY56,PPOST,SP70                                  *C-240184
          CALL      RSIBPOS1
MSTD3300  CALL      RKIBPOS1
          IF        OVRCD<>1
            MATCH     PPOST,IBPOPCOD
            GOTO      MSTD3500 IF NOT EQUAL      
            MATCH     "OS ",IBPOSTAT
            GOTO      MSTD3300 IF EQUAL
            MATCH     "NSW",IBPOSTAT
            IF        @EQUAL
              MOVE      ONE,TSTATE
            ENDIF
            MATCH     "VIC",IBPOSTAT
            IF        @EQUAL
              MOVE      TWO,TSTATE
            ENDIF
            MATCH     "QLD",IBPOSTAT
            IF        @EQUAL
              MOVE      THREE,TSTATE
            ENDIF
            MATCH     "SA ",IBPOSTAT
            IF        @EQUAL
              MOVE      FOUR,TSTATE
            ENDIF
            MATCH     "WA ",IBPOSTAT
            IF        @EQUAL
              MOVE      FIVE,TSTATE
            ENDIF
            MATCH     "TAS",IBPOSTAT
            IF        @EQUAL
              MOVE      SIX,TSTATE
            ENDIF
            MATCH     "NT ",IBPOSTAT
            IF        @EQUAL
              MOVE      SEVEN,TSTATE
            ENDIF
            MATCH     "ACT",IBPOSTAT
            IF        @EQUAL
              MOVE      EIGHT,TSTATE
            ENDIF
          ENDIF
.
MSTD3500  MOVE      "99",TRLANG             * Default for language used
          MOVE      SP2,TCODE
          MOVE      SP3,ACODE
.
.....     LOAD      TCODE,CNSWLNG,CATP1,CATP2,CATP3,CATU1,CATU2:
....                              CATP4,CATP5,CATP6
....      LOAD      ACODE,CNSWLNG,PUSR1,PUSR2,PUSR3,AUSR1,AUSR2:
....                              PUSR4,PUSR5,PUSR6
.
          MOVE      PMPXLNG1,ACODE          
          MATCH     SP3,ACODE
          GOTO      MSTD4000 IF EQUAL
.
          PACK      KEY5 WITH ANSL,ANSA,ACODE    * Check for a valid code
          CALL      RDCODE1
          BRANCH    OVRCD OF MSTD4000
.
          MOVE      ZERO,FORM2
          MATCH     SP4,THCSCOD
          GOTO      MSTD4000 IF EQUAL
          MOVE      THCSCOD,TRLANG
          REP       " 0",TRLANG
.
MSTD4000  MOVE      "999",TCNTRY            * Country of Birth
          PACK      KEY5,ANSC,SP1,PCONT
          CALL      RDCODE1
          BRANCH    OVRCD OF MSTD5000
.
          MATCH     SP4,THCSCOD
          GOTO      MSTD5000 IF EQUAL
          MOVE      THCSCOD,TCNTRY
.
MSTD5000  MOVE      "4",TRACE               * Race default = 4
          PACK      TCODE,ANSV,ANSA
          MOVE      SP3,ACODE
.
....      LOAD      TCODE,PNSWRACE,CATP1,CATP2,CATP3,CATP4,CATP5,CATP6:
....                               CATU1,CATU2,CATU3,CATU4,CATU5,CATU6:
....                               CATU7,CATU8,CATU9,CATU10,CATU11
....      LOAD      ACODE,PNSWRACE,PUSR1,PUSR2,PUSR3,PUSR4,PUSR5,PUSR6:
....                               AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
....                               AUSR7,PTMIUS08,PTMIUS09,PTMIUS10,PTMIUS11 
.
          MOVE      PMPXABRG,ACODE
          MATCH     SP3,ACODE
          GOTO      MSTD6000 IF EQUAL
.
          PACK      KEY5 WITH TCODE,ACODE   * Check for a valid code
          CALL      RDCODE1
          BRANCH    OVRCD OF MSTD6000
.
          MATCH     SP4,THCSCOD
          GOTO      MSTD6000 IF EQUAL
          MOVE      THCSCOD,TRACE
.
MSTD6000  UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          UNPACK    XCENT,DIM1,KEY1
          PACK      TBDATE8,XDAY,XMON,XCENT,XYEAR * Birth date DDMMCCYY
          REP       " 0",TBDATE8
.
MSTD9999  RETURN
.
.******************************************************************************
.*                                  ADMD0000              Called by: PROC0000 *
.*                         Extract admissions details                         *
.******************************************************************************
ADMD0000  MOVE      SP2,TRSREF              * Source of Referral
          MOVE      SP4,THCSCOD             * 2nd chars of Source referral
          MOVE      SP10,TRHREFF
          MOVE      SP10,TDVACN
          PACK      KEY5,ANSS,SP1,ASRCE
          CALL      RDCODE1
          UNPACK    THCSCOD,TRCONST,TRSREF   
.
          MOVE      TRSREF,STRING
          CALL      RMBL0000
          MOVE      STRING,FORM2
          MOVE      FORM2,TRSREF
          REP       " 0",TRSREF
.
          MATCH     "00",TRSREF
          IF        @EQUAL
            MOVE      ONE,BABYFLAG
          ENDIF
.
          IF        FORM2=4 | FORM2=5
            PACK      KEY8,AADMNO
            CALL      RDPTDAD1              * read adm.transfer source
            IF        OVRCD<>1
              PACK      KEY5,PTDAADTS,SP70
              CALL      RDPTVAD1
              IF        OVRCD=1
                MOVE      PTDAADTS,TRHREFF
              ELSE 
                MATCH     SP70,PTVANHSC
                IF        !@EQUAL
                  MOVE      PTVANHSC,TRHREFF      * Valid transfer source
                ELSE
                  MOVE      PTVACODE,TRHREFF      * Valid transfer source
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      TRADAT8,XDAY,XMON,XCENT,XYEAR  * Admission Date
          REP       " 0",TRADAT8
.
          UNPACK    ATIME,XHOUR,ANS,XMIN
          PACK      TRADMTM,XHOUR,XMIN      * Admission Time
          REP       " 0",TRADMTM
.
          MOVE      SP2,TPSTAT              * Patient status
          MOVE      SP4,THCSCOD
.
          PACK      KEY5,ANSC,ANSL,ACLAIM                  
          CALL      RDCODE1
.
ADMD5000  MOVE      ZERO,FORM2               * DVA Card type
ADMD5500  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      ADMD5800 IF EQUAL
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "V",ANS
          GOTO      ADMD5800 IF EQUAL
.
          GOTO      ADMD5500
.
ADMD5800  MOVE      SP10,ACODE              * Determine which user defined field
          MOVE      ZERO,FORM1
          UNPACK    SP2,DIM1,DIM1A
          MOVE      SP1,TDVACT
          MOVE      SP70,TDVACN
.
.         Set DVA Number using concession card, if one exists
.
          MOVE      THREE,CARDTYPE               * set for DVA card type
          CALL      CONCD000                     * DVA conc card ?
          IF        EXIT=1
            MOVE      SP70,DIM20                 * no DAV card exist
          ENDIF
.
          MOVE      DIM20,TDVACN                 * DVA number
.
.         There was a DVA concession card, so we need to check to see
.         if a DVA Card Colour was also present
.
          MATCH     SP3,PMCDDVAC                 * DVA Card Colour blank ?
          GOTO      ADMD6000 IF EQUAL
.
          MOVE      PMCDDVAC,ACODE
          PACK      KEY5,ANSD,ANSX,ACODE
          CALL      RDCODE1
          IF        OVRCD = 0
            PACK      TDVACT,THCSCOD
          ENDIF
.
ADMD6000  BRANCH    DVAFLAG,ADMD6100        * DVA patient              *I-44050
          COMPARE   TWO,PUBPRIV             * select Private patient
          IF        @EQUAL
            MOVE      SP8,TDVACT
            MOVE      SP10,TDVACN
          ENDIF
.
ADMD6100  COMPARE   ONE,PUBPRIV                           * add label  *C-44050
          IF        @EQUAL
            MOVE      "5",THCOVER           * Public defaults to 5
          ELSE
            MOVE      "0",THCOVER           * Private defaults to 0
          ENDIF
.
          MOVE      SP10,THFUND
          MOVE      SP30,THFNUM
          MOVE      SP4,HFHDPE              * Level of Health Insurance
          PACK      KEY14,AFUNDH,AFNDTB     * get HDP Equiv. for patient
          CALL      RDFUND1
          BRANCH    OVRCD,ADMD7000          * no record so leave default
.
          UNPACK    HFHDPE,ANS,THCOVER    * New file use the 2st char of HDP
          CMATCH    SP1,THCOVER
          IF        @EQUAL
            MOVE      "9",THCOVER         * New file defaults to 9
          ENDIF
.
.         Discharge intention
.
ADMD7000  MOVE      SP4,THCSCOD
....      IF        PTCNDSCI=0
....        MOVE      "P ",TCODE
....        MOVE      ACLSS,ACODE
....      ELSE
....        PACK      TCODE,ANSU,PTCNDSCI
....        LOAD      ACODE,PTCNDSCI,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5
....      ENDIF
          PACK      TCODE,ANSV,ANSI               * I-54416  CAT VI
          MOVE      PMVXIDUS,ACODE                * I-54416
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      THCSCOD,TRDSCHI
          ENDIF
.
.
.         Usual Accommodation
.
.
....      LOAD      USACCODE,PTCNUSAC,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7,PTMIUS08,PTMIUS09,PTMIUS10,PTMIUS11
.
....      LOAD      USACCAT,PTCNUSAC,CATU1,CATU2,CATU3,CATU4,CATU5,CATU6,CATU7,CATU8,CATU9,CATU10,CATU11
.
          MOVE      SP3,TUSUACC
          MOVE      PMVXUSAC,USACCODE
          MATCH     SP3,USACCODE
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSP,USACCODE
            CALL      RDCODE1               * Read the codes file
            IF        OVRCD<>1
              MOVE      THCSCOD,TUSUACC     * Usual accomodation 
            ENDIF
          ENDIF
.
.
.         Unplanned visit to theatre
.
          MOVE      SP4,THCSCOD
.....     LOAD      CODE,PTCNUVTH,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7
....      PACK      KEY5,ANSU,PTCNUVTH,CODE
          PACK      KEY5,ANSK,ANSB,PMVXUVTH       * C-54416
          CALL      RDCODE1
          MOVE      THCSCOD,TUPLTHEA
.
.         Involvement of Palliative Care Team
.
          MOVE      SP4,THCSCOD
          MOVE      "2",TPALCARE            * default to 2
....      LOAD      CODE,PTCNPALC,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7
....      PACK      KEY5,ANSU,PTCNPALC,CODE
          PACK      KEY5,ANSK,ANSG,PMVXPALC    * I-54416   CAT KG
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP4,THCSCOD
            IF        !@EQUAL
              UNPACK    THCSCOD,TPALCARE
            ENDIF
          ENDIF
.
.... I-
          MOVE      SP2,TSUTADM            * Service unit type on admission
.                                           * 0=Private, 1=Public Hospital
.         IF        PTCNHOSP=1
.           UNPACK    SP5,TCODE,ACODE
.           LOAD      TCODE,PTCNASUT,CATU1,CATU2,CATU3,CATU4,CATU5,CATCC
.           LOAD      ACODE,PTCNASUT,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,ACARE
.           MATCH     SP3,ACODE
.           IF        !@EQUAL
.             PACK      KEY5,TCODE,ACODE
.             CALL      RDCODE1
.             IF        OVRCD<>1
.               MOVE      THCSCOD,TSUTADM
.               MOVE      TSUTADM,STRING
.               CALL      RMBL0000
.               MOVE      STRING,FORM2
.               MOVE      FORM2,TSUTADM
.               REP       " 0",TSUTADM      * Service unit type on admission
.             ENDIF
.           ENDIF
.         ENDIF
.
ADMD9999  RETURN
+
.******************************************************************************
.*                                  DSCD0000              Called by: PROC0000 *
.*                            Extract discharged details                      *
.******************************************************************************
DSCD0000  UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY   * Separation Date
          PACK      TDDATE8,XDAY,XMON,XCENT,XYEAR
          REP       " 0",TDDATE8
.
          UNPACK    DTIME,XHOUR,ANS,XMIN
          PACK      TRSEPTM,XHOUR,XMIN       * Separation Time
          REP       " 0",TRSEPTM
.
          MOVE      SP1,TFINPRG
          COMPARE   ONE,PTCNHOSP            * Public hospital ?
          GOTO      DSCD0200 IF NOT EQUAL   * no.
.
....      LOAD      CODE,PTCNFINP,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
          MOVE      PMVXFINP,CODE           * C-54416   CAT KE
          PACK      KEY5,ANSK,ANSE,CODE     * C-54416
          CALL      RDCODE1
          IF        OVRCD<>1 & PTCNHOSP=1
            MOVE      THCSCOD,TFINPRG
          ENDIF
.
.                                           * Payment status on separation
.* ****************************************** Code moved to PYSP0000   *C-44050
DSCD0200  CALL      PYSP0000     
.
DSCD0500  MOVE      SP2,TREFTO              * Referral To
          MOVE      "00",TDSMODE            * Separation Mode/In area trans
          MOVE      SP4,TAREAT
.
.         Get TAREAT from PTDADCTS on PATDADFD
.
          MOVE      SP5,PTDADCTS             * Initialize
          PACK      KEY8,AADMNO
          CALL      RDPTDAD1                 * Read PATDADFD
.
          IF        PTCNDTRF = 1
            PACK      KEY5,ANSD,SP1,DSTAT
            CALL      RDCODE1
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST
            CALL      RDCODE1
          ENDIF
          MATCH     "1",TCINDC2
          GOTO      DSCD0800 IF NOT EQUAL
.
          PACK      KEY5,PTDADCTS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            GOTO     DSCD0800
          ENDIF
          MATCH     SP70,PTVANHSC
          IF        !@EQUAL
            MOVE      PTVANHSC,TAREAT       * Valid transfer source
          ELSE
            MOVE      PTVACODE,TAREAT       * Valid transfer source
          ENDIF
DSCD0800  BRANCH    PTNSWHDP,DSCD1000
.
.         Use Category "DD"
.
          MATCH     SP3,DDEST
          GOTO      DSCD2000 IF EQUAL
.
          PACK      KEY5,ANSD,ANSD,DDEST
          CALL      RDCODE1
          BRANCH    OVRCD OF DSCD2000
.
          MATCH     SP4,THCSCOD
          GOTO      DSCD2000 IF EQUAL
          GOTO      DSCD1200
.
.         Use Category "D "
.
DSCD1000  MATCH     SP3,DSTAT
          GOTO      DSCD2000 IF EQUAL
.
          PACK      KEY5,ANSD,SP1,DSTAT
          CALL      RDCODE1
          BRANCH    OVRCD OF DSCD2000
.
          MATCH     SP4,THCSCOD
          GOTO      DSCD2000 IF EQUAL
.
DSCD1200  UNPACK    THCSCOD,TDSMODE
.
          MOVE      TDSMODE,STRING
          CALL      RMBL0000
          MOVE      STRING,FORM2
          MOVE      FORM2,TDSMODE
          REP       " 0",TDSMODE
.
DSCD2000  IF        PTNSWHDP = 1
            PACK      KEY5,ANSD,ANSD,DDEST
            CALL      RDCODE1
          ELSE
            PACK      KEY5,ANSD,SP1,DSTAT
            CALL      RDCODE1
          ENDIF
          MATCH     SP4,THCSCOD
          GOTO      DSCD2200 IF EQUAL
.
          UNPACK    THCSCOD,TREFTO
.                                           * 0=Private, 1=Public Hospital
          IF        PTCNHOSP=1
            MOVE      TREFTO,STRING
            CALL      RMBL0000
            MOVE      STRING,FORM2
            MOVE      FORM2,TREFTO
            REP       " 0",TREFTO
          ELSE
            MOVE      SP2,TREFTO
          ENDIF
          REP       " 0",TREFTO
.
DSCD2200  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      CALCAGE
.
          MOVE      ZERO,FTRBWGHT
          MATCH     SP6,ABWGHT
          GOTO      DSCD2400 IF EQUAL
.
          MATCH     "     0",ABWGHT
          GOTO      DSCD2400 IF EQUAL
.
          UNPACK    ABWGHT,DIM2,STRING
          CALL      RMBL0000
          MOVE      STRING,FTRBWGHT
.
DSCD2400  COMPARE   "29",PSAGEDAY
          GOTO      DSCD3000 IF LESS
          GOTO      DSCD3000 IF EQUAL
          MOVE      ZERO,FTRBWGHT
.
DSCD3000  MOVE      SP4,TRHRICU            
          MOVE      SP6,TRAMBNO             
          MOVE      SP4,THRSMV
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          BRANCH    OVRCD,DSCD4000
          MOVE      PTICUMEC,FORM4          * (form 5 to form 4)
          MOVE      FORM4,THRSMV            * hours on mechanical ventilation
          MOVE      PTICUINT,FORM4          * (form 5 to form 4)
          MOVE      FORM4,TRHRICU
          REP       " 0",TRHRICU
          MOVE      SP6,DIM6A
          MOVE      ZERO,FORM1A
          MOVE      SIX,FORM1B
          STRIP     PTICAMBN
          MOVELPTR  PTICAMBN,FORM1A
          ASSIGN    (FORM1B-FORM1A),FORM1B
          LOAD      DIM6A,FORM1B,SP1,SP2,SP3,SP4,SP5,SP6
          PACK      DIM6A,DIM6A,PTICAMBN,SP10 
          RESET     DIM6A
.
          MOVE      DIM6A,TRAMBNO
DSCD4000  REP       " 0",TRAMBNO
          MOVE      SP1,TRPENST             * Pension Status
          LOAD      CODE,PTCNPSOS,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
          PACK      KEY5,ANSD,PTCNPSOS,CODE
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      THCSCOD,TRPENST
          ENDIF
.
DSCD9999  RETURN
+
.* ****************************************** Start of Addition        *I-44050
.******************************************************************************
.  PYSP0000  - get Payment Status on Separation       Called By MSTR0000
.                                                               DSCD0200
.                ( Code moved from DSCD0200 - CAR 44050 )
.******************************************************************************
.                                           * Payment status on separation
PYSP0000  COMPARE   ONE,PUBPRIV
          IF        @EQUAL
            MOVE      "20",TPSTAT           * Public defaults to 20
          ELSE
            MOVE      "30",TPSTAT           * Private defaults to 30
          ENDIF
.
          MOVE      ZERO,FORM2
....      LOAD      CODE,PTCNPYSP,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
          MOVE      PMVXPYSP,CODE
          MATCH     SP3,CODE
          GOTO      PYSP9999 IF EQUAL            * 229945
          PACK      KEY5,ANSK,ANSK,CODE
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      THCSCOD,TPSTAT
            MOVE      TPSTAT,STRING
            CALL      RMBL0000
            MOVE      STRING,FORM2
            MOVE      FORM2,TPSTAT
            REP       " 0",TPSTAT
          ENDIF
.
PYSP9999  RETURN
.* ******************************************   End of Addition        *I-44050
+
.******************************************************************************
.  RMBL - Remove trailing and leading blanks          Called By lots
.        Requires - STRING   (input string)
.        Returns  - STRING   (output string without blanks)
.******************************************************************************
.
.---- remove trailing blanks ----
.
RMBL0000  PACK      STRING,STRING,SP20      * Ensure string filled to end
          ENDSET    STRING                  * Move form ptr to end of string
.
RMBL1000  CMATCH    SP1,STRING              * Quit loop if char pointed to by
          GOTO      RMBL2000 IF NOT EQUAL   *    form pointer is blank
.
          BUMP      STRING,-1               * Decrement form pointer
          GOTO      RMBL1000 IF NOT EOS     * Quit loop if form ptr = 1
.
          SETLPTR   STRING,ZERO             * Set form and length pointers to 0
          GOTO      RMBL9999                *    since we are at start of string
.                                           *    and exit routine
.
RMBL2000  LENSET    STRING                  * Set length pointer to form pointer
          RESET     STRING                  * Set form pointer to one
.
.---- remove leading blanks ----
.
RMBL3000  CMATCH    SP1,STRING              * Quit loop if char pointed to by
          GOTO      RMBL9999 IF NOT EQUAL   *    form pointer is blank
.
          BUMP      STRING,1                * Increment form pointer
          GOTO      RMBL3000 IF NOT EOS     * Quit loop if form ptr = eos
.
          SETLPTR   STRING,ZERO             * Set form and length pointers to 0
          GOTO      RMBL9999                *    since we are at start of string
.                                           *    and exit routine
RMBL9999  RETURN
+
.******************************************************************************
.*                                  VIST0000              Called by: PROC0000 *
.*                   Check for previous psychiatric visits                    *
.******************************************************************************
VIST0000  MOVE      AADMNO,SAVADMN
          MOVE      SP1,TRAPSYC           * Default to 9 for first adm.to psych.
          MOVE      SP10,TYRPSYC          * Year of last adm.to a psych.unit
.
          MOVE      AURNO,PVIURNO
          PACK      PVIDATE,ADATE
          REP       " 0",PVIDATE
          PACK      KEY24,PVIURNO,PVIDATE,Z20
          CALL      RDSVISA2
VIST1000  CALL      RDPVISA2
          BRANCH    OVRCD,VIST3000
.
          MATCH     AURNO,PVIURNO           * Same U/R number ?
          GOTO      VIST3000 IF NOT EQUAL
.
          COMPARE   PVIBILL,SAVADMN
          GOTO      VIST1000 IF EQUAL
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VIST1000
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1
          CMATCH    ANSP,TCINDC3            * 3rd indicator a "P" ?
          IF        OVRCD = 0 & @EQUAL
            MOVE      "2",TRAPSYC           * no to first visit
            UNPACK    PVIDATE,XCENT,TYRPSYC * Year of last adm.to a psych.unit
            GOTO      VIST3000
          ENDIF
          GOTO      VIST1000
.
VIST3000  MOVE      SAVADMN,KEY8
          CALL      RDMISS1
.
VIST9999  RETURN
+
.******************************************************************************
.*                                  TRAN0000              Called by: PROC0000 *
.*                           Extract bed days                                 *
.******************************************************************************
. get Patient Type and change of Patient Type
.
TRAN0000  MOVE      SP1,TRATYPE             * Patient Type on admission
          MOVE      ZERO,FNDRECA            * found rec "A" flag
          MOVE      ZERO,FNDRECB            * found 1st change flag
          MOVE      SP8,LEAVDATE            * Leave Date
          MOVE      SP8,RETNDATE            * Return Date
          MOVE      SP1,TRBABYS
          MOVE      ZERO,TPSYFLG
          MOVE      SP10,STRDATE            * psychiatric starting date
          MOVE      SP10,ENDDATE            * psychiatric ending date
          MOVE      ZERO,FTPSYDAY           * psychiatric bed days
          MOVE      ZERO,FTRLEAVE           * leave days
          MOVE      ZERO,FTNLEAVE           * number of leave periods
          MOVE      ZERO,TRBDAYS            * unqualified baby bed days
          UNPACK    SP20,TPRDATE8           * Date of principal procedure
          MOVE      "19",TRLEGST            * Legal status
          MOVE      ZERO,EPSNO              * Epsiode no
          CALL      CIQB0000                * Check if qualified baby
          MOVE      ZERO,TRBDAYS            * unqualified baby bed days
          MOVE      ZERO,UNQBDAYS           * unqualified baby bed days in FORM2
          MOVE      SP8,STDATE
.
          PACK      KEY30,AADMNO,SP20,SP10
          CALL      RDSTRAN2
TRAN1000  CALL      RDKTRAN2 
          BRANCH    OVRCD,TRAN5000
.
          COMPARE   AADMNO,TADMN            * same Admission No. ?
          GOTO      TRAN5000 IF NOT EQUAL
.
          IF        BABYFLAG=1
            CALL      BDAY0000              * Yes,Calc.unqualified baby bed days
          ENDIF
.
          MOVE      SP1,DIM1
          MOVE      SP4,THCSCOD
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          UNPACK    THCSCOD,KEY1,TRBABYS,DIM2
.... I - 54416 MH legal status from CAT LS
          MOVE      PMVXMHLS,DIM3
          MATCH     SP3,DIM3
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSS,PMVXMHLS
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      THCSCOD,TRLEGST
            ENDIF
          ENDIF
.... End I
...       MATCH     SP2,DIM2
...       IF        !@EQUAL
...         MOVE      DIM2,TRLEGST          * legal status
...         REP       " 0",TRLEGST
...       ENDIF
.
          COMPARE   ONE,BABYFLAG            * Born in hospital ?
          GOTO      TRAN1100 IF NOT EQUAL
.
          MATCH     "2",TRBABYS
          IF        @EQUAL
            MOVE      TDATE,STDATE        * Save the change date
          ENDIF
.
          COMPARE   ZERO,EPSNO
          GOTO      TRAN1100 IF EQUAL
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      KEY5,CATBT,WEFRBT
            CALL      RDCODE1
            MATCH     ANSQ,TCINDC5
            IF        @EQUAL
              MOVE      SP8,STDATE
            ELSE
              MOVE      TDATE,STDATE
            ENDIF
          ENDIF
.
TRAN1100  MATCH     "D",TMOVE               * discharge ?
          GOTO      TRAN1200 IF NOT EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY   * Discharge Date
          PACK      TDDATE8,CDAY,CMON,CCENT,CYEAR
          REP       " 0",TDDATE8
.
          UNPACK    DTIME,XHOUR,ANS,XMIN
          PACK      TRSEPTM,XHOUR,XMIN       * Separation Time
          REP       " 0",TRSEPTM
.
          ADD       ONE,EPSNO               * Increment the epsiode no
          GOTO      TRAN5000
.
TRAN1200  MATCH     "L",TMOVE               * Leave ? If so get Leave Date
          GOTO      TRAN1400 IF NOT EQUAL
.
          PACK      LEAVDATE,TDATE
          REP       " 0",LEAVDATE
.
TRAN1400  MATCH     "R",TMOVE               * Leave Return ? if so get date
          GOTO      TRAN1600 IF NOT EQUAL
.
          PACK      RETNDATE,TDATE
          REP       " 0",RETNDATE
          CALL      LEAV0000                * Calculate no of days leave
.
TRAN1600  BRANCH    FNDRECA,TRAN3000        * already got the "A" record
          MATCH     "A",TMOVE               * admission
          GOTO      TRAN1000 IF NOT EQUAL
.
TRAN2000  MOVE      SP4,THCSCOD
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          CMATCH    ANSP,TCINDC3            * 3rd indicator a "P" ?
          IF        OVRCD = 0 & @EQUAL
            MOVE      ONE,TPSYFLG           * set indicator for psychiatric
            MOVE      TDATE,STRDATE         * set start date for psychiatric
          ENDIF
          MOVE      THCSCOD,TRATYPE         * Patient Type on admission
          MOVE      TATYPE,OLDATYPE         * save Patient Type
          MOVE      ONE,FNDRECA             * found rec "A" flag
.
          MOVE      SP4,THCSCOD
          MOVE      DTADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,TRAN2900
.         MOVE      PMVXREAD,CODE           * 147529
          MOVE      PMVXUREA,CODE
          MATCH     SP3,PMVXUREA
          IF        @EQUAL
            MOVE      "1",TREADMN
            GOTO      TRAN1000
          ENDIF
.         PACK      KEY5,ANSK,ANSM,CODE     * 147529
          PACK      KEY5,ANSK,ANSO,CODE
          CALL      RDCODE1
TRAN2900  MOVE      THCSCOD,TREADMN
......    REP       "81231232",TREADMN
.
          GOTO      TRAN1000                * go and get next record
.
. now get the 1st change in Admission Type
.
TRAN3000  BRANCH    QUALODOB,TRAN1000       * Qualified on DOB, dont write
.
          MATCH     TATYPE,OLDATYPE         * change in Admission Type ?
          GOTO      TRAN1000 IF EQUAL       * no change
.
          BRANCH    FNDRECB,TRAN3400        * already got the 1st change ?
.
.         If this is the Admission Date, then just treat this as being the
.         Admission Type at admission
.
          MATCH     TDATE,ADATE             * change on Admission Date ?
          GOTO      TRAN2000 IF EQUAL       * yes, assume a correction
          CALL      PSYC0000                * psychiatric bed days
          MOVE      TATYPE,OLDATYPE         * save new Admission Type
.
          MATCH     TRBABYS,SP1              
          GOTO      TRAN3200 IF EQUAL       * don't check for change 
.
.      we have a diff. Admission Type so check for a change on HDP Equivalent
.
TRAN3200  MOVE      SP4,THCSCOD
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          MATCH     TRATYPE,THCSCOD         * change in HDP Equiv. ?
          GOTO      TRAN4000 IF NOT EQUAL       * no change
.
          MOVE      THCSCOD,TYPC1
          MOVE      ONE,FNDRECB             * found 1st change flag
          GOTO      TRAN1000                * go and get next record
.         
. now get the 2nd change in Admission Type
.
TRAN3400  CALL      PSYC0000                * psychiatric bed days
          MOVE      TATYPE,OLDATYPE         * save new Admission Type
.
.      we have a diff Adm Type so check for a change on HDP Equiv
.
          MOVE      SP4,THCSCOD
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          MATCH     TYPC1,THCSCOD           * change in HDP Equiv. ?
          GOTO      TRAN1000 IF EQUAL       * no change
.
.      we have a change in HDP treat as disch & re-adm
.
TRAN4000  COMPARE   ONE,QUALADOB
          GOTO      TRAN4500 IF NOT EQUAL   * Not qualified after DOB
.
          MATCH     "2",TRBABYS
          GOTO      TRAN1000 IF NOT EQUAL   * Not the unqualified admin type
.
TRAN4500  ADD       ONE,EPSNO               * Increment the epsiode no
.
          MOVE      "09",TDSMODE            * hardcoded as per NSWHDP (4/2/98)
          MOVE      SP3,TREFTO
.
          MOVE      SP8,TDDATE8   * separation date = date of change of Adm Type
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY   * reformat date
          PACK      TDDATE8,CDAY,CMON,CCENT,CYEAR  * required format
          REP       " 0",TDDATE8
.
          UNPACK    TTIME,XHOUR,ANS,XMIN
          PACK      TRSEPTM,XHOUR,XMIN       * Separation Time
          REP       " 0",TRSEPTM
.
          UNPACK    SP10,TPRDIAG,TLOSDIA
          UNPACK    SP30,TRCOND1,TRCOND2,TRCOND3:     * diagnosis codes
                         TRCOND4,TRCOND5,TRCOND6
          UNPACK    SP30,TRCOND7,TRCOND8,TRCOND9:
                         TRCOND10,TRCOND11,TRCOND12
          UNPACK    SP30,TRCOND13,TRCOND14,TRCOND15
          UNPACK    SP30,TRCOND16,TRCOND17,TRCOND18,TRCOND19
          UNPACK    SP30,OTRCOND1,OTRCOND2,OTRCOND3:     * diagnosis codes
                         OTRCOND4,OTRCOND5,OTRCOND6
          UNPACK    SP30,OTRCOND7,OTRCOND8,OTRCOND9:
                         OTRCON10,OTRCON11,OTRCON12
          UNPACK    SP30,OTRCON13,OTRCON14,OTRCON15
          UNPACK    SP30,OTRCON16,OTRCON17,OTRCON18,OTRCON19
          MOVE      SP10,TREXTC1
          MOVE      SP10,TREXTC1
          MOVE      SP10,TREXTC2
          MOVE      SP10,TREXTC3
          MOVE      SP10,TPLOC1
          MOVE      SP10,TACCINJ1
          MOVE      SP10,TPLOC2
          MOVE      SP10,TACCINJ2
          MOVE      SP10,TPLOC3
          MOVE      SP10,TACCINJ3
.
          UNPACK    SP20,TPRDATE8      * Date of principal procedure
          UNPACK    SP30,TRPPLOC,TPRPROX
.
          UNPACK    SP30,TRPROX1,TRPROX2,TRPROX3:     * procedure codes
                         TRPROX4
          UNPACK    SP30,TRPROX5,TRPROX6,TRPROX7:     * procedure codes
                         TRPROX8
          UNPACK    SP30,TRPROX9,TRPROX10,TRPROX11:
                         TRPROX12
          UNPACK    SP30,TRPROX13,TRPROX14,TRPROX15:
                         TRPROX16
          UNPACK    SP30,TRPROX17,TRPROX18,TRPROX19
.
. ------- operation locations
.
          UNPACK    SP10,TROLOC1,TROLOC2,TROLOC3,TROLOC4,TROLOC5:
                         TROLOC6,TROLOC7,TROLOC8,TROLOC9,TROLOC10
          UNPACK    SP10,TROLOC11,TROLOC12,TROLOC13,TROLOC14,TROLOC15:
                         TROLOC16,TROLOC17,TROLOC18,TROLOC19
.
          MOVE      ONE,DISCADMN                 * discharge & admission flag
          GOTO      TRAN6000                     * go and write to file
.
TRAN5000  MOVE      ZERO,DISCADMN                * discharge & admission flag
.
. calculate no. of leave days
.
TRAN6000  MATCH     SP8,LEAVDATE                 * Leave Date blank?
          GOTO      TRAN7000 IF EQUAL
          MATCH     SP8,RETNDATE                 * Return Date blank?
          GOTO      TRAN7000 IF EQUAL
          CALL      LEAV0000                     * Calculate no of days leave
.
.         check if patient was psychiatric
.
TRAN7000  IF       TPSYFLG = 1
            MOVE      TDATE,ENDDATE             * set the ending date
            CALL      CALC0000                  * calculate the dates difference
            ADD       CALDAYS,FTPSYDAY
            IF        FTPSYDAY>0
              SUB       FTRLEAVE,FTPSYDAY
            ENDIF
.
            MATCH     "D",TMOVE
            IF        @EQUAL
              COMPARE   ONE,DAYCASE
              IF        @EQUAL
                ADD       ONE,FTPSYDAY            * as per NSWHDP algorithm
              ENDIF
            ENDIF
            MOVE      ZERO,TPSYFLG
          ENDIF
.
          IF        BABYFLAG=1
            CALL      BDAY0000              * Yes,Calc.unqual. baby bed days
          ENDIF
.
          MOVE      ZERO,CNTLOC
          MOVE      ZERO,CNTACT
.
          MOVE      ZERO,EXTFLAG
          MOVE      ZERO,PLOFLAG
          MOVE      ZERO,ACTFLAG
          MOVE      ZERO,PRMFLAG
.
.....          BRANCH    DISCADMN,TRAN8000            * leave these blank ? 
.
          CALL      PDIS0000                * Process the diseases
          CALL      POPR0000                * Process the operations
          CALL      HFUN0000                * Get Health fund details
          CALL      CHIH0000                * Check for hospital in the home
.
TRAN8000  CALL      WREC0000                     * Write to text file
.
. we have written a record so check if (Admission Type ="8") discharge/admiss.
. flag is set. ie write a record for the 2nd part of the patients visit
.
          BRANCH    DISCADMN,TRAN8200
          GOTO      TRAN9999
.
. we need to write the second half of the patients visit so set up variables
.
TRAN8200  UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY        * put in required format
          PACK      TRADAT8,CDAY,CMON,CCENT,CYEAR
          REP       " 0",TRADAT8
.
          UNPACK    TTIME,XHOUR,ANS,XMIN
          PACK      TRADMTM,XHOUR,XMIN           * Admission Time
          REP       " 0",TRADMTM
.
          MOVE      SP4,THCSCOD
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          MOVE      PTCDNHCP,TRATYPE             * C-54416 Cat CC HCP Equiv.
....      MOVE      THCSCOD,TRATYPE              * Patient Type on admission
.
          MOVE      ZERO,UNQBDAYS
          MOVE      ZERO,FTRLEAVE                * leave days
          MOVE      ZERO,DISCADMN                * reset flag
          MOVE      SP8,LEAVDATE
          MOVE      SP8,RETNDATE
.
          MOVE      SP1,THCSCOD
          BRANCH    PTNSWHDP,TRAN8400
          PACK      KEY5,ANSD,ANSD,DDEST
          GOTO      TRAN8600
.
TRAN8400  PACK      KEY5,ANSD,SP1,DSTAT
.
TRAN8600  CALL      RDCODE1
          MOVE      THCSCOD,TDSMODE
.
          MOVE      TDSMODE,STRING
          CALL      RMBL0000
          MOVE      STRING,FORM2
          MOVE      FORM2,TDSMODE
          REP       " 0",TDSMODE
.
          MOVE      "1",TREADMN           * Next episode discharge & re-admit
.
          MOVE      "09",TRSREF           * hardcoded as per NSWHDP (4/2/98)
          MOVE      SP10,TRHREFF
          MOVE      ZERO,TPSYFLG
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          CMATCH    ANSP,TCINDC3            * 3rd indicator a "P" ?
          IF        OVRCD = 0 & @EQUAL
            MOVE      ONE,TPSYFLG           * set indicator for psychiatric
            MOVE      TDATE,STRDATE         * set start date for psychiatric
          ENDIF
.
          GOTO      TRAN1000
.
TRAN9999  RETURN
+
.******************************************************************************
.*                                  CIQB0000              Called by: WRIT0000 *
.*                           Check If Qualified Baby                          *
.******************************************************************************
CIQB0000  MOVE      ZERO,QUALADOB           * Qualified after DOB flag - no
          MOVE      ZERO,QUALODOB           * Qualified on DOB flag - no
.
          PACK      KEY30,AADMNO,SP20,SP10
          CALL      RDSTRAN2                * Position on & read a transfer
CIQB1000  CALL      RDKTRAN2                  file record
          BRANCH    OVRCD,CIQB9000
.
          COMPARE   AADMNO,TADMN
          GOTO      CIQB9000 IF NOT EQUAL   * Diff admin no
.
          MATCH     SP3,TATYPE
          GOTO      CIQB1000 IF EQUAL       * Blank admin type
.
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1                 * Read a codes file record
          BRANCH    OVRCD,CIQB1000
.
          UNPACK    THCSCOD,KEY1,TRBABYS,KEY2
          MATCH     "2",TRBABYS
          GOTO      CIQB1000 IF NOT EQUAL   * Not qualified admin type
.
          MATCH     ADATE,TDATE
          GOTO      CIQB2000 IF EQUAL       * Transfer date = admin date
.
          MOVE      ONE,QUALADOB            * Qualified after DOB flag - yes
          GOTO      CIQB9000
.
CIQB2000  PACK      KEY8,ADATE
          MATCH     KEY8,PBDATE
          GOTO      CIQB1000 IF NOT EQUAL   * Admin date not on DOB
.
          MOVE      ONE,QUALODOB            * Qualified on DOB flag - yes
.
CIQB9000  MOVE      ZERO,EXIT
CIQB9999  RETURN
+
.******************************************************************************
.*                                  WREC0000              Called by: WRIT0000 *
.*          Write a record to text file                                       *
.******************************************************************************
WREC0000  MATCH     "99999",TRECNO                * Maximum "9999" records
          GOTO      WREC1000 IF EQUAL
          ADD       ONE,PAGNNO
          MOVE      PAGNNO,TRECNO
          REP       " 0",TRECNO
          MATCH     "09",TDSMODE
          IF        @EQUAL
            MOVE      SP4,TAREAT    * cannot be transferred if statistical sep
          ENDIF
.
          MOVE      ANSN,TPHIC           * Not Private Health insurance claim
          MOVE      TPSTAT,FORM2
.                                        * 1=Public, 2=Private patient
          IF        PUBPRIV=2
            MOVE     AFUNDH,THFUND
            MOVE     AFNDMM,THFNUM
            IF       (FORM2>30&FORM2<37)|FORM2=46
              MOVE     ANSY,TPHIC        * Private Health insurance claim
            ELSE
              GOTO     WREC1000
            ENDIF
          ENDIF
.
WREC1000  MATCH     SP5,TLOSDIA                  * blank?
          GOTO      WREC2000 IF NOT EQUAL
          MOVE      TPRDIAG,TLOSDIA              * set value
          MOVE      UNQBDAYS,FORM1
          MOVE      FORM1,TRBDAYS
          REP       " 0",TRBDAYS
.
WREC2000  MOVE      TWO,TDRGMH
.
.         if three is no previous psychiatric visit and the psychiatric bed 
.         days for current admission is not zero, then set to yes to first
.         visit of psyc.
.
          MOVE      "00000",TIDUMH
          MOVE      ZERO,FORM1
          MATCH     SP1,TRAPSYC
          IF        !@EQUAL
            MOVE      TRAPSYC,FORM1
          ENDIF
          IF        FORM1 <> 2 & FTPSYDAY <> 0 
            MOVE      "1",TRAPSYC           * Yes to first psych.visit
          ENDIF
. 
          IF        FTPSYDAY=0
            MOVE      SP1,TRAPSYC
          ENDIF
.
          MOVE      FTRLEAVE,TRLEAVE      * move to dim
          REP       " 0",TRLEAVE
          MOVE      FTNLEAVE,TNLEAVE      * move to dim
          REP       " 0",TNLEAVE
          MOVE      FTRBWGHT,TRBWGHT
          REP       " 0",TRBWGHT
          MOVE      FTPSYDAY,TPSYDAYS
          REP       " 0",TPSYDAYS
.
          MATCH     "00000",TPSYDAYS       * Calculate involuntary MH days
          GOTO      WREC3000 IF EQUAL      * if TPSYDAYS>0 & TRLEGST=02,03,04,06
.
          MATCH     "02",TRLEGST
          GOTO      WREC2500 IF EQUAL
.
          MATCH     "03",TRLEGST
          GOTO      WREC2500 IF EQUAL
.
          MATCH     "04",TRLEGST
          GOTO      WREC2500 IF EQUAL
.
          MATCH     "06",TRLEGST
          GOTO      WREC3000 IF NOT EQUAL
.
WREC2500  MOVE      SP6,TIDUMH
          MOVE      TPSYDAYS,TIDUMH
          REP       " 0",TIDUMH
          MOVE      ONE,TDRGMH
.
.
WREC3000  WRITE     WORK2,SEQ;TRECNO,THOSCOD,TRURNO,TMEDINO,TFNAME,TMNAME:
                             TSNAME,TSTRNO,TSTRNM,TLOCAL,TSTATE,TPOST:
                             TBDATE8,TRSEX,TCNTRY,TRLANG,TRACE,TMSTAT:
                             TREADMN,THCOVER,TRLEGST,THFUND,THFNUM,TRADAT8:
                             TRADMTM,TREMERG,TRCONST,TRDSCHI,TRSREF,TRHREFF:
                             TSUTADM,TRAMBNO,TDDATE8,TRSEPTM,TPSTAT,TRHRICU:
                             TFINPRG,TRLEAVE,TNLEAVE,TDSMODE,TAREAT,TREFTO:
                             TIDUMH,TDRGMH,THRSMV:
                             TPHIC,TRBWGHT,TRBDAYS,TRAPSYC,TYRPSYC,TPSYDAYS:
                             TUSUACC,TDVACT,TDVACN,TPRDIAG,TRCOND1,TRCOND2:
                             TRCOND3,TRCOND4,TRCOND5,TRCOND6,TRCOND7,TRCOND8:
                             TRCOND9,TRCOND10,TRCOND11,TRCOND12,TRCOND13:
                             TRCOND14,TRCOND15,TRCOND16,TRCOND17,TRCOND18:
                             TRCOND19,TPRPROX,TRPPLOC,TPRDATE8,TRPROX1:
                             TROLOC1,TRPROX2,TROLOC2:
                             TRPROX3,TROLOC3,TRPROX4,TROLOC4,TRPROX5,TROLOC5:
                             TRPROX6,TROLOC6,TRPROX7,TROLOC7,TRPROX8,TROLOC8:
                             TRPROX9,TROLOC9,TRPROX10,TROLOC10,TRPROX11:
                             TROLOC11,TRPROX12,TROLOC12,TRPROX13,TROLOC13:
                             TRPROX14,TROLOC14,TRPROX15,TROLOC15,TRPROX16:
                             TROLOC16,TRPROX17,TROLOC17,TRPROX18,TROLOC18:
                             TRPROX19,TROLOC19,TUPLTHEA:
                             TPALCARE,TREXTC1,TPLOC1,TACCINJ1,TREXTC2,TPLOC2:
                             TACCINJ2,TREXTC3,TPLOC3,TACCINJ3,TRATYPE
          CALL      VALD0000                * validate data
          MOVE      ZERO,FTPSYDAY
.
WREC9999  RETURN
+
.******************************************************************************
.*                                  BDAY0000              Called by: WRIT0000 *
.*          Calculate the bed days for baby                                   *
.******************************************************************************
BDAY0000  MATCH     SP8,STDATE
          GOTO      BDAY9000 IF EQUAL       * Blank save date
.
.         Calculate number of unqualified baby bed days
.
          PACK      CDYSFDTE,STDATE          * From Date
          REP       " 0",CDYSFDTE
.
          PACK      CDYSTDTE,TDATE           * To Date
          REP       " 0",CDYSTDTE
.
          CALL      CALCDAYS                     * calc number of bed days
          MOVE      CDYSDAYS,FORM4
          SUB       ONE,FORM4
.
          SUB       FTRLEAVE,FORM4
.
.Only add extra day if transfer date = start date & there's a type change
. -OR- if move is a discharge
.
.         MATCH     STDATE,TDATE
.         IF        @EQUAL
.           MATCH     ATYPE,TATYPE
.           IF        !@EQUAL
.             ADD       ONE,FORM4                  * as per NSWHDP algorithm
.             GOTO      BDAY5000
.           ENDIF
.         ENDIF
.
.         MATCH     "D",TMOVE & DAYCASE = 1
.         IF        @EQUAL
.           ADD       ONE,FORM4                  * as per NSWHDP algorithm
.         ENDIF
.
BDAY5000  ADD       FORM4,UNQBDAYS               * accumulate the bed days
.
BDAY9000  MOVE      SP8,STDATE
BDAY9999  RETURN
+
.******************************************************************************
.*                                  LEAV0000              Called by: WRIT0000 *
.*          Calculate the bed days for leave                                  *
.******************************************************************************
LEAV0000  MOVE      LEAVDATE,CDYSFDTE            * From Date
          MOVE      RETNDATE,CDYSTDTE            * To Date
          CALL      CALCDAYS                     * calc no. of days leave
          SUB       ONE,CDYSDAYS                 * only want days difference
.
. 
. --------- If the patient goes on leave on the admission date don't count
.           the day as a leave day
.
          PACK      KEY8,ADATE,SP10
          MATCH     KEY8,LEAVDATE 
          IF        @EQUAL
            SUB       ONE,CDYSDAYS
          ENDIF
.                                                 * remove negative days
          COMPARE   ZERO,CDYSDAYS                 * +ve?
          IF        @LESS | @EQUAL
            MOVE      ZERO,CDYSDAYS
          ELSE 
            ADD       CDYSDAYS,FTRLEAVE           * leave days
.....       IF        CDYSDAYS>=2                                       D-48330
              ADD       ONE,FTNLEAVE              * leave periods
.....       ENDIF                                                       D-48330
          ENDIF
.
          MOVE      SP8,LEAVDATE
          MOVE      SP8,RETNDATE
.
LEAV9999  RETURN
+
.******************************************************************************
.*                                  PSYC0000              Called by: PROC0000 *
.*          Calculate the bed days for psychiatric                            *
.******************************************************************************
PSYC0000 
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          CMATCH    ANSP,TCINDC3            * 3rd indicator a "P" ?
          IF        OVRCD = 0 & @EQUAL
            IF       TPSYFLG = 0
.
.             the patient has been transferred to psychiatric
.
              MOVE     ONE,TPSYFLG          * flag for psychiatric
              MOVE     TDATE,STRDATE        * set the starting date 
            ENDIF
          ELSE
            IF       TPSYFLG = 1
.
.             the patient has changed from psychiatric to something else
.
               MOVE    TDATE,ENDDATE        * set the ending date
               CALL    CALC0000             * calculate the dates difference
               ADD     CALDAYS,FTPSYDAY
               MOVE    ZERO,TPSYFLG
            ENDIF
          ENDIF
.
PSYC9999  RETURN
+
.******************************************************************************
.*                                  CALC0000              Called by: PROC0000 *
.*                Calculate the dates differences                             *
.******************************************************************************
CALC0000  PACK      CDYSFDTE,STRDATE
          PACK      CDYSTDTE,ENDDATE
          CALL      CALCDAYS
          MOVE      CDYSDAYS,CALDAYS
          SUB       ONE,CALDAYS       * Only want the diff between the 2 dates
CALC9999  RETURN
+
.******************************************************************************
.*                                  RMDT0000              Called by: PROC0000 *
.*          Move KEY9 to KEY7 (Left Justify), eliminating any dots            *
.******************************************************************************
RMDT0000  RESET     KEY9
.******************************************** start of change          *C-62056
          CMATCH    "M",KEY9
          IF        @EQUAL
            REP       ". - ",KEY9           * Morphology codes only
          ELSE
            REP       ". - / ",KEY9
          ENDIF
.********************************************   end of change          *C-62056
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP9
          MOVE      KEY9,KEY7
.
RMDT9000  MOVE      ZERO,EXIT
RMDT9999  RETURN
+
.******************************************************************************
.*                                  GETSTR00              Called by: PROC0000 *
.*                         Get the street number                              *
.******************************************************************************
GETSTR00  RESET     PADD1
          CLEAR     TSTRNO
          CLEAR     TSTRNM
.
GETSTR10  CMATCH    SP1,PADD1
          GOTO      GETSTR25 IF EQUAL
.
          MOVE      PADD1,ANS
          CMATCH    "/",PADD1
          GOTO      GETSTR20 IF EQUAL
.
          TYPE      ANS
          GOTO      GETSTR30 IF NOT EQUAL
.
GETSTR20  APPEND    ANS,TSTRNO
.
GETSTR25  BUMP      PADD1
          GOTO      GETSTR10 IF NOT EOS
.
GETSTR30  APPEND    SP10,TSTRNO
          RESET     TSTRNO
.
          APPEND    PADD1,TSTRNM
          APPEND    SP20,TSTRNM
          APPEND    SP20,TSTRNM
          RESET     TSTRNM
          RETURN
+
.******************************************************************************
.*                                  PDIS0000              Called by: TRAN0000 *
.*                            Process The Diseases                            *
.******************************************************************************
PDIS0000  MOVE      SP10,TPRDIAG
          UNPACK    SP30,TRCOND1,TRCOND2,TRCOND3,TRCOND4,TRCOND5
          UNPACK    SP30,TRCOND6,TRCOND7,TRCOND8,TRCOND9,TRCOND10
          UNPACK    SP30,TRCOND11,TRCOND12,TRCOND13,TRCOND14,TRCOND15
          UNPACK    SP30,TRCOND16,TRCOND17,TRCOND18,TRCOND19
          UNPACK    SP30,OTRCOND1,OTRCOND2,OTRCOND3,OTRCOND4,OTRCOND5
          UNPACK    SP30,OTRCOND6,OTRCOND7,OTRCOND8,OTRCOND9,OTRCON10
          UNPACK    SP30,OTRCON11,OTRCON12,OTRCOND13,OTRCON14,OTRCON15
          UNPACK    SP30,OTRCON16,OTRCON17,OTRCON18,OTRCON19
          MOVE      SP10,TLOSDIA
          UNPACK    SP30,TREXTC1,TREXTC2,TREXTC3
          MOVE      SP10,TPLOC1
          MOVE      SP10,TACCINJ1
          MOVE      SP10,TPLOC2
          MOVE      SP10,TACCINJ2
          MOVE      SP10,TPLOC3
          MOVE      SP10,TACCINJ3
.
          MOVE      ZERO,COUNT
          PACK      KEY13,AADMNO,EPSNO,SP20                           *C-240107
          CALL      RSPTECD1                * Position on & read an episode
          CALL      RKPTECD1                  disease coding file record
          BRANCH    OVRCD,PDIS8000
.
          COMPARE   AADMNO,PTEDADMN
          GOTO      PDIS8000 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSNO,PTEDEPNO
          GOTO      PDIS8000 IF NOT EQUAL   * Different episode no
          GOTO      PDIS2000
.
PDIS1000  CALL      RKPTECD1                * Read a patient dis eps file rec
          BRANCH    OVRCD,PDIS9000
.
          COMPARE   AADMNO,PTEDADMN
          GOTO      PDIS9000 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSNO,PTEDEPNO
          GOTO      PDIS9000 IF NOT EQUAL   * Different episode no
.
PDIS2000  MOVE      ZERO,CMPCNT             * Complex map counter - no
PDIS3000  CALL      VDIS0000                * Validating disease code
          BRANCH    EXIT,PDIS6000,PDIS7000,PDIS6100,PDIS6200
.
          MOVE      PTEDCODE,KEY9
          CALL      RMDT0000                * Remove dots
.
          CMATCH    "P",PTEDTYPE
          GOTO      PDIS4000 IF NOT EQUAL   * Not a primary disease type
.
          BRANCH    PRMFLAG,PDIS4000        * Already have a primary disease
.
          MOVE      ONE,PRMFLAG
          MOVE      KEY7,TPRDIAG            * The 1st primary disease
          GOTO      PDIS7000
.
PDIS4000  CMATCH    "L",PTEDTYPE 
          GOTO      PDIS5000 IF EQUAL       * L disease type
.
          ADD       ONE,COUNT
          STORE     KEY7,COUNT,TRCOND1,TRCOND2,TRCOND3,TRCOND4,TRCOND5:
                               TRCOND6,TRCOND7,TRCOND8,TRCOND9,TRCOND10:
                               TRCOND11,TRCOND12,TRCOND13,TRCOND14,TRCOND15:
                               TRCOND16,TRCOND17,TRCOND18,TRCOND19
          GOTO      PDIS7000
.
PDIS5000  MOVE      KEY7,TLOSDIA            * L disease type
          GOTO      PDIS7000
.
PDIS6000  CALL      PECS0000                * Process E code stuff
          GOTO      PDIS7000
.
PDIS6100  CALL      PPLO0000                * Process Place of occurnce
          GOTO      PDIS7000
.
PDIS6200  CALL      PACT0000                * Process Activity code
.
PDIS7000  COMPARE   ZERO,CMPCNT
          GOTO      PDIS1000 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      PDIS1000 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,PTEDCODE
          LOAD      PTEDCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,PTEDCODE
          GOTO      PDIS1000 IF EQUAL       * Blank code
          GOTO      PDIS3000
.
PDIS8000  PACK      ERRDESC,SP30,SP30,SP10
          CLEAR     ERRDESC
          APPEND    "Missing Disease Coding for Episode ",ERRDESC
          APPEND    EPSNO,ERRDESC
          APPEND    SP70,ERRDESC
          RESET     ERRDESC
          CALL      PRTL0000                * Print error line
.
PDIS9000  MOVE      ZERO,EXIT
PDIS9999  RETURN
+
.******************************************************************************
.*                                  VDIS0000                                  *
.*                           Validating Disease Code                          *
.******************************************************************************
VDIS0000  MOVE      DDATE,ICDRDDTE
          PACK      KEY9,PTEDCODE
          CALL      RDPTICD1
          BRANCH    OVRCD,VDIS9200
.
          MATCH     "2",PT0DACRQ
          GOTO      VDIS9100 IF EQUAL       * External cause code
.
          MATCH     "6",PT0DACRQ
          GOTO      VDIS9100 IF EQUAL       * External cause code
.
          MATCH     "7",PT0DACRQ
          GOTO      VDIS9100 IF EQUAL       * External cause code
.
          MATCH     "8",PT0DACRQ
          GOTO      VDIS9100 IF EQUAL       * External cause code
.
          MATCH     "4",PT0DACRQ            * Morphology code
          GOTO      VDIS9000 IF EQUAL               * was VDIS9200     *C-62056
.
          MATCH     ANSP,PT0DACRQ
          GOTO      VDIS9300 IF EQUAL       * Place of occurence
.
          MATCH     ANSA,PT0DACRQ
          GOTO      VDIS9400 IF EQUAL       * Activity when injured
.
VDIS9000  MOVE      ZERO,EXIT
          GOTO      VDIS9999
.
VDIS9100  MOVE      ONE,EXIT
          GOTO      VDIS9999
.
VDIS9200  MOVE      TWO,EXIT
          GOTO      VDIS9999
.
VDIS9300  MOVE      THREE,EXIT
          GOTO      VDIS9999
.
VDIS9400  MOVE      FOUR,EXIT
.
VDIS9999  RETURN
+
.******************************************************************************
.*                                  PECS0000              Called by: PDIS0000 *
.*                            Process E Code Stuff                            *
.******************************************************************************
PECS0000  COMPARE   THREE,EXTFLAG
          GOTO      PECS9000 IF NOT LESS    * Already have more than 3 E codes
.
          ADD       ONE,EXTFLAG
          MOVE      PTEDCODE,KEY9
          CALL      RMDT0000                * Remove dots
.
          MATCH     "6",PT0DACRQ
          GOTO      PECS0100 IF EQUAL   
.
          MATCH     "7",PT0DACRQ
          GOTO      PECS0200 IF EQUAL      
.
          MATCH     "8",PT0DACRQ
          GOTO      PECS0300 IF EQUAL     
.
PECS0100  ADD       "1",CNTLOC
          GOTO      PECS0400
.
PECS0200  ADD       "1",CNTACT
          GOTO      PECS0400
.
PECS0300  ADD       "1",CNTLOC
          ADD       "1",CNTACT
.
PECS0400  MATCH     PTCNI10D,PTEDDTCD
          GOTO      PECS1000 IF LESS        * Coding date < ICD10 go live date
.
          STORE     KEY7,EXTFLAG,TREXTC1,TREXTC2,TREXTC3
          GOTO      PECS9000
.
PECS1000  UNPACK    KEY7,KEY1,KEY6
          STORE     KEY6,EXTFLAG,TREXTC1,TREXTC2,TREXTC3
.
PECS9000  MOVE      ZERO,EXIT
PECS9999  RETURN
+
.******************************************************************************
.*                                  PPLO0000              Called by: PDIS0000 *
.*                            Process Place of occurence                      *
.******************************************************************************
PPLO0000  COMPARE   THREE,PLOFLAG
          GOTO      PPLO9000 IF NOT LESS    * Already have more than 3 E codes
.                                           * 229945
          ADD       ONE,PLOFLAG
          MOVE      PTEDCODE,KEY9
          CALL      RMDT0000                * Remove dots
.
          MATCH     PTCNI10D,PTEDDTCD
          GOTO      PPLO1000 IF LESS        * Coding date < ICD10 go live date
.
          STORE     KEY7,PLOFLAG,TPLOC1,TPLOC2,TPLOC3
          GOTO      PPLO9000
.
PPLO1000  UNPACK    KEY7,KEY1,KEY6
          STORE     KEY6,PLOFLAG,TPLOC1,TPLOC2,TPLOC3
.
PPLO9000  MOVE      ZERO,EXIT
PPLO9999  RETURN
+
.******************************************************************************
.*                                  PACT0000              Called by: PDIS0000 *
.*                            Process Activity when injured                   *
.******************************************************************************
PACT0000  COMPARE   THREE,ACTFLAG
          GOTO      PACT9000 IF NOT LESS    * Already have more than 3 E codes
.
          ADD       ONE,ACTFLAG
          MOVE      PTEDCODE,KEY9
          CALL      RMDT0000                * Remove dots
.
          MATCH     PTCNI10D,PTEDDTCD
          GOTO      PACT1000 IF LESS        * Coding date < ICD10 go live date
.
          STORE     KEY7,ACTFLAG,TACCINJ1,TACCINJ2,TACCINJ3
          GOTO      PACT9000
.
PACT1000  UNPACK    KEY7,KEY1,KEY6
          STORE     KEY6,ACTFLAG,TACCINJ1,TACCINJ2,TACCINJ3
.
PACT9000  MOVE      ZERO,EXIT
PACT9999  RETURN
+
.******************************************************************************
.*                                  POPR0000              Called by: TRAN0000 *
.*                           Process The Operations                           *
.******************************************************************************
POPR0000  MOVE      SP10,TPRPROX
          UNPACK    SP70,TRPROX1,TRPROX2,TRPROX3,TRPROX4,TRPROX5
          UNPACK    SP70,TRPROX6,TRPROX7,TRPROX8,TRPROX9,TRPROX10
          UNPACK    SP70,TRPROX11,TRPROX12,TRPROX13,TRPROX14,TRPROX15
          UNPACK    SP70,TRPROX16,TRPROX17,TRPROX18,TRPROX19
.
          MOVE      SP1,TRPPLOC
          UNPACK    SP10,TROLOC1,TROLOC2,TROLOC3,TROLOC4,TROLOC5:
                         TROLOC6,TROLOC7,TROLOC8,TROLOC9,TROLOC10
          UNPACK    SP10,TROLOC11,TROLOC12,TROLOC13,TROLOC14,TROLOC15:
                         TROLOC16,TROLOC17,TROLOC18,TROLOC19
.
          UNPACK    SP20,TPRDATE8    * date of principal procedure
.
          MOVE      ZERO,COUNT
          PACK      KEY13,AADMNO,SP1,ZERO,SP20                        *C-240107
          CALL      RSPTECO1                * Position on & read an episode
POPR1000  CALL      RKPTECO1                  operation coding file record
          BRANCH    OVRCD,POPR2000
.
          COMPARE   AADMNO,PTEOADMN
          GOTO      POPR2000 IF NOT EQUAL   * Different admin no
.
          COMPARE   ZERO,PTEOEPNO
          GOTO      POPR2000 IF NOT EQUAL   * Different episode no
.
          MATCH     ANSX,PTEOTYPE
          GOTO      POPR1000 IF EQUAL       * Ignore this operation code
          GOTO      POPR7000
.
POPR2000  PACK      KEY13,AADMNO,EPSNO,SP20                           *C-240107
          CALL      RSPTECO1                * Position on & read an episode
POPR3000  CALL      RKPTECO1                * Read a pat opr eps file rec
          BRANCH    OVRCD,POPR6000
.
          COMPARE   AADMNO,PTEOADMN
          GOTO      POPR6000 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSNO,PTEOEPNO
          GOTO      POPR6000 IF NOT EQUAL   * Different epsiode no
.
          MATCH     ANSX,PTEOTYPE
          GOTO      POPR3000 IF EQUAL       * Ignore this operation code
.
          MOVE      ZERO,CMPCNT             * Complex map counter - no
POPR4000  CALL      VOPR0000
          BRANCH    EXIT,POPR5000
.
          MOVE      PTEOCODE,KEY9
          CALL      RMDT0000                * Remove dots
.
          ADD       ONE,COUNT
          STORE     KEY7,COUNT,TPRPROX,TRPROX1,TRPROX2,TRPROX3,TRPROX4:
                                 TRPROX5,TRPROX6,TRPROX7,TRPROX8,TRPROX9:
                                 TRPROX10,TRPROX11,TRPROX12,TRPROX13,TRPROX14:
                                 TRPROX15,TRPROX16,TRPROX17,TRPROX18,TRPROX19
.
          MOVE      PTEOTYPE,KEY1
          REP       "O1I2N3",KEY1
          STORE     KEY1,COUNT,TRPPLOC,TROLOC1,TROLOC2,TROLOC3,TROLOC4:
                               TROLOC5,TROLOC6,TROLOC7,TROLOC8,TROLOC9:
                               TROLOC10,TROLOC11,TROLOC12,TROLOC13,TROLOC14:
                               TROLOC15,TROLOC16,TROLOC17,TROLOC18,TROLOC19
.
          COMPARE   ONE,COUNT
          GOTO      POPR5000 IF NOT EQUAL   * Not the 1st operation code
.
          UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY
          PACK      TPRDATE8,CDAY,CMON,CCENT,CYEAR   * Date of principal proc.
          IF        USENFILE=1
            MATCH     "1",PT0ODTMN
            IF        !@EQUAL
              MATCH     SP70,TPRDATE8
              IF        @EQUAL
                MOVE      "Operation Code Exists, but No Operation Date",ERRDESC
                CALL      PRTL0000              * print line
              ENDIF
            ENDIF 
          ENDIF
.
POPR5000  COMPARE   ZERO,CMPCNT
          GOTO      POPR3000 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      POPR3000 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,PTEOCODE
          LOAD      PTEOCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,PTEOCODE
          GOTO      POPR3000 IF EQUAL       * Blank code
          GOTO      POPR4000
.
POPR6000  MATCH     SP8,TPRDATE8
          GOTO      POPR9000 IF NOT EQUAL
          BRANCH    USENFILE,POPR9000
.
          PACK      KEY8,CCC,CYY,CMM,CDD    * current date
          REP       " 0",KEY8
          MOVE      AADMNO,OPDAADMN
          MOVE      ZERO,OPDASTAT
          PACK      KEY31,OPDAADMN,OPDASTAT,KEY8,Z20
          CALL      RSOPDEA2
          CALL      RPOPDEA2
          BRANCH    OVRCD,POPR9000
.
          MOVE      OPDAADMN,FORM8
          COMPARE   FORM8,AADMNO            * same admission ?
          GOTO      POPR9000 IF NOT EQUAL
.
          COMPARE   ZERO,OPDASTAT           * booking status ?
          GOTO      POPR9000 IF NOT EQUAL
.
          UNPACK    OPDADATE,XCENT,XYEAR,XMON,XDAY
          PACK      TPRDATE8,XDAY,XMON,XCENT,XYEAR * date of principal procedure
          GOTO      POPR9000
.
POPR7000  PACK      ERRDESC,SP30,SP30,SP10
          CLEAR     ERRDESC
          APPEND    "Check Episode Coding for this Admission",ERRDESC
          APPEND    SP30,ERRDESC
          APPEND    SP30,ERRDESC
          RESET     ERRDESC
          CALL      PRTL0000                * Print error line
.
POPR9000  MOVE      ZERO,EXIT
POPR9999  RETURN
+
.******************************************************************************
.*                                  VOPR0000                                  *
.*                          Validating Operation Code                         *
.******************************************************************************
VOPR0000  MOVE      DDATE,ICDRDDTE
          PACK      KEY9,PTEOCODE
          CALL      RDPTICO1                * Read an ICD10 operation file rec
          BRANCH    OVRCD,VOPR9500
.
VOPR9000  MOVE      ZERO,EXIT
          GOTO      VOPR9999
.
VOPR9500  MOVE      ONE,EXIT
VOPR9999  RETURN
+
.******************************************************************************
.*                                  HFUN0000              Called by: PROC0000 *
.*                        Get the Health fund details                         *
.******************************************************************************
HFUN0000  
.
HFUN9999  RETURN
+
.******************************************************************************
.*                                  GDRG0000              Called by: GDGR0000 *
.*                              Get The DRG Code                              *
.******************************************************************************
GDRG0000  MOVE      SP4,TRDRG               * Default to no DRG
          MATCH     SP8,DDATE
          GOTO      GDRG9000 IF EQUAL       * Patient not discharged
.
          MATCH     PTCNED70,DDATE          * disc.date > DRG 7.0 effect.date?
          IF        !@LESS
            MOVE      DRG070,DRGVERS        * Use 7.0 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED62,DDATE          * disc.date > DRG 6.2 effect.date?
          IF        !@LESS
            MOVE      DRG062,DRGVERS        * Using 6.2 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED60,DDATE          * disc.date > DRG 6.0 effect.date?
          IF        !@LESS
            MOVE      DRG060,DRGVERS        * Using 6.0 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED52,DDATE          * disc.date > DRG 5.2 effect.date?
          IF        !@LESS
            MOVE      DRG052,DRGVERS        * Using 5.2 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED51,DDATE          * disc.date > DRG 5.1 effect.date?
          IF        !@LESS
            MOVE      DRG051,DRGVERS        * Using 5.1 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED50,DDATE          * disc.date > DRG 5.0 effect.date?
          IF        !@LESS
            MOVE      DRG050,DRGVERS        * Using 5.0 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED42,DDATE          * disc.date > DRG 4.2 effect.date?
          IF        !@LESS
            MOVE      DRG042,DRGVERS        * Using 4.2 DRG version
            GOTO      GDRG0400
          ENDIF
.
          MATCH     PTCNED41,DDATE          * disc.date > DRG 4.1 effect.date?
          IF        !@LESS
            MOVE      DRG041,DRGVERS        * Using 4.1 DRG version
            GOTO      GDRG0400
          ENDIF
.
          GOTO      GDRG9000
.
GDRG0400  PACK      KEY13,AADMNO,SP1,ONE,DRGVERS
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,GDRG1000
.
          MATCH     SP4,PTPGNDRG            * blank DRG ?
          GOTO      GDRG1000 IF EQUAL       * Yes - finished
.
          MOVE      PTPGNDRG,KEY4
          UNPACK    KEY4,KEY3,KEY1
          MATCH     SP1,KEY1
          GOTO      GDRG4000 IF NOT EQUAL   * Valid DRG
.
GDRG1000  MOVE      PTDSDDRG,KEY4           * Default to discharge DRG code
          UNPACK    KEY4,KEY3,KEY1
          MATCH     SP1,KEY1
          GOTO      GDRG9000 IF EQUAL       * Invalid DRG
.
GDRG4000  MOVE      KEY4,TRDRG
.
GDRG9000  MOVE      ZERO,EXIT
GDRG9999  RETURN
+
.******************************************************************************
.*                                  ENDP0000              Called by: PROC0000 *
.*                        Get the next batch number                           *
.******************************************************************************
ENDP0000  BRANCH    OPTION OF ENDP1000
          MOVE      CNXBTCH,FORM5                * Reprocessing
          SUB       ONE,FORM5                    * Use the previous batch no.
          GOTO      ENDP2000
.
ENDP1000  MOVE      CNXBTCH,FORM5
          ADD       ONE,CNXBTCH                  * Update the next batch no.
          WRITAB    CONTROLF,TEN8;*249,CNXBTCH
.
.         Update the date range of the batch processed
.
          WRITAB    CONTROLF,EIGHTY8;*124,CHCSST,CHCSED   * C-58552
.
.         Update the header of transmission file
.
ENDP2000  MOVE      FORM5,TRBATCH
          REP       " 0",TRBATCH
          MOVE      TRECNO,FORM5
.
          WRITAB    WORK2,ZERO;*5,FORM5;
          CLOSE     WORK2
.
          DISPLAY   *P1:24,*EL,*P19:24,*V2LON:
                    "** Transmission Data Processing Completed **",*W;
.
.
          IF        ERRFND = 1
            CALL      UND132
            PRINT     *N,*1,"*** End of Report ***"
          ENDIF
.
.         Print the summary report
.
          MATCH     SP8,TDDATE8
          IF        @EQUAL
            MOVE      SP10,LATSEP
          ELSE
            UNPACK    TDDATE8,XDAY,XMON,XCENT,XYEAR
            PACK      LATSEP,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          ENDIF
.
          PRINT     *F,*1,"****************************************":
                    "****************************************":
                    *N,*N,*1,"Company Name     : ",CNAME:
                    *N,*1,"Hospital Code    : ",CFILENO:
                    *N,*1,"Latest Separation: ",LATSEP:
                    *N,*1,"Number of Records: ",TRECNO;
.
          UNPACK    TODATE,XCENT,XYEAR,XMON,XDAY
          PRINT     *N,*1,"Disk No.         : ":
                           THOSCOD,"-",XDAY,"/",XMON,"/",XCENT,XYEAR;
.
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
          UNPACK    XDATE,XCENT,XYEAR,XMON,XDAY
          PRINT     *N,*1,"Date             : ",XDAY,"/",XMON,"/",XCENT,XYEAR:
                    *N,*1,"****************************************":
                    "****************************************"
.
          COMPARE   ZERO,ERRFND
          GOTO      ENDP3000 IF EQUAL
.
          DISPLAY   *P1:24,*EL,"Errors Found in Transmission. ":
                               "See Error Report. ";
          CALL      HITENTER
.
.         Option to copy to Disk
.
ENDP3000  KEYIN     *P1:24,*EL,"Do you want to copy Transmission file ":
                    "to the Disk (",*V2LON,"Y",*HOFF:
                    "/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
          REP       UPPLOW,ANS
          MATCH     "N",ANS
          GOTO      ENDP9999 IF EQUAL
          MATCH     "Y",ANS
          GOTO      ENDP4000 IF EQUAL
          BEEP
          GOTO      ENDP3000
.
.         Copy to Disk
.
ENDP4000  CLOSE     WORK2
.
          MOVE      SP10,DISKNAME
          CLEAR     DISKNAME
          APPEND    "NSW",DISKNAME
          APPEND    THOSCOD,DISKNAME
          APPEND    SP6,DISKNAME
          RESET     DISKNAME
.
          PACK      CMDLINE,SP30,SP30,SP30,SP10
          CLEAR     CMDLINE
          APPEND    "HCS_TO_DISK ",CMDLINE
          APPEND    FILENAME,CMDLINE
          APPEND    ".txt",CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    DISKNAME,CMDLINE
          RESET     CMDLINE
.
          DISPLAY   *P1:11,*EF,*P20:24,*V2LON:
                    "** Copying file onto Disk.  Please Wait **";
.
          DISPLAY   *P1:13,*EL;
          EXECUTE   CMDLINE,TASKID
          GOTO      ENDP5000 IF OVER
.
          DISPLAY   *P1:20,*EF,*P27:20,*V2LON,"** Transmission Completed **";
          GOTO      ENDP9999
.
ENDP5000  DISPLAY   *P1:24,*EL,*V2LON,*B,*BLINKON:
                    "** Unable to access Disk drive instruction.  ":
                    "Contact I.B.A. Immediately **  ",*W;
          KEYIN     ANS;
.
ENDP9999  RETURN
+
.******************************************************************************
.*                                  HEAD0000              Called by: PROC0000 *
.*                                 Heading                                    *
.******************************************************************************
HEAD0000  CALL      HEAD132
          CALL      UND132
          PRINT     *1,"|","U/R Number",*12,"|","Adm Number",*23,"| ":
                    "Adm Date",*36,"| ","Sep Date",*49,"|"," Error Description":
                    *132,"|"
          CALL      UND132
          MOVE      "6",CLNO
HEAD9999  RETURN
+
.*****************************************************************************
. PRTL0000 - Print Line of Error report            
.*****************************************************************************
PRTL0000  IF        ERRFND=0
            MOVE      ONE,ERRFND              * Set an error found
            CALL      HEAD0000
          ENDIF
          COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS
.
          UNPACK    TDDATE8,CDAY,CMON,CCENT,CYEAR
          CALL      PACDATE
          MOVE      CPCDATE,SEPDATE
          UNPACK    TRADAT8,CDAY,CMON,CCENT,CYEAR
          CALL      PACDATE
          ADD       ONE,CLNO
          PRINT     *1,"|",*3,PURNO,*12,"|",*14,AADMNO,*23,"|",*25,CPCDATE:
                    *36,"|",*38,SEPDATE,*49,"|",*51,ERRDESC,*132,"|"
.
PRTL9999  RETURN
.
.*****************************************************************************
. VALD0000 - Validate the data before sending
.*****************************************************************************
VALD0000  
.
. ------- Sex ------------------------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TRSEX,FORM1
.....     IF        FORM1<1 | FORM1>3                                   D-49016
          IF        FORM1<1 | FORM1>4
            MOVE      "Invalid Sex Type",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Marital Status -------------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TMSTAT,FORM1
          IF        FORM1<1 | FORM1>6
            MOVE      "Invalid Maritial Status",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Aboriginality --------------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TRACE,FORM1
          IF        FORM1<1 | FORM1>4
            COMPARE   NINE,FORM1
            GOTO      RACE1 IF EQUAL
            MOVE      "Invalid Aboriginality",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- If Abo must be born in OZ --------------------------------------
.
RACE1     MOVE      ZERO,FORM1
          MOVE      TRACE,FORM1
          IF        FORM1=1 | FORM1=2 | FORM1=3
            MATCH     "036",TCNTRY
            IF        !@EQUAL
          MOVE     "Aboriginality = 1,2 or 3, Country must = 036 (Aust)",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Abo Language X Aboriginality -------------------------------
.
          MATCH     "00",TRLANG
          IF        @EQUAL
            MOVE      ZERO,FORM1
            MOVE      TRACE,FORM1
            IF        FORM1<1 | FORM1>3
              MOVE      "Language = 00, Aboriginality must = 1,2 or 3",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- source of referral ---------------------------------------------
.
          MOVE      ZERO,FORM2
          MOVE      TRSREF,FORM2
          IF        FORM2<0 | FORM2>15
            MOVE      "Invalid Source of Referral",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Admission Criterion --------------------------------------------
.
          IF        PUBPRIV=3
            MOVE      "Blank or Invalid Admission Criterion",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Medicare Number --------------------------------------------
.
          COMPARE   ONE,PUBPRIV
          GOTO      NEXT IF NOT EQUAL
.                                           * Public patient
          MATCH     SP15,TMEDINO
          GOTO      NEXT IF NOT EQUAL
.
          MOVE      "Blank Medicare Number for a public patient.",ERRDESC
          CALL      PRTL0000
.
. ------- Patient Status ---------------------------------------------
.
NEXT      MOVE      ZERO,FORM2
          MOVE      TPSTAT,FORM2
.
PSTAT000  COMPARE   ONE,PTCNHOSP            * 0=Private, 1=Public
          GOTO      PSTAT200 IF EQUAL 
.
.------------ Private Hospital - valid values -------------------------------- 
.
.PSTAT100  IF  FORM2<20 |(FORM2>23 & FORM2<30)|(FORM2>30 & FORM2<40)|(FORM2>40 &
.              FORM2<42)|(FORM2>45 & FORM2<46)|(FORM2>50 & FORM2<60)|FORM2>60
.
PSTAT100  IF  FORM2=20|FORM2=23|FORM2=30|FORM2=40|FORM2=41|FORM2=42|FORM2=45
            GOTO  HIS000
          ENDIF
          IF  FORM2=46|FORM2=50|FORM2=60
            GOTO  HIS000
          ENDIF
          MOVE "Invalid payment status on Separation/Patient Status",ERRDESC
          CALL    PRTL0000
          GOTO      HIS000
.
.------------ Public Hospital ------------------------------------------------
.
PSTAT200  IF  FORM2<20|(FORM2>20 & FORM2<23)|(FORM2>24 & FORM2<31)|(FORM2>37 &              FORM2<40)|(FORM2>43 & FORM2<45)|(FORM2>46 & FORM2<50)|(FORM2>52 &               FORM2<60)|FORM2>60
.
              MOVE "Invalid payment status on Separation/Patient Status",ERRDESC
              CALL PRTL0000
.
          ENDIF
.
. ------- Health Insurance Status --------------------------------------
.
HIS000    MOVE      ZERO,FORM1
          MOVE      THCOVER,FORM1
.
HIS500    IF        PUBPRIV=2         
.                                       * Private patients
            IF       FORM1<0|FORM1=3|(FORM1>4 & FORM1<9)|FORM1>9
              GOTO      HISERR
            ENDIF
          ELSE                          * Public patients
            IF       FORM1<0|FORM1=3|FORM1>9
              GOTO     HISERR
            ENDIF
          ENDIF
.
          GOTO      RTOS000
.
HISERR    MOVE      "Invalid Health Insurance Status",ERRDESC
          CALL      PRTL0000              * print line
.
. ------- Referred to on Separation --------------------------------------
.
RTOS000   MATCH     "00",TREFTO
          IF        @EQUAL
.                                           * 0=Private, 1=Public Hospital
            IF        PTCNHOSP=1
              MOVE      "Invalid Referred to on Separation",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ELSE
            MOVE      ZERO,FORM2
            MOVE      TREFTO,FORM2
            IF        FORM2<0 | FORM2>13
              MOVE      "Invalid Referred to on Separation",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Mode of Separation ---------------------------------------------
.
          MOVE      ZERO,FORM2
          MOVE      TDSMODE,FORM2
          IF        FORM2<1 | FORM2>11
            MOVE      "Invalid Mode of Separation",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Service Category on Admission ----------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TRATYPE,FORM1
          IF        FORM1<0 | FORM1>9
        MOVE      "Invalid Service Category on Admission/Admission Type",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Service Unit Type on Admission ----------------------------------
.
... D-55938
...       MATCH     "00",TSUTADM
...       IF        @EQUAL
.                                           * 0=Private, 1=Public Hospital
...         IF        PTCNHOSP=1
...           MOVE      "Invalid Service Unit Type on Admission",ERRDESC
...           CALL      PRTL0000            * print line
...         ENDIF
...       ELSE
...         MOVE      ZERO,FORM2
...         MOVE      TSUTADM,FORM2
...         IF        FORM2<1 | FORM2>19 | (FORM2>=15 & FORM2<=18)
...           MOVE      "Invalid Service Unit Type on Admission",ERRDESC
...           CALL      PRTL0000            * print line
...         ENDIF
...       ENDIF
.
. ------- Readmission within 28 days -------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TREADMN,FORM1
          IF        FORM1<1 | FORM1>3
            MOVE      "Invalid Readmission within 28 Days",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Financial Program --------------------------------------
.
          MATCH     SP1,TFINPRG
          IF        @EQUAL
.                                           * 0=Private, 1=Public Hospital
            IF        PTCNHOSP=1
              MOVE      "Invalid Financial Program",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ELSE
            MOVE      ZERO,FORM1
            MOVE      TFINPRG,FORM1
            IF        FORM1<2 | FORM1=3 | FORM1=7 | FORM1>9
              MOVE      "Invalid Financial Program",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Admission Status -----------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TREMERG,FORM1
          IF        FORM1<1 | FORM1>5
            MOVE      "Invalid Admission Status",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
          IF        USENFILE=1
            IF        FORM1<1 | FORM1>3
              MOVE      "Invalid Admission Status",ERRDESC
              CALL      PRTL0000              * print line
            ENDIF
          ENDIF
.
. ------- Contract Status ------------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TRCONST,FORM1
          IF        FORM1<1 | FORM1>2
            MOVE      "Invalid Contract Status",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Discharge Intention --------------------------------------------
.
          MOVE      ZERO,FORM1
          MOVE      TRDSCHI,FORM1
          IF        FORM1<1 | FORM1>2
            MOVE      "Invalid Discharge Intention",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Baby Weight ----------------------------------------------------
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      CALCAGE
          IF        PSAGEDAY<=29
            IF        FTRBWGHT<400
              MOVE      "Baby Weight Below 400 grams",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
            IF        FTRBWGHT>6000
              MOVE      "Baby Weight above 6000 grams",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Baby bed days ----------------------------------------------------
.
          MATCH     TBDATE8,TRADAT8
          IF        @EQUAL
            IF        UNQBDAYS<0 | UNQBDAYS>9
              MOVE    "DOB = Adm.Date, Unq.Baby bed days must be 0 to 9",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
.-------- Psychiatric unit --------------------------------------------------
.
          MOVE      ZERO,FORM1
          COMPARE   ZERO,FTPSYDAY
          GOTO      PSYC00 IF EQUAL
.
          MATCH     SP1,TRPENST
          GOTO      LSOA00 IF EQUAL
.
          MOVE      TRPENST,FORM1                 * Pension Status
          IF        (FORM1>1 & FORM1<4)|FORM1>9
            MOVE      "Invalid Pension Status on Separation",ERRDESC
            CALL      PRTL0000
          ENDIF
.
          MOVE      ZERO,FORM1
          MOVE      TRAPSYC,FORM1                 * First Psych Admission
          IF        FORM1<1 | FORM1>2
            MOVE     "Invalid First Psychiatric Admission",ERRDESC
            CALL     PRTL0000
          ENDIF
.
          MATCH      SP4,TRAPSYC                  * Year of 1st Psych Admn
          IF         @EQUAL
            MOVE       "Year of first admission must be reported",ERRDESC
            CALL       PRTL0000
          ENDIF
          GOTO      LSOA00
.
PSYC00    MATCH     SP1,TRPENST
          IF        !@EQUAL
            MOVE     "Pension status should be blank if no psych days",ERRDESC
            CALL     PRTL0000
          ENDIF
.
. ----- Legal status on admission only for psychiatric -----
.
LSOA00    
.         COMPARE   ONE,TPSYFLG
.         GOTO      LSOA10 IF NOT EQUAL     * Not a psychiatric patient
.
          MOVE      ZERO,FORM5
          MOVE      TIDUMH,FORM5
          COMPARE   ZERO,FORM5
          GOTO      LSOA10 IF NOT EQUAL
.
          MATCH     "02",TRLEGST
          GOTO      LSOA05 IF EQUAL
.
          MATCH     "03",TRLEGST
          GOTO      LSOA05 IF EQUAL
.
          MATCH     "04",TRLEGST
          GOTO      LSOA05 IF EQUAL
.
          MATCH     "06",TRLEGST
          GOTO      LSOA10 IF NOT EQUAL
.
LSOA05    MOVE      "Involuntary days should not be zero",ERRDESC
          CALL      PRTL0000 
.
LSOA10    IF        FTPSYDAY<>0
            MOVE      ONE,TDRGMH    * mental health legal status
.
            MATCH     "02",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "03",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "04",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "06",TRLEGST
            GOTO      UVT000 IF EQUAL
.
         ELSE
            MOVE      TWO,TDRGMH            * mental health legal status
.
            MATCH     "01",TRLEGST            * new file
            GOTO      UVT000 IF EQUAL
.
            MATCH     "05",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "07",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "08",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "18",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MATCH     "19",TRLEGST
            GOTO      UVT000 IF EQUAL
.
            MOVE      "Invalid Legal Status on Admission",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
.
.-------- Unplanned visit to theatre ----------------------------------------
.
UVT000    MATCH      SP8,TPRDATE8
          IF         !@EQUAL
            MATCH     SP1,TUPLTHEA
            IF        !@EQUAL
              MOVE      ZERO,FORM1
              MOVE      TUPLTHEA,FORM1
              IF        FORM1=1 | FORM1=2 | FORM1=9
                GOTO       DVA00
              ELSE
                MOVE       "Unplanned visit to Theatre must be 1 or 2",ERRDESC
                CALL      PRTL0000          * print line
              ENDIF
            ENDIF
          ENDIF
.
.-------- DVA Card ---------------------------------------------------------
.
DVA00     BRANCH    DVAFLAG,DVA01           * DVA patient              *I-44050
          COMPARE   TWO,PUBPRIV             * 1=Public, 2=Private
          IF        @EQUAL
            MOVE      SP8,TDVACT
            MOVE      SP10,TDVACN
            GOTO      IPCT000
          ENDIF
. 
DVA01     MATCH     SP8,TDVACN                            * add label  *C-44050
          IF        @EQUAL
            MATCH     SP1,TDVACT
            IF        !@EQUAL
              MOVE      "Card type should be blank if no card number",ERRDESC
              CALL      PRTL0000
            ELSE 
              GOTO    IPCT000
            ENDIF
          ENDIF
.
          MATCH       "50",TPSTAT
          IF          @EQUAL
            MATCH       "G",TDVACT
            GOTO        DVACN00 IF EQUAL 
.
            MATCH       "W",TDVACT
            GOTO        DVACN00 IF EQUAL
.
            MOVE     "DVA Card type must be completed for Vet Affairs",ERRDESC
            CALL     PRTL0000
.
DVACN00     MATCH    SP9,TDVACN
            IF       @EQUAL
              MOVE   "DVA Card no. must be completed for Vet Affairs",ERRDESC
              CALL   PRTL0000
            ENDIF
          ENDIF
.
          CMATCH    "N",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          CMATCH    "V",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          CMATCH    "S",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          CMATCH    "Q",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          CMATCH    "T",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          CMATCH    "W",TDVACN
          GOTO      DVACT00 IF EQUAL
.
          MOVE      "Invalid DVA Card number",ERRDESC
          CALL      PRTL0000
.
DVACT00   MATCH     SP10,TDVACN
          IF        !@EQUAL
            COMPARE   TWO,PUBPRIV             * 1=Public, 2=Private   *I-222931
            GOTO      IPCT000 IF EQUAL                                *I-222931
            MATCH     SP1,TDVACT
            IF        @EQUAL
              MOVE      "No DVA Card Type",ERRDESC
              CALL      PRTL0000
            ENDIF
          ENDIF
.
. ------- Involvement of Palliative care team ------------------------------
.
IPCT000   MOVE      ZERO,FORM1
          MOVE      TPALCARE,FORM1
          IF        FORM1<0 | FORM1>2
            MOVE      "Involvement of Palliative care must be 1 or 2",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Born in Hospital but DOB <> DOA -------------------------------
.
          MATCH     "00",TRSREF
          IF        @EQUAL
            UNPACK    TBDATE8,XDAY,XMON,XCENT,XYEAR
            PACK      KEY8,XCENT,XYEAR,XMON,XDAY
            REP       " 0",KEY8
            MATCH     KEY8,ADATE
            IF        !@EQUAL
              MOVE   "Source of Referral = 0, DOB must = Admission Date",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Baby Status X Source of Referral -------------------------------
.
          MATCH     "00",TRSREF
          IF        @EQUAL
            IF        UNQBDAYS<0 | UNQBDAYS>9
         MOVE     "Source of Ref. = 0, Unq.Baby Bed days must be 0 to 9",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Hospital Transferred X Admission Hosp -------------------------
.
          MATCH     THOSCOD,TAREAT
          IF        @EQUAL
     MOVE      "Transfer Hospital must be different to Admission Hosp.",ERRDESC
            CALL      PRTL0000              * print line
          ENDIF
.
. ------- Contract Status ------------------------------------------------
.
          MATCH     "1",TRCONST
          IF        @EQUAL
            MATCH     SP7,TPRPROX
            IF        @EQUAL
             MOVE      "Contract Status = 1, there must be a Procedure",ERRDESC
              CALL      PRTL0000            * print line
            ENDIF
          ENDIF
.
. ------- Validate the operation code and date ------------------------------
.
VALD8000  MATCH     SP7,TPRPROX
          IF        @EQUAL
            MATCH     SP8,TPRDATE8
            IF        !@EQUAL
              IF        USENFILE=0
               MOVE      "Operation Date exists, but NO Operation Code",ERRDESC
                CALL      PRTL0000              * print line
              ENDIF
            ENDIF
          ELSE
            MATCH     SP8,TPRDATE8
            IF        @EQUAL
              BRANCH    PTMORBDT,VALD8010                             *I-206821
              IF        USENFILE=0
                MOVE      "Operation Code exists, but NO Operation Date",ERRDESC
                CALL      PRTL0000              * print line
              ENDIF
            ENDIF
          ENDIF
.
. --------- Validate external cause,place of occurence & activity
.
VALD8010  IF        CNTLOC>PLOFLAG
            MOVE      "Place of occurence required ",ERRDESC
            CALL      PRTL0000
          ENDIF
.
          IF        CNTACT>ACTFLAG
            MOVE      "Activity when injured required ",ERRDESC
            CALL      PRTL0000
          ENDIF
.
VALD9999  RETURN
+
.*****************************************************************************
. CHIH0000 - Check for Hospital in the Hotel
.*****************************************************************************
CHIH0000  MOVE      ZERO,HIHFOUND
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
CHIH1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CHIH9999
.
          MATCH     DAADMNO,DTADMN
          GOTO      CHIH9999 IF NOT EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHIH1000               * 229945
.
          PACK      KEY5,CATBT,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHIH1000               * 229945
.
          MATCH     ANST,TCINDC1
          IF        !@EQUAL
            COMPARE    ONE,HIHFOUND
            GOTO       CHIH9000 IF EQUAL
            GOTO       CHIH1000
          ENDIF
.
          COMPARE   ONE,HIHFOUND
          IF        !@EQUAL
            UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY   * Set discharge Date
            PACK      TDDATE8,CDAY,CMON,CCENT,CYEAR
            REP       " 0",TDDATE8
.
            UNPACK    TTIME,XHOUR,ANS,XMIN
            PACK      TRSEPTM,XHOUR,XMIN       * Separation Time
            REP       " 0",TRSEPTM
.
            MOVE      ONE,HIHFOUND
            GOTO      CHIH1000
          ENDIF
.
CHIH9000  PACK      ERRDESC,SP7
          CLEAR     ERRDESC
          APPEND    "Invalid Hospital in the Hotel transfer",ERRDESC
          APPEND    EPSNO,ERRDESC
          APPEND    SP70,ERRDESC
          RESET     ERRDESC
          CALL      PRTL0000                * Print error line
          GOTO      CHIH9999
.
CHIH9999  RETURN
+
.******************************************************************************
.*                                  MVEXT000                                  *
.*                         Move Extract to Web Directory                      *
.******************************************************************************
MVEXT000  CLEAR     CMDLINE                 * header file
          APPEND    "ibabil55.us1 ",CMDLINE
          APPEND    FILENAME,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
MVEXT999  RETURN
+
.*****************************************************************************
.*                              CONCD000                                     *
.*     See if the patient has concession card of a given type on file        *
.* Requires: CARDTYPE - Concession Card Type                                 *
.*                      3 = DVA                                              *
.*                      4 = Pension                                          *
.*           DATETIME - date/time (ccyymmddhhmmss)                           *
.*           PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CONCD000  MOVE      SP70,DIM20
          PACK      KEY19,PURNO,Z70
          CALL      RSPMCCD1                     * position on U/R
CONCD050  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CONCD910               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CONCD910 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA or Pension (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CONCD050               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CONCD050 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CONCD050 IF NOT EQUAL        * no - ignore record
.
          MOVE      TCINDC1,FORM1
          COMPARE   FORM1,CARDTYPE               * same concession card type ?
          GOTO      CONCD050 IF NOT EQUAL        * no - ignore record
.
.         A concession card of the same type has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CONCD100 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          MOVE      DATETIME,DIM8
          MATCH     DATETIME,PMCDEXDT            * card valid for date ?
          GOTO      CONCD910 IF LESS             * no - nothing found
.
.         Concession card is current
.
CONCD100  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CONCD910 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,EXIT
          GOTO      CONCD999
.
CONCD910  MOVE      ONE,EXIT
.
CONCD999  RETURN
+
.==============================================================================
.
          INC       STD001IO
          INC       IBAPOSIO/INC
          INC       CALCAGE
          INC       CALCDAYS
          INC       PATM10T9
.
          INC       PATGILOS
          INC       OPRDEAIO/INC
          INC       PATCMPIO/INC
          INC       PATCODIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATFN1IO/INC
          INC       PATICUIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATPGRIO/INC
          INC       PATWR1IO/INC
          INC       HL7BMTIO/INC
....      INC       HL7BMTMA
          INC       PATMI1IO/INC
          INC       PATTRNIO/INC
....      INC       HL7BMTTR
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PMSCCDIO/INC
          INC       PATWVEIO/INC
....      INC       HL7BMTRG
....      INC       HL7BMTVI
+
.

