.******************************************************************************
.* System   : Inpatients                                                      *
.* Program  : CONVADT                                                         *
.* Desc     : Convert Admission/Discharge/Transfer Historical Data            *
.******************************************************************************
.* Date     : 11/01/93                                                        *
.* Author   : ROD   (Copied)                                                  *
.* Mods     :                                                                 *
.*        V10.05.02 30/10/2014  Ebon Clements     CAR 301898                  *
.*                  Lock control file when getting next visit number          *
.*        V10.05.01 15/08/2014  Ania P            CAR 304641                  *
.*                  Clearing PTICAMBN with SP70 not SP10 after length change  *
.*        V10.03.01 18/11/2011  Mike Laming       CAR 240184                  *
.*                  Changes to IBAPOSTF Post Code table - added State to Keys *
.*        V10.01.01 01/12/2010  Peter Vela        CAR 233148                  *
.*                  Initialised pattranf variables to spaces before write     *
.*                  06/01/2011  Jill Parkinson    CAR 233088                  *
.*                  Added pmvxfndm                                            *
.*        V9.11.03  07/04/2009  Peter Vela        CAR 183976                  *
.*                  Moved spaces to PMVXPILC before WRPMVX11                  *
.*        V9.11.02  17/02/2009  Peter Vela        CAR 183976                  *
.*                  Moved spaces to PMVXPOEC before WRPMVX11                  *
.*        V9.11.01  08/01/2009  Steve Armstrong   CAR 185927                  * 
.*                  Removed isadd on temp file and included extra index in    *
.*                  isbuild (now that CMDLINE has been used instead of KEY127 *
.*                  and extended to 500 in length).                           *
.******************************************************************************
.*        V9.04.01  03/08/05 J.Tan    CAR 62750                               * 
.*                  Removed redefined amount variables                        * 
.******************************************************************************
.*        V9.03.01  30/05/2003  Lina Vo     CAR 37504                         *
.*                  Write SLA/ASGC code from ibapostf to visit extension table*
.******************************************************************************
.*        V9.02.34  08/06/2002  J.Tan                                         *
.*                  Recompiled for CLPATMIS                                   *
.*        V9.02.33  26/04/2002  Jill Habasque                                 *
.*                  Added check for blank DRG                                 *
.*        V9.02.32  22/02/2002  Jill Habasque                                 *
.*                  Changed to move TMPADMIS to FORM8 (not DIM8)              *
.*        V9.02.31  10/02/2002  Sandra Barcham                                *
.*                  Read AADMNO from position 1 not 3                         *
.*        V9.02.30  23/01/2001  J.Tan                                         *
.*                  Mods to update doctor for visit file                      *
.*        V9.02.29  22/01/2001  J.Tan                                         *
.*                  Mods to update doctor,unit,atype to pattran for disc.rec. *
.*        V9.02.28  22/01/2001  J.Tan                                         *
.*                  Mods to update doctor,unit,atype to pattran for disc.rec. *
.*        V9.02.27  21/01/2001  J.Tan                                         *
.*                  Mods to update doctor,unit,atype to patmiss for adttran   *
.*        V9.02.26  21/01/2002  Steve Armstrong                               *
.*                  Mods to add a check if CCU hours or NCU hours are present *
.*                  when determining if a paticuaf record needs to be written.*
.*        V9.02.25  17/01/2001  J.Tan                                         *
.*                  Removed checking for 1st indicator of admission type      *
.*        V9.02.24  16/01/2001  S.Barcham                                     *
.*                  Excluded routine CLER0000                                 *
.*        V9.02.23  14/01/2001  Pat Dirito                                    *
.*                  Re-included routine CLER0000                              *
.*        V9.02.22  14/01/2001  Pat Dirito                                    *
.*                  Fixed Grouper Version format writing to Discharge File    *
.*                  & now writing to patpgraf with all national, state &      *
.*                  local variables populated.                                *
.*        V9.02.21  11/01/2001  Ebon Clements                                 *
.*                  Recompiled for changes to MRTPDSFD                        *
.*        V9.02.20  07/12/2001  J.Habasque                                    *
.*                  Fixed ABWGHT to be packed with SP2 and TMPADMWT           *
.*        V9.02.19  03/12/2001  J.Habasque                                    *
.*                  Fixed default of pmvxingp and pmvxcfsg to no              *
.*        V9.02.18  29/11/2001  J.Habasque                                    *
.*                  Fixed write of admission transfer source                  *
.*        V9.02.17  27/11/2001  J.Tan                                         *
.*                  Changed CP4 to COM in post discharge status               *
.*        V9.02.16  24/10/2001  Mike Laming                                   *
.*                  Add code to bypass data errors on both inpu files         *
.*        V9.02.15  22/10/2001  Mike Laming                                   *
.*                  Leave ACODDTE as spaces if All spaces                     *
.*        V9.02.14  11/10/2001  Mike Laming                                   *
.*                  Fix duplicate "A" Transfers and general cleanup           *
.*        V9.02.11-13  11/10/2001  Mike Laming                                *
.*                  Other bits and pieces                                     *
.*        V9.02.10  08/10/2001  Mike Laming                                   *
.*                  Oracle DB not handling Read-previous the same as C-Isam   *
.*                  Try a different approach                                  *
.*        V9.02.09  28/09/2001  Mike Laming                                   *
.*                  Correct the handling of Transfers, particularly 'D' type  *
.*                  to check whether a valid Discharge Ward and Bad was given *
.*                  in the 'convadt.txt' processing. Delete the 'D' Transfer  *
.*                  if wrong, and fix the Discharge record PATDSCFD.          *
.*        V9.02.08  26/09/2001  Mike Laming                                   *
.*                  Correct check against Discharge Time (was using ATIME)    *
.*        V9.02.07  20/09/2001  Mike Laming                                   *
.*                  Add Discharge Ward & Bed to 'convadt.txt' and processing  *
.*        V9.02.06  17/09/2001  Mike Laming                                   *
.*                  Add more extensive Record Counts to Report                *
.*        V9.02.05  13/09/2001  Mike Laming                                   *
.*                  Move 'Special Funding' and 'Grouper Details' routines to  *
.*                  just before 'Check Discharge' (from after 'Discharge Track*
.*        V9.02.04  04/09/2001  Mike Laming                                   *
.*                  Change process to now check the Discharge Ward/bed after  *
.*                  all Transfers for each Admission have been processed.     *
.*        V9.02.03  03/09/2001  Mike Laming                                   *
.*                  Change process for Transfers to stop inserting Transfers  *
.*                  around Discharge                                          *
.*        V9.02.02  16/08/2001  Mike Laming                                   *
.*                  strip leading zeros from Admission No. & cleanup messages *
.*        V9.02.01  13/08/2001  Mike Laming                                   *
.*                  Correct Transfer Date/Time checking                       *
.******************************************************************************
.*        V9.00.00  18/05/2001  Mike Laming                                   *
.*                  Change to handle RCH & SVHM                               *
.*                  Add new input fields as per Layout document               *
.*                  Add files for update - PATASFFD, PATPGRFD, PMSVX1FD       *
.*                  Correct Indexes on older files                            *
.******************************************************************************
.*        V5.07.02  25/11/1999  Davin                                         *
.*                  Changed for 4 character drgs                              *
.*        V5.07.01  06/05/1999  Greg Horvat                                   *
.*                  Added post discharge details                              *
.*        V5.07.00  23/04/1999  Greg Horvat                                   *
.*                  Ported from release 6.04                                  *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
          INC       IBAPOSFD/INC                 * postcode file
          INC       MRTPDSFD/INC                 * DSC Header
          INC       MRTPSHFD/INC                 * DSC History
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDADFD/INC                 * Transfer Destination
          INC       PATDSCFD/INC                 * Discharge Details
          INC       PATICUFD/INC                 * Intensive Care Unit
          INC       PATRE1FD/INC                 * Person Respon. for Account
          INC       PATMA1FD/INC                 * Patient Master
          INC       PATMI1FD/INC                 * Admissions
          INC       PATTRNFD/INC                 * Transfer Details
          INC       PATVISFD/INC                 * Visit Details
          INC       PATASFFD/INC                 * Special Funding Arrange.  @@
          INC       PATPGRFD/INC                 * Grouper Details           @@
          INC       PMSVX1FD/INC                 * Visit Extension           @@
.
.******************************************************************************
.*                            TEMPORARY FILES                                 *
.******************************************************************************
.
. File definition for admissions (convadt.txt)
. ------------------------------
ADT       FILE      ASCII, FIXED=901                                   *C-90207
.
.Name     Type   Length  Start loc.  Description
.----     ----   ------  ----------  -----------
TMPUR     DIM       8         1      U/R Number
TMPADMIS  FORM      8         9      Admission Number 
TMPADATE  DIM       8        17      Admission Date (ccyymmdd)
TMPATIME  DIM       8        25      Admission Time (hh:mm:ss)
TMPWARD   DIM       3        33      Ward (coded - patwr1af)
TMPBED    DIM       3        36      Bed (coded - patwr1af)
TMPRDOC   DIM      22        39      Referring Doctor
TMPADOC   DIM       6        61      Attending Doctor (coded - patdo1af)
TMPLDOC   DIM      30        67      Local Doctor
TMPASRCE  DIM       3        97      Admission Source (Cat S )
TMPATYPE  DIM       3        100     Admission Type (Cat A )
TMPACLSS  DIM       3        103     Admission Class (Cat P )
TMPADIAG  DIM     100        106     Admitting Diagnosis 
TMPCLAIM  DIM       3        206     Claim Code (Cat CL)
TMPCARE   DIM       3        209     Care Class (Cat CC)
TMPLSSET  DIM       3        212     Speciality/Unit (Cat AC)                @@
TMPHFUND  DIM       6        215     Health Fund (coded - patfn1af)
TMPHFTBL  DIM       8        221     Health Fund Table (coded - patfn1af)
TMPMEMB   DIM      10        229     Membership Number
TMPRELIG  FORM      1        239     Religious Visit 1=Yes, 2=No
TMPAUSR1  DIM       3        240     Admission user defined code 1 (Cat U1)
TMPAUSR2  DIM       3        243     Admission user defined code 2 (Cat U2)
TMPAUSR3  DIM       3        246     Admission user defined code 3 (Cat U3)
TMPAUSR4  DIM       3        249     Admission user defined code 4 (Cat U4)
TMPAUSR5  DIM       3        252     Admission user defined code 5 (Cat U5)
TMPAUSR6  DIM       3        255     Admission user defined code 6 (Cat U6)
TMPAUSR7  DIM       3        258     Admission user defined code 7 (Cat U7)
TMPAUSR8  DIM       3        261     Admission user defined code 8 (Cat U8)
TMPAUSR9  DIM       3        264     Admission user defined code 9 (Cat U9)
TMPAUSR0  DIM       3        267     Admission user defined code 0 (Cat U0)
TMPADMWT  DIM       4        270     Admission weight
TMPCDCMP  DIM       8        274     Date Coding Complete (ccyymmdd)
TMPDDATE  DIM       8        282     Discharge Date (ccyymmdd)
TMPDTIME  DIM       8        290     Discharge Time (hh:mm:ss)
TMPDSTAT  DIM       3        298     Discharge Status (Cat D)
TMPDDEST  DIM       3        301     Discharge Destination (Cat DD)
TMPDIAG   DIM      100       304     Discharge Diagnosis
TMPTRAN   DIM       5        404     Discharge Transfer Destination 
.                                        (coded - patdadaf)
TMPSSREF  DIM       4        409     Separation Referral                     @@
TMPDUSR1  DIM       3        413     Discharge user defined code 1 (Cat D1)
TMPDUSR2  DIM       3        416     Discharge user defined code 2 (Cat D2)
TMPDUSR3  DIM       3        419     Discharge user defined code 3 (Cat D3)
TMPDUSR4  DIM       3        422     Discharge user defined code 4 (Cat D4)
TMPDUSR5  DIM       3        425     Discharge user defined code 5 (Cat D5)
TMPGEPNO  DIM       2        428     Episode no                              @@ 
TMPGSDRG  DIM       4        430     State DRG Code (coded - patdgwaf)       @@ 
TMPGSMDC  DIM       4        434     State MDC Code (coded - patdgwaf)       @@ 
. ----- TMPDRG    DIM       4                DRG code                        @@
. ----- TMPMDC    DIM       4                MDC code                        @@
TMPSEVIX  DIM       1        438     DRG Severity Index
TMPGRVER  DIM       3        439     3M Grouper Version
. ------------------------- Start of Addition for RCH/SVHM ---------------- @@
TMPGWFIX  FORM   12.4        442     WIES value fixed                
TMPGWVAR  FORM   12.4        459     WIES value variable   
TMPGWTOL  FORM   12.4        476     WIES value total  
TMPGSWGT  FORM    6.4        493     State weight 
TMPGSALS  FORM    4.2        504     State average LOS 
TMPGWWTU  FORM    6.4        511     WIES weight used 
TMPGWWTD  DIM      13        522     WIES weight description 
. --------------------------- End of Addition for RCH/SVHM ---------------- @@
TMPICUH   FORM      4        535     ICU hours
TMPHOMV   FORM      4        539     Hours on mech ventilation
TMPPRANM  DIM      20        543     P.R.A Name
TMPPRAA1  DIM      35        563     P.R.A address line 1
TMPPRAA2  DIM      35        598     P.R.A address line 2
TMPPRAA3  DIM      35        633     P.R.A address line 3
TMPPRAA4  DIM      35        668     P.R.A address line 4
TMPPRAPC  DIM       8        703     P.R.A post code
TMPPRAPP  DIM      20        711     P.R.A home phone
TMPPRABP  DIM      20        731     P.R.A business phone
TMPPRARE  DIM      10        751     P.R.A Relationship
TMPPDDAT  DIM       8        761     Post discharge date (ccyymmdd)
TMPPDTIM  DIM       8        769     Post discharge time (hh:mm:ss)
TMPPDDOC  DIM       6        777     Post discharge doctor (coded - patdo1af)
TMPPDSTA  DIM       3        783     Post discharge status (Cat CP)
. ------------------------- Start of Addition for RCH/SVHM ---------------- @@
. ------------------------------------------------------- Following in PMSVX1FD
TMPXABRG  DIM       3        786     Aboriginality        (PRS/2) (Cat VA)
TMPXCADM  DIM       3        789     Admission Criterion  (PRS/2) (Cat VB
TMPXIRAD  DIM       3        792     Intent to Readmit    (PRS/2) (Cat VR)
TMPXIDUS  DIM       3        795     Intend Stay Duration (PRS/2) Cat VI
TMPXCRAV  DIM       3        798     Carer Availability   (PRS/2) (Cat VK)
TMPXAPWD  DIM       3        801     Admitting Point Ward (coded - patwr1af)
TMPXAPBD  DIM       3        804     Admitting Point Bed (coded - patwr1af)
TMPXPOWD  DIM       3        807     Post-Op Ward (coded - patwr1af)
TMPXPOBD  DIM       3        810     Post-Op Bed (coded - patwr1af)
TMPXPSTY  DIM       1        813     Parent Staying (0=NO,1=YES)
TMPXVALW  DIM       1        814     Visitor Allowed (0=NO,1=YES)
TMPXPALW  DIM       1        815     Phone Calls Allowed? (0=NO,1=YES)
TMPXINDC  DIM       1        816     Intended Day Case (0=NO,1=YES)
TMPXMDAV  DIM       3        817     Mode of Arrival (Cat VM)
TMPXFRMS  DIM       3        820     Forms (Cat VF)
TMPXCSNG  DIM       3        823     Coder Snags (Cat VN)
TMPCHNCU  FORM      4        826     HOURS IN NCU 
TMPCUCCU  FORM      4        830     HOURS IN CRITICAL CARE (CCU)
TMPXPWGT  FORM      6        834     Patient Weight  
TMPXPHGT  FORM      6        840     Patient Height 
TMPXDHWR  DIM       8        846     Date Height/Weight Record. ccyymmdd
. ------------------------------------------------------- Following in PATASFFD
TMPFTYPE  DIM       1        854     SFA type
.                                     A - admission
.                                     L - on leave
TMPFDATE  DIM       8        855     SFA date(ccyymmdd leave only)
TMPFTIME  DIM       8        863     SFA time(leave only)
TMPFCODE  DIM       1        871     SFA code 
TMPFCTYP  DIM       1        872     Contract type
TMPFCROL  DIM       1        873     Contract role
TMPFCSID  DIM       5        874     Contract/spoke id
. -------------------------------------------------------
TMPXRCCT  DIM       3        879     Crit. Care Xfer Reason (PRS/2) (VJ) 
TMPAADTS  DIM       5        882     Admission Transfer Source 
.                                        (coded - patvadaf)
TMPXPOST  DIM       8        887     Post Code 
. --------------------------- End of Addition for RCH/SVHM ---------------- @@
TMPDWARD  DIM       3        895     Discharge Ward (coded - patwr1af) *I-90207
TMPDBED   DIM       3        898     Discharge Bed  (coded - patwr1af) *I-90207
.
.End of Record               901
.
. File definition for transfers 
. -----------------------------
ADTTRAN   FILE      ASCII, FIXED=61                                          @@
.
.Name     Type   Length  Start loc.  Description
.----     ----   ------  ----------  -----------
XURNO     DIM       8         1      U/R no
XADMNO    FORM      8         9      Admission no
XTRNDATE  DIM       8        17      Transfer date (ccyymmdd)
XTRNTIME  DIM       8        25      Transfer time (hh:mm:ss)
XRECTY    DIM       1        33      Record Type - C=Transfer/Change         @@
.                                                  L=Going on Leave          @@
.                                                  R=Return from Leave       @@
XATYPE    DIM       3        34      Admission type (Cat A )
XUNIT     DIM       3        37      Unit/Department (Cat AC)                @@
XWARD     DIM       3        40      Ward (coded - patwr1af)
XBED      DIM       3        43      Bed (coded - patwr1af)
XADOCT    DIM       6        46      Attending doctor (coded -patdo1af)
XRATE     FORM      6.2      52      Rate
.
.End of Record               61

+
.******************************************************************************
.*                              GLOBAL VARIABLES                              *
.******************************************************************************
ADTFLAG   FORM      1
BYPASMSG  FORM      1                                                  *I-90213
.
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CMDLINE   DIM       500
COUNT     FORM      7
COUNTIN   FORM      7
COUNTREJ  FORM      7
COUNTERR  FORM      7
COUNTAUP  FORM      7
COUNTAWR  FORM      7
COUNTDUP  FORM      7
COUNTDWR  FORM      7
COUNTGUP  FORM      7
COUNTGWR  FORM      7
COUNTIUP  FORM      7
COUNTIWR  FORM      7
COUNTPUP  FORM      7
COUNTPWR  FORM      7
COUNTSUP  FORM      7
COUNTSWR  FORM      7
COUNTTDE  FORM      7                                                  *I-90209
COUNTTUP  FORM      7
COUNTTWR  FORM      7
COUNTUUP  FORM      7
COUNTUWR  FORM      7
COUNTVUP  FORM      7
COUNTVWR  FORM      7
COUNTWUP  FORM      7
COUNTWWR  FORM      7
.
DATAERR   FORM      1                                                  *I-90216
DIM3      DIM       3
DIM5      DIM       5
DIM8      DIM       8
DIM10     DIM       10
.
ERRORNO   FORM      2                                                  *I-90209
ERRTRAN   FORM      1                                                  *I-90209
FORM6     FORM      6
FORM8     FORM      8
LSTADMNO  FORM      8                       * Previous Admission No.   *I-90204
.
PDATE     DIM       10
.
REMVCRAP  FORM      1                       * Remove rubbish Transfer  *I-90207
REMVDONE  FORM      1                       * Remove rubbish Transfer  *I-90207
.
TEMP      FILE      ASCII,FIXED=256
TRNFLAG   FORM      1
UPDTADMN  FORM      1
UPDTREQD  FORM      1
UPDTEXTN  FORM      1
UPDTTRAN  FORM      1
.
+
.******************************************************************************
.*                                 CONSTANTS                                  *
.******************************************************************************
SP127     INIT      "                                          ":
                    "                                          ":
                    "                                           "
ZED30     INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
PRGID     INIT      "CONVADT"
PRGNAM    INIT      "Convert Admission/Discharge/Transfer Data"
VERSION   INIT      "V10.11.00"
+
.******************************************************************************
.*                                 MAINLINE                                   *
.*                           Controlling Logic                                *
.******************************************************************************
ML0000    CALL      INIT0000                * Initialise variables
          BRANCH    EXIT,ML9999
.
ML1000    CALL      OPTN0000                * Select option
          BRANCH    EXIT,ML9000
.
.         CALL      CLER0000                * Clear the files before proceeding
.         BRANCH    EXIT,ML9000
.
          CALL      OPEN0000                * Open file
          CALL      PROC0000                * process the details
.
ML9000    CLOSE     TEMP,DELETE
ML9999    CHAIN     PGM
+
.******************************************************************************
.*                                  INIT0000                                  *
.*                            Initialise Variables                            *
.******************************************************************************
INIT0000  CALL      DISPHEAD                * display screen header
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO          * see if conversion file exists
          OPEN      ADT,"convadt"
          MOVE      OVRCD,ADTFLAG
          TRAPCLR   IO
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO          * see if conversion file exists
          OPEN      ADTTRAN,"convtran"
          MOVE      OVRCD,TRNFLAG
          TRAPCLR   IO
.
          IF        ADTFLAG=1 & TRNFLAG=1
            DISPLAY   *P1:24,*EL,*B,"Data files not found.  ";
            CALL      HITENTER
            GOTO      INIT9500
          ENDIF
.
INIT9000  MOVE      ZERO,EXIT
          GOTO      INIT9999
.
INIT9500  MOVE      ONE,EXIT
INIT9999  RETURN
+
.******************************************************************************
.*                                  OPTN0000                                  *
.*                                Select Option                               *
.******************************************************************************
OPTN0000  MOVE      FALSE,EXIT
          DISPLAY   *P1:4,"This program converts all data in the ":
                    "convadt & convtran files";
          KEYIN     *P1:24,*EL,"Ok to Continue (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          GOTO      OPTN9000 IF EQUAL
.
          MATCH     ANSN,ANS
          GOTO      OPTN9500 IF EQUAL
.
          BEEP
          GOTO      OPTN0000
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
OPTN9999  RETURN
+
.******************************************************************************
.*                                  CLER0000                                  *
.*                      Clear The Files Before Proceeding                     *
.******************************************************************************
CLER0000  KEYIN     *P1:24,*EL,*B,"Clear the files before proceeding (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          GOTO      CLER1000 IF EQUAL
.
          MATCH     ANSN,ANS
          GOTO      CLER9000 IF EQUAL
.
          BEEP
          GOTO      CLER0000
.
CLER1000  DISPLAY   *P1:24,*EL,"Checking mrtpdsaf",*W;
          EXECUTE   "ldat mrtpdsaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving mrtpdsaf",*W;
          EXECUTE   "cp `ldat mrtpdsaf.dat` savpdsaf.dat",TASKID
          EXECUTE   "cp `ldat mrtpdsaf.idx` savpdsaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting mrtpdsaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating mrtpdsaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 71 UC1-8",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking mrtpshaf",*W;
          EXECUTE   "ldat mrtpshaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving mrtpshaf",*W;
          EXECUTE   "cp `ldat mrtpshaf.dat` savpshaf.dat",TASKID
          EXECUTE   "cp `ldat mrtpshaf.idx` savpshaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting mrtpshaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating mrtpshaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 65 UC1-8,9-16,17-21",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking patdadaf",*W;
          EXECUTE   "ldat patdadaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patdadaf",*W;
          EXECUTE   "cp `ldat patdadaf.dat` savdadaf.dat",TASKID
          EXECUTE   "cp `ldat patdadaf.idx` savdadaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patdadaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patdadaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 30 UC1-8",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking patdschf",*W;
          EXECUTE   "ldat patdschf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patdschf",*W;
          EXECUTE   "cp `ldat patdschf.dat` savdschf.dat",TASKID
          EXECUTE   "cp `ldat patdschf.idx` savdschf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patdschf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patdschf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 240 UC9-16 UC17-24,9-16",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking paticuaf",*W;
          EXECUTE   "ldat paticuaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving paticuaf",*W;
          EXECUTE   "cp `ldat paticuaf.dat` savicuaf.dat",TASKID
          EXECUTE   "cp `ldat paticuaf.idx` savicuaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting paticuaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating paticuaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 52 UC1-8",CMDLINE                                     * @@
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking patmi1af",*W;
          EXECUTE   "ldat patmi1af.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patmi1af",*W;
          EXECUTE   "cp `ldat patmi1af.dat` savmi1af.dat",TASKID
          EXECUTE   "cp `ldat patmi1af.idx` savmi1af.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patmi1af",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patmi1af",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 620 UC1-8 UC33-33,1-8",CMDLINE
          APPEND    " UC17-24,1-8 UC424-431,1-8",CMDLINE
          APPEND    " UC33-33,64-69,52-54,55-57,1-8 UC33-33,52-54,17-24,1-8",CMDLINE
          APPEND    " UC64-69,33-33,424-431,1-8",CMDLINE                    * @@
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Checking patre1af",*W;
          EXECUTE   "ldat patre1af.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patre1af",*W;
          EXECUTE   "cp `ldat patre1af.dat` savre1af.dat",TASKID
          EXECUTE   "cp `ldat patre1af.idx` savre1af.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patre1af",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patre1af",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 227 UC1-8",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.
          DISPLAY   *P1:24,*EL,"Checking pattranf",*W;
          EXECUTE   "ldat pattranf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving pattranf",*W;
          EXECUTE   "cp `ldat pattranf.dat` savtranf.dat",TASKID
          EXECUTE   "cp `ldat pattranf.idx` savtranf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting pattranf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating pattranf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 220 UC1-3,4-6,7-14,15-22,32-39 UC32-39,7-14,15-22,1-3,4-6",CMDLINE
          APPEND    " UC75-80,7-14,15-22,1-3,4-6,32-39 UC1-3,7-14,15-22,4-6,32-39",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Checking patvisaf",*W;
          EXECUTE   "ldat patvisaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL;"Saving patvisaf",*W;
          EXECUTE   "cp `ldat patvisaf.dat` savvisaf.dat",TASKID
          EXECUTE   "cp `ldat patvisaf.idx` savvisaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patvisaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patvisaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 64 UC17-24 UC1-8,9-16,17-24",CMDLINE
          APPEND    " UC27-32,9-16,17-24",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
. --------------------------                             Visit Extension
          DISPLAY   *P1:24,*EL,"Checking pmsvx1af",*W;
          EXECUTE   "ldat pmsvx1af.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving pmsvx1af",*W;
          EXECUTE   "cp `ldat pmsvx1af.dat` savvx1af.dat",TASKID
          EXECUTE   "cp `ldat pmsvx1af.idx` savvx1af.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting pmsvx1af",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating pmsvx1af",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 629 UC1-8 UC9-16,1-8",CMDLINE
          RESET     CMDLINE
.
. --------------------------                     Special Funding Arrangements
          DISPLAY   *P1:24,*EL,"Checking patasfaf",*W;
          EXECUTE   "ldat patasfaf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patasfaf",*W;
          EXECUTE   "cp `ldat patasfaf.dat` savasfaf.dat",TASKID
          EXECUTE   "cp `ldat patasfaf.idx` savasfaf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patasfaf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patasfaf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 39 UC1-8,9-9,10-17,18-25",CMDLINE
          RESET     CMDLINE
.
. --------------------------                             Grouper Details
          DISPLAY   *P1:24,*EL,"Checking patpgraf",*W;
          EXECUTE   "ldat patpgraf.dat > temp.txt",TASKID
          CALL      FFLP0000                * Find file path
          BRANCH    EXIT,CLER9500
.
          DISPLAY   *P1:24,*EL,"Saving patpgraf",*W;
          EXECUTE   "cp `ldat patpgraf.dat` savpgraf.dat",TASKID
          EXECUTE   "cp `ldat patpgraf.idx` savpgraf.idx",TASKID
.
          DISPLAY   *P1:24,*EL,"Deleting patpgraf",*W;
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    KEY99,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,"Creating patpgraf",*W;
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    KEY99,CMDLINE
          APPEND    " 150 UC1-8,9-10,11-13 UC1-8,11-13,9-10",CMDLINE
          RESET     CMDLINE
.
CLER9000  MOVE      ZERO,EXIT
          GOTO      CLER9999
.
CLER9500  MOVE      ONE,EXIT
CLER9999  RETURN
+
.******************************************************************************
.*                                  FFLP0000                                  *
.*                               Find File Path                               *
.******************************************************************************
FFLP0000  CLOSE     TEMP
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TEMP,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,FFLP3000
.
          READ      TEMP,SEQ;KEY99
          GOTO      FFLP3000 IF OVER
.
          ENDSET    KEY99
FFLP1000  CMATCH    ".",KEY99
          GOTO      FFLP2000 IF EQUAL
.
          BUMP      KEY99,-1
          GOTO      FFLP1000 IF NOT EOS
          GOTO      FFLP3000
.
FFLP2000  BUMP      KEY99,-1
          LENSET    KEY99
          RESET     KEY99
          PACK      KEY99,KEY99,SP127
          STRIP     KEY99
          GOTO      FFLP9000
.
FFLP3000  DISPLAY   *P1:24,*EL,*B,"Error clearing files.  Files not cleared.  ";
          CALL      HITENTER
          GOTO      FFLP9500
.
FFLP9000  MOVE      ZERO,EXIT
          GOTO      FFLP9999
.
FFLP9500  MOVE      ONE,EXIT
FFLP9999  RETURN
+
.******************************************************************************
.*                                  OPEN0000                                  *
.*                                 Open Files                                 *
.******************************************************************************
OPEN0000  DISPLAY   *P1:24,*EL,*P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          DISPLAY   *P64:24,"ibapostf";
          OPEN      IBAPOST1,"ibapostf"
.
          DISPLAY   *P64:24,"mrtpdsaf";
          OPEN      MRTPDSA1,"mrtpdsaf"
.
          DISPLAY   *P64:24,"mrtpshaf";
          OPEN      MRTPSHA1,"mrtpshaf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdadaf";
          OPEN      PATDADA1,"patdadaf"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"                                *I-90209
.
          DISPLAY   *P64:24,"paticuaf";
          OPEN      PATICUA1,"paticuaf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patre1af";
          OPEN      PATRE1A1,"patre1af"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
. ------------------------- Start of Addition for RCH/SVHM ---------------- @@
.                                        Special Funding Arrangement Codes
          DISPLAY   *P64:24,"patasfaf";
          OPEN      PATASFA1,"patasfaf"
.                                        Patient Grouper Details
          DISPLAY   *P64:24,"patpgraf";
          OPEN      PATPGRA1,"patpgraf"
.                                        Visit Extension Table
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
. --------------------------- End of Addition for RCH/SVHM ---------------- @@
OPEN9999  RETURN
+
.******************************************************************************
.*                                  PROC0000                                  *
.*                   Routine to process the convadt.txt file                  *
.******************************************************************************
PROC0000  CLOCK     TIME,CTIMEIS
          MOVE      ZERO,CLNO
          MOVE      ZERO,COUNT
          MOVE      ZERO,COUNTTDE
          CALL      TOTL0000                * Reset Total Counts       *I-90206
          MOVE      SP4,PASSCODE                                       *I-90206
.
          CALL      HEAD0000                * print the error report header
.
          PRINT     *1,"|",*14,"|",*30,"| ":                           *I-90202
                    *50,"Errors on 'convadt.txt'",*132,"|"             *I-90202
          ADD       ONE,CLNO                                           *I-90206
.
          DISPLAY   *P1:6,"Started : ",*V2LON,CTIMEIS,*HOFF:
                    *P30:6,"Finished : ":
                    *P1:8,"Processing U/R       : ":
                    *P1:9,"Admission No.        : ":
                    *P1:10,"Record count         : ";
.
          BRANCH    ADTFLAG,PROC5000
.
.------ read the next record from the convadt file ------
.
PROC1000  MOVE      ZERO,DATAERR                                       *I-90216
          TRAP      FERR0000 IF FORMAT                                 *I-90216
.
          READ      ADT,SEQ;TMPUR,TMPADMIS,TMPADATE,TMPATIME,TMPWARD:
                            TMPBED,TMPRDOC,TMPADOC,TMPLDOC,TMPASRCE:
                            TMPATYPE,TMPACLSS,TMPADIAG,TMPCLAIM,TMPCARE:
                            TMPLSSET,TMPHFUND,TMPHFTBL,TMPMEMB,TMPRELIG:
                            TMPAUSR1,TMPAUSR2,TMPAUSR3,TMPAUSR4,TMPAUSR5:
                            TMPAUSR6,TMPAUSR7,TMPAUSR8,TMPAUSR9,TMPAUSR0:
                            TMPADMWT,TMPCDCMP,TMPDDATE,TMPDTIME,TMPDSTAT:
                            TMPDDEST,TMPDIAG,TMPTRAN,TMPSSREF:
                            TMPDUSR1,TMPDUSR2,TMPDUSR3,TMPDUSR4,TMPDUSR5:
                            TMPGEPNO,TMPGSDRG,TMPGSMDC,TMPSEVIX,TMPGRVER:
                            TMPGWFIX,TMPGWVAR,TMPGWTOL,TMPGSWGT,TMPGSALS:
                            TMPGWWTU,TMPGWWTD,TMPICUH,TMPHOMV,TMPPRANM:
                            TMPPRAA1,TMPPRAA2,TMPPRAA3,TMPPRAA4,TMPPRAPC:
                            TMPPRAPP,TMPPRABP,TMPPRARE,TMPPDDAT,TMPPDTIM:
                            TMPPDDOC,TMPPDSTA,TMPXABRG,TMPXCADM,TMPXIRAD:
                            TMPXIDUS,TMPXCRAV,TMPXAPWD,TMPXAPBD,TMPXPOWD:
                            TMPXPOBD,TMPXPSTY,TMPXVALW,TMPXPALW,TMPXINDC:
                            TMPXMDAV,TMPXFRMS,TMPXCSNG,TMPCHNCU,TMPCUCCU:
                            TMPXPWGT,TMPXPHGT,TMPXDHWR,TMPFTYPE,TMPFDATE:
                            TMPFTIME,TMPFCODE,TMPFCTYP,TMPFCROL,TMPFCSID:
                            TMPXRCCT,TMPAADTS,TMPXPOST,TMPDWARD,TMPDBED
.
          TRAPCLR   FORMAT                                             *I-90216
.
          GOTO      PROC5000 IF OVER
          BRANCH    DATAERR,PROC1000        * Get next record          *I-90216
.
          MOVE      TMPADMIS,FORM8          * Strip Leading Zeros      *I-90202
          MOVE      FORM8,TMPADMIS          * By moving to DIM & Back  *I-90202
          REP       " 0",TMPADATE
.
          PACK      DIM10,TMPDWARD,TMPDBED,SP10  * Fix NULL Ward & Bed  I-90210
          UNPACK    DIM10,TMPDWARD,TMPDBED                             *I-90210
.
          ADD       ONE,COUNT
          ADD       ONE,COUNTIN                                        *I-90206
          IF        COUNT%100=1
            DISPLAY   *P24:8,*V2LON,TMPUR:
                      *P24:9,TMPADMIS:
                      *P24:10,COUNT;
          ENDIF
.
. check if patient exists on master file
.
          PACK      KEY8,TMPUR
          CALL      RDMAST1                 * read the patient master file
          IF        OVRCD=1
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "UR not found on PMI Master file",*132,"|"       *I-90202
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTREJ                                     *I-90206
            GOTO      PROC1000
          ENDIF
.
.------ check if admission number exists ------
.
          IF        TMPADMIS=0
. ----      PI      4                                                   D-90216
            MOVE    " 10",PRXCODE   * System Lock Sector 10
            CALL    GETSLK00        * Get System Lock of Sector 10
            READ    CONTROLF,TEN;*1,AADMNO
            MOVE    AADMNO,TMPADMIS
            ADD     ONE,AADMNO
            WRITAB  CONTROLF,TEN;*1,AADMNO
            CALL    RELSLK00        * Release System Lock of Sector 10
          ENDIF
.
. ------- Check visit file -------
.
          MOVE      ZERO,UPDTREQD                                          * @@
          PACK      KEY8,TMPADMIS
          CALL      RDVISA1                 * read the patient visit file
          IF        OVRCD = 0
            MOVE      ONE,UPDTREQD                                         * @@
          ENDIF
.
          MOVE      TMPUR,PVIURNO
          MOVE      TMPADATE,PVIDATE
          MOVE      TMPADMIS,PVIBILL
          MOVE      THREE,PVITYPE
          MOVE      TMPADOC,PVIDOCT
          PACK      KEY5,ANSA,SP1,TMPATYPE
          CALL      RDCODE1                 * read the patient codes file
          IF        OVRCD = 1
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Admission Type",*47,TMPATYPE,*52,"not on codes file": 
                      " - Admission bypassed",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ",*V2LON:
                             TMPADMIS;
.
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTREJ                                     *I-90206
            GOTO      PROC1000
          ELSE
. -----     TYPE      TCINDC1
. -----     IF        !@EQUAL
. -----       PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
. -----                 "Admission Type indicator TCINDC1 not numeric":
. -----                 " - Admission bypassed",*132,"|"
. -----       DISPLAY   *P1:24,*EL,*B,"Error with admission number : ",*V2LON:
. -----                        TMPADMIS;
.
. -----       CALL      CPAG0000            * check for new page
. -----       ADD       ONE,COUNTREJ                                   *I-90206
. -----       GOTO      PROC1000
. -----     ENDIF
            MOVE      TCINDC1,FORM1
            MOVE      FORM1,PVISTAT                                    *I-90202
. --------------------------------------------------------------------- D-90202
. -----     IF        (FORM1 = 1) | (FORM1 = 2)                         D-90202
. -----       MOVE      FORM1,PVISTAT                                   D-90202
. -----     ELSE                           -- 
. -----       PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
. -----                 "Admission Type indicator TCINDC1 is not '1' or '2'":
. -----                 *132,"|"
. -----       DISPLAY   *P1:24,*EL,*B,"Error with admission number : ",*V2LON:
. -----                        TMPADMIS;
. -----       CALL      CPAG0000            * check for new page
. -----       GOTO      PROC1000
. -----     ENDIF                                                       
. --------------------------------------------------------------------- D-90202
          ENDIF
          MOVE      ZERO,PVITRAN
          MOVE      SP2,PVILOCK
          MOVE      SP6,PVISITE
          MOVE      SP3,PVIRESI
          MOVE      SP1,PVIUNQE
          MOVE      SP20,PVISPAR
.
          PACK      KEY8,TMPADMIS
          IF        UPDTREQD = 0
            CALL      WRPTVIS1              * write to the visit file
            ADD       ONE,COUNTVWR                                     *I-90206
          ELSE
            CALL      UPPTVIS1
            ADD       ONE,COUNTVUP                                     *I-90206
          ENDIF
. ------------------------- Start of Addition for RCH/SVHM ---------------- @@
.------ write the visit extension file --------
.
          MOVE      ZERO,UPDTEXTN 
          PACK      KEY8,TMPADMIS
          CALL      RDPMVX11                * read the visit extension file
          IF        OVRCD = 0
            MOVE      ONE,UPDTEXTN
          ENDIF
.
          MOVE      TMPADMIS,PMVXVISN
          MOVE      TMPADATE,PMVXVSDT
          MOVE      TMPADOC,PMVXDOCA
          MOVE      ZERO,PMVXINGP
          MOVE      ZERO,PMVXCFSG
          UNPACK    SP127,PMVXDOCT,PMVXCSNR,PMVXPIND,PMVXVLOC
          UNPACK    SP127,PMVXCPTH,PMVXHCP1,PMVXHCP2,PMVXHCP3,PMVXHCP4
          UNPACK    SP127,PMVXRHC1,PMVXRH1G,PMVXRH1C,PMVXRHC2,PMVXRH2G,PMVXRH2C
          UNPACK    SP127,PMVXRHC3,PMVXRH3G,PMVXRH3C,PMVXRHC4,PMVXRH4G,PMVXRH4C
          MOVE      TMPXABRG,PMVXABRG
          MOVE      TMPXCADM,PMVXCADM
          MOVE      TMPXIRAD,PMVXIRAD
          MOVE      TMPXIDUS,PMVXIDUS
          MOVE      TMPXCRAV,PMVXCRAV
          MOVE      TMPXAPWD,PMVXAPWD
          MOVE      TMPXAPBD,PMVXAPBD
          MOVE      TMPXPOWD,PMVXPOWD
          MOVE      TMPXPOBD,PMVXPOBD
          MOVE      TMPXPSTY,PMVXPSTY
          MOVE      TMPXVALW,PMVXVALW
          MOVE      TMPXPALW,PMVXPALW
          MOVE      TMPXINDC,PMVXINDC
          MOVE      TMPXMDAV,PMVXMDAV
          MOVE      TMPXFRMS,PMVXFRMS
          MOVE      TMPXCSNG,PMVXCSNG
          MOVE      TMPXPWGT,PMVXPWGT
          MOVE      TMPXPHGT,PMVXPHGT
          MOVE      TMPXDHWR,PMVXDHWR
          MOVE      TMPXRCCT,PMVXRCCT
          MOVE      TMPXPOST,PMVXPOST
          MOVE      TMPMEMB,PMVXFNDM
          UNPACK    SP127,PMVXEDC1,PMVXEDC2,PMVXEDC3,PMVXHOME
          UNPACK    SP127,PMVXUDF1,PMVXUDF2
          UNPACK    SP127,PMVXUDF3,PMVXUDF4
          UNPACK    SP127,PMVXUDT1,PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6
          UNPACK    SP127,PMVXCDTE,PMVXCTIM,PMVXWEBC,PMVXLUPD,PMVXLUPT
          UNPACK    SP127,PMVXMHLS,PMVXSPAR
.
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP20
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            MOVE      SP10,PMVXASGC
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,PROC1500
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF                                                 * end *I-240184
.          
PROC1500  PACK      KEY8,TMPADMIS
          IF        UPDTEXTN = 0
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPGID
            MOVE      SP70,PMVXPILC
            CALL      WRPMVX11                * write visit extension file
          ELSE
            CALL      UPPMVX11                * update visit extension
          ENDIF

. --------------------------- END of Addition for RCH/SVHM ----------------- @@
.
.------ check the admission file ------
.
PROC2000  MOVE      ZERO,UPDTADMN
          PACK      KEY8,TMPADMIS
          CALL      RDMISS1                 * Read admission file
.
          COMPARE   ONE,OVRCD               * 
          GOTO      PROC2600 IF EQUAL       * Admission does not yet exist
.
          MOVE      ONE,UPDTADMN   
.                                           * Check that data that is part
.                                           * of other file keys is not altered
          MATCH     ADATE,TMPADATE
          IF        !@EQUAL
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Changing admission date (Key data in Transfer). ":
                      " - Date will not be altered.",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
                      *V2LON,TMPADMIS;
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
            MOVE      ADATE,TMPADATE
            GOTO      PROC2500
          ENDIF
.
          MATCH     ATIME,TMPATIME
          IF        !@EQUAL
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Changing admission time (Key data in Transfer). ":
                      " - Admission Time will not be altered",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
                      *V2LON,TMPADMIS;
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
            MOVE      ATIME,TMPATIME
            GOTO      PROC2500
          ENDIF
.
          MATCH     ATYPE,TMPATYPE
          IF        !@EQUAL
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Changing admission type. ":      
                      " Admission type will not be altered",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
                      *V2LON,TMPADMIS;
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
            MOVE      ATYPE,TMPATYPE
            GOTO      PROC2500
          ENDIF
.
. -------------------------------- Ward & Bed are blank if patient discharged
.
          MATCH     SP8,TMPDDATE            * Check if Discharged      *I-90205
          GOTO      PROC2500 IF NOT EQUAL   * bypass Ward/Bed check    *I-90205
.
          MATCH     AWARD,TMPWARD
          IF        !@EQUAL
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Changing admission ward (Key to Transfers). ":      
                      " - Admission Ward will not be altered",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
                      *V2LON,TMPADMIS;
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
            GOTO      PROC2500
          ENDIF
.
          MATCH     ABED,TMPBED
          IF        !@EQUAL
            PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                      "Changing admission bed (Key to Transfers). ":      
                      " - Admission Bed not be altered",*132,"|"
            DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
                      *V2LON,TMPADMIS;
            CALL      CPAG0000              * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
            GOTO      PROC2500
          ENDIF
.
PROC2500  MATCH     ADOCTA,TMPADOC
. ------  IF        !@EQUAL
. ------    PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
. ------              "Changing admission doctor. ":      
. ------              " - Admission file not updated.",*132,"|"
. ------    DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":
. ------              *V2LON,TMPADMIS;
. ------    CALL      CPAG0000            * check for new page
. ------    ADD       ONE,COUNTERR                                   *I-90206
. ------    GOTO      PROC2600
. ------  ENDIF
.
.
PROC2600  IF        UPDTADMN = 0
            CALL      CLPATMIS                * clear the admission file vars
            MOVE      TMPADMIS,AADMNO
            MOVE      TMPUR,AURNO
            MOVE      TMPADATE,ADATE
            MOVE      TMPATIME,ATIME
          ENDIF
.
          MOVE      ONE,ASTAT
          MOVE      ONE,AINVPRT
          MOVE      TMPDDATE,ALACDTE
          MATCH     SP8,TMPDDATE            * Check if Discharged      *I-90205
          IF        @EQUAL
            MOVE      TMPWARD,AWARD
            MOVE      TMPBED,ABED
          ELSE                              * Discharged               *I-90205
            MOVE      SP3,AWARD                                        *I-90205
            MOVE      SP3,ABED                                         *I-90205
            MOVE      THREE,ASTAT                                      *I-90205
            MOVE      ONE,ADSCHI                                       *I-90205
          ENDIF                                                        *I-90205
.
          MOVE      TMPADOC,ADOCTA
          MOVE      TMPLDOC,ADOCTL
          MOVE      TMPASRCE,ASRCE
          MOVE      TMPATYPE,ATYPE
          MOVE      TMPACLSS,ACLSS
          MOVE      TMPCARE,ACARE
          MOVE      TMPHFUND,AFUNDH
          MOVE      TMPHFTBL,AFNDTB
          MOVE      TMPMEMB,AFNDMM
          MOVE      TMPRELIG,AVISIT
          UNPACK    TMPADIAG,ADIAG1,ADIAG2
          MOVE      TMPCLAIM,ACLAIM
          MOVE      TMPLSSET,ACLSSFT 
          MOVE      TMPAUSR1,AUSR1
          MOVE      TMPAUSR2,AUSR2
          MOVE      TMPAUSR3,AUSR3
          MOVE      TMPAUSR4,AUSR4
          MOVE      TMPAUSR5,AUSR5
          MOVE      TMPAUSR6,AUSR6
          MOVE      TMPAUSR7,AUSR7
          MOVE      TMPRDOC,ARDRNAM
          MOVE      TMPCDCMP,ACODDTE
          MATCH     SP10,ACODDTE                                       *I-90215
          IF        !@EQUAL 
            REP       " 0",ACODDTE
          ENDIF                                                        *I-90215
          PACK      ABWGHT,SP2,TMPADMWT
          MOVE      TMPAUSR8,PTMIUSR8
          MOVE      TMPAUSR9,PTMIUSR9
          MOVE      TMPAUSR0,PTMIUSR0
.
          IF        UPDTADMN = 0
            CALL      WRMISS1A              * write to the admissions file
            ADD       ONE,COUNTAWR                                     *I-90206
          ELSE
            CALL      UPMISS1               * update the admissions file
            ADD       ONE,COUNTAUP                                     *I-90206
          ENDIF
.
. ------- Check transfer file -------
.
PROC2700  MOVE      ZERO,UPDTREQD
          PACK      KEY30,TMPWARD,TMPBED,TMPADATE,TMPATIME,TMPADMIS
          CALL      RDTRAN1                 * read the transfer file
          IF        OVRCD = 0
            MOVE      ONE,UPDTREQD                                         * @@
          ELSE                                    
            CALL      CLTR0000              * Clear transfer file variables
          ENDIF
.
          MOVE      TMPWARD,TWARD
          MOVE      TMPBED,TBED
          MOVE      TMPADATE,TDATE
          MOVE      TMPATIME,TTIME
          MOVE      ANSA,TMOVE
          MOVE      TMPUR,TURNO
          MOVE      TMPADMIS,TADMN
          MOVE      TMPATYPE,TATYPE
          MOVE      TMPADOC,TADOCT
          MOVE      TMPLSSET,TDEPT                                         * @@
.
          IF        UPDTREQD = 0 
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      SP70,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN1                 * write to the transfer file
            ADD       ONE,COUNTTWR                                     *I-90206
          ELSE
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      SP70,PTTRUUID
            CALL      UPTRAN1                 * update transfer record
            ADD       ONE,COUNTTUP                                     *I-90206
          ENDIF
.
. ----- Write an ICU file record -----
.
PROC3000  IF        TMPICUH <> 0 | TMPHOMV <> 0 | TMPCHNCU <> 0 | TMPCUCCU <> 0
            MOVE      ZERO,PTICUINT
            MOVE      ZERO,PTICUMEC
            MOVE      ZERO,PTICHNCU                                    * @@
            MOVE      ZERO,PTICUCCU                                    * @@
            PACK      KEY8,TMPADMIS
            CALL      RDPTICU1                   * Read an ICU file record
.
            MOVE      TMPADMIS,PTICUADM
            MOVE      TMPICUH,PTICUINT
            MOVE      TMPHOMV,PTICUMEC
            MOVE      TMPCHNCU,PTICHNCU                                    * @@
            MOVE      TMPCUCCU,PTICUCCU                                    * @@
            MOVE      ZERO,PTICCPAP
            MOVE      SP70,PTICAMBN
            MOVE      SP20,PTICUSPR
            IF        OVRCD=1
              CALL      WRPTICU1                 * Write an ICU file record
              ADD       ONE,COUNTIWR                                   *I-90206
            ELSE
              CALL      UPPTICU1                 * Update an ICU file record
              ADD       ONE,COUNTIUP                                   *I-90206
            ENDIF
          ENDIF
.
. ----- Special Funding Arrangements -----
.
PROC3200  MATCH     SP8,TMPFDATE
          GOTO      PROC3300 IF EQUAL
.
          PACK      KEY25,TMPADMIS,TMPFTYPE,TMPFDATE,TMPFTIME
          CALL      RDPTASF1                * Read Special Funding Arr. file
.
          MOVE      TMPADMIS,PTAFADMN
          MOVE      TMPFTYPE,PTAFTYPE
          MOVE      TMPFDATE,PTAFDATE
          MOVE      TMPFTIME,PTAFTIME
          MOVE      TMPFCODE,PTAFCODE
          MOVE      TMPFCTYP,PTAFCTYP
          MOVE      TMPFCROL,PTAFCROL
          MOVE      TMPFCSID,PTAFCSID
          MOVE      SP5,PTAFSPAR
.
          IF        OVRCD=1
            CALL      WRPTASF1
            ADD       ONE,COUNTSWR                                     *I-90206
          ELSE
            CALL      UPPTASF1
            ADD       ONE,COUNTSUP                                     *I-90206
          ENDIF
.
. ------- Write Grouper Details -------
.
PROC3300  MATCH     SP2,TMPGEPNO
          GOTO      PROC3500 IF EQUAL
.
          MOVE      TMPGEPNO,FORM2          * Remove leading zero      *I-90206
          MOVE      FORM2,TMPGEPNO                                     *I-90206
.
          MATCH     SP70,TMPGSDRG
          GOTO      PROC3500 IF EQUAL
.
          PACK      KEY13,TMPADMIS,TMPGEPNO,TMPGRVER
          CALL      RDPTPGR1                * Read Grouper Details
.
          MOVE      TMPADMIS,PTPGADMN       * Admission No
          MOVE      TMPGEPNO,PTPGEPNO       * Episode No
          MOVE      TMPGRVER,PTPGGPVR       * Grouper Version
.
          MOVE      TMPGSDRG,PTPGNDRG       * National DRG
          MOVE      TMPGSMDC,PTPGNMDC       * National MDC
          MOVE      TMPGSWGT,PTPGNWGT       * National Weight
          MOVE      TMPGSALS,PTPGNALS       * National Avg Los
.
          MOVE      TMPGSDRG,PTPGSDRG       * State DRG
          MOVE      TMPGSMDC,PTPGSMDC       * State MDC
          MOVE      TMPGSWGT,PTPGSWGT       * State Weight
          MOVE      TMPGSALS,PTPGSALS       * State Avg Los
.
          MOVE      TMPGSDRG,PTPGLDRG       * Local DRG
          MOVE      TMPGSMDC,PTPGLMDC       * Local MDC
          MOVE      TMPGSWGT,PTPGLWGT       * Local Weight
          MOVE      TMPGSALS,PTPGLALS       * Local Avg Los 
.
          MOVE      SP70,PTPGPCCL           * Patient CCL Class Level
          MOVE      TMPGWFIX,PTPGWFIX       * WIES value fixed
          MOVE      TMPGWVAR,PTPGWVAR       * WIES value variable
          MOVE      TMPGWTOL,PTPGWTOL       * WIES value total
          MOVE      SP70,PTPGWWTU           * WIES weight used
          MOVE      SP70,PTPGWWTD           * WIES weight description
          MOVE      SP70,PTPGSPAR           * Spare variable
.
          IF        OVRCD=1
            CALL      WRPTPGR1
            ADD       ONE,COUNTGWR                                     *I-90206
          ELSE
            CALL      UPPTPGR1
            ADD       ONE,COUNTGUP                                     *I-90206
          ENDIF
. --------------------------- End of Addition for RCH/SVHM ---------------- @@
.
. --- check person responsible for account ---
.
PROC3500  MATCH     SP20,TMPPRANM
          GOTO      PROC4000 IF EQUAL       * No PRA
.
          PACK      KEY8,TMPADMIS
          CALL      RDRESP1
.
          MOVE      TMPADMIS,PKADMN
          MOVE      TMPPRANM,PKNAME
          MOVE      TMPPRAA1,PKADD1
          MOVE      TMPPRAA2,PKADD2
          MOVE      TMPPRAA3,PKSUBR
          MOVE      TMPPRAA4,PKADD4
          MOVE      TMPPRAPC,PKPOST
          MOVE      TMPPRAPP,PKTELEP
          MOVE      TMPPRABP,PKTELEB
          MOVE      TMPPRARE,PKRELP
.
          IF        OVRCD=1
            CALL      WRRESP1
            ADD       ONE,COUNTPWR                                     *I-90206
          ELSE
            CALL      UPRESP1
            ADD       ONE,COUNTPUP                                     *I-90206
          ENDIF
.
.
PROC4000  MATCH     SP8,TMPDDATE
          GOTO      PROC1000 IF EQUAL       * Patient not yet discharged
.
.   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
.
. ------- Check discharge file -------
.
          REP       " 0",TMPDDATE
.
          MATCH     TMPADATE,TMPDDATE                                  *I-90214
          GOTO      PROC4100 IF NOT EQUAL                              *I-90214
          MATCH     TMPATIME,TMPDTIME                                  *I-90214
          GOTO      PROC4100 IF NOT EQUAL                              *I-90214
.
          PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":     *I-90214
                    "Admission & Discharge Date and time are the ":    *I-90214
                    "same -Discharge info. bypassed",*132,"|"          *I-90214
          DISPLAY   *P1:24,*EL,*B,"Error with admission number : ":    *I-90214
                    *V2LON,TMPADMIS;                                   *I-90214
          CALL      CPAG0000                * check for new page       *I-90214
          ADD       ONE,COUNTERR                                       *I-90214
          GOTO      PROC1000                                           *I-90214
.
.
PROC4100  MOVE      ZERO,BYPASMSG                                      *I-90213
          MATCH     SP8,TMPDWARD            * Check blank Dischg Ward  *I-90213
          IF        @EQUAL
            MOVE      TMPWARD,TMPDWARD                                 *I-90213
            MOVE      TMPBED,TMPDBED                                   *I-90213
            MOVE      ONE,BYPASMSG                                     *I-90213
          ENDIF                                                        *I-90213
.
          PACK      KEY8,TMPADMIS
          CALL      RDDSCH1                 * Is there a discharged record ?
          COMPARE   ONE,OVRCD
          GOTO      PROC4200 IF EQUAL       * Discharge does not exits
.
          MOVE      PTDSDWRD,TMPDWARD
          IF        BYPASMSG=0
            MATCH     DDATE,TMPDDATE
            IF        !@EQUAL
              PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                        "Changing discharge date (a Key field). ":
                        "Discharge file not updated.",*132,"|"
              DISPLAY   *P1:24,*EL,*B,"Error with Discharge File : ":
                        *V2LON,TMPADMIS;
              CALL      CPAG0000          * check for new page
              ADD       ONE,COUNTERR                                   *I-90206
. -----       GOTO      PROC4500                                       *D-90213
.
            ELSE                                                       *C-90213
              MATCH     DTIME,TMPDTIME
              IF        !@EQUAL
                PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                          "Changing discharge time (a Key field). ":
                          "Discharge file not updated.",*132,"|"
                DISPLAY   *P1:24,*EL,*B,"Error with Discharge File : ":
                          *V2LON,TMPADMIS;
                CALL      CPAG0000          * check for new page
                ADD       ONE,COUNTERR                                 *I-90206
. -----         GOTO      PROC4500                                     *D-90213
              ENDIF                         * IF DTIME NE TMPDTIME
            ENDIF                           * IF DDATE NE TMPDDATE
          ENDIF                             * IF BYPASMSG=0            *I-90213
.
.                                           * IF OVRCD=1 (new record)
PROC4200  IF        OVRCD=1
            CALL      CLPATDSC              * Clear discharge file variables
            MOVE      TMPUR,DURNO
            MOVE      TMPDDATE,DDATE
            MOVE      TMPDTIME,DTIME
          ENDIF                                                        *I-90213
.
          MOVE      TMPDSTAT,DSTAT
          MOVE      TMPDDEST,DDEST
          UNPACK    TMPDIAG,DDIAG,DDIAG2
          MOVE      TMPDUSR1,DUSD1
          MOVE      TMPDUSR2,DUSD2
          MOVE      TMPDUSR3,DUSD3
          MOVE      TMPDUSR4,DUSD4
          MOVE      TMPDUSR5,DUSD5
          MOVE      TMPGSDRG,PTDSDDRG                                      * @@
          MOVE      TMPGSMDC,PTDSDMDC                                      * @@
          MOVE      TMPSEVIX,PTDSSIDX
          MOVE      TMPGRVER,PTDSVOGU
          MOVE      TMPDWARD,PTDSDWRD                                  *I-90207
          MOVE      TMPADATE,CDYSFDTE
          MOVE      TMPDDATE,CDYSTDTE
          CALL      CALCDAYS                * Calculate diff between 2 dates
          SUB       ONE,CDYSDAYS
          MOVE      CDYSDAYS,PTDSDLOS
          MOVE      TMPSSREF,PTDSSREF                                      * @@
.
          IF        OVRCD=1
            CALL      WRDSCH1               * write to the discharge file
            ADD       ONE,COUNTDWR                                     *I-90206
          ELSE
            CALL      UPDSCH1               * update the discharge file
            ADD       ONE,COUNTDUP                                     *I-90206
.                                           * If there IS a Discharge  *I-90213
            GOTO      PROC4500              * don' touch the Transfer  *I-90213
          ENDIF
.
          MOVE      "COM",TMPPDSTA          * Set Status to "complete"       @@
.
. ------- Check transfer file -------
.
. ------- PACK      KEY30,TMPWARD,TMPBED,TMPDDATE,TMPDTIME,TMPADMIS     D-90207
          PACK      KEY30,TMPDWARD,TMPDBED,TMPDDATE,TMPDTIME,TMPADMIS  *I-90207
          CALL      RDTRAN1                 * read the transfer file
          IF        OVRCD = 0
            MOVE      TMPATYPE,TATYPE                                   *I-90207
            MOVE      TMPADOC,TADOCT                                    *I-90207
            MOVE      TMPLSSET,TDEPT                                    *I-90207
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      SP70,PTTRUUID
            CALL      UPTRAN1
            GOTO      PROC4500              * DON'T TOUCH               C-90213
          ENDIF
.
          MOVE      TMPDWARD,TWARD                                     *I-90207
          MOVE      TMPDBED,TBED                                       *I-90207
          MOVE      TMPDDATE,TDATE
          MOVE      TMPDTIME,TTIME
          MOVE      TMPADMIS,TADMN                                     *I-90207
          MOVE      ANSD,TMOVE
          MOVE      TMPUR,TURNO                                        *I-90207
          MOVE      TMPATYPE,TATYPE                                    *I-90207
          MOVE      TMPADOC,TADOCT                                     *I-90207
          MOVE      TMPLSSET,TDEPT                                     *I-90207
.
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      SP70,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          CALL      WRTRAN1                 * write to the transfer file
.
          PACK      KEY8,TMPADMIS
          CALL      RDMISS1                 * Read admission file
          IF        OVRCD=0
            MOVE      TMPATYPE,ATYPE                                    *I-90207
            MOVE      TMPADOC,ADOCTA                                    *I-90207
            MOVE      TMPLSSET,ACLSSFT 
            CALL      UPMISS1
          ENDIF
.
          PACK      KEY8,TMPADMIS
          CALL      RDVISA1                 * read the patient visit file
          IF        OVRCD=0
            MOVE      TMPADOC,PVIDOCT
            CALL      UPPTVIS1
          ENDIF
.
          ADD       ONE,COUNTTWR                                       *I-90206
.
. ----- Transfer Destination File -----
.
PROC4500  MATCH     SP5,TMPTRAN
          GOTO      PROC4550 IF NOT EQUAL       * Discharge transfer code
.
          MATCH     SP5,TMPAADTS
          GOTO      PROC4600 IF EQUAL           * Admission transfer code
.
PROC4550  PACK      KEY8,TMPADMIS
          CALL      RDPTDAD1
.
          MOVE      TMPADMIS,PTDAADMN
          MOVE      TMPAADTS,PTDAADTS                                      * @@
          MOVE      TMPTRAN,PTDADCTS
          MOVE      SP20,PTDASPAR
.
          IF        OVRCD=1
            CALL      WRPTDAD1
            ADD       ONE,COUNTUWR                                     *I-90206
          ELSE
            CALL      UPPTDAD1
            ADD       ONE,COUNTUUP                                     *I-90206
          ENDIF
.
. ----- Post Discharge Tracking -----
.
PROC4600  PACK      KEY8,TMPADMIS
          CALL      RDMRPDS1                * Read a post dsc header file rec
.
          MOVE      TMPADMIS,MRPDADMN
          MOVE      TMPPDDOC,MRPDDOCT
          MOVE      TMPPDSTA,MRPDSTAT
          MOVE      TMPPDDAT,MRPDDATE
          MOVE      TMPPDTIM,MRPDTIME
          MOVE      SP70,MRPDRMOR
          MOVE      SP127,MRPDSPAR
.
          IF        OVRCD=1
            CALL      WRMRPDS1              * Write a post dsc header file rec
            ADD       ONE,COUNTWWR                                     *I-90206
          ELSE
            CALL      UPMRPDS1              * Update a post dsc header file rec
            ADD       ONE,COUNTWUP                                     *I-90206
          ENDIF
.
. ----- Post Discharge Tracking History -----
.
          PACK      KEY21,TMPADMIS,TMPPDDAT,TMPPDTIM
          CALL      RDMRPSH1                * Read a post dsc history file rec
.
          MOVE      TMPADMIS,MRPSADMN
          MOVE      TMPPDDAT,MRPSDATE
          MOVE      TMPPDTIM,MRPSTIME
          MOVE      TMPPDSTA,MRPSSTAT
          MOVE      SP30,MRPSCMNT
          MOVE      SP70,MRPDRMOR
          MOVE      SP10,MRPSSPAR
.
          IF        OVRCD=1
            CALL      WRMRPSH1              * Write a post dsc history file rec
          ELSE
            CALL      UPMRPSH1              * Update a post dsc history file rec
          ENDIF
.
.
          GOTO      PROC1000
.
. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
.
. --- Process the Transfers ---
.
PROC5000  CALL      TOTL2000                                           *I-90206
          BRANCH    TRNFLAG,PROC9000
.
          PRINT     *1,"|",*14,"|",*30,"| ":                           *I-90202
                    *50,"Errors on 'convtran.txt'",*132,"|"            *I-90202
          ADD       TWO,CLNO                                           *I-90206
          MOVE      ZERO,COUNT                                         *I-90213
.
PROC5100  MOVE      ZERO,DATAERR                                       *I-90216
          TRAP      FERR2000 IF FORMAT                                 *I-90216
          READ      ADTTRAN,SEQ;XURNO,XADMNO,XTRNDATE,XTRNTIME,XRECTY:
                                XATYPE,XUNIT,XWARD,XBED,XADOCT,XRATE
          TRAPCLR   FORMAT                                             *I-90216
.
          GOTO      PROC9000 IF OVER
          BRANCH    DATAERR,PROC5100        * next record if data error I-90216
.
          ADD       ONE,COUNT                                          *I-90213
          ADD       ONE,COUNTIN                                        *I-90206
          IF        COUNT%100=1
            DISPLAY   *P24:8,*V2LON,XURNO:                             *I-90213
                      *P24:9,XADMNO:                                   *I-90213
                      *P24:10,COUNT;                                   *I-90213
          ENDIF                                                        *I-90213
          MOVE      ZERO,BYPASMSG                                      *I-90213
.
          MOVE      XADMNO,DIM8             * Strip Leading Zeros      *I-90202
          MOVE      DIM8,XADMNO             * By moving to DIM & back  *I-90202
.
.                                ------------------------------------- *I-90204
.                                Check to see if a new Admission is about to
.                                be processed - if so, go and check that the
.                                previous set of Transfers finished in the same
.                                Ward/Bed as the Discharge
          COMPARE   XADMNO,LSTADMNO                                    *I-90204
          CALL      WBCK0000 IF NOT EQUAL                              *I-90204
.
          MOVE      XADMNO,LSTADMNO                                    *I-90204
.
.                                           ----------------------------------
.                                           Now read the PMI Master, Admission,
.                                           and Discharge records for this
.                                           Transfer    
          MATCH     XURNO,PURNO
          IF        !@EQUAL
            PACK      KEY8,XURNO
            CALL      RDMAST1               * read PMI patient master file
            IF        OVRCD=1
              PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ":
                        "UR not found on PMI Master file",*132,"|"     *I-90202
              CALL      CPAG0000            * check for new page
              ADD       ONE,COUNTREJ                                   *I-90206
              GOTO      PROC5100
            ENDIF
          ENDIF
.
          COMPARE   XADMNO,AADMNO
          IF        !@EQUAL     
            PACK      KEY8,XADMNO
            CALL      RDMISS1               * read Admission file
            IF        OVRCD=1
              PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ": 
                        "Admission not found for this Transfer",*132,"|" 
              CALL      CPAG0000            * is new page wanted ?
              ADD       ONE,COUNTREJ                                   *I-90206
              GOTO      PROC5100
            ELSE
              MOVE      XATYPE,ATYPE        * admission type
              MOVE      XADOCT,ADOCTA       * attending doctor
              MOVE      XUNIT,ACLSSFT       * unit
              CALL      UPMISS1
            ENDIF
.
            MOVE      SP10,DTIME                                       *I-90203
            PACK      KEY8,XADMNO
            CALL      RDDSCH1               * read Discharge file
            IF        OVRCD=1
              PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ": 
                        "Discharge Record not found",*132,"|"          *I-90202
              CALL      CPAG0000            * check for new page
              ADD       ONE,COUNTREJ                                   *I-90206
              GOTO      PROC5100
            ENDIF
          ENDIF
.
          MOVE      ZERO,UPDTTRAN                                      *I-90209
.                                           ---------------------------------
.                                           Now check that the Transfer 
.                                           is in the correct Date/Time range
.
.                                           First, check "A" type against
.                                           the Admission Date & Time
          MATCH     ANSA,XRECTY                                        *I-90213
          IF        @EQUAL
            MOVE      ONE,ERRORNO
            MATCH     ADATE,XTRNDATE
            GOTO      PROC8500 IF NOT EQUAL 
            MATCH     ATIME,XTRNTIME                                 
            GOTO      PROC8500 IF NOT EQUAL 
            GOTO      PROC5900
          ENDIF
.
.                                           Check "D" type against Discharge
.                                           Date & Time
          MATCH     ANSD,XRECTY 
          IF        @EQUAL
            MOVE      TWO,ERRORNO
            MATCH     DDATE,XTRNDATE
            GOTO      PROC8500 IF NOT EQUAL 
            MATCH     DTIME,XTRNTIME                                 
            GOTO      PROC8500 IF NOT EQUAL 
            GOTO      PROC5900
          ENDIF
.
.                                           ---------------------------------
.                                           Check all other Transfer types  
.                                           (C, L & R) against the Date range
PROC5200  MOVE      THREE,ERRORNO
          MATCH     ADATE,XTRNDATE
          GOTO      PROC8500 IF LESS        * Date before Admission date
.
          MATCH     ADATE,XTRNDATE          * Check against Admission Date
          IF        @EQUAL
            MATCH     ATIME,XTRNTIME    
            GOTO      PROC8500 IF LESS      * Time is before Admiss.
            MOVE      SIX,ERRORNO
            MATCH     ATIME,XTRNTIME    
            GOTO      PROC8500 IF EQUAL     * Time is equal to Admiss.
          ENDIF
.
          MOVE      FOUR,ERRORNO
          MATCH     XTRNDATE,DDATE          * check against Discharge date
          GOTO      PROC8500 IF LESS        * Greater than Discharge date
.
          MATCH     DDATE,XTRNDATE
          IF        @EQUAL                             
            MATCH     DTIME,XTRNTIME 
            GOTO      PROC8500 IF NOT LESS  * Time is after Discharge
          ENDIF
.         
.                                           -------------------------------
.                                           * See if C, L and R Transfers 
.                                           * are in correct order
.                                           * First, find any Transfer on 
.                                           * "pattranf.dat" before this one
PROC5600  MOVE      ZERO,OVRCD
.
          MOVE      "99999999",TADMN
          PACK      KEY30,XADMNO,XTRNDATE,ZED30
          CALL      RDTRAN2                 * position on transfer file
          MOVE      DTADMN,TADMN
.
PROC5610  COMPARE   TADMN,XADMNO
          GOTO      PROC5620 IF LESS        * Read too far forward     
          COMPARE   XADMNO,TADMN
          GOTO      PROC5900 IF NOT EQUAL   * Finished this Admission 
.
          MATCH     XTRNDATE,TDATE
          GOTO      PROC5650 IF LESS
          MATCH     XTRNTIME,TTIME
          GOTO      PROC5650 IF LESS
.
PROC5620  CALL      RDPTRAN2                * Read Previous Transfer   
          COMPARE   ONE,OVRCD
          GOTO      PROC5900 IF EQUAL
.
          GOTO      PROC5610
.
.
PROC5650  MOVE      ZERO,OVRCD                                         *I-90210
          MATCH     "A",TMOVE
          GOTO      PROC5900 IF EQUAL       * Admission - anything can follow	
.
          MATCH     "C",TMOVE
          GOTO      PROC5900 IF EQUAL       * Change - anything can follow	
.
          MATCH     "L",TMOVE
          GOTO      PROC5700 IF EQUAL       * On-Leave - next must be R (Return)
.                                           * Returned - next cannot be R
          MATCH     "R",XRECTY
          GOTO      PROC5800 IF EQUAL       * R follows R - an error
          GOTO      PROC5900
.
PROC5700  MATCH     "R",XRECTY
          GOTO      PROC5900 IF EQUAL       * R follows L - OK
.                                           * Something else follows L - error
PROC5800  PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ":
                    "Tansfer Type ",XRECTY," ON ",XTRNDATE," follows a type ":
                    TMOVE," on ",TDATE," ",TTIME,*132,"|"
          CALL      CPAG0000                * need new page ?
          ADD       ONE,COUNTREJ                                       *I-90206
          GOTO      PROC5100
.
.
.                                           ----------------------------------
.                                           See if the Transfer exists -
.                                           If found, update it
.                                           If not found, Check "A" and "D"
PROC5900  MOVE      ZERO,OVRCD                                         *C-90209
          MOVE      ZERO,ERRTRAN                                       *I-90209
          MOVE      ZERO,UPDTTRAN                                      *I-90209
          PACK      KEY30,XWARD,XBED,XTRNDATE,XTRNTIME,XADMNO          *I-90209
          CALL      RDTRAN1                 * re-read Transfer file    *I-90209
          IF        OVRCD = 0
            MOVE      ONE,UPDTTRAN                                     *I-90209
          ELSE 
            MATCH   ANSA,XRECTY
            GOTO    PROC5910 IF NOT EQUAL
            MOVE    FIVE,ERRORNO            * Can't find the "A" Transfer
            GOTO    PROC8500
          ENDIF                                                        *I-90209
.
PROC5910  MATCH     ANSD,XRECTY                                        *I-90209
          CALL      TSTD0000 IF EQUAL                                  *I-90209
.
          COMPARE   ONE,ERRTRAN                                        *I-90209
          GOTO      PROC5100 IF EQUAL                                  *I-90209
.
          IF        UPDTTRAN = 0
            CALL      CLTR0000              * Clear transfer file variables @@
            MOVE      XWARD,TWARD
            MOVE      XBED,TBED
            MOVE      XTRNDATE,TDATE
            MOVE      XTRNTIME,TTIME
            MOVE      XADMNO,TADMN
          ENDIF                                                        *I-90209
.
          MOVE      XRECTY,TMOVE                                       *I-90207
          MOVE      XURNO,TURNO
          MOVE      XRATE,TRATEF
          MOVE      XATYPE,TATYPE
          MOVE      XADOCT,TADOCT
          MOVE      XUNIT,TDEPT                                        * @@
.
          IF        UPDTTRAN = 0
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      SP70,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN1                 * write to the transfer file
            ADD       ONE,COUNTTWR                                     *I-90206
          ELSE                                                         *I-90209
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      SP70,PTTRUUID
            CALL      UPTRAN1                                          *I-90209
            ADD       ONE,COUNTTUP                                     *I-90209
          ENDIF                                                        *I-90209
.
          MATCH     ANSD,XRECTY                                        *I-90209
          IF        @EQUAL
            PACK      KEY8,XADMNO
            CALL      RDMISS1                 * Read admission file
            IF        OVRCD=0
              MOVE      XATYPE,ATYPE
              MOVE      XADOCT,ADOCTA
              MOVE      XUNIT,ACLSSFT                                      * @@
              CALL      UPMISS1
            ENDIF
.
            PACK      KEY8,XADMNO
            CALL      RDVISA1                 * read the patient visit file
            IF        OVRCD=0
              MOVE      XADOCT,PVIDOCT
              CALL      UPPTVIS1
            ENDIF
          ENDIF
.
          GOTO      PROC5100                                           *I-90204
.
.
PROC8500  UNPACK    XTRNDATE,CCENT,CYEAR,CMON,CDAY                     *I-90203
          PACK      PDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR            *I-90203
.
          IF        BYPASMSG = 0
            PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ":
                      PDATE," ",XTRNTIME," - ";
            IF        ERRORNO = 1
              PRINT     " Invalid Date/Time on A type Transfer";  
            ENDIF
            IF        ERRORNO = 2
              PRINT     " Invalid Date/Time on D type Transfer";  
            ENDIF
            IF        ERRORNO = 3
              PRINT     " Transfer Date/Time is before Admission Date/Time"; 
            ENDIF
            IF        ERRORNO = 6
              PRINT     " Transfer Date/Time is same as Admission Date/Time"; 
            ENDIF
            IF        ERRORNO = 4
              PRINT     " Transfer Date/Time is after Discharge Date/Time";
            ENDIF
            IF        ERRORNO = 5
              PRINT     " Invalid A type Transfer, check Ward and Bed";
            ENDIF
.
            PRINT       *132,"|"
.
            CALL      CPAG0000                * check for new page
            ADD       ONE,COUNTERR                                     *I-90206
          ENDIF                                                        *I-90213
          GOTO      PROC5100
.
.------ we have finished processing the convadt file ------
.
PROC9000  BRANCH    TRNFLAG,PROC9200                                   *I-90204
.                                           * If there were any Transfers, then
          CALL      WBCK0000                * Check Last Transfer -    *I-90204
          CALL      TOTL4000                * Print final record counts I-90206
.
PROC9200  CLOCK     TIME,CTIMEIS                                       *C-90204
          DISPLAY   *P41:6,*V2LON,CTIMEIS,*P24:10,COUNT,*HOFF:
                    *P1:24,*EL,*B,"Conversion Finished.  ";
          CALL      HITENTER
          CALL      UND132
          PRINT     *N,*N,"*** End of Report ***"
.
PROC9999  RETURN
+
.
. -------------------- START OF CHECKING DISCHARGE WARD/BED -----------*C-90204
.
. ----- Check if change record required before discharge -----
.
WBCK0000  COMPARE   "00000000",LSTADMNO 
          GOTO      WBCK9999 IF EQUAL
          PACK      KEY30,LSTADMNO,ZED30
. -----   CALL      RDSTRAN2                * Position on & read last   D-90210
. -----   CALL      RDPTRAN2                * Transfer (should be 'D')  D-90210
. -----   BRANCH    OVRCD,WBCK9000                                      D-90210
.
          MOVE      "99999999",TADMN                                   *I-90210
          CALL      RDTRAN2                 * Read last transfer       *I-90210
          MOVE      DTADMN,TADMN                                       *I-90210
.
WBCK0500  COMPARE   TADMN,LSTADMNO                                     *I-90210
          IF        @LESS
            CALL      RDPTRAN2              * Should handle Oracle DB  *I-90210
            GOTO      WBCK0500                                         *I-90210
          ENDIF                                                        *I-90210
.
          COMPARE   LSTADMNO,TADMN
          GOTO      WBCK9000 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSD,TMOVE
          GOTO      WBCK9000 IF NOT EQUAL   * No discharge record
.
.                                           * Save the Discharge Transfer Info
          MOVE      TURNO,STURNO 
          MOVE      TADMN,STADMN 
          MOVE      TWARD,STWARD   
          MOVE      TBED,STBED
          MOVE      TDATE,STDATE
          MOVE      TTIME,STTIME
          MOVE      TRATEF,STRATEF
          MOVE      TATYPE,STATYPE
          MOVE      TADOCT,STADOCT
.
          UNPACK    STTIME,CHOUR,KEY1,CMIN,KEY1,KEY2
          PACK      KEY6,CHOUR,CMIN,KEY2
          REP       " 0",KEY6
          MATCH     "000000",KEY6
          GOTO      WBCK1000 IF NOT EQUAL   * Not currently midnite
.
.                                             If Discharge was a Midnight, set
.                                             the Time and Date back to just 
.                                             before midnight - it saves 
.                                             problems generating a new record.
          UNPACK    STDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
          CALL      DMYCON                  * Convert to julian date
          SUB       ONE,JULDAY              * Subtract 1 day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                  * Convert to greg date
          PACK      STDATE,CC,YY,MM,DD
          REP       " 0",STDATE
          MOVE      "23:59:59",STTIME
          GOTO      WBCK2000
.
.                                           * Otherwise set the Time back 1 sec.
WBCK1000  MOVE      KEY6,FORM6
          SUB       ONE,FORM6               * Subtract 1 second from disch time
          MOVE      FORM6,KEY6
          UNPACK    KEY6,CHOUR,CMIN,KEY2
          MATCH     "99",CMIN
          IF        @EQUAL
            MOVE      "59",CMIN
          ENDIF
          MATCH     "99",KEY2
          IF        @EQUAL
            MOVE      "59",KEY2
          ENDIF
          PACK      STTIME,CHOUR,COLON,CMIN,COLON,KEY2
          REP       " 0",STTIME
.
.                                           * Now read the last 'C' Transfer
.                                           * record and see if the Ward, Bed,
.                                           * etc., is the same as the Discharge
.
WBCK2000  CALL      RDPTRAN2                * Read previous transfer file record
          BRANCH    OVRCD,WBCK9000
.
          COMPARE   LSTADMNO,TADMN
          GOTO      WBCK9000 IF NOT EQUAL   * Different admin no (not possible!)
.
.                                           * Now check if a change is needed
          MATCH     STWARD,TWARD
          GOTO      WBCK5000 IF NOT EQUAL   * Different ward
.
          MATCH     STBED,TBED
          GOTO      WBCK5000 IF NOT EQUAL   * Different bed
.
          MATCH     STATYPE,TATYPE
          GOTO      WBCK5000 IF NOT EQUAL   * Different admin type
.
          MATCH     STADOCT,TADOCT
          GOTO      WBCK9000 IF EQUAL       * Same attending doctor
.
.
.                                           * Just in case the generated 'C'
.                                           * has already been done (eg. re-run)
WBCK5000  MATCH     STDATE,TDATE
          GOTO      WBCK6000 IF NOT EQUAL   * Different transfer date
.
          MATCH     STTIME,TTIME
          GOTO      WBCK6000 IF NOT EQUAL   * Different transfer time
.
          MOVE      STWARD,TWARD
          MOVE      STBED,TBED
          MOVE      STRATEF,TRATEF
          MOVE      STATYPE,TATYPE
          MOVE      STADOCT,TADOCT
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      SP70,PTTRUUID
.
          CALL      UPTRAN2                 * Update a transfer file record
          ADD       ONE,COUNTTUP                                       *I-90206
          GOTO      WBCK9000
.
WBCK6000  CALL      CLTR0000                * Clear transfer file variables
          MOVE      STWARD,TWARD
          MOVE      STBED,TBED
          MOVE      STDATE,TDATE
          MOVE      STTIME,TTIME
          MOVE      ANSC,TMOVE
          MOVE      STURNO,TURNO 
          MOVE      LSTADMNO,TADMN
          MOVE      STRATEF,TRATEF
          MOVE      STATYPE,TATYPE
          MOVE      STADOCT,TADOCT
.
          PACK      KEY30,TWARD,TBED,TDATE,TTIME,TADMN
          CALL      RDTRAN1                 * Read a transfer file record
          COMPARE   ONE,OVRCD
          IF        @EQUAL     
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      SP70,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN1                 * Write a transfer file record
            ADD       ONE,COUNTTWR                                     *I-90206
          ENDIF                                                        *I-90206
.
WBCK9000 
WBCK9999  RETURN               
.
. -------------------- END OF CHECKING DISCHARGE WARD/BED --------------------
+
.******************************************************************************
.*                                  TSTD0000              Called by: PROC0000 *
.*                        Check the 'D' type Transfer                         *
.******************************************************************************
TSTD0000  MOVE      ZERO,ERRTRAN
.                                           * Check when a Transfer exists
          IF        UPDTTRAN = 1
            MATCH     XRECTY,TMOVE          * If both records are 'D', return
            GOTO      TSTD9999 IF EQUAL
            PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"|":
                      "Attempting to change a Transfer Type ",TMOVE," to D"
            CALL      CPAG0000
            ADD       ONE,COUNTREJ
            MOVE      ONE,ERRTRAN
            GOTO      TSTD9999
          ENDIF
.                                           * Find the Discharge Transfer 
.                                           * created from the 'convadt' recd.
.                                           * as it has the wrong Ward/Bed
          PACK      KEY30,XADMNO,XTRNDATE,SP30 
.
          MOVE      "99999999",TADMN                                   *I-90210
          CALL      RDSTRAN2                                           *I-90210
          MOVE      DTADMN,TADMN                                       *I-90210
.
TSTD1000  MOVE      ZERO,OVRCD  
          COMPARE   XADMNO,TADMN
          GOTO      TSTD9000 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSD,TMOVE              * Is this the D Discharge record?
          GOTO      TSTD2000 IF EQUAL       * Yes - continue                  
.
          CALL      RDKTRAN2                * Read next record
          COMPARE   ONE,OVRCD
          GOTO      TSTD9000 IF EQUAL       * "D" record not found
          GOTO      TSTD1000
.                                           * Read the Discharge File
TSTD2000  PACK      KEY8,XADMNO
          CALL      RDDSCH1
          IF        OVRCD = 0
            MOVE      XWARD,PTDSDWRD        * Update the Discharge Ward
            CALL      UPDSCH1
            ADD       ONE,COUNTDUP
          ENDIF
.                                           * Now clean up the Transfers
          PACK      KEY30,TWARD,TBED,TDATE,TTIME,TADMN
          CALL      RDTRAN1                 * Read the transfer file record
          COMPARE   ZERO,OVRCD
          IF        OVRCD = 0
            CALL      DETRAN1               * Delete transfer file record
            ADD       ONE,COUNTTDE
          ENDIF
.
.                                           * Now see if there is a ":59"
.                                           * change Transfer to match Discharge
          PACK      KEY30,XADMNO,SP30
.
          MOVE      "99999999",TADMN
          CALL      RDSTRAN2
          MOVE      DTADMN,TADMN
.
TSTD3000  MOVE      ZERO,OVRCD  
          COMPARE   XADMNO,TADMN
          GOTO      TSTD9999 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSC,TMOVE              * Is this the Change record?
          IF        @EQUAL
            UNPACK    TTIME,DIM5,DIM3
            MATCH     ":59",DIM3            * does the ":59: record exist ?
            GOTO      TSTD4000 IF EQUAL
          ENDIF
.
          CALL      RDKTRAN2                * Read next record
          COMPARE   ONE,OVRCD
          GOTO      TSTD9999 IF EQUAL       * End of file         
          GOTO      TSTD3000                * Try the next Transfer
.
TSTD4000  PACK      KEY30,TWARD,TBED,TDATE,TTIME,TADMN
          CALL      RDTRAN1                 * Read the transfer file record
          COMPARE   ZERO,OVRCD
          CALL      DETRAN1 IF EQUAL        * Delete the ":59" transfer record
          GOTO      TSTD9999
.
.
TSTD9000  PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"|":
                    " A Discharge Transfer not found - inserted"        
          CALL      CPAG0000
          ADD       ONE,COUNTREJ
. ------  MOVE      ONE,ERRTRAN
.
TSTD9999  RETURN               
. ----------------------------------------- End of additional code ---- I-90209
+
.******************************************************************************
.*                                  CLTR0000              Called by: PROC0000 *
.*                        Clear Transfer File Variables                       *
.******************************************************************************
CLTR0000  MOVE      SP3,TWARD
          MOVE      SP3,TBED
          MOVE      SP8,TDATE
          MOVE      SP8,TTIME
          MOVE      SP1,TMOVE
          PACK      TURNO,SP7,ZERO
          MOVE      ZERO,TADMN
          MOVE      ZERO,TRATEF
          MOVE      ZERO,TRATEG
          MOVE      ZERO,TDISC
          MOVE      ZERO,TALLW
          MOVE      SP3,TATYPE
          MOVE      SP6,TADOCT
          MOVE      ZERO,TRATEH
          MOVE      ZERO,TEXTRA
          MOVE      SP3,TRBTYP
          MOVE      ZERO,TRBEND
          MOVE      SP3,TCHSTAT
          MOVE      SP3,TDEPT
          MOVE      SP3,PTTRLTYP
          MOVE      ZERO,PTTREPNO
          MOVE      ZERO,PTTREPSD
          MOVE      ZERO,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
          MOVE      ZERO,PTTRAEND
          MOVE      ZERO,PTTRADPT
          MOVE      ZERO,PTTRADRB
          MOVE      SP70,PTTRNHAC
          MOVE      SP70,PTTROPER
          MOVE      SP70,PTTRAUAT
          MOVE      SP70,PTTRCDAT
          MOVE      SP70,PTTRCTIM
          MOVE      SP70,PTTRCUID
          MOVE      SP70,PTTRLTSC
          MOVE      SP70,PTTRCLTY
          PACK      PTTRSPAR,SP30,SP10
.
CLTR9000  MOVE      ZERO,EXIT
CLTR9999  RETURN
+
.******************************************************************************
.*                                    HEAD0000                                *
.*                  Routine to print the error report page header             *
.******************************************************************************
HEAD0000  CALL      HEAD132                 * print the page header
.
          CALL      UND132
          PRINT     *1,"| U/R Number | Admission No. | Error Message",*132,"|"
          ADD       ONE,CLNO
          CALL      UND132
.
HEAD9999  RETURN
+
.******************************************************************************
.*                                     CPAG0000                               *
.*                         See if we need to paginate                         *
.******************************************************************************
CPAG0000  ADD       ONE,CLNO
          IF        CLNO>=58
            CALL      HEAD0000              * print the page header
          ENDIF
CPAG9999  RETURN
+
.******************************************************************************
.*                                     FERR0000                               *
.*            Print TRAP data errors in "convadt.txt" & "convtran.txt"        *
.******************************************************************************
.
FERR0000  MOVE      ONE,DATAERR
          PRINT     *1,"|",*4,TMPUR,*14,"|",*19,TMPADMIS,*30,"| ":
                    "Data error occurred in this record - Record No. :":
                    COUNTIN,"   - Record bypassed",*132,"|"
          READ      ADT,SEQ;TMPUR           * Bypass rest of record
          GOTO      FERR9999
.
FERR2000  MOVE      ONE,DATAERR
          PRINT     *1,"|",*4,XURNO,*14,"|",*19,XADMNO,*30,"| ": 
                    "Data error occurred in this record - Record No. :":
                    COUNTIN,"   - Record bypassed",*132,"|"
          READ      ADTTRAN,SEQ;XURNO       * Bypass rest of record
.
FERR9999  RETURN
+
. ----------------------------------------- Start of Addition --------- I-90206
.******************************************************************************
.*                                     TOTL0000                               *
.*                         Print the Record Counts                            *
.******************************************************************************
.
TOTL0000  MOVE      ZERO,COUNTIN        
          MOVE      ZERO,COUNTREJ        
          MOVE      ZERO,COUNTERR            
          MOVE      ZERO,COUNTAWR              
          MOVE      ZERO,COUNTAUP                  
          MOVE      ZERO,COUNTDWR                     
          MOVE      ZERO,COUNTDUP                        
          MOVE      ZERO,COUNTGWR                           
          MOVE      ZERO,COUNTGUP                               
          MOVE      ZERO,COUNTIWR      
          MOVE      ZERO,COUNTIUP        
          MOVE      ZERO,COUNTPWR          
          MOVE      ZERO,COUNTPUP            
          MOVE      ZERO,COUNTSWR               
          MOVE      ZERO,COUNTSUP                  
          MOVE      ZERO,COUNTTWR                    
          MOVE      ZERO,COUNTTUP                      
          MOVE      ZERO,COUNTUWR                         
          MOVE      ZERO,COUNTUUP                           
          MOVE      ZERO,COUNTVWR                             
          MOVE      ZERO,COUNTVUP                               
          MOVE      ZERO,COUNTWWR                                 
          MOVE      ZERO,COUNTWUP                                  
.
          GOTO      TOTL9999
.
TOTL2000  PRINT     *1,"|",*14,"|",*30,"| ",*50:
                    "Records read from 'convadt.txt'     :",COUNTIN:
                    *132,"|",*N:                                   
                    *1,"|",*14,"|",*30,"| ",*50:                   
                    "        rejected                    :",COUNTREJ:
                    *132,"|",*N:                                  
                    *1,"|",*14,"|",*30,"| ",*50:                  
                    "        in error (not updated)      :",COUNTERR:
                    *132,"|",*N:                                 
                    *1,"|",*14,"|",*30,"| ",*50:               
                    "Records written to Admissions (new) :",COUNTAWR:
                    *132,"|",*N:                                 
                    *1,"|",*14,"|",*30,"| ",*50:               
                    "        updated on Admissions File  :",COUNTAUP:
                    *132,"|",*N:                                  
                    *1,"|",*14,"|",*30,"| ",*50:  
                    "Records written to Visit Mast. (new):",COUNTVWR:
                    *132,"|",*N:                 
                    *1,"|",*14,"|",*30,"| ",*50:    
                    "        updated on Visit Master     :",COUNTVUP:
                    *132,"|",*N:                     
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Grouper Details  :",COUNTGWR:
                    *132,"|",*N:                             
                    *1,"|",*14,"|",*30,"| ",*50:                 
                    "        updated on Grouper Details  :",COUNTGUP:
                    *132,"|",*N:                          
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Discharge (new)  :",COUNTDWR:
                    *132,"|",*N:                             
                    *1,"|",*14,"|",*30,"| ",*50:                 
                    "        updated on Discharge File   :",COUNTDUP:
                    *132,"|",*N:                          
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Dischrg Tracking :",COUNTWWR:
                    *132,"|",*N:                             
                    *1,"|",*14,"|",*30,"| ",*50:                 
                    "        updated on Dischrg Tracking :",COUNTWUP:
                    *132,"|",*N:                          
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Transfers (new)  :",COUNTTWR:
                    *132,"|",*N:                             
                    *1,"|",*14,"|",*30,"| ",*50:                 
                    "        updated on Transfers File   :",COUNTTUP:
                    *132,"|",*N:                          
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Transfer Destin. :",COUNTUWR:
                    *132,"|",*N:                             
                    *1,"|",*14,"|",*30,"| ",*50:                 
                    "        updated on Transfer Destin. :",COUNTUUP:
                    *132,"|",*N
          ADD       TEN,CLNO 
          ADD       TEN,CLNO 
.
          MOVE      ZERO,COUNTIN                           
          MOVE      ZERO,COUNTREJ                           
          MOVE      ZERO,COUNTERR                                
          MOVE      ZERO,COUNTTWR                                
          MOVE      ZERO,COUNTTUP                                
.
          GOTO      TOTL9999
.
TOTL4000  PRINT     *1,"|",*14,"|",*30,"| ",*50:
                    "Records read from 'convtran.txt'    :",COUNTIN:
                    *132,"|",*N:                                   
                    *1,"|",*14,"|",*30,"| ",*50:                   
                    "        rejected                    :",COUNTREJ:
                    *132,"|",*N:                                  
                    *1,"|",*14,"|",*30,"| ",*50:                  
                    "        in error (not updated)      :",COUNTERR:
                    *132,"|",*N:                                 
                    *1,"|",*14,"|",*30,"| ",*50:        
                    "Records written to Transfers (new)  :",COUNTTWR:
                    *132,"|",*N:                      
                    *1,"|",*14,"|",*30,"| ",*50:    
                    "        updated on Transfers        :",COUNTTUP: 
                    *132,"|",*N:
                    *1,"|",*14,"|",*30,"| ",*50:    
                    "        re-created on Transfers     :",COUNTTDE: 
                    *132,"|",*N
          ADD       FIVE,CLNO 
.
TOTL9999  RETURN
. ----------------------------------------- End of Addition ----------- I-90206
.
. ----------------------------------------- Start of Deletion --------- D-90206
. --WRTMISS  RESET     KEY8
. -      MOVE      ZERO,OVRCD
. -      MOVE      AADMNO,DAADMNO
. -      MOVE      ASTAT,DASTAT
. -      MOVE      PTMIPVIS,DPTMIPVI
. -      MOVE      PTMIDDIG,DPTMIDDI
.....         MOVE      PASSCODE,PTMIOPER
. -      WRITE     PATMI1A1,KEY8;KEY8,AURNO,ADATE,ATIME:
. -                              DASTAT,APORT,ATRANNO,AINVPRT,ALACDTE:
. -                              ACANCEL,AWARD,ABED,ADOCTR,ADOCTA:
. -                              ADOCTL,ASRCE,ATYPE,ACLSS,ACARE,AFUNDH:
. -                              AFNDTB,AFNDMM,AELIG,AVISIT,AALERG:
. -                              AILLN,ADIAG1,ADIAG2,ADISC,ADOCTT,ACLSSFT:
. -                              AALLOW,AMBS,ACLAIM,ADIET,APLOCCR,ASTAY:
. -                              ADYHOSP,AMEMB,AMEMBNO:
. -                              ACOMM1,ACOMM2,APLUR,APURGE,AUSR1:
. -                              AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7:
. -                              ADSCHI,ARDRNAM,AFNDYY,AFNDCG:
. -                              AOCCDTE,ACODDTE,ARETDTE,AMUMADM,DPTMIPVI:
. -                              ABWGHT:
. -                              PTMSRFGP,PTMSGPPC,PTMSFHAN,PTMSECRA:
. -                              PTMSMGIN,DPTMIDDI,PTMIGPPT,PTMIDOFR:
. -                              PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC:
. -                              PTMIESSF,PTMIUSR8,PTMIUSR9,PTMIUSR0:
. -                              PTMIPDRG,PTMIOPER,PTMIXWRD,PTMIADOC:
. -                              PTMIREGS,PTMIUYN1,PTMIUYN2,PTMIPANO:
. -                              PTMIPADT,PTMIPCMX,PTMSSPAR
. -      RETURN
.
. -WRTDSCH
.....         MOVE      PASSCODE,PTDSOPER
. -      MOVE      DADMNO,DDADMNO
. -      RESET     KEY8
. -      WRITE     PATDSCH1,KEY8;DURNO,KEY8:
. -                         DDATE,DTIME,DSTAT,DDEST:
. -                         DDIAG,DDIAG2,DUSD1,DUSD2,DUSD3,DUSD4:
. -                         DUSD5,DFMBS,PTDSDMDC,PTDSDDRG,DWLREASN,PTDSSIDX:
. -                         PTDSVOGU,PTDSOPER,PTDSUYN1,PTDSUYN2:
. -                         PTDSUYN3,PTDSUYN4,PTDSDWRD,PTDSDLOS,DSPARE
. -      RETURN
. ----------------------------------------- End of Deletion ----------- D-90206
.
.
.==============================================================================
.
          INC       STD001IO
          INC       CALCDAYS                * Calculate diff between 2 dates
          INC       CLPATDSC                * Clear disch file variables
          INC       CLPATMIS                * Clear admin file variables
.
          INC       IBAPOSIO/INC                 * postcode file
          INC       MRTPDSIO/INC
          INC       MRTPSHIO/INC
          INC       PATCODIO/INC
          INC       PATDADIO/INC
          INC       PATDSCIO/INC
          INC       PATICUIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       PATRE1IO/INC
          INC       PATASFIO/INC                                           * @@
          INC       PATPGRIO/INC                                           * @@
          INC       PMSVX1IO/INC                                           * @@
+
.

