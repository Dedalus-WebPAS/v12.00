.************************************************************************
.*  Procedure: DGCLIOCM  -  Outpatient Clinic Master Maintenance        *
.*                          HL7 Broadcast Message routine               *
.*                                                                      *
.*  Author   : Davin Sloan (06/01/2012)                                 *
.*                                                                      *
.*  Mods     :                                                          *
.*  V10.03.02 10/10/2013  Davin S          CAR 291578                   *
.*            Added dummy label rapmqpt1 as pmsqpt is not used here     *
.*  V10.03.01 17/04/2013  Davin S          CAR 280425                   *
.*            Changed IBCNUCIS - value 1 or greater will write trigger  *
.*                                                                      *
.************************************************************************
          DEFPROC   DGCLIOCM
.
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       OUTQMAFD/INC
.
CISMFLAG  FORM      1             * HL7 message flag
.                                    0 = don't send HL7 message
.                                    1 = send HL7 message
IBAMFLAG  FORM      1
MESSAGID  DIM       20
PURNO     DIM       8
.
DGCLI000  MOVE      ZERO,IBAMFLAG           * IBA proprietary message flag
          MOVE      SP8,PURNO               * dummy UR
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*133,IBCNUCIS
          READ      CONTROLF,THIRTY2;*137,OTCNM01M     * sending M01
.
          MOVE      ZERO,CISMFLAG                * set default interface flag
          MATCH     "1",IBCNUCIS                 * using HL7 interface ?
          IF        !@LESS
            COMPARE   ONE,OTCNM01M               * yes - sending M01 for OCM ?
            IF        @EQUAL
              MOVE      ONE,CISMFLAG             * yes- set flag for HL7 message
            ENDIF
          ENDIF
.
.         Check if we are sending any messages.
.
          IF        CISMFLAG <> 1
            GOTO      DGCLI999
          ENDIF
.
.         Open the relevant holding tables
.
          OPEN      HL7CISA1,"hl7cisaf"
          OPEN      OUTQMAA1,"outqmaaf"
.
          CALL      DGMESSID                    * Get Message ID, Date & Time
.
.         Write a record to outqmaaf (holding O/P clinic master details)
.
          MOVE      MESSAGID,OTQMMESI
          PACK      OTQMSPAR,SP70,SP70
          CALL      WROTQMA1
.
          MOVE      "M01",H7CIMETP
          MOVE      OTCMACTN,H7CIACTN          * A=Add, U=Update, D=Delete
          MOVE      HL7TRGID,H7CITRID
          MOVE      HL7INCLD,H7CIINCL
          MATCH     "HL7REGEN",PRGID
          IF        @EQUAL
            MOVE      HL7RCTAG,H7CIRTAG
            MOVE      HL7SFTAG,H7CISTAG
          ELSE
            MOVE      SP20,H7CIRTAG
            MOVE      SP3,H7CISTAG
          ENDIF
          CALL      WRCIS000                   * yes - write hl7cisaf record
.
          CLOSE     HL7CISA1
          CLOSE     OUTQMAA1
.
DGCLI999  GOTO      DGCLIEND                    * end procedure
.
.         IO's go in here
.
RAPMQPT1  GOTO      OVERCOND                    * dummy for DGMESSID
.
          INC       BRHLCOMN
.
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       IBAOVRIO/INC
          INC       OUTQMAIO/INC
.
DGCLIEND  ENDPROC
