.----------------------------------------------------------------------
. Program       : EOCWEB01
.
. Function      : Episode of Care Server
.
. Modifications  :
.----------------------------------------------------------------------
. V12.00.01 13/05/2025  Ebon Clements  TSK 0955096
.           Added alphanumeric visit number generation - GENBOK00 - GENANVIS
.           Changed OUTBOKNO to DIM 8
.           Added alphanumeric visit number for COMPARE and MOVE 0
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.00.01 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V10.11.06 30/11/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments.
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 22/11/2017 Ania P          TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
. V10.11.03 06/09/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. 
. V10.11.02 08/08/2017  Thanh T.       TSK 0821710
.           Recompiled OUTBOATM. 
. V10.11.01 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.----------------------------------------------------------------------
. V10.08.01 02/05/2016  Ebon Clements   TSK 0268970            
.           Recompiled for LINKDMUL and UNLNKMUL - use OUTCLIA1 
. V10.04.02 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
.----------------------------------------------------------------------
. V10.02.02 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.01 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
.----------------------------------------------------------------------
. V10.00.01 26/07/2010  Ebon Clements  CAR 225970
.           Recompiled for UNLNKMUL - fixed open of outboka6
.----------------------------------------------------------------------
. V9.12.02  17/12/2009  Peter McMullen CAR 210130
.           Convert to newer Dr name format routine DOCNM000
. V9.12.01  22/06/2009  Jill Habasque  CAR 179650
.           Recompiled for LINKDMUL and UNLNKMUL - uses outboka6 
. V9.11.05  24/02/2009  Ebon Clements  CAR 189402
.           Recompiled for UNLNKMUL - Don't display cancelled ED visits
. V9.11.04  19/02/2009  Ebon Clements  CAR 184833
.           Recompiled for UNLNKMUL - Display limit increased
. V9.11.03  04/02/2009  Jill Habasque  CAR 179332
.           Recompiled for UNLNKMUL
. V9.11.02  21/11/2008  Jill Habasque  CAR 181446
.           Added unable to link, episode of care is closed message.
. V9.11.01  19/11/2008  Jill Habasque  CAR 181446
.           Added call to CLRRFL00 in SAVEPS000
. V9.09.02  07/04/2008  Ebon Clements  165634
.           Fixed OTRLRHCP display tag
. V9.09.01  31/03/2008  Ebon Clements  164250
.           Changed OTRLDEPT to be category A not AC
. V9.08.02  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
. V9.08.01  06/12/2006  Jill Habasque CAR 127290
.           Added output of DECRFREF
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.06  26/10/2005 Ebon Clements CAR 75461
.           Recompiled for UNLNKMUL and LINKDMUL - clinic and diagnosis display
. V9.04.05  14/10/2005 Ebon Clements CAR 79606
.           Recompiled for LINKDMUL - MLOUT000 fixed diagnosis display
. V9.04.04  03/08/2005 Jill Habasque CAR 70410
.           Fixed output of I1-I9 category codes
. V9.04.03  01/08/2005 Jill Habasque CAR 68140
.           Added all cgi's into ACCSAV00      
. V9.04.02  25/07/2005 Jill Habasque CAR 68704
.           Removed calls to CHKEPS00          
. V9.04.01  27/06/2005 Jill Habasque CAR 63555
.           Added clear of otrloutn in EOCDIS00
. V9.03.13  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.12  5/03/2004  Peter Vela    CAR 13038
.           Added functionality for Doctor Name format parameter in table of
.           episodes
. V9.03.11  24/02/2004  Jill Habasque CAR 44349
.           Changed to read eocaccaf if the ecrfrefn=0 and acrfaccn<>spaces
. V9.03.10  16/02/2004  Sylvek Litewka  CAR 47091
.           Added processing for variable SAVACCNO to CLRPAR00 and SETPAR00 
.           procedures.
. V9.03.09  06/01/2004  Sylvek Litewka  CAR 46257
.           Recompiled for OUTRF1IO - mods to write routines.
. V9.03.08  11/12/2003  Ebon Clements CAR 43785
.           Mods for OUTRF1FD - change from doctors file to hcp file
. V9.03.07  12/11/2003  Jill Habasque CAR 43785
.           Recompiled for LINKDMUL and UNLNKDMUL (changed to use outsita3)
. V9.03.06  11/09/2003  Sandra Barcham    43010 
.           Open outpreaf & outphoaf without file prefix
. V9.03.05  04/08/2003  Jill Habasque SRF 42003
.           Recompiled for LINKDMUL and UNLNKMUL
. V9.03.04  22/07/2003  Jill Habasque SRF 21760 
.           Recompiled for bokdiaaf index
. V9.03.03  08/07/2003  Jill Habasque SRF 39250 
.           Changes for multi databases
. V9.03.02  18/06/2003 Sylvek Litewka  CAR 39108
.           Modified NXTPAG50 to replace SPACES with PLUS SIGNS when appending
.           ECRFEPNO field to the REDIRECT string.
. V9.03.01  15/05/2003 Ebon Clements CAR 39108
.           Added close and re-open EOC referral options           
. V9.02.11  30/04/2003 Lina Vo  CAR 38512
.           In EXSACC00,only redirect to existing ACC if from eocweb0101006.html
. V9.02.10  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.09  21/01/2003  Lina Vo                          
.           Added Remote scriptiing VLDACC00.
.           Added RETURNCD to determine return program after linking ACC.
.           Added LNKECACC indicator to determine whether to link EOC 
.           to visit after update of ACC. 
.           Create new section LNKACC00 & EXSACC00.
. V9.02.08  03/12/2002  Lina Vo                          
.           Added OPNOUT00 to open outpatient files.              
. V9.02.07  01/11/2002  Sylvek Litewka                   
.           Modified LNKCUR00 to check for ADMISSNO being spaces. 
. V9.02.06  24/10/2002  Lina Vo                   
.           Recompiled for change in EOCREFFD
. V9.02.05  10/10/2002  Sylvek Litewka   SRF 22692
.           Added variables MVEVN17 and MVEVN18 to store Visit Type
.           description for Patient Events and Allied Health Referrals.
.           09/10/2002  Peter Vela   SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.04  28/05/2002  Mike Laming  SRF 15999
.           Recompiled for OUTRF1IO.INC
. V9.02.03  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.02  20.11.2001  B.G.Ackland  
.           Remove pi's from Program
. V9.02.01  04.10.2001 J.Tan
.           Mods at LNKSAV00 for I*D 
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.001 14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B03 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B03 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 05.06.2001 Pat Dirito 
.           Removed all reference to DISMISFD - District Nursing
.           Default details. Note I have a backup in my home 
.           directory if needed. 
.----------------------------------------------------------------------
.                 V5.10.B01 22.03.2001 B.G.Ackland
.                           Fix Redirect/Update Link
.                 V5.09.02 15.01.2001 Bronko Sosic
.                          Recompiled for PATMASTM   
.                 V5.08.B01 28/12/2000  J.Tan
.                          Fixed duplicate codes file
.                 V5.08.03 16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.02 07.06.2000 B.G.Ackland
.                          Recompiled for PATMASTM   
.                 V5.08.01 25.05.2000 Pat Dirito 
.                          Recompiled for PATMASTM   
.                 V5.07.07 07.02.2000 B.G.Ackland
.                          Epsiode of Care Defaults
.                 V5.07.06 02.02.2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.05 29.12.1999 B.G.Ackland
.                          Recompiled for New Standard
.                 V5.07.04 20.12.1999 K.C.Nelson 
.                          Recompiled for IBAWEBDF/IBAWEBCD                    
.                 V5.07.03 29.11.1999 Pat Dirito 
.                          Accident Date cannot be in the future               
.                 V5.07.02 01.11.1999 Pat Dirito 
.                          Recompiled for UNLNKMUL                     
.                 V5.07.01 10.10.1999 B.G.Ackland
.                          Output HCP Desc & Doctor Name in EOC Table
.                 V5.07.00 16.08.1999 K.C.Nelson & Pat Dirito 
.                          Created Program
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       APSMASFD/INC   * A/P Master file
          INC       BOKRC1FD/INC   * Booking file
          INC       BOKDIAFD/INC   * Booking Diagnosis File
          INC       EOCREFFD/INC   * Episode of Care - Referral File 
          INC       EOCACCFD/INC   * Episode of Care - Accident Detail File 
          INC       EOCAFCFD/INC   * EOC - Accident Flag Change File 
          INC       EOCLNKFD/INC   * Episode of Care - Link File          
          INC       OUTBOAFD/INC   * Clinic Session Booking File A
          INC       OUTCONFD/INC   * Control File Include 
          INC       OUTCTYFD/INC   * Outpatients - Clinic Type File
          INC       OUTDIAFD/INC   * Outpatient - Diagnosis File
          INC       OUTRF1FD/INC   * New Referral Letter File
          INC       OUTSITFD/INC   * Outpatients - Site Codes File
          INC       OUTHISFD/INC   * Outpatients History File
          INC       OUTPREFD/INC   * Out - Pre-attendance Booking Details File
          INC       PATALRFD/INC   * Data variable defs for CALCAGE routine 
          INC       PATCALAG/INC   * Data variable defs for CALCAGE routine 
          INC       VISMDTFD/INC   * Coments File
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC   * Inpatient Control File
          INC       PATDO1FD/INC   * Doctor File
          INC       PATFN1FD/INC   * Doctor File
          INC       PATDPTHV/INC   * Data variable defs for CALCAGE routine 
          INC       PATIN1FD/INC   * Doctor File
          INC       PATHSPFD/INC
          INC       PATDHEAD/INC   * Data include for PMIHEAD,PATHEAD etc...
          INC       PMSHCPFD/INC   * National HCP File
          INC       PMSHCGFD/INC   * National HCP Practice File
          INC       PMSHCPTD/INC   * National HCP File
          INC       PMSHCGTD/INC   * National HCP Practice File
          INC       PATHOSFD/INC   * Hospital File
          INC       PATPR1FD/INC   * New Patient Master File
          INC       PATMA1FD/INC   * New Patient Master File
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATMI1FD/INC   * New Patient Admission File
          INC       PATWR1FD/INC   * Patients Visits File
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Patients Visits extn File
          INC       MRTMASFD/INC   * Patients Visits File
          INC       WATTR1FD/INC   * Waiting list file
          INC       WEBHDPFD/INC   * Hospital Data File Locations
          INC       RESLNKFD/INC   * Hospital Data File Locations
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       TFILEVAR/INC
.----------------------------------------------------------------------
. CGI Parameters
.----------------------------------------------------------------------
LTABTYPE  FORM      1
PURCDESC  DIM       20
NEXTPAGE  DIM       1              * Nextpage Parameter
NEXTREPT  DIM       2              * Nextpage Parameter
NEXTTEMP  DIM       3              * Nextpage Parameter
UPDTTYPE  DIM       1              * Update Type
UPDATETY  FORM      2              * Update Type for remote scripting
.
LNKECACC  DIM       1              * Link EOC indicator        
EPSOFCAR  DIM       5              * Episode of Care ID
LINKEVNT  DIM       10[99]         * List of Events to link to an episode 
RETURNCD  DIM       3              * Return template program code
UNLKEVNT  DIM       10[99]         * List of Events to unlink to an episode 
.
OTRFL001  DIM       8              * Date of Letter
OTRFL002  DIM       10             * Referring HCP
OTRFL003  DIM       8              * Outpatient Site
OTRFL004  DIM       6              * Clinic Id/Consultant
OTRFL005  DIM       3              * Department (Cat A)
OTRFL006  DIM       50             * Diagnosis       
OTRFL007  DIM       3              * Priority (Cat PR)
OTRFL008  DIM       3              * User Defined 1 (Cat L1)
OTRFL009  DIM       3              * User Defined 2 (Cal L2)
OTRFL010  DIM       3              * User Defined 3 (Cal L3)
OTRFL011  DIM       3              * User Defined 4 (Cal L4)
OTRFL013  DIM       10             * Referring GP   
OTRFL014  DIM       10             * GP Practice Code
OTRFL015  DIM       2              * GP Practice Count
OTRFL016  DIM       20             * Request Number
OTRFL017  DIM       8              * Request for App. Canc Date
OTRFL018  DIM       3              * Reason for request (Cat RQ)     
OTRFL019  DIM       3              * Specialty functions code (Cat OF)
OTRFL020  DIM       35             * Correspondence Address Line 1
OTRFL021  DIM       35             * Correspondence Address Line 2
OTRFL022  DIM       35             * Correspondence Address Line 3
OTRFL023  DIM       35             * Correspondence Address Line 4
OTRFL024  DIM       8              * Correspondence Post Code
OTRFL025  DIM       20             * ECR Approval Number
OTRFL026  DIM       20             * GPFH Approval Number
OTRFL027  DIM       6              * Clinic Type of Referral
OTRFL028  DIM       3              * Source of Referral (Cat S)
OTRFL029  DIM       10             * Responsible Health Care Prof
OTRFL030  DIM       8              * Date Referral Received 
OTRFL031  DIM       8              * Date of Priority
OTRFL032  DIM       3              * Expected Purchaser (Cat HP)
OTRFL033  DIM       6              * Patient Rank   
OTRFL034  FORM      1              * Referral Type 0=Outpat, 1=Other
OTRFL035  DIM       8              * Date Closed  (EOCREFFD) 
OTRFL036  DIM       1              * Status Open/Closed  (EOCREFFD) 
.
ECACC001  DIM       20             * ACC Number
ECACC002  FORM      1              * ACC Approval
ECACC003  DIM       8              * Date of Accident (CCYYMMDD)
ECACC004  DIM       8              * Date Field 1 (CCYYMMDD)
ECACC005  DIM       5              * Time Field 1 (HH:MM)
ECACC006  DIM       8              * Date Field 2 (CCYYMMDD)
ECACC007  DIM       5              * Time Field 2
ECACC008  DIM       8              * Date Field 3 (CCYYMMDD)
ECACC009  DIM       5              * Time Field 3
ECACC010  DIM       8              * Date Field 4 (CCYYMMDD)
ECACC011  DIM       5              * Time Field 4
ECACC012  DIM       8              * Date Field 5 (CCYYMMDD)
ECACC013  DIM       5              * Time Field 5
ECACC014  DIM       8              * Date Field 6 (CCYYMMDD)
ECACC015  DIM       5              * Time Field 6
ECACC016  DIM       6              * Doctor Field 1
ECACC017  DIM       6              * Doctor Field 2
ECACC018  DIM       6              * Doctor Field 3
ECACC019  DIM       6              * Doctor Field 4
ECACC020  DIM       6              * Doctor Field 5
ECACC021  DIM       6              * Doctor Field 6
ECACC022  DIM       9              * Diagnosis Field 1
ECACC023  DIM       9              * Diagnosis Field 2
ECACC024  DIM       9              * Diagnosis Field 3
ECACC025  DIM       60             * Diagnosis Field 4
ECACC026  DIM       60             * Diagnosis Field 5
ECACC027  DIM       60             * Diagnosis Field 6
ECACC028  FORM      1              * 1=Yes, 0=No Field 1
ECACC029  FORM      1              * 1=Yes, 0=No Field 2
ECACC030  FORM      1              * 1=Yes, 0=No Field 3
ECACC031  FORM      1              * 1=Yes, 0=No Field 4
ECACC032  FORM      1              * 1=Yes, 0=No Field 5
ECACC033  FORM      1              * 1=Yes, 0=No Field 6
ECACC034  DIM       60             * Free Format 1
ECACC035  DIM       60             * Free Format 2
ECACC036  DIM       60             * Free Format 3
ECACC037  DIM       60             * Free Format 4
ECACC038  DIM       60             * Free Format 5
ECACC039  DIM       60             * Free Format 6
ECACC040  DIM       60             * Free Format 7
ECACC041  DIM       60             * Free Format 8
ECACC042  DIM       60             * Free Format 9
ECACC043  DIM       60             * Free Format 10
ECACC044  DIM       3              * Coded Field 1 (Cat I1)
ECACC045  DIM       3              * Coded Field 2 (Cat I2)
ECACC046  DIM       3              * Coded Field 3 (Cat I3)
ECACC047  DIM       3              * Coded Field 4 (Cat I4)
ECACC048  DIM       3              * Coded Field 5 (Cat I5)
ECACC049  DIM       3              * Coded Field 6 (Cat I6)
ECACC050  DIM       3              * Coded Field 7 (Cat I7)
ECACC051  DIM       3              * Coded Field 8 (Cat I8)
ECACC052  DIM       3              * Coded Field 9 (Cat I9)
ECACC053  DIM       8              * Numeric Field 1 
ECACC054  DIM       8              * Numeric Field 2
.
.  Variable Declarations
.
AECNRQDF  DIM       3
DSCNRQDF  DIM       3
WTCNRQDF  DIM       3
AECNECSR  FORM      1
DSCNECSR  FORM      1
WTCNECSR  FORM      1
.
COUNTR    FORM      1
CMDLINE   DIM       80
MRCNNOHS  FORM      2
HOSPCNT   FORM      1
OLDPATH   DIM       80
PATH1     DIM       80
PATH2     DIM       80
PATH3     DIM       80
PATH4     DIM       80
PATH5     DIM       80
PATH6     DIM       80
DOCTOR    DIM       30  * Formatted Doctor
DOCTCODE  DIM       6   * Doctor Code
EVNTNUM   DIM       8   * Event Number
EVNTDATE  DIM       8   * Event Date   
EVNTDIAG  DIM       30  * Event Diagnosis
EVNTDOC   DIM       6   * Doctor/Clinic
EVNTHCP   DIM      10   * Doctor HCP/Clinic
EVNTHOSP  DIM       2   * Hospital Unique ID
EVNVTYPE  FORM      2   * Event Visit Type
EVNTHSPL  DIM       3   * Hospital Code 
DIAGNSIS  DIM       30  * Diagnosis
DISABLD   DIM       10  * Diabled Checked
HOSPCODE  DIM       3   * Hospital Code 
.
FORM8     FORM      8       
FORM5     FORM      5       
LINKEND   FORM      2   * Last Item of Link Events
UNLKEND   FORM      2   * Last Item of Unlink Events
..OPFILE    DIM       8   * Datafile   
OUTBOKNO  DIM       8   * Outpatient Booking Number
SAVACCNO  DIM       20  * Saved accident No.
TXTLEN    FORM      3   * Text Length for Episodes of Care Comments
UNLINK    DIM       12  * Contains Either Linked or Unlinked Variable
VISITYPE  FORM      2   * 
XXDPATH   DIM       120
CFILEPRE  DIM       3   * site prefix
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
VSTXUNIQ  FORM      3
QRYDATA1  DIM       240
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
CURRDATX  DIM       8
.
NINES     INIT      "99999"
.
.
VTYPE     DIM       10            * Contains the Following 
MVEVN01   INIT      "A&E       "
MVEVN02   INIT      "O/P Att.  "
MVEVN03   INIT      "Admission "
MVEVN04   INIT      "Cancelled "
MVEVN05   INIT      "Discharged"
MVEVN06   INIT      "On-Leave  "
MVEVN07   INIT      "Pre-Adm.  "
MVEVN08   INIT      "Community "
MVEVN09   INIT      "Waiting   "
MVEVN10   INIT      "I/P Book  "
MVEVN11   INIT      "O/P Ref.  "
MVEVN12   INIT      "O/P Book  "
MVEVN13   INIT      "Dis Nurs A"
MVEVN14   INIT      "Dis Nurs D"
MVEVN15   INIT      "Maternity "
MVEVN16   INIT      "Orig Ref. "
MVEVN17   DIM       10            * Set in UNLNKMUL.PBL depending on event type
MVEVN18   INIT      "Allied    "
.
.---------------------------------------------------------------------------
PRGID     INIT      "EOCWEB01"
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Episode of Care Server"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
MAIN1010  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      EOCDIS00                * Episode of Care Display 
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          BRANCH    EXIT,MAIN1010
          GOTO      MAIN1000
.
MAIN1200  CALL      EOCRFR00                * Episode of Care Referral
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      EOCACC00                * Episode of Care Accident
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          BRANCH    EXIT,MAIN1010
          GOTO      MAIN1000
.
MAIN1400  CALL      RSCRPT00                 * Remote Scripting
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60
.
          CALL      WINCLS00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG10  CALL      NXTJPG00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG50  STRIP     REDIRECT               
          ENDSET    REDIRECT
.
          MOVE      ECRFEPNO,D5
          REP       " +",D5
          APPEND    D5,REDIRECT  
.
          RESET     REDIRECT

          CALL      RDIREC00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG60  CALL      RDIREC00
          MOVE      ZERO,EXIT
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back x number of pages
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F1
          SUB       TWO,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
.                            "    self.close();":
                             "    window.history.go(-",F1,");":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------------------------
.  Redirect URL
.------------------------------------------------------------------------------
NXTJPG00  CALL      OPENHTML
          BRANCH    EXIT,NXTJPG90
          STRIP     WEBTITLE
          MOVELPTR  WEBTITLE,TXTLEN
          IF        TXTLEN>0
            SFORMAT   VAR,TXTLEN
          ELSE
            SFORMAT   VAR,ONE
          ENDIF
          MOVE      WEBTITLE,VAR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",VAR,"#");"
          SFORMAT   VAR,127
          STRIP     REDIRECT
          MOVELPTR  REDIRECT,TXTLEN
          IF        TXTLEN>0
            SFORMAT   VAR,TXTLEN
          ELSE
            SFORMAT   VAR,ONE
          ENDIF
          MOVE      REDIRECT,VAR
.
          WRITE     HTMLFILE;"    if (window.name.substr(0,4)=='Hide' ) {":
                             "     opener.location.href=#"",VAR,"#";":
                             "     self.close(); } ":
                             "    else {":
                             "     location.href=#"",VAR,"#";} }":
                             "</script>"
          CALL      CLOSHTML
          SFORMAT   VAR,127
          GOTO      NXTJPG99
.
NXTJPG90  DISPLAY   "*** Fifo Not Found ***"
.
NXTJPG99  RETURN
.------------------------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,TWENTY2;*1,STCNAAED
.
          READ      CONTROLF,SEVENTY9;*138,PTCNURHA
          READ      CONTROLF,SEVENTY9;*123,PTCNLEDT
          READ      CONTROLF,THIRTY1;*183,OTCNNSID
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.       
          OPEN      EOCREFA1,"eocrefaf"  * EOC Referral File
          OPEN      EOCACCA1,"eocaccaf"  * Accident Detail File
          OPEN      EOCAFCA1,"eocafcaf"  * Accident Flag Change File
          OPEN      EOCLNKA1,"eoclnkaf"  * Link File 
          OPEN      EOCLNKA2,"eoclnkaf"  * Link File 
          OPEN      EOCLNKA3,"eoclnkaf"  * Link File 
          OPEN      PATDO1A1,"patdo1af"  * Doctor File
          OPEN      VISMDTA1,"vismdtaf"  * visit Comments file  
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCODE1,"patcodes"  * Codes Table File
          OPEN      PATCODE2,"patcodes"  * Codes Table File
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSHCPA1,"pmshcpaf"  * National HCP File
          OPEN      PATHOSP2,"pathospf"  * Hospital File
          OPEN      PATVISA1,"patvisaf"  * Patient Visits File   
          OPEN      PMSVX1A1,"pmsvx1af"  * Patient Visits extn File   
          OPEN      WEBHDPA1,"webhdpaf"  * Hospital Data File Locations
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
          CALL      PATDPATH
.
          RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          OPEN      OUTCTYA1,CFNAME           * Outpatient Clinic Type File 
.
          PACK      CFNAME,CFILEPRE,FILHISA1  * Get the name of the HISA1 file
          OPEN      OUTHISA1,CFNAME           * Outpatient History File
.
          OPEN      OUTPREA1,"outpreaf"       * Open pre-attendance file
.
          OPEN      OUTRF1A1,"outrf1af"  * New Referral Letter File
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,NEXTREPT
          MOVE      SP70,NEXTTEMP
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,EPSOFCAR
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,RETURNCD
          MOVE      SP70,LNKECACC 
          MOVE      ZERO,UPDATETY
          MOVE      SP70,SAVACCNO
.
          MOVE      SP70,OTRFL001
          MOVE      SP70,OTRFL002 
          MOVE      SP70,OTRFL003  
          MOVE      SP70,OTRFL004  
          MOVE      SP70,OTRFL005 
          MOVE      SP70,OTRFL006
          MOVE      SP70,OTRFL007
          MOVE      SP70,OTRFL008
          MOVE      SP70,OTRFL009
          MOVE      SP70,OTRFL010
          MOVE      SP70,OTRFL011
          MOVE      SP70,OTRFL013
          MOVE      SP70,OTRFL014
          MOVE      SP70,OTRFL015
          MOVE      SP70,OTRFL016
          MOVE      SP70,OTRFL017
          MOVE      SP70,OTRFL018
          MOVE      SP70,OTRFL019
          MOVE      SP70,OTRFL020
          MOVE      SP70,OTRFL021
          MOVE      SP70,OTRFL022
          MOVE      SP70,OTRFL023
          MOVE      SP70,OTRFL024
          MOVE      SP70,OTRFL025
          MOVE      SP70,OTRFL026
          MOVE      SP70,OTRFL027
          MOVE      SP70,OTRFL028
          MOVE      SP70,OTRFL029
          MOVE      SP70,OTRFL030
          MOVE      SP70,OTRFL031
          MOVE      SP70,OTRFL032
          MOVE      SP70,OTRFL033
          MOVE      ZERO,OTRFL034  
          MOVE      SP70,OTRFL035 
          MOVE      SP70,OTRFL036
.
          MOVE      ZERO,LINKEND
          MOVE      ZERO,UNLKEND
          MOVE      ZERO,VSCMTFLG
          MOVE      ZERO,VSCMTLIN
.
          MOVE      SP70,ECACC001  
          MOVE      SP70,ECACC002
          MOVE      Z70,ECACC003 
          MOVE      Z70,ECACC004 
          MOVE      Z70,ECACC005 
          MOVE      Z70,ECACC006 
          MOVE      Z70,ECACC007 
          MOVE      Z70,ECACC008 
          MOVE      Z70,ECACC009 
          MOVE      Z70,ECACC010 
          MOVE      Z70,ECACC011  
          MOVE      Z70,ECACC012 
          MOVE      Z70,ECACC013 
          MOVE      Z70,ECACC014 
          MOVE      Z70,ECACC015 
          MOVE      Z70,ECACC016 
          MOVE      Z70,ECACC017 
          MOVE      Z70,ECACC018 
          MOVE      Z70,ECACC019 
          MOVE      Z70,ECACC020 
          MOVE      Z70,ECACC021 
          MOVE      Z70,ECACC022 
          MOVE      Z70,ECACC023 
          MOVE      Z70,ECACC024 
          MOVE      Z70,ECACC025 
          MOVE      Z70,ECACC026 
          MOVE      Z70,ECACC027 
          MOVE      Z70,ECACC028 
          MOVE      Z70,ECACC029 
          MOVE      Z70,ECACC030 
          MOVE      Z70,ECACC031 
          MOVE      Z70,ECACC032 
          MOVE      Z70,ECACC033 
          MOVE      Z70,ECACC034 
          MOVE      Z70,ECACC035 
          MOVE      Z70,ECACC036 
          MOVE      Z70,ECACC037 
          MOVE      Z70,ECACC038 
          MOVE      Z70,ECACC039 
          MOVE      Z70,ECACC040 
          MOVE      Z70,ECACC041 
          MOVE      Z70,ECACC042 
          MOVE      Z70,ECACC043 
          MOVE      Z70,ECACC044 
          MOVE      Z70,ECACC045 
          MOVE      Z70,ECACC046 
          MOVE      Z70,ECACC047 
          MOVE      Z70,ECACC048 
          MOVE      Z70,ECACC049 
          MOVE      Z70,ECACC050 
          MOVE      Z70,ECACC051 
          MOVE      Z70,ECACC052 
          MOVE      Z70,ECACC053 
          MOVE      Z70,ECACC054 
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            PACK      ADMISSNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextrept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTREPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nexttemp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTTEMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epsofcar=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSOFCAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otrfl",QRYNAME
          IF        @EQUAL
            CALL      STDIS000        
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecacc",QRYNAME
          IF        @EQUAL
            CALL      STACC000        
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkevnt=",QRYNAME
          IF        @EQUAL
            ADD       ONE,LINKEND       
            PACK      LINKEVNT[LINKEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unlkevnt=",QRYNAME
          IF        @EQUAL
            ADD       ONE,UNLKEND       
            PACK      UNLKEVNT[UNLKEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returncd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lnkecacc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LNKECACC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savaccno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVACCNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Set Parameters for Option 1: Episode of Care Display   
.------------------------------------------------------------
STDIS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STDIS001,STDIS002,STDIS003,STDIS004,STDIS005,STDIS006:
                       STDIS007,STDIS008,STDIS009,STDIS010,STDIS011,STDIS012:
                       STDIS013,STDIS014,STDIS015,STDIS016,STDIS017,STDIS018:
                       STDIS019,STDIS020,STDIS021,STDIS022,STDIS023,STDIS024:
                       STDIS025,STDIS026,STDIS027,STDIS028,STDIS029,STDIS030:
                       STDIS031,STDIS032,STDIS033,STDIS034,STDIS035,STDIS036
.
          GOTO      STDIS999   
.
STDIS001  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL001,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL001
          ENDIF 
          GOTO      STDIS999   
.
STDIS002  MOVE      QRYDATA,OTRFL002
          GOTO      STDIS999   
.
STDIS003  MOVE      QRYDATA,OTRFL003
          GOTO      STDIS999   
.
STDIS004  MOVE      QRYDATA,OTRFL004
          GOTO      STDIS999   
.
STDIS005  MOVE      QRYDATA,OTRFL005
          GOTO      STDIS999   
.
STDIS006  MOVE      QRYDATA,OTRFL006
          GOTO      STDIS999   
.
STDIS007  MOVE      QRYDATA,OTRFL007
          GOTO      STDIS999   
.
STDIS008  MOVE      QRYDATA,OTRFL008
          GOTO      STDIS999   
.
STDIS009  MOVE      QRYDATA,OTRFL009
          GOTO      STDIS999   
.
STDIS010  MOVE      QRYDATA,OTRFL010
          GOTO      STDIS999   
.
STDIS011  MOVE      QRYDATA,OTRFL011
          GOTO      STDIS999   
.
STDIS012  CALL      GTVISC00         * Save Episode comments into array
          MOVE      ONE,VSCMTFLG
          GOTO      STDIS999   
.
STDIS013  MOVE      QRYDATA,OTRFL013
          GOTO      STDIS999   
.
STDIS014  MOVE      QRYDATA,OTRFL014
          GOTO      STDIS999   
.
STDIS015  MOVE      QRYDATA,OTRFL015
          GOTO      STDIS999   
.
STDIS016  MOVE      QRYDATA,OTRFL016
          GOTO      STDIS999   
.
STDIS017  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL017,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL017
          ENDIF 
          GOTO      STDIS999   
.
STDIS018  MOVE      QRYDATA,OTRFL018
          GOTO      STDIS999   
.
STDIS019  MOVE      QRYDATA,OTRFL019
          GOTO      STDIS999   
.
STDIS020  MOVE      QRYDATA,OTRFL020
          GOTO      STDIS999   
.
STDIS021  MOVE      QRYDATA,OTRFL021
          GOTO      STDIS999   
.
STDIS022  MOVE      QRYDATA,OTRFL022
          GOTO      STDIS999   
.
STDIS023  MOVE      QRYDATA,OTRFL023
          GOTO      STDIS999   
.
STDIS024  MOVE      QRYDATA,OTRFL024
          GOTO      STDIS999   
.
STDIS025  MOVE      QRYDATA,OTRFL025
          GOTO      STDIS999   
.
STDIS026  MOVE      QRYDATA,OTRFL026
          GOTO      STDIS999   
.
STDIS027  MOVE      QRYDATA,OTRFL027
          GOTO      STDIS999   
.
STDIS028  MOVE      QRYDATA,OTRFL028
          GOTO      STDIS999   
.
STDIS029  MOVE      QRYDATA,OTRFL029
          GOTO      STDIS999   
.
STDIS030  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL030,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL030
          ENDIF 
          GOTO      STDIS999   
.
STDIS031  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL031,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL031
          ENDIF 
          GOTO      STDIS999   
.
STDIS032  MOVE      QRYDATA,OTRFL032
          GOTO      STDIS999   
.
STDIS033  MOVE      QRYDATA,OTRFL033
          GOTO      STDIS999   
.
STDIS034  MOVE      QRYDATA,OTRFL034
          GOTO      STDIS999   
.
STDIS035  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL035,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL035
          ENDIF 
          GOTO      STDIS999   
.
STDIS036  MOVE      QRYDATA,OTRFL036
          GOTO      STDIS999   
.
STDIS999  RETURN
.------------------------------------------------------------
. Set Parameters for Option 2: Episode of Care Accidents 
.------------------------------------------------------------
STACC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STACC001,STACC002,STACC003,STACC004,STACC005,STACC006:
                       STACC007,STACC008,STACC009,STACC010,STACC011,STACC012:
                       STACC013,STACC014,STACC015,STACC016,STACC017,STACC018:
                       STACC019,STACC020,STACC021,STACC022,STACC023,STACC024:
                       STACC025,STACC026,STACC027,STACC028,STACC029,STACC030:
                       STACC031,STACC032,STACC033,STACC034,STACC035,STACC036:
                       STACC037,STACC038,STACC039,STACC040,STACC041,STACC042:
                       STACC043,STACC044,STACC045,STACC046,STACC047,STACC048:
                       STACC049,STACC050,STACC051,STACC052,STACC053,STACC054
.
          GOTO      STACC999   
.
STACC001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ECACC001
          PACK      ECACC001,ECACC001,SP70
          GOTO      STACC999   
.
STACC002  MOVE      QRYDATA,ECACC002
          GOTO      STACC999   
.
STACC003  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC003,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC003
          ENDIF 
          GOTO      STACC999   
.
STACC004  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC004,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC004
          ENDIF 
          GOTO      STACC999   
.
STACC005  MOVE      QRYDATA,ECACC005
          GOTO      STACC999   
.
STACC006  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC006,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC006
          ENDIF 
          GOTO      STACC999   
.
STACC007  MOVE      QRYDATA,ECACC007
          GOTO      STACC999   
.
STACC008  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC008,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC008
          ENDIF 
          GOTO      STACC999   
.
STACC009  MOVE      QRYDATA,ECACC009
          GOTO      STACC999   
.
STACC010  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC010,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC010
          ENDIF 
          GOTO      STACC999   
.
STACC011  MOVE      QRYDATA,ECACC011
          GOTO      STACC999   
.
STACC012  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC012,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC012
          ENDIF 
          GOTO      STACC999   
.
STACC013  MOVE      QRYDATA,ECACC013
          GOTO      STACC999   
.
STACC014  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ECACC014,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ECACC014
          ENDIF 
          GOTO      STACC999   
.
STACC015  MOVE      QRYDATA,ECACC015
          GOTO      STACC999   
.
STACC016  MOVE      QRYDATA,ECACC016
          GOTO      STACC999   
.
STACC017  MOVE      QRYDATA,ECACC017
          GOTO      STACC999   
.
STACC018  MOVE      QRYDATA,ECACC018
          GOTO      STACC999   
.
STACC019  MOVE      QRYDATA,ECACC019
          GOTO      STACC999   
.
STACC020  MOVE      QRYDATA,ECACC020
          GOTO      STACC999   
.
STACC021  MOVE      QRYDATA,ECACC021
          GOTO      STACC999   
.
STACC022  MOVE      QRYDATA,ECACC022
          GOTO      STACC999   
.
STACC023  MOVE      QRYDATA,ECACC023
          GOTO      STACC999   
.
STACC024  MOVE      QRYDATA,ECACC024
          GOTO      STACC999   
.
STACC025  MOVE      QRYDATA,ECACC025
          GOTO      STACC999   
.
STACC026  MOVE      QRYDATA,ECACC026
          GOTO      STACC999   
.
STACC027  MOVE      QRYDATA,ECACC027
          GOTO      STACC999   
.
STACC028  MOVE      QRYDATA,ECACC028
          GOTO      STACC999   
.
STACC029  MOVE      QRYDATA,ECACC029
          GOTO      STACC999   
.
STACC030  MOVE      QRYDATA,ECACC030
          GOTO      STACC999   
.
STACC031  MOVE      QRYDATA,ECACC031
          GOTO      STACC999   
.
STACC032  MOVE      QRYDATA,ECACC032
          GOTO      STACC999   
.
STACC033  MOVE      QRYDATA,ECACC033
          GOTO      STACC999   
.
STACC034  MOVE      QRYDATA,ECACC034
          GOTO      STACC999   
.
STACC035  MOVE      QRYDATA,ECACC035
          GOTO      STACC999   
.
STACC036  MOVE      QRYDATA,ECACC036
          GOTO      STACC999   
.
STACC037  MOVE      QRYDATA,ECACC037
          GOTO      STACC999   
.
STACC038  MOVE      QRYDATA,ECACC038
          GOTO      STACC999   
.
STACC039  MOVE      QRYDATA,ECACC039
          GOTO      STACC999   
.
STACC040  MOVE      QRYDATA,ECACC040
          GOTO      STACC999   
.
STACC041  MOVE      QRYDATA,ECACC041
          GOTO      STACC999   
.
STACC042  MOVE      QRYDATA,ECACC042
          GOTO      STACC999   
.
STACC043  MOVE      QRYDATA,ECACC043
          GOTO      STACC999   
.
STACC044  MOVE      QRYDATA,ECACC044
          GOTO      STACC999   
.
STACC045  MOVE      QRYDATA,ECACC045
          GOTO      STACC999   
.
STACC046  MOVE      QRYDATA,ECACC046
          GOTO      STACC999   
.
STACC047  MOVE      QRYDATA,ECACC047
          GOTO      STACC999   
.
STACC048  MOVE      QRYDATA,ECACC048
          GOTO      STACC999   
.
STACC049  MOVE      QRYDATA,ECACC049
          GOTO      STACC999   
.
STACC050  MOVE      QRYDATA,ECACC050
          GOTO      STACC999   
.
STACC051  MOVE      QRYDATA,ECACC051
          GOTO      STACC999   
.
STACC052  MOVE      QRYDATA,ECACC052
          GOTO      STACC999   
.
STACC053  MOVE      QRYDATA,ECACC053
          GOTO      STACC999   
.
STACC054  MOVE      QRYDATA,ECACC054
          GOTO      STACC999   
.
STACC999  RETURN
.-----------------------------------------------------------------
. GTVISC00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVISC10 IF EOS

.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   "99",VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
.------------------------------------------------------------
. Episode of Care Display
.------------------------------------------------------------
EOCDIS00  MOVE      ZERO,EXIT
.
          CALL     EXSACC00
          IF       ECLNEPNO>0
            GOTO      EOCDIS99
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EOCDIS90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,EPSOFCAR
          IF        @EQUAL
            MOVE      SP70,OTRLOUTN
            MOVE      SP70,OTRLURNO
            CALL      CLOUTRFL    * Clear Referral Letter File Variables
            CALL      CLRRFL00    * Clear Referral File Variables
            CALL      EOCDEF00
          ELSE
            CALL      EOCREF00    * Read EOC & Corresponding Referral details
            BRANCH    EXIT,EOCDIS99
          ENDIF
.
          MOVE      "Episode of Care",WEBTITLE
          CALL      WEBHED00    * Heading
          BRANCH    EXIT,EOCDIS99
          CALL      WEBBOD00
          CALL      WEBEND00    * End of Page
          MOVE      ONE,EXIT 
          GOTO      EOCDIS99
.
EOCDIS90  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCDIS99
.
EOCDIS91  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCDIS99
.
EOCDIS99  RETURN
.------------------------------------------------------------
. Read the Episode of Care and corresponding referral details
.------------------------------------------------------------
EOCREF00  MOVE      ZERO,EXIT
          PACK      KEY13,URNUMBER,EPSOFCAR,SP70
          CALL      RDECREF1
          BRANCH    OVRCD,EOCREF90
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      EOCREF10 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      EOCREF10 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
EOCREF10  PACK      KEY8,ECRFREFN 
          CALL      RDOTRFL1
          BRANCH    OVRCD,EOCREF91
.
          GOTO      EOCREF99
.
EOCREF90  MOVE      "Invalid Read on EOC Referral File",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCREF99
.
EOCREF91  MOVE      "Invalid Read on Referral Letter File",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
EOCREF99  RETURN
.----------------------------------------------------------------------
. Default Values for Epsiode of Care if a Visit No is Available
.----------------------------------------------------------------------
EOCDEF00  MATCH     SP70,ADMISSNO
          GOTO      EOCDEF99 IF EQUAL
.
          READ      CONTROLF,SEVENTY6;*87,DSCNRQDF,DSCNECSR
          READ      CONTROLF,SEVENTY8;*36,AECNRQDF,AECNECSR
          READ      CONTROLF,THIRTY2;*53,OTCNORFL,OTCNRQDF
          READ      CONTROLF,THIRTY7;*232,WTCNRQDF,WTCNECSR
          READ      CONTROLF,NINTY8;*121,PTCNRQDF
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      EOCDEF05 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      EOCDEF05 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
EOCDEF05  MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1                 * Check for Referral Details
          COMPARE   ZERO,OVRCD
          GOTO      EOCDEF99 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1                  * Check if visit record exists
          BRANCH    OVRCD,EOCDEF50
.
          BRANCH    PVITYPE,EOCDEF10,EOCDEF20,EOCDEF30
          GOTO      EOCDEF99
.
EOCDEF10  PROC      EMRDEF00
          GOTO      EOCDEF99
.
EOCDEF20  PROC      OUTDEF00
          GOTO      EOCDEF99
.
EOCDEF30  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,EOCDEF99
.
          MOVE      ADATE,OTRLDATE      * Date of Referral
          MOVE      ADOCTR,OTRLRDOC     * Referral Doctor
          MOVE      ATYPE,OTRLDEPT      * Health Speciality
          MOVE      ADIAG1,OTRLDIAG     * Referral Reason
          MOVE      PTCNRQDF,OTRLREAS   * Reason for Request
          MOVE      ASRCE,OTRLSRCE      * Referral Source
          MOVE      ADOCTA,OTRLRHCP     * Responsible HCP
          MOVE      PTMIPHPU,OTRLPURC   * Expected Purchaser
.
          GOTO      EOCDEF99
.
EOCDEF50  MOVE      ZERO,PVITYPE
          PROC      OUTDEF00   * Check for Booking
.
EOCDEF99  RETURN
.------------------------------------------------------------
. CLRRFL00 - Clear the Referral Variables (EOCREFFD)
.------------------------------------------------------------
CLRRFL00  MOVE      SP20,ECRFURNO
          MOVE      ZERO,ECRFEPNO
          MOVE      ZERO,ECRFHOSP
          MOVE      ZEROVISN,ECRFREFN
          MOVE      SP20,ECRFACCN
          MOVE      ZERO,ECRFSTAT
          MOVE      SP10,ECRFCDAT
          PACK      ECRFSPAR,SP30,SP30
.
CLRRFL99  RETURN
.------------------------------------------------------------
. Episodes of Care - Referral Add,Update,Delete
.------------------------------------------------------------
EOCRFR00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EOCRFR93 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      EOCRFR10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      EOCRFR20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      EOCRFR30 IF EQUAL
.
          MATCH     "P",UPDTTYPE    * Process formaction
          GOTO      EOCRFR40 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Link Current Admissno formaction
          GOTO      EOCRFR50 IF EQUAL
.
          MATCH     "L",UPDTTYPE    * Close EOC Recerral               
          GOTO      EOCRFR60 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Reactivate EOC Referral          
          GOTO      EOCRFR70 IF EQUAL
.
          GOTO      EOCRFR93
.
.         ************ ADD FORMACTION **************
.
EOCRFR10  PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,EOCRFR90
.        
...       CALL      CHKEPS00     * Check EOS Mandatory Fields 
...       BRANCH    EXIT,EOCRFR99
          CALL      GENEPS00     * Generate a new episode of Care Number 
.
EOCRFR11  CALL      GENBOK00     * Generate Outpatient Booking Number
          CALL      WRIREF00     * Write Referral Letter Record 
          BRANCH    EXIT,EOCRFR11
          CALL      SAVEPS00     * Save & Write Episode of Care Referral Record
          CALL      UPVCM000     * Save Episode of Care Text Box Comments
          CALL      LNKSAV00     * Save & Write to Episode of Care Link File 
.
.    Check if Referral Type (OTRFL034) is set to 0=Outpatients 
.
          IF        OTRFL034=0          
            CALL      WRTHIS00   * Write/Update the Outpatient History File 
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      EOCRFR99
.
.         ************ UPDATE FORMACTION ************
.
EOCRFR20  PACK      KEY8,URNUMBER,SP70        * Read Master File  
          CALL      RDMAST1
          BRANCH    OVRCD,EOCRFR90
.
          PACK      KEY13,URNUMBER,EPSOFCAR,SP70  * Referral File
          CALL      RDECREF1
          BRANCH    OVRCD,EOCRFR91 
          MOVE      ECRFREFN,OUTBOKNO     * Outpatient number  
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      EOCRFR25 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      EOCRFR25 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
EOCRFR25  PACK      KEY8,OUTBOKNO,SP70    * Referral Letter File 
          CALL      RDOTRFL1 
          BRANCH    OVRCD,EOCRFR91
.
...       CALL      CHKEPS00     * Check EOS Mandatory Fields 
...       BRANCH    EXIT,EOCRFR99
.          
          CALL      UPDREF00     * Update Referral Letter Record 
          CALL      UPVCM000     * Save Episode of Care Text Box Comments
.
          MOVE      ZERO,EXIT
          GOTO      EOCRFR99
.
.         ************ DELETE FORMACTION **********
.
EOCRFR30  PACK      KEY8,URNUMBER,SP70     * Read Master File  
          CALL      RDMAST1
          BRANCH    OVRCD,EOCRFR90
.
          PACK      KEY13,URNUMBER,EPSOFCAR,SP70  * Referral File
          CALL      RDECREF1
          BRANCH    OVRCD,EOCRFR91 
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      EOCRFR35 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      EOCRFR35 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
EOCRFR35  PACK      KEY8,ECRFREFN,SP70      * Referral Letter File
          CALL      RDOTRFL1 
          BRANCH    OVRCD,EOCRFR91
.
          CALL      CHLNK000       * Check Event from EOC Link File
          BRANCH    EXIT,EOCRFR94
.
          CALL      DREOC000       * Delete EOC Referral record
          CALL      DELNK000       * Delete Event from EOC Link File
          CALL      DOTRL000       * Delete Referral Record
          CALL      DACCD000       * Delete Accident Detail Record
          CALL      DACFC000       * Delete ACC Flag Change Record
.
          MOVE      VSCMTTYP,KEY3
          MOVE      ECRFREFN,KEY8
          CALL      DLVCM000       * Delete comments from comment file    
.
          MOVE      ZERO,EXIT
          GOTO      EOCRFR99
.
.         ******** PROCESS LINKS FORMACTION *******
.
EOCRFR40  CALL      LNKEVN00      * Link Unlinked Events   
          CALL      ULKEVN00      * Unlink Linked Events
.
          MOVE      ZERO,EXIT
          GOTO      EOCRFR99
.
EOCRFR50  CALL      LNKCUR00      * Link Unlinked Events   
          MOVE      ONE,EXIT
          GOTO      EOCRFR99
.
EOCRFR60  CALL      CLSE0000      * Close EOC Referral     
          GOTO      EOCRFR99
.
EOCRFR70  CALL      REOP0000      * ReActivate EOC Referral
          GOTO      EOCRFR99
.
EOCRFR90  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCRFR99
.
EOCRFR91  MOVE      "Invalid Episode of Care",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCRFR99
.
EOCRFR93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCRFR99
.
EOCRFR94  MOVE      "Linked Events Still Exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCRFR99

.
EOCRFR99  RETURN
.------------------------------------------------------------------
. CHLNK000 - Check the event from EOC link file    called by; EOCRFR00  
.----------------------------------------------------------------------
CHLNK000  MOVE      ECRFURNO,ECLNURNO
          MOVE      ECRFEPNO,ECLNEPNO
          MOVE      ECRFHOSP,ECLNHOSP
          MOVE      ECRFREFN,ECLNVISI
          PACK      KEY23,ECLNURNO,ECLNEPNO,ECLNHOSP,SP70
          CALL      RSECLNK1
CHLNK100  CALL      RKECLNK1
          BRANCH    OVRCD,CHLNK900
          MATCH     ECLNURNO,ECRFURNO
          GOTO      CHLNK900 IF NOT EQUAL
          COMPARE   ECLNEPNO,ECRFEPNO
          GOTO      CHLNK900 IF NOT EQUAL
          COMPARE   ECLNHOSP,ECRFHOSP
          GOTO      CHLNK900 IF NOT EQUAL
          MATCH     ECLNVISI,ECRFREFN
          GOTO      CHLNK100 IF EQUAL
          MOVE      ONE,EXIT
          GOTO      CHLNK999
CHLNK900  MOVE      ZERO,EXIT
.
CHLNK999  RETURN
.------------------------------------------------------------------
. * Checks mandatory fields and checks for blank
.------------------------------------------------------------------
CHKEPS00  RESET     OTRFL001
          MATCH     SP70,OTRFL001
          GOTO      CHKEPS90 IF EQUAL
.
          RESET     OTRFL002
          MATCH     SP70,OTRFL002
          GOTO      CHKEPS91 IF EQUAL
.
          RESET     OTRFL028
          MATCH     SP70,OTRFL028
          GOTO      CHKEPS92 IF EQUAL
.
          GOTO      CHKEPS98
.
CHKEPS90  MOVE      "Referral Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKEPS99
.
CHKEPS91  MOVE      "Referring Doctor is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKEPS99
.
CHKEPS92  MOVE      "Source of Referral is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKEPS99
.
CHKEPS98  MOVE      ZERO,EXIT
CHKEPS99  RETURN
.------------------------------------------------------------------
.                       LNKEVN00
.  Links Unlinked events to the EOC Link File   
.                                               called by: EOCRFR00
.------------------------------------------------------------------
LNKEVN00  MOVE      ONE,F3
LNKEVN10  IF        F3<=LINKEND   
            MATCH     LINKEVNT[F3],SP70
            IF        !@EQUAL
               PACK      KEY10,LINKEVNT[F3]
               CALL      RAECLNK2 
               IF        OVRCD=0 
                 CALL      DEECLNK2
               ENDIF 
            ENDIF  
            ADD       ONE,F3
            GOTO      LNKEVN10
          ENDIF
.
LNKEVN99  RETURN
.------------------------------------------------------------------
.                       ULKEVN00
.  Links Unlinked events to the EOC Link File   
.                                               called by: EOCRFR00
.------------------------------------------------------------------
ULKEVN00  MOVE      ONE,F3
ULKEVN10  IF        F3<=UNLKEND   
            MATCH     UNLKEVNT[F3],SP70
            IF        !@EQUAL
               MOVE      URNUMBER,ECLNURNO
               MOVE      EPSOFCAR,ECLNEPNO 
               UNPACK    UNLKEVNT[F3],KEY2,KEY8
               MOVE      KEY2,ECLNHOSP
               MOVE      KEY8,ECLNVISI
               PACK      KEY10,UNLKEVNT[F3]
               CALL      RAECLNK2 
               IF        OVRCD=1 
                 CALL      WRECLNK2
               ENDIF 
            ENDIF  
            ADD       ONE,F3
            GOTO      ULKEVN10
          ENDIF
.
ULKEVN99  RETURN
.------------------------------------------------------------
. Link Current Admissno
.------------------------------------------------------------
LNKCUR00  MATCH     SP70,ADMISSNO
          GOTO      LNKCUR90 IF EQUAL
.
          MOVE      URNUMBER,ECLNURNO
          MOVE      EPSOFCAR,ECLNEPNO 
          MOVE      CHOSPNUM,ECLNHOSP
          MOVE      ADMISSNO,ECLNVISI
          PACK      KEY13,ECLNURNO,EPSOFCAR,SP70
          CALL      RDECREF1
          IF        OVRCD<.1
            IF        ECRFSTAT=1
              MOVE      "Unable to Link, Episode of Care is Closed.",WEBTITLE
              CALL      WEBERR00
              GOTO      LNKCUR99
            ENDIF
          ENDIF
          PACK      KEY10,CHOSPNUM,ADMISSNO,SP70
          CALL      RAECLNK2 
          IF        OVRCD=1 
            CALL      WRECLNK2
            MOVE      "Patient Event Now Linked",WEBTITLE
            CALL      WEBERR00
          ELSE
            MOVE      "ERROR: Patient Event Already Linked",WEBTITLE
            CALL      WEBERR00
          ENDIF 
.
          GOTO      LNKCUR99
.
LNKCUR90  MOVE      "ERROR: Patient Event Not Specified",WEBTITLE
          CALL      WEBERR00
.          
LNKCUR99  RETURN
.------------------------------------------------------------------
.                       GENEPS00
.  Generate new Episode of Care Number.         
.  RETURNS : EPSOFCAR - Episode of Care No. 
.                                               called by: EOCRFR00
.------------------------------------------------------------------
GENEPS00  MOVE      ONE,FORM5
          PACK      KEY13,URNUMBER,NINES
          CALL      RSECREF1
          CALL      RPECREF1
          BRANCH    OVRCD,GENEPS98
.
          MATCH     URNUMBER,ECRFURNO
          GOTO      GENEPS98 IF NOT EQUAL
.
          MOVE      ECRFEPNO,FORM5
          ADD       ONE,FORM5
.
GENEPS98  MOVE      FORM5,EPSOFCAR    * Episode of Care ID
GENEPS99  RETURN
.------------------------------------------------------------------
.                       GENBOK00
.  Generate new Outpatients Booking Number. 
.  RETURNS : OUTBOKNO - Outpatient Booking No. 
.                                              called by: EOCRFR00
.------------------------------------------------------------------
GENBOK00  READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OUTBOKNO
          ELSE
            MOVE      " 10",PRXCODE   * System Lock Sector 10
            CALL      GETSLK00        * Get System Lock of Sector 10
            READ      CONTROLF,TEN;*1,FORM8V  * Get the next Outpatient number
            ADD       ONE,FORM8V              * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8V  * Post new outpatient no
            CALL      RELSLK00        * Release System Lock of Sector 10
            SUB       ONE,FORM8V              * Go back to original O/P Number
            MOVE      FORM8V,OUTBOKNO
          ENDIF
.
.         Make sure this outpatient number has not been used
.
          PACK      KEY8,OUTBOKNO            * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      GENBOK00 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OUTBOKNO            * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      GENBOK00 IF EQUAL        * Yes. Try again
.
GENBOK99  RETURN
.------------------------------------------------------------------
.                        SAVREF00
.  Save Referral Table Variables                called by: EOCRFR00
.------------------------------------------------------------------
SAVREF00  MOVE      OUTBOKNO,OTRLOUTN      * Outpatient Number
          MOVE      URNUMBER,OTRLURNO      * U/R Number
          MOVE      OTRFL001,OTRLDATE      * Letter Date
          MOVE      OTRFL002,OTRLRDOC      * Referral Doctor
          MOVE      OTRFL004,OTRLCONS      * Consultant
          MOVE      OTRFL005,OTRLDEPT      * Department
          MOVE      OTRFL007,OTRLPRIO      * Priority
          MOVE      OTRFL006,OTRLDIAG      * Diagnosis
          MOVE      OTRFL008,OTRLUSD1      * User Defined Field 1
          MOVE      OTRFL009,OTRLUSD2      * User Defined Field 2
          MOVE      OTRFL010,OTRLUSD3      * User Defined Field 3
          MOVE      OTRFL011,OTRLUSD4      * User Defined Field 4
. -----  Booking Details  -----
          MOVE      SP70,OTRLBSIT          * Booked Site
          MOVE      SP70,OTRLBCLI          * Booked Clinic
          MOVE      SP70,OTRLBDTE          * Booked Date
          MOVE      SP70,OTRLBSTR          * Booked Start Time
          MOVE      SP70,OTRLBSLT          * Booked Slot Number
. -----  New Variables  -----
          MOVE      OTRFL013,OTRLRFGP      * Referring GP
          MOVE      OTRFL014,OTRLGPPC      * GP Practice Code
          MOVE      OTRFL016,OTRLRQST      * Request Number
          MOVE      OTRFL017,OTRLCDTE      * Request for Appointment Canc. Date
          MOVE      OTRFL018,OTRLREAS      * Reason for Request  (Cat "RQ")
          MOVE      OTRFL019,OTRLSPFC      * Specialty Function Code (Cat "OF")
          MOVE      OTRFL020,OTRLCAD1      * Correspondence Address Line 1
          MOVE      OTRFL021,OTRLCAD2      * Correspondence Address Line 2
          MOVE      OTRFL022,OTRLCAD3      * Correspondence Address Line 3
          MOVE      OTRFL023,OTRLCAD4      * Correspondence Address Line 4
          MOVE      OTRFL024,OTRLCPC       * Correspondence Post Code
          MOVE      OTRFL025,OTRLECRN      * ECR Approval Number
          MOVE      OTRFL026,OTRLGPFH      * GPFH Approval Number
          MOVE      OTRFL015,OTRLGPPT      * GP Practice count
          MOVE      SP70,OTRLOPER          * Operator who recorded O/P referral
          MOVE      OTRFL027,OTRLCTYP      * Clinic Type of Referral
          MOVE      SP70,OTRLSITE          * Site Code of Referral
          MOVE      OTRFL028,OTRLSRCE      * Source of Referral
          MOVE      OTRFL029,OTRLRHCP      * Responsible HCP
          MOVE      OTRFL030,OTRLDREC      * Date Referral Received
          MOVE      OTRFL031,OTRLDPRI      * Date of Priority
          MOVE      OTRFL032,OTRLPURC      * Expected Purchaser
          MOVE      ONE,OTRLTREF           * Ref Type (0=Outpatient, 1=Other)
          MOVE      OTRFL033,OTRLRANK      * Patient Rank
          MOVE      SP70,OTRLSPRE          * Spare
.
SAVREF99  RETURN
.------------------------------------------------------------------
.  WRIREF00 : Write an Outpatient Referral Letter Record 
.                                               called by: EOCRFR00   
.------------------------------------------------------------------
WRIREF00  PACK      KEY8,OUTBOKNO      * Key for Out. Referral Let. File
          CALL      RAOTRFL1
          COMPARE   ZERO,OVRCD
          GOTO      WRIREF90 IF EQUAL  * Record exists
.
          CALL      SAVREF00           * Save Referral Letter variables 
.
          PACK      OTRLCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLCDAT
          CLOCK     TIME,OTRLCTIM
          MOVE      WBSEUID,OTRLCUID
.
          PACK      KEY8,OTRLOUTN,SP70
          CALL      WROTRFL1
          MOVE      ZERO,EXIT
          GOTO      WRIREF99
.
WRIREF90  MOVE      ONE,EXIT
WRIREF99  RETURN
.------------------------------------------------------------------
.  UPDREF00 : Update an Outpatient Referral Letter Record 
.                                               called by: EOCRFR00   
.------------------------------------------------------------------
UPDREF00  PACK      KEY8,OUTBOKNO    * Key for Out. Referral Let. File
          CALL      RAOTRFL1
          BRANCH    OVRCD,UPDREF90   * Record does not exist
.
          CALL      SAVREF00     * Save Referral Letter variables 
.
          PACK      OTRLUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLUDAT
          CLOCK     TIME,OTRLUTIM
          MOVE      WBSEUID,OTRLUUID
.
          CALL      UPOTRFL1
          GOTO      UPDREF99
.
UPDREF90  MOVE      "Referral Letter record does not exists!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPDREF99  RETURN
.------------------------------------------------------------------
.                        SAVEPS00
.  Save & Write Episode of Care Referral.       called by: EOCRFR00
.------------------------------------------------------------------
SAVEPS00  CALL      CLRRFL00
          MOVE      URNUMBER,ECRFURNO      * U/R Number
          MOVE      EPSOFCAR,ECRFEPNO      * Episode of Care No.
          MOVE      CHOSPNUM,ECRFHOSP      * Hospital Index
          MOVE      OUTBOKNO,ECRFREFN      * Referral Event Number
          MOVE      SP70,ECRFACCN          * Accident Number
          MOVE      OTRFL036,ECRFSTAT      * Status 0=Open, 1=Closed
          MOVE      OTRFL035,ECRFCDAT      * Date Closed (CCYYMMDD)
          MOVE      SP70,ECRFSPAR          * Spare
.
          PACK      KEY13,ECRFURNO,ECRFEPNO,SP70
          CALL      WRECREF1
.
SAVEPS99  RETURN
.
.------------------------------------------------------------------------
. Insert/Update new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.------------------------------------------------------------------------
.
UPVCM000  IF        VSCMTFLG <> 1
            GOTO      UPVCM999
          ENDIF
.
          MOVE      VSCMTTYP,KEY3
          MOVE      OUTBOKNO,KEY8
          CALL      DLVCM000                  * delete visit comments
.
          IF        VSCMTLIN = 0
            GOTO      UPVCM999
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVCM200  MOVE      OUTBOKNO,VSMDVISN        * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      ONE,F6
          MOVE      F6,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE           * Visit date
          MOVE      CTIMEIS,VSMDTIME           * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG      * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVCM400  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVCM990 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      UPVCM990
          ENDIF
.
          GOTO      UPVCM400
.
UPVCM990  CLOSE     COMVISAF,DELETE
.
UPVCM999  RETURN
.
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,KEY8,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     KEY8,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
.-------------------------------------------------------------------
.  LNKSAV00  :  Write the referral Number to the Link File  
.               write to the episode of care link file - eoclnkaf 
.                                                called by: EOCRFR00  
.-------------------------------------------------------------------
LNKSAV00  MOVE      URNUMBER,ECLNURNO  * U/R number
          MOVE      EPSOFCAR,ECLNEPNO  * Episode of Care No.
          MOVE      CHOSPNUM,ECLNHOSP  * Unique Hospital Index
          MOVE      OUTBOKNO,ECLNVISI  * Event no. (Outpatient No.) 
          PACK      ECLNSPAR,SP70      * Spare
          PACK      KEY23,ECLNURNO,ECLNEPNO,ECLNHOSP,ECLNVISI,SP70
          CALL      RAECLNK1
          IF        OVRCD=1
            CALL      WRECLNK1
          ELSE
            CALL      UPECLNK1         
          ENDIF
LNKSAV99  RETURN
.-------------------------------------------------------------------
.   WRTHIS00 - Write to the Outpatient History File
.                                                called by: EOCRFR00
.-------------------------------------------------------------------
WRTHIS00  COMPARE   ONE,PTCNURHA          * Control File Variable(PTCNURHA) - 
          GOTO      WRTHIS99 IF NOT EQUAL * Using RHA Booking System 1=Yes,0=No
.
. ------- write a history record -----------------------
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      WRTHIS05 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      WRTHIS05 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
WRTHIS05  PACK      KEY8,OUTBOKNO  * Position on correct Referral Letter record
          CALL      RDOTRFL1           
          BRANCH    OVRCD,WRTHIS91
.
          PACK      KEY8,CCC,CYY,CMM,CDD,SP70
          REP       " 0",KEY8
          PACK      KEY28,OTRLURNO,OTRLOUTN,KEY8,Z70
          CALL      RSOTHIS1
          CALL      RPOTHIS1
          BRANCH    OVRCD,WRTHIS10
.
          MATCH     OTRLURNO,OTHIURNO
          GOTO      WRTHIS10 IF NOT EQUAL
.
          MATCH     OTRLOUTN,OTHIEVNT
          GOTO      WRTHIS10 IF NOT EQUAL
.
          MATCH     KEY8,OTHIEDAT
          GOTO      WRTHIS10 IF NOT EQUAL
.
          ADD       ONE,OTHIUCNT   * Increment Unique Count
          GOTO      WRTHIS20
.
WRTHIS10  MOVE      OTRLURNO,OTHIURNO
          MOVE      OTRLOUTN,OTHIEVNT
          PACK      OTHIEDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",OTHIEDAT
          MOVE      ONE,OTHIUCNT   * Assign Unique Count to 1
.
WRTHIS20  MOVE      OTRLPRIO,OTHIPRIO
          MOVE      OTRLRANK,OTHIRANK
          PACK      OTHISPAR,SP70
.
          PACK      KEY28,OTHIURNO,OTHIEVNT,OTHIEDAT,OTHIUCNT,SP70
          CALL      RAOTHIS1
          IF        OVRCD=1
            CALL      WROTHIS1
          ELSE          
            CALL      WRTHIS90
          ENDIF
          GOTO      WRTHIS99
.
WRTHIS90  MOVE      "Write to Outpatient History File failed!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTHIS99
.
WRTHIS91  MOVE      "Invalid Letter Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTHIS99
.
WRTHIS99  RETURN
.-------------------------------------------------------------------
. DREOC000 - Delete EOC Referral Record          called by; EOCRFR00    
.-------------------------------------------------------------------
DREOC000  PACK      KEY13,URNUMBER,ECRFEPNO,SP70
          CALL      RAECREF1
          IF        OVRCD=0
            CALL      DEECREF1
          ENDIF
.
DREOC999  RETURN
.----------------------------------------------------------------------
. DELNK000 - Delete the event from EOC link file    called by; EOCRFR00    
.----------------------------------------------------------------------
DELNK000  MOVE      ECRFURNO,ECLNURNO
          MOVE      ECRFEPNO,ECLNEPNO
          MOVE      ECRFHOSP,ECLNHOSP
          MOVE      ECRFREFN,ECLNVISI
          PACK      KEY23,ECLNURNO,ECLNEPNO,ECLNHOSP,ECLNVISI,SP20,SP10
          CALL      RAECLNK1
          IF        OVRCD=0
            CALL      DEECLNK1
          ENDIF
.
DELNK999  RETURN
.----------------------------------------------------------------------
.                             DOTRL000  
.  Delete an Outpatient Referral Letter Record      called by; EOCRFR00     
.----------------------------------------------------------------------
DOTRL000  MATCH     ZEROVISN,ECRFREFN
          GOTO      DOTRL999 IF EQUAL
.
          PACK      KEY8,ECRFREFN,SP70       * Key for Out. Referral Let. File
          CALL      RAOTRFL1
          IF        OVRCD=0
            CALL      DEOTRFL1
          ENDIF
.
DOTRL999  RETURN
.----------------------------------------------------------------------
. DACCD000 : Delete an Accident Detail Record       called by; EOCRFR00     
.----------------------------------------------------------------------
DACCD000  MATCH     SP70,ECRFACCN
          GOTO      DACCD999 IF EQUAL
.
          PACK      KEY20,ECRFACCN,SP70
          CALL      RAECACC1
          IF        OVRCD=0
            CALL      DEECACC1
          ENDIF
.
DACCD999  RETURN
.----------------------------------------------------------------------
. DACFC000 : Delete Accident Flag Change Record     called by; EOCRFR00       
.----------------------------------------------------------------------
DACFC000  MOVE      ECRFREFN,KEY8
          CALL      RDECAFC1                * record on file ?
          BRANCH    OVRCD,DACFC999          * no - finished
.
          MOVE      ECRFREFN,KEY8           * yes
          CALL      DEECAFC1                * delete record
.
DACFC999  RETURN
.-----------------------------------------------------------------
. Episodes of Care Accident Maintenance: Display,Add/Update,Delete
.-----------------------------------------------------------------
EOCACC00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EOCACC30 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Add/Update formaction
          GOTO      EOCACC10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      EOCACC20 IF EQUAL
.
          GOTO      EOCACC93
.
.         ************ ADD/UPDATE FORMACTION ********
.
EOCACC10  CALL      CHKACC00      * Checks mandatory fields
          BRANCH    EXIT,EOCACC99
.
.  If saved Accident no. matches cgi Accident no. continue 
.
          MATCH     SAVACCNO,ECACC001
          IF        !@EQUAL
            PACK      KEY20,ECACC001  * Check if new Accident No. already exists
            CALL      RAECACC1
            IF        OVRCD=0
              GOTO      EOCACC92      * Yes report an error!
            ENDIF
          ENDIF
.
.  Deletes record and rewrites with new or old(displayed) cgi-parameters  
.
          PACK      KEY20,SAVACCNO,SP70  
          CALL      RAECACC1
          IF        OVRCD=0
            CALL      DEECACC1 
          ENDIF
.
          CALL      ACCSAV00    * Moves input variables to file variables
          CALL      WRECACC1    * Writes away the data (Add new record)
          CALL      SETREF00    * Set ECRFACCN(ACC NO.) in EOC Referral File
          MOVE      ECRFREFN,OUTBOKNO  * Set Referral event No. (Outpatient No) 
          CALL      ACCFLG00    * Update Accident Flag Change File 
.
          MATCH     "1",LNKECACC
          IF @EQUAL
            CALL      LNKACC00  * Link EOC if not already
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      EOCACC99
.
.         *********** DELETE FORMACTION *********
.
EOCACC20  PACK      KEY20,ECACC001,SP70
          CALL      RDECACC1
          BRANCH    OVRCD,EOCACC91
.
          PACK      KEY20,ECACC001,SP70
          CALL      DEECACC1         * Deletes the data
.
          PACK      KEY8,OUTBOKNO    * Delete Accident Flag
          CALL      DEECAFC1     
.
.    Reset Accident number in EOC Referral File
.
          CALL      SETREF00    * Set ECRFACCN(ACC NO.) in EOC Referral File
.
          MOVE      ZERO,EXIT
          GOTO      EOCACC99
.
.         ************ DISPLAY FORMACTION ********
.
EOCACC30  PACK      KEY13,URNUMBER,EPSOFCAR,SP70
          CALL      RDECREF1
          BRANCH    OVRCD,EOCACC94
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EOCACC90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     ZEROVISN,ECRFREFN
          IF        !@EQUAL           
            MOVE      ECRFREFN,OUTBOKNO  * Set Referral event No. (Out-pat No) 
          ENDIF
.
          MATCH     SP70,ECRFACCN
          IF        !@EQUAL 
            PACK      KEY20,ECRFACCN,SP70
            CALL      RDECACC1
            IF        OVRCD=1
              CALL      CLRACC00    * Clear all the file variables
              MOVE      SP70,SAVACCNO * Saved Accident No.
            ELSE 
              MOVE      ECACACCN,SAVACCNO * Saved Accident No.
            ENDIF
          ELSE
            CALL      CLRACC00    * Clear all the file variables
            MOVE      SP70,SAVACCNO * Saved Accident No.
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Accident Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EOCACC99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC90  MOVE      "U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC91  MOVE      "Accident does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC92  MOVE      "Accident No. exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC94  MOVE      "Invalid Referral Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EOCACC99
.
EOCACC99  RETURN
.-----------------------------------------------------------
. Initialize's file data : ACC Detail File 
.-----------------------------------------------------------
CLRACC00  MOVE      SP70,ECACACCN   * Accident No. 
          MOVE      ZERO,ECACACCA   * Accident Aproval 
          MOVE      SP70,ECACDAT1   * Date Field 1 (CCYYMMDD)
          MOVE      SP70,ECACTIM1   * Time Field 1 (HH:MM)
          MOVE      SP70,ECACDAT2   * Date Field 2 (CCYYMMDD)
          MOVE      SP70,ECACTIM2   * Time Field 2 (HH:MM)
          MOVE      SP70,ECACDAT3   * Date Field 3 (CCYYMMDD)
          MOVE      SP70,ECACTIM3   * Time Field 3 (HH:MM)
          MOVE      SP70,ECACDAT4   * Date Field 4 (CCYYMMDD)
          MOVE      SP70,ECACTIM4   * Time Field 4 (HH:MM)
          MOVE      SP70,ECACDAT5   * Date Field 5 (CCYYMMDD)
          MOVE      SP70,ECACTIM5   * Time Field 5 (HH:MM)
          MOVE      SP70,ECACDAT6   * Date Field 6 (CCYYMMDD)
          MOVE      SP70,ECACTIM6   * Time Field 6 (HH:MM)
          MOVE      SP70,ECACDOC1   * Doctor Field 1
          MOVE      SP70,ECACDOC2   * Doctor Field 2
          MOVE      SP70,ECACDOC3   * Doctor Field 3
          MOVE      SP70,ECACDOC4   * Doctor Field 4
          MOVE      SP70,ECACDOC5   * Doctor Field 5
          MOVE      SP70,ECACDOC6   * Doctor Field 6
          MOVE      SP70,ECACDIA1   * Diagnosis Field 1
          MOVE      SP70,ECACDIA2   * Diagnosis Field 2
          MOVE      SP70,ECACDIA3   * Diagnosis Field 3
          MOVE      SP70,ECACDIA4   * Diagnosis Field 4
          MOVE      SP70,ECACDIA5   * Diagnosis Field 5
          MOVE      SP70,ECACDIA6   * Diagnosis Field 6
          MOVE      ZERO,ECACYNO1   * 1=Yes, 0=no
          MOVE      ZERO,ECACYNO2   * 1=Yes,0=No
          MOVE      ZERO,ECACYNO3   * 1=Yes,0=No
          MOVE      ZERO,ECACYNO4   * 1=Yes,0=No
          MOVE      ZERO,ECACYNO5   * 1=Yes,0=no
          MOVE      ZERO,ECACYNO6   * 1=Yes,0=No
          MOVE      SP70,ECACFRE1   * Free Format 1
          MOVE      SP70,ECACFRE2   *  Free Format 2
          MOVE      SP70,ECACFRE3   * Free Format 3
          MOVE      SP70,ECACFRE4   * Free Format 4
          MOVE      SP70,ECACFRE5   * Free Format 5
          MOVE      SP70,ECACFRE6   * Free Format 6
          MOVE      SP70,ECACFRE7   * Free Format 7
          MOVE      SP70,ECACFRE8   * Free Format 8
          MOVE      SP70,ECACFRE9   * Free Format 9
          MOVE      SP70,ECACFR10   * Free Format 10
          MOVE      SP70,ECACCOD1   * Coded Field 1 (Cat I1)
          MOVE      SP70,ECACCOD2   * Coded Field 2 (Cat I2)
          MOVE      SP70,ECACCOD3   * Coded Field 3 (Cat I3)
          MOVE      SP70,ECACCOD4   * Coded Field 4 (Cat I4)
          MOVE      SP70,ECACCOD5   * Coded Field 5 (Cat I5)
          MOVE      SP70,ECACCOD6   * Coded Field 6 (Cat I6)
          MOVE      SP70,ECACCOD7   * Coded Field 7 (Cat I7)
          MOVE      SP70,ECACCOD8   * Coded Field 8 (Cat I8)
          MOVE      SP70,ECACCOD9   * Coded Field 9 (Cat I9)
          MOVE      ZERO,ECACNUM1   * Numeric Field 1
          MOVE      ZERO,ECACNUM2   * Numeric Field 2
          MOVE      SP70,ECACDACC   * Date of Accident (CCYYMMDD)
          MOVE      SP70,ECACSPAR   * Spare
.
CLRACC99  RETURN
.-----------------------------------------------------------
. Move cgi-variables file variables : ACC Detail File 
.-----------------------------------------------------------
ACCSAV00  MOVE      ECACC001,ECACACCN   * Accident No. 
.
          COMPARE   ONE,ECACC002
          IF        !@EQUAL
            MOVE      ZERO,ECACACCA
          ELSE
            MOVE      ECACC002,ECACACCA   * Accident Aproval (Insurer Approval 
          ENDIF
.
          MATCH     Z70,ECACC003
          IF        !@EQUAL
            MOVE      ECACC003,ECACDACC   * Date of Accident (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC004
          IF        !@EQUAL
            MOVE      ECACC004,ECACDAT1   * Accident Declined Date (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC005
          IF        !@EQUAL
            MOVE      ECACC005,ECACTIM1   * Time Field 1 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC006
          IF        !@EQUAL
            MOVE      ECACC006,ECACDAT2   * Date Field 2 (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC007
          IF        !@EQUAL
            MOVE      ECACC007,ECACTIM2   * Time Field 2 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC008
          IF        !@EQUAL
            MOVE      ECACC008,ECACDAT3   * Date Field 3 (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC009
          IF        !@EQUAL
            MOVE      ECACC009,ECACTIM3   * Time Field 3 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC010
          IF        !@EQUAL
            MOVE      ECACC010,ECACDAT4   * Date Field 4 (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC011
          IF        !@EQUAL
            MOVE      ECACC011,ECACTIM4   * Time Field 4 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC012
          IF        !@EQUAL
            MOVE      ECACC012,ECACDAT5   * Date Field 5 (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC013
          IF        !@EQUAL
            MOVE      ECACC013,ECACTIM5   * Time Field 5 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC014
          IF        !@EQUAL
            MOVE      ECACC014,ECACDAT6   * Date Field 6 (CCYYMMDD)
          ENDIF
.
          MATCH     Z70,ECACC015
          IF        !@EQUAL
            MOVE      ECACC015,ECACTIM6   * Time Field 6 (HH:MM)
          ENDIF
.
          MATCH     Z70,ECACC016
          IF        !@EQUAL
            MOVE      ECACC016,ECACDOC1   * Doctor Field 1
          ENDIF
.
          MATCH     Z70,ECACC017
          IF        !@EQUAL
            MOVE      ECACC017,ECACDOC2   * Doctor Field 2
          ENDIF
.
          MATCH     Z70,ECACC018
          IF        !@EQUAL
            MOVE      ECACC018,ECACDOC3   * Doctor Field 3
          ENDIF
.
          MATCH     Z70,ECACC019
          IF        !@EQUAL
            MOVE      ECACC019,ECACDOC4   * Doctor Field 4
          ENDIF
.
          MATCH     Z70,ECACC020
          IF        !@EQUAL
            MOVE      ECACC020,ECACDOC5   * Doctor Field 5
          ENDIF
.
          MATCH     Z70,ECACC021
          IF        !@EQUAL
            MOVE      ECACC021,ECACDOC6   * Doctor Field 6
          ENDIF
.
          MATCH     Z70,ECACC022
          IF        !@EQUAL
            MOVE      ECACC022,ECACDIA1   * Diagnosis Field 1
          ENDIF
.
          MATCH     Z70,ECACC023
          IF        !@EQUAL
            MOVE      ECACC023,ECACDIA2   * Diagnosis Field 2
          ENDIF
.
          MATCH     Z70,ECACC024
          IF        !@EQUAL
            MOVE      ECACC024,ECACDIA3   * Diagnosis Field 3
          ENDIF
.
          MATCH     Z70,ECACC025
          IF        !@EQUAL
            MOVE      ECACC025,ECACDIA4   * Diagnosis Field 4
          ENDIF
.
          MATCH     Z70,ECACC026
          IF        !@EQUAL
            MOVE      ECACC026,ECACDIA5   * Diagnosis Field 5
          ENDIF
.
          MATCH     Z70,ECACC027
          IF        !@EQUAL
            MOVE      ECACC027,ECACDIA6   * Diagnosis Field 6
          ENDIF
.
          COMPARE   ONE,ECACC028
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO1
          ELSE
            MOVE      ECACC028,ECACYNO1   * 1=Yes, 0=no  (Work Related)
          ENDIF
.
          COMPARE   ONE,ECACC029
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO2
          ELSE
            MOVE      ECACC029,ECACYNO2   * 1=Yes,0=No
          ENDIF
.
          COMPARE   ONE,ECACC030
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO3
          ELSE
            MOVE      ECACC030,ECACYNO3   * 1=Yes,0=No
          ENDIF
.
          COMPARE   ONE,ECACC031
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO4
          ELSE
            MOVE      ECACC031,ECACYNO4   * 1=Yes,0=No
          ENDIF
.
          COMPARE   ONE,ECACC032
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO5
          ELSE
            MOVE      ECACC032,ECACYNO5   * 1=Yes,0=no
          ENDIF
.
          COMPARE   ONE,ECACC033
          IF        !@EQUAL
            MOVE      ZERO,ECACYNO6
          ELSE
            MOVE      ECACC033,ECACYNO6   * 1=Yes,0=No
          ENDIF
.
.
          MATCH     Z70,ECACC034
          IF        !@EQUAL
            MOVE      ECACC034,ECACFRE1   * Free Format 1 (Accident Description)
          ENDIF
.
          MATCH     Z70,ECACC035
          IF        !@EQUAL
            MOVE      ECACC035,ECACFRE2   * Free Format 2 (Accident Description)
          ENDIF
.
          MATCH     Z70,ECACC036
          IF        !@EQUAL
            MOVE      ECACC036,ECACFRE3   * Free Format 3
          ENDIF
.
          MATCH     Z70,ECACC037
          IF        !@EQUAL
            MOVE      ECACC037,ECACFRE4   * Free Format 4
          ENDIF
.
          MATCH     Z70,ECACC038
          IF        !@EQUAL
            MOVE      ECACC038,ECACFRE5   * Free Format 5
          ENDIF
.
          MATCH     Z70,ECACC039
          IF        !@EQUAL
            MOVE      ECACC039,ECACFRE6   * Free Format 6
          ENDIF
.
          MATCH     Z70,ECACC040
          IF        !@EQUAL
            MOVE      ECACC040,ECACFRE7   * Free Format 7
          ENDIF
.
          MATCH     Z70,ECACC041
          IF        !@EQUAL
            MOVE      ECACC041,ECACFRE8   * Free Format 8
          ENDIF
.
          MATCH     Z70,ECACC042
          IF        !@EQUAL
            MOVE      ECACC042,ECACFRE9   * Free Format 9
          ENDIF
.
          MATCH     Z70,ECACC043
          IF        !@EQUAL
            MOVE      ECACC043,ECACFR10   * Free Format 10
          ENDIF
.
          MATCH     Z70,ECACC044
          IF        !@EQUAL
            MOVE      ECACC044,ECACCOD1   * Coded Field 1 (Cat I1)
          ENDIF
.
          MATCH     Z70,ECACC045
          IF        !@EQUAL
            MOVE      ECACC045,ECACCOD2   * Coded Field 2 (Cat I2)
          ENDIF
.
          MATCH     Z70,ECACC046
          IF        !@EQUAL
            MOVE      ECACC046,ECACCOD3   * Coded Field 3 (Cat I3)
          ENDIF
.
          MATCH     Z70,ECACC047
          IF        !@EQUAL
            MOVE      ECACC047,ECACCOD4   * Coded Field 4 (Cat I4)
          ENDIF
.
          MATCH     Z70,ECACC048
          IF        !@EQUAL
            MOVE      ECACC048,ECACCOD5   * Coded Field 5 (Cat I5)
          ENDIF
.
          MATCH     Z70,ECACC049
          IF        !@EQUAL
            MOVE      ECACC049,ECACCOD6   * Coded Field 6 (Cat I6)
          ENDIF
.
          MATCH     Z70,ECACC050
          IF        !@EQUAL
            MOVE      ECACC050,ECACCOD7   * Coded Field 7 (Cat I7)
          ENDIF
.
          MATCH     Z70,ECACC051
          IF        !@EQUAL
            MOVE      ECACC051,ECACCOD8   * Coded Field 8 (Cat I8)
          ENDIF
.
          MATCH     Z70,ECACC052
          IF        !@EQUAL
            MOVE      ECACC052,ECACCOD9   * Coded Field 9 (Cat I9)
          ENDIF
.
          MATCH     Z70,ECACC053
          IF        !@EQUAL
            MOVE      ECACC053,ECACNUM1   * Numeric Field 1
          ENDIF
.
          MATCH     Z70,ECACC054
          IF        !@EQUAL
            MOVE      ECACC054,ECACNUM2   * Numeric Field 2
          ENDIF
.
          MOVE      SP70,ECACSPAR   * Spare
.
ACCSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields (EOC Accident Maintenance)
.------------------------------------------------------------
CHKACC00  CALL      IBACLOCK
          RESET     ECACC001
          MATCH     SP70,ECACC001
          GOTO      CHKACC90 IF EQUAL
.
          RESET     ECACC003
          MATCH     SP70,ECACC003
          GOTO      CHKACC92 IF EQUAL
          PACK      KEY8,CCC,CYY,CMM,CDD,SP70
          REP       " 0",KEY8
          MATCH     ECACC003,KEY8
          GOTO      CHKACC98 IF EQUAL
          GOTO      CHKACC93 IF LESS
.
          GOTO      CHKACC98
.
CHKACC90  MOVE      "Accident Number is mandatory",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKACC99
.
CHKACC92  MOVE      "Accident Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKACC99
.
CHKACC93  MOVE      "Accident Date cannot be in the future!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKACC99
..
CHKACC98  MOVE      ZERO,EXIT
CHKACC99  RETURN
.------------------------------------------------------------
. Link ACC             
.------------------------------------------------------------
LNKACC00  MATCH     SP70,ADMISSNO
          GOTO      LNKACC90 IF EQUAL
.
          MOVE      URNUMBER,ECLNURNO
          MOVE      EPSOFCAR,ECLNEPNO 
          MOVE      CHOSPNUM,ECLNHOSP
          MOVE      ADMISSNO,ECLNVISI
          PACK      KEY10,CHOSPNUM,ADMISSNO,SP70
          CALL      RAECLNK2 
          IF        OVRCD=1 
            CALL      WRECLNK2
          ENDIF 
.
          GOTO      LNKCUR99
.
LNKACC90  MOVE      "ERROR: Patient Event Not Specified",WEBTITLE
          CALL      WEBERR00
.          
LNKACC99  RETURN
.-------------------------------------------------------------
. SETREF00 - Set ECRFACCN(ACC NO.) In EOC Referral File 
.                                          called by: EOCACC00 
.-------------------------------------------------------------
SETREF00  PACK      KEY13,URNUMBER,EPSOFCAR,SP70
          CALL      RDECREF1
          BRANCH    OVRCD,SETREF90
.
          MATCH     "U",UPDTTYPE
          IF        @EQUAL  
            MOVE      ECACACCN,ECRFACCN     * Update Formaction
          ELSE
            MOVE      SP70,ECRFACCN         * Delete Formaction
          ENDIF
. 
          CALL      UPECREF1
          GOTO      SETREF99             
.
SETREF90  MOVE      "Cannot save Accident No. in Referral File!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETREF99
.
SETREF99  RETURN
.-------------------------------------------------------------
. ACCFLG00 - Update Accident Flag Change File (eocafcaf) 
.                                          called by: EOCACC00 
.-------------------------------------------------------------
ACCFLG00  PACK      KEY8,OUTBOKNO
          CALL      RDECAFC1
          IF        OVRCD=0
            PACK      ECAFDATE,CCC,CYY,CMM,CDD
            REP       " 0",ECAFDATE
            MOVE      ZERO,ECAFSENT
            MOVE      SP70,ECAFSPAR
            CALL      UPECAFC1   * Update Flag File (Record already exists)
          ELSE
            MOVE      OUTBOKNO,KEY8
            PACK      ECAFDATE,CCC,CYY,CMM,CDD
            REP       " 0",ECAFDATE
            MOVE      ZERO,ECAFSENT
            MOVE      SP70,ECAFSPAR
            CALL      WRECAFC1   * Write to Flag File (Record does not exists)
          ENDIF
.
ACCFLG99  RETURN  
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
RSCRPT00  CALL      XMLHED00
          BRANCH    EXIT,RSCRPT99
.
          BRANCH    UPDATETY,RSCRPT10
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      RSCRPT90
.
RSCRPT10  CALL      VLDACC00        * validate ACC number
          GOTO      RSCRPT90
.
RSCRPT90  CALL      XMLEND00
.
RSCRPT99  RETURN
.------------------------------------------------------------
. Check if ACC already exists in eocaccaf
.   RETURN   0 - ACC does not exist
.            1 - ACC exists in eocaccaf (error)
.------------------------------------------------------------
VLDACC00  MATCH     SAVACCNO,ECACC001
          IF        !@EQUAL
            PACK      KEY20,ECACC001  * Check if new Accident No. already exists
            CALL      RAECACC1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                        ONE:
                        "</RETURN_VALUE>"
              GOTO      VLDACC99            * Yes report an error!
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
VLDACC99  RETURN
.------------------------------------------------------------
. Check if visit has ACC already attached 
.------------------------------------------------------------
EXSACC00  MOVE      ZERO,ECLNEPNO
.
          COMPARE   ONE,REPORTNO
          GOTO      EXSACC99 IF NOT EQUAL 
          MATCH     "006",TEMPLATE
          GOTO      EXSACC99 IF NOT EQUAL 
.
          PACK      KEY10,CHOSPNUM,ADMISSNO,SP70
          CALL      RDECLNK2
          IF OVRCD=0
            MOVE    ECLNEPNO,EPSOFCAR
          ELSE
            GOTO    EXSACC99
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",EPSOFCAR
          CLEAR    REDIRECT
          APPEND    "eocweb01.pbl?&reportno=03&template=002",REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&epsofcar=",REDIRECT
          APPEND    EPSOFCAR,REDIRECT
          APPEND    "&returncd=",REDIRECT
          APPEND    RETURNCD,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",EPSOFCAR
          MOVE      SIX,NEXTPAGE

EXSACC99  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30
          GOTO      PROFLD99
.
.  Report 1: Episode of Care Display   
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD12  CALL      EREF0000                * Epsiode of Care Referral Details
          GOTO      PROFLD99
.
PROFLD20                         * Not Used....
          GOTO      PROFLD99
.
.
.  Report 3: Episode of Care Accidents 
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD32  CALL      EREF0000                * Epsiode of Care Referral Details
          GOTO      PROFLD99
.
PROFLD33  CALL      EACC0000                * Episode of Care Accident Details
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
.  Epsiode of Care Referral Details
.------------------------------------------------------------
EREF0000  BRANCH    FLDITMNO,EREF0100,EREF0200,EREF0300,EREF0400,EREF0500:
                             EREF0600,EREF0700,EREF0800,EREF0900,EREF1000:  
                             EREF1100,EREF1200,EREF1300,EREF1400,EREF1500:  
                             EREF1600,EREF1700,EREF1800,EREF1900,EREF2000:  
                             EREF2100,EREF2200,EREF2300,EREF2400,EREF2500:  
                             EREF2600,EREF2700,EREF2800,EREF2900,EREF3000:  
                             EREF3100,EREF3200,EREF3300,EREF3400,EREF3500:  
                             EREF3600,EREF3700,EREF3800,EREF3900,EREF4000:  
                             EREF4100,EREF4200,EREF4300,EREF4400,EREF4500:
                             EREF4600,EREF4700
.
          GOTO      EREF9999
.
EREF0100  MATCH     SP70,OTRLDATE
          GOTO      EREF9999 IF EQUAL
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;  * Date of Letter
          GOTO      EREF9999
.
EREF0200  PACK      GENPCODE,OTRLRDOC,SP70   * Referaing HCP 
          CALL      HCPDET00            * Get HCP Details (PMSHCPTM)
          GOTO      EREF9999
.
EREF0300  UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          BRANCH    F1,EREF0301
          PACK      KEY6,OTRLSITE,SP70  
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,EREF9999
          WRITE     HTMLFILE;OSTDESC;        * Descprition 
          GOTO      EREF9999
EREF0301  WRITE     HTMLFILE;OTRLSITE;       * Code 
          GOTO      EREF9999
.
.
EREF0400  MOVE      OTRLCONS,DOCTCODE   * Consultant 
          CALL      DOCDET00            * Get Doctor Details (PATDOCTM)
          GOTO      EREF9999
.
EREF0500  MOVE      "A ",CATEGORY       * Department
          MOVE      OTRLDEPT,CODE
          CALL      CODITM00
          GOTO      EREF9999
.
EREF0600  MATCH     SP70,OTRLDIAG
          GOTO      EREF9999 IF EQUAL 
          WRITE     HTMLFILE;OTRLDIAG;  * Diagnosis 
          GOTO      EREF9999
.
EREF0700  MOVE      "PR",CATEGORY       * Priority 
          MOVE      OTRLPRIO,CODE
          CALL      CODITM00 
          GOTO      EREF9999
.
EREF0800  MOVE      "L1",CATEGORY       * User Defined 1
          MOVE      OTRLUSD1,CODE 
          CALL      CODITM00 
          GOTO      EREF9999
.
EREF0900  MOVE      "L2",CATEGORY       * User Defined 2
          MOVE      OTRLUSD2,CODE
          CALL      CODITM00
          GOTO      EREF9999 
.
EREF1000  MOVE      "L3",CATEGORY       * User Defined 3
          MOVE      OTRLUSD3,CODE
          CALL      CODITM00
          GOTO      EREF9999 
.
EREF1100  MOVE      "L4",CATEGORY       * User Defined 4
          MOVE      OTRLUSD4,CODE
          CALL      CODITM00
          GOTO      EREF9999 
.
EREF1200  CALL      VISCMA00            * Output Text Area Comment
          GOTO      EREF9999
.
EREF1300  PACK      GENPCODE,OTRLRFGP,SP70   * Referal HCP 
          CALL      HCPDET00            * Get HCP Details (PMSHCPTM)
          GOTO      EREF9999
.
EREF1400  MATCH     SP70,OTRLGPPC 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLGPPC;  * HCP Practice Code 
          GOTO      EREF9999            * Note (PMSHCGTM needs to be implemeted)
.
EREF1500  MATCH     SP70,OTRLGPPT 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLGPPT;  * GP Practice Count 
          GOTO      EREF9999
.
EREF1600  MATCH     SP70,OTRLRQST 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLRQST;  * Request Number 
          GOTO      EREF9999
.
EREF1700  MATCH     SP70,OTRLCDTE
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCDTE;  * Request for App. Cancelation Date 
          GOTO      EREF9999
.
EREF1800  MOVE      "RQ",CATEGORY
          MOVE      OTRLREAS,CODE       * Reason for Request
          CALL      CODITM00
          GOTO      EREF9999
.
EREF1900  MOVE      "OF",CATEGORY       * Specialty Function Code
          MOVE      OTRLSPFC,CODE 
          CALL      CODITM00
          GOTO      EREF9999
.
EREF2000  MATCH     SP70,OTRLCAD1
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD1;  * Correspondance Address Line 1 
          GOTO      EREF9999
.
EREF2100  MATCH     SP70,OTRLCAD2
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD2;  * Correspondance Address Line 2 
          GOTO      EREF9999
.
EREF2200  MATCH     SP70,OTRLCAD3
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD3;  * Correspondance Address Line 3 
          GOTO      EREF9999
.
EREF2300  MATCH     SP70,OTRLCAD4
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD4;  * Correspondance Address Line 4 
          GOTO      EREF9999
.
EREF2400  MATCH     SP70,OTRLCPC 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCPC;   * Correspondance Post Code
          GOTO      EREF9999
.
EREF2500  MATCH     SP70,OTRLECRN
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLECRN;  * ECR Approval Number 
          GOTO      EREF9999
.
EREF2600  MATCH     SP70,OTRLGPFH
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLGPFH;  * GPFH Approval Number 
          GOTO      EREF9999
.
.
EREF2700  UNPACK    DIM127,D1,KEY1,DIM127    * Clinic Type of Referral
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,EREF2701
          PACK      KEY12,WBSESIT,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
          BRANCH    OVRCD,EREF9999
          WRITE     HTMLFILE;OCTDESC;        * Descprition
          GOTO      EREF9999
EREF2701  WRITE     HTMLFILE;OTRLCTYP;       * Code
          GOTO      EREF9999 
.
.
EREF2800  MOVE      "S ",CATEGORY   * Source of Referral
          MOVE      OTRLSRCE,CODE
          CALL      CODITM00
          GOTO      EREF9999
.
EREF2900  PACK      GENPCODE,OTRLRHCP,SP70   * Responsible HCP
          CALL      HCPDET00            * Get Doctor Details
          GOTO      EREF9999
.
EREF3000  MATCH     SP70,OTRLDREC 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLDREC;  * Date of Referral Recieved 
          GOTO      EREF9999
.
EREF3100  MATCH     SP70,OTRLDPRI 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLDPRI;  * Date of Priority 
          GOTO      EREF9999
.
EREF3200  MOVE      "HP",CATEGORY       * Expected Purchaser 
          MOVE      OTRLPURC,CODE
          CALL      CODITM00
          GOTO      EREF9999
.
EREF3300  MATCH     SP70,OTRLRANK
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;OTRLRANK;  * Patient Rank  
          GOTO      EREF9999
.
.
EREF3400  UNPACK    DIM127,D1,KEY1,DIM127  * Referral Type 0=Outpatient 1=Other
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,EREF3401
          IF        OTRLTREF=0
            MOVE      "Outpatient",KEY10
          ELSE
            MOVE      "Other",KEY10
          ENDIF
          WRITE     HTMLFILE;KEY10;     * Desciption  
EREF3401  WRITE     HTMLFILE;OTRLTREF;  * Code 
          GOTO      EREF9999
.
.
EREF3500  MATCH     SP70,ECRFCDAT 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;ECRFCDAT;  * Date Closed (EOCREFFD) 
          GOTO      EREF9999
.
EREF3600  COMPARE   ZERO,ECRFSTAT 
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;ECRFSTAT;  * Status 0=open 1=closed (EOCREFFD) 
          GOTO      EREF9999
.
EREF3700  MATCH     SP70,ECRFACCN
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;ECRFACCN;  * ACC Number (EOCREFFD) 
          GOTO      EREF9999
.
EREF3800  CALL      LNKSER00            * Link to another Program 
          GOTO      EREF9999
.
EREF3900  
          GOTO      EREF9999
.
EREF4000  CALL      TABEP000            * Table of Episodes 
          GOTO      EREF9999
.
EREF4100  UNPACK    DIM127,D1,KEY1,DIM127 * Table Type 0=Linking 1=Enquiries
          MOVE      ZERO,LTABTYPE
          MOVE      KEY1,LTABTYPE
          PROC      LINKDMUL            * Procedure Call to Display
          GOTO      EREF9999            * Table of Linked Events             
.
EREF4200  PROC      UNLNKMUL            * Procedure call to display 
          GOTO      EREF9999            * Table of unlinked Events 
.
EREF4300  MATCH     SP70,EPSOFCAR
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;EPSOFCAR;  * Episode of Care ID 
          GOTO      EREF9999
.
EREF4400  WRITE     HTMLFILE;RETURNCD;  * return program
          GOTO      EREF9999
.
EREF4500  WRITE     HTMLFILE;CHOSPNUM;
          GOTO      EREF9999
.
EREF4600  MATCH     SP70,DECRFREF
          GOTO      EREF9999 IF EQUAL
          WRITE     HTMLFILE;DECRFREF;  * Referral Event Number
          GOTO      EREF9999
.
EREF4700  CALL      VICMNT00
          GOTO      EREF9999
.
EREF9999  RETURN
.------------------------------------------------------------
. Output Episode of Care Comment Text Area
.------------------------------------------------------------
VISCMA00  PACK      KEY20,OTRLOUTN,VSCMTTYP,SP70
          CALL      RSVSMTX1
VISCMA10  CALL      RKVSMTX1
          BRANCH    OVRCD,VISCMA99
.
          MATCH     OTRLOUTN,VSMTVISN
          GOTO      VISCMA99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMTTYPE
          GOTO      VISCMA99 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,70
.
          GOTO      VISCMA10
.
VISCMA99  RETURN
.
.-----------------------------------------------------------------------
. Retrieve the last number of visit comment details
.-----------------------------------------------------------------------
VICMNT00  MOVE      SP70,KEY3
          UNPACK    DIM127,DIM1,KEY3,DIM127
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      5,VSCMNOFS
          ELSE
            MOVE      KEY3,VSCMNOFS
          ENDIF
.
          MOVE      ZERO,F3
          PACK      KEY17,OTRLOUTN,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
VICMNT10  CALL      RPVSMDT1
          BRANCH    OVRCD,VICMNT99
.
          IF        F3 = VSCMNOFS
            GOTO      VICMNT99
          ENDIF
.
          MATCH     OTRLOUTN,VSMDVISN
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VICMNT10 IF EQUAL
.
. Retrieve comment header
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     SP70,VSCMDATE
            GOTO     VICMNT20
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VSCMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VICMNT20  PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSENAM,VSCMUSRN
          ELSE
            MOVE      VSMDUSER,VSCMUSRN
          ENDIF
          STRIP     VSCMUSRN
.
VICMNT30  PACK      VSCMLINE,VSCMDATE,SP1,VSMDTIME,SP1,VSCMUSRN,SP1,VSMDOCCG
          WRITE     HTMLFILE;VSCMLINE
          ADD       ONE,F3
.
          CALL      VICMTX00
.
          GOTO      VICMNT10
.
VICMNT99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
VICMTX00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VICMTX20  CALL      RKVSMTX1
          BRANCH    OVRCD,VICMTX99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VICMTX99 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,70
.
          GOTO      VICMTX20
.
VICMTX99  RETURN
.
.-----------------------------------------------------------
. Link to Another Program
.-----------------------------------------------------------
LNKSER00  UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",EPSOFCAR
.
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&epsofcar=",EPSOFCAR;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO 
          REP       "+ ",EPSOFCAR 
.
LNKSER99  RETURN
.------------------------------------------------------------
.  Table of Episodes for Patient U/R 
.------------------------------------------------------------
TABEP000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY13,URNUMBER,SP70   
          CALL      RSECREF1   * Episode of Care Referral File
TABEP010  CALL      RKECREF1
          BRANCH    OVRCD,TABEP999
          MATCH     URNUMBER,ECRFURNO
          GOTO      TABEP999 IF NOT EQUAL
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      TABEP020 IF EQUAL
          MOVE      ECRFHOSP,HOSPCNT
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD      XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          IF        HOSPCNT <> ZERO
            MATCH     SP30,XXDPATH
            GOTO      TABEP010 IF EQUAL       * no DPATH for hospital
          ENDIF
          CALL      OOTRF000
.
TABEP020  MATCH     ZEROVISN,ECRFREFN
          GOTO      TABEP030 IF EQUAL
.
          PACK      KEY8,ECRFREFN
          CALL      RDOTRFL1   * New Referral Letter File
          IF        OVRCD=1
            MOVE      "Missing outrf1af record",PURCDESC
            GOTO      TABEP040
          ENDIF
.
          MOVE      OTRLPURC,PURCDESC
          MATCH     SP3,OTRLPURC
          IF        !@EQUAL
            MOVE      "HP",KEY2
            PACK      KEY5,KEY2,OTRLPURC
            CALL      RDCODE1
            IF        OVRCD=0
               MOVE      TDESC,PURCDESC
            ENDIF
          ENDIF
.
          MOVE      OTRLRHCP,DOCFNAME
          MOVE      OTRLRHCP,KEY10
          CALL      RDPMHCP1
          IF        OVRCD=0
.           CALL      DOCSNM00
            MOVE      PMHCTITL,FMTTITLE        * I CAR 13038
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000              * end I CAR 13038
          ENDIF
.
          MATCH     SP70,ECRFACCN
          IF        @EQUAL
            MOVE      "&nbsp;",KEY20
          ELSE   
            MOVE      ECRFACCN,KEY20
          ENDIF           
          GOTO      TABEP040
.
TABEP030  PACK      KEY20,ECRFACCN,SP20
          CALL      RDECACC1
          BRANCH    OVRCD,TABEP040
.
          MOVE      ECACDACC,OTRLDATE
          MOVE      SP70,OTRLDIAG
          MOVE      SP70,DOCFNAME
          MOVE      SP70,PURCDESC
.
TABEP040  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",DECRFEPN
.
          WRITE     HTMLFILE;"t.addRow(#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&returncd=",RETURNCD:
                             "&epsofcar=",DECRFEPN,"#",#"":
                             OTRLDATE,"#",#"":
                             OTRLDIAG,"#",#"":
                             DOCFNAME,"#",#"":
                             PURCDESC,"#",#"":
                             KEY20,"#",#"":
                             "eocweb01.pbl":
                             "?reportno=02":
                             "&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&epsofcar=",DECRFEPN:
                             "&updttype=C","#",#"":
                             ECRFCDAT,"#")"
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",DECRFEPN
.
          GOTO      TABEP010
.
TABEP999  RETURN
.------------------------------------------------------------
. Episode of Care Accident Details
.------------------------------------------------------------
EACC0000  BRANCH    FLDITMNO,EACC0100,EACC0200,EACC0300,EACC0400,EACC0500:
                             EACC0600,EACC0700,EACC0800,EACC0900,EACC1000:  
                             EACC1100,EACC1200,EACC1300,EACC1400,EACC1500:  
                             EACC1600,EACC1700,EACC1800,EACC1900,EACC2000:  
                             EACC2100,EACC2200,EACC2300,EACC2400,EACC2500:  
                             EACC2600,EACC2700,EACC2800,EACC2900,EACC3000:  
                             EACC3100,EACC3200,EACC3300,EACC3400,EACC3500:  
                             EACC3600,EACC3700,EACC3800,EACC3900,EACC4000:  
                             EACC4100,EACC4200,EACC4300,EACC4400,EACC4500:  
                             EACC4600,EACC4700,EACC4800,EACC4900,EACC5000:  
                             EACC5100,EACC5200,EACC5300,EACC5400
.
          GOTO      EACC9999
.
EACC0100  MATCH     SP70,ECACACCN 
          GOTO      EACC9999 IF EQUAL 
          WRITE     HTMLFILE;ECACACCN;     * ACC Number  
          GOTO      EACC9999
.
EACC0200  COMPARE   ZERO,ECACACCA
          GOTO      EACC9999 IF EQUAL 
          WRITE     HTMLFILE;ECACACCA;     * ACC Approval 
          GOTO      EACC9999
.
EACC0300  MATCH     SP70,ECACDACC
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDACC,CCENT,CYEAR,CMON,CDAY  * Date of Accident 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC0400  MATCH     SP70,ECACDAT1
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT1,CCENT,CYEAR,CMON,CDAY  * Date Field 1 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC0500  MATCH     SP70,ECACTIM1
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM1;  * Time Field 1   
          GOTO      EACC9999
.
EACC0600  MATCH     SP70,ECACDAT2 
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT2,CCENT,CYEAR,CMON,CDAY  * Date Field 2 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC0700  MATCH     SP70,ECACTIM2
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM2;  * Time Field 2 
          GOTO      EACC9999
.
EACC0800  MATCH     SP70,ECACDAT3 
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT3,CCENT,CYEAR,CMON,CDAY  * Date Field 3 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC0900  MATCH     SP70,ECACTIM3
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM3;  * Time Field 3 
          GOTO      EACC9999
.
EACC1000  MATCH     SP70,ECACDAT4 
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT4,CCENT,CYEAR,CMON,CDAY  * Date Field 4 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC1100  MATCH     SP70,ECACTIM4
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM4;  * Time Field 4 
          GOTO      EACC9999
.
EACC1200  MATCH     SP70,ECACDAT5 
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT5,CCENT,CYEAR,CMON,CDAY  * Date Field 5 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC1300  MATCH     SP70,ECACTIM5
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM5;  * Time Field 5 
          GOTO      EACC9999
.
EACC1400  MATCH     SP70,ECACDAT6 
          GOTO      EACC9999 IF EQUAL
          UNPACK    ECACDAT6,CCENT,CYEAR,CMON,CDAY  * Date Field 6 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;KEY11;
          GOTO      EACC9999
.
EACC1500  MATCH     SP70,ECACTIM6
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACTIM6;  * Time Field 6 
          GOTO      EACC9999
.
EACC1600  MOVE      ECACDOC1,DOCTCODE   * Doctor Field 1
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC1700  MOVE      ECACDOC2,DOCTCODE   * Doctor Field 2
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC1800  MOVE      ECACDOC3,DOCTCODE   * Doctor Field 3
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC1900  MOVE      ECACDOC4,DOCTCODE   * Doctor Field 4
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC2000  MOVE      ECACDOC5,DOCTCODE   * Doctor Field 5
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC2100  MOVE      ECACDOC6,DOCTCODE   * Doctor Field 6
          CALL      DOCDET00            * Get Doctor Details
          GOTO      EACC9999
.
EACC2200  MATCH     SP70,ECACDIA1
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA1;  * Diagnosis Field 1
          GOTO      EACC9999
.
EACC2300  MATCH     SP70,ECACDIA2
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA2;  * Diagnosis Field 2
          GOTO      EACC9999
.
EACC2400  MATCH     SP70,ECACDIA3
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA3;  * Diagnosis Field 3
          GOTO      EACC9999
.
EACC2500  MATCH     SP70,ECACDIA4
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA4;  * Diagnosis Field 4
          GOTO      EACC9999
.
EACC2600  MATCH     SP70,ECACDIA5
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA5;  * Diagnosis Field 5
          GOTO      EACC9999
.
EACC2700  MATCH     SP70,ECACDIA6
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACDIA6;  * Diagnosis Field 6
          GOTO      EACC9999
.
EACC2800  COMPARE   ZERO,ECACYNO1
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO1;  * Y/N Field 1  1=Yes 0=No 
          GOTO      EACC9999
.
EACC2900  COMPARE   ZERO,ECACYNO2
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO2;  * Y/N Field 2  1=Yes 0=No 
          GOTO      EACC9999
.
EACC3000  COMPARE   ZERO,ECACYNO3
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO3;  * Y/N Field 3  1=Yes 0=No 
          GOTO      EACC9999
.
EACC3100  COMPARE   ZERO,ECACYNO4
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO4;  * Y/N Field 4  1=Yes 0=No 
          GOTO      EACC9999
.
EACC3200  COMPARE   ZERO,ECACYNO5
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO5;  * Y/N Field 5  1=Yes 0=No 
          GOTO      EACC9999
.
EACC3300  COMPARE   ZERO,ECACYNO6
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACYNO6;  * Y/N Field 6  1=Yes 0=No 
          GOTO      EACC9999
.
EACC3400  MATCH     SP70,ECACFRE1
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE1;  * Free Format 1            
          GOTO      EACC9999
.
EACC3500  MATCH     SP70,ECACFRE2
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE2;  * Free Format 2            
          GOTO      EACC9999
.
EACC3600  MATCH     SP70,ECACFRE3
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE3;  * Free Format 3            
          GOTO      EACC9999
.
EACC3700  MATCH     SP70,ECACFRE4
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE4;  * Free Format 4            
          GOTO      EACC9999
.
EACC3800  MATCH     SP70,ECACFRE5
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE5;  * Free Format 5            
          GOTO      EACC9999
.
EACC3900  MATCH     SP70,ECACFRE6
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE6;  * Free Format 6            
          GOTO      EACC9999
.
EACC4000  MATCH     SP70,ECACFRE7
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE7;  * Free Format 7            
          GOTO      EACC9999
.
EACC4100  MATCH     SP70,ECACFRE8
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE8;  * Free Format 8            
          GOTO      EACC9999
.
EACC4200  MATCH     SP70,ECACFRE9
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFRE9;  * Free Format 9            
          GOTO      EACC9999
.
EACC4300  MATCH     SP70,ECACFR10
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACFR10;  * Free Format 10           
          GOTO      EACC9999
.
EACC4400  MOVE      "I1",CATEGORY       * Coded Field 1
          MOVE      ECACCOD1,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC4500  MOVE      "I2",CATEGORY       * Coded Field 2
          MOVE      ECACCOD2,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC4600  MOVE      "I3",CATEGORY       * Coded Field 3
          MOVE      ECACCOD3,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC4700  MOVE      "I4",CATEGORY       * Coded Field 4
          MOVE      ECACCOD4,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC4800  MOVE      "I5",CATEGORY       * Coded Field 5
          MOVE      ECACCOD5,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC4900  MOVE      "I6",CATEGORY       * Coded Field 6
          MOVE      ECACCOD6,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC5000  MOVE      "I7",CATEGORY       * Coded Field 7
          MOVE      ECACCOD7,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC5100  MOVE      "I8",CATEGORY       * Coded Field 8
          MOVE      ECACCOD8,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC5200  MOVE      "I9",CATEGORY       * Coded Field 9
          MOVE      ECACCOD9,CODE
          CALL      CODITM00
          GOTO      EACC9999 
.
EACC5300  COMPARE   ZERO,ECACNUM1       * Numeric Field 1
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACNUM1;
          GOTO      EACC9999
.
EACC5400  COMPARE   ZERO,ECACNUM2       * Numeric Field 2
          GOTO      EACC9999 IF EQUAL
          WRITE     HTMLFILE;ECACNUM2;
          GOTO      EACC9999
.
EACC9999  RETURN
.*********************************************************************
.         open the required file
.*********************************************************************
OTRF0000  IF        FILENUM = 40
            CLOSE     OUTSITA1
            OPEN      OUTSITA1,PATH
          ENDIF
          IF        FILENUM = 61
            CLOSE     OUTRF1A1
            OPEN      OUTRF1A1,PATH
          ENDIF
          IF        FILENUM = 65
            CLOSE     OUTRF1A2
            OPEN      OUTRF1A2,PATH
          ENDIF
.
OTRF9999  RETURN
.*********************************************************************
.         open the outpatient referral file
.*********************************************************************
OOTRF000  MOVE      "outrf1af",OPFILE
          MOVE      SIXTY1,FILENUM
          CALL      OMDFN000
          MOVE      SIXTY5,FILENUM
          CALL      OMDFN000
OOTRF999  RETURN
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       GENANVIS
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC   * Booking File
          INC       BOKDIAIO/INC   * Booking Diagnosis File
          INC       EOCREFIO/INC   * Episode of Care - Referral File
          INC       EOCACCIO/INC   * Episode of Care - Accident Detail File
          INC       EOCAFCIO/INC   * EOC - Accident Flag Change File 
          INC       EOCLNKIO/INC   * Episode of Care - Link File           
          INC       OUTRF1IO/INC   * New Referral Letter File
          INC       OUTDIAIO/INC   * Outpatient Diagnosis File
          INC       OUTSITIO/INC   * Outpatients - Site Codes File
          INC       OUTCTYIO/INC   * Outpatients - Clinic Type File 
          INC       OUTHISIO/INC   * Outpatients History File
          INC       OUTPREIO/INC   * Out - Pre-attendance Booking Details File
          INC       OUTBOAIO/INC   * Clinic Session Booking File A
          INC       PATALRIO/INC   * Codes File
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATFN1IO/INC   * Health Fund File
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC   * Insurance File
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSHCPIO/INC   * National HCP File
          INC       PMSHCGIO/INC   * National HCP Practice File
          INC       PATMA1IO/INC   * New Patient Master File 
          INC       PMSPX2IO/INC
          INC       PATHOSIO/INC   * Hospital File
          INC       PATMI1IO/INC   * New Patient Admission File 
          INC       PATVISIO/INC   * Patient Visits File
          INC       PMSVX1IO/INC   * Patient Visits xtn  File
          INC       WATTR1IO/INC   * Waiting List File
          INC       WEBHDPIO/INC   * Hospital Data File Locations
          INC       PATWR1IO/INC   * Patients Visits File
          INC       PATPR1IO/INC   * Patients Visits File
          INC       RESLNKIO/INC   * Patients Visits File
          INC       MRTMASIO/INC   * Patients Visits File
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CALCAGE
          INC       CLOUTRFL    * Clear Referral Letter File Variables
          INC       CHKOCREF  * Checks if Referral is an External Referral (EOC)
          INC       NAMSTRCD
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATDPATH       * get all the DPATH's
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       LINKDMUL       * Table of Linked Events
          INC       UNLNKMUL       * Table of Unlinked Events
          INC       TFILENAM
.------------------------------------------------------------
. Procedure to get Referral Defaults from Outpatient 
.------------------------------------------------------------
          DEFPROC  OUTDEF00   
.
          INC      OUTPREFD/INC
          INC      OUTBOAFD/INC
          INC      OUTBB1FD/INC
          INC      OUTBOCFD/INC
.
KEYBOA    DIM      28
.
          COMPARE  ZERO,PVITYPE
          GOTO     OUTDEF50 IF EQUAL
.
          PACK     KEY6,PVISITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDEF90
.
          CALL     OPBOK000
          BRANCH   EXIT,OUTDEF90
.
          PACK     KEYBOA,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL     RDSBOKA1
OUTDEF10  CALL     RDKBOKA1
          BRANCH   OVRCD,OUTDEF90
          PACK     KEYBOA,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH    KEY20,KEYBOA
          GOTO     OUTDEF90 IF NOT EQUAL
          MATCH    OBAOUTNO,PVIBILL         * Set up billing number
          GOTO     OUTDEF10 IF NOT EQUAL
          GOTO     OUTDEF80
. 
OUTDEF50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     OUTPREA1,"outpreaf"   * Pre Attendance File
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDEF90
          MOVE     ADMISSNO,KEY8
          CALL     RDPREA1               * Check for Pre-Attendance
          BRANCH   OVRCD,OUTDEF90
.
          PACK     KEY6,OPRSITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDEF90
.
          PACK     KEYBOA,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
. 
          CALL     OPBOK000
          BRANCH   EXIT,OUTDEF90
.
          MOVE     KEYBOA,KEY28
          CALL     RDBOKA1
          BRANCH   OVRCD,OUTDEF90
.
OUTDEF80  MOVE     ADMISSNO,KEY8
          CALL     RDOTBOC1
          IF       OVRCD=1
            MOVE     SP70,OTBCRDAT
          ENDIF
          MOVE     ADMISSNO,KEY8
          CALL     RDBOKB1
          MOVE     OTBCRDAT,OTRLDATE
          MOVE     OBACLASS,OTRLDEPT
          MOVE     OBAPRTY,OTRLPRIO
          MOVE     OBASRCR,OTRLSRCE
          MOVE     OTCNRQDF,OTRLREAS
          CALL     VSCMNT00
          MOVE     ZERO,EXIT
          GOTO     OUTDEF99
OUTDEF90  MOVE     ONE,EXIT
          GOTO     OUTDEF99
.
OPBOK000  PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OPBOK900
.
          PACK     KEY8,OSTFILE,FILBB1A1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBB1A1,KEY8     
          TRAPCLR  IO
          BRANCH   OVRCD,OPBOK900
.
          PACK     KEY8,OSTFILE,FILBOKC1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKC1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OPBOK900
          MOVE     ZERO,EXIT
          GOTO     OPBOK999
.
OPBOK900  MOVE     ONE,EXIT
OPBOK999  RETURN
.
          INC      OUTPREIO/INC
          INC      OUTBOAIO/INC
          INC      OUTBB1IO/INC
          INC      OUTBOCIO/INC
          INC      IBAOVRIO/INC
.
OUTDEF99  ENDPROC
.----------------------------------------------------------------------
. Retrieve the 1st comment text lines of the latest active visit
. comment details
.----------------------------------------------------------------------
VSCMNT00  PACK      KEY17,ADMISSNO,VSCMTTYP,Z70  * Key for start of comment
          CALL      RSVSMDT1
VSCMNT20  CALL      RPVSMDT1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VSCMNT20 IF EQUAL
.
. Retrieve the comment text line details
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSCMNT60  CALL      RKVSMTX1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MOVE      VSMTCMNT,OTRLDIAG
.
VSCMNT99  RETURN
.------------------------------------------------------------
. Procedure to get Emergency Default Details
.------------------------------------------------------------
          DEFPROC  EMRDEF00   
.
          INC      AAEDE1FD/INC
          INC      EMRVISFD/INC
.
EMRDEF10  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     EMRVISA1,"emrvisaf"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRDEF50
.
          MOVE     ADMISSNO,KEY8
          CALL     RDEMVIS1
          BRANCH   OVRCD,EMRDEF50
.
          MOVE     EMVIDATE,OTRLDATE
          MOVE     EMVICLAS,OTRLDEPT
          MOVE     EMVICOM1,OTRLDIAG
          MOVE     AECNRQDF,OTRLREAS
          MOVE     EMVISRCE,OTRLSRCE
          MOVE     EMVIDOCT,OTRLRHCP
          MOVE     ZERO,EXIT
.
          MOVE     ZERO,EXIT
          GOTO     EMRDEF99
.
EMRDEF50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     AAEDE1A1,"aaede1af"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRDEF90
.
          PACK     KEY8,ADMISSNO
          CALL     RDDETA1
          BRANCH   OVRCD,EMRDEF90
.
          MOVE     ADADATE,OTRLDATE
          MOVE     ADACLASS,OTRLDEPT
          MOVE     ADADIAG,OTRLDIAG
          MOVE     AECNRQDF,OTRLREAS
          LOAD     OTRLSRCE,AECNECSR,ADAUSR1,ADAUSR2,ADAUSR3,ADAUSR4,ADAUSR5:
                                      ADASRC
          MOVE     ADADOCT,OTRLRHCP
          MOVE     ZERO,EXIT
          GOTO     EMRDEF99
.
EMRDEF90  MOVE     ONE,EXIT
          GOTO     EMRDEF99
.
          INC       AAEDE1IO/INC
          INC      EMRVISIO/INC
          INC       IBAOVRIO/INC
.
EMRDEF99  ENDPROC
.
.******************************************************************************
.*               CLSE0000                                                     *
.*                Close the EOC referral                                      *
.*                Parameter - KEY13                                           *
.******************************************************************************
CLSE0000  PACK      KEY13,URNUMBER,EPSOFCAR,SP70  * Referral File
          CALL      RDECREF1
          BRANCH    OVRCD,CLSE9000
.
          MATCH     SP70,OTRFL035          * Close date is mandatory
          GOTO      CLSE9200 IF EQUAL
.
          MOVE      OTRFL035,ECRFCDAT      * Date Closed (CCYYMMDD)
.
          MOVE      ONE,ECRFSTAT
          CALL      UPECREF1
          MOVE      ZERO,EXIT
          GOTO      CLSE9999
.
CLSE9000  MOVE      "Invalid Episode of Care",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSE9999
.
CLSE9200  MOVE      "Close date is a required field",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSE9999
.
CLSE9999  RETURN
.
.******************************************************************************
.*               REOP0000                                                     *
.*       Re-Open the Closed EOC                                               *
.******************************************************************************
REOP0000  PACK      KEY13,URNUMBER,EPSOFCAR,SP70  * Referral File
          CALL      RDECREF1
          BRANCH    OVRCD,REOP9000
.
          MOVE      ZERO,ECRFSTAT
          MOVE      SP10,ECRFCDAT
.
          CALL      UPECREF1
          MOVE      ZERO,EXIT
          GOTO      REOP9999
.
REOP9000  MOVE      "Invalid Episode of Care",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REOP9999
.
REOP9999  RETURN
