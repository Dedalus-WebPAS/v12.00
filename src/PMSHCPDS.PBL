.******************************************************************************
.* System         : All                                                       *
.*                                                                            *
.* Include Name   : PMSHCPDS.PBL                                              *
.*                                                                            *
.* Function       : Display the codes from the GP file PMSHCPFD.INC           *
.*                                                                            *
.* Parameters     :                                                           *
.*                                                                            *
.* Returns        : CKYIDEF6      GP practice code                            *
.*                  CKYIDEF2      GP practice code count                      *
.*                                                                            *
.* Modifications  :                                                           *
.*        V9.02.00  12/12/2002  J.Tan                                         *
.*                  Ported from r5.10                                         *
.*        V5.10.01  21/08/2002  Raghunandan Surve, HPS  SRF18814              *
.*                  Fixed GP search for a surname and given-name              *
.******************************************************************************
.*        V5.09.01  22/02/2002  Mike Laming  SRF 14642                        *
.*                  Correct GP Practice display for each GP Code              *
.*        V5.07.01  10/11/1999  Caleb Sharman 5.08 mods                       *
.*                  Mods to display doctors given name in full                *
.*        V5.05.01  14/11/1997  Nick      SRF 643825                          *
.*                  Fixed bug when searching for DR's with same surname       *
.*        V5.04.01  25/03/1997  Greg Horvat      SRF 619363                   *
.*                  Changed to display GP's without practices                 *
.*                                                                            *
.*                  13/05/93 J.Tan   SRF 440044                               *
.*                  Fixed displaying GP after screen is full                  *
.*                  13/07/93 WHIRLPOOL SRF 440129                             *
.*                  Added use of PTGPFLAG to display all GP'S                 *
.*                  03/11/1993    Justin Coates  QUOTE 440017 SRF 440204      *
.*                  changed to always loop over link file and then to loop    *
.*                  over practice file and use the practice address details   *
.*                  16/11/1993    Justin Coates  QUOTE 440017 SRF 440204      *
.*                  return CKYIDEF6 and CKYIDEF2 for practice code/count      *
.*                  14/01/1994    Justin Coates  SRF 440457                   *
.*                  check on the active flag for second loop on patgppfd      *
.*                  07/03/1994    Justin Coates  SRF 440717                   *
.*                  fix where things go if no search surname entered          *
.******************************************************************************
.
PMSHCPDS  PACK      PMHCSNAX,SP30
          PACK      PMHCGNAX,SP30
          PACK      PMHCPRCX,SP30
.
. ******* enter the search parameters *******
.
DSGPP001  DISPLAY   *P1:3,*EF:
                    *P1:4,"Surname : ":
                    *P32:4,"Given : ":
                    *P66:4,"Prac : "
.
          KEYIN     *P11:4,*V2LON,*RV,PMHCSNAX,*P11:4,*DV,PMHCSNAX
.
. ...........................................Removed                    D-50901
...       RESET     PMHCSNAX   
...       GOTO      DSGPP900 IF EOS        
....
...       ENDSET    PMHCSNAX       
...       APPEND    SP30,PMHCSNAX
...       RESET     PMHCSNAX
....
...       MATCH     SP30,PMHCSNAX 
...       GOTO      DSGPP100 IF EQUAL                                   D-50901
.
          KEYIN     *P40:4,*V2LON,*RV,PMHCGNAX,*P40:4,*DV,PMHCGNAX:
                    *P73:4,*V2LON,*RV,PMHCPRCX,*P73:4,*DV,PMHCPRCX
.
. ******** check if anything has been keyed *********
.
          PACK      DIM3,PMHCSNAX,PMHCGNAX,PMHCPRCX                    *I-50901
          RESET     DIM3                                               *I-50901
          GOTO      DSGPP900 IF EOS                                    *I-50901
.
          PACK      PMHCSNAX,PMHCSNAX,SP20                      * SRF18814
          PACK      PMHCGNAX,PMHCGNAX,SP25                      * SRF18814
          STRIP     PMHCSNAX                                           *I-50901
          STRIP     PMHCGNAX                                           *I-50901
.
. ******* display the data *******
.
DSGPP100  DISPLAY   *P1:6,*EF,*V2LON,*P5:6:
                    *ULON,"GP Code ",*P15:6,"Name                        ":
                    *P72:6,"Practice"
          MOVE      SEVEN,CVERT
          MOVE      ONE,FORM2                    * init item counter
          DISPLAY   *P1:24,"GP : "
          PACK      KEY80,PMHCSNAX,SP30,SP30     * SRF18814
          CALL      RSPMHCP2
.
. ******* get a new GP *******
.
DSGPP200  CALL      RKPMHCP2
          BRANCH    OVRCD OF DSGPP500
.
          IF        PMHCFLAG = 0
            MATCH     "1",PMHCSTTS           * Non-active ?
            GOTO      DSGPP200 IF EQUAL
          ENDIF
.
          DISPLAY   *P5:24,*V2LON,PMHCSNAM,PMHCGNAM 
          MOVE      SP6,PMHGPRAC           * clear practice code
..........changed GOTO for SRF18814
          STRIP     PMHCSNAX
          GOTO      DSGPP205 IF EOS        * dont check the surname
.
          MATCH     PMHCSNAM,PMHCSNAX
          GOTO      DSGPP500 IF NOT EQUAL   * incorrect surname
.
DSGPP205  RESET     PMHCGNAX                * did they enter a given name ??
          IF        !@EOS
            MATCH     SP30,PMHCGNAX           * given name entered ??
            IF        !@EQUAL
              MATCH     PMHCGNAX,PMHCGNAM
              IF        !@EQUAL
.                MOVE      "~",DIM1
.                PACK      KEY53,PMHCSNAM,DIM1,SP30,SP30
.                CALL      RDPMHCC2
                GOTO      DSGPP200
              ENDIF
            ENDIF
          ENDIF
.
. ------- loop over the GP link file for the GP entered -------
.
DSGPP210  CALL      CGPPV000                * Clear GP practice variables
          MOVE      SP6,PMHLHCPR
          PACK      KEY14,PMHCHCPC,PMHCPRCX,SP30
          CALL      RSPMHCL1                * Position on & read a GP link
          CALL      RPPMHCL1                * Back up 1 record         *I-50901
.
DSGPP220  MOVE      SP8,PMHLHCPC                                       *I-50901
          MOVE      SP8,PMHLHCPR                                       *I-50901
DSGPP221  CALL      RKPMHCL1                * file record              *C-50901
          BRANCH    OVRCD,DSGPP300
.
          MATCH     PMHCHCPC,PMHLHCPC
...       GOTO      DSGPP300 IF NOT EQUAL   * Different GP code         D-50901
          IF        !@EQUAL
            MOVE      SP8,PMHLHCPC                                     *I-50901
            MOVE      SP8,PMHLHCPR                                     *I-50901
            GOTO      DSGPP300                                         *I-50901
          ENDIF                                                        *I-50901
.
          MATCH     SP6,PMHLHCPR
          GOTO      DSGPP300 IF EQUAL       * Blank GP practice
.
          IF        PMHLFLAG=0
            MATCH     "1",PMHLSTAT
            GOTO      DSGPP220 IF EQUAL     * Not active
          ENDIF
.
............................................. Moved to DSGPP310         D-50901
...       RESET     PMHCPRCX
...       GOTO      DSGPP230 IF EOS         * No practice keyed in
....
...       MATCH     SP6,PMHCPRCX
...       GOTO      DSGPP230 IF EQUAL       * No practice keyed in
....
...       MATCH     PMHCPRCX,PMHLHCPR
...       GOTO      DSGPP300 IF NOT EQUAL   * Different GP practice     D-50901
.
. ------- loop over the GP practice file -----
.
DSGPP230  CALL      CGPPV000                * Clear GP practice variables
          PACK      KEY12,PMHLHCPR,SP2
          CALL      RSPMHCG1                * Position on & read a GP practice
DSGPP240  CALL      RKPMHCG1                  file record
          BRANCH    OVRCD,DSGPP300
.
          MATCH     PMHLHCPR,PMHGPRAC
...       GOTO      DSGPP300 IF NOT EQUAL   * Different GP practice     D-50901
          IF        !@EQUAL
            CALL      CGPPV000              * Clear GP practice vars.  *I-50901
            GOTO      DSGPP300                                         *I-50901
          ENDIF                                                        *I-50901
.
          IF        PMHGFLAG = 0
            MATCH     "1",PMHGSTTS
            IF        @EQUAL
              CALL      CGPPV000            * Clear GP practice variables
              GOTO      DSGPP240
            ENDIF
          ENDIF
          GOTO      DSGPP300
.
. ------- loop over the GP link file for the GP entered -------
.
DSGPP250  CALL      RKPMHCL1                * Read a GP link file record
          BRANCH    OVRCD,DSGPP200          * No more practices for GP
.
          MATCH     PMHCHCPC,PMHLHCPC
          GOTO      DSGPP200 IF NOT EQUAL   * Different GP code
.
          MATCH     SP6,PMHLHCPR
          GOTO      DSGPP250 IF EQUAL       * Blank GP practice
.
          IF        PMHLFLAG=0
            MATCH     "1",PMHLSTAT
            GOTO      DSGPP250 IF EQUAL     * Not active
          ENDIF
.
............................................. Moved to DSGPP310         D-50901
...       RESET     PMHCPRCX 
...       GOTO      DSGPP260 IF EOS         * No practice keyed in      
....
...       MATCH     SP6,PMHCPRCX
...       GOTO      DSGPP260 IF EQUAL       * No practice keyed in
....
...       MATCH     PMHCPRCX,PMHLHCPR
...       GOTO      DSGPP200 IF NOT EQUAL   * Different GP practice     D-50901
.
. ------- loop over the GP practice file -----
.
DSGPP260  CALL      CGPPV000                * Clear GP practice variables
          PACK      KEY12,PMHLHCPR,SP2
          CALL      RSPMHCG1                * Position on & read a GP practice
DSGPP270  CALL      RKPMHCG1                  file record
          BRANCH    OVRCD,DSGPP250
.
          MATCH     PMHLHCPR,PMHGPRAC
          GOTO      DSGPP250 IF NOT EQUAL   * Different GP practice
.
          IF        PMHGFLAG=0
            MATCH     "1",PMHGSTTS
            GOTO      DSGPP270 IF EQUAL     * not active
          ENDIF
.
DSGPP300  COMPARE    TWENTY3,CVERT
          GOTO       DSGPP310 IF LESS
.
. ask question with Next Screen
.
          MOVE      ONE,FORM1
          DISPLAY   *P1:24,*EL,"Select Item, (",*V2LON,"F",*HOFF:
                    ")irst Screen, (":
                    *V2LON,"N",*HOFF,")ext Screen, (",*V2LON,"R",*HOFF:
                    ")e-search, (",*V2LON,"E",*HOFF,")xit ? ";
.
DSGPP305  KEYIN     *P67:24,*DV,UNDLN2:
                    *P67:24,*V2LON,*JR,DIM2:
                    *P67:24,*DV,DIM2
          PACK      DIM2,DIM2,SP2
          REP       UPPLOW,DIM2
          TYPE      DIM2                          * numeric input?
          GOTO      DSGPP670 IF EQUAL
          MATCH     " F",DIM2
          GOTO      DSGPP100 IF EQUAL
          MATCH     " N",DIM2
          GOTO      DSGPP700 IF EQUAL
          MATCH     " R",DIM2
          GOTO      DSGPP001 IF EQUAL
          MATCH     " E",DIM2
          GOTO      DSGPP900 IF EQUAL
          BEEP
          GOTO      DSGPP305
. .......................................................................
.
DSGPP310  MOVELPTR  PMHCPRCX,FORM1                                     *C-50901
          GOTO      DSGPP350 IF EQUAL       * No practice keyed in     *C-50901
.
          MATCH     PMHCPRCX,PMHLHCPR                                  *I-50901
          GOTO      DSGPP450 IF NOT EQUAL   * Not the selected GP Prac.*I-50901
.
DSGPP350  MOVE      PMHCGNAM,ANS                                       *C-50901
          PACK      DIM3 WITH SP1,ANS,DOT
.
          CMATCH    SP1,ANS
          GOTO      DSGPP400 IF NOT EQUAL
.
          MOVE      SP3,DIM3
.
DSGPP400  ASSIGN    (CVERT+1),CCOL1
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      SP3,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
.
          DISPLAY   *P1:CVERT,*V2LON,FORM2,". ",PMHCHCPC,SP1:
                    PACFNAME,*HOFF,*P72:CVERT,PMHLHCPR;                *C-50901
.
          STRIP     PMHGPNAM
          IF        !@EOS
            DISPLAY   *P5:CCOL1,*+,PMHGPNAM,", ";
          ENDIF
.
          STRIP     PMHGADD1
          IF        !@EOS
            DISPLAY   *+,PMHGADD1,", ";
          ENDIF
.
          STRIP     PMHGADD2
          IF        !@EOS
            DISPLAY   *+,PMHGADD2,", ";
          ENDIF
.
          STRIP     PMHGADD3
          IF        !@EOS
            DISPLAY   *+,PMHGADD3,", ";
          ENDIF
.
          STRIP     PMHGADD4
          IF        !@EOS
            DISPLAY   *+,PMHGADD4,", ";
          ENDIF
.
          STRIP     PMHGPOST
          IF        !@EOS
            DISPLAY   *+,PMHGPOST;
          ENDIF
.
          PACK      PMHCQARR[FORM2],PMHCHCPC,PMHGPRAC,PMHGCNTR
          ADD       ONE,FORM2                    * increment item counter
          ADD       TWO,CVERT
.
DSGPP450  MATCH     PMHCHCPC,PMHLHCPC                                  *C-50901
          GOTO      DSGPP250 IF NOT EQUAL   * Different GP code
.
          MATCH     SP6,PMHLHCPR
          GOTO      DSGPP250 IF EQUAL       * Blank GP practice
          GOTO      DSGPP270
.
. ask question without Next Screen
.
DSGPP500  MOVE      TWO,FORM1
          DISPLAY   *P1:24,*EL,"Select Item, (",*V2LON,"F",*HOFF:
                    ")irst Screen, (",*V2LON,"R",*HOFF:
                    ")e-search, (",*V2LON,"E",*HOFF,")xit ? ";
.
DSGPP550  KEYIN     *P52:24,*DV,UNDLN2:
                    *P52:24,*V2LON,*JR,DIM2:
                    *P52:24,*DV,DIM2
          PACK      DIM2,DIM2,SP2
          REP       UPPLOW,DIM2
          TYPE      DIM2                          * numeric input?
          GOTO      DSGPP670 IF EQUAL
          MATCH     " F",DIM2
          GOTO      DSGPP100 IF EQUAL
          MATCH     " R",DIM2
          GOTO      DSGPP001 IF EQUAL
          MATCH     " E",DIM2
          GOTO      DSGPP900 IF EQUAL
          BEEP
          GOTO      DSGPP550
.
. a numeric was input
.
DSGPP670  MOVE      DIM2,CCOL
          IF        (CCOL<1) | (CCOL>=FORM2)
            BEEP                                  * not in valid range
            BRANCH    FORM1,DSGPP305,DSGPP550
          ENDIF
.
          UNPACK    PMHCQARR[CCOL],PMHCHCPC,CKYIDEF6,CKYIDEF2
          MOVE      ZERO,EXIT
          GOTO      DSGPP999
.
.         Clear the screen
.
DSGPP700  MOVE      SEVEN,CVERT
          DISPLAY   *P1:CVERT,*EF
          MOVE      ONE,FORM2                     * init item counter
          GOTO      DSGPP300
.
DSGPP900  MOVE      SP8,PMHCHCPC
          MOVE      ONE,EXIT                      * Exit selected
.
DSGPP999  RETURN
.
CGPPV000  PACK      PMHGPRAC,SP6
          PACK      PMHGPNAM,SP30
          PACK      PMHGADD1,SP30,SP10
          PACK      PMHGADD2,SP30,SP10
          PACK      PMHGADD3,SP30,SP10
          PACK      PMHGADD4,SP30,SP10
          PACK      PMHGPOST,SP10
CGPPV999  RETURN
.............................................................................
