.--------------------------------------------------------------------------
. Program       : OPRWEB03
.
. Function      : Theatre List Server
.
. Modifications :
.--------------------------------------------------------------------------
. V11.05.01 14/11/2024  Nikitha B      TSK 0953741
.           Added ADJUSFLG and call for ADJUST00 at SESTAA10 to assign class
.           "AdjustTime" display pink when theater time adjusted to start later.
. V11.04.01 01/05/2024  PJ Le Febour   TSK 0945350   
.           added HTMLLNK5 redirect Patient link 
.           currently patweb9801001 amended to oprweb0104001
. V11.03.02 21/08/2023  Alina Bhari    TSK 0936611   
.           Fixed the title for Day Session by Date/Unit - LIST0000  
. V11.03.01 21/03/2023  Ebon Clements    TSK 0909393
.           Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
. V11.02.01 01.04.2022  DA Sarkies     TSK 0906511
.           Recompiled for PATNAMCD
. V11.01.07 03/06/2021  Ebon Clements  TSK 0886820
.           Added dispwkno to NEXT0000 and PREV0000
. V11.01.06 20/05/2021  Davin           TSK 0904190
.           Added clear of oprsrgaf fields (CLOPRSRG) at CURTHE00
. V11.01.05 28/04/2021  Ebon Clements   TSK 0905009
.           Fixed alert display if patient only has a micro alert - CASTAB12
.           and THETAB11
. V11.01.04 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
. V11.01.03 22.04.2021  DA Sarkies     TSK 0904924
.           Fixed up html errors in code  
. V11.01.02 23/03/2021  Ebon Clements  TSK 0886820
.           Increased WEEKCYCL to a DIM 10
. V11.01.01 03/03/2021  Ebon Clements  TSK 0886820
.           Added display week cycle number menu cgi variable - dispwkno
.           Added theatre week cycle number display functionality
. V11.00.03 13/01/2021  Ebon Clements   TSK 0893749
.           Added All Sessions Excluding Cancelled (4) - SESL2100 SESUNT00
. V11.00.02 09/12/2020  Thanh T         TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 27/04/2020  Ebon Clements   TSK 0850105
.           Added procedure calls PMSCURTH - Theatre status in patient header
. V10.15.02 07/01/2020  Nicole Torrisi  TSK 0885597
.           REP space with 0 in OPDACASE in PATROW00 to correct sort order
. V10.15.01 25/09/2019  Richa Phogat    TSK 0862335
.           Added SESL2600 to display DEFTVIEW
. V10.14.07 26/09/2019  Sunny           TSK 0846427
.           1)Fixed TDCMC000 to make the button display red if more
.             than 1 line exists.
.           2)Fixed TDCML999 to display Day Comments from the hospital user is
.             logged in.
. V10.14.06 24/09/2019  Richa Phogat    TSK 0862335
.           Updated CURTHE00 to get correct value for BKRXADWD
. V10.14.05 11/09/2019  Sunny           TSK 0846427         
.           Added DISPDAYC in NEXT0000 and PREV0000
. V10.14.04 21/08/2019  Richa Phogat    TSK 0862335
.           New CGI vaiable EXCLEXIT, ADMPOINT, DFLTWARD, WARDCODE, ADMWRDEC, 
.           XTRAFLTR 
.           Updated CURTHE00 by adding more variables 
.           Added WSEL0000 to get Ward Selection List
. V10.14.03 12/08/2019  Ebon Clements   TSK 0878134
.           Fixed theatre session type display - SESUNT40 - OPSESTYP - DIM19
. V10.14.02 16/07/2019  Tracey Nguyen   TSK 0846427
.           1)New CGI variables to display current date theatre
.             comments - DISPDAYC,DAYCMCNT           
.           2)New tags SESL2200, SESL2300, SESL2400
. V10.14.01 05/06/2019  Nicole Torrisi  TSK 0867028
.           Added SESSBOOK filter to SESUNT00 Theatre Sessions by Date/Unit   
.           Added output of SESSBOOK select list - SESL2100
.--------------------------------------------------------------------------
. V10.13.01 16/07/2018  Steve Armstrong TSK 0851661
.           Updated field descriptions for oprardaf variables (STOARD00)
.--------------------------------------------------------------------------
. V10.12.03 30/04/2018  Richa Phogat   TSK 0843171
.           Added OPDAPOWD and OPDAPOBD in PATROW00
. V10.12.02 23/04/2018  Ebon Clements  TSK 0845588
.           Added fasting date functionality
. V10.12.01 02/03/2018  Ken Bell       TSK 0851092
.           Added Hospital Code for Recovery Closed Table for Multi-Campus
.--------------------------------------------------------------------------
. V10.11.02 01/11/2017  Ken Bell       TSK 0847087
.           Wrong variable was used for Loan Equipment, S/B OPDALEQR
. V10.11.01 13/10/2017  Thanht T.      TSK 0845832
.           Added Loan equipment description to theatre case list in
.           standard/oprweb0303005 template
. V10.10.02 10/03/2017  Peter Vela     TSK 0829089
.           Added N/A validation to PICOCODE PROTAB00
. V10.10.01 03/03/2017  J.Tan          TSK 0829089
.           Fixed checking for Prosthetic input complete
. V10.09.04 24/02/2017  Peter Vela     TSK 0829089
.           Added OPCNVPIN functionality to PROTAB00
. V10.09.03 21/02/2017  Peter Vela     TSK 0829089
.           Added Hospital Level Prosthetics list functionality
. V10.09.02 11/01/2017  Jill Parkinson TSK 0831305
.           Corrected labels in CURTHE00 so that it doesn't skip setting of 
.           casekeys and linking to the incorrect patient
. V10.09.01 12/12/2016  Ania P         CAR 319994
.           Change position of GETPAT00 & PATLN000 in CURTHE00 to avoid
.           this code being skipped if no Patient Alert Read.
. V10.08.07 14/10/2016  Ania P         CAR 319994
.           Mod CURTHE13 to work the same as CURTHE15
. V10.08.06 11/10/2016  Ania P         CAR 319994
.           Added DSAL0000 & Mod CURTHE13/CURTHE15
. V10.08.05 09/08/2016  Davin          TSK 0321234
.           Recompiled for LSTALERT - added ALRTIMG4 for Chronic Alerts
. V10.08.04 29/07/2016  Ebon Clements    TSK 0312728
.           Only test recovery review if patient in recovery - REVW0000
. V10.08.03 11.07.2016  Ebon Clements  TSK 0312768
.           Added additional theatre recovery fields for Map. eg Bay - MAPROW00
. V10.08.02 09.06.2016  Ebon Clements  TSK 0308881
.           Added recovery closed tag - RCLS0000
. V10.08.01 18.04.2016  B.G.Ackland   
.           Internal Testing of Map Display showing Arrival/Departure 
.           Fields not Clear
. V10.07.04 17.02.2016  B.G.Ackland   
.           Added New Tag for Theatre Map Location Output
. V10.07.03 21/10/2015  Ebon Clements  CAR 317489
.           Added HTMLLNK4 to PATROW00 
. V10.07.02 20/10/2015  Ebon Clements  CAR 317489
.           Fixed theatre filter - theacode
. V10.07.01 15/10/2015  Ebon Clements  CAR 316638
.           Added cancelled/tranferred status display - CURTHE00
. V10.06.03 18/09/2015  Ebon Clements  CAR 317489
.           Added theatre filter THEACODE to theatre case list - CURTHE00
. V10.06.02 02.06.2015  B.G.Ackland    CAR 
.           Theatre Map View Requirements
. V10.06.01 17/07/2015  Peter Vela     CAR 313515
.           Fixed key assignment in PATLST45 to KEY16
. V10.05.02 30/01/2015  Patrick Adair  CAR 308918
.           Added Fasting Time Data Collection
. V10.05.01 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
.--------------------------------------------------------------------------
. V10.04.04 24.06.2014  Jill Parkinson CAR 273374 
.           Added check for OPSGTISS in CURTHE00 as sjog dont collect prep start
. V10.04.03 03.06.2014  Peter Vela   CAR 297908
.           Fixed red font validation in SESUNT00
. V10.04.02 16.05.2014  Peter Vela   CAR 297908
.           Added red font for Actual Op Min in SESUNT00 
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.--------------------------------------------------------------------------
. V10.03.05 22/11/2013  Patrick Adair  CAR 282248
.           Changed Diagnosis label to read Reason For Admission for NZ
. V10.03.04 04/10/2013  Patrick Adair  CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.03 29/04/2013 J.Tan          CAR 257211
.           Mods checking for Adjustment time in session
. V10.03.02 19/01/2012  Peter McMullen CAR 252064
.           Save anasthetic description in CURTHE00
. V10.03.01 29/11/2011 Jill Parkinson     CAR 249362
.           Changed key to alert table reads
. V10.02.02 25/06/2011 Steve Armstrong    CAR 240722
.           Mods to cater for changes to PATLOCFD.
.                - LSNAME & LGNAME extended to 40 chars.
.                - PTLCGNM2 added.
. V10.02.01 10/05/2011  Davin          CAR 239539 WA Health
.           Recompiled for LSTALERT - added ALRTIMG2,ALRTIMG3,ALRTIMGT
. V10.01.01 13/01/2011 Jill Parkinson CAR 233088
.           Added pmsvx1af
.--------------------------------------------------------------------------
. V10.00.04 25/08/2010  Saroeun Soeur  CAR 207457
.           THETAB00 -  CONDDESC set nowrap
. V10.00.03 11/08/2010  Ebon Clements  CAR 207457
.           Added time period filter FILTTPER to THETAB00
. V10.00.02 20/07/2010  Peter Vela     CAR 218719
.           Added LSTALR00 to CURTHE00
. V10.00.01 07/06/2010  Mike Laming    CAR 204622
.           Added Patient Alerts to Theatre List in THETAB00 (uses LSTALERT)
.           Changed CASTAB00 to use LSTALERT for Patient Alerts
.--------------------------------------------------------------------------
. V9.12.14  03/02/2010  Jill Parkinson CAR 192721
.           Added WARDDOSA
. V9.12.13  27/01/2010  Jill Parkinson CAR 212482
.           Fixed replace + in CURTAB00
. V9.12.12  27/01/2010  Jill Parkinson CAR 211804
.           Removed class=icon from deaf icon as it is not a link
. V9.12.11  21/01/2010  Mike Laming    CAR 211804
.           Mods to CURTHE00 to clean up Theatre Case (sort) List
. V9.12.10  05/01/2010  Saroeun Soeur  CAR 212530
.           _SAVDOCT - store the correct surgeon code
.           GETSES00 - process _SAVDOCT
. V9.12.09  21/12/2009  Ebon Clements  CAR 194682
.           Use ward master record to check if DOSA ward - THETAB15
. V9.12.08  14/12/2009  Ebon Clements  CAR 212016
.           Added patient folder to CURTHE00
. V9.12.07  09/12/2009  Peter McMullen CAR 210130
.            concert to newer doctor name formatting routine DOCNM000
. V9.12.06  23/09/2009  Saroeun Soeur  CAR 203443
.            fixed patient linked folder relating to CAR 201782
. V9.12.05  02/09/2009  Ebon Clements  CAR 172487
.           Added finilisation fields to SESUNT00
. V9.12.04  12/08/2009  Jill Habasque  CAR 195472
.           Changed PERSOVER to form 4.5 instead of 4.1
. V9.12.03  24/07/2009  Saroeun Soeur  CAR 201782
.           Added patient folder  linked to theatre details
. V9.12.02  20/07/2009  Peter McMullen CAR 186039
.           Add Doctor selection list, surgeon/anaeth filter and patient
.           alerts to CURTHE00
. V9.12.01  17/07/2009  WeeLee Koo     CAR 174474
.           Added PATNAMCD and PATDOCCD. Changed displays of Patient name 
.           according to Patient Search Parameters
.--------------------------------------------------------------------------
. V9.11.01  27/10/2008  Ebon Clements  CAR 181535
.           Added trap around write to arrival details - OPREVT13
.--------------------------------------------------------------------------
. V9.10.01  06/05/2008  Ebon Clements  CAR 167841
.           Fixed population of patient name PATFNAME in PATLST00
.--------------------------------------------------------------------------
. V9.09.06  27/03/2008  Peter Vela     CAR 164748
.           Added Booking Comments to PATLST00
. V9.09.05  13/03/2008  Ebon Clements  CAR 162989
.           Added patient alerts indicator to CASTAB00
. V9.09.04  05/02/2008  Mike Laming    CAR 159894
.           Correct routine THEATR00 to test for Multi Hospital
. V9.09.03  28/11/2007  Peter McMullem CAR 155802
.           Changed THETAB15 to use AWARD and then BKRXADWD if AWARD is blank
. V9.09.02  20/07/2007  Ebon Clements CAR 145544
.           Don't do multi hospital test on theatre list if act
. V9.09.01  13/06/2007  Ebon Clements CAR 142421
.           Changed CURTHE15 to use AWARD and then BKRXADWD if AWARD is blank
.--------------------------------------------------------------------------
. V9.08.01  02/10/2006  Ebon Clements CAR 119992
.           Added multi hospital tests to theatre session lists
.--------------------------------------------------------------------------
. V9.07.01  20/09/2006  Peter Vela    CAR 118228
.           Added functionality for Reallocated ad hoc theatre sessions
.           report no 5
.--------------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
.------------------------------------------------------------
.                 V9.04.07  04/10/2005  Mike Laming     CAR 52354
.                           Add switch SHOCNSNT & code for "Consent"
.                 V9.04.06  06/06/2005  Ebon Clements   CAR 62848
.                           Fixed OPCNCLSU using clinics test
.                 V9.04.05  13/05/2005  Jill Habasque   CAR 61176
.                           Added check for OPCNCLSU                     
.                 V9.04.04  14/02/2005  Lina Vo         CAR 56404
.                           Recompiled for OPRSRGFD                      
.                 V9.04.03  14/02/2005  Ebon Clements   CAR 57347
.                           Added EXTHFLAG to THETAB00 for day procedures
.                 V9.04.02  07/01/2005  Ebon Clements   CAR 54211
.                           Mod for Day Session case List - THETAB00
.                 V9.04.01  27/09/2004  Lina Vo         CAR 53754 
.                           Mod for Day Session case List
.                 V9.03.04  30/06/2004  Sylvek Litewka  CAR 50667 
.                           Modified procedure SESTAA00 to output Day name and
.                           Session Status fields. Modified procedure SESUNT00 
.                           to output Session Status field.
.                 V9.03.03  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2
.                           Add Sex Description routine SEXDSC00 with Code "R" 
.                           - "Intersex" added.
.                 V9.03.02  20/01/2004 Peter Vela      CAR 44973
.                           Added Code for Time Called For field
.                           New submit branch in mainline for updating
.                           Time Called For column in oprweb0303004.html
.                 V9.03.01  18/07/2003 Sylvek Litewka  CAR 38345
.                           Added SURGTYPE filter on a number of Theatre Lists.
.                           Modified CURTHE00 to output OPARUT11 (Estimated
.                           Discharge Time) and to prefix the patient status
.                           description with "RIP -" (Deceased) where required.
.------------------------------------------------------------------------------
.                 V9.02.22  07/02/2003 Tonii CAR 35992
.                           Recompiled for PATMISTM - inactive codes in patfundf
.                 V9.02.21  09/10/2002 Peter Vela    SRF 17693
.                           Recompiled for PATMISTM - Admitting Point
.                 V9.02.20  27/09/2002 Ebon Clements SRF 20551
.                           Do not display cancelled sessions in SESTAA00
.                 V9.02.19  29.06.2002 Ebon Clements SRF 19105
.                           Recompiled for sigpipe trap
.                 V9.02.18  31.05.2002 Ebon Clements SRF 18229
.                           Added trap if sigpipe
.                 V9.02.17  15.05.2002 Jill Habasque SRF 17530
.                           Added check for cancelled bookings in castab00
.                 V9.02.16  28.03.2002 Ashwin
.                           Add link for Change Theatre for patient
.                 V9.02.15  28.02.2002 Ashwin
.                           Display Cancelled Sessions and Status
.                 V9.02.14  05.02.2002 Ashwin
.                           Check for DOSA Ward
.                 V9.02.13  29.01.2002 Ashwin
.                           Remove auto update of arrival time
.                 V9.02.12  24.01.2002 Ashwin
.                           Modify for Nursing Station,Add Session type to
.                           Case List,Recovery Description
.                 V9.02.11  17.01.2002 Ashwin
.                           Don't display cancelled session,Fix Ward/bed display
.                 V9.02.10  09.01.2002 Ashwin
.                           Add Patient Diagnosis/Equipment List
.                 V9.02.09  03.01.2002 Ashwin,Kuldeep
.                           Fix for update of Time Called for
.                 V9.02.08  18.12.2001 Kuldeep,Ashwin
.                           Change the format of display of time,default all 
.                           patients,skip anaesthetic patient for theatre list
.                           Dosatime picked up only from admission file
.                 V9.02.07  22.11.2001 Ashwin
.                           Change the sequence of display of current status
.                 V9.02.06  14.11.2001 Ashwin
.                           Add Time Called for column in Patient theatre list
.                 V9.02.05  30.10.2001 Ashwin
.                           Cancelled patients not to be displayed
.                 V9.02.04  03.10.2001 Jill Habasque
.                           Commented out replace of apostrophies with space.
.                 V9.02.03  08.09.2001 Ashwin - HPS
.                           Modified to display month for theatre case
.                           modified for Patient List
.                 V9.02.01  28.08.2001 Ashwin - HPS
.                           Modified for the Percentage calculation for Theatre
.                           Status
.                 V9.01.02  17.08.2001 HPS-ODC
.                           Modified Routine CURTHE00
.                 V9.01.01  14.08.2001 J.Tan & HPS -ODC
.                           Recompiled for PATMASTM
.                           Modified for Theatre Status enquiry.
.                 VB9.00.01 16.07.2001 B.G.Ackland
.                          Move Count of Patient in Session to New Routine
.                          Fix Session Case List and Various Other Problems
.                 V9.00.00 28.06.2001 HPS - Sunil/Krishna
.                          Added Code for New List Screens
.                 V5.10.01 19.03.2001 Bronko Sosic
.                          Added Check for dead patients in GETPAT00
.                 V5.09.02 15.01.2001 Bronko Sosic
.                          Recompiled for PATMASTM 
.                 V5.08.04 05/09/2000  Tonii
.                          Mods to accept Unknown and Indeterminate as valid
.                          patient sex description
.                 V5.08.03  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.02 07.06.2000 B.G.Ackland
.                          Recompiled for PATMASTM 
.                 V5.08.01 25/05/2000 Pat Dirito     
.                          Recompiled for PATMASTM 
.                 V5.07.05 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.04 05/01/2000  Katie Nelson      
.                          Recompiled for WEBDATCD Y2K date correction      
.                          Also Recompiled for PATMASTM changes      
.                 V5.07.03 20/12/1999  Katie Nelson      
.                          Recompiled for IBAWEBCD/IBAWEBDF
.                 V5.07.02 03/11/1999  Katie Nelson      
.                          Recompiled for WEBDATCD/DAYOFWEK   
.                 V5.07.01 29/09/1999  Nicole Harrington
.                          Port 6.06 - 5.07
.                 V6.04.01 12.02.1998 B.G.Ackland
.
.                 V6.04.03 23.03.1998 B.G.Ackland
.                          New Template Body Processing   
.
.------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       CALDURNV/INC
          INC       PMSPX2TD/INC
          INC       BOKRC1FD/INC
.
          INC       MLTHCPFD/INC
          INC       OPRCOMFD/INC
          INC       OPRCONFD/INC
          INC       OPRCLIFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDEBFD/INC
          INC       OPRDECFD/INC
          INC       OPRDEDFD/INC
          INC       OPROPRFD/INC
          INC       OPRRALFD/INC
          INC       OPRSESFD/INC
          INC       OPRPIMFD/INC
          INC       PMSPX2FD/INC
.
          INC       PATCALAG/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATHSPFD/INC
          INC       PATLOCFD/INC
          INC       PATMI1FD/INC
          INC       PMSVX1FD/INC
          INC       PATMA1FD/INC
          INC       PATPR1FD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PATNURFD/INC
          INC       PATALRFD/INC
          INC       SCRMASFD/INC
          INC       OPRARDFD/INC
          INC       OPRRCIFD/INC
          INC       BOKRX1FD/INC          
          INC       BOKDIAFD/INC
          INC       OPRSRGFD/INC            * HPS Code Starts Here
          INC       OPRWCNFD/INC
.
          INC       PMSCCDFD/INC            * Concession Card Details
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
.  
ACTOPRED  FORM      1
CURRDATD  DIM       8                       * Current date
DEFTVIEW  FORM      1
DIM100A   DIM       100                     * surgeon link
DIM100B   DIM       100                     * anaethetist link
DIM200C   DIM       200                     * alerts text          
DIM200D   DIM       200
DIM32     DIM       32
DIM20A    DIM       20
DIM20B    DIM       20
DISPCREV  DIM       20
DISPDAYC  FORM      1           *Display Todays theatre comments     *T0846427
DAYCMCNT  FORM      3           *Current date comment line count     *T0846427
DISPDTFF  DIM       13
DISPDTFL  DIM       13
DISPSDAT  DIM       20
DISPWKNO  FORM      1           * Display week number on theatre lists
DURATIME  FORM      8
DOSAWARD  DIM       1
EXTHFLAG  DIM       1                       * Exit theatre filter
EXCLCANC  DIM       1
EXCLEXIT  DIM       1                       * Exclude Exit Stauts Patient
ADMPOINT  DIM       3                       * Admitting Point
DFLTWARD  DIM       3                   * ward to be pre-selected on select list
WARDCODE  DIM       3                       * Ward Code
ADMWRDEC  DIM       20                      * Admitting Ward Description
XTRAFLTR  DIM       1
HOUR      DIM       2
LBRACKT   INIT      "("
RBRACKT   INIT      ")"
LISTTYPE  DIM       1                       * List Type CGI Param
LOCATION  DIM       3
MIN       DIM       2
THEACODE  DIM       6                       * Theatre CGI Param
PICOCODE  DIM       1
SURGC001  DIM       8                       * Time Called For       
UNITCODE  DIM       3                       * Session Type (ST) CGI Param
SURGTYPE  DIM       3                       * Surgery Type - Day/General
SESSBOOK  FORM      1                       * Session booking filter
OPDUNQID  DIM       10                      * CGI param to update curr time
.                                           * HPS Code Ends Here
OPERROOM  DIM       50
DISPTEAM  FORM      1
BARWIDTH  FORM      3
FORM3     FORM      3
FORM8     FORM      8
FILTTPER  DIM       3
FILTSURG  DIM       6
SHOWORDR  FORM      1      
BARIMAGE  DIM       40
SHOWUSED  FORM      1
PSRHNAME  DIM       30
DOCTCODE  DIM       6
ANAECODE  DIM       6
ADJUSFLG  DIM       10
.
CONDDESC  DIM       33
CONSENT   DIM       1
SHOCNSNT  FORM      1
.
CANCBOOK  FORM      1
CASECNT   FORM      3
THISCAS   FORM      3
LSTCASE   FORM      3
.
ACTION    DIM       1
ALRTLINK  DIM       127                                               *I-204622
ALRTIMGE  DIM       127                                               *I-204622
ALRTIMG2  DIM       127
ALRTIMG3  DIM       127
ALRTIMG4  DIM       127
ALRTIMGT  DIM       250
TAGMATCH  DIM       14
OLDEXPD   FORM      4
DISALERT  FORM      1                            * Disability alert flag
OTHALERT  FORM      1                            * Other alert flag
.
SURFNAME  DIM       50
SURFNAM2  DIM       50
ANAFNAME  DIM       50
SESHEAD1  DIM       80
FORMNAME  DIM       8
ELEMNAME  DIM       8
ELEMVALU  DIM       80
KEY90A    DIM       120    * I CAR 44973
OUTVALUE  DIM       80
PATFOLDR  DIM       3
REDIFLAG  DIM       1
SESSDATE  DIM       10    Session Date
SESSFILL  FORM      3.1   Fill Percentage for Session
SESTDESC  DIM       20
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
HTMLLNK2  DIM       127
STARTIME  DIM       5
CENDTME   DIM       5
HTMLLNK3  DIM       200
HTMLLNK4  DIM       127
HTMLLNK5  DIM       200
.
SAVKEY20  DIM       20
LASTCASE  DIM       3
MVTOCASE  DIM       3
CASEKEYS  DIM       26
SESSKEYS  DIM       22
SESSKEY2  DIM       30
NEWSESSI  DIM       19
PATCANTH  DIM       3   * Reason for Theatre Cancellation
CANADMIS  DIM       1   * Cancel Admission 
PATCANAD  DIM       3   * Reason for Admission Cancellation
PICDIM20  DIM       20
CODEOA    INIT      "OA"
CODEBC    INIT      "BC"
CODECO    INIT      "CO"
CODEDK    INIT      "DK"
CODESC    INIT      "SC"
CODESP    INIT      "SP"
CODEST    INIT      "ST"
STYPDES   DIM       25
EQRDESC1  DIM       20
EQRDESC2  DIM       20
EQRDESC3  DIM       20
EQRLDESC  DIM       20
.                                           * HPS Code Starts Here 
DOSATIME  DIM       8                       * Admission Time
CURSTATS  DIM       21                      * Current Status
CURSTATB  DIM       5                       * Current status recovery bay
COUNT     FORM      3                       * Count Variable 
PERSOVER  FORM      4.5                     * % Over
.                                           * HPS Code Ends Here
_SAVDOCT  DIM       6                       * surgeon code
.
DIM15     DIM       15
DIM127A   DIM       127
STAPRFIX  INIT      "RIP - "                * Prefix for patient status
UPDTTYPE  DIM       1                       * I CAR 44973
NEXTPAGE  DIM       1                       * I CAR 44973
WARDDOSA  DIM       7
.
MDATAKEY  DIM       16
MDATAVAL  DIM       70
.
SHOWMAP   FORM      1
PAGEVIEW  DIM       1
REVWREQD  DIM       3
UPDATETY  FORM      2
SETTABLE  FORM      2
SETFIELD  FORM      2
SURSNAME  DIM       25
ANASNAME  DIM       25
WARDSTR   DIM       10
CURSCODE  DIM       2                      * Current Status Code
DESCRDCD  DIM       25
DESCUC01  DIM       25
DESCUC02  DIM       25
DESCUC03  DIM       25
DESCUC04  DIM       25
DESCUC05  DIM       25
DESCUC06  DIM       25
DESCUC07  DIM       25
DESCUC08  DIM       25
MAGNETSS  DIM       10
USERDF01  DIM       100
USERDF02  DIM       100
USERDF03  DIM       100
USERDF04  DIM       100
USERDF05  DIM       100
USERDF06  DIM       100
USERDF07  DIM       100
USERDF08  DIM       100
USERDF09  DIM       100
USERDF10  DIM       100
MAPLOCKY  DIM       16
MAPLOCCD  DIM       16
CAToa     INIT      "oa"
CATob     INIT      "ob"
CAToc     INIT      "oc"
CATod     INIT      "od"
CAToe     INIT      "od"
CATof     INIT      "of"
CATog     INIT      "og"
CAToh     INIT      "oh"
.
WORKDATE  DATE      8
WORKTIME  DIM       8
.
YELFIELD  DIM       11
.
ENDDWEEK  DATE      8
ROTATION  FORM      2
STRTWEEK  DATE      8
WEEKCYCL  DIM       10
WEEKNUMB  FORM      3
.
.-------------------------------------------------------------------------
PRGID     INIT      "OPRWEB03"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "Theatre List Server"
.-------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      LIST0000   * Theatre List
          GOTO      MAIN1000
.
MAIN1200  CALL      CURANA00   * Current Anaesthetist Patient List
          GOTO      MAIN1000
.
MAIN1300  CALL      CASLST00   * Theatre Case List by Date
          GOTO      MAIN1000
.
MAIN1400  CALL      CURPER00   * I CAR 44973
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          CALL      OPREVT00
.         BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000   * end I CAR 44973
.
MAIN1500  CALL      REALST00   * Reallocated Sessions List
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
.   Update Map Field
.
MAIN1600  CALL      REMOTE00
          GOTO      MAIN1000
.
MAIN1700  CALL      PROLST00   * Prosthetics List
          GOTO      MAIN1000
.

. Shutdown & Exit Server
.==============================
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
          BRANCH    UPDATETY,REMOTE10,REMOTE20
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      UPDMAP00                * Update Map Location
          GOTO      REMOTE90     
.
REMOTE20  CALL      UPDTIM00                * Update Time
          GOTO      REMOTE90
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
.======================================================================
. Update Time
.======================================================================
UPDTIM00  CLOCK     TIME,CTIMEIS
          BRANCH    SETTABLE,UPDTIM10,UPDTIM20
          GOTO      UPDTIM99
.
UPDTIM10  PACK      KEY11,OPDUNQID,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          BRANCH    OVRCD,UPDTIM15
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      UPDTIM15 IF NOT EQUAL
. ?? Update Durations ??
          CALL      STOSRG00
          CALL      UPOPSRG1
.
          PACK      KEY10,OPSGUNID,SP70
          CALL      RDOPDEA3
          IF        OVRCD<>1
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
          GOTO      UPDTIM90
.
UPDTIM15  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No Surgical Team":
                             "</RETURN_VALUE>"
          GOTO      UPDTIM90
.
UPDTIM20  PACK      KEY10,OPDUNQID,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
            CALL      STOARD00
            CALL      UPOPARD1
          ELSE
            CALL      CLOPRARD
            MOVE      OPDUNQID,OPARUNID
            MOVE      USERID,OPARUIAR
            CALL      STOARD00
            CALL      WROPARD1
          ENDIF
.
          PACK      KEY10,OPARUNID,SP70
          CALL      RDOPDEA3
          IF        OVRCD<>1
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
          GOTO      UPDTIM90
.
UPDTIM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Update Complete":
                             "</RETURN_VALUE>"
.
UPDTIM99  RETURN
.-------------------------------------------------------------------------------
. Store Current Time into Surgery Field
.-------------------------------------------------------------------------------
.  1. OPSGTIPS  Time Prep Start (HH:MM:SS)         
.  2. OPSGTIDR  Time of Dressing (HH:MM:SS)        
.  3. OPSGTISS  Time Surgery Started (HH:MM:SS)    
.  4. OPSGTISE  Time Surgery Ended (HH:MM:SS)      
.  5. OPSGUT01  User Defined Time Field 1          
.  6. OPSGUT02  User Defined Time Field 2          
.  7. OPSGUT03  User Defined Time Field 3          
.  8. OPSGUT04  User Defined Time Field 4          
.  9. OPSGUT05  User Defined Time Field 5          
. 10. OPSGUT06  User Defined Time Field 6          
. 11. OPSGUT07  User Defined Time Field 7          
. 12. OPSGUT08  User Defined Time Field 8          
. 13. OPSGUT09  User Defined Time Field 9          
. 14. OPSGUT10  User Defined Time Field 10         
.-------------------------------------------------------------------------------
STOSRG00  PACK      KEY8,SP70
          LOAD      KEY8,SETFIELD,OPSGTIPS,OPSGTIDR,OPSGTISS,OPSGTISE:
                                     OPSGUT01,OPSGUT02,OPSGUT03,OPSGUT04:
                                     OPSGUT05,OPSGUT06,OPSGUT07,OPSGUT08:
                                     OPSGUT09,OPSGUT10
 
          MATCH     SP70,KEY8
          IF        @EQUAL
            STORE     CTIMEIS,SETFIELD,OPSGTIPS,OPSGTIDR,OPSGTISS,OPSGTISE:
                                       OPSGUT01,OPSGUT02,OPSGUT03,OPSGUT04:
                                       OPSGUT05,OPSGUT06,OPSGUT07,OPSGUT08:
                                       OPSGUT09,OPSGUT10
          ENDIF
          RETURN
.
.-------------------------------------------------------------------------------
. Store Current Time into Arrival Field
.-------------------------------------------------------------------------------
.  1. OPARATIM  Arrival Time (HH:MM:SS)            
.  2. OPARTCAL  Time Called For                    
.  3. OPARANAP  Anaesthetic Prep Start (HH:MM:SS)  
.  4. OPARANAS  Anaesthetic Start (HH:MM:SS)       
.  5. OPARANAE  Anaesthetic End (HH:MM:SS)         
.  6. OPARTIRF  Time in Recovery - Front (HH:MM:SS)
.  7. OPARTIRB  Time in Recovery - Back (HH:MM:SS) 
.  8. OPARTIRD  Time in Recovery - Day Procedure   
.  9. OPARTETC  Time Exit Theatre Compl. (HH:MM:SS)
. 10. OPARTEXP  Time Patient Died (HH:MM:SS)       
. 11. OPARTICU  Time Patient Went to ICU (HH:MM:SS)
. 12. OPARTIDP  Ready to Depart Time (HH:MM:SS)    
. 13. OPARUT01  Surgical Time Out (hh:mm:ss)
. 14. OPARUT02  Clinical Review Date (ccyymmdd)
. 15. OPARUT03  Clinical Review Time (hh:mm:ss)
. 16. OPARUT04  User Defined Time Field 4
. 17. OPARUT05  User Defined Time Field 5          
. 18. OPARUT06  Ready for Recovery Time (hh:mm:ss)
. 19. OPARUT07  Ready for Recovery Time (hh:mm:ss) 
. 20. OPARUT08  Ready for Recovery Time (hh:mm:ss) 
. 21. OPARUT09  Ready for Recovery Time (hh:mm:ss) 
. 22. OPARUT10  Ready for Recovery Time (hh:mm:ss) 
. 23. OPARUT11  User Defined Time Field 11         
. 24. OPARUT12  User Defined Time Field 12         
. 25. OPARUT13  Anaesthetic Time Out (hh:mm:ss)
. 26. OPARUT14  User Defined Time Field 14         
. 27. OPARUT15  User Defined Time Field 15         
.-------------------------------------------------------------------------------
STOARD00  PACK      KEY8,SP70
          LOAD      KEY8,SETFIELD,OPARATIM,OPARTCAL,OPARANAP,OPARANAS:
                                     OPARANAE,OPARTIRF,OPARTIRB,OPARTIRD:
                                     OPARTETC,OPARTICU,OPARTIDP:
                                     OPARUT01,OPARUT02,OPARUT03,OPARUT04:
                                     OPARUT05,OPARUT06,OPARUT07,OPARUT08:
                                     OPARUT09,OPARUT10,OPARUT11,OPARUT12:
                                     OPARUT13,OPARUT14,OPARUT15
          MATCH     SP70,KEY8
          IF        @EQUAL
            STORE     CTIMEIS,SETFIELD,OPARATIM,OPARTCAL,OPARANAP,OPARANAS:
                                       OPARANAE,OPARTIRF,OPARTIRB,OPARTIRD:
                                       OPARTETC,OPARTICU,OPARTIDP:
                                       OPARUT01,OPARUT02,OPARUT03,OPARUT04:
                                       OPARUT05,OPARUT06,OPARUT07,OPARUT08:
                                       OPARUT09,OPARUT10,OPARUT11,OPARUT12:
                                       OPARUT13,OPARUT14,OPARUT15
          ENDIF
          RETURN
.-------------------------------------------------------------------------------
. Update Map Field
.-------------------------------------------------------------------------------
UPDMAP00  PACK      KEY16,MDATAKEY,SP70
          CALL      RDOPDED1
          IF        OVRCD=0
            MOVE      MDATAVAL,OPDDDATA
            CALL      UPOPDED1
          ELSE
            UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
            MOVE      MDATAVAL,OPDDDATA
            MOVE      SP70,OPDDSPA 
            CALL      WROPDED1
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Update Complete":
                             "</RETURN_VALUE>"
UPDMAP99  RETURN
.******************************************************************************
.           Output Next Page Based on CGI Parameter nextpage     * I CAR 44973*
.******************************************************************************
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00      * Redirect Parent Content Page
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-----------------------------------------------------------------------------.
.                   Main Action Routine                          * I CAR 44973.
.-----------------------------------------------------------------------------.
.
OPREVT00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      OPREVT40 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Add Referral
          GOTO      OPREVT10 IF EQUAL
.
          GOTO      OPREVT95                * Invalid Update Type
.
OPREVT10  MATCH     SP70,SURGC001
          GOTO      OPREVT40 IF EQUAL
.
          PACK      KEY10,OPDUNQID,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,OPREVT13
.         MATCH     OPDAUNIQ,OPARUNID
.         GOTO      OPREVT13 IF NOT EQUAL
          MOVE      SURGC001,OPARTCAL
          MOVE      USERID,OPARUIAR
          CALL      UPOPARD1
          GOTO      OPREVT40
.
OPREVT13  CALL      CLOPRARD
          MOVE      OPDUNQID,OPARUNID
          MOVE      SURGC001,OPARTCAL
          MOVE      USERID,OPARUIAR
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROPARD1
          TRAPCLR   IO
          BRANCH    OVRCD,OPREVT10
.
OPREVT40  PACK      KEY10,OPARUNID,SP70
          CALL      RDOPDEA3
          IF        OVRCD<>1
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
          MATCH     "1",REDIFLAG
          IF        @EQUAL
            APPEND    "oprweb03.pbl?reportno=3&template=006",REDIRECT
          ELSE
            APPEND    "oprweb03.pbl?reportno=3&template=004",REDIRECT
          ENDIF
.
          APPEND    "&viewtype=",REDIRECT
          APPEND    VIEWTYPE,REDIRECT
          APPEND    "&lastdate=",REDIRECT
          APPEND    LASTDATE,REDIRECT
          APPEND    "&theacode=",REDIRECT
          APPEND    THEACODE,REDIRECT
          APPEND    "&vyearmth=",REDIRECT
          APPEND    VYEARMTH,REDIRECT
          APPEND    "&opdunqid=",REDIRECT
          APPEND    OPDUNQID,REDIRECT
          APPEND    "&listtype=",REDIRECT
          APPEND    LISTTYPE,REDIRECT
          GOTO      OPREVT99
.
OPREVT50  CLEAR     WEBTITLE
          MOVE      "Theatre Case List",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,OPREVT99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      OPREVT99
.
OPREVT95  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREVT99
.
OPREVT99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATDO1A1,"patdo1af" 
          OPEN      PATDO1A2,"patdo1af" 
          OPEN      PATMA1A1,"patma1af" 
          OPEN      PATMX1A1,"patmx1af" 
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATHSPA1,"pathspaf" 
          OPEN      PATMI1A1,"patmi1af" 
          OPEN      PMSVX1A1,"pmsvx1af" 
          OPEN      PATMI1A2,"patmi1af" 
          OPEN      BOKRC1A1,"bokrc1af" 
          OPEN      BOKRC1A6,"bokrc1af" 
.
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATNURS1,"patnursm"
          OPEN      PATALRT1,"patalrtf"
.
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      PATLOCA1,"patlocaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCOMA1,"oprcomaf"        *Theatre session based comments
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRRALA1,"oprralaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSESA4,"oprsesaf"
          OPEN      OPRSESA6,"oprsesaf"
          OPEN      OPRPIMA1,"oprpimaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRDETC1,"oprdetcf"
          OPEN      OPRDEDA1,"oprdedaf"
          OPEN      OPRARDA1,"oprardaf"   
          OPEN      BOKRX1A1,"bokrx1af"  
          OPEN      BOKDIAA1,"bokdiaaf"  
          OPEN      OPRSRGA1,"oprsrgaf" 
          OPEN      OPRRCIA1,"oprrciaf"
          OPEN      OPRWCNA2,"oprwcnaf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
          READ      CONTROLF,FORTY;*55,OPCNAUDM,*61,OPCNAUDS,*111,OPCNCLSU
          READ      CONTROLF,FORTY;*43,OPCNAUDA,OPCNAUDB,*46,OPCNAUDD:
                                   *61,OPCNAUDS,OPCNAUDT
          READ      CONTROLF,FORTY2;*28,OPCNFULL,*241,OPCNSCOM
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND13;*38,OPCNCRRM
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTHCPA1,"mlthcpaf"
            OPEN      MLTHCPA2,"mlthcpaf"
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>Title Given Names
.------------------------------------------------------------
PATNAM00  CLEAR     DISPNAME
...       REP       "' ",PSNAME
          REP       "#" ",PSNAME
...       REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<b>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      "000",TEMPLATE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,DOCTCODE
          MOVE      SP70,ANAECODE
          MOVE      ZERO,VIEWTYPE
          MOVE      ZERO,SHOWORDR
          MOVE      ZERO,SHOWUSED
          MOVE      SP70,VYEARMTH
          MOVE      SP70,THEACODE           * HPS Code Starts Here
          MOVE      SP70,PICOCODE
          MOVE      SP70,LISTTYPE           
          MOVE      SP70,SURGC001           
          MOVE      SP70,UNITCODE
          MOVE      SP70,SURGTYPE
          MOVE      ZERO,SESSBOOK
          MOVE      SP70,OPDUNQID           * HPS Code Ends Here
          MOVE      ZERO,CANCBOOK
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,UPDTTYPE           * I CAR 44973
          MOVE      SP70,NEXTPAGE           * I CAR 44973
          MOVE      SP70,REDIFLAG
          MOVE      SP70,SESSKEY2
          MOVE      ZERO,DISPTEAM
          MOVE      SP70,FILTTPER
          MOVE      ZERO,ACTOPRED
.
          MOVE      ZERO,UPDATETY
          MOVE      ZERO,SETTABLE
          MOVE      ZERO,SETFIELD
          MOVE      ZERO,PAGEVIEW
          MOVE      SP70,MDATAKEY
          MOVE      SP70,MDATAVAL
          MOVE      SP70,EXCLCANC
          MOVE      SP70,EXCLEXIT
          MOVE      SP70,ADMPOINT
          MOVE      SP70,FILTSURG
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,DISPDAYC                *T0846427
          MOVE      ZERO,DAYCMCNT                *T0846427
          MOVE      SP70,WARDCODE
          MOVE      SP70,XTRAFLTR
          MOVE      ZERO,DISPWKNO
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "anaecode=",QRYNAME
          IF        @EQUAL
            PACK      ANAECODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispteam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPTEAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showordr=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SHOWORDR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showused=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SHOWUSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "surgtype=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,SURGTYPE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "sessbook=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SESSBOOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unitcode=",QRYNAME     * HPS Code Starts Here
          IF        @EQUAL
            MOVE      QRYDATA,UNITCODE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "theacode=",QRYNAME   
          IF        @EQUAL
            PACK      THEACODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "picocode=",QRYNAME
          IF        @EQUAL
            PACK      PICOCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "listtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LISTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "surgc001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SURGC001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdunqid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDUNQID
            GOTO      SETPAR99
          ENDIF                             * HPS Code Ends Here
.
          MATCH     "updttype=",QRYNAME     * I CAR 44973
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.                                           * end I CAR 44973
          MATCH     "rediflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskey2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEY2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttper=",QRYNAME
          IF        @EQUAL
            PACK      FILTTPER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pageview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAGEVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "settable=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SETTABLE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setfield=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SETFIELD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdatakey=",QRYNAME
          IF        @EQUAL
            PACK      MDATAKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdataval=",QRYNAME
          IF        @EQUAL
            PACK      MDATAVAL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclcanc=",QRYNAME
          IF        @EQUAL
            PACK      EXCLCANC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclexit=",QRYNAME
          IF        @EQUAL
            PACK      EXCLEXIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admpoint=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,ADMPOINT
            PACK      ADMPOINT,ADMPOINT,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "wardcode=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,WARDCODE
.            PACK      WARDCODE,WARDCODE,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "filtsurg=",QRYNAME
          IF        @EQUAL
            PACK      FILTSURG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispdayc=",QRYNAME                    *T0846427
          IF        @EQUAL
            MOVE      QRYDATA,DISPDAYC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xtrafltr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,XTRAFLTR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispwkno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPWKNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Process Templated Fields
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD99,PROFLD70
.
          GOTO      PROFLD99
.
PROFLD10  CALL      SESL0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
PROFLD21  CALL      DOCF0000
          GOTO      PROFLD99
PROFLD22  CALL      PANA0000
          GOTO      PROFLD99
.
PROFLD30  CALL      CASL0000
          GOTO      PROFLD99
.
PROFLD40  
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      REAL0000
          GOTO      PROFLD99
.
PROFLD52  CALL      REALD000
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.
PROFLD71  CALL      PROL0000
          GOTO      PROFLD99
.
PROFLD72  CALL      SESL0000
          GOTO      PROFLD99
.
PROFLD73  CALL      CASL0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. List Sessions by Date Range
.------------------------------------------------------------
SESL0000  BRANCH    FLDITMNO,SESL0100,SESL0200,SESL0300,SESL0400,SESL0500:
                             SESL0600,SESL0700,SESL0800,SESL0900,SESL1000:
                             SESL1100,SESL1200,SESL1300,SESL1400,SESL1500:
                             SESL1600,SESL1700,SESL1800,SESL1900,SESL2000:
                             SESL2100,SESL2200,SESL2300,SESL2400,SESL2500:
                             SESL2600,SESL2700
.
          GOTO      SESL9999
.
SESL0100  CALL      NEXT0000
          GOTO      SESL9999
.
SESL0200  CALL      PREV0000
          GOTO      SESL9999
.
SESL0300  CALL      CURSTD00
          GOTO      SESL9999
.
SESL0400  CALL      CUREND00
          GOTO      SESL9999
.
SESL0500  CALL      CURYR000
          GOTO      SESL9999
.
SESL0600  CALL      CURMON00
          GOTO      SESL9999
.
SESL0700  CALL      SELV0000
          GOTO      SESL9999
.
SESL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      SESL9999
.
SESL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      SESL9999
.
SESL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      SESL9999
.
SESL1100  CALL      SESLST00
          GOTO      SESL9999
.
SESL1200  WRITE     HTMLFILE;SHOWUSED;
          GOTO      SESL9999
.
SESL1300  WRITE     HTMLFILE;SHOWORDR;
          GOTO      SESL9999
.
SESL1400  CALL      SESTAA00
          GOTO      SESL9999
.
SESL1500  MOVE      "ST",CATEGORY       
          MOVE      UNITCODE,CODE        
          CALL      CODITM00
          GOTO      SESL9999
.
SESL1600  MOVE      ZERO,ACTOPRED
          CALL      SESUNT00               
          GOTO      SESL9999              
.
SESL1700  MOVE      "YD",CATEGORY       
          MOVE      SURGTYPE,CODE        
          CALL      CODITM00
          GOTO      SESL9999
.
SESL1800  WRITE     HTMLFILE;DISPTEAM;
          GOTO      SESL9999
.
SESL1900  MOVE      ONE,ACTOPRED
          CALL      SESUNT00
          GOTO      SESL9999
.
SESL2000  MOVE      SURGTYPE,LOCATION
          CALL      RCLS0000           * Check if recovery is closed
          GOTO      SESL9999
.
SESL2100  WRITE     HTMLFILE;"<option value=#"0#"";
          COMPARE   ZERO,SESSBOOK
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;*+,">All</option>"
.
          WRITE     HTMLFILE;"<option value=#"1#"";
          COMPARE   ONE,SESSBOOK
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;*+,">Sessions with bookings</option>"
.
          WRITE     HTMLFILE;"<option value=#"2#"";
          COMPARE   TWO,SESSBOOK
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;*+,">Sessions with no bookings</option>"
.
          WRITE     HTMLFILE;"<option value=#"3#"";
          COMPARE   THREE,SESSBOOK
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;*+,">Cancelled sessions</option>"
.
          WRITE     HTMLFILE;"<option value=#"4#"";
          COMPARE   FOUR,SESSBOOK
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;*+,">All sessions excluding cancelled</option>"
.
          GOTO      SESL9999
.
SESL2200  CALL      TDCML000               *Output current date      *T0846427
          GOTO      SESL9999               *comment line1
.
SESL2300  WRITE     HTMLFILE;DISPDAYC;     *Display Day comments     *T0846427
          GOTO      SESL9999               *flag
.
SESL2400  CALL      TDCMC000               *Current date comment     *T0846427
          GOTO      SESL9999               *lines count
.
SESL2500  WRITE     HTMLFILE;XTRAFLTR;     *Display Extra fields  
          GOTO      SESL9999               *flag
.
SESL2600  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      CASL9999
.
SESL2700  WRITE     HTMLFILE;DISPWKNO;
          GOTO      CASL9999
.
SESL9999  RETURN
.
.------------------------------------------------------------------------------
. List current date theatre comments for line 1                      *T0846427
.------------------------------------------------------------------------------
TDCML000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCML999 IF NOT EQUAL    *No, exit
.
          MOVE      SP70,OPCMTEXT
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATD,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATD
.
          PACK      KEY25,CURRDATD,SP70
          CALL      RSOPCOM1
TDCML100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCML999
.
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital
          GOTO      TDCML100 IF NOT EQUAL
.
          MATCH     CURRDATD,OPCMDATE        * same date 
          GOTO      TDCML999 IF NOT EQUAL
.
          COMPARE   ONE,OPCMLINE             *First line?
          GOTO      TDCML999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPCMTEXT;       *Output first line
          GOTO      TDCML999
.
TDCML999  RETURN
.
.------------------------------------------------------------------------------
. Count current date theatre comments                                *T0846427
.------------------------------------------------------------------------------
TDCMC000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCMC999 IF NOT EQUAL    *No, exit
.
          MOVE      ZERO,DAYCMCNT            *Current date comment line count 
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATD,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATD
.
          PACK      KEY25,CURRDATD,SP70
          CALL      RSOPCOM1
TDCMC100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCMC300
.
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital
          GOTO      TDCMC100 IF NOT EQUAL          
.
          MATCH     CURRDATD,OPCMDATE
          GOTO      TDCMC300 IF NOT EQUAL
.
          ADD       ONE,DAYCMCNT
          GOTO      TDCMC100
.
TDCMC300  WRITE     HTMLFILE;DAYCMCNT;       *Output line count
          GOTO      TDCMC999
.
TDCMC999  RETURN
.
.------------------------------------------------------------
. Session List 
.------------------------------------------------------------
LIST0000  MATCH     SP70,SURGTYPE
          IF        @EQUAL
            MOVE      WBSEDGSI,SURGTYPE
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          STRIP     MTHNAM
          CLEAR     WEBTITLE
.
          MATCH     "5",TEMPLATE
          IF        @EQUAL
            APPEND    "Day Sessions for ",WEBTITLE
          ELSE
            MATCH     "005",TEMPLATE
            IF        @EQUAL
              APPEND    "Day Sessions for ",WEBTITLE
            ELSE
              APPEND    "Theatre Sessions for ",WEBTITLE
            ENDIF
          ENDIF
.          APPEND    CDAY,WEBTITLE      * HPSI
.          APPEND    SP1,WEBTITLE       * HPSI
          APPEND    MTHNAM,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,LIST9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
LIST9999  RETURN
.------------------------------------------------------------
. Session List 
.------------------------------------------------------------
SESLST00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      SESTOP00   * Top of Session Table
          MOVE      ZERO,F3
          IF        SHOWORDR=0
            PACK      KEY22,WBSEHOSP,FRSTDATE,SP70    * By Date by Time 
            CALL      RSOPSES1
          ELSE
            PACK      KEY28,WBSEHOSP,FRSTDATE,SP70    * By Date by Theatre
            CALL      RSOPSES4
          ENDIF
SESLST10  IF        SHOWORDR=0
            CALL      RKOPSES1               * By Date by Time
          ELSE
            CALL      RKOPSES4               * By Date by Theatre
          ENDIF
          BRANCH    OVRCD,SESLST90
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      SESLST90 IF NOT EQUAL 
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      SESLST90 IF LESS
.
          CALL      SESDET00    * Get Display Details for Session
          CALL      CALBAR00     * Calculate Bar
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,DAYNAM3,"</td>":
                             "<td>",OPRMDESC,"</td>":
                             "<td align=center nowrap>":
                             "<a href='",LINKPRG,".pbl?":
                             "reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&sesskeys=",OPSEDATE,OPSETIME,OPSECLIN,"'>":
                             OPSETIME,"</a></td>":
                             "<td>",SURFNAME,"</td>":
                             "<td>",ANAFNAME,"</td>":
                             "<td align=right>",OPSEDURA,"</td>":
                             "<td align=left nowrap ":
                             "WIDTH=100 HEIGHT=10 BGCOLOR=##000080>":
                             "<IMG SRC=",BARIMAGE,SP1:
                             FILHIGHT,SP1,FILWIDTH:
                             " ALIGN=ABSBOTTOM></TD></TR>"
          GOTO      SESLST10
.
SESLST90  
SESLST99  RETURN
.------------------------------------------------------------
. Calculate Bar for Session
.------------------------------------------------------------
CALBAR00  MOVE      "../images/oprweb03_nm.gif",BARIMAGE
          MOVE      "10",FILHIGH
          IF        SHOWUSED=0
            ASSIGN    OPSETIMB/OPSEDURA*100.0,SESSFILL
            ASSIGN    OPSETIMB/OPSEDURA*120,F3
          ENDIF
          IF        SHOWUSED=1
            ASSIGN    OPSEACTD/OPSEDURA*100.0,SESSFILL
            ASSIGN    OPSEACTD/OPSEDURA*120,F3
          ENDIF
          IF        SHOWUSED=2
            ASSIGN    OPSEACTD/OPSEDURA*100.0,SESSFILL
            ASSIGN    (OPSEACTD-OPSETIMB)/2,F3
            MOVE      "../images/oprweb03_ot.gif",BARIMAGE
            MOVE      F3,OPSEDURA   * If Showing Overtime then Show Minutes Over
          ENDIF
          IF        F3>120
            MOVE      "../images/oprweb03_ot.gif",BARIMAGE
            MOVE      "120",F3
          ENDIF
          IF        F3<1
            MOVE      ONE,F3
            MOVE      "1",FILHIGH
          ENDIF
          MOVE      F3,KEY3
          MOVE      F3,BARWIDTH
          SQUEEZE   KEY3
          CLEAR     FILWIDTH
          APPEND    "WIDTH=",FILWIDTH
          APPEND    KEY3,FILWIDTH
          RESET     FILWIDTH
.
          MOVE      FILHIGH,KEY3
          SQUEEZE   KEY3
          CLEAR     FILHIGHT
          APPEND    "HEIGHT=",FILHIGHT
          APPEND    KEY3,FILHIGHT
          RESET     FILHIGHT
          RETURN
.
.------------------------------------------------------------
. Top of Session List Table
.------------------------------------------------------------
SESTOP00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          WRITE    HTMLFILE;"<tr>":
                              "<td class=HeadingCell>Day</td>":
                              "<td class=HeadingCell>Theatre</TD>":
                              "<td class=HeadingCell align=center>Start</td>":
                              "<td class=HeadingCell>Surgeon</TD>":
                              "<td class=HeadingCell>Anaesthetist</td>";
          IF        SHOWUSED=0
            WRITE    HTMLFILE;"<td class=HeadingCell align=right>Time</td>":
                              "<td class=HeadingCell>Bookings</td></tr>"
          ENDIF
          IF        SHOWUSED=1
            WRITE    HTMLFILE;"<td class=HeadingCell align=right>Time</td>":
                              "<td class=HeadingCell>Usage</td></tr>"
          ENDIF
          IF        SHOWUSED=2
            WRITE    HTMLFILE;"<td class=HeadingCell align=right>Overtime</td>":
                              "<td class=HeadingCell>OverTime</td></tr>"
          ENDIF
          RETURN
.------------------------------------------------------------
. Get Details for Session
.------------------------------------------------------------
SESDET00  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,SESSDATE
.
          MOVE      OPSECLIN,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
          ENDIF
.
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE 
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,SURFNAME
          ELSE
            MOVE      "&nbsp;",SURFNAME
          ENDIF
.
          MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE 
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,ANAFNAME
          ELSE
            MOVE      "&nbsp;",ANAFNAME
          ENDIF
.
          MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      OPRMDESC,NAME35
            CALL      NAMSTR00
            RESET     DISPNAME
            PACK      OPRMDESC,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",OPRMDESC
          ENDIF
.
          MOVE      SP70,STYPDES
          PACK      KEY5,CODEST,OPSETYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,STYPDES
          ENDIF
          RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",THEACODE           * HPS Code Starts Here
          REP       " +",LISTTYPE  
          REP       " +",UNITCODE           * HPS Code Ends Here
          REP       " +",SURGTYPE           
          REP       " +",DOCTCODE           
          REP       " +",ANAECODE           
          REP       " +",FILTSURG
          REP       " +",PICOCODE
          REP       " +",ADMPOINT           
          REP       " +",WARDCODE            
.
          WRITE     HTMLFILE;"oprweb03.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&theacode=",THEACODE:    * HPS Code Starts Here
                             "&listtype=",LISTTYPE:
                             "&unitcode=",UNITCODE:   
                             "&surgtype=",SURGTYPE:   
                             "&sessbook=",SESSBOOK:   
                             "&dispteam=",DISPTEAM:
                             "&doctcode=",DOCTCODE:
                             "&anaecode=",ANAECODE:
                             "&filtsurg=",FILTSURG:
                             "&exclcanc=",EXCLCANC:
                             "&exclexit=",EXCLEXIT:
                             "&picocode=",PICOCODE:
                             "&deftview=",DEFTVIEW:
                             "&admpoint=",ADMPOINT:   
                             "&wardcode=",WARDCODE:   
                             "&xtrafltr=",XTRAFLTR:
                             "&dispdayc=",DISPDAYC:
                             "&dispwkno=",DISPWKNO;
.
          REP       "+ ",THEACODE
          REP       "+ ",LISTTYPE           * HPS Code Ends Here     
          REP       "+ ",UNITCODE
          REP       "+ ",SURGTYPE
          REP       "+ ",DOCTCODE           
          REP       "+ ",ANAECODE           
          REP       "+ ",FILTSURG
          REP       "+ ",PICOCODE
          REP       "+ ",ADMPOINT
          REP       "+ ",WARDCODE
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",THEACODE           * HPS Code Starts Here
          REP       " +",LISTTYPE
          REP       " +",UNITCODE           * HPS Code Ends Here
          REP       " +",SURGTYPE           
          REP       " +",DOCTCODE           
          REP       " +",ANAECODE           
          REP       " +",FILTSURG
          REP       " +",PICOCODE
          REP       " +",ADMPOINT           
          REP       " +",WARDCODE           
.
          WRITE     HTMLFILE;"oprweb03.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:                             
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&theacode=",THEACODE:   * HPS Code Starts Here
                             "&listtype=",LISTTYPE:
                             "&unitcode=",UNITCODE:
                             "&surgtype=",SURGTYPE:
                             "&sessbook=",SESSBOOK:
                             "&dispteam=",DISPTEAM:
                             "&doctcode=",DOCTCODE:
                             "&anaecode=",ANAECODE:
                             "&filtsurg=",FILTSURG:
                             "&exclcanc=",EXCLCANC:
                             "&exclexit=",EXCLEXIT:
                             "&picocode=",PICOCODE:
                             "&deftview=",DEFTVIEW:
                             "&admpoint=",ADMPOINT:
                             "&wardcode=",WARDCODE:
                             "&xtrafltr=",XTRAFLTR:
                             "&dispdayc=",DISPDAYC:
                             "&dispwkno=",DISPWKNO;
.
          REP       "+ ",UNITCODE
          REP       "+ ",SURGTYPE
          REP       "+ ",THEACODE
          REP       "+ ",LISTTYPE           * HPS Code Ends Here
          REP       "+ ",DOCTCODE           
          REP       "+ ",ANAECODE           
          REP       "+ ",FILTSURG
          REP       "+ ",PICOCODE
          REP       "+ ",ADMPOINT
          REP       "+ ",WARDCODE
.                                                           
PREV9999  RETURN
.------------------------------------------------------------
. Anaesthetist Current Patients
.------------------------------------------------------------
CURANA00  MATCH     SP70,WBSEDOC
          GOTO      CURANA95 IF EQUAL
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            PACK      KEY6,DOCTCODE,SP70
          ELSE
            MOVE      WBSEDOC,KEY6
          ENDIF
          CALL      RDDOCT1
          BRANCH    OVRCD,CURANA95
.
          MOVE      DTITL,FMTTITLE 
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MATCH     SP70,FRSTDATE
          CLEAR     WEBTITLE
          APPEND    "Current Patient for ",WEBTITLE
          APPEND    DOCFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,LIST9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      CURANA99
.
CURANA95  MOVE      "INVALID DOCTOR SECURITY",WEBTITLE
          CALL      WEBERR00
.
CURANA99  RETURN
.------------------------------------------------------------
. List Current Admission for a Anaesthetist
.------------------------------------------------------------
PANA0000  BRANCH    FLDITMNO,PANA0100
          GOTO      PANA9999
.
PANA0100  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      CURTAB00
          GOTO      PANA9999
.
PANA9999  RETURN
.------------------------------------------------------------
. List Current Admission for a Anaesthetist
.------------------------------------------------------------
CURTAB00  WRITE     HTMLFILE;"<tr>":
                                "<td class=HeadingCell align=center colspan=6>":
                                "Current Patients for ",DOCFNAME:
                                "</td></tr>":
                             "<tr>":
                                "<td class=HeadingCell>Name</td>":
                                "<td class=HeadingCell>Ward/Bed</td>":
                                "<td class=HeadingCell>Adm. Date</td>": 
                                "<td class=HeadingCell>Sex</td>": 
                                "<td class=HeadingCell>Age</td>"; 
          IF        PTCNHDPS=1
             WRITE     HTMLFILE;"<td class=HeadingCell>":
                                "Reason For Admission</td></tr>"
          ELSE
             WRITE     HTMLFILE;"<td class=HeadingCell>Diagnosis</td></tr>"
          ENDIF
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
CURTAB10  CALL      RDKMISS2
          BRANCH    OVRCD,CURTAB99
          COMPARE   TWO,ASTAT
          GOTO      CURTAB99 IF NOT EQUAL
.
          PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
CURTAB20  CALL      RKOPDEA2
          BRANCH    OVRCD,CURTAB10
          MATCH     DAADMNO,OPDAADMN
          GOTO      CURTAB10 IF NOT EQUAL
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,CURTAB20
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,OPSEANAE
            GOTO      CURTAB20 IF NOT EQUAL
          ELSE
            MATCH     WBSEDOC,OPSEANAE
            GOTO      CURTAB20 IF NOT EQUAL
          ENDIF
.
          MOVE      AURNO,URNUMBER
          CALL      GETPAT00
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             "<img src=../images/oprweb03-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             "  ",PATFNAME,"  (",AURNO,")</td>":
                             "<td align=center>",AWARD,"/",ABED,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,CCENT,CYEAR,"</td>": 
                             "<td>",DISPSEX,"</td>": 
                             "<td align=center>",PSAGEYRS,"</td>":
                             "<td>&nbsp;",ADIAG1,ADIAG2,"</td></tr>"
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          GOTO      CURTAB10
.
CURTAB99  RETURN
.------------------------------------------------------------
. Get Patient Details
.------------------------------------------------------------
GETPAT00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE.
.
          CALL      PATNAM00
.
          RETURN
.------------------------------------------------------------
. Session List 
.------------------------------------------------------------
SESTAA00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,F3
          PACK      KEY22,WBSEHOSP,FRSTDATE,SP70    * By Date by Time 
          CALL      RSOPSES1
SESTAA10  CALL      RKOPSES1               * By Date by Time
          BRANCH    OVRCD,SESTAA90
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      SESTAA90 IF NOT EQUAL
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      SESTAA90 IF LESS
.
          COMPARE   ZERO,OPSESTAT          * Do not display cancelled sessions
          GOTO      SESTAA10 IF EQUAL 
.
          CALL      GETSES00  * Get Display Details for Session
          CALL      CALBAR00  * Calculate Bar
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      SESSKEYS,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
          CALL      WKCN0000                * Week cycle number
.
          CALL      ADJUST00                * Check Adjust time session
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPSDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,OPSETIME,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",LINKPRG:
                                ".pbl?reportno=",LINKREP:
                                "&template=",LINKTEM:
                                "&sesskeys=",SESSKEYS,"#",":
                             "#"",OPRMDESC,"#",":
                             "#"",OPSEDATE,OPSETIME,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",ANAFNAME,"#",":
                             "#"",OPSEDURA,"#",":
                             "#"",OPSETIMB,"#",":
                             "#"",OPSEACTD,"#",":
                             "#"",BARWIDTH,"#",":
                             "#"",DAYNAM3,"#",":
                             "#"",OPSESTAT,"#",":          * 10
                             "#"",WEEKCYCL,"#",":
                             "#"",DISPSDAT,WEEKCYCL,"#",":
                             "#"",ADJUSFLG,"#");"
          GOTO      SESTAA10
.
SESTAA90  
.
SESTAA99  RETURN
.******************************************************************************
.*                     Theatre List by Unit        HPS CODE Starts Here       *
.******************************************************************************
SESUNT00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,F3
          PACK      KEY22,WBSEHOSP,FRSTDATE,SP70     * By Date by Time 
          CALL      RSOPSES1
SESUNT10  CALL      RKOPSES1                * By Date by Time
          BRANCH    OVRCD,SESUNT99
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      SESUNT99 IF NOT EQUAL
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      SESUNT99 IF LESS
.
          MATCH     SP70,UNITCODE
          GOTO      SESUNT20 IF EQUAL
          MATCH     UNITCODE,OPSETYPE
          GOTO      SESUNT10 IF NOT EQUAL
.
SESUNT20  MATCH     SP70,SURGTYPE           * Check Surgery Type Filter
          GOTO      SESUNT30 IF EQUAL       * Blank, list all types
          MATCH     "ALL",SURGTYPE          * Check Surgery Type Filter
          GOTO      SESUNT30 IF EQUAL       * List all Types
          MATCH     SURGTYPE,OPSEDGSI
          GOTO      SESUNT10 IF NOT EQUAL
.
SESUNT30  CALL      GETSES00  * Get Display Details for Session
          CALL      SESCNT00  * Count Patients in Session
.
          BRANCH    SESSBOOK,SESUNT31,SESUNT32,SESUNT33,SESUNT34
.
. All 
          GOTO      SESUNT35
.
. Sessions with bookings
SESUNT31  IF        COUNT > 0
            GOTO      SESUNT35
          ENDIF
.
          GOTO      SESUNT10
.
. Sessions with no bookings
SESUNT32  IF        COUNT > 0
            GOTO      SESUNT10
          ENDIF
.
          GOTO      SESUNT35
.
. Cancelled sessions
SESUNT33  COMPARE   ZERO,OPSESTAT
          IF        @EQUAL
            GOTO      SESUNT35
          ENDIF
.
          GOTO      SESUNT10
.
. All sessions excluding cancelled
SESUNT34  COMPARE   ZERO,OPSESTAT
          IF        @EQUAL
            GOTO      SESUNT10
          ENDIF
.
SESUNT35  CALL      CALBAR00  * Calculate Bar
.
          MOVE      OPSETHET,OPERROOM
          MOVE      OPSETHET,KEY80
          COMPARE   ZERO,OPSESTAT
          GOTO      SESUNT40 IF NOT EQUAL
.
          CLEAR     OPERROOM
          APPEND    "<font color=red>",OPERROOM
          APPEND    OPSETHET,OPERROOM
          APPEND    "</font>",OPERROOM
          RESET     OPERROOM
.
          PACK      KEY5,ANSO,ANSC,OPSECANC
          CALL      RDCODE1
          BRANCH    OVRCD,SESUNT40
          CLEAR     KEY80
          APPEND    OPERROOM,KEY80
          APPEND    "- C - ",KEY80
          APPEND    TDESC,KEY80
          RESET     KEY80
          MOVE      SP70,TDESC
.
SESUNT40  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      SESSKEYS,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
          MOVE      SP70,DIM20A
          MATCH     SP70,OPSEDELA
          IF        !@EQUAL
            PACK      KEY5,ANSO,ANSD,OPSEDELA,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DIM20A
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM20B
          MATCH     SP70,OPSEOVER
          IF        !@EQUAL
            PACK      KEY5,ANSO,ANSO,OPSEOVER,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DIM20B
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM19
          MATCH     SP70,OPSESTYP
          GOTO      SESUNT50 IF EQUAL
          MOVE      "TU",CATEGORY           * Theatre Description
          PACK      KEY5,CATEGORY,OPSESTYP,SP70
          CALL      RDCODE1
          MOVE      TDESC,DIM19
.
SESUNT50  MATCH     SP70,OPSETYPE
          GOTO      SESUNT60 IF EQUAL
          MOVE      "ST",CATEGORY           * Theatre Description
          PACK      KEY5,CATEGORY,OPSETYPE,SP70
          CALL      RDCODE1
.
SESUNT60  ASSIGN    OPSETIMB,PERSOVER
          DIV       OPSEDURA,PERSOVER       * Calc % Over
          MULT      HUNDRED,PERSOVER
          SUB       HUNDRED,PERSOVER
          IF        PERSOVER < 0
            MOVE      ZERO,PERSOVER
          ENDIF
          MOVE      PERSOVER,F4
.
          IF        OPCNCLSU=0
            MOVE      OPSECLIN,KEY6
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDESC,SURFNAME
            ENDIF
          ENDIF
.
          CALL      ADJUST00                   * Check Adjust time session
.
          CALL      WKCN0000                * Week cycle number
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPSDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,OPSETIME,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",LINKPRG:
                                ".pbl?reportno=",LINKREP:
                                "&template=",LINKTEM:
                                "&sesskeys=",SESSKEYS:
                                "&dispteam=",DISPTEAM,"#",":
                             "#"",OPERROOM,"#",":
                             "#"",OPSEDATE,OPSETIME,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",ANAFNAME,"#",":
                             "#"",OPSEDURA,"#",":
                             "#"",OPSETIMB,"#",";
.
.         IF        ACTOPRED=ONE
.           IF        OPSEACTD > ZERO
.             WRITE     HTMLFILE;"#"<font color=red>",OPSEACTD,"</font>#",";
.           ELSE
.             WRITE     HTMLFILE;"#"",OPSEACTD,"#",";
.           ENDIF
.         ELSE
.             WRITE     HTMLFILE;"#"",OPSEACTD,"#",";
.         ENDIF
.
          IF        ACTOPRED=ONE
            MATCH     SP70,OPSEACDS
            IF        !@EQUAL
              MATCH     SP70,OPSEACDE
              IF        !@EQUAL 
                WRITE     HTMLFILE;"#"<font color=red>",OPSEACTD,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",OPSEACTD,"#",";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"",OPSEACTD,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",OPSEACTD,"#",";  
          ENDIF
.
          WRITE     HTMLFILE;"#"",BARWIDTH,"#",":
                             "#"",DAYNAM3,"#",":
                             "#"",TDESC,"#",":
                             "#"",F4,"%","#",":
                             "#"",COUNT,"#",":
                             "#"",DIM19,"#",":
                             "#"",KEY80,"#",":
                             "#"",OPSESTAT,"#",":
                             "#"",OPSEFIND,OPSEFINT,"#",":
                             "#"",OPSEACDS,OPSEACTS,"#",":
                             "#"",OPSEDELA,"#",":
                             "#"",DIM20A,"#",":
                             "#"",OPSEACDE,OPSEACTE,"#",":
                             "#"",OPSEOVER,"#",":
                             "#"",DIM20B,"#",":
                             "#"",ADJUSFLG,"#",":
                             "#"",WEEKCYCL,"#",":
                             "#"",DISPSDAT,WEEKCYCL,"#");"
          GOTO      SESUNT10
.
SESUNT99  RETURN                            * HPS Code Ends Here
.
.******************************************************************************
. Check if there is adjustment time for a session
.******************************************************************************
ADJUST00  MOVE      SP70,ADJUSFLG
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,ZERO,SP70
          CALL      RSOPDEA1                * Calculate No of Patients
ADJUST10  CALL      RKOPDEA1
          BRANCH    OVRCD,ADJUST99
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      ADJUST99 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE
          GOTO      ADJUST99 IF NOT EQUAL
          MATCH     OPDATIME,OPSETIME
          GOTO      ADJUST99 IF NOT EQUAL
          MATCH     OPDACLIN,OPSECLIN
          GOTO      ADJUST99 IF NOT EQUAL
          COMPARE   "3",OPDASTAT
          GOTO      ADJUST10 IF EQUAL
.
          MATCH     "  1",OPDACASE
          GOTO      ADJUST10 IF NOT EQUAL     * Not a first case
.
          MATCH     OPDATIME,OPDAEXPS
          IF        !@EQUAL
            MOVE      "AdjustTime",ADJUSFLG          * Adjustment flag
          ENDIF
ADJUST99  RETURN
+
.******************************************************************************
.*                     Get Theatre Session Details (fromatted)                *
.******************************************************************************
GETSES00  MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1                   * get aneasthetist first
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,ANAFNAME
          ELSE
            MOVE      "&nbsp;",ANAFNAME
          ENDIF
.                                             * now get doctor details,  
.                                             * resolve true doctor code.
          MOVE      OPSECLIN,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
            MOVE      OPCLDOCT,_SAVDOCT       * save surgeon code
          ELSE
            MOVE      OPSECLIN,_SAVDOCT       
          ENDIF
.
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,SURFNAME
          ELSE
            MOVE      "&nbsp;",SURFNAME
            MOVE      OPCLDESC,SURFNAME
          ENDIF
.
          MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      OPRMDESC,NAME35
            CALL      NAMSTR00
            RESET     DISPNAME
            PACK      OPRMDESC,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",OPRMDESC
          ENDIF
.
          MOVE      SP70,STYPDES
          PACK      KEY5,CODEST,OPSETYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,STYPDES
          ENDIF
.
GETSES99  RETURN
.
SESCNT00  MOVE      ZERO,COUNT              * HPS Code Starts Here
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,ZERO,SP70
          CALL      RSOPDEA1                * Calculate No of Patients
SESCNT10  CALL      RKOPDEA1
          BRANCH    OVRCD,SESCNT99
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      SESCNT99 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE 
          GOTO      SESCNT99 IF NOT EQUAL
          MATCH     OPDATIME,OPSETIME
          GOTO      SESCNT99 IF NOT EQUAL
          MATCH     OPDACLIN,OPSECLIN
          GOTO      SESCNT99 IF NOT EQUAL
          COMPARE   "3",OPDASTAT
          GOTO      SESCNT10 IF EQUAL
          ADD       ONE,COUNT
          GOTO      SESCNT10                  * HPS Code Ends Here
SESCNT99  RETURN
.
.------------------------------------------------------------
. Theatre Case List 
.------------------------------------------------------------
CASLST00  MATCH     SP70,SURGTYPE
          IF        @EQUAL
            MOVE      WBSEDGSI,SURGTYPE
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Theatre Case List",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,CASLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
CASLST99  RETURN
.
.------------------------------------------------------------
. List Sessions by Date Range
.------------------------------------------------------------
CASL0000  BRANCH    FLDITMNO,CASL0100,CASL0200,CASL0300,CASL0400,CASL0500:
                             CASL0600,CASL0700,CASL0800,CASL0900,CASL1000:
                             CASL1100,CASL1200,CASL1300,CASL1400,CASL1500:
                             CASL1600,CASL1700,CASL1800,CASL1900,CASL2000:
                             CASL2100,CASL2200,CASL2300,CASL2400,CASL2500:
                             CASL2600,CASL2700,CASL2800,CASL2900,CASL3000:
                             CASL3100,CASL3200,CASL3300
.     
          GOTO      CASL9999 * harmless fall-through 
.     
CASL0100  CALL      NEXT0000
          GOTO      CASL9999
.
CASL0200  CALL      PREV0000
          GOTO      CASL9999
.
CASL0300  CALL      CURSTD00
          GOTO      CASL9999
.
CASL0400  CALL      CUREND00
          GOTO      CASL9999
.
CASL0500  CALL      CURYR000
          GOTO      CASL9999
.
CASL0600  CALL      CURMON00
          GOTO      CASL9999
.
CASL0700  CALL      SELV0000
          GOTO      CASL9999
.
CASL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      CASL9999
.
CASL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      CASL9999
.
CASL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CASL9999
.
CASL1100  CALL      CASTAB00
          GOTO      CASL9999
.
CASL1200  MOVE      ZERO,SHOWMAP
          CALL      CURTHE00                * HPS Code Starts Here
          GOTO      CASL9999
.
CASL1300  MOVE      ZERO,SHOCNSNT           * don't use Consent
          CALL      THETAB00
          GOTO      CASL9999   
.    
CASL1400  CALL      THEATR00           
          GOTO      CASL9999
.
CASL1500  CALL      LISTCM00
          GOTO      CASL9999                * HPS Code Ends Here
.
CASL1600  CALL      PATLST00
          GOTO      CASL9999
.
CASL1700  MOVE      ONE,CANCBOOK
          CALL      CASTAB00
          GOTO      CASL9999
.
CASL1800  MOVE      "YD",CATEGORY
          MOVE      SURGTYPE,CODE
          CALL      CODITM00
          GOTO      CASL9999
.
CASL1900  MOVE      ONE,SHOCNSNT            * use Consent
          CALL      THETAB00
          GOTO      CASL9999   
.
CASL2000  CALL      DOCSEL00                * build doctor selection list
          GOTO      CASL9999   
.
CASL2100  MOVE      "SP",CATEGORY           * Time period filter
          MOVE      FILTTPER,CODE
          CALL      CODITM00
          GOTO      CASL9999   
.
CASL2200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,CASL9999
          PACK      KEY6,WBSEHOSP,SURGTYPE
          REP       " +",KEY6
          BRANCH    F1,CASL2210,CASL2220
.
          WRITE     HTMLFILE;PAGEVIEW;           * Web User Hospital Code
          GOTO      CASL9999
.
CASL2210  WRITE     HTMLFILE;KEY6;               * Web User Hospital Code
          GOTO      CASL9999
.
CASL2220  WRITE     HTMLFILE;KEY6,PAGEVIEW;      * Web User Hospital Code
          GOTO      CASL9999
.
CASL2300  MOVE      ONE,SHOWMAP
          CALL      CURTHE00
          GOTO      CASL9999
.
CASL2400  MOVE      FILTSURG,DOCTCODE   * Doctor Code
          CALL      DOCDET00
          GOTO      CASL9999
.
CASL2500  WRITE     HTMLFILE;EXCLCANC;
          GOTO      CASL9999
.
CASL2600  CALL      ALLTHE00
          GOTO      CASL9999
.
CASL2700  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      CASL9999
.
CASL2800  CALL      MAPTHE00
          GOTO      CASL9999
.
CASL2900  MOVE      SURGTYPE,LOCATION
          CALL      RCLS0000           * Check if recovery is closed
          GOTO      CASL9999
.
CASL3000  UNPACK    DIM127,D1,FLDITEM,DIM127               *T0846427-start      
          MOVE      FLDITEM,FLDITMNO
          CALL      SESL0000                                         
          GOTO      CASL9999                               *T0846427-end
.
CASL3100  WRITE     HTMLFILE;EXCLEXIT;
          GOTO      CASL9999
.
CASL3200  MOVE      "ap",CATEGORY
          MOVE      ADMPOINT,CODE
          CALL      CODITM00
          GOTO      CASL9999
.
CASL3300  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      CASL9999
.
CASL9999  RETURN
.------------------------------------------------------------
.               Rotuine for Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.    if we have a bed number we have passed all the ward master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.    write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.----------------------------------------------------------------------
. Case List by Date Range
.----------------------------------------------------------------------
CASTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
CASTAB10  CALL      RKOPDEA1
          BRANCH    OVRCD,CASTAB90
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      CASTAB90 IF NOT EQUAL
.
          MATCH     OPDADATE,LASTDATE
          GOTO      CASTAB90 IF LESS
.
          COMPARE   ONE,CANCBOOK 
          IF        @EQUAL
            COMPARE   THREE,OPDASTAT          * dont include cancelled bookings
            GOTO      CASTAB10 IF EQUAL
          ENDIF
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,CASTAB10
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      CASTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,SURGTYPE           * Check Surgery Type Filter
          GOTO      CASTAB12 IF EQUAL       * Blank, list all types
          MATCH     "ALL",SURGTYPE          * Check Surgery Type Filter
          GOTO      CASTAB12 IF EQUAL       * List all types
          MATCH     OPSEDGSI,SURGTYPE       * Match Filter value
          GOTO      CASTAB10 IF NOT EQUAL   * No match, get next record
.
CASTAB12  CALL      GETSES00
          CALL      CASDET00
.
.                                           * set up Alerts Column    *I-204622
          CALL      LSTALR00                * Patient Alerts (in LSTALERT.PBL)
          STRIP     ALRTIMGE
          STRIP     ALRTIMG2
          STRIP     ALRTIMG3
          STRIP     ALRTIMG4
          PACK      ALRTIMGT,ALRTIMGE,ALRTIMG2,ALRTIMG3,ALRTIMG4,SP70
.
          MATCH     SP70,ALRTIMGT           * <= returned from LSTALERT.PBL
          IF        @EQUAL
            MOVE      "&nbsp;",DIM200C
          ELSE
            REP       " +",ALRTLINK
            CLEAR     DIM200C
            APPEND    "<a href=",DIM200C
            APPEND    ALRTLINK,DIM200C
            APPEND    ">",DIM200C
            APPEND    ALRTIMGT,DIM200C
            APPEND    "</a>",DIM200C
            RESET     DIM200C
          ENDIF
          STRIP     DIM200C                 *                   end   *I-204622
.
          MOVE      OPRMDESC,OPERROOM
          MATCH     SP70,OPDATHET
          GOTO      CASTAB15 IF EQUAL
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     OPERROOM
            APPEND    "<font color=red>",OPERROOM
            APPEND    OPRMDESC,OPERROOM
            APPEND    "</font>",OPERROOM
            RESET     OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.
CASTAB15  PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE
          REP       " +",CASEKEYS
          CALL      PATNAM00
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",CASEKEYS,"#",":
                             "#"",OPERROOM,"#",":
                             "#"",OPDADATE,OPDAEXPS,"#",":
                             "#"",OPDAEXPD,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",ANAFNAME,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",AURNO,"#",":
                             "#"",OPDADES1,OPDADES2,OPDADES3,"#",":
                             "#"",TDESC,"#",":
                             "#"",*+,DIM200C,"#");"   * Alerts Link   *I-204622
...                          "#"",PTMXSIN1,"#");"                     *D-204622
          GOTO      CASTAB10
.
CASTAB90
.
CASTAB99  RETURN
.******************************************************************************
.*           Current Theatre Status Enquiry          HPS Code Starts Here     *
.******************************************************************************
CURTHE00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
CURTHE10  CALL      RKOPDEA1
          BRANCH    OVRCD,CURTHE99
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      CURTHE99 IF NOT EQUAL
.
          MATCH     OPDADATE,LASTDATE
          GOTO      CURTHE99 IF LESS
          CALL      CLOPRARD              * Make sure Arri/Depart Fields Cleared
          CALL      CLOPRSRG              * Clear oprsrgaf fields (0904190)
.
          MATCH     SP70,THEACODE           * Theatre Filter
          IF        !@EQUAL
            MATCH     THEACODE,OPDATHET
            GOTO      CURTHE10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,CURTHE10
.
          COMPARE   ZERO,OPSESTAT
          GOTO      CURTHE10 IF EQUAL
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      CURTHE10 IF NOT EQUAL
            ENDIF
          ENDIF
.
         MATCH    "1",EXCLCANC                  * Exclude cancelled
          IF       @EQUAL
            COMPARE   THREE,OPDASTAT
            GOTO      CURTHE10 IF EQUAL
          ENDIF
.
          CALL      CLPATMIS
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          MATCH     WARDCODE,SP70
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      CURTHE10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ADMPOINT                * Check Admit Point Filter
          GOTO      CURTHE11 IF EQUAL            * Blank, list all types
          MATCH     "ALL",ADMPOINT               * Check Admit Point Filter
          GOTO      CURTHE11 IF EQUAL            * List all types
          PACK      BKRXADWD,SP70
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,CURTHE10
          MATCH     BKRXADWD,ADMPOINT            * Match Filter value
          GOTO      CURTHE10 IF NOT EQUAL        * No match, get next record
.
CURTHE11  MATCH     SP70,SURGTYPE                * Check Surgery Type Filter
          GOTO      CURTHE20 IF EQUAL            * Blank, list all types
          MATCH     "ALL",SURGTYPE               * Check Surgery Type Filter
          GOTO      CURTHE20 IF EQUAL            * List all types
          MATCH     OPSEDGSI,SURGTYPE            * Match Filter value
          GOTO      CURTHE10 IF NOT EQUAL        * No match, get next record
.
CURTHE20  MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,NSEXTN
          COMPARE   THREE,OPDASTAT
          GOTO      CURTHE30 IF NOT EQUAL
.
          MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Transferred",CURSTATS
          ELSE
            MOVE      "Cancelled",CURSTATS
          ENDIF
.
          PACK      KEY5,ANSS,ANSC,OPDACANC
          CALL      RDCODE1
          BRANCH    OVRCD,CURTHE40
          MOVE      TDESC,OPDADES1
          MOVE      SP70,OPDADES2
          MOVE      SP70,OPDADES3
          MOVE      SP70,TDESC
          GOTO      CURTHE40
.
CURTHE30  PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,CURTHE10
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,CURTHE10
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
            GOTO      CURTHE40
          ENDIF
.
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MOVE      "Holding",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MOVE      "Anaes",CURSTATS
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG            * Clear oprsrgaf fields (0904190)
            GOTO      CURTHE40
          ENDIF
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MOVE      "Theatre",CURSTATS
          ENDIF
.
          MATCH     SP70,OPSGTISS
          IF        !@EQUAL
            MOVE      "Theatre",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",CURSTATS
.
            MATCH     SP70,OPARUC03
            IF        !@EQUAL
              SQUEEZE   OPARUC03
              PACK      CURSTATB,LBRACK,OPARUC03,RBRACK,SP70
              RESET     OPARUC03
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",CURSTATS
.
            MATCH     SP70,OPARUC03
            IF        !@EQUAL
              SQUEEZE   OPARUC03
              PACK      CURSTATB,LBRACK,OPARUC03,RBRACK,SP70
              RESET     OPARUC03
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",CURSTATS
.
            MATCH     SP70,OPARUC03
            IF        !@EQUAL
              SQUEEZE   OPARUC03
              PACK      CURSTATB,LBRACK,OPARUC03,RBRACK,SP70
              RESET     OPARUC03
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIDP 
          IF        !@EQUAL
            MOVE      "Ready To Depart",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",CURSTATS
            MATCH     "1",EXCLEXIT               * Exclude Exit status Patients
            GOTO      CURTHE10 IF EQUAL
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,CURSTATS              * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",CURSTATS      * Yes, set status to "Deceased"
            ELSE
              MOVE      CURSTATS,DIM15           * No, save current status
              PACK      CURSTATS,STAPRFIX,DIM15  * Build new status desc
            ENDIF
          ENDIF
.
CURTHE40  CALL      GETSES00
          CALL      CASDET00
.
          PACK      DIM200D,SP70,SP70
          CLEAR     DIM200D
.                                      See  if Patient Alerts exist
          MOVE      ZERO,EXIT
          PROC      DISPALRT
.
          PACK      KEY16,PURNO,SP20
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,CURTHE50
.
          MATCH     PURNO,PTALURNO
          GOTO      CURTHE50 IF NOT EQUAL
.
          REP       " +",OPDAURNO
          REP       " +",OPDAADMN

          APPEND    "<a href=javascript:PatientAlerts('",DIM200D
          REP       " +",PURNO
          APPEND    PURNO,DIM200D
          REP       "+ ",PURNO
          APPEND    "')>",DIM200D
.
          REP       "+ ",OPDAURNO
          REP       "+ ",OPDAADMN
.
          IF        EXIT=0
            APPEND    "<img src=../images/AlertIcon.gif class=Icon>",DIM200D
          ENDIF
.
          IF        EXIT=1
            APPEND   "<img src=../images/AlertIconDIS.gif class=Icon>",DIM200D
          ENDIF
.
          IF        EXIT=2
            APPEND   "<img src=../images/AlertIcon.gif class=Icon>",DIM200D
            APPEND   "<img src=../images/AlertIconDIS.gif class=Icon>",DIM200D
          ENDIF
.
          APPEND   "</a>",DIM200D
.
CURTHE50  CALL      PATFLD00
          MOVE      KEY3,PATFOLDR
.
          MATCH     SP70,FILTSURG
          IF        !@EQUAL
            MATCH      DCODE,FILTSURG
            GOTO       CURTHE10  IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH      DCODE,DOCTCODE
            GOTO       CURTHE10  IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ANAECODE
          IF        !@EQUAL
            MATCH      OPSEANAE,ANAECODE
            GOTO       CURTHE10  IF NOT EQUAL
          ENDIF
.            
          MOVE      OPRMDESC,OPERROOM
          MATCH     SP70,OPDATHET
          GOTO      CURTHE60 IF EQUAL
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     OPERROOM
            APPEND    "<font color=red>",OPERROOM
            APPEND    OPRMDESC,OPERROOM
            APPEND    "</font>",OPERROOM
            RESET     OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.
CURTHE60  PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE
          REP       " +",CASEKEYS
.
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20A
.
          PACK      KEY3,AWARD,SP70
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      BKRXADWD,KEY3
          ENDIF
          PACK      KEY6,KEY3,ABED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CURTHE70
.
          PACK      KEY6,PTWDNSTA,SP70
          CALL      RDNURS1
          BRANCH    OVRCD,CURTHE70
.
CURTHE70  PACK      DIM200C,SP70,SP70
          CLEAR     DIM200C
.                                      See  if Patient Alerts exist
          MOVE      ZERO,EXIT
          PROC      DISPALRT
. 
          PACK      KEY16,PURNO,SP20
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,CURTHE80
.
          MATCH     PURNO,PTALURNO
          GOTO      CURTHE80 IF NOT EQUAL
.
          REP       " +",OPDAURNO
          REP       " +",OPDAADMN

          APPEND    "<a href=javascript:onclick=viewAlert('",DIM200C
          REP       " +",PURNO
          APPEND    PURNO,DIM200C
          REP       "+ ",PURNO
          APPEND    "')>",DIM200C
.
          REP       "+ ",OPDAURNO
          REP       "+ ",OPDAADMN
.
          IF        EXIT=0
            APPEND    "<img src=../images/AlertIcon.gif class=Icon>",DIM200C
          ENDIF
.                     
          IF        EXIT=1
            APPEND   "<img src=../images/AlertIconDIS.gif class=Icon>",DIM200C
          ENDIF
.
          IF        EXIT=2
            APPEND   "<img src=../images/AlertIcon.gif class=Icon>",DIM200C
            APPEND   "<img src=../images/AlertIconDIS.gif class=Icon>",DIM200C
          ENDIF
.
          APPEND   "</a>",DIM200C
.
CURTHE80  PACK      KEY5,CODEDK,PTMXDEAF,SP5
          MOVE      SP1,TCINDC1
          CALL      RDCODE1                 * Cat."DK"
          MATCH     "D",TCINDC1
          IF        @EQUAL

            APPEND    "<img src='../images/deaf.gif'  />",DIM200C
          ENDIF
.
          CALL      GETPAT00
          CALL      PATLN000       * Format Patient Name with System Parameter
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            PACK      DDATE,SP70
            PACK      DTIME,SP70
          ENDIF
.
          PACK      ADMWRDEC,SP70
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          IF        OVRCD=0     
            MOVE      "ap",CATEGORY
            MOVE      BKRXADWD,CODE
            CALL      GETCOD00
            MOVE      TDESC,ADMWRDEC
          ENDIF
.
          IF        SHOWMAP=1
            CALL      MAPROW00
          ELSE
            CALL      PATROW00
          ENDIF
          GOTO      CURTHE10
.
CURTHE99  RETURN
.******************************************************************************
. Patient Theatre Row
.******************************************************************************
PATROW00  WRITE     HTMLFILE;"t.addRow(#"",LINKPRG:
                                ".pbl?reportno=",LINKREP:
                                "&template=",LINKTEM:
                                "&casekeys=",CASEKEYS,"#",":
                             "#"",OPRMDESC,"#",":             * 1
                             "#"",OPDADATE,OPDAEXPS,"#",":    * 2
                             "#"",OPDAEXPD,"#",":             * 3
                             "#"",SURFNAME,"#",":             * 4
                             "#"",ANAFNAME,"#",":             * 5
                             "#"",FORMATNM,"#",":             * 6
                             "#"",AURNO,"#",":                * 7
                             "#"",OPDADES1,OPDADES2,OPDADES3,"#",":  * 8
                             "#"",DIM20A,"#",":               * 9
                             "#"",OPSETYPE,"#",":             * 10
                             "#"",OPDAPROV,"#",":             * 11
                             "#"",OPDADES1,"#",":             * 12
                             "#"",CURSTATS,"#",":             * 13 
                             "#"",NSEXTN,"#",":               * 14
                             "#"",OPDAEXPS,"#"";              * 15
.
          MATCH     SP70,ABED
          IF        !@EQUAL
            WRITE     HTMLFILE;",#"",AWARD,"/",ABED,"#"";     * 16
          ELSE
            WRITE     HTMLFILE;",#"",AWARD,"#"";              * 16
          ENDIF
.
          WRITE     HTMLFILE;",#"",OPARUT11,"#"";             * 17
.
          CLEAR     DIM100A
          APPEND    "<a href=javascript:DoctorViewFrame('",DIM100A
          STRIP     _SAVDOCT                      
          APPEND    _SAVDOCT,DIM100A
          APPEND    "') >",DIM100A
          APPEND    SURFNAME,DIM100A
          APPEND    "</a>",DIM100A
          RESET     DIM100A
.
          WRITE     HTMLFILE;",#"",DIM100A,"#"";              * 18
.
          CLEAR     DIM100B
          MATCH     "&nbsp;",ANAFNAME
          IF        @EQUAL
            MOVE      "&nbsp;",DIM100B
          ELSE
            APPEND    "<a href=javascript:DoctorViewFrame('",DIM100B
            STRIP     OPSEANAE
            APPEND    OPSEANAE,DIM100B
            APPEND    "') >",DIM100B
            APPEND    ANAFNAME,DIM100B
            APPEND    "</a>",DIM100B
          ENDIF
          RESET     DIM100B
          WRITE     HTMLFILE;",#"",DIM100B,"#"";              * 19
.
          WRITE     HTMLFILE;",#"",DIM200C,"#",";             * 20
.
          WRITE     HTMLFILE;"#"",PATFOLDR,"#",";             * 21
.
          WRITE     HTMLFILE;"#"",DIM200D,"#",";              * 22
.
          CLEAR     DIM200D
          MATCH     SP70,BKREATIM
          IF        @EQUAL
            MOVE      "&nbsp;",DIM200D
          ELSE
            APPEND    "<a href=javascript:onclick=UpdFastingTimes('",DIM200D
            REP       " +",OPDAUNIQ
            APPEND    OPDAUNIQ,DIM200D
            REP       "+ ",OPDAUNIQ
            APPEND    "')>",DIM200D
            APPEND    "<img src=../images/DateTimeStamp.gif",DIM200D
            APPEND    " class=Icon>",DIM200D
            APPEND    "</a>&nbsp;",DIM200D
            APPEND    BKREATIM,DIM200D
          ENDIF
          RESET     DIM200D
          STRIP     DIM200D
          WRITE     HTMLFILE;"#"",DIM200D,"#",";        * 23
.
          MOVE      SP70,DISPDTFF
          MATCH     SP70,OPDADTFF
          IF        !@EQUAL
            UNPACK    OPDADTFF,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDTFF,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,SLASH
          ENDIF
.
          MATCH     SP70,OPDAFAST
          IF        @EQUAL
            MOVE      "&nbsp;",D5
          ELSE
            PACK       D5,OPDAFAST
          ENDIF
.
          MATCH     SP70,DISPDTFF
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",DISPDTFF,"<br>",D5,"#",";   * 24
          ELSE
            WRITE     HTMLFILE;"#"",D5,"#",";                   * 24
          ENDIF
.
          MOVE      SP70,DISPDTFL
          MATCH     SP70,OPDADTFL
          IF        !@EQUAL
            UNPACK    OPDADTFL,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDTFL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,SLASH
          ENDIF
.
          MATCH     SP70,OPDAPRE5
          IF        @EQUAL
            MOVE      "&nbsp;",OPDAPRE5
          ENDIF
.
          MATCH     SP70,DISPDTFL
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",DISPDTFL,"<br>",OPDAPRE5,"#","       * 25
          ELSE
            WRITE     HTMLFILE;"#"",OPDAPRE5,"#","                       * 25
          ENDIF
.
          MOVE      "013",OPDDTYPE
          MOVE      "  1",OPDDLINE
          MOVE      SP70,OPDDDATA
          PACK      KEY16,OPDAUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      RDOPDED1
          IF        OVRCD=1
            MOVE      SP70,OPDDDATA
          ENDIF
.
          WRITE     HTMLFILE;"#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",";             * 26
          WRITE     HTMLFILE;"#"",KEY16,"#",":                * 27  
                             "#"",OPDDDATA,"#",":             * 28
                             "#"",OPDATHET,"#",";             * 29
.
          IF        ASTAT=2
            MATCH     SP70,ABED
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",AWARD,"/",ABED,"#",";            * 30
            ELSE
              WRITE     HTMLFILE;"#"",AWARD,"#",";
            ENDIF
          ELSE
            MATCH     SP70,BKRXPOBD
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",BKRXPOWD,"/",BKRXPOBD,"#",";     * 30
            ELSE
              WRITE     HTMLFILE;"#"",BKRXPOWD,"#",";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#"H: ",PTELEP,"<br>":                  * 31
                             "B: ",PTELEB,"<br>":
                             "M: ",PTMXCELL,"#",";
.
          MATCH     SP70,OPSEFIND
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",DYES,"#",";                      * 32
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",SURFNAME,"<br>",ANAFNAME,"#",";    * 33
.
          MOVE      "TU",CATEGORY
          MOVE      OPSESTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,SESTDESC
          REP       " 0",OPDACASE
.
          WRITE     HTMLFILE;*+,"#"",SESTDESC,LBRACK,OPDACASE,RBRACK,"#","; * 34
.
          IF        ASTAT=2
            MATCH     SP70,ABED
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",AWARD,"/",ABED,"#",";            * 35
            ELSE
              WRITE     HTMLFILE;"#"",AWARD,"#",";
            ENDIF
          ELSE
            MATCH     SP70,OPDAPOBD
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",OPDAPOWD,"/",OPDAPOBD,"#",";     * 35
            ELSE
              WRITE     HTMLFILE;"#"",OPDAPOWD,"#",";                  * 35
            ENDIF
          ENDIF
.
          CLEAR     HTMLLNK4
          APPEND    "javascript:linkToCase('",HTMLLNK4
          APPEND    LINKPRG,HTMLLNK4
          APPEND    ".pbl?reportno=",HTMLLNK4
          APPEND    LINKREP,HTMLLNK4
          APPEND    "&template=",HTMLLNK4
          APPEND    LINKTEM,HTMLLNK4
          APPEND    "&casekeys=",HTMLLNK4
          APPEND    CASEKEYS,HTMLLNK4
          APPEND    "')",HTMLLNK4
          RESET     HTMLLNK4
.
          WRITE     HTMLFILE;"#"",HTMLLNK4,"#",":                      * 36
                             "#"",OPARATIM,"#",":                      * 37
                             "#"",OPARANAS,"#",":                      * 38
                             "#"",OPARTIRD,"#",":                      * 39
                             "#"",OPARTETC,"#",":                      * 40
                             "#"",OPSGTISS,"#",":                      * 41
                             "#"",OPSGTISE,"#",":                      * 42
                             "#"",ADMWRDEC,"#",":                      * 43
                             "#"",AWARD,"#",":                         * 44
                             "#"",ABED,"#",":                          * 45
                             "#"",ADATE,ATIME,"#",":                   * 46
                             "#"",DDATE,DTIME,"#");"                   * 47
.
PATROW99  RETURN
.******************************************************************************
. Patient Theatre Mapping
.******************************************************************************
MAPROW00  MATCH     SP70,ABED
          IF        !@EQUAL
            CLEAR     WARDSTR
            APPEND    AWARD,WARDSTR
            APPEND    "/",WARDSTR
            APPEND    ABED,WARDSTR
            RESET     WARDSTR
          ELSE
            MOVE      AWARD,WARDSTR
          ENDIF
          STRIP     WARDSTR
.
          CALL      GETUCN00
.
          STRIP     OPDDDATA
          STRIP     SURSNAME
          STRIP     SURFNAME
          STRIP     ANASNAME
          STRIP     ANAFNAME
          STRIP     FORMATNM
          STRIP     OPRMDESC
          STRIP     OPDADES1
          STRIP     CURSTATS
          STRIP     CURSTATB
          STRIP     OPDAPROV
          STRIP     OPDADES1
          STRIP     OPDADES2
          STRIP     OPDADES2
.
          MOVE      "013",OPDDTYPE
          MOVE      "  1",OPDDLINE
          PACK      MAPLOCKY,OPDAUNIQ,OPDDTYPE,OPDDLINE,SP70
.
          WRITE     HTMLFILE;"obj.AddPatient(#"",CASEKEYS,"#",": 
                             "#"",OPRMDESC,"#",":             * 1
                             "#"",OPDADATE,OPDAEXPS,"#",":    
                             "#"",OPDAEXPD,"#",":             
                             "#"",SURFNAME,"#",":             
                             "#"",ANAFNAME,"#",":             * 5
                             "#"",FORMATNM,"#",":
                             "#"",AURNO,"#",":
                             "#"",OPDADES1,SP1,OPDADES2,SP1,OPDADES3,"#",":
                             "#"",DIM20A,"#",":
                             "#"",OPSETYPE,"#",":             * 10
                             "#"",OPDAPROV,"#",":
                             "#"",OPDADES1,"#",":
                             "#"",CURSTATS,"#",":
                             "#"",NSEXTN,"#",":       
                             "#"",OPDAEXPS,"#",":             * 15
                             "#"",WARDSTR,"#",":              * 16
                             "#"",OPARUT11,"#",":             * 17
                             "#"",_SAVDOCT,"#",":             * 18
                             "#"",OPSEANAE,"#",":             * 19
                             "#"",SURSNAME,"#",":             * 20
                             "#"",ANASNAME,"#",":             * 21
                             "#"",PATFOLDR,"#",":             * 22
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PTMXSIN5,"#",": * 23
                             "#"",MAPLOCKY,"#",":             * 24
                             "#"",MAPLOCCD,"#",":             * 25
                             "#"",CURSCODE,"#",":             * 26
                             "#"",AURNO,"#",":                * 27
                             "#"",DAADMNO,"#",":              * 28
                             "#"",PTITL,"#",":                * 29
                             "#"",PGNAME,"#",":               * 30
                             "#"",PSNAME,"#",":               * 31
                             "#"",PSEX,"#",":                 * 32
                             "#"",PSAGE,"#",":                * 33
                             "#"",OPARUC01,"#",":             * 34
                             "#"",OPARUC02,"#",":             * 35
                             "#"",OPARUC03,"#",":             * 36
                             "#"",OPARUC04,"#",":             * 37
                             "#"",OPARUC05,"#",":             * 38
                             "#"",OPARUC06,"#",":             * 39
                             "#"",OPARUC07,"#",":             * 40
                             "#"",OPARUC08,"#",":             * 41
                             "#"",DESCUC01,"#",":             * 42
                             "#"",DESCUC02,"#",":             * 43
                             "#"",DESCUC03,"#",":             * 44
                             "#"",DESCUC04,"#",":             * 45
                             "#"",DESCUC05,"#",":             * 46
                             "#"",DESCUC06,"#",":             * 47
                             "#"",DESCUC07,"#",":             * 48
                             "#"",DESCUC08,"#",":             * 49
                             "#"",USERDF01,"#",":             * 50
                             "#"",USERDF02,"#",":             * 51
                             "#"",USERDF03,"#",":             * 52
                             "#"",USERDF04,"#",":             * 53
                             "#"",USERDF05,"#",":             * 54
                             "#"",USERDF06,"#",":             * 55
                             "#"",USERDF07,"#",":             * 56
                             "#"",USERDF08,"#",":             * 57
                             "#"",MAGNETSS,"#",":             * 58
                             "#"",CURSCODE,"#",":             * 59
                             "#"",OPDATHET,"#",":             * 60
                             "#"",CURSTATS,CURSTATB,"#",":    * 61
                             "#"",OPARRDCD,"#",":             * 62
                             "#"",DESCRDCD,"#",":             * 63 
                             "#"",DISPCREV,"#",":             * 64 
                             "#"",REVWREQD,"#");"             * 65     
          RETURN
.
GETUCN00  MOVE      SP70,USERDF01
          MOVE      SP70,USERDF02
          MOVE      SP70,USERDF03
          MOVE      SP70,USERDF04
          MOVE      SP70,USERDF05
          MOVE      SP70,USERDF06
          MOVE      SP70,USERDF07
          MOVE      SP70,USERDF08
          MOVE      SP70,MAPLOCCD
          MOVE      SP70,DESCRDCD
          MOVE      SP70,DISPCREV
.
          MATCH     SP70,OPARUT02
          IF        !@EQUAL
            UNPACK    OPARUT02,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPCREV,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,OPARUT03
          ENDIF
          STRIP     DISPCREV
.
          MOVE      "Ou",CATEGORY                // Recovery Delay Reason
          MOVE      OPARRDCD,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCRDCD
          STRIP     DESCRDCD
.
          CALL      REVW0000           * Check if recovery review required
          STRIP     REVWREQD
.
          PACK      MAGNETSS,OPARUY01,OPARUY02,OPARUY03,OPARUY04,OPARUY05:
                             OPARUY06,OPARUY07,OPARUY08,OPARUY09,OPARUY10
.
          MOVE      "013",OPDDTYPE
          MOVE      "  1",OPDDLINE
          MOVE      SP70,OPDDDATA
          PACK      KEY16,OPDAUNIQ,OPDDTYPE,SP70
          CALL      RSOPDED1
GETUCN10  CALL      RKOPDED1
          BRANCH    OVRCD,GETUCN20
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      GETUCN20 IF NOT EQUAL
          MOVE      OPDDLINE,F3
          STORE     OPDDDATA,F3,MAPLOCCD,USERDF01,USERDF02,USERDF03,USERDF04:
                                         USERDF05,USERDF06,USERDF07,USERDF08
          GOTO      GETUCN10
.
GETUCN20  MOVE      SP70,DESCUC01
          MOVE      SP70,DESCUC02
          MOVE      SP70,DESCUC03
          MOVE      SP70,DESCUC04
          MOVE      SP70,DESCUC05
          MOVE      SP70,DESCUC06
          MOVE      SP70,DESCUC07
          MOVE      SP70,DESCUC08
          MOVE      ONE,F2
GETUCN30  LOAD      CODE,F2,OPARUC01,OPARUC02,OPARUC03,OPARUC04:
                            OPARUC05,OPARUC06,OPARUC07,OPARUC08
          MATCH     SP70,CODE
          IF        !@EQUAL
            LOAD      CATEGORY,F2,CAToa,CATob,CAToc,CATod:
                                   CAToe,CATof,CATog,CAToh
            MOVE      OPARUC01,CODE
            CALL      GETCOD00
            STORE     TDESC,F2,DESCUC01,DESCUC02,DESCUC03,DESCUC04:
                               DESCUC05,DESCUC06,DESCUC07,DESCUC08
          ENDIF
          ADD       ONE,F2
          COMPARE   EIGHT,F2
          GOTO      GETUCN30 IF NOT EQUAL
          STRIP     USERDF01
          STRIP     USERDF02
          STRIP     USERDF03
          STRIP     USERDF04
          STRIP     USERDF05
          STRIP     USERDF06
          STRIP     USERDF07
          STRIP     USERDF08
          STRIP     DESCUC01
          STRIP     DESCUC02
          STRIP     DESCUC03
          STRIP     DESCUC04
          STRIP     DESCUC05
          STRIP     DESCUC06
          STRIP     DESCUC07
          STRIP     DESCUC08
          STRIP     MAPLOCCD
         
.
GETUCN99  RETURN
.
.
.******************************************************************************
. Check if recovery review required and return class name for cell highlight
.******************************************************************************
REVW0000  MOVE      SP70,REVWREQD
.
          PACK      DIM32,OPARTETC,OPARTICU,OPARTEXP,OPARTIDP,SP70
.
          MATCH     SP70,DIM32                   * Has patient left theatre
          GOTO      REVW9999 IF NOT EQUAL
.
          MATCH     SP70,OPARTIRF                * Exit if not in recovery
          GOTO      REVW9999 IF EQUAL
.
          MOVE      OPSEDATE,WORKDATE            * Date into recovery
          MATCH     "1",OPSGUY02
          IF        @EQUAL
            ADD       ONE,WORKDATE               * Add 1 day if overnight
          ENDIF
          MOVE      OPARTIRF,WORKTIME            * Time into recovery
.
          MATCH     SP70,OPARUT02
          IF        !@EQUAL
            MOVE      OPARUT02,WORKDATE          * User last review date
            MOVE      OPARUT03,WORKTIME
          ENDIF
.
          MOVE      WORKDATE,FIRSTDAT
          REP       " 0",FIRSTDAT
          UNPACK    WORKTIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTIME
.
          CALL      IBACLOCK                    * Current date and time
          CLOCK     TIME,CTIMEIS
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF
          MOVE      CALCTIME,DURATIME
.
          SQUEEZE   OPCNCRRM
          MOVE      ZERO,FORM3
          MOVE      OPCNCRRM,FORM3
          IF        DURATIME > FORM3 & FORM3 > ZERO
            MOVE      "Yes",REVWREQD
          ENDIF
.
REVW9999  RETURN
.******************************************************************************
.*                       Patient Diag/Eqpt List
.******************************************************************************
PATLST00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
PATLST10  CALL      RKOPDEA1
          BRANCH    OVRCD,PATLST99
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      PATLST99 IF NOT EQUAL
.
          MATCH     OPDADATE,LASTDATE
          GOTO      PATLST99 IF LESS
.         
          COMPARE   THREE,OPDASTAT
          GOTO      PATLST10 IF EQUAL
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,PATLST10
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      PATLST10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,SURGTYPE                * Check Surgery Type Filter
          GOTO      PATLST15 IF EQUAL            * Blank, list all types
          MATCH     "ALL",SURGTYPE               * Check Surgery Type Filter
          GOTO      PATLST15 IF EQUAL            * List all types
          MATCH     OPSEDGSI,SURGTYPE            * Match Filter value
          GOTO      PATLST10 IF NOT EQUAL        * No match, get next record
.
PATLST15  CALL      GETSES00
          CALL      CASDET00
.
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            MOVE      OPRMDESC,OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE
          CALL      PATNAM00
.
          IF        OPCNCLSU=0
            MOVE      OPSECLIN,KEY6
            CALL      RDOPCLI1
            IF        OVRCD=0
....          MOVE      OPCLDESC,PATFNAME
            ENDIF
          ENDIF
.
          PACK      KEY18,OPDAADMN,OPDAUNIQ,SP70
          CALL      RDBKDIA1
          IF        OVRCD=1
            MOVE      SP70,BKDIDES1
          ENDIF
.
          MOVE      SP70,EQRDESC1
          MOVE      SP70,EQRDESC2
          MOVE      SP70,EQRDESC3
          MOVE      SP70,EQRLDESC
          PACK      VAR,SP70,SP70
          PACK      DIM127A,SP70,SP70
.
          MATCH     SP70,OPDAEQR1
          GOTO      PATLST20 IF EQUAL
          PACK      KEY5,ANSX,ANSE,OPDAEQR1
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,EQRDESC1
          ENDIF
.
PATLST20  MATCH     SP70,OPDAEQR2
          GOTO      PATLST30 IF EQUAL
          PACK      KEY5,ANSX,ANSE,OPDAEQR2
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,EQRDESC2
          ENDIF
.
PATLST30  MATCH     SP70,OPDAEQR3
          GOTO      PATLST35 IF EQUAL
          PACK      KEY5,ANSX,ANSE,OPDAEQR3
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,EQRDESC3
          ENDIF
.
PATLST35  MATCH     SP70,OPDALEQR
          GOTO      PATLST40 IF EQUAL
          PACK      KEY5,ANSX,ANSO,OPDALEQR
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,EQRLDESC
          ENDIF
.
PATLST40  MOVE      "002",D3
          PACK      KEY16,OPDAUNIQ,D3,SP70
          CALL      RSOPDED1
          CALL      RKOPDED1
          BRANCH    OVRCD,PATLST45
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      PATLST45 IF NOT EQUAL
          MATCH     "002",OPDDTYPE
          GOTO      PATLST45 IF NOT EQUAL
          STRIP     OPDDDATA
          MOVELPTR  OPDDDATA,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      OPDDDATA,VAR
.
PATLST45  MOVE      "009",D3
          PACK      KEY16,OPDAUNIQ,D3,SP70
          CALL      RSOPDED1
          CALL      RKOPDED1
          BRANCH    OVRCD,PATLST50
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      PATLST50 IF NOT EQUAL
          MATCH     "009",OPDDTYPE
          GOTO      PATLST50 IF NOT EQUAL
          STRIP     OPDDDATA
          MOVELPTR  OPDDDATA,LENGTH
          SFORMAT   DIM127A,LENGTH
          MOVE      OPDDDATA,DIM127A
.
PATLST50  CLEAR     HTMLLINK
          APPEND    "javascript:CaseLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPDADATE,OPDAEXPS,"#",":
                             "#"",AURNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",OPERROOM,"#",":
                             "#"",BKDIDES1,"#",":
                             "#"",EQRDESC1,"#",":
                             "#"",EQRDESC2,"#",":
                             "#"",EQRDESC3,"#",":
                             "#"",EQRLDESC,"#",":
                             "#"",VAR,"#",":
                             "#"",DIM127A,"#");"
          GOTO      PATLST10
PATLST99  RETURN
.******************************************************************************
.*                       Patient Theatre List                                 *
.******************************************************************************
THETAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,EXTHFLAG,DIM127
.
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
THETAB10  CALL      RKOPDEA1
          BRANCH    OVRCD,THETAB99
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      THETAB99 IF NOT EQUAL
.
          MATCH     OPDADATE,LASTDATE
          GOTO      THETAB99 IF LESS
.
          COMPARE   THREE,OPDASTAT
          GOTO      THETAB10 IF EQUAL
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,THETAB10
.
          COMPARE   TWO,ASTAT
          GOTO      THETAB10 IF NOT EQUAL
.
          MOVE      SP70,OPARATIM           * Clear Arrival Time
          PACK      KEY10,OPDAUNIQ,SP70     * Read Arrvl/Recovery File
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
          ENDIF
.
          MATCH     "1",EXTHFLAG
          IF        @EQUAL
            MATCH     SP70,OPARTETC              * Only show patients who have
            GOTO      THETAB10 IF NOT EQUAL      * not exited theatre (Day proc)
          ELSE
            MATCH     SP70,OPARANAP
            GOTO      THETAB10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,THETAB10
.
          MOVE      SP70,NSEXTN
          MOVE      SP70,ATIME              * Clear  DOSA/Admiss time
          MOVE      SP70,BKREATIM      
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,THETAB10
.
          COMPARE   ZERO,OPSESTAT
          GOTO      THETAB10 IF EQUAL
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      THETAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTTPER
          IF        !@EQUAL
            MATCH     FILTTPER,OPSETPER          * Time period filter
            GOTO      THETAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SURGTYPE                * Check Surgery Type Filter
          GOTO      THETAB11 IF EQUAL            * Blank, list all types
          MATCH     "ALL",SURGTYPE               * Check Surgery Type Filter
          GOTO      THETAB11 IF EQUAL            * List all types
          MATCH     OPSEDGSI,SURGTYPE            * Match Filter value
          GOTO      THETAB10 IF NOT EQUAL        * No match, get next record
.
THETAB11  CALL      GETSES00
          CALL      CASDET00
.
          MOVE      SP70,CONDDESC
          PACK      KEY88,PTMASNAM,PMPXFNAM,OPDAADMN,SP70,SP70
          CALL      RDLOCA1
          IF        OVRCD=0
            MATCH     SP70,LPCONDC
            IF        !@EQUAL
              PACK      KEY5,CODECO,LPCONDC,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      LPCONDC,TDESC
              ENDIF
              UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
              PACK      CONDDESC,TDESC,LBRACKT,CDAY,SLASH,CMON,SP1:
                                 LPCTIME,RBRACKT,SP70
            ENDIF
          ENDIF
.
          CALL      LSTALR00    * Patient Alerts (in LSTALERT.PBL)    *I-204622
          STRIP     ALRTIMGE
          STRIP     ALRTIMG2
          STRIP     ALRTIMG3
          STRIP     ALRTIMG4
          PACK      ALRTIMGT,ALRTIMGE,ALRTIMG2,ALRTIMG3,ALRTIMG4,SP70
.
          MATCH     SP70,ALRTIMGT           * returned from LSTALERT.PBL
          IF        @EQUAL
            MOVE      "&nbsp;",DIM200C
          ELSE
            REP       " +",ALRTLINK
            CLEAR     DIM200C
            APPEND    "<a href=",DIM200C
            APPEND    ALRTLINK,DIM200C
            APPEND    ">",DIM200C
            APPEND    ALRTIMGT,DIM200C
            APPEND    "</a>",DIM200C
            RESET     DIM200C
          ENDIF
          STRIP     DIM200C                 * Alerts Link       end   *I-204622
.
          CALL      PATFLD00
          MOVE      KEY3,PATFOLDR
          MOVE      SP70,WARDDOSA
.
          MATCH     SP70,THEACODE           * Theatre Filter
          IF        !@EQUAL
            MATCH   THEACODE,OPDATHET
            IF      @EQUAL
              MOVE    THEACODE,OPERROOM
            ELSE
              GOTO  THETAB10
            ENDIF
          ENDIF
.
          REP       " 0",LISTTYPE           * Check List Type with Spaces
          PACK      KEY10,OPDAUNIQ,SP70     * Read Arrvl/Recovery File
          CALL      RDOPARD1
          BRANCH    OVRCD,THETAB14          * C CAR 44973
.
          MATCH     "0",LISTTYPE            * LstType=0 chk arrtim<10
          IF        @EQUAL
            MOVE    OPARATIM,FIRSTIME
            MOVE    CTIMEIS,LASTTIME
            CALL    TIMEDIFF
            IF      CALCTIME<10
              GOTO  THETAB14                * C CAR 44973
            ELSE
              GOTO  THETAB10
            ENDIF
          ENDIF
.
.THETAB12  MATCH     SP70,SURGC001           * D CAR 44973
.          GOTO      THETAB14 IF EQUAL
.          MATCH     OPDAUNIQ,OPDUNQID       * Chq for UnqID to Update Time
.          GOTO      THETAB14 IF NOT EQUAL
.
.          PACK      KEY10,OPDAUNIQ,SP70
.          CALL      RDOPARD1
.          MATCH     OPDAUNIQ,OPARUNID
.          GOTO      THETAB13 IF NOT EQUAL
.          MOVE      SURGC001,OPARTCAL
.          MOVE      USERID,OPARUIAR
.          CALL      UPOPARD1
.          GOTO      THETAB14
.
.THETAB13  MOVE      OPDAUNIQ,OPARUNID
.          MOVE      SURGC001,OPARTCAL
.          MOVE      USERID,OPARUIAR
.          CALL      WROPARD1                * end D CAR 44973
.
THETAB14  MOVE      OPRMDESC,OPERROOM
          MATCH     SP70,OPDATHET
          GOTO      THETAB15 IF EQUAL
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            MOVE      OPRMDESC,OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.
THETAB15  PACK      KEY3,AWARD,SP70
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      BKRXADWD,KEY3
          ENDIF
.
          MOVE      ZERO,DOSAWARD           * Get DOSA flag from ward master
          PACK      KEY6,KEY3,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,THETAB16
.
          MOVE      PTWDDOSA,DOSAWARD
.
          PACK      KEY6,KEY3,ABED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,THETAB16
          MATCH     KEY3,WWARD
          GOTO      THETAB16 IF NOT EQUAL
.
          MATCH     "1",DOSAWARD
          IF        @EQUAL
            PACK      WARDDOSA,KEY3,SLASH,ABED
            MOVE      SP70,KEY3
            MOVE      SP70,ABED
          ELSE
            MOVE      SP70,DOSATIME
            PACK      KEY6,PTWDNSTA,SP70
            CALL      RDNURS1
            BRANCH    OVRCD,THETAB16
          ENDIF
.
THETAB16  PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE
          CALL      PATNAM00
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
.
          UNPACK    DOSATIME,KEY5
          PACK      DOSATIME,KEY5,SP70 
.
          UNPACK    OPARATIM,KEY5
          PACK      OPARATIM,KEY5,SP70 
.
          UNPACK    OPARTCAL,KEY5
          PACK      OPARTCAL,KEY5,SP70 
.
          CLEAR     HTMLLINK
          APPEND    "javascript:CaseLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK            
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:DayLink('",HTMLLNK2
          APPEND    CASEKEYS,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          CLEAR     KEY90
          APPEND    "javascript:UpdateLink('",KEY90
          APPEND    CASEKEYS,KEY90
          APPEND    "')",KEY90
          RESET     KEY90            
.
          CLEAR     KEY90A                                    * I CAR 44973
          APPEND    "javascript:UpdateTime('",KEY90A
          APPEND    VIEWTYPE,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    LASTDATE,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    THEACODE,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    VYEARMTH,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    CTIMEIS,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    OPDAUNIQ,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    LISTTYPE,KEY90A
          APPEND    "'",KEY90A
          APPEND    COMMA,KEY90A
          APPEND    "'",KEY90A
          APPEND    OPARATIM,KEY90A
          IF        SHOCNSNT = 1
            APPEND    "','",KEY90A
            APPEND    OPDACSST,KEY90A       * set Consent flag
          ENDIF
          APPEND    "')",KEY90A
          RESET     KEY90A                                    * end I CAR 44973
.
          REP       " +",THEACODE
          REP       " +",LISTTYPE
          REP       " +",OPDAUNIQ
.
          CLEAR     HTMLLNK3
          APPEND    "patweb98.pbl?reportno=01&template=001&",HTMLLNK3 
          APPEND    "urnumber=",HTMLLNK3
          APPEND     AURNO,HTMLLNK3
          APPEND    "&admissno=",HTMLLNK3
          APPEND    OPDAADMN,HTMLLNK3
          APPEND    "&casekeys=",HTMLLNK3
          REP       " +",CASEKEYS
          APPEND    CASEKEYS,HTMLLNK3
          RESET     HTMLLNK3
          REP       " +",HTMLLNK3
. 
          CLEAR     HTMLLNK5
          APPEND    "oprweb01.pbl?reportno=04&template=001&",HTMLLNK5 
          APPEND    "urnumber=",HTMLLNK5
          APPEND     AURNO,HTMLLNK5
          APPEND    "&admissno=",HTMLLNK5
          APPEND    OPDAADMN,HTMLLNK5
          APPEND    "&casekeys=",HTMLLNK5
          REP       " +",CASEKEYS
          APPEND    CASEKEYS,HTMLLNK5
          RESET     HTMLLNK5
          REP       " +",HTMLLNK5
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPDADATE,OPDAEXPS,"#",":
                             "#"",AURNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",OPERROOM,"#",":
                             "#"",KEY90,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",KEY3,"#",":
                             "#"",ABED,"#",":
                             "#"",DOSATIME,"#",":
                             "#"",OPARATIM,"#",":
                             "#"",NSEXTN,"#",":
                             "#"",OPARTCAL,"#",":
                             "#"","oprweb03.pbl?reportno=3&template=4&":
                             "viewtype=",VIEWTYPE:
                             "&lastdate=",LASTDATE:
                             "&theacode=",THEACODE:
                             "&vyearmth=",VYEARMTH:
                             "&surgc001=",CTIMEIS:
                             "&opdunqid=",OPDAUNIQ:
                             "&listtype=",LISTTYPE,"#",":
                             "#"",KEY90A,"#",":                 * I CAR 44973
                             "#"",HTMLLNK2,"#",":                 
                             "#"",PATFOLDR,"#",":
                             "#"",HTMLLNK3,"#",":
                             "#"",WARDDOSA,"#",":
                             "#"",*+,DIM200C,"#",":             *I-204622
.                           "#"<span style=\#"white-space:nowrap;\#" >",PATFNAME,"<br>",CONDDESC,"</span>#");"
                             "#"<span style=\#"white-space:nowrap;\#" >",PATFNAME,"<br>",CONDDESC,"</span>,#",":
                             "#"",HTMLLNK5,"#");"

.
          REP       "+ ",THEACODE
          REP       "+ ",LISTTYPE
          REP       "+ ",OPDAUNIQ
          GOTO      THETAB10
.
THETAB99  RETURN
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
CASDET00  MOVE      OPDAADMN,KEY8
          CALL      GURN0000
          BRANCH    EXIT,CASDET99
          MATCH     "       0",AURNO
          GOTO      CASDET10 IF NOT EQUAL   * have a UR number
.
.         on pre-admission file
.
          MOVE      OPDAADMN,KEY8           * visit number
          CALL      RDPRAM1
          BRANCH    OVRCD,CASDET10          * invalid visit number
.
          MOVE      ZERO,PURNO
          GOTO      CASDET99                * valid patient
.
.         on master file
.
CASDET10  PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CASDET99          * invalid UR number
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CASDET99          * invalid UR number
.
          MOVE      AURNO,URNUMBER                                    *I-204622
          MOVE      OPDAADMN,ADMISSNO                                 *I-204622
. 
CASDET99  RETURN
.******************************************************************************
.                   GURN0000
.    Given the admission number in KEY8/KEY6 this gets the UR number from
.    either the admission or booking master file.
.    Returns : AURNO
.    Routine by Bill Dew 14/03/90
.******************************************************************************
GURN0000  MOVE      SP70,DOSATIME
          CALL      RDMISS1                 * read admission file
          BRANCH    OVRCD,GURN5555
          MOVE      ATIME,DOSATIME
          CALL      RDBKREC1                
          BRANCH    OVRCD,GURN9000
          GOTO      GURN9000                          
.
GURN5555  CALL      CLPATMIS
          CALL      RDBKREC1                * read booking records file
          BRANCH    OVRCD,GURN9990
          MOVE      BKREURNO,AURNO
.         MOVE      BKREATIM,DOSATIME      * HPS Code Ends
.
GURN9000  MOVE      ZERO,EXIT               * a valid admission number
          GOTO      GURN9999
.
GURN9990  MOVE      ONE,EXIT                * an invalid admission number
.
GURN9999  RETURN
.******************************************************************************
.*                    Theatre Combo Display          HPS Code Starts Here     *
.******************************************************************************
THEATR00  PACK      KEY6,SP70 
          CALL      RSOPOPR1
THEATR10  CALL      RKOPOPR1
          BRANCH    OVRCD,THEATR99
.                                                                     *I-159894
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPRMHOSP    * Check hospital with user
              GOTO      THEATR10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     THEACODE,OPRMROOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",OPRMROOM,"selected>",OPRMDESC:
                                "</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",OPRMROOM,">",OPRMDESC:
                               "</option>"
          ENDIF
          GOTO      THEATR10
.
THEATR99  RETURN
.
.******************************************************************************
.*               All Theatre Combo Display                                    *
.******************************************************************************
ALLTHE00  PACK      KEY6,SP70
          CALL      RSOPOPR1
ALLTHE10  CALL      RKOPOPR1
          BRANCH    OVRCD,ALLTHE99
.                                                                     *I-159894
          MATCH     THEACODE,OPRMROOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",OPRMROOM,"selected>",OPRMDESC:
                                "</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",OPRMROOM,">",OPRMDESC:
                               "</option>"
          ENDIF
          GOTO      ALLTHE10
.
ALLTHE99  RETURN
.******************************************************************************
.*               Map Theatre Locations                                        *
.* Location Parameters
.*--------------------------------------
.*  0.  Name
.*  1.  Code
.*  2.  Top
.*  3.  Left
.*  4.  Current Position Height
.*  5.  Current Position Width
.*  6.  Current Position Top
.*  7.  Current Position Left
.*  8. Container Type 0-Treatment Area, 1-Notice Board, 2-Label, 3-Empty, 4-Statistics
.*  9. Maximum number of patients
.* 10. Short Name
.* 11. No Patient Wide
.* 12. No Patient High
.* 13. Show Location (true/false)
.* 14. Auto Position (true/false)
.* 15. Width
.* 16. Height
.* 17. Action Update
.* 18. Column Count
.* 19. Table Layout
.******************************************************************************
MAPTHE00  PACK      KEY6,SP70
          CALL      RSOPOPR1
MAPTHE10  CALL      RKOPOPR1
          BRANCH    OVRCD,MAPTHE99
          BRANCH    OPRMSTAT,MAPTHE10
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPRMHOSP                * Check hospital with user
              GOTO      MAPTHE10 IF NOT EQUAL
            ENDIF
          ENDIF
.         
          STRIP     OPRMDESC
          STRIP     OPRMROOM
          WRITE     HTMLFILE;"obj.AddLocation(#"":          
                                     OPRMDESC,"#",#"":     *0  Name
                                     OPRMROOM,"#",":       *1  Code
                                     "0,":                 *2  Top 
                                     "0,":                 *3  Left
                                     "0,":                 *4  Actual Position
                                     "0,":                 *5  Actual Position
                                     "0,":                 *6  Actual Position
                                     "0,#"":               *7  Actual Position
                                     "0#",#"":             *8  Container Type
                                     "1#",#"":             *9  Maximum Number of Patients
                                     OPRMROOM,"#",":       *10 Short Name
                                     "1,":                 *11 No Patient Wide
                                     "1,":                 *12 No Patient Wide
                                     "true,":              *13 Show Location
                                     "true":               *14 Auto Position 
                                     ");"
          GOTO      MAPTHE10
.
MAPTHE99  RETURN
.******************************************************************************
.*                       List Combo Display                                   *
.******************************************************************************
LISTCM00  MATCH     SP70,LISTTYPE           * Check List Type with Spaces
          IF        @EQUAL
            MOVE    "1",LISTTYPE
          ENDIF
          MATCH     "0",LISTTYPE
          IF        !@EQUAL
            WRITE     HTMLFILE;"<option value=1 selected>All Patients ":
                                "</option>"
            WRITE     HTMLFILE;"<option value=0>Not Arrvd&Arrvd<10min ":
                                "</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=1>All Patients </option>"
            WRITE     HTMLFILE;"<option value=0 selected>":
                               "Not Arrvd&Arrvd<10min </option>" 
          ENDIF
.
LISTCM99  RETURN
.------------------------------------------------------------
. Reallocated Sessions List
.------------------------------------------------------------
REALST00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      REALST40 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete reallocated sessions
          GOTO      REALST30 IF EQUAL       
.
          GOTO      REALST95                * Invalid Update Type
.
REALST30  PACK      KEY30,SESSKEY2,SP70
          CALL      RDOPRAL1
          BRANCH    OVRCD,REALST70
.
          PACK      KEY26,WBSEHOSP,OPRLDATE,OPRLSTOR,OPRLSUOR,ZERO,SP70
          CALL      RSOPDEA1
          CALL      RKOPDEA1
          IF        OVRCD=0
.
            MATCH     OPRLDATE,OPDADATE
            GOTO      REALST35 IF NOT EQUAL
.
            MATCH     OPRLSTOR,OPDATIME
            GOTO      REALST35 IF NOT EQUAL
.
            MATCH     OPRLSUOR,OPDACLIN
            GOTO      REALST35 IF NOT EQUAL
.
            COMPARE   OPDASTAT,ZERO
            GOTO      REALST35 IF NOT EQUAL
.
            GOTO      REALST80
          ENDIF
.
REALST35  PACK      KEY30,SESSKEY2,SP70
          CALL      DEOPRAL1
.
          MOVE      ZERO,EXIT
          GOTO      REALST99
.
REALST40  MATCH     SP70,SESSKEY2
          IF        !@EQUAL
            PACK      KEY30,SESSKEY2,SP70
            CALL      RDOPRAL1
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          STRIP     MTHNAM
          CLEAR     WEBTITLE
          APPEND    "Re-allocated Sessions for ",WEBTITLE
          APPEND    MTHNAM,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,REALST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      REALST99
.
REALST70  MOVE      "Reallocated Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REALST99
.
REALST80  MOVE      "Bookings found. Delete not permitted.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REALST99
.
REALST95  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00 
          MOVE      ONE,EXIT
          GOTO      REALST99
.
REALST99  RETURN
.------------------------------------------------------------
. List Sessions by Date Range
.------------------------------------------------------------
REAL0000  BRANCH    FLDITMNO,REAL0100,REAL0200,REAL0300,REAL0400:
                             REAL0500,REAL0600,REAL0700,REAL0800:
                             REAL0900,REAL1000,REAL1100,REAL1200
. 
REAL0100  CALL      NEXT0000
          GOTO      REAL9999
.         
REAL0200  CALL      PREV0000
          GOTO      REAL9999
.         
REAL0300  CALL      CURSTD00
          GOTO      REAL9999
.         
REAL0400  CALL      CUREND00
          GOTO      REAL9999
.         
REAL0500  CALL      CURYR000
          GOTO      REAL9999
.
REAL0600  CALL      CURMON00
          GOTO      REAL9999
.
REAL0700  CALL      SELV0000
          GOTO      REAL9999
.
REAL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      REAL9999
.
REAL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      REAL9999
.
REAL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      REAL9999
.
REAL1100  CALL      REALTB00
          GOTO      REAL9999
.
REAL1200  WRITE     HTMLFILE;SESSKEY2;
          GOTO      REAL9999
.
REAL9999  RETURN
.------------------------------------------------------------
. Reallocated Sessions List 
.------------------------------------------------------------
REALTB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,F3
          PACK      KEY30,FRSTDATE,SP70    * By Date by Time
          CALL      RSOPRAL1
REALTB10  CALL      RKOPRAL1               * By Date by Time
          BRANCH    OVRCD,REALTB90
          MATCH     OPRLDATE,LASTDATE
          GOTO      REALTB90 IF LESS
.
          MOVE      OPRLSUOR,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      DSNAME,NAME35
            CALL      NAMSTR00
            APPEND    COMMA,DISPNAME
            MOVE      DGNAME,ANS
            APPEND    ANS,DISPNAME
            RESET     DISPNAME
            PACK      SURFNAME,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",SURFNAME
            MOVE      OPCLDESC,SURFNAME
          ENDIF
.
          MOVE      OPRLSUNW,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      DSNAME,NAME35
            CALL      NAMSTR00
            APPEND    COMMA,DISPNAME
            MOVE      DGNAME,ANS
            APPEND    ANS,DISPNAME
            RESET     DISPNAME
            PACK      SURFNAM2,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",SURFNAM2
            MOVE      OPCLDESC,SURFNAM2
          ENDIF
.
          UNPACK    OPRLDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      SESSKEY2,OPRLDATE,OPRLSTOR,OPRLSUOR,OPRLSTNW,OPRLSUNW,SP70
.
          MOVE      OPRLOVST,TIMESTRT
          MOVE      OPRLOVEN,TIMESTOP
          CALL      CALLDURN
.
          REP       " +",SESSKEY2
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowDetail01('",HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&sesskey2=",HTMLLINK
          APPEND    SESSKEY2,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPRLDATE,OPRLSTOR,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",OPRLDATE,OPRLSTNW,"#",":
                             "#"",SURFNAM2,"#",":
                             "#"",OPRLOVST,"#",":
                             "#"",OPRLOVEN,"#",":
                             "#"",DURATION,"#");"
          GOTO      REALTB10
.
REALTB90 
.
REALTB99  RETURN
.------------------------------------------------------------
. Reallocated Sessions variable tags oprralaf
.------------------------------------------------------------
REALD000  BRANCH    FLDITMNO,REALD010,REALD020,REALD030,REALD040:
                             REALD050,REALD060,REALD070,REALD080
.
REALD010  MATCH     SP70,OPRLDATE
          GOTO      REALD999 IF EQUAL
          GOTO      REALD999 IF EOS
          UNPACK    OPRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      REALD999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      REALD999
.
REALD020  WRITE     HTMLFILE;OPRLSTOR;
          GOTO      REALD999
.
REALD030  MOVE      OPRLSUOR,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      DSNAME,NAME35
            CALL      NAMSTR00
            APPEND    COMMA,DISPNAME
            MOVE      DGNAME,ANS
            APPEND    ANS,DISPNAME
            RESET     DISPNAME
            PACK      SURFNAM2,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",SURFNAM2
            MOVE      OPCLDESC,SURFNAM2
          ENDIF
          WRITE     HTMLFILE;SURFNAM2;
          GOTO      REALD999
.
REALD040  WRITE     HTMLFILE;OPRLSTNW;
          GOTO      REALD999
.
REALD050  MOVE      OPRLSUNW,KEY6
          CALL      RDOPCLI1
          IF        OVRCD=0
            MOVE      OPCLDOCT,KEY6
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      DSNAME,NAME35
            CALL      NAMSTR00
            APPEND    COMMA,DISPNAME
            MOVE      DGNAME,ANS
            APPEND    ANS,DISPNAME
            RESET     DISPNAME
            PACK      SURFNAM2,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",SURFNAM2
            MOVE      OPCLDESC,SURFNAM2
          ENDIF
          WRITE     HTMLFILE;SURFNAM2;
          GOTO      REALD999
.
REALD060  WRITE     HTMLFILE;OPRLOVST;
          GOTO      REALD999
.
REALD070  WRITE     HTMLFILE;OPRLOVEN;
          GOTO      REALD999
.
REALD080  MOVE      OPRLOVST,TIMESTRT
          MOVE      OPRLOVEN,TIMESTOP
          CALL      CALLDURN
          WRITE     HTMLFILE;DURATION;
          GOTO      REALD999
.
REALD999  RETURN
.------------------------------------------------------------
. Overlap Duration in Minutes
.------------------------------------------------------------
CALLDURN  MOVE      ZERO,DURATION
          MATCH     TIMESTOP,TIMESTRT
          GOTO      DURN9999 IF EQUAL       * no duration
          GOTO      DURN1000 IF LESS        * times not over midnight
.
.         overlap went over midnight so make end time larger
.         eg 22:00 to 01:00 becomes 22:00 to 25:00 which gives 3 hours duration
.
          UNPACK    TIMESTOP,CHOUR,ANS,CMIN,ANS,CSEC
          MOVE      CHOUR,FORM2
          ADD       "24",FORM2              
          MOVE      FORM2,CHOUR
          PACK      TIMESTOP,CHOUR,ANS,CMIN,ANS,CSEC
.         
.         get end time as seconds
.
DURN1000  UNPACK    TIMESTOP,CHOUR,ANS,CMIN,ANS,CSEC
          MOVE      CHOUR,FORM2             * hour as a form 2
          MOVE      FORM2,FORM6A            * set up work variable
          MULT      "3600",FORM6A           * hours turned into minutes
          MOVE      CMIN,FORM2              * minutes as as form 2
          ASSIGN    (FORM2*60)+FORM6A,FORM6A
          MOVE      CSEC,ISEC               * get seconds as a form field
          ADD       ISEC,FORM6A             * the total minutes of end time
.
.         get start time as minutes
.
          UNPACK    TIMESTRT,CHOUR,ANS,CMIN,ANS,CSEC
          MOVE      CHOUR,FORM2             * hour as a form 2
          MOVE      FORM2,FORM6B            * set up work variable
          MULT      "3600",FORM6B           * hours turned into minutes
          MOVE      CMIN,FORM2              * minutes as as form 2
          ASSIGN    (FORM2*60)+FORM6B,FORM6B
          MOVE      CSEC,ISEC               * get seconds as a form field
          ADD       ISEC,FORM6B             * the total minutes of end time
.
.         duration = end seconds - start seconds
.
          SUB       FORM6B,FORM6A           * the duration
          MOVE      FORM6A,DURATION         * the duration
.
          DIV       "60",DURATION           * get duration as minutes
.
DURN9999  RETURN
.
.------------------------------------------------------------
. Build Surgeon/Anaethesetist list
.------------------------------------------------------------
DOCSEL00  UNPACK    DIM127,D1,DIM1 
          PACK      KEY26,SP70              * Clear Dr Name key
          CALL      RDSDOCT2
DOCSEL10  CALL      RDKDOCT2                * get docs in name order
          BRANCH    OVRCD,DOCSEL99
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH    "1",PTDOHOSS
              IF       @EQUAL
                PACK     KEY13,WBSEHOSP,DCODE,SP70
                CALL     RDMLHCP1
                BRANCH   OVRCD,DOCSEL10
              ELSE
                MATCH    "1",PTCNMHCP         * Only show matching hospitals
                GOTO     DOCSEL10 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   "0",DRSTAT
          GOTO       DOCSEL10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DCODE,"#"";
DOCSEL20  MATCH     "2",DIM1
          GOTO      DOCSEL30 IF EQUAL
          MATCH     DOCTCODE,DCODE
          GOTO      DOCSEL40 IF EQUAL
          GOTO      DOCSEL50
.
DOCSEL30  MATCH     ANAECODE,DCODE  
          GOTO      DOCSEL40 IF EQUAL
          GOTO      DOCSEL50
.
DOCSEL40  WRITE     HTMLFILE;" selected";
.
DOCSEL50  STRIP     DSNAME
          STRIP     DGNAME
          WRITE     HTMLFILE;*+,">",DSNAME,", ",DGNAME,"</option>"
          GOTO      DOCSEL10
.
DOCSEL99  RETURN    
.
.******************************************************************************
.* Check if recovery is closed
.******************************************************************************
RCLS0000  MATCH     SP70,LOCATION           * All locations
          GOTO      RCLS5000 IF EQUAL
.
          MATCH     "ALL",LOCATION          * All locations
          GOTO      RCLS5000 IF EQUAL
.
          PACK      KEY22,LOCATION,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS0100  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS9999
.
          MATCH     LOCATION,OPRCLOCN       * Correct location
          GOTO      RCLS9999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS0100 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS0100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"1";           * Yes recovery closed
          GOTO      RCLS9999
.
RCLS5000  PACK      PTCDKEY2,ANSY,ANSD,SP70
          CALL      RDSCODE2
RCLS6000  CALL      RDKCODE2                   * Read location cat YD
          BRANCH    OVRCD,RCLS9999
.
          MATCH     "YD",TCODE                 * Correct category
          GOTO      RCLS9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE                 * Skip category record
          GOTO      RCLS6000 IF EQUAL
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      RCLS6000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS              * Check hospital security
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,RCLS6000
            ENDIF
          ENDIF
.
          PACK      KEY22,ACODE,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS6100  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS6000
.
          MATCH     ACODE,OPRCLOCN       * Correct location
          GOTO      RCLS6000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS6100 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS6100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS6000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"2";           * Yes a recovery location is closed
.
RCLS9999  RETURN
.
.*****************************************************************************
.         DSAL0000 - disability alert string
.*****************************************************************************
          DEFPROC   DISPALRT
.
          INC       PATALRFD/INC
.
          OPEN      PATALRT1,"patalrtf";
          OPEN      PATMWSA1,"patmwsaf";
.
          READ      CONTROLF,HUND14;*250,PTCNCUDA
.
          MATCH     SP70,PTCNCUDA
          GOTO      DSAL9000 IF EQUAL
.
          PACK      KEY16,PURNO,ANSH,PTCNCUDA,SP70
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,DSAL9000
.
          MATCH     PURNO,PTALURNO
          GOTO      DSAL9000 IF NOT EQUAL
.
          PACK      DIM2,ANSH,PTCNCUDA
          MATCH     PTALCATG,DIM2
          GOTO      DSAL9000 IF NOT EQUAL
.
          MOVE      ZERO,FORM1
.
DSAL1000  PACK      KEY16,PURNO,SP70
          CALL      RSPTALR1
DSAL2000  CALL      RKPTALR1
          BRANCH    OVRCD,DSAL3000
.
          MATCH     PTALURNO,PURNO
          GOTO      DSAL3000 IF NOT EQUAL
.
. CAR 320331 - ignore micro, risk and medical alerts as these already have an
.              icon appearing in the banner elsewhere.
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSAL2000
.
          MATCH     "M",TCINDC5
          GOTO      DSAL2000 IF EQUAL
.
          MATCH     "B",TCINDC5
          GOTO      DSAL2000 IF EQUAL
.
          MATCH     "R",TCINDC5
          GOTO      DSAL2000 IF EQUAL
.
          ADD       ONE,FORM1
          COMPARE   TWO,FORM1
          GOTO      DSAL9200 IF EQUAL
          GOTO      DSAL2000
.
DSAL3000  COMPARE   ONE,FORM1
          GOTO      DSAL9100 IF EQUAL
.
          GOTO      DSAL9000
.
DSAL9000  MOVE      ZERO,EXIT                      * zero
          GOTO      DSAL9999
.
DSAL9100  MOVE      ONE,EXIT                       * one
          PACK      KEY14,PURNO,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,DSAL9999
.
          MATCH     PURNO,PTMWURNO
          GOTO      DSAL9200 IF EQUAL
.
          GOTO      DSAL9999
.
DSAL9200  MOVE      TWO,EXIT                      * two
          GOTO      DSAL9999
.
          INC       PATALRIO/INC
          INC       IBAOVRIO/INC
.
DSAL9999  CLOSE     PATALRT1
          CLOSE     PATMWSA1
          ENDPROC
+
.------------------------------------------------------------
. Prosthetics List
.------------------------------------------------------------
PROLST00  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Prosthetics Input Complete/Incomplete List",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PROLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
PROLST99  RETURN
.
.------------------------------------------------------------
. List Prosthetics by Date Range
.------------------------------------------------------------
PROL0000  BRANCH    FLDITMNO,PROL0100,PROL0200,PROL0300,PROL0400,PROL0500:
                             PROL0600,PROL0700,PROL0800,PROL0900,PROL1000:
                             PROL1100,PROL1200,PROL1300
.
          GOTO      PROL9999 * harmless fall-through
.
PROL0100  CALL      NEXT0000
          GOTO      PROL9999
.
PROL0200  CALL      PREV0000
          GOTO      PROL9999
.
PROL0300  CALL      CURSTD00
          GOTO      PROL9999
.
PROL0400  CALL      CUREND00
          GOTO      PROL9999
.
PROL0500  CALL      CURYR000
          GOTO      PROL9999
.
PROL0600  CALL      CURMON00
          GOTO      PROL9999
.
PROL0700  CALL      SELV0000
          GOTO      PROL9999
.
PROL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PROL9999
.
PROL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      PROL9999
.
PROL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PROL9999
.
PROL1100  CALL      PROTAB00
          GOTO      PROL9999
.
PROL1200  WRITE     HTMLFILE;DOCTCODE;
          GOTO      PROL9999
.
PROL1300  WRITE     HTMLFILE;PICOCODE;
          GOTO      PROL9999
.
PROL9999  RETURN
.----------------------------------------------------------------------
. Prosthetics List by Date Range
.----------------------------------------------------------------------
PROTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
PROTAB10  CALL      RKOPDEA1
          BRANCH    OVRCD,PROTAB90
.
          MATCH     OPDAHOSP,WBSEHOSP
          GOTO      PROTAB90 IF LESS
.
          MATCH     OPDADATE,LASTDATE
          GOTO      PROTAB90 IF LESS
.
          COMPARE   THREE,OPDASTAT          * dont include cancelled bookings
          GOTO      PROTAB10 IF EQUAL
.
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,OPDAUNIT
            GOTO      PROTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,OPDACLIN
            GOTO      PROTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,THEACODE
          IF        !@EQUAL
            MATCH     THEACODE,OPDATHET
            GOTO      PROTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PICOCODE
          GOTO      PROTAB11 IF EQUAL        * All selected
.
          MATCH     "1",PICOCODE
          IF        @EQUAL
            MATCH     "1",OPDAPCOM
            GOTO      PROTAB10 IF NOT EQUAL
          ELSE
            MATCH     "2",PICOCODE
            IF        @EQUAL
              MATCH     "2",OPDAPCOM
              GOTO      PROTAB10 IF NOT EQUAL
            ELSE
              MATCH     "0",OPDAPCOM
              GOTO      PROTAB11 IF EQUAL
              MATCH     SP70,OPDAPCOM
              GOTO      PROTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
PROTAB11  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,PROTAB10
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      PROTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
PROTAB12  CALL      GETSES00
          CALL      CASDET00
.
          MOVE      AURNO,URNUMBER
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          MOVE      OPDATHET,OPERROOM
          MATCH     SP70,OPDATHET
          GOTO      PROTAB15 IF EQUAL
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     OPERROOM
            APPEND    OPRMDESC,OPERROOM
            RESET     OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.
PROTAB15  PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE
          REP       " +",CASEKEYS
          CALL      PATNAM00
.
          MOVE      "Not Applicable      ",PICDIM20
          MATCH     "1",OPDAPCOM
          IF        @EQUAL
            MOVE      "Yes                 ",PICDIM20
          ENDIF
          MATCH     "0",OPDAPCOM
          IF        @EQUAL
            MOVE      "No                  ",PICDIM20
          ENDIF
          MATCH     SP70,OPDAPCOM
          IF        @EQUAL
            MOVE      "No                  ",PICDIM20
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",CASEKEYS,"#",":
                             "#"",OPDADATE,OPDAEXPS,"#",":
                             "#"",OPDAEXPD,"#",":
                             "#"",SURFNAME,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",OPERROOM,"#",":
                             "#"",OPDAADMN,"#",":
                             "#"",KEY3,"#",":
                             "#"",OPDAUNIQ,"#",":
                             "#"",OPDADES1,"#",":
          "#"","oprweb06.pbl?reportno=7&template=1&casekeys=",CASEKEYS,"#",":
                             "#"",PICDIM20,"#",";
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPPIM1
PROTAB50  CALL      RKOPPIM1
          IF        OVRCD=1
            MOVE      SP70,YELFIELD
          ELSE
            MATCH     OPPIUNID,OPDAUNIQ
            IF        @EQUAL
.
              MATCH     "1",OPPIAIMP
              IF        @EQUAL
                MOVE      "BladderCell",YELFIELD
              ELSE
                GOTO      PROTAB50             
              ENDIF
.
            ELSE
              MOVE      SP70,YELFIELD
            ENDIF
          ENDIF
.
          MATCH     "BladderCell",YELFIELD
          IF        @EQUAL
            WRITE     HTMLFILE;"#"";
          ELSE
            MATCH     SP70,OPDAVUN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"":
 "<input type=checkbox value='1' checked onclick=ProVer(this,'",CASEKEYS,"');>";
            ELSE
              WRITE     HTMLFILE;"#"":
 "<input type=checkbox value='1' onclick=ProVer(this,'",CASEKEYS,"');>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"#",";
.
          WRITE     HTMLFILE;"#"",YELFIELD,"#");"
.
          GOTO      PROTAB10
.
PROTAB90
.
PROTAB99  RETURN
.-----------------------------------------------------------------------
          INC       BOKRC1IO/INC
          INC       MLTHCPIO/INC
          INC       OPRCLIIO/INC
          INC       OPRCOMIO/INC
          INC       OPRDEAIO/INC
          INC       OPRPIMIO/INC
          INC       OPRDEBIO/INC
          INC       OPRDECIO/INC
          INC       OPRDEDIO/INC
          INC       OPROPRIO/INC
          INC       OPRRALIO/INC
          INC       OPRSESIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATHSPIO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PMSVX1IO/INC
          INC       PATPR1IO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PATNURIO/INC
          INC       PATALRIO/INC
          INC       SCRMASIO/INC
          INC       OPRARDIO/INC
          INC       OPRWCNIO/INC
          INC       BOKRX1IO/INC   
          INC       BOKDIAIO/INC        
          INC       OPRRCIIO/INC
          INC       OPRSRGIO/INC  
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSPX2IO/INC
.
          INC       CALCAGE
          INC       NAMSTRCD    * Create Name String
          INC       PATDOCTM    * Create Name String
          INC       PATNAMCD
          INC       PATDOCCD
          INC       IBAWEBCD    * Standard WEB Functions
          INC       DAYOFWEK
          INC       CLOPRARD
          INC       CLOPRSRG
          INC       CLPATMIS
          INC       WEBDATCD
          INC       OPRWCNWK
          INC       PMSCURTH
          INC       PMSPX2TM
          INC       LSTALERT        * Alerts column in Patient List   *I-204622
