.******************************************************************************
.*  Include    :  BARCODEF.PBL                                                *
.*  Function   :  Format data for bar code label printing                     *
.*                                                                            *
.*  Paramaters :  MRCNLAYT  -  Label layout                                   *
.*                                                                            *
.*  Mod's      :                                                              *
.******************************************************************************
.* V10.15.01 02/12/2019  Thanh T          TSK 0885298                         *
.*           Changed LABLF840 to call CALCAGE for patient age                 *
.******************************************************************************
.*        V10.03.01 07/11/2011  Mike Laming      CAR 253086                   *
.*                  Added format 14 (Zebra) to MRCNLAYT for WA Health         *
.*        V10.02.03 25/08/2011  Mike Laming      CAR 248541                   *
.*                  Correct Zebra format - now 22 chars using ZEBBAR22        *
.*        V10.02.02 10/06/2011  Mike Laming      CAR 240724                   *
.*                  Remove MRCNBCHI - use LFPREFIX with all codes 22 chars    *
.*        V10.02.01 10/06/2011  Mike Laming      CAR 240724                   *
.*                  Added MRT Table KEY changes & "Hospital Id on Barcode     * 
.*                  Lables" (MRCNBCHI Sec.60 Pos.149)                         * 
.*        V9.12.01  31/07/2009  Ebon Clements    CAR 202737                   *
.*                  Added new layout 13 - Zebra (Medical Record Barcode)      * 
.*        V9.08.01  25/10/2006  Steve Armstrong  CAR 107236                   *
.*                  Added layout 12 (Unformatted output) for MRCNLAYT         *
.******************************************************************************
.*        V9.07.02  14/09/2006  Ebon Clements CAR 107236                      *
.*                  Added MRCNIBAP IBA prefix test to LABLF700 Sato           *
.*        V9.07.01  04/07/2006  Peter Vela    CAR ??????                      *
.*                  Fixed endless loop for BHS Zebra Labels LABLF850          *
.******************************************************************************
.*        V9.04.04  16/09/2005  Mike Laming   CAR 68672                       *
.*                  Mods to add Datamax E-Class printer - MRCNLAYT=11         *
.*        V9.04.03  14/06/2005  Steve Armstrong   CAR 62213                   *
.*                  Mods to use BHS variables for surname, given name & U/R.  *
.*                  Surname & given name are now limited to 15 characters in  *
.*                  length (each) and U/R is left justified.                  *
.*        V9.04.02  01/06/2005  Steve Armstrong   CAR 62213                   *
.*                  - Mods for BHS label to only print the U/R in the barcode *
.*        V9.04.01  30/03/2005  Steve Armstrong   CAR 60350                   *
.*                  - Mods for Ballarat Zebra Labels  (Layout 10)             *
.******************************************************************************
.*        V9.03.01  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      *
.*                  - Add Sex Description routine SEXDSC00 with Code "R" -    *
.*                  "Intersex" added                                          *
.******************************************************************************
.*                V5.08.02  31/08/2000  Tonii                                 *
.*                          Mods to accept Unknown and Indetereminate as      *
.*                          valid patient sex description                     *
.*                V5.08.01  21/06/2000  J Habasque SRF 637148                 *
.*                          Fixed routine for layout 6                        *
.*                V5.07.03  12/01/2000  Jill Habasque SRF 646377              *
.*                          Added layout 8 - Southern Health                  *
.*                V5.07.02  11/08/1999  Jill Habasque SRF 645944              *
.*                          Changed Hawkes Bay to show century for dob        *
.*                V5.07.01  05/02/1999  Steve Armstrong                       *
.*                          Mods for ACC label layout (MRCNLAYT = 7)          *
.*                V5.07.00  12/10/1998  Davin                                 *
.*                          507 changes                                       *
.******************************************************************************
.*                V5.01.01  26/11/92  DIG                                     *
.*                          Modified for changes to BARCODEL                  *
.*                V5.01.02  29/01/93  DWJ                                     *
.*                          Changes for HRH                                   *
.*                V5.01.03  21/04/1994  Steve Armstrong                       *
.*                          Added new layout for Taranaki                     *
.*                V5.01.04  26/04/1994  Steve Armstrong                       *
.*                          Added new layout for Hawkes Bay                   *
.*                V5.01.05  10/05/1994  Steve Armstrong                       *
.*                          Further mods for Taranaki label                   *
.******************************************************************************
.*                V5.02.00  19/10/1994  Rob Leonard   SRF 130390              *
.*                          Setup pats name correctly for standard layout     *
.*                V5.02.01  29/06/1995  ROD           SRF 137007              *
.*                          Change format of patients name to what it         *
.*                          currently was before above change (Surn, Giv)     *
.*                V5.02.03  31/10/1995  Steve Armstrong  SRF 611942           *
.*                          Mods for new layout (6)                           *
.******************************************************************************
.
BARCODEF  BRANCH    MRCNLAYT,LABLF100:           * Std
                             LABLF200:           * W.A.H.B.
                             LABLF300:           * HRH
                             LABLF400:           * THC (Tharo Large)
                             LABLF500:           * HWK (Tharo Wide)
                             LABLF600:           * CHC (Tharo Narrow)
                             LABLF100:           * ACC (Epson DLQ-3000+)
                             LABLF600:           * STH
                             LABLF700:           * Sato CX200
                             LABLF800:           * BHS (Zebra TLP 2844-Z)
                             LABLF900:           * (Datamax E-class) -68672
                             LABLF999:           * Unformatted output
                             LABLF813:           * Zebra(Medical Record Barcode)
                             LABLF814            * Zebra WA Health (MR Barcode)
          GOTO      LABLF999
.
.------ format labels for layout no 1 - Standard layout ------
.
LABLF100  RESET     PSNAME
          RESET     PGNAME
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      SP4,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LABNAME
          MOVE      SP6,LABSEX
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,LABSEX
          REP       UPPLOW,LABSEX
.
LABLF170  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE,CDAY,SLASH,CMON,SLASH,CYEAR
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY: 
                             MRMAVOLN
          MOVE      LABNAME,LABLINE1
          PACK      LABLINE2,LABSEX,SP20,SP4,CPPURNO
          MOVE      LABBDTE,LABLINE3
          PACK      LABLINE4,SP20,SP20,SP20,SP20
          PACK      LABLINE5,SP20,SP20,SP20,SP20
          GOTO      LABLF999
.
.------ Print Labels for layout no 2 - W.A.H.B. ------
.
LABLF200  MOVE      PSNAME,NZSNAME
          MOVE      PGNAME,NZGNAME
          MOVE      CHCSCOD,NZHOSP
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE,CDAY,SLASH,CMON,SLASH,CYEAR
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
          PACK      LABLINE1,NZSNAME,SP2,NZHOSP,SP7,CPPURNO
          PACK      LABLINE2,NZGNAME,SP1,PTITL,SP1,PSEX,SP1,PSAGE,SP1,LABBDTE
          PACK      LABLINE3,SP20,SP20,SP20,SP20
          GOTO      LABLF999
.
.------ Print Labels for layout no 3 - H.R.H. ------
.
LABLF300  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE,CDAY,SLASH,CMON,SLASH,CYEAR
.
          MOVE      CPPURNO,TEMPURNO
          MOVE      PSNAME,TEMPSURN
          MOVE      PGNAME,TEMPGIVN
          MOVE      LABBDTE,TEMPDOB
          MOVE      MRMAVOLN,TEMPVOL
...       MOVE      CPPURNO,DIM8A
...       SQUEEZE   DIM8A
...       PACK      LABID,DIM8A,MRMAHLOC,MRMADOTY,MRMAVOLN
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
.         MOVE      LABID,TEMPLABL
          GOTO      LABLF999
.
.------ Print Labels for layout no 4 - T.A.H.B. ------
.
LABLF400  MOVE      PSNAME,NZSNAME
          MOVE      PGNAME,NZGNAME
          MOVE      CHCSCOD,NZHOSP
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE,CDAY,SLASH,CMON,SLASH,CYEAR
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
          PACK      LABLINE1,CPPURNO
          PACK      LABLINE2,NZSNAME
          PACK      LABLINE3,NZGNAME,SP1,PSEX,SP3,LABBDTE
          MOVE      "                      Volume ",LABLINE4
          ENDSET    LABLINE4
          APPEND    MRMAVOLN,LABLINE4
          RESET     LABLINE4
          GOTO      LABLF999
.
.------ Print Labels for layout no 5 - Hawkes Bay ------
.
LABLF500  MOVE      PSNAME,NZSNAME
          MOVE      PGNAME,NZGNAME
          MOVE      CHCSCOD,NZHOSP
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE1,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
          PACK      LABLINE1,NZSNAME,SP2,NZHOSP,SP7,CPPURNO
          PACK      LABLINE2,NZGNAME,SP1,PTITL,SP1,PSEX,SP5,LABBDTE1
          PACK      LABLINE3,SP20,SP20,SP20,SP20
.
.
          GOTO      LABLF999
.
.------ Print Labels for layout no 6 - Tharo Narrow ----
.
LABLF600  MOVE      PSNAME,NZSNAME
          MOVE      PGNAME,NZGNAME
          MOVE      CHCSCOD,NZHOSP
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LABBDTE,CDAY,SLASH,CMON,SLASH,CYEAR
.                                                                     *C-240724
          PACK      LABID,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
          PACK      LABLINE1,NZSNAME,SP2,NZHOSP,SP7,CPPURNO
          PACK      LABLINE2,NZGNAME,SP1,PTITL,SP1,PSEX,SP5,LABBDTE
          PACK      LABLINE3,SP20,SP20,SP20,SP20
.
          GOTO      LABLF999
.
.         Sato layout
.
LABLF700  MOVE      PSNAME,NZSNAME
.                                                                     *C-240724
          PACK      BARSTRNG,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
.
          MOVE      PGNAME,NZGNAME
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      CPCDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          GOTO      LABLF850
.
.         Zebra Layouts
.                                           * MRCNLAYT = 10 - BHS Zebra
LABLF800  PACK      ZEBRABAR,CPPURNO        * Barcode - U/R No.
          GOTO      LABLF840
.
.                                           * MRCNLAYT = 13 - Zebra (MR Barcode)
LABLF813  PACK      ZEBBAR22,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
          GOTO      LABLF840
.
.                                           * MRCNLAYT = 14 - Zebra WA Health
LABLF814  PACK      ZEBBAR22,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
.
          CLEAR     ZEBFNAME
          REP       UPPLOW,PTMASNAM         * Surname
          STRIP     PTMASNAM
          APPEND    PTMASNAM,ZEBFNAME
          APPEND    ", ",ZEBFNAME
          UNPACK    SP70,KEY1,KEY40
          UNPACK    PMPXFNAM,KEY1,KEY40     * First Name
          REP       UPPLOW,KEY1
          REP       LOWCASE,KEY40
          PACK      KEY30,KEY1,KEY40
          STRIP     KEY30
          APPEND    KEY30,ZEBFNAME
          UNPACK    SP70,KEY1,KEY40
          UNPACK    PMPXSNAM,KEY1,KEY40     * Second Name
          REP       UPPLOW,KEY1
          REP       LOWCASE,KEY40
          PACK      KEY30,SP1,KEY1,KEY40
          STRIP     KEY30
          APPEND    KEY30,ZEBFNAME
          RESET     ZEBFNAME
          STRIP     ZEBFNAME
.
          MOVE      "Vol ",KEY4
          PACK      VOLNO,KEY4,DMRMAVOL
.
          GOTO      LABLF840
.
.
LABLF840  MOVE      CPPURNO,ZEBURNO
          SQUEEZE   ZEBURNO
.
.                                           * Load names
          MOVE      PSNAME,ZEBSNAME
          MOVE      PGNAME,ZEBGNAME
.                                           * Format DOB
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      CPCDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                                           * Sex description
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                   * CALCAGE uses PBDATE
.
.                                           * (also used by LABLF700)
LABLF850  IF        HTLNUM < 10
            MOVE      HTLNUM,FORM1
            PACK      LABNUM,FORM1,SP1,SP1
          ELSE
            IF        HTLNUM < 99
              MOVE      HTLNUM,FORM2
              PACK      LABNUM,FORM2,SP1
            ELSE
              MOVE      HTLNUM,LABNUM
            ENDIF
          ENDIF
.
          GOTO      LABLF999
.
.------ Print labels for layout no 11 - Datamax E-class -----
.
LABLF900  MOVE      ZERO,EXIT
.
.
LABLF910  MOVE      ZERO,EXIT               * Datamax E-class - Label format 1
          MOVE      THREE,LABFONT           * equiv.to "Courier New 14"
.
.                                           * setup Barcode line
.                                                                     *C-240724
          PACK      BARSTRNG,LFPREFIX,CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY:
                             MRMAVOLN
.
.                                           * Label Line 1
          MOVE      "U/R: ",DIM5
          PACK      LBLLEFT1,DIM5,PURNO,SP20
          PACK      LBLRGHT1,SP70
.                                           * Label Line 2
          PACK      LBLLEFT2,PSNAME,SP20
          PACK      LBLRGHT2,PTITL,SP3,PGNAME
.                                           * Label Line 3
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      CPCDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PSEX,DSEXCHAR           * get sex description (in IBACOMN)
          CALL      SEXDSC00                *       returns DSEXDESC & DSEXNO 
          MOVE      "DOB: ",DIM5
          PACK      LBLLEFT3,DIM5,CPCDATE,SP20
          PACK      LBLRGHT3,DSEXDESC,SP20    
.                                           * Label Line 4
          MOVE      "Vol: ",DIM5
          PACK      LBLLEFT4,DIM5,MRMAVOLN,SP20
          PACK      LBLRGHT4,SP20    
.
          GOTO      LABLF999
.
LABLF999  RETURN
