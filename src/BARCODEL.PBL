.******************************************************************************
.*                               BARCODEL.PBL                                 *
.*                               ------------                                 *
.*               This is an include to print Bar Coded Labels                 *
.*                                                                            *
.*  Author          : DIG 13/09/89                                            *
.*                                                                            *
.*  Files Needed    : BARCODFD.INC    TRKCONFD.INC     TRKCONIO.INC           *
.*                    IBAPRINT include and associated files                   *
.*                                                                            *
.*  Parameters Used : PRTTYPE  - The Printer we are printing on :             *
.*                                1 = HP2934A                                 *
.*                                2 = Epson with dongle                       *
.*                                3 = THARO Freedom                           *
.*                                4 = Intermec 3400                           *
.*                                5 = Epson DLQ-3000+                         *
.*                                6 = Sato CX200                              *
.*                                7 = Zebra                                   *
.*                                8 = Datamax E-class                         *
.*                                9 = Generic Barcoding                       *
.*                                                                            *
.*                    HTLNUM   - The number of Labels we are printing         *
.*                                                                            *
.*                    MRCNLAYT  - The layout of the Labels we are             *
.*                               printing :                                   *
.*                                1 = Standard (40 Columns per Label          *
.*                                               8 Rows per Label)            *
.*                                2 = W.A.H.B. (40 Columns per Label          *
.*                                               5 Rows per Label)            *
.*                                3 = H.R.H.   (40 Columns per Label          *
.*                                              8 Rows per Label              *
.*                                              2 Labels Wide)                *
.*                                4 = Tharo Large Bar Code (THC)              *
.*                                5 = Tharo Wide Bar Code (HWK)               *
.*                                6 = Tharo Narrow Bar Code (CHC)             *
.*                                7 = Anne Caudle Centre                      *
.*                                8 = Southern Health (STH)                   *
.*                                9 = SATO CX200                              *
.*                               10 = Zebra (BHS)                             *
.*                               11 = Datamax E-Class                         *
.*                               12 = Unformatted output                      *
.*                               13 = Zebra (Medical Record Barcode)          *
.*                               14 = Zebra WA Health (MR Barcode)            *
.*                                                                            *
.*  Modifications :                                                           *
.******************************************************************************
.* V10.15.01 02/12/2019  Thanh T          TSK 0885298                         *
.*           Changed INTUO000 to use the calculating age from CALCAGE for     *
.*           patient age                                                      *
.******************************************************************************
.*        V10.04.02 03/06/2014  Steve Armstrong  CAR 301905                   *
.*                  Mods to move THC barcode to the left so that it fits      *
.*                  on the label now that we are using long format (LF)       *
.*                  (KEY8 changed from "00500100" to "00500050")              *
.*        V10.04.01 28/05/2014  Steve Armstrong  CAR 301697                   *
.*                  Further mods to handle long format barcode -              *
.*                  Changed RMLDB000 & PRKEYxxx routines to replace the       *
.*                  following:                                                *
.*                       KEY17 - now KEY22                                    *
.*                       KEY16 - now KEY21                                    *
.*                       KEY15 - now KEY20                                    *
.*                       KEY14 - now KEY19                                    *
.*                       KEY13 - now KEY18                                    *
.*                       KEY12 - now KEY17                                    *
.*                       KEY11 - now KEY16                                    *
.*                       KEY10 - now KEY15                                    *
.******************************************************************************
.*        V10.03.03 03/10/2013  Steve Armstrong  CAR 288086                   *
.*                  Mods to make barcode for MRCNLAYT = 13 (HEA) narrower to  *
.*                  fit the long form of the barcode on the label.  Also      *
.*                  removed auto-print of interpretation line under barcode   *
.*                  so that now it is manually printed so that the text is    *
.*                  larger then normal.                                       *
.*        V10.03.02 24/07/2013  Steve Armstrong  CAR 288086                   *
.*                  Updated coordinates for MRCNLAYT = 13 (HEA) to set x      *
.*                  coordinate to 40 instead of 140.  This will move the      *
.*                  barcode to the left of the label thus allowing room for   *
.*                  the long form of the barcode to fit on the label.         *
.*        V10.03.01 07/11/2011  Mike Laming      CAR 253086                   *
.*                  Added format 14 (Zebra) to MRCNLAYT in routine INTZB000   *
.******************************************************************************
.*        V10.02.04 21/09/2011  Steve Armstrong  CAR 250963                   *
.*                  Further mods to positioning and format of Zebra barcode   *
.*                  to fit on the label.                                      *
.*        V10.02.03 13/09/2011  Steve Armstrong  CAR 250963                   *
.*                  With hospital in barcode, changed x co-ordinate for Zebra *
.*                  barcode label from 140 to 50 to move barcode to the left  *
.*                  to fit barcode on label.                                  *
.*        V10.02.02 25/08/2011  Mike Laming      CAR 248541                   *
.*                  Correct Zebra format - now 22 chars using ZEBBAR22        *
.*        V10.02.01 10/06/2011  Mike Laming       CAR 240724                  *
.*                  Mods for "Hospital" KEY in MRT Tables (WA Changes)        *
.******************************************************************************
.*        V9.12.01  31/07/2009  Ebon Clements     CAR 202737                  *
.*                  Added new layout 13 - Zebra (Medical Record Barcode)      *
.******************************************************************************
.*        V9.08.01  13/11/2006  Ebon Clements     CAR 124591                  *
.*                  Commented out GOTO BARLB999 at BARCODEL. Some labels have *
.*                  not printed anything and need to fall through to BARLB100 *
.******************************************************************************
.*        V9.07.01  25/10/2006  Steve Armstrong   CAR 107236                  *
.*                  Added unformatted output (INTUO000)                       *
.******************************************************************************
.*        V9.04.04  16/09/2005  Mike Laming   CAR 68672                       *
.*                  Added code for PRTTYPE 8 (Datamax E-Class Barcode Printer)*
.*                  and MRCNLAYT 11 (Datamax Std.) - see INTDE000             *
.*        V9.04.03  14/06/2005  Steve Armstrong    CAR 62213                  *
.*                  Modified BHS layout (10) to use ZEBSNAME, ZEBGNAME &      *
.*                  ZEBURNO variables for printing.  Also Added "^FS" to end  *
.*                  of barcode string so that only the U/R number prints on   *
.*                  the barcode.  Also moved U/R, title and sex further to    *
.*                  the right.                                                *
.*        V9.04.02  17/05/2005  Steve Armstrong    CAR 62029                  *
.*                  Modified BHS layout (10) to print barcode on the top line *
.*                  for small label layout.                                   *
.*        V9.04.01  30/03/2005  Steve Armstrong    CAR 60350                  *
.*                  Added code for PRTTYPE 7 (Zebra) and MRCNLAYT 10 (BHS -   *
.*                  Zebra).                                                   *
.******************************************************************************
.*        V5.08.03  19/10/2000  Steve Armstrong                               *
.*                  Added Volume to label                                     *
.*        V5.08.02  17/07/2000  Steve Armstrong                               *
.*                  Mods for Sato CX200 printer                               *
.*        V5.08.01  12/01/2000  Jill Habasque  SRF 646377                     *
.*                  Added layout 8 - Southern Health                          *
.*        V5.07.01  29/10/1999  Steve Armstrong                               *
.*                  Mods for HWK Line 1 and Line 2 column position            *
.******************************************************************************
.*                  05/02/1999  Steve Armstrong                               *
.*                  Mods for new label layout (MRCNLAYT = 7 for ACC) and      *
.*                  new printer type  (Epson DLQ-3000+)                       *
.*                  21/09/89 DIG                                              *
.*                  Took out 1 *N from the start of printing                  *
.*                  for labels as it appears that the print                   *
.*                  which sets up the Bar Code characteristics                *
.*                  prints a blank line as well                               *
.*                  16/07/1992    LOFTY and DOG                               *
.*                  remove leading blanks when print the barcode              *
.*                  12/08/92 DWJ                                              *
.*                  Change bar code characteristics for Intermec              *
.*                  26/11/92  DIG                                             *
.*                  Fixed problem with removing leading blanks and            *
.*                  changed H.R.H. labels to print 2 wide and fit             *
.*                  the stationary properly. ABSOLUTE NIGHTMARE!!!            *
.*                  29/01/93  DWJ                                             *
.*                  HRH layout (Quote : 7561)                                 *
.*                  21/07/1993    Lofty the Pom  (Dudley changes)             *
.*                  Allow for PRTTYPE = 2 - Epson printer (with dongle)       *
.*                  10/08/1993    Lofty the Pom  (Dudley changes)             *
.*                  If PRTTYPE = 2, do 4 carriage returns after label (1&2)   *
.*                  11/03/1994    Justin Coates  (Hawkes Bay changes)         *
.*                  added PRTTYPE = 3                                         *
.*                  21/04/1994  Steve Armstrong                               *
.*                  Added layout 4 (Taranaki)                                 *
.*                  26/04/1994  Steve Armstrong                               *
.*                  Added layout 5 (Hawkes Bay)                               *
.*                  10/05/1994  Steve Armstrong                               *
.*                  Further mods to Taranaki label                            *
.*                  22/09/1995  Steve Armstrong    SRF 611942                 *
.*                  Mods for new font for HWK bar code layout                 *
.*                  31/10/1995  Steve Armstrong    SRF 611942                 *
.*                  Mods to reset HWK font back to original setup and to      *
.*                  create a new layout the same as HWK but using the new font*
.*                  (layout 6 for CHC)                                        *
.******************************************************************************
.
BARCODEL  MOVE      FALSE,FLAGDOUB
          PERFORM   PRTTYPE,INTHP000:       * HP2934A
                            INTEP000:       * Epson with dongle
                            INTTH000:       * Tharo Freedom
                            INTHP999:       * Intermec 3400 (only for V6)
                            INTHP999:       * Epson DLQ-3000+ (not required)
                            INTSA000:       * Sato CX200
                            INTZB000:       * Zebra
                            INTDE000:       * Datamax E-class          *I-68672
                            INTUO000        * Unformatted output
.
.....     GOTO      BARLB999
.
. ------- Bar Code Labels routine ------ 
.  
BARLB100  BRANCH    MRCNLAYT,BARLB200:      * Standard Layout
                             BARLB300:      * W.A.H.B.
                             BARLB400:      * H.R.H.
                             BARLB300:      * T.A.H.B.
                             BARLB300:      * Hawkes Bay
                             BARLB300:      * C.H.C.
                             BARLB300:      * A.C.C.
                             BARLB300:      * Southern
                             BARLB999:      * SATO CX200
                             BARLB999:      * BHS (Zebra)
                             BARLB999:      * Datamax E-class          *I-68672
                             BARLB999:      * Unformatted output
                             BARLB999:      * Zebra (Medical Record Barcode)
                             BARLB999       * Zebra WA Health (MR Barcode)
.
          GOTO      BARLB999
.
. ------- Print labels for size 1 ------
.
BARLB200  MOVE      LABID,HP1ID
          MOVE      LABLINE1,HP1LINE1
          MOVE      LABLINE2,HP1LINE2
          MOVE      LABLINE3,HP1LINE3
          MOVE      LABLINE4,HP1LINE4
          MOVE      LABLINE5,HP1LINE5
          MOVE      ZERO,LABCOUNT                      * initialise Label count
.
BARLB225  PRINT     HP1LINE1:
                    *N,HP1LINE2:
                    *N,HP1LINE3:
                    *N,HP1LINE4:
                    *N,HP1LINE5:
                    *N;
          CALL      RMLDB000                * remove the leading blanks & print
          ADD       ONE,LABCOUNT
          COMPARE   LABCOUNT,HTLNUM
          GOTO      BARLB999 IF EQUAL
.
          IF        PRTTYPE = TWO
            PRINT     *N,*N,*N,*N;
          ELSE
            PRINT     *N;
          ENDIF
          GOTO      BARLB225
.
. ------- Print Labels for size 2 ------
.
BARLB300  MOVE      LABID,HP1ID
          MOVE      LABLINE1,HP1LINE1
          MOVE      LABLINE2,HP1LINE2
          IF        MRCNLAYT = 4
            MOVE      LABLINE3,HP1LINE3
            MOVE      LABLINE4,HP1LINE4
          ENDIF
          MOVE      ZERO,LABCOUNT
.
BARLB315  IF        PRTTYPE = 3
            IF        MRCNLAYT = 5|MRCNLAYT = 6|MRCNLAYT = 8
              PRINT     STX,"f320",RET
              PRINT     $BOFF1,RET
            ENDIF
            PRINT     STX,ANSL,RET 
            PRINT     ANSD,ONE,ONE,RET
            PRINT     $BON4,HP1LINE1,RET
            PRINT     $BON5,HP1LINE2,RET
            IF        MRCNLAYT = 4
              PRINT     $BON6,HP1LINE3,RET
              PRINT     $BON7,HP1LINE4,RET
            ENDIF
          ELSE
            IF        PRTTYPE = 5 & MRCNLAYT = 7
              PRINT     LABLINE1                    * Epson DLQ-3000+
              PRINT     LABLINE2
              PRINT     LABLINE3
              PRINT     LABLINE4

              MATCH     "1",MRCNBCHI
              IF        @EQUAL
                PRINT     ESC,LBR,UCB,LEN,NULL,CODE39,DPI,MINUS3,BLEN,NULL,STX:
                         CPPURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,*N,*N,*N,*N
              ELSE
                PRINT     ESC,LBR,UCB,LEN,NULL,CODE39,DPI,MINUS3,BLEN,NULL,STX:
                          CPPURNO,MRMAHLOC,MRMADOTY,MRMAVOLN,*N,*N,*N,*N
              ENDIF
            ELSE
              PRINT     HP1LINE1:
                        *N,HP1LINE2:
                        *N;
            ENDIF
          ENDIF
          CALL      RMLDB000                * remove the leading blanks & print
          ADD       ONE,LABCOUNT
          COMPARE   LABCOUNT,HTLNUM
          GOTO      BARLB999 IF EQUAL
          IF        PRTTYPE = TWO
            PRINT     *N,*N,*N,*N;
          ELSE
            IF        PRTTYPE <> 5
              PRINT     *N;
            ENDIF
          ENDIF
          GOTO      BARLB315
.
.------ Print Labels for layout 3 (H.R.H.) ------
.
BARLB400  MOVE      LABID,HP1ID
          CALL      RMLDB000
.
BARLB999  RETURN
+
.************************************************************************
.*                               INTHP000                               *
.*          Routine to initialise the Bar Code characteristics and      *
.*          sequences for the HP2934A printer.                          *
.************************************************************************
INTHP000  PACK      $BON1,ESC,AST,ZZZ            * Bar code on sequence
          PACK      $BOFF1,UZZ                   * Bar code off sequence
.
.------ Set up the Characteristics for the Bar Codes ------
.
          IF        MRCNLAYT <> THREE
.           PRINT     $BON1,ZER,VVV,ZER,QQQ,THR,RRR,ONE,SSS,THR,TTT,ONE,UUU:
.                           THR,UHH
.         ELSE
            PRINT     $BON1,ZER,VVV,ZER,QQQ,THR,RRR,ONE,SSS,THR,TTT,ONE,UUU:
                            FIV,UHH
          ENDIF
.
INTHP999  RETURN
+
.*********************************************************************
.*                  INTEP000
.*        initilize the bar code characteristics for epson with dongle 
.*********************************************************************
INTEP000  PACK      $BON2,ESC,LCI,LCS,TWO,ANSB   * Bar code on sequence
          PACK      $BOFF1,BSL                   * Bar code off sequence
.
INTEP999  RETURN
+
.*********************************************************************
.*                  INTTH000
.*        initilize the bar code characteristics for Tharo printer 
.*        the string is made up of the following characters
.*                  a        = rotation
.*                  b        = font
.*                  c        = height multiplier
.*                  d        = width multiplier
.*                  eee      = bar code height
.*                  ffff     = row position
.*                  gggg     = column position
.*********************************************************************
INTTH000  IF        MRCNLAYT = 2
            MOVE      "078",KEY3
            MOVE      "00000020",KEY8                        * WAHB
            PACK      $BON3,ONE,ANSA,EIGHT,TWO,KEY3,KEY8     * Barcode
          ELSE
            IF        MRCNLAYT = 5
              MOVE      "078",KEY3
              MOVE      "00000020",KEY8                        * Hawkes Bay
              PACK      $BON3,ONE,ANSA,EIGHT,TWO,KEY3,KEY8     * Barcode
.                              a   b     c    d  eee  ffffgggg
            ELSE
              IF        MRCNLAYT = 6
                MOVE      "078",KEY3
                MOVE      "00000020",KEY8                        * CHC
                PACK      $BON3,ONE,ANSE,EIGHT,TWO,KEY3,KEY8     * Barcode
.                                a   b     c    d  eee  ffffgggg
              ELSE
                IF        MRCNLAYT = 8
                  MOVE      "018",KEY3
                  MOVE      "00000050",KEY8                        * STH
                  PACK      $BON3,ONE,ANSE,EIGHT,TWO,KEY3,KEY8     * Barcode
.                                  a   b     c    d  eee  ffffgggg
                ELSE
                  MOVE      "100",KEY3
                  MOVE      "00500050",KEY8                        * TAHB 
                  PACK      $BON3,ONE,ANSA,FOUR,TWO,KEY3,KEY8      * Barcode
.                                  a   b    c    d   eee  ffffgggg
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "000",KEY3
          IF        MRCNLAYT = 2|MRCNLAYT = 5|MRCNLAYT = 6|MRCNLAYT = 8
            IF        MRCNLAYT = 5
              MOVE      "01050020",KEY8                        * Hawkes Bay
            ELSE
              IF        MRCNLAYT = 8
                MOVE      "00550050",KEY8                      * STH
              ELSE
                MOVE      "01150020",KEY8                      * WAHB
              ENDIF
            ENDIF
            PACK      $BON4,ONE,THREE,ONE,ONE,KEY3,KEY8      * Line 1
.                            a    b    c   d  eee  ffffgggg
          ELSE
            MOVE      "03300250",KEY8                        * TAHB
            PACK      $BON4,ONE,SIX,ONE,ONE,KEY3,KEY8        * Line 1
.                            a   b   c   d  eee  ffffgggg
          ENDIF
.
          IF        MRCNLAYT = 2|MRCNLAYT = 5|MRCNLAYT = 6|MRCNLAYT = 8
            IF        MRCNLAYT = 5
              MOVE      "00900020",KEY8                      * Hawkes Bay 
            ELSE
              IF        MRCNLAYT = 8
                MOVE      "00350050",KEY8                    *STH
              ELSE
                MOVE      "00950020",KEY8                    * WAHB
              ENDIF
            ENDIF
            PACK      $BON5,ONE,THREE,ONE,ONE,KEY3,KEY8      * Line 2 
.                            a    b    c   d  eee  ffffgggg
          ELSE
            MOVE      "03000100",KEY8                        * TAHB
            PACK      $BON5,ONE,FIVE,ONE,ONE,KEY3,KEY8       * Line 2
.                            a    b   c   d  eee  ffffgggg
          ENDIF
.
          IF        MRCNLAYT = 4
            MOVE      "02500100",KEY8                         * TAHB
            PACK      $BON6,ONE,THREE,ONE,ONE,KEY3,KEY8       * Line 3
.                            a    b    c   d  eee  ffff   gggg
            MOVE      "005",KEY3
            MOVE      "01700100",KEY8                         * TAHB
            PACK      $BON7,ONE,NINE,ONE,ONE,KEY3,KEY8         * Line 4
.                            a    b    c   d  eee  ffff   gggg
          ENDIF
.
          PACK      $BOFF1,ANSE                  * Bar code off sequence
.
INTTH999  RETURN
+
.******************************************************************************
.*                  INTSA000                                                  *
.*        Initialize the bar code characteristics for Sato printer.           *
.*        The string is made up of the following characters:                  *
.*        ESCA - Start Command                                                *
.*        ESCLaabb - Character expansion where                                *
.*                       aa = multiple to expand horizontally (1-12)          *
.*                       bb = multiple to expand vertically   (1-12)          *
.*        ESCQaaaaaa - Print Quantity where                                   *
.*                       aaaaaa - total number of labels to print (1-65535)   *
.*        ESCZ - Stop Command                                                 *
.*        ESCHaaaa - Horizontal Position where                                *
.*                      aaaa = no. of dots horizontally from the base ref.    *
.*                             point                                          *
.*        ESCVbbbb - Vertical Position where                                  *
.*                      bbbb = no. of dots vertically from the base ref.      *
.*                             point                                          *
.*        ESCXU - Font XU                                                     *
.*        ESCBabbcccd - Bar Code where                                        *
.*                        a = "1" (Code 39)                                   *
.*                        bb = no. of dots (1-12)                             *
.*                        ccc = barcode height in dots                        *
.*                        d = N/A                                             *
.*        ESCQaaaaaa - Print Quantity where                                   *
.*                        aaaaaa = no. of labels to print                     *
.******************************************************************************
.
INTSA000  PRINT     ESC,ANSA:                              * Start
                    ESC,ANSH,ZERO,ZERO,FIVE,ZERO:          * Set horizontal posn
                    ESC,ANSV,ZERO,ZERO,ONE,ZERO:           * Set vertical posn
                    ESC,ANSL,ZERO,THREE,ZERO,THREE:        * set char. expansion
                    ESC,ANSX,ANSU,NZSNAME:                 * print surname
                    ESC,ANSH,ZERO,FIVE,ZERO,ZERO:          * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,ONE,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,CPPURNO:                 * print U/R (font XU)
                    ESC,ANSH,ZERO,SIX,SEVEN,ZERO:          * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,ONE,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,"Vol: ",MRMAVOLN:        * print volume
                    ESC,ANSH,ZERO,ZERO,FIVE,ZERO:          * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,SIX,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,NZGNAME:                 * print given name
                    ESC,ANSH,ZERO,FOUR,FOUR,ZERO:          * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,SIX,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,PTITL:                   * print title
                    ESC,ANSH,ZERO,FIVE,FIVE,ZERO:          * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,SIX,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,PSEX:                    * print sex
                    ESC,ANSH,ZERO,SIX,ZERO,ZERO:           * set horizontal posn
                    ESC,ANSV,ZERO,ZERO,SIX,ZERO:           * set vertical posn
                    ESC,ANSX,ANSU,CPCDATE:                 * print dob
                    ESC,ANSH,ZERO,ZERO,SIX,ZERO :          * set horizontal posn
                    ESC,ANSV,ZERO,ONE,ZERO,ZERO:           * set vertical posn
                    ESC,ANSL,ZERO,ONE,ZERO,ONE:            * set char. expansion
                    ESC,ANSB,ONE,ZERO,TWO,ZERO,EIGHT,ZERO,ASK,BARSTRNG,ASK:
                    ESC,ANSQ,LABNUM:                       * set no. of labels
                    ESC,ANSZ                               * stop
.
.         Remove the last CALL from the stack as we have finished printing the 
.         label and can return directly to the calling program
.
          NORETURN
.
INTSA999  RETURN
+
.******************************************************************************
.*                  INTZB000                                                  *
.*        Initialize the bar code characteristics for Zebra printer.          *
.*        The string is made up of the following characters:                  *
.*        ^XA - indicates start of new label                                  *
.*        ^PWa - print width (where a is the width in dots)                   *
.*               this is set to an arbitrary large number (10000) so          *
.*               that the full label width will be used.                      *
.*        ^FOx,y - field origin.                                              *
.*               position on label where x = horizontal coordinate and        *
.*               y = vertical coordinate (in dots).                           *
.*        ^Afo,h,w - scalable font.                                           *
.*               where f = font id, o = orientation (R = rotated 90deg),      *
.*               h = character height (in dots), w = width (in dots).         *
.*        ^FDa - Field data (where a is data to be printed)                   *
.*        ^FS - Field separator (indicates end of field data).                *
.*        ^BYw - Bar code field default (where w = width in dots)             *
.*        ^B3o,e,h,f,g - Code 39 barcode                                      *
.*               o = orientation (N = normal)                                 *
.*               e = check digit (not used - set to N)                        *
.*               h = bar code height (in dots)                                *
.*               f = print interpretation line (Y or N)                       *
.*                   controls whether actual barcode data is printed with     *
.*                   the barcode                                              *
.*               g = print interpretation line above code (Y or N)            *
.*                   if "f" is set to "Y", this controls whether the data is  *
.*                   displayed above or below the barcode                     *
.*        ^PQq - print quantity (where q is the quantity of labels reqd)      *
.*        ^XZ - indicates end of label                                        *
.******************************************************************************
.
.                                           * Start new label
INTZB000  COMPARE   "10",MRCNLAYT   
          GOTO      INTZB100 IF EQUAL       * BHS (Zebra TLP 2844-Z)
          COMPARE   "13",MRCNLAYT
          GOTO      INTZB130 IF EQUAL       * Zebra (Medical Records Barcode)
          COMPARE   "14",MRCNLAYT
          GOTO      INTZB140 IF EQUAL       * Zebra WA Health (MR Barcode)
.
.
                                 * MRCNLAYT = 10 - BHS (Zebra TLP 2844-Z)     
.
..                  "^XA^PW10000"                                 ...zebra code
INTZB100  PRINT     CARET,ANSX,ANSA:                         * Start new label
                    CARET,ANSP,ANSW,ONE,ZERO,ZERO,ZERO,ZERO; * Set print width
.                                                     * Set barcode coordinates
..                  "^FO230,25^BY2^B3N,N,50,Y,N"                  ...zebra code
          PRINT     CARET,ANSF,ANSO,TWO,THREE,ZERO,COMMA,TWENTY5:
                    CARET,ANSB,ANSY,TWO:                     * Set barcode width
                    CARET,ANSB,THREE,ANSN,COMMA,ANSN,COMMA:  * Set barcode vars
                    FIFTY,COMMA,ANSY,COMMA,ANSN;
.
..                  "^FD",ZEBRABAR,"^FS"                          ...zebra code
          PRINT     CARET,ANSF,ANSD,ZEBRABAR,CARET,ANSF,ANSS; * Print barcode
.
          GOTO      INTZB135           * common to MRCNLAYT=10 & MRCNLAYT=13
.
.
.
                                 * MRCNLAYT = 13 - Zebra(Medical Record Barcode)
.
INTZB130  PRINT     CARET,ANSX,ANSA:                         * Start new label
                    CARET,ANSP,ANSW,ONE,ZERO,ZERO,ZERO,ZERO; * Set print width
.                                                     * Set barcode coordinates
          PRINT     CARET,ANSF,ANSO,TWO,THREE,ZERO,COMMA,TWENTY5:
                    CARET,ANSB,ANSY,ONE:                     * Set barcode width
                    CARET,ANSB,THREE,ANSN,COMMA,ANSN,COMMA:  * Set barcode vars
                    FIFTY,COMMA,ANSN,COMMA,ANSN;
.     
          PRINT     CARET,ANSF,ANSD,ZEBBAR22,CARET,ANSF,ANSS; * Print barcode
.
.         Print Interpretation Line directly under the barcode.
.         This is done separately as we want larger text than what
.         would normally be printed if we were printing the Interpretation
.         Line automatically as part of the barcode.
.
          PRINT     CARET,ANSF,ANSO,TWO,EIGHT,ZERO,COMMA,EIGHTY:
                    CARET,ANSA,ZERO,ANSN,COMMA,TWENTY,COMMA,TWENTY9:
                    CARET,ANSF,ANSD,ZEBBAR22,CARET,ANSF,ANSS;
.
INTZB135  MOVE      SP1,KEY1           * common to MRCNLAYT=10 & MRCNLAYT=13
.                                           * Set surname coordinates
          PRINT     CARET,ANSF,ANSO,TWO,THREE,ZERO,COMMA,ONE,ONE,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,ZEBSNAME,CARET,ANSF,ANSS:   * Print surname
.
.                                           * Set U/R coordinates
                    CARET,ANSF,ANSO,FIVE,ZERO,ZERO,COMMA,ONE,ONE,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,ZEBURNO,CARET,ANSF,ANSS:     * Print U/R no.
.
.                                           * Set given name coordinates
                    CARET,ANSF,ANSO,TWO,THREE,ZERO,COMMA,ONE,SIX,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,ZEBGNAME,CARET,ANSF,ANSS: * Print given name
.
.                                           * Set title coordinates
                    CARET,ANSF,ANSO,FIVE,ZERO,ZERO,COMMA,ONE,SIX,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,PTITL,CARET,ANSF,ANSS:        * Print title
.
.                                           * Set dob coordinates
                    CARET,ANSF,ANSO,TWO,THREE,ZERO,COMMA,TWO,ONE,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,CPCDATE,CARET,ANSF,ANSS:        * Print dob
.
.                                           * Set sex coordinates
                    CARET,ANSF,ANSO,FIVE,ZERO,ZERO,COMMA,TWO,ONE,ZERO:
                    CARET,ANSA,ZERO,ANSN,COMMA,THIRTY1,COMMA,TWENTY9: * Set font
                    CARET,ANSF,ANSD,DSEXDESC,CARET,ANSF,ANSS;      * Print sex
.
          GOTO      INTZB500           * common routine to end label
.
.
                                 * MRCNLAYT = 14 - Zebra WA Health (MR Barcode)
INTZB140  PRINT     "^XA^PW10000":                   * Start label, print width
                    "^FO100,25^BY2,2^B3N,N,50,N,N":  * Set barcode coordinates
                    "^FD",ZEBBAR22,"^FS":            * Print barcode
.
.                                                    * Set U/R No. & print
                    "^FO100,100^A0N,41,34^FD",ZEBURNO,"^FS":
.                                                    * Set Volume No. & print
                    "^FO350,100^A0N,41,34^FD",VOLNO,"^FS":
.                                                    * Set Full Name & print
                    "^FO100,155^A0N,51,44^FD",*+,ZEBFNAME,"^FS":
.                                                    * Set DoB  & print
                    "^FO100,220^A0N,41,34^FD",CPCDATE,"^FS":
.                                                    * Set sex desc & print
                    "^FO350,220^A0N,41,34^FD",DSEXDESC,"^FS";
.
          GOTO      INTZB500           * common routine to end label
.     
.     
.     
...                 "^PQ",LABNUM,"^XZ"                             * zebra code
INTZB500  PRINT     CARET,ANSP,ANSQ,LABNUM:                * Set print quantity
                    CARET,ANSX,ANSZ                        * Set end of label
.
.         Remove the last CALL from the stack as we have finished printing the 
.         label and can return directly to the calling program
.
          NORETURN
.
INTZB999  RETURN
+
.*********************************************************************
.*                  INTDE000
.*        initilize the bar code characteristics for Datamax E-class (Std)
.*        the string is made up of the following characters :-
.*        <STX>L  - (Ctrl-B)L - Begin Label
.*        D11     - Label header record - set width & dot multipliers (1 & 1)
.*        PK      - set print speed (152 dots/sec)
.*        pE      - set backfeed speed
.*        SK      - set slew speed  (152 dots/sec default)
.*        A2      - set format attribute  (2=Transparent mode)
.*        <STX>ySW1 - set font symbol set "W1" (doesn't seem to do much)
.*        Qnnnn   - set no. of labels where "nnnn" to be zero filled
.*        E       - terminate record
.*
.*    For actual print lines, see further below for BARFMAT & TXTFMAT as set
.*    for the following sample "PRINT" statements -
.*                             __________________* Vert. (Inch/100 from bot.Left
.*                            |       ___________* Horiz.(Inch/100 from bot.left
.*                            |      |
.*        PRINT     BARFMAT,"0120","0020",BARSTRNG    * print Barcode
.*        PRINT     TXTFMAT,"0095","0020",LBLLEFT1,*N:
.*                  TXTFMAT,"0095","0190",LBLLEFT2,*N:
.*
.*        NOTE - each command to be terminated with <CR> (or "PRINT *N")      
.*********************************************************************
.
INTDE000  COMPARE   ZERO,HTLNUM
          GOTO      INTDE999 IF EQUAL
.
.                                           * data set up in BARCODEF
.
          PACK      BARFMAT,ONE:                      * set rotation
                            ANSA:                     * set font (A=Barcode)
                            SEVEN:                    * set width multiplier
                            TWO:                      * set height multiplier
                            ZERO,FIVE,ZERO            * set  barcode height
.
          PACK      TXTFMAT,ONE:                      * set rotation
                            LABFONT:                  * set font (in BARCODEF)
                            ONE:                      * set width multiplier
                            ONE:                      * set height multiplier
                            ZERO,ZERO,ZERO            * set scalable font
.
.*************** these codes only needed if using scalable fonts *************
....      PACK      TXTFMAT,ONE:                      * set rotation
....                        NINE:                     * set font (A=Barcode)
....                        ONE:                      * set width multiplier
....                        ONE:                      * set height multiplier
....                        ANSS,ZERO,ONE             * set scalable font
.....
....      PACK      TXTSIZE,ANSP,ZERO,ONE,ZERO:       * Scalable height (Points)
....                        ANSP,ZERO,ZERO,EIGHT      * Scalable width (Points)
.******************************************************************************
.
          PRINT     STX,ANSL,*N:                      * Start
                    "D11",*N:                         * Set width & dot size
                    "PK",*N:                          * Set print speed
                    "pE",*N:                          * set backfeed speed
                    "SK",*N:                          * Set slew speed
                    "A2"                              * set format attribute
.
.                              __________________* Vert. (Inch/100 from bot.Left
.                             |       ___________* Horiz.(Inch/100 from bot.left
.                             |      |
          PRINT     BARFMAT,"0120","0020",BARSTRNG    * print U/R Barcode
.
....      PRINT     STX,"ySW1"                        * set font symbol set "W1"
....      PRINT     TXTFMAT,"0055","0005",TXTSIZE,LABLINE1  * only scalable font
.
.                                                     * Line 1
.                              __________________* Vert. (Inch/100 from bot.Left
.                             |       ___________* Horiz.(Inch/100 from bot.left
.                             |      |
          PRINT     TXTFMAT,"0095","0020",LBLLEFT1,*N:
                    TXTFMAT,"0095","0190",LBLRGHT1
.                                                     * Line 2
          PRINT     TXTFMAT,"0065","0020",LBLLEFT2,*N:
                    TXTFMAT,"0065","0190",LBLRGHT2
.                                                     * Line 3
          PRINT     TXTFMAT,"0035","0020",LBLLEFT3,*N:
                    TXTFMAT,"0035","0190",LBLRGHT3
.                                                     * Line 4
          PRINT     TXTFMAT,"0005","0020",LBLLEFT4,*N:
                    TXTFMAT,"0005","0190",LBLRGHT4
.
          PRINT     "Q0",LABNUM,*N:                   * set no. of labels
                    ANSE                              * terminate record
.
.         Remove the last CALL from the stack as we have finished printing the
.         label and can return directly to the calling program
.
INTDE900  NORETURN
.
INTDE999  RETURN
+
.*****************************************************************************
.*                         INTUO000                                          *
.*            Routine to produce unformatted output                          *
.*****************************************************************************
.
INTUO000  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MATCH     "1",MRCNBCHI
          IF        @EQUAL
            PRINT     *1,"MRTLABEL",*N:
                      *1,"UR NUMBER:",PURNO,*N:
                      *1,"SURNAME:",PSNAME,*N:
                      *1,"GIVEN NAMES:",PGNAME,*N:
                      *1,"TITLE:",PTITL,*N:
                      *1,"DATE OF BIRTH:",CPCDATE,*N:
                      *1,"AGE:",PSAGEYRS,*N:
                      *1,"SEX:",PSEX,*N:
                      *1,"VOLUME:",MRMAVOLN,*N:
                      *1,"HOME LOCATION:",MRMAHLOC,*N:
                      *1,"DOCUMENT TYPE:",MRMADOTY,*N:
                      *1,"HOSPITAL CODE:",MRMAHHOS,*N:
                      *1,"NUMBER OF LABELS:",HTLNUM,*N
          ELSE
            PRINT     *1,"MRTLABEL",*N:
                      *1,"UR NUMBER:",PURNO,*N:
                      *1,"SURNAME:",PSNAME,*N:
                      *1,"GIVEN NAMES:",PGNAME,*N:
                      *1,"TITLE:",PTITL,*N:
                      *1,"DATE OF BIRTH:",CPCDATE,*N:
                      *1,"AGE:",PSAGEYRS,*N:
                      *1,"SEX:",PSEX,*N:
                      *1,"VOLUME:",MRMAVOLN,*N:
                      *1,"HOME LOCATION:",MRMAHLOC,*N:
                      *1,"DOCUMENT TYPE:",MRMADOTY,*N:
                      *1,"HOSPITAL CODE:",CHCSCOD,*N:
                      *1,"NUMBER OF LABELS:",HTLNUM,*N
          ENDIF
.
.         Remove the last CALL from the stack as we have finished printing the
.         label and can return directly to the calling program
.
          NORETURN
.
INTUO999  RETURN
+
.*********************************************************************
.                   RMLDB000
.         Remove leading spaces for intermec bar-code reader for 
.         printing the barcode
.*********************************************************************
RMLDB000  MOVE      ONE,FORM2
          MOVE      HP1ID,TEMPHPID
.
RMLDB100  CMATCH    SP1,TEMPHPID
          GOTO      RMLDB200 IF NOT EQUAL   * no more blanks
.
          ADD       ONE,FORM2               * add to count of blanks
          BUMP      TEMPHPID,1
          GOTO      RMLDB100 IF NOT EOS     * more of string to go
.
RMLDB200  STORE     TEMPHPID,FORM2,KEY22,KEY21,KEY20,KEY19,KEY18:
                                   KEY17,KEY16,KEY15
.  
.         print the string
.
          BRANCH    MRCNLAYT,RMLDB300:
                             RMLDB300:
                             RMLDB400:
                             RMLDB300:
                             RMLDB300:
                             RMLDB300:
                             RMLDB300:
                             RMLDB300:
                             RMLDB999     * EPW not used
.
RMLDB300  PERFORM   FORM2,PRKEY220,PRKEY210,PRKEY200,PRKEY190,PRKEY180:
                          PRKEY170,PRKEY160,PRKEY150
          GOTO      RMLDB999
.
RMLDB400  BRANCH   FORM2,RMLDB410,RMLDB420,RMLDB430,RMLDB440,RMLDB450:
                         RMLDB460,RMLDB470,RMLDB480
.
RMLDB410  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY22,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB420  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY21,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB430  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY20,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB440  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY19,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB450  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY18,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB460  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY17,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB470  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY16,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB480  PRINT     STX,ESC,EEE,THR,CAN,TEMPURNO,RET,TEMPSURN,RET,TEMPGIVN,RET:
                    TEMPDOB,RET,TEMPVOL,RET,KEY15,RS,HTLNUM,ETB,ETX;
          GOTO      RMLDB999
.
RMLDB999  RETURN
+
.*********************************************************************
.         routines to print the required length for the barcode
.*********************************************************************
PRKEY150  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY15,GT,ZZZ,FRTY2,LCC,LT,KEY15,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY15,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY15,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY15,RET
            ELSE
              PRINT     $BON3,KEY15,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY160  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY16,GT,ZZZ,FRTY2,LCC,LT,KEY16,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY16,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY16,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY16,RET
            ELSE
              PRINT     $BON3,KEY16,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY170  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY17,GT,ZZZ,FRTY2,LCC,LT,KEY17,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY17,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY17,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY17,RET
            ELSE
              PRINT     $BON3,KEY17,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY180  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY18,GT,ZZZ,FRTY2,LCC,LT,KEY18,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY18,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY18,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY18,RET
            ELSE
              PRINT     $BON3,KEY18,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY190  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY19,GT,ZZZ,FRTY2,LCC,LT,KEY19,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY19,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY19,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY19,RET
            ELSE
              PRINT     $BON3,KEY19,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY200  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY20,GT,ZZZ,FRTY2,LCC,LT,KEY20,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY20,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY20,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY20,RET
            ELSE
              PRINT     $BON3,KEY20,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY210  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY21,GT,ZZZ,FRTY2,LCC,LT,KEY21,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY21,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY21,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY21,RET
            ELSE
              PRINT     $BON3,KEY21,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
.
PRKEY220  IF        PRTTYPE = ONE
            IF        FLAGDOUB = TRUE
              PRINT     $BON1,ONNE,LCC,LT,KEY22,GT,ZZZ,FRTY2,LCC,LT,KEY22,GT:
                        $BOFF1;
            ELSE
              PRINT     $BON1,ONNE,LCC,LT,KEY22,GT,$BOFF1;
            ENDIF
          ENDIF
          IF        PRTTYPE = TWO
            PRINT     $BON2,KEY22,$BOFF1;
          ENDIF
          IF        PRTTYPE = THREE
            IF        MRCNLAYT = 6
              PRINT     $BON3,ANSA,KEY22,RET
            ELSE
              PRINT     $BON3,KEY22,RET
            ENDIF
            PRINT     ANSQ,"0001",RET
            PRINT     $BOFF1,RET
          ENDIF
          RETURN
+
