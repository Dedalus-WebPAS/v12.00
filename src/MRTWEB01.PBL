.------------------------------------------------------------------------------
. Program       : MRTWEB01 
.
. Function      : Medical Record Tracking Maintenance
.
.                     
. Modifications  :
.-------------------------------------------------------------------------------
. V12.00.01 14/08/2025  Thanh T        TSK 0963125
.           Changed XMLMRT72 to add retrieve the correct currect loction
.           when Visit Number is selected
. V11.05.03 15/04/2025  Ebon Clements TSK 0950532
.           Added coding template diagnosis cluster id functionality
. V11.05.02 02/04/2025  Ebon Clements TSK 0950532
.           Added MRTDDCID to CLRTDT00. Added MRTTD007 for MRTDDCID
. V11.05.01 27/11/2024  Ebon Clements TSK 0954191
.           Recompiled for PATCODTM
. V11.04.05 07/08/2024  Alina Bhari   TSK 0922829 
.           displayed MRT status description as per the configured hex value
.           color in Cat RS-RECSTATC,XMLMRT75,XMLMRT85,MASTB200,MASTB900
.           MSDTB310,SRMTB400                                              
. V11.04.04 22/07/2024  PJ Le Febour  TSK 0948466a
.           MLST2500 - correction by removal of comma in GOTO IF EQUAL
. V11.04.03 19/07/2024  PJ Le Febour  TSK 0948466
.           MLST2500 filter for Operator ID added
. V11.04.02 29/02/2024  Ebon Clements TSK 0932517
.           Allow operation prefix I and N - VALICO00
. V11.04.01 17.01/2024  DA Sarkies    TSK 0932689
.           Removec the onclick function from the MRs list. Added code to save
.           multiple volumes into the MR Visits Table.
. V11.03.01 22/11/2022  Bella Turco   TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.06 20/10/2022  Bella Turco   TSK 0925906
.           Moved "Medical Record Master Maintenance" to WEBTITLE in MRTMAS40 
. V11.02.05 30/09/2022  Jacob Jackson TSK 0910609
.           Ensure created by/updated by fields would update when volume
.           changes
. V11.02.04 13/09/2022  Alina Bhari   TSK 0910609
.           Displayed 2 field (Created by and Updated by)                   
.           -MRTA0000,MRTA4400,MRTA4500,MRTA4600,MRTA4700,MRTA4800,MRTA4900
. V11.02.03 16/05/2022  Thanh T       TSK 0901057
.           Added XMLMRT72 to return the volume number of the medical record
.           link visit 
. V11.02.02 01.04.2022  DA Sarkies    TSK 0905611
.           Recompiled for PATNAMCD
. V11.02.01 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTHEDFD changes
. V11.01.01 26/04/2021  Ebon Clements  TSK 0901388
.           Recompiled for MRTPSHFD - Free text description
. V11.00.02 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 28/10/2020  Ebon Clements     TSK 0848770
.           Added OVRCD test to MRT loction display tag - MRTA0200
.-------------------------------------------------------------------------------
. V10.15.01 02/12/2019  Thanh T           TSK 0885298
.           Recompiled for BARCODEF changes
.-------------------------------------------------------------------------------
. V10.14.01 10/09/2019  Ken Bell          TSK 0872529
.           Modify CHDVIS00 delete logic to override orphan PATMI1AF visit links
.           remaining from V10.01 CAR 242450 since they have not been cleaned up
.-------------------------------------------------------------------------------
. V10.12.02 28/05/2018  Ebon Clements     TSK 0852045
.           Added home hospital test to home location warning - XMLCHK20
. V10.12.01 23/05/2018  Peter Vela        TSK 0857355
.           Added SP70 validation for FILTURNO in MLST1410
. V10.11.04 29/11/2017  Richa Phogat   Task 0848145
.           Changed VOLNLIST from a DIM 101 to a DIM 500
. V10.11.03 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.02 19/10/2017  Ebon Clements    TSK 0827626
.           Added report 20 - Remote scripts for barcode printing
. V10.11.01 30/07/2017  Thanh T.         TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.-------------------------------------------------------------------------------
. V10.10.02 16/05/2017  Don Nguyen       TSK 0829913
.           Modified XMLMRT00 to use MRMACLOC & MRMACHOS (Current) from the
.           Master record if no history record exists; default to Home Location/
.           Hospital if Current is blank.
.           Modified MRTA1400 & MASTB100 to call RSMRMAS1 before RKMRMAS1
. V10.10.01 27/03/2017  Don Nguyen       TSK 0817797
.           Modified SAVMVE00 to use MRCNNBMN - Next Bulk Record Movement Number
.           Modified HISROW00 to output MRHIMOVN - Bulk Record Movement Number
.           Recompiled for MRTHISFD/IO
.           Removed unused routine MOESAV00
. V10.08.02 19/07/2016  Jill Parkinson   TSK 0822807
.           Added use of mrhiskey in MRTMOE00 if medrecky is blank (instead of
.           just using the current mrtmasaf record)
. V10.08.01 08/07/2016  Jill Parkinson   TSK 0822002
.           Recompiled for PATMASTM
. V10.07.01 06/10/2015  Nicole Torrisi   CAR 304013
.           Fixed admission number in incomplete coding check
. V10.06.04 29/09/2015  Nicole Torrisi   CAR 304013
.           Changed Bulk Record Movement to display oldest Incomplete Coding
. V10.06.03 02/07/2015  Ebon Clements    CAR 318455
.           Removed duplicate display of cancelled pre admissions - VISTB000
. V10.06.02 29/06/2015  Ebon Clements    CAR 314271
.           If multi hospital only show incomplete coding message for 
.           the users logged in hospital - XMLCHK70
. V10.06.01 09/06/2015  Nicole Torrisi   CAR 304013
.           Fixed Bulk Record Movement Incomplete Coding warning message
. V10.05.03 10/02/2015  Nicole Torrisi   CAR 304013
.           Changed Bulk Record Movement to display oldest Incomplete Coding
. V10.05.02 26/11/2014 Ebon Clements     CAR 299539
.           Added multi hospital test to default document type - MRTV0200
. V10.05.01 29/09/2014  Ebon Clements    CAR 303818
.           Added hospital description tag to MRT location maintanance
.           Added edit button default of hospital id - ELOC0000
. V10.04.11 10/06/2014  Peter Vela       CAR 300217
.           Added check for hospital at SAVMVE16 for superlev variable
.           Added display all medical records flag in XMLMRT00
. V10.04.10 10/06/2014  Patrick Adair    CAR 299068
.           Changed MRMACOMM in MASTB800 to change last \ to \\ as discussed. 
.           This issue may still occur elsewhere.
. V10.04.09 03/06/2014  Steve Armstrong  CAR 301905
.           Recompiled for changes to BARCODEL
. V10.04.08 28/05/2014  Steve Armstrong  CAR 301697
.           Recompiled for changes to BARCODFD & BARCODEL
. V10.04.07 15/05/2014  J.Tan          CAR 291374
.           Mods to display Microfilm or Volume Comments on Record movement
. V10.04.06 17/04/2014  Ebon Clements  CAR 298133
.           Fixed loop to find the oldest uncoded visit - XMLCHK60
. V10.04.05 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.04 03/04/2014  Peter Vela     CAR 292589
.           Added HSLC0000
.           Added FILTHOSP validation to MASTB000
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 17/12/2013  Patrick Adair  CAR 235296
.           Allow Inactive Tracking Locations and Operator Id's to be shown
. V10.04.01 17/12/2013  Peter Vela     CAR 290928
.           Added single hospital validation in HISTB000
.-------------------------------------------------------------------------------
. V10.03.40 21/11/2013  Peter Vela     CAR 290884
.           Added DOSELHOS to RCRQ1200
. V10.03.39 21/10/2013  Ebon Clements  CAR 292853
.           Fixed home hospital default for multi hospital scan of pre
.           multi hospital MRT barcode labels - XMLMRT00
. V10.03.38 16/10/2013  Patrick Adair  CAR 282959
.           Find oldest uncoded admission record instead of latest to display
.           in Warning Message (limited to last 20 visits only) (XMLCHK60)
. V10.03.37 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.36 03/10/2013  Steve Armstrong  CAR 288086
.           Recompiled for changes to BARCODEL.
. V10.03.35 11/09/2013  patrick Adair  CAR 287462
.           Cleared WBSENAM if MRRDFUID is blank in GFILST00
. V10.03.34 24/07/2013  Steve Armstrong   CAR 288086
.           Recompiled for changes to BARCODEL
. V10.03.33 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.32 10/07/2013  Ania P           CAR 288258
.           Fixed overwrite of MRRDFUID before Update/Write
. V10.03.31 02/07/2013  Peter Vela     CAR 287465
.           Put back alternative hospital validation in MSDTB000
. V10.03.30 25/06/2013  Ebon Clements  CAR 287288
.           Fixed key size on movement reason selection list - RCRQ0710
. V10.03.29 04/06/2013  Ebon Clements  CAR 285585
.           Added DOSELHOS = 1 to retain MR home hospital - MRTAB3800
. V10.03.28 03/06/2013  Ania P         CAR 216497
.           Added userid to new var MRRDFUID
. V10.03.27 31/05/2013  Ebon Clements  CAR 285540
.           Added required hospital tag -  RCRQ1000 
. V10.03.26 20/03/2013  Peter Vela     CAR 285387
.           Commented out originating hospital and alternate hospital
.           validations @ MSDTB000
. V10.03.25 22/03/2013  Jill Parkinson CAR 283050
.           Changed HSEL0000 to save the key before looping back to HSEL0100
. V10.03.24 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.23 04/03/2013  Ebon Clements    CAR 277797
.           Fixed default and popilations of hospital filter - MLST2000
. V10.03.22 22/01/2013  Peter Vela       CAR 276499
.           Fixed Destination and Requested By @ HISROW00
. V10.03.21 16/01/2013  Patrick Adair    CAR 274123
.           Commented out Supervisor check for site record list in MSDTB000
. V10.03.20 22/11/2012  Mike Laming      CAR 276499
.           Added filtdest to MLST2200 for MR Movements list
. V10.03.19 31/08/2012  Mike Laming      CAR 268580
.           Mods to MSDTB000 to select Users hospital if not Super User
. V10.03.18 18/07/2012  Ebon Clements    CAR 266290
.           Added display in transit functionality
. V10.03.17 05/07/2012  Mike Laming      CAR 268580
.           Mod at MSDTB300 to check MRHIDHOS for blank if MRMAKEY not found
. V10.03.16 31/05/2012 Ebon Clements     CAR 251788
.           Show DNA OP bookings in linked visit list - VISTB000
. V10.03.15 01/05/2012  Mike Laming      CAR 263795
.           Mods to MRTTB000 (Location Maint) to handle Multi Hosp & single Hosp
. V10.03.14 24/04/2012  Ebon Clements    CAR 263806
.           Display hospitals with the same MRT Home Location - HSEL0000 
. V10.03.13 05/04/2012  Steve Armstrong  CAR 263236
.           Extended MRTLC007 & MRTLC011 from DIM  3 to DIM  6 to
.           cater for extended printer codes.
. V10.03.12 27/03/2012  Patrick Adair    CAR 261961
.           Added Comments to Receive Medical Records
. V10.03.11 09/02/2012  Peter Vela        CAR 259106
.           Fixed red current location fields again
. V10.03.10 09/02/2012  Peter Vela        CAR 259106
.           Fixed red current location fields
. V10.03.09 30/01/2012  Mike Laming       CAR 259106
.           Mods to use PTHSRCTY instead of MRCNRCTY in "Red" Hospital fields.
. V10.03.08 23/01/2012  Peter Vela      CAR 258462
.           Changed KEY17 to KEY20 @ SAVMVE16
. V10.03.07 19/01/2012  Peter Vela      CAR 258462
.           Changed BRANCH OVRCD @ SAVMVE16
. V10.03.06 19/01/2012  Peter Vela      CAR 258462
.           Changed KEY17 to KEY20 @ SAVMVE91
. V10.03.05 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.04 08/12/2011  Mike Laming       CAR 248696
.           More mods to Red or Black Hospital Id (Added Cat TY test)
. V10.03.03 21/11/2011  Mike Laming       CAR 254569
.           More mods to Hospital Id (with colours)
. V10.03.02 18/11/2011  Peter McMullen   CAR 254569
.           Extend location display fields to avoid truncation
. V10.03.01 07/11/2011  Mike Laming      CAR 253086
.           Recompiled for Zebra Labels - BARCODEL, BARCODEF, BARCODFD
.           See CHKLAB05 for testing Zebra Code to Spool file)
. V10.02.22 25/10/2011  Ebon Clements    CAR 239818
.           Fixed template 9 test for enquiry webtitle - MRTMAS00
. V10.02.21 13/10/2011  Mike Laming      CAR 252360
.           Added MOVT0900 "Bulk Record Movement" Home Hospital selection List
. V10.02.20 12/10/2011  Mike Laming      CAR 251827
.           Mods to MASTB0000 & SRMTB000 to select Records with Home Hosp. at
.           another Hosp.
. V10.02.19 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.18 21/09/2011  Steve Armstrong  CAR 250963
.           Recompiled for changes to BARCODEL
. V10.02.17 15/09/2011  Mike Laming      CAR 248696
.           Mods to (hos) fields where Home Hospital is not Current Hospital
. V10.02.16 14/09/2011  Ebon Clements    CAR 250555
.           Added transflg for redirect back to bed transfer page
.           Added dischflg for redirect from discharge page
. V10.02.15 13/09/2011  Steve Armstrong  CAR 250963
.           Recompiled for changes to BARCODEL
.           13/09/2011  Jill Parkinson   CAR 248652
.           Recompiled for changes to PMSPX2TM
. V10.02.14 29/08/2011  Peter McMullen   CAR 24R9261
.           Sort MRT destination list alpabetically                      
. V10.02.13 29/08/2011  Mike Laming      CAR 248690 
.           Added Originating Hospital Filter to MOVT000 and SRMTB000
. V10.02.12 25/08/2011  Mike Laming      CAR 248541 
.           Recompiled for BARCODEF, BARCODEL & BARCODFD - Correct Zebra Barcode
. V10.02.11 15/08/2011  Ebon Clements    CAR 248101 
.           List associated MRT home hospitals - HSEL0000
. V10.02.10 11/08/2011  Ebon Clements    CAR 248087 
.           Fixed duplicate MR test when updating a MR - MRTMAS20
. V10.02.09 10/08/2011  Mike Laming      CAR 241939 
.           Added "epscd001" Episode Number in MR Coding Template MRTD0000
. V10.02.08 08/08/2011  Peter McMullen   CAR 2437731
.           Replaced prefix literal 'O' in VALICO00 with controlf.CMOPRT 
. V10.02.07 26/07/2011  Ebon Clements    CAR 243582
.           Recompiled for MRTLOCFD - Tracking receipt functionality
. V10.02.06 20/07/2011  Mike Laming      CAR 240724
.           Slowly replacing "LOCATION" with HOMELOCN (as paired with HOMEHOSP)
. V10.02.05 13/07/2011  Mike Laming      CAR 240724
.           Bug fix for Hospital Security in HSEL0000
. V10.02.04 06/07/2011  Mike Laming      CAR 240724
.           Further mods for MRT Hospital/Location - WA Health changes
. V10.02.03 26/05/2011  Mike Laming      CAR 240724
.           Mods for MRT Hospital/Location - add Hospitals, change Keys on
.           "mrtlocaf" and "mrtmasaf". Added MRCNBCHI "Hospital Id. on Barcode"
. V10.02.02 11/05/2011  Mike Laming   CAR 240707
.           Added "Movement Comment" MRHICOMM (MRTME018) - plus MRTHISFD change
. V10.02.01 04/04/2011 Jill Parkinson CAR 239574
.           Removed open of ibaprntf
.           Increased printer variables
. V10.00.06 30.08.2010 Ebon Clements CAR 229027
.           Recompiled for TRKALTCD - Added test for departed OP appointments
. V10.00.05 26.08.2010 Saroeun Soeur CAR 228069
.           HISTAB10 - changed location of filter check for userid (FILTUSID)
. V10.00.04 27/05/2010 Ebon Clements CAR 166668
.           Added list mrt locations by name - MRTTD000
. V10.00.03 23/04/2010 Peter Vela    CAR 220615
.           Added display of template title "Medical Record Master Enquiry"
. V10.00.02 20/04/2010   Ebon Clements     CAR 59880 
.           Added XMLALT00 - Display medical record tracking alerts
. V10.00.01 19/03/2010   Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL&INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.02  04/09/2009 Ebon Clements CAR 205250
.           Added given name to STFTB000
. V9.12.01  31/07/2009 Ebon Clements CAR 202737 
.           Recompiled for changes to BARCODEL and BARCODEF - New layout 13
. V9.11.03  15/04/2009 Ebon Clements CAR 161781
.           Added hospital and active filter to tracking locations - MRTTB000
. V9.11.02  23/01/2009 Ebon Clements CAR 178299
.           Include cancelled visits in the linked visits list - VISTB000
. V9.11.01  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.03  06/06/2008 Jill Habasque CAR 166095   
.           Increased length of MRTTD006 to allow 100
. V9.10.02  26/05/2008 Sandra Barcham  CAR 169203
.           Fixed display of requested by
. V9.10.01  29/04/2008  Jill Habasque  CAR 165593
.           Added WARLST00
.-------------------------------------------------------------------------------
. V9.09.17  07/04/2008  Jill Habasque  CAR 165593
.           Added move of zero to exit in SAVMVE94              
. V9.09.16  04/04/2008  Jill Habasque  CAR 165593
.           Shorten error in SAVMVE00 for record already exists
. V9.09.15  17/03/2008  Jill Habasque  CAR 129417
.           Added error in SAVMVE00 for record already exists
. V9.09.14  03/03/2008  Jill Habasque  CAR 01881 
.           Fixed suplev cgi
. V9.09.13  26/02/2008  Ebon Clements  CAR 162224
.           Changed HISTB000 to use MRHIOPER if web user is blank
. V9.09.12  22/02/2008  Ebon Clements  CAR 161834
.           Added DFLTRCTY and DFLTSTAT for user doc type and status defaults
.           Fixed default document type test in SRMTB000
. V9.09.11  18/02/2008  Ebon Clements  CAR 161653
.           Changed size of DFLTHLOC from DIM 3 to DIM 4
. V9.09.10  14/20/2008  Ebon Clements    CAR 148460
.           Fixed read of CMDISP 
. V9.09.09  06/02/2008  Ebon Clements    CAR 148460
.           Removed V2 from ICD code heading - TDTHD000 & TOPHD000
. V9.09.08  15/01/2008  Ebon Clements    CAR 157822
.           Added web user default of mrt document type - MOVT0400 and MRTV0200
. V9.09.07  10/01/2008  Jill Habasque    CAR 93331
.           Added superlev cgi
. V9.09.06  20/12/2007  Ebon Clements  CAR 158133
.           Changed XMLVOL00 to not return SP2 if not using auto generate vol
. V9.09.05  06/12/2007  Ebon Clements  CAR 150419
.           Added print barcode label functionality to MRTMAS10
. V9.09.04  19/11/2007  Ebon Clements  CAR 150855
.           Added cross campus medical record tracking functionality           
. V9.09.03  06/09/2007  Ebon Clements  CAR 64204
.           Added outpatient bookings to VISTB000
. V9.09.02  26/07/2007  Jill Habasque  CAR 14R5727
.           Change GTPEX000 so no Extn or Pager if name is blank   
. V9.09.01  10/07/2007  Jill Habasque  CAR 142588
.           Added calls to DELHIS00 after deleting mrtmasaf record
. V9.08.05  30/04/2007  Neelkamal Pyla CAR 137604
.           Added MRTLC011 cgi and MRTL1400 tag to MRTL0000 to display the value
.           for 'Bulk Record Request Printer' 
. V9.08.04  06/03/2007  Ebon Clements  CAR 127601
.           Added udpate and fill bulk request functionality - MRTMVE30
. V9.08.03  25/01/2007  Peter Vela     CAR 127930
.           Added MRMADTCR MRMATMCR before WRTMAS1
. V9.08.02  13/11/2006  Ebon Clements    CAR 124591
.           Recompiled for changes to BARCODEL
. V9.08.01  25/10/2006  Steve Armstrong  CAR 107236
.           Recompiled for changes to BARCODEL/BARCODEF
.-------------------------------------------------------------------------------
. V9.07.03  14/09/2006  Ebon Clements CAR 107236
.           Added MRCNIBAP - Using IBA prefix and Allegra barcode lables
. V9.07.02  12/07/2006  Peter Vela   CAR 112027
.           Added home location default tag for RCH
. V9.07.01  04/07/2006  Peter Vela   CAR ??????
.           Recompiled for BARCODEF - Fixed endless loop
.-------------------------------------------------------------------------------
. V9.06.03  31/05/2006  Janet George CAR 106941
.           Fixed home location default for multi hospitals - MRTA2700 
. V9.06.02  01/05/2006  Jill Habasque CAR 84263
.           Added MRTLC010 - Priority location
. V9.06.01  27/04/2006  Jill Habasque CAR 93842
.           Added regiflag cgi
. V9.05.02  17/03/2006  Ebon Clements CAR 89155
.           Mods for multi hospital medical record locations
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B05 28/02/2006  Ebon Clements     CAR 94531
.           Changed VOLNLIST from a DIM 51 to a DIM 101
. V9.05.B04 20/02/2006  Ebon Clements     CAR 73880
.           Mods to movement reason maintenance borrowing period
. V9.05.B03 20/02/2006  Ebon Clements     CAR 76341
.           Added referral and encounter file audit 
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.27  24/11/2005  Ebon Clements CAR 78032
.           Added MRCNLINK - Using medical record linked visit
. V9.04.26  28/10/2005  Jill Habasque CAR 73889
.           Mods to use medical record key if available in XMLMRT00
. V9.04.25  17/10/2005  Jill Habasque CAR 73889    
.           Mods to allow blank document type in XMLMRT00
. V9.04.24  04/10/2005  Ebon Clements CAR 78032    
.           Added SUPRFLAG to CHDVIS00 to override linked visits error on delete
. V9.04.23  22/09/2005  Ebon Clements CAR 56976    
.           Added LINK0000 - Linked medical racords by visit number
. V9.04.22  20/09/2005  Mike Laming   CAR 68672    
.           Recompiled for BARCODFD, BARCODEL & BARCODEF - add Datamax E-class
. V9.04.21  19/09/2005  Ebon CLEMENTS CAR 56976
.           Changed MSDTB000 checkbox for medrecky to be onclick not onchange
. V9.04.20  09/09/2005  Peter Vela    CAR 72779
.           Modified CHDVIS00 to check if linked visits are cancelled.
.           If yes then allow the deletion of MRT master record
. V9.04.19  05/09/2005  Jill Habasque CAR 74866
.           Added right justify of VOLKEY in XMLMRT00  
. V9.04.18  18/08/2005  Sandra Barcham        71427
.           Allow borrowing period = 800 day
. V9.04.17  04/08/2005  Jill Habasque     CAR 64590
.           Added check for linked visits before deleting a medical record
. V9.04.16  07/07/2005  Ebon Clements     CAR 62220
.           Added print bulk mrt labels to CHKLAB00
. V9.04.15  27/06/2005  Ebon Clements     CAR 62766
.           Changed XMLVOL00 to read MRCNAUTO for generation of next
.           medical record volume number.
. V9.04.14  14/06/2005  Steve Armstrong   CAR 62213
.           Recompiled for changes to BARCODFD, BARCODEL & BARCODEF
. V9.04.13  07/06/2005  Sandra Barcham   CAR 62213
.           Recompiled for changes to BARCODFD
. V9.04.12  01/06/2005  Steve Armstrong  CAR 62213
.           Recompiled for changes to BARCODEF
. V9.04.11  27/05/2005  Ebon Clements    CAR 61683
.           Fixed size of VALDHMLC should be a DIM 4 not a DIM 3
. V9.04.10  19/05/2005  Jill Habasque    CAR 59013
.           Added home location and document type filters
. V9.04.09  17/05/2005  Steve Armstrong  CAR 62029
.           Recompiled for BARCODEL
. V9.04.08  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.07  15.04.2005  Ebon Clements    CAR 60672
.           Added home location description to MASTB000
. V9.04.06  07/04/2005  Steve Armstrong  CAR 60530
.           Recompiled for changes to BARCODEL, BARCODEF & BARCODFD
. V9.04.05  25/02/2005  Mike Laming   CAR 57503
.           Add clear of MRKEYARR[] at label CLRPAR00
. V9.04.04  11/01/2005  Peter Vela    CAR 51373
.           Added Home Location for generate volume number New Zealand
. V9.04.03  18/10/2004  Guomin Fu     CAR 53229
.           Fixed when cancelling MR movement, the mrtmasaf"current location"
.           ends up being home location of the MR rather than what the mrthisaf
.           says where it should be
. V9.04.02  20/09/2004  Lina Vo       CAR 53266
.           Added Multi Hospital to MRT Locations Maintenance.                  
.           Added display of Multi Hospital in MRT Master Maintenance.
.           Changed XMLVOL00 to find next volume by Location and document type
.           for Multi Hospital.
.           17/09/2004  Guomin Fu     CAR 51445
.           Added in GTRQX000 and GTPEX000 to check PTCNRQCF for whether to use
.           staff code or free format for requester. If set to using free format
.           then allows ext.no and pager no. to be displayed even requester
.           field is empty.
. V9.04.01  31/08/2004  Guomin Fu     CAR 48031
.           Changed in HISTAB00 to display "limit reached" when records number>
.           150.
. V9.03.22  29/06/2004  Guomin Fu     CAR 50523
.           Fixed to display the Current Location as the value of Home Location
.           when the last movement is removed.
. V9.03.21  15/06/2004  Pat Dirito    CAR 50669                       
.           Added outputs for Request Details in XMLCHK00 & XMLMRT00
.           11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
.           07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.20  07/06/2004 Ebon Clements             CAR 50499
.           Changed MOVREC30 to write post discharge details to MRTPDSFD for
.           the last discharged or current inpatient visit.
. V9.03.19  07/05/2004 Pat Dirito                CAR 49620
.           Added KIDSFLAG to routine SRMTB000                    
.           20/04/2004 Henry Son                 CAR 44792
.           Display Extension and Pager in Movement History.
. V9.03.18  26/03/2004 Peter Vela                CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.17  23/03/2004 Jill Habasque             CAR 48014
.           Removed use of MRCNIN1A
. V9.03.16  04/03/2004  Davin                    CAR 34825
.           Write user id associated with MRT security number to mrthis (kids)
.           09/03/2004 Jill Habasque             CAR 43608
.           Mods to use home location
. V9.03.15  26/02/2004 Jill Habasque             CAR 43132
.           Mods to write to mrtvisaf
. V9.03.14  17/02/2004 Jill Habasque             CAR 45120
.           Fix read of mrtmasaf for barcode labels         
. V9.03.13  03/02/2004 Henry Son                 CAR 45993
.           Fix Document type selection for 3 characters.
. V9.03.12  27/01/2004 Jill Habasque             CAR 46895
.           Added remove of leading zeros before calling RDPRTA1
. V9.03.11  19/12/2003 Peter Vela                CAR 38495
.           Added submit functionality Transfer to ward
.           Added functionality for defaulting Transfer to Ward to Single Record
.           Movement destination
.           19/12/2003 Peter Vela                CAR 41687
.           Medical Record location now defaulting from current ward MRT
.           location field when patient is admitted.
.           18/12/2003 Peter Vela                CAR 43134
.           Added tag for MRCNWNHL - Parameter for Home Location Warning Msg
.           09/12/2003 Sylvek Litewka            CAR 20222
.           Modified procedures VALICD00 and VALICO00 to use new common IO
.           routines to read ICD files.
. V9.03.10  05/11/2003 Pat Dirito                CAR 44627
.           Checking against Active indicator for Movement Reasons
.           Routines - MRTA1600 & SELREA00 
.           29/10/2003 Sylvek Litewka            CAR 44328
.           Recompiled for PATECOFD changes.
. V9.03.09  13/10/2003 Pat Dirito                CAR 44236
.           Added STARTKEY to next and previous buttons NEXTPR00 & PREVPRO0
. V9.03.08  11/09/2003 Pat Dirito                CAR 43132
.           Added PTCNRQCF - Free Format for Requested By
. V9.03.07  08/09/2003 Ebon Clements             CAR 43130
.           Removed edits in MRTMAS10 so you can have multiple documents with
.           the same type and volume as the home location is part of the key.
. V9.03.06  05/09/2003 Ebon Clements             CAR 43129
.           Added medical record key to MASTB000 for MedMov javascript
.           02/09/2003 Jill Habasque
.           Fixed DELXXX00 routines
. V9.03.05  25/08/2003 Jill Habasque             CAR 42777
.           Added read of ibaprtaf
. V9.03.04  21/08/2003 Jill Habasque             CAR 41282
.           Added open of IBAPDFA1
. V9.03.03  17/07/2003 Jill Habasque             CAR 41282
.           Fixed printing of bar code labels in CHKLAB00           
. V9.03.02  28/05/2003 Davin                     CAR 38714
.           Added broadcast of medical record movements (DGCLICRM)
. V9.03.01  19/05/2003 Pat Dirito                SRF 39121
.           Now using Addmiting point for MR Location in combination with
.           PTWDLOCN(Ward File MR Location)
.-------------------------------------------------------------------------------
. V9.02.62  11/12/2002 Pat Dirito                SRF 34349
.           Removed checking of MRCNSTAT against medical records
. V9.02.61  27/11/2002 Pat Dirito                SRF 22611
.           Added deletion of MR Visit Link when Medical record Deleted.
.           (DELVIS00, DELHIS00, DELRES00)
. V9.02.60  04/09/2002 Pat Dirito                SRF 19040
.           Added deletion of Request when Medical record Deleted.(DELREQ00)
. V9.02.59  29/06/2002 Ebon Clements             SRF 19105
.           Recompiled for sigpipe trap  
. V9.02.58  26/06/2002 Pat Dirito                SRF 18511
.           Now checking for Bad Debts in XMLMRT00 & XMLCHK00.
. V9.02.57  11/06/2002 Pat Dirito                SRF 18171
.           Fixed setting of SAVKEY17 in routine SAVHOM00 & SAVMVE00
. V9.02.56  31/05/2002 Ebon Clements             SRF 18229
.           Added trap if sigpipe 
. V9.02.55  29/05/2002 Pat Dirito                SRF 17422
.           Now deleting all movements after selected movement date.
. V9.02.54  07/05/2002 Pat Dirito  
.           Fixed Arrays for U*R FORM 2's were getting bigger than 99!
. V9.02.53  02/05/2002 Pat Dirito  
.           Added Traps around WRTMAS1 as still I*D on site.
. V9.02.52  30/04/2002 Pat Dirito  
.           Fixed saving & displaying of MRMOTYPE & MRMOINDC
. V9.02.51  26/04/2002 Pat Dirito  
.           Added boundry so that cannot add more than 99 records to ERRORLST
. V9.02.50  12/03/2002 Pat Dirito  
.           Fixed code in XMLMRT00 setting of HOMELOCT  
. V9.02.49  11/04/2002 Pat Dirito  
.           Made mods to update mrtmasaf when most current history record is
.           deleted. label- MRTMOE30
. V9.02.48  27/03/2002 Pat Dirito  
.           Set SAVHOM00 to now save Home Location regardless if already found!
. V9.02.47  21/03/2002 Pat Dirito  
.           I * D on WRMRPDS1 removed REP of Date before write.
. V9.02.46  13/03/2002 Pat Dirito  
.           Added boundry so that cannot add more than 99 records to MRKEYARR
. V9.02.45  12/03/2002 Pat Dirito  
.           Fixed code in XMLMRT00 was steping over label XMLMRT77
. V9.02.44  15/02/2002 Bronko Sosic
.           movement now updates MRMALOC with most current history location
. V9.02.43  13/02/2002 Jill Habasque 
.           Added trap for WRMRHIS1
. V9.02.42  12/02/2002 Jill Habasque 
.           Mods to KEY26 before WRMRHIS1
. V9.02.41  06/02.2002 Pat Dirito    
.           Fixed validation of Disease & Procedure Codes in VALICD00 & VALICO00
. V9.02.40  02/02.2002 Pat Dirito    
.           Added SAVHOM00 - Change bulk Home Locations 
. V9.02.39  01/02.2002 Pat Dirito    
.           SAVMVE00 was using DAYSEP incorrectly and fixed associated error
.           message!
. V9.02.38  31.01.2002 Pat Dirito    
.           XMLMRT00 & XMLCHK00 not checking for discharged patients on 
.           incomplete coding message!
. V9.02.37  29.01.2002 Pat Dirito    
.           Added another output variable (FILREQED) in XMLMRT00 
. V9.02.36  25.01.2002 Pat Dirito    
.           Fixed more code that was writing to phantom IO Call(WRMHIST1) 
. V9.02.35  23.01.2002 Pat Dirito    
.           Fixed more code that was writing to phantom IO Call(WRMHIST1) 
.           causing I*D on site
. V9.02.34  23.01.2002 Pat Dirito    
.           Added an RA read before write to WRTMAS1 as was getting I*D on site
.           Cleaned up code in SAVMVE00 as best I could....
. V9.02.33  16.01.2002 Pat Dirito    
.           Now using variables for HOMELOCT and CODINGDT as these were
.           F1 & KEY1, and were possibly been reset by other routines!
. V9.02.32  11.01.2002 Bronko Sosic  
.           Added MUPSAV00 for update of MAIN1500              
.           Changed read in SAVMVE00 to read off index 3
.           11.01.2002 Pat Dirito
.           Fixed Spelling of Cancelled. Added output of Visit No in 
.           XMLMRT00 & XMLCHK00 
. V9.02.31  03.01.2002 Bronko Sosic  
.           Added check on current status of record in XMLMRT00
. V9.02.30  03.01.2002 Pat Dirito    
.           Added UR to Error message in XMLMRT00
. V9.02.29  27.12.2001 Pat Dirito    
.           Fixed some of the messy code in XMLMRT00!! 
. V9.02.28  20.12.2001 Pat Dirito    
.           Removed call to javascript ChkHist() no longer needed.
. V9.02.27  19.12.2001 Pat Dirito    
.           Recompiled for PATMSXTM 
. V9.02.26  13.12.2001 Ebon Clements 
.           Added defaulting tags for medical record setup screen         
. V9.02.25  10.12.2001 Bronko Sosic 
.           Changed Bulk record Movements for RCH                         
. V9.02.24  05.12.2001 Pat Dirito   
.           Added Disease and Procedure Prefix Tags               
. V9.02.23  05.12.2001 Bronko Sosic 
.           Cleared volumnu[] in clear par for defect 2355,2230,2373
. V9.02.22  05.12.2001 Pat Dirito   
.           Changed TDTRW000 & TOPRW000 to use onclicks             
. V9.02.21  04.12.2001 Pat Dirito   
.           Addition of edit checks on Coding Templates - Report 12
. V9.02.20  26.11.2001 Pat Dirito   
.           Changes for Default Medical Record Reason & Defualt Destination
.           Tags
. V9.02.19  21.11.2001 Ebon Clements
.           Changed XMLMRT00 to read the visit file with the correct key
. V9.02.18  17.11.2001 Ebon Clements
.           Added remote script to generate the next volume number for a
.           medical record document type.
.           Add filter for destination to record movement list
. V9.02.17  15.11.2001 Pat Dirito 
.           Set MRTMV007 to be a radio button
. V9.02.16  08.11.2001 Davin
.           Replaced PTCNVOGU with PTCNDGPV
. V9.02.15  19.10.2001 Pat Dirito    
.           Modified SRMTB000 to output all Document Types
. V9.02.14  18.10.2001 Ebon Clements 
.           Added operator id to record movement list
. V9.02.13  18.10.2001 Ebon Clements 
.           Set up default document type in single record movement
. V9.02.12  17.10.2001 Ebon Clements 
.           Recompiled for PATCODFD           
. V9.02.11  15.10.2001 Ebon Clements 
.           Set default document type for selection lists                     
.           16.10.2001 Pat Dirito  
.           Modified Add for MRTMAS00 Now only alowing adds for unique 
.           Document Type $ Volume Number 
.           Changed MRTMS003 to a FORM!!        
. V9.02.10  13.10.2001 Bronko Sosic  
.           Changed Processing of Bulk Record Movements                       
. V9.02.09  13.01.2001 Ebon Clements 
.           Added requestor to the medical records master maintenance list    
. V9.02.08  10.01.2001 Ebon Clements 
.           Changed unfilled request error message to display if any requests
.           are outstanding regardless of the date and time
. V9.02.07  10.10.2001 B.G.Ackland
.           Fix I * D for Add of Record
. V9.02.06  08.10.2001 Pat Dirito
.           Program was never saving Web-Userid corectly. Was saving desc
.           into a DIM6(MRTME006) should be saving Web-Userid into MRTME015
.           Now Fixed
. V9.02.05  04.10.2001 Pat Dirito
.           Fixed add of a Medical Record MRTMAS00                        
. V9.02.04  21.09.2001 J.Tan
.           Fixed fields for moving to a home location other than it's own
. V9.02.03  18.09.2001 J.Tan
.           Fixed setting up key for visit file (coding date) 
. V9.02.01  31.08.2001 J.Tan
.           Mods to default Current location to Home location
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.001 14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B13 13.08.2001 Bronko Sosic   
.           Bug Fixed for St V.  
. V9.00.B12 13.07.2001 Sandra Barcham
.           Replaced GP with HCP
. V9.00.B11 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B10 28.05.2001 Ebon Clements 
.           Fixed up default of home location selection list
.           It defaults to home location of the current mrtmasaf
.           record
. V9.00.B09 25.05.2001 Ebon Clements 
.           Added warning for unfilled requests
. V9.00.B08 23.05.2001 Ebon Clements 
.           Added error so you can' move a record before the
.           last movement date
. V9.00.B07 22.05.2001 Ebon Clements 
.           Added Merged U/R warning to record movement      
. V9.00.B06 20.05.2001 Bronko Sosic  
.           Bug Fixes                                        
. V9.00.B04 18.05.2001 Bronko Sosic  
.           Bug Fixes                                        
. V9.00.B03 17.05.2001 Ebon Clements 
.           Added a new feild to master table output MASTB000
. V9.00.B02 16.05.2001 Bronko Sosic 
.           Added a new feild that is returned form XMLMRT00 
. V9.00.B01 09.04.2001 Bronko Sosic 
.           Recompiled                                       
.--------------------------------------------------------
.                V5.10.B04 09.04.2001 Ebon Clements
.                          Allow entry of microfilm details on add record   
.                          09.03.2001 Ebon Clements
.                          Changed update medical records to allow changes  
.                          to a records home location and document type. The
.                          modify now deletes and writes the record.
.                          01.03.2001 Bronko Sosic
.                          Added new CGI variable to MRTLOCFD so added input
.                          Feild in maintanace function
.                V5.09.B03 20.02.2001 Bronko Sosic
.                          Fixed due date calculation for xml scripting
.                V5.09.B02 16.02.2001 J.Tan
.                          Added printing Bar Code labels
.                 V5.09.01 03.01.2001 Bronko Sosic
.                          Added update for MRTMASFD when a write is done on
.                          Recomplied for PATMASTM    
.                          09.01.2001 Katie Nelson 
.                          Added control cache header
.                          MRTHISFD due to FD changes
.                 V5.07.01 25.03.2000 Bronko Sosic
.                          Added startkey for GOTO button
.                 V5.07.00 07.01.2000 Bronko Sosic
.                          Created Program                                      
.                    
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       ALLCONFD/INC
          INC       APSMASFD/INC
          INC       ALLREFFD/INC
          INC       BOKRC1FD/INC
          INC       EMRVISFD/INC
          INC       PATHSPFD/INC
          INC       PATRE1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       MLTSECFD/INC
          INC       MRTRESFD/INC
          INC       MRTHISFD/INC
          INC       MRTRQHFD/INC
          INC       MRTRQDFD/INC
          INC       PATCONFD/INC
          INC       MRTSTFFD/INC
          INC       MRTCONFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMOVFD/INC
          INC       MRTTDTFD/INC
          INC       MRTTHDFD/INC
          INC       MRTPSHFD/INC
          INC       PATBAYFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCTYFD/INC
          INC       OUTCANFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       PATDSCFD/INC
          INC       PATCALAG/INC  
          INC       PATWR1FD/INC
          INC       PATPR1FD/INC   * New Patient Master File
          INC       PATDO1FD/INC   * Doctor File
          INC       PATFN1FD/INC   * Health Fund File 
          INC       PATIN1FD/INC   * Insurance File
          INC       PATMI1FD/INC   * New Patient Admission File
          INC       PATMA1FD/INC   * New Patient Master File
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       OUTSITFD/INC   * Outpatients - Site Codes File
          INC       PATALRFD/INC   * Data variable defs for CALCAGE routine
          INC       PATVISFD/INC   * Patients Visits File   
          INC       BARCODFD/INC  
          INC       MRTPDSFD/INC
 
          INC       PATECOFD/INC   *  
          INC       PATICOFD/INC   *  
          INC       PATCANFD/INC   *
          INC       PATICDFD/INC
          INC       PATICUFD/INC
.---------------------------------------------------------------------------
.  CGI Variables
.
CARET     INIT      "^"
CATAP     INIT      "ap"
CATTY     INIT      "TY"
CDCIDBUT  FORM      1       * Display clear DCID button flag
CLUSTERV  DIM       2       * Cluster value
CODCOUNT  FORM      3
DAYSDIFF  FORM      5
DCIDCLAS  DIM       15      * DCID class
DESTHOSP  DIM       3
DIM1A     DIM       1
DIM1B     DIM       1
DIM1C     DIM       1
DIM1D     DIM       1
DIM1E     DIM       1
DIM1F     DIM       1
DIM3      DIM       3
DIM5      DIM       5
DIM20A    DIM       20
DISPDATE  DIM       11
DISPLNAM  DIM       30
DISPHLOC  DIM       30
DISCDATE  DIM       12 
DISCDEST  DIM       20
DISCHFLG  FORM      1
DISPRECN  DIM       30
DISPRECS  DIM       11
DISAMREC  DIM       1
VISITNUM  DIM       8
DOCUTYPE  DIM       3                 * Document Type
DOSELHOS  FORM      1                 * an awkward way to fix complicated code
CODINGDT  FORM      1
CURRDATE  DIM       8       * Current Date
EXTNTXT   INIT      "<br>Ext: "        * extention break text          *I-44792
EPSCD001  DIM       2                                                 *I-241939
FILTACTV  DIM       1
FILTHOSP  DIM       3
FILTFLAG  FORM      1
FILLSTAT  DIM       20
FORMVOLN  FORM      2
RECCOUNT  FORM      8
REGIFLAG  FORM      1
FILTURNO  DIM       8
FILTTYPE  FORM      1 
FILTUSID  DIM       10
FILTNAM   DIM       30
FILTDEST  DIM       4
HLOCDSC1  DIM       96
HLOCDSC2  DIM       70
HMLODESC  DIM       30
HOLOCODE  DIM       4  * home location code
HOMELOCD  DIM       70
HOMELOCT  FORM      1
HOMEHOSP  DIM       3
HOMELOCN  DIM       4
HOMHOSDS  DIM       10
INACTVDS  DIM       1
INACTVOP  DIM       1
RQSTLOCT  DIM       30
RQSTREAS  DIM       30
LOCATION  DIM       4
LINKVOLM  DIM       2
PAGERTXT  INIT      "<br>Pager: "      * page break text               *I-44792
PRESDETS  DIM       100     * Person Responsible details               *I-44792
RECSTATD  DIM       20
RECSTATC  DIM       10      * Colorcode for Record Status
SVKEY20A  DIM       20                                                *I-240724
SVKEY20B  DIM       20                                                *I-240724
SELHOSP   DIM       3                                                 *I-240724
SMRURNO   DIM       8         8        1  Patient's U/R Number
SMRHHOS   DIM       3         3           Home Hospital               *I-240724
SMRHLOC   DIM       4         4        9  Home Location
SMRDOTY   DIM       3         3       13  Type of Document
SMRVOLN   DIM       2         2       16  Volume Number
SMRSTAT   DIM       3         3       18  Status
SMRCOMM   DIM       20        20      21  Comments
SMRKEY    DIM       10        10      41  Key for History File
SMRCHOS   DIM       3                     Current Hospital            *I-240724
SMRCLOC   DIM       4         4       51  Currnt Location
SMRFILM   DIM       25        25      55  Microfilm address       
SMROHOS   DIM       3                     Originating Hospital        *I-240724
SMRUSCR   DIM       10
SMRDTCR   DIM       8
SMRTMCR   DIM       8
SMRUSUP   DIM       10
SMRDTUP   DIM       8
SMRTMUP   DIM       8
SELECTED  DIM       4         * Selected Index
STAFFKEY  DIM       6
SUPERLEV  DIM       1
.
MRTSECID  DIM       10      * MRT security number User ID
MRTSECNO  DIM       8       * MRT security number
.
NOLABEL   FORM      3
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
.
EPISODET  DIM       8       * Episode type
MEDRECKY  DIM       10      * Key for First Medical Record Volume
MEDRCKY1  DIM       10      * Key for Second Medical Record Volume
MEDRCKY2  DIM       10      * Key for Third Medical Record Volume
MEDRCKY3  DIM       10      * Key for Fourth Medical Record Volume
MEDRCKY4  DIM       10      * Key for Fifth Medical Record Volume
MEDRCKY5  DIM       10      * Key for Sixth Medical Record Volume
MEDRECID  DIM       20      * Combined Key to Medical Record
MEDILOCN  DIM       4       * MR Location
MEDIHOSN  DIM       3       * MR Hospital Id
UPDATETY  DIM       1       * Update Type
URLLINK   DIM       40
LOCDESCR  DIM       70      * Location description
.
TEST      FORM      1       * flag
TRAKHOSP  DIM       3       * Tracking alert hospital                 *I-240724
TRAKLOCN  DIM       4       * Tracking alert location
TRANSFLG  FORM      1
DOCTCODE  DIM       6       * Doctor Code
FORM8     FORM      8       * Form of 8   
FILREQED  DIM       1       * Filing Required
INTRANST  DIM       26
PDSTDEST  DIM       20      * Post Discharge Status Desc
PSAGECON  DIM       3
PSAGETYP  DIM       3
PACKLINK  DIM       70      * Test
RECSTAT1  INIT      "In Transit"
RECSTAT2  INIT      "Received"
RECSTAT3  INIT      "Sent Direct"
SQUOTE    INIT       "'"
MR        INIT      "MR"
CUR       INIT      "CUR"
CFILEPRE  DIM       3
CODEAP    INIT      "ap"
CODETY    INIT      "TY"
CODERS    INIT      "RS"
NNN       INIT      "999"
S         INIT      "S"
OBB       INIT      "("
CBB       INIT      ")"
OBR       INIT      "<font color=red>("
CBR       INIT      ")</font>"
RECORD    INIT      "medrecky"
NZGNAME   DIM       18
NZSNAME   DIM       20
CPPURNO   DIM       8
LABNAME   DIM       40
LABSEX    DIM       8                                                  *C-49016
LABBDTE   DIM       8
LABBDTE1  DIM       10
LASTMOVD  DIM       12      * Last Movement Date
NZHOSP    DIM       1
HISTDATE  DIM       8
HISTTIME  DIM       5
DESCDOCM  DIM       30
MDATE     DIM       12      * Display date for movement history check
MFLAG     FORM      1       * Flag for last movement date check
KIDSFLAG  FORM      1       * Using Kids Screen
RQSTDATE  DIM       12
RFLAG     FORM      1       * Flag for unfilled requests
MRHISKEY  DIM       26      * Key to Medical record History File
HISKEY    DIM       26      * Key to Medical record History File
.
MRTLC001  DIM       4       * Location Code      
MRTLC002  DIM       30      * Description
MRTLC003  DIM       3       * Type               
MRTLC004  DIM       1       * Indicater 1=Internal 2=External  
MRTLC005  FORM      1       * Status 1=Inactive 0=Active            
MRTLC006  FORM      1       * Usage Indicator  0=Not Uses 1=Used
MRTLC007  DIM       6       * Printer               
MRTLC008  DIM       6       * Stationery Code               
MRTLC009  DIM       3       * Multi Hospital ID     
MRTLC010  DIM       1       * Priority Location     
MRTLC011  DIM       6       * Bulk Record Request Printer     
MRTLC012  DIM       1       * Using Tracking Receipt for this location
.
MRTMV001  DIM       4       * Reason for movement
MRTMV002  DIM       30      * Description
MRTMV003  FORM      3       * Borrowing period (days)
MRTMV004  DIM       1       * Type 1=Ordinary 2=In-Patient
MRTMV005  DIM       1       * Reason Indicator 1=Home 2=Other 3=Archive Home
MRTMV006  FORM      1       * Status Indicator 0=Active 1=Non Active
MRTMV007  FORM      1       * Usage Indicator 0=Not Used 1=Used 2=Bulk Requests

MRTST001  DIM       6       * Staff Code
MRTST002  DIM       6       * Title
MRTST003  DIM       20      * Surname
MRTST004  DIM       25      * Given name
MRTST005  DIM       3       * Position
MRTST006  DIM       30      * Contact Point
MRTST007  DIM       12      * Phone No. (Internal Extension)
MRTST008  DIM       12      * Phone No. (External/Other)
MRTST009  DIM       12      * Phone No. (After Hours)
MRTST010  DIM       12      * Phone No. (Pager)
MRTST011  DIM       20      * Bar Code Number
MRTST012  FORM      1       * Status Indicator 0=Active 1=Non Active
MRTST013  FORM      1       * Usage Indicator 0=Not Used 1=Used
.
BAYCD001  DIM       3       * Bay Code
BAYCD002  DIM       2       * Last Two Digits of U/R Number
BAYCD003  DIM       20      * Bay Discription
.
DISPLAYR  DIM       50      * Display requested by 
.
SAVBAY    DIM       3       * Saved BayCode
SAVUR     DIM       2       * Saved 2 Digit UR
SAVEDKEY  DIM       20      * Saved key for Medical Records Master Details
SAVKEY3   DIM       3
SAVKEY3A  DIM       3
SAVKEY3B  DIM       3
..SAVKEY17  DIM       17
SAVKEY20  DIM       20
SUPRFLAG  DIM       1       * Supervisor flag
.
MRTMS001  DIM       4       * Home Location
MRTMS002  DIM       3       * Type Of Document
MRTMS003  FORM      2       * Volume Number
MRTMS004  DIM       3       * Status
MRTMS005  DIM       20      * Comments
MRTMS006  DIM       10      * Key for History File
MRTMS007  DIM       25      * MicroFile Address    
MRTMS008  DIM       3       * Home Hospital ID     
MRTMS009  DIM       3       * Originating Hospital ID     
.
MRTRS001  DIM       11      * Date Required
MRTRS002  DIM       5       * Time Required
MRTRS003  DIM       4       * Location
MRTRS004  DIM       6       * Staff Member
MRTRS005  DIM       4       * Reason
MRTRS006  DIM       8       * Reservation Date
MRTRS007  DIM       3       * Hospital ID
.
MRTME001  DIM       8       * Date of Movement
MRTME002  DIM       8       * Time of Movement
MRTME003  DIM       4       * Destination of Location
MRTME004  DIM       6       * Receiver of Record (Requested by (Staff Code))
MRTME005  DIM       4       * Reasion of Movement
MRTME006  DIM       6       * Operator
MRTME007  DIM       8       * Due Date
MRTME008  DIM       1       * Status 1=Out 2=In
MRTME009  DIM       2       * Lock Feild Variable
MRTME010  DIM       3       * Document Type
MRTME011  DIM       2       * Volume Number
MRTME012  DIM       3       * Post discharge Header Current status
MRTME013  DIM       20      * Extention Number
MRTME014  DIM       20      * Pager Number    
MRTME015  DIM       10      * Web UserID
MRTME016  DIM       35      * Requested By
MRTME017  DIM       4       * MR Home Location
MRTME018  DIM       50      * Movement Comments
MRTME019  DIM       3       * Destination of Hospital (see MRTME003)  *I-240724
MRTME020  DIM       3       * MR Home Hospital ID     (see MRTME017)  *I-240724
.
MICRFILM  DIM       20      * Microfilm
VOLMCOMM  DIM       25      * Volume Comments
CLEARCOM  DIM       1       * Clear Commnets
.
DOCMTYPE  DIM       3       * Document Type 
VOLUMENO  DIM       2       * Volume Number
.
ALTHOHOS  DIM       3       * Alternate Home Hospital 
ALRTMESS  DIM       127     * Tracking alert message
ALRTCLAS  DIM       10      * Tracking alert class
ARRCNT    FORM      3       * Array Counter
COUNT     FORM      3       * Count of MR Keys
ENDDDATE  DATE      8
ERRFLG    FORM      1
ERRORCNT  FORM      3       * Count of Errors
ERRORLST  DIM       50[99]
LNKADMIS  DIM       8[99]   * Array of visit numbers for bulk record link
MRKEYARR  DIM       23[99]  * Array of MR Keys (added 3 for HOS)      *C-240724
MRKEYCNT  FORM      3       * Count of MR Keys
LINKACNT  FORM      3       * Count of visit numbers for bulk record link
MRRECKEY  DIM       40[99]  * Array of MR Keys
MRKEYEND  FORM      3       * Count of MR Keys
PRINTLAB  DIM       1
HOSKEY    DIM       3                                                 *I-240724
HOSLOCKY  DIM       7                                                 *I-240724
LOCKEY    DIM       4
RTYKEY    DIM       3
VOLKEY    DIM       2
VOLNLIST  DIM       500     * List of MR Volumes 
VOLMLIST  DIM       12      * List of MR Volumes allocated to visit
.
MRTTH001  DIM       4       * Template ID
MRTTH002  DIM       35      * Description
MRTTH003  DIM       1       * Active indicator 1=Active 0=Inactive
.
MRTTD001  DIM       4       * Template ID
MRTTD002  DIM       1       * Record Type (D/O)
MRTTD003  DIM       3       * Sequence No
MRTTD004  DIM       1       * Disease/Operation Type
MRTTD005  DIM       9       * Disease/Operation Code
MRTTD006  DIM       100     * Description
MRTTD007  DIM       2       * Diagnosis Cluster Identifier
.
FORM3     FORM      3       * Count for Sequence
FORM3A    FORM      3       * Testing for weather to read backwards or forwards
REQUESTN  DIM       10
SAVKEY    DIM       8       * Key Save
SAVMRKEY  DIM       10      * Save key to record
SAVMSTAT  DIM       3       * Save status
SAVMFILM  DIM       25      * Save MicroFilm Address
SAVMCOMM  DIM       20      * Save Volume Comments
TRNTOWRD  DIM       3       * Transfer to Ward    * I CAR 38495
NEWSEQNC  DIM       3       * New sequence passed in from BSP
MOVESWAP  DIM       1       * passed in from BSP to indicate swap or move
.
ADMNCNTR  FORM      2       * incomplete coding check
ADMNSTOR  DIM       8       * incomplete coding check  
.
CODTYP    FORM      3       * Coding type
.                             9 - ICD9 coding
.                             101 - ICD10 version 1 coding
.                             102 - ICD10 version 2 coding
CHRCOUNT  FORM      1       * Count         
.
JUSTNO    FORM      2       * Right justification amount
LJUSCODE  DIM       70      * Left justified code
RJUSCODE  DIM       70      * Right justified code
VOLUMENU  FORM      2[99]   * Volume No
.
VALDURNO  DIM       8        * Validate U/R Number
VALDDOTY  DIM       3        * Validate Document Type
VALDHMHO  DIM       3        * Validate Home hospital
VALDHMLC  DIM       4        * Validate Home location
RECORDKY  DIM       20       * Medical record key for default checkbox *C240724
SELECTKY  DIM       20       * Medical record key for default checkbox *C240724
.
BORRDATE  DATE      8
.
DFLTHHOS  DIM       3        * Dummy variable for default home hospital
DFLTHLOC  DIM       4        * Dummy variable for default home location
DFLTRCTY  DIM       3        * Dummy variable for default record type
DFLTSTAT  DIM       3        * Dummy variable for default status
WORKDATE  DATE      8
.
REPLSLSH  DIM       20       * Dummy variable to cater for \ in comment field
DISPCOMM  DIM       21       * Dummy variable to cater for \ in comment field
BACKSLSH  INIT      "\"
.
.---------------------------------------------------------------------------
PRGID     INIT      "MRTWEB01"
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Medical Record Tracking Maintenance"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
MAIN1010  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MRTLOC00        * Location Maintenance                
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
. 
MAIN1200  CALL      MRTMOV00        * Movement Reason Maintenance          
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      MRTSTF00        * Staff Register Maintenance          
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      MRTBAY00        * Bay Codes Maintenance          
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      MRTMAS00        * Medical Record Master Maintenance        
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      MRTVIS00        * Medical Records Linking / Unlinking
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      MRTTRC00        * Medical Records Bulk Reservations
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      MRTLST00
          GOTO      MAIN1000
.
MAIN1900  CALL      MRTMVE00        * Medical Records Bulk Movement
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      MRTMOE00        * Medical Records Movement History Main
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      MRTTHD00        * Medical Records Coding Templates
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      MRTTDT00        * Medical Records Coding Details
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      XMLMOV00        * Remote scripting for due date
          GOTO      MAIN1000
.
MAIN2400  CALL      XMLMRT00        * Remote scripting for MRT Details (bulk)
          GOTO      MAIN1000
.
MAIN2500  CALL      CHKLAB00        * Print Bar Code labels
          BRANCH    EXIT,MAIN1000
          MOVE      "Print Bar Code Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      XMLCHK00        * MRT Details Matching for Home Location (single)
          GOTO      MAIN1000
. 
MAIN2700  CALL      XMLVOL00        * Generate the next volume number
          GOTO      MAIN1000
.
MAIN2800  CALL      LINK0000        * Medical Records Linking / Unlinking
          BRANCH    EXIT,MAIN1000   * by Admission Number
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      XMLALT00        * Display medical record tracking alerts
          GOTO      MAIN1000
.
MAIN3000  CALL      XMLBAR00        * Remote script to select MR for
          GOTO      MAIN1000        * final admission barcode label printing
.
MAIN3100  CALL      XMLDCI00        * Remote script to save coding template
          GOTO      MAIN1000        * cluster id's
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP

.------------------------------------------------------------
. Remote scripting for MRT details   
.------------------------------------------------------------
XMLMRT00  CALL      XMLHED00
XMLMRT01  BRANCH    EXIT,XMLMRT99
.
          MATCH     SP10,HOMELOCN           * use new var HOMELOCN    *I-240724
          IF        !@EQUAL
            MATCH     SP10,LOCATION
            IF        @EQUAL
              MOVE      HOMELOCN,LOCATION
            ENDIF
          ENDIF
.
          MOVE      ZERO,HOMELOCT     * Moving to Home Location 
          MOVE      ZERO,CODINGDT     * Coding Date
          MOVE      SP70,HOMELOCD     * Home Location Description
          MOVE      SP70,LOCDESCR     * Location Description
          MOVE      SP70,LASTMOVD     * Last Movement Date
          MOVE      SP70,LINKVOLM
          MOVE      SP70,VOLMLIST 
.         
          RESET     DOCMTYPE
          MATCH     SP70,DOCMTYPE
          IF        !@EQUAL
            MOVE      DOCMTYPE,RTYKEY
          ENDIF
          MOVE      VOLUMENO,VOLKEY
          MOVE      SP10,SAVMSTAT
          MOVE      SP70,SAVMFILM
          MOVE      SP70,SAVMCOMM
.
          UNPACK    MRKEYARR[1],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY  *C-240724
.
          MOVE      ZERO,F2
          SQUEEZE   VOLKEY
          MOVE      VOLKEY,F2
          PACK      VOLKEY,F2,SP70
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
.
          MATCH     SP70,HOSKEY                                       *I-240724
          IF        !@EQUAL
            PACK      HOMEHOSP,HOSKEY,SP70
          ENDIF
.
          MATCH     SP70,LOCKEY
          IF        !@EQUAL
            PACK      LOCATION,LOCKEY,SP70
          ENDIF
.
          MATCH     SP70,RTYKEY
          IF        !@EQUAL
            PACK      DOCMTYPE,RTYKEY,SP70
          ENDIF
.
          MATCH     SP70,HOSLOCKY                                     *C-240724
          IF        !@EQUAL
            IF        IBCNMHOS=1
              MATCH     SP70,HOSKEY                * Pre multi hospital barcode
              IF        @EQUAL
                PACK      HOSKEY,HOMEHOSP,SP70     * Default home hospital
                PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10
              ENDIF
            ENDIF
.
            GOTO      XMLMRT20
          ENDIF
.
          PACK      LJUSCODE,URNUMBER,SP70
          MOVE      "8",JUSTNO
          CALL      RJUS0000        
          MOVE      RJUSCODE,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1                * Read Pateint Master File
          BRANCH    OVRCD,XMLMRT90
.
          MOVE      VOLUMENO,DIM2
          SQUEEZE   DIM2
          MOVE      ZERO,FORMVOLN
          MOVE      DIM2,FORMVOLN
.
          PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RSMRMAS3
XMLMRT10  CALL      RPMRMAS3               * Read MRT Master File
          BRANCH    OVRCD,XMLMRT91
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLMRT91 IF NOT EQUAL
.
          MATCH     SP70,LOCATION
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP                               *I-240724
            GOTO      XMLMRT10 IF NOT EQUAL
            MATCH     MRMAHLOC,LOCATION
            GOTO      XMLMRT10 IF NOT EQUAL
          ENDIF
.        
          MATCH     SP70,DOCMTYPE
          IF        !@EQUAL
            MATCH     DOCMTYPE,MRMADOTY
            GOTO      XMLMRT10 IF NOT EQUAL
          ENDIF
.
          MOVE      MRMAVOLN,VOLKEY
          IF        FORMVOLN<>0
            COMPARE   MRMAVOLN,FORMVOLN
            GOTO      XMLMRT15 IF EQUAL
            GOTO      XMLMRT10 
          ENDIF
.
XMLMRT15  MOVE      MRMAHLOC,LOCKEY
          MOVE      MRMAHHOS,HOSKEY                                   *I-240724
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
          MOVE      MRMADOTY,RTYKEY
          MOVE      MRMACOMM,EPISODET
          MOVE      MRMASTAT,SAVMSTAT
          MOVE      MRMAFILM,SAVMFILM
          MOVE      MRMACOMM,SAVMCOMM
.
          MOVE      MRMAKEY,SAVMRKEY
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                * Read MRT History File   
          IF        OVRCD=1
            PACK      MRHIDATE,SP70
            MOVE      MRMAHLOC,MRHILOC      * moves home loc into file
            MOVE      MRMAHHOS,MRHIDHOS     * moves home hospital into file
.
            MATCH     SP70,MRMACLOC
            IF        !@EQUAL
              MOVE      MRMACLOC,MRHILOC    * use master record Current Location
              MOVE      MRMACHOS,MRHIDHOS   * use master record Current Hospital
            ENDIF
          ELSE
            MATCH     MRHIKEY,MRMAKEY
            IF        !@EQUAL
              PACK      MRHIDATE,SP70
              MOVE      MRMAHLOC,MRHILOC    * moves home loc into file
              MOVE      MRMAHHOS,MRHIDHOS   * moves home hospital into file
.
              MATCH     SP70,MRMACLOC
              IF        !@EQUAL
                MOVE      MRMACLOC,MRHILOC  * use master record Current Location
                MOVE      MRMACHOS,MRHIDHOS * use master record Current Hospital
              ENDIF
            ENDIF
          ENDIF
          GOTO      XMLMRT60
.
XMLMRT20  UNPACK    MRKEYARR[1],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY  *C-240724
          MOVE      ZERO,F2
          SQUEEZE   VOLKEY
          MOVE      VOLKEY,F2
          PACK      VOLKEY,F2,SP70
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSKEY                * Pre multi hospital barcode
            IF        @EQUAL
              PACK      HOSKEY,HOMEHOSP,SP70     * Default home hospital
            ENDIF
          ENDIF
.
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
          MATCH     SP70,HOSLOCKY                                     *I-240724
          GOTO      XMLMRT40 IF EQUAL
.
XMLMRT30  MOVE      URNUMBER,KEY8
          CALL      RDMAST1                 * Read Patient Master File
          BRANCH    OVRCD,XMLMRT90
.
          PACK      KEY20,URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY,SP70   *C-240724
          CALL      RDMRMAS1                * Read MRT Master File
          BRANCH    OVRCD,XMLMRT91
.
          MOVE      MRMACOMM,EPISODET
          MOVE      MRMASTAT,SAVMSTAT
          MOVE      MRMAFILM,SAVMFILM
          MOVE      MRMACOMM,SAVMCOMM
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1                                
          CALL      RPMRHIS1                * Read MRT History File 
          IF        OVRCD=1
            PACK      MRHIDATE,SP70
            MOVE      MRMAHLOC,MRHILOC      * moves home loc into file
            MOVE      MRMAHHOS,MRHIDHOS     * moves home hospital into file
.
            MATCH     SP70,MRMACLOC
            IF        !@EQUAL
              MOVE      MRMACLOC,MRHILOC    * use master record Current Location
              MOVE      MRMACHOS,MRHIDHOS   * use master record Current Hospital
            ENDIF
          ELSE
            MATCH     MRHIKEY,MRMAKEY
            IF        !@EQUAL
              PACK      MRHIDATE,SP70
              MOVE      MRMAHLOC,MRHILOC    * moves home loc into file
              MOVE      MRMAHHOS,MRHIDHOS   * moves home hospital into file
.
              MATCH     SP70,MRMACLOC
              IF        !@EQUAL
                MOVE      MRMACLOC,MRHILOC  * use master record Current Location
                MOVE      MRMACHOS,MRHIDHOS * use master record Current Hospital
              ENDIF
            ENDIF
          ENDIF
          GOTO      XMLMRT60
.
XMLMRT40  PACK      LJUSCODE,URNUMBER,SP70
          MOVE      "8",JUSTNO
          CALL      RJUS0000        
          MOVE      RJUSCODE,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1                 * Read Patient Master File
          BRANCH    OVRCD,XMLMRT90
.
          PACK      KEY20,URNUMBER,Z70
          CALL      RSMRMAS3
XMLMRT50  CALL      RPMRMAS3
          BRANCH    OVRCD,XMLMRT91
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLMRT91 IF NOT EQUAL
.          
          MATCH     SP70,LOCATION
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP                               *I-240724
            GOTO      XMLMRT50 IF NOT EQUAL
            MATCH     MRMAHLOC,LOCATION
            GOTO      XMLMRT50 IF NOT EQUAL
          ENDIF 
.
          MATCH     SP70,DOCMTYPE
          IF        !@EQUAL
            MATCH     MRMADOTY,DOCMTYPE
            GOTO      XMLMRT50 IF NOT EQUAL
          ENDIF 
.
..          MATCH     MRCNSTAT,MRMASTAT
..          GOTO      XMLMRT50 IF NOT EQUAL
.
          MOVE      MRMAHLOC,LOCKEY
          MOVE      MRMAHLOC,HOSKEY                                   *I-240724
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
          MOVE      MRMADOTY,RTYKEY
          MOVE      MRMAVOLN,VOLKEY
          MOVE      MRMACOMM,EPISODET            
          MOVE      MRMAKEY,SAVMRKEY
          MOVE      MRMASTAT,SAVMSTAT
          MOVE      MRMAFILM,SAVMFILM
          MOVE      MRMACOMM,SAVMCOMM
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1                                
          CALL      RPMRHIS1
          IF        OVRCD=1
            PACK      MRHIDATE,SP70
            MOVE      MRMAHLOC,MRHILOC      * moves home loc into file
            MOVE      MRMAHHOS,MRHIDHOS     * moves home hospital into file
.
            MATCH     SP70,MRMACLOC
            IF        !@EQUAL
              MOVE      MRMACLOC,MRHILOC    * use master record Current Location
              MOVE      MRMACHOS,MRHIDHOS   * use master record Current Hospital
            ENDIF
          ELSE
            MATCH     MRHIKEY,MRMAKEY
            IF        !@EQUAL
              PACK      MRHIDATE,SP70
              MOVE      MRMAHLOC,MRHILOC    * moves home loc into file
              MOVE      MRMAHHOS,MRHIDHOS   * moves home hospital into file
.
              MATCH     SP70,MRMACLOC
              IF        !@EQUAL
                MOVE      MRMACLOC,MRHILOC  * use master record Current Location
                MOVE      MRMACHOS,MRHIDHOS * use master record Current Hospital
              ENDIF
            ENDIF
          ENDIF
.
XMLMRT60  MOVE      SP70,VOLNLIST
          PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RSMRMAS3
XMLMRT70  CALL      RPMRMAS3               * Read MRT Master File
          BRANCH    OVRCD,XMLMRT75
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLMRT75 IF NOT EQUAL
. 
          MATCH     SP70,LOCATION
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP                               *I-240724
            GOTO      XMLMRT70 IF NOT EQUAL
            MATCH     MRMAHLOC,LOCATION
            GOTO      XMLMRT70 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCMTYPE
          IF        !@EQUAL
            MATCH     DOCMTYPE,MRMADOTY
            GOTO      XMLMRT70 IF NOT EQUAL  
          ENDIF
.
..          MATCH     MRCNSTAT,MRMASTAT
..          GOTO      XMLMRT70 IF NOT EQUAL
.
          APPEND    DMRMAVOL,VOLNLIST
          APPEND    COMMA,VOLNLIST
.
XMLMRT72  MATCH     SP70,VISITNUM
          IF        !@EQUAL & !@EOS
            PACK      KEY8,VISITNUM,SP70
            CALL      RDMRVS1
            IF        OVRCD=0
              MATCH     MRMAKEY,MRVSMKEY
              IF        @EQUAL
                MOVE      DMRMAVOL,LINKVOLM 
                MATCH     SP70,VISITNUM
                IF        !@EQUAL & !@EOS
                  PACK      KEY10,MRVSMKEY,SP70
                  CALL      RDMRMAS2
                  IF        OVRCD=0
                    MOVE      MRMACLOC,MRHILOC
                    MOVE      MRMACHOS,MRHIDHOS
                  ENDIF
                ENDIF
              ENDIF
              MATCH     MRMAKEY,MRVSXKY1
              IF        @EQUAL
                APPEND    DMRMAVOL,VOLMLIST  
                APPEND    COMMA,VOLMLIST
              ENDIF
              MATCH     MRMAKEY,MRVSXKY2
              IF        @EQUAL
                APPEND    DMRMAVOL,VOLMLIST  
                APPEND    COMMA,VOLMLIST
              ENDIF
              MATCH     MRMAKEY,MRVSXKY3
              IF        @EQUAL
                APPEND    DMRMAVOL,VOLMLIST  
                APPEND    COMMA,VOLMLIST
              ENDIF
              MATCH     MRMAKEY,MRVSXKY4
              IF        @EQUAL
                APPEND    DMRMAVOL,VOLMLIST  
                APPEND    COMMA,VOLMLIST
              ENDIF
              MATCH     MRMAKEY,MRVSXKY5
              IF        @EQUAL
                APPEND    DMRMAVOL,VOLMLIST  
                APPEND    COMMA,VOLMLIST
              ENDIF
            ENDIF
          ENDIF            
.
          GOTO      XMLMRT70

XMLMRT75  PACK      MRKEYARR[1],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY  *C-240724
          REP       " +",MRKEYARR[1]
          CALL      PATNAM00
.
          PACK      KEY20,URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY,SP70 
          CALL      RDMRMAS1                * Read MRT Master File
          BRANCH    OVRCD,XMLMRT91
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP10                        *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,XMLMRT92
.
          PACK      KEY70,MRLODESC                          * start   *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRHIDHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRHIDHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRHIDHOS            * destination hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * same as the home hospital ?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRHIDHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRHIDHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
          ENDIF                                             
          MOVE      KEY70,LOCDESCR                          * end     *I-240724
          PACK      RECSTATD,SP70
          PACK      RECSTATC,SP70
.
          PACK      KEY5,CODERS,SAVMSTAT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,XMLMRT89
          MOVE      TDESC,RECSTATD
          MOVE      PTCDUDF3,RECSTATC
.
          MATCH     SP70,MRHIDATE        * Movement History date
          GOTO      XMLMRT76 IF EQUAL
.
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTMOVD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR

XMLMRT76  PACK      KEY7,MRTME019,MRTME003,SP70  * Destination        *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,XMLMRT77
.
          MATCH     MRLOTYPE,MRCNHMTY
          IF        @EQUAL
            PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                     *I-240724
            PACK      KEY7,MRTME019,MRTME003,SP10                     *I-240724
            MATCH     HOSLOCKY,KEY7                                   *I-240724
            IF        !@EQUAL
              MOVE      ONE,HOMELOCT    * Moving to a Home Location 
            ENDIF
          ENDIF
.
XMLMRT77  PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
XMLMRT78  CALL      RDPVISA2                                                   
          BRANCH    OVRCD,XMLMRT80
.
          MATCH     PVIURNO,URNUMBER
          GOTO      XMLMRT79 IF NOT EQUAL
.
          MATCH     "00000000",PVIDATE          * Bad Debt? If so Ignore!
          GOTO      XMLMRT78 IF EQUAL
.
          COMPARE   PVITYPE,THREE                                              
          GOTO      XMLMRT78 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,XMLMRT78
.
          COMPARE   "3",ASTAT                   * Discharged only
          GOTO      XMLMRT78 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            MOVE      ONE,CODINGDT              * Coding Found
            MOVE      PVIBILL,ADMNSTOR
            GOTO      XMLMRT78
          ENDIF
.
          GOTO      XMLMRT78
.
XMLMRT79  COMPARE   ZERO,CODINGDT
          GOTO      XMLMRT80 IF EQUAL
.
.  Incomplete Coding found. Now Retrieve Discharge Date, Post Discharge Status
.  & Discharge Destination. These will be returned.
.
          PACK      KEY8,ADMNSTOR,SP70 
          CALL      RDDSCH1           * Read Discharge File
          IF        OVRCD=0
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   * Disch Date
            MOVE      "DD",CATEGORY  
            MOVE      DDEST,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISCDEST     * Discharge Destination       
          ELSE
            MOVE      SP70,DISCDATE
            MOVE      SP70,DISCDEST
          ENDIF
.
          PACK      KEY8,ADMNSTOR,SP70 
          CALL      RDMRPDS1             * Read Post Discharge Header File
          IF        OVRCD=0
            MOVE      "CP",CATEGORY  
            MOVE      MRPDSTAT,CODE
            CALL      GETCOD00
            MOVE      TDESC,PDSTDEST      * Post Discharge Status    
          ELSE
            MOVE      SP70,PDSTDEST
          ENDIF
.
XMLMRT80  MOVE      ZERO,MFLAG        * Check that movement date is after last
          MOVE      SP70,MDATE        * movement date
.
          MATCH     MRHIDATE,SP70
          GOTO      XMLMRT82 IF EQUAL
.
          MATCH     MRHIDATE,MRTME001          * Check history date
          IF        @EQUAL
            MATCH     MRHITIME,MRTME002
            IF        @LESS
              MOVE      ONE,MFLAG
              UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                                   DEC
              PACK      MDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
            GOTO      XMLMRT82
          ENDIF
.
          MATCH     MRHIDATE,MRTME001          * Check history date
          IF        @LESS
            UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      ONE,MFLAG
          ENDIF
.
XMLMRT82  MOVE      ZERO,RFLAG
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
          PACK      KEY7,MRTME019,MRTME003,SP10                       *I-240724
.                                           * If going back home check for
          MATCH     HOSLOCKY,KEY7                                     *I-240724
          GOTO      XMLMRT85 IF NOT EQUAL   * unfilled requests after movement
.                                           * date
          PACK      KEY20,SAVMRKEY,SP70
          CALL      RSMRRQD2
XMLMRT83  CALL      RKMRRQD2
          BRANCH    OVRCD,XMLMRT85
. 
          MATCH     SAVMRKEY,MRRDRKEY
          GOTO      XMLMRT85 IF NOT EQUAL
.
          MATCH     ANSN,MRRDFILL
          GOTO      XMLMRT83 IF NOT EQUAL
.
          PACK      KEY10,MRRDRQNO
          CALL      RDMRRQH1
          BRANCH    OVRCD,XMLMRT83
.
          MATCH     MRRQDTRQ,MRTME001        
          IF        @EQUAL
            MATCH     MRRQTMRQ,MRTME002
            IF        @LESS
              MOVE      ONE,RFLAG
              GOTO      XMLMRT84
            ENDIF
            GOTO      XMLMRT83
          ENDIF
          IF        @LESS
            MOVE      ONE,RFLAG
            GOTO      XMLMRT84
          ENDIF
.
          GOTO      XMLMRT83
.
XMLMRT84  UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY  * Date Required
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      RQSTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,RQSTLOCT        * Get Location Required
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70                       *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=0
            PACK      RQSTLOCT,MRLODESC,SP70
          ENDIF
.
          MOVE      SP70,RQSTREAS        * Get Movement Reason
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          IF        OVRCD=0
            PACK      RQSTREAS,MRMODESC,SP70
          ENDIF
.
XMLMRT85  PACK      KEY7,HOSKEY,LOCKEY,SP70                           *C-240724
          CALL      RDMRLOC1  
          IF        OVRCD=0
.                                           * Current Location
            PACK      KEY70,MRLODESC                        * start   *I-240724
            IF        IBCNMHOS = 1
              MOVE      SP70,KEY30
              PACK      KEY30,OBB,HOSKEY,CBB     * set default to black
              MATCH     MRMAHHOS,HOSKEY  
              IF        !@EQUAL
                MOVE      SP3,PTHSHHOS
                PACK      KEY3,HOSKEY            * destination hosp
                CALL      RDPTHSP1
                MATCH     PTHSHHOS,MRMAHHOS      * same as the home hospital ?
                IF        !@EQUAL
                  PACK      KEY30,OBR,HOSKEY,CBR     * red
                ELSE
                  UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                  PACK      KEY5,CATTY,PTHSRCTY                       *C-259106
                  CALL      RDCODE1
                  MATCH     "B",TCINDC1                       
                  IF        !@EQUAL
                    PACK      KEY30,OBR,HOSKEY,CBR   * red
                  ENDIF
                ENDIF
              ENDIF
              PACK      KEY70,KEY30,MRLODESC     * format "(HOS)Location"
              RESET     KEY70
            ENDIF                                             
            MOVE      KEY70,HOMELOCD                        * end     *I-240724
          ENDIF
.
          MATCH     "Y  ",PTMXFILN   * Filing Required for UR?
          IF        @EQUAL
            MOVE      "Y",FILREQED
          ELSE
            MOVE      "N",FILREQED
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                           MRKEYARR[1],"|",PATFNAME,"|":
                           LOCDESCR,"|",LASTMOVD,"|",RECSTATD,"|",VOLNLIST,"|":
                           HOMELOCT,"|",EPISODET,"|",CODINGDT,"|",PSTAT,"|":
                           PPSNAME,"|",MFLAG,"|",MDATE,"|",RFLAG,"|":
                           DISCDATE,"|",DISCDEST,"|",PDSTDEST,"|",ADMNSTOR,"|":
                           FILREQED,"|",HOMELOCD,"|",RQSTDATE,"|",MRRQTMRQ:
                           "|",MRRQLOCR,"|",RQSTLOCT,"|",MRRQPERS,"|",MRRQMOVR:
                           "|",RQSTREAS,"|",MRRQHOSC,"|",SAVMCOMM,"|",SAVMFILM:
                           "|",LINKVOLM,"|",VOLMLIST,"|",RECSTATC:
                           "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
.        ********** OUTPUT ERRORS **********
.
XMLMRT89  MATCH     "1",DISAMREC
          GOTO      XMLMRT94 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Record":
                             "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
XMLMRT90  MATCH     "1",DISAMREC
          GOTO      XMLMRT94 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid U/R number -",URNUMBER:
                             "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
XMLMRT91  MATCH     "1",DISAMREC
          GOTO      XMLMRT94 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Volume Not Found, UR - ",URNUMBER:
                             "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
XMLMRT92  MATCH     "1",DISAMREC
          GOTO      XMLMRT94 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Location of record not found, UR - ",URNUMBER:
                             "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
XMLMRT93  MATCH     "1",DISAMREC
          GOTO      XMLMRT94 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Document Type Required, UR - ",URNUMBER:
                             "</RETURN_VALUE>"
          GOTO      XMLMRT95
.
XMLMRT94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "allmedicalrecords":   
                             "</RETURN_VALUE>" 
          GOTO      XMLMRT95
.
XMLMRT95  CALL      XMLEND00
XMLMRT99  RETURN
.------------------------------------------------------------
. Remote scripting for MRT details
.------------------------------------------------------------
XMLCHK00  MOVE      ZERO,ADMNCNTR
.
          CALL      XMLHED00
          BRANCH    EXIT,XMLCHK99
.
          MOVE      ZERO,HOMELOCT
          MOVE      ZERO,CODINGDT
          MOVE      ZERO,MFLAG              * Clear move history warnings
          MOVE      SP70,MDATE
.
          PACK      KEY20,MRKEYARR[1],SP70                            *C-240724
          CALL      RDMRMAS1                * Read MRT Master File
          BRANCH    OVRCD,XMLCHK89
.
          MOVE      ZERO,RFLAG
          MATCH     MRMAHHOS,MRTME019                                 *I-240724
          GOTO      XMLCHK20 IF NOT EQUAL
          MATCH     MRMAHLOC,MRTME003       * If going back home check for
          GOTO      XMLCHK20 IF NOT EQUAL   * unfilled requests after movement
.                                           * date
          PACK      KEY20,MRMAKEY,SP70
          CALL      RSMRRQD2            * Read Request Details
XMLCHK10  CALL      RKMRRQD2
          BRANCH    OVRCD,XMLCHK20
. 
          MATCH     MRMAKEY,MRRDRKEY    * Valid Medical Record Key
          GOTO      XMLCHK20 IF NOT EQUAL
.
          MATCH     ANSN,MRRDFILL
          GOTO      XMLCHK10 IF NOT EQUAL
.
          PACK      KEY10,MRRDRQNO     * Request Header Details
          CALL      RDMRRQH1
          BRANCH    OVRCD,XMLCHK10
.
          MOVE      ONE,RFLAG          * Display error for unfilled requests
.                                      * regardless of the date and time
.
          UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY  * Date Required
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      RQSTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,RQSTLOCT        * Get Location Required
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70                       *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=0
            PACK      RQSTLOCT,MRLODESC,SP70
          ENDIF
.
          MOVE      SP70,RQSTREAS        * Get Movement Reason
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          IF        OVRCD=0
            PACK      RQSTREAS,MRMODESC,SP70
          ENDIF
.
..          GOTO      XMLCHK10          * P.D Removed 15/06/04 as no need to 
..                                      * re-read more request once flag is set!
.
XMLCHK20  PACK      KEY7,MRTME019,MRTME003  * Hospital/Destination    *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,XMLCHK80
.
          MATCH     MRLOTYPE,MRCNHMTY
          IF        @EQUAL
            MATCH     MRMAHHOS,MRTME019
            IF        !@EQUAL
              MOVE      ONE,HOMELOCT        * Moving to a Home Location
            ENDIF
            MATCH     MRMAHLOC,MRTME003
            IF        !@EQUAL
              MOVE      ONE,HOMELOCT    * Moving to a Home Location
            ENDIF
          ENDIF
.
          PACK      KEY26,MRMAKEY,Z70       * Check movement date is not
          CALL      RSMRHIS1                * bofore the last movement date
          CALL      RPMRHIS1                * Read MRT History File
          BRANCH    OVRCD,XMLCHK60
.
          MATCH     MRHIKEY,MRMAKEY         * Correct history record
          GOTO      XMLCHK60 IF NOT EQUAL
.
          MATCH     MRHIDATE,MRTME001          * Check history date
          IF        @EQUAL
            MATCH     MRHITIME,MRTME002
            IF        @LESS
              MOVE      ONE,MFLAG
              UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                                   DEC
              PACK      MDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
            GOTO      XMLCHK60
          ENDIF
.
          MATCH     MRHIDATE,MRTME001          * Check history date
          IF        @LESS
            UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      ONE,MFLAG
          ENDIF
.
XMLCHK60  PACK      KEY24,MRMAURNO,Z70
          CALL      RDSVISA2
XMLCHK70  CALL      RDPVISA2
          BRANCH    OVRCD,XMLCHK80
.
          MATCH     PVIURNO,MRMAURNO
          GOTO      XMLCHK75 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            PACK      KEY8,PVIBILL,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,XMLCHK70
.
            MATCH     WBSEHOSP,PMVXMHOS         * Skip if not for the users
            GOTO      XMLCHK70 IF NOT EQUAL     * logged in hospital
          ENDIF
.
          ADD       ONE,ADMNCNTR
          IF        ADMNCNTR > 20
            GOTO      XMLCHK75                  * only check max of 20 records
          ENDIF
.
          MATCH     "00000000",PVIDATE          * Bad Debt? If so Ignore!
          GOTO      XMLCHK70 IF EQUAL
.
          COMPARE   PVITYPE,THREE
          GOTO      XMLCHK70 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,XMLCHK70
.
          COMPARE   "3",ASTAT                   * Discharged only
          GOTO      XMLCHK70 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            MOVE      ONE,CODINGDT              * Coding Found
            MOVE      PVIBILL,ADMNSTOR
            GOTO      XMLCHK70
          ENDIF
.
          GOTO      XMLCHK70
.
XMLCHK75  COMPARE   ZERO,CODINGDT
          GOTO      XMLCHK80 IF EQUAL
.
.  Incomplete Coding found. Now Retrieve Discharge Date, Post Discharge Status
.  & Discharge Destination. These will be returned.
.
          PACK      KEY8,ADMNSTOR,SP70
          CALL      RDDSCH1           * Read Discharge File
          IF        OVRCD=0
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   * Disch Date
            MOVE      "DD",CATEGORY
            MOVE      DDEST,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISCDEST     * Discharge Destination
          ELSE
            MOVE      SP70,DISCDATE
            MOVE      SP70,DISCDEST
          ENDIF
.
          PACK      KEY8,ADMNSTOR,SP70
          CALL      RDMRPDS1             * Read Post Discharge Header File
          IF        OVRCD=0
            MOVE      "CP",CATEGORY
            MOVE      MRPDSTAT,CODE
            CALL      GETCOD00
            MOVE      TDESC,PDSTDEST      * Post Discharge Status
          ELSE
            MOVE      SP70,PDSTDEST
          ENDIF
.
          GOTO      XMLCHK80
.
XMLCHK80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             HOMELOCT,"|",CODINGDT,"|",MFLAG,"|",MDATE,"|":
                             RFLAG,"|",DISCDATE,"|",DISCDEST,"|",PDSTDEST,"|":
                             ADMNSTOR,"|",RQSTDATE,"|",MRRQTMRQ,"|",MRRQLOCR:
                             "|",RQSTLOCT,"|",MRRQPERS,"|",MRRQMOVR,"|":
                             RQSTREAS:
                             "</RETURN_VALUE>"
          GOTO      XMLCHK95
.
XMLCHK89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Record":
                             "</RETURN_VALUE>"
.
XMLCHK95  CALL      XMLEND00
XMLCHK99  RETURN
.------------------------------------------------------------
. Display the Due Date               
.------------------------------------------------------------
XMLMOV00  CALL      XMLHED00
          BRANCH    EXIT,XMLMOV99
.
          PACK      KEY4,MRTME005
          CALL      RDMRMOV1
          BRANCH    OVRCD,XMLMOV90
.       
          MOVE      MRTME001,BORRDATE
          ADD       MRMOPERD,BORRDATE           * add no. of days to date
.
          UNPACK    BORRDATE,CCENT,CYEAR,CMON,CDAY

          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          GOTO      XMLMOV80
.
XMLMOV80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY12:
                             "</RETURN_VALUE>"
          GOTO      XMLMOV95
.
XMLMOV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Record":
                             "</RETURN_VALUE>"
XMLMOV95  CALL      XMLEND00
XMLMOV99  RETURN
.------------------------------------------------------------
. Medical Records Lists by Date 
.------------------------------------------------------------
MRTLST00  CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Medical Records Lists",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MRTLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      MRTLST99
.
MRTLST99  RETURN
.------------------------------------------------------------
. List by Date Range
.------------------------------------------------------------
MLST0000  BRANCH    FLDITMNO,MLST0100,MLST0200,MLST0300,MLST0400,MLST0500:
                             MLST0600,MLST0700,MLST0800,MLST0900,MLST1000:
                             MLST1100,MLST1200,MLST1300,MLST1400,MLST1500:
                             MLST1600,MLST1700,MLST1800,MLST1900,MLST2000:
                             MLST2100,MLST2200,MLST2300,MLST2400,MLST2500
.
MLST0100  CALL      NEXT0000
          GOTO      MLST9999
.
MLST0200  CALL      PREV0000
          GOTO      MLST9999
.
MLST0300  CALL      CURSTD00
          GOTO      MLST9999
.
MLST0400  CALL      CUREND00
          GOTO      MLST9999
.
MLST0500  CALL      CURYR000
          GOTO      MLST9999
.
MLST0600  CALL      CURMON00
          GOTO      MLST9999
.
MLST0700  CALL      SELV0000
          GOTO      MLST9999
.
MLST0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      MLST9999
.
MLST0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      MLST9999
.
MLST1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MLST9999
.
MLST1100  CALL      HISTAB00
          GOTO      MLST9999
.
MLST1200  CALL      RESTAB00
          GOTO      MLST9999
.
MLST1300  PACK      KEY7,SP70
          CALL      RDMRLOC1
MLST1310  CALL      RKMRLOC1
          BRANCH    OVRCD,MLST9999
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      MLST1310
          ENDIF
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,LOCATION
          IF        @EQUAL
....        MATCH     MRLOHOSP,HOSPID           * MLMLMLML            *I-240724
....        GOTO      MLST1312 IF NOT EQUAL                           *I-240724
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MLST1312    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MLST1310 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MLST1310
.
MLST1400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MLST1410
.
          MATCH     SP70,FILTURNO
          GOTO      MLST9999 IF EQUAL
.
          WRITE     HTMLFILE;FILTURNO;
          GOTO      MLST9999
.
MLST1410  MATCH     SP70,FILTURNO
          GOTO      MLST9999 IF EQUAL
          GOTO      MLST9999 IF EOS
.
          PACK      KEY8,FILTURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MLST9999
.
          CALL      PATNAA00
          WRITE     HTMLFILE;PATFNAME;
          GOTO      MLST9999
.
MLST1500  WRITE     HTMLFILE;FILTTYPE;
          GOTO      MLST9999
.
MLST1600  PACK      KEY10,SP70
          CALL      RSWBSE1
MLST1610  CALL      RKWBSE1
          BRANCH    OVRCD,MLST9999
.
          MATCH     "1",INACTVOP
          IF        !@EQUAL
            MATCH     "1",WBSEACT
            GOTO      MLST1610 IF NOT EQUAL
          ENDIF
          PACK      KEY15,QUOTE,WBSEUID,QUOTE
          MATCH     FILTUSID,WBSEUID
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               WBSENAM,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY15,">",WBSENAM,"</option>"
          ENDIF
          GOTO      MLST1610
.
MLST1700  CALL      LOCSEL00                     * Locations selection list
          GOTO      MLST9999
.
MLST1800  PACK      KEY7,SP70      * Displays list of Home Locations
          CALL      RDMRLOC1
MLST1810  CALL      RKMRLOC1
          BRANCH    OVRCD,MLST9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      MLST1810 
          ENDIF     
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      MLST1810 IF NOT EQUAL
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,HOLOCODE
          IF        @EQUAL
....        MATCH     MRLOHOSP,HOSPID           * MLMLMML             *I-240724
....        GOTO      MLST1812 IF NOT EQUAL                           *I-240724
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MLST1812    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MLST1810 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MLST1810
.
MLST1900  RESET     DOCUTYPE
          MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      DOCUTYPE,CODE
          CALL      CODITM00
          GOTO      MLST9999
.
MLST2000  MOVE      FILTHOSP,SELHOSP
          CALL      HSEL0000                * Selection list of User Hospitals
          MOVE      SELHOSP,FILTHOSP        * Retain default hospital code
          GOTO      MLST9999
.
MLST2100  WRITE     HTMLFILE;SUPERLEV;
          GOTO      MLST9999
.
MLST2200  WRITE     HTMLFILE;FILTDEST;      * Destination filter
          GOTO      MLST9999
.
MLST2300  WRITE     HTMLFILE;INACTVDS;      * Show Inactive Destination filter
          GOTO      MLST9999
.
MLST2400  WRITE     HTMLFILE;INACTVOP;      * Show Inactive Operator Ids
          GOTO      MLST9999
.
MLST2500  UNPACK    DIM127,D1,KEY1,DIM127   * Operator ID filter
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,FILTUSID
          IF        @EQUAL
            GOTO      MLST9999 IF EQUAL
          ENDIF
          BRANCH    F1,MLST2510
.
          PACK      KEY10,FILTUSID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,MLST9999
.
MLST2505  WRITE     HTMLFILE;WBSEUID
          GOTO      MLST9999
.
MLST2510  WRITE     HTMLFILE;WBSENAM;
          GOTO      MLST2515
.          
MLST2515  PACK      KEY10,USERID,SP70     * restore UserID
          CALL      RDWBSE1
          GOTO      MLST9999
.
MLST9999  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,NEXT0100,NEXT0200
          WRITE     HTMLFILE;"SelectNextDay();";
          GOTO      NEXT9999
NEXT0100  WRITE     HTMLFILE;"SelectNextWeek();";
          GOTO      NEXT9999
NEXT0200  WRITE     HTMLFILE;"SelectNextMonth();";
          GOTO      NEXT9999
NEXT9999  RETURN
.------------------------------------------------------------
. Last Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,PREV0100,PREV0200
          WRITE     HTMLFILE;"SelectLastDay();";
          GOTO      PREV9999
PREV0100  WRITE     HTMLFILE;"SelectLastWeek();";
          GOTO      PREV9999
PREV0200  WRITE     HTMLFILE;"SelectLastMonth();";
          GOTO      PREV9999
PREV9999  RETURN
.------------------------------------------------------------
. Records by Date Range
.------------------------------------------------------------
HISTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,RECCOUNT
          PACK      KEY26,FRSTDATE,SP30
          CALL      RSMRHIS3                    * position on histor
HISTAB10  CALL      RKMRHIS3                    * read key sequenti
          BRANCH    OVRCD,HISTAB99
          MATCH     MRHIDATE,LASTDATE
          GOTO      HISTAB99 IF LESS
.
          MATCH     SP70,FILTUSID
          IF        !@EQUAL
            MATCH     MRHIUSID,FILTUSID
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      MRHIKEY,KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,HISTAB10
.
          PACK      KEY8,MRMAURNO
          CALL      RDMAST1
          BRANCH    OVRCD,HISTAB10
          CALL      RDPMPX21
          BRANCH    OVRCD,HISTAB10
.
          MATCH     SP70,FILTURNO              * Match U/R with filter
          IF        !@EQUAL                   
            MATCH     MRMAURNO,FILTURNO
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HOLOCODE
          IF        !@EQUAL
            MATCH     MRMAHLOC,HOLOCODE
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCUTYPE
          IF        !@EQUAL
            MATCH     MRMADOTY,DOCUTYPE
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHOSP                                     *I-240724
          IF        !@EQUAL
            MATCH     MRHIDHOS,FILTHOSP     * destination Hospital
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTDEST
          IF        !@EQUAL
            MATCH     MRHILOC,FILTDEST      * destination Location
            GOTO      HISTAB10 IF NOT EQUAL
          ENDIF
.
          CALL      HISROW00
.
          BRANCH    EXIT,HISTAB10              * Skip record and do not count it
.
          ADD       ONE,RECCOUNT
          IF        RECCOUNT<150
            GOTO      HISTAB10 
          ELSE
            WRITE     HTMLFILE;"LimitReached();" * I CAR 48031
          ENDIF
.
HISTAB99  RETURN
.------------------------------------------------------------
. History Row
.------------------------------------------------------------
HISROW00  MOVE      SP70,MRLODESC
.
          MATCH     SP70,MRMACLOC
          GOTO      HISROW10 IF EQUAL
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          GOTO      HISROW20
.
HISROW10  PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
HISROW20  CALL      RDMRLOC1
          MOVE      MRLODESC,HOMELOCD
. 
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRHIDHOS,MRHILOC,SP10                        *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC                          * start   *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRHIDHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRHIDHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRHIDHOS            * destination hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * same as the home hospital ?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRHIDHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRHIDHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            PACK      KEY70,KEY30,MRLODESC,SP70  * format "(HOS)Location"
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
          IF        FILTTYPE = 0
            GOTO      HISROW70
          ENDIF
.
          IF        FILTTYPE = 1
            MATCH    "1",MRLOINDC
            GOTO     HISROW80 IF NOT EQUAL
          ENDIF
.
          IF        FILTTYPE = 2
            MATCH    "2",MRLOINDC
            GOTO     HISROW80 IF NOT EQUAL
          ENDIF
.
HISROW70  MOVE      SP70,KEY25
          MOVE      MRHIRECV,KEY6
          CALL      RDMRSTF1
          PACK      KEY25,MRSTTITL,SP1,MRSTSNAM,SP1,MRSTGNAM 
.
          MOVE      SP70,MRMODESC
          MOVE      MRHIREAS,KEY4
          CALL      RDMRMOV1
.
          MOVE      SP70,KEY50
          PACK      PRESDETS,SP70,SP70
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,KEY50   * Requested By Free Format
            CALL      GTPEX000         * get pager,ext details
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
              CALL      GTPEX000
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:HistoryLink('",HTMLLINK
          APPEND    MRHIKEY,HTMLLINK
          APPEND    MRHIDATE,HTMLLINK
          APPEND    MRHITIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      SP70,DISPRECN
          MATCH     SP70,MRHIRCUI
          IF        !@EQUAL
            PACK      KEY10,MRHIRCUI,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      MRHIRCUI,WBSENAM
            ENDIF
            MOVE      WBSENAM,DISPRECN
          ENDIF
.
          MOVE      SP70,DISPRECS
          MOVE      ZERO,F1
          MOVE      MRHIRCST,F1
          LOAD      DISPRECS,F1,RECSTAT1,RECSTAT2,RECSTAT3
.
          MOVE      "&nbsp;",DISPLNAM
          PACK      KEY10,MRHIUSID
          CALL      RDWBSE1
          BRANCH    OVRCD,HISROW75
.
          MOVE      WBSENAM,DISPLNAM
.
HISROW75  CALL      PATLN000
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       " +",MRMAURNO
          SQUEEZE   MRMAHLOC
          SQUEEZE   MRMADOTY
          SQUEEZE   DMRMAVOL
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",MRHIDATE,MRHITIME,"#",":       * 2
                             "#"",MRHIDDUE,"#",":                * 3
                             "#"",HOMELOCD,"#",":                * 4
                             "#"",HLOCDSC1,"#",":                * 5  *C-240724
                             "#"",KEY25,"#",":                   * 6
                             "#"",MRMODESC,"#",":                * 7
                             "#"",DISPLNAM,"#",":                * 8
                             "#"",KEY3,"#",":                    * 9
                             "#"",MRHICOMM,"#",":                * 10
                             "#"",LINKPRG,"#.pbl":               * 11
                                 "?reportno=",LINKREP:
                                 "&template=",LINKTEM:
                                 "&urnumber=",MRMAURNO,"#",": 
                             "#"",DISPRECS,"#",":                * 12
                             "#"",MRHIRCDT,MRHIRCTM,"#",":       * 13
                             "#"",DISPRECN,"#",":                * 14
                             "#"",PRESDETS,"#",":                * 15
                             "#"",MRHIMOVN,"#",":                * 16
                             "#"",MRMAHLOC,"/":                  * 17   
                             MRMADOTY,"/",DMRMAVOL,"#");"
.
          REP       "+ ",MRMAURNO
.
          MOVE      ZERO,EXIT
          GOTO      HISROW99
.
HISROW80  MOVE      ONE,EXIT
          GOTO      HISROW99
.
HISROW99  RETURN
.------------------------------------------------------------
. Records by Date Range
.------------------------------------------------------------
RESTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCOUNT
.
          PACK      KEY31,FRSTDATE,SP30
          CALL      RSMRRES2                    * position 
RESTAB10  CALL      RKMRRES2                    * read key sequential
          BRANCH    OVRCD,RESTAB99
          MATCH     MRRSRESV,LASTDATE
          GOTO      RESTAB99 IF LESS
.
          MOVE      MRRSKEY,KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,RESTAB10
.
          PACK      KEY8,MRMAURNO
          CALL      RDMAST1
          BRANCH    OVRCD,RESTAB10
.
          CALL      RESROW00
.
          ADD       ONE,RECCOUNT
          IF        RECCOUNT<150
            GOTO      RESTAB10 
          ENDIF
.
RESTAB99  RETURN
.------------------------------------------------------------
. Reservations Row
.------------------------------------------------------------
RESROW00  MOVE      SP70,MRLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC                            *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,HOMELOCD
. 
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRRSRHOS,MRRSDEPT                            *C-240724
          CALL      RDMRLOC1
.
          MOVE      SP70,KEY25
          MOVE      MRRSREQS,KEY6
          CALL      RDMRSTF1
          PACK      KEY25,MRSTTITL,SP1,MRSTSNAM,SP1,MRSTGNAM 
.
          MOVE      SP70,MRMODESC
          MOVE      MRRSREAS,KEY4
          CALL      RDMRMOV1
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ReservationLink('",HTMLLINK
          APPEND    MRRSKEY,HTMLLINK
          APPEND    MRRSDATE,HTMLLINK
          APPEND    MRRSTIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PSNAME,COMMA,PGNAME,COMMA,PTITL:
                             ",",PURNO,",",PSAGEYRS,",",DISPSEX,"#",":
                             "#"",MRRSDATE,MRRSTIME,"#",":
                             "#"",MRRSRESV,"#",":
                             "#"",HOMELOCD,"#",":
                             "#"",MRLODESC,"#",":
                             "#"",KEY25,"#",":
                             "#"",MRMODESC,"#");"
          RETURN
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      ALLREFA1,"allrefaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTVISA2,"mrtvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTLOCA3,"mrtlocaf"    
          OPEN      MRTLOCA4,"mrtlocaf"    
          OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTSTFA1,"mrtstfaf"
          OPEN      PATBAYS1,"patbaysf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTMASA3,"mrtmasaf"
          OPEN      MRTMASA4,"mrtmasaf"
          OPEN      MRTRESA1,"mrtresaf"
          OPEN      MRTRESA2,"mrtresaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTHISA2,"mrthisaf"
          OPEN      MRTHISA3,"mrthisaf"
          OPEN      MRTTDTR1,"mrttdtaf"
          OPEN      MRTTHDR1,"mrtthdaf"
          OPEN      MRTPDSA1,"mrtpdsaf"
          OPEN      MRTPSHA1,"mrtpshaf"
          OPEN      MRTRQHR1,"mrtrqhaf"
          OPEN      MRTRQDR1,"mrtrqdaf"
          OPEN      MRTRQDR2,"mrtrqdaf"
          OPEN      OUTCANA1,"outcanaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      IBATMHA1,"ibatmhaf"
.
          OPEN      IBAPRTA1,"ibaprtaf"
          OPEN      IBACODE1,"ibacodef"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      CONTROLF,"controlf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      PATECOA3,"patecoaf"
          OPEN      PATCANA1,"patcanaf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
          CALL      OPICO1
          CALL      OPICO2
          CALL      OPICD1
          CALL      OPICD2
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     PTCNI10D,KEY8
          IF        !@LESS
            MOVE       "101",CODTYP         * Using ICD10 v1 codes
          ELSE
            MOVE       "9",CODTYP           * Using ICD9 codes
          ENDIF
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*36,CMDISD,CMOPRT:
                                 *235,CMDISP,CMDISS,CMDISC,CMDISA
          READ      CONTROLF,HUND05;*147,CMDISM
          READ      CONTROLF,TWENTY1;*138,PTCNNHII,*217,CMDISL
          READ      CONTROLF,FIFTY9;*193,PTCNRQCF
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
.------ Read controlf to get Label Layout and Hospital Code ------
.
          READ      CONTROLF,SIXTY;*79,MRCNLAYT,*84,MRCNHLOC,*88,MRCNRCTY:
                                   *105,MRCNHMTY,*108,MRCNSTAT,*114,MRCNFUTD:
                                   HTNUMDAY,*127,MRCNAUTO,*131,MRCNCHGL:
                                   *148,MRCNWNHL,*149,MRCNBCHI
          READ      CONTROLF,NINTY7;*163,MRCNLINK,*164,MRCNUREQ,*165,MRCNIBAP:
                                    *167,MRCNCROS,*170,MRCNTDAY,*176,MRCNTREC
          READ      CONTROLF,TEN3;*213,CHCSCOD
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG
          READ      CONTROLF,SIXTY;*111,HTLNUM
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS                      *I-51373
          READ      CONTROLF,HUND31;*1,MRCNDCID
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
INIT9999  RETURN
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
OPNOUT99 RETURN
.
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,URNUMBER 
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,MEDRECKY
          MOVE      SP70,MEDRCKY1
          MOVE      SP70,MEDRCKY2
          MOVE      SP70,MEDRCKY3
          MOVE      SP70,MEDRCKY4
          MOVE      SP70,MEDRCKY5
          MOVE      SP70,MRHISKEY
          MOVE      SP70,FILTURNO
          MOVE      SP70,FILTUSID
          MOVE      SP70,FILTDEST
          MOVE      ZERO,FILTTYPE
          MOVE      SP70,HOLOCODE
          MOVE      SP70,DOCUTYPE
          MOVE      SP70,MRTSECID
          MOVE      SP70,MRTSECNO
          MOVE      SP70,DESTHOSP
          MOVE      SP70,SUPERLEV
          MOVE      ZERO,REGIFLAG
          MOVE      SP70,PRINTLAB
          MOVE      SP70,EPSCD001                                     *I-241939
          MOVE      ZERO,DOSELHOS
.
          MOVE      SP70,MRTLC001 
          MOVE      SP70,MRTLC002 
          MOVE      SP70,MRTLC003 
          MOVE      SP70,MRTLC004 
          MOVE      ZERO,MRTLC005 
          MOVE      ZERO,MRTLC006 
          MOVE      SP70,MRTLC007 
          MOVE      SP70,MRTLC008 
          MOVE      SP70,MRTLC009 
          MOVE      SP70,MRTLC010 
          MOVE      SP70,MRTLC011 
          MOVE      SP70,MRTLC012 
          MOVE      SP70,REQUESTN
          MOVE      ZERO,TRANSFLG
          MOVE      ZERO,DISCHFLG
.
          MOVE      SP70,MRTMV001
          MOVE      SP70,MRTMV002
          MOVE      ZERO,MRTMV003
          MOVE      SP70,MRTMV004
          MOVE      SP70,MRTMV005
          MOVE      ZERO,MRTMV006
          MOVE      ZERO,MRTMV007
.
          MOVE      SP70,MRTST001 
          MOVE      SP70,MRTST002 
          MOVE      SP70,MRTST003
          MOVE      SP70,MRTST004 
          MOVE      SP70,MRTST005 
          MOVE      SP70,MRTST006 
          MOVE      SP70,MRTST007  
          MOVE      SP70,MRTST008
          MOVE      SP70,MRTST009 
          MOVE      SP70,MRTST010 
          MOVE      SP70,MRTST011 
          MOVE      ZERO,MRTST012
          MOVE      ZERO,MRTST013
.
          MOVE      SP70,BAYCD001
          MOVE      SP70,BAYCD002
          MOVE      SP70,BAYCD003
.
          MOVE      SP70,MRTMS001
          MOVE      SP70,MRTMS002
          MOVE      ZERO,MRTMS003
          MOVE      SP70,MRTMS004
          MOVE      SP70,MRTMS005
          MOVE      SP70,MRTMS006
          MOVE      SP70,MRTMS007
          MOVE      SP70,MRTMS008
          MOVE      SP70,MRTMS009
.
          MOVE      SP70,MRTRS001
          MOVE      SP70,MRTRS002
          MOVE      SP70,MRTRS003
          MOVE      SP70,MRTRS004
          MOVE      SP70,MRTRS005
          MOVE      SP70,MRTRS006
          MOVE      SP70,MRTRS007
.
          MOVE      SP70,MRTME001
          MOVE      SP70,MRTME002
          MOVE      SP70,MRTME003
          MOVE      SP70,MRTME004
          MOVE      SP70,MRTME005
          MOVE      SP70,MRTME006
          MOVE      SP70,MRTME007
          MOVE      SP70,MRTME008
          MOVE      SP70,MRTME009
          MOVE      SP70,MRTME010
          MOVE      SP70,MRTME011
          MOVE      SP70,MRTME012
          MOVE      SP70,MRTME013
          MOVE      SP70,MRTME014
          MOVE      SP70,MRTME015
          MOVE      SP70,MRTME016
          MOVE      SP70,MRTME017
          MOVE      SP70,MRTME018
          MOVE      SP70,MRTME019
          MOVE      SP70,MRTME020
.
          MOVE      SP70,HOMEHOSP
          MOVE      SP70,HOMELOCN
          MOVE      SP70,DOCMTYPE                                      
          MOVE      SP70,VOLUMENO  
.
          MOVE      SP70,MRTTH001
          MOVE      SP70,MRTTH002
          MOVE      SP70,MRTTH003
.
          MOVE      SP70,MRTTD001
          MOVE      SP70,MRTTD002
          MOVE      SP70,MRTTD003
          MOVE      SP70,MRTTD004
          MOVE      SP70,MRTTD005
          PACK      MRTTD006,SP70,SP70
          MOVE      SP70,MRTTD007
.
          MOVE      ZERO,MRKEYCNT
          MOVE      ZERO,LINKACNT
          MOVE      ZERO,FORM3
          MOVE      ZERO,FORM3A
          MOVE      SP70,SAVKEY
          MOVE      SP70,TRNTOWRD                 * I CAR 38495
          MOVE      SP70,NEWSEQNC
          MOVE      SP70,MOVESWAP
.
          MOVE      SP70,SAVEDKEY
          MOVE      SP70,LOCATION
          MOVE      ZERO,TEST
.
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDDOTY
          MOVE      SP70,VALDHMLC
          MOVE      SP70,VALDHMHO                                     *I-240724
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 98
            MOVE      ZERO,VOLUMENU[COUNT]
            MOVE      SP70,MRKEYARR[COUNT]                             *I-57503
            MOVE      SP70,LNKADMIS[COUNT]                             *I-57503
            ADD       ONE,COUNT
          DO
.
          MOVE      ZERO,COUNT
          MOVE      ZERO,NOLABEL
          MOVE      SP70,SELPRINT
          MOVE      SP70,SELECTKY
          MOVE      ZERO,MRKEYEND
          MOVE      ZERO,SUPRFLAG
          MOVE      SP70,FILTACTV
          MOVE      SP70,FILTHOSP
          MOVE      SP70,INACTVDS
          MOVE      SP70,INACTVOP
          MOVE      ZERO,FILTFLAG
.
          MOVE      Z70,MICRFILM  * Microfilm
          MOVE      Z70,VOLMCOMM  * Volume Comments
          MOVE      Z70,CLEARCOM  * Clear Comments
          MOVE      SP70,DISAMREC
          MOVE      SP70,VISITNUM
.
          MOVE      SP70,RECSTATC  
          MOVE      SP70,CLUSTERV
.
CLRPAR99  RETURN
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrkeyarr=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",MRKEYCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,MRKEYCNT
            PACK      MRKEYARR[MRKEYCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lnkadmis=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",LINKACNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,LINKACNT
            PACK      LNKADMIS[LINKACNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "volumenu",QRYNAME
          IF        @EQUAL
            COMPARE   "99",COUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,COUNT
            MOVE      QRYDATA,VOLUMENU[COUNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epscd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrecky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRECKY
            PACK      MEDRECKY,MEDRECKY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrcky1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRCKY1
            PACK      MEDRCKY1,MEDRCKY1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrcky2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRCKY2
            PACK      MEDRCKY2,MEDRCKY2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrcky3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRCKY3
            PACK      MEDRCKY3,MEDRCKY3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrcky4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRCKY4
            PACK      MEDRCKY4,MEDRCKY4,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrcky5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRCKY5
            PACK      MEDRCKY5,MEDRCKY5,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrhiskey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRHISKEY
            PACK      MRHISKEY,MRHISKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "location=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LOCATION
            PACK      LOCATION,LOCATION,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homehosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOMEHOSP
            PACK      HOMEHOSP,HOMEHOSP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homelocn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOMELOCN
            PACK      HOMELOCN,HOMELOCN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtlc",QRYNAME
          IF        @EQUAL
            CALL      STLOC000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtmv",QRYNAME
          IF        @EQUAL
             CALL      STMOV000
             GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtme",QRYNAME
          IF        @EQUAL
             CALL      STMOE000
             GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtst",QRYNAME
          IF        @EQUAL
            CALL      STSTF000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "baycd",QRYNAME
          IF        @EQUAL
            CALL      STBAY000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtms",QRYNAME
          IF        @EQUAL
            CALL      STMAS000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtrs",QRYNAME
          IF        @EQUAL
            CALL      STRES000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrtth",QRYNAME
          IF        @EQUAL
            CALL      STTHD000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "mrttd",QRYNAME
          IF        @EQUAL
            CALL      STTDT000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "newseqnc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWSEQNC
            PACK      NEWSEQNC,NEWSEQNC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPERLEV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "moveswap=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVESWAP
            PACK      MOVESWAP,MOVESWAP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docmtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "volumeno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VOLUMENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savedkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVEDKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regiflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REGIFLAG
            DISPLAY   "here",REGIFLAG,"here"
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdest=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTDEST
            PACK      FILTDEST,FILTDEST,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "holocode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOLOCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docutype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCUTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtusid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTUSID
            PACK      FILTUSID,FILTUSID,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filturno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTURNO
            PACK      FILTURNO,FILTURNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDURNO
            PACK      VALDURNO,VALDURNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhmho=",QRYNAME                               *I-240724
          IF        @EQUAL
            MOVE      QRYDATA,VALDHMHO
            PACK      VALDHMHO,VALDHMHO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddoty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDOTY
            PACK      VALDDOTY,VALDDOTY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhmlc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDHMLC
            PACK      VALDHMLC,VALDHMLC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nolabels=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOLABEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selectky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELECTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntowrd=",QRYNAME                 * I CAR 38495
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOWRD
            PACK      TRNTOWRD,TRNTOWRD,SP70
            GOTO      SETPAR99                          * end I CAR 38495
          ENDIF
.
          MATCH     "mrtsecid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtsecno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrreckey=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",MRKEYEND
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,MRKEYEND
            PACK      MRRECKEY[MRKEYEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQUESTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "desthosp=",QRYNAME
          IF        @EQUAL
            PACK      DESTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printlab=",QRYNAME
          IF        @EQUAL
            PACK      PRINTLAB,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtactv=",QRYNAME
          IF        @EQUAL
            PACK      FILTACTV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dischflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCHFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inactvds=",QRYNAME
          IF        @EQUAL
            PACK      INACTVDS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inactvop=",QRYNAME
          IF        @EQUAL
            PACK      INACTVOP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "micrfilm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MICRFILM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "volmcomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VOLMCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clearcom=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLEARCOM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disamrec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISAMREC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visitnum=",QRYNAME
          IF        @EQUAL
            PACK      VISITNUM,QRYDATA,SP70
            RJUSTIFY  VISITNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clusterv=",QRYNAME
          IF        @EQUAL
            PACK      CLUSTERV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 1 - MRT Locations 
.-------------------------------------------------------------------------------
STLOC000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STLOC001,STLOC002,STLOC003,STLOC004,STLOC005,STLOC006:
                       STLOC007,STLOC008,STLOC009,STLOC010,STLOC011,STLOC012
.
          GOTO      STLOC999
.
STLOC001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTLC001
          PACK      MRTLC001,MRTLC001,SP70
          GOTO      STLOC999
.
STLOC002  MOVE      QRYDATA,MRTLC002
          GOTO      STLOC999
STLOC003  MOVE      QRYDATA,MRTLC003
          GOTO      STLOC999
STLOC004  MOVE      QRYDATA,MRTLC004
          GOTO      STLOC999
STLOC005  MOVE      QRYDATA,MRTLC005
          GOTO      STLOC999
STLOC006  MOVE      QRYDATA,MRTLC006
          GOTO      STLOC999
STLOC007  MOVE      QRYDATA,MRTLC007
          GOTO      STLOC999
STLOC008  MOVE      QRYDATA,MRTLC008
          GOTO      STLOC999
STLOC009  PACK      MRTLC009,QRYDATA,SP10
          GOTO      STLOC999
STLOC010  MOVE      QRYDATA,MRTLC010
          GOTO      STLOC999
STLOC011  MOVE      QRYDATA,MRTLC011
          GOTO      STLOC999
STLOC012  MOVE      QRYDATA,MRTLC012
          GOTO      STLOC999
.
STLOC999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 2 - MRT Movement Reasons Maintenance
.-------------------------------------------------------------------------------
STMOV000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMOV001,STMOV002,STMOV003,STMOV004,STMOV005,STMOV006:
                    STMOV007
.
          GOTO      STMOV999
.
STMOV001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTMV001
          PACK      MRTMV001,MRTMV001,SP70
          GOTO      STMOV999
.
STMOV002  MOVE      QRYDATA,MRTMV002
          GOTO      STMOV999
STMOV003  MOVE      QRYDATA,MRTMV003
          GOTO      STMOV999
STMOV004  MOVE      QRYDATA,MRTMV004
          GOTO      STMOV999
STMOV005  MOVE      QRYDATA,MRTMV005
          GOTO      STMOV999
STMOV006  MOVE      QRYDATA,MRTMV006
          GOTO      STMOV999
STMOV007  MOVE      QRYDATA,MRTMV007
          GOTO      STMOV999
.
STMOV999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 3 - MRT Staff Register Maintenance
.-------------------------------------------------------------------------------
STSTF000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STSTF001,STSTF002,STSTF003,STSTF004,STSTF005,STSTF006:
                    STSTF007,STSTF008,STSTF009,STSTF010,STSTF011,STSTF012:
                    STSTF013
.
          GOTO      STSTF999
.
STSTF001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTST001
          PACK      MRTST001,MRTST001,SP70
          GOTO      STSTF999
.
STSTF002  MOVE      QRYDATA,MRTST002
          GOTO      STSTF999
STSTF003  MOVE      QRYDATA,MRTST003
          GOTO      STSTF999
STSTF004  MOVE      QRYDATA,MRTST004
          GOTO      STSTF999
STSTF005  MOVE      QRYDATA,MRTST005
          GOTO      STSTF999
STSTF006  MOVE      QRYDATA,MRTST006
          GOTO      STSTF999
STSTF007  MOVE      QRYDATA,MRTST007
          GOTO      STSTF999
STSTF008  MOVE      QRYDATA,MRTST008
          GOTO      STSTF999
STSTF009  MOVE      QRYDATA,MRTST009
          GOTO      STSTF999
STSTF010  MOVE      QRYDATA,MRTST010
          GOTO      STSTF999
STSTF011  MOVE      QRYDATA,MRTST011
          GOTO      STSTF999
STSTF012  MOVE      QRYDATA,MRTST012
          GOTO      STSTF999
STSTF013  MOVE      QRYDATA,MRTST013
          GOTO      STSTF999
.
STSTF999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 4 - Bay Codes  
.-------------------------------------------------------------------------------
STBAY000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STBAY001,STBAY002,STBAY003
.
          GOTO      STBAY999
.
STBAY001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,BAYCD001
          PACK      BAYCD001,BAYCD001,SP70
          GOTO      STBAY999
.
STBAY002  MOVE      QRYDATA,BAYCD002
          GOTO      STBAY999
.
STBAY003  MOVE      QRYDATA,BAYCD003
          GOTO      STBAY999
.
STBAY999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 5 - Medical Record Master Maintenance
.-------------------------------------------------------------------------------
STMAS000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMAS001,STMAS002,STMAS003,STMAS004,STMAS005,STMAS006:
                       STMAS007,STMAS008,STMAS009
.
          GOTO      STMAS999
.
STMAS001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTMS001
          PACK      MRTMS001,MRTMS001,SP70
          GOTO      STMAS999
.
STMAS002  UNPACK    QRYDATA,MRTMS002        * get 3 digit code         *C-45993
          MOVE      QRYDATA,MRTMS002
          PACK      MRTMS002,MRTMS002,SP70
          GOTO      STMAS999
.
STMAS003  MOVE      QRYDATA,MRTMS003
          GOTO      STMAS999
.
STMAS004  UNPACK    QRYDATA,MRTMS004
          PACK      MRTMS004,MRTMS004,SP70
          GOTO      STMAS999
.
STMAS005  MOVE      QRYDATA,MRTMS005
          GOTO      STMAS999
.
STMAS006  MOVE      QRYDATA,MRTMS006
          GOTO      STMAS999
.
STMAS007  MOVE      QRYDATA,MRTMS007
          GOTO      STMAS999
.
STMAS008  MOVE      QRYDATA,MRTMS008
          GOTO      STMAS999
.
STMAS009  MOVE      QRYDATA,MRTMS009
          GOTO      STMAS999
.
STMAS999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 6 - Medical Record Reservation Maintenance
.-------------------------------------------------------------------------------
STRES000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STRES001,STRES002,STRES003,STRES004,STRES005,STRES006:
                       STRES007
.
          GOTO      STRES999
.
STRES001  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTRS001 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTRS001,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTRS001
            ENDIF
          ENDIF
          GOTO      STRES999
.
STRES002  MOVE      QRYDATA,MRTRS002
          GOTO      STRES999
.
STRES003  MOVE      QRYDATA,MRTRS003
          GOTO      STRES999
.
STRES004  MOVE      QRYDATA,MRTRS004
          GOTO      STRES999
.
STRES005  MOVE      QRYDATA,MRTRS005
          GOTO      STRES999
.
STRES006  MOVE      QRYDATA,MRTRS006
          GOTO      STRES999
.
STRES007  MOVE      QRYDATA,MRTRS007
          GOTO      STRES999
.
STRES999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 10 - Medical Record Movement Maintenance
.-------------------------------------------------------------------------------
STMOE000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMOE001,STMOE002,STMOE003,STMOE004,STMOE005,STMOE006:
                       STMOE007,STMOE008,STMOE009,STMOE010,STMOE011,STMOE012:
                       STMOE013,STMOE014,STMOE015,STMOE016,STMOE017,STMOE018:
                       STMOE019,STMOE020
.
          GOTO      STMOE999
.
STMOE001  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME001 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME001,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME001
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE002  MOVE      QRYDATA,MRTME002
          GOTO      STMOE999
.
STMOE003  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTME003
          PACK      MRTME003,MRTME003,SP70
          GOTO      STMOE999
.
STMOE004  MOVE      QRYDATA,MRTME004
          GOTO      STMOE999
.
STMOE005  MOVE      QRYDATA,MRTME005
          GOTO      STMOE999
.
STMOE006  MOVE      QRYDATA,MRTME006
          GOTO      STMOE999
.
STMOE007  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME007 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME007,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME007
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE008  MOVE      QRYDATA,MRTME008
          GOTO      STMOE999
.
STMOE009  MOVE      QRYDATA,MRTME009
          GOTO      STMOE999
.
STMOE010  MOVE      QRYDATA,MRTME010
          PACK      MRTME010,MRTME010,SP70
          GOTO      STMOE999
.
STMOE011  MOVE      QRYDATA,MRTME011
          GOTO      STMOE999
.
STMOE012  MOVE      QRYDATA,MRTME012
          GOTO      STMOE999
.
STMOE013  MOVE      QRYDATA,MRTME013
          GOTO      STMOE999
.
STMOE014  MOVE      QRYDATA,MRTME014
          GOTO      STMOE999
.
STMOE015  MOVE      QRYDATA,MRTME015
          GOTO      STMOE999
.
STMOE016  PACK      QRYDATA,QRYDATA,SP70 
          MOVE      QRYDATA,MRTME016
          GOTO      STMOE999
.
STMOE017  MOVE      QRYDATA,MRTME017        * new Home Location
          PACK      MRTME017,MRTME017,SP70
          GOTO      STMOE999
.
STMOE018  MOVE      QRYDATA,MRTME018
          GOTO      STMOE999
.
STMOE019  MOVE      QRYDATA,MRTME019        * Destination Hospital
          GOTO      STMOE999
.
STMOE020  MOVE      QRYDATA,MRTME020        * Home Hospital
          GOTO      STMOE999
.
STMOE999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 11 - Medical Record Template Header Maintenance
.-------------------------------------------------------------------------------
STTHD000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STTHD001,STTHD002,STTHD003
.
          GOTO      STTHD999
.
STTHD001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTTH001
          PACK      MRTTH001,MRTTH001,SP70
          GOTO      STTHD999
.
STTHD002  MOVE      QRYDATA,MRTTH002
          GOTO      STTHD999
.
STTHD003  MOVE      QRYDATA,MRTTH003
          GOTO      STTHD999
.
STTHD999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 11 - Medical Record Template Details Maintenance
.-------------------------------------------------------------------------------
STTDT000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STTDT001,STTDT002,STTDT003,STTDT004,STTDT005:
                       STTDT006,STTDT007
.
          GOTO      STTDT999
.
STTDT001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTTD001
          PACK      MRTTD001,MRTTD001,SP70
          GOTO      STTDT999
.
STTDT002  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTTD002
          PACK      MRTTD002,MRTTD002,SP70
          GOTO      STTDT999
.
STTDT003  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MRTTD003
          PACK      MRTTD003,MRTTD003,SP70
          GOTO      STTDT999
.
STTDT004  MOVE      QRYDATA,MRTTD004
          GOTO      STTDT999
.
STTDT005  MOVE      QRYDATA,MRTTD005
          UNPACK    MRTTD005,DIM1      * Checks to see if Disease or Operation 
          TYPE      DIM1
          IF        @EQUAL                                                     
            MOVE      "O",MRTTD002
          ELSE
            MOVE      "D",MRTTD002
          ENDIF
          GOTO      STTDT999
.
STTDT006  MOVE      QRYDATA,MRTTD006
          GOTO      STTDT999
.
STTDT007  MOVE      QRYDATA,MRTTD007
          GOTO      STTDT999
.
STTDT999  RETURN
.-------------------------------------------------------------------------------
. Location Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTLOC00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTLOC40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTLOC10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTLOC20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTLOC30 IF EQUAL
.
          GOTO      MRTLOC93
.
.         ************ ADD FORMACTION ***********
.
MRTLOC10  CALL      CHKLOC00      * Checks mandatory fields
          BRANCH    EXIT,MRTLOC99
          PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      RDMRLOC1
          COMPARE   ZERO,OVRCD
          GOTO      MRTLOC92 IF EQUAL
.
          CALL      LOCSAV00      * Moves input variables to file variables
          PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      WRMRLOC1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTLOC99
.
.         ************ UPDATE FORMACTION **********
.
MRTLOC20  PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTLOC91
          CALL      CHKLOC00      * Checks mandatory fields
          BRANCH    EXIT,MRTLOC99
.
          CALL      RLMRLOC1      * Locks Record
          CALL      LOCSAV00      * Moves input variables to file variables
          PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      UPMRLOC1      * Writes away the data
          CALL      ULTLOC1       * Unlocks Record
.
          MOVE      ZERO,EXIT
          GOTO      MRTLOC99
.
.         ************ DELETE FORMACTION **********
.
MRTLOC30  PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTLOC91
          CALL      DEMRLOC1
.
          MOVE      ZERO,EXIT
          GOTO      MRTLOC99
.
.         ************ DISPLAY FORMACTION **********
.
MRTLOC40  CALL      ELOC0000                * Edit button hospital default
          BRANCH    EXIT,MRTLOC94
.
          MOVE      SP4,MRLOHOSP                                      *C-240724
          PACK      KEY7,MRTLC009,MRTLC001,SP70                       *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=1
            CALL      CLRMRT00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Locations Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTLOC99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTLOC99
.
MRTLOC91  MOVE      "Location Code record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLOC99
.
MRTLOC92  MOVE      "Location Code record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLOC99
.
MRTLOC93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLOC99
.
MRTLOC94  CLEAR     WEBTITLE
          APPEND    "Location Code exists for multiple hospitals.\n",WEBTITLE
          APPEND    "Please select a hospital.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLOC99
.
MRTLOC99  RETURN
.
.-----------------------------------------------------------
. Default the MR location hospital ID for the edit button
. if the location code only exists in one hospital. This
. is only used when the multi hospital filter is set to all
.-----------------------------------------------------------
ELOC0000  COMPARE   ONE,IBCNMHOS            * Exit if not multi hospital
          GOTO      ELOC8000 IF NOT EQUAL
.
          MATCH     "003",TEMPLATE          * Call to update screen only
          IF        !@EQUAL
            MATCH     "3",TEMPLATE
            GOTO      ELOC8000 IF NOT EQUAL
          ENDIF

          MATCH     SP70,MRTLC009           * Exit hospital populated
          GOTO      ELOC8000 IF NOT EQUAL
.
          MATCH     SP70,STARTKEY           * Exit if startkey is blank
          GOTO      ELOC8000 IF EQUAL
.
          PACK      KEY7,STARTKEY,SP70
          CALL      RDMRLOC4
ELOC1000  CALL      RKMRLOC4
          BRANCH    EXIT,ELOC8000           * End of file
.
          MATCH     STARTKEY,MRLOCODE       * Exit if location not matching
          GOTO      ELOC8000 IF NOT EQUAL
.
          MATCH     SP70,MRTLC009           * hospital populated so location
          GOTO      ELOC9000 IF NOT EQUAL   * code is in multiple hospitals
.
          MOVE      MRLOHOSP,MRTLC009       * Set hospital ID
          GOTO      ELOC1000
.
ELOC8000  MOVE      ZERO,EXIT
          GOTO      ELOC9999
.
ELOC9000  MOVE      SP70,MRTLC009           * Clear location hospital
          MOVE      ONE,EXIT
          GOTO      ELOC9999
.
ELOC9999  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRMRT00  MOVE      SP70,MRLODESC
          MOVE      SP70,MRLOCODE 
          MOVE      SP70,MRLOTYPE  
          MOVE      SP70,MRLOINDC  
          MOVE      ZERO,MRLOSTAT  
          MOVE      ZERO,MRLOUSAG 
          MOVE      SP70,MRLOPRNT  
          MOVE      SP70,MRLOSTCD  
          MOVE      SP70,MRLOHOSP  
          MOVE      SP70,MRLOPRLC  
          MOVE      SP70,MRLOBPRN
          MOVE      SP70,MRLOTREC
          MOVE      SP70,MRLOSPAR
.
CLRMRT99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
LOCSAV00  MOVE      MRTLC001,MRLOCODE   * Location Code 
          MOVE      MRTLC002,MRLODESC   * Description
          MOVE      MRTLC003,MRLOTYPE   * Type     
          MOVE      MRTLC004,MRLOINDC   * 1=Internal 2=External 
          MOVE      MRLOINDC,F1         * Added as radio index starts at 0 
          ADD       ONE,F1
          MOVE      F1,MRLOINDC
.
          COMPARE   TWO,MRTLC005     * Status 0 = Active 1 = Non-Active
          IF        @EQUAL
            MOVE      ZERO,MRLOSTAT   
          ELSE 
            MOVE      ONE,MRLOSTAT
          ENDIF
.
          COMPARE   TWO,MRTLC006     * Status 0 = Active 1 = Non-Active
          IF        @EQUAL
            MOVE      ZERO,MRLOUSAG   
          ELSE 
            MOVE      ONE,MRLOUSAG
          ENDIF
.
          MOVE      MRTLC007,MRLOPRNT   * Type     
          MOVE      MRTLC008,MRLOSTCD   * Stationery code
.
          IF        IBCNMHOS=1
            MOVE      MRTLC009,MRLOHOSP * Multi Hospital ID
          ENDIF
          MOVE      MRTLC010,MRLOPRLC   * Priority Location
.
          MOVE      MRTLC011,MRLOBPRN   * Bulk Record Request Printer
          MOVE      MRTLC012,MRLOTREC   * Using Tracking Receipt For This Loc
.
LOCSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields                      
.------------------------------------------------------------
CHKLOC00  RESET     MRTLC001
          MATCH     SP70,MRTLC001
          GOTO      CHKLOC90 IF EQUAL
.
          RESET     MRTLC002
          MATCH     SP70,MRTLC002
          GOTO      CHKLOC91 IF EQUAL
.
          COMPARE   ONE,IBCNMHOS                                      *I-240724
          GOTO      CHKLOC98 IF NOT EQUAL
          RESET     MRTLC009
          MATCH     SP70,MRTLC009
          GOTO      CHKLOC92 IF EQUAL                          * end  *I-240724
.
          GOTO      CHKLOC98
.
CHKLOC90  MOVE      "Location Code cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLOC99
.
CHKLOC91  MOVE      "Description is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLOC99
.
CHKLOC92  MOVE      "Hospital is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLOC99
.
CHKLOC98  MOVE      ZERO,EXIT
CHKLOC99  RETURN
.-------------------------------------------------------------------------------
. Movement Reason Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTMOV00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTMOV40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTMOV10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTMOV20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTMOV30 IF EQUAL
.
          GOTO      MRTMOV93
.
.         ************ ADD FORMACTION ***********
.
MRTMOV10  CALL      CHKMOV00      * Checks mandatory fields
          BRANCH    EXIT,MRTMOV99
          PACK      KEY4,MRTMV001,SP70
          CALL      RDMRMOV1
          COMPARE   ZERO,OVRCD
          GOTO      MRTMOV92 IF EQUAL
.
          CALL      MOVSAV00      * Moves input variables to file variables
          PACK      KEY4,MRTMV001,SP70
          CALL      WRTMOV1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTMOV99
.
.         ************ UPDATE FORMACTION **********
.
MRTMOV20  PACK      KEY4,MRTMV001,SP70   
          CALL      RDMRMOV1
          BRANCH    OVRCD,MRTMOV91
          CALL      CHKMOV00      * Checks mandatory fields
          BRANCH    EXIT,MRTMOV99
.
          CALL      RLMRMOV1      * Locks Record
          CALL      MOVSAV00      * Moves input variables to file variables
          PACK      KEY4,MRTMV001,SP70  
          CALL      UPMRMOV1      * Writes away the data
          CALL      ULTMOV1       * Unlocks Record
.
          MOVE      ZERO,EXIT
          GOTO      MRTMOV99
.
.         ************ DELETE FORMACTION **********
.
MRTMOV30  PACK      KEY4,MRTMV001,SP70   
          CALL      RDMRMOV1
          BRANCH    OVRCD,MRTMOV91
          CALL      DETMOV1 
.
          MOVE      ZERO,EXIT
          GOTO      MRTMOV99
.
.         ************ DISPLAY FORMACTION **********
.
MRTMOV40  PACK      KEY4,MRTMV001,SP70
          CALL      RDMRMOV1
          IF        OVRCD=1
            CALL      CLRMOV00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Movement Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTMOV99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTMOV99
.
MRTMOV91  MOVE      "Movement Code record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOV99
.
MRTMOV92  MOVE      "Movement Code record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOV99
.
MRTMOV93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOV99
.
MRTMOV99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRMOV00  MOVE      SP70,MRMODESC
          MOVE      SP70,MRMOREAS 
          MOVE      SP70,MRMOPERD
          MOVE      SP70,MRMOTYPE  
          MOVE      SP70,MRMOINDC  
          MOVE      ZERO,MRMOSTAT  
          MOVE      ZERO,MRMOUSAG 
.
CLRMOV99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
MOVSAV00  MOVE      MRTMV001,MRMOREAS   * Reason for movement
          MOVE      MRTMV002,MRMODESC   * Description
          MOVE      MRTMV003,MRMOPERD   * Borrowing period
          MOVE      MRTMV004,MRMOTYPE   * Type               
          MOVE      MRTMV005,MRMOINDC   * Reason indicator
.
          COMPARE   TWO,MRTMV006        * Status 0 = Active 1 = Non-Active
          IF        @EQUAL
            MOVE      ZERO,MRMOSTAT   
          ELSE 
            MOVE      ONE,MRMOSTAT
          ENDIF
.
          MOVE      MRTMV007,MRMOUSAG * Usage 0=Not Used 1=Used 2= Bulk Requests
.
MOVSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKMOV00  RESET     MRTMV001
          MATCH     SP70,MRTMV001
          GOTO      CHKMOV90 IF EQUAL
.
          RESET     MRTMV002
          MATCH     SP70,MRTMV002
          GOTO      CHKMOV91 IF EQUAL
.
          GOTO      CHKMOV98
.
CHKMOV90  MOVE      "Movement Code cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKMOV99
.
CHKMOV91  MOVE      "Description is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKMOV99
.
CHKMOV98  MOVE      ZERO,EXIT
.
CHKMOV99  RETURN
.-------------------------------------------------------------------------------
. Staff Register Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTSTF00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTSTF40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTSTF10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTSTF20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTSTF30 IF EQUAL
.
          GOTO      MRTSTF93
.
.         ************ ADD FORMACTION ***********
.
MRTSTF10  CALL      CHKSTF00      * Checks mandatory fields
          BRANCH    EXIT,MRTSTF99
          PACK      KEY6,MRTST001,SP70
          CALL      RDMRSTF1
          COMPARE   ZERO,OVRCD
          GOTO      MRTSTF92 IF EQUAL
.
          CALL      STFSAV00      * Moves input variables to file variables
          PACK      KEY6,MRTST001,SP70
          CALL      WRSTAF1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTSTF99
.
.         ************ UPDATE FORMACTION **********
.
MRTSTF20  PACK      KEY6,MRTST001,SP70   
          CALL      RDMRSTF1
          BRANCH    OVRCD,MRTSTF91
          CALL      CHKSTF00      * Checks mandatory fields
          BRANCH    EXIT,MRTSTF99
.
          CALL      RLMRSTF1      * Lock Record
          CALL      STFSAV00      * Moves input variables to file variables
          PACK      KEY6,MRTST001,SP70  
          CALL      UPMRSTF1      * Writes away the data
          CALL      ULSTAF1       * Unlock Record
.
          MOVE      ZERO,EXIT
          GOTO      MRTSTF99
.
.         ************ DELETE FORMACTION **********
.
MRTSTF30  PACK      KEY6,MRTST001,SP70   
          CALL      RDMRSTF1
          BRANCH    OVRCD,MRTSTF91
          CALL      DESTAF1 
.
          MOVE      ZERO,EXIT
          GOTO      MRTSTF99
.
.         ************ DISPLAY FORMACTION **********
.
MRTSTF40  PACK      KEY6,MRTST001,SP70
          CALL      RDMRSTF1
          IF        OVRCD=1
            CALL      CLRSTF00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Staff Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTSTF99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTSTF99
.
MRTSTF91  MOVE      "Staff Code record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTSTF99
.
MRTSTF92  MOVE      "Staff Code record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTSTF99
.
MRTSTF93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTSTF99
.
MRTSTF99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRSTF00  MOVE      SP70,MRSTCODE
          MOVE      SP70,MRSTTITL 
          MOVE      SP70,MRSTSNAM
          MOVE      SP70,MRSTGNAM  
          MOVE      SP70,MRSTDEPT  
          MOVE      SP70,MRSTCONT  
          MOVE      SP70,MRSTIEPH
          MOVE      SP70,MRSTBHPH
          MOVE      SP70,MRSTAHPH
          MOVE      SP70,MRSTPAGR
          MOVE      SP70,MRSTBCOD
          MOVE      ZERO,MRSTSTAT
          MOVE      ZERO,MRSTUSAG 
.
CLRSTF99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
STFSAV00  MOVE      MRTST001,MRSTCODE   * Staff Code 
          MOVE      MRTST002,MRSTTITL   * Title      
          MOVE      MRTST003,MRSTSNAM   * Surname 
          MOVE      MRTST004,MRSTGNAM   * Given Name               
          MOVE      MRTST005,MRSTDEPT   * Position
          MOVE      MRTST006,MRSTCONT   * Contact Point
          MOVE      MRTST007,MRSTIEPH   * Phone No. (Internal Extension)
          MOVE      MRTST008,MRSTBHPH   * Phone No. (External/Other)
          MOVE      MRTST009,MRSTAHPH   * Phone No. (After hours)
          MOVE      MRTST010,MRSTPAGR   * Phone No. (Pager)
          MOVE      MRTST011,MRSTBCOD   * Bar Code Number 
.
          COMPARE   TWO,MRTST012     * Status 0 = Active 1 = Non-Active
          IF        @EQUAL
            MOVE      ZERO,MRSTSTAT   
          ELSE 
            MOVE      ONE,MRSTSTAT
          ENDIF
.
          COMPARE   ONE,MRTST013     * Status 0 = Not Used 1 = Used
          IF        @EQUAL
            MOVE      ONE,MRSTUSAG
          ELSE 
            MOVE      ZERO,MRSTUSAG  
          ENDIF
.
STFSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKSTF00  RESET     MRTST001
          MATCH     SP70,MRTST001
          GOTO      CHKSTF90 IF EQUAL
.
          RESET     MRTST002
          MATCH     SP70,MRTST002
          GOTO      CHKSTF91 IF EQUAL
.
          RESET     MRTST003
          MATCH     SP70,MRTST003
          GOTO      CHKSTF92 IF EQUAL
.
          RESET     MRTST004
          MATCH     SP70,MRTST004
          GOTO      CHKSTF93 IF EQUAL
.
          GOTO      CHKSTF98
.
CHKSTF90  MOVE      "Staff Code cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKSTF91  MOVE      "Title is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKSTF92  MOVE      "Surname cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKSTF93  MOVE      "Given Name cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKSTF98  MOVE      ZERO,EXIT
.
CHKSTF99  RETURN
.-------------------------------------------------------------------------------
. Bay Codes Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTBAY00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTBAY40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTBAY10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTBAY20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTBAY30 IF EQUAL
.
          GOTO      MRTBAY93
.
.         ************ ADD FORMACTION ***********
.
MRTBAY10  MATCH     SP70,BAYCD002
          IF        @EQUAL 
            CALL      CHKBAY00      * Checks mandatory fields
            BRANCH    EXIT,MRTBAY99
          ENDIF
          PACK      KEY5,BAYCD001,BAYCD002,SP70
          CALL      RDBAYS1
          COMPARE   ZERO,OVRCD
          GOTO      MRTBAY92 IF EQUAL
.
          CALL      BAYSAV00      * Moves input variables to file variables
          PACK      KEY5,BAYCD001,BAYCD002,SP70
          CALL      WRBAYS1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTBAY99
.
.         ************ UPDATE FORMACTION **********
.
MRTBAY20  PACK      KEY5,BAYCD001,BAYCD002,SP70   
          CALL      RDBAYS1
          BRANCH    OVRCD,MRTBAY91
          CALL      CHKBAY00      * Checks mandatory fields
          BRANCH    EXIT,MRTBAY99
.
          CALL      RLBAYS1       * Lock Record
          CALL      BAYSAV00      * Moves input variables to file variables
          PACK      KEY5,BAYCD001,BAYCD002,SP70  
          CALL      UPBAYS1       * Writes away the data
          CALL      ULBAYS1       * Unlock Record
.
          MOVE      ZERO,EXIT
          GOTO      MRTBAY99
.
.         ************ DELETE FORMACTION **********
.
MRTBAY30  MATCH     SP70,BAYCD002
          IF        @EQUAL
            PACK      KEY5,BAYCD001,SP70   
            CALL      RDSBAYS1
MRTBAY31    CALL      RDKBAYS1
            BRANCH    OVRCD,MRTBAY32
            MATCH     BAYCODE,BAYCD001
            GOTO      MRTBAY32 IF NOT EQUAL
            PACK      KEY5,BAYCODE,BAYUR,SP70
            CALL      DEBAYS1 
            GOTO      MRTBAY31
          ENDIF
.
MRTBAY32  PACK      KEY5,BAYCD001,BAYCD002,SP70   * Delete Parent   
          CALL      RDBAYS1
          BRANCH    OVRCD,MRTBAY91
          CALL      DEBAYS1 
.
          MOVE      ZERO,EXIT
          GOTO      MRTBAY99
.
.         ************ DISPLAY FORMACTION **********
.
MRTBAY40  PACK      KEY5,BAYCD001,BAYCD002,SP70
          CALL      RDBAYS1
          IF        OVRCD=1
            CALL      CLRBAY00    * Clear all the file variables
          ENDIF
          MOVE      BAYCODE,SAVBAY   * Move Baycode into sav Variable
.
          CLEAR     WEBTITLE
          MOVE      "Bay Codes Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTSTF99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTBAY99
.
MRTBAY91  MOVE      "Bay Mantenance Code record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTSTF99
.
MRTBAY92  MOVE      "Bay Mantenance Code record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTBAY99
.
MRTBAY93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTBAY99
.
MRTBAY99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRBAY00  MOVE      SP70,BAYCODE
          MOVE      SP70,BAYUR
          MOVE      SP70,BAYDESC
.
CLRBAY99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
BAYSAV00  MOVE      BAYCD001,BAYCODE   * Bay Code 
          MOVE      BAYCD002,BAYUR     * Last two digits of U/R no      
          MOVE      BAYCD003,BAYDESC   * Bay Description 
.
BAYSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKBAY00  RESET     BAYCD001
          MATCH     SP70,BAYCD001
          GOTO      CHKBAY90 IF EQUAL
.
          RESET     BAYCD003
          MATCH     SP70,BAYCD003
          GOTO      CHKBAY91 IF EQUAL
.
          GOTO      CHKSTF98
.
CHKBAY90  MOVE      "Bay Code cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKBAY91  MOVE      "Bay description cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTF99
.
CHKBAY98  MOVE      ZERO,EXIT
CHKBAY99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Master Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTMAS00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTMAS40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTMAS10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTMAS20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTMAS30 IF EQUAL
.
          GOTO      MRTMAS93
.
.         ************ ADD FORMACTION ***********
.
MRTMAS10  
.         CALL      UNQDOC00      * Checks mandatory fields       
.         BRANCH    EXIT,MRTMAS99
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RDMRMAS1
          COMPARE   ZERO,OVRCD
          GOTO      MRTMAS92 IF EQUAL
.
. Also Record cannot be saved if Document Type and Volume No are alrady found!
. Read Above Should Check This
.
.          PACK      KEY20,URNUMBER,SP70
.          CALL      RSMRMAS1
.MRTMAS11  CALL      RKMRMAS1
.          BRANCH    OVRCD,MRTMAS12
..
.          MATCH     URNUMBER,MRMAURNO 
.          GOTO      MRTMAS12 IF NOT EQUAL
..
.          MATCH     MRTMS002,MRMADOTY       * Check Document Type
.          IF        @EQUAL
.            COMPARE   MRTMS003,MRMAVOLN        * Now check volume number
.            GOTO      MRTMAS92 IF EQUAL
.          ENDIF
..
.          GOTO      MRTMAS11
.
MRTMAS12  CALL      MASSAV00      * Moves input variables to file variables
.
MRTMAS13  READ      CONTROLF,SIXTY;*95,MRCNUKEY
          ADD       ONE,MRCNUKEY
          WRITAB    CONTROLF,SIXTY;*95,MRCNUKEY
          SUB       ONE,MRCNUKEY
          MOVE      MRCNUKEY,MRMAKEY
.
          PACK      KEY10,MRMAKEY
          CALL      RAMRMAS2                * Read a master file record
          COMPARE   ONE,OVRCD
          GOTO      MRTMAS13 IF NOT EQUAL   * Record exists, get next unq key
.
          MOVE      URNUMBER,MRMAURNO
          MOVE      MRTMS001,MRMAHLOC
          MOVE      MRTMS002,MRMADOTY
          MOVE      MRTMS003,MRMAVOLN
          MOVE      MRMAHLOC,MRMACLOC
          MOVE      MRTMS008,MRMAHHOS                                 *I-240724
          MOVE      MRMAHHOS,MRMACHOS                                 *I-240724
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,MRMAOHOS     * Originating Hospital    *I-240724
          ENDIF
          CALL      IBACLOCK
          PACK      MRMADTCR,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTCR
          MOVE      CTIMEIS,MRMATMCR
          MOVE      WBSEUID,MRMACUID
          MOVE      SP70,MRMADTUP
          MOVE      SP70,MRMATMUP
          MOVE      SP70,MRMAUUID
.
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
          CALL      RAMRMAS1                                          *I-240724
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRMRMAS1              * Writes the Key & data
            TRAPCLR   IO
            BRANCH    OVRCD,MRTMAS99
          ENDIF
.
          MATCH     "1",PRINTLAB            * Print Barcode Label
          GOTO      MRTMAS19 IF NOT EQUAL
.
          MOVE      MRMAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRTMAS19
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PTCNNHII=1
            MOVE      MRMAURNO,KEY8
            CALL      RDNHMAS2
            BRANCH    OVRCD,MRTMAS19
          ENDIF
.
          MOVE      URNUMBER,CPPURNO
          CALL      OPNPRINT
          UNPACK    SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
          MATCH     "0",DIM1A
          GOTO      MRTMAS15 IF NOT EQUAL
.
          MOVE      SP1,DIM1A
.
          MATCH     "0",DIM1B
          GOTO      MRTMAS15 IF NOT EQUAL
.
          MOVE      SP1,DIM1B
.
          MATCH     "0",DIM1C
          GOTO      MRTMAS15 IF NOT EQUAL
.
          MOVE      SP1,DIM1C
.
          MATCH     "0",DIM1D
          GOTO      MRTMAS15 IF NOT EQUAL
.
          MOVE      SP1,DIM1D
.
          MATCH     "0",DIM1E
          GOTO      MRTMAS15 IF NOT EQUAL
.
          MOVE      SP1,DIM1E
.
MRTMAS15  PACK      SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
.
          PACK      KEY6,SELPRINT,SP70
          CALL      RDPRTA1
          IF        OVRCD=1
            MOVE      SP70,PRTTYPE
.                     * this bit writes Zebra Code to Spool
.           CMATCH    "S",SELPRINT
.           IF        @EQUAL
.             MOVE      "7",PRTTYPE         * Testing - Zebra code to Spool
.           ENDIF
          ENDIF
          CALL      LABL0000                * Print bar code labels
          CALL      CLSPRINT
.
MRTMAS19  MOVE      ZERO,EXIT
          GOTO      MRTMAS99
.
.         ************ UPDATE FORMACTION **********
.
MRTMAS20  PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          MATCH     SAVEDKEY,KEY20
          IF        !@EQUAL
            CALL      RAMRMAS1                                        *C-240724
            IF        OVRCD=0
              GOTO      MRTMAS95 IF EQUAL
            ENDIF
          ENDIF
.
MRTMAS22  MOVE      SAVEDKEY,KEY20                                    *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,MRTMAS91
.
          CALL      DEMRMAS1      * Delete old record
.
          CALL      MUPSAV00      * Moves input variables to file variables
.
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RAMRMAS1                                          *C-240724
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRMRMAS1              * Writes the Key & data
            TRAPCLR   IO
            BRANCH    OVRCD,MRTMAS99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MRTMAS99
.
.         ************ DELETE FORMACTION **********
.
MRTMAS30  PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RDMRMAS1                                          *C-240724
          BRANCH    OVRCD,MRTMAS91
.
          CALL      CHDVIS00  * Do not delete if visits linked
          BRANCH    EXIT,MRTMAS94
.
          CALL      DELHIS00  * Delete MR History Details record for Med key
          CALL      DELREQ00  * Delete Request Details record for Med key
...       CALL      DELVIS00  * Delete Visit Details record for Med key
          CALL      DELRES00  * Delete Reservation Details record for Med key
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      DEMRMAS1                                          *C-240724
.
          MOVE      ZERO,EXIT
          GOTO      MRTMAS99
.
.         ************ DISPLAY FORMACTION **********
.
MRTMAS40  MOVE      SP70,KEY8
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRTMAS91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      MRTMAS96 IF EQUAL
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RDMRMAS1                                          *C-240724
          IF        OVRCD=0
            MOVE      MRMAKEY,MEDRECKY
            CALL      SAVMRM00    * Save Variables
          ELSE
            CALL      CLRMRM00    * Clear all the file variables
            CALL      SAVMRM00    * Clear Save Variables
          ENDIF
.
          CLEAR     WEBTITLE
.
          MATCH     "009",TEMPLATE
          IF        @EQUAL
            MOVE      "Medical Record Master Enquiry",WEBTITLE
          ELSE
            MATCH     "9",TEMPLATE
            IF        @EQUAL
              MOVE      "Medical Record Master Enquiry",WEBTITLE
            ELSE
              MOVE      "Medical Record Master Maintenance",WEBTITLE
            ENDIF
          ENDIF
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTMAS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS91  MOVE      "Patient U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS92  MOVE      "This Medical Record Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS94  MOVE      "Unable to delete, linked visits exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS95  CLEAR     WEBTITLE
          APPEND    "This change would create a duplicate ",WEBTITLE
          APPEND    "Medical Record",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS96  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMAS99
.
MRTMAS99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRMRM00  MOVE      SP70,MRMAURNO
          MOVE      SP70,MRMAHHOS                                     *I-240724
          MOVE      SP70,MRMAHLOC 
          MOVE      SP70,MRMADOTY 
          MOVE      ZERO,MRMAVOLN
          MOVE      SP70,MRMASTAT  
          MOVE      SP70,MRMACOMM  
          MOVE      SP70,MRMAKEY  
          MOVE      SP70,MRMAFILM
          MOVE      SP70,MRMACHOS                                     *I-240724
          MOVE      SP70,MRMACLOC
          MOVE      SP70,MRMAOHOS                                     *I-240724
.
CLRMRM99  RETURN
.-----------------------------------------------------------
. Save file data
.-----------------------------------------------------------
SAVMRM00  MOVE      MRMAURNO,SMRURNO
          MOVE      MRMAHHOS,SMRHHOS                                  *I-240724
          MOVE      MRMAHLOC,SMRHLOC 
          MOVE      MRMADOTY,SMRDOTY 
          MOVE      MRMAVOLN,SMRVOLN
          MOVE      MRMASTAT,SMRSTAT  
          MOVE      MRMACOMM,SMRCOMM  
          MOVE      MRMAKEY,SMRKEY  
          MOVE      MRMAFILM,SMRFILM
          MOVE      MRMACHOS,SMRCHOS                                  *I-240724
          MOVE      MRMACLOC,SMRCLOC
          MOVE      MRMAOHOS,SMROHOS                                  *I-240724
          MOVE      MRMADTCR,SMRDTCR
          MOVE      MRMATMCR,SMRTMCR
          MOVE      MRMACUID,SMRUSCR
          MOVE      MRMADTUP,SMRDTUP
          MOVE      MRMATMUP,SMRTMUP
          MOVE      MRMAUUID,SMRUSUP
.
SAVMRM99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
MUPSAV00  MOVE      URNUMBER,MRMAURNO    
          MOVE      MRTMS001,MRMAHLOC 
          MOVE      MRTMS002,MRMADOTY 
          MOVE      MRTMS003,MRMAVOLN
          MOVE      MRTMS004,MRMASTAT  
          MOVE      MRTMS005,MRMACOMM  
          MOVE      MRTMS006,MRMAKEY  
          MOVE      MRTMS007,MRMAFILM 
          MOVE      MRTMS008,MRMAHHOS                                 *I-240724
.
MUPSAV99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
MASSAV00  MOVE      URNUMBER,MRMAURNO    
          MOVE      MRTMS001,MRMAHLOC 
          MOVE      MRTMS002,MRMADOTY 
          MOVE      MRTMS003,MRMAVOLN
          MOVE      MRTMS004,MRMASTAT  
          MOVE      MRTMS005,MRMACOMM  
          MOVE      MRTMS006,MRMAKEY  
          MOVE      MRTMS007,MRMAFILM 
          MOVE      MRMAHLOC,MRMACLOC
          MOVE      MRTMS008,MRMAHHOS                                 *I-240724
          MOVE      MRMAHHOS,MRMACHOS                                 *I-240724
.
MASSAV99  RETURN
.---------------------------------------------------------------------------
. Delete History Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELHIS00  PACK      KEY26,MRMAKEY,SP70
          CALL      RSMRHIS1 
          CALL      RKMRHIS1 
          BRANCH    OVRCD,DELHIS99
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      DELHIS99 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1 
.
          GOTO      DELHIS00          
.
DELHIS99  RETURN
.---------------------------------------------------------------------------
. Delete Request Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELREQ00  PACK      KEY20,MRMAKEY,SP70
          CALL      RSMRRQD2 
          CALL      RKMRRQD2 
          BRANCH    OVRCD,DELREQ99
.
          MATCH     MRMAKEY,MRRDRKEY
          GOTO      DELREQ99 IF NOT EQUAL
.
          PACK      KEY20,MRRDRKEY,MRRDRQNO,SP70
          CALL      DEMRRQD2 
.
          GOTO      DELREQ00          
.
DELREQ99  RETURN
.---------------------------------------------------------------------------
. Check  MR Visit Details records for deleting a Medical Record
.---------------------------------------------------------------------------
.CHDVIS00  MOVE      ZERO,EXIT
.          PACK      KEY18,MRMAKEY,SP70
.          CALL      RSMRVS2 
.          CALL      RKMRVS2 
.          BRANCH    OVRCD,CHDVIS99
.
.          MATCH     MRMAKEY,MRVSMKEY
.          GOTO      CHDVIS90 IF EQUAL
.
.          GOTO      CHDVIS99
.
.CHDVIS90  MOVE      ONE,EXIT
.CHDVIS99  RETURN
.
CHDVIS00  MOVE      ZERO,EXIT
.
          MATCH     "1",SUPRFLAG
          GOTO      CHDVIS99 IF EQUAL
.
          MATCH     "1",MRCNLINK                * Don't check for linked visits
          GOTO      CHDVIS99 IF EQUAL
.
          PACK      KEY18,MRMAKEY,SP70
          CALL      RSMRVS2
CHDVIS10  CALL      RKMRVS2
          BRANCH    OVRCD,CHDVIS99 
.
          MATCH     MRMAKEY,MRVSMKEY             * all linked visits are canc
          GOTO      CHDVIS99 IF NOT EQUAL        * allow the deletion
.
          CALL      CLPATMIS                   * Clear patmis vars
.
          PACK      KEY8,MRVSVSNO,SP70         * Read admission can't use
          CALL      RDMISS1                    * OVRCD as pmsvx1af is also read
.                                              * and might be missing
          MATCH     DAADMNO,MRVSVSNO           * Did we find an admission
          GOTO      CHDVIS20 IF NOT EQUAL
.
          COMPARE   FIVE,ASTAT                 * Cancelled pre admission
          GOTO      CHDVIS20 IF NOT EQUAL
.
          PACK      KEY8,MRVSVSNO,SP70           * Locate orphan MRT link for
          CALL      RDVISA1                      * the cancelled visit
          IF        OVRCD=1
            PACK      KEY18,MRVSMKEY,MRVSVSNO,SP70
            CALL      DEMRVS2                       * Delete the orphaned mrt
            GOTO      CHDVIS10                      * link - go to next visit
          ENDIF
.
CHDVIS20  PACK      KEY8,MRVSVSNO,SP70           * check if medical record
          CALL      RDPRAM1                      * is linked to pre adm
          IF        OVRCD=0
            COMPARE   FIVE,ASTAT
            GOTO      CHDVIS10 IF EQUAL          * if cancelled move onto 
            GOTO      CHDVIS90                   * the next visit
          ENDIF
.
          PACK      KEY8,MRVSVSNO,SP70           * check if medical record 
          CALL      RDOTCAN1                     * is linked to a cancelled out
          IF        OVRCD=0
            GOTO      CHDVIS10                   * move to next linked visit
          ENDIF
.
          PACK      KEY8,MRVSVSNO,SP70           * check if medical record
          CALL      RDALREF1                     * is linked to allied health
          IF        OVRCD=0
            MATCH     "5",ALRESTAT
            GOTO      CHDVIS10 IF EQUAL          * if cancelled move onto
            GOTO      CHDVIS90                   * the next visit
          ENDIF
.
          PACK      KEY8,MRVSVSNO,SP70           * check if medical record
          CALL      RDBKREC1                     * is linked to theatre booking
          IF        OVRCD=0
            COMPARE   TWO,BKRESTAT
            GOTO      CHDVIS10 IF EQUAL          * if cancelled move onto
            GOTO      CHDVIS90                   * the next visit
          ENDIF
.
CHDVIS90  MOVE      ONE,EXIT
CHDVIS99  RETURN
.---------------------------------------------------------------------------
. Delete MR Visit Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELRES00  PACK      KEY23,MRMAKEY,SP70
          CALL      RSMRRES1 
          CALL      RKMRRES1 
          BRANCH    OVRCD,DELRES99
.
          MATCH     MRMAKEY,MRRSKEY
          GOTO      DELRES99 IF NOT EQUAL
.
          PACK      KEY23,MRRSKEY,MRRSDATE,MRRSTIME,SP70
          CALL      DERESV1 
.
          GOTO      DELRES00          
.
DELRES99  RETURN
.---------------------------------------------------------------------------
. * Checks that record being added has unique Volume Number & Document Type
.---------------------------------------------------------------------------
UNQDOC00  PACK      KEY20,URNUMBER,MRTMS003,SP70                      *C-240724
          CALL      RSMRMAS3   
UNQDOC10  CALL      RKMRMAS3   
          BRANCH    OVRCD,UNQDOC98
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      UNQDOC98 IF NOT EQUAL
.
          COMPARE   MRTMS003,MRMAVOLN
          GOTO      UNQDOC98 IF NOT EQUAL
.
          MATCH     MRTMS002,MRMADOTY
          GOTO      UNQDOC90 IF EQUAL
.
          GOTO      UNQDOC10
.
UNQDOC90  MOVE      "This Medical Record Exists!",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNQDOC99
.
UNQDOC98  MOVE      ZERO,EXIT
UNQDOC99  RETURN
.*************************************************************************
.*                                 CHKLAB00                              *
.*                Print labels                                           *
.*************************************************************************
CHKLAB00  MATCH     SP1,UPDTTYPE
          GOTO      CHKLAB70 IF EQUAL
.
          MATCH     "B",UPDTTYPE            * Print bulk mrt labels
          GOTO      CHKLAB20 IF EQUAL
.
          CALL      MASSAV00 
          MOVE      NOLABEL,HTLNUM
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
          CALL      RDMRMAS1                                          *C-240724
          BRANCH    OVRCD,CHKLAB90
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKLAB95
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PTCNNHII=1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            BRANCH    OVRCD,CHKLAB96
          ENDIF
.
          MOVE      URNUMBER,CPPURNO
          CALL      OPNPRINT
          UNPACK    SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
          MATCH     "0",DIM1A
          GOTO      CHKLAB05 IF NOT EQUAL
.
          MOVE      SP1,DIM1A
.
          MATCH     "0",DIM1B
          GOTO      CHKLAB05 IF NOT EQUAL
.
          MOVE      SP1,DIM1B
.
          MATCH     "0",DIM1C
          GOTO      CHKLAB05 IF NOT EQUAL
.
          MOVE      SP1,DIM1C
.
          MATCH     "0",DIM1D
          GOTO      CHKLAB05 IF NOT EQUAL
.
          MOVE      SP1,DIM1D
.
          MATCH     "0",DIM1E
          GOTO      CHKLAB05 IF NOT EQUAL
.
          MOVE      SP1,DIM1E
.
CHKLAB05  PACK      SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
.
          PACK      KEY6,SELPRINT,SP70
          CALL      RDPRTA1
          IF        OVRCD=1
            MOVE      SP70,PRTTYPE
.                     * this bit writes Zebra Code to Spool
            CMATCH    "S",SELPRINT
...         IF        @EQUAL
...           MOVE      "7",PRTTYPE         * Testing - Zebra code to Spool
...         ENDIF
          ENDIF
          CALL      LABL0000                * Print bar code labels
          CALL      CLSPRINT
          MOVE      ZERO,EXIT      
          GOTO      CHKLAB99
.
CHKLAB20  MOVE      NOLABEL,HTLNUM
          CALL      OPNPRINT
          UNPACK    SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
          MATCH     "0",DIM1A
          GOTO      CHKLAB25 IF NOT EQUAL
.
          MOVE      SP1,DIM1A
.
          MATCH     "0",DIM1B
          GOTO      CHKLAB25 IF NOT EQUAL
.
          MOVE      SP1,DIM1B
.
          MATCH     "0",DIM1C
          GOTO      CHKLAB25 IF NOT EQUAL
.
          MOVE      SP1,DIM1C
.
          MATCH     "0",DIM1D
          GOTO      CHKLAB25 IF NOT EQUAL
.
          MOVE      SP1,DIM1D
.
          MATCH     "0",DIM1E
          GOTO      CHKLAB25 IF NOT EQUAL
.
          MOVE      SP1,DIM1E
.
CHKLAB25  PACK      SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
.
          PACK      KEY6,SELPRINT,SP70
          CALL      RDPRTA1
          IF        OVRCD=1
            MOVE      SP70,PRTTYPE
          ENDIF
.
          CALL      BLAB0000                * Print bulk labels
          CALL      CLSPRINT
.
          MOVE      ZERO,EXIT      
          GOTO      CHKLAB99
.
CHKLAB70  MATCH     "002",TEMPLATE          * Bulk print
          GOTO      CHKLAB80 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKLAB95
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RDMRMAS1                                          *C-240724
          BRANCH    OVRCD,CHKLAB90
          CALL      SAVMRM00    * Save Variables
.
CHKLAB80  CLEAR     WEBTITLE
          MOVE      "Print Bar Code Label",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTMAS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      CHKLAB99
.
CHKLAB90  MOVE      "Medical Record Does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAB99
.
CHKLAB95  MOVE      "Invalid UR",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAB99
.
CHKLAB96  MOVE      "Missing nhimasaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAB99
.
.
CHKLAB99  RETURN
.*************************************************************************
.*                                 LABL0000                              *
.*                Routine to print patient Bar Coded Labels              *
.*************************************************************************
LABL0000
.
.------ Read the number of labels to print ------
.
          COMPARE   ZERO,HTLNUM
          GOTO      LABL9999 IF EQUAL
.
          CALL      BARCODEF                      * format Bar code labels
          CALL      BARCODEL                      * print Bar Code Labels
.
LABL9999  RETURN
.-------------------------------------------------------------------------------
. Medical Record Linking / Inlinking : Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTVIS00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTVIS40 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTVIS20 IF EQUAL
.
          GOTO      MRTVIS99
.
.         ************ UPDATE FORMACTION **********
.
MRTVIS20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1 
          BRANCH    OVRCD,MRTVIS30
          CALL      CHKVIS00      * Checks mandatory fields
          BRANCH    EXIT,MRTVIS99
.
          CALL      VISSAV00      * Moves input variables to file variables
          PACK      KEY8,ADMISSNO,SP70
          CALL      UPMRVS1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTVIS99
.
.         ************ ADD FORMACTION **********
.
MRTVIS30  CALL      VISSAV00      * Moves input variables to file variables
          PACK      KEY8,ADMISSNO,SP70
          CALL      WRMRVS1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTVIS99
.
.         ************ DISPLAY FORMACTION **********
.
MRTVIS40  MOVE      SP70,KEY8
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRTVIS92
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,MRTMS003,SP70
          CALL      RDMRMAS1                                          *C-240724
          IF        OVRCD=0
            MOVE      MRMAKEY,MEDRECKY
            CALL      SAVMRM00    * Save Variables
          ELSE
            CALL      CLRMRM00    * Clear all the file variables
            CALL      SAVMRM00    * Clear Save Variables
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMRVS1
          BRANCH    OVRCD,MRTVIS93
          
          CLEAR     WEBTITLE
          MOVE      "Medical Record Visit Links",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTVIS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTVIS99
.
MRTVIS91  MOVE      "Admission Number does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTVIS99
.
MRTVIS92  MOVE      "U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTVIS99
.
MRTVIS93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTVIS99
.
MRTVIS99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRVIS00  MOVE      SP70,MRVSVSNO
          MOVE      SP70,MRVSMKEY 
          MOVE      SP70,MRVSXKY1 
          MOVE      SP70,MRVSXKY2 
          MOVE      SP70,MRVSXKY3 
          MOVE      SP70,MRVSXKY4 
          MOVE      SP70,MRVSXKY5 
          MOVE      SP70,MRVSSPAR 
.
CLRVIS99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
VISSAV00  MOVE      MEDRECKY,MRVSMKEY
          MOVE      MEDRCKY1,MRVSXKY1
          MOVE      MEDRCKY2,MRVSXKY2
          MOVE      MEDRCKY3,MRVSXKY3
          MOVE      MEDRCKY4,MRVSXKY4
          MOVE      MEDRCKY5,MRVSXKY5
          MOVE      ADMISSNO,MRVSVSNO 
.
VISSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKVIS00  RESET     MEDRECKY
          MATCH     SP70,MEDRECKY
          GOTO      CHKVIS90 IF EQUAL
.
          RESET     ADMISSNO
          MATCH     SP70,ADMISSNO
          GOTO      CHKVIS91 IF EQUAL
.
          GOTO      CHKVIS98
.
CHKVIS90  MOVE      "Medial Record Key is needed!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKVIS99
.
CHKVIS91  MOVE      "Admission Number is needed!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKVIS99
.
CHKVIS98  MOVE      ZERO,EXIT
CHKVIS99  RETURN
.------------------------------------------------------------
. Get Current Medical Record
.------------------------------------------------------------
GETCMR00  PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
GETCMR10  CALL      RKMRMAS1
          BRANCH    OVRCD,GETCMR95                          
.
          MATCH     URNUMBER,MRMAURNO                       
          GOTO      GETCMR95 IF NOT EQUAL                   
.
..          MATCH     MRCNSTAT,MRMASTAT                       
..          GOTO      GETCMR10 IF NOT EQUAL                   
.
          MOVE      ZERO,EXIT                               
          GOTO      GETCMR99                                
.                                                           
GETCMR95  MOVE      ONE,EXIT                                
.                                                           
GETCMR99  RETURN                                          
.-------------------------------------------------------------------------------
. Medical Record Tracking Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTTRC00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTTRC40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTTRC10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTTRC20 IF EQUAL
.
          GOTO      MRTTRC99
.
.         ************ ADD FORMACTION **********
.
MRTTRC10  CALL      SAVTRC00      * Loop through UR's and save Reservations
          MOVE      ZERO,EXIT
          COMPARE   ZERO,ERRORCNT
          GOTO      MRTTRC99 IF EQUAL
          CALL      ERRLST00
          MOVE      ONE,EXIT
          GOTO      MRTTRC99
.
.         ************ DELETE FORMACTION **********
.
MRTTRC20  PACK      KEY23,MRMAKEY,MRTRS001,MRTRS002,SP70
          CALL      RDMRRES1
          BRANCH    OVRCD,MRTTRC91
          CALL      DERESV1
.
.
          MOVE      ZERO,EXIT
          GOTO      MRTMAS99
. 
.         ************ DISPLAY FORMACTION **********
.
MRTTRC40  MOVE      SP70,KEY8
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRTTRC91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,MRTTRC91
.
          PACK      KEY23,MRMAKEY,MRTRS001,MRTRS002,SP70
          CALL      RDMRRES1
          IF        OVRCD=1
            CALL      CLRTRC00    * Clear all the file variables
          ENDIF

          CLEAR     WEBTITLE
          MOVE      "Medical Record Master Bulk Reservations",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTTRC99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTTRC99
.
MRTTRC91  MOVE      "Patient Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTRC99
.
MRTTRC92  MOVE      "Patient Record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTRC99
.
MRTTRC93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTRC99
.
MRTTRC99  RETURN
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
     "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; "
          MOVE      ZERO,F3
ERRLST10  ADD       ONE,F3
          IF        F3>ERRORCNT | F3>99
            COMPARE   TEST,ONE
            IF        !@EQUAL
              GOTO      ERRLST20
            ELSE
              WRITE     HTMLFILE;"}":
                             "</script>"
              CALL      CLOSHTML
              GOTO      ERRLST99
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"    alert(#"",ERRORLST[F3],"\n#");"
          GOTO      ERRLST10

ERRLST20  WRITE     HTMLFILE;"    alert(#"All Other Records Processed\n#");":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      ERRLST99
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST99  RETURN
.----------------------------------------------------------------------
. Output Javascript List of Warnings for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
WARLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
   "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; "
          MOVE      ZERO,F3
WARLST10  ADD       ONE,F3
          IF        F3>ERRORCNT | F3>99
            COMPARE   TEST,ONE
            IF        !@EQUAL
              GOTO      WARLST20
            ELSE
              WRITE     HTMLFILE;"}":
                             "</script>"
              CALL      CLOSHTML
              GOTO      WARLST99
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"    alert(#"",ERRORLST[F3],"\n#");"
          GOTO      WARLST10

WARLST20  WRITE     HTMLFILE;"    alert(#"All Other Records Processed\n#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WARLST99
.
WARLST95  DISPLAY   "*** Fifo Not Found ***"
.
WARLST99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRTRC00  MOVE      SP70,MRRSKEY
          MOVE      SP70,MRRSDATE 
          MOVE      SP70,MRRSTIME 
          MOVE      SP70,MRRSDEPT
          MOVE      SP70,MRRSREQS  
          MOVE      SP70,MRRSREAS  
          MOVE      SP70,MRRSRESV 
          MOVE      SP70,MRRSRHOS           * Hospital ID             *I-240724
          MOVE      SP70,MRRSSPAR 
.
CLRTRC99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
TRCSAV00  MOVE      MRMAKEY,MRRSKEY
          MOVE      MRTRS001,MRRSDATE 
          MOVE      MRTRS002,MRRSTIME 
          MOVE      MRTRS003,MRRSDEPT
          MOVE      MRTRS004,MRRSREQS  
          MOVE      MRTRS005,MRRSREAS  
          PACK      MRRSRESV,CCC,CYY,CMM,CDD
          REP       " 0",MRRSRESV
          MOVE      MRTRS007,MRRSRHOS       * Hospital ID             *I-240724
.
TRCSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKTRC00  RESET     MRTRS001
          MATCH     SP70,MRTRS001
          GOTO      CHKRES00 IF EQUAL
.
          RESET     MRTRS002
          MATCH     SP70,MRTRS002
          GOTO      CHKRES91 IF EQUAL
.
          GOTO      CHKRES98
.
CHKTRC90  MOVE      "Date Required Cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKRES99
.
CHKTRC91  MOVE      "Time Required cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKRES99
.
CHKTRC98  MOVE      ZERO,EXIT
.
CHKTRC99  RETURN
.------------------------------------------------------------
. Loop through UR numbers and save Reservations
.------------------------------------------------------------
SAVTRC00  MOVE      ZERO,ARRCNT
          MOVE      ZERO,ERRORCNT
.
SAVTRC10  ADD       ONE,ARRCNT
          IF        ARRCNT > MRKEYCNT
            GOTO      SAVTRC99
          ENDIF
.
          MATCH     SP70,MRKEYARR[ARRCNT]  * = corresponding UR
          GOTO      SAVTRC10 IF EQUAL
.
          REP       "+ ",MRKEYARR[ARRCNT]
          UNPACK    MRKEYARR[ARRCNT],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
.
....      MATCH     SP70,LOCKEY
          MATCH     SP70,HOSLOCKY                                     *C-240724
          GOTO      SAVTRC20 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,SAVTRC90
.
          MOVE      MRKEYARR[ARRCNT],KEY20                            *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,SAVTRC91
. 
          GOTO      SAVTRC40
.
SAVTRC20  PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
SAVTRC30  CALL      RKMRMAS1
          BRANCH    OVRCD,SAVTRC92
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      SAVTRC92 IF NOT EQUAL
.
..          MATCH     MRCNSTAT,MRMASTAT
..          GOTO      SAVTRC30 IF NOT EQUAL
.
SAVTRC40  PACK      KEY23,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRRES1
          IF        OVRCD=1
            CALL      TRCSAV00  * Save Variables 
            PACK      KEY23,MRMAKEY,MRRSDATE,MRTRS002,SP70
            CALL      WRRESV1 
          ENDIF
          GOTO      SAVTRC10
.
SAVTRC90  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVTRC10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "Invalid U/R - ",ERRORLST[ERRORCNT]
          APPEND    KEY8,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVTRC10
.
SAVTRC91  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVTRC10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "Invalid MR Key - ",ERRORLST[ERRORCNT]
          APPEND    KEY17,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVTRC10
.
SAVTRC92  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVTRC10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "No Record for UR - ",ERRORLST[ERRORCNT]
          APPEND    URNUMBER,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVTRC10
.
SAVTRC99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Movements
.-------------------------------------------------------------------------------
MRTMVE00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTMVE40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Bulk Record Movements
          GOTO      MRTMVE10 IF EQUAL
.
          MATCH     "H",UPDTTYPE    * Save Home Locations
          GOTO      MRTMVE20 IF EQUAL
.
          MATCH     "F",UPDTTYPE    * Bulk Request Record Movements
          GOTO      MRTMVE30 IF EQUAL
.
          GOTO      MRTMVE99
.
.         ********* ADD FORMACTION **********
.
MRTMVE10  CALL      SAVMVE00
.
.         Increment 'Next Bulk Record Movement Number' and save to control file
.
          MOVE      MRCNNBMN,F10
          ADD       ONE,F10
          MOVE      F10,D10
          REP       " 0",D10
          WRITAB    CONTROLF,SIXTY1;*220,D10
.
          MOVE      ZERO,EXIT
.
          COMPARE   ZERO,ERRORCNT
          GOTO      MRTMVE99 IF EQUAL
          CALL      WARLST00
.
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
.         ********** UPDATE HOME LOCATION FORMACTION **********
.
MRTMVE20  CALL      SAVHOM00
          BRANCH    EXIT,MRTMVE99
          MOVE      ZERO,EXIT
.
          COMPARE   ZERO,ERRORCNT
          GOTO      MRTMVE99 IF EQUAL
          CALL      ERRLST00
.
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
.         ********* UPDATE AND FILL BULK REQUEST FORMACTION **********
.
MRTMVE30  PACK      KEY10,REQUESTN,SP70            * Request Header File
          CALL      RDMRRQH1
          BRANCH    OVRCD,MRTMVE94
.
          MOVE      MRTME016,MRRQPERS
          MOVE      MRTME005,MRRQMOVR
          MOVE      MRTME003,MRRQLOCR
          MOVE      MRTME013,MRRQEXTN
          MOVE      MRTME014,MRRQPAGE
          MOVE      MRTME019,MRRQHOSC                                 *I-240724
.
          CLOCK     TIME,MRRQTMUP
          PACK      MRRQDTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          CALL      UPMRRQH1
.
          CALL      SAVMVE00
          MOVE      ZERO,EXIT
.
          COMPARE   ZERO,ERRORCNT
          GOTO      MRTMVE99 IF EQUAL
          CALL      ERRLST00
.
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
.         ********** DISPLAY FORMACTION **********
.
MRTMVE40  MOVE      SP70,KEY8
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
..          BRANCH    OVRCD,MRTMVE91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          IF        OVRCD=1
            CALL      CLMRTHIS    * Clear all the file variables
          ENDIF
.
          PACK      KEY10,REQUESTN,SP70
          CALL      RDMRRQH1
          IF        OVRCD=1
            CALL      CRQH0000
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Record Movement",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTMVE99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
MRTMVE91  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
MRTMVE92  MOVE      "Patient Record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
MRTMVE93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
MRTMVE94  MOVE      "Invalid Request",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMVE99
.
MRTMVE99  RETURN
.
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
MVESAV00  MOVE      MRMAKEY,MRHIKEY
          MOVE      MRTME001,MRHIDATE 
          MOVE      MRTME002,MRHITIME 
          MOVE      MRTME003,MRHILOC
          MOVE      MRTME005,MRHIREAS  
          MOVE      MRTME006,MRHIOPER 
          MOVE      MRTME007,MRHIDDUE 
          MOVE      MRTME018,MRHICOMM                                 *C-261931
...       MOVE      MRTME019,MRHIDHOS                                 *I-240724
          MOVE      DESTHOSP,MRHIDHOS                                 *I-240724
          MOVE      MRCNNBMN,MRHIMOVN
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP70                        *C-240724
          CALL      RDMRLOC1
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT     * external
          ELSE 
            MOVE      TWO,MRHISTAT    * internal 
          ENDIF
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MATCH     SP70,MRTSECNO
          IF        !@EQUAL
            MOVE      MRTSECID,MRHIUSID  * MRT Security number User ID
          ELSE
            MOVE      USERID,MRHIUSID    * Web User ID
          ENDIF
.
          COMPARE   ONE,PTCNRQCF       * Requested by Free Format?
          IF        @EQUAL
            MOVE      SP70,MRHIRECV  
            MOVE      MRTME016,MRHIREQB  * Requested By Free Format
          ELSE
            MOVE      SP70,MRHIREQB  
            MOVE      MRTME016,MRHIRECV  * Requested By (Using Staff Code)
          ENDIF
.
          MOVE      SP70,MRHILOCK 
          MOVE      MRTME013,MRHIEXTN
          MOVE      MRTME014,MRHIPAGE
          MOVE      MRTME018,MRHICOMM
.
MVESAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKMVE00  RESET     MRTME001
          MATCH     SP70,MRTME001
          GOTO      CHKMVE90 IF EQUAL
.
          RESET     MRTME002
          MATCH     SP70,MRTME002
          GOTO      CHKMVE91 IF EQUAL
.
          GOTO      CHKMVE98
.
CHKMVE90  MOVE      "Date Required Cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKMVE99
.
CHKMVE91  MOVE      "Time Required cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKMVE99
.
CHKMVE98  MOVE      ZERO,EXIT
.
CHKMVE99  RETURN
.------------------------------------------------------------
. Loop through UR numbers and save Movement
.------------------------------------------------------------
SAVMVE00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE      * Set Current Date
.
          READ      CONTROLF,SIXTY1;*220,MRCNNBMN
          MATCH     "0000000000",MRCNNBMN
          IF        @EQUAL
            MOVE      "0000000001",MRCNNBMN
          ENDIF
.
          MOVE      ZERO,ARRCNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,COUNT
.
SAVMVE10  ADD       ONE,ARRCNT
          ADD       ONE,COUNT
          IF        ARRCNT > MRKEYCNT
            GOTO      SAVMVE99
          ENDIF
.
          MATCH     SP70,MRKEYARR[ARRCNT]  * = corresponding UR
          GOTO      SAVMVE99 IF EQUAL
.
          MATCH     CURRDATE,MRTME001      * Current date against move date
          GOTO      SAVMVE15 IF EQUAL
.
          MATCH     CURRDATE,MRTME001      * Is it a past date? 
          GOTO      SAVMVE15 IF LESS
.
          COMPARE   MRCNFUTD,ZERO          * Future Date Parameter
          GOTO      SAVMVE93 IF EQUAL
.
          DAYSEP    CURRDATE,MRTME001,DAYSDIFF
          IF        DAYSDIFF > HTNUMDAY        
            GOTO      SAVMVE93             * Future date too far in advance!
          ENDIF
.
SAVMVE15  MATCH     SP70,MRKEYARR[ARRCNT]  * = corresponding UR
          GOTO      SAVMVE10 IF EQUAL
.
          REP       "+ ",MRKEYARR[ARRCNT]
          UNPACK    MRKEYARR[ARRCNT],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY
          PACK      HOSLOCKY,HOSKEY,LOCKEY,SP10                       *I-240724
.
....      MATCH     SP70,LOCKEY
          MATCH     SP70,HOSLOCKY                                     *C-240724
          GOTO      SAVMVE20 IF EQUAL
.
          COMPARE   VOLUMENU[COUNT],ZERO
          IF        !@EQUAL
            PACK      MRKEYARR[ARRCNT],URNUMBER,HOSKEY,LOCKEY,RTYKEY:
                                       VOLUMENU[COUNT]                *C-240724
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SAVMVE90
.
. "99" is a flag set from BSP that indicates that ALL medical Record volumes 
. for the patient
.
          COMPARE   "99",VOLUMENU[COUNT]
          GOTO      SAVMVE18 IF NOT EQUAL
.
          PACK      KEY20,URNUMBER,Z70
          CALL      RSMRMAS3
SAVMVE16  CALL      RPMRMAS3
          BRANCH    OVRCD,SAVMVE10
.
          MATCH     URNUMBER,MRMAURNO         * Matches on UR No
          GOTO      SAVMVE10 IF NOT EQUAL
.
          MATCH     RTYKEY,MRMADOTY           * Matches on document type
          GOTO      SAVMVE16 IF NOT EQUAL
.
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            MATCH     HOSKEY,MRMAHHOS
            GOTO      SAVMVE16 IF NOT EQUAL
          ELSE
            MATCH     SP70,SUPERLEV
            IF        @EQUAL | @EOS
              MATCH     HOSKEY,MRMAHHOS
              GOTO      SAVMVE16 IF NOT EQUAL
.
              MATCH     LOCKEY,MRMAHLOC
              GOTO      SAVMVE16 IF NOT EQUAL
            ENDIF
          ENDIF
.
..          MATCH     MRCNSTAT,MRMASTAT         * Only active records
..          GOTO      SAVMVE16 IF NOT EQUAL
.
          PACK      SAVKEY20,MRMAURNO,MRMAVOLN,MRMAHHOS,MRMAHLOC,MRMADOTY,SP70 
.
          CALL      MOVREC00    * Save & Move Medical Record
          BRANCH    EXIT,SAVMVE94
.
          PACK      KEY20,SAVKEY20    * Have full Key so do direct read.
          CALL      RDMRMAS3
          GOTO      SAVMVE16
.
SAVMVE18  MOVE      MRKEYARR[ARRCNT],KEY20                            *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,SAVMVE91
. 
          CALL      MOVREC00    * Save & Move Medical Record
          BRANCH    EXIT,SAVMVE94
          GOTO      SAVMVE10
.
SAVMVE20  PACK      LJUSCODE,URNUMBER,SP70
          MOVE      "8",JUSTNO
          CALL      RJUS0000        
          MOVE      RJUSCODE,URNUMBER
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
SAVMVE30  CALL      RKMRMAS1
          BRANCH    OVRCD,SAVMVE92
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      SAVMVE92 IF NOT EQUAL
.
..          MATCH     MRCNSTAT,MRMASTAT
..          GOTO      SAVMVE30 IF NOT EQUAL
. 
          CALL      MOVREC00    * Save & Move Medical Record
          BRANCH    EXIT,SAVMVE94
          GOTO      SAVMVE10
.
SAVMVE90  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVMVE10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Invalid U/R - ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    KEY8,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVMVE10
.
SAVMVE91  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVMVE10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Invalid Medical Record Key - ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    KEY20,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVMVE10
.
SAVMVE92  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVMVE10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "No Record for UR - ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    URNUMBER,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVMVE10
.
SAVMVE93  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVMVE10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Cannot Move this record into the ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    "future. ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    MRKEYARR[ARRCNT],ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          MOVE      ONE,TEST
          GOTO      SAVMVE10
.
SAVMVE94  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVMVE10
          ENDIF     
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Movement exists at this time for UR",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    URNUMBER,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT] 
          MOVE      ZERO,EXIT
          GOTO      SAVMVE10
.
SAVMVE99  RETURN
.------------------------------------------------------------
. Loop through UR numbers and save Home Locations & Destinations
.------------------------------------------------------------
SAVHOM00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE      * Set Current Date
.
          MOVE      ZERO,ARRCNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,COUNT
.
          IF        IBCNMHOS = 1
            MATCH     SP10,MRTME020         * is Home Hospital blank?
            GOTO      SAVHOM97 IF EQUAL
          ENDIF
          MATCH     SP10,MRTME017           * Is Home Location blank?
          GOTO      SAVHOM97 IF EQUAL
.
SAVHOM10  ADD       ONE,ARRCNT
          ADD       ONE,COUNT
          IF        ARRCNT > MRKEYCNT
            GOTO      SAVHOM99
          ENDIF
.
          MATCH     SP70,MRKEYARR[ARRCNT]   * Medical Record Key 1 to mrtmasaf 
          GOTO      SAVHOM99 IF EQUAL
.
          MATCH     CURRDATE,MRTME001       * Current date against move date
          GOTO      SAVHOM20 IF EQUAL
.
          MATCH     CURRDATE,MRTME001       * Is it a past date?
          GOTO      SAVHOM20 IF LESS
.
          COMPARE   MRCNFUTD,ZERO           * Future Date Parameter
          GOTO      SAVHOM92 IF EQUAL
.
          DAYSEP    CURRDATE,MRTME001,DAYSDIFF
          IF        DAYSDIFF > HTNUMDAY        
            GOTO      SAVHOM92              * Future date too far in advance!
          ENDIF
.
SAVHOM20  MATCH     SP70,MRKEYARR[ARRCNT] 
          GOTO      SAVHOM10 IF EQUAL
.
          REP       "+ ",MRKEYARR[ARRCNT]
          UNPACK    MRKEYARR[ARRCNT],URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY
.
          COMPARE   VOLUMENU[COUNT],ZERO
          IF        !@EQUAL
            PACK      MRKEYARR[ARRCNT],URNUMBER,HOSKEY,LOCKEY,RTYKEY:
                                       VOLUMENU[COUNT]   
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SAVHOM90
.
. "99" is a flag set from BSP that indicates that ALL medical Record volumes 
. for the patient
.
          COMPARE   "99",VOLUMENU[COUNT]
          GOTO      SAVHOM50 IF NOT EQUAL
.
          PACK      KEY20,URNUMBER,Z70                                *C-240724
SAVHOM30  CALL      RSMRMAS3
SAVHOM40  CALL      RPMRMAS3
          BRANCH    OVRCD,SAVHOM50

          MATCH     URNUMBER,MRMAURNO       * Matches on UR No
          GOTO      SAVHOM10 IF NOT EQUAL
.
          MATCH     RTYKEY,MRMADOTY         * Matches on document type
          GOTO      SAVHOM40 IF NOT EQUAL
.
..          MATCH     MRCNSTAT,MRMASTAT         * Only active records
..          GOTO      SAVHOM40 IF NOT EQUAL
.
.  * Set save key with spaces as the RS will postion above the current record,
.    thus RP does a read on the previous volume
.
          PACK      SAVKEY20,MRMAURNO,MRMAVOLN,SP70  
.
          CALL      MOVHOM00    * Create New Record with new Home Location 
          BRANCH    ERRFLG,SAVHOM93                                   *I-240724
.
          PACK      KEY20,SAVKEY20          * Use save key.
          GOTO      SAVHOM30
.
SAVHOM50  PACK      KEY20,MRKEYARR[ARRCNT],SP70                       *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,SAVHOM91
.
          CALL      MOVHOM00    * Create New Record with new Home Location 
          GOTO      SAVHOM10
.
SAVHOM90  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVHOM10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Invalid U/R - ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    KEY8,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVHOM10
.
SAVHOM91  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVHOM10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Invalid Medical Record Key - ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    KEY17,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      SAVHOM10
.
SAVHOM92  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVHOM10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Cannot Move this record into the ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    "future. ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT] 
          APPEND    MRKEYARR[ARRCNT],ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          MOVE      ONE,TEST
          GOTO      SAVHOM10
.
SAVHOM93  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      SAVHOM10
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          MOVE      "Cannot Move this record - will ",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT]
          APPEND    "create a duplicate",ERRORLST[ERRORCNT]
          ENDSET    ERRORLST[ERRORCNT]
          APPEND    MRKEYARR[ARRCNT],ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          MOVE      ONE,TEST
          GOTO      SAVHOM10
.
SAVHOM97  CLEAR     WEBTITLE
          IF        IBCNMHOS = 1
            MOVE      "Error Home Hosp. or Location cannot be blank!",WEBTITLE
          ELSE
            MOVE      "Error Home Location cannot be blank!",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SAVHOM99 
.
SAVHOM99  RETURN
.-------------------------------------------------------------------------------
. Save & Move Medical Record 
.-------------------------------------------------------------------------------
MOVREC00  MOVE      ZERO,EXIT
          PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          IF        OVRCD<>1
            MOVE      ONE,EXIT
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE      * Set Current Date
.
.  * Delete all movements after current movement if there are any.
.
          PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
MOVREC10  CALL      RSMRHIS1
          CALL      RKMRHIS1
          BRANCH    OVRCD,MOVREC20
.
          MATCH     MRHIKEY,MRMAKEY         * Match on History Key
          GOTO      MOVREC20 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1
.
          GOTO      MOVREC10                * Read next record 
.
MOVREC20  MATCH     ANSF,UPDTTYPE           * Update and Fill Bulk Request
          GOTO      MOVREC25 IF NOT EQUAL
.
          MATCH     SP70,REQUESTN           * request Number
          GOTO      MOVREC25 IF EQUAL
.
          MOVE      REQUESTN,MRRQRQNO
          MOVE      MRMAKEY,MRRDRKEY
          MOVE      SP70,MRRDSPAR
          PACK      KEY20,MRRQRQNO,MRMAKEY,SP70
          CALL      RDMRRQD1
          IF        OVRCD=0
            MOVE      "Y",MRRDFILL          * Update to Filled
            PACK      MRRDFUID,USERID,SP70
            CALL      UPMRRQD1
          ELSE
            MOVE      "Y",MRRDFILL          * Update to Filled
            PACK      MRRDFUID,USERID,SP70
            CALL      WRMRRQD1              * write to the request Details
          ENDIF
.
MOVREC25  PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          COMPARE   ZERO,OVRCD
          GOTO      MOVREC99 IF EQUAL
.
          CALL      MVESAV00  * Save Variables 
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRMRHIS1      * Writes away the data
            TRAPCLR   IO
            BRANCH    OVRCD,MOVREC99
          ENDIF
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
          PACK      KEY10,MRMAKEY,SP70
          CALL      RDMRMAS2       * Updates the master file with current loc
          BRANCH    OVRCD,MOVREC99
.
          MOVE      MRHIDHOS,MRMACHOS  * set Current Hospital         *I-240724
          MOVE      MRHILOC,MRMACLOC   * Set Current Location
.
          COMPARE   "99",VOLUMENU[COUNT]
          GOTO      MOVREC28 IF EQUAL
.
          MATCH     "1",CLEARCOM
          IF        @EQUAL
            MOVE      SP70,VOLMCOMM
            MOVE      SP70,MICRFILM
          ENDIF
.
          MATCH     Z70,VOLMCOMM
          IF        !@EQUAL
            PACK      MRMACOMM,VOLMCOMM,SP70
          ENDIF
          MATCH     Z70,MICRFILM
          IF        !@EQUAL
            PACK      MRMAFILM,MICRFILM,SP70
          ENDIF
.
MOVREC28  CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
          MATCH     SP70,MRTME012  * change in Post Discharge Status 
          GOTO      MOVREC99 IF EQUAL
.
          PACK      KEY26,URNUMBER,SP1,THREE,Z70
          CALL      RDSVISA4     * Reads Visit file for admission number
MOVREC30  CALL      RDPVISA4
          BRANCH    OVRCD,MOVREC99
.
          MATCH     URNUMBER,PVIURNO             * Same U/R
          GOTO      MOVREC99 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE                * Inpatient Visit
          GOTO      MOVREC99 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MOVREC30
.
          COMPARE   TWO,ASTAT                    * Current Admission
          GOTO      MOVREC35 IF EQUAL
.
          COMPARE   THREE,ASTAT                  * Discharged
          GOTO      MOVREC35 IF EQUAL
.
          GOTO      MOVREC30
.
MOVREC35  PACK      KEY8,AADMNO,SP70 
          CALL      RDMRPDS1     * Check for existing Post discharge status
          IF        OVRCD=1
            MOVE      AADMNO,MRPDADMN
            MOVE      ADOCTA,MRPDDOCT
            MOVE      MRTME012,MRPDSTAT
            MOVE      CURRDATE,MRPDDATE
            CLOCK     TIME,MRPDTIME 
            MOVE      SP70,MRPDRMOR
            MOVE      SP70,MRPDSPAR
            CALL      WRMRPDS1
          ELSE
            PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
            CALL      RDMRPSH1
            IF        OVRCD=1
              MOVE      MRPDADMN,MRPSADMN
              MOVE      MRPDDATE,MRPSDATE
              MOVE      MRPDTIME,MRPSTIME 
              MOVE      MRPDSTAT,MRPSSTAT
              MOVE      SP70,MRPSCMNT  
              MOVE      SP70,MRPSMIS1 
              MOVE      SP70,MRPSMIS2
              MOVE      SP70,MRPSMIS3 
              MOVE      SP70,MRPSMIS4 
              MOVE      SP70,MRPSMIS5 
              MOVE      SP70,MRPSMIS6 
              PACK      MRPSFTM1,SP70,SP70
              PACK      MRPSFTM2,SP70,SP70
              PACK      MRPSFTM3,SP70,SP70
              PACK      MRPSFTM4,SP70,SP70
              PACK      MRPSFTM5,SP70,SP70
              MOVE      SP70,MRPSSPAR
              CALL      WRMRPSH1
            ELSE
              MOVE      MRPDSTAT,MRPSSTAT
              CALL      UPMRPSH1
            ENDIF 
            MOVE      ADOCTA,MRPDDOCT
            MOVE      MRTME012,MRPDSTAT
            MOVE      CURRDATE,MRPDDATE
            CLOCK     TIME,MRPDTIME 
            CALL      UPMRPDS1
          ENDIF
.
MOVREC99  RETURN
.-------------------------------------------------------------------------------
. Set New Home Loctaion & Destination & write to the History file 
.-------------------------------------------------------------------------------
MOVHOM00  MOVE      ZERO,ERRFLG
          PACK      SVKEY20A,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70 
          PACK      SVKEY20B,URNUMBER,MRTME020,MRTME017,MRMADOTY,MRMAVOLN,SP70
.
          MATCH     SVKEY20A,SVKEY20B
          IF        !@EQUAL
            PACK      KEY20,SVKEY20B      * check if new Home causes a duplicate
            CALL      RAMRMAS1     
            IF        OVRCD <> 1
              MOVE      ONE,ERRFLG
              GOTO      MOVHOM99
            ENDIF
          ENDIF
.
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70 
          CALL      DEMRMAS1            * Delete old record           *C-240724
.
.  * Creat new record with new Home Location
.
          MOVE      MRTME020,MRMAHHOS   * set new Home Hospital       *I-240724
          MOVE      MRTME017,MRMAHLOC   * Set new Home Location
          MOVE      MRTME003,MRMACLOC   * Set new Current Location
          MOVE      MRTME019,MRMACHOS   * set new Current Hospital    *I-240724
.
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
.
          PACK      KEY20,URNUMBER,MRTME020,MRTME017,MRMADOTY,MRMAVOLN,SP70
          CALL      RAMRMAS1                                          *C-240724
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRMRMAS1              * Writes the Key & data
            TRAPCLR   IO
            BRANCH    OVRCD,MOVHOM99
          ENDIF
.
.  * Delete all movements after current movement if there are any.
.
          PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
MOVHOM10  CALL      RSMRHIS1
          CALL      RKMRHIS1
          BRANCH    OVRCD,MOVHOM20
.
          MATCH     MRHIKEY,MRMAKEY         * Match on History Key
          GOTO      MOVHOM20 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1
.
          GOTO      MOVHOM10                * Read next record
.
MOVHOM20  PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          COMPARE   ZERO,OVRCD
          GOTO      MOVREC99 IF EQUAL
.
          CALL      MVESAV00  * Save Variables 
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRMRHIS1      * Writes away the data
            TRAPCLR   IO
            BRANCH    OVRCD,MOVHOM99
          ENDIF
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
MOVHOM99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Movement History Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTMOE00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTMOE40 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTMOE30 IF EQUAL
.
          GOTO      MRTMOE92
.
.         ************ DELETE FORMACTION **********
.
MRTMOE30  PACK      KEY26,MEDRECKY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,MRTMOE90
.
          PACK      HISKEY,MRHIKEY,MRHIDATE,MRHITIME,SP70
          PACK      KEY26,MEDRECKY,MRTME001,MRTME002,SP70
.
.   *** Check if we are on most current movement history record 
.
          MATCH     KEY26,HISKEY
          GOTO      MRTMOE31 IF NOT EQUAL
. 
          CALL      RSETLC00    * Reset the location of the mrtmasaf record. 
.
MRTMOE31  PACK      KEY26,MEDRECKY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          BRANCH    OVRCD,MRTMOE90
.
          CALL      DEMRHIS1 
.
          MOVE      ZERO,EXIT
          GOTO      MRTMOE99
.
.         ************ DISPLAY FORMACTION **********
.
MRTMOE40  MOVE      SP70,KEY8
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRTMOE91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
.  if medrecky has not been passed in, use mrhiskey instead
          MATCH     SP70,MEDRECKY
          IF        @EQUAL
            MATCH     SP70,MRHISKEY
            IF        !@EQUAL
              PACK      MEDRECKY,MRHISKEY
            ENDIF
          ENDIF
.
          MATCH     SP70,MEDRECKY
          IF        @EQUAL
            CALL      GETCMR00       * Get Current Medical Record
            BRANCH    EXIT,MRTMOE90
          ELSE
            PACK      KEY10,MEDRECKY,SP70
            CALL      RDMRMAS2
            BRANCH    OVRCD,MRTMOE90
          ENDIF
.
          CALL      SAVMRM00         * Save Masterfile Details
.
          MATCH     MRHISKEY,SP70    
          IF        @EQUAL
            PACK      KEY26,MEDRECKY,MRTME001,MRTME002,SP70
          ELSE
            PACK      KEY26,MRHISKEY,SP70
          ENDIF
          CALL      RDMRHIS1
          IF        OVRCD=1
            CALL      CLMRTHIS    * Clear all the file variables
          ENDIF

          CLEAR     WEBTITLE
          MOVE      "Medical Record Master Movement",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTMOE99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTMOE99
.
MRTMOE90  MOVE      "Medical Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOE99
.
MRTMOE91  MOVE      "Invalid UR Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOE99
.
MRTMOE92  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTMOE99
.
MRTMOE99  RETURN
+
.-------------------------------------------------------------------------------
. This routine will read the previous History record and write its location
. to mrtmasaf. If no previous history records are found no upadate of mrtmasaf
. will occur.
.-------------------------------------------------------------------------------
RSETLC00  CALL      RPMRHIS1          * Read Previous history Record 
          BRANCH    OVRCD,RSETLC95    * C CAR 50523
.
          MATCH     MEDRECKY,MRHIKEY  * Check if Medical record Key 
          GOTO      RSETLC95 IF NOT EQUAL  * C CAR 50523
.
          PACK      KEY10,MRHIKEY,SP70
          CALL      RDMRMAS2          * Updates the master file with current loc
          BRANCH    OVRCD,RSETLC99
.
          MOVE      MRHIDHOS,MRMACHOS * set Current Hospital          *I-240724
          MOVE      MRHILOC,MRMACLOC  * Set Current Location
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2                    
          GOTO      RSETLC99          * I-53229
.
RSETLC95  PACK      KEY10,MEDRECKY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,RSETLC99
          MOVE      MRMAHHOS,MRMACHOS                                 *I-240724
          MOVE      MRMAHLOC,MRMACLOC
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
RSETLC99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Template Headings Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTTHD00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTTHD40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTTHD10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTTHD30 IF EQUAL
.
          GOTO      MRTTHD93
.
.         ************ ADD FORMACTION ***********
.
MRTTHD10  CALL      CHKTHD00      * Checks mandatory fields
          BRANCH    EXIT,MRTTHD99
          PACK      KEY4,MRTTH001,SP70
          CALL      RDMRTHD1
          COMPARE   ZERO,OVRCD
          GOTO      MRTTHD92 IF EQUAL
.
          CALL      THDSAV00      * Moves input variables to file variables
          PACK      KEY4,MRTTH001,SP70
          CALL      WRMRTHD1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTTHD99
.
.         ************ DELETE FORMACTION **********
.
MRTTHD30  PACK      KEY4,MRTTH001,SP70
          CALL      RDMRTHD1
          BRANCH    OVRCD,MRTTHD91
          CALL      DEMRTHD1
.
          PACK      KEY8,MRTTH001,SP70
          CALL      RDMRTDT1
MRTTHD31  CALL      RKMRTDT1
          BRANCH    OVRCD,MRTTHD32
.
          MATCH     MRTDTMNO,MRTTH001
          IF        !@EQUAL
            GOTO      MRTTHD31
          ENDIF
.          
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      DEMRTDT1
          GOTO      MRTTHD31
.
MRTTHD32  MOVE      ZERO,EXIT
          GOTO      MRTTHD99
.
.         ************ DISPLAY FORMACTION **********
.
MRTTHD40  PACK      KEY4,MRTTH001,SP70
          CALL      RDMRTHD1
          IF        OVRCD=1
            CALL      CLRTHD00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Coding Templates Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTTHD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTTHD99
.
MRTTHD91  MOVE      "Coding Template does not exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTHD99
.
MRTTHD92  MOVE      "Coding Template exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTHD99
.
MRTTHD93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTHD99
.
MRTTHD99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRTHD00  MOVE      SP70,MRTHTMID
          MOVE      SP70,MRTHDESC 
          MOVE      SP70,MRTHACTV 
.
CLRHTD99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
THDSAV00  MOVE      MRTTH001,MRTHTMID    
          MOVE      MRTTH002,MRTHDESC       
.
          MATCH     "2",MRTTH003     * Status 1 = Active 0 = Non-Active
          IF        @EQUAL
            MOVE      ONE,MRTHACTV   
          ELSE 
            MOVE      ZERO,MRTHACTV   
          ENDIF
.
THDSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKTHD00  RESET     MRTTH001
          MATCH     SP70,MRTTH001
          GOTO      CHKTHD90 IF EQUAL
.
          GOTO      CHKTHD98
.
CHKTHD90  MOVE      "Template ID cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTHD99
.
CHKTHD98  MOVE      ZERO,EXIT
.
CHKTHD99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Template Details Maintenance: Display,Add,Update,Delete
.-------------------------------------------------------------------------------
MRTTDT00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTTDT50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MRTTDT10 IF EQUAL
.
          MATCH     "S",UPDTTYPE    * Swap Sequence 
          GOTO      MRTTDT20 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MRTTDT40 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MRTTDT30 IF EQUAL
.
          GOTO      MRTTDT93
.
.         ************ ADD FORMACTION ***********
.
MRTTDT10  UNPACK    MRTTD005,DIM1      * Checks to see if Disease or Operation
          TYPE      DIM1
          IF        @EQUAL
            CALL      VALICO00     * Validate Procedure Code
            BRANCH    EXIT,MRTTDT99
          ELSE
            CALL      VALICD00     * Validate Disease Code
            BRANCH    EXIT,MRTTDT99
          ENDIF 
.
          MOVE      MRTTD001,MRTDTMNO
          MOVE      MRTTD002,MRTDRECT
          CALL      SEQN0000             * sets up next seq in list
          MOVE      FORM3,MRTTD003
          REP       " 0",MRTTD003
          PACK      MRTTD003,MRTTD003,SP70
.
          CALL      CHKTDT00      * Checks mandatory fields
          BRANCH    EXIT,MRTTDT99
.
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      RDMRTDT1
          COMPARE   ZERO,OVRCD
          GOTO      MRTTDT92 IF EQUAL
.
          CALL      TDTSAV00      * Moves input variables to file variables
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      WRMRTDT1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTTDT99
.
.         ************ SWAP FORMACTION **********
.
MRTTDT20  MATCH     NEWSEQNC,MRTTD003
          GOTO      MRTTDT99 IF EQUAL
.
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70   
          CALL      RDMRTDT1
          BRANCH    OVRCD,MRTTDT91
.
          MATCH     MOVESWAP,S
          IF        @EQUAL
            GOTO      SWAP0000
          ENDIF
.
          MOVE      NEWSEQNC,FORM3
          MOVE      MRTTD003,FORM3A
          
          IF        FORM3 > FORM3A
            GOTO      STRL0000
          ELSE
            GOTO      ENDL0000
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MRTTDT99
.
.         ************ DELETE FORMACTION **********
.
MRTTDT30  PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70   
          CALL      RDMRTDT1
          BRANCH    OVRCD,MRTTDT91
          CALL      DEMRTDT1
MRTTDT31  CALL      RKMRTDT1
          BRANCH    OVRCD,MRTTDT32
.
          MATCH     MRTDTMNO,MRTTD001
          GOTO      MRTTDT32 IF NOT EQUAL
.
          MATCH     MRTDRECT,MRTTD002
          GOTO      MRTTDT32 IF NOT EQUAL
.
          PACK      SAVKEY,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          PACK      KEY8,SAVKEY
          CALL      DEMRTDT1
.
          MOVE      MRTDSEQN,FORM3
          SUB       ONE,FORM3
          MOVE      FORM3,MRTDSEQN
          REP       " 0",MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1             

          GOTO      MRTTDT31
.
MRTTDT32  MOVE      ZERO,EXIT
          GOTO      MRTTDT99
.
.
.         ************ UPDATE FORMACTION **********
.
MRTTDT40  UNPACK    MRTTD005,DIM1      * Checks to see if Disease or Operation
          TYPE      DIM1
          IF        @EQUAL
            CALL      VALICO00     * Validate Procedure Code
            BRANCH    EXIT,MRTTDT99
          ELSE
            CALL      VALICD00     * Validate Disease Code
            BRANCH    EXIT,MRTTDT99
          ENDIF 
.
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      RDMRTDT1
          BRANCH    OVRCD,MRTTDT91
          CALL      CHKTDT00      * Checks mandatory fields
          BRANCH    EXIT,MRTTDT99
.
          CALL      TDTSAV00      * Moves input variables to file variables
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      UPMRTDT1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      MRTTDT99
.
.
.         ************ DISPLAY FORMACTION **********
.
MRTTDT50  PACK      KEY4,MRTTD001,SP70
          CALL      RDMRTHD1
          BRANCH    OVRCD,MRTTDT90
 
          PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      RDMRTDT1
          IF        OVRCD=1
            CALL      CLRTDT00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Medical Records Coding Template Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTTDT99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTTDT99
.
MRTTDT90  MOVE      "Coding Template does not exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTDT99
.
MRTTDT91  MOVE      "Coding Template Does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTDT99
.
MRTTDT92  MOVE      "Coding Template exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTDT99
.
MRTTDT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTTDT99
.
MRTTDT99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRTDT00  MOVE      SP70,MRTDTMNO
          MOVE      SP70,MRTDRECT 
          MOVE      SP70,MRTDSEQN 
          MOVE      SP70,MRTDDEST 
          MOVE      SP70,MRTDDECD 
          MOVE      SP70,MRTDDESC 
          MOVE      SP70,MRTDDCID
.
CLRTDT99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
TDTSAV00  MOVE      MRTTD001,MRTDTMNO    
          MOVE      MRTTD002,MRTDRECT       
          MOVE      MRTTD003,MRTDSEQN      
          MOVE      MRTTD004,MRTDDEST       
          MOVE      MRTTD005,MRTDDECD       
          MOVE      MRTTD006,MRTDDESC       
          MOVE      MRTTD007,MRTDDCID       
.
TDTSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKTDT00  RESET     MRTTD001
          MATCH     SP70,MRTTD001
          GOTO      CHKTDT90 IF EQUAL
.
          RESET     MRTTD002
          MATCH     SP70,MRTTD002
          GOTO      CHKTDT91 IF EQUAL
.
          RESET     MRTTD003
          MATCH     SP70,MRTTD003
          GOTO      CHKTDT92 IF EQUAL
.
          GOTO      CHKTDT98
.
CHKTDT90  MOVE      "Template ID cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTDT99
.
CHKTDT91  MOVE      "Record Type cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTDT99
.
CHKTDT92  MOVE      "Sequence Number cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTDT99
.
CHKTDT98  MOVE      ZERO,EXIT
.
CHKTDT99  RETURN
.---------------------------------------------------------------------
.         Repositions sequence in template from start to end
.---------------------------------------------------------------------
STRL0000  PACK      SAVKEY,MRTTD001,MRTTD002,MRTTD003,SP70   
          MOVE      SAVKEY,KEY8
          CALL      RDMRTDT1
          MOVE      NNN,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      RAMRTDT1
          CALL      WRMRTDT1
          MOVE      SAVKEY,KEY8 
          CALL      DEMRTDT1

          PACK      KEY8,SAVKEY,SP70
          CALL      RSMRTDT1
STRL1000  CALL      RKMRTDT1
          BRANCH    OVRCD,STRL9999

          MATCH     MRTDTMNO,MRTTD001
          GOTO      STRL9999 IF NOT EQUAL

          MATCH     MRTDRECT,MRTTD002
          GOTO      STRL9999 IF NOT EQUAL

          MATCH     MRTDSEQN,NEWSEQNC
          GOTO      STRL2000 IF NOT EQUAL
          
          MOVE      MRTDSEQN,FORM3
          SUB       ONE,FORM3
          MOVE      FORM3,MRTDSEQN
          REP       " 0",MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1             
          PACK      KEY8,MRTDTMNO,MRTDRECT,NEWSEQNC,SP70
          CALL      DEMRTDT1
.
          PACK      KEY8,MRTDTMNO,MRTDRECT,NNN,SP70
          CALL      RDMRTDT1
          MOVE      NEWSEQNC,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,NEWSEQNC,SP70
          CALL      WRMRTDT1
          PACK      KEY8,MRTDTMNO,MRTDRECT,NNN,SP70
          CALL      DEMRTDT1
          GOTO      STRL9999

STRL2000  MOVE      MRTDSEQN,FORM3
          MOVE      MRTDSEQN,KEY3
          SUB       ONE,FORM3
          MOVE      FORM3,MRTDSEQN
          REP       " 0",MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1             

          PACK      KEY8,MRTDTMNO,MRTDRECT,KEY3,SP70
          CALL      DEMRTDT1
          GOTO      STRL1000

STRL9999  RETURN             
.---------------------------------------------------------------------
.         Repositions sequence in template from end to start
.---------------------------------------------------------------------
ENDL0000  PACK      SAVKEY,MRTTD001,MRTTD002,MRTTD003,SP70   
          MOVE      SAVKEY,KEY8
          CALL      RDMRTDT1
          MOVE      NNN,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1
          MOVE      SAVKEY,KEY8 
          CALL      DEMRTDT1

          PACK      KEY8,SAVKEY,SP70
          CALL      RSMRTDT1
ENDL1000  CALL      RPMRTDT1
          BRANCH    OVRCD,ENDL9999

          MATCH     MRTDTMNO,MRTTD001
          GOTO      ENDL9999 IF NOT EQUAL

          MATCH     MRTDRECT,MRTTD002
          GOTO      ENDL9999 IF NOT EQUAL

          MATCH     MRTDSEQN,NEWSEQNC
          GOTO      ENDL2000 IF NOT EQUAL
          
          MOVE      MRTDSEQN,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,MRTDSEQN
          REP       " 0",MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1             
          PACK      KEY8,MRTDTMNO,MRTDRECT,NEWSEQNC,SP70
          CALL      DEMRTDT1
.
          PACK      KEY8,MRTDTMNO,MRTDRECT,NNN,SP70
          CALL      RDMRTDT1
          MOVE      NEWSEQNC,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,NEWSEQNC,SP70
          CALL      WRMRTDT1
          PACK      KEY8,MRTDTMNO,MRTDRECT,NNN,SP70
          CALL      DEMRTDT1
          GOTO      ENDL9999

ENDL2000  MOVE      MRTDSEQN,FORM3
          MOVE      MRTDSEQN,KEY3
          ADD       ONE,FORM3
          MOVE      FORM3,MRTDSEQN
          REP       " 0",MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1             

          PACK      KEY8,MRTDTMNO,MRTDRECT,KEY3,SP70
          CALL      DEMRTDT1
          GOTO      ENDL1000

ENDL9999  RETURN             
.---------------------------------------------------------------------
.         Swap sequence in list
.---------------------------------------------------------------------
SWAP0000  PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70   
          CALL      RDMRTDT1
          CALL      DEMRTDT1
          MOVE      NNN,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1
.
          PACK      KEY8,MRTTD001,MRTTD002,NEWSEQNC,SP70
          CALL      RDMRTDT1
          CALL      DEMRTDT1
          MOVE      MRTTD003,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1
.
          PACK      KEY8,MRTTD001,MRTTD002,NNN,SP70
          CALL      RDMRTDT1
          CALL      DEMRTDT1
          MOVE      NEWSEQNC,MRTDSEQN
          PACK      KEY8,MRTDTMNO,MRTDRECT,MRTDSEQN,SP70
          CALL      WRMRTDT1
.
SWAP9999  RETURN
.------------------------------------------------------------
. Validate ICD Disease
.------------------------------------------------------------
VALICD00  MOVE      MRTTD005,KEY9
          CALL      RDPTICD1
          BRANCH    OVRCD,VALICD90
.
          MATCH     "P",DFLAG
          GOTO      VALICD91 IF NOT EQUAL
.
          GOTO      VALICD98
.
VALICD90  MOVE      "Invalid Disease Code!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALICD99
.
VALICD91  MOVE      "Invalid Disease Prefix not Posting!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALICD99
.
VALICD98  MOVE      ZERO,EXIT
VALICD99  RETURN
.------------------------------------------------------------
. Validate ICD Operation
.------------------------------------------------------------
VALICO00  MOVE      MRTTD005,KEY9
          CALL      RDPTICO1
          BRANCH    OVRCD,VALICO90
.
          MATCH     ANSI,MRTTD004
          GOTO      VALICO98 IF EQUAL
.
          MATCH     ANSN,MRTTD004
          GOTO      VALICO98 IF EQUAL
.
          MATCH     "P",OFLAG
          GOTO      VALICO91 IF NOT EQUAL
.
          MATCH     CMOPRT,MRTTD004
          GOTO      VALICO92 IF NOT EQUAL
.
          GOTO      VALICO98
.
VALICO90  MOVE      "Invalid Procedure Code!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALICO99
.
VALICO91  MOVE      "Invalid Procedure not a Posting Record!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALICO99
.
VALICO92  MOVE      "Invalid Prefix for Procedure Code!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALICO99
.
VALICO98  MOVE      ZERO,EXIT
VALICO99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Post Discharge Tracking
.-------------------------------------------------------------------------------
PSTTRK00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PSTTRK50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PSTTRK10 IF EQUAL
.
          GOTO      PSTTRK93
.
.         ************ ADD FORMACTION ***********
.
PSTTRK10  
.
          MOVE      ZERO,EXIT
          GOTO      PSTTRK99
.
.         ************ DISPLAY FORMACTION **********
.
PSTTRK50  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PSTTRK91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
. 
          CLEAR     WEBTITLE
          MOVE      "Medical Records Post Discharge Tracking",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PSTTRK99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK99  RETURN
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110,PROFL120,PROFLD99,PROFLD99,PROFL150:
                             PROFLD99,PROFLD99,PROFL180
.
          GOTO      PROFLD99
.
.      Locations Maintenance
.
PROFLD10  CALL      MRTL0000       * Locations Maintanance
          GOTO      PROFLD99
.
.      Movement Reason Maintenance
.
PROFLD20  CALL      MRTM0000
          GOTO      PROFLD99
.
.      Staff Register Maintenance
.
PROFLD30  CALL      MRTS0000
          GOTO      PROFLD99
.
.      Bay Codes Maintenance
.
PROFLD40  CALL      MRTB0000
          GOTO      PROFLD99
.
.      Medical Record Master Maintenance
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD52  CALL      MRTA0000
          GOTO      PROFLD99
.
.      Medical Record Reservation Maintenance
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD62  CALL      MRTA0000
          GOTO      PROFLD99
.
PROFLD63  CALL      MRTR0000
          GOTO      PROFLD99
.
.      Medical Record Reservation Bulk Maintenance
.
PROFLD70  GOTO      PROFLD50
.
PROFLD80  CALL      MLST0000
          GOTO      PROFLD99
.
.      Medical Record Bulk Movement Maintenance
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD92  CALL      MRTA0000
          GOTO      PROFLD99
.
PROFLD93  CALL      MRTV0000                * Bulk Movement Maintenance
          GOTO      PROFLD99
.
PROFLD94  CALL      MOVT0000                * Single record movement
          GOTO      PROFLD99
.
PROFLD95  CALL      RCRQ0000                * Record Request Details
          GOTO      PROFLD99
.
.      Medical Record Movement Maintenance
.
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102,PROFL103
          GOTO      PROFLD99
.
PROFL101  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFL102  CALL      MRTA0000
          GOTO      PROFLD99
.
PROFL103  CALL      MRTH0000                * MRT History
          GOTO      PROFLD99
.
.      Medical Record Template Heading Maintenance
.
PROFL110  CALL      MRTT0000
          GOTO      PROFLD99
.
.      Medical Record Template Details Maintenance
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122
          GOTO      PROFLD99
.
PROFL121  CALL      MRTT0000                * Template Headings Maint.
          GOTO      PROFLD99
.
PROFL122  CALL      MRTD0000                * Template details Maint. 
          GOTO      PROFLD99
.
.      Bar Code Labels
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFL152  CALL      MRTA0000
          GOTO      PROFLD99
.
.     Link medical records by visit number
.
PROFL180  BRANCH    FLDSETNO,PROFL181,PROFL182
          GOTO      PROFLD99
.
PROFL181  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFL182  CALL      MRTA0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-----------------------------------------------------------
. Option 1 - Locations Mantenance
.-----------------------------------------------------------
MRTL0000  BRANCH    FLDITMNO,MRTL0100,MRTL0200,MRTL0300,MRTL0400,MRTL0500:
                             MRTL0600,MRTL0700,MRTL0800,MRTL0900,MRTL1000:
                             MRTL1100,MRTL1200,MRTL1300,MRTL1400,MRTL1500:
                             MRTL1600,MRTL1700,MRTL1800,MRTL1900,MRTL2000:
                             MRTL2100,MRTL2200
          GOTO      MRTL9999
.
MRTL0100  WRITE     HTMLFILE;MRLOCODE;  * Location Code
          GOTO      MRTL9999
.
MRTL0200  WRITE     HTMLFILE;MRLODESC;  * Description
          GOTO      MRTL9999
.
MRTL0300  MOVE      "LT",CATEGORY
          MOVE      MRLOTYPE,CODE
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL0400  WRITE     HTMLFILE;MRLOINDC;  * Indicator (Int/Ext)           
          GOTO      MRTL9999
.
MRTL0500  WRITE     HTMLFILE;MRLOSTAT;  * Status Indicator             
          GOTO      MRTL9999
.
MRTL0600  WRITE     HTMLFILE;MRLOUSAG;  * Usage Indicator              
          GOTO      MRTL9999
.
MRTL0700  CALL      MRTTB000            * Table of mrt locations by code
          GOTO      MRTL9999
.
MRTL0800  CALL      NEXTPR00            * Link to Next Set of Codes 
          GOTO      MRTL9999
.
MRTL0900  CALL      PREVPR00            * Link to Prev Set of Codes 
          GOTO      MRTL9999
.
MRTL1000  MOVE      MRLOPRNT,CDEFPRT
          CALL      SELPRT00            * Select a Printer
          GOTO      MRTL9999
.
MRTL1100  CALL      STCOD000            * Stationary Code's
          GOTO      MRTL9999
.
MRTL1200  COMPARE   ONE,IBCNMHOS
          GOTO      MRTL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=DataLabel>Hospital ID</td>":
                             "<td><select name=mrtlc009 title='Hospital ID' ":
                             "class='Mandatory'>":
                             "<option></option>"
          MOVE      MRLOHOSP,SELHOSP
          CALL      HSEL0000
          WRITE     HTMLFILE;"</select></td><td colspan=2>&nbsp</td></tr>";
          GOTO      MRTL9999
.
MRTL1300  WRITE     HTMLFILE;MRLOPRLC;  * Priority Location (1=yes)
          GOTO      MRTL9999
.
MRTL1400  MOVE      MRLOBPRN,CDEFPRT
          CALL      SELPRT00            * Select a Printer
          GOTO      MRTL9999
.
MRTL1500  WRITE     HTMLFILE;FILTACTV;  * Active/Inactive filter
          GOTO      MRTL9999
.
MRTL1600  WRITE     HTMLFILE;FILTHOSP;  * Hospital filter
          GOTO      MRTL9999
.
MRTL1700  COMPARE   ONE,IBCNMHOS
          GOTO      MRTL9999 IF NOT EQUAL
.
          MOVE      FILTHOSP,SELHOSP
          CALL      HSEL0000
          WRITE     HTMLFILE;"</select></td><td colspan=2>&nbsp</td></tr>";
          GOTO      MRTL9999
.
MRTL1800  CALL      MRTTD000     * Table of mrt locations by name
          GOTO      MRTL9999

MRTL1900  WRITE     HTMLFILE;SUPERLEV;      * Supervisor flag
          GOTO      MRTL9999
.
MRTL2000  WRITE     HTMLFILE;MRLOHOSP;      * Hospital Id.
          GOTO      MRTL9999
.
MRTL2100  WRITE     HTMLFILE;MRLOTREC;     * Using Tracking Receipt For This Loc
          GOTO      MRTL9999
.
MRTL2200  COMPARE   ONE,IBCNMHOS
          GOTO      MRTL9999 IF NOT EQUAL
.
          PACK      KEY3,MRLOHOSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      MRLOHOSP,PTHSNAME
          ENDIF
.
          WRITE     HTMLFILE;PTHSNAME;      * Hospital Name
          GOTO      MRTL9999
.
MRTL9999  RETURN
.------------------------------------------------------------
. Stationary Code's
.------------------------------------------------------------
STCOD000  MOVE      ZERO,KEY6
          CALL      RSIBTH1
STCOD010  CALL      RKIBTH1
          BRANCH    OVRCD,STCOD999
.
          MATCH     "  4",IBTHSTYP           * Stationary Type 4 is med rec req.
          GOTO      STCOD010 IF NOT EQUAL
.
          MATCH     MRLOSTCD,IBTHSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#" selected>":
                               IBTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">",IBTHDESC:
                               "</option>"
          ENDIF
          GOTO      STCOD010
.
STCOD999  RETURN
+
.------------------------------------------------------------
. Hospital Selection - List of Hospitals allowed to User
. Including any associated MR home hospitals
.------------------------------------------------------------
HSEL0000  IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            GOTO      HSEL5000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD = 1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
.
          MATCH     SP70,PTHSHHOS                * Any default MR home hospital
          GOTO      HSEL0100 IF EQUAL
.
          MATCH     PTHSHOSP,PTHSHHOS            * MR home hospital different to
          GOTO      HSEL0100 IF EQUAL            * current hosptial
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD = 1
            PACK      KEY13,USERID,PTHSHHOS,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL2000
          ENDIF
          GOTO       HSEL0100
.
HSEL2000  PACK      SAVKEY3,PTHSHOSP,SP70
          PACK      KEY3,PTHSHHOS,SP70           * Output associated MR home 
          CALL      RDPTHSP1                     * hospital the user doesn't
          BRANCH    OVRCD,HSEL3000               * have direct access to.
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
.
HSEL3000  PACK      KEY3,SAVKEY3
          CALL      RDPTHSP1
          GOTO      HSEL0100
.
HSEL5000  MOVE      SP10,WBSEHOSP           * only display User Hospital
          PACK      KEY10,USERID,SP70 
          CALL      RDWBSE1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY3,WBSEHOSP,SP70 
          CALL      RDPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          IF        DOSELHOS <> 1
            MOVE      WBSEHOSP,SELHOSP      * override whatever is in SELHOSP
          ENDIF
.     
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     PTHSHOSP,SELHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">":
                               KEY50,"</option>"
          ENDIF
. 
          MATCH     SP70,PTHSHHOS                * Any default MR home hospital
          GOTO      HSEL9999 IF EQUAL 
.
          MOVE      PTHSHOSP,SAVKEY3A
          MOVE      PTHSHHOS,SAVKEY3B
.
HSEL6000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL6100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          MATCH     SAVKEY3A,PTHSHOSP
          GOTO      HSEL6100 IF EQUAL
.
          MATCH     PTHSHHOS,SAVKEY3B
          GOTO      HSEL6100 IF NOT EQUAL
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
.
          MATCH     PTHSHOSP,SELHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">":
                               KEY50,"</option>"
          ENDIF
.
          GOTO      HSEL6100
.
HSEL9999  RETURN
.-----------------------------------------------------------
. Option 2 - Movement Reason Mantenance
.-----------------------------------------------------------
MRTM0000  BRANCH    FLDITMNO,MRTM0100,MRTM0200,MRTM0300,MRTM0400,MRTM0500:
                             MRTM0600,MRTM0700,MRTM0800,MRTM0900,MRTM1000
          GOTO      MRTM9999
.
MRTM0100  WRITE     HTMLFILE;MRMOREAS;  * Reason for Movement
          GOTO      MRTM9999
.
MRTM0200  WRITE     HTMLFILE;MRMODESC;  * Description
          GOTO      MRTM9999
.
MRTM0300  WRITE     HTMLFILE;MRMOPERD;  * Borrowing Period
          GOTO      MRTM9999
.      
MRTM0400  WRITE     HTMLFILE;MRMOTYPE;  * Type     
          GOTO      MRTM9999
.
MRTM0500  WRITE     HTMLFILE;MRMOINDC;  * Indicator (Int/Ext)          
          GOTO      MRTM9999
.
MRTM0600  WRITE     HTMLFILE;MRMOSTAT;  * Status Indicator            
          GOTO      MRTM9999
.
MRTM0700  WRITE     HTMLFILE;MRMOUSAG;  * Usage Indicator              
          GOTO      MRTM9999
.
MRTM0800  CALL      MOVTB000     * Table of Movement Reasons
          GOTO      MRTM9999
.
MRTM0900  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTM9999
.
MRTM1000  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTM9999
.
MRTM9999  RETURN
.-----------------------------------------------------------
. Option 3 - Staff Register Mantenance
.-----------------------------------------------------------
MRTS0000  BRANCH    FLDITMNO,MRTS0100,MRTS0200,MRTS0300,MRTS0400,MRTS0500:
                             MRTS0600,MRTS0700,MRTS0800,MRTS0900,MRTS1000:
                             MRTS1100,MRTS1200,MRTS1300,MRTS1400,MRTS1500:
                             MRTS1600
          GOTO      MRTS9999
.
MRTS0100  WRITE     HTMLFILE;MRSTCODE;  * Staff Code
          GOTO      MRTS9999
.
MRTS0200  WRITE     HTMLFILE;MRSTTITL;  * Title
          GOTO      MRTS9999
.
MRTS0300  WRITE     HTMLFILE;MRSTSNAM;  * Surname
          GOTO      MRTS9999
.      
MRTS0400  WRITE     HTMLFILE;MRSTGNAM;  * Given Name
          GOTO      MRTS9999
.
MRTS0500  MOVE      "TD",CATEGORY
          MOVE      MRSTDEPT,CODE
          CALL      CODITM00
          GOTO      MRTS9999
.
MRTS0600  WRITE     HTMLFILE;MRSTCONT;  * Contact Point
          GOTO      MRTS9999
.
MRTS0700  WRITE     HTMLFILE;MRSTIEPH;  * Phone No. (Internal Extention)
          GOTO      MRTS9999
.
MRTS0800  WRITE     HTMLFILE;MRSTBHPH;  * Phone No. (External/Other)
          GOTO      MRTS9999
.
MRTS0900  WRITE     HTMLFILE;MRSTAHPH;  * Phone No. (After Hours)
          GOTO      MRTS9999
.
MRTS1000  WRITE     HTMLFILE;MRSTPAGR;  * Phone No. (Pager)
          GOTO      MRTS9999
.
MRTS1100  WRITE     HTMLFILE;MRSTBCOD;  * Bar Code Number
          GOTO      MRTS9999
.
MRTS1200  WRITE     HTMLFILE;MRSTSTAT;  * Status Indicator
          GOTO      MRTS9999
.
MRTS1300  WRITE     HTMLFILE;MRSTUSAG;  * Usage Indicator              
          GOTO      MRTS9999
.
MRTS1400  CALL      STFTB000     * Table of Movement Reasons
          GOTO      MRTS9999
.
MRTS1500  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTS9999
.
MRTS1600  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTS9999
.
MRTS9999  RETURN
.-----------------------------------------------------------
. Option 4 - Bay Codes Mantenance
.-----------------------------------------------------------
MRTB0000  BRANCH    FLDITMNO,MRTB0100,MRTB0200,MRTB0300,MRTB0400,MRTB0500:
                             MRTB0600,MRTB0700
          GOTO      MRTB9999
.
MRTB0100  WRITE     HTMLFILE;SAVBAY;   * Location Code
          GOTO      MRTB9999
.
MRTB0200  CALL      URDIGS00   * Display UR digits for this Bay Code 
          GOTO      MRTB9999
.
MRTB0300  WRITE     HTMLFILE;BAYDESC;  * Description     
          GOTO      MRTB9999
.
MRTB0400  CALL      BAYTB000     * Table of Operating Rooms
          GOTO      MRTB9999
.
MRTB0500  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTB9999
.
MRTB0600  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTB9999
.
MRTB0700  CALL      LNKPRI00     * Redirect Routine 
          GOTO      MRTB9999
.
MRTB9999  RETURN
.-----------------------------------------------------------
. Option 5 - Medical Record Master Mantenance
.-----------------------------------------------------------
MRTA0000  BRANCH    FLDITMNO,MRTA0100,MRTA0200,MRTA0300,MRTA0400,MRTA0500:
                             MRTA0600,MRTA0700,MRTA0800,MRTA0900,MRTA1000:
                             MRTA1100,MRTA1200,MRTA1300,MRTA1400,MRTA1500:
                             MRTA1600,MRTA1700,MRTA1800,MRTA1900,MRTA2000:
                             MRTA2100,MRTA2200,MRTA2300,MRTA2400,MRTA2500:
                             MRTA2600,MRTA2700,MRTA2800,MRTA2900,MRTA3000:
                             MRTA3100,MRTA3200,MRTA3300,MRTA3400,MRTA3500:
                             MRTA3600,MRTA3700,MRTA3800,MRTA3900,MRTA4000:
                             MRTA4100,MRTA4200,MRTA4300,MRTA4400,MRTA4500:
                             MRTA4600,MRTA4700,MRTA4800,MRTA4900
          GOTO      MRTA9999
.
MRTA0100  WRITE     HTMLFILE;SMRURNO;    
          GOTO      MRTA9999
.
MRTA0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTA0210,MRTA0220,MRTA0240,MRTA0250
          PACK      KEY7,SMRHHOS,SMRHLOC,SP10                         *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=1
            PACK      MRLODESC,SMRHHOS,SMRHLOC,SP10
          ENDIF
          WRITE     HTMLFILE;MRLODESC;
          GOTO      MRTA9999
.
MRTA0210  WRITE     HTMLFILE;SMRHLOC;            * Home Location Code
          GOTO      MRTA9999
.
MRTA0220  PACK      KEY7,SP70                                         *C-240724 
          CALL      RDMRLOC1
MRTA0230  CALL      RKMRLOC1
          BRANCH    OVRCD,MRTA9999
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      MRTA0230
          ENDIF
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,SMRHLOC
          IF        @EQUAL
            MATCH     MRLOHOSP,SMRHHOS                                *I-240724
            GOTO      MRTA0232 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MRTA0232    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MRTA0230 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTA0230
.
MRTA0240  WRITE     HTMLFILE;SMRHHOS;            * Home Hospital Code *I-240724
          GOTO      MRTA9999
.
MRTA0250  PACK      KEY3,SMRHHOS                                      *I-240724
          CALL      RDPTHSP1
          BRANCH    OVRCD,MRTA9999
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      MRTA9999
.
MRTA0300  MOVE      "TY",CATEGORY
          MOVE      SMRDOTY,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTA0400  WRITE     HTMLFILE;SMRVOLN;    
          GOTO      MRTA9999
.
MRTA0500  MOVE      "RS",CATEGORY
          MOVE      SMRSTAT,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTA0600  WRITE     HTMLFILE;SMRCOMM;    
          GOTO      MRTA9999
.
MRTA0700  WRITE     HTMLFILE;SMRKEY;    
          GOTO      MRTA9999
.
MRTA0800  CALL      MASTB000     * Table of Record Master by U/R
          GOTO      MRTA9999
.
MRTA0900  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTA9999
.
MRTA1000  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTA9999
.
MRTA1100  WRITE     HTMLFILE;URNUMBER;    
          GOTO      MRTA9999
.
MRTA1200  CALL      HISTB000     * Table of History for a record
          GOTO      MRTA9999
.
MRTA1300  CALL      RESTB000     * Table of Reservations for a record
          GOTO      MRTA9999
.
MRTA1400  PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
MRTA1420  CALL      RKMRMAS1
          BRANCH    OVRCD,MRTA1490
          MATCH     URNUMBER,MRMAURNO
          GOTO      MRTA1490 IF NOT EQUAL
.
          MOVE      SP20,TDESC
          PACK      KEY5,CODETY,MRMADOTY
          CALL      RDCODE1
.
          PACK      KEY30,QUOTE,MRMAKEY,SP5,QUOTE
          MATCH     MRMAKEY,SMRKEY
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          ENDIF
          GOTO      MRTA1420
.
MRTA1490  MOVE      SMRKEY,KEY10
          CALL      RDMRMAS2
          GOTO      MRTA9999
.
MRTA1500  PACK      KEY6,SP70
          CALL      RSMRSTF1   
MRTA1520  CALL      RKMRSTF1
          BRANCH    OVRCD,MRTA9999
          PACK      KEY25,MRSTTITL,SP1,MRSTSNAM,SP1,MRSTGNAM
          PACK      KEY30,QUOTE,MRSTCODE,SP5,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY30,">",KEY25,"</option>"
          GOTO      MRTA1520
.
MRTA1600  PACK      KEY4,SP70
          CALL      RSMRMOV1
MRTA1620  CALL      RKMRMOV1
          BRANCH    OVRCD,MRTA9999
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      MRTA1620 IF EQUAL
.
          PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          GOTO      MRTA1620
.
MRTA1700  CALL      VISTB000
          GOTO      MRTA9999
.
MRTA1800  WRITE     HTMLFILE;ADMISSNO;  
          GOTO      MRTA9999
.
MRTA1900  CALL      MSDTB000
          GOTO      MRTA9999
.
MRTA2000  MOVE      "TY",CATEGORY
          MOVE      DOCMTYPE,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTA2100  CALL      MRTTAB00
          GOTO      MRTA9999
.
MRTA2200  PACK      SAVKEY20,SMRURNO,SMRHHOS,SMRHLOC,SMRDOTY,SMRVOLN,SP30
          WRITE     HTMLFILE;SAVKEY20;                                *C-240724
          GOTO      MRTA9999
.
MRTA2300  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
....      CALL      RDMRLOC1       * Default to home location of current 
....2310  CALL      RKMRLOC1       * record in mrtmasaf
....      BRANCH    OVRCD,MRTA9999
....
....      COMPARE   MRLOSTAT,ONE
....      IF        @EQUAL
....        GOTO      MRTA2310
....      ENDIF
....      MATCH     MRLOTYPE,MRCNHMTY
....      GOTO      MRTA2310 IF NOT EQUAL
....      PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
....      MATCH     MRLOCODE,SMRHLOC
....      IF        @EQUAL
....        MATCH     MRLOHOSP,SMRHHOS                                *I-240724
....        GOTO      MRTA2312 IF NOT EQUAL
....        WRITE     HTMLFILE;"<option value=",KEY15," selected>":
....                           MRLODESC,"</option>"
....      ELSE
....2312    IF        IBCNMHOS=1
....          MATCH     WBSEHOSP,MRLOHOSP
....          GOTO      MRTA2310 IF NOT EQUAL
....        ENDIF
....        WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
....      ENDIF
....      GOTO      MRTA2310
          GOTO      MRTA9999
.
MRTA2400  WRITE     HTMLFILE;SMRFILM;  
          GOTO      MRTA9999
.
MRTA2500  MOVE      "TY",CATEGORY
          MOVE      MRCNRCTY,DFLTRCTY
.
          MATCH     SP70,WBSEDTYP
          IF        !@EQUAL
            MOVE      WBSEDTYP,DFLTRCTY
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,MRTA2550
.
              MATCH     SP70,PTHSRCTY
              IF        !@EQUAL
                MOVE      PTHSRCTY,DFLTRCTY
              ENDIF
            ENDIF
          ENDIF
.
MRTA2550  MOVE      DFLTRCTY,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTA2600  MOVE      "RS",CATEGORY
          MOVE      MRCNSTAT,DFLTSTAT
.
          IF        IBCNMHOS=1
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,MRTA2650
.
            MATCH     SP70,PTHSSTAT
            IF        !@EQUAL
              MOVE      PTHSSTAT,DFLTSTAT
            ENDIF
          ENDIF
.
MRTA2650  MOVE      DFLTSTAT,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTA2700  MOVE      MRCNHLOC,DFLTHLOC   *Move Control File Variable to dummy var
....      MOVE      SP3,DFLTHHOS                                      *I-240724
....
....      First check if the user has Home Location then Default with that 
....      location.Else Check if Multi hospital exists then Read Hospital file 
....      and take  Home location and Default it. If it doesnt exists
....      take home location from control file and default it.
....
....      MATCH     SP70,WBSEHLOC
....      IF        !@EQUAL
....        MOVE      WBSEHLOC,DFLTHLOC
.....       MOVE      WBSEHHOS,DFLTHHOS
....      ELSE
....        IF        IBCNMHOS=1
....          PACK      KEY3,WBSEHOSP,SP70
....          CALL      RDPTHSP1
....          BRANCH    OVRCD,MRTA2705
....
....          MATCH     SP70,PTHSHHOS
....          IF        !@EQUAL
....            MOVE      PTHSHLOC,DFLTHLOC
....            MOVE      PTHSHHOS,DFLTHHOS
....          ENDIF
....        ENDIF
....      ENDIF 
....
....2705  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
....      CALL      RDMRLOC1       * Default to home location of current
....2710  CALL      RKMRLOC1       * record in mrtmasaf
....      BRANCH    OVRCD,MRTA9999
....      COMPARE   MRLOSTAT,ONE
....      IF        @EQUAL
....        GOTO      MRTA2710
....      ENDIF
....      MATCH     MRLOTYPE,MRCNHMTY
....      GOTO      MRTA2710 IF NOT EQUAL
....
....      PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
....      MATCH     MRLOCODE,DFLTHLOC  * Default Medical Records Home Location 
....      IF        @EQUAL
....        MATCH     MRLOHOSP,DFLTHHOS                               *I-240724
....        GOTO      MRTA2712 IF NOT EQUAL
....        WRITE     HTMLFILE;"<option value=",KEY15," selected>":
....                           MRLODESC,"</option>"
....      ELSE
....2712    IF        IBCNMHOS=1
....          MATCH     WBSEHOSP,MRLOHOSP
....          GOTO      MRTA2710 IF NOT EQUAL
....        ENDIF
....        WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
....      ENDIF
....      GOTO      MRTA2710
.
MRTA2800  WRITE     HTMLFILE;SELECTKY;
          GOTO      MRTA9999
.
MRTA2900  WRITE     HTMLFILE;PTCNRQCF;      * Free Format for Requested Para
          GOTO      MRTA9999
.
MRTA3000  MOVE      SP70,STAFFKEY           * Set Staff Key
          CALL      STFLST00                * Selection List of Mrt Staff
          GOTO      MRTA9999
.
MRTA3100  WRITE     HTMLFILE;IBCNMHOS;   
          GOTO      MRTA9999
.
MRTA3200  COMPARE   ONE,IBCNMHOS
          GOTO      MRTA9999 IF NOT EQUAL
.
          PACK      KEY7,SMRHHOS,SMRHLOC,SP10 * Home Location         *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTA9999
.
          PACK      KEY3,MRLOHOSP,SP10        * Multi Hospital
          CALL      RDPTHSP1
          BRANCH    OVRCD,MRTA9999
.
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      MRTA9999
.
MRTA3300  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
          CALL      RDMRLOC1       * Default to home location of current
MRTA3310  CALL      RKMRLOC1       * record in mrtmasaf
          BRANCH    OVRCD,MRTA9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      MRTA3310
          ENDIF
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      MRTA3310 IF NOT EQUAL
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,MRCNHLOC
          IF        @EQUAL
            MATCH     SP3,MRLOHOSP                                    *I-240724
            GOTO      MRTA3312 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MRTA3312    WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTA3310
.
MRTA3400  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
          CALL      RDMRLOC1       * Default to home location of current
MRTA3410  CALL      RKMRLOC1       * record in mrtmasaf
          BRANCH    OVRCD,MRTA9999 
.         
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      MRTA3410
          ENDIF
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      MRTA3410 IF NOT EQUAL
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,SMRHLOC
          IF        @EQUAL
            MATCH     MRLOHOSP,SMRHHOS                                *I-240724
            GOTO      MRTA3412 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
.
MRTA3412    MATCH     "1",SUPERLEV                                    *C-240124
            IF        @EQUAL
              PACK      KEY13,USERID,SP70            * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,MRLOHOSP,SP70 * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,MRTA3410
              ENDIF
              WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
              GOTO      MRTA3410
            ENDIF
.
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MRTA3410 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTA3410
.
MRTA3500  MOVE      MRCNHLOC,DFLTHLOC   *Move Control File Variable to dummy var
          MOVE      SP3,DFLTHHOS
.
.         First check if the user has Home Location then Default with that
.         location.Else Check if Multi hospital exists then Read Hospital file
.         and take  Home location and Default it. If it doesnt exists
.         take home location from control file and default it.
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHLOC,DFLTHLOC
            MOVE      WBSEHHOS,DFLTHHOS                               *I-240724
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,MRTA3505
.
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DFLTHHOS                           *I-240724
                MOVE      PTHSHLOC,DFLTHLOC
              ENDIF
            ENDIF
          ENDIF
.
MRTA3505  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
          CALL      RDMRLOC1       * Default to home location of current
MRTA3510  CALL      RKMRLOC1       * record in mrtmasaf
          BRANCH    OVRCD,MRTA9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      MRTA3510
          ENDIF
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      MRTA3510 IF NOT EQUAL
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,DFLTHLOC  * Default Medical Records Home Location
          IF        @EQUAL
            MATCH     MRLOHOSP,DFLTHHOS                               *I-240724
            GOTO      MRTA3512 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MRTA3512    MATCH     "1",SUPERLEV
            IF        @EQUAL
              PACK      KEY13,USERID,SP70            * All hospital access
              CALL      RDMLSEC1   
              IF        OVRCD=1    
                PACK      KEY13,USERID,MRLOHOSP,SP70 * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,MRTA3510
              ENDIF 
              WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
              GOTO      MRTA3510
            ENDIF
.
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MRTA3510 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTA3510
.
MRTA3600  WRITE     HTMLFILE;SUPERLEV;
          GOTO      MRTA9999
.
.                                                    * new routine    *I-240724
MRTA3700  MOVE      SP3,DFLTHHOS        * set Defaults for single Hospital Locn.
          MOVE      MRCNHLOC,DFLTHLOC
.
.         Check if the user has Home Hospital &/or Location, if so, set Defaults
.         Otherwise, check if Multi Hospital exists then Read Hospital file
.         and use Home Hospital and Home Location.
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHHOS,DFLTHHOS
            MOVE      WBSEHLOC,DFLTHLOC
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,MRTA3705
.
              MOVE      WBSEHOSP,DFLTHHOS        * default to User logged into
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DFLTHHOS
                MOVE      PTHSHLOC,DFLTHLOC
              ENDIF
            ENDIF
          ENDIF
.
MRTA3705  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTA3706
          WRITE     HTMLFILE;DFLTHHOS;      * Default Home Hospital Id Code
          GOTO      MRTA9999
MRTA3706  WRITE     HTMLFILE;DFLTHLOC;      * Default Home Location Code
          GOTO      MRTA9999
.         
.
MRTA3800  MOVE      SMRHHOS,SELHOSP         * Home Hospital+pull down (MRTMS008)
          MOVE      ONE,DOSELHOS            * Do not default from user id
          CALL      HSEL0000    
          GOTO      MRTA9999
.
MRTA3900  WRITE     HTMLFILE;WBSEHOSP;      * User Hospital Code
          GOTO      MRTA9999
.
MRTA4000  WRITE     HTMLFILE;TRANSFLG;      * Redirect to bed transfer page
          GOTO      MRTA9999
.
MRTA4100  WRITE     HTMLFILE;DISCHFLG;      * Redirect from discharge page
          GOTO      MRTA9999
.
MRTA4200  CALL      HSLC0000
          GOTO      MRTA9999
.
MRTA4300  MATCH     " 0",SMRVOLN            * Don;t display zero volume
          GOTO      MRTA9999 IF EQUAL
.
          WRITE     HTMLFILE;SMRVOLN;
          GOTO      MRTA9999
.
MRTA4400  MATCH     SP70,SMRUSCR
          GOTO      MRTA9999 IF EQUAL
.
          PACK      KEY10,SMRUSCR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
             WRITE     HTMLFILE;WBSENAM;
          ENDIF
.
          GOTO      MRTA9999
.
MRTA4500  MATCH     SP70,SMRDTCR
          GOTO      MRTA9999 IF EQUAL
.
          UNPACK    SMRDTCR,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTA9999
.
MRTA4600  MATCH     SP70,SMRTMCR
          GOTO      MRTA9999 IF EQUAL
.
          WRITE     HTMLFILE;SMRTMCR;
          GOTO      MRTA9999
.
MRTA4700  MATCH     SP70,SMRUSUP
          GOTO      MRTA9999 IF EQUAL
.
          PACK      KEY10,SMRUSUP,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM
          ENDIF
.
          GOTO      MRTA9999
.
MRTA4800  MATCH     SP70,SMRDTUP
          GOTO      MRTA9999 IF EQUAL
.
          UNPACK    SMRDTUP,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTA9999
.
MRTA4900  MATCH     SP70,SMRTMUP
          GOTO      MRTA9999 IF EQUAL
.
          WRITE     HTMLFILE;SMRTMUP;
          GOTO      MRTA9999
.
MRTA9999  RETURN
.-----------------------------------------------------------
. Option 6 - Medical Record Reservation Mantenance
.-----------------------------------------------------------
MRTR0000  BRANCH    FLDITMNO,MRTR0100,MRTR0200,MRTR0300,MRTR0400,MRTR0500:
                             MRTR0600,MRTR0700,MRTR0800,MRTR0900
          GOTO      MRTR9999
.
MRTR0100  WRITE     HTMLFILE;MRRSKEY;    
          GOTO      MRTR9999
.
MRTR0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTR0250
          UNPACK    MRRSDATE,CCENT,CYEAR,CMON,CDAY   * To Date in (DD MON CCYY)
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY12;
          GOTO      MRTR9999

MRTR0250  WRITE     HTMLFILE;MRRSDATE;
          GOTO      MRTR9999
.
MRTR0300  WRITE     HTMLFILE;MRRSTIME;    
          GOTO      MRTR9999
.
MRTR0400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTR0410,MRTR0420
          PACK      KEY7,MRRSRHOS,MRRSDEPT                            *C-240724
          CALL      RDMRLOC1
          WRITE     HTMLFILE;MRLODESC;
          GOTO      MRTR9999
.
MRTR0410  WRITE     HTMLFILE;MRRSDEPT;
          GOTO      MRTR9999
.
MRTR0420  PACK      KEY7,SP70                                         *C-240724
          CALL      RDMRLOC1
MRTR0430  CALL      RKMRLOC1
          BRANCH    OVRCD,MRTR9999
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,MRRSDEPT
          IF        @EQUAL
            MATCH     MRLOHOSP,MRRSRHOS                               *I-240724
            GOTO      MRTR0432 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
MRTR0432    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      MRTR0430 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTR0430
.
MRTR0500  MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      CODITM00
          GOTO      MRTA9999
.
MRTR0600  WRITE     HTMLFILE;MRMAVOLN;    
          GOTO      MRTA9999
.
MRTR0700  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTA9999
.
MRTR0800  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTA9999
.
MRTR0900  CALL      RESTB000     * Table of Reservations for a record
          GOTO      MRTA9999
.
MRTR9999  RETURN
.-----------------------------------------------------------
. Option 9- Medical Records Movements Mantenance
.-----------------------------------------------------------
MRTV0000  BRANCH    FLDITMNO,MRTV0100,MRTV0200,MRTV0300,MRTV0400,MRTV0500:
                             MRTV0600,MRTV0700
          GOTO      MRTV9999
.
MRTV0100  CALL      SELLOC00                * Selection List of Locations
          GOTO      MRTV9999

MRTV0200  MOVE      "TY",CATEGORY           * Selection List of Documents
          IF       IBCNMHOS=1
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD<>1
              MOVE      PTHSRCTY,CODE
            ENDIF
          ELSE
            MOVE     MRCNRCTY,CODE
          ENDIF
.
          MATCH     SP70,WBSEDTYP
          IF        !@EQUAL
            MOVE      WBSEDTYP,CODE
          ENDIF
.
          CALL      CODITM00
          GOTO      MRTV9999
.
MRTV0300  WRITE     HTMLFILE;WBSENAM;       * User Name
          GOTO      MRTV9999
.
MRTV0400  CALL      SELREA00       * Selection List of Reasons
          GOTO      MRTV9999

MRTV0500  MOVE      "CP",CATEGORY           * Selection List of Post Discharge
          CALL      CODITM00
          GOTO      MRTV9999
.
MRTV0600  CALL      LOCDEF00                * Selection List of Locations
          GOTO      MRTV9999
.
MRTV0700  WRITE     HTMLFILE;SUPERLEV;      * Supervisor flag
          GOTO      MRTV9999
.
MRTV9999 RETURN
.----------------------------------------------------------------
.  Outputs a selection list of MRT Staff
.                   ******** STFLST00 ********
.----------------------------------------------------------------
STFLST00  PACK      KEY6,STAFFKEY,SP70
          CALL      RSMRSTF1
STFLST10  CALL      RKMRSTF1
          BRANCH    OVRCD,STFLST99
.
          COMPARE   MRSTSTAT,ONE    * Checks for Active Staff only
          IF        @EQUAL
            GOTO      STFLST10
          ENDIF
.
          PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
.
          MATCH     STAFFKEY,MRSTCODE    * Default Staff Code
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#" selected>":
                                 KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#">":
                                 KEY50,"</option>"
          ENDIF
.
          GOTO    STFLST10
.
STFLST99  RETURN
.--------------------------------------------------------------------------
.                Selection List of Reasons 
.  .0 = List of Reason of Admission with match on CGI parameter
.  .1 = Defualt Selected to Admission
.  .2 = List of reasons with type,reason indicators and usage indicators
.  .3 = Defualt Selected to Admission
.       List of reasons with type,reason indicators and usage indicators
.--------------------------------------------------------------------------
SELREA00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          IF        F1=1 | F1=3
            MOVE      "A   ",SELECTED
          ELSE
            MOVE      MRTME005,SELECTED
          ENDIF
.
          PACK      KEY4,SP70               
          CALL      RSMRMOV1
SELREA10  CALL      RKMRMOV1
          BRANCH    OVRCD,SELREA99
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      SELREA10 IF EQUAL
.
          IF        F1=2 | F1=3
            PACK      KEY30,QUOTE,MRMOREAS,MRMOTYPE,MRMOINDC,MRMOUSAG:
                            MRMOPERD,QUOTE
          ELSE
            PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          ENDIF
.
          MATCH     MRMOREAS,SELECTED
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               MRMODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          ENDIF
          GOTO      SELREA10
.
SELREA99  RETURN
.--------------------------------------------------------------------------
.    Selection List of Locations with Defaulted Medical record Location
.    Read Visit Extension File to retrieve Admitting Point then retrieve 
.    MR Location from Admitting Point if blank then Read Ward file 
.--------------------------------------------------------------------------
LOCDEF00  MOVE      SP70,MEDILOCN
          MOVE      SP70,MEDIHOSN                                     *I-240724
.
          PACK      KEY8,ADMISSNO,SP70        * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,LOCDEF99
.
          PACK      KEY8,AADMNO,SP70          * Reads Visit Extention file
          CALL      RDPMVX11
          BRANCH    OVRCD,LOCDEF99
.
          IF        ASTAT=ONE
            PACK      KEY5,CODEAP,PMVXAPWD,SP70  * Retreive MRT Location from 
            CALL      RDCODE1                    * Admitting Point
            BRANCH    OVRCD,LOCDEF10
.
            MATCH     SP70,PTCDNHCP
            IF        @EQUAL
              PACK      KEY6,THCSCOD,SP70     *  Read Ward to get mr location
              CALL      RDWARD1
              BRANCH    OVRCD,LOCDEF10
              MOVE      PTWDHOSN,MEDIHOSN                             *I-240724
              MOVE      PTWDLOCN,MEDILOCN     * Set MR Location

            ELSE
              MOVE      PTCDNHCP,MEDILOCN     * Use Admitting Point Location
              MOVE      PTWDHOSN,MEDIHOSN                             *I-240724
            ENDIF
          ELSE
            PACK      KEY6,AWARD,SP70         * I CAR 41687
            CALL      RDWARD1
            BRANCH    OVRCD,LOCDEF10
            MOVE      PTWDLOCN,MEDILOCN       * end I CAR 41687
            MOVE      PTWDHOSN,MEDIHOSN                               *I-240724
          ENDIF
.
LOCDEF10  PACK      KEY7,SP70                                         *C-240724
          CALL      RDMRLOC1
LOCDEF20  CALL      RKMRLOC1
          BRANCH    OVRCD,LOCDEF99
.
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      LOCDEF20
          ENDIF
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,MEDILOCN  * Medical Record Location
          IF        @EQUAL
            MATCH     MRLOHOSP,MEDIHOSN                               *I-240724
            GOTO      LOCDEF22 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
LOCDEF22    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      LOCDEF20 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      LOCDEF20

LOCDEF99  RETURN                 
.--------------------------------------------------------------------------
.           Selection List of Locations
.--------------------------------------------------------------------------
SELLOC00  UNPACK    DIM127,D1,KEY1,DIM127    
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SELLOC10,SELLOC20,SELLOC60
          PACK      KEY7,MRTME019,MRTME003                            *C-240724
          CALL      RDMRLOC1
          WRITE     HTMLFILE;MRLODESC;
          GOTO      SELLOC99
.
SELLOC10  WRITE     HTMLFILE;SMRHLOC;        * Hom location code 
          GOTO      MRTM9999
.
SELLOC20  IF        PTCNNHII=1
            GOTO      SELLOC40      * I CAR 38495
          ENDIF
.
          PACK      KEY37,SP70                                         *C-240724
          CALL      RDMRLOC3
SELLOC30  CALL      RKMRLOC3
          BRANCH    OVRCD,SELLOC99
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      SELLOC30
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,MRLOHOSP
            GOTO      SELLOC30 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#"";
          MATCH     MRLOCODE,MRTME003
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",MRLODESC,"</option>"
          GOTO      SELLOC30
.
SELLOC40  PACK      KEY6,TRNTOWRD,SP70        * I CAR 38495
          CALL      RDWARD1
          IF        OVRCD=1
            MOVE      SP70,PTWDLOCN
          ENDIF
.
          PACK      KEY37,SP70
          CALL      RDMRLOC3
SELLOC50  CALL      RKMRLOC3
          BRANCH    OVRCD,SELLOC99
          COMPARE   MRLOSTAT,ONE              * Checks for Active locations only
          IF        @EQUAL
            GOTO      SELLOC50
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,MRLOHOSP
            GOTO      SELLOC50 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#"";
          MATCH     MRLOCODE,PTWDLOCN
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",MRLODESC,"</option>"
          GOTO      SELLOC50 
.
SELLOC60  WRITE     HTMLFILE;MRTME003;
          GOTO      SELLOC99
.
SELLOC99  RETURN                 
.-----------------------------------------------------------
. Option 9- Medical Records Single Movement
.-----------------------------------------------------------
MOVT0000  BRANCH    FLDITMNO,MOVT0100,MOVT0200,MOVT0300,MOVT0400,MOVT0500:
                             MOVT0600,MOVT0700,MOVT0800,MOVT0900
          GOTO      MRTH9999
.
MOVT0100  WRITE     HTMLFILE;WBSENAM;       * User Name
          GOTO      MOVT9999
.
MOVT0200  CALL      SRMTB000                * Table of Locations
          GOTO      MOVT9999
.
MOVT0300  WRITE     HTMLFILE;URNUMBER;      
          GOTO      MOVT9999
.
MOVT0400  MATCH     SP70,MRTME010
          IF        @EQUAL
            MOVE      "TY",CATEGORY           * Selection List of Documents
            MOVE      MRCNRCTY,CODE
.
            MATCH     SP70,WBSEDTYP
            IF        !@EQUAL
              MOVE      WBSEDTYP,CODE
            ENDIF
.
            CALL      CODITM00
          ELSE
            MOVE      "TY",CATEGORY           * Selection List of Documents
            MOVE      MRTME010,CODE
            CALL      CODITM00
          ENDIF
          GOTO      MOVT9999
.
MOVT0500  WRITE     HTMLFILE;MRCNWNHL;        * I CAR 43134
          GOTO      MOVT9999
.
MOVT0600  WRITE     HTMLFILE;REGIFLAG;
          GOTO      MOVT9999
.
.                                             * Hospital list (with security)
MOVT0700  MATCH     SP70,DESTHOSP             * filtered on DESTHOS
          IF        @EQUAL
            MOVE      WBSEHOSP,DESTHOSP       * default to "Logged in Hospital"
          ENDIF
          MOVE      DESTHOSP,SELHOSP
          CALL      HSEL0000
          GOTO      MOVT9999
.
.                                             * Hospital list (with security)
MOVT0800  MATCH     SP70,FILTHOSP             * filtered on FILTHOSP
          MOVE      FILTHOSP,SELHOSP
          CALL      HSEL0000
          GOTO      MOVT9999
.                                             * Hospital list (with security)
MOVT0900  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          MOVE      PTHSHHOS,SELHOSP          * default to User's Home Hospital
          MOVE      ONE,DOSELHOS              * da fix
          CALL      HSEL0000
          GOTO      MOVT9999
.
.
MOVT9999 RETURN
.-----------------------------------------------------------
. Option 10- Medical Records Movements Mantenance
.-----------------------------------------------------------
MRTH0000  BRANCH    FLDITMNO,MRTH0100,MRTH0200,MRTH0300,MRTH0400,MRTH0500
          GOTO      MRTH9999
.
MRTH0100  PACK      KEY7,MRHIDHOS,MRHILOC          * Location         *I-240724
          CALL      RDMRLOC1
          MATCH     MRMAOHOS,MRHIDHOS       * check if in Orig. Hosp  *I-240724
          IF        @EQUAL
            PACK      KEY70,MRLODESC,SP70
          ELSE
            PACK      KEY70,MRLODESC,OBR,MRMACHOS,CBR,SP70   * red
          ENDIF
          WRITE     HTMLFILE;KEY70;                                   *C-240724
          GOTO      MRTH9999
.
MRTH0200  PACK      KEY4,MRHIREAS         * Reason
          CALL      RDMRMOV1
          WRITE     HTMLFILE;MRMODESC;
          GOTO      MRTH9999

MRTH0300  WRITE     HTMLFILE;MRHITIME;    * Time
          GOTO      MRTH9999
.
MRTH0400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTH0410
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY    * Date
          MOVE      CMON,F2                    
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY12;
          GOTO      MRTH9999
.
MRTH0410  WRITE     HTMLFILE;MRHIDATE;
          GOTO      MRTH9999
.
MRTH0500  WRITE     HTMLFILE;MRHIKEY;
          GOTO      MRTH9999
.
MRTH9999  RETURN
.-----------------------------------------------------------
. Option 11- Medical Records Template Heading Mantenance
.-----------------------------------------------------------
MRTT0000  BRANCH    FLDITMNO,MRTT0100,MRTT0200,MRTT0300,MRTT0400,MRTT0500:
                             MRTT0600
          GOTO      MRTT9999
.
MRTT0100  WRITE     HTMLFILE;MRTHTMID;  * Template ID 
          GOTO      MRTT9999
.
MRTT0200  WRITE     HTMLFILE;MRTHDESC;  * Description
          GOTO      MRTT9999
.
MRTT0300  WRITE     HTMLFILE;MRTHACTV;  * Active Indicator           
          GOTO      MRTT9999
.
MRTT0400  CALL      THDTB000     * Table of Med Rec Template Headings 
          GOTO      MRTT9999
.
MRTT0500  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTT9999
.
MRTT0600  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTT9999
.
MRTT9999  RETURN
.-----------------------------------------------------------
. Option 12 - Medical Record Template Details Mantenance
.-----------------------------------------------------------
MRTD0000  BRANCH    FLDITMNO,MRTD0100,MRTD0200,MRTD0300,MRTD0400,MRTD0500:
                             MRTD0600,MRTD0700,MRTD0800,MRTD0900,MRTD1000:
                             MRTD1100,MRTD1200,MRTD1300,MRTD1400,MRTD1500:
                             MRTD1600,MRTD1700,MRTD1800,MRTD1900,MRTD2000
          GOTO      MRTD9999
.
MRTD0100  WRITE     HTMLFILE;MRTDTMNO;    
          GOTO      MRTR9999
.
MRTD0200  WRITE     HTMLFILE;MRTDRECT;    
          GOTO      MRTR9999
.
MRTD0300  WRITE     HTMLFILE;MRTDSEQN;
          GOTO      MRTR9999
.
MRTD0400  WRITE     HTMLFILE;MRTDDEST;    
          GOTO      MRTA9999
.
MRTD0500  WRITE     HTMLFILE;MRTDDECD;    
          GOTO      MRTA9999
.
MRTD0600  WRITE     HTMLFILE;MRTDDESC;    
          GOTO      MRTA9999
.
MRTD0700  CALL      NEXTPR00     * Link to Next Set of Codes 
          GOTO      MRTA9999
.
MRTD0800  CALL      PREVPR00     * Link to Prev Set of Codes 
          GOTO      MRTA9999
.
MRTD0900  CALL      TDTTB000     * Table of Medical Records Disease Codes 
          GOTO      MRTA9999
.
MRTD1000  CALL      TOPTB000     * Table of Medical Records Operational Codes 
          GOTO      MRTA9999
.
MRTD1100  WRITE     HTMLFILE;CMDISP;  * Prefix for a Primary Diagnosis
          GOTO      MRTD9999
.
MRTD1200  WRITE     HTMLFILE;CMDISS;  * Prefix for a Sequela Diagnosis
          GOTO      MRTD9999
.
MRTD1300  WRITE     HTMLFILE;CMDISC;  * Prefix for a Complication Diagnosis
          GOTO      MRTD9999
.
MRTD1400  WRITE     HTMLFILE;CMDISA;  * Prefix for a Associated Diagnosis
          GOTO      MRTD9999
.
MRTD1500  WRITE     HTMLFILE;CMDISL;  * Prefix for disease responsible for
          GOTO      MRTD9999          * Length of Stay
.
MRTD1600  WRITE     HTMLFILE;CMDISD;  * Disability disease type
          GOTO      MRTD9999
.
MRTD1700  WRITE     HTMLFILE;CMOPRT;  * Post-Surgical operation type
          GOTO      MRTD9999
.
MRTD1800  WRITE     HTMLFILE;CMDISM;  * Prefix for a Morphology Diagnosis
          GOTO      MRTD9999
.
MRTD1900  WRITE     HTMLFILE;EPSCD001;      * Episode Number
          GOTO      MRTD9999
.
MRTD2000  WRITE     HTMLFILE;MRTDDCID;      * Diagnosis Cluster Id
          GOTO      MRTD9999
.
MRTD9999  RETURN
.-----------------------------------------------------------
. Display All UR Digits for BAY CODE 
.-----------------------------------------------------------
URDIGS00  PACK      KEY5,SAVBAY,SP70
URDIGS10  CALL      RDSBAYS1
          CALL      RDKBAYS1 
          BRANCH    OVRCD,URDIGS99
          MATCH     SAVBAY,BAYCODE
          GOTO      URDIGS99 IF NOT EQUAL
          WRITE     HTMLFILE;BAYUR;     * Last Two Digits of U/R
          MOVE      BAYUR,SAVUR
          CALL      RDKBAYS1            * Check for another record
          BRANCH    OVRCD,URDIGS99
          MATCH     SAVBAY,BAYCODE
          GOTO      URDIGS99 IF NOT EQUAL
          WRITE     HTMLFILE;",";        * Write "," if another record exists
          PACK      KEY5,SAVBAY,SAVUR,SP70
          GOTO      URDIGS10
.
URDIGS99  RETURN
.-----------------------------------------------------------
. Link to Next Group Codes           
.-----------------------------------------------------------
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       " +",FILTACTV
          REP       " +",FILTHOSP
.
          WRITE     HTMLFILE;"mrtweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY:
                                 "&filtactv=",FILTACTV:
                                 "&filthosp=",FILTHOSP:
                                 "&superlev=",SUPERLEV;
.
          REP       "+ ",STARTKEY
          REP       "+ ",FILTACTV
          REP       "+ ",FILTHOSP
.
NEXTPR99  RETURN
.-----------------------------------------------------------
. Link to Prev Group Codes           
.-----------------------------------------------------------
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       " +",FILTACTV
          REP       " +",FILTHOSP
.
          WRITE     HTMLFILE;"mrtweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY:
                                 "&filtactv=",FILTACTV:
                                 "&filthosp=",FILTHOSP:
                                 "&superlev=",SUPERLEV;
.
          REP       "+ ",STARTKEY
          REP       "+ ",FILTACTV
          REP       "+ ",FILTHOSP
.
PREVPR99  RETURN
.-----------------------------------------------------------
. Link for Redirect            
.-----------------------------------------------------------
LNKPRI00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127

          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;LINKPRG,"#.pbl":
                                 "?reportno=",LINKREP:
                                 "&template=",LINKTEM:
                                 "&baycd001=",SAVBAY; 
.
LNKPRI99  RETURN
.------------------------------------------------------------
. Table of Medical Record Single Movement
.------------------------------------------------------------
SRMTB000  MOVE      ZERO,KIDSFLAG
          UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      DIM1,KIDSFLAG
.
          MOVE      ZERO,COUNT
....        CALL      MASHD000      * Output Table Heading
.
          MOVE      SP10,WBSEHOSP                                     *I-240724
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
            MOVE      SP3,PTHSHHOS
            PACK      KEY3,WBSEHOSP
            CALL      RDPTHSP1
            MOVE      PTHSHHOS,ALTHOHOS
          ENDIF
.
          PACK      KEY20,URNUMBER,Z70
          CALL      RDMRMAS3
SRMTB100  CALL      RPMRMAS3
          BRANCH    OVRCD,SRMTB999
.
          MATCH     URNUMBER,MRMAURNO
          IF        !@EQUAL
            GOTO      SRMTB999
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            IF        !@EQUAL
              MATCH     WBSEHOSP,MRMAHHOS   * is Users Hosp = MR Home Hosp
              GOTO      SRMTB150 IF EQUAL
              MATCH     WBSEHOSP,MRMAOHOS   * is User Hosp = Originating Hosp
              GOTO      SRMTB150 IF EQUAL
              MATCH     ALTHOHOS,MRMAHHOS   * is Alt Home Hosp = MR Home Hosp
              GOTO      SRMTB150 IF EQUAL
              GOTO      SRMTB100
            ENDIF
          ENDIF 
.                                                                     *I-248690
SRMTB150  MATCH     SP10,FILTHOSP           * filter on Originating Hospital
          IF        !@EQUAL
            MATCH     FILTHOSP,MRMAOHOS     * 
            GOTO      SRMTB100 IF NOT EQUAL
          ENDIF
.
          MATCH     "All",MRTME010
          IF        !@EQUAL
            MATCH     SP70,MRTME010
            IF        !@EQUAL
              MATCH     MRMADOTY,MRTME010
              IF        !@EQUAL
                GOTO      SRMTB100
              ENDIF 
            ELSE
              MATCH     SP70,WBSEDTYP
              IF        !@EQUAL
                MATCH     MRMADOTY,WBSEDTYP
                IF        !@EQUAL
                  GOTO      SRMTB100
                ENDIF
              ELSE  
                MATCH     MRMADOTY,MRCNRCTY
                IF        !@EQUAL
                  GOTO      SRMTB100
                ENDIF 
              ENDIF
            ENDIF
          ENDIF 
.
SRMTB300  MOVE      SP70,MRLODESC           * Home Location
          MOVE      SP70,HMLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC                            *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
....        MATCH     MRMAOHOS,MRMAHHOS
....        IF        !@EQUAL
....          PACK      KEY30,OBR,MRMAOHOS,CBR,SP20  * red
....          APPEND    KEY30,KEY70
....        ENDIF
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
SRMTB400  MOVE      SP70,MRLODESC           * Current Location
          PACK      KEY7,MRMACHOS,MRMACLOC                            *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRMACHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRMACHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRMACHOS            * current hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * same as the home hospital?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRMACHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRMACHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC2                          * end     *I-240724
.
          MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20A                                      *C-240724
.
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        @EQUAL
            MOVE      "&nbsp;",TDESC
          ENDIF
.
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,DMRMAVOL
.
.  * Using Kids template
.
          BRANCH    KIDSFLAG,SRMTB500
.
          WRITE     HTMLFILE;"<tr><td width=20%>&nbsp;",DIM20A,"</td>":
                         "<td width=25%>",HLOCDSC1,"</td>":
                         "<td width=8% align=center>",MRMAVOLN,"</td>":
                         "<td width=30%>",KEY70,"</td>":
                         "<td width=25%><span style=color:",PTCDUDF3,">":
                         TDESC,"</span></td>":
                         "<td width=10%><input type=checkbox name=mrkeyarr":
                         " value='",KEY20,"'></td></tr>"
.
          GOTO      SRMTB600
.
SRMTB500  WRITE     HTMLFILE;"<tr><td width=25%>",DIM20A,"</td>":
                         "<td width=7%>",MRMAVOLN,"</td>":
                         "<td width=33%>",HLOCDSC2,"</td>":
                         "<td width=16%><span style=color:",PTCDUDF3,">":
                         TDESC,"</span></td>":
                         "<td width=7%>","<input type=checkbox name=mrkeyarr":
                         " value='",KEY20,"'></td></tr>"
.
SRMTB600  ADD       ONE,COUNT
          COMPARE   "99",COUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=6><font size=3>":
                               "Limit of 99 records reached!</td></tr>"; 
            GOTO      SRMTB999
          ENDIF 
          GOTO      SRMTB100
.
SRMTB999  RETURN
.------------------------------------------------------------
. Location Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
MASHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Volume</td>":
                               "<td class=HeadingCell>":
                               "Current Location</td>":
                               "<td class=HeadingCell>":
                               "Status</td>":
                               "<td class=HeadingCell>":
                               "Required</td>":
                             "</tr>"
.
MASHD999  RETURN
.------------------------------------------------------------
. Table of Tracking Locations by Code
.------------------------------------------------------------
MRTTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MRHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD     * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV                                    *I-240724
            IF        !@EQUAL
              PACK      KEY10,USERID,SP10   * not Super User, login Hosp only
              CALL      RDWBSE1
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ELSE
            UNPACK    SP20,FILTHOSP
          ENDIF
.
          PACK      KEY7,STARTKEY,SP70                       *C-240724
          CALL      RDMRLOC4
          IF        OVRCD<>1
            GOTO      MRTTB110
          ENDIF
.
MRTTB100  CALL      RKMRLOC4
          BRANCH    OVRCD,MRTTB900
.
MRTTB110  MATCH     SP70,FILTACTV
          IF        !@EQUAL
            MOVE      FILTACTV,F1
            COMPARE   F1,MRLOSTAT
            GOTO      MRTTB100 IF NOT EQUAL
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
...       GOTO      MRTTB200 IF NOT EQUAL
          IF        @EQUAL
            MATCH     SP3,MRLOHOSP
            GOTO      MRTTB100 IF EQUAL     * don't process if blank Hospital.
          ELSE
            MATCH     SP3,MRLOHOSP
            GOTO      MRTTB100 IF NOT EQUAL * don't process Locations with Hosp.
            GOTO      MRTTB200
          ENDIF
.                                           * check for User Id's access
          MATCH     SP70,FILTHOSP
          IF        @EQUAL
            PACK      KEY13,USERID,SP70              * All hospital access?
            CALL      RDMLSEC1
            IF        OVRCD = 1
              PACK      KEY13,USERID,MRLOHOSP,SP70   * This hospital access?
              CALL      RDMLSEC1
              BRANCH    OVRCD,MRTTB100
            ENDIF
          ELSE
            MATCH     FILTHOSP,MRLOHOSP              * Filter Hospital
            GOTO      MRTTB100 IF NOT EQUAL
          ENDIF
.
MRTTB200  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MRTTB100
          ENDIF
.
          CALL      MRTRW000    * Display Locations Mantenance Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MRTTB100 IF NOT EQUAL
          GOTO      MRTTB999
.
MRTTB900  CALL      NOMORE00    * Display No More Records Message
.
MRTTB999  RETURN
.
.------------------------------------------------------------
. Table of Tracking Locations by Name
.------------------------------------------------------------
MRTTD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MRHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MATCH     "1",SUPERLEV                                      *I-240724
          IF        !@EQUAL
            PACK      KEY10,USERID,SP10     * not Super User, login Hosp only
            CALL      RDWBSE1
            MOVE      WBSEHOSP,FILTHOSP
          ENDIF
.
          PACK      KEY37,STARTKEY,SP70                               *C-240724
          CALL      RDMRLOC3
          IF        OVRCD=0
            GOTO      MRTTD110
          ENDIF
MRTTD100  CALL      RKMRLOC3
          BRANCH    OVRCD,MRTTD900
.
MRTTD110  MATCH     SP70,FILTACTV
          IF        !@EQUAL
            MOVE      FILTACTV,F1
            COMPARE   F1,MRLOSTAT
            GOTO      MRTTD100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,MRLOHOSP
            GOTO      MRTTD100 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MRTTD100
          ENDIF
.
          CALL      MRTRW000    * Display Locations Mantenance Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MRTTD100 IF NOT EQUAL
          GOTO      MRTTD999
.
MRTTD900  CALL      NOMORE00    * Display No More Records
.
MRTTD999  RETURN
.------------------------------------------------------------
. Location Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
MRHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "Location Code</td>":
                               "<td class=HeadingCell width=30%>":
                               "Description</td>":
                               "<td class=HeadingCell width=30%>":
                               "Type</td>":
                               "<td class=HeadingCell width=10%>":
                               "Status</td>";
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                               "Hospital</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
MRHED999  RETURN
.------------------------------------------------------------
. Locations Maintenance (TABLE ROW)
.------------------------------------------------------------
MRTRW000  MATCH     SP70,MRLOTYPE
          IF        @EQUAL
            MOVE      "&nbsp",TDESC 
          ELSE
            MOVE      "LT",CATEGORY
            MOVE      MRLOTYPE,CODE 
            CALL      GETCOD00
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      SP70,PTHSNAME
            MATCH     SP70,MRLOHOSP
            IF        !@EQUAL
              PACK      KEY3,MRLOHOSP,SP10        * Multi Hospital
              CALL      RDPTHSP1
              IF        OVRCD=1
                MOVE      MRLOHOSP,PTHSNAME
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ZERO,MRLOSTAT
          IF        @EQUAL
            MOVE      "Active",KEY8
          ELSE
            MOVE      "Inactive",KEY8
          ENDIF
.
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail01":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mrtlc009=",MRLOHOSP:
                             "&mrtlc001=",MRLOCODE:
                             "&superlev=",SUPERLEV,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             MRLOCODE,"</td>":
                             "<td>",MRLODESC,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td>",KEY8,"</td>";
.
         IF         IBCNMHOS=1
           WRITE      HTMLFILE;"<td>",PTHSNAME,"&nbsp;</td>";
         ENDIF
.
         WRITE      HTMLFILE;"</tr>";
.
MRTRW999 RETURN
.------------------------------------------------------------
. Table of Movement Reasons 
.------------------------------------------------------------
MOVTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MVHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY4,STARTKEY,SP70
          CALL      RSMRMOV1
          IF        OVRCD=0
            CALL      RPMRMOV1
          ENDIF
MOVTB100  CALL      RKMRMOV1
          BRANCH    OVRCD,MOVTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MOVTB100
          ENDIF
.
          CALL      MRTMV000    * Display Movement Reasons Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MOVTB100 IF NOT EQUAL
          GOTO      MOVTB999
.
MOVTB900  CALL      NOMORE00    * Display No More Records Message
.
MOVTB999  RETURN
.------------------------------------------------------------
. Movement Reasons Table Details (TABLE HEADING)
.------------------------------------------------------------
MVHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "Movement Code</td>":
                               "<td class=HeadingCell width=35%>":
                               "Description</td>":
                               "<td class=HeadingCell width=35%>":
                               "Borrowing Period (Days)</td>":
                             "</tr>"
.
MVHED999  RETURN
.------------------------------------------------------------
. Movement Reasons (TABLE ROW)
.------------------------------------------------------------
MRTMV000  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mrtmv001=",MRMOREAS,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             MRMOREAS,"</td>":
                             "<td>",MRMODESC,"&nbsp;</td>":
                             "<td>",MRMOPERD,"&nbsp;</td>":
                             "</tr>";
.
MRTMV999  RETURN 
.------------------------------------------------------------
. Table of Staff Register 
.------------------------------------------------------------
STFTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      STHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY6,STARTKEY,SP70
          CALL      RDMRSTF1
          IF        OVRCD=0
            CALL      RPMRSTF1     
          ENDIF
.
STFTB100  CALL      RKMRSTF1
          BRANCH    OVRCD,MOVTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      STFTB100
          ENDIF
.
          CALL      MRTST000    * Display Staff Register Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      STFTB100 IF NOT EQUAL
          GOTO      STFTB999
.
STFTB900  CALL      NOMORE00    * Display No More Records Message
.
STFTB999  RETURN
.------------------------------------------------------------
. Staff Register Table Details (TABLE HEADING)
.------------------------------------------------------------
STHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Staff Code</td>":
                               "<td class=HeadingCell width=25%>":
                               "Surname</td>":
                               "<td class=HeadingCell width=25%>":
                               "Given Name</td>":
                               "<td class=HeadingCell width=15%>":
                               "Position</td>":
                               "<td class=HeadingCell width=15%>":
                               "Status</td>":
                             "</tr>"
.
STHED999  RETURN
.------------------------------------------------------------
. Staff Register (TABLE ROW)
.------------------------------------------------------------
MRTST000  COMPARE   ZERO,MRSTSTAT
          IF        @EQUAL
            MOVE      "Active",KEY10 
          ELSE
            MOVE      "Not Active",KEY10 
          ENDIF
.
          MATCH     SP70,MRSTDEPT
          IF        @EQUAL
            MOVE      "&nbsp;",TDESC 
          ELSE
            MOVE      "TD",CATEGORY
            MOVE      MRSTDEPT,CODE
            CALL      GETCOD00    
            MATCH     SP70,TDESC
            IF        @EQUAL
              MOVE      "&nbsp;",TDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail03":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mrtst001=",MRSTCODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             MRSTCODE,"</td>":
                             "<td>",MRSTSNAM,"</td>":
                             "<td>",MRSTGNAM,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td>",KEY10,"</td>":
                             "</tr>"
.
MRTST999  RETURN 
.------------------------------------------------------------
. Table of Tracking Locations
.------------------------------------------------------------
BAYTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BYHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY5,STARTKEY,SP70
          CALL      RDSBAYS1
          IF        OVRCD=0
            CALL      RDPBAYS1
          ENDIF
BAYTB100  CALL      RDKBAYS1
          BRANCH    OVRCD,BAYTB900
.
          MATCH     SP70,BAYUR
          IF        !@EQUAL
            GOTO      BAYTB100
          ENDIF 
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      BAYTB100
          ENDIF
.
          CALL      BAYRW000  * Display Locations Mantenance Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      BAYTB100 IF NOT EQUAL
          GOTO      BAYTB999
.
BAYTB900  CALL      NOMORE00  * Display No More Records Message
.
BAYTB999  RETURN
.------------------------------------------------------------
. Bay Code Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
BYHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=40%>":
                               "Bay Code</td>":
                               "<td class=HeadingCell width=60%>":
                               "Description</td>":
                               "</tr>"
.
BYHED999  RETURN
.------------------------------------------------------------
. Bay Code Maintenance (TABLE ROW)
.------------------------------------------------------------
BAYRW000  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail04":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&baycd001=",BAYCODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             BAYCODE,"</td>":
                             "<td>",BAYDESC,"</td>":
                             "</tr>"
.
BAYRW999  RETURN 
.------------------------------------------------------------
. Location Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
MSDHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Volume</td>":
                               "<td class=HeadingCell>":
                               "Current Location</td>":
                               "<td class=HeadingCell>":
                               "Status</td>":
                               "<td class=HeadingCell>":
                               "Link</td>":
                             "</tr>"
.
MSDHD999  RETURN
.------------------------------------------------------------
. Table of Medical Record Master Maintenance
.------------------------------------------------------------
MSDTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MSDHD000      * Output Table Heading
.
          PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RDMRMAS1
MSDTB100  CALL      RPMRMAS1
          BRANCH    OVRCD,MSDTB900
.
          MATCH     URNUMBER,MRMAURNO
          IF        !@EQUAL
            GOTO      MSDTB999
          ENDIF
.
          RESET     DOCMTYPE
          MATCH     SP70,DOCMTYPE
          IF        !@EQUAL
            MATCH     MRMADOTY,DOCMTYPE
            IF        !@EQUAL
              GOTO      MSDTB100
            ENDIF
          ELSE
            MATCH     MRMADOTY,MRCNRCTY
            IF        !@EQUAL
              GOTO      MSDTB100
            ENDIF
          ENDIF
.
          MOVE      SP10,WBSEHOSP           * select req'd Hospitals  *I-268580
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
            MOVE      SP3,PTHSHHOS
            PACK      KEY3,WBSEHOSP
            CALL      RDPTHSP1
            MOVE      PTHSHHOS,ALTHOHOS
.                                                                    Car 274123
.           MATCH     "1",SUPERLEV
.           IF        !@EQUAL
              MATCH     WBSEHOSP,MRMAHHOS   * is Users Hosp = MR Home Hosp
              GOTO      MSDTB200 IF EQUAL
.             MATCH     WBSEHOSP,MRMAOHOS   * is User Hosp = Originating Hosp
.             GOTO      MSDTB200 IF EQUAL
              MATCH     ALTHOHOS,MRMAHHOS   * is Alt Home Hosp = MR Home Hosp
              GOTO      MSDTB200 IF EQUAL
              GOTO      MSDTB100
.           ENDIF
          ENDIF                                                * end  *I-268580
.                                                   (revamp)          *C-268580
MSDTB200  MOVE      SP70,MRLODESC           * clear Current Location
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,MSDTB300
.
          MATCH     MRHIKEY,MRMAKEY
          GOTO      MSDTB300 IF NOT EQUAL
.                                           * use movement history
          PACK      KEY7,MRHIDHOS,MRHILOC                             *C-240724
          CALL      RDMRLOC1
...       MATCH     MRMAHHOS,MRHIDHOS       * check if in Home Hosp
          MATCH     WBSEHOSP,MRHIDHOS       * check if in Users Hosp  *C-268580
          IF        @EQUAL
            PACK      KEY70,MRLODESC,SP70
          ELSE
            PACK      KEY70,MRLODESC,OBR,MRHIDHOS,CBR,SP70  * red
          ENDIF
          GOTO      MSDTB310
.
MSDTB300  PACK      KEY7,MRMAHHOS,MRMAHLOC                            *C-240724
          CALL      RDMRLOC1
...       MATCH     MRMAOHOS,MRMAHHOS       * check if in Orig. Hosp  *I-240724
          MATCH     WBSEHOSP,MRMAHHOS                                 *C-268580
          IF        @EQUAL
            PACK      KEY70,MRLODESC,SP70
          ELSE
            PACK      KEY70,MRLODESC,OBR,MRMAHHOS,CBR,SP70  * red
          ENDIF                                             * (end)   *C-268580
.
MSDTB310  MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
.
          PACK      KEY10,MRMAKEY,SP70
          PACK      KEY8,ADMISSNO,SP70

          CALL      RDMRVS1
          IF        OVRCD = 1
            CALL      CLRVIS00
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td align=centre name='mrtvolno'>":
                             MRMAVOLN,"</td><td>":
...                          MRLODESC,"</td><td>":
                             KEY70,"</td><td>":                       *C-240724
                             "<span style=color:",PTCDUDF3,">":
                             TDESC,"<span></td><td>":
                             "<input type=checkbox name=":
                             RECORD," value='",KEY10,"'" 
.
          MATCH     MRVSMKEY,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          MATCH     MRVSXKY1,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          MATCH     MRVSXKY2,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          MATCH     MRVSXKY3,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          MATCH     MRVSXKY4,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          MATCH     MRVSXKY5,MRMAKEY
          IF        @EQUAL
            WRITE     HTMLFILE;" checked "
          ENDIF
.
          
.
          WRITE     HTMLFILE;"></td></tr>"
.
          GOTO      MSDTB100
.
MSDTB900  WRITE     HTMLFILE;"<td class=HeadingCell width=5%></td>":
                             "<td class=HeadingCell width=5%></td>":
                             "<td class=HeadingCell width=5%></td>"
.
          GOTO      MSDTB999
.
MSDTB999  RETURN
.------------------------------------------------------------
. Table of Medical Records Details
.------------------------------------------------------------
MRTTAB00  MOVE      SP10,WBSEHOSP                                     *I-240724
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
          ENDIF
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
MRTTAB10  CALL      RKMRMAS1
          BRANCH    OVRCD,MRTTAB99
          MATCH     MRMAURNO,URNUMBER
          GOTO      MRTTAB99 IF NOT EQUAL
.                                                          * start    *I-240724
          IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            IF        !@EQUAL
              MATCH     WBSEHOSP,MRMAHHOS   * is Users Hospital = Master C-Hosp
              IF        !@EQUAL
                MATCH     WBSEHOSP,MRMACHOS
                GOTO      MRTTAB10 IF NOT EQUAL
              ENDIF
            ELSE
              PACK      KEY13,USERID,SP70               * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD = 1
                PACK      KEY13,USERID,MRMAHHOS,SP70    * This Home Hosp. access
                CALL      RDMLSEC1
                IF        OVRCD = 1
                  PACK      KEY13,USERID,MRMACHOS,SP70  * This Curr Hosp. access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,MRTTAB10
                ENDIF
              ENDIF
            ENDIF
          ENDIF                                                * end  *I-240724
.
          MOVE      SP20,DESCDOCM
          PACK      HLOCDSC1,SP70,SP70
          MATCH     SP3,MRMADOTY
          GOTO      MRTTAB20 IF EQUAL
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,MRTTAB20
          MOVE      TDESC,DESCDOCM
.
MRTTAB20  MATCH     SP4,MRMAHLOC            
          GOTO      MRTTAB30 IF EQUAL
.
          MOVE      SP70,MRLODESC
          PACK      HLOCDSC1,SP70,SP70
          PACK      KEY7,MRMAHHOS,MRMAHLOC                            *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                      * start  *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
....        MATCH     MRMAOHOS,MRMAHHOS
....        IF        !@EQUAL
....          PACK      KEY30,OBR,MRMAOHOS,CBR,SP20   * red
....          APPEND    KEY30,KEY70
....        ENDIF
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
MRTTAB30  MOVE      SP70,HISTDATE
          MOVE      SP70,HISTTIME
          MOVE      HLOCDSC1,HLOCDSC2
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                      * read tracking history file
          BRANCH    OVRCD,MRTTAB40
          MATCH     MRMAKEY,MRHIKEY
          GOTO      MRTTAB40 IF NOT EQUAL
          MOVE      MRHIDATE,HISTDATE
          MOVE      MRHITIME,HISTTIME
.
          PACK      KEY7,MRHIDHOS,MRHILOC                             *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTTAB40
          PACK      KEY70,MRLODESC,SP70                      * start  *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRHIDHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRHIDHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRHIDHOS            * destination hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * default home same as home ?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRHIDHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRHIDHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30 
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
          ENDIF
          MOVE      KEY70,HLOCDSC2                          * end     *I-240724
.
MRTTAB40  MOVE      SP70,MTHNAM3
          UNPACK    HISTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,TDESC
          MATCH     SP3,MRMASTAT
          IF        !@EQUAL
            MOVE      "RS",KEY2
            PACK      KEY5,KEY2,MRMASTAT
            CALL      RDCODE1
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:RequestReport('",HTMLLINK
          APPEND    MRMAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMADOTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMAKEY,HTMLLINK
          APPEND    "','",HTMLLINK                                    *I-240724
          APPEND    SUPERLEV,HTMLLINK                                 *I-240724
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",MRMAVOLN,"#",":
                             "#"",HLOCDSC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",MRMACOMM,"#",":
                             "#"",HLOCDSC2,"#",":
                             "#"",HISTDATE,HISTTIME,"#",":
                             "#"",MRMAFILM,"#")"
.
          GOTO      MRTTAB10
.
MRTTAB99  RETURN
.------------------------------------------------------------
. Table of Medical Record Master Maintenance
.------------------------------------------------------------
MASTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      SP10,WBSEHOSP                                     *I-240724
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
            MOVE      SP3,PTHSHHOS
            PACK      KEY3,WBSEHOSP
            CALL      RDPTHSP1
            MOVE      PTHSHHOS,ALTHOHOS
.
            MATCH     "1",SUPERLEV
            IF        @EQUAL
              IF        FILTFLAG=1
                MOVE      WBSEHOSP,FILTHOSP
              ENDIF
            ENDIF
.
          ENDIF                                              * end    *I-240724
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
MASTB100  CALL      RKMRMAS1
          BRANCH    OVRCD,MASTB999
.
          MATCH     URNUMBER,MRMAURNO
          IF        !@EQUAL
            GOTO      MASTB999
          ENDIF 
.                                                                     *I-240724
          IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            IF        !@EQUAL
              MATCH     WBSEHOSP,MRMAHHOS   * is Users Hosp = MR Home Hosp
              GOTO      MASTB150 IF EQUAL
              MATCH     WBSEHOSP,MRMAOHOS   * is User Hosp = Originating Hosp
              GOTO      MASTB150 IF EQUAL
              MATCH     WBSEHOSP,MRMACHOS   * is User Hosp = Originating Hosp
              GOTO      MASTB150 IF EQUAL
              MATCH     ALTHOHOS,MRMAHHOS   * is Alt Home Hosp = MR Home Hosp
              GOTO      MASTB150 IF EQUAL
              GOTO      MASTB100
            ELSE
              MATCH     SP70,FILTHOSP
              IF        !@EQUAL & !@EOS
                PACK      KEY13,USERID,SP70               * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD = 1
                  PACK      KEY13,USERID,MRMAHHOS,SP70  * This Home Hosp. access
                  CALL      RDMLSEC1
                  IF        OVRCD = 1
                    PACK      KEY13,USERID,MRMAHHOS,SP70 *This Curr Hosp. access
                    CALL      RDMLSEC1
                    BRANCH    OVRCD,MASTB100
                  ENDIF
                ENDIF
.
                MATCH     FILTHOSP,MRMAHHOS
                GOTO      MASTB100 IF NOT EQUAL
.
              ENDIF
            ENDIF
          ENDIF                                                * end  *I-240724
.
MASTB150  UNPACK    SP70,HOMEHOSP,PTHSSNAM,HOMHOSDS,KEY20
          MOVE      SP70,DISPHLOC
          PACK      KEY7,MRMAHHOS,MRMAHLOC      * Home Location       *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=0
            MOVE      MRLOHOSP,HOMEHOSP
            MOVE      MRLODESC,DISPHLOC
            IF        IBCNMHOS=1
              PACK      KEY3,MRLOHOSP,SP70
              CALL      RDPTHSP1
              PACK      HOMHOSDS,PTHSSNAM,SP10
            ENDIF
          ENDIF
.
          MOVE      SP70,MRLODESC
          MOVE      SP70,MRLOHOSP
          PACK      KEY7,MRMACHOS,MRMACLOC      * Current Location    *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC                          * start   *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRMACHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRMACHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRMACHOS            * current hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * default same as home hosp?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRMACHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRMACHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
          ENDIF
.
          CALL      ITRN0000                     * Check if in transit
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      HLOCDSC1,INTRANST,KEY70
          ELSE
            MOVE      KEY70,HLOCDSC1                          * end     *I-240724
          ENDIF
.
MASTB200  MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MOVE      SP70,PTCDUDF3
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          PACK      CODE,MRMASTAT,SP70
          CALL      GETCOD00
.
           MOVE      PTCDUDF3,RECSTATC
.
          MOVE      SP70,DISPLAYR
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,MASTB800
.
          MATCH     MRHIKEY,MRMAKEY
          GOTO      MASTB800 IF NOT EQUAL
.
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,DISPLAYR   * Requested By Free Format
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      DISPLAYR,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.                                                                     *C-240724
MASTB800  PACK      PACKLINK,URNUMBER,SQUOTE,COMMA,SQUOTE,MRMAHHOS,SQUOTE:
                    COMMA,SQUOTE,MRMAHLOC,SQUOTE:
                    COMMA,SQUOTE,MRMADOTY,SQUOTE,COMMA,SQUOTE,MRMAVOLN
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateReport('",HTMLLINK
          APPEND    PACKLINK,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.                                                                     *C-240724
          PACK      RECORDKY,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,DMRMAVOL,SP70
.
          PACK      DISPCOMM,MRMACOMM,SP20
          PACK      REPLSLSH,MRMACOMM,SP20
          ENDSET    REPLSLSH
          CMATCH    BACKSLSH,REPLSLSH
          GOTO      MASTB900 IF NOT EQUAL
.
          PACK      DISPCOMM,MRMACOMM,BACKSLSH
.
MASTB900  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":            * 0
                             "#"",KEY20,"#",":                        * 1
                             "#"",MRMAVOLN,"#",":                     * 2
                             "#"",HLOCDSC1,"#",":                     * 3
                             "#"","<span style=color:",RECSTATC,">":  * 4
                             TDESC,"</span>","#",":
                             "#"",DISPCOMM,"#",":                     * 5
                             "#"",MRMAHLOC,"#",":                     * 6
                             "#"",MRMAFILM,"#",":                     * 7
                             "#"<input type=checkbox name=dummy":     * 8
                             " value='",MRMADOTY,RECORDKY:
                             "' onclick='MedMove(this);'>":
                             "#",":
                             "#"",DISPLAYR,"#",":                     * 9
                             "#"",HOMHOSDS,"#",":                     * 10
                             "#"",DISPHLOC,"#");"                     * 11
.
          GOTO      MASTB100 
.
MASTB999  RETURN
.------------------------------------------------------------
. Table of History of a Record 
.------------------------------------------------------------
HISTB000  UNPACK    DIM127,D1,LINKPRG,DIM127                          *I-240724
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY26,MEDRECKY,SP70
          CALL      RDMRHIS1
HISTB100  CALL      RKMRHIS1
          BRANCH    OVRCD,HISTB999
.
          MATCH     MEDRECKY,MRHIKEY
          IF        !@EQUAL
            GOTO      HISTB999
          ENDIF 
.
          CLEAR     HTMLLINK
          APPEND    "javascript:HistoryLink('",HTMLLINK
          APPEND    MRHIKEY,HTMLLINK
          APPEND    MRHIDATE,HTMLLINK
          APPEND    MRHITIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          UNPACK    SP70,MRLODESC
          UNPACK    SP70,HLOCDSC1
.         PACK      KEY7,MRHIDHOS,MRHILOC                             *C-240724
.         CALL      RDMRLOC1
.
.                                           * check if in Orig. Hosp  *I-240724
.         PACK      KEY70,MRLODESC
          IF        IBCNMHOS = 1
.
            PACK      KEY7,MRHIDHOS,MRHILOC,SP70
            CALL      RDMRLOC1
            IF        OVRCD=1
              PACK      KEY70,MRHILOC
            ELSE
              PACK      KEY70,MRLODESC
            ENDIF
.
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRHIDHOS,CBB     * set default to black
            MATCH     SMRHHOS,MRHIDHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRHIDHOS            * destination hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,SMRHHOS         * default same as home hosp?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRHIDHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRHIDHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
.
          ELSE
.
            PACK      KEY7,MRHIDHOS,MRHILOC,SP70
            CALL      RDMRLOC1
            IF        OVRCD=0
              PACK      KEY70,MRLODESC
            ELSE
              PACK      KEY7,SP3,MRHILOC,SP70
              CALL      RDMRLOC1
              IF        OVRCD=0
                PACK      KEY70,MRLODESC
              ELSE
                PACK      KEY70,MRHILOC
              ENDIF
            ENDIF
.
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
          MOVE      SP70,MRMODESC
          MOVE      MRHIREAS,KEY4
          CALL      RDMRMOV1
.
          MOVE      SP70,DISPRECN
          MATCH     SP70,MRHIRCUI
          IF        !@EQUAL
            PACK      KEY10,MRHIRCUI,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      MRHIRCUI,WBSENAM
            ENDIF
            MOVE      WBSENAM,DISPRECN
          ENDIF
.
          MOVE      SP70,DISPRECS
          MOVE      ZERO,F1
          MOVE      MRHIRCST,F1
          LOAD      DISPRECS,F1,RECSTAT1,RECSTAT2,RECSTAT3
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,MRHIUSID
          IF        !@EQUAL
            MOVE      MRHIUSID,KEY10
            CALL      RDWBSE1
          ELSE
            PACK      KEY6,MRHIOPER,SP70  
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      WBSENAM,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY50
          PACK      PRESDETS,SP70,SP70                                 *I-44792
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,KEY50   * Requested By Free Format
            CALL      GTPEX000         * get pager,ext details         *I-44792
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
              CALL      GTPEX000                                       *I-44792
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":   * 0
                             "#"",MRHIDATE,MRHITIME,"#",":   * 1
                             "#"",MRHIDDUE,"#",":            * 2
                             "#"",HLOCDSC1,"#",":            * 3      *C-240724
                             "#"",PRESDETS,"#",":            * 4       *C-44792
                             "#"",MRMODESC,"#",":            * 5
                             "#"",WBSENAM,"#",":             * 6
                             "#"",MRHISTAT,"#",":            * 7
                             "#"",DISPRECS,"#",":            * 8
                             "#"",MRHIRCDT,MRHIRCTM,"#",":   * 9
                             "#"",DISPRECN,"#",":            * 10
                             "#"",MRHICOMM,"#");"            * 11     *C-261931

          MOVE      USERID,KEY10
          CALL      RDWBSE1
.
          GOTO      HISTB100 
.
HISTB999  RETURN
.------------------------------------------------------------
. Get the pager and extension if there is one.                         *I-44792
.------------------------------------------------------------
GTPEX000  PACK      PRESDETS,SP70,SP70
          PACK      PRESDETS,KEY50
          STRIP     PRESDETS
.
.... I-51445  if using staff code for requester, it needs to have a value
.... to get ext.no and pager no
          COMPARE   ONE,PTCNRQCF
          IF        !@EQUAL
            MATCH     SP20,KEY50         * check for 20 spaces.
            GOTO      GTPEX999 IF EQUAL
          ENDIF
.
          MATCH     SP20,MRHIEXTN
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,EXTNTXT,MRHIEXTN
            STRIP     PRESDETS
          ENDIF
.
          MATCH     SP20,MRHIPAGE
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,PAGERTXT,MRHIPAGE
            STRIP     PRESDETS
          ENDIF
.
GTPEX999  RETURN
.------------------------------------------------------------
. Table of Visits associated with Medical Records
.------------------------------------------------------------
VISTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RDSVISA2 
VISTB100  CALL      RDKVISA2             * Reads Visit File
          BRANCH    OVRCD,VISTB500
.
          MATCH     URNUMBER,PVIURNO     * Checks to see if U/R's are the same
          IF        !@EQUAL
            GOTO      VISTB500
          ENDIF 
.
          PACK      KEY8,DPVIBILL,SP70   * Reads MRTVISFD for Medical Record
          CALL      RDMRVS1
          BRANCH    OVRCD,VISTB100
.
          MATCH     MRVSMKEY,MEDRECKY    * Checks if Medical Record is Correct
          IF        !@EQUAL 
            GOTO      VISTB100
          ENDIF
.
          PACK      KEY8,MRVSVSNO,SP70   * Reads Discharge File for Dis. date
          CALL      RDDSCH1 
          IF        OVRCD=1
            MOVE      SP70,DDATE
          ENDIF

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,VISTB100
.
          CLEAR     HTMLLINK
          APPEND    "javascript:VisitLink('",HTMLLINK
          APPEND    MRVSVSNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMADOTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MRVSVSNO,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",DDATE,"#");"
.
          GOTO      VISTB100 
.
VISTB500  PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
VISTB600  CALL      RDKBOKA3             * Reads Visit File
          BRANCH    OVRCD,VISTB999
.
          MATCH     URNUMBER,OBAURNO     * U/R
          GOTO      VISTB999 IF NOT EQUAL
.
          IF        OBASTAT <> 1 & OBASTAT <> 5
            GOTO      VISTB600                    * Booked and DNA
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70   * Reads MRTVISFD for Medical Record
          CALL      RDMRVS1
          BRANCH    OVRCD,VISTB600
.
          MATCH     MRVSMKEY,MEDRECKY    * Checks if Medical Record is Correct
          IF        !@EQUAL
            GOTO      VISTB600
          ENDIF
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,VISTB600
.
          CLEAR     HTMLLINK
          APPEND    "javascript:VisitLink('",HTMLLINK
          APPEND    MRVSVSNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMADOTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MRVSVSNO,"#",":
                             "#"",OBADATE,"#",":
                             "#"",SP1,"#");"
.
          GOTO      VISTB600
.
VISTB999  RETURN
.------------------------------------------------------------
. Table of Medical Requests/Reservation for a Record
.------------------------------------------------------------
RESTB000  PACK      KEY20,MEDRECKY,SP70
          CALL      RSMRRQD2
RESTB100  CALL      RKMRRQD2
          BRANCH    OVRCD,RESTB999
          MATCH     MEDRECKY,MRRDRKEY
          GOTO      RESTB999 IF NOT EQUAL
.
          MOVE      MRRDRQNO,KEY10
          CALL      RDMRRQH1
          BRANCH    OVRCD,RESTB100
.
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRRQHOSC,MRRQLOCR                            *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP20                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRRQHOSC,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
            RESET     KEY70
          ENDIF                                             * end     *I-240724
.
          MOVE      SP70,MRMODESC
          MOVE      MRRQMOVR,KEY4
          CALL      RDMRMOV1
.
          MOVE      "QU",CATEGORY
          MOVE      MRRQURGY,CODE
          CALL      GETCOD00
.
          MOVE      SP70,KEY50
          PACK      PRESDETS,SP70,SP70                                 *I-44792
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRRQPERS,KEY50   * Requested By Free Format
            CALL      GTRQX000         *  request get pager,ext details*I-44792
          ELSE
            UNPACK    MRRQPERS,KEY6    * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
              CALL      GTRQX000       *  request get pager,ext details*I-44792
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:RequestLink('",HTMLLINK
          APPEND    MRRDRQNO,HTMLLINK
          APPEND    MRRDRKEY,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          CALL      GFILST00
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MRRQDTRQ,MRRQTMRQ,"#",":
                             "#"",MRRQDAYE,MRRQTIYM,"#",":
                             "#"",KEY70,"#",":         * was MRLODESC *C-240724
                             "#"",MRRQCOMM,"#",":
                             "#"",PRESDETS,"#",":                      *C-44792
                             "#"",MRMODESC,"#",":
                             "#"",FILLSTAT,WBSENAM,"#",":
                             "#"",TDESC,"#",":
                             "#"",MRRQEXTN,"#",":
                             "#"",MRRQPAGE,"#");"
.
          GOTO      RESTB100 
.
RESTB999  RETURN
.------------------------------------------------------------
. Get the pager and extension if there is one.                         *I-44792
.------------------------------------------------------------
GTRQX000  PACK      PRESDETS,SP70,SP70
          PACK      PRESDETS,KEY50
          STRIP     PRESDETS
.
          COMPARE   ONE,PTCNRQCF         * I-51445 if using staff code for
                                         * requester, it needs to have a value
                                         * to get ext.no and pager no displayed
          IF        !@EQUAL
            MATCH     SP20,KEY50         * check for 20 spaces.
            GOTO      GTRQX999 IF EQUAL
          ENDIF
.
          MATCH     SP20,MRRQEXTN
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,EXTNTXT,MRRQEXTN
            STRIP     PRESDETS
          ENDIF
.
          MATCH     SP20,MRRQPAGE
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,PAGERTXT,MRRQPAGE
            STRIP     PRESDETS
          ENDIF
.
GTRQX999  RETURN
.
GFILST00  MOVE      SP70,FILLSTAT
          MATCH     "Y",MRRDFILL
          IF        @EQUAL
            MOVE      "Filled by ",FILLSTAT
          ENDIF
          MATCH     "N",MRRDFILL
          IF        @EQUAL
            MOVE      "Not Filled",FILLSTAT
            PACK      MRRDFUID,SP70
          ENDIF
          MATCH     "P",MRRDFILL
          IF        @EQUAL
            MOVE      "Processing by ",FILLSTAT
          ENDIF
          MATCH     "C",MRRDFILL
          IF        @EQUAL
            MOVE      "Cancelled by ",FILLSTAT
          ENDIF
.
          MATCH     SP70,MRRDFUID
          IF        @EQUAL
            PACK      WBSENAM,SP70
            GOTO      GFILST99
          ENDIF
.
          PACK      KEY10,MRRDFUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,MRRDFUID,SP70          * Display filled by user id
          ENDIF
.
GFILST99  RETURN
.------------------------------------------------------------
. Table of Medical Record Template Heading Maintenance
.------------------------------------------------------------
THDTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY4,SP70
          CALL      RDMRTHD1
THDTB100  CALL      RKMRTHD1
          BRANCH    OVRCD,THDTB999
.
          PACK      PACKLINK,MRTHTMID
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateTemplt('",HTMLLINK
          APPEND    PACKLINK,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MRTHTMID,"#",":
                             "#"",MRTHDESC,"#");"
.
          GOTO      THDTB100 
.
THDTB999  RETURN
.------------------------------------------------------------
. Table of Medical Record Template Details for Disease Codes
.------------------------------------------------------------
TDTTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ONE,CDCIDBUT
          MOVE      HUNDRED,CODCOUNT   * Cgi counter/var set to have 3 chars
.
          CALL      TDTHD000      * Output Table Heading
.
          PACK      KEY8,MRTTD001,SP70
          CALL      RSMRTDT1
.          IF        OVRCD=0
.            CALL      RPMRTDT1
.          ENDIF
TDTTB100  CALL      RKMRTDT1
          BRANCH    OVRCD,TDTTB999
.
          MATCH     MRTTD001,MRTDTMNO
          GOTO      TDTTB999 IF NOT EQUAL
.
          MATCH     "D",MRTDRECT
          GOTO      TDTTB100 IF NOT EQUAL
.
          CALL      TDTRW000  * Display Locations Mantenance Table Details Row
          GOTO      TDTTB100
.
TDTTB999  RETURN
.------------------------------------------------------------
. Bay Code Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
TDTHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "ICD10 Disease Code</td>":
                               "<td class=HeadingCell>":
                                 "Description</td>";
.
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>":
                                 "Cluster ID</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=11%>":
                               "Sequence</td>":
                               "</tr>"
.
TDTHD999  RETURN
.------------------------------------------------------------
. Coding template diagnosis Code Maintenance (TABLE ROW)
.------------------------------------------------------------
TDTRW000  ADD       ONE,CODCOUNT
.
          WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle onclick='":
                             "ShowDetail12(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mrttd001=",MRTDTMNO:
                             "&mrttd002=",MRTDRECT:
                             "&mrttd003=",MRTDSEQN,"#")';>":
                             MRTDDEST,SP1,MRTDDECD,"</td>":                     
                             "<td>",MRTDDESC,"</td>";
.
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id
          GOTO      TDTRW500 IF NOT EQUAL
.
          PACK      KEY9,MRTDDECD,SP70
          CALL      RDPTICD1                     * Read ICD disease record
          IF        OVRCD=1 | ICDRDVER < 13
            MOVE      ZERO,PT0DCARQ
          ENDIF
.
          MOVE      "Readonly",DCIDCLAS          * Not required - Grey
.
          MATCH     "1",PT0DCARQ                 * Required - Blue
          IF        @EQUAL
            MOVE      "Mandatory",DCIDCLAS
          ENDIF
.
          MATCH     "2",PT0DCARQ                 * Maybe - Green
          IF        @EQUAL
            MOVE      "GreenBackground",DCIDCLAS
          ENDIF
.
          MATCH     SP70,MRTDDCID                * Cluster id populated
          GOTO      TDTRW200 IF NOT EQUAL
.
          MATCH     ANSU,MRTDDECD                * U prefix
          IF        @EQUAL
            UNPACK    MRTDDECD,D1,D2
            MOVE      ZERO,F2
            SQUEEZE   D2
            MOVE      D2,F2                   * U78 to U88 range
            IF        F2 >= 78 & F2 <=88
              MOVE      "0 ",MRTDDCID         * Assign and update chronic
              CALL      UPMRTDT1              * condition value 8
              GOTO      TDTRW200
            ENDIF
          ENDIF
.
          MOVE      "8 ",MRTDDCID         * Assign and update unclusterd 
          CALL      UPMRTDT1              * condition value 8
.
TDTRW200  WRITE     HTMLFILE;"<td>":
                             "<input type=hidden ":
                             " name=#"clusk",CODCOUNT,"#"":
                             " id=#"clusk",CODCOUNT,"#"":
                             " value=#"",MRTDTMNO,MRTDRECT,MRTDSEQN,"#">":
                             "<input type=text size=2 maxlength=2 readonly":
                             " name=#"clusa",CODCOUNT,"#"":
                             " id=#"clusa",CODCOUNT,"#"":
                             " value=#"",MRTDDCID,"#"":
                             " class=#"",DCIDCLAS,"#"":
                             " alt=#"Cluster ID#" title=#"Cluster ID#"":
                             " onchange=#"InputCluster(",CODCOUNT,");#">"
.
          WRITE     HTMLFILE;"&nbsp;<img src=../images/MoveIcon.gif":
                             " alt=#"Assign Cluster ID#"":
                             " title=#"Assign Cluster ID#"":
                             " class=Icon":
                             " onclick=#"AssignNextCluster(",CODCOUNT:
                             ");#">"
.
          WRITE     HTMLFILE;"&nbsp;<select name=#"clusb",CODCOUNT,"#"":
                             " id=#"clusb",CODCOUNT,"#"":
                             " class=#"Select40#"":
                             " title=#"Select Cluster ID#"":
                             " onfocus=#"GenerateClusterSel(",CODCOUNT,");#"":
                             " onchange=#"SelectCluster(this,",CODCOUNT,");#">":
                             " <option></option>":
                             " <option value=#"",MRTDDCID,"#" selected>":
                               MRTDDCID,"</option>":
                             " </select>";
.
          WRITE     HTMLFILE;"&nbsp;<img src=../images/ChronicDCID.gif ":
                             " alt=#"Assign Chronic Condition#"":
                             " title=#"Assign Chronic Condition#"":
                             " class=Icon":
                             " onclick=#"AssignChronic(",CODCOUNT,");#">"
.
          WRITE     HTMLFILE;"<img src=../images/erase.gif":
                             " alt=#"Delete Cluster ID#"":
                             " title=#"Delete Cluster ID#"":
                             " class=Icon":
                             " onclick=#"DeleteCluster(",CODCOUNT,");#">"
          IF        CDCIDBUT=1
            WRITE     HTMLFILE;"<input type=button class=#"SmallButton#"":
                               " value=#"Clear All#"":
                               " onclick=#"DeleteAllClusters();#">"
            MOVE      ZERO,CDCIDBUT
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
TDTRW500  CALL      SEQU0000
          WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif":
                             " class=#"Icon#"":
                             " alt='Move Record' border=0 ":
                             "onclick=#"javascript:MoveRec12('",MRTDTMNO:
                             "','",MRTDRECT,"','",MRTDSEQN,"','M')#";>":
                             "<img src=../images/SwapIcon.gif":
                             " class=#"Icon#"":
                             " alt='Swap Record' border=0 ":
                             "onclick=#"javascript:MoveRec12('",MRTDTMNO:
                             "','",MRTDRECT,"','",MRTDSEQN,"','S')#";>":
                             "</td></tr>"
.
TDTRW999  RETURN 
.------------------------------------------------------------
. Table of Medical Record Template Details for Operational Codes
.------------------------------------------------------------
TOPTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      TOPHD000      * Output Table Heading
.
          PACK      KEY8,MRTTD001,SP70
          CALL      RSMRTDT1
.          IF        OVRCD=0
.            CALL      RPMRTDT1
.          ENDIF
TOPTB100  CALL      RKMRTDT1
          BRANCH    OVRCD,TOPTB999
.
          MATCH     MRTTD001,MRTDTMNO
          GOTO      TOPTB999 IF NOT EQUAL
.
          MATCH     "O",MRTDRECT
          GOTO      TOPTB100 IF NOT EQUAL
.
          CALL      TOPRW000  * Display Locations Mantenance Table Details Row
          GOTO      TOPTB100
.
TOPTB999  RETURN
.------------------------------------------------------------
. Bay Code Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
TOPHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "ICD10 Procedure Code</td>":
                               "<td class=HeadingCell>":
                               "Description</td>":
                               "<td class=HeadingCell width=11%>":
                               "Sequence</td>":
                               "</tr>"
.
TOPHD999  RETURN
.------------------------------------------------------------
. Bay Code Maintenance (TABLE ROW)
.------------------------------------------------------------
TOPRW000  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle ":
                             "onclick='ShowDetail12(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mrttd001=",MRTDTMNO:
                             "&mrttd002=",MRTDRECT:
                             "&mrttd003=",MRTDSEQN,"#")';>":
                             MRTDDEST,SP1,MRTDDECD,"</td>":
                             "<td>",MRTDDESC,"</td>"
          CALL      SEQU0000
          WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif":
                             " alt='Move Record' border=0 ":
                             " class=#"Icon#"":
                             "onclick=#"MoveRec12('",MRTDTMNO:      
                             "','",MRTDRECT,"','",MRTDSEQN,"','M')#";>":
                             "<img src=../images/SwapIcon.gif":
                             " class=#"Icon#"":
                             " alt='Swap Record' border=0 ":
                             "onclick=#"MoveRec12('",MRTDTMNO:      
                             "','",MRTDRECT,"','",MRTDSEQN,"','S')#";>":
                             "</td></tr>"
.
TOPRW999  RETURN 
.-------------------------------------------------------------------------
.             Displays drop down list of sequence
.-------------------------------------------------------------------------
SEQU0000  MOVE      MRTDSEQN,KEY3
          MOVE      MRTDRECT,KEY1
          MOVE      MRTDTMNO,KEY4
          WRITE     HTMLFILE;"<td><select name=dummy ":
                             "onChange=setSeq(this);>"
          PACK      KEY8,MRTDTMNO,MRTDRECT,SP70
          CALL      RDMRTDT1
SEQU0100  CALL      RKMRTDT1
          BRANCH    OVRCD,SEQU9000
.
          MATCH     MRTDTMNO,KEY4
          GOTO      SEQU9000 IF NOT EQUAL
.
          MATCH     MRTDRECT,KEY1
          GOTO      SEQU9000 IF NOT EQUAL
.
          MOVE      MRTDSEQN,FORM3 
          MATCH     MRTDSEQN,KEY3
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRTDSEQN,"#" selected>":
                               FORM3,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRTDSEQN,"#">",FORM3,"</option>"
          ENDIF
          GOTO      SEQU0100
.
SEQU9000  WRITE     HTMLFILE;"</select>"
          PACK      KEY8,KEY4,KEY1,KEY3,SP70
          CALL      RSMRTDT1
          MOVE      KEY3,MRTDSEQN
          MOVE      KEY1,MRTDRECT
          MOVE      KEY4,MRTDTMNO

SEQU9999  RETURN
.-------------------------------------------------------------------------
.             Loops through List to find last Sequence number
.-------------------------------------------------------------------------
SEQN0000  MOVE      ZERO,FORM3
          MOVE      MRTDRECT,KEY1
          MOVE      MRTDTMNO,KEY4
.
          PACK      KEY8,MRTDTMNO,MRTDRECT,SP70
          CALL      RDMRTDT1
SEQN0100  CALL      RKMRTDT1
          BRANCH    OVRCD,SEQN9000
.
          MATCH     MRTDTMNO,KEY4
          IF        !@EQUAL
            GOTO      SEQN9000
          ENDIF
.
          MATCH     MRTDRECT,KEY1
          IF        !@EQUAL
            GOTO      SEQN9000
          ENDIF
.
          ADD       ONE,FORM3
.
          GOTO      SEQN0100
.
SEQN9000  ADD       ONE,FORM3
SEQN9999  RETURN
.------------------------------------------------------------------------------
. Right Justify The Code                          
.------------------------------------------------------------------------------
RJUS0000  PACK      RJUSCODE,SP70
          RESET     LJUSCODE,JUSTNO
          MOVE      ZERO,CHRCOUNT
RJUS1000  CMATCH    SP1,LJUSCODE
          GOTO      RJUS2000 IF NOT EQUAL
.
          ADD       ONE,CHRCOUNT
          BUMP      LJUSCODE,-1
          GOTO      RJUS2000 IF EOS
.
          COMPARE   JUSTNO,CHRCOUNT
          GOTO      RJUS1000 IF LESS
.
RJUS2000  RESET     LJUSCODE
          CLEAR     RJUSCODE
          RESET     RJUSCODE,CHRCOUNT
          APPEND    LJUSCODE,RJUSCODE
          RESET     RJUSCODE
.
RJUS9000  MOVE      ZERO,EXIT
RJUS9999  RETURN
.
.----------------------------------------------------------------
. Generate the next vol number
.----------------------------------------------------------------
XMLVOL00  CALL      XMLHED00
          BRANCH    EXIT,XMLVOL99
.
          MOVE      ONE,F2
          BRANCH    MRCNAUTO,XMLVOL10,XMLVOL20
.
          GOTO      XMLVOL30
.
. Generate next volume number by ur and document type
.
XMLVOL10  PACK      KEY20,VALDURNO,VALDDOTY,Z70
          CALL      RSMRMAS4
          CALL      RPMRMAS4
          BRANCH    OVRCD,XMLVOL50
.
          MATCH     MRMAURNO,VALDURNO
          GOTO      XMLVOL50 IF NOT EQUAL
.
          MATCH     MRMADOTY,VALDDOTY
          GOTO      XMLVOL50 IF NOT EQUAL
.
          MOVE      MRMAVOLN,F2
          ADD       ONE,F2
          GOTO      XMLVOL50
.
.         Generate next volume number by ur, home location and document type
.
XMLVOL20  PACK      KEY20,VALDURNO,VALDHMHO,VALDHMLC,VALDDOTY,Z70     *C-240724
          CALL      RSMRMAS1
          CALL      RPMRMAS1
          BRANCH    OVRCD,XMLVOL50
.         
          MATCH     MRMAURNO,VALDURNO
          GOTO      XMLVOL50 IF NOT EQUAL
.         
          MATCH     MRMAHHOS,VALDHMHO                                 *I-240724
          GOTO      XMLVOL50 IF NOT EQUAL
.         
          MATCH     MRMAHLOC,VALDHMLC
          GOTO      XMLVOL50 IF NOT EQUAL
.         
          MATCH     MRMADOTY,VALDDOTY
          GOTO      XMLVOL50 IF NOT EQUAL
.         
          MOVE      MRMAVOLN,F2
          ADD       ONE,F2
          GOTO      XMLVOL50
.

XMLVOL30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "</RETURN_VALUE>"
          GOTO      XMLVOL90
.
XMLVOL50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F2:
                             "</RETURN_VALUE>"
.
XMLVOl90  CALL      XMLEND00
.
XMLVOL99  RETURN
.
.----------------------------------------------------------------
.  Outputs a selection list of New Locations
.                   ******** LOCSEL00 ********
.----------------------------------------------------------------
LOCSEL00  PACK      KEY7,SP70
          CALL      RSMRLOC1
LOCSEL10  CALL      RKMRLOC1
          BRANCH    OVRCD,LOCSEL99
.
          COMPARE   MRLOSTAT,ONE
          GOTO      LOCSEL10 IF EQUAL
.         
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,MRLOHOSP
              GOTO      LOCSEL10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70            * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,MRLOHOSP,SP70 * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,LOCSEL10
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     FILTDEST,MRLOCODE    * Default Medical Records Location
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
                                 MRLODESC,"</option>"
          ELSE
....        IF        IBCNMHOS=1
....          MATCH     WBSEHOSP,MRLOHOSP
....          GOTO      LOCSEL10 IF NOT EQUAL
....        ENDIF
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
                                 MRLODESC,"</option>"
          ENDIF
          GOTO    LOCSEL10
.
LOCSEL99  RETURN
.----------------------------------------------------------------
.  Print bulk mrt labels from mrt pulling lists
.----------------------------------------------------------------
BLAB0000  MOVE      ZERO,ARRCNT
.
BLAB1000  ADD       ONE,ARRCNT
          IF        ARRCNT>MRKEYEND
            GOTO      BLAB9999
          ENDIF
.
          MATCH     SP70,MRRECKEY[ARRCNT]
          GOTO      BLAB1000 IF EQUAL
.
          UNPACK    MRRECKEY[ARRCNT],KEY10,KEY28
.
          PACK      KEY10,KEY10,SP70   * Reads MRTMASFD
          CALL      RDMRMAS2
          BRANCH    OVRCD,BLAB1000
.
          MOVE      MRMAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BLAB1000
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PTCNNHII=1
            MOVE      MRMAURNO,KEY8
            CALL      RDNHMAS2
            BRANCH    OVRCD,BLAB1000
          ENDIF
.
          MOVE      MRMAURNO,CPPURNO
          CALL      LABL0000                * Print bar code labels
.
          GOTO      BLAB1000
.
BLAB9999  RETURN
.
.-------------------------------------------------------------------------------
. Medical Record Linking / Inlinking : Display,Add,Update,Delete
.-------------------------------------------------------------------------------
LINK0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      LINK8000 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Add/Update formaction
          GOTO      LINK2000 IF EQUAL
.
          MATCH     "B",UPDTTYPE    * Bulk link 
          GOTO      LINK4000 IF EQUAL
.
          GOTO      LINK9100
.
.         ************ UPDATE FORMACTION **********
.
LINK2000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1
          BRANCH    OVRCD,LINK3000
.
          CALL      CHKVIS00      * Checks mandatory fields
          BRANCH    EXIT,LINK9999
.
          CALL      VISSAV00      * Moves input variables to file variables
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      UPMRVS1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      LINK9999
.
.         ************ ADD FORMACTION **********
.
LINK3000  CALL      VISSAV00      * Moves input variables to file variables
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      WRMRVS1       * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      LINK9999
.
.         ************ BULK LINK FORMACTION **********
.
LINK4000  MATCH     SP70,MEDRECKY
          GOTO      LINK9200 IF EQUAL
.
          CALL      BLNK0000                * Bulk Link
.
          MOVE      ZERO,EXIT
          GOTO      LINK9999
.
.
.         ************ DISPLAY FORMACTION **********
.
LINK8000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LINK9000
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1
          IF        OVRCD=1
            UNPACK    SP70,MRVSVSNO,MRVSMKEY,MRVSSPAR
          ENDIF
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2
          IF        OVRCD=0
            CALL      SAVMRM00    * Save Variables
          ELSE
            CALL      CLRMRM00    * Clear all the file variables
            CALL      SAVMRM00    * Clear Save Variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Medical Record Visit Links",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LINK9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9000  MOVE      "U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9100  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9200  MOVE      "Medial Record Key is needed!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9999  RETURN
.
.-------------------------------------------------------------------------------
. Bulk Linking / Inlinking 
.-------------------------------------------------------------------------------
BLNK0000  MOVE      ZERO,ARRCNT
.
BLNK1000  ADD       ONE,ARRCNT
          IF        ARRCNT>LINKACNT
            GOTO      BLNK9999
          ENDIF
.
          MATCH     SP70,LNKADMIS[ARRCNT]  * = Link to admission
          GOTO      BLNK1000 IF EQUAL
.
          MOVE      MEDRECKY,MRVSMKEY
          MOVE      MEDRCKY1,MRVSXKY1
          MOVE      MEDRCKY2,MRVSXKY2
          MOVE      MEDRCKY3,MRVSXKY3
          MOVE      MEDRCKY4,MRVSXKY4
          MOVE      MEDRCKY5,MRVSXKY5
          MOVE      LNKADMIS[ARRCNT],MRVSVSNO
          MOVE      SP70,MRVSSPAR
.
          PACK      KEY8,MRVSVSNO,SP70
          CALL      RAMRVS1
          IF        OVRCD=1
            CALL      WRMRVS1       * Write
          ELSE 
            CALL      UPMRVS1       * Write
          ENDIF
.
          GOTO      BLNK1000
.
BLNK9999  RETURN
.
.------------------------------------------------------------
.  Record Request Details
.------------------------------------------------------------
RCRQ0000  BRANCH    FLDITMNO,RCRQ0100,RCRQ0200,RCRQ0300,RCRQ0400,RCRQ0500:
                             RCRQ0600,RCRQ0700,RCRQ0800,RCRQ0900,RCRQ1000:
                             RCRQ1100,RCRQ1200
          GOTO      RCRQ9999
.           
RCRQ0100  WRITE     HTMLFILE;REQUESTN;
          GOTO      RCRQ9999
.         
RCRQ0200  UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY   * To Date in (DD MON CCYY)
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY12;
          GOTO      RCRQ9999
.         
RCRQ0300  WRITE     HTMLFILE;MRRQTMRQ;     * Time Request Required
          GOTO      RCRQ9999
.         
RCRQ0400  MOVE      SP70,KEY50      * Clear requested by field before read
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRRQPERS,KEY50      * Requested By Free Format
          ELSE
            UNPACK    MRRQPERS,KEY6   * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
          WRITE     HTMLFILE;KEY50;     * Person Requesting Record
          GOTO      RCRQ9999
.         
RCRQ0500  MOVE      MRRQPERS,STAFFKEY       * Set Staff Key
          CALL      STFLST00                * Selection List of Mrt Staff
          GOTO      RCRQ9999
.         
RCRQ0600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.         
          BRANCH    F1,RCRQ0645
.
          PACK      KEY7,SP70
          CALL      RDMRLOC1
RCRQ0641  CALL      RKMRLOC1
          BRANCH    OVRCD,RCRQ9999
.
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ0641
          ENDIF
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,MRRQLOCR
          IF        @EQUAL
            MATCH     MRLOHOSP,MRRQHOSC                               *I-240724
            GOTO      RCRQ0642 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
RCRQ0642    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ0641 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ0641
.
RCRQ0645  PACK      KEY37,SP70                                        *C-240724
          CALL      RDMRLOC3
RCRQ0646  CALL      RKMRLOC3
          BRANCH    OVRCD,RCRQ9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ0646
          ENDIF
          PACK      KEY15,QUOTE,MRLOCODE,QUOTE
          MATCH     MRLOCODE,MRRQLOCR
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15,"selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ0646 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ0646
.         
RCRQ0700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1   * Bulk Reasons Flag
.         
          PACK      KEY4,SP70               * Selection List of Resions
          CALL      RSMRMOV1
RCRQ0710  CALL      RKMRMOV1
          BRANCH    OVRCD,RCRQ9999
.         
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      RCRQ0710 IF EQUAL
.                              
          IF        F1 = ONE
            COMPARE   TWO,MRMOUSAG
            GOTO      RCRQ0710 IF NOT EQUAL
          ENDIF
.
          PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          MATCH     MRRQMOVR,MRMOREAS
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected >":
                               MRMODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          ENDIF
          GOTO      RCRQ0710
.         
RCRQ0800  WRITE     HTMLFILE;MRRQEXTN;     * Extention Number
          GOTO      RCRQ9999
.         
RCRQ0900  WRITE     HTMLFILE;MRRQPAGE;     * Pager
          GOTO      RCRQ9999
.         
RCRQ1000  WRITE     HTMLFILE;MRRQHOSC;     * Required hospital
          GOTO      RCRQ9999
.         
RCRQ1100  WRITE     HTMLFILE;MRRQLOCR;     * Required location 
          GOTO      RCRQ9999
.         
RCRQ1200  MOVE      MRRQHOSC,SELHOSP       * Required hospital
          MOVE      ONE,DOSELHOS
          CALL      HSEL0000               * selection list
          GOTO      RCRQ9999
.         
RCRQ9999  RETURN
.
.------------------------------------------------------------
. Clear file vars from mrtrqhaf
.------------------------------------------------------------
CRQH0000  MOVE      SP70,MRRQRQNO
          MOVE      SP70,MRRQDTRQ
          MOVE      SP70,MRRQTMRQ
          MOVE      SP70,MRRQLOCR
          MOVE      SP70,MRRQPERS
          MOVE      SP70,MRRQMOVR
          MOVE      SP70,MRRQURGY
          MOVE      SP70,MRRQEXTN
          MOVE      SP70,MRRQCOMM
          MOVE      SP70,MRRQHOSC
          MOVE      SP70,MRRQDAYE
          MOVE      SP70,MRRQTIYM
          MOVE      SP70,MRRQUSID
          MOVE      SP70,MRRQDTUP
          MOVE      SP70,MRRQTMUP
          MOVE      SP70,MRRQUSUP
          MOVE      SP70,MRRQEXTN
          MOVE      SP70,MRRQPAGE
          MOVE      SP70,MRRQTRIG
          MOVE      SP70,MRRQSPAE
.
CRQH9999  RETURN
.
.------------------------------------------------------------
. Remote scripting for MRT tracking alerts
. Check for any current ED or IP visits  or any PRE, BOOK, OUT 
. REQ within x days
.------------------------------------------------------------
XMLALT00  CALL      XMLHED00
          BRANCH    EXIT,XMLALT99
.
          MOVE      DESTHOSP,TRAKHOSP       * Tracking alert Hospital
          MOVE      LOCATION,TRAKLOCN       * Tracking alert location
.
          PROC      TRKALT00                * Check for tracking alerts
.
XMLALT80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ALRTMESS,"|",ALRTCLAS:
                             "</RETURN_VALUE>"
          GOTO      XMLALT95
.
XMLALT95  CALL      XMLEND00
XMLALT99  RETURN
.
.---------------------------------------------------------------------------
. Check if this MR is in transit to the current location
.---------------------------------------------------------------------------
ITRN0000  MOVE      SP70,INTRANST
.
          MATCH     "1",MRCNTREC                 * System Using Tracking Receipt
          GOTO      ITRN9999 IF NOT EQUAL
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                     * Read last history record
          BRANCH    OVRCD,ITRN9999
.
          MATCH     MRMAKEY,MRHIKEY              * Correct MR history record
          GOTO      ITRN9999 IF NOT EQUAL
.
          MATCH     MRMACHOS,MRHIDHOS            * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current hospital
.
          MATCH     MRMACLOC,MRHILOC             * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current location
.
          MATCH     "1",MRHIRCST                 * In Transit
          GOTO      ITRN9999 IF NOT EQUAL
.
          MOVE      "<font color=red>(T)</font>",INTRANST
.
ITRN9999  RETURN
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSLC0000  MATCH     SP70,FILTHOSP
          IF        @EQUAL 
            IF        FILTFLAG=1 
              MOVE      WBSEHOSP,FILTHOSP 
            ENDIF
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSLC0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSLC9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSLC0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSLC0100
.
HSLC9999  RETURN
.
.----------------------------------------------------------------
. Get MR details to allow barcode label printing from
. the final admission screen
.----------------------------------------------------------------
XMLBAR00  CALL      XMLHED00
          BRANCH    EXIT,XMLBAR99
.
          MATCH     "C",UPDTTYPE            * Return linked visit MR details
          GOTO      XMLBAR10 IF EQUAL
.
          MATCH     "V",UPDTTYPE            * Return volumes for a U/R,
          GOTO      XMLBAR20 IF EQUAL       * home loc and doc type
.
          MATCH     "T",UPDTTYPE            * Return Doc types for a U/R,
          GOTO      XMLBAR30 IF EQUAL       * home loc
.
          MATCH     "H",UPDTTYPE            * Return home locations for a U/R,
          GOTO      XMLBAR40 IF EQUAL       * home home hospital
.
          GOTO      XMLBAR89
.
XMLBAR10  CALL      CLMRTMAS
          MOVE      SP70,PTHSNAME
          MOVE      SP70,MRLODESC
          MOVE      SP70,TDESC
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1
          BRANCH    OVRCD,XMLBAR11
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,XMLBAR11
.
          MOVE      SP70,PTHSNAME
          IF        IBCNMHOS=1
            PACK      KEY3,MRMAHHOS,SP70
            CALL      RDPTHSP1
          ENDIF
.
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP70
          CALL      RDMRLOC1
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00

XMLBAR11  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":  * Linked visit MR
                             MRMAURNO,"|":                  * details
                             MRMAHHOS,"|",PTHSNAME,"|":
                             MRMAHLOC,"|",MRLODESC,"|":
                             MRMADOTY,"|",TDESC,"|":
                             MRMAVOLN:
                             "</RETURN_VALUE>"
          GOTO      XMLBAR90
.
XMLBAR20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,MRTMS002,SP70
          CALL      RSMRMAS1
XMLBAR21  CALL      RKMRMAS1
          BRANCH    OVRCD,XMLBAR29
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLBAR29 IF NOT EQUAL
.
          MATCH     MRTMS008,MRMAHHOS
          GOTO      XMLBAR29 IF NOT EQUAL
.
          MATCH     MRTMS001,MRMAHLOC
          GOTO      XMLBAR29 IF NOT EQUAL
.
          MATCH     MRTMS002,MRMADOTY
          GOTO      XMLBAR29 IF NOT EQUAL
.
          WRITE     HTMLFILE;MRMAVOLN,"|";
          GOTO      XMLBAR21
.
XMLBAR29  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      XMLBAR90
.
XMLBAR30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      PTCDKEY2,CATTY,SP70
          CALL      RDSCODE2
XMLBAR31  CALL      RDKCODE2
          BRANCH    OVRCD,XMLBAR39
.
          MATCH     CATTY,TCODE
          GOTO      XMLBAR39 IF NOT EQUAL
.
          PACK      KEY20,URNUMBER,MRTMS008,MRTMS001,ACODE,SP70
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,XMLBAR31
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLBAR31 IF NOT EQUAL
.
          MATCH     MRTMS008,MRMAHHOS
          GOTO      XMLBAR31 IF NOT EQUAL
.
          MATCH     MRTMS001,MRMAHLOC
          GOTO      XMLBAR31 IF NOT EQUAL
.
          MATCH     ACODE,MRMADOTY
          GOTO      XMLBAR31 IF NOT EQUAL
.
          WRITE     HTMLFILE;ACODE,",",TDESC,"|";
          GOTO      XMLBAR31
.
XMLBAR39  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      XMLBAR90
.
XMLBAR40  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY7,MRTMS008,SP70
          CALL      RSMRLOC1
XMLBAR41  CALL      RKMRLOC1
          BRANCH    OVRCD,XMLBAR49
.
          MATCH     MRLOHOSP,MRTMS008
          GOTO      XMLBAR49 IF NOT EQUAL
.
          PACK      KEY20,URNUMBER,MRLOHOSP,MRLOCODE,SP70
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,XMLBAR41
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      XMLBAR41 IF NOT EQUAL
.
          MATCH     MRLOHOSP,MRMAHHOS
          GOTO      XMLBAR41 IF NOT EQUAL
.
          MATCH     MRLOCODE,MRMAHLOC
          GOTO      XMLBAR41 IF NOT EQUAL
.
          WRITE     HTMLFILE;MRLOCODE,",",MRLODESC,"|";
          GOTO      XMLBAR41
.
XMLBAR49  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      XMLBAR90
.
XMLBAR89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Request Type - ",UPDTTYPE:
                             "</RETURN_VALUE>"
.
XMLBAR90  CALL      XMLEND00
.
XMLBAR99  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.----------------------------------------------------------------
. Get MR details to allow barcode label printing from
. the final admission screen
.----------------------------------------------------------------
XMLDCI00  CALL      XMLHED00
          BRANCH    EXIT,XMLDCI99
.
          MATCH     "A",UPDTTYPE            * Return linked visit MR details
          GOTO      XMLDCI10 IF EQUAL
.
          GOTO      XMLDCI90
.
XMLDCI10  PACK      KEY8,MRTTD001,MRTTD002,MRTTD003,SP70
          CALL      RDMRTDT1              * Read coding template record
          BRANCH    OVRCD,XMLDCI80
.
          SQUEEZE   CLUSTERV
          PACK      MRTDDCID,CLUSTERV,SP70
.
          CALL      UPMRTDT1              * Update coding template
.
.  Outputting Dummy Info so that Remote scripting does not fall over

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>": 
                             MRTDTMNO,"|":               
                             "</RETURN_VALUE>"
          GOTO      XMLDCI90
.
XMLDCI80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Record Not Found! ":
                             "</RETURN_VALUE>"
          GOTO      XMLDCI90
.
XMLDCI89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Request Type - ",UPDTTYPE:
                             "</RETURN_VALUE>"
.
XMLDCI90  CALL      XMLEND00
.
XMLDCI99  RETURN
+
.------------------------------------------------------------
          INC       CLMRTMAS
          INC       IBAWEBCD
          INC       PATMASTM
          INC       CLPMSPX2
          INC       DGCLICRM
          INC       PMSPX2TM
          INC       PMSVX1IO/INC
          INC       PATMSXTM
          INC       APSMASIO/INC
          INC       ALLREFIO/INC
          INC       BOKRC1IO/INC
          INC       EMRVISIO/INC
          INC       MLTSECIO/INC
          INC       MRTSTFIO/INC
          INC       MRTLOCIO/INC
          INC       MRTMOVIO/INC
          INC       PATBAYIO/INC
          INC       MRTMASIO/INC
          INC       PATHSPIO/INC
          INC       PATWR1IO/INC
          INC       PATPR1IO/INC   * New Patient Master File
          INC       PATDO1IO/INC   * Doctor File
          INC       PATFN1IO/INC   * Health Fund File
          INC       PATIN1IO/INC   * Insurance File
          INC       PATMI1IO/INC   * New Patient Admission File
          INC       PATMA1IO/INC   * New Patient Master File
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSPX2IO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       OUTSITIO/INC   * Outpatients - Site Codes File
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCANIO/INC
          INC       PATALRIO/INC   * Data variable defs for CALCAGE routine
          INC       PATVISIO/INC   * Patients Visits File
          INC       MRTRESIO/INC
          INC       MRTTDTIO/INC
          INC       MRTTHDIO/INC
          INC       MRTHISIO/INC
          INC       MRTPDSIO/INC
          INC       MRTPSHIO/INC
          INC       MRTRQHIO/INC
          INC       MRTRQDIO/INC
          INC       MRTVISIO/INC
          INC       NHIMASIO/INC 
          INC       NHIETHIO/INC  
          INC       PATDSCIO/INC
          INC       PATRE1IO/INC
.          INC       IBAIOPRN/INC  

          INC       PATECOIO/INC   *
          INC       PATCANIO/INC   *
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
.
          INC       CLMRTHIS
          INC       CLNHIMAS 
          INC       CLPATMIS
          INC       BARCODEF       * Bar Code Labels format routine
          INC       BARCODEL       * Bar Code Labels print routine
          INC       WEBDATCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATNAMCD
          INC       TRKALTCD
