.******************************************************************************
.* System         : Patient Billing                                           *
.* Include Name   : ABFMHDET.PBL                                              *
.* Author         : J.Tan                                                     *
.* Date           : 25/05/2023  Task 0923703                                  *
.* Modification   :                                                           *
.*                                                                            *
.*       V12.00.01  30/05/2025  Don Nguyen     TSK 0955096                    *
.*                  Alphanumeric visit number changes around PINVADM/AADMNO   *
.*       V11.03.04  16/08/2023 J.Tan  Task 0947804                            *
.*                  Fixed displaying percentage (APPSAMNT)                    *
.*       V11.03.03  17/11/2023  J.Tan          TSK 0940089                    *
.*                  Mod checking for blank Discharged DRG                     *
.*       V11.03.02  13/07/2023 J.Tan  Task 0923703                            *
.*                  Fixed displaying Private Patient Service                  *
.*       V11.03.01  12/07/2023 J.Tan  Task 0923703                            *
.*                  Mod to display Invoiced AMHCC End Class                   *
.*       V11.03.00  25/05/2023 J.Tan  Task 0923703                            *
.*                  Created Routine to display ABF values for Mental Health   *
.******************************************************************************
ABFMHDET  CALL      MINT0000          * Initliase variables
.
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      ABFM9000 IF NOT EQUAL   * Not using ABF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,ABFM9000
.
          BRANCH    NWAUFLAG,ABFM0100      * NWAU Calculations

          MATCH     "A",TCINDC2
          GOTO      ABFM9000 IF NOT EQUAL    * Not an ABF Funding
          GOTO      ABFM0200

ABFM0100  MATCH     "N",TCINDC2            * Check for NWAU Calculations
          GOTO      ABFM9000 IF NOT EQUAL  * Not an ABF Funding
.
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "X",TCINDC17
              GOTO      ABFM9000 IF EQUAL   * Excluded from NWAU
              MATCH     "11",PTCDUDF6
              GOTO      ABFM9000 IF NOT EQUAL * NOT an Inpatient Mental Health
            ENDIF
          ENDIF
.
ABFM0200  MOVE      ADATE,KEY8                * Use Adm.date
          IF        ASTAT=3
            MOVE      DDATE,KEY8              * Discharged date
          ENDIF
.
.
.         Check if an Invoice number was selected
.
ABFM0400  PACK      INVOICNO,INVOICNO,SP70
          MATCH     SP70,INVOICNO
          GOTO      ABFM3000 IF NOT EQUAL
.
.         Check if ABF Invoice raised already
.
          OPEN      PATINVR3,"patinvrf"
          PACK      KEY16,AADMNO,Z70
          CALL      RSPTINV3
ABFM1000  CALL      RPPTINV3
          BRANCH    OVRCD,ABFM2000
.
          MATCH     PINVADM,AADMNO
          GOTO      ABFM2000 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABFM1000 IF NOT EQUAL  * Credit note
.
          COMPARE   THREE,PTINCMIX
          GOTO      ABFM1000 IF NOT EQUAL
.
          MOVE      PINVNO,INVOICNO
          GOTO      ABFM3000          * found an ABF Invoice - do not calc.ABF
.
ABFM2000  MOVE      ZERO,PROGFLAG
          MOVE      ZERO,NWAUAMNT
          PROC      ABFMHINV          * Calculate ABF Invoice
          MOVE      SP70,INVOICNO
.
ABFM3000  OPEN      PMSABFA3,"pmsabfaf"
          OPEN      PMSPWAA1,"pmspwaaf"
          OPEN      PMSPWAA2,"pmspwaaf"
.
          CALL      CLPATDSC                   * Clear discharge record
          IF        ASTAT=3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin date
          REP       " 0",CPCDATE
          PACK      KEY16,CPCDATE,SP20
.
          MOVE      AFUNDH,D6                 * Save patient health fund
          MOVE      SP70,AFUNDH               * Blank HF, use Claim Grouper Ver.
          CALL      GETDRG
          MOVE      D6,AFUNDH                 * restore HF
          IF        OVRCD=0
            MOVE      DDRGCODE,PDRGCODE
          ENDIF
.
          MATCH     SP70,PDRGCODE
          IF        @EQUAL
            MOVE      PTMIPDRG,PDRGCODE        * Default to Admission DRG
            IF        ASTAT=3
              MATCH     SP70,PTDSDDRG
              IF        !@EQUAL
                MOVE      PTDSDDRG,PDRGCODE    * Use Discharged DRG
              ENDIF
            ENDIF
          ENDIF
.
          CALL      MCNT0000
          PACK      CONTRCID,CONTRCID,SP70
.
.         CALL      CLPMSPWA
.         MATCH     SP70,CONTRCID
.         IF        !@EQUAL & !@EOS
.           MATCH     SP70,PDRGCODE
.           IF        !@EQUAL & !@EOS
.             PACK      KEY10,CONTRCID,PDRGCODE,SP70
.             CALL      RDPMPWA1 
.             IF        OVRCD=1
.               CALL      CLPMSPWA
.             ENDIF 
.           ENDIF
.         ENDIF
.
.         MOVE      "Yes",KEY3
.         MATCH     "1",PMPWSDPY
.         IF        !@EQUAL
.           MOVE      "No ",KEY3
.         ENDIF
.
          PACK      KEY19,AADMNO,ZERO,ZERO,ONE,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      "Yes",KEY3
          COMPARE   ONE,PMABADJV
          IF        !@EQUAL
            MOVE      "No ",KEY3
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY6,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ELSE
            MOVE      PMABADJV,AACCAMNT
          ENDIF
.
          MOVE      PMABADJV,FORM10
.
          WRITE     HTMLFILE;"<table border=1 width=100%>":
                             "<tr><td width=17%>Admitted On:</td>":
                             "<td width=18%><b>",KEY16,"</b></td>":
                             "<td width=15%>Same-Day Payment List:</td>":
                             "<td width=18%><b>&nbsp; ",KEY3,"</b></td>":
                           "<td width=14%>Priv Pat Accom Adj.(overnight):</td>":
                             "<td width=18%><b>&nbsp;",PMABADJV,"</b></td>":
                             "</tr>";
. 
          MOVE      SP70,TDESC
          MATCH     SP70,ACLAIM
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY9,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10
.
          WRITE     HTMLFILE;"<tr><td>Claim Code:</td>":
                               "<td><b>",ACLAIM,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Bundled ICU:</td>":
                               "<td><b>No</b></td>":
                 "<td rowspan=2>Priv Pat Service - <br>  Psychogeriatric:</td>":
                   "<td rowspan=2><b>&nbsp;",PMABADJV,"</b></td>":
                               "</tr>";
.
          PACK      KEY14,AFUNDH,AFNDTB,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      SP70,HFNAME
            MOVE      SP70,PTHFBCAT
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,ZERO,FOUR,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,F10P4
.
          WRITE     HTMLFILE;"<tr><td>Health Fund:</td>":
                               "<td><b>",AFUNDH,"</b>":
                               " - <b>",HFNAME,"</b></td>":
                               "<td>Min Days Stay(Lower Bound):</td>":
                               "<td><b>&nbsp;",F10P4,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,PTHFBCAT
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSH,ANST,PTHFBCAT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,ZERO,FIVE,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,F10P4
.
          PACK      KEY19,AADMNO,ZERO,THIRTY,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Table Type:</td>":
                               "<td><b>",PTHFBCAT,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Max Days Stay(Upper bound):</td>":
                               "<td><b>&nbsp;",F10P4,"</b></td>":
                               "<td>Priv Pat Service - GEM:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "</tr>";
.
          CALL      GETM0000                               * In CMXMATRX.PBL
.
          PACK      KEY19,AADMNO,ZERO,ZERO,SIX,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,APPSAMNT        * APPS
          MOVE      PMABADJV,FRM10P4A
.
          PACK      KEY19,AADMNO,ZERO,THIRTY1,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Primary CMBS:</td>":
                               "<td><b>",PRICMBS,"</b></td>":
                               "<td>Private Patient Service %:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "<td>Priv Pat Service - Maint:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,ZERO,SEVEN,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
          DIV       "100",FORM10P4
.
          MOVE      SP70,DIM3
          PACK      KEY19,AADMNO,ZERO,THIRTY6,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ELSE
            MOVE      "RA3",DIM3
            MOVE      PMABADJV,ATAAMNTS
          ENDIF
.
          IF        PMABADJV=ZERO
            PACK      KEY19,AADMNO,ZERO,THIRTY7,INVOICNO,SP70
            CALL      RDPMABF3
            IF        OVRCD=ONE
              CALL      CLPMSABF
            ELSE
              MOVE      "RA4",DIM3
              MOVE      PMABADJV,ATAAMNTS
            ENDIF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr><td>Secondary CMBS:</td>":
                               "<td><b>",SECCMBS,"</b></td>":
                               "<td>Paediatric (Adjustments) %:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "<td>Hospital Remoteness Area:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"(",DIM3,")</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,ZERO,EIGHT,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,F10P4
.
          PACK      KEY19,AADMNO,ZERO,THIRTY8,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Tertiary CMBS:</td>":
                               "<td><b>",TERCMBS,"</b></td>":
                               "<td>Same Day (Price Weight):</td>":
                               "<td><b>&nbsp;",F10P4,"</b></td>":
                               "<td>HAC 1:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                          "<td><b>&nbsp;",FORM10P4,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          CALL      GETI0000                               * In CMXMATRX.PBL
.
          PACK      KEY19,AADMNO,ZERO,ZERO,NINE,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          PACK      KEY19,AADMNO,ZERO,THIRTY9,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Primary ICD Disease:</td>":
                               "<td><b>",PRIICDCD,"</b></td>":
                               "<td>Short Stay Outlier Base:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "<td>HAC 2:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                          "<td><b>&nbsp;",FORM10P4,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,ASRCE
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TEN,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          PACK      KEY19,AADMNO,ZERO,FORTY,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Admission Source:</td>":
                               "<td><b>",ASRCE,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Short Stay Outlier Per Diem:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "<td>HAC 3:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                          "<td><b>&nbsp;",FORM10P4,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,ATYPE
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TEN1,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          PACK      KEY19,AADMNO,ZERO,FORTY1,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr><td>Admission Type:</td>":
                               "<td><b>",ATYPE,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Inlier (Price Weight):</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "<td>HAC 4:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                          "<td><b>&nbsp;",FORM10P4,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          LOAD      AUDFCODE,PTCNCMAU,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                             AUSR7,PTMIUSR8,PTMIUSR9,PTMIUSR0
.
          PACK      KEY19,AADMNO,ZERO,TEN2,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.

.
          WRITE     HTMLFILE;"<tr><td>Admission UDF:</td>":
                               "<td><b>",AUDFCODE,"</b></td>":
                               "<td>Long Stay Outlier Per Diem:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "<td>HAC 5:</td>":
                               "<td><b>&nbsp;</b></td>":
                               "</tr>";
.

          MOVE      ADATE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD
          REP       " 0",TODATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE
          ENDIF
          CALL      NHOSPDAY
.         ADD       ADYHOSP,NBRDAYS
.
          MOVE      SP70,KEY16
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE  
            REP       " 0",CPCDATE
            PACK      KEY16,CPCDATE,SP20
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TEN3,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          IF        PMABADJV=ZERO
            PACK      KEY19,AADMNO,ZERO,TEN4,INVOICNO,SP70
            CALL      RDPMABF3
            IF        OVRCD=ONE
              CALL      CLPMSABF
            ENDIF
          ENDIF
.
          IF        PMABADJV=ZERO
            PACK      KEY19,AADMNO,ZERO,TEN5,INVOICNO,SP70
            CALL      RDPMABF3
            IF        OVRCD=ONE
              CALL      CLPMSABF
            ENDIF
          ENDIF
          MOVE      PMABADJV,F10P4
          MOVE      PMABADJV,ASPAAMNT       * A_SPA
.
          PACK      KEY19,AADMNO,ZERO,FORTY2,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Disch'd On:</td>":
                               "<td><b>",KEY16,"</b></td>":
                               "<td>Specialist Psychiatric Age:</td>":
                               "<td><b>&nbsp;",F10P4,"</b></td>":
.                              "<td><b>&nbsp;",F10P4,"</b>  ASPA </td>":
                               "<td>HAC 6:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                          "<td><b>&nbsp;",FORM10P4,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.         
          MOVE      SP70,TDESC
          MATCH     SP70,DSTAT
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM3
          MOVE      ZERO,FORM10P4
          PACK      KEY19,AADMNO,ZERO,TEN6,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ELSE
            MOVE      PMABADJV,FORM10P4
            MOVE      PMABADJV,ARESAMNT      * A_Res
            MOVE      "R2 ",DIM3 
          ENDIF
.
          IF        PMABADJV = ZERO
            PACK      KEY19,AADMNO,ZERO,TEN7,INVOICNO,SP70
            CALL      RDPMABF3
            IF        OVRCD=ONE
              CALL      CLPMSABF
            ELSE
              MOVE      PMABADJV,FORM10P4
              MOVE      PMABADJV,ARESAMNT      * A_Res
              MOVE      "RA3",DIM3
            ENDIF
          ENDIF
.
          IF        PMABADJV = ZERO
            PACK      KEY19,AADMNO,ZERO,TEN9,INVOICNO,SP70
            CALL      RDPMABF3
            IF        OVRCD=ONE
              CALL      CLPMSABF
            ELSE
              MOVE      PMABADJV,FORM10P4
              MOVE      PMABADJV,ARESAMNT      * A_Res
              MOVE      "RA4",DIM3
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,FORTY3,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Discharge Status:</td>":
                               "<td><b>",DSTAT,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Patient Remoteness Area Adj:</td>";
.                          "<td><b>&nbsp;",FORM10P4,"(",DIM3,")</b> ARes </td>":
.
          MATCH     SP70,DIM3
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><b>&nbsp;",FORM10P4,"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>&nbsp;",FORM10P4,"(",DIM3,")</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>HAC 7:</td>":
                             "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,DDEST
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY1,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
          MOVE      PMABADJV,AINDAMNT        * A_Ind
.
          PACK      KEY19,AADMNO,ZERO,FORTY4,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Discharge Destination:</td>":
                               "<td><b>",DDEST,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Indigenous Adjustment:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                              "<td><b>&nbsp;",FORM10P4,"</b>  AInd  </td>":
                               "<td>HAC 8:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,ACARE
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY2,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
          MOVE      PMABADJV,ARTAMNTS          * A_RT
.
          PACK      KEY19,AADMNO,ZERO,FORTY5,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Care Class:</td>":
                               "<td><b>",ACARE,"</b>":
                               " - <b>",TDESC,"</b></td>":
                               "<td>Radiotherapy Adjustment:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                              "<td><b>&nbsp;",FORM10P4,"</b> ART </td>":
                               "<td>HAC 9:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,TWENTY3,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
          MOVE      PMABADJV,ADIAAMNT          * A_Dia
.
          PACK      KEY19,AADMNO,ZERO,FORTY6,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Contract ID:</td>":
                               "<td><b>",CONTRCID,"</b></td>":
                               "<td>Dialysis Adjustment:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
.                              "<td><b>&nbsp;",FORM10P4,"</b>  ADia</td>":
                               "<td>HAC 10:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,KEY50
          MATCH     SP70,CONTRCID
          IF        !@EQUAL 
            IF        CNTRCEFR=0
              MOVE      "As at the Effective date",KEY50
            ENDIF
            IF        CNTRCEFR=1
              MOVE      "For Admission From",KEY50
            ENDIF
            IF        CNTRCEFR=2
              MOVE      "For Discharge From",KEY50
            ENDIF
            IF        CNTRCEFR=3
              MOVE      "Contract Effective Details not valid/found",KEY50
            ENDIF
          ENDIF 
          PACK      KEY50,KEY50,SP70
.
          PACK      KEY19,AADMNO,ZERO,TWENTY5,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ELSE
            MOVE      PMABADJV,AACCAMNT
          ENDIF
          MOVE      PMABADJV,FORM10P4
.
          PACK      KEY19,AADMNO,ZERO,FORTY7,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Contract Effective:</td>":
                               "<td><b>",KEY50,"</b></td>":
                               "<td>Priv Pat Accom Adj.(sameday):</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "<td>HAC 11:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,KEY10
          MATCH     SP70,CONTRCID
          IF        !@EQUAL & !@EOS
            PACK      KEY6,CONTRCID,SP70
            CALL      RDPMCID1
            IF        OVRCD=0
              MATCH     SP70,PMCIFDAT
              IF        !@EQUAL & !@EOS
                UNPACK    PMCIFDAT,CCENT,CYEAR,CMON,CDAY
                PACK      KEY10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,SP70
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY7,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
.
          PACK      KEY19,AADMNO,ZERO,FORTY8,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
.
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Effective From Date:</td>":
                               "<td><b>",KEY10,"</b></td>":
                               "<td>Priv Pat Service - Palliative:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "<td>HAC 12:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      SP70,KEY10
          MATCH     SP70,CONTRCID
          IF        !@EQUAL & !@EOS
            PACK      KEY6,CONTRCID,SP70
            CALL      RDPMCID1
            IF        OVRCD=0
              MATCH     SP70,PMCITDAT
              IF        !@EQUAL & !@EOS
                UNPACK    PMCITDAT,CCENT,CYEAR,CMON,CDAY
                PACK      KEY10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,SP70
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,TWENTY8,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FORM10P4
.
          PACK      KEY19,AADMNO,ZERO,FORTY9,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Effective To Date:</td>":
                               "<td><b>",KEY10,"</b></td>":
                               "<td>Priv Pat Service - Rehab:</td>":
                               "<td><b>&nbsp;",FORM10P4,"</b></td>":
                               "<td>HAC 13:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          MOVE      ZERO,F6
          MOVE      SP70,KEY6
          PACK      KEY19,AADMNO,ZERO,FIFTY9,INVOICNO,SP70      * Charlson Score
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
            MOVE      SP70,KEY6
          ELSE
            MOVE      PMABADJV,F6
            MOVE      F6,KEY6
          ENDIF
.
          PACK      KEY19,AADMNO,ZERO,FIFTY,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          PACK      KEY19,AADMNO,ZERO,SIXTY3,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,AHACAMNT
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Charlson Score</td>":
                               "<td><b>",KEY6,"</b></td>":
                               "<td>AHAC Adjustment</td>":
                               "<td><b>&nbsp;",PMABADJV,"</b></td>":
                               "<td>HAC 14:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,FIFTY1,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
.
          WRITE     HTMLFILE;"<tr>":
                               "<td>Provisional DRG (Uncoded Pats)</td>":
                               "<td><b>",PTMIPDRG,"</b></td>":
                               "<td>ICU Adjustment:</td>":
                               "<td><b>&nbsp;</b></td>":
                               "<td>HAC 15:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
.                          "<td><b>&nbsp;",FRM10P4A,"<br>",PMABCDES,"</b></td>":
                               "</tr>";
.
          WRITE     HTMLFILE;"<tr><td>Discharge DRG:</td>":
                               "<td><b>",PTDSDDRG,"</b></td>":
                               "<td>Days of Previous Hospitalisation:</td>":
                               "<td><b>&nbsp;",ADYHOSP,"</b></td>":
                               "<td>HAC 16:</td>":
                               "<td><b>&nbsp;</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,SIXTY2,INVOICNO,SP70      * PW
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,FRM10P4A
          MOVE      PMABADJV,PWAMOUNT          * PW
.
.
.         Complete LOS = ADATE to Disc.or Current
.
          MOVE      ADATE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD
          REP       " 0",TODATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE
          ENDIF
          MOVE      ZERO,F6
          DAYSEP    ADATE,TODATE,F6           * LOS
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>Complete LOS</td>":
                               "<td><b>&nbsp;",F6,"</b></td>":
                               "<td>Price Weight:</td>":
                               "<td><b>&nbsp;",FRM10P4A,"</b></td>":
                               "</tr>";
.
          PACK      KEY19,AADMNO,ZERO,SEVENTY3,INVOICNO,SP70      * AMHCC Code
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          WRITE     HTMLFILE;"<tr><td>Invoiced AMHCC End Class</td>":
                               "<td><b>&nbsp;",PMABCDES,"</b></td>";
.
.  Leave days = LOS(ADATE to Disc.or Current) - Days without Leave(NBRDAYS)
.
          SUB       NBRDAYS,F6                * LOS without Leaves
.
          PACK      KEY19,AADMNO,ZERO,FIFTY3,INVOICNO,SP70      * NWAU
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ELSE
            MATCH     SP70,INVOICNO
            IF        !@EQUAL
              MOVE      SP70,KEY19
              UNPACK    PMABCDES,KEY19      * get NWAU amount with 6 decimal
              SQUEEZE   KEY19
              MOVE      KEY19,NWAUAMNT
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>No.of Leave Days:</td>":
                             "<td><b>&nbsp;",F6,"</b></td>":
                             "<td>NWAU:</td>":
                             "<td><b>&nbsp;",PMABADJV,"</b></td>":
                             "</tr>";
.
          MOVE      ZERO,F6
          PACK      KEY19,AADMNO,ZERO,SIXTY4,INVOICNO,SP70
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,F6
          MOVE      PMABADJV,LOSNDAYS
.
          WRITE     HTMLFILE;"<tr><td></td>":
                               "<td></td>":
                               "<td>Billable LOS</td>":
                               "<td><b>&nbsp;",F6,"</b></td>":
                               "<td></td>":
                               "<td></td>":
                               "</tr>";
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          PACK      KEY19,AADMNO,ZERO,SIXTY1,INVOICNO,SP70      * NEP
          CALL      RDPMABF3
          IF        OVRCD=ONE
            CALL      CLPMSABF
          ENDIF
          MOVE      PMABADJV,NEPAMNTS
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td><b></b></td>":
                               "<td>NEP:</td>":
                               "<td><b>&nbsp;",PMABADJV,"</b></td>":
                               "</tr></table>";
.
          CALL      MCAL00000                 * Display ABF calculation
          GOTO      ABFM9999
.
ABFM9000  WRITE     HTMLFILE;"<tr><center><b>ABF/NWAU Details ":
                             "are not applicable to this event</b></td>":
                             "</center></tr>";
          GOTO      ABFM9999
.
ABFM9999  RETURN
+
.*******************************************************************************
.         Display ABF Calculation
.*******************************************************************************
MCAL0000  CALL      MHBF0000                * Calculate ABF amount
          MOVE      ABFCHRGE,FORM12P2
.
.
.{[PW x APaed x (1 + ARes + AInd) x (1 + ATreat)] - 
. [PW x APPS + LOS x AAcc]} x NEP
.
          WRITE     HTMLFILE;"<table border=1 width=100%><tr><td>":
                      "ABF Calculation:</td></tr>":
                      "<tr><td>":
                      "= {[PW x APaed x ":
                      "(1 + ARes + AInd) x ":
                      "(1 + ATreat)] - ":
                      "[PW x APPS + LOS x AAcc]} x ":
                      "NEP</td></tr>";
.
          WRITE     HTMLFILE;"<tr><td>":
                      "= {[ ",PWAMOUNT," x 1 x ":
                      "(1 + ",ARESAMNT," + ",AINDAMNT,") x ":
                      "(1 + ",ATAAMNTS,")] - ":
                      "[ ",PWAMOUNT," x ",APPSAMNT:
                      " + ",LOSNDAYS," x ",AACCAMNT," ]} x ":
                      " $",NEPAMNTS," </td></tr>";
.
          WRITE    HTMLFILE;"<tr><td>":
                      "= $",FORM12P2,"</td></tr><table>"
.
MCAL9999  RETURN
+
.*******************************************************************************
.         Look for a Contract ID
.*******************************************************************************
MCNT0000  PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,MCNT9000
.
          MOVE      ADATE,CEFFDATE         * default to admission date
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
          PACK      KEY10,PDRGCODE,SP70
          CALL      RSPMPWA2
MCNT1000  CALL      RKPMPWA2
          BRANCH    OVRCD,MCNT9000
.
          MATCH     PMPWDRGC,PDRGCODE
          GOTO      MCNT9000 IF NOT EQUAL     * Different DRG Code
.
          MOVE      PMPWCNTR,KEY6
          CALL      VALCONTR                * Validate Contract ID
          BRANCH    EXIT,MCNT1000
.
          MOVE      PMPWCNTR,CONTRCID
          MOVE      ZERO,EXIT
          GOTO      MCNT9999
.
MCNT9000  MOVE      ONE,EXIT
MCNT9999  RETURN
+
.*******************************************************************************
.         Calculate ABF amount
.*******************************************************************************
MHBF0000  MATCH     SP70,INVOICNO
          IF        !@EQUAL
            MOVE      NWAUAMNT,ABFCHRGE      * NWAU amount in 6 decimal places
            GOTO      MHBF9000
          ENDIF
.
.        {[PW x APaed x (1 + ARes + AInd) + (1 + ATreat)] -
.        [PW x APPS + LOS x AAcc]} x NEP
.
          MOVE      ONE,F106A
          ADD       ARESAMNT,F106A           * A_Res
          ADD       AINDAMNT,F106A           * A_Ind
.
          MOVE      ONE,F106B                * 1 +
          ADD       ATAAMNTS,F106B           * A_ATA/A_Treat
.
          MOVE      LOSNDAYS,F106C           * LOS
          MULT      AACCAMNT,F106C           * AAcc
.
          IF        APPSAMNT>0
            DIV       "100",APPSAMNT
          ENDIF
          MOVE      PWAMOUNT,F106D           * PW
          MULT      APPSAMNT,F106D           * APPS
          ADD       F106C,F106D
.
          MOVE      PWAMOUNT,F106C           * [PW
          MULT      F106A,F106C              * x (1+A_Res+A_Ind)
          MULT      F106B,F106C              * x (1 + ATreat)]
          SUB       F106D,F106C              * - [PW x APPS + LOS x AAcc]
          MOVE      F106C,ABFCHRGE           * NWAU
.
MHBF9000  IF        ABFCHRGE<0
            MOVE      ZERO,ABFCHRGE           * No negative NWAU
          ENDIF
          MULT      NEPAMNTS,ABFCHRGE         * ABF Charge= NWAU x NEP
.
MHBF9999  RETURN
+
.*******************************************************************************
.         Initialise variables 
.*******************************************************************************
MINT0000  MOVE      ZERO,CALCFLAG
          MOVE      ZERO,COVIDFLG
          MOVE      ZERO,PWAMOUNT
          MOVE      ZERO,ASPAAMNT
          MOVE      ZERO,AINDAMNT
          MOVE      ZERO,ARESAMNT
          MOVE      ZERO,ATAAMNTS
          MOVE      ZERO,ARTAMNTS
          MOVE      ZERO,APPSAMNT
          MOVE      ZERO,AACCAMNT
.
          MOVE      ZERO,ADIAAMNT
          MOVE      ZERO,LOSNDAYS
          MOVE      ZERO,AHACAMNT
          MOVE      ZERO,NEPAMNTS
          MOVE      ZERO,ABFCHRGE
          MOVE      ZERO,NWAUAMNT
MINT9999  RETURN
.
