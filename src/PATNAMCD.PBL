.------------------------------------------------------------
. File       : PATNAMCD.PBL
.
. Functions  : This file contains standard routines for
.              Displaying Patient Names in different formats
.
. Routines   : PATLNM00  - Formats name depending on System Parameter
.
. Variables  : Inputs  - Valid Read of Master File
.                        Patient Age Already Calcuated with CALCAGE
.              Returns - FORMATNM - Formated Name   
.
.------------------------------------------------------------
.      V12.00.02  12/06/2025  Don Nguyen        TSK 0961844 & 0961881
.                 Corrected code to resize VAR accordingly for Paediatric icon
.      V12.00.01  02/06/2025  Don Nguyen        TSK 0960938
.                 Output Paediatric Icon as a DIV instead of IMG; PATLN900
.      V11.05.02  23.01.2025  PJ Le Febour      TSK 0836234a
.                 PATLN900 - corrected html tag display Paediatric Icon
.      V11.05.01  11.12.2024  PJ Le Febour      TSK 0836234
.                 added read of param CWEBPAED display PaedIcon 1=Y 0=N
.                 added read of param CAGECOFF Paediatric age limit 14  
.                 PATLN900 display Paediatric Icon patient age less than 14      
.      V11.02.02  05.04.2022  Ebon Clements     TSK 0913610
.                 Removed white space from gender HDP display
.                 ADHDPG00
.      V11.02.01  01.04.2022  DA Sarkies        TSK 0906511
.                 Added selection so that customer can choose to display
.                 HDP code for gender, or code. Added function to check if
.                 patient deceased, and date of death recorded, and display
.                 age to date of death
.      V11.00.01  14/04/2020  Ebon Clements     TSK 0890104
.                 Added preferred name formats 29 to 42
.      V10.15.01  07/10/2019  Ebon Clements     TSK 0878316
.                             Added name formats 21 to 28
.      V10.08.02  16/09/2016  Ebon Clements     TSK 0826212
.                             Pack PTMASNAM with SP70 after STRIP
.      V10.08.01  25/07/2016  Ania P            CAR 320468
.                             Changed PSNAME to PTMASNAM so last name
.                             doesnt get truncated if longer than DIM 20
.       V9.10.01  26/08/2008  Ebon Clements     CAR 174175
.                             Fixed DOB display bug for surname "AN"
.       V9.07.01  20/09/2006  Jill Habasque     CAR 109852
.                             Added alternate ID's
.       V9.03.01  01/12/2003  Peter Vela        CAR 40355
.                             Added new Patient Name formats with DOBs
.	V9.02.01  06/10/2001  Glenn Saunders
.                             Don't append comma for "Anonymous"
.	V5.09.00  03/01/2001  Bronko Sosic
.                             Created Include
.------------------------------------------------------------
PATLN000  MOVE     PGNAME,FMTGNAME
          MOVE     PTITL,FMTTITLE
.
          READ     CONTROLF,HUND01;*45,CWEBPNAM 
          READ     CONTROLF,HUND10;*249,PTCNDAUR 
          READ     CONTROLF,HUND01;*96,CWEBGVTD
          READ     CONTROLF,HUND01;*106,CWEBPAED
          READ     CONTROLF,TEN;*94,CAGECOFF
          MOVE     CWEBPNAM,F2
          SFORMAT  FORMATNM,127
          SFORMAT  VAR,127
          PACK     FORMATNM,SP70,SP70
          REP      "#" ",PTMASNAM
          REP      "#" ",FMTGNAME
          REP      UPPLOW,PTMASNAM
.
          CLEAR    DISPNAME
          PACK     NAME35,FMTTITLE,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTTITLE   
          STRIP    FMTTITLE    
.
          CLEAR    DISPNAME
          PACK     NAME35,FMTGNAME,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTGNAME   
          STRIP    FMTGNAME    
.
          CALL     CLDCAG00
.
          STRIP    PTMASNAM
          CLEAR    FORMATNM
          APPEND   "<b>",FORMATNM
          APPEND   PTMASNAM,FORMATNM
          APPEND   "</b>",FORMATNM
          PACK     PTMASNAM,PTMASNAM,SP70
.
          PACK     KEY9,PTMASNAM,SP70
.
          MATCH    "ANONYMOUS",KEY9                   * match all 9 characters
          GOTO     PATLN005 IF EQUAL
.
          APPEND   COMMA,FORMATNM
.
          UNPACK   PBDATE,CCENT,CYEAR,CMON,CDAY        * I CAR 40355
.
PATLN005  APPEND   SP1,FORMATNM
          BRANCH   F2,PATLN010,PATLN020,PATLN030,PATLN040,PATLN050:
                      PATLN060,PATLN070,PATLN080,PATLN090,PATLN100:
                      PATLN110,PATLN120,PATLN130,PATLN140,PATLN150:
                      PATLN160,PATLN170,PATLN180,PATLN190,PATLN200:
                      PATLN210,PATLN220,PATLN230,PATLN240,PATLN250:
                      PATLN260,PATLN270,PATLN280,PATLN290,PATLN300:
                      PATLN310,PATLN320,PATLN330,PATLN340,PATLN350:
                      PATLN360,PATLN370,PATLN380,PATLN390,PATLN400:
                      PATLN410,PATLN420
.
          GOTO     PATLN999
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,First Initial (U/R No)
.------------------------------------------------------------
PATLN010  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
.
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900           
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,First Initial (Age,Sex)
.------------------------------------------------------------
PATLN020  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900          
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,First Initial (Age,Sex,U/R)
.------------------------------------------------------------
PATLN030  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title First Initial (U/R No)
.------------------------------------------------------------
PATLN040  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900           
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title First Initial (Age,Sex)
.------------------------------------------------------------
PATLN050  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900          
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title First Initial (Age,Sex,U/R)
.------------------------------------------------------------
PATLN060  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Given Name (U/R No)
.------------------------------------------------------------
PATLN070  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900           
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Given Name (Age,Sex)
.------------------------------------------------------------
PATLN080  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900          
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Given Name (Age,Sex,U/R)
.------------------------------------------------------------
PATLN090  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title Given Name (U/R No)
.------------------------------------------------------------
PATLN100  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900           
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title Given Name (Age,Sex)
.------------------------------------------------------------
PATLN110  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900           
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>,Title Given Name (Age,Sex,U/R)
.------------------------------------------------------------
PATLN120  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,First Initial (DOB,Sex)
.------------------------------------------------------------
PATLN130  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,First Initial (DOB,Sex,U/R No)
.------------------------------------------------------------
PATLN140  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Title First Initial (DOB,Sex)
.------------------------------------------------------------
PATLN150  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Title First Initial (DOB,Sex,U/R)
.------------------------------------------------------------
PATLN160  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------  * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Given Name (DOB,Sex)
.------------------------------------------------------------
PATLN170  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00      
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Given Name (DOB,Sex,U/R)
.------------------------------------------------------------
PATLN180  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Title Given Name (DOB,Sex)
.------------------------------------------------------------
PATLN190  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   * I CAR 40355
. Format Patient Name <b>SURNAME</b>,Title Given Name (DOB,Sex,U/R)
.------------------------------------------------------------
PATLN200  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,First Initial (Age,DOB,Sex,U/R No)
.------------------------------------------------------------
PATLN210  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00      
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,First Initial (DOB,Age,Sex,U/R No)
.------------------------------------------------------------
PATLN220  MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title First Initial (Age,DOB,Sex,U/R)
.------------------------------------------------------------
PATLN230  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title First Initial (DOB,Age,Sex,U/R)
.------------------------------------------------------------
PATLN240  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          MOVE     FMTGNAME,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM

          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name (Age,DOB,Sex,U/R)
.------------------------------------------------------------
PATLN250  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name (DOB,Age,Sex,U/R)
.------------------------------------------------------------
PATLN260  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name (Age,DOB,Sex,U/R)
.------------------------------------------------------------
PATLN270  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name (DOB,Age,Sex,U/R)
.------------------------------------------------------------
PATLN280  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (U/R No)
.------------------------------------------------------------   
PATLN290  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,Sex)
.------------------------------------------------------------   
PATLN300  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Sex)
.------------------------------------------------------------   
PATLN310  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00     
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,Sex,U/R)
.------------------------------------------------------------   
PATLN320  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Sex,U/R) 
.------------------------------------------------------------   
PATLN330  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,DOB,Sex,U/R)
.------------------------------------------------------------   
PATLN340  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Age,Sex,U/R)
.------------------------------------------------------------   
PATLN350  APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (U/R No)
.------------------------------------------------------------   
PATLN360  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,Sex)
.------------------------------------------------------------   
PATLN370  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Sex)
.------------------------------------------------------------   
PATLN380  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,Sex,U/R)
.------------------------------------------------------------   
PATLN390  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Sex,U/R)
.------------------------------------------------------------   
PATLN400  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name 
. <b>[Preferred Surname, Preferred Given Name]</b> (Age,DOB,Sex,U/R)
.------------------------------------------------------------   
PATLN410  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.------------------------------------------------------------   
. Format Patient Name <b>SURNAME</b>,Title Given Name
. <b>[Preferred Surname, Preferred Given Name]</b> (DOB,Age,Sex,U/R)
.------------------------------------------------------------   
PATLN420  APPEND   FMTTITLE,FORMATNM
          APPEND   SP1,FORMATNM
          APPEND   FMTGNAME,FORMATNM
          APPEND   SP1,FORMATNM
          CALL     ADDPNM00            * Add preferred name
          APPEND   LBRACK,FORMATNM
          CALL     ADDDOB00
          APPEND   COMMA,FORMATNM
          CALL     ADDAGE00
          APPEND   COMMA,FORMATNM
          CALL     ADHDPG00 
          APPEND   COMMA,FORMATNM
          MATCH    "1",PTCNDAUR
          IF       @EQUAL
            PROC     GETALIDS
            MATCH    SP20,KEY20
            IF       !@EQUAL
              APPEND   KEY20,FORMATNM
            ELSE
              APPEND   PURNO,FORMATNM
            ENDIF
          ELSE
            APPEND   PURNO,FORMATNM
          ENDIF
          APPEND   RBRACK,FORMATNM
          GOTO     PATLN900
.
.
.
PATLN900  MATCH     "1", CWEBPAED      * Display Paediatric Icon
          IF        @EQUAL
            IF        PSAGEYRS < CAGECOFF
              APPEND    "<div class='Paed'></div>",FORMATNM
            ENDIF
          ENDIF
.
          APPEND    SP70,FORMATNM
          RESET     FORMATNM
          MOVE      FORMATNM,VAR
          STRIP     FORMATNM
          MOVELPTR  FORMATNM,LENGTH
          IF        LENGTH=0
            SFORMAT   FORMATNM,1
          ELSE
            SFORMAT   FORMATNM,LENGTH
          ENDIF
          MOVE      VAR,FORMATNM
.
PATLN999  RETURN
+
.-----------------------------------------------------------
. Format age in years months or weeks depending on CALCAGE
.-----------------------------------------------------------
ADDAGE00  MATCH     "y",PSAGETYP
          GOTO      ADDAGE10 IF NOT EQUAL
          MOVE      PSAGEYRS,D3
          SQUEEZE   D3
          APPEND    D3,FORMATNM
          APPEND    PSAGETYP,FORMATNM
          GOTO      ADDAGE99
.
ADDAGE10  MATCH     "d",PSAGETYP
          GOTO      ADDAGE20 IF NOT EQUAL
          MOVE      PSAGEDAY,D5
          SQUEEZE   D5
          APPEND    D5,FORMATNM
          APPEND    PSAGETYP,FORMATNM
          GOTO      ADDAGE99
.
ADDAGE20  MATCH     "m",PSAGETYP
          GOTO      ADDAGE30 IF NOT EQUAL
          MOVE      PSAGEMNT,D4
          SQUEEZE   D4
          APPEND    D4,FORMATNM
          APPEND    PSAGETYP,FORMATNM
          GOTO      ADDAGE99
.
ADDAGE30  MATCH     "w",PSAGETYP
          GOTO      ADDAGE99 IF NOT EQUAL
          MOVE      PSAGEWKS,D8
          SQUEEZE   D8
          APPEND    D8,FORMATNM
          APPEND    PSAGETYP,FORMATNM
.
ADDAGE99  RETURN
.-----------------------------------------------------------
. Calculate deceased age 
.-----------------------------------------------------------
.
CLDCAG00  COMPARE   ONE,PCEASE
          GOTO      CLDCAG99 IF NOT EQUAL
          MATCH     SP70,PDECDTE
          GOTO      CLDCAG99 IF EQUAL
          MOVE      PDECDTE,AGEDATE
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
CLDCAG99  RETURN

.-----------------------------------------------------------
. Format DOB with Slashes
.-----------------------------------------------------------
ADDDOB00  APPEND   CDAY,FORMATNM
          APPEND   SLASH,FORMATNM
          APPEND   CMON,FORMATNM
          APPEND   SLASH,FORMATNM
          APPEND   CCENT,FORMATNM
          APPEND   CYEAR,FORMATNM
.
ADDDOB99  RETURN
.
.-----------------------------------------------------------
. Add <b>[Preferred Surname, Preferred Given Name]</b>
.-----------------------------------------------------------
ADDPNM00  MOVE      ZERO,F1              * No preferred name printed
.
          MOVE      PMPXPFSN,KEY20       * Preferred surname in KEY20
          REP       UPPLOW,PTMASNAM      * Upper case
          REP       "#" ",KEY20          * Remove double quotes
          STRIP     KEY20
.
          MOVE      PMPXPFGN,KEY25       * Preferred given name in KEY25
          REP       "#" ",KEY25          * Remove double quotes
          CLEAR     DISPNAME
          PACK      NAME35,KEY25,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,KEY25
          STRIP     KEY25
.
          MATCH     SP70,KEY20           * Preferred surname populated
          IF        !@EQUAL & !@EOS
            APPEND    "<b>[",FORMATNM
            APPEND    KEY20,FORMATNM
            MOVE      ONE,F1             * Preferred name printed
          ENDIF
.
          MATCH     SP70,KEY25
          IF        !@EQUAL & !@EOS
            IF        F1=1
              APPEND    COMMA,FORMATNM   * Add comman and space before
              APPEND    SP1,FORMATNM     * preferred given name
            ELSE
              APPEND    "<b>[",FORMATNM  * Start preferred name
            ENDIF
.
            APPEND    KEY25,FORMATNM
            MOVE      ONE,F1             * Preferred name printed
          ENDIF
.
          IF        F1=1
            APPEND    "]</b> ",FORMATNM  * End printed preferred name
          ENDIF
.
ADDPNM99  RETURN
.
.-----------------------------------------------------------
. Add HDP Gender Code instead of standard Gender Code 
.-----------------------------------------------------------
ADHDPG00  MATCH     " 2",CWEBGVTD 
          IF        @EQUAL
            GOTO      ADHDPG10
          ENDIF
          GOTO      ADHDPG80 

ADHDPG10  PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADHDPG80
.
          SQUEEZE   THCSCOD
          APPEND    THCSCOD,FORMATNM
          RESET     THCSCOD
          GOTO      ADHDPG99
.
ADHDPG80  APPEND    PSEX,FORMATNM

ADHDPG99  RETURN
