.******************************************************************************
.* System   : ACCIDENT & EMERGENCY                                            *
.* Include  : AAEINVS                                                         *
.* Desc     : Invoice Generation and Printing                                 *
.******************************************************************************
.* Function : This include controls the printing of invoices for A&E patients.*
.*            All invoice layouts are controlled through this include, the    *
.*            code that is invoice layout dependent being located in the      *
.*            include PATINVTn, where "n" if the invoice layout.              *
.******************************************************************************
.* Mods     :                                                                 *
.*       V12.00.01 14/05/2025  Bella Turco     TSK 0955096                    *
.*                 Alphanumeric changes                                       *
.*       V11.05.01 21/02/2025  J.Tan   TSK 0955356                            *
.*                 Added FININVN,FINADMN,FINURNO - Financial details          *
.*       V11.02.01 03/03/2022  J.Tan           TSK 0902652                    *
.*                 Mod for Patient Invoice new functionality (PTCNPPIN=1)     *
.*       V11.01.01 01/10/2020  J.Tan            TSK 0911732                   *
.*                 Mod checking for 'tobe invoiced' amount (CKPD000)          *
.*       V11.00.02 04/06/2020  J.Tan            TSK 0886178                   *
.*                 Mod not to apply deposit to ABF Invoice                    *
.*       V11.00.01 31/03/2020  J.Tan            TSK 0868813                   *
.*                 Changed PKNAME from DIM30 to DIM 80                        *
.*       V10.14.03 24/09/2019  J.Tan            TSK 0857392                   *
.*                 Updating Invoice number ot ABF file                        *
.*       V10.14.02 23/09/2019  J.Tan            TSK 0857392                   *
.*                 Fixed ABF Invoice pending                                  *
.*       V10.14.01 20/03/2019  J.Tan            TSK 0857392                   *
.*                 Changed RCP Transaction count from DIM3 to DIM5            *
.*       V10.13.02 20/09/2018  J.Tan        TSK 0863727                       *
.*                 Added Restrictive Override code                            *
.*       V10.13.01 21/08/2017  J.Tan        TSK 0859742                       *
.*                 Added ECLIPSE new fields from aaedtr                       *
.*       V10.12.01 27/04/2018  J.Tan          Task 0845996                    *
.*                 Mod to update CMDEUDAT,CMDEUTIM and CMDEUUID               *
.*       V10.07.01 21/12/2015  J.Tan        CAR 0303942                       *
.*                 Added ATDTPCOD - Payment code                              *
.*       V10.05.01 05/08/2014  Peter Vela   CAR 302164                        *
.*                 Added ATDTRBRS - Rebate Reason CAT Rr                      *
.*       V10.04.02 01/05/2014  J.Tan        CAR 261630                        *
.*                 Removed patauc Cash audit file                             *
.*       V10.04.01 27/02/2014 J.Tan         CAR 275810                        *
.*                 Mods to check Defence force claim                          *
.*       V10.02.01 29/03/2011  Jill Parkinson CAR 239574                      *
.*                 Removed opens of ibaprntf                                  *
.*       V10.01.02 13/01/2011  Mike Laming    CAR 233084                      *
.*                 Added new include CLPATINV (Added PTINCNID) in ZEROINV     *
.*       V10.01.01 06/01/2011 Jill Parkinson CAR 233088                       *
.*                 Added move to PMVXFNDM                                     *
.*       V10.00.02 23/09/2010 J.Tan         CAR 230664                        *
.*                 Mods for HEC invoice layout - PTCNINVL=18                  *
.*       V10.00.01 19/04/2010  J.Tan        CAR 219670                        *
.*                 Mods to set date/time updated to rcpdteaf file             *
.*       V9.12.03  05/10/2009  J.Tan        CAR 191624                        *
.*                 Mods to set the Deposit Applied date to Current date       *
.*       V9.12.02  16/07/2009  J.Tan        CAR 199759                        *
.*                 Mods to printing claim for Pendlebury layout               *
.*       V9.12.01  03/06/2009  J.Tan        CAR 198199                        *
.*                 Fixed printing invoice for ALL doctors                     *
.*       V9.10.05  12/08/2008  J.Tan        CAR 175967                        *
.*                 Fixed printing provider number                             *
.*       V9.10.04  04/08/2008  J.Tan        CAR 175246                        *
.*                 Fixed printing for ALL Doctor Invoice(Cabrini)             *
.*       V9.10.03  22/07/2008 J.Tan      CAR 173734                           *
.*                 Fixed doctor name for Emergency invoice header             *
.*       V9.10.02  23/05/2008 J.Tan      CAR 169149                           *
.*                 Added Date and Time invoice created/updated                *
.*       V9.10.01  05/05/2008 J.Tan      CAR 162313                           *
.*                 Added Deposit status to comdepaf file                      *
.*       V9.09.05  14/04/2008 J.Tan      CAR 161684                           *
.*                 Mods to set ATSPARE1 variable from aaedtref                *
.*       V9.09.04  12/03/2008 J.Tan      CAR 163659                           *
.*                 Mods to remove closing patipen file (I*C)                  *
.*       V9.09.03  01/11/2007 J.Tan      CAR 151803                           *
.*                 Mods to display Out of Pocket amount                       *
.*       V9.09.02  05/07/2007 Peter Vela CAR 144548                           *
.*                 Initialised PRA variables to PMI values                    *
.*       V9.09.01  12/06/2007 J.Tan      CAR 142173                           *
.*                 Added GST amount                                           *
.*       V9.08.04  09/05/2007 Peter Vela CAR 142173                           *
.*                 Initialsed new aaedtref variables                          *
.*       V9.08.03  07/05/2007 J.Tan   CAR 140282                              *
.*                 Mods to initialise batch no of aaedtref                    *
.*       V9.08.02  22/02/2007 Mike Laming   CAR 119436                        *
.*                 Add PROC FLAGDEBT (PMSOSDTM) for Outstanding Debt Alert ind.
.*       V9.08.01  14/11/2006 Peter Vela CAR 124547                           *
.*                 Added functionality for PTCNDEES and PTCNDDES              *
.*                 Change PRFA when Patient Deceased                          *
.*       V9.07.01  11/08/2006 J.Tan   CAR 103365                              *
.*                 Added Invoice discount and rounding amount                 *
.*       V9.04.05  25/10/2005 Sandra Barcham  81362                           *
.*                 Fixed incorrect packing of fincode for deposits            *
.*       V9.04.04  18/11/2004 J.Tan   CAR 54392                               *
.*                 Mods to set up discharged date from emrvisaf file          *
.*       V9.04.03  05/10/2004 J.Tan   CAR 53798                               *
.*                 Removed PATDSMSC                                           *
.*       V9.04.02  22/09/2004 Lina Vo CAR 53660                               *
.*                 Changed for Multi Hospital to use PTHSTFEE instead         *
.*                 of PTCNTFEE                                                *
.*       V9.04.01  20/08/2004 J.Tan  CAR 52835                                *
.*                 Initialise hospital ID for patfinsf                        *
.*       V9.03.12  10/08/2004 J.Tan  CAR 52504
.*                 Mods checking for register for non banked deposit
.*       V9.03.11  30/06/2004 J.Tan  CAR 51112
.*                 Mods to check for unrelease deposit when printing invoice
.*       V9.03.10  11/06/2004 J.Tan  CAR 50035                                *
.*                 Mods to set mechanical vent var from pmsmtiaf              *
.*       V9.03.09  01/06/2004 J.Tan  CAR 50273
.*                 Exclude cancelled non-bank deposit
.*       V9.03.08  25/05/2004 J.Tan  CAR 50111
.*                 Fixed I*C patirngaf file                                   *
.*       V9.03.07  13/05/2004 J.Tan  CAR 49827
.*                 Mods to get non-banked deposit                             *
.*       V9.03.06  09/01/2004 J.Tan                                           *
.*                 Fixed setting invoice number for rcpdteaf file             *
.*       V9.03.05  18/12/2003  J.Tan                                          *
.*                 Replaced patcash with comdepaf file                        *
.*       V9.03.04  20/10/2003  J.Tan    CAR 44172                             *
.*                 Mods to read misc.theatre item file (pmsmitaf)             *
.*       V9.03.03  17/09/2003 Lina Vo     CAR 40497                           *
.*                 Changed index and read of patmchgf to include effective    *
.*                 date.                                                      *
.*       V9.03.02  01/08/2003 J.Tan                                           *
.*                 Changed the colour of the invoice heading                  *
.*       V9.03.01  27/06/2003 J.Tan                                           *
.*                 Mods for WEB to check if any invoice to be printed         *
.*       V9.02.08  11/04/2003  Davin  CAR/Quote 23297 (misc. charges keyin)   *
.*                 When keyin rebate flag="Y", display default patient/rebate *
.*                 amounts                                                    *
.*       V9.02.07  08/04/2003  J.Tan                                          *
.*                 Mods for WEB Billing                                       *
.*       V9.02.06  05/11/2002  J.Tan                                          *
.*                 Fixed printing HF                                          *
.*       V9.02.05  30/05/2002  J.Tan defect 18151                             *
.*                 Mods to check if record exists in aaedtr before write a rec*
.*       V9.02.04  07/04/2002  J.Tan                                          *
.*                 Added parameter to use theatre fees     
.*       V9.02.03  01.03.2001  J.Tan                                          *
.*                 Mods to charge MBS amount for MBS items
.*       V9.02.02  29.11.2001  B.G.Ackland                                    *
.*                 Remove pi's from Program
.*       V9.02.01  17/10/2001  Dean Cramer                                    *
.*                 Include tests for web reports (PGM = "IBARSH")             *
.*       V5.08.05  15/11/2000  J Habasque                                     *
.*                 Fixed read of patmchgf to use key26 instead of key22       *
.*       V5.08.04  28/06/2000  J.Tan                                          *
.*                 Recompiled for PATCALFN - patfigaf file                    *
.*       V5.08.03  06/06/2000  Jill Habasque                                  *
.*                 Changed to use key14 for Health fund file                  *
.*       V5.08.02  18/05/2000  Pat Dirito                                     *
.*                 Changed Web Output Table heading to Use class=HeadingCell  *
.*       V5.08.01  17/05/2000  Jill Habasque                                  *
.*                 Removed close of controlf to fix I*C                       *
.*       V5.08.B03 07/04/2000  Davin                                          *
.*                 Mods for templating - call templating from layouts         *
.*       V5.08.B02 21/03/2000  Davin                                          *
.*                 Mods for templating - use PATINVHL for headers             *
.*                                     - use PATINVTL for tails (from layouts)*
.*            V5.08.B01 22/02/2000  Steve Downing                             *
.*                      Mods to initialise GST variables                      *
.******************************************************************************
.*            V5.07.02  12/07/1999 Nicole Harrington                          *
.*                      Added web flags, writes to HTMLFILE and WEBLINUP      * 
.*            V5.07.01  08/01/1999 J Habasque                                 *
.*                      Changed tempfile length from 209 to 211               *
.*            V5.07     06/10/98  Jim Stathopoulos                            *
.*                      507 Changes                                           *
.******************************************************************************
.*            V5.00     14/04/89 K.Peak           SRF 100124                  *
.*                      Fixed $ amount display                                *
.*            V5.01     17/04/89 J.Tan            SRF 100014                  *
.*                      Mods to include fee category                          *
.*            V5.02     18/04/89 K.Peak           SRF 100180                  *
.*                      Discharge date on EPW invoices                        *
.*            V5.03     02/05/89 K.Peak           SRF 100336                  *
.*                      Changed Admission to A & E                            *
.*            V5.04     05/05/89 K.Peak                                       *
.*                      Added HNUMDES for New Zealand                         *
.*            V5.05     10/05/89 K.Peak           SRF 100489                  *
.*                      Fixed minimum amount bug                              *
.*            V5.06     17/05/89 J.Tan            SRF 100588                  *
.*                      Fixed the date of item audit                          *
.*            V5.01.01  25/08/89 Graeme Williams                              *
.*                      Do not allow posting of GST item by user              *
.*            V5.01.02  30/08/89 K.Peak           SRF 102146                  *
.*                      Fixed display of other invoices                       *
.*            V5.01.03  05/09/89 K.Peak           SRF 102210                  *
.*                      Fixed I* L 46614                                      *
.*            V5.01.04  07/09/89 M.Ohleiter                                   *
.*                      Fixed key on PATRE1FD to Key8                         *
.*            V5.01.05  13/09/89 M.Ohleiter                                   *
.*                      Included word processor for comments                  *
.*            V5.01.06  20/09/89 Graeme Williams  SRF 101341, 101345          *
.*                      Put cash into current month when printing invoices    *
.*            V5.01.07  03/04/90 J.Tan            SRF 104451                  *
.*                      Check item date with visit date/discharge date        *
.*            V5.01.08  16/05/90 J.Tan            SRF 104959                  *
.*                      Mods to use invoice date for deposit of fin. summary  *
.*            V5.01.09  17/05/90  E.Phan                                      *
.*                      Removed Fee Category file & implement A&E Misc Charges*
.*            V5.01.10  22/05/90 J.Tan            SRF 104901                  *
.*                      Added 8 new theatre classifications                   *
.*            V5.01.11  30/05/90 E.Phan           SRF 105159                  *
.*                      Check for zero claim code & blank hf in aaemchgf first*
.*            V5.01.12  14/06/90 J.Tan            SRF 725                     *
.*                      Fixed A&E item charges                                *
.*            V5.01.13  14/09/90 i chung          SRF 106167                  *
.*                      Fix spelling error (from Reciepts to Receipts)-SFLDBC2*
.*            V5.01.14  15/01/91 J.Tan            SRF 107488                  *
.*                      Fixed patient and rebate portion when posting cash    *
.*            V5.01.15  31/01/91 J.Tan            SRF 107753                  *
.*                      Added "?" option to item code                         *
.*            V5.01.16  12/06/92 Graeme Williams  SRF 114865                  *
.*                      Changes for 9 character miscellaneous items           *
.*            V5.01.17  26/06/92 i chung          SRF 115282                  *
.*                      Initialized PINVLOCK, PINVREB, PINVCANC, PINVPCSH     *
.*                                  PINVCADM, PINVSPAR in routine ZEROINV     *
.*            V5.01.18  05/11/1992  Graeme Williams                           *
.*                      Set the OTSERVS variable when inputting misc. items.  *
.*            V5.01.19  23/11/1992  Justin Coates   (HONG KONG changes)       *
.*                      allow for PTCNINVL for new layout                     *
.*            V5.01.20  06/01/92  DIG                           QUOTE  7522   *
.*                      Added new value to PTCNINVL for Anne Caudle.          *
.*            V5.01.21  21/01/1993  Justin Coates                             *
.*                      added invoice layout 12 - West Gippsland              *
.*            V5.01.22  30/12/1992  Whirlpool                                 *
.*                      Dudley Address Changes                                *
.*            V5.01.23  28/05/93 J.Tan   SRF 120832                           *
.*                      Allows multiple items for non-fixed items             *
.*            V5.01.24  18/06/93 Robert Sumsion   SRF122783                   *
.*                      Allow writing to the new Indexed Cash Receipts Audit  *
.*                      file.                                                 *
.*            V5.01.25  29/06/93 Robert Sumsion   SRF122783                   *
.*                      Modified for changes to PATCRA format. The method for *
.*                      updating the PATCRA file also changed.                *
.*        V5.01.26  19/08/1993  Glenn Berry   Bulletin 27  SRF 117999         *
.*                  Added 'Parent of' for P.R.A.                              *
.*        V5.01.27  22/11/1993  Glenn Berry      Hawkes Bay Changes           *
.*                  Added Invoice Layout 13 - Hawkes Bay                      *
.*        V5.01.28  28/01/1994  Glenn Berry      Hawkes Bay Changes           *
.*                  Fix invoice number not being printed :                    *
.*                      MOVE      CNEXTINV,SAVINVNO                           *
.*        V5.01.29  26/11/1993  Glenn Berry      Hawkes Bay Changes           *
.*                  Added Invoice Layout 13 - Hawkes Bay                      *
.*        V5.01.30  26/07/1994  Rob Leonard   Quote 8064                      *
.*                  Added Invoice Layout 15 - Taranaki                        *
.*        V5.02.01  20/02/1995  Greg Horvat      SRF 134879                   *
.*                  Recompiled for PATAUMFD & PATIOAUM - added new variable,  *
.*                  changed to write to this new variable & changed to write  *
.*                  the correct date to the miscell item date                 *
.*        V5.02.02  14/03/1995  Greg Horvat      SRF 134573  Quote 8300       *
.*                  Recompiled for PATBNKFD & PATIOBNK - Added PTBFRDTE &     *
.*                  changed to write to this variable                         *
.*        V5.03.B0  24/05/1995  Paul Howells     SRF 134644                   *
.*                  Check whether using invoice pending file before writing.  *
.*        V5.03.01  28/07/1995  Greg Horvat      SRF 610897                   *
.*                  Added Port Macquaire's AAE invoice layout, PTCNINVL=16    *
.*                                                                            *
.******************************************************************************
.
.      This is the start of the code that controls the printing of the invoice.
.
INVPRT    MOVE      ONE,HEADTYPE                  * print "INVOICE" mode
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,B10DATE
.
          UNPACK    ADADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,A10DATE
.
          COMPARE   ONE,HSTANDM
          GOTO      INVPRT1 IF EQUAL
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1
            OPEN      PMSVX1A1,"pmsvx1af"
            MOVE      SP70,PMVXMHOS
            PACK      KEY8,ADANUMB,SP10
            CALL      RDPMVX11
            OPEN      PATHSPA1,"pathspaf"
            MOVE      SP70,PTHSTFEE
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
.
          MOVE      ADANUMB,KEY8
          CALL      RDDISA1
          BRANCH    OVRCD,INVPRT1
.
          UNPACK    ADSDATE,CCENT1,CYEAR1,CMON1,CDAY1
          PACK      CPDATE1,CDAY1,SLASH,CMON1,SLASH,CCENT1,CYEAR1
          MOVE      CPDATE1,D10DATE
          GOTO      INVPRT2
.
INVPRT1   MOVE      SP10,D10DATE
.
INVPRT2   CALL      DISPINV
INVPRT9   RETURN
+
.******************************************************************************
.         This subroutine displays the invoice, and then asks if the invoice
.         is to be printed, have a cash receipt done, have miscellaneous
.         items added, comments added, or change the bed fee.
.******************************************************************************
DISPINV   MOVE      TWO,PROGFLAG
          MOVE      ZERO,GROSSTOT
          MOVE      ZERO,NETTOT
          MOVE      ZERO,ABFFLAG
.
          LOAD      IPASS,NUMINVS,ZERO,ONE   * set the current pass number
.
          CALL      INITIVAR         * Initialize any special variables
.
          CALL      SCRDISP           * Display heading for invoice
          CALL      GETCASH           * Get any cash figures from discharge prog
.
.         Check if we are generating one or two invoices
.
          MOVE      TWO,PROGFLAG      * set flag to say display invoice
          BRANCH    NUMINVS,DLINE110,DLINE120
.
.         One invoice being generated
.
DLINE110  CALL      AAETBI            * Display invoice
          GOTO      KYOPT
.
.         Two invoices being generated
.
DLINE120  BRANCH    IPASS,DLINE130,DLINE140
.
DLINE130  DISPLAY   *P1:6,*EL,*P24:6,"P a t i e n t   I n v o i c e";
          CALL      AAETBI
          GOTO      KYOPT
.
DLINE140  DISPLAY   *P1:6,*EL,*P24:6,"I n s u r a n c e   I n v o i c e";
          CALL      AAETBI
.
.         Check if the patient has comments
.
KYOPT     OPEN      AAEDETB1,"aaedetbf"
          CALL      HASAAECM
.
ENDOPTN   RETURN
+
.******************************************************************************
.       Subroutine to display screen heading
.******************************************************************************
SCRDISP   CALL      GETPNAM
.
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      SCRDI10 IF NOT EQUAL   * Not using ABF
.
          PACK      KEY5,CODECL,ADACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,SCRDI10
          MATCH     "A",TCINDC2
          GOTO      SCRDI20 IF EQUAL       * ABF Funding no Out of pocket
.
SCRDI10   COMPARE   TWO,IPATFLAG
          GOTO      SCRDI20 IF EQUAL
          BRANCH    PREBFLAG,SCRDI20
.
          MATCH     "1",EMCNDPOC
          GOTO      SCRDI20 IF NOT EQUAL     * no out of pocket
.
          WRITE     HTMLFILE;"<tr bgcolor=#99FFFF><b>":
                               "<td align=center><b> Date </td>":
                               "<td><b> Description </b></td>":
                               "<td><b> Item </b></td>":
                               "<td align=right><b> GST Exc.</b></td>":
                               "<td align=right><b> GST Amount</b></td>":
                               "<td align=right><b> Total Amount</b></td>":
                               "<td align=right><b> Rebate Amount</b></td>":
                               "<td align=right><b> Out of Pocket</b></td>":
                               "</tr>";
          GOTO      ENDDISP
.
SCRDI20   WRITE     HTMLFILE;"<tr bgcolor=#99FFFF><b>":
                               "<td align=center><b> Date </td>":
                               "<td><b> Description </b></td>":
                               "<td><b> Item </b></td>":
                               "<td><b> Reference </b></td>":
                               "<td align=right><b> GST Exc.</b></td>":
                               "<td align=right><b> GST Amount</b></td>":
                               "<td align=right><b> Total</b></td>":
                               "</tr>";
ENDDISP   RETURN
+
.******************************************************************************
.       PNAME IS TOO LONG FOR INPUT RECEIPT DETAILS
.******************************************************************************
GETPNAMS  REP       ", ",PTITL
          REP       ", ",PGNAME
          REP       ", ",PSNAME
.
          MOVE      PGNAME,ANS
          CLEAR     PNAME
          APPEND    ANS,PNAME
          APPEND    DOT,PNAME
          APPEND    PSNAME,PNAME
          RESET     PNAME,20
          APPEND    SP30,PNAME
          RESET     PNAME
          RETURN
+
.******************************************************************************
.       Get the name of the patient (Title Given-names Surname)
.******************************************************************************
GETPNAM   CLEAR     PNAME
          REP       ", ",PTITL
          REP       ", ",PGNAME
          REP       ", ",PSNAME
          RESET     PGNAME
.
          PACK      DIM6,PTITL,SP2
.
.       Get the first non-blank character of the title
.
FRSTCH    CMATCH    SP1,DIM6
          GOTO      APGNAM IF NOT EQUAL
          BUMP      DIM6
          GOTO      FRSTCH IF NOT EOS
.
.       No title, name will be Given-names Surname
.
          APPEND    PGNAME,PNAME
          GOTO      APS1
.
.       Check for last non-blank in title, and append Given names there
.
APGNAM    APPEND    DIM6,PNAME
APG1      CMATCH    SP1,PNAME
          GOTO      APG2 IF NOT EQUAL
          BUMP      PNAME,-1
          GOTO      APG1 IF NOT EOS
.
.       Append given name at this point
.
APG2      APPEND    SP1,PNAME
          APPEND    PGNAME,PNAME
.
.       Search for last non-blank in given names to append surname there
.
APS1      CMATCH    SP1,PNAME
          GOTO      APS2 IF NOT EQUAL
          BUMP      PNAME,-1
          GOTO      APS1 IF NOT EOS
.
.       No given name or title. Name will be just Surname
.
          CLEAR     PNAME
          APPEND    PSNAME,PNAME
          GOTO      APSPS
.
.       Append surname at this point
.
APS2      APPEND    SP1,PNAME
          APPEND    PSNAME,PNAME
.
APSPS     APPEND    SP30,PNAME               * Clear out end of string
          APPEND    SP30,PNAME
          RESET     PNAME
          RETURN
+
.******************************************************************************
.        This subroutine does the actual printing of an invoice. We are
.        only interested in invoices that have a non-zero gross total.
.******************************************************************************
PRNTINV  CALL      SINVH000                 * check for template header
         BRANCH    EXIT,ENDDISP
         CALL      SINVT000                 * check for template tail
         BRANCH    EXIT,ENDDISP
.
          COMPARE   ZERO,GROSSTOT
          GOTO      DISPINVE IF EQUAL
          MATCH     "EMRWEB04",PRGID
          IF        !@EQUAL
            DISPLAY   *P1:6,*EF;
          ENDIF
.
.        Print the invoice. This is the entry point that is used for the
.        batches of invoices from IBAOUT20.
.
PRNTINV0  MOVE      THREE,PROGFLAG
          MOVE      ZERO,INVPRTD
          MOVE      ZERO,GROSSTOT
          MOVE      ZERO,NETTOT
.
          LOAD      IPASS,NUMINVS,ZERO,ONE   * set the pass indicator
          LOAD      PINVTYP,NUMINVS,ZERO,TWO * 1st invoice will be patient
.
.        Get the patients name
.
PRNTOSD   CALL      GETPNAM
.
.        Get any pending cash receipts
.
          CALL      GETCASH
.
         MATCH      "1",PTCNPPIN
         GOTO       NXTINV1 IF EQUAL          * Using new Patient Invoice
.
.        We now check for a special case. If we are printing split invoices
.        and there is no cash, and no patient portion, then only print the
.        second invoice.
.
          IF        CSAMT = 0.00 & IPASS = 1
            MOVE      ONE,PROGFLAG           * calculate invoice flag
            CALL      AAETBI
            IF        GROSSTOT = 0.00
              MOVE      TWO,IPASS            * start with pass 2 (rebate port.)
              MOVE      ONE,PINVTYP          * insurance invoice
            ENDIF
            MOVE      THREE,PROGFLAG         * print invoice flag
          ENDIF
.
.        Get the next invoice number and write a zero invoice record
.
NXTINV1   OPEN      PATINVR1,"patinvrf"
          OPEN      PATIRNG1,"patirnge"
.
NXTINV2   MOVE      CINVRAE,KEY3
          CALL      TRIRNG1
          BRANCH    OVRCD,NOIRNGE,RNGEFULL
.
          MOVE      IRNEXT,CNEXTINV
          MOVE      CNEXTINV,KEY8
          CALL      RDINV1
          COMPARE   ZERO,OVRCD
          GOTO      NXTINV2 IF EQUAL
.
          MATCH     "EMRWEB04",PRGID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                      "*** Generating Invoice ",CNEXTINV," ***";
          ENDIF
.
          CALL      ZEROINV
.
.        Open spool file for invoice
.
          MATCH     "EMRWEB04",PRGID
          IF        !@EQUAL
.           CALL      OPNPRINT
          ENDIF
.
          UNPACK    ADADATE,CCENT,CYEAR,CMON,CDAY
          PACK      A10DATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          COMPARE   ONE,HSTANDM
          GOTO      PRTDDTE IF EQUAL
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1
            OPEN      PMSVX1A1,"pmsvx1af"
            MOVE      SP70,PMVXMHOS
            PACK      KEY8,ADANUMB,SP10
            CALL      RDPMVX11
            OPEN      PATHSPA1,"pathspaf"
            MOVE      SP70,PTHSTFEE
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
.
          MOVE      ADANUMB,KEY8
          CALL      RDDISA1
          BRANCH    OVRCD,PRTDDTE
.
          UNPACK    ADSDATE,CCENT1,CYEAR1,CMON1,CDAY1
          PACK      D10DATE,CDAY1,SLASH,CMON1,SLASH,CCENT1,CYEAR1
          GOTO      PRTDDTE1 
.
PRTDDTE   MOVE      SP10,D10DATE
.
PRTDDTE1  CALL      SETUPIV       * Set up any special varaibles
.
.         Set the claim type indicator if this is a claim
.
          MOVE      ZERO,CLAIM
          PACK      KEY5,CODECL,ADACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,ENDSIV
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
SETIVLP   ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      ENDSIV IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          MATCH     ANSW,ANS
          GOTO      SVISCLM IF EQUAL
          MATCH     ANSM,ANS
          GOTO      SVISCLM IF EQUAL
          MATCH     ANSV,ANS
          GOTO      SVISCLM IF EQUAL
          MATCH     ANSD,ANS
          GOTO      SVISCLM IF EQUAL
          GOTO      SETIVLP
.
.         We have a claim
.
SVISCLM   REP       "W1M2V3D4",ANS
          MOVE      ANS,CLAIM
.
.         Set up the person resp for account
.
ENDSIV    RESET     PGNAME
          MOVE      PGNAME,ANS
          PACK      DIM8,SP1,PTITL,SP1,ANS,DOT
.
FRSTCH2   CMATCH    SP1,DIM8
          GOTO      PCKNAM2 IF NOT EQUAL
          BUMP      DIM8
          GOTO      FRSTCH2 IF NOT EOS
.
PCKNAM2   PACK      PFNAME,DIM8,PTMASNAM
          REP       ", ",PFNAME
          MOVE      PFNAME,PKNAME
          MOVE      PSUBRB,PKSUBR
          MOVE      PADD1,PKADD1
          MOVE      PADD2,PKADD2
          MOVE      PPOST,PKPOST
          MOVE      SP10,PKRELP
.
          OPEN      PATRE1A1,"patre1af"
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          CLOSE     PATRE1A1
          BRANCH    OVRCD,GPRESP95
.
          MATCH     SP70,PKNAME
          IF        @EQUAL|@EOS
            PACK      PFNAME,DIM8,PTMASNAM 
            REP       ", ",PFNAME
            MOVE      PFNAME,PKNAME 
            MOVE      PSUBRB,PKSUBR   
            MOVE      PADD1,PKADD1
            MOVE      PADD2,PKADD2 
            MOVE      PPOST,PKPOST 
            MOVE      SP10,PKRELP                                             
            GOTO      GPRESP95 
          ENDIF 
.
.---- P.R.A. Record exists, so use it.
.
          MATCH     "1",PTCNDEES             * using deceased PRFA indicator
          GOTO      GPRESP85 IF NOT EQUAL    * no
.         
          CMATCH    "$",PKNAME
          IF        @EQUAL
            STRIP     PTCNDDES
            MOVE      PTCNDDES,PFNAME
            UNPACK    PKNAME,DIM2,KEY78      * ignore "$ "
            PACK      PFNAME,PFNAME,SP1,KEY78,SP30
            GOTO      GPRESP95
          ENDIF
.
GPRESP85  COMPARE   ONE,PTCNPAOF             * using 'parent of'?
          GOTO      GPRESP90 IF NOT EQUAL    * no
.
.---- If first character of PKNAME is "@" then replace with "Parent of"
.
          CMATCH    "@",PKNAME
          IF        @EQUAL 
            MOVE      "Parent of ",PFNAME
            UNPACK    PKNAME,DIM2,KEY78      * ignore "@ "
            PACK      PFNAME,PFNAME,KEY78,SP30
            GOTO      GPRESP95
          ENDIF
.
GPRESP90  PACK      PFNAME,PKNAME,SP70,SP70
.
GPRESP95  CALL      PRTIHDR
          BRANCH    EXIT,PRNTOSD             * Print the second invoice
.
GPRESP99  RETURN
+
.******************************************************************************
.        Print the invoice heading section
.******************************************************************************
PRTIHDR   MOVE      ADANUMB,PINVADM
          MOVE      ADAURNO,PINVUR
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,AFNDMM
          MOVE      PFNDMM,PMVXFNDM
          MOVE      ADADATE,ADATE
          MOVE      SP10,DDATE
.
          OPEN      EMRVISA1,"emrvisaf"
          MOVE      ATNUMB,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,ADATE
            MOVE      EMVIDDAT,DDATE
          ENDIF
.
          MOVE      SP70,DPROV
          OPEN      PATDO1A1,"patdo1af"
          MOVE      ADADOCT,KEY6
          CALL      RDDOCT1
.
          MATCH     "1",EMCNGINV            * Group invoice by Service Doctor
          GOTO      PRTIH140 IF NOT EQUAL
.
          MOVE      SERVDOCT,KEY10
          MATCH     SP70,SERVDOCT
          GOTO      PRTIH100 IF EQUAL
          MATCH     "ALL",SERVDOCT
          GOTO      PRTIH120 IF NOT EQUAL
.
PRTIH100  CALL      CFDOC0000           * Get first doctor
.         MOVE      KEY10,SERVDOCT
.
PRTIH120  OPEN      PMSHCPA1,"pmshcpaf" 
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,DTITL
            MOVE      PMHCGNAM,DGNAME
            MOVE      PMHCSNAM,DSNAME
            MOVE      PMHCPRV1,DPROV
          ENDIF
.
PRTIH140  MOVE      ONE,PINVSYS
          MOVE      SP6,PINVSITE
          MOVE      CNEXTINV,SAVINVNO
          CALL      HEAD
.
.        Generate the body and tail of the invoice
.
          CALL      AAETBI
.
.        Update the invoice record with the appropriate details
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY    * Save invoice date
          MOVE      CNEXTINV,KEY8
          CALL      RDINV1
.
          PACK      PINVDTE,CCENT,CYEAR,CMON,CDAY    * Restore invoice date
          MOVE      ADANUMB,PINVADM
          MOVE      ADAURNO,PINVUR
          MOVE      PSNAME,PINALPHA
          MOVE      GROSSTOT,PINVAMT
          MOVE      HFMISC,PINVREB
          MOVE      ZERO,PTINGSTA
          MOVE      ONE,PINVSYS
          MOVE      SP6,PINVSITE
.
.         with the New Patient Invoice functionality, Print Rebate Invoice 
.         might possible include Items with Patient portion
.
          IF         PREBFLAG=1
            IF         PINVREB=GROSSTOT
              MOVE       ONE,PINVTYP       * Insurance Invoice
            ENDIF
          ELSE
            IF         IPATFLAG=2
              MOVE       TWO,PINVTYP       * Patient invoice
            ENDIF
          ENDIF
.
          IF        PRINTABF=1
            MOVE      THREE,PTINCMIX       * ABF invoice
          ENDIF
.
.         Check if we are using Aust.GST 
.
          IF        IBCNUGST=2 
            ADD       TOTGST,PINVAMT
            MOVE      TOTGST,PTINGSTA      * GST amount
          ENDIF
.
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
.
          MOVE      ADACOMP,PINVCLM
          CALL      UPINV1
.
          IF        PRINTABF=1
            CALL      UAAB0000                * Update Inv. no to ABF file
          ENDIF
.
          PROC      FLAGDEBT                * set outstanding debt indicator
.
.       Do Cash updates, and then remove the patient from the list
.       of patient who will still have invoices pending. Then print invoice.
.
          CALL      POST0000
.
          MATCH     "EMRWEB04",PRGID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                      "*** Invoice Generation Completed ***",*W,*P1:24,*EL;
.           CALL      CLSPRINT
          ENDIF
.
          MATCH     "1",PTCNPPIN
          GOTO      PRTIH160 IF NOT EQUAL
.
.         If we are printing Patient invoice, do not remove Pending record as
.         we still have Health fund invoice to print
.
          COMPARE   TWO,IPATFLAG
          GOTO      PRTIH900 IF EQUAL
.
          CALL      DELIPEND
          GOTO      PRTIH900           * print New Patient Invoice functionality
.
.         If we are generating multiple invoices, check if we need to generate
.         another invoice.
.
PRTIH160  CALL      DELIPEND
.
          BRANCH    IPASS,PRTIH200,PRTIH900
          GOTO      PRTIH900
.
.         We have generated the first invoice. Now time to generate the second
.
PRTIH200  MOVE      TWO,IPASS                * second pass
          MOVE      ONE,PINVTYP              * insurance invoice
          MOVE      ZERO,GROSSTOT
          MOVE      ZERO,NETTOT
.
.         Check if we need to print a form feed between invoices
.
          BRANCH    CINVFF,PRTIH400
          GOTO      PRTIH800
.
PRTIH400  PRINT     *F;                      * formfeed between invoices
PRTIH800  MOVE      ONE,EXIT
          GOTO      PRTIH999
.
PRTIH900  MOVE      ZERO,EXIT
PRTIH999  RETURN
+
.******************************************************************************
.        Invoice is for zero amount, and for zero bed days
.******************************************************************************
.
DISPINVE  MATCH     "IBARSH",PGM
          GOTO      ENDDISP IF EQUAL
          MOVE      "No Invoice details to be printed. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENDDISP
.
.         Invalid invoice range in the control file
.
NOIRNGE   MATCH     "IBARSH",PGM
          GOTO      ENDDISP IF EQUAL
          MOVE      "Invalid Invoice Range in Control file. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENDDISP
.
.         No more invoices available in invoice range
.
RNGEFULL  MATCH     "IBARSH",PGM
          GOTO      ENDDISP IF EQUAL
          MOVE      "Next Invoice Number outside of valid range. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENDDISP

.         Subroutine to get the next transaction number
.
NXTTRAN1  MOVE      ADANUMB,TADMNO
          MOVE      ADANUMB,KEY8
          CALL      TRVISA1
          MOVE      PVITRAN,ATTRANS
          RETURN
+
.*************************************************************************** 
.* GETCASH      Subroutine to get the total cash amount currently entered  *
.*************************************************************************** 
GETCASH   BRANCH    PRABFINV,CASHLP90           * no deposit for ABF Invoice
.
          OPEN      COMDEPA1,"comdepaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      COMDEPA3,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA5,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPREGA1,"rcpregaf"
          MOVE      ZERO,CSAMT
          MOVE      ZERO,CASHFLAG
          MOVE      ZERO,FORM1
.
.         Get all banked deposits for this patients
.
          MOVE      ADANUMB,AADMNO
          MOVE      AADMNO,DAADMNO
.
          PACK      KEY25,ADAURNO,SP70
          CALL      RSRCDTE5
CASHLP20  CALL      RKRCDTE5
          BRANCH    OVRCD,CASHLP48
          MATCH     ADAURNO,RCDTURNO
          GOTO      CASHLP48 IF NOT EQUAL       * Different U/R
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      CASHLP40 IF EQUAL           * same visit number
          MATCH     SP70,RCDTVIST
          GOTO      CASHLP20 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CASHLP20
          COMPARE   "90",REGIBACD
          GOTO      CASHLP20 IF NOT EQUAL      * Not EMR Deposit register
.
CASHLP40  PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          BRANCH    OVRCD,CASHLP20             * not released
          MATCH     "0",CMDESTAT               * Check for Held deposit
          GOTO      CASHLP20 IF NOT EQUAL
.
          ADD       RCDTAMNT,CSAMT
          UNPACK    CMDETDAT,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,CSCENT
          MOVE      XYEAR,CSYEAR
          MOVE      XMON,CSMON
          MOVE      XDAY,CSDAY
          GOTO      CASHLP20
.
CASHLP48  COMPARE   ZERO,CSAMT
          GOTO      CASHLP50 IF EQUAL
          MOVE      ONE,CASHFLAG
.
.         Check for any non-banked deposits
.         and any EMR deposit with no visit number allocated
.
CASHLP50  MOVE      ZERO,FORM1
          MOVE      ZERO,NBNKAMNT
          PACK      KEY25,ADAURNO,SP70
          CALL      RSRCDTE5
CASHLP60  CALL      RKRCDTE5
          BRANCH    OVRCD,CASHLP90
          MATCH     ADAURNO,RCDTURNO
          GOTO      CASHLP90 IF NOT EQUAL       * Different U/R
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          COMPARE   ZERO,OVRCD
          GOTO      CASHLP60 IF EQUAL           * has been released
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      CASHLP70 IF EQUAL           * same visit number
.
          MATCH     SP70,RCDTVIST
          GOTO      CASHLP60 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CASHLP60
          COMPARE   "90",REGIBACD
          GOTO      CASHLP60 IF NOT EQUAL      * Not EMR Deposit register
.
CASHLP70  MATCH     SP10,RCDTINVN              * Invoice number must be blank
          GOTO      CASHLP60 IF NOT EQUAL
          MATCH     SP10,RCDTRELD
          GOTO      CASHLP60 IF NOT EQUAL       * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,CASHLP60
          MATCH     "1",RCBNSTAT               * check if cancelled
          GOTO      CASHLP60 IF EQUAL
.
          ADD       RCDTAMNT,NBNKAMNT
          GOTO      CASHLP60 
.
CASHLP90  RETURN
+
.*************************************************************************** 
.      Invoice was printed, so post any cash receipts to DTRAN and INVR files
.*************************************************************************** 
POST0000  BRANCH    PRABFINV,POST9999           * no deposit for ABF Invoice
.
          OPEN      COMDEPA1,"comdepaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA5,"rcpdteaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPREGA1,"rcpregaf"
          MOVE      ADANUMB,AADMNO
          MOVE      AADMNO,DAADMNO
.
.         Get cash that have been released for this admission
.         and any EMR deposit has been released with no visit number 
.
          PACK      KEY25,ADAURNO,SP70
          CALL      RSRCDTE5
POST1000  CALL      RKRCDTE5
          BRANCH    OVRCD,POST7000
          MATCH     ADAURNO,RCDTURNO
          GOTO      POST7000 IF NOT EQUAL
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          BRANCH    OVRCD,POST1000            * Not released yet
          MATCH     "0",CMDESTAT              * Check for Held deposit
          GOTO      POST1000 IF NOT EQUAL
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      POST2000 IF EQUAL     * same visit number
.
          MATCH     SP70,RCDTVIST
          GOTO      POST1000 IF NOT EQUAL
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,POST1000
          COMPARE   "90",REGIBACD
          GOTO      POST1000 IF NOT EQUAL      * Not EMR Deposit register
.
POST2000  MATCH     SP70,RCDTVIST
          IF        @EQUAL
            MOVE      DAADMNO,RCDTVIST
          ENDIF
          PACK      RCDTINVN,SP4,PINVNO
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE5
.
.         Read the first record of Bank details file to get the payment type
.         ie. Cash, Cheque
.
          MOVE      SP70,ATDTPCOD
          OPEN      RCPBDTA1,"rcpbdtaf"
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     RCDTRECN,RCBDRECN      * Same receipt number?
            IF        @EQUAL
              MOVE      RCBDPCOD,ATDTPCOD
            ENDIF
          ENDIF
.
          MOVE      RCDTAMNT,ATPATAMT
          MOVE      CMDERECN,ATRECEPT
.
          MOVE      PINVADM,ATNUMB
          MOVE      PINVNO,ATINVNO
.
          MOVE      TWO,ATRECTYP            *** RECORD TYPE CASH
          MOVE      ONE,ATINVPRT            *** SET AS ALREADY PRINTED
          MOVE      CMDETDAT,ATDDATE
          MOVE      "PY",ATTYPE
          MOVE      SP30,ATITEMNO
          MOVE      SP3,ATMISGRP
          MOVE      ONE,ATPAYTYP       ***** set up Payment TYPE
.
          MOVE      SP30,ATDDESC
          MOVE      "PATIENT",ATDDESC
          MULT      SEQ,ATPATAMT            **** MAKE IT NEGATIVE
          MOVE      ATPATAMT,ATPATPOR
          MOVE      ZERO,ATREBPOR
          PACK      ATDTEFFD,PINVDTE
          REP       " 0",ATDTEFFD
          MOVE      SP70,ATDTBTCH
          MOVE      SP70,ATDTSUBN
          MOVE      SP70,ATDTEDAD
          MOVE      SP70,ATDTSVTM
          MOVE      ZERO,ATSPARE1
          MOVE      ZERO,ATSPARE2
          MOVE      SP70,ATSPARE
          MOVE      SP70,ATDTCRST
          MOVE      ZERO,ATDTSCHF
          MOVE      SP70,ATDTRBRS
          PACK      ATDTACOI,SP70       * After Care Override Indicator
          PACK      ATDTDSOV,SP70       * Duplicate Service Override
          PACK      ATDTSTXT,SP70       * Service Text
          PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      ATDTMPOV,SP70       * Multi Procedure Override
          PACK      ATDTNMPT,SP70       * Number of Patients Seen
          PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      ATDTTDUR,SP70       * Time Duration (Mins)
          PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
.
.         Post this cash
.
POST4000  CALL      NXTTRAN1                * Get the next transaction number
.
          PACK      KEY22,ATNUMB,ATINVNO,ATTRANS
          CALL      RDADTRE1
          COMPARE   ZERO,OVRCD
          GOTO      POST4000 IF EQUAL         * already exist
.
          CALL      WRDTRE1
.
          MOVE      "1",CMDESTAT            * set Deposit status to 'Applied'
          PACK      CMDEAINV,SP4,ATINVNO,SP70
.         PACK      CMDEREFD,PINVDTE
          PACK      CMDEREFD,CCC,CYY,CMM,CDD,SP70    * set to current date
          REP       " 0",CMDEREFD           * Date deposit applied
          CALL      IBACLOCK
          MOVE      CTIMEIS,CMDEREFT        * Time invoice is written to
.
          PACK      CMDEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",CMDEUDAT           * date updated
          CLOCK     TIME,CMDEUTIM           * time updated
          MOVE      USERID,CMDEUUID         * web user id
          CALL      UPCMDEP1
.
          OPEN      PATINVR1,"patinvrf"
          MOVE      CNEXTINV,KEY8
          CALL      RDINV1
          ADD       ATPATAMT,PINVPATA
.
.         Check if the invoice now balances
.
          MOVE      PINVAMT,TOTAMT       * Invoice amount +
          ADD       PINVPATA,TOTAMT      * Patient payments +
          ADD       PINVHFDA,TOTAMT      * H.F payments +
          ADD       PINVOTHA,TOTAMT      * Other payments +
          ADD       PINVJOUR,TOTAMT      * Journals = amount outstanding
.
          MOVE      "99999999",PINVBLCD  * Assume it doesn't balance
.
          COMPARE   ZERO,TOTAMT          * Does it balance ?
          GOTO      POST6000 IF NOT EQUAL
.
.         Invoice is now balanced. Record the date that this occured
.
          PACK      PINVBLCD,CCC,CYY,CMM,CDD
          REP       " 0",PINVBLCD
.
POST6000  PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
.
          CALL      UPINV1
          PROC      FLAGDEBT                * set outstanding debt indicator
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          MOVE      ANSB,FINTYPE
          PACK      FINCODE,ANSA,SP20
          MOVE      RCDTAMNT,FINAMT
.         PACK      FINDATE,CCC,CYY,CMM,CDD
          MOVE      PINVDTE,FINDATE
          REP       " 0",FINDATE
          MOVE      ONE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      ZERO,FGSTFLAG
.
          MOVE      SP70,FINHOSP
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRSITA1,"emrsitaf"
          MOVE      ATNUMB,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVISITE,KEY3
            CALL      RDEMSIT1
            IF        OVRCD=0
              MOVE      EMSTHSNO,FINHOSP
            ENDIF
          ENDIF
          CALL      PATCALF
          GOTO      POST1000
.
.         Check for any non banked deposits (unreleased cash)
.
POST7000  MOVE      ZERO,NBNKAMNT
          PACK      KEY25,ADAURNO,SP70
          CALL      RSRCDTE5
POST7200  CALL      RKRCDTE5
          BRANCH    OVRCD,POST8000
          MATCH     ADAURNO,RCDTURNO
          GOTO      POST8000 IF NOT EQUAL
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          COMPARE   ZERO,OVRCD
          GOTO      POST7200 IF EQUAL       * has been released
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      POST7400 IF EQUAL
          MATCH     SP70,RCDTVIST
          GOTO      POST7200 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,POST7200
          COMPARE   "90",REGIBACD
          GOTO      POST7200 IF NOT EQUAL      * Not EMR Deposit register
.
POST7400  MATCH     SP10,RCDTINVN          * Invoice number must be blank
          GOTO      POST7200 IF NOT EQUAL
          MATCH     SP10,RCDTRELD
          GOTO      POST7200 IF NOT EQUAL   * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,POST7200
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      POST7200 IF EQUAL
.
          ADD       RCDTAMNT,NBNKAMNT
          PACK      RCDTINVN,SP4,CNEXTINV   * store the invoice number
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE5
          GOTO      POST7200
.
POST8000  OPEN      PATINVR1,"patinvrf"
          MOVE      CNEXTINV,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,POST9999
          MOVE      NBNKAMNT,PINVPCSH       * pending cash
          MULT      "-1",PINVPCSH
.
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
.
          CALL      UPINV1
          PROC      FLAGDEBT                * set outstanding debt indicator
.
POST9999  RETURN
+
.*************************************************************************** 
.         patients who still have invoices pending.
.*************************************************************************** 
DELIPEND  COMPARE   ZERO,PTCNIPEN
          GOTO      DELIP999 IF NOT EQUAL
.
.         check for ABF 
.
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      DELIP400 IF NOT EQUAL   * Not using ABF
.
          PACK      KEY5,CODECL,ADACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,DELIP400
          MATCH     "A",TCINDC2
          GOTO      DELIP400 IF NOT EQUAL
.
          CALL      ABFV0000                * Check if ABF Invoice raised
          BRANCH    EXIT,DELIP999           * ABF invoice has not been raised
.
.         Check if still Item tobe invoiced
.
          PACK      KEY14,ADANUMB,SP20
          CALL      RSPMMTI1
DELIP100  CALL      RKPMMTI1
          BRANCH    OVRCD,DELIP400
.
          MOVE      ADANUMB,DADANUMB
          MATCH     PMMIVISN,DADANUMB
          GOTO      DELIP400 IF NOT EQUAL
.
          COMPARE   ZERO,PMMIAMTT
          GOTO      DELIP100 IF EQUAL      * zero amount of item
.
          GOTO      DELIP999
.
.         Check if there is still a tobe invoiced (multiple service doctor)
.
DELIP400  MATCH     "1",EMCNGINV            * Group invoice by Service Doctor
          IF        @EQUAL
            CALL      CKPD0000              * Check for tobe invoiced amount
            BRANCH    EXIT,DELIP999         * do not remove inv.pending record
          ENDIF
          OPEN      PATIPEN1,"patipenf"
          MOVE      ADANUMB,IPADMNO
.
          MOVE      IPADMNO,KEY8
          CALL      RDIPEN1
.
          COMPARE   ZERO,OVRCD
          CALL      DEIPEN1 IF EQUAL        * delete Invoice pending record
.
DELIP999  RETURN
+
.*************************************************************************** 
.         Check for next invoice pending
.*************************************************************************** 
CKPD0000  MOVE      ZERO,EXIT
          MOVE      ONE,PROGFLAG           * calculate invoice flag
          UNPACK    SP70,DIM10,DIM32
          OPEN      EMRHISA2,"emrhisaf"
          PACK      KEY32,ADANUMB,SP70
          CALL      RSEMHIS2
CKPD1000  CALL      RKEMHIS2
          BRANCH    OVRCD,CKPD8100
.
          MATCH     DADANUMB,EMHIVIS
          GOTO      CKPD8100 IF NOT EQUAL
.
          MATCH     SP70,EMHIDOC
          GOTO      CKPD1000 IF EQUAL
.
          MATCH     DIM10,EMHIDOC
          GOTO      CKPD1000 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          MATCH     SERVDOCT,EMHIDOC
          GOTO      CKPD1000 IF EQUAL      * invoice has just been printed 
.
          PACK      KEY10,EMHIDOC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,CKPD1000
.
          PACK      DIM32,EMHIVIS,EMHIDOC,EMHIDAT,EMHITIM,SP70
.
          MOVE      EMHIDOC,SERVDOCT
          CALL      AAETBI
          COMPARE   ZERO,GROSSTOT
          GOTO      CKPD8000 IF NOT EQUAL  * still has amount to be invoiced
.
.         Check next service doctor
.
          MOVE      DIM32,KEY32           * reposition
          CALL      RDEMHIS2
          GOTO      CKPD1000
.
CKPD8000  MOVE      ONE,EXIT              * still has to be invoiced amount
          GOTO      CKPD9000
.
CKPD8100  MOVE      ZERO,EXIT
CKPD9000  MOVE      THREE,PROGFLAG        * set back to print invoice flag
CKPD9999  RETURN
+
.*************************************************************************** 
.         Check if ABF invoice has been raised
.*************************************************************************** 
ABFV0000  OPEN      PATINVR3,"patinvrf"
          MOVE      PINVADM,ADANUMB
          PACK      KEY16,ADANUMB,SP70
          CALL      RSPTINV3
ABFV1000  CALL      RKPTINV3
          BRANCH    OVRCD,ABFV8100
.
          MATCH     PINVADM,ADANUMB
          GOTO      ABFV8100 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABFV1000 IF NOT EQUAL  * Credit note
.
          COMPARE   THREE,PTINCMIX         * check for ABF invoice
          GOTO      ABFV8000 IF EQUAL
          GOTO      ABFV1000
.
ABFV8000  MOVE      ZERO,EXIT              * found an ABF Invoice
          GOTO      ABFV9000
.
ABFV8100  MOVE      ONE,EXIT               * ABF Invoice has not been raised
.
ABFV9000  MOVE      CNEXTINV,KEY8
          CALL      RDINV1                 * reposition to the original invoice
ABFV9999  RETURN
+
.**********************************************************************
.         Update Invoice number to ABF file
.**********************************************************************
UAAB0000  READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      UAAB9999 IF NOT EQUAL   * Not using ABF
.
          OPEN      PMSABFA1,"pmsabfaf"
.
UAAB1000  PACK      KEY19,ADANUMB,SP70
          CALL      RSPMABF1
          CALL      RKPMABF1
          BRANCH    OVRCD,UAAB9999
.
          MATCH     DADANUMB,PMABADMN       * Same admission no ?
          GOTO      UAAB9999 IF NOT EQUAL
.
          MATCH     SP70,PMABINVN
          GOTO      UAAB9999 IF NOT EQUAL  * Invoice must be blank
.
          MOVE      CNEXTINV,PMABINVN
          CALL      UPPMABF1
          GOTO      UAAB1000
.
UAAB9999  RETURN
+
.*************************************************************************** 
.         Subroutine to write a zero record to the invoice file
.*************************************************************************** 
ZEROINV   CALL      CLPATINV                * clear Invoice variables
.
          MOVE      CNEXTINV,KEY8
          MOVE      CNEXTINV,PINVNO
.
          PACK      PINVDTE,CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
...       MOVE      ZERO,PINVUR
          MOVE      ONE,PINVSYS
.
...       MOVE      "99999999",PINVBLCD
...       MOVE      "0",PTINCRST
.
          CALL      RDINV1
          COMPARE   ZERO,OVRCD
          GOTO      ZERORET IF EQUAL
.
          PACK      PTINCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINCDAT             * date created
          CLOCK     TIME,PTINCTIM             * time created
          MOVE      USERID,PTINCUID           * web user id
          CALL      WRINV1
.
ZERORET   RETURN
+
.****************************************************************************
.  SINVH000 - Set up invoice header for stationery templating
.****************************************************************************
SINVH000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          MOVE      AECNAEIH,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVH900
.
          PACK      KEY12,AECNAEIH,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVH900
.
          MATCH     AECNAEIH,IBDTSCOD         * match stationery codes
          GOTO      SINVH950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVH900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVH999
.
SINVH950  MOVE      ZERO,EXIT
SINVH999  RETURN
+
.****************************************************************************
.  SINVT000 - Set up invoice tail for stationery templating
.****************************************************************************
SINVT000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          MOVE      AECNAEIT,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVT900
.
          PACK      KEY12,AECNAEIT,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVT900
.
          MATCH     AECNAEIT,IBDTSCOD         * match stationery codes
          GOTO      SINVT950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVT900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVT999
.
SINVT950  MOVE      ZERO,EXIT
SINVT999  RETURN
+
.*****************************************************************************
.*                           MVMI0000                                        *
.* Move fields from aaedtref to pmsmtiaf                                     *
.*****************************************************************************
MVMI0000  MOVE      ATNUMB,PMMIVISN
          MOVE      ATTRANS,PMMITRAN
          MOVE      ADAURNO,PMMIURNO
          MOVE      " 1",PMMISYST
          MOVE      ATITEMNO,PMMIITEM
          MOVE      ATDDESC,PMMIDESC
          PACK      PMMIDES2,SP70
          MOVE      ATDDATE,PMMITDAT
          MOVE      ATRECTYP,PMMIRTYP
          MOVE      ATPATAMT,PMMIAMTT
          MOVE      ATPATPOR,PMMIAMTP
          MOVE      ATREBPOR,PMMIRBAT
          MOVE      ZERO,PMMIAMTG
          MOVE      ATPATAMT,PMMIAMTH
          UNPACK    SP70,PMMITDOC,PMMIODOC,PMMISESS
          MOVE      ATSERVS,PMMISERV
          MOVE      ATMISGRP,PMMIMGRP
          MOVE      ATBATCHN,PMMIBTCH
          MOVE      ATDTGSTA,PMMIGSTA
          MOVE      ATDTGSTC,PMMIGSTC
          MOVE      ATDTGSTM,PMMIGSTM
          MOVE      PASSCODE,PMMIWUSR
MVMI9999  RETURN
+
..............................................................................
