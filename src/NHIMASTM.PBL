. V11.00.01 27/03/2020  Jill Parkinson Task 0879163
.           Added output of NHMASEX using category G
. V10.14.01 19/02/2019  Ebon Clements TSK 0867703
.           Changed NHI ethnicity file reads to use KEY5
. V10.04.01 09/05/2014  Don Nguyen    CAR 300097
.           Fixed SETMWD00 to clear CDAY, CCENT, CYEAR and MTHNAM3 for '0' vals
. V10.03.01 09/10/2013  Patrick Adair CAR 289210
.           Corrected end date processing in TABHCE20 to cater for spaces
.------------------------------------------------------------
. NHI Fields
.------------------------------------------------------------
NHIF0000  IF        (FLDITMNO>22&FLDITMNO<39)
            COMPARE   ZERO,READDNR         * Flag for First Read
            CALL      SETCON00 IF EQUAL    * Get Donor Information 
          ENDIF
          BRANCH    FLDITMNO,NHIF0100,NHIF0200,NHIF0300,NHIF0400,NHIF0500:
                             NHIF0600,NHIF0700,NHIF0800,NHIF0900,NHIF1000:
                             NHIF1100,NHIF1200,NHIF1300,NHIF1400,NHIF1500:
                             NHIF1600,NHIF1700,NHIF1800,NHIF1900,NHIF2000:
                             NHIF2100,NHIF2200,NHIF2300,NHIF2400,NHIF2500:
                             NHIF2600,NHIF2700,NHIF2800,NHIF2900,NHIF3000:
                             NHIF3100,NHIF3200,NHIF3300,NHIF3400,NHIF3500:
                             NHIF3600,NHIF3700,NHIF3800,NHIF3900,NHIF4000:
                             NHIF4100,NHIF4200,NHIF4300,NHIF4400,NHIF4500:
                             NHIF4600,NHIF4700
.                             NHIF5100,NHIF5200,NHIF5300,NHIF5400,NHIF5500:
.                             NHIF5600,NHIF5700,NHIF5800,NHIF5900,NHIF6000:
.                             NHIF6100,NHIF6200,NHIF6300,NHIF6400,NHIF6500:
.                             NHIF6600,NHIF6700,NHIF6800,NHIF6900,NHIF7000:
.                             NHIF7100,NHIF7200,NHIF7300,NHIF7400,NHIF7500:
.                             NHIF7600,NHIF7700,NHIF7800,NHIF7900,NHIF8000
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      NHIF9999
.
NHIF0100  WRITE     HTMLFILE;NHMANMPI;
          GOTO      NHIF9999
.
NHIF0200  WRITE     HTMLFILE;NHMAURNO;
          GOTO      NHIF9999
.
NHIF0300  WRITE     HTMLFILE;NHMASURN;
          GOTO      NHIF9999
.
NHIF0400  WRITE     HTMLFILE;NHMAGIV1;
          GOTO      NHIF9999
.
NHIF0500  WRITE     HTMLFILE;NHMAGIV2;
          GOTO      NHIF9999
.
NHIF0600  WRITE     HTMLFILE;NHMAGIV3;
          GOTO      NHIF9999
.
NHIF0700  WRITE     HTMLFILE;NHMAPREI;
          GOTO      NHIF9999
.
NHIF0800  WRITE     HTMLFILE;NHMAADD1;
          GOTO      NHIF9999
.
NHIF0900  WRITE     HTMLFILE;NHMAADD2;
          GOTO      NHIF9999
.
NHIF1000  WRITE     HTMLFILE;NHMAADD3;
          GOTO      NHIF9999
.
NHIF1100  WRITE     HTMLFILE;NHMAADD4;
          GOTO      NHIF9999
.
NHIF1200  WRITE     HTMLFILE;NHMAADD5;
          GOTO      NHIF9999
.
NHIF1300  UNPACK    NHMADOB,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NHIF9999
.
NHIF1400  MATCH     SP70,NHMADDTH
          GOTO      NHIF9999 IF EQUAL
          UNPACK    NHMADDTH,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NHIF9999
.
NHIF1500  WRITE     HTMLFILE;NHMADOMC;
          GOTO      NHIF9999
.
NHIF1600  WRITE     HTMLFILE;NHMARES;
          GOTO      NHIF9999
.
NHIF1700  WRITE     HTMLFILE;NHMASEX;
          GOTO      NHIF9999
.
NHIF1800  UNPACK    NHMADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NHIF9999
.
NHIF1900  WRITE     HTMLFILE;NHMATIM;
          GOTO      NHIF9999
.
NHIF2000  MOVE      NHMAETH,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF2100  MOVE      NHMAETH2,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF2200  MOVE      NHMAETH3,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF2300  UNPACK    NHDNDONR,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05:
                             DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
.
          MOVE      ZERO,F2
NHIF2310  ADD       ONE,F2
          LOAD      KEY1,F2,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05:
                            DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
          MATCH     SP1,KEY1
          IF        !@EQUAL
            CALL      RDNHDCD1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<tr><td>",NHDCDES,"</td></tr>"
            ENDIF
          ENDIF
          COMPARE   "10",F2
          GOTO      NHIF2310 IF NOT EQUAL
          GOTO      NHIF9999
.
NHIF2400  WRITE     HTMLFILE;NHDNCNSU;
          GOTO      NHIF9999
.
NHIF2500  WRITE     HTMLFILE;NHDNCNG1;
          GOTO      NHIF9999
.
NHIF2600  WRITE     HTMLFILE;NHDNCNG2;
          GOTO      NHIF9999
.
NHIF2700  WRITE     HTMLFILE;NHDNCNG3;
          GOTO      NHIF9999
.
NHIF2800  WRITE     HTMLFILE;NHDNCNPI;
          GOTO      NHIF9999
.
NHIF2900  WRITE     HTMLFILE;NHDNCNA1;
          GOTO      NHIF9999
.
NHIF3000  WRITE     HTMLFILE;NHDNCNA2;
          GOTO      NHIF9999
.
NHIF3100  WRITE     HTMLFILE;NHDNCNA3;
          GOTO      NHIF9999
.
NHIF3200  WRITE     HTMLFILE;NHDNCNA4;
          GOTO      NHIF9999
.
NHIF3300  WRITE     HTMLFILE;NHDNCNA5;
          GOTO      NHIF9999
.
NHIF3400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,NHIF3410,NHIF3420
          MOVE      NHDNCREL,KEY2
          CALL      RDNHREL1
          BRANCH    OVRCD,NHIF9999
          WRITE     HTMLFILE;NHREDES;
          GOTO      NHIF9999
NHIF3410  WRITE     HTMLFILE;NHDNCREL;
          GOTO      NHIF9999
NHIF3420  PACK      KEY2,SP70
          CALL      RSNHREL1
NHIF3430  CALL      RKNHREL1
          BRANCH    OVRCD,NHIF9999
          PACK      KEY4,QUOTE,NHRERCD,SP1,QUOTE
          MATCH     NHDNCREL,NHRERCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY4," selected>":
                               NHREDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY4,">",NHREDES,"</option>"
          ENDIF
          GOTO      NHIF3430
.
NHIF3500  WRITE     HTMLFILE;NHDNCWPH;
          GOTO      NHIF9999
.
NHIF3600  WRITE     HTMLFILE;NHDNCAPH;
          GOTO      NHIF9999
.
NHIF3700  REP       " 0",NHDNDAT
          MATCH     "00000000",NHDNDAT
          GOTO      NHIF9999 IF EQUAL
          UNPACK    NHDNDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NHIF9999
.
NHIF3800  WRITE     HTMLFILE;NHDNTIM;
          GOTO      NHIF9999
.
NHIF3900  WRITE     HTMLFILE;NZIBMWDN;
          GOTO      NHIF9999
.
NHIF4000  WRITE     HTMLFILE;NZIBMWST;
          GOTO      NHIF9999
.
. Medical Warnings Table
.
NHIF4100  CALL      TABMWR00
          GOTO      NHIF9999
.
. Alias Details
.
NHIF4200  CALL      TABALI00
          GOTO      NHIF9999
.
. National Event Details
.
NHIF4300  CALL      TABHCE00
          GOTO      NHIF9999
.
NHIF4400  MOVE      NHMAETH4,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF4500  MOVE      NHMAETH5,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF4600  MOVE      NHMAETH6,D5
          CALL      NHIETH00
          GOTO      NHIF9999
.
NHIF4700  MOVE      "G ",CATEGORY
          MOVE      NHMASEX,CODE
          CALL      CODITM00
          GOTO      NHIF9999
.
NHIF9999  RETURN
.------------------------------------------------------------
. Show Ethnicity 0=Description, 1=Code, 2=Options
.------------------------------------------------------------
NHIETH00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,NHIETH10,NHIETH20
          MOVE      D5,KEY5
          CALL      RDNHETH1
          IF        OVRCD=0
            WRITE     HTMLFILE;NHETDES
          ENDIF
          GOTO      NHIETH99
.
NHIETH10  WRITE     HTMLFILE;D5;
          GOTO      NHIETH99
.
NHIETH20  PACK      KEY5,SP70
          CALL      RSNHETH1
NHIETH30  CALL      RKNHETH1
          BRANCH    OVRCD,NHIETH99
          PACK      KEY7,QUOTE,NHETECD,QUOTE
          MATCH     D5,NHETECD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY7," selected>":
                               NHETDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY7,">",NHETDES,"</option>"
          ENDIF
          GOTO      NHIETH30
.
NHIETH99  RETURN
.------------------------------------------------------------
. Table of Medical Warning Details
.------------------------------------------------------------
TABMWR00  PROC      SETMED00     * Get Medical Warnings from NHI
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Severity</td>":
                                "<td class=HeadingCell>Date</td>":
                                "<td class=HeadingCell>Description</td></tr>"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
TABMWR10  CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          MOVE      PTMWCLSS,ANS
          MOVE      "Danger",SEVRDESC
          MATCH     ANSD,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Warning",SEVRDESC
          MATCH     ANSW,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Other",SEVRDESC
.
TABMWR20  CALL      SETMWD00
          WRITE     HTMLFILE;"<tr><td>",SEVRDESC,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",PTMWTEXT,"</td></tr>"
          GOTO      TABMWR10
.
TABMWR99  RETURN
.------------------------------------------------------------
. Set Medical Warning Date
.------------------------------------------------------------
SETMWD00  REP       " 0",PTMWDATE
          UNPACK    PTMWDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     "00",CDAY
          IF        @EQUAL
            MOVE      SP70,CDAY
          ENDIF
          MATCH     "00",CMON
          IF        @EQUAL
            MOVE      SP70,MTHNAM3
          ENDIF
          PACK      KEY4,CCENT,CYEAR
          MATCH     "0000",KEY4
          IF        @EQUAL
            MOVE      SP70,CCENT
            MOVE      SP70,CYEAR
          ENDIF
          RETURN
.
.------------------------------------------------------------
. Setup Patient Contact & Donor Details
.------------------------------------------------------------
SETCON00  MOVE     ONE,READDNR      * Set Flag as Donor Details Read
.
          UNPACK   SP70,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05
          UNPACK   SP70,DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
          MOVE     SP70,NZIBSTSU
          MOVE     SP70,NZIBPCSN
          MOVE     SP70,NZIBPCG1
          MOVE     SP70,NZIBPCG2
          MOVE     SP70,NZIBPCG3
          MOVE     SP70,NZIBPRNM
          MOVE     SP70,NZIBPCA1
          MOVE     SP70,NZIBPCA2
          MOVE     SP70,NZIBPCSB
          MOVE     SP70,NZIBPCTW
          MOVE     SP70,NZIBPCCT
          MOVE     SP70,NZIBRELC
          MOVE     SP70,NZIBWKPH
          MOVE     SP70,NZIBAHPH
.
          CALL     CLRDNR00
          MATCH    ANSY,NZIBMWDN
          GOTO     SETCON50 IF NOT EQUAL
.
          MOVE     NHMANMPI,NZIBNMPI
          CALL     GETDNR                   * Read National Database
          BRANCH   OVRCD,SETCON90
.
          MOVE     NZIBSTSU,NHDNDONR
          MOVE     NZIBSTSU,NHDNDONR
          UNPACK   NZIBSTSU,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05:
                            DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
          MOVE     NHMANMPI,NHDNNMPI
          MOVE     NZIBPCSN,NHDNCNSU
          MOVE     NZIBPCG1,NHDNCNG1
          MOVE     NZIBPCG2,NHDNCNG2
          MOVE     NZIBPCG3,NHDNCNG3
          MOVE     NZIBPRNM,NHDNCNPI
          MOVE     NZIBPCA1,NHDNCNA1
          MOVE     NZIBPCA2,NHDNCNA2
          MOVE     NZIBPCSB,NHDNCNA3
          MOVE     NZIBPCTW,NHDNCNA4
          MOVE     NZIBPCCT,NHDNCNA5
          MOVE     NZIBWKPH,NHDNCWPH
          MOVE     NZIBAHPH,NHDNCAPH
          MOVE     NZIBRELC,NHDNCREL
          PACK     KEY7,NHDNNMPI
          CALL     RANHDNR1
          IF       OVRCD=0
            CALL     UPNHDNR1
          ELSE
            CALL     WRNHDNR1
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     SETCON99
.
SETCON50  MOVE     ZERO,EXIT
          GOTO     SETCON99
.
SETCON90  CALL     NZHISERR
          MOVE     ONE,EXIT
          GOTO     SETCON99
.
SETCON95  MOVE     ONE,EXIT
          GOTO     SETCON99
.
SETCON99  RETURN
.
CLRDNR00  MOVE       SP70,NHDNNMPI
          MOVE       SP70,NHDNDONR
          MOVE       SP70,NHDNCNSU
          MOVE       SP70,NHDNCNG1
          MOVE       SP70,NHDNCNG2
          MOVE       SP70,NHDNCNG3
          MOVE       SP70,NHDNCNPI
          MOVE       SP70,NHDNCNA1
          MOVE       SP70,NHDNCNA2
          MOVE       SP70,NHDNCNA3
          MOVE       SP70,NHDNCNA4
          MOVE       SP70,NHDNCNA5
          MOVE       SP70,NHDNCREL
          MOVE       SP70,NHDNCWPH
          MOVE       SP70,NHDNCAPH
          MOVE       SP70,NHDNDAT
          MOVE       SP70,NHDNTIM
          MOVE       SP70,NHDNSPA
.
          RETURN
.------------------------------------------------------------
. Table of NHI Alias Details
.------------------------------------------------------------
TABALI00  PROC      SETALI00     * Get Alias Details from NHI
          PACK      KEY11,URNUMBER,SP70
          CALL      RSTMAL1
          CALL      RKTMAL1
          BRANCH    OVRCD,TABALI99
          MATCH     TMALURNO,URNUMBER
          GOTO      TABALI99 IF NOT EQUAL
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Surname</td>":
                                 "<td class=HeadingCell>Given Names</td>":
                                 "<td class=HeadingCell>Pref.</td></tr>"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSTMAL1
TABALI10  CALL      RKTMAL1
          BRANCH    OVRCD,TABALI99
          MATCH     TMALURNO,URNUMBER
          GOTO      TABALI99 IF NOT EQUAL
          WRITE     HTMLFILE;"<tr><td>",TMALSUR,"</td>":
                             "<td>",TMALGV1,", ",TMALGV2,", ",TMALGV3,"</td>":
                             "<td>",TMALPRE,"</td></tr>"
          GOTO      TABALI10
.
TABALI99  RETURN
.------------------------------------------------------------
. Table of National Health Care Events
.------------------------------------------------------------
TABHCE00  MOVE      NHMANMPI,NZIBNMPI
          MOVE      SP70,NZIBCPTR
          MOVE      ZERO,HCETOT
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Start</td>":
                                 "<td class=HeadingCell>End</td>":
                                 "<td class=HeadingCell>Description</td>":
                                 "<td class=HeadingCell>Facility</td></tr>"
TABHCE10  CALL      GETHCE
          BRANCH    OVRCD,TABHCE90
          MOVE      NZIBNMWR,FORM2                * Number Returned
          ADD       FORM2,HCETOT
.
          MOVE      NZIBNMWR,HCEEND
          MOVE      ZERO,HCECNT
TABHCE20  ADD       ONE,HCECNT
          COMPARE   HCECNT,HCEEND                  * Check for number returned
          GOTO      TABHCE30 IF LESS
          UNPACK    NZARSTDT[HCECNT],CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>"
.
          MATCH     SP70,NZARENDT[HCECNT]
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp</td>"
          ELSE 
            UNPACK    NZARENDT[HCECNT],CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>",NZAREVND[HCECNT],"</td>":
                             "<td>",NZARRPTF[HCECNT],"</td></tr>"
          GOTO      TABHCE20
.
TABHCE30  MOVE      NZIBNMWF,FORM3                * Total Number of Events
          COMPARE   FORM3,HCETOT
          GOTO      TABHCE10 IF NOT EQUAL
          GOTO      TABHCE99
.
TABHCE90  WRITE     HTMLFILE;"NHI/MWS Error : ",NZIBERRN,"-",NZIBERRD;
.
TABHCE99  RETURN
.
