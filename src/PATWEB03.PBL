.----------------------------------------------------------------------
. Program       : PATWEB03
.
. Function      : Patient Problems for Patient Care Module
.
. Modifications  :
.
.----------------------------------------------------------------------
. V12.00.02 08.07.2025  DA Sarkies     TSK 0961027
.           Recompiled for PATNAMCD
. V12.00.01 23/05/2025 Nikitha B       TSK  0955096                      
.           Alphanumeric changes                                      
. V11.05.05 08.07.2025  DA Sarkies     TSK 0961027
.           Recompiled for PATNAMCD
. V11.05.03 02/12/2024  Peter Vela     Task 0955123
.           FHIR API - Added new fields in RESCND00 Condition Resource
.           (Patient Probs)
. V11.05.02 05/12/2024  Alina Bhari    Task 0953151
.           Seperated the PMPBDSC1&PMPBDSC2 descrption with space in patient
.           problem - PROLST00                                              
. V11.05.01 02/12/2024  Alina Bhari    Task 0953151
.           Added text field to continue the description of text
.           -PRBDES07,PRBDES08,PRBDES09,PRBDES10,PRBDES11,PRBDES12,PROLST00
. V11.04.04 31.10.2024  DA Sarkies     Task 0953161
.           Added code to record asseter for multiple problems.
.           Removed JSON if asseter is blank
. V11.04.03 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.02 05/06/2024  Bella Turco   TSK 0946916
.           Error if adding a Secondary Doctor that is the same as the Attending
.           Doctor in Doctor Care List (VALA0000)
. V11.04.01 10/05/2024  Nikitha B     TSK 0945137
.           Added LOOPCNTR variable for PMSUPGCD.
. V11.03.05 28/08/2023  Peter Vela     TSK 0927262
.           Added FHIRBUND functionality to FHIR Condition Resource RESCND00
. V11.03.04 31/07/2023  Peter Vela     TSK 0927262
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
.           to Practitioner User resource
. V11.03.03 31.07.2023  DA Sarkies     Task 0927256
.           Added code to store Active Status into PMPBACTV
. V11.03.02 13.07.2023  DA Sarkies     Task 0927256
.           Added CGI Variables to save the Patient Problem History
. V11.03.01 05/06/2023  Peter Vela     Task 0927262
.           ClinicalAide FHIR api
.           Added Subject include FHRSUBIN functionality
.           Added Participant include FHRPARIN functionality
. V11.02.02 04/08/2022  Jill Parkinson Task 0918740
.           Fixed key pack in UPRG0000 and added keepalive for large visit count
. V11.02.01 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.02 15/09/2021  Thanh T        TSK 0889595
.           Recompiled for PMSDAUFD changes
. V11.01.01 16/08/2021  Ebon Clements  TSK 0899109
.           Added clear of shared care doctor update flag - UPVISFLG
. V11.00.01 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V10.15.01 21/10/2019  Ebon Clements  TSK 0882800
.           Don't send an A08 for doctor care maintenace if the admission
.           status is cancelled - DCMAIN00
.----------------------------------------------------------------------
. V10.14.02 17/09/2019  Thanh T        TSK 0880262
.           Changed DCARE150 to fix issue with the 'Attending doctor' 
.           not showing when the Secondary doctor is added with the 
.           exact date/time as the Attending doctor      
. V10.14.01 08/05/2019  Jill Parkinson Task 0871365
.           Added branch on F1 instead of exit after wipg0000 add program call
.----------------------------------------------------------------------
. V10.13.05 17.12.2018  Ebon Clements  TSK 0859064
.           Added mark action type to patient problem audit - AUDACT00
. V10.13.04 17.12.2018  B.G.Ackland    TSK 0835482 
.           FHIR Output Add asserter display
. V10.13.03 27/11/2018  Ania P         TSL 0866657
.           Replaced PMSPP028 with PMSPP029
. V10.13.02 24/10/2018  Ebon Clements  TSK 0815359
.           Clear discharge fields for current patients for AH Contacts
.           18/10/2018  Don Nguyen     TSK 0838558
.           Deleted comments temp file (COMFILPG) after use
. V10.13.01 30/07/2018  Ebon Clements  TSK 0815359
.           Added report 15 inpatient AH contacts
. V10.12.03 24/05/2018  Don Nguyen     TSK 0846099
.           Recompiled for changes to PATFIMTM - Added PTFI0920
. V10.12.02 10/05/2018  Tracey Nguyen    TSK 0841644
.           Initialize TOTFIMWS after MOTFIMWS in DFIM3000 to display as ".000"
.           if value is zero instead of "00000.000"
. V10.12.01 24/04/2018  Tracey Nguyen    TSK 0841644
.           1)Modified DFIM0000 to output Weighted FIM score if PTCNFIMW=1
.           2)Modified CAAC2100 to calculate Weighted FIM score if PTCNFIMW=1
.----------------------------------------------------------------------
. V10.11.05 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
. V10.11.04 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.03 12.10.2017  Ania P         TSK 0846433
.           Changed content of USRCRTDT in DROW1000
. V10.11.02 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.01 03/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.----------------------------------------------------------------------
. V10.10.04 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
. V10.10.03 27/04/2017  B.G.Ackland    TSK 0835482
.           FHIR Interface Processing (FHIR Condition Resource)
. V10.10.02 27/03/2017  B.G.Ackland    TSK 0835482
.           Changes to enable FHIR Interface Processing (FHIR Condition Resource)
. V10.10.01 16/03/2017 Jill Parkinson TSK 0818098
.           Added new aroc fields for discharged timed up and go seconds and
.           10 metre walk seconds
. V10.09.02 28/02/2017  Davin          TSK 0832314
.           Added HL7 triggers 4 and 5 for add/update doctor (uppmvx11)
. V10.09.01 23/01/2017  Ebon Clements  TSK 0823180
.           Added supervisor update program admission type - PROG0000
. V10.08.10 06/10/2016  Ebon Clements  TSK 0823847
.           Added secondary doctor tag to report 5 - GTAG0000
. V10.08.09 04/10/2016  Peter Vela     TSK 0826904
.           Fixed validation for GEM/FIM Assessments in GTABW000
. V10.08.08 15/06/2016  Ebon Clements  TSK 0318672
.           Added count OP appointments by associated number functionality to
.           patient programs
. V10.08.07 09/06/2016  Peter Vela     TSK 0820521
.           Recompiled for PMSRUGTM
. V10.08.06 12/05/2016  J.Tan          CAR 0809575
.           Modified DROW0000 to initialise Unit Description
. V10.08.05 01/04/2016  Don Nguyen     CAR 0813124
.           Modified MAST0000 to loop discharge file instead of admission file
. V10.08.04 31/03/2016  Don Nguyen     CAR 0813124
.           Added MASCA000 to output all current admissions missing Assessments.
.           Moved code to check for Assessments into CHKASE00.
. V10.08.03 30/03/2016  Don Nguyen     CAR 0813124
.           Modified MAST0000 - only current admissions for 'Current' filter
. V10.08.02 30/03/2016  Don Nguyen     CAR 0813124
.           Modified MAST0000 to skip admission date check for 'Current' filter
.           Also added output of adm/disch date values for column sort.
. V10.08.01 30/03/2016  Don Nguyen     CAR 0813124
.           Modified MAST0000 to correct OPTNCODE filtering
.----------------------------------------------------------------------
. V10.07.06 30/12/2015  Peter Vela     CAR 0808396
.           Added tag for Attending Doctor in GTAG0000
. V10.07.05 21/12/2015  Peter Vela     CAR 0808065
.           Fixed pack of key in HTABW0000 and MTABW0000
. V10.07.04 19/11/2015  Peter Vela     CAR 323717
.           Call CLPATDSC in MAST0000
. V10.07.03 18/11/2015  Peter Vela     CAR 323717
.           Removed validations for SMMSE from MAST0000
. V10.07.02 18/11/2015  Peter Vela     CAR 323717
.           Fixed validation for Missing Assessments in MAST0000
. V10.07.01 23/10/2015  Don Nguyen     CAR 316624
.           Modified VALA0000 to check for blank end date before validations.
.           Renamed PMDTC000 to SETDC000; allow blank values for
.           PMDTC004 & PMDTC006.
.----------------------------------------------------------------------
. V10.06.14 10/08/2015  Peter Vela     CAR 319656
.           Fixed Doctor Unit column in DROW0000 for standard
. V10.06.13 07/08/2015  Peter Vela     CAR 320050
.           Recompiled for ALLSASFD
. V10.06.12 29/07/2015  Peter Vela     CAR 320048
.           Recompiled for PMSRUGTM
. V10.06.11 22/07/2015  Jill Parkinson CAR 317209  
.           Added check for admission withing program dates in MSPG0000   
. V10.06.10 14/07/2015  Jill Parkinson CAR 317209  
.           Fixed match to pmsupgaf in MSPG0000                           
. V10.06.09 13/07/2015  Don Nguyen       CAR 318207
.           Modified VALO0000 to skip validations for Additional Doctor
. V10.06.08 01/07/2015  Ania P           CAR 318537
.           Fixed Attending Doctor Unit in DROW0000
. V10.06.07 17/06/2015  Patrick Adair    CAR 317209
.           New report for Visits with a Missing Program
. V10.06.06 11/06/2015  Ebon Clements   CAR 317878
.           Fixed program maintenance comments created by user id - ADDCOM00
.           Fixed program maintenance comments deleted by user id - DELCOM00
. V10.06.05 23/05/2015  Jill Parkinson  CAR 312723
.           Added update for Advanced Care Plan Flag
. V10.06.04 06/05/2015  Patrick Adair    CAR 271541
.           Added AN-SNAP changes for WA Health
. V10.06.03 20/04/2015  Steve Armstrong  CAR 290369
.           Recompiled for changes to PMSSNPFD
. V10.06.02 24/03/2015  Don Nguyen       CAR 314369
.           Added clear for MRGEFLAG in CLRPAR00
. V10.06.01 12/03/2015  Patrick Adair    CAR 308415
.           Added FIM Total AN-SNAP Auto Classification
.           12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use
.----------------------------------------------------------------------
. V10.05.06 26/02/2015  Patrick Adair    CAR 295856
.           Added display of all visits for patient between program start and
.           end dates
. V10.05.05 11/12/2014  Don Nguyen       CAR 301494
.           Modified DCARE000 & DROW0000 to output new fields for Additional
.           Care Doctor. Added PMDT0150.
.           Added MODTIMFN include.
.           Modified VALA0000 to ignore duplicate keys for Add (we now add
.           one second to the time before adding a new record).
.           Skipped call to VALO0000 for ADDDTC00 and UPDDTC00 if SETSECDT != 0
.           Simplified DELDTC00.
. V10.05.04 30/09/2014  Ebon Clements    CAR 277093
.           Fixed loop for selecting a valid auto classification - CAAC2300
.           Correct age processing checks - CAAC5000
. V10.05.03 09/09/2014  Patrick Adair    CAR 277093
.           Correct age processing checks
. V10.05.02 27/08/2014  Patrick Adair    CAR 277093
.           Added AN SNAP Auto Classification functionality
.           27/08/2014  Patrick Adair    CAR 294210
.           Added Program Maintenance Comments functionality
.           Added Program Interruption Expiry date update
. V10.05.01 22/07/2014  Ebon Clements   CAR 302859
.           Check for duplicate key on update of pmsupgaf - PROG2000
. V10.04.04 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 26/03/2014  J.Tan          CAR 279251
.           Added Death audit details
. V10.04.01 09/01/2014  Jill Parkinson CAR 295953
.           Fixed check for Interruption overlaps
.           Added showcodg for CAR 290943
.----------------------------------------------------------------------
. V10.03.32 29/11/2013  Patrick Adair    CAR 294209
.           Updated for Program Interrupted display
. V10.03.31 28/11/2013  Patrick Adair    CAR 291388
.           Output Date Clinically Ready for Rehab
. V10.03.30 27/11/2013  Patrick Adair    CAR 259559
.           Allow update of non Rehab programs (UPRG0000)
. V10.03.29 16/09/2013  Don Nguyen       CAR 291192
.           Added ADMT0000 and DIST0000
. V10.03.28 10/09/2013  Peter Vela       CAR 289907
.           Added Change Provisional DRG to UROW0000
. V10.03.27 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIIO
. V10.03.26 05/09/2013  Jill Parkinson CAR 289849
.           Added keep alive comment to missing FIM pages
. V10.03.25 05/09/2013  Patrick Adair  CAR 289849
.           Change Missing Admission/Discharge FIM to only scan selected month
. V10.03.24 08.04.2013  B.G.Ackland    CAR 288225
.           Mobility Suite Clinical Summary View
.           Extend Problem List Data Fields
.           18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.23 26/02/2013  Patrick Adair  CAR 281720
.           Show FIM Scores on FIM Assessment List
. V10.03.22 20/02/2013  Jill Parkinson CAR 281115
.           Changed DIPV0000 to use AFUNDH instead of PFUNDH
. V10.03.21 19/02/2013  Jill Parkinson CAR 281115
.           Recompiled for CINP000 - program list was using pmi fund instead
.           of admission health fund/table
. V10.03.20 13/02/2013  Don Nguyen     CAR 280770
.           Removed check on SAVSDOCT and SAVSUNIT in DCARE250 to display all
.           doctor care records for the same doctor/unit.
. V10.03.19 08/01/2013  Patrick Adair  CAR 277015
.           AN-SNAP Classification to be non-mandatory if no FIM scores exist
.           for a program
. V10.03.18 11/12/2012  Jill Parkinson CAR 277915
.           Fixed output of HFNAME in program list
. V10.03.17 04/12/2012  Jill Parkinson CAR 277146
.           Added program error messages in ADDPRG92 and ADDPRG93
. V10.03.16 19/11/2012  Peter Vela     CAR 276367
.           Recompiled for PATFIMTM
. V10.03.15 15/10/2012  Patrick Adair  CAR 274597
.           Change Missing Admission/Discharge FIM to be hospital specific
. V10.03.14 15/10/2012  Patrick Adair  CAR 274410
.           changed Program interruption overlap date checking functionality to
.           issue  warning message only now and check dates against program
.           start and end dates not Admission/Discharge dates
. V10.03.13 09/10/2012  Patrick Adair  CAR 273161
.           Changed Program interruption key for delete functionality
. V10.03.12 04/10/2012  Patrick Adair  CAR 273161
.           Added Program Delete functionality
. V10.03.11 01/10/2012  Patrick Adair  CAR 273962
.           Fixed FIM Assesment reads and displays
. V10.03.10 01/10/2012  Patrick Adair  CAR 273178
.           Fixed patient age display on FIM lists
. V10.03.09 19/09/2012  Patrick Adair  CAR 273062
.           Amended Discharge Date rehab Date Display
. V10.03.08 18/09/2012  Patrick Adair  CAR 273312
.           Amended ptfim004 processing
. V10.03.07 14/09/2012  Patrick Adair  CAR 273062
.           Made further changes for date displays
. V10.03.06 12/09/2012  Patrick Adair  CAR 272964
.           Corrected rehab date and rehab discharge date displays
. V10.03.05 12/09/2012  Patrick Adair  CAR 272960
.           Corrected Discharge date display
. V10.03.04 21/05/2012  Jill Parkinson CAR 257615
.           Added NOPROGRM flag
. V10.03.03 03/04/2012  Patrick Adair   CAR 257776
.           Added AN-SNAP processing
. V10.03.02 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.01 22/11/2011  Ebon Clements  CAR 255484
.           Changed ALTRTYPE from DIM 25 to DIM 30
. V10.02.07 17/10/2011  Steve Armstrong  CAR 251886
.           Added HL7 message triggers for visit update (A08 - DGCLICAC)
.           when secondary consultant is added, updated or deleted
. V10.02.06 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.05 07/10/2011  Saroeun Soeur  CAR 234355
.           added row - UROW0000 - PTUNOTTM
. V10.02.04 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.03 01/09/2011  Jill Parkinson CAR 249825
.           Added PPRDIR00
. V10.02.02 19/08/2011  Davin          CAR 248341
.           Added secondary team field (pmdtteam)
. V10.02.02 19/08/2011  Davin          CAR 248341
.           Added secondary team field (pmdtteam)
. V10.02.01 08/07/2011  Saroeun Soeur  CAR 245064
.           Display the correct Attending Doctor (Pre-admin) and UNIT
. V10.00.06 24/08/2010  Jill Parkinson CAR 216702
.           Added new patunaaf list
. V10.00.05 21/07/2010  Ebon Clements CAR 207040
.           Recompiled for PMSUPGCD - OP visit count
. V10.00.04 08/06/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.03 02/06/2010  Jill Parkinson CAR 222551
.           Added redirect to SETPAR00
. V10.00.02 21/05/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.01 08/04/2010 Jill Parkinson CAR 207094
.           Added PMPBLVIS
. V9.12.02  10/03/2010 Jill Parkinson CAR
.           Fixed tag for PMPBNRDT
. V9.12.01  16/02/2010 Ebon Clements CAR 207040
.           Added report 6 - Patient level health fund program maintenance
. V9.10.02  27/04/2009 WEELEE KOO   CAR 191723
.           Display the correct Attending Doctor (Pre-admin) under Doc Care List
. V9.10.01  05/05/2008  Ebon Clements  CAR 167071
.           Changed doctor care add, upd and del to clear visit extn doctor/unit
. V9.08.02  08/06/2007  Mike Laming    CAR 125736
.           Remove INC for PATDKIKY
. V9.08.01  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B01 22/12/2005 Ebon Clements CAR 76341
.           Added write of attending HCP to care team details table
.           on update of doctor care details
. V9.04.01  25/02/2005 Jill Habasque CAR 56347
.           Added doctor care functionality
. V9.03.02  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.01  26/03/2004 Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.02.03  13/12/2001 Harvinder
.           Modified LSTPB000 for option no. 3
. V9.02.02  05/12/2001 Katie Nelson/Harvinder SRF XXXXXX(nz)
.           Added option 3 - List all Problems by review date
. V9.02.01  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.00.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B03 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 17.05.2001 Ebon Clements
.           Created program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF
.
          INC       WEBDATDF
          INC       FHRDATDF
          INC       ALLPCTFD/INC
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC
          INC       MEHLERFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCONFD/INC
          INC       PATCONFD/INC
          INC       PATCALAG/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       PATHSPFD/INC
          INC       PATMI1FD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       OUTSITFD/INC
          INC       PATVISFD/INC
          INC       PATFN1FD/INC
          INC       PATIN1FD/INC
          INC       PATDO1FD/INC
          INC       PATALRFD/INC
          INC       PATMA1FD/INC
          INC       PATDSCFD/INC
          INC       PMSENCFD/INC
          INC       PMSEVTFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATDADFD/INC
          INC       PATUNAFD/INC
          INC       PMSBRQFD/INC
          INC       PMSDTCFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSUPGFD/INC
          INC       PMSAPGFD/INC                                    * CAR 257776
          INC       PMSAPGTD/INC                                    * CAR 257776
          INC       PMSPRGFD/INC                                    * CAR 257776
          INC       PMSPITFD/INC                                    * CAR 257776
          INC       PMSRUGFD/INC
          INC       PMSRUGTD/INC
          INC       PMSMMSFD/INC
          INC       ALLSASFD/INC
          INC       MEHHONFD/INC
          INC       PMSIGRFD/INC                                    * C-0841644
          INC       PMSIMPFD/INC                                    * CAR 257776
          INC       PMSSNCFD/INC
          INC       PMSSNPFD/INC                                    * CAR 257776
          INC       PATFIMFD/INC                                    * CAR 257776
          INC       PATFIMTD/INC                                    * CAR 257776
          INC       OPRNURFD/INC                                    * CAR 257776
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSUPOFD/INC
          INC       PMSHPGFD/INC
          INC       PMSHPOFD/INC
          INC       PATTRNFD/INC
          INC       PMSVX1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSPRBFD/INC
          INC       PMSRELFD/INC
          INC       PMSAUPFD/INC
          INC       PMSDAUFD/INC
          INC       PMSUDTFD/INC
          INC       PMSUTXFD/INC
.
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSUDTTD/INC
          INC       PMSUTXTD/INC
          INC       PMSTLEFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       TFILEVAR/INC
.
ADDNEWPG  FORM      1
ADMNTYPE  DIM       3
ALTRTYPE  DIM       30
OLDAU002  DIM       8
OLDAU003  DIM       8
PMSPB001  DIM       8                    * U/R Number
PMSPB002  DIM       5                    * Problem Number
PMSPB003  DIM       1                    * Sub Problem Indicator
PMSPB004  DIM       5                    * Parent Problem Number
PMSPB005  DIM       3                    * Problem ID
PMSPB006  DIM       3                    * Problem Type
PMSPB007  DIM       1                    * Active (Y/N)
PMSPB008  DIM       3                    * Problem Status
PMSPB009  DIM       50                   * Diagnosis/Problem Description 1
PMSPB010  DIM       50                   * Diagnosis/Problem Description 2
PMSPB011  DIM       5                    * Diagnosis Coding System
PMSPB012  DIM       10                   * Diagnosis Code
PMSPB013  DIM       8                    * Established Date
PMSPB014  DIM       5                    * Established Time
PMSPB015  DIM       10                   * Established By
PMSPB016  DIM       8                    * Est Resolutoin Date
PMSPB017  DIM       5                    * Est Resolutoin Time
PMSPB018  DIM       8                    * Actual Resolution Date
PMSPB019  DIM       5                    * Actual Resolution Time
PMSPB020  DIM       3                    * Review Status
PMSPB021  DIM       8                    * Next Review Date
PMSPB022  DIM       5                    * Next Review Time
PMSPB023  DIM       3                    * User Def Code 1
PMSPB024  DIM       3                    * User Def Code 2
PMSPB025  DIM       1                    * User Def Y/N 1
PMSPB026  DIM       1                    * User Def Y/N 2
PMSPB027  DIM       8                    * User Def Date 1
PMSPB028  DIM       8                    * User Def Date 2
PMSPB029  DIM       5                    * User Def Time 1
PMSPB030  DIM       5                    * User Def Time 2
PMSPB031  DIM       8                    * Linked visit
.
PMDAU001  DIM       8                    * U/R Number
PMDAU002  DIM       8                    * Date
PMDAU003  DIM       8                    * Time
PMDAU004  DIM       3                    * Type of record
PMDAU005  DIM       3                    * Value
.
PMUPG001  DIM       8                    * U/R Number
PMUPG002  DIM       3                    * Admission Type (Cat A)
PMUPG003  DIM       3                    * Claim Code     (Cat CL)
PMUPG004  DIM       6                    * Health Fund
PMUPG005  DIM       3                    * Health Fund Table Type (Cat HT)
PMUPG006  DIM       8                    * Expiry Date (CCYYMMDD)
PMUPG007  DIM       3                    * Maximum Number of IP Visits
PMUPG008  DIM       3                    * Warn at X Number of IP Visits
PMUPG009  DIM       3                    * Manual IP Visit Count
PMUPG010  DIM       3                    * Maximum Number of OP Visits
PMUPG011  DIM       3                    * Warn at X Number of OP Visits
PMUPG012  DIM       3                    * Manual OP Visit Count
PMUPG013  DIM       1                    * Breakdown of OP Visits
PMUPG014  DIM       8                    * Date Extension Received (CCYYMMDD)
PMUPG015  DIM       8                    * Start of Therapy (CCYYMMDD)
PMUPG016  DIM       50                   * Program Name
PMUPG017  DIM       3                    * UDS Impairment Code FIC
PMUPG018  DIM       3                    * AN-SNAP Class
PMUPG019  DIM       8                    * Therapy End Date (CCYYMMDD)
PMUPG020  DIM       3                    * Program in Progress
PMUPG021  DIM       1                    * Program Interupted
PMUPG022  DIM       8                    * Date of Rehab. Plan (CCYYMMDD)
PMUPG023  DIM       8                    * Discharge from Rehab Plan(CCYYMMDD)
.
PMUPO001  DIM       8                    * U/R Number
PMUPO002  DIM       3                    * Admission Type (Cat A)
PMUPO003  DIM       3                    * Claim Code (Cat CL)
PMUPO004  DIM       6                    * Health Fund
PMUPO005  DIM       3                    * Health Fund Table Type (Cat HT)
PMUPO006  DIM       8                    * Expiry Date (CCYYMMDD)
PMUPO007  DIM       3                    * Visit Type (Cat CV)
PMUPO008  DIM       3                    * Maximum Number of OP Visits
PMUPO009  DIM       3                    * Warn at X Number of OP Visits
PMUPO010  DIM       3                    * Manual OP Visit Count
.
CFILEPRE  DIM       3
DIM2A     DIM       2
DIM4      DIM       4
DIM8      DIM       8
DIM13     DIM       13
DIM20     DIM       20
FILTATYP  DIM       3                    * Admission type filter
FLTPB005  DIM       3                    * Filter ID
FLTPB006  DIM       3                    * Filter Type
FLTPB008  DIM       3                    * Filter Type
FLTPB020  DIM       3                    * Filter Type
PRIDDESC  DIM       20                   * Problem ID Description
PRTYDESC  DIM       20                   * Problem Type Description
PRSTDESC  DIM       20                   * Problem Status Description
RVSTDESC  DIM       20                   * Review Status Description
.
PMDTC001  DIM       8
PMDTC002  DIM       10
PMDTC003  DIM       3
PMDTC004  DIM       8
PMDTC005  DIM       8
PMDTC006  DIM       8
PMDTC007  DIM       8
PMDTC008  DIM       5
.
AUDITKEY  DIM       36                   * Audit Key
AUDITTYP  DIM       1                    * Audit Type
ACTNCODE  DIM       3                    * Action Code
ACTNCOMM  DIM       40                   * Comment
ADMSTYPE  DIM       3                                               * CAR 257776
ATYPDESC  DIM       20
.
ACTIDESC  DIM       8                    * Active or Inactive description
ADMCNTR   FORM      8
ADOCNAME  DIM       50
BLNKFLAG  FORM      1
BRKODESC  DIM       3
CALCDAYS  FORM      4                            * Rehab Suspension Days
CARECATG  DIM       2                    * category for care type     CAR 257776
CARECODE  DIM       3
COMFILPG  FILE      ASCII, FIXED=127             * Program Maintenance Comments
COMFILNW  DIM       8
COPYFLDS  DIM       83                   * FIM Scores for copy        CAR 257776
CLAMDESC  DIM       20
COGSCORE  FORM      3                                               * CAR 281720
COUNTER   FORM      2                                               * CAR 274410
CURRDATE  DIM       8                    * current date               CAR 273178
DFLTWARD  DIM       3              * pre-selected ward on select list CAR 257776
DISPSUR   DIM       8
DISPCOMM  DIM       1000
DISPDATE  DIM       11
DISPDTE1  DIM       11
DISPDACT  DIM       12                                              * CAR 257776
DISPDDSC  DIM       12                                              * CAR 257776
DISPRHDT  DIM       12                                              * CAR 272964
DISPRDDT  DIM       12                                              * CAR 272964
DISPTIME  DIM       8
DISPTYPE  DIM       20                                              * CAR 257776
DISPMUR   DIM       8
DOCTCODE  DIM       6
DOCTTYPE  DIM       20
DSCHFLAG  FORM      1
EDITFLAG  FORM      1
EXPIRYDT  DIM       8
FENDDATE  FORM      8                                               * CAR 257776
FIMADATE  DATE      8                                               * CAR 257776
FIMCDATE  FORM      8                                               * CAR 257776
FIMDDATE  FORM      8                                               * CAR 257776
FIMSCORD  DIM       3                                               * CAR 257776
FIMSCORE  FORM      3                                               * CAR 257776
FIMCSCRE  FORM      2
FIMMSCRE  FORM      2
FRMTDATE  DIM       8
FROMDATE  DATE      8                            * Date Calculation From
FSCORESY  DIM       1                                               * CAR 277015
FSTRTDTE  FORM      8                                               * CAR 257776
FORM8     FORM      8
FORM5     FORM      5
IPVCOUNT  FORM      3
IPVCMAXI  FORM      3
IPVEXTRA  FORM      3
IPVCWARN  FORM      3
IENDDATE  FORM      8                                               * CAR 257776
ISTRTDTE  FORM      8                                               * CAR 257776
LOOPCNTR  FORM      3
SETSECDT  FORM      1        * set Secondary Care Doctor
SUPRFLAG  FORM      1
FOUNDFLG  FORM      1
LASTITEM  FORM      3
MASSCNTR  FORM      2
MOTFIMWS  FORM      5.3                                             *C-0841644
MOTSCORE  FORM      3                                               * CAR 281720
MRGEFLAG  FORM      1
NEXTPAGE  DIM       1                    * Next page parameter
NEWVISIT  FORM      1
NMPNUMB   DIM       20
NONREHAB  DIM       1                    * N = nonrehab patient     * CAR 259559
NOPROGRM  FORM      1
OPTNCODE  DIM       1
OPVCOUNT  FORM      3
OPVCMAXI  FORM      3
OPVEXTRA  FORM      3
OPVCWARN  FORM      3
PMPITCNT  FORM      5                    * Program Interruption Cntr  CAR 257776
PROBLEMN  DIM       5                    * Problem number
PSAGETYP  DIM       1
PSAGECON  DIM       3
REASNDSC  DIM       50                                              * CAR 257776
SAVADOCT  DIM       10
SAVAUNIT  DIM       3
SAVKEY24  DIM       24                                              * CAR 273962
SAVKEY31  DIM       31
SAVKEY34  DIM       34
SAVSDOCT  DIM       10
SAVSUNIT  DIM       3
SAVSECDC  DIM       10       * Saved Secondary Doctor for Share Care List
SAVEURNO  DIM       8
SERVER    DIM       13      * Server Name
SHOWCODG  FORM      1
SHOWCOMM  FORM      1
STRIKETG  DIM       8
STRENDTG  DIM       9
SUPERLEV  DIM       1
REPTNO    DIM       3
TABTDESC  DIM       20
TODATE    DATE      8                            * Date Calculation To
TOTFIMWS  FORM      5.3                                             *C-0841644
TOTALSDS  FORM      4                            * Total Rehab Susp Days
TRANDATE  DIM       8
TRANTIME  DIM       8
UNITCODE  DIM       3                                               * CAR 257776
UPDTTYPE  DIM       1                    * Update Type
UPVISFLG  FORM      1
UNITDESC  DIM       25
UNITDES2  DIM       25
USRCRTDT  DIM       70
VTYPDESC  DIM       20
.
VALDURNO  DIM       8
VALDCLAM  DIM       3
VALDATYP  DIM       3
VALDFUND  DIM       6
VALDTABT  DIM       3
VALDEDAT  DIM       8
VALDICDE  DIM       7
VALDASSO  DIM       1
VALDSDAT  DIM       8
VALDSTYP  DIM       3
VALDVTYP  DIM       1
VSTEXIST  DIM       1                                               * CAR 273161
WARCOUNT  FORM      2                                               * CAR 274410
WARDCODE  DIM       3                                               * CAR 257776
WARDKEY   DIM       3                                               * CAR 257776
WEBWARNG  DIM       127[10]                                         * CAR 274410
WBSENAMC  DIM       30
WBSENAMD  DIM       30
.
HOURTME   DIM       2
HTMLLNK2  DIM       127                     * HTML link 2
MINTIME   DIM       2
SECTIME   DIM       2
.
PRBDAT01  DATE      8                       * Problem History Date 1
PRBTIM01  DIM       5
PRBTYP01  DIM       3                       * Problem History Type 1
PRBCOD01  DIM       10                      * Problem History Code 1
PRBDES01  DIM       50                      * Problem History Desc 1
PRBDES07  DIM       50                      * Problem History Desc 1 Continue
PRBSTA01  DIM       3                       * Problem History Status 1
PRBACT01  DIM       1                       * Problem History Active 1
.
PRBDAT02  DATE      8                       * Problem History Date 2
PRBTIM02  DIM       5
PRBTYP02  DIM       3                       * Problem History Type 2
PRBCOD02  DIM       10                      * Problem History Code 2
PRBDES02  DIM       50                      * Problem History Desc 2
PRBDES08  DIM       50                      * Problem History Desc 2 Continue
PRBSTA02  DIM       3                       * Problem History Status 2
PRBACT02  DIM       1                       * Problem History Active 2
.
PRBDAT03  DATE      8                       * Problem History Date 3
PRBTIM03  DIM       5                       * Problem History Type 3
PRBTYP03  DIM       3                       * Problem History Type 3
PRBCOD03  DIM       10                      * Problem History Code 3
PRBDES03  DIM       50                      * Problem History Desc 3
PRBDES09  DIM       50                      * Problem History Desc 3 Continue
PRBSTA03  DIM       3                       * Problem History Status 3
PRBACT03  DIM       1                       * Problem History Active 3
.
PRBDAT04  DATE      8                       * Problem History Date 4
PRBTIM04  DIM       5                       * Problem History Type 3
PRBTYP04  DIM       3                       * Problem History Type 4
PRBCOD04  DIM       10                      * Problem History Code 4
PRBDES04  DIM       50                      * Problem History Desc 4
PRBDES10  DIM       50                      * Problem History Desc 4 Continue
PRBSTA04  DIM       3                       * Problem History Status 4
PRBACT04  DIM       1                       * Problem History Active 4
.
PRBDAT05  DATE      8                       * Problem History Date 5
PRBTIM05  DIM       5                       * Problem History Type 3
PRBTYP05  DIM       3                       * Problem History Type 5
PRBCOD05  DIM       10                      * Problem History Code 5
PRBDES05  DIM       50                      * Problem History Desc 5
PRBDES11  DIM       50                      * Problem History Desc 5 Continue
PRBSTA05  DIM       3                       * Problem History Status 5
PRBACT05  DIM       1                       * Problem History Active 5
.
PRBDAT06  DATE      8                       * Problem History Date 6
PRBTIM06  DIM       5                       * Problem History Type 3
PRBTYP06  DIM       3                       * Problem History Type 6
PRBCOD06  DIM       10                      * Problem History Code 6
PRBDES06  DIM       50                      * Problem History Desc 6
PRBDES12  DIM       50                      * Problem History Desc 6 Continue
PRBSTA06  DIM       3                       * Problem History Status 6
PRBACT06  DIM       1                       * Problem History Active 6
.
BR        INIT      "<br>"
CATA      INIT      "A "                                            * CAR 257776
CATCC     INIT      "CC"                                            * CAR 257776
CATRZ     INIT      "RZ"                                            * CAR 257776
CATAC     INIT      "AC"                                            * CAR 257776
CATTC     INIT      "tc"
CATWX     INIT      "wx"
CATWZ     INIT      "wz"
NBSP      INIT      "%nbsp;"
AT        INIT      "at"
UNADMIT   INIT      "Unadmit"
UNDSCH    INIT      "Undischarge"
CHGADM    INIT      "Change Admission Date/Time"
CHGDSC    INIT      "Change Discharge Date/Time"
CANCPRE   INIT      "Cancel Preadmission"
CHGDRG    INIT      "Change Provisional DRG"
ONEINIT   INIT      "1"                                             * CAR 257776
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
DASH      INIT      "-"
.
FHRCONID  DIM      13  *  Condition ID
.FHRENCID  DIM      16  *  Encounter ID
.FHRPATID  DIM      8   *  Patient ID
.FHRPRAID  DIM      20  *  Practitioner ID
FHRSUBIN  FORM      1      * _include=Condition:subject
FHRPARIN  FORM      1      * _include=Condition:participant
FHIRBUND  FORM      1
FHIRLOCH  DIM       50
.
.-------------------------------------------------------------------------------
PRGID     INIT      "PATWEB03"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Patient Problem Listing"
.-------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PMSPRB00                * Patient Problem Details
          BRANCH    EXIT,MAIN1000
          MOVE      "Enquiry Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      AUDACT00                * Update Audit Action
          GOTO      MAIN1000
.
MAIN1300  CALL      PRBLST00                * List all Problems by review date
          GOTO      MAIN1000
.
MAIN1400  CALL      GETPAT00                * Standard patient level lists
          GOTO      MAIN1000
.
MAIN1500  CALL      DCMAIN00                * Doctor Care Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      PROG0000                * Patient F/Fund Program Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      REMOTE00                * Patient Program Remote Scripts
          GOTO      MAIN1000
.                                                                   * CAR 257776
MAIN1800  CALL      PRIT0000                * Patient Program Interrupted
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.                                                                   * CAR 257776
MAIN1900  CALL      PRFM0000                * Patient Program FIM Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.                                                                   * CAR 257776
MAIN2000  CALL      MFIM0000                 * List Missing FIMs
          GOTO      MAIN1000
.                                                                   * CAR 294210
MAIN2100  CALL      PMCOMM00                 * Program Maintenance Comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      MASS0000                 * List Missing Assessments - WAH
          GOTO      MAIN1000
.
MAIN2300  CALL      ADVCA000                * Advanced Care Plan Audit
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      MPGM0000                 * List FIM not linked to a Program
          GOTO      MAIN1000
.
MAIN2500  CALL      ICON0000                 * IP AH Contacts
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Patient Enquiry Page
.------------------------------------------------------------
GETPAT00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      ZERO,RESPFLAG
          MOVE      ZERO,DSCHFLAG
          MOVE      SP70,DOCTCODE
          CALL      IBACLOCK
          CALL      CLPATMAS
          CALL      CLPATMIS
          CALL      CLPATDSC
          CALL      CLPMSPX2
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      GETPAT00
          ENDIF
.
          IF        MASTFLAG=1
            MOVE      "Can't find patient master details",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT99
          ENDIF

          MOVE      ADMISSNO,KEY8
          MATCH     SP70,KEY8
          IF        @EQUAL
            MOVE      ONE,MISSFLAG
            MOVE      ONE,RESPFLAG
            MOVE      ONE,DSCHFLAG
            GOTO      GETPAT05
          ELSE
            CALL      RDMISS1
            MOVE      OVRCD,MISSFLAG
            CALL      RDPTDAD1
            IF        OVRCD=1
              MOVE      SP70,PTDAADTS
              MOVE      SP70,PTDADCTS
            ENDIF
.
            CALL      RDPTVIS1
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
          IF        OVRCD=0
            MOVE      DDATE,ICDRDDTE   * Needed for RDPTICD1 & RDPTICO1 reads
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
.
          MOVE      SP70,PMEVEVNT
          MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
.
GETPAT05  CALL      PATNAA00                * format name without bold tags
.
.                                                 * read nutrition file
.
.    Webtplaf must be read here to get correct description for WEBTITLE
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          PACK      KEY13,PRGID,KEY2,TEMPLATE,SP70
          CALL      RDWBTP1
          CLEAR     WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GETPAT99
.
          CALL      WEBBOD00   * Output Templated Body of HTML
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
GETPAT90  IF        PTCNNHII=1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
          CALL      WEBEND00   * Output End of Web Page
.
.
GETPAT99  RETURN
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.------------------------------------------------------------
. Update Action & Comment to Audit Table
.------------------------------------------------------------
.------------------------------------------------------------
. Update Action & Comment to Audit Table
.------------------------------------------------------------
AUDACT00  PACK      PMAPURNO,URNUMBER,SP70      * UR Number
          PACK      PMAPPNUM,PROBLEMN,SP70      * Problem Number
          PACK      PMAPWUID,USERID,SP70        * Web User ID
          CALL      IBACLOCK
          PACK      PMAPDATE,CCC,CYY,CMM,CDD
          REP       " 0",PMAPDATE               * Date
          CLOCK     TIME,PMAPTIME               * Time
.
          MOVE      "M",PMAPACTY                * Mark Action
          MOVE      ACTNCODE,PMAPACCD           * Action Code
          MOVE      ACTNCOMM,PMAPCOMM           * Comment
          MOVE      SP70,PMAPSPAR               * Spare
.
          PACK      KEY36,PMAPURNO,PMAPPNUM,PMAPDATE,PMAPTIME,PMAPWUID,SP70
          CALL      RAPMAUP1
          COMPARE   ZERO,OVRCD
          GOTO      AUDACT90 IF EQUAL
.
          IF        OVRCD=1
            CALL      WRPMAUP1
          ENDIF
          CALL      WINCLS00
          GOTO      AUDACT99
.
AUDACT90  CLEAR     WEBTITLE
          APPEND    "Action record already exists for this user ",WEBTITLE
          APPEND    "hour and minute.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
.
AUDACT99  RETURN
+
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      PMSPRBA1,"pmsprbaf"
          OPEN      PMSPRBA2,"pmsprbaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSAUPA1,"pmsaupaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PATICDO1,"paticdof"
          OPEN      PATUNAA1,"patunaaf"
          OPEN      PATMI1A1,"patmi1af"                             * CAR 257776
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A3,"patmi1af"                             * CAR 257776
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATWR1A1,"patwr1af"                             * CAR 257776
          OPEN      PATWR1A7,"patwr1af"                             * CAR 257776
          OPEN      PATICDO1,"paticdof"
          OPEN      PATI10O1,"pati10of"
          OPEN      PMSENCA1,"pmsencaf"
          OPEN      PMSENCA2,"pmsencaf"
          OPEN      PMSDTCA1,"pmsdtcaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      ALLPCTA1,"allpctaf"
          OPEN      PMSDAUA1,"pmsdauaf"
          OPEN      PMSUDTA1,"pmsudtaf"
          OPEN      PMSUTXA1,"pmsutxaf"
          OPEN      PMSSNCA2,"pmssncaf"
          OPEN      PMSRUGA1,"pmsrugaf"
          OPEN      PMSMMSA1,"pmsmmsaf"
          OPEN      ALLSASA1,"allsasaf"
          OPEN      MEHHONA1,"mehhonaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSIGRA1,"pmsigraf"                           * C-0841644 
          OPEN      PMSIMPA1,"pmsimpaf"                           * C-0841644 
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,THIRTY2;*143,OTCNCASS
          READ      CONTROLF,HUND25;*172,PTCNFIMW                 * C-0841644
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          OPEN      OUTSITA3,"outsitaf"     * Open the site file
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          MOVE      ZERO,NOPROGRM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSHPGA1,"pmshpgaf"
          TRAPCLR   IO
          IF        OVRCD<>1
            OPEN      PMSHPOA1,"pmshpoaf"
            OPEN      PMSUPGA1,"pmsupgaf"
            OPEN      PMSAPGA1,"pmsapgaf"                           * CAR 257776
            OPEN      PMSPITA1,"pmspitaf"                           * CAR 257776
            OPEN      PMSPRGA1,"pmsprgaf"                           * CAR 257776
..........  OPEN      PMSIMPA1,"pmsimpaf"  *C-0841644               * CAR 257776
            OPEN      PATFIMA1,"patfimaf"                           * CAR 257776
            OPEN      OPRNURA1,"oprnuraf"                           * CAR 257776
            OPEN      PMSSNPA1,"pmssnpaf"                           * CAR 257776
            OPEN      PMSUPOA1,"pmsupoaf"
          ELSE
            MOVE      ONE,NOPROGRM
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNW
.
          CALL      OPICD1                      * Open ICD Disease files
.
          RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BOKA3 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
OPNOUT99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the visit files site code. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
COTFIL00  MATCH     SP70,PVISITE             * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
+
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,TEMPLATE
          MOVE      ZERO,SHOWCODG
          MOVE      ZERO,SHOWCOMM
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,NEXTPAGE
          MOVE      ZERO,PROBLEMN
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,FRSTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,FILTATYP
          MOVE      Z70,EXPIRYDT
          MOVE      Z70,OLDAU002
          MOVE      Z70,OLDAU003
.
          MOVE      Z70,PMSPB001
          MOVE      Z70,PMSPB002
          MOVE      Z70,PMSPB003
          MOVE      Z70,PMSPB004
          MOVE      Z70,PMSPB005
          MOVE      Z70,PMSPB006
          MOVE      ZERO,PMSPB007
          MOVE      Z70,PMSPB008
          MOVE      Z70,PMSPB009
          MOVE      Z70,PMSPB010
          MOVE      Z70,PMSPB011
          MOVE      Z70,PMSPB012
          MOVE      Z70,PMSPB013
          MOVE      Z70,PMSPB014
          MOVE      Z70,PMSPB015
          MOVE      Z70,PMSPB016
          MOVE      Z70,PMSPB017
          MOVE      Z70,PMSPB018
          MOVE      Z70,PMSPB019
          MOVE      Z70,PMSPB020
          MOVE      Z70,PMSPB021
          MOVE      Z70,PMSPB022
          MOVE      Z70,PMSPB023
          MOVE      Z70,PMSPB024
          MOVE      Z70,PMSPB025
          MOVE      Z70,PMSPB026
          MOVE      Z70,PMSPB027
          MOVE      Z70,PMSPB028
          MOVE      Z70,PMSPB029
          MOVE      Z70,PMSPB030
          MOVE      Z70,PMSPB031
.
          MOVE      Z70,PMDAU001
          MOVE      Z70,PMDAU002
          MOVE      Z70,PMDAU003
          MOVE      Z70,PMDAU004
          MOVE      Z70,PMDAU005
.
          MOVE      Z70,PMUPG001
          MOVE      Z70,PMUPG002
          MOVE      Z70,PMUPG003
          MOVE      Z70,PMUPG004
          MOVE      Z70,PMUPG005
          MOVE      Z70,PMUPG006
          MOVE      Z70,PMUPG007
          MOVE      Z70,PMUPG008
          MOVE      Z70,PMUPG009
          MOVE      Z70,PMUPG010
          MOVE      Z70,PMUPG011
          MOVE      Z70,PMUPG012
          MOVE      Z70,PMUPG013
          MOVE      Z70,PMUPG014
          MOVE      Z70,PMUPG015
          MOVE      Z70,PMUPG016
          MOVE      Z70,PMUPG017
          MOVE      Z70,PMUPG018
          MOVE      Z70,PMUPG019
          MOVE      Z70,PMUPG020
          MOVE      Z70,PMUPG021
          MOVE      Z70,PMUPG022
          MOVE      Z70,PMUPG023
.
          MOVE      Z70,PMUPO001
          MOVE      Z70,PMUPO002
          MOVE      Z70,PMUPO003
          MOVE      Z70,PMUPO004
          MOVE      Z70,PMUPO005
          MOVE      Z70,PMUPO006
          MOVE      Z70,PMUPO007
          MOVE      Z70,PMUPO008
          MOVE      Z70,PMUPO009
          MOVE      Z70,PMUPO010
          MOVE      ZERO,ADDNEWPG
.
          MOVE      SP70,FLTPB005
          MOVE      SP70,FLTPB006
          MOVE      SP70,FLTPB008
          MOVE      SP70,FLTPB020
          MOVE      Z70,ADMNTYPE
.
          MOVE      SP70,ACTNCODE
          MOVE      SP70,ACTNCOMM
.
          MOVE      Z70,PMDTC001
          MOVE      Z70,PMDTC002
          MOVE      Z70,PMDTC003
          MOVE      Z70,PMDTC004
          MOVE      Z70,PMDTC005
          MOVE      Z70,PMDTC006
          MOVE      Z70,PMDTC007
          MOVE      Z70,PMDTC008
.
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDCLAM
          MOVE      SP70,VALDATYP
          MOVE      SP70,VALDFUND
          MOVE      SP70,VALDTABT
          MOVE      SP70,VALDEDAT
          MOVE      SP70,VALDICDE
          MOVE      SP70,VALDASSO
          MOVE      SP70,VALDSDAT
          MOVE      SP70,VALDSTYP
          MOVE      SP70,VALDVTYP
.
          MOVE      SP70,DISPRHDT                                   * CAR 272964
          MOVE      SP70,DISPRDDT                                   * CAR 272964
          MOVE      SP70,DISPDATE                                   * CAR 272960
          MOVE      SP70,DISPDACT                                   * CAR 272960
          MOVE      SP70,DISPDDSC                                   * CAR 272960
          MOVE      SP70,UNITCODE                                   * CAR 257776
          MOVE      SP70,ADMSTYPE                                   * CAR 257776
          MOVE      SP70,CARECODE
          MOVE      SP70,SUPERLEV
          MOVE      SP70,OPTNCODE
          MOVE      SP70,WARDCODE                                   * CAR 257776
          MOVE      ZERO,WARCOUNT                                   * CAR 274410
          MOVE      "0",VSTEXIST                                    * CAR 273161
          MOVE      "0",FSCORESY                                    * CAR 277015
.
          MOVE      Z70,PRBDAT01
          MOVE      Z70,PRBTIM01
          MOVE      Z70,PRBCOD01
          MOVE      Z70,PRBDES01
          MOVE      Z70,PRBDES07
          MOVE      Z70,PRBTYP01
          MOVE      Z70,PRBSTA01
          MOVE      Z70,PRBACT01
.
          MOVE      Z70,PRBDAT02
          MOVE      Z70,PRBTIM02
          MOVE      Z70,PRBCOD02
          MOVE      Z70,PRBDES02
          MOVE      Z70,PRBDES08
          MOVE      Z70,PRBTYP02
          MOVE      Z70,PRBSTA02
          MOVE      Z70,PRBACT02
.
          MOVE      Z70,PRBDAT03
          MOVE      Z70,PRBTIM03
          MOVE      Z70,PRBCOD03
          MOVE      Z70,PRBDES03
          MOVE      Z70,PRBDES09
          MOVE      Z70,PRBTYP03
          MOVE      Z70,PRBSTA03
          MOVE      Z70,PRBACT03
.
          MOVE      Z70,PRBDAT04
          MOVE      Z70,PRBTIM04
          MOVE      Z70,PRBCOD04
          MOVE      Z70,PRBDES04
          MOVE      Z70,PRBDES10
          MOVE      Z70,PRBTYP04
          MOVE      Z70,PRBSTA04
          MOVE      Z70,PRBACT04
.
          MOVE      Z70,PRBDAT05
          MOVE      Z70,PRBTIM05
          MOVE      Z70,PRBCOD05
          MOVE      Z70,PRBDES05
          MOVE      Z70,PRBDES11
          MOVE      Z70,PRBTYP05
          MOVE      Z70,PRBSTA05
          MOVE      Z70,PRBACT05
.
          MOVE      Z70,PRBDAT06
          MOVE      Z70,PRBTIM06
          MOVE      Z70,PRBCOD06
          MOVE      Z70,PRBDES06
          MOVE      Z70,PRBDES12
          MOVE      Z70,PRBTYP06
          MOVE      Z70,PRBSTA06
          MOVE      Z70,PRBACT01
.
          CALL      CPPAPG00                                        * CAR 257776
          CALL      CPPPIT00                                        * CAR 257776
          CALL      CPPTFI00                                        * CAR 257776
          CALL      CPPUDT00
.
          MOVE      ZERO,SETSECDT
.
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,SUPRFLAG
          MOVE      ZERO,UPVISFLG
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,FHIRBUND
          MOVE      SP70,FHIRLOCH
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcodg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCODG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldau002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,OLDAU002
            REP       " 0",OLDAU002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldau003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDAU003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltpb005=",QRYNAME
          IF        @EQUAL
            PACK      FLTPB005,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltpb006=",QRYNAME
          IF        @EQUAL
            PACK      FLTPB006,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltpb008=",QRYNAME
          IF        @EQUAL
            PACK      FLTPB008,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltpb020=",QRYNAME
          IF        @EQUAL
            PACK      FLTPB020,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "problemn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROBLEMN
            GOTO      SETPAR99
          ENDIF

          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actncomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmspb",QRYNAME
          IF        @EQUAL
            CALL      PMSPP000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdau",QRYNAME
          IF        @EQUAL
            CALL      PMDAU000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmupg",QRYNAME
          IF        @EQUAL
            CALL      STUPG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmapg",QRYNAME                                 * CAR 257776
          IF        @EQUAL
            CALL      SPPAPG00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpit",QRYNAME                                 * CAR 257776
          IF        @EQUAL
            CALL      SPPPIT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptfim",QRYNAME                                 * CAR 257776
          IF        @EQUAL
            CALL      SPPTF000
            GOTO      SETPAR99
          ENDIF
.                                                                   * CAR 257776
          MATCH     "unitcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNITCODE
            PACK      UNITCODE,UNITCODE,SP70
            GOTO      SETPAR99
          ENDIF
.                                                                   * CAR 257776
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WARDCODE
            PACK      WARDCODE,WARDCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admstype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMSTYPE
            PACK      ADMSTYPE,ADMSTYPE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "carecode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CARECODE
            PACK      CARECODE,CARECODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTNCODE
            PACK      OPTNCODE,OPTNCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "pmupo",QRYNAME
          IF        @EQUAL
            CALL      STUPO000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdtc",QRYNAME
          IF        @EQUAL
            CALL      SETDC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trndate1=",QRYNAME     * this it for date field
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "expirydt=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            PACK      EXPIRYDT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtatyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTATYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            PACK      VALDURNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdclam=",QRYNAME
          IF        @EQUAL
            PACK      VALDCLAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdatyp=",QRYNAME
          IF        @EQUAL
            PACK      VALDATYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdfund=",QRYNAME
          IF        @EQUAL
            PACK      VALDFUND,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtabt=",QRYNAME
          IF        @EQUAL
            PACK      VALDTABT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdicde=",QRYNAME
          IF        @EQUAL
            PACK      VALDICDE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdasso=",QRYNAME
          IF        @EQUAL
            PACK      VALDASSO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdsdat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      VALDSDAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdedat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      VALDEDAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdstyp=",QRYNAME
          IF        @EQUAL
            PACK      VALDSTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdvtyp=",QRYNAME
          IF        @EQUAL
            PACK      VALDVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addnewpg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDNEWPG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmudt",QRYNAME
          IF        @EQUAL
            CALL      SPMUT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prgmcomm=",QRYNAME
          IF        @EQUAL
            CALL      GETPGC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setsecdt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETSECDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admntype=",QRYNAME
          IF        @EQUAL
            PACK      ADMNTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod01=",QRYNAME             *Historical Problem Code
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod05=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbcod06=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBCOD06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat01=",QRYNAME             *Historical Problem Date
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT01,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat02=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT02,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat03=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT03,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat04=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT04,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat05=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT05,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdat06=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PRBDAT06,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim01=",QRYNAME             *Established Time      
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim02=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim03=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim04=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim05=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtim06=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,PRBTIM06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp01=",QRYNAME             *Historical Problem Type
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp05=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbtyp06=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBTYP06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta01=",QRYNAME           *Historical Problem Status
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta05=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbsta06=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBSTA06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes01=",QRYNAME             *Historical Proble Descript
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes05=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes06=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes07=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES07
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes08=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES08
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes09=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES09
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes10=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes11=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES11
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbdes12=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBDES12
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact05=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT05
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prbact06=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRBACT06
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirbund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRBUND
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Process Fields
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40,PROFLD50:
                    PROFLD60,PROFLD99,PROFLD80,PROFLD90,PROFL100,PROFL110:
                    PROFL120,PROFL130,PROFL140,PROFL150
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD12  CALL      EXTD0000                * Problem Details
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      LSTPB000                * Problem Patients List by Date
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD42  CALL      LIST0000                * Lists
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD52  CALL      PMDT0000                * Doctor Care Details
          GOTO      PROFLD99
.
PROFLD53  CALL      GTAG0000
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64,PROFLD65:
                             PROFLD66,PROFLD67
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD62  CALL      PMHP0000                * Health Fund Program Details
          GOTO      PROFLD99
.
PROFLD63  CALL      PMUG0000                * Patient Health Fund Program
          GOTO      PROFLD99                * Details
.
PROFLD64  CALL      GTAG0000
          GOTO      PROFLD99
.
PROFLD65  CALL      PMUO0000                * Patient Health Fund OP Program
          GOTO      PROFLD99                * Breakdown Details
.
PROFLD66  CALL      PAPG0000                * Patient Program Details Extension
          GOTO      PROFLD99                                        * CAR 257776
.
PROFLD67  CALL      PMUT0000                * Disp Program Maint Comments
          GOTO      PROFLD99
.                                                                   * CAR 257776
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD82  CALL      GTAG0000                * General Tags
          GOTO      PROFLD99
.
PROFLD83  CALL      PPIT0000                * Program Interruption Details
          GOTO      PROFLD99
.
PROFLD84  CALL      PMUG0000                * Patient Health Fund Program
          GOTO      PROFLD99                * Details
.                                                                   * CAR 25776
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFLD92  CALL      GTAG0000                * General Tags
          GOTO      PROFLD99
.
PROFLD93  CALL      PTFI0000                * Program FIM Score Details
          GOTO      PROFLD99
.
PROFLD94  CALL      PMUG0000                * Patient Health Fund Program
          GOTO      PROFLD99                * Details
.
PROFLD95  CALL      PAPG0000                * Patient Program Details Extension
          GOTO      PROFLD99
.                                                                   * CAR 25776
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102
          GOTO      PROFLD99
.
PROFL101  CALL      MAFD0000                * Missing Admission FIM Details
          GOTO      PROFLD99
.
PROFL102  CALL      MDFD0000                * Missing Discharge FIM Details
          GOTO      PROFLD99
.                                                                   * CAR 294210
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113,PROFL114
          GOTO      PROFLD99
.
PROFL111  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFL112  CALL      PMUG0000                * Patient Health Fund Program
          GOTO      PROFLD99                * Details
.
PROFL113  CALL      PMUT0000                * Disp Program Maint Comments
          GOTO      PROFLD99
.
PROFL114  CALL      GTAG0000                * General Tags
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121
          GOTO      PROFLD99
.
PROFL121  CALL      MASD0000                * Missing AN-SNAP Assessments
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132
          GOTO      PROFLD99
.
PROFL131  CALL      MASF0000                * Master Details
          GOTO      PROFLD99
.
PROFL132  CALL      PMDA0000                * Advanced Care Plan Audit
          GOTO      PROFLD99
.                                                                   * CAR 25776
PROFL140  BRANCH    FLDSETNO,PROFL141
          GOTO      PROFLD99
.
PROFL141  CALL      NPGM0000                * Visits not linked to a Program
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151
          GOTO      PROFLD99
.
PROFL151  CALL      ITAG0000                * IP Ah contact tags
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. Advanced Care Plan Details
.------------------------------------------------------------
PMDA0000  BRANCH    FLDITMNO,PMDA0010,PMDA0020,PMDA0030,PMDA0040,PMDA0050
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      PMDA9999
.
PMDA0010  WRITE     HTMLFILE;PMDEURNO;
          GOTO      PMDA9999
.
PMDA0020  MATCH     SP70,PMDECDAT
          GOTO      PMDA9999 IF EQUAL
.
          UNPACK    PMDECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMDA9999
.
PMDA0030  WRITE     HTMLFILE;PMDECTIM;
          GOTO      PMDA9999
.
PMDA0040  WRITE     HTMLFILE;PMDERTYP;
          GOTO      PMDA9999
.
PMDA0050  MOVE      "P9",CATEGORY
          MOVE      PMDEFL01,CODE
          CALL      CODITM00
          GOTO      PMDA9999
.
PMDA9999  RETURN
+
.------------------------------------------------------------
. Lists
.------------------------------------------------------------
LIST0000  BRANCH    FLDITMNO,LIST0010,LIST0020,LIST0030,LIST0040
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      LIST9999
.
LIST0010  CALL      DCARE000        * Doctor Care List
          GOTO      LIST9999
.
LIST0020  CALL      PTUNA000        * Inpatient Audit List
          GOTO      LIST9999
.
LIST0030  CALL      DEATH000        * Death Audit List
          GOTO      LIST9999
.
LIST0040  CALL      ADVCP000        * Advanced Care Plan Audit List
          GOTO      LIST9999
.
LIST9999  RETURN
+
.------------------------------------------------------------
. Doctor Care List
.------------------------------------------------------------
DCARE000  MOVE      ZERO,FOUNDFLG
          MOVE      ZERO,EDITFLAG
          MOVE      SP70,SAVADOCT
          MOVE      SP70,SAVAUNIT
          MOVE      SP70,SAVSDOCT
          MOVE      SP70,SAVSUNIT
          MOVE      SP70,SAVSECDC
          MOVE      SP70,HTMLLINK
.
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
DCARE100  CALL      RDKTRAN2
          BRANCH    OVRCD,DCARE200
.
          MATCH     ADMISSNO,DTADMN
          GOTO      DCARE200 IF NOT EQUAL
.
          IF        FOUNDFLG=0
            MOVE      TADOCT,SAVADOCT
            MOVE      TDEPT,SAVAUNIT
            MOVE      ONE,FOUNDFLG
            GOTO      DCARE150
          ENDIF
.
          MATCH     TADOCT,SAVADOCT
          GOTO      DCARE150 IF NOT EQUAL
.
          MATCH     TDEPT,SAVAUNIT
          GOTO      DCARE150 IF NOT EQUAL
          GOTO      DCARE100
.
DCARE150  PACK      KEY24,ADMISSNO,TDATE,TTIME,SP70
          CALL      RDPMDTC1
          IF        OVRCD = 1
            CALL      CLRPMDTC
.         ELSE
.           GOTO      DCARE100
          ENDIF
.
          PACK      KEY24,ADMISSNO,TDATE,TTIME,Z70
          CALL      RSPMDTC1
          CALL      RPPMDTC1
          IF        OVRCD=1
            CALL      CLRPMDTC
            GOTO      DCARE160
          ENDIF
.
          MATCH     ADMISSNO,PMDTVISN
          IF        !@EQUAL
            CALL      CLRPMDTC
            GOTO      DCARE160
          ENDIF
.
          MATCH     PMDTSDAT,TDATE
          GOTO      DCARE160 IF LESS
.
          MATCH     PMDTSTIM,TTIME
          GOTO      DCARE160 IF LESS
.
          MATCH     TDATE,PMDTEDAT
          GOTO      DCARE160 IF LESS
.
          MATCH     TTIME,PMDTSTIM
          GOTO      DCARE160 IF LESS
          CALL      CLRPMDTC
.
DCARE160  PACK      PMDTSDAT,SP70
          PACK      PMDTSTIM,SP70
          PACK      PMDTEDAT,SP70
          PACK      PMDTETIM,SP70
          PACK      PMDTDOCT,SP70
          PACK      PMDTUNIT,SP70
          CALL      DROW0000
          MOVE      TADOCT,SAVADOCT
          MOVE      TDEPT,SAVAUNIT
          GOTO      DCARE100
.
DCARE200  MOVE      ZERO,FOUNDFLG
          MOVE      ONE,EDITFLAG
          MOVE      SP70,SAVADOCT
          MOVE      SP70,SAVAUNIT
          MOVE      SP70,SAVSDOCT
          MOVE      SP70,SAVSUNIT
          MOVE      SP70,SAVSECDC
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMDTC1
DCARE250  CALL      RKPMDTC1
          BRANCH    OVRCD,DCARE999
.
          MATCH     ADMISSNO,PMDTVISN
          GOTO      DCARE999 IF NOT EQUAL
.
          IF        FOUNDFLG=0
            MOVE      PMDTDOCT,SAVSDOCT
            MOVE      PMDTUNIT,SAVSUNIT
            MOVE      ONE,FOUNDFLG
            GOTO      DCARE300
          ENDIF
.
.         MATCH     PMDTDOCT,SAVSDOCT
.         GOTO      DCARE300 IF NOT EQUAL
.
.         MATCH     PMDTUNIT,SAVSUNIT
.         GOTO      DCARE250 IF EQUAL
.         GOTO      DCARE300
.
DCARE300  PACK      KEY30,ADMISSNO,PMDTSDAT,PMDTSTIM,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          MATCH     ADMISSNO,DTADMN
          GOTO      DCARE350 IF NOT EQUAL
          MATCH     PMDTSDAT,TDATE
          GOTO      DCARE350 IF NOT EQUAL
          MATCH     PMDTSTIM,TTIME
          GOTO      DCARE360 IF EQUAL
.
DCARE350  PACK      TDATE,SP70
          PACK      TTIME,SP70
.
          IF         ASTAT= 1
            MOVE      ADOCTA,TADOCT
            MOVE      ACLSSFT,TDEPT
          ENDIF
.
DCARE360  MOVE      PMDTDOCT,SAVSDOCT
          MOVE      PMDTUNIT,SAVSUNIT
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    PMDTVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMDTSDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMDTSTIM,HTMLLINK
          APPEND    "')",HTMLLINK
.
          CALL      DROW0000
          GOTO      DCARE250
.
.
DCARE999  RETURN
+
.------------------------------------------------------------
. Output doctor care row
.------------------------------------------------------------
DROW0000  MOVE      SP70,DOCFNAME
          MOVE      SP70,ADOCNAME
          MOVE      TADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      ADOCNAME,DOCFNAME
          ENDIF
.
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITDES2
          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TDESC,UNITDESC        * Attending Unit
            MOVE      TDESC,UNITDES2
          ENDIF
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,PMDTDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      SP70,UNITDES2          * Shared Care Unit
          ENDIF
.
          MATCH     SP70,PMDTUNIT
          IF        !@EQUAL
            MOVE      SP70,UNITDES2          * Shared Care Unit
            PACK      KEY5,ANSA,ANSC,PMDTUNIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,UNITDES2
            ENDIF
          ENDIF
.
          MOVE      "Attending",DOCTTYPE
          MATCH     SP70,PMDTDOCT
          GOTO      DROW1000 IF EQUAL
.
          MATCH     SP70,SAVSECDC
          IF        @EQUAL
            MOVE      DTADMN,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     PMDTDOCT,PMVXEDC1
              IF        @EQUAL
                MOVE      "Secondary",DOCTTYPE
                MOVE      PMDTDOCT,SAVSECDC
              ELSE
                MOVE      "Additional",DOCTTYPE
              ENDIF
            ENDIF
          ELSE
            MOVE      "Additional",DOCTTYPE
          ENDIF
.
DROW1000  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",TDATE,TTIME,"#",":            * 1
                             "#"",ADOCNAME,"#",":               * 2
                             "#"",UNITDESC,"#",":               * 3
                             "#"",DOCFNAME,"#",":               * 4
                             "#"",TDESC,"#",":                  * 5
                             "#"",EDITFLAG,"#",":               * 6
                             "#"",PMDTSDAT,PMDTSTIM,"#",":      * 7
                             "#"",PMDTEDAT,PMDTETIM,"#",";      * 8
          MATCH     SP70,TDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",PMDTSDAT,PMDTSTIM,"#","     * 9
          ELSE
            WRITE     HTMLFILE;"#"",TDATE,TTIME,"#","           * 9
          ENDIF
.
          MATCH     SP70,PMDTDOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",ADOCNAME,"#","              * 10
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAME,"#","              * 10
          ENDIF
.
          PACK      USRCRTDT,SP70
          MATCH     SP70,PMDTDOCT
          IF        @EQUAL
            UNPACK    PTTRCDAT,CCENT,CYEAR,CMON,CDAY
          ELSE
            UNPACK    PMDTCDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM20,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,PMDTDOCT
          IF        @EQUAL
            PACK      KEY10,PTTRUCID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              PACK      USRCRTDT,WBSENAM,SP1,DIM20,SP1,AT,SP1,PTTRCTIM
            ELSE
              PACK      USRCRTDT,PTTRUCID,SP1,DIM20,SP1,AT,SP1,PTTRCTIM
            ENDIF
          ELSE
            PACK      KEY10,PMDTCUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              PACK      USRCRTDT,WBSENAM,SP1,DIM20,SP1,AT,SP1,PMDTCTIM
            ELSE
              PACK      USRCRTDT,PMDTCUID,SP1,DIM20,SP1,AT,SP1,PMDTCTIM
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#"",DOCTTYPE,"#",":               * 11
                             "#"",USRCRTDT,"#",":               * 12
                             "#"",UNITDES2,"#")"                * 13
.
          MOVE      ONE,FOUNDFLG
.
DROW9999  RETURN
+
.------------------------------------------------------------
. Patient Problems
.------------------------------------------------------------
PMSPRB00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PMSPRB95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CLPRTEXT                * Clear Problem Variables
          MATCH     SP70,UPDTTYPE           * Dislay
          GOTO      PMSPRB50 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      PMSPRB10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      PMSPRB20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      PMSPRB30 IF EQUAL
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      PMSPRB99
.
PMSPRB10  CALL      ADDPRB00
          GOTO      PMSPRB99
.
PMSPRB20  CALL      UPDPRB00
          GOTO      PMSPRB99
.
PMSPRB30  CALL      DELPRB00
          GOTO      PMSPRB99
.
PMSPRB50  PACK      KEY13,URNUMBER,PROBLEMN
          CALL      RDPMPRB1
          IF        OVRCD=1
            CALL      CLPRTEXT
          ELSE
            MOVE      "V",AUDITTYP
            MOVE      SP70,PMAPACCD
            MOVE      SP70,PMAPCOMM
            CALL      WRTAUD00      * Write Audit Record
          ENDIF
.
          MOVE      "Patient Problems",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PMSPRB99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PMSPRB99
.
PMSPRB95  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
PMSPRB99  RETURN
+
.------------------------------------------------------------
. Clear Problem Variables
.------------------------------------------------------------
CLPRTEXT
          MOVE      SP70,PMPBURNO
          MOVE      SP70,PMPBPNUM
          MOVE      SP70,PMPBSPIN
          MOVE      SP70,PMPBPPNO
          MOVE      SP70,PMPBPRID
          MOVE      SP70,PMPBPRTY
          MOVE      SP70,PMPBACTV
          MOVE      SP70,PMPBPRST
          MOVE      SP70,PMPBDSC1
          MOVE      SP70,PMPBDSC2
          MOVE      SP70,PMPBDCSY
          MOVE      SP70,PMPBDCOD
          MOVE      SP70,PMPBESDT
          MOVE      SP70,PMPBESTI
          MOVE      SP70,PMPBESBY
          MOVE      SP70,PMPBERDT
          MOVE      SP70,PMPBERTI
          MOVE      SP70,PMPBARDT
          MOVE      SP70,PMPBARTI
          MOVE      SP70,PMPBRVST
          MOVE      SP70,PMPBNRDT
          MOVE      SP70,PMPBNRTI
          MOVE      SP70,PMPBUDC1
          MOVE      SP70,PMPBUDC2
          MOVE      SP70,PMPBUDY1
          MOVE      SP70,PMPBUDY2
          MOVE      SP70,PMPBUDD1
          MOVE      SP70,PMPBUDD2
          MOVE      SP70,PMPBUDT1
          MOVE      SP70,PMPBUDT2
          MOVE      SP70,PMPBLVIS
          MOVE      SP70,PMPBSPAR
          RETURN
+
.------------------------------------------------------------
. Clear Audit Variables
.------------------------------------------------------------
CLAUTEXT  MOVE      SP70,PMAPURNO
          MOVE      SP70,PMAPPNUM
          MOVE      SP70,PMAPWUID
          MOVE      SP70,PMAPDATE
          MOVE      SP70,PMAPTIME
          MOVE      SP70,PMAPACTY
          MOVE      SP70,PMAPACCD
          MOVE      SP70,PMAPCOMM
          RETURN
.------------------------------------------------------------
. Problem Details
.------------------------------------------------------------
EXTD0000  BRANCH    FLDITMNO,EXTD0010,EXTD0020,EXTD0030,EXTD0040,EXTD0050:
                             EXTD0060,EXTD0070,EXTD0080,EXTD0090,EXTD0100:
                             EXTD0110,EXTD0120,EXTD0130,EXTD0140,EXTD0150:
                             EXTD0160,EXTD0170,EXTD0180,EXTD0190,EXTD0200:
                             EXTD0210,EXTD0220,EXTD0230,EXTD0240,EXTD0250:
                             EXTD0260,EXTD0270,EXTD0280,EXTD0290,EXTD0300:
                             EXTD0310,EXTD0320,EXTD0330,EXTD0340,EXTD0350:
                             EXTD0360,EXTD0370
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      EXTD9999
.
EXTD0010  WRITE     HTMLFILE;PMPBURNO;
          GOTO      EXTD9999
.
EXTD0020  WRITE     HTMLFILE;PMPBPNUM;
          GOTO      EXTD9999
.
EXTD0030  WRITE     HTMLFILE;PMPBSPIN;
          GOTO      EXTD9999
.
EXTD0040  WRITE     HTMLFILE;PMPBPPNO;
          GOTO      EXTD9999
.
EXTD0050  MOVE      "ww",CATEGORY
          MOVE      PMPBPRID,CODE
          CALL      CODITM00
          GOTO      EXTD9999
.
EXTD0060  MOVE      "wy",CATEGORY
          MOVE      PMPBPRTY,CODE
          CALL      CODITM00
          GOTO      EXTD9999
.
EXTD0070  WRITE     HTMLFILE;PMPBACTV;
          GOTO      EXTD9999
.
EXTD0080  MOVE      "wx",CATEGORY
          MOVE      PMPBPRST,CODE
          CALL      CODITM00
          GOTO      EXTD9999
.
EXTD0090  WRITE     HTMLFILE;PMPBDSC1;
          GOTO      EXTD9999
.
EXTD0100  WRITE     HTMLFILE;PMPBDSC2;
          GOTO      EXTD9999
.
EXTD0110  WRITE     HTMLFILE;PMPBDCSY;
          GOTO      EXTD9999
.
EXTD0120  WRITE     HTMLFILE;PMPBDCOD;
          GOTO      EXTD9999
.
EXTD0130  MATCH     SP70,PMPBESDT
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBESDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0140  WRITE     HTMLFILE;PMPBESTI;
          GOTO      EXTD9999
.
EXTD0150  WRITE     HTMLFILE;PMPBESBY;
          GOTO      EXTD9999
.
EXTD0160  MATCH     SP70,PMPBERDT
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBERDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0170  WRITE     HTMLFILE;PMPBERTI;
          GOTO      EXTD9999
.
EXTD0180  MATCH     SP70,PMPBARDT
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBARDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0190  WRITE     HTMLFILE;PMPBARTI;
          GOTO      EXTD9999
.
EXTD0200  MOVE      "wz",CATEGORY
          MOVE      PMPBRVST,CODE
          CALL      CODITM00
          GOTO      EXTD9999
.
EXTD0210  MATCH     SP70,PMPBNRDT
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBNRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0220  WRITE     HTMLFILE;PMPBNRTI;
          GOTO      EXTD9999
.
EXTD0230  WRITE     HTMLFILE;PMPBUDC1;
          GOTO      EXTD9999
.
EXTD0240  WRITE     HTMLFILE;PMPBUDC2;
          GOTO      EXTD9999
.
EXTD0250  WRITE     HTMLFILE;PMPBUDY1;
          GOTO      EXTD9999
.
EXTD0260  WRITE     HTMLFILE;PMPBUDY2;
          GOTO      EXTD9999
.
EXTD0270  MATCH     SP70,PMPBUDD1
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBUDD1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0280  MATCH     SP70,PMPBUDD2
          GOTO      EXTD9999 IF EQUAL
.
          UNPACK    PMPBUDD2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      EXTD9999
.
EXTD0290  WRITE     HTMLFILE;PMPBUDT1;
          GOTO      EXTD9999
.
EXTD0300  WRITE     HTMLFILE;PMPBUDT2;
          GOTO      EXTD9999
.
EXTD0310  CALL      PROLST00                * Problem List
          GOTO      EXTD9999
.
EXTD0320  CALL      PROAUD00                * Audit List
          GOTO      EXTD9999
.
EXTD0330  MATCH     "0", PMPBACTV
          IF        @EQUAL
            WRITE     HTMLFILE;DNO;
          ELSE
            WRITE     HTMLFILE;DYES;
          ENDIF
          GOTO      EXTD9999
.
EXTD0340  CALL      NEXTAD00
          GOTO      EXTD9999
.
EXTD0350  WRITE     HTMLFILE;AUDITKEY;
          GOTO      EXTD9999
.
EXTD0360  WRITE     HTMLFILE;PMPBLVIS;
          GOTO      EXTD9999
.
EXTD0370  IF        FHIRBUND=0
            CALL      RESCND00                * FHIR Condition Resource
          ELSE
            PACK      FHRCONID,PMPBURNO,PMPBPNUM,SP70
            REP       " -",FHRCONID
            WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Condition/PRB-",FHRCONID,"#", ":
                                  " #"resource#" : ";
            CALL      RESCND00                * FHIR Condition Resource
            WRITE     HTMLFILE;*+,"}"
.
            IF        FHRSUBIN=1
.
              PACK      FHRPATID,URNUMBER
              SQUEEZE   FHRPATID
.
              WRITE     HTMLFILE;*+,",{":
                                    " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                      " #"resource#": ";
              CALL      RESPAT00
.
              WRITE     HTMLFILE;*+,"}"
            ENDIF
.
            IF       FHRPARIN=1
.
              MATCH     SP70,PMPBESBY
              IF        !@EQUAL & !@EOS
.
                PACK      KEY10,PMPBESBY,SP70
                CALL      RDWBSE1
                IF        OVRCD=0
.UPTOHERE
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",PMPBESBY,"#", ":
                            " #"resource#" : ";
                  CALL     RESPRA00         * FHIR Resource Practitioner Recorder
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          GOTO      EXTD9999
.
EXTD9999  RETURN
+
.------------------------------------------------------------
. Add Problem
.------------------------------------------------------------
ADDPRB00  MOVE      ZERO,FORM5
          PACK      KEY13,URNUMBER,Z70
          CALL      RSPMPRB1
          CALL      RPPMPRB1
          BRANCH    OVRCD,ADDPRB50
.
          MATCH     PMPBURNO,URNUMBER
          GOTO      ADDPRB50 IF NOT EQUAL
.
          MOVE      PMPBPNUM,FORM5
.
ADDPRB50  CALL      CLPRTEXT
          MATCH     Z70,PMSPB013
          GOTO      ADDPRB55 IF EQUAL
          CALL      MVPRB000
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
.
          IF        FHIRTYPE=1
            MATCH     "A",UPDTTYPE
            IF        @EQUAL
              MOVE      KEY13,DIM13
              REP       " -",DIM13
              CLEAR     FHIRLOCH
              APPEND    "Condition/",FHIRLOCH
              APPEND    DIM13,FHIRLOCH
              RESET     FHIRLOCH
              STRIP     FHIRLOCH
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ADDPRB99
.
ADDPRB55  
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MATCH     Z70,PRBDAT01                   *Historical Problem 1
          GOTO      ADDPRB60 IF EQUAL
          MATCH     SP70,PRBDAT01
          GOTO      ADDPRB60 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MOVE      PRBDAT01,PMPBESDT
          MOVE      PRBTIM01,PMPBESTI
          MOVE      PRBTYP01,PMPBPRTY
          MOVE      PRBCOD01,PMPBDCOD
          MOVE      PRBSTA01,PMPBPRST
          MOVE      PRBDES01,PMPBDSC1
          MOVE      PRBDES07,PMPBDSC2
          MOVE      PRBACT01,PMPBACTV
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB60  MATCH     Z70,PRBDAT02
          GOTO      ADDPRB65 IF EQUAL 
          MATCH     SP70,PRBDAT02                    *Historical Problem 2
          GOTO      ADDPRB65 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MOVE      PRBDAT02,PMPBESDT
          MOVE      PRBTIM02,PMPBESTI
          MOVE      PRBTYP02,PMPBPRTY
          MOVE      PRBCOD02,PMPBDCOD
          MOVE      PRBDES02,PMPBDSC1
          MOVE      PRBDES08,PMPBDSC2
          MOVE      PRBSTA02,PMPBPRST
	  MOVE      PRBACT02,PMPBACTV
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB65  MATCH     SP70,PRBDAT03                     *Historical Problem 3
          GOTO      ADDPRB70 IF EQUAL
          MATCH     Z70,PRBDAT03
          GOTO      ADDPRB70 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
          MOVE      PRBDAT03,PMPBESDT
          MOVE      PRBTIM03,PMPBESTI
          MOVE      PRBTYP03,PMPBPRTY
          MOVE      PRBCOD03,PMPBDCOD
          MOVE      PRBDES03,PMPBDSC1
          MOVE      PRBDES09,PMPBDSC2
          MOVE      PRBSTA03,PMPBPRST
	  MOVE      PRBACT03,PMPBACTV
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB70  MATCH     SP70,PRBDAT04                    *Historical Problem 4
          GOTO      ADDPRB75 IF EQUAL
          MATCH     Z70,PRBDAT04
          GOTO      ADDPRB75 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MOVE      PRBDAT04,PMPBESDT
          MOVE      PRBTIM04,PMPBESTI
          MOVE      PRBTYP04,PMPBPRTY
          MOVE      PRBCOD04,PMPBDCOD
          MOVE      PRBDES04,PMPBDSC1
          MOVE      PRBDES10,PMPBDSC2
          MOVE      PRBSTA04,PMPBPRST
	  MOVE      PRBACT04,PMPBACTV
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB75  MATCH     SP70,PRBDAT05                   *Historical Problem 5
          GOTO      ADDPRB80 IF EQUAL
          MATCH     Z70,PRBDAT05
          GOTO      ADDPRB80 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MOVE      PRBDAT05,PMPBESDT
          MOVE      PRBTIM05,PMPBESTI
          MOVE      PRBTYP05,PMPBPRTY
          MOVE      PRBCOD05,PMPBDCOD
          MOVE      PRBDES05,PMPBDSC1
          MOVE      PRBDES11,PMPBDSC2
          MOVE      PRBSTA05,PMPBPRST
	  MOVE      PRBACT05,PMPBACTV
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB80  MATCH     SP70,PRBDAT06                   *Historical Problem 6
          GOTO      ADDPRB99 IF EQUAL
          MATCH     Z70,PRBDAT06
          GOTO      ADDPRB99 IF EQUAL
          CALL      CLPRTEXT
          MOVE      URNUMBER,PMPBURNO
          ADD       ONE,FORM5
          MOVE      FORM5,PMPBPNUM
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE      PMSPB015,PMPBESBY
          ENDIF
.
          MOVE      PRBDAT06,PMPBESDT
          MOVE      PRBTIM06,PMPBESTI
          MOVE      PRBTYP06,PMPBPRTY
          MOVE      PRBCOD06,PMPBDCOD
          MOVE      PRBDES06,PMPBDSC1
          MOVE      PRBDES12,PMPBDSC2
          MOVE      PRBSTA06,PMPBPRST
	  MOVE      PRBACT06,PMPBACTV
          PACK      KEY13,PMPBURNO,PMPBPNUM
          CALL      WRPMPRB1
.
          MOVE      PMPBURNO,URNUMBER
          MOVE      PMPBPNUM,PROBLEMN
          MOVE      "A",AUDITTYP
          CALL      WRTAUD00
          MOVE      ZERO,EXIT
.
ADDPRB99  RETURN
.---------------------------------------------------------------
. ********************* Set Redirect String ******************
.  INPUTS: URNUMBER  - Urnumber No
.          PROBLEMN  - Problem Number
.          REPTNO    - Report No
.          TEMPLATE  - Template No
.          SERVER    - Server
.          NEXTPAGE  - Nextpage
.---------------------------------------------------------------
STRDIR00  REP       " +",URNUMBER
          REP       " +",PROBLEMN
.
          CLEAR     REDIRECT
          APPEND    SERVER,REDIRECT
          APPEND    "&reportno=",REDIRECT
          APPEND    REPTNO,REDIRECT
          APPEND    "&template=",REDIRECT
          APPEND    TEMPLATE,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&problemn=",REDIRECT
          APPEND    PROBLEMN,REDIRECT
          RESET     REDIRECT
.
          REP       "+ ",URNUMBER
          REP       "+ ",PROBLEMN
.
STRDIR99  RETURN
+
.------------------------------------------------------------
. Delete Problem
.------------------------------------------------------------
DELPRB00  PACK      KEY13,URNUMBER,PROBLEMN
          CALL      RAPMPRB1
          IF        OVRCD=0
            CALL      DEPMPRB1
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Problem Not On File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
.
DELEPRB9  RETURN
+
.------------------------------------------------------------
. Update Problem
.------------------------------------------------------------
UPDPRB00  CALL      CLPRTEXT
          PACK      KEY13,URNUMBER,PROBLEMN
          CALL      RDPMPRB1
          IF        OVRCD=0
            CALL      MVPRB000
            CALL      UPPMPRB1
            MOVE      "U",AUDITTYP
            CALL      WRTAUD00
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Problem Not On File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
UPDPRB99  RETURN
+
.------------------------------------------------------------
. Problem Lisiting
.------------------------------------------------------------
PROLST00  MOVE      ZERO,RECNUMB
          PACK      KEY13,URNUMBER,SP30
          CALL      RSPMPRB1
PROLST10  CALL      RKPMPRB1
          BRANCH    OVRCD,PROLST99
.
          MATCH     URNUMBER,PMPBURNO
          GOTO      PROLST99 IF NOT EQUAL
.
          MATCH     "1",PMPBACTV
          IF        @EQUAL
            MOVE      "INACTIVE",ACTIDESC
          ELSE
            MOVE      "ACTIVE",ACTIDESC
          ENDIF
.
          MOVE      "wy",CATEGORY
          MOVE      PMPBPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRTYDESC
.
          MOVE      "ww",CATEGORY
          MOVE      PMPBPRID,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIDDESC
.
          MOVE      "wx",CATEGORY
          MOVE      PMPBPRST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRSTDESC
.
          MOVE      "wz",CATEGORY
          MOVE      PMPBRVST,CODE
          CALL      GETCOD00
          MOVE      TDESC,RVSTDESC
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateItem('",HTMLLINK
          APPEND    PMPBURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPBPNUM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY10,PMPBESBY,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",PMPBESDT,PMPBESTI,"#",":
                               "#"",PMPBDSC1,SP1,PMPBDSC2,"#",":
                               "#"",PMPBDSC2,"#",":
                               "#"",ACTIDESC,"#",":
                               "#"",PRTYDESC,"#",":
                               "#"",PRIDDESC,"#",":
                               "#"",PRSTDESC,"#",":
                               "#"",PMPBNRDT,"#",":
                               "#"",RVSTDESC,"#",":
                               "#"",PMPBERDT,PMPBERTI,"#",":
                               "#"",PMPBARDT,PMPBARTI,"#",":
                               "#"",PMPBNRDT,PMPBNRTI,"#",":
                               "#"",WBSENAM,"#");"
          ELSE
            CALL      FHRCND00
          ENDIF
          GOTO      PROLST10
.
PROLST99  RETURN
+
.------------------------------------------------------------
. Output FHIR Condition (Problem) List
.------------------------------------------------------------
FHRCND00  PACK      FHRCONID,PMPBURNO,PMPBPNUM,SP70
          REP       " -",FHRCONID
          IF        RECNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          ADD       ONE,RECNUMB
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Condition/PRB-",FHRCONID,"#", ":
                                " #"resource#" : ";
          CALL      RESCND00
          WRITE     HTMLFILE;*+,"}"
.
          IF        FHRSUBIN=1
.
            PACK      FHRPATID,URNUMBER
            SQUEEZE   FHRPATID
.
            WRITE     HTMLFILE;*+,",{":
                                  " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
.
            CALL      RESPAT00
.
            WRITE     HTMLFILE;*+,"}"
          ENDIF
.
          IF       FHRPARIN=1
.
            MATCH     SP70,PMPBESBY
            IF        !@EQUAL & !@EOS
.
              PACK      KEY10,PMPBESBY,SP70
              CALL      RDWBSE1
              IF        OVRCD=0
.UPTOHERE
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",PMPBESBY,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner Recorder
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
FHRCND99  RETURN
+
.------------------------------------------------------------
. Problem Audit Lisiting
.------------------------------------------------------------
PROAUD00  IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY36,URNUMBER,PROBLEMN,Z70
          CALL      RSPMAUP1
PROAUD10  CALL      RPPMAUP1
          BRANCH    OVRCD,PROAUD99
          MATCH     URNUMBER,PMAPURNO
          GOTO      PROAUD99 IF NOT EQUAL
          MATCH     PROBLEMN,PMAPPNUM
          GOTO      PROAUD99 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO     PROAUD10
          ENDIF
.
          CALL      PROALN00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PROAUD10 IF NOT EQUAL
PROAUD99  RETURN
.------------------------------------------------------------
. Problem Audit Lisiting Rows (TABLE ROW)
.------------------------------------------------------------
PROALN00  MATCH     "U",PMAPACTY
          IF         @EQUAL
            MOVE       "Update",ACTIDESC
          ENDIF
          MATCH     "A",PMAPACTY
          IF         @EQUAL
            MOVE       "Add",ACTIDESC
          ENDIF
          MATCH     "V",PMAPACTY
          IF         @EQUAL
            MOVE       "View",ACTIDESC
          ENDIF
          MATCH     "M",PMAPACTY
          IF         @EQUAL
            MOVE       "Action",ACTIDESC
          ENDIF
.
          PACK      KEY10,PMAPWUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
          UNPACK    PMAPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "w3",CATEGORY
          MOVE      PMAPACCD,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"<tr><td>",WBSENAM,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                  " at ",PMAPTIME,"</td>":
                             "<td>",ACTIDESC,"</td>":
                             "<td>",TDESC,"&nbsp;</td>":
                             "<td>",PMAPCOMM,"&nbsp;</td>":
                             "</tr>"
.
PROALN99  RETURN
+
.-----------------------------------------------------------
. Link to Next page of audit
.-----------------------------------------------------------
NEXTAD00  ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REPLACE   " +",URNUMBER
          REPLACE   " +",PROBLEMN
          REPLACE   " +",ADMISSNO
.
          WRITE     HTMLFILE;"patweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&problemn=",PROBLEMN;
.
          REPLACE   "+ ",URNUMBER
          REPLACE   "+ ",PROBLEMN
          REPLACE   "+ ",ADMISSNO
.
NEXTAD99  RETURN
.---------------------------------------------------------------------
. Move in Problem Details
.------------------------------------------------------------
MVPRB000  MATCH     Z70,PMSPB001
          IF        !@EQUAL
            MOVE       PMSPB001,PMPBURNO
          ENDIF
.
          MATCH     Z70,PMSPB002
          IF        !@EQUAL
            MOVE       PMSPB002,PMPBPNUM
          ENDIF
.
          MATCH     Z70,PMSPB003
          IF        !@EQUAL
            MOVE       PMSPB003,PMPBSPIN
          ENDIF
.
          MATCH     Z70,PMSPB004
          IF        !@EQUAL
            MOVE       PMSPB004,PMPBPPNO
          ENDIF
.
          MATCH     Z70,PMSPB005
          IF        !@EQUAL
            MOVE       PMSPB005,PMPBPRID
          ENDIF
.
          MATCH     Z70,PMSPB006
          IF        !@EQUAL
            MOVE       PMSPB006,PMPBPRTY
          ENDIF
.
          MOVE       PMSPB007,PMPBACTV      * Active Indicator 0 or 1
.
          MATCH     Z70,PMSPB008
          IF        !@EQUAL
            MOVE       PMSPB008,PMPBPRST
          ENDIF
.
          MATCH     Z70,PMSPB009
          IF        !@EQUAL
            MOVE       PMSPB009,PMPBDSC1
          ENDIF
.
          MATCH     Z70,PMSPB010
          IF        !@EQUAL
            MOVE       PMSPB010,PMPBDSC2
          ENDIF
.
          MATCH     Z70,PMSPB011
          IF        !@EQUAL
            MOVE       PMSPB011,PMPBDCSY
          ENDIF
.
          MATCH     Z70,PMSPB012
          IF        !@EQUAL
            MOVE       PMSPB012,PMPBDCOD
          ENDIF
.
          MATCH     Z70,PMSPB013
          IF        !@EQUAL
            MOVE       PMSPB013,PMPBESDT
          ENDIF
.
          MATCH     Z70,PMSPB014
          IF        !@EQUAL
            MOVE       PMSPB014,PMPBESTI
          ENDIF
.
          MATCH     Z70,PMSPB015
          IF        !@EQUAL
            MOVE       PMSPB015,PMPBESBY
          ENDIF
.
          MATCH     Z70,PMSPB016
          IF        !@EQUAL
            MOVE       PMSPB016,PMPBERDT
          ENDIF
.
          MATCH     Z70,PMSPB017
          IF        !@EQUAL
            MOVE       PMSPB017,PMPBERTI
          ENDIF
.
          MATCH     Z70,PMSPB018
          IF        !@EQUAL
            MOVE       PMSPB018,PMPBARDT
          ENDIF
.
          MATCH     Z70,PMSPB019
          IF        !@EQUAL
            MOVE       PMSPB019,PMPBARTI
          ENDIF
.
          MATCH     Z70,PMSPB020
          IF        !@EQUAL
            MOVE       PMSPB020,PMPBRVST
          ENDIF
.
          MATCH     Z70,PMSPB021
          IF        !@EQUAL
            MOVE       PMSPB021,PMPBNRDT
          ENDIF
.
          MATCH     Z70,PMSPB022
          IF        !@EQUAL
            MOVE       PMSPB022,PMPBNRTI
          ENDIF
.
          MATCH     Z70,PMSPB023
          IF        !@EQUAL
            MOVE       PMSPB023,PMPBUDC1
          ENDIF
.
          MATCH     Z70,PMSPB024
          IF        !@EQUAL
            MOVE       PMSPB024,PMPBUDC2
          ENDIF
.
          MATCH     Z70,PMSPB025
          IF        !@EQUAL
            MOVE       PMSPB025,PMPBUDY1
          ENDIF
.
          MATCH     Z70,PMSPB026
          IF        !@EQUAL
            MOVE       PMSPB026,PMPBUDY2
          ENDIF
.
          MATCH     Z70,PMSPB027
          IF        !@EQUAL
            MOVE       PMSPB027,PMPBUDD1
          ENDIF
.
          MATCH     Z70,PMSPB028
          IF        !@EQUAL
            MOVE       PMSPB028,PMPBUDD2
          ENDIF
.
          MATCH     Z70,PMSPB029
          IF        !@EQUAL
            MOVE       PMSPB029,PMPBUDT1
          ENDIF
.
          MATCH     Z70,PMSPB030
          IF        !@EQUAL
            MOVE       PMSPB030,PMPBUDT2
          ENDIF
.
          MATCH     Z70,PMSPB031
          IF        !@EQUAL
            MOVE       PMSPB031,PMPBLVIS
          ENDIF
.
MVPRB999  RETURN
.------------------------------------------------------------
. Set up patient problem master variables from cgi
.------------------------------------------------------------
PMSPP000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,PMSPP001,PMSPP002,PMSPP003,PMSPP004,PMSPP005:
                       PMSPP006,PMSPP007,PMSPP008,PMSPP009,PMSPP010:
                       PMSPP011,PMSPP012,PMSPP013,PMSPP014,PMSPP015:
                       PMSPP016,PMSPP017,PMSPP018,PMSPP019,PMSPP020:
                       PMSPP021,PMSPP022,PMSPP023,PMSPP024,PMSPP025:
                       PMSPP026,PMSPP027,PMSPP028,PMSPP029,PMSPP030:
                       PMSPP031
          GOTO      PMSPP999
.
PMSPP001  MOVE      QRYDATA,PMSPB001
          GOTO      PMSPP9999
.
PMSPP002  MOVE      QRYDATA,PMSPB002
          GOTO      PMSPP9999
.
PMSPP003  MOVE      QRYDATA,PMSPB003
          GOTO      PMSPP9999
.
PMSPP004  MOVE      QRYDATA,PMSPB004
          GOTO      PMSPP9999
.
PMSPP005  MOVE      QRYDATA,PMSPB005
          GOTO      PMSPP9999
.
PMSPP006  MOVE      QRYDATA,PMSPB006
          GOTO      PMSPP9999
.
PMSPP007  MOVE      QRYDATA,PMSPB007
          GOTO      PMSPP9999
.
PMSPP008  MOVE      QRYDATA,PMSPB008
          GOTO      PMSPP9999
.
PMSPP009  MOVE      QRYDATA,PMSPB009
          GOTO      PMSPP9999
.
PMSPP010  MOVE      QRYDATA,PMSPB010
          GOTO      PMSPP9999
.
PMSPP011  MOVE      QRYDATA,PMSPB011
          GOTO      PMSPP9999
.
PMSPP012  MOVE      QRYDATA,PMSPB012
          GOTO      PMSPP9999
.
PMSPP013  MOVE      SP70,PMSPB013
          MATCH     SP70,QRYDATA
          GOTO      PMSPP999 IF EQUAL
          GOTO      PMSPP999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSPB013,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSPB013
          GOTO      PMSPP999
.
PMSPP014  MOVE      QRYDATA,PMSPB014
          GOTO      PMSPP9999
.
PMSPP015  MOVE      QRYDATA,PMSPB015
          GOTO      PMSPP9999
.
PMSPP016  MOVE      SP70,PMSPB016
          MATCH     SP70,QRYDATA
          GOTO      PMSPP999 IF EQUAL
          GOTO      PMSPP999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSPB016,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSPB016
          GOTO      PMSPP999
.
PMSPP017  MOVE      QRYDATA,PMSPB017
          GOTO      PMSPP9999
.
PMSPP018  MOVE      SP70,PMSPB018
          MATCH     SP70,QRYDATA
          GOTO      PMSPP999 IF EQUAL
          GOTO      PMSPP999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSPB018,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSPB018
          GOTO      PMSPP999
.
PMSPP019  MOVE      QRYDATA,PMSPB019
          GOTO      PMSPP9999
.
PMSPP020  MOVE      QRYDATA,PMSPB020
          GOTO      PMSPP9999
.
PMSPP021  MOVE      SP70,PMSPB021
          MATCH     SP70,QRYDATA
          GOTO      PMSPP999 IF EQUAL
          GOTO      PMSPP999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSPB021,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSPB021
          GOTO      PMSPP999
.
PMSPP022  MOVE      QRYDATA,PMSPB022
          GOTO      PMSPP9999
.
PMSPP023  MOVE      QRYDATA,PMSPB023
          GOTO      PMSPP9999
.
PMSPP024  MOVE      QRYDATA,PMSPB024
          GOTO      PMSPP9999
.
PMSPP025  MOVE      QRYDATA,PMSPB025
          GOTO      PMSPP9999
.
PMSPP026  MOVE      QRYDATA,PMSPB026
          GOTO      PMSPP9999
.
PMSPP027  MOVE      QRYDATA,PMSPB027
          GOTO      PMSPP9999
.
PMSPP028  MOVE      QRYDATA,PMSPB028
          GOTO      PMSPP9999
.
PMSPP029  MOVE      QRYDATA,PMSPB029
          GOTO      PMSPP9999
.
PMSPP030  MOVE      QRYDATA,PMSPB030
          GOTO      PMSPP9999
.
PMSPP031  MOVE      QRYDATA,PMSPB031
          GOTO      PMSPP9999
.
PMSPP999  RETURN
+
.------------------------------------------------------------
. Set up Advanced care plan audit variables from cgi
.------------------------------------------------------------
PMDAU000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,PMDAU001,PMDAU002,PMDAU003,PMDAU004,PMDAU005,PMDAU006
          GOTO      PMDAU999
.
PMDAU001  MOVE      QRYDATA,PMDAU001
          GOTO      PMDAU999
.
PMDAU002  MATCH     SP70,QRYDATA
          GOTO      PMDAU999 IF EQUAL
          GOTO      PMDAU999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMDAU002,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMDAU002
          GOTO      PMDAU999
.
PMDAU003  MOVE      QRYDATA,PMDAU003
          GOTO      PMDAU999
.
PMDAU004  MOVE      QRYDATA,PMDAU004
          GOTO      PMDAU999
.
PMDAU005  MOVE      QRYDATA,PMDAU005
          GOTO      PMDAU999
.
PMDAU006  MOVE      QRYDATA,PMDAU002
          GOTO      PMDAU999
.
PMDAU999  RETURN
+
.------------------------------------------------------------
. Set up doctor care list variables from cgi
.------------------------------------------------------------
SETDC000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETDC001,SETDC002,SETDC003,SETDC004,SETDC005:
                       SETDC006,SETDC007,SETDC008
          GOTO      SETDC999
.
SETDC001  MOVE      QRYDATA,PMDTC001
          GOTO      SETDC999
.
SETDC002  MOVE      QRYDATA,PMDTC002
          GOTO      SETDC999
.
SETDC003  MOVE      QRYDATA,PMDTC003
          GOTO      SETDC999
.
SETDC004  MOVE      SP70,PMDTC004
.
          MATCH     SP70,QRYDATA
          GOTO      SETDC999 IF EQUAL
          GOTO      SETDC999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMDTC004,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMDTC004
          GOTO      SETDC999
.
SETDC005  MOVE      QRYDATA,PMDTC005
          GOTO      SETDC999
.
SETDC006  MOVE      SP70,PMDTC006
.
          MATCH     SP70,QRYDATA
          GOTO      SETDC999 IF EQUAL
          GOTO      SETDC999 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMDTC006,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMDTC006
          GOTO      SETDC999
.
SETDC007  MOVE      QRYDATA,PMDTC007
          GOTO      SETDC999
.
SETDC008  MOVE      QRYDATA,PMDTC008
          GOTO      SETDC999
.
SETDC999  RETURN
+
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PPRDIR00      * Redirect parent.Parent
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPAR00      * Redirect parent.Parent
          GOTO      NXTPAG99
.
NXTPAG70  CALL      FHREXT00      * Redirect parent.Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
PRTEST    WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                          "  redirectParentFrame(#"",REDIRECT,"#");":
                             "} else {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
+
.*****************************************************************************
.*        Close Window or Frame and Goto New Location                         *
.******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
          CALL      CLOSHTML
.
WINPAR99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PPRDIR00  CALL      OPENHTML
          BRANCH    EXIT,PPRDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name.match(/PopUpFrame/)) {":
                          "  redirectParentParentFrame(#"",REDIRECT,"#");":
                             "} else {":
                             " parent.parent.location.href=#"",REDIRECT,"#";":
                             "}}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PPRDIR99
.
PPRDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PPRDIR99  RETURN
+
.---------------------------------------------------------------------
. Write Audit user, date and time
.---------------------------------------------------------------------
WRTAUD00  CALL      IBACLOCK
          PACK      PMAPDATE,CCC,CYY,CMM,CDD
          REP       " 0",PMAPDATE
          MOVE      USERID,PMAPWUID
          CLOCK     TIME,PMAPTIME
          MOVE      URNUMBER,PMAPURNO
          MOVE      PROBLEMN,PMAPPNUM
          MOVE      AUDITTYP,PMAPACTY
          PACK      KEY36,PMAPURNO,PMAPPNUM,PMAPDATE,PMAPTIME,PMAPWUID
          MOVE      KEY36,AUDITKEY
          CALL      RDPMAUP1
          IF        OVRCD=1
            CALL      WRPMAUP1
          ENDIF
.
          RETURN
.------------------------------------------------------------
. List of Patients by Problem
.------------------------------------------------------------
PRBLST00  CALL      IBACLOCK
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Problem Patient List by Date",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PRBLST99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
.
PRBLST99  RETURN
.------------------------------------------------------------
. Problem List Details
.------------------------------------------------------------
LSTPB000  BRANCH    FLDITMNO,LSTPB010,LSTPB020,LSTPB030,LSTPB040,LSTPB050:
                             LSTPB060,LSTPB070,LSTPB080,LSTPB090,LSTPB100:
                             LSTPB110,LSTPB120,LSTPB130
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      LSTPB999
.
LSTPB010  CALL      NEXT0000
          GOTO      LSTPB999
.
LSTPB020  CALL      PREV0000
          GOTO      LSTPB999
.
LSTPB030  CALL      CURSTD00
          GOTO      LSTPB999
.
LSTPB040  CALL      CUREND00
          GOTO      LSTPB999
.
LSTPB050  CALL      CURYR000
          GOTO      LSTPB999
.
LSTPB060  CALL      CURMON00
          GOTO      LSTPB999
.
LSTPB070  CALL      SELV0000
          GOTO      LSTPB999
.
LSTPB080  MOVE      "ww",CATEGORY
          MOVE      FLTPB005,CODE
          CALL      CODITM00
          GOTO      LSTPB999
.
LSTPB090  MOVE      "wx",CATEGORY
          MOVE      FLTPB008,CODE
          CALL      CODITM00
          GOTO      LSTPB999
.
LSTPB100  MOVE      "wy",CATEGORY
          MOVE      FLTPB006,CODE
          CALL      CODITM00
          GOTO      LSTPB999
.
LSTPB110  MOVE      "wz",CATEGORY
          MOVE      FLTPB020,CODE
          CALL      CODITM00
          GOTO      LSTPB999
.
LSTPB120  CALL      PPLDT0000               * Problem Patient List by date
          GOTO      LSTPB999
.
LSTPB130  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      LSTPB999
.
LSTPB999  RETURN
.------------------------------------------------------------
. Problem Patient List by Date
.------------------------------------------------------------
PPLDT000  PACK      KEY21,FRSTDATE,SP70
          CALL      RSPMPRB2
PPLDT010  CALL      RKPMPRB2
          BRANCH    OVRCD,PPLDT999
          MATCH     "1",PMPBACTV
          GOTO      PPLDT010 IF EQUAL
          MATCH     PMPBNRDT,LASTDATE
          GOTO      PPLDT999 IF LESS
.
          MATCH     FLTPB005,SP70
          IF        !@EQUAL
            MATCH     FLTPB005,PMPBPRID
            GOTO      PPLDT010 IF NOT EQUAL
          ENDIF
.
          MATCH     FLTPB006,SP70
          IF        !@EQUAL
            MATCH     FLTPB006,PMPBPRTY
            GOTO      PPLDT010 IF NOT EQUAL
          ENDIF
.
          MATCH     FLTPB008,SP70
          IF        !@EQUAL
            MATCH     FLTPB008,PMPBPRST
            GOTO      PPLDT010 IF NOT EQUAL
          ENDIF
.
          MATCH     FLTPB020,SP70
          IF        !@EQUAL
            MATCH     FLTPB020,PMPBRVST
            GOTO      PPLDT010 IF NOT EQUAL
          ENDIF
.
.
          MOVE      "wy",CATEGORY
          MOVE      PMPBPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRTYDESC
.
          MOVE      "ww",CATEGORY
          MOVE      PMPBPRID,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIDDESC
.
          MOVE      "wx",CATEGORY
          MOVE      PMPBPRST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRSTDESC
.
          MOVE      "wz",CATEGORY
          MOVE      PMPBRVST,CODE
          CALL      GETCOD00
          MOVE      TDESC,RVSTDESC
.
          PACK      KEY8,PMPBURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      PATNAA00
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateItem('",HTMLLINK
          APPEND    PMPBURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPBPNUM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PMPBNRDT,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",PMPBDSC1,"#",":
                             "#"",PRIDDESC,"#",":
                             "#"",PRTYDESC,"#",":
                             "#"",PRSTDESC,"#",":
                             "#"",RVSTDESC,"#");"
.
          GOTO      PPLDT010

PPLDT999  RETURN
.------------------------------------------------------------
. Link to Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",OPTNCODE
          REP       " +",WARDCODE
          REP       " +",CARECODE
.
          WRITE     HTMLFILE;"patweb03.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&optncode=",OPTNCODE:
                                 "&wardcode=",WARDCODE:
                                 "&carecode=",CARECODE;
          MATCH      SP70,FLTPB005
          IF         !@EQUAL
            REP       " +",FLTPB005
            WRITE     HTMLFILE;"&fltpb005=",FLTPB005;
            REP       "+ ",FLTPB005
          ENDIF
.
          MATCH      SP70,FLTPB006
          IF         !@EQUAL
            REP       " +",FLTPB006
            WRITE     HTMLFILE;"&fltpb006=",FLTPB006;
            REP       "+ ",FLTPB006
          ENDIF
.
          MATCH      SP70,FLTPB008
          IF         !@EQUAL
            REP       " +",FLTPB008
            WRITE     HTMLFILE;"&fltpb008=",FLTPB008;
            REP       "+ ",FLTPB008
          ENDIF
.
          MATCH      SP70,FLTPB020
          IF         !@EQUAL
            REP       " +",FLTPB020
            WRITE     HTMLFILE;"&fltpb020=",FLTPB020;
            REP       "+ ",FLTPB020
          ENDIF
.
          REP       "+ ",OPTNCODE
          REP       "+ ",WARDCODE
          REP       "+ ",CARECODE
.
NEXT9999  RETURN
.-------------------------------------------------------------------------------
.  Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",OPTNCODE
          REP       " +",WARDCODE
          REP       " +",CARECODE
.
          WRITE     HTMLFILE;"patweb03.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&optncode=",OPTNCODE:
                                 "&wardcode=",WARDCODE:
                                 "&carecode=",CARECODE;
          MATCH      SP70,FLTPB005
          IF         !@EQUAL
            REP       " +",FLTPB005
            WRITE     HTMLFILE;"&fltpb005=",FLTPB005;
            REP       "+ ",FLTPB005
          ENDIF
.
          MATCH      SP70,FLTPB006
          IF         !@EQUAL
            REP       " +",FLTPB006
            WRITE     HTMLFILE;"&fltpb006=",FLTPB006;
            REP       "+ ",FLTPB006
          ENDIF
.
          MATCH      SP70,FLTPB008
          IF         !@EQUAL
            REP       " +",FLTPB008
            WRITE     HTMLFILE;"&fltpb008=",FLTPB008;
            REP       "+ ",FLTPB008
          ENDIF
.
          MATCH      SP70,FLTPB020
          IF         !@EQUAL
            REP       " +",FLTPB020
            WRITE     HTMLFILE;"&fltpb020=",FLTPB020;
            REP       "+ ",FLTPB020
          ENDIF
.
          REP       "+ ",OPTNCODE
          REP       "+ ",WARDCODE
          REP       "+ ",CARECODE
.
PREV9999  RETURN
.------------------------------------------------------------
. Doctor Care Maintenance
.------------------------------------------------------------
DCMAIN00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,DCMAIN95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          BRANCH    OVRCD,DCMAIN96
.
          IF        ASTAT=3
            PACK      KEY8,ADMISSNO
            CALL      RDDSCH1
            BRANCH    OVRCD,DCMAIN94
          ENDIF
.
          PACK      KEY8,ADMISSNO
          CALL      RDPMVX11
          BRANCH    OVRCD,DCMAIN97
.
.         Read the last pattrnf record and  patre1af record for HL7 messaging
.
          PACK      KEY30,ADMISSNO,TILDA30
          CALL      RDSTRAN2                * position after last tran record
          CALL      RDPTRAN2                * read previous record
          BRANCH    OVRCD,DCMAIN93          * eof - error
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTRES1                * PRFA record on file ?
          BRANCH    OVRCD,DCMAIN92          * no - error
.
          CALL      CLRPMDTC                * Clear Doctor Care Variables
          MATCH     "A",UPDTTYPE            * Add
          GOTO      DCMAIN10 IF EQUAL
.
          PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDPMDTC1
          IF        OVRCD=1
            CALL      CLRPMDTC
          ENDIF
.
          MATCH     SP70,UPDTTYPE           * Dislay
          GOTO      DCMAIN50 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      DCMAIN20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      DCMAIN30 IF EQUAL
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      DCMAIN99
.
DCMAIN10  CALL      ADDDTC00
          GOTO      DCMAIN99
.
DCMAIN20  CALL      UPDDTC00
          GOTO      DCMAIN99
.
DCMAIN30  CALL      DELDTC00
          GOTO      DCMAIN99
.
DCMAIN50  MOVE      "Doctor Care Maintenance",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,DCMAIN99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN92  MOVE      "Missing PRFA Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN93  MOVE      "Missing Transfer Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN94  MOVE      "Missing Discharge Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN95  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN96  MOVE      "Invalid Admission Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN97  MOVE      "Missing Visit Extension Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN98  MOVE      "Invalid Doctor Care Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCMAIN99
.
DCMAIN99  RETURN
+
.------------------------------------------------------------
. Add Doctor Care record
.------------------------------------------------------------
ADDDTC00  CALL      VALA0000    * validate record
          BRANCH    EXIT,ADDDTC99
.
          COMPARE   ONE,SETSECDT            * set as Secondary Doctor?
          GOTO      ADDDTC10 IF EQUAL       * yes; skip overlap validation
.
          CALL      VALO0000    * validate for overlaps record
          BRANCH    EXIT,ADDDTC99
.
ADDDTC10  CALL      CLRPMDTC
.
          CALL      MVDTC000
          MOVE      ADMISSNO,PMDTVISN
          PACK      KEY24,PMDTVISN,PMDTSDAT,PMDTSTIM,SP70
          CALL      IBACLOCK
          PACK      PMDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDTCDAT
          MOVE      USERID,PMDTCUID
          CLOCK     TIME,PMDTCTIM
.
ADDDTC20  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRPMDTC1
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      PMDTSDAT,D8
            UNPACK    PMDTSTIM,HOURTME,KEY1,MINTIME,DIM1,SECTIME
            CALL      ASEC0000      * add 1 sec to date/time
            MOVE      ":",KEY1
            PACK      PMDTSTIM,HOURTME,KEY1,MINTIME,KEY1,SECTIME,SP70 * new time
            MOVE      D8,PMDTSDAT      * new date
            GOTO      ADDDTC20         * try writing new record again
          ENDIF
.
          COMPARE   ONE,SETSECDT            * set as Secondary Doctor?
          GOTO      ADDDTC30 IF NOT EQUAL   * no; continue as per previously
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMDTDOCT,PMVXEDC1
            MOVE      PMDTUNIT,PMVXEDU1
            CALL      UPPMVX11
.
. Only send if not cancelled
.
            IF        ASTAT<>5
              CALL      PMIGTNID              * get national id for HL7 message
              MOVE      NMPNUMB,PTNINMPI
              MOVE      FOUR,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICAC
            ENDIF
          ENDIF
          GOTO      ADDDTC99
.
.
.         Update visit extn record as per existing functionality (without
.         set Secondary Doctor option)
.
ADDDTC30  COMPARE   ZERO,UPVISFLG
          GOTO      ADDDTC90 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            IF        UPVISFLG=2
              MOVE      SP70,PMVXEDC1
              MOVE      SP70,PMVXEDU1
            ELSE
              MOVE      PMDTDOCT,PMVXEDC1
              MOVE      PMDTUNIT,PMVXEDU1
            ENDIF
            CALL      UPPMVX11
          ENDIF
.
. Only send if not cancelled
.
ADDDTC50  IF        ASTAT<>5
            CALL      PMIGTNID                * get national id for HL7 message
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWO,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC
          ENDIF
.
ADDDTC90  MOVE      URNUMBER,ALPCURNO
          MOVE      " 1",ALPCTYPE
          MOVE      PMDTDOCT,ALPCCODE
          MOVE      SP70,ALPCSITE
.
          PACK      KEY26,ALPCURNO,ALPCTYPE,ALPCCODE,ALPCSITE,SP70
          CALL      RDALPCT1
          IF        OVRCD=1
            MOVE      ZERO,ALPCADFL
            PACK      ALPCCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALPCCDAT
            CLOCK     TIME,ALPCCTIM
            MOVE      USERID,ALPCCUID
            MOVE      SP70,ALPCSPAR
            CALL      WRALPCT1
          ENDIF
.
          MOVE      ZERO,EXIT
.
ADDDTC99  RETURN
+
.------------------------------------------------------------
. Update Doctor Care record
.------------------------------------------------------------
UPDDTC00  CALL      VALA0000    * validate record
          BRANCH    EXIT,UPDDTC99
.
          COMPARE   ONE,SETSECDT            * set as Secondary Doctor?
          GOTO      UPDDTC10 IF EQUAL       * yes; skip overlap validation
.
          CALL      VALO0000    * validate for overlaps record
          BRANCH    EXIT,UPDDTC99
.
UPDDTC10  CALL      CLRPMDTC
.
          PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDPMDTC1
          BRANCH    OVRCD,UPDDTC95
.
          CALL      MVDTC000
          CALL      IBACLOCK
          PACK      PMDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDTUDAT
          MOVE      USERID,PMDTUUID
          CLOCK     TIME,PMDTUTIM
          CALL      UPPMDTC1
.
          COMPARE   ONE,SETSECDT            * set as Secondary Doctor?
          GOTO      UPDDTC20 IF NOT EQUAL   * no; continue as per previously
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMDTDOCT,PMVXEDC1
            MOVE      PMDTUNIT,PMVXEDU1
            CALL      UPPMVX11
.
. Only send if not cancelled
.
            IF        ASTAT<>5
              CALL      PMIGTNID              * get national id for HL7 message
              MOVE      NMPNUMB,PTNINMPI
              MOVE      FIVE,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICAC
            ENDIF
          ENDIF
          GOTO      UPDDTC99
.
.
.         Update visit extn record as per existing functionality (without
.         set Secondary Doctor option)
.
UPDDTC20  COMPARE   ZERO,UPVISFLG
          GOTO      UPDDTC90 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            IF        UPVISFLG=2
              MOVE      SP70,PMVXEDC1
              MOVE      SP70,PMVXEDU1
            ELSE
              MOVE      PMDTDOCT,PMVXEDC1
              MOVE      PMDTUNIT,PMVXEDU1
            ENDIF
            CALL      UPPMVX11
          ENDIF
.
. Only send if not cancelled
.
UPDDTC50  IF        ASTAT<>5
            CALL      PMIGTNID                * get national id for HL7 message
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THREE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC
          ENDIF
.
UPDDTC90  MOVE      ZERO,EXIT
          GOTO      UPDDTC99
.
UPDDTC95  MOVE      "Doctor Care record not on file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPDDTC99  RETURN
+
.------------------------------------------------------------
. Delete Doctor Care record and clear the Secondary Doctor/Unit
. field in the visit extn file if same Doctor.
.------------------------------------------------------------
DELDTC00  PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDPMDTC1
          BRANCH    OVRCD,DELDTC91
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,DELDTC90
.
          MATCH     PMDTDOCT,PMVXEDC1
          IF        @EQUAL
            MOVE      SP70,PMVXEDC1         * Clear doctor
            MOVE      SP70,PMVXEDU1         * Clear unit
            CALL      UPPMVX11
.
. Only send if not cancelled
.
            IF        ASTAT<>5
              CALL      PMIGTNID              * get national id for HL7 message
              MOVE      NMPNUMB,PTNINMPI
              MOVE      ONE,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICAC
            ENDIF
          ENDIF
.
DELDTC90  CALL      DEPMDTC1
          MOVE      ZERO,EXIT
          GOTO      DELDTC99
.
DELDTC91  MOVE      "Record not on file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
DELDTC99  RETURN
+
.------------------------------------------------------------
. Validate Doctor care record
.------------------------------------------------------------
VALA0000  MOVE      ZERO,EXIT
          PACK      KEY24,ADMISSNO,PMDTC004,PMDTC005,SP70
          CALL      RDPMDTC1
          IF        OVRCD<>1
            MATCH     ANSA,UPDTTYPE
            IF        @EQUAL
.             GOTO      VALA9020
            ENDIF
          ENDIF
.
          MATCH     PMDTC002,ADOCTA      * exit if new doc matches Attending doc
          GOTO      VALA9040 IF EQUAL
.
          MATCH     SP70,PMDTC006           * blank end date?
          IF        !@EQUAL
            MATCH     PMDTC004,PMDTC006     * compare start/end dates
            GOTO      VALA9030 IF LESS      * end date before start date
.
            MATCH     PMDTC004,PMDTC006     * same start/end date?
            IF        @EQUAL
              MATCH     PMDTC005,PMDTC007   * compare start/end times
              GOTO      VALA9030 IF LESS    * end time before start time
            ENDIF
          ENDIF
.
. *** validate start date and time ***
.
          MATCH     ADATE,PMDTC004
          GOTO      VALA9000 IF LESS
.
          MATCH     ADATE,PMDTC004
          IF        @EQUAL
            MATCH     ATIME,PMDTC005
            GOTO      VALA9000 IF LESS
          ENDIF
.
          IF        ASTAT<>3
            GOTO      VALA1000
          ENDIF
.
          MATCH     PMDTC004,DDATE
          GOTO      VALA9010 IF LESS
.
          MATCH     DDATE,PMDTC004
          IF        @EQUAL
            MATCH     DTIME,PMDTC005
            GOTO      VALA9010 IF LESS
          ENDIF
.
VALA1000  MATCH     SP70,PMDTC006
          GOTO      VALA2000 IF EQUAL
.
          MATCH     Z70,PMDTC006
          GOTO      VALA2000 IF EQUAL
.
. *** validate end date and time ***
.
          MATCH     ADATE,PMDTC006
          GOTO      VALA9000 IF LESS
.
          MATCH     ADATE,PMDTC006
          IF        @EQUAL
            MATCH     ATIME,PMDTC007
            GOTO      VALA9000 IF LESS
          ENDIF
.
          IF        ASTAT<>3
            GOTO      VALA2000
          ENDIF
.
          MATCH     PMDTC006,DDATE
          GOTO      VALA9010 IF LESS
.
          MATCH     DDATE,PMDTC006
          IF        @EQUAL
            MATCH     DTIME,PMDTC007
            GOTO      VALA9010 IF LESS
          ENDIF
.
VALA2000  MOVE      ZERO,EXIT
          GOTO      VALA9999
.
VALA9000  MOVE      "Cannot be before admission date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALA9999
.
VALA9010  MOVE      "Cannot be before discharge date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALA9999
.
VALA9020  MOVE      "Record already exists for this date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALA9999
.
VALA9030  MOVE      "End date/time less than Start Date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALA9999
.
VALA9040  MOVE      "Additional Doctor cannot be the same as the current Admitting Doctor",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALA9999
.
VALA9999  RETURN
+
.------------------------------------------------------------
. Validate for overlapping Doctor Care record
. Returns  UPVISFLG 0 = Don't update visit extn file
.                   1 = Update visit extn file
.                   2 = Clear visit extn file doctor and unit
.------------------------------------------------------------
VALO0000  MOVE      ZERO,EXIT
          MOVE      ZERO,UPVISFLG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,VALO9999
.
          MATCH     SP70,PMVXEDC1           * Secondary Doctor exists?
          GOTO      VALO0100 IF EQUAL       * no; continue with validations
.
          GOTO      VALO9999                * We must be adding/updating
                                            * an Additional Doctorl so skip
                                            * any validations
.
VALO0100  PACK      KEY24,ADMISSNO,PMDTC004,PMDTC005,Z70
          CALL      RSPMDTC1
VALO0200  CALL      RPPMDTC1
          BRANCH    OVRCD,VALO0600
.
          MATCH     ADMISSNO,PMDTVISN
          GOTO      VALO0600 IF NOT EQUAL
.
          MATCH     ANSU,UPDTTYPE
          GOTO      VALO0500 IF NOT EQUAL
.
          MATCH     TRANDATE,PMDTSDAT
          GOTO      VALO0500 IF NOT EQUAL
.
          MATCH     TRANTIME,PMDTSTIM
          GOTO      VALO0500 IF NOT EQUAL
.
          GOTO      VALO0200
.
VALO0500  MATCH     SP70,PMDTEDAT
          GOTO      VALO9000 IF EQUAL
.
          MATCH     PMDTEDAT,PMDTC004
          GOTO      VALO9010 IF LESS
.
          MATCH     PMDTEDAT,PMDTC004
          IF        @EQUAL
            MATCH     PMDTETIM,PMDTC005
            GOTO      VALO9010 IF LESS
          ENDIF
.
          MATCH     SP70,PMDTC006
          GOTO      VALO9999 IF EQUAL
.
VALO0600  PACK      KEY24,ADMISSNO,PMDTC004,PMDTC005,SP70
          CALL      RSPMDTC1
VALO0700  CALL      RKPMDTC1
          BRANCH    OVRCD,VALO8000
.
          MATCH     ADMISSNO,PMDTVISN
          GOTO      VALO8000 IF NOT EQUAL
.
          MATCH     SP70,PMDTC006
          GOTO      VALO9020 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE
          GOTO      VALO1000 IF NOT EQUAL
.
          MATCH     TRANDATE,PMDTSDAT
          GOTO      VALO1000 IF NOT EQUAL
.
          MATCH     TRANTIME,PMDTSTIM
          GOTO      VALO1000 IF NOT EQUAL
.
          GOTO      VALO0700
.
VALO1000  MATCH     PMDTC004,PMDTSDAT
          GOTO      VALO9020 IF LESS
.
          MATCH     PMDTC004,PMDTSDAT
          IF        @EQUAL
            MATCH     PMDTC005,PMDTSTIM
            GOTO      VALO9020 IF LESS
          ENDIF
.
          MATCH     PMDTC006,PMDTSDAT
          GOTO      VALO9020 IF LESS
.
          MATCH     PMDTC006,PMDTSDAT
          IF        @EQUAL
            MATCH     PMDTC007,PMDTSTIM
            GOTO      VALO9020 IF LESS
          ENDIF
.
          GOTO     VALO9999
.
VALO8000  MATCH     Z70,PMDTC006            * No End date
          GOTO      VALA8200 IF EQUAL
.
          MATCH     SP70,PMDTC006           * No End date
          GOTO      VALA8200 IF EQUAL
.
          MOVE      TWO,UPVISFLG            * Add/Update last care record with
          GOTO      VALO9999                * an end date
.
VALA8200  MOVE      ONE,UPVISFLG
          GOTO      VALO9999
.
VALO9000  MOVE      "Previous doctor has not ended yet",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALO9999
.
VALO9010  MOVE      "Overlapping previous end date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALO9999
.
VALO9020  MOVE      "Overlapping next start date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALO9999
.
VALO9999  RETURN
+
.------------------------------------------------------------
. Move Doctor Care Variables
.------------------------------------------------------------
MVDTC000  MATCH     Z70,PMDTC002
          IF        !@EQUAL
            PACK      PMDTDOCT,PMDTC002,SP70
          ENDIF
.
          MATCH     Z70,PMDTC003
          IF        !@EQUAL
            PACK      PMDTUNIT,PMDTC003,SP70
          ENDIF
.
          MATCH     Z70,PMDTC004
          IF        !@EQUAL
            PACK      PMDTSDAT,PMDTC004,SP70
          ENDIF
.
          MATCH     Z70,PMDTC005
          IF        !@EQUAL
            PACK      PMDTSTIM,PMDTC005,SP70
          ENDIF
.
          MATCH     Z70,PMDTC006
          IF        !@EQUAL
            PACK      PMDTEDAT,PMDTC006,SP70
          ENDIF
.
          MATCH     Z70,PMDTC007
          IF        !@EQUAL
            PACK      PMDTETIM,PMDTC007,SP70
          ENDIF
.
          MATCH     Z70,PMDTC008
          IF        !@EQUAL
            PACK      PMDTTEAM,PMDTC008,SP70
          ENDIF
.
MVDTC999  RETURN
+
.------------------------------------------------------------
. Clear Doctor Care Variables
.------------------------------------------------------------
CLRPMDTC  PACK      PMDTVISN,SP70
          PACK      PMDTDOCT,SP70
          PACK      PMDTUNIT,SP70
          PACK      PMDTSDAT,SP70
          PACK      PMDTSTIM,SP70
          PACK      PMDTEDAT,SP70
          PACK      PMDTETIM,SP70
          PACK      PMDTCDAT,SP70
          PACK      PMDTCTIM,SP70
          PACK      PMDTCUID,SP70
          PACK      PMDTUDAT,SP70
          PACK      PMDTUTIM,SP70
          PACK      PMDTUUID,SP70
          PACK      PMDTTEAM,SP70
          PACK      PMDTSPAR,SP70
.
          RETURN
+
.------------------------------------------------------------
. Doctor Care Details
.------------------------------------------------------------
PMDT0000  BRANCH    FLDITMNO,PMDT0010,PMDT0020,PMDT0030,PMDT0040,PMDT0050:
                             PMDT0060,PMDT0070,PMDT0080,PMDT0090,PMDT0100:
                             PMDT0110,PMDT0120,PMDT0130,PMDT0140,PMDT0150
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      PMDT9999
.
PMDT0010  WRITE     HTMLFILE;PMDTVISN;
          GOTO      PMDT9999
.
PMDT0020  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMDT0025
          PACK      KEY10,PMDTDOCT,SP30
          CALL      RDPMHCP1
          BRANCH    OVRCD,PMDT9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PMDT9999
.
PMDT0025  WRITE     HTMLFILE;PMDTDOCT;
          GOTO      PMDT9999
.
PMDT0030  MOVE      "AC",CATEGORY             * Unit (AC)
          PACK      CODE,PMDTUNIT,SP70
          CALL      CODITM00
          GOTO      PMDT9999
.
PMDT0040  MATCH     PMDTSDAT,SP70             * Start Date
          GOTO      PMDT9999 IF EQUAL
          UNPACK    PMDTSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMDT9999
.
PMDT0050  MATCH     PMDTSTIM,SP70             * Start Time
          GOTO      PMDT9999 IF EQUAL
          WRITE     HTMLFILE;PMDTSTIM;
          GOTO      PMDT9999
.
PMDT0060  MATCH     PMDTEDAT,SP70             * End Date
          GOTO      PMDT9999 IF EQUAL
          UNPACK    PMDTEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMDT9999
.
PMDT0070  MATCH     PMDTETIM,SP70             * End Time
          GOTO      PMDT9999 IF EQUAL
          WRITE     HTMLFILE;PMDTETIM;
          GOTO      PMDT9999
.
PMDT0080  MATCH     PMDTCDAT,SP70             * Date Record Created
          GOTO      PMDT9999 IF EQUAL
          UNPACK    PMDTCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMDT9999
.
PMDT0090  MATCH     PMDTCTIM,SP70             * Time Record Created
          GOTO      PMDT9999 IF EQUAL
          WRITE     HTMLFILE;PMDTCTIM;
          GOTO      PMDT9999
.
PMDT0100  UNPACK    DIM127,D1,KEY1,DIM127     * .0   Web User ID rec. creator
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMDT0105
          WRITE     HTMLFILE;PMDTCUID;
          GOTO      PMDT9999
PMDT0105  PACK      KEY10,PMDTCUID,SP70       * .1
          CALL      RDWBSE1
          BRANCH    OVRCD,PMDT9999
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMDT9999
.
PMDT0110  MATCH     PMDTUDAT,SP70             * Date Record Created
          GOTO      PMDT9999 IF EQUAL
          UNPACK    PMDTUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMDT9999
.
PMDT0120  MATCH     PMDTUTIM,SP70             * Time Record Created
          GOTO      PMDT9999 IF EQUAL
          WRITE     HTMLFILE;PMDTUTIM;
          GOTO      PMDT9999
.
PMDT0130  UNPACK    DIM127,D1,KEY1,DIM127     * .0   Web User ID rec. creator
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMDT0135
          WRITE     HTMLFILE;PMDTUUID;
          GOTO      PMDT9999
PMDT0135  PACK      KEY10,PMDTUUID,SP70       * .1
          CALL      RDWBSE1
          BRANCH    OVRCD,PMDT9999
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMDT9999
.
PMDT0140  PROC      DISTM000                 * display Team/s
          GOTO      PMDT9999
.
PMDT0150  PACK      KEY24,ADMISSNO,TDATE,TTIME,SP70
          CALL      RSPMDTC1
          CALL      RKPMDTC1
          BRANCH    OVRCD,PMDT9999
.
          MATCH     ADMISSNO,PMDTVISN       * same visit? if not read backwards
          GOTO      PMDT0151 IF EQUAL
.
          PACK      KEY24,ADMISSNO,TDATE,TTIME,Z70
          CALL      RSPMDTC1
          CALL      RPPMDTC1
          BRANCH    OVRCD,PMDT9999
.
          MATCH     ADMISSNO,PMDTVISN       * same visit? if not then bail
          GOTO      PMDT0151 IF EQUAL
.
          GOTO      PMDT9999
.
PMDT0151  WRITE     HTMLFILE;PMDTDOCT;      * output Care Doctor for this visit
          GOTO      PMDT9999
.
PMDT9999  RETURN
+
.------------------------------------------------------------
. Patient Level Health Fund Program Maintenance
.------------------------------------------------------------
PROG0000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      PROG5000 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update program
          GOTO      PROG2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete program and OP breakdown
          GOTO      PROG3000 IF EQUAL
.
          MATCH     "E",UPDTTYPE       * Update OP breakdown
          GOTO      PROG4000 IF EQUAL
.
          GOTO      PROG9000
.
PROG2000  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          BRANCH    OVRCD,PROG9200
.
. Save the original primary key
.
          PACK      SAVKEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                             PMUGEDAT,SP70
.
          CALL      MVUPG000      * Moves input variables to file variables
.
          MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            MOVE      EXPIRYDT,PMUGEDAT     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            MOVE      ADMNTYPE,PMUGATYP     * New admission type
          ENDIF
.
          PACK      PMUGUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUGUDAT
          CLOCK     TIME,PMUGUTIM
          MOVE      USERID,PMUGUUID
.
. Save the new primary key
.
          PACK      KEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
.
. If the expiry date has changed check for a duplicate before the update
.
          MATCH     KEY31,SAVKEY31
          IF        !@EQUAL
            CALL      RAPMUPG1              * Is new program on file
            COMPARE   ZERO,OVRCD
            GOTO      PROG9300 IF EQUAL
.
            MOVE      SAVKEY31,KEY31
            CALL      RAPMUPG1              * Re read original program
            BRANCH    OVRCD,PROG9200
          ENDIF
.
          CALL      UPPMUPG1
.
PROG2010  MOVE      PMUPG001,PMAPG001
          MOVE      PMUPG002,PMAPG002
          MOVE      PMUPG003,PMAPG003
          MOVE      PMUPG004,PMAPG004
          MOVE      PMUPG005,PMAPG005
          MOVE      PMUPG006,PMAPG006
.
          PACK      KEY31,PMAPG001,PMAPG002,PMAPG003,PMAPG004,PMAPG005:
                          PMAPG006,SP70
          CALL      RDPMAPG1
          BRANCH    OVRCD,PROG9200
.
          CALL      MVPAPG00      * Moves input variables to file variables
.
          MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            MOVE      EXPIRYDT,PMAGEDAT     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            MOVE      ADMNTYPE,PMAGATYP     * New admission type
          ENDIF
.
          PACK      PMAGUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAGUDAT
          CLOCK     TIME,PMAGUTIM
          MOVE      USERID,PMAGUUID
.
          CALL      UPPMAPG1
.
PROG2100  MATCH     Z70,EXPIRYDT                 * Expiry date received
          GOTO      PROG2150 IF EQUAL
.
          MATCH     EXPIRYDT,PMUPG006            * Change of expiry date
          GOTO      PROG2200 IF NOT EQUAL
.
PROG2150  MATCH     Z70,ADMNTYPE                 * Admissoin type received
          GOTO      PROG2900 IF EQUAL
.
          MATCH     ADMNTYPE,PMUPG002            * Change of admission type
          GOTO      PROG2900 IF EQUAL
.
PROG2200  CALL      UPPIT000                     * Update Program Interruption
.
          CALL      UPPMC000                     * Update Program Maint Comments
.
          PACK      KEY34,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMUPO1
          CALL      RKPMUPO1
          BRANCH    OVRCD,PROG2900
.
          MATCH     PMUPG001,PMUOURNO
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     PMUPG002,PMUOATYP
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     PMUPG003,PMUOCLAM
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     PMUPG004,PMUOFUND
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     PMUPG005,PMUOTABT
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     PMUPG006,PMUOEDAT
          GOTO      PROG2900 IF NOT EQUAL
.
          MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            MOVE      EXPIRYDT,PMUOEDAT     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            MOVE      ADMNTYPE,PMUOATYP     * New admission type
          ENDIF
.
          CALL      UPPMUPO1
          GOTO      PROG2100
.
PROG2900  MOVE      ZERO,EXIT
          GOTO      PROG9999
.
PROG3000  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          BRANCH    OVRCD,PROG9200
.
          CALL      DEPMUPG1
.
PROG3500  PACK      KEY34,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMUPO1
          CALL      RKPMUPO1
          BRANCH    OVRCD,PROG3600                                  * Car 273161
.
          MATCH     PMUPG001,PMUOURNO
          GOTO      PROG3600 IF NOT EQUAL                           * Car 273161
.
          MATCH     PMUPG002,PMUOATYP
          GOTO      PROG3600 IF NOT EQUAL                           * Car 273161
.
          MATCH     PMUPG003,PMUOCLAM
          GOTO      PROG3600 IF NOT EQUAL                           * Car 273161
.
          MATCH     PMUPG004,PMUOFUND
          GOTO      PROG3600 IF NOT EQUAL                           * Car 273161
.
          MATCH     PMUPG005,PMUOTABT
          GOTO      PROG3600 IF NOT EQUAL                            * Car 273161
.
          MATCH     PMUPG006,PMUOEDAT
          GOTO      PROG3600 IF NOT EQUAL                            * Car 273161
.
          PACK      KEY34,PMUOURNO,PMUOATYP,PMUOCLAM,PMUOFUND,PMUOTABT:
                          PMUOEDAT,PMUOVTYP,SP70
          CALL      DEPMUPO1
          GOTO      PROG3500
.
.*                  Delete pmsapgaf and pmspitaf records              CAR 273161
PROG3600  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMAPG1
          BRANCH    OVRCD,PROG3700
.
          CALL      DEPMAPG1
.
PROG3700  PACK      KEY36,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMPIT1
          CALL      RKPMPIT1
          BRANCH    OVRCD,PROG3900
.
          MATCH     PMUPG001,PMPIURNO
          GOTO      PROG3900 IF NOT EQUAL
.
          MATCH     PMUPG002,PMPIATYP
          GOTO      PROG3900 IF NOT EQUAL
.
          MATCH     PMUPG003,PMPICLAM
          GOTO      PROG3900 IF NOT EQUAL
.
          MATCH     PMUPG004,PMPIFUND
          GOTO      PROG3900 IF NOT EQUAL
.
          MATCH     PMUPG005,PMPITABT
          GOTO      PROG3900 IF NOT EQUAL
.
          MATCH     PMUPG006,PMPIEDAT
          GOTO      PROG3900 IF NOT EQUAL
.
          PACK      KEY36,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,PMPIICNT,SP70
          CALL      DEPMPIT1
          GOTO      PROG3700
.
PROG3900  MOVE      ZERO,EXIT
          GOTO      PROG9999
.
PROG4000  PACK      KEY34,PMUPO001,PMUPO002,PMUPO003,PMUPO004,PMUPO005:
                          PMUPO006,PMUPO007,SP70
          CALL      RDPMUPO1
          BRANCH    OVRCD,PROG9200
.
          CALL      MVUPO000      * Moves input variables to file variables
.
          PACK      PMUOUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUOUDAT
          CLOCK     TIME,PMUOUTIM
          MOVE      USERID,PMUOUUID
.
          CALL      UPPMUPO1
.
          MOVE      ZERO,EXIT
          GOTO      PROG9999
.
PROG5000  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PROG9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          IF        OVRCD=1
            CALL      CLPMSUPG
            GOTO      PROG5100                                      * CAR 257776
          ENDIF
.                                                                   * CAR 257776
          PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMAPG1
          IF        OVRCD=1
            CALL      CLPAPG00
            MOVE      PMUPG001,PMAGURNO
            MOVE      PMUPG002,PMAGATYP
            MOVE      PMUPG003,PMAGCLAM
            MOVE      PMUPG004,PMAGFUND
            MOVE      PMUPG005,PMAGTABT
            MOVE      PMUPG006,PMAGEDAT
            CALL      WRPMAPG1           * Create record if one does not exist
          ENDIF
.
PROG5100  PACK      KEY34,PMUPO001,PMUPO002,PMUPO003,PMUPO004,PMUPO005:
                          PMUPO006,PMUPO007,SP70
          CALL      RDPMUPO1
          IF        OVRCD=1
            CALL      CLPMSUPO
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Programs",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PROG9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PROG9999
.
PROG9000  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROG9999
.
PROG9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROG9999
.
PROG9200  MOVE      "Invalid Program Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROG9999
.
PROG9300  MOVE      "Program Record already on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROG9999
.
PROG9999  RETURN
.
.*******************************************************************************
. Program Interruption Details Maintenance                            CAR 257776
.*******************************************************************************
PRIT0000  MATCH     SP70,UPDTTYPE
          GOTO      PRIT7000 IF EQUAL
.
          MATCH     "A",UPDTTYPE                 * Add Program Interruption
          GOTO      PRIT1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE                 * Update Program Interruption
          GOTO      PRIT2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete Program Interruption
          GOTO      PRIT3000 IF EQUAL
.
          GOTO      PRIT9000
.
.------------------------------------------------------------------------------
. Add new Program Interruption Details
.------------------------------------------------------------------------------
PRIT1000  MOVE      ZERO,PMPITCNT
.
          PACK      KEY36,PMPIT001,PMPIT002,PMPIT003,PMPIT004,PMPIT005:
                          PMPIT006,Z70
          CALL      RSPMPIT1
PRIT1100  CALL      RPPMPIT1                      * identify last count
          IF        OVRCD = 1
            GOTO      PRIT1200
          ENDIF
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      PRIT1200 IF NOT EQUAL
.
          SQUEEZE   PMPIICNT
          MOVE      PMPIICNT,PMPITCNT
          IF        PMPITCNT > 99998
            GOTO    PRIT9300
          ENDIF
.
PRIT1200  CALL      CHOL0000                     * Check For Date Overlap
.
          ADD       ONE,PMPITCNT
          MOVE      PMPITCNT,PMPIT007
.
          CALL      CLPPIT00                     * Clear File Variables
          CALL      MVPPIT00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPICDAT                * System date
          CLOCK     TIME,PMPICTIM                * System time
          MOVE      USERID,PMPICUID              * web user id
.
          CALL      WRPMPIT1                     * write new record
.                                                                   * Car 274410
          CALL      WEBWAR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
.------------------------------------------------------------------------------
. Update Program Interruption Details
.------------------------------------------------------------------------------
PRIT2000  CALL      CHOL0000                     * Check For Date Overlap
.                                                * Re-read update record
          PACK      KEY36,PMPIT001,PMPIT002,PMPIT003,PMPIT004,PMPIT005:
                          PMPIT006,PMPIT007,SP70
          CALL      RDPMPIT1
          IF        OVRCD = 1
            GOTO      PRIT9200
          ENDIF
.
          CALL      MVPPIT00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPIUDAT                * System date
          CLOCK     TIME,PMPIUTIM                * System time
          MOVE      USERID,PMPIUUID              * web user id
.
          CALL      UPPMPIT1                     * update details
.                                                                   * Car 274410
          CALL      WEBWAR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
.------------------------------------------------------------------------------
. Delete Program Interruption
.------------------------------------------------------------------------------
PRIT3000  PACK      KEY36,PMPIT001,PMPIT002,PMPIT003,PMPIT004,PMPIT005:
                          PMPIT006,PMPIT007,SP70
          CALL      RDPMPIT1
          IF        OVRCD = 1
            GOTO      PRIT9200
          ENDIF
.
          CALL      MVPPIT00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPIDDAT                * System date
          CLOCK     TIME,PMPIDTIM                * System time
          MOVE      USERID,PMPIDUID              * web user id
.
          MOVE      ONEINIT,PMPIDELT             * Set Deleted flag
.
          CALL      UPPMPIT1                     * update details
.
          MOVE      ZERO,EXIT
          GOTO      PRIT9999
.
.------------------------------------------------------------------------------
. List Program Interruption
.------------------------------------------------------------------------------
PRIT7000  CLEAR     WEBTITLE
          MOVE      "Program Interruption Details",WEBTITLE
          RESET     WEBTITLE
.
          MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PRIT9400
.
          PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          IF        OVRCD=1
            CALL      CLPMSUPG
            GOTO      PRIT9100
          ENDIF
.
PRIT7100  PACK      KEY36,PMPIT001,PMPIT002,PMPIT003,PMPIT004,PMPIT005:
                          PMPIT006,PMPIT007,SP70
          CALL      RDPMPIT1
          IF        OVRCD = 1
            CALL      CLPPIT00
          ENDIF
.                                                 * Get the admission date
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD = 1
            CALL      CLPATMIS
          ENDIF
.                                                 * Get the discharge date
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD = 1
            CALL      CLPATDSC
          ENDIF
.
          CALL      WEBHED00                     * Create HTML File/Page Header
          BRANCH    EXIT,PRIT9999
          CALL      WEBBOD00                     * Process Web Body
          CALL      WEBEND00                     * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9100  MOVE      "Program does not exist on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9200  MOVE      "Interruptions do not exist on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9300  MOVE      "Too Many Program Interruption Details exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9400  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIT9999
.
PRIT9999  RETURN
.
.*******************************************************************************
. Update Program Interruption with new Program Expiry Date
.*******************************************************************************
UPPIT000  PACK      KEY36,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMPIT1
UPPIT100  CALL      RKPMPIT1
          BRANCH    OVRCD,UPPIT999
.
          MATCH     PMUPG001,PMPIURNO
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     PMUPG002,PMPIATYP
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     PMUPG003,PMPICLAM
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     PMUPG004,PMPIFUND
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     PMUPG005,PMPITABT
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     PMUPG006,PMPIEDAT
          GOTO      UPPIT999 IF NOT EQUAL
.
          MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            PACK      PMPIEDAT,EXPIRYDT,SP70     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            PACK      PMPIATYP,ADMNTYPE,SP70     * New admission type
          ENDIF
.
          PACK      KEY36,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,PMPIICNT,SP70
.
          CALL      UPPMPIT1
.
          GOTO      UPPIT000
.
UPPIT999  RETURN
.
.*******************************************************************************
. Check Program Interruption Details do not ovelap Existing Records   CAR 257776
.*******************************************************************************
CHOL0000  PACK      KEY36,PMPIT001,PMPIT002,PMPIT003,PMPIT004,PMPIT005:
                          SP70
          CALL      RSPMPIT1
CHOL1000  CALL      RKPMPIT1
          IF        OVRCD = 1
            GOTO      CHOL9000
          ENDIF
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      CHOL9000 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      CHOL1000 IF EQUAL
.
          MOVE      PMPIT009,ISTRTDTE
          MOVE      PMPIT010,IENDDATE
          IF        IENDDATE = 0
            MOVE      "99999999",IENDDATE
          ENDIF
          MOVE      PMPIFDAT,FSTRTDTE
          MOVE      PMPITDAT,FENDDATE
          IF        (ISTRTDTE < FSTRTDTE) & (IENDDATE < FSTRTDTE)
            GOTO      CHOL1000
          ENDIF
.
          IF        (ISTRTDTE > FENDDATE) & (IENDDATE > FENDDATE)
            GOTO      CHOL1000
          ENDIF
.
          MATCH     PMPIT007,PMPIICNT
          IF        @EQUAL
            GOTO      CHOL1000
          ENDIF
.
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            GOTO      CHOL9200
          ENDIF
.
CHOL9200  MOVE      "Interruption overlaps with exising records",WEBTITLE
.
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      CHOL9999
.
CHOL9000  MOVE      ZERO,EXIT
.
CHOL9999  RETURN
.
.*******************************************************************************
. Program FIM Details Maintenance                                     CAR 257776
.*******************************************************************************
PRFM0000  MATCH     SP70,UPDTTYPE
          GOTO      PRFM7000 IF EQUAL
.
          MATCH     "A",UPDTTYPE                 * Add FIM Details
          GOTO      PRFM1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE                 * Update FIM Details
          GOTO      PRFM2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete FIM Details
          GOTO      PRFM3000 IF EQUAL
.
          GOTO      PRFM9000
.
.-------------------------------------------------------------------------------
. Add new Program FIM Details
.-------------------------------------------------------------------------------
PRFM1000  PACK      KEY24,ADMISSNO,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          BRANCH    OVRCD,PRFM1010
.                                                * FIM record already exists
          MATCH     ONEINIT,PTFIDELT
          GOTO      PRFM9400 IF EQUAL
.
          GOTO      PRFM9500
.
PRFM1010  CALL      CLPATFIM                     * Clear File Variables
          CALL      MVPTFI00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PTFICDAT                * System date
          CLOCK     TIME,PTFICTIM                * System time
          MOVE      USERID,PTFICUID              * web user id
.
          CALL      WRPTFIM1                     * write new record
.
          MOVE      ZERO,EXIT
          GOTO      PRFM9999
.
.-------------------------------------------------------------------------------
. Update Program FIM Details
.-------------------------------------------------------------------------------
PRFM2000  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            GOTO      PRFM9200
          ENDIF
.
          CALL      MVPTFI00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PTFIUDAT                * System date
          CLOCK     TIME,PTFIUTIM                * System time
          MOVE      USERID,PTFIUUID              * web user id
.
          CALL      UPPTFIM1                     * update details
.
          MOVE      ZERO,EXIT
          GOTO      PRFM9999
.
.-------------------------------------------------------------------------------
. Delete Program FIM
.-------------------------------------------------------------------------------
PRFM3000  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            GOTO      PRFM9200
          ENDIF
.
          CALL      MVPTFI00                     * move cgi to file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PTFIDDAT                * System date
          CLOCK     TIME,PTFIDTIM                * System time
          MOVE      USERID,PTFIDUID              * web user id
.
          MOVE      ONEINIT,PTFIDELT             * Set Deleted flag
.
          CALL      UPPTFIM1                     * update details
.
          MOVE      ZERO,EXIT
          GOTO      PRFM9999
.
.-------------------------------------------------------------------------------
. List Program FIM
.-------------------------------------------------------------------------------
PRFM7000  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PRFM9300
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Program FIM Details",WEBTITLE
          RESET     WEBTITLE
.
          PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          IF        OVRCD=1
            CALL      CLPMSUPG
            GOTO      PRFM9100
          ENDIF
.
          PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMAPG1
          IF        OVRCD=1
            CALL      CLPAPG00
            GOTO      PRFM9100
          ENDIF
.
PRFM7100  PACK      KEY24,ADMISSNO,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
          CALL      WEBHED00                     * Create HTML File/Page Header
          BRANCH    EXIT,PRFM9999
          CALL      WEBBOD00                     * Process Web Body
          CALL      WEBEND00                     * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9100  MOVE      "FIM Program does not exist on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9200  MOVE      "FIM Details do not exist on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9300  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9400  CLEAR     WEBTITLE
          APPEND    "Deleted FIM Details Already exist for this date ",WEBTITLE
          APPEND    "and time. ", WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9500  CLEAR     WEBTITLE
          APPEND    "FIM Details Already exist for this date ",WEBTITLE
          APPEND    "and time. ", WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRFM9999
.
PRFM9999  RETURN
.
.-------------------------------------------------------------------------------
. Program Maintenance Comments
.-------------------------------------------------------------------------------
PMCOMM00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      PMCOMM80 IF EQUAL
.
          MATCH     "A",UPDTTYPE                 * Add Comments Formaction
          GOTO      PMCOMM10 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete Comments Formaction
          GOTO      PMCOMM30 IF EQUAL
.
          GOTO      PMCOMM92
.
.         ************ ADD FORMACTION ***********
.
PMCOMM10  CALL      CLPUDT00                     * Clear comment file variables
.
          CALL      ADDCOM00                     * Add Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      PMCOMM99
.
.         ************ DELETE FORMACTION **********
.
PMCOMM30  PACK      KEY40,PMUDT001,PMUDT002,PMUDT003,PMUDT004,PMUDT005:
                          PMUDT006,PMUDT007,PMUDT008,SP70
          CALL      RDPMUDT1
          BRANCH    OVRCD,PMCOMM90
.
          CALL      DELCOM00                     * Delete Note SubRoutine
          BRANCH    EXIT,PMCOMM99
.
          MOVE      ZERO,EXIT
          GOTO      PMCOMM99
.
.         ************ DISPLAY FORMACTION **********
.
PMCOMM80  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMUPG1
          BRANCH    OVRCD,PMCOMM93
.
          PACK      KEY40,PMUDT001,PMUDT002,PMUDT003,PMUDT004,PMUDT005:
                          PMUDT006,PMUDT007,PMUDT008,SP70
          CALL      RDPMUDT1
          IF        OVRCD=1
            CALL      CLPUDT00                   * Clear comment file variables
          ENDIF
.
          MOVE      "Comments Maintenance",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMCOMM99
          CALL      WEBBOD00                     * Process Web Body
          CALL      WEBEND00                     * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PMCOMM99
.
PMCOMM90  MOVE      "Invalid Program Maintenance Comment Key.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMCOMM99
.
PMCOMM92  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMCOMM99
.
PMCOMM93  MOVE      "Invalid Program Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMCOMM99
.
PMCOMM99  CLOSE     COMFILPG,DELETE    * Delete temp file created by GETPGC00
          RETURN
.
.-------------------------------------------------------------------------------
.  Write Program Maintenance Comments
.-------------------------------------------------------------------------------
ADDCOM00  MOVE      ZERO,F6
.
          PACK      KEY40,PMUDT001,PMUDT002,PMUDT003,PMUDT004,PMUDT005:
                          PMUDT006,PMUDT007,Z70
.
          CALL      RSPMUDT1
          CALL      RPPMUDT1                     * read back to get last record
          IF        OVRCD=1
            GOTO      ADDCOM10
          ENDIF
.
          MATCH     PMUTURNO,PMUDT001
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTATYP,PMUDT002
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTCTYP,PMUDT003
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTHFND,PMUDT004
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTHTAB,PMUDT005
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTEXPD,PMUDT006
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MATCH     PMUTCOMT,PMUDT007
          GOTO      ADDCOM10 IF NOT EQUAL
.
          MOVE      PMUTNNUM,F6
          ADD       ONE,F6
          GOTO      ADDCOM20
.
ADDCOM10  MOVE      ONE,F6
.
ADDCOM20  PACK      PMUTURNO,PMUDT001,SP70       * U/R Number
          PACK      PMUTATYP,PMUDT002,SP70       * Admission Type
          PACK      PMUTCTYP,PMUDT003,SP70       * Claim Type
          PACK      PMUTHFND,PMUDT004,SP70       * Health Fund
          PACK      PMUTHTAB,PMUDT005,SP70       * Health Fund Table Type
          PACK      PMUTEXPD,PMUDT006,SP70       * Expiry Date
          PACK      PMUTCOMT,PMUDT007,SP70       * Comment Type
          MOVE      F6,PMUTNNUM                  * Note Number
          MOVE      PMUDT009,PMUTIDAT            * Date
          MOVE      PMUDT010,PMUTITIM            * Time
          PACK      PMUTIUID,USERID,SP70         * Created by User
.
          MOVE      "0",PMUTDIND                 * Delete Indicator
          MOVE      SP70,PMUTDDAT                * Delete Date
          MOVE      SP70,PMUTDTIM                * Delete Time
          MOVE      SP70,PMUTDUID                * Deleted by User
          PACK      PMUTSPAR,SP70,SP70           * Spare
.
          PACK      KEY40,PMUTURNO,PMUTATYP,PMUTCTYP,PMUTHFND,PMUTHTAB:
                          PMUTEXPD,PMUTCOMT,PMUTNNUM,SP70
          CALL      RDPMUDT1
          IF        OVRCD=1
            CALL      WRPMUDT1                   * Write Record
          ELSE
            GOTO      ADDCOM99
          ENDIF
.
.         now write the prgram maintenance comment lines
.
          MOVE      PMUTURNO,PMUXURNO
          MOVE      PMUTATYP,PMUXATYP
          MOVE      PMUTCTYP,PMUXCTYP
          MOVE      PMUTHFND,PMUXHFND
          MOVE      PMUTHTAB,PMUXHTAB
          MOVE      PMUTEXPD,PMUXEXPD
          MOVE      PMUTCOMT,PMUXCOMT
          MOVE      PMUTNNUM,PMUXNNUM
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILPG,COMFILNW
          TRAPCLR   IO
          BRANCH    OVRCD,ADDCOM99
.
ADDCOM30  ADD       ONE,F3
          MOVE      F3,PMUXLNUM
.
          READ      COMFILPG,SEQ;PMUXCOMM
          GOTO      ADDCOM99 IF OVER
.
          MATCH     SP70,PMUXCOMM
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADDCOM30
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDCOM60                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADDCOM30          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDCOM60
          ENDIF
.
          MOVE      ZERO,BLNKFLAG
.
ADDCOM60  PACK      KEY43,PMUXURNO,PMUXATYP,PMUXCTYP,PMUXHFND,PMUXHTAB:
                          PMUXEXPD,PMUXCOMT,PMUXNNUM,PMUXLNUM,SP70
          CALL      WRPMUTX1
          IF        F3>=LASTITEM
            GOTO     ADDCOM99
          ENDIF
.
          GOTO      ADDCOM30
.
ADDCOM99  RETURN
.
.-------------------------------------------------------------------------------
. Delete a Program Maintenance Comment
.-------------------------------------------------------------------------------
DELCOM00  PACK      PMUTDDAT,CCC,CYY,CMM,CDD     * Delete Date
          REP       " 0",PMUTDDAT
          CLOCK     TIME,PMUTDTIM                * Delete Time
.
          PACK      PMUTDUID,USERID,SP70         * Deleted by
.
          MOVE      "1",PMUTDIND                 * Delete Indicator
.
          PACK      KEY40,PMUDT001,PMUDT002,PMUDT003,PMUDT004,PMUDT005:
                          PMUDT006,PMUDT007,PMUDT008,SP70
          CALL      UPPMUDT1                     * Write Record
          GOTO      DELCOM98
.
DELCOM98  MOVE      ZERO,EXIT
.
DELCOM99  RETURN
.
.*******************************************************************************
. Missing FIM Lists (Admission/Discharge)                             CAR 257776
.*******************************************************************************
MFIM0000  CALL      CURPER00
          CALL      CALCDT00                   * Calc Next & Last Period Dates
.
          CLEAR     WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                   * Create Output File and
          BRANCH    EXIT,MFIM9999              * Write HTML Page Header
.
          CALL      WEBBOD00                   * Process Web Body
.
          CALL      WEBEND00                   * Process End of HTML File
.
MFIM9999  RETURN
.
.*******************************************************************************
. Missing Admission FIM Details by Date Range                         CAR 257776
.*******************************************************************************
MAFD0000  BRANCH    FLDITMNO,MAFD0100,MAFD0200,MAFD0300,MAFD0400,MAFD0500:
                             MAFD0600,MAFD0700,MAFD0800
.
MAFD0100  CALL      NEXT0000
          GOTO      MAFD9999
.
MAFD0200  CALL      PREV0000
          GOTO      MAFD9999
.
MAFD0300  CALL      CURSTD00                   * Current Start Date
          GOTO      MAFD9999
.
MAFD0400  CALL      CUREND00                   * Current End Date
          GOTO      MAFD9999
.
MAFD0500  CALL      SELV0000                   * View Type (Day Week Month)
          GOTO      MAFD9999
.
MAFD0600  CALL      ADMF0000                   * Missing Admission FIM list
          GOTO      MAFD9999
.
MAFD0700  MOVE      CATAC,CATEGORY             * Unit Selection List
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      MAFD9999
.
MAFD0800  PACK      DFLTWARD,WARDCODE          * Ward Selection List
          CALL      WSEL0000
          GOTO      MAFD9999
.
MAFD9999  RETURN
.
.*******************************************************************************
. Table of Missing Admission FIM Details                              CAR 257776
.*******************************************************************************
ADMF0000  READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            MOVE      CATA,CARECATG
          ELSE
            MOVE      CATCC,CARECATG
          ENDIF
          MOVE      ZERO,ADMCNTR
.                                              * Check all admissions for period
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
ADMF1000  CALL      RDKMISS3
          BRANCH    OVRCD,ADMF9999
.
          ADD       ONE,ADMCNTR
          IF        (ADMCNTR%300) = 0
            WRITE     HTMLFILE;"// keep alive comment "
          ENDIF
.
          MATCH     ADATE,LASTDATE
          GOTO      ADMF9999 IF LESS            * EOF
.                                                                   * Car 274597
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      ADMF1000 IF NOT EQUAL
          ENDIF
.                                              * Admission records only
          IF        ASTAT<2 | ASTAT>4
            GOTO      ADMF1000                 * Next record loop
          ENDIF
.
          MATCH     "A ",CARECATG              * Read relevant category type
          IF        @EQUAL
            PACK      KEY5,CARECATG,ATYPE,SP70
          ELSE
            PACK      KEY5,CARECATG,ACARE,SP70
          ENDIF
.
          CALL      RDCODE1
          BRANCH    OVRCD,ADMF1000
.
          MATCH     "A ",CARECATG              * Identify Rehabilitation Visits
          IF        @EQUAL
            MATCH     "9",TCINDC8
            GOTO      ADMF2000 IF EQUAL
          ELSE
            MATCH     "2",TCINDC6
            GOTO      ADMF2000 IF EQUAL
          ENDIF
.
          GOTO      ADMF1000                   * Next record loop
.
ADMF2000  PACK      KEY30,DAADMNO,SP70         * Get relevant transfer info
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,ADMF1000
.
          MATCH     "A",TMOVE                 * check adm record exists
          GOTO      ADMF1000 IF NOT EQUAL
.
          MATCH     DTADMN,DAADMNO
          IF        @EQUAL
            MOVE      TWARD,AWARD
            MOVE      TBED,ABED
            MOVE      TDEPT,ACLSSFT
            MOVE      TADOCT,ADOCTA
          ENDIF
.                                              * Check if unit matches selection
ADMF2500  MATCH     SP3,UNITCODE
          IF        !@EQUAL
            MATCH     ACLSSFT,UNITCODE
            GOTO      ADMF1000 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Check if ward matches selection
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      ADMF1000 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Check for Admission FIM Details
          PACK      KEY24,DAADMNO,SP70
          CALL      RSPTFIM1
ADMF3000  CALL      RKPTFIM1
          BRANCH    OVRCD,ADMF7000
.
          MATCH     PTFIVISN,DAADMNO
          GOTO      ADMF7000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      ADMF3000 IF EQUAL
.
          MATCH     "A",PTFITYPE
          GOTO       ADMF1000 IF EQUAL
.
ADMF7000  CALL      ADMCON00                   * Output row if no Adm FIM exists
.
          GOTO      ADMF1000                   * loop to next record
.
ADMF9999  RETURN
.
.*******************************************************************************
. Table of Missing Admission FIM Details Content                      CAR 257776
.*******************************************************************************
ADMCON00  MOVE      DAADMNO,KEY8               * Get Discharge Date if exists
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MOVE      AURNO,KEY8
          CALL      FMFT0000                   * Format output fields
.
          MOVE      SP70,DISPRHDT
          MOVE      SP70,DISPRDDT
.
ADMCON10  PACK      KEY31,AURNO,SP70
          CALL      RSPMUPG1
ADMCON20  CALL      RKPMUPG1
          BRANCH    OVRCD,ADMCON90
.
          MATCH     PMUGURNO,AURNO
          GOTO      ADMCON90 IF NOT EQUAL
.
          MATCH     PMUGSDAT,ADATE
          GOTO      ADMCON20 IF LESS             * Next UPG record loop
.
          MATCH     SP70,PMUGEDAT
          GOTO      ADMCON50 IF EQUAL
.
          MATCH     ADATE,PMUGEDAT
          GOTO      ADMCON90 IF LESS             * UPG record found
.
          GOTO      ADMCON20                     * Next UPG record loop
.                                                                     Car 272964
ADMCON50  MATCH     SP70,PMUGRPDT
          IF        !@EQUAL
            UNPACK    PMUGRPDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPRHDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.                                                                     Car 272964
          MATCH     SP70,PMUGRDDT
          IF        !@EQUAL
            UNPACK    PMUGRDDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPRDDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
ADMCON90  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     HTMLLINK
          APPEND    "javascript:programSummary('",HTMLLINK
          APPEND    DAADMNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    AURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGATYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGCLAM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGFUND,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGTABT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                                      "#"",FORMATNM,"#",":       * 1
                                      "#"",DAADMNO,"#",":        * 2
                                      "#"",DISPDACT,ATIME,"#",": * 3
                                      "#"",DISPDDSC,DTIME,"#",": * 4
                                      "#"",DOCFNAME,"#",":       * 5
                                      "#"",TDESC,"#",":          * 6
                                      "#"",WBDESC,"#",":         * 7
                                      "#"",DISPRHDT,"#",":       * 8
                                      "#"",DISPRDDT,"#",":       * 9
                                      "#"",KEY3,"#");"           * 10
.
ADMCON99  RETURN
.
.*******************************************************************************
. Missing Discharge FIM Details by Date Range                         CAR 257776
.*******************************************************************************
MDFD0000  BRANCH    FLDITMNO,MDFD0100,MDFD0200,MDFD0300,MDFD0400,MDFD0500:
                             MDFD0600,MDFD0700,MDFD0800
.
MDFD0100  CALL      NEXT0000
          GOTO      MDFD9999
.
MDFD0200  CALL      PREV0000
          GOTO      MDFD9999
.
MDFD0300  CALL      CURSTD00                   * Current Start Date
          GOTO      MDFD9999
.
MDFD0400  CALL      CUREND00                   * Current End Date
          GOTO      MDFD9999
.
MDFD0500  CALL      SELV0000                   * View Type (Day Week Month)
          GOTO      MDFD9999
.
MDFD0600  CALL      DSCF0000                   * Missing Discharge FIM list
          GOTO      MDFD9999
.
MDFD0700  MOVE      CATAC,CATEGORY             * Unit Selection List
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      MDFD9999
.
MDFD0800  PACK      DFLTWARD,WARDCODE          * Ward Selection List
          CALL      WSEL0000
          GOTO      MDFD9999
.
MDFD9999  RETURN
.
.*******************************************************************************
. List of rehab patients whao have a FIM Score but are not linked to a program
.*******************************************************************************
MPGM0000  CALL      CURPER00
          CALL      CALCDT00                   * Calc Next & Last Period Dates
.
          CLEAR     WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                   * Create Output File and
          BRANCH    EXIT,MPGM9999              * Write HTML Page Header
.
          CALL      WEBBOD00                   * Process Web Body
.
          CALL      WEBEND00                   * Process End of HTML File
.
MPGM9999  RETURN
.
.*******************************************************************************
. Missing Admission FIM Details by Date Range                         CAR 257776
.*******************************************************************************
NPGM0000  BRANCH    FLDITMNO,NPGM0100,NPGM0200,NPGM0300,NPGM0400,NPGM0500:
                             NPGM0600,NPGM0700
.
NPGM0100  CALL      NEXT0000
          GOTO      NPGM9999
.
NPGM0200  CALL      PREV0000
          GOTO      NPGM9999
.
NPGM0300  CALL      CURSTD00                   * Current Start Date
          GOTO      NPGM9999
.
NPGM0400  CALL      CUREND00                   * Current End Date
          GOTO      NPGM9999
.
NPGM0500  CALL      SELV0000                   * View Type (Day Week Month)
          GOTO      NPGM9999
.
NPGM0600  CALL      MSPG0000                   * Missing Program list
          GOTO      NPGM9999
.
NPGM0700  MOVE      CATA,CATEGORY              * Admission Type Selection List
          MOVE      ADMSTYPE,CODE
          CALL      CODSEL00
          GOTO      NPGM9999
.
NPGM9999  RETURN
.
.*******************************************************************************
. Table of Discharged Patients with FIM Records
.*******************************************************************************
MSPG0000  MOVE      ZERO,ADMCNTR
.                                              * Check all discharges for period
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSDSCH2
MSPG1000  CALL      RDKDSCH2
          BRANCH    OVRCD,MSPG9999
.
          MATCH     DDATE,LASTDATE
          GOTO      MSPG9999 IF LESS           * EOF
.
          ADD       ONE,ADMCNTR
          IF        (ADMCNTR%300) = 0
            WRITE     HTMLFILE;"// keep alive comment "
          ENDIF
.                                              * Check Admission type
          PACK      KEY8,DURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MSPG1000
.
          PACK      KEY24,DDADMNO,SP70
          CALL      RSPTFIM1
MSPG2000  CALL      RKPTFIM1
          BRANCH    OVRCD,MSPG1000
.
          MATCH     PTFIVISN,DDADMNO
          GOTO      MSPG1000 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      MSPG2000 IF EQUAL
.                                              * Get Admission record
          PACK      KEY8,DDADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MSPG1000
.
          MATCH     SP10,ADMSTYPE
          IF        !@EQUAL
            MATCH     ATYPE,ADMSTYPE
            GOTO      MSPG1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MSPG1000
.                                              * Check if a Rehab Patient
          MATCH     "2",TCINDC6
          GOTO      MSPG1000 IF NOT EQUAL
.
          PACK      KEY31,AURNO,SP70
          CALL      RSPMUPG1
MSPG3000  CALL      RKPMUPG1
          BRANCH    OVRCD,MSPG3500
.
          MATCH     PMUGURNO,AURNO
          GOTO      MSPG3500 IF NOT EQUAL
.
          MATCH     PMUGATYP,ATYPE
          IF        !@EQUAL
            GOTO      MSPG3000
          ENDIF
.
          MATCH     PMUGSDAT,ADATE
          GOTO      MSPG3000 IF LESS
.
          MATCH     SP70,PMUGENDD
          IF        !@EQUAL
            MATCH     PMUGENDD,ADATE
            GOTO      MSPG3000 IF NOT LESS
          ENDIF
          GOTO      MSPG1000
.                                              * Format Patient Name
MSPG3500  CALL      PATLN000
.                                              * KEY3 for folder colour code
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PATFLD00
.                                              * Format Doctor Name
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                              * Format Admission Date
          PACK      DISPDACT,SP70
          MATCH     ADATE,SP70
          GOTO      MSPG4000 IF EQUAL
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.                                              * Format Discharge Date
MSPG4000  PACK      DISPDDSC,SP70
          MATCH     DDATE,SP70
          GOTO      MSPG5000 IF EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
MSPG5000  PACK      KEY5,CATA,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     HTMLLINK
          APPEND    "javascript:patientPMI('",HTMLLINK
          APPEND    AURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DAADMNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                                      "#"",FORMATNM,"#",":       * 1
                                      "#"",DAADMNO,"#",":        * 2
                                      "#"",DISPDACT,ATIME,"#",": * 3
                                      "#"",DISPDDSC,DTIME,"#",": * 4
                                      "#"",DOCFNAME,"#",":       * 5
                                      "#"",DYES,"#",":           * 6
                                      "#"",TDESC,"#",":          * 7
                                      "#"",KEY3,"#");"           * 8
.
          GOTO      MSPG1000                   * loop to next record
.
MSPG9999  RETURN
.
.-------------------------------------------------------------------------------
. Display List of Program Maintenance Comments
.-------------------------------------------------------------------------------
PRGCTB00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Date</td>":
                             "<td class=HeadingCell width=20%>Input By</td>":
                             "<td class=HeadingCell width=40%>Notes</td>":
                             "<td class=HeadingCell width=20%>Deleted By</td>":
                             "</tr>";
.
          PACK      KEY40,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMUDT1
PRGCTB10  CALL      RKPMUDT1
          BRANCH    OVRCD,PRGCTB99
.
          MATCH     PMUTURNO,PMUPG001
          GOTO      PRGCTB99 IF NOT EQUAL
.
          MATCH     PMUTATYP,PMUPG002
          GOTO      PRGCTB99 IF NOT EQUAL
.
          MATCH     PMUTCTYP,PMUPG003
          GOTO      PRGCTB99 IF NOT EQUAL
.
          MATCH     PMUTHFND,PMUPG004
          GOTO      PRGCTB99 IF NOT EQUAL
.
          MATCH     PMUTHTAB,PMUPG005
          GOTO      PRGCTB99 IF NOT EQUAL
.
          MATCH     PMUTEXPD,PMUPG006
          GOTO      PRGCTB99 IF NOT EQUAL
.                                                * reformat Expiry Date
          MOVE      "&nbsp;",WBSENAMC
          MOVE      "&nbsp;",WBSENAMD
          MOVE      "",STRIKETG
          MOVE      "",STRENDTG

          MATCH     "1",PMUTDIND
          IF        @EQUAL
            MOVE      "<strike>",STRIKETG
            MOVE      "</strike>",STRENDTG
.
            PACK      WBSENAM,SP70
            PACK      KEY10,PMUTDUID,SP70
.
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      "Invalid User",WBSENAM
            ENDIF
.
            PACK      WBSENAMD,WBSENAM,SP70
          ENDIF
.
          PACK      DISPDATE,SP70
          UNPACK    PMUTIDAT,CCENT,CYEAR,CMON,CDAY  * reformat create Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      DISPTIME,PMUTITIM,SP70
.
          PACK      WBSENAM,SP70
          PACK      KEY10,PMUTIUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          PACK      WBSENAMC,WBSENAM,SP70
.
          CLEAR     DISPCOMM
          CALL      PMLCMT00
          RESET     DISPCOMM
.
          PACK      DISPDTE1,SP70
          MATCH     SP70,PMUTEXPD
          IF        !@EQUAL
            UNPACK    PMUTEXPD,CCENT,CYEAR,CMON,CDAY  * reformat create Date
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDTE1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap valign=#"top#">":
                             "<img src=../images/MaintenanceIcon.gif ":
                             "class=ListIcon ":
                             "onclick=#"pgmComments('",PMUTURNO:
                             "','",PMUTATYP:
                             "','",PMUTCTYP:
                             "','",PMUTHFND:
                             "','",PMUTHTAB:
                             "','",PMUTEXPD:
                             "','",PMUTCOMT:
                             "','",PMUTNNUM:
                             "','",DISPDTE1,"')#">":
                             STRIKETG,DISPDATE,SP1,DISPTIME,"</td>":
                     "<td valign=#"top#">",STRIKETG,WBSENAMC,STRENDTG,"</td>":
                     "<td valign=#"top#">",STRIKETG,DISPCOMM,STRENDTG,"</td>":
                     "<td valign=#"top#">",WBSENAMD,"</td>":
                             "</tr>";
.
          GOTO      PRGCTB10
.
PRGCTB99  RETURN
.
.-------------------------------------------------------------------------------
. Display Program Maintenance Comment Line
.-------------------------------------------------------------------------------
PMLCMT00  PACK      KEY43,PMUTURNO,PMUTATYP,PMUTCTYP,PMUTHFND,PMUTHTAB:
                          PMUTEXPD,PMUTCOMT,PMUTNNUM,SP70
.
          CALL      RSPMUTX1
PMLCMT10  CALL      RKPMUTX1
          BRANCH    OVRCD,PMLCMT99
.
          MATCH     PMUTURNO,PMUXURNO
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTATYP,PMUXATYP
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTCTYP,PMUXCTYP
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTHFND,PMUXHFND
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTHTAB,PMUXHTAB
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTEXPD,PMUXEXPD
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTCOMT,PMUXCOMT
          GOTO      PMLCMT99 IF NOT EQUAL
.
          MATCH     PMUTNNUM,PMUXNNUM
          GOTO      PMLCMT99 IF NOT EQUAL
.
          STRIP     PMUXCOMM
          MOVELPTR  PMUXCOMM,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          APPEND    PMUXCOMM,DISPCOMM
          APPEND    BR,DISPCOMM
          GOTO      PMLCMT10
.
PMLCMT99  RETURN
.
.------------------------------------------------------------
. Get Program Maintenance Comments
.------------------------------------------------------------
GETPGC00  PREP      COMFILPG,COMFILNW
          MOVE      ONE,F3
          WRITE     COMFILPG,SEQ;QRYDATA
.
GETPGC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPGC90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPGC80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILPG,SEQ;QRYDATA
          GOTO      GETPGC10
.
GETPGC80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
.
GETPGC90  MOVE      F3,LASTITEM
          OPEN      COMFILPG,COMFILNW
.
GETPGC99  RETURN
.
.*******************************************************************************
. Table of Missing Discharge FIM Details                              CAR 257776
.*******************************************************************************
DSCF0000  READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            MOVE      CATA,CARECATG
          ELSE
            MOVE      CATCC,CARECATG
          ENDIF
.                                              * Check all discharges for period
          MOVE      ZERO,ADMCNTR
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSDSCH2
DSCF1000  CALL      RDKDSCH2
          BRANCH    OVRCD,DSCF9999
.
          MATCH     DDATE,LASTDATE
          GOTO      DSCF9999 IF LESS           * EOF
.
          ADD       ONE,ADMCNTR
          IF        (ADMCNTR%300) = 0
            WRITE     HTMLFILE;"// keep alive comment "
          ENDIF
.
          PACK      KEY8,DDADMNO,SP70          * Get the Admission Record
          CALL      RDMISS1
          BRANCH    OVRCD,DSCF9999
.                                                                   * Car 274597
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      DSCF1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "A ",CARECATG              * Read relevant category type
          IF        @EQUAL
            PACK      KEY5,CARECATG,ATYPE,SP70
          ELSE
            PACK      KEY5,CARECATG,ACARE,SP70
          ENDIF
.
          CALL      RDCODE1
          BRANCH    OVRCD,DSCF9999
.
          MATCH     "A ",CARECATG              * Check if Rehabilitation Visit
          IF        @EQUAL
            MATCH     "9",TCINDC8
            GOTO      DSCF2000 IF EQUAL
          ELSE
            MATCH     "2",TCINDC6
            GOTO      DSCF2000 IF EQUAL
          ENDIF
.
          GOTO      DSCF8000                   * Next record loop
.
DSCF2000  PACK      KEY30,DDADMNO,Z70          * Get relevant transfer info
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,DSCF8000
.
          MATCH     "D",TMOVE                  * check discharge record exists
          GOTO       DSCF8000 IF NOT EQUAL
.
          MATCH     DTADMN,DDADMNO
          IF        @EQUAL
            MOVE      TWARD,AWARD
            MOVE      TBED,ABED
            MOVE      TDEPT,ACLSSFT
            MOVE      TADOCT,ADOCTA
          ENDIF
.                                              * Check if unit matches selection
DSCF2500  MATCH     SP3,UNITCODE
          IF        !@EQUAL
            MATCH     ACLSSFT,UNITCODE
            GOTO      DSCF8000 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Check if ward matches selection
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      DSCF8000 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Check for Discharge FIM Details
          PACK      FIMSCORD,SP70
          PACK      KEY24,DDADMNO,SP70
          CALL      RSPTFIM1
DSCF3000  CALL      RKPTFIM1
          BRANCH    OVRCD,DSCF7000
.
          MATCH     PTFIVISN,DDADMNO
          GOTO      DSCF7000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      DSCF3000 IF EQUAL
.
          MATCH     "P",PTFITYPE
          GOTO       DSCF3000 IF EQUAL
.
          MATCH     "A",PTFITYPE
          IF        @EQUAL
            MOVE      ZERO,FIMSCORE
            ASSIGN    PTFIEATS+PTFIGRMS+PTFIBTHS+FIMSCORE,FIMSCORE
            ASSIGN    PTFIUPBS+PTFILWBS+PTFITLTS+FIMSCORE,FIMSCORE
            ASSIGN    PTFIBLMS+PTFIBWMS+PTFITBDS+FIMSCORE,FIMSCORE
            ASSIGN    PTFITTLS+PTFITBTS+PTFILOCS+FIMSCORE,FIMSCORE
            ASSIGN    PTFISTRS+PTFICOMS+PTFIEXPS+FIMSCORE,FIMSCORE
            ASSIGN    PTFISCIS+PTFIPRBS+PTFIMEMS+FIMSCORE,FIMSCORE
            MOVE      FIMSCORE,FIMSCORD
            GOTO      DSCF3000
          ENDIF
.
          GOTO      DSCF8000
.                                              * Output row if no Dsc FIM exists
DSCF7000  CALL      DSCCON00
.
DSCF8000  GOTO      DSCF1000                   * loop to next discharge record
.
DSCF9999  RETURN
.
.*******************************************************************************
. Table of Missing Discharge FIM Details Content                      CAR 257776
.*******************************************************************************
DSCCON00  MOVE      DURNO,KEY8
          CALL      FMFT0000                   * Format output fields
.
          MOVE      SP70,DISPRHDT
          MOVE      SP70,DISPRDDT
.
DSCCON10  PACK      KEY31,DURNO,SP70
          CALL      RSPMUPG1
DSCCON20  CALL      RKPMUPG1
          BRANCH    OVRCD,DSCCON90
.
          MATCH     PMUGURNO,DURNO
          GOTO      DSCCON90 IF NOT EQUAL
.
          MATCH     PMUGSDAT,DDATE
          GOTO      DSCCON20 IF LESS             * Next UPG record loop
.
          MATCH     SP70,PMUGEDAT
          GOTO      DSCCON50 IF EQUAL
.
          MATCH     DDATE,PMUGEDAT
          GOTO      DSCCON90 IF LESS             * UPG record found
.
          GOTO      DSCCON20                     * Next UPG record loop
.                                                                     Car 272964
DSCCON50  MATCH     SP70,PMUGRPDT
          IF        !@EQUAL
            UNPACK    PMUGRPDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPRHDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.                                                                     Car 272964
          MATCH     SP70,PMUGRDDT
          IF        !@EQUAL
            UNPACK    PMUGRDDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPRDDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
DSCCON90  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     HTMLLINK
          APPEND    "javascript:programSummary('",HTMLLINK
          APPEND    DDADMNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGATYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGCLAM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGFUND,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGTABT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                                      "#"",FORMATNM,"#",":       * 1
                                      "#"",DDADMNO,"#",":        * 2
                                      "#"",DISPDACT,ATIME,"#",": * 3
                                      "#"",DISPDDSC,DTIME,"#",": * 4
                                      "#"",DOCFNAME,"#",":       * 5
                                      "#"",FIMSCORD,"#",":       * 6
                                      "#"",TDESC,"#",":          * 7
                                      "#"",WBDESC,"#",":         * 8
                                      "#"",DISPRHDT,"#",":       * 9
                                      "#"",DISPRDDT,"#",":       * 10
                                      "#"",KEY3,"#");"           * 11
.
DSCCON99  RETURN
.
.*******************************************************************************
. Format Missing FIM Details Table Content                            CAR 257776
.*******************************************************************************
FMFT0000  CALL      RDMAST1                      * Get Patient Details
          MOVE      OVRCD,MASTFLAG
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.                                                * Format Doctor Name
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                                * calc patient age
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CURRDATE,SP10      * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.                                                * Format Patient Name
          CALL      PATLN000
.                                                * KEY3 for folder colour code
          CALL      PATFLD00
.                                                * Get Unit Description
          MOVE      CATAC,CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
.                                                * Get Ward Description
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            MOVE      SP70,WBDESC
          ENDIF
.                                                * Format Admission Date
          PACK      DISPDACT,SP70
          MATCH     ADATE,SP70
          GOTO      FMFT1000 IF EQUAL
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.                                                * Format Discharge Date
FMFT1000  PACK      DISPDDSC,SP70
          PACK      DDATE,DDATE,SP70
          MATCH     SP70,DDATE
          GOTO      FMFT9999 IF EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          GOTO      FMFT9999                     * Next UPG record loop
.
FMFT9000  CALL      CLPUPG00
.
FMFT9999  RETURN
.
.*******************************************************************************
.  Ward Selection List Routine                                        CAR 257776
.*******************************************************************************
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.                                                * do not use bed records
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 * List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.                                                * write the select options
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.*******************************************************************************
. Patient level program list
.*******************************************************************************
UPRG0000  PACK      KEY31,URNUMBER,FILTATYP,SP70
          CALL      RSPMUPG1
UPRG1000  CALL      RKPMUPG1
          BRANCH    OVRCD,UPRG9999
.
          MATCH     URNUMBER,PMUGURNO
          GOTO      UPRG9999 IF NOT EQUAL
.
          MATCH     SP70,FILTATYP
          IF        !@EQUAL
            MATCH     FILTATYP,PMUGATYP
            GOTO      UPRG9999 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,ATYPDESC
          MOVE      " ",NONREHAB
          MATCH     SP70,PMUGATYP
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,PMUGATYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUGATYP,TDESC
              MOVE      SP70,TCINDC13
            ENDIF
            MOVE      TDESC,ATYPDESC
            UNPACK    TCINDC13,NONREHAB
          ENDIF
.
          MOVE      SP70,CLAMDESC
          MATCH     SP70,PMUGCLAM
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PMUGCLAM,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUGCLAM,TDESC
            ENDIF
            MOVE      TDESC,CLAMDESC
          ENDIF
.
          MOVE      SP70,TABTDESC
          MATCH     SP70,PMUGTABT
          IF        !@EQUAL
            PACK      KEY5,ANSH,ANST,PMUGTABT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUGTABT,TDESC
            ENDIF
            MOVE      TDESC,TABTDESC
          ENDIF
.
          MOVE      SP70,DIM20
          PACK      KEY14,PMUGFUND,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      PMUGFUND,HFNAME
          ELSE
            PACK      DIM20,HFNAME,SP70
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            UNPACK    PMUGEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      DNO,BRKODESC
          MATCH     "1",PMUGBRKO
          IF        @EQUAL
            MOVE      DYES,BRKODESC
          ENDIF
.
          WRITE     HTMLFILE;"// keep alive comment "
          MOVE      ZERO,NEWVISIT           * Don't include new pre adm in count
          CALL      CINP0000                * Valid program so count IP visits
          MOVE      ZERO,NEWVISIT           * Don't include new booking in count
          CALL      COUT0000                * Valid program so count OP visits
.
          CLEAR     HTMLLINK
          MATCH     "N",NONREHAB
          IF        @EQUAL
            APPEND    "javascript:UpdateNonRehab('",HTMLLINK
          ELSE
            APPEND    "javascript:UpdateProgram('",HTMLLINK
          ENDIF
          APPEND    PMUGURNO,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUGATYP,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUGCLAM,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUGFUND,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUGTABT,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                                      "#"",PMUGURNO,"#",":      * 1
                                      "#"",PMUGATYP,"#",":      * 2
                                      "#"",ATYPDESC,"#",":      * 3
                                      "#"",PMUGCLAM,"#",":      * 4
                                      "#"",CLAMDESC,"#",":      * 5
                                      "#"",PMUGFUND,"#",":      * 6
                                      "#"",DIM20,"#",":        * 7
                                      "#"",PMUGTABT,"#",":      * 8
                                      "#"",TABTDESC,"#",":      * 9
                                      "#"",PMUGEDAT,"#",":      * 10
                                      "#"",PMUGMAXI,"#",":      * 11
                                      "#"",PMUGWARI,"#",":      * 12
                                      "#"",PMUGMANI,"#",":      * 13
                                      "#"",PMUGMAXO,"#",":      * 14
                                      "#"",PMUGWARO,"#",":      * 15
                                      "#"",PMUGMANO,"#",":      * 16
                                      "#"",PMUGBRKO,"#",":      * 17
                                      "#"",PMUGEXTD,"#",":      * 18
                                      "#"",PMUGSDAT,"#",":      * 19
                                      "#"",PMUGPNAM,"#",":      * 20
                                      "#"",IPVCOUNT,"#",":      * 21
                                      "#"",OPVCOUNT,"#",":      * 22
                                      "#"",BRKODESC,"#");"      * 23
.
          GOTO      UPRG1000
.
UPRG9999  RETURN
.
.
.*******************************************************************************
. Patient level OP program breakdown list
.*******************************************************************************
OPRG0000  PACK      KEY34,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RSPMUPO1
OPRG1000  CALL      RKPMUPO1
          BRANCH    OVRCD,OPRG9999
.
          MATCH     PMUGURNO,PMUOURNO
          GOTO      OPRG9999 IF NOT EQUAL
.
          MATCH     PMUGATYP,PMUOATYP
          GOTO      OPRG9999 IF NOT EQUAL
.
          MATCH     PMUGCLAM,PMUOCLAM
          GOTO      OPRG9999 IF NOT EQUAL
.
          MATCH     PMUGFUND,PMUOFUND
          GOTO      OPRG9999 IF NOT EQUAL
.
          MATCH     PMUGTABT,PMUOTABT
          GOTO      OPRG9999 IF NOT EQUAL
.
          MATCH     PMUGEDAT,PMUOEDAT
          GOTO      OPRG9999 IF NOT EQUAL
.
          MOVE      SP70,VTYPDESC
          MATCH     SP70,PMUOVTYP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,PMUOVTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUOVTYP,TDESC
            ENDIF
            MOVE      TDESC,VTYPDESC
          ENDIF
.
          MOVE      ZERO,NEWVISIT           * Don't include new booking in count
          CALL      COBK0000                * Valid progam so count OP
.                                           * breakdown visits
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMUOEDAT
          IF        !@EQUAL
            UNPACK    PMUOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateOPProgram('",HTMLLINK
          APPEND    PMUOURNO,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUOATYP,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUOCLAM,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUOFUND,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUOTABT,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMUOVTYP,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                                      "#"",PMUOVTYP,"#",":      * 1
                                      "#"",VTYPDESC,"#",":      * 2
                                      "#"",PMUOMAXO,"#",":      * 3
                                      "#"",PMUOWARO,"#",":      * 4
                                      "#"",PMUOMANO,"#",":      * 5
                                      "#"",OPVCOUNT,"#");"      * 6
.
          GOTO      OPRG1000
.
OPRG9999  RETURN
.
.*******************************************************************************
. Display visits for a program record                                 CAR 257776
.*******************************************************************************
DIPV0000  PACK      KEY24,PURNO,PMUGSDAT,SP70
          CALL      RDSVISA2
DIPV1000  CALL      RDKVISA2
          BRANCH    OVRCD,DIPV9999
.
          MATCH     PURNO,PVIURNO
          GOTO      DIPV9999 IF NOT EQUAL
.
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            MATCH     PVIDATE,PMUGEDAT
            GOTO      DIPV9999 IF LESS
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      DIPV1000 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL
          CALL      RDPTMIS1
          BRANCH    OVRCD,DIPV1000
.
          BRANCH    ASTAT,DIPV1000,DIPV2000,DIPV2000,DIPV2000,DIPV1000
          GOTO      DIPV1000
.-------------------------------------------------------------------------------
. check that visit is valid for this program
.-------------------------------------------------------------------------------
DIPV2000  MATCH     PMUGATYP,ATYPE
          GOTO      DIPV1000 IF NOT EQUAL
.
          MATCH     SP70,PMUGCLAM
          IF        !@EQUAL
            MATCH     PMUGCLAM,ACLAIM
            GOTO      DIPV1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGFUND
          IF        !@EQUAL
            MATCH     PMUGFUND,AFUNDH
            GOTO      DIPV1000 IF NOT EQUAL
.
            PACK      KEY14 WITH AFUNDH,AFNDTB,SP10
            CALL      RDFUND1
            BRANCH    OVRCD,DIPV1000
.
            MATCH     PMUGTABT,PTHFBCAT
            GOTO      DIPV1000 IF NOT EQUAL
          ENDIF
.
.-------------------------------------------------------------------------------
. get attending doctor name
.-------------------------------------------------------------------------------
DIPV3000  MOVE      SP70,DOCFNAME
          MOVE      SP70,ADOCNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      ADOCNAME,DOCFNAME
          ENDIF
.
.-------------------------------------------------------------------------------
. get patient visit discharge date if it exists
.-------------------------------------------------------------------------------
.
DIPV4000  MOVE      DAADMNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.-------------------------------------------------------------------------------
. output visit details to table
.-------------------------------------------------------------------------------
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            UNPACK    PMUGEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.                                        * Check if FIM Scores exist? CAR 277015
          MATCH     "0",FSCORESY
          IF        @EQUAL
            CALL      CFSC0000
          ENDIF
.
          MOVE      ONEINIT,VSTEXIST                                * CAR 273161
.
          CLEAR     HTMLLINK
          APPEND    "javascript:FIMDetails('",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGATYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGCLAM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGFUND,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGTABT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                                      "#"",PVIBILL,"#",":       * 1
                                      "#"",ADATE,"#",":         * 2
                                      "#"",DDATE,"#",":         * 3
                                      "#"",DOCFNAME,"#");"      * 4
.
.-------------------------------------------------------------------------------
. loop until all visits have been processed
.-------------------------------------------------------------------------------
          GOTO DIPV1000
.
DIPV9999  RETURN
.
.*******************************************************************************
. Display visits for a U/R within the program record date range
.*******************************************************************************
DIAV0000  PACK      KEY24,PURNO,PMUGSDAT,SP70
          CALL      RDSVISA2
DIAV1000  CALL      RDKVISA2
          BRANCH    OVRCD,DIAV9999
.
          MATCH     PURNO,PVIURNO
          GOTO      DIAV9999 IF NOT EQUAL
.
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            MATCH     PVIDATE,PMUGEDAT
            GOTO      DIAV9999 IF LESS
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      DIAV1000 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL
          CALL      RDPTMIS1
          BRANCH    OVRCD,DIAV1000
.
          BRANCH    ASTAT,DIAV1000,DIAV2000,DIAV2000,DIAV2000,DIAV1000
                    GOTO      DIAV1000
.
.-------------------------------------------------------------------------------
. get attending doctor name
.-------------------------------------------------------------------------------
DIAV2000  MOVE      SP70,DOCFNAME
          MOVE      SP70,ADOCNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      ADOCNAME,DOCFNAME
          ENDIF
.
.-------------------------------------------------------------------------------
. get patient visit discharge date if it exists
.-------------------------------------------------------------------------------
.
DIAV3000  MOVE      DAADMNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.-------------------------------------------------------------------------------
. get patient visit admisstion type
.-------------------------------------------------------------------------------
.
DIAV4000  PACK      KEY5,CATA,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
.-------------------------------------------------------------------------------
. get patient visit hospital for multi hospital
.-------------------------------------------------------------------------------
.
DIAV5000  COMPARE   IBCNMHOS,ZERO
          GOTO      DIAV9000 IF EQUAL
.
          MOVE      PMVXMHOS,KEY3
          CALL      RDPTHSP1
          IF        OVRCD=1
            PACK      PTHSNAME,SP70
          ENDIF
.
.-------------------------------------------------------------------------------
. output visit details to table
.-------------------------------------------------------------------------------
.
DIAV9000  MOVE      SP70,DISPDATE
          MATCH     SP70,ADATE
          IF        !@EQUAL
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DISPDTE1
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDTE1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          IF        IBCNMHOS=0
            WRITE     HTMLFILE;"<tr><td>",PVIBILL,"</td>":
                               "<td>",DISPDATE,"</td>":
                               "<td>",DISPDTE1,"</td>":
                               "<td>",TDESC,"&nbsp;</td>":
                               "<td>",ADOCNAME,"&nbsp;</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>",PVIBILL,"</td>":
                               "<td>",DISPDATE,"</td>":
                               "<td>",DISPDTE1,"</td>":
                               "<td>",PTHSNAME,"&nbsp;</td>":
                               "<td>",TDESC,"&nbsp;</td>":
                               "<td>",ADOCNAME,"&nbsp;</td>":
                               "</tr>"
          ENDIF
.
.-------------------------------------------------------------------------------
. loop until all relevant visits have been processed
.-------------------------------------------------------------------------------
          GOTO DIAV1000
.
DIAV9999  RETURN.
.*******************************************************************************
. Check if any FIM score exists                                       CAR 277015
.*******************************************************************************
CFSC0000  PACK      SAVKEY24,PTFIVISN,PTFIDATE,PTFITIME
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CFSC1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CFSC8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CFSC8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CFSC1000 IF EQUAL
.
          MOVE      ONEINIT,FSCORESY
.                                              * Re-read original record in case
CFSC8000  PACK      KEY24,SAVKEY24,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
CFSC9999  RETURN
.
.*******************************************************************************
. Display program interruptions list                                  CAR 257776
.*******************************************************************************
DPIL0000  PACK      KEY36,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RSPMPIT1
DPIL1000  CALL      RKPMPIT1
          BRANCH    OVRCD,DPIL9999
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      DPIL9999 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      DPIL1000 IF EQUAL
.
.-------------------------------------------------------------------------------
. output program interrupted details to table
.-------------------------------------------------------------------------------
.                                                * Reason For Interruption Descr
          MOVE      SP70,REASNDSC
          MATCH     SP70,PMPIRINT
          IF        !@EQUAL
            PACK      KEY5,CATRZ,PMPIRINT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMPIRINT,TDESC
            ENDIF
          ENDIF
          MOVE      PTCDLDES,REASNDSC
.                                                * reformat Expiry Date
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            UNPACK    PMUGEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:updatePGMInterrupt('",HTMLLINK
          APPEND    PMUGURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGATYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGCLAM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGFUND,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMUGTABT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPIICNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0 Link
                                      "#"",REASNDSC,"#",":      * 1 Long Descr
                                      "#"",PMPIFDAT,"#",":      * 2 From Date
                                      "#"",PMPITDAT,"#");"      * 3 To Date
.
.-------------------------------------------------------------------------------
. loop until all program interruptions have been processed
.-------------------------------------------------------------------------------
          GOTO DPIL1000
.
DPIL9999  RETURN
.
.*******************************************************************************
. Check for any interruptions without an end date                     CAR 257776
.*******************************************************************************
INTE0000  PACK      KEY36,PMAGURNO,PMAGATYP,PMAGCLAM,PMAGFUND,PMAGTABT:
                          PMAGEDAT,SP70
          CALL      RSPMPIT1
INTE1000  CALL      RKPMPIT1
          BRANCH    OVRCD,INTE9999
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      INTE9999 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      INTE1000 IF EQUAL
.
.-------------------------------------------------------------------------------
. output one if any interruptions do not have an end date
.-------------------------------------------------------------------------------
          MATCH     PMPITDAT,SP70
          IF        @EQUAL
            GOTO      INTE8000
          ENDIF
.
          MATCH     PMPITDAT,Z70
          IF        @EQUAL
            GOTO      INTE8000
          ENDIF
.
          GOTO      INTE1000
.
INTE8000  WRITE     HTMLFILE;ONE;
          GOTO      INTE9999
.
INTE9999  RETURN
.
.*******************************************************************************
. Get Admission Date                                                  CAR 257776
.*******************************************************************************
ADMD0000  PACK      KEY8,ADMISSNO
          CALL      RDPTMIS1
          BRANCH    OVRCD,ADMD9999
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDACT;
.
ADMD9999  RETURN
+
.*******************************************************************************
.         Process Admission date/time tags
.*******************************************************************************
ADMT0000  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,F1
          MOVE      DIM1,F1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,ADMT9999
.
          BRANCH    F1,ADMT0100,ADMT0200
          GOTO      ADMT9999
.
ADMT0100  WRITE     HTMLFILE;ADATE;
          GOTO      ADMT9999
.
ADMT0200  WRITE     HTMLFILE;ATIME;
          GOTO      ADMT9999
.
ADMT9999  RETURN
+
.*******************************************************************************
.         Process Discharge date/time tags
.*******************************************************************************
DIST0000  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,F1
          MOVE      DIM1,F1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,DIST9999
.
          BRANCH    F1,DIST0100,DIST0200,DIST0300
          GOTO      DIST9999
.
DIST0100  WRITE     HTMLFILE;DDATE;
          GOTO      DIST9999
.
DIST0200  WRITE     HTMLFILE;DTIME;
          GOTO      DIST9999
.
DIST0300  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDACT;
          GOTO      DIST9999
.
DIST9999  RETURN
+
.*******************************************************************************
. Get the Program Start Date for Program Interruptions                CAR 274410
.*******************************************************************************
ADTE0000  PACK      DISPDACT,SP70
          MATCH     PMUGSDAT,SP70
          GOTO      ADTE9999 IF EQUAL
.
          UNPACK    PMUGSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDACT;
.
ADTE9999  RETURN
.
.*******************************************************************************
. Get the Date Clinically Ready for Rehab                             CAR 291388
.*******************************************************************************
DCRC0000  PACK      DISPDACT,SP70
          MATCH     PMAGDCRC,SP70
          GOTO      DCRC9999 IF EQUAL
.
          UNPACK    PMAGDCRC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDACT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDACT;
.
DCRC9999  RETURN
.
.*******************************************************************************
. Get the Program End Date for Program Interruptions                  CAR 274410
.*******************************************************************************
DDTE0000  PACK      DISPDDSC,SP70
          MATCH     PMUGENDD,SP70
          GOTO      DDTE9999 IF EQUAL
.
          UNPACK    PMUGENDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDDSC;
.
DDTE9999  RETURN
.
.*******************************************************************************
. Get the Assessment Date                                             CAR 294209
.*******************************************************************************
DART0000  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMAPG1
          BRANCH    OVRCD,DART9999
.
          PACK      DISPDDSC,SP70
          MATCH     PMAGDART,SP70
          GOTO      DART9999 IF EQUAL
.
          UNPACK    PMAGDART,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDDSC;
.
DART9999  RETURN
.
.*******************************************************************************
. Get the Referral Date                                               CAR 294209
.*******************************************************************************
RFDT0000  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RDPMAPG1
          BRANCH    OVRCD,RFDT9999
.
          PACK      DISPDDSC,SP70
          MATCH     PMAGRFDT,SP70
          GOTO      RFDT9999 IF EQUAL
.
          UNPACK    PMAGRFDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDDSC;
.
RFDT9999  RETURN
.
.*******************************************************************************
. Get the Total No of Days for Interruptions                          CAR 294209
.*******************************************************************************
TNDI0000  MOVE      ZERO,TOTALSDS
          PACK      KEY36,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RSPMPIT1
TNDI1000  CALL      RKPMPIT1
          BRANCH    OVRCD,TNDI8000
.
          MATCH     PMPIURNO,PMUGURNO
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     PMPIATYP,PMUGATYP
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     PMPICLAM,PMUGCLAM
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     PMPIFUND,PMUGFUND
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     PMPITABT,PMUGTABT
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     PMPIEDAT,PMUGEDAT
          GOTO      TNDI8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      TNDI1000 IF EQUAL
.
          MOVE      PMPIFDAT,FROMDATE
.
          MATCH     SP70,PMPITDAT
          IF        @EQUAL
            MOVE      CURRDATE,TODATE
          ELSE
            MOVE      PMPITDAT,TODATE
          ENDIF
.                                              * Calculate Rehab Suspension Days
          MOVE      ZERO,CALCDAYS
          DAYSEP    FROMDATE,TODATE,CALCDAYS
          COMPARE   ZERO,CALCDAYS
          IF        @EQUAL
            MOVE      ONE,CALCDAYS
          ENDIF
          ADD       CALCDAYS,TOTALSDS
.
          GOTO      TNDI1000
.
TNDI8000  WRITE     HTMLFILE;TOTALSDS;               * Total Rehab Susp Days
.
TNDI9999  RETURN
.
.*******************************************************************************
. Display FIM Details                                                 CAR 257776
.*******************************************************************************
DFIM0000  PACK      KEY31,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70     * Get Impairment Code from C-0841644
          CALL      RDPMAPG1                *  HF Program Details table
          BRANCH    OVRCD,DFIM9999
.
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
DFIM1000  CALL      RKPTFIM1
          BRANCH    OVRCD,DFIM9999
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      DFIM9999 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      DFIM1000 IF EQUAL
.
.-------------------------------------------------------------------------------
. output FIM details to table
.-------------------------------------------------------------------------------
.                                                * reformat FIM Date
          MOVE      SP70,DISPDATE
          MATCH     SP70,PTFIDATE
          IF        !@EQUAL
            UNPACK    PTFIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.                                                * Convert Type code to Descrpt
          MOVE      SP70,DISPTYPE
          MATCH     ANSA,PTFITYPE
          IF        @EQUAL
            MOVE      "Admission",DISPTYPE
            GOTO      DFIM2000
          ENDIF
.
          MATCH     ANSD,PTFITYPE
          IF        @EQUAL
            MOVE      "Discharge",DISPTYPE
            GOTO      DFIM2000
          ENDIF
.
          MATCH     ANSP,PTFITYPE
          IF        @EQUAL
            MOVE      "Progress",DISPTYPE
            GOTO      DFIM2000
          ENDIF
.
          MATCH     ANSV,PTFITYPE
          IF        @EQUAL
            MOVE      "VINAH",DISPTYPE
            GOTO      DFIM2000
          ENDIF
.                                                                   * Car 281720
DFIM2000  MOVE      ZERO,MOTSCORE
          ASSIGN    PTFIEATS+PTFIGRMS+PTFIBTHS+PTFIUPBS,MOTSCORE
          ASSIGN    PTFILWBS+PTFITLTS+PTFIBLMS+MOTSCORE,MOTSCORE
          ASSIGN    PTFIBWMS+PTFITBDS+PTFITTLS+MOTSCORE,MOTSCORE
          ASSIGN    PTFITBTS+PTFILOCS+PTFISTRS+MOTSCORE,MOTSCORE
.
          MOVE      ZERO,COGSCORE
          ASSIGN    PTFICOMS+PTFIEXPS+PTFISCIS+PTFIPRBS,COGSCORE
          ASSIGN    PTFIMEMS+COGSCORE,COGSCORE
.
          MOVE      ZERO,FIMSCORE
          ASSIGN    MOTSCORE+COGSCORE,FIMSCORE
.
          PACK      WBSENAM,SP70
          MOVE      "Unknown",WBSENAM
          PACK      KEY10,PTFICUID,SP70
          CALL      RDWBSE1
.
.         Calculate the Weighted FIM values                      C-0841644-start
DFIM3000  MOVE      ZERO,MOTFIMWS                                   
          MOVE      ZERO,TOTFIMWS 
          MATCH     "1",PTCNFIMW                * Use Weighted FIMS?
          GOTO      DFIM8000 IF NOT EQUAL       * No
.
          MATCH     SP70,PMAGICDE               * Impairment Code entered?
          GOTO      DFIM8000 IF EQUAL           * No
.
          PACK      KEY7,PMAGICDE,SP70          * Yes, get Impairment Group
          CALL      RDPMIMP1                    *  from Impairment Code table
          BRANCH    OVRCD,DFIM8000              
.
          PACK      KEY3,PMIMGCDE,SP70          * Get FIM weighted valus from
          CALL      RDPMIGR1                    *  Impairment Group table
          BRANCH    OVRCD,DFIM8000
.
..........Use the FIM value from pmsigraf and patfimaf to calculate
..........the Weighted FIM scores
.
          ASSIGN    ((PTFIEATS*PMIGEATI)+(PTFIGRMS*PMIGROOM)),MOTFIMWS
          ASSIGN    ((PTFIBTHS*PMIGBATH)+(PTFIUPBS*PMIGUPBD)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFILWBS*PMIGLWBD)+(PTFITLTS*PMIGTOIL)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFIBLMS*PMIGBLAD)+(PTFIBWMS*PMIGBOWE)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFITBDS*PMIGTBED)+(PTFITTLS*PMIGTTOI)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFITBTS*PMIGTTUB)+(PTFILOCS*PMIGWALK)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFISTRS*PMIGSTAI)+ MOTFIMWS),MOTFIMWS
.
          ASSIGN    MOTFIMWS+COGSCORE,TOTFIMWS
          GOTO      DFIM8000
.
DFIM8000  CLEAR     HTMLLINK
          APPEND    "javascript:updateFIMScores('",HTMLLINK
          APPEND    PTFIVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTFITIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTFITYPE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0 Link
                             "#"",PTFIDATE,PTFITIME,"#",":      * 1 Date/time
                             "#"",DISPTYPE,"#",":               * 2 FIM Type
                             "#"",MOTSCORE,"#",":               * 3 Motor Score
                             "#"",COGSCORE,"#",":               * 4 Cognitive
                             "#"",FIMSCORE,"#",":               * 5 FIM score
                             "#"",WBSENAM,"#",":                * 6 Created by
                             "#"",PTFICDAT,PTFICTIM,"#",":      * 7 Date/Time
                             "#"",MOTSCORE," / ",MOTFIMWS,"#",": * 8 Wgt FIM
                             "#"",FIMSCORE," / ",TOTFIMWS,"#");" * 9 Tot Wgt FIM
.
.-------------------------------------------------------------------------------
. loop until all FIM details have been processed
.-------------------------------------------------------------------------------
          GOTO DFIM1000
.
DFIM9999  RETURN
.
.*******************************************************************************
. Check if Admission FIM already exists                               CAR 257776
.*******************************************************************************
CFAD0000  PACK      SAVKEY24,PTFIVISN,PTFIDATE,PTFITIME             * CAR 273962
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CFAD1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CFAD8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CFAD8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CFAD1000 IF EQUAL
.
          MATCH     ANSA,PTFITYPE
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;
            GOTO      CFAD8000
          ENDIF
.
          GOTO CFAD1000
.                                                * Re-read original record
CFAD8000  PACK      KEY24,SAVKEY24,SP70                             * CAR 273692
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
CFAD9999  RETURN
.
.*******************************************************************************
. Check if Discharge FIM already exists                               CAR 257776
.*******************************************************************************
CFDS0000  PACK      SAVKEY24,PTFIVISN,PTFIDATE,PTFITIME             * CAR 273962
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CFDS1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CFDS8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CFDS8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CFDS1000 IF EQUAL
.
          MATCH     ANSD,PTFITYPE
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;
            GOTO      CFDS8000
          ENDIF
.
          GOTO CFDS1000
.                                                * Re-read original record
CFDS8000  PACK      KEY24,SAVKEY24,SP70                             * CAR 273962
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
CFDS9999  RETURN
.
.*******************************************************************************
. Check if rehabilitation visit exists within 90 days of Admission    CAR 257776
.*******************************************************************************
CHRV0000  MATCH     "A",PTFIM004                 * only for Admission FIM
          GOTO      CHRV9999 IF NOT EQUAL
.
          READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            MOVE      CATA,CARECATG
          ELSE
            MOVE      CATCC,CARECATG
          ENDIF
.                                                * Get Admission date
          PACK      KEY8,ADMISSNO
          CALL      RDPTMIS1
          BRANCH    OVRCD,CHRV9999
.                                                * Store Admission Date
          MOVE      ADATE,FIMADATE
          SUBTRACT  "90",FIMADATE
          MOVE      FIMADATE,FIMCDATE
.
          PACK      KEY17,URNUMBER,THREE,SP70
          CALL      RSPTMI18
CHRV1000  CALL      RKPTMI18
          BRANCH    OVRCD,CHRV9999
.
          MATCH     URNUMBER,AURNO
          GOTO      CHRV9999 IF NOT EQUAL
.                                                * Discharge records only
          IF        ASTAT<>3
            GOTO      CHRV9999                   * Discharge records only
          ENDIF
.
          MATCH     "A ",CARECATG                * Read relevant category type
          IF        @EQUAL
            PACK      KEY5,CARECATG,ATYPE,SP70
          ELSE
            PACK      KEY5,CARECATG,ACARE,SP70
          ENDIF
.
          CALL      RDCODE1
          BRANCH    OVRCD,CHRV9999
.
          MATCH     "A ",CARECATG                * Identify Rehab Visits
          IF        @EQUAL
            MATCH     "9",TCINDC8
            GOTO      CHRV2000 IF EQUAL
          ELSE
            MATCH     "2",TCINDC6
            GOTO      CHRV2000 IF EQUAL
          ENDIF
.
          GOTO      CHRV3000                     * next record
.
CHRV2000  PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CHRV9999
.                                                * discharge not within 90 days
          MOVE      DDATE,FIMDDATE
          IF        FIMDDATE > FIMCDATE
            GOTO      CHRV7000
          ENDIF
.
CHRV3000  GOTO      CHRV1000                     * Loop through records for urno
.
CHRV7000  PACK      KEY24,DAADMNO,SP70           * Get Discharge FIM Score
          CALL      RSPTFIM1
CHRV8000  CALL      RKPTFIM1
          BRANCH    OVRCD,CHRV1000
.
          MATCH     PTFIVISN,DAADMNO
          GOTO      CHRV1000 IF NOT EQUAL
.
          MATCH     "D",PTFITYPE
          GOTO      CHRV8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CHRV8000 IF EQUAL
.
          CLEAR     COPYFLDS
          APPEND    ONE,COPYFLDS                 * FIM Discharge found
          APPEND    PTFIEATS,COPYFLDS            * all except comments
          APPEND    PTFIGRMS,COPYFLDS
          APPEND    PTFIBTHS,COPYFLDS
          APPEND    PTFIUPBS,COPYFLDS
          APPEND    PTFILWBS,COPYFLDS
          APPEND    PTFITLTS,COPYFLDS
          APPEND    PTFIBLMS,COPYFLDS
          APPEND    PTFIBWMS,COPYFLDS
          APPEND    PTFITBDS,COPYFLDS
          APPEND    PTFITTLS,COPYFLDS
          APPEND    PTFITBTS,COPYFLDS
          APPEND    PTFILOCD,COPYFLDS
          APPEND    PTFILOCS,COPYFLDS
          APPEND    PTFISTRS,COPYFLDS
          APPEND    PTFICOCD,COPYFLDS
          APPEND    PTFICOMS,COPYFLDS
          APPEND    PTFIEXCD,COPYFLDS
          APPEND    PTFIEXPS,COPYFLDS
          APPEND    PTFISCIS,COPYFLDS
          APPEND    PTFIPRBS,COPYFLDS
          APPEND    PTFIMEMS,COPYFLDS
          APPEND    PTFIEATG,COPYFLDS
          APPEND    PTFIGRMG,COPYFLDS
          APPEND    PTFIBTHG,COPYFLDS
          APPEND    PTFIUPBG,COPYFLDS
          APPEND    PTFILWBG,COPYFLDS
          APPEND    PTFITLTG,COPYFLDS
          APPEND    PTFIBLMG,COPYFLDS
          APPEND    PTFIBWMG,COPYFLDS
          APPEND    PTFITBDG,COPYFLDS
          APPEND    PTFITTLG,COPYFLDS
          APPEND    PTFITBTG,COPYFLDS
          APPEND    PTFILOCG,COPYFLDS
          APPEND    PTFISTRG,COPYFLDS
          APPEND    PTFICOMG,COPYFLDS
          APPEND    PTFIEXPG,COPYFLDS
          APPEND    PTFISCIG,COPYFLDS
          APPEND    PTFIPRBG,COPYFLDS
          APPEND    PTFIMEMG,COPYFLDS
          WRITE     HTMLFILE;COPYFLDS;
.
CHRV9999  RETURN
.
.*******************************************************************************
. Check if Progress or Disharge FIM scores exist                      CAR 257776
.*******************************************************************************
CHKF0000  MATCH     "A",PTFIM004                 * only for Admission FIM
          GOTO      CHKF9999 IF NOT EQUAL

CHKF1000  PACK      KEY24,ADMISSNO,Z70           * Get Last FIM Score for Visit
          CALL      RSPTFIM1
CHKF2000  CALL      RPPTFIM1
          BRANCH    OVRCD,CHKF8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CHKF8000 IF NOT EQUAL
.
          MATCH     "A",PTFITYPE
          GOTO      CHKF8000 IF EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CHKF2000 IF EQUAL
.
          WRITE     HTMLFILE;ONE;
.                                                * Re-read original record
CHKF8000  PACK      KEY24,ADMISSNO,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
CHKF9999  RETURN
.
.*******************************************************************************
. Default Actual and Goal Scores from Previous FIM details            CAR 257776
.*******************************************************************************
GPRV0000  PACK      KEY24,ADMISSNO,Z70           * Get Last FIM Score for Visit
          CALL      RSPTFIM1
GPRV2000  CALL      RPPTFIM1
          BRANCH    OVRCD,GPRV8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      GPRV8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      GPRV2000 IF EQUAL
.
          CLEAR     COPYFLDS
          APPEND    ONE,COPYFLDS
          APPEND    PTFIEATS,COPYFLDS
          APPEND    PTFIGRMS,COPYFLDS
          APPEND    PTFIBTHS,COPYFLDS
          APPEND    PTFIUPBS,COPYFLDS
          APPEND    PTFILWBS,COPYFLDS
          APPEND    PTFITLTS,COPYFLDS
          APPEND    PTFIBLMS,COPYFLDS
          APPEND    PTFIBWMS,COPYFLDS
          APPEND    PTFITBDS,COPYFLDS
          APPEND    PTFITTLS,COPYFLDS
          APPEND    PTFITBTS,COPYFLDS
          APPEND    PTFILOCD,COPYFLDS
          APPEND    PTFILOCS,COPYFLDS
          APPEND    PTFISTRS,COPYFLDS
          APPEND    PTFICOCD,COPYFLDS
          APPEND    PTFICOMS,COPYFLDS
          APPEND    PTFIEXCD,COPYFLDS
          APPEND    PTFIEXPS,COPYFLDS
          APPEND    PTFISCIS,COPYFLDS
          APPEND    PTFIPRBS,COPYFLDS
          APPEND    PTFIMEMS,COPYFLDS
.
          MATCH     "A",PTFITYPE
          GOTO      GPRV5000 IF EQUAL
.
GPRV3000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
GPRV4000  CALL      RKPTFIM1
          BRANCH    OVRCD,GPRV8000
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      GPRV8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      GPRV4000 IF EQUAL
.
GPRV5000  APPEND    PTFIEATG,COPYFLDS
          APPEND    PTFIGRMG,COPYFLDS
          APPEND    PTFIBTHG,COPYFLDS
          APPEND    PTFIUPBG,COPYFLDS
          APPEND    PTFILWBG,COPYFLDS
          APPEND    PTFITLTG,COPYFLDS
          APPEND    PTFIBLMG,COPYFLDS
          APPEND    PTFIBWMG,COPYFLDS
          APPEND    PTFITBDG,COPYFLDS
          APPEND    PTFITTLG,COPYFLDS
          APPEND    PTFITBTG,COPYFLDS
          APPEND    PTFILOCG,COPYFLDS
          APPEND    PTFISTRG,COPYFLDS
          APPEND    PTFICOMG,COPYFLDS
          APPEND    PTFIEXPG,COPYFLDS
          APPEND    PTFISCIG,COPYFLDS
          APPEND    PTFIPRBG,COPYFLDS
          APPEND    PTFIMEMG,COPYFLDS
          WRITE     HTMLFILE;COPYFLDS;

.                                                * Re-read original record
GPRV8000  PACK      KEY24,ADMISSNO,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD = 1
            CALL      CLPATFIM
          ENDIF
.
GPRV9999  RETURN
.
.*******************************************************************************
. Check if Program Interruption Exists                                CAR 257776
.*******************************************************************************
CHKI0000  PACK      KEY36,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMPIT1
CHKI2000  CALL      RKPMPIT1
          BRANCH    OVRCD,CHKI9998
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      CHKI9998 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      CHKI2000 IF EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      CHKI9999
.
CHKI9998
          WRITE     HTMLFILE;ZERO;
.
CHKI9999  RETURN
.
.*******************************************************************************
. WEBWAR00 - Display Warnings                                         CAR 274410
.*******************************************************************************
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20 WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             " reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
.
.*******************************************************************************
. Get the Last Interruption End Date                                  CAR 274410
.*******************************************************************************
ENDI0000  PACK      KEY36,PMAGURNO,PMAGATYP,PMAGCLAM,PMAGFUND,PMAGTABT:
                          PMAGEDAT,Z70
          CALL      RSPMPIT1
ENDI1000  CALL      RPPMPIT1
          BRANCH    OVRCD,ENDI9999
.
          PACK      KEY31,PMPIURNO,PMPIATYP,PMPICLAM,PMPIFUND,PMPITABT:
                          PMPIEDAT,SP70
          MATCH     KEY31,KEY36
          GOTO      ENDI9999 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      ENDI1000 IF EQUAL
.
          MATCH     PMPITDAT,SP70
          IF        @EQUAL
            WRITE     HTMLFILE;"99999999";
            GOTO      ENDI9999
          ENDIF
.
          UNPACK    PMPITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDDSC;
          GOTO      ENDI9999
.
ENDI9999  RETURN
.
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0100,GTAG0200,GTAG0300,GTAG0400,GTAG0500:
                             GTAG0600,GTAG0700,GTAG0800,GTAG0900,GTAG1000:
                             GTAG1100,GTAG1200,GTAG1300,GTAG1400,GTAG1500:
                             GTAG1600,GTAG1700,GTAG1800,GTAG1900,GTAG2000:
                             GTAG2100,GTAG2200,GTAG2300,GTAG2400,GTAG2500:
                             GTAG2600,GTAG2700,GTAG2800,GTAG2900,GTAG3000:
                             GTAG3100,GTAG3200,GTAG3300
          GOTO      GTAG9999
.
GTAG0100  CALL      UPRG0000                * Program list By UR
          GOTO      GTAG9999
.
GTAG0200  MOVE      "A ",CATEGORY
          MOVE      FILTATYP,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0300  CALL      OPRG0000                * OP program breakdown list By UR
          GOTO      GTAG9999
.
GTAG0400  CALL      DIPV0000                * Visit list By U/R       CAR 257776
          GOTO      GTAG9999
.
GTAG0500  CALL      DPIL0000                * Program Interrupt List  CAR 257776
          GOTO      GTAG9999
.
GTAG0600  CALL      INTE0000                * Chk Interrupt End Dates CAR 257776
          GOTO      GTAG9999
.
GTAG0700  CALL      ADTE0000                * get Program Start Date  CAR 274410
          GOTO      GTAG9999
.
GTAG0800  CALL      DDTE0000                * get Program End Date    CAR 274410
          GOTO      GTAG9999
.
GTAG0900  CALL      DFIM0000                * Program FIM Score List  CAR 257776
          GOTO      GTAG9999
.
GTAG1000  WRITE     HTMLFILE;PTFIM004;      * FIM Assessment Type     CAR 257776
          GOTO      GTAG9999
.
GTAG1100  CALL      CFAD0000                * Admission FIM Exists    CAR 257776
          GOTO      GTAG9999
.
GTAG1200  CALL      CFDS0000                * Discharge FIM Exists    CAR 257776
          GOTO      GTAG9999
.
GTAG1300  CALL      CHRV0000                * Chk Rehab vst <=90 days CAR 257776
          GOTO      GTAG9999
.
GTAG1400  CALL      CHKF0000                * Chk if progress or      CAR 257776
          GOTO      GTAG9999                * discharge FIM exist
.
GTAG1500  CALL      GPRV0000                * Get details from prev   CAR 257776
          GOTO      GTAG9999                * FIM Scored Detail
.
GTAG1600  CALL      CHKI0000                * Check if Interruption   CAR 257776
          GOTO      GTAG9999                * exists
.
GTAG1700  CALL      ADMD0000                * get Intr Admission Date CAR 257776
          GOTO      GTAG9999
.
GTAG1800  WRITE     HTMLFILE;VSTEXIST;      * Delete Program Allowed? CAR 273161
          GOTO      GTAG9999
.
GTAG1900  CALL      ENDI0000                * last Interrupt End Date CAR 274410
          GOTO      GTAG9999
.
GTAG2000  WRITE     HTMLFILE;FSCORESY;      * Any FIM Scores exist?   CAR 277015
          GOTO      GTAG9999
.
GTAG2100  CALL      ADMT0000                * get Admission Date/Time values
          GOTO      GTAG9999
.
GTAG2200  CALL      DIST0000                * get Discharge Date/Time values
          GOTO      GTAG9999
.
GTAG2300  CALL      DCRC0000                * get Date Clinically Ready for Rehab
          GOTO      GTAG9999
.
GTAG2400  CALL      DART0000                * get Assessment Date
          GOTO      GTAG9999
.
GTAG2500  CALL      RFDT0000                * get Referral Date
          GOTO      GTAG9999
.
GTAG2600  CALL      TNDI0000                * get Total No of Days for Interruption
          GOTO      GTAG9999
.
GTAG2700  WRITE     HTMLFILE;SHOWCODG;      * Show coding page
          GOTO      GTAG9999
.
GTAG2800  WRITE     HTMLFILE;SHOWCOMM;      * Show program maint comments
          GOTO      GTAG9999
.
GTAG2900  CALL      DIAV0000                * Visit list By U/R
          GOTO      GTAG9999
.
GTAG3000  CALL      GDOC0000                * General Tags
          GOTO      GTAG9999
.
GTAG3100  WRITE     HTMLFILE;PMVXEDC1;      * Secondary doctor
          GOTO      GTAG9999
.
GTAG3200  WRITE     HTMLFILE;SUPRFLAG;      * Supervisor flag   
          GOTO      GTAG9999
.
GTAG3300  MOVE      ZERO,NEWVISIT           * Don't include new pre adm in count
          CALL      CINP0000                * Valid program must be in context 
          WRITE     HTMLFILE;IPVCOUNT;      * Total valid IP visits
          GOTO      GTAG9999
.
GTAG9999  RETURN
.
.-------------------------------------------------------------------------------
.  Set Parameters for U/R health fund program details
.-------------------------------------------------------------------------------
STUPG000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      ZERO,F3
          MOVE      KEY3,F3
.
          BRANCH    F3,STUPG010,STUPG020,STUPG030,STUPG040,STUPG050:
                       STUPG060,STUPG070,STUPG080,STUPG090,STUPG100:
                       STUPG110,STUPG120,STUPG130,STUPG140,STUPG150:
                       STUPG160,STUPG170,STUPG180,STUPG190,STUPG200:
                       STUPG210,STUPG220,STUPG230
          GOTO      STUPG999
.
STUPG010  PACK      PMUPG001,QRYDATA,SP70
          GOTO      STUPG999
.
STUPG020  PACK      PMUPG002,QRYDATA,SP70
          GOTO      STUPG999
.
STUPG030  PACK      PMUPG003,QRYDATA,SP70
          GOTO      STUPG999
.
STUPG040  PACK      PMUPG004,QRYDATA,SP70
          GOTO      STUPG999
.
STUPG050  PACK      PMUPG005,QRYDATA,SP70
          GOTO      STUPG999
.
STUPG060  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG006,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG070  MOVE      QRYDATA,PMUPG007
          GOTO      STUPG999
.
STUPG080  MOVE      QRYDATA,PMUPG008
          GOTO      STUPG999
.
STUPG090  MOVE      QRYDATA,PMUPG009
          GOTO      STUPG999
.
STUPG100  MOVE      QRYDATA,PMUPG010
          GOTO      STUPG999
.
STUPG110  MOVE      QRYDATA,PMUPG011
          GOTO      STUPG999
.
STUPG120  MOVE      QRYDATA,PMUPG012
          GOTO      STUPG999
.
STUPG130  MOVE      QRYDATA,PMUPG013
          GOTO      STUPG999
.
STUPG140  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG014,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG150  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG015,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG160  MOVE      QRYDATA,PMUPG016
          GOTO      STUPG999
.
STUPG170  MOVE      QRYDATA,PMUPG017
          GOTO      STUPG999
.
STUPG180  MOVE      QRYDATA,PMUPG018
          GOTO      STUPG999
.
STUPG190  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG019,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG200  MOVE      QRYDATA,PMUPG020
          GOTO      STUPG999
.
STUPG210  MOVE      QRYDATA,PMUPG021
          GOTO      STUPG999
.
STUPG220  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG022,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG230  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPG023,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPG999
.
STUPG999  RETURN
.
.-------------------------------------------------------------------------------
.  Move cgi to file vars for U/R health fund program details
.-------------------------------------------------------------------------------
MVUPG000  MATCH     Z70,PMUPG001
          IF        !@EQUAL
            MOVE      PMUPG001,PMUGURNO
          ENDIF
.
          MATCH     Z70,PMUPG002
          IF        !@EQUAL
            MOVE      PMUPG002,PMUGATYP
          ENDIF
.
          MATCH     Z70,PMUPG003
          IF        !@EQUAL
            MOVE      PMUPG003,PMUGCLAM
          ENDIF
.
          MATCH     Z70,PMUPG004
          IF        !@EQUAL
            MOVE      PMUPG004,PMUGFUND
          ENDIF
.
          MATCH     Z70,PMUPG005
          IF        !@EQUAL
            MOVE      PMUPG005,PMUGTABT
          ENDIF
.
          MATCH     Z70,PMUPG006
          IF        !@EQUAL
            MOVE      PMUPG006,PMUGEDAT
          ENDIF
.
          MATCH     Z70,PMUPG007
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG007
            MOVE      PMUPG007,F3
            MOVE      F3,PMUGMAXI
          ENDIF
.
          MATCH     Z70,PMUPG008
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG008
            MOVE      PMUPG008,F3
            MOVE      F3,PMUGWARI
          ENDIF
.
          MATCH     Z70,PMUPG009
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG009
            MOVE      PMUPG009,F3
            MOVE      F3,PMUGMANI
          ENDIF
.
          MATCH     Z70,PMUPG010
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG010
            MOVE      PMUPG010,F3
            MOVE      F3,PMUGMAXO
          ENDIF
.
          MATCH     Z70,PMUPG011
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG011
            MOVE      PMUPG011,F3
            MOVE      F3,PMUGWARO
          ENDIF
.
          MATCH     Z70,PMUPG012
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPG012
            MOVE      PMUPG012,F3
            MOVE      F3,PMUGMANO
          ENDIF
.
          MATCH     Z70,PMUPG013
          IF        !@EQUAL
            MOVE      PMUPG013,PMUGBRKO
          ENDIF
.
          MATCH     Z70,PMUPG014
          IF        !@EQUAL
            MOVE      PMUPG014,PMUGEXTD
          ENDIF
.
          MATCH     Z70,PMUPG015
          IF        !@EQUAL
            MOVE      PMUPG015,PMUGSDAT
          ENDIF
.
          MATCH     Z70,PMUPG016
          IF        !@EQUAL
            MOVE      PMUPG016,PMUGPNAM
          ENDIF
.
          MATCH     Z70,PMUPG017
          IF        !@EQUAL
            MOVE      PMUPG017,PMUGUDSI
          ENDIF
.
          MATCH     Z70,PMUPG018
          IF        !@EQUAL
            MOVE      PMUPG018,PMUGSNAP
          ENDIF
.
          MATCH     Z70,PMUPG019
          IF        !@EQUAL
            MOVE      PMUPG019,PMUGENDD
          ENDIF
.
          MATCH     Z70,PMUPG020
          IF        !@EQUAL
            MOVE      PMUPG020,PMUGPROG
          ENDIF
.
          MATCH     Z70,PMUPG021
          IF        !@EQUAL
            MOVE      PMUPG021,PMUGPINT
          ENDIF
.
          MATCH     Z70,PMUPG022
          IF        !@EQUAL
            MOVE      PMUPG022,PMUGRPDT
          ENDIF
.
          MATCH     Z70,PMUPG023
          IF        !@EQUAL
            MOVE      PMUPG023,PMUGRDDT
          ENDIF
.
MVUPG999  RETURN
.
.-------------------------------------------------------------------------------
.  Set Parameters for U/R health fund OP program details
.-------------------------------------------------------------------------------
STUPO000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      ZERO,F3
          MOVE      KEY3,F3
.
          BRANCH    F3,STUPO010,STUPO020,STUPO030,STUPO040,STUPO050:
                       STUPO060,STUPO070,STUPO080,STUPO090,STUPO100
          GOTO      STUPO999
.
STUPO010  PACK      PMUPO001,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO020  PACK      PMUPO002,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO030  PACK      PMUPO003,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO040  PACK      PMUPO004,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO050  PACK      PMUPO005,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO060  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PMUPO006,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      STUPO999
.
STUPO070  PACK      PMUPO007,QRYDATA,SP70
          GOTO      STUPO999
.
STUPO080  MOVE      QRYDATA,PMUPO008
          GOTO      STUPO999
.
STUPO090  MOVE      QRYDATA,PMUPO009
          GOTO      STUPO999
.
STUPO100  MOVE      QRYDATA,PMUPO010
          GOTO      STUPO999
.
STUPO999  RETURN
.
.-------------------------------------------------------------------------------
.  Move cgi to file vars for U/R health fund OP program details
.-------------------------------------------------------------------------------
MVUPO000  MATCH     Z70,PMUPO001
          IF        !@EQUAL
            MOVE      PMUPO001,PMUOURNO
          ENDIF
.
          MATCH     Z70,PMUPO002
          IF        !@EQUAL
            MOVE      PMUPO002,PMUOATYP
          ENDIF
.
          MATCH     Z70,PMUPO003
          IF        !@EQUAL
            MOVE      PMUPO003,PMUOCLAM
          ENDIF
.
          MATCH     Z70,PMUPO004
          IF        !@EQUAL
            MOVE      PMUPO004,PMUOFUND
          ENDIF
.
          MATCH     Z70,PMUPO005
          IF        !@EQUAL
            MOVE      PMUPO005,PMUOTABT
          ENDIF
.
          MATCH     Z70,PMUPO006
          IF        !@EQUAL
            MOVE      PMUPO006,PMUOEDAT
          ENDIF
.
          MATCH     Z70,PMUPO007
          IF        !@EQUAL
            MOVE      PMUPO007,PMUOVTYP
          ENDIF
.
          MATCH     Z70,PMUPO008
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPO008
            MOVE      PMUPO008,F3
            MOVE      F3,PMUOMAXO
          ENDIF
.
          MATCH     Z70,PMUPO009
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPO009
            MOVE      PMUPO009,F3
            MOVE      F3,PMUOWARO
          ENDIF
.
          MATCH     Z70,PMUPO010
          IF        !@EQUAL
            MOVE      ZERO,F3
            SQUEEZE   PMUPO010
            MOVE      PMUPO010,F3
            MOVE      F3,PMUOMANO
          ENDIF
.
MVUPO999  RETURN
.
+
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
REMOTE05  MOVE      ZERO,F1
          MOVE      UPDTTYPE,F1
          BRANCH    F1,REMOTE10,REMOTE20,REMOTE30
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      CHKPRG00      * Check for a valid program
          GOTO      REMOTE90
.
REMOTE20  CALL      ADDPRG00      * Check for a valid program and add it to
          GOTO      REMOTE90      * a patient
.
REMOTE30  CALL      CAAC0000      * Check for AN-SNAP Auto Classification
          GOTO      REMOTE90
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
.
.******************************************************************************
. Check for a valid program
.******************************************************************************
CHKPRG00  PACK      KEY8,VALDURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CHKPRG90
.
          PACK      KEY8,VALDURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHKPRG90
.
          MOVE      ZERO,IPVCMAXI         * Max IP Visits
          MOVE      ZERO,IPVCWARN         * IP Visit Count Warning
          MOVE      ZERO,IPVCOUNT         * IP Visit Count
          MOVE      ZERO,IPVEXTRA         * Extra Funding required in X Visits
          MOVE      ZERO,OPVCMAXI         * Max OP Visits
          MOVE      ZERO,OPVCWARN         * OP Visit Count Warning
          MOVE      ZERO,OPVCOUNT         * OP Visit Count
          MOVE      ZERO,OPVEXTRA         * Extra Funding required in X Visits
.
. Check U/R for a valid program with a matching admission type and claim code
. with a blank health fund and table type.
.
. Check for an open progam with no expiry date
.
          PACK      KEY31,VALDURNO,VALDATYP,VALDCLAM,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      CHKPRG35
          ENDIF
.
          PACK      KEY31,VALDURNO,VALDATYP,VALDCLAM,SP9:
                          VALDEDAT,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      CHKPRG35
          ENDIF
CHKPRG20  CALL      RKPMUPG1
          BRANCH    OVRCD,CHKPRG25
.
          MATCH     VALDURNO,PMUGURNO
          GOTO      CHKPRG25 IF NOT EQUAL
.
          MATCH     VALDATYP,PMUGATYP
          GOTO      CHKPRG25 IF NOT EQUAL
.
          MATCH     VALDCLAM,PMUGCLAM
          GOTO      CHKPRG25 IF NOT EQUAL
.
          MATCH     SP70,PMUGFUND
          GOTO      CHKPRG25 IF NOT EQUAL
.
          MATCH     SP70,PMUGTABT
          GOTO      CHKPRG25 IF NOT EQUAL
.
          GOTO      CHKPRG35
.
CHKPRG25  PACK      KEY14,VALDFUND,VALDTABT,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,CHKPRG55
.
. Check U/R for a valid program with a matching admission type, health fund and
. table type with a blank claim code
.
. Check for an program with no expiry date
.
          PACK      KEY31,VALDURNO,VALDATYP,SP3,HCODE,PTHFBCAT,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      CHKPRG35
          ENDIF
.
. Check for a program with an expiry date
.
          PACK      KEY31,VALDURNO,VALDATYP,SP3,HCODE,PTHFBCAT:
                          VALDEDAT,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      CHKPRG35
          ENDIF
          CALL      RKPMUPG1
          BRANCH    OVRCD,CHKPRG55
.
          MATCH     VALDURNO,PMUGURNO
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     VALDATYP,PMUGATYP
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     SP3,PMUGCLAM
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     HCODE,PMUGFUND
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PTHFBCAT,PMUGTABT
          GOTO      CHKPRG55 IF NOT EQUAL
.
CHKPRG35  PACK      SAVKEY34,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
.
          MATCH     "3",VALDVTYP            * IP Visits only
          IF        @EQUAL
            MOVE      ONE,NEWVISIT          * Include new pre adm in count
            CALL      CINP0000              * Valid program so count IP visits
            GOTO      CHKPRG50
          ENDIF
.
          MATCH     "2",VALDVTYP            * OP Visits only
          GOTO      CHKPRG91 IF NOT EQUAL   * Invalid valdvtyp
.
          MOVE      ONE,NEWVISIT            * Include new booking in count
          CALL      COUT0000              * Valid program so count OP visits
.
          MATCH     "1",PMUGBRKO          * Op visit breakdown
          GOTO      CHKPRG50 IF NOT EQUAL
.
          PACK      KEY34,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RSPMUPO1
CHKPRG40  CALL      RKPMUPO1
          BRANCH    OVRCD,CHKPRG55
.
          MATCH     PMUGURNO,PMUOURNO
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PMUGATYP,PMUOATYP
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PMUGCLAM,PMUOCLAM
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PMUGFUND,PMUOFUND
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PMUGTABT,PMUOTABT
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     PMUGEDAT,PMUOEDAT
          GOTO      CHKPRG55 IF NOT EQUAL
.
          MATCH     VALDSTYP,PMUOVTYP
          GOTO      CHKPRG40 IF NOT EQUAL
.
          PACK      SAVKEY34,PMUOURNO,PMUOATYP,PMUOCLAM,PMUOFUND,PMUOTABT:
                          PMUOEDAT,PMUOVTYP,SP70
.
          MOVE      ONE,NEWVISIT            * Include new booking in count
          CALL      COBK0000                * Valid progam so count OP visits
.
CHKPRG50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    SAVKEY34,"|",IPVEXTRA,"|",OPVEXTRA,"|":
                    "</RETURN_VALUE>"
          GOTO      CHKPRG99
.
CHKPRG55  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    SP1,"|",ZERO,"|",ZERO,"|":
                    "</RETURN_VALUE>"
          GOTO      CHKPRG99
.
CHKPRG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid U/R Number":
                    "</RETURN_VALUE>"
          GOTO      CHKPRG99
.
CHKPRG91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Visit Type Validation":
                    "</RETURN_VALUE>"
          GOTO      CHKPRG99
.
CHKPRG99  RETURN
.
.******************************************************************************
. Check for a valid program
.******************************************************************************
ADDPRG00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDPRG90
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDPRG90
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,ADDPRG35          * Check for OP booking as they
.                                           * have no visit record
          COMPARE   TWO,PVITYPE             * OP Visit
          GOTO      ADDPRG35 IF EQUAL
.
          COMPARE   THREE,PVITYPE           * IP Visit
          GOTO      ADDPRG25 IF EQUAL
.
          GOTO      ADDPRG91
.
ADDPRG25  PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          BRANCH    OVRCD,ADDPRG91
.
          IF        ASTAT=1|ASTAT=5
            GOTO      ADDPRG91
          ENDIF
          MOVE      ONE,ADDNEWPG
          CALL      WIPG0000                * Write new program to patient
          BRANCH    F1,ADDPRG92,ADDPRG93
          GOTO      ADDPRG55
.
ADDPRG35  PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,ADDPRG91
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      ADDPRG91 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,ADDPRG91
.
          MOVE      ONE,ADDNEWPG
          CALL      WOPG0000                * Write new OP program to patient
          GOTO      ADDPRG55
.
ADDPRG55  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    "OK":
                    "</RETURN_VALUE>"
          GOTO      ADDPRG99
.
ADDPRG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid U/R Number":
                    "</RETURN_VALUE>"
          GOTO      ADDPRG99
.
ADDPRG91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Visit Number":
                    "</RETURN_VALUE>"
          GOTO      ADDPRG99
.
ADDPRG92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Unable to Add Program, record already exists":
                    "</RETURN_VALUE>"
          GOTO      ADDPRG99
.
ADDPRG93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Unable to Add Program, No Hospital Level Program matrix set up":
                    "</RETURN_VALUE>"
          GOTO      ADDPRG99
.
ADDPRG99  RETURN
.
.*******************************************************************************
. Check if AN-SNAP Auto Classification is valid for this Program
.*******************************************************************************
CAAC0000  PACK      KEY31,VALDURNO,VALDATYP,VALDCLAM,VALDFUND,VALDTABT:
                          VALDEDAT
          CALL      RDPMUPG1
          BRANCH    OVRCD,CAAC9100
.
          PACK      KEY31,VALDURNO,VALDATYP,VALDCLAM,VALDFUND,VALDTABT:
                          VALDEDAT
          CALL      RDPMAPG1
          BRANCH    OVRCD,CAAC9100
.
          PACK      KEY24,PMUGURNO,SP70
          CALL      RDSVISA2
CAAC1000  CALL      RDKVISA2
          BRANCH    OVRCD,CAAC9100
.
          MATCH     PVIURNO,PMUGURNO
          GOTO      CAAC9100 IF NOT EQUAL
.
          MATCH     PMUGSDAT,PVIDATE
          GOTO      CAAC1000 IF LESS
.
          MATCH     PMUGENDD,SP70
          IF        !@EQUAL
            MATCH     PVIDATE,PMUGENDD
            GOTO      CAAC1000 IF LESS
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      CAAC1000 IF NOT EQUAL
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CAAC1000
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      CAAC1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CAAC1000
.
.*******************************************************************************
. check that visit is valid for this program
.*******************************************************************************
          MATCH     PMUGATYP,ATYPE
          GOTO      CAAC1000 IF NOT EQUAL
.
          MATCH     SP70,PMUGCLAM
          IF        !@EQUAL
            MATCH     PMUGCLAM,ACLAIM
            GOTO      CAAC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGFUND
          IF        !@EQUAL
            MATCH     PMUGFUND,AFUNDH
            GOTO      CAAC1000 IF NOT EQUAL
.
            PACK      KEY14,AFUNDH,AFNDTB,SP10
            CALL      RDFUND1
            BRANCH    OVRCD,CAAC1000
.
            MATCH     PMUGTABT,PTHFBCAT
            GOTO      CAAC1000 IF NOT EQUAL
          ENDIF
.
.*******************************************************************************
. Get scores from first admission FIM
.*******************************************************************************
CAAC2000  PACK      KEY24,DPVIBILL,SP70
          CALL      RSPTFIM1
CAAC2100  CALL      RKPTFIM1
          BRANCH    OVRCD,CAAC1000
.
          MATCH     PTFIVISN,DPVIBILL
          GOTO      CAAC1000 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CAAC2100 IF EQUAL
.
          MATCH     "A",PTFITYPE
          GOTO      CAAC2100 IF NOT EQUAL
.
.         Crude FIM value
          MOVE      ZERO,FIMSCORE
          ASSIGN    PTFIEATS+PTFIGRMS+PTFIBTHS+FIMSCORE,FIMSCORE
          ASSIGN    PTFIUPBS+PTFILWBS+PTFITLTS+FIMSCORE,FIMSCORE
          ASSIGN    PTFIBLMS+PTFIBWMS+PTFITBDS+FIMSCORE,FIMSCORE
          ASSIGN    PTFITTLS+PTFITBTS+PTFILOCS+FIMSCORE,FIMSCORE
          ASSIGN    PTFISTRS+FIMSCORE,FIMSCORE
          MOVE      FIMSCORE,FIMMSCRE
.
          MOVE      ZERO,FIMSCORE
          ASSIGN    PTFICOMS+PTFIEXPS+PTFISCIS+FIMSCORE,FIMSCORE
          ASSIGN    PTFIPRBS+PTFIMEMS+FIMSCORE,FIMSCORE
          MOVE      FIMSCORE,FIMCSCRE
        
.         Check if utilising weighted FIMs is required
          MOVE      ZERO,MOTFIMWS
          MATCH     "1",PTCNFIMW                * Use Weighted FIMS?
          GOTO      CAAC2200 IF NOT EQUAL       * No
.
          MATCH     SP70,PMAGICDE               * Impairment Code entered?
          GOTO      CAAC2200 IF EQUAL           * No
.
          PACK      KEY7,PMAGICDE,SP70          * Yes, get Impairment Group
          CALL      RDPMIMP1                    *  from Impairment Code table
          BRANCH    OVRCD,CAAC2200
.
          PACK      KEY3,PMIMGCDE,SP70          * Get FIM weighted values from
          CALL      RDPMIGR1                    *  Impairment Group table
          BRANCH    OVRCD,CAAC2200
.
.         Use the FIM value from pmsigraf and patfimaf to calculate
.         the Weighted FIM scores
.
          ASSIGN    ((PTFIEATS*PMIGEATI)+(PTFIGRMS*PMIGROOM)),MOTFIMWS
          ASSIGN    ((PTFIBTHS*PMIGBATH)+(PTFIUPBS*PMIGUPBD)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFILWBS*PMIGLWBD)+(PTFITLTS*PMIGTOIL)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFIBLMS*PMIGBLAD)+(PTFIBWMS*PMIGBOWE)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFITBDS*PMIGTBED)+(PTFITTLS*PMIGTTOI)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFITBTS*PMIGTTUB)+(PTFILOCS*PMIGWALK)+MOTFIMWS),MOTFIMWS
          ASSIGN    ((PTFISTRS*PMIGSTAI)+ MOTFIMWS),MOTFIMWS
          MOVE      MOTFIMWS,FIMMSCRE
          GOTO      CAAC2200
.
.
.*******************************************************************************
. Check if AN-SNAP Auto Classification is valid for this Impairment
.*******************************************************************************
CAAC2200  PACK      KEY20,VALDICDE,VALDSDAT,Z70
          CALL      RSPMSNC2
CAAC2300  CALL      RPPMSNC2
          BRANCH    OVRCD,CAAC9100
.
          MATCH     VALDICDE,PMSCICDE
          GOTO      CAAC9100 IF NOT EQUAL
.
          MATCH     PMSCDEFF,VALDSDAT
          GOTO      CAAC2300 IF LESS
.
          MATCH     SP70,PMSCDEFT
          IF        !@EQUAL
            MATCH     VALDSDAT,PMSCDEFT
            GOTO      CAAC2300 IF LESS
          ENDIF
.
          MATCH     "1",VALDASSO
          IF        @EQUAL
            MATCH     "1",PMSCASSO
            GOTO      CAAC2300 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",PMSCFMSE
          GOTO      CAAC3000 IF NOT EQUAL
.
          IF        FIMMSCRE < PMSCFMSL
            GOTO      CAAC2300
          ENDIF
.
          IF        FIMMSCRE > PMSCFMSH
            GOTO      CAAC2300
          ENDIF
.
CAAC3000  MATCH     "1",PMSCFCSE
          GOTO      CAAC4000 IF NOT EQUAL
.
          IF        FIMCSCRE < PMSCFCSL
            GOTO      CAAC2300
          ENDIF
.
          IF        FIMCSCRE > PMSCFCSH
            GOTO      CAAC2300
          ENDIF
.
CAAC4000  MATCH     "1",PMSCFTSR
          GOTO      CAAC5000 IF NOT EQUAL
.
          MOVE      ZERO,FIMSCORE
          ASSIGN    FIMMSCRE+FIMCSCRE,FIMSCORE
.
          IF        FIMSCORE < PMSCFTSL
            GOTO      CAAC2300
          ENDIF
.
          IF        FIMSCORE > PMSCFTSH
            GOTO      CAAC2300
          ENDIF
.
CAAC5000  MATCH     "0",PMSCAGEL
          GOTO      CAAC9000 IF EQUAL
.
          MOVE      PMUGURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CAAC9100
.
          MATCH     "2",PMSCAGEL
          GOTO      CAAC5100 IF EQUAL
.
          IF        PSAGE < PMSCAGE
            GOTO      CAAC2300
          ENDIF
.
          GOTO      CAAC9000
.
CAAC5100  IF        PSAGE > PMSCAGE
            GOTO      CAAC2300
          ENDIF
.
CAAC9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMSCCLCD,"|",PMSCVERS:
                             "</RETURN_VALUE>"
.
          GOTO      CAAC9999
.
CAAC9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "</RETURN_VALUE>";
          GOTO      CAAC9999
.
CAAC9999  RETURN
+
.------------------------------------------------------------
. Output Inpatient Audit Details
.------------------------------------------------------------
PTUNA000  PACK      KEY17,URNUMBER,SP70
          CALL      RSPTMI18
PTUNA100  CALL      RKPTMI18
          BRANCH    OVRCD,PTUNA999
.
          MATCH     URNUMBER,AURNO
          GOTO      PTUNA999 IF NOT EQUAL
.
          PACK      KEY25,AADMNO,SP70
          CALL      RDSUNAA1
PTUNA200  CALL      RDKUNAA1
          BRANCH    OVRCD,PTUNA100
.
          MATCH     DAADMNO,DPTUNADM
          GOTO      PTUNA100 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    DAADMNO,HTMLLINK
          APPEND    "')",HTMLLINK
.
          CALL      UROW0000
          GOTO      PTUNA200
.
PTUNA999  RETURN
+
.------------------------------------------------------------
. Output Inpatient Audit row
.------------------------------------------------------------
UROW0000  MOVE      SP70,TDESC
          MATCH     SP70,PTUNCANC
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSC,PTUNCANC,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      TDESC,SP70
            ENDIF
          ENDIF
.
          MOVE      SP70,ALTRTYPE
          MATCH     "1",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,UNADMIT,SP70
          ENDIF
          MATCH     "2",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,UNDSCH,SP70
          ENDIF
          MATCH     "3",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,CHGADM,SP70
          ENDIF
          MATCH     "4",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,CHGDSC,SP70
          ENDIF
          MATCH     "5",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,CANCPRE,SP70
          ENDIF
          MATCH     "6",PTUNTYPE
          IF        @EQUAL
            PACK      ALTRTYPE,CHGDRG,SP70
          ENDIF
          PACK      WBSENAM,SP70
          PACK      KEY10,PTUNAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF

          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DPTUNADM,"#",":
                             "#"",PTUNDATE,PTUNTIME,"#",":
                             "#"",ALTRTYPE,"#",":
                             "#"",PTUNODTE,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",TDESC,"#",":
                             "#"",PTUNOTTM,"#",":
                             "#"",PTUNOPRD,"#");"
.
UROW9999  RETURN
+
.------------------------------------------------------------
. Output Death Audit Details
.------------------------------------------------------------
DEATH000  PACK      KEY27,URNUMBER,SP70
          CALL      RSPMDAU1
DEATH100  CALL      RKPMDAU1
          BRANCH    OVRCD,DEATH999
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      DEATH999 IF NOT EQUAL
.
          MATCH     "001",PMDERTYP
          GOTO      DEATH100 IF NOT EQUAL
.
          CALL      DERW0000
          GOTO      DEATH100
.
DEATH999  RETURN
+
.------------------------------------------------------------
. Output Death Audit row
.------------------------------------------------------------
DERW0000  PACK      WBSENAM,SP70
          MATCH     SP70,PMDECUID
          IF        !@EQUAL
            PACK      KEY10,PMDECUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      "Invalid User",WBSENAM
            ENDIF
          ENDIF
.
          UNPACK    PMDEFL01,KEY8                      * Date of death
.
          MOVE      SP70,KEY3
          CMATCH    "Y",PMDEFL02
          IF        @EQUAL
            MOVE      "Yes",KEY3                       * Unknown Date of death
          ENDIF
.
          MOVE      SP70,KEY20
          MATCH     SP70,PMDEFL003
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSY,PMDEFL03,SP70     * Notification type
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,KEY20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          UNPACK    PMDEFL04,KEY10         * Death certificate number
.
          WRITE     HTMLFILE;"t.addRow(#"",PMDECDAT,PMDECTIM,"#",":
                             "#"",KEY8,"#",":
                             "#"",KEY3,"#",":
                             "#"",KEY20,"#",":
                             "#"",KEY10,"#",":
                             "#"",WBSENAM,"#");"
.
DERW9999  RETURN
+
.------------------------------------------------------------
. Output Advanced Care Plan Details
.------------------------------------------------------------
ADVCP000  MOVE      ZERO,F1
          PACK      KEY27,URNUMBER,Z70
          CALL      RSPMDAU1
ADVCP100  CALL      RPPMDAU1
          BRANCH    OVRCD,ADVCP999
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      ADVCP999 IF NOT EQUAL
.
          MATCH     "003",PMDERTYP
          GOTO      ADVCP100 IF NOT EQUAL
.
          ADD       ONE,F1
          CALL      ADVC0000
          GOTO      ADVCP100
.
ADVCP999  RETURN
+
.------------------------------------------------------------
. Output Advanced Care Plan row
.------------------------------------------------------------
ADVC0000  PACK      WBSENAM,SP70
          MATCH     SP70,PMDECUID
          IF        !@EQUAL
            PACK      KEY10,PMDECUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      "Invalid User",WBSENAM
            ENDIF
          ENDIF
.
          UNPACK    PMDEFL01,KEY3                      * Advanced care plan flag
.
          MOVE      SP70,KEY20
          MATCH     SP70,PMDEFL01
          IF        !@EQUAL
            PACK      KEY5,ANSP,NINE,PMDEFL01,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,KEY20
            ENDIF
          ENDIF
.
.
          CLEAR     HTMLLINK
          APPEND    "javascript:updateAdvCarePlan('",HTMLLINK
          APPEND    PMDEURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMDECDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMDECTIM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMDERTYP,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PMDECDAT,PMDECTIM,"#",":
                             "#"",KEY20,"#",":
                             "#"",WBSENAM,"#");"
.
ADVC9999  RETURN
+
.......................................................................
.  DISTM000 - display Teams
.    Tag Parameters   0=Description
.                     1=Code
.                     2=Selection List
.......................................................................
          DEFPROC   DISTM000
.
          INC       PMSTEMFD/INC
.
DISTM100  OPEN      PMSTEMA1,"pmstemaf"
.
DISTM200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,DISTM210,DISTM220
.
          UNPACK    SP70,PMTMTEAM,PMTMDESC       * default - display Desc
          PACK      KEY5,PMDTTEAM,SP8
          CALL      RDPMTEM1
          MATCH     SP70,PMTMDESC
          GOTO      DISTM999 IF EQUAL
          WRITE     HTMLFILE;PMTMDESC;
          GOTO      DISTM999
.
DISTM210  PACK      PMDTTEAM,PMDTTEAM,SP8        * display Code
          MATCH     SP70,PMDTTEAM
          GOTO      DISTM999 IF EQUAL
          WRITE     HTMLFILE;PMDTTEAM;
          GOTO      DISTM999
.
DISTM220  UNPACK    SP70,PMTMTEAM,PMTMDESC       * display selection list
          PACK      KEY5,SP8
          CALL      RSPMTEM1
DISTM221  CALL      RKPMTEM1
          BRANCH    OVRCD,DISTM999
.
          MATCH     "1",PMTMACTV
          GOTO      DISTM221 IF EQUAL            * don't display inactive codes
.
          MATCH     PMDTTEAM,PMTMTEAM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PMTMTEAM,"#" selected>":
                               PMTMDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PMTMTEAM,"#">":
                               PMTMDESC,"</option>"
          ENDIF
          GOTO      DISTM221
.
.
OVERCOND  MOVE      ONE,OVRCD
          RETURN
.
          INC       PMSTEMIO/INC
.
DISTM999  CLOSE     PMSTEMA1
.
          ENDPROC
+
.
.*******************************************************************************
. Update Program Maintenance Comments with new Program Expiry Date
.*******************************************************************************
UPPMC000  PACK      KEY40,PMUPG001,PMUPG002,PMUPG003,PMUPG004,PMUPG005:
                          PMUPG006,SP70
          CALL      RSPMUDT1
          CALL      RKPMUDT1
          BRANCH    OVRCD,UPPMC999
.
          MATCH     PMUTURNO,PMUPG001
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     PMUTATYP,PMUPG002
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     PMUTCTYP,PMUPG003
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     PMUTHFND,PMUPG004
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     PMUTHTAB,PMUPG005
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     PMUTEXPD,PMUPG006
          GOTO      UPPMC999 IF NOT EQUAL
.
          MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            PACK      PMUTEXPD,EXPIRYDT,SP70     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            PACK      PMUTATYP,ADMNTYPE,SP70     * New admission type
          ENDIF
.
          PACK      KEY40,PMUTURNO,PMUTATYP,PMUTCTYP,PMUTHFND,PMUTHTAB:
                          EXPIRYDT,PMUTCOMT,PMUTNNUM,SP70
.
          CALL      UPPMUDT1
.
UPPMC100  PACK      KEY43,PMUTURNO,PMUPG002,PMUTCTYP,PMUTHFND,PMUTHTAB:
                          PMUPG006,PMUTCOMT,PMUTNNUM,SP70
          CALL      RSPMUTX1
          CALL      RKPMUTX1
          BRANCH    OVRCD,UPPMC000
.
          MATCH     PMUTURNO,PMUXURNO
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUXATYP,PMUPG002
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUTCTYP,PMUXCTYP
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUTHFND,PMUXHFND
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUTHTAB,PMUXHTAB
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUXEXPD,PMUPG006
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUTCOMT,PMUXCOMT
          GOTO      UPPMC000 IF NOT EQUAL
.
          MATCH     PMUTNNUM,PMUXNNUM
          GOTO      UPPMC000 IF NOT EQUAL
.
UPPMC200  MATCH     Z70,EXPIRYDT
          IF        !@EQUAL
            PACK      PMUXEXPD,EXPIRYDT,SP70     * New expiry date
          ENDIF
.
          MATCH     Z70,ADMNTYPE
          IF        !@EQUAL
            PACK      PMUXATYP,ADMNTYPE,SP70     * New admission type
          ENDIF
.
          PACK      KEY43,PMUXURNO,PMUXATYP,PMUXCTYP,PMUXHFND,PMUXHTAB:
                          EXPIRYDT,PMUXCOMT,PMUXNNUM,PMUXLNUM,SP70
.
          CALL      UPPMUTX1
.
          GOTO      UPPMC100
.
UPPMC999  RETURN
.
.*******************************************************************************
. Missing AN-SNAP Assessments - WAH
.*******************************************************************************
MASS0000  CALL      CURPER00
          CALL      CALCDT00                   * Calc Next & Last Period Dates
.
          CLEAR     WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                   * Create Output File and
          BRANCH    EXIT,MASS9999              * Write HTML Page Header
.
          CALL      WEBBOD00                   * Process Web Body
.
          CALL      WEBEND00                   * Process End of HTML File
.
MASS9999  RETURN
.
.*******************************************************************************
. Missing AN-SNAP Assessment Details - WAH
.*******************************************************************************
MASD0000  BRANCH    FLDITMNO,MASD0100,MASD0200,MASD0300,MASD0400,MASD0500:
                             MASD0600,MASD0700,MASD0800,MASD0900,MASD1000
.
MASD0100  CALL      NEXT0000
          GOTO      MASD9999
.
MASD0200  CALL      PREV0000
          GOTO      MASD9999
.
MASD0300  CALL      CURSTD00                   * Current Start Date
          GOTO      MASD9999
.
MASD0400  CALL      CUREND00                   * Current End Date
          GOTO      MASD9999
.
MASD0500  CALL      SELV0000                   * View Type (Day Week Month)
          GOTO      MASD9999
.
MASD0600  MATCH     "1",OPTNCODE               * All Current admissions?
          IF        @EQUAL
            CALL      MASCA000    * Missing Assessments list (curr admissions)
          ELSE
            CALL      MAST0000    * Missing Assessments list (by discharge date)
          ENDIF
          GOTO      MASD9999
.
MASD0700  PACK      DFLTWARD,WARDCODE          * Ward Selection List
          CALL      WSEL0000
          GOTO      MASD9999
.
MASD0800  CALL      ASCD0000                   * Care Type Selection List
          GOTO      MASD9999
.
MASD0900  WRITE     HTMLFILE;OPTNCODE;         * Patient Type
          GOTO      MASD9999
.
MASD1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MASD9999
.
MASD9999  RETURN
.
.******************************************************************************
. Output AN-SNAP Assessment Type selection list - WAH
.******************************************************************************
ASCD0000  MOVE      ZERO,TCFORM6
          PACK      KEY5,CATCC,SP70
          CALL      RDSCODE1
ASCD1000  CALL      RDKCODE1
          BRANCH    OVRCD,ASCD9999
.
          MATCH     CATCC,TCODE
          GOTO      ASCD9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      ASCD1000 IF EQUAL
.
.         IF        IBCNMHOS=1
.           MATCH    "1",PTCDHOSS
.           GOTO      ASCD1000 IF NOT EQUAL
.         ENDIF
.
          IF        TCFORM6=4|TCFORM6=7|TCFORM6=8|TCFORM6=9|TCFORM6=10
            MATCH     ACODE,CARECODE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",ACODE,"#" selected>",TDESC:
                                   "</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",ACODE,"#">",TDESC,"</option>"
            ENDIF
          ENDIF
.
          GOTO      ASCD1000
.
ASCD9999  RETURN
.
.*******************************************************************************
. Table of Missing AN-SNAP Assessments - WAH (by discharge date)
.*******************************************************************************
MAST0000  MOVE      ZERO,ADMCNTR
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSDSCH2
MAST1000  CALL      RDKDSCH2
          BRANCH    OVRCD,MAST9999
.
          ADD       ONE,ADMCNTR
          IF        (ADMCNTR%300) = 0
            WRITE     HTMLFILE;"// keep alive comment "
          ENDIF
.
          MATCH     DDATE,LASTDATE
          GOTO      MAST9999 IF LESS        * Discharged after last period date
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MAST1000
.
          CALL      RDPMVX11
          IF        OVRCD=1
            PACK    PMVXMHOS,SP70
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      MAST1000 IF NOT EQUAL
          ENDIF
.
          CALL      CHKASE00                   * Check Assessments exists
          BRANCH    EXIT,MAST1000              * Exists; skip
.
.         Output list row details if no Assessments exist
.
          CALL      OUTROW00
          GOTO      MAST1000
.
MAST9999  RETURN
+
.*******************************************************************************
. Table of Missing AN-SNAP Assessments - WAH (all CURRENT admissions)
.*******************************************************************************
MASCA000  CALL      CLPATDSC
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
MASCA100  CALL      RDKMISS2
          BRANCH    OVRCD,MASCA999
.
          MATCH     "2",DASTAT
          GOTO      MASCA999 IF NOT EQUAL
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            PACK    PMVXMHOS,SP70
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      MASCA100 IF NOT EQUAL
          ENDIF
.
          CALL      CHKASE00
          BRANCH    EXIT,MASCA100
.
.         Output list row details if no Assessments exist
.
          CALL      OUTROW00
          GOTO      MASCA100
.
MASCA999  RETURN
+
.*******************************************************************************
. Check Assessment exists for an admission
.         EXIT      0 - None
.                   1 - Exists
.*******************************************************************************
CHKASE00  MOVE      ZERO,EXIT
          PACK      KEY30,DAADMNO,Z70          * Get relevant transfer info
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKASE91
.
          MATCH     DTADMN,DAADMNO
          IF        @EQUAL
            MOVE      TWARD,AWARD
            MOVE      TBED,ABED
            MOVE      TDEPT,ACLSSFT
            MOVE      TADOCT,ADOCTA
          ENDIF
.                                              * Check if Care Type matches
          MATCH     SP3,CARECODE
          IF        !@EQUAL
            MATCH     ACARE,CARECODE
            GOTO      CHKASE91 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Check if ward matches selection
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      CHKASE91 IF NOT EQUAL    * Next record loop
          ENDIF
.                                              * Get Associated Care Type
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKASE91
.
          MOVE      ZERO,MASSCNTR
          MATCH     SP3,CARECODE
          IF        @EQUAL
            COMPARE   FOUR,TCFORM6
            GOTO      CHKASE10 IF EQUAL
            COMPARE   SEVEN,TCFORM6
            GOTO      CHKASE10 IF EQUAL
            COMPARE   EIGHT,TCFORM6
            GOTO      CHKASE10 IF EQUAL
            COMPARE   NINE,TCFORM6
            GOTO      CHKASE10 IF EQUAL
            COMPARE   TEN,TCFORM6
            GOTO      CHKASE10 IF EQUAL
            GOTO      CHKASE91
.
CHKASE10    CALL      CTABW000
            CALL      GTABW000
            CALL      HTABW000
.           CALL      MTABW000
            CALL      RTABW000
            GOTO      CHKASE20
          ENDIF
.
          COMPARE   FOUR,TCFORM6
          IF        @EQUAL
            CALL      GTABW000
            GOTO      CHKASE20
          ENDIF
.
          COMPARE   SEVEN,TCFORM6
          IF        @EQUAL
            CALL      CTABW000
            CALL      RTABW000
            GOTO      CHKASE20
          ENDIF
.
          COMPARE   EIGHT,TCFORM6
          IF        @EQUAL
            CALL      GTABW000
.           CALL      MTABW000
            GOTO      CHKASE20
          ENDIF
.
          COMPARE   NINE,TCFORM6
          IF        @EQUAL
            CALL      HTABW000
            GOTO      CHKASE20
          ENDIF
.
          COMPARE   TEN,TCFORM6
          IF        @EQUAL
            CALL      RTABW000
            GOTO      CHKASE20
          ENDIF
.
          GOTO      CHKASE20
.
CHKASE20  IF        MASSCNTR > 0
            GOTO      CHKASE91         * Assessment counter > 0
          ENDIF
.
CHKASE90  MOVE      ZERO,EXIT          * no Assessments
          GOTO      CHKASE99
.
CHKASE91  MOVE      ONE,EXIT           * Assessments exists
CHKASE99  RETURN
+
.*******************************************************************************
.         Output list row details
.*******************************************************************************
OUTROW00  MOVE      AURNO,KEY8
          CALL      FMFT0000                   * Format output fields
.                                              * Get Care Type Description
          MOVE      CATCC,CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     HTMLLINK
          APPEND    "javascript:assessmentList('",HTMLLINK
          APPEND    AURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DAADMNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                                      "#"",FORMATNM,"#",":       * 1
                                      "#"",DAADMNO,"#",":        * 2
                                      "#"",DISPDACT,ATIME,"#",": * 3
                                      "#"",DISPDDSC,DTIME,"#",": * 4
                                      "#"",DOCFNAME,"#",":       * 5
                                      "#"",TDESC,"#",":          * 6
                                      "#"",WBDESC,"#",":         * 7
                                      "#"",KEY3,"#",":           * 8
                                      "#"",ADATE,ATIME,"#",":    * 9
                                      "#"",DDATE,DTIME,"#");"    * 10
.
OUTROW99  RETURN
+
.-----------------------------------------------------------------------------.
. Table of Missing PCPSS Assessments - WAH
.-----------------------------------------------------------------------------.
CTABW000  PACK      KEY24,DAADMNO,SP70
          CALL      RSALSAS1
CTABW100  CALL      RKALSAS1
          BRANCH    OVRCD,CTABW999
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CTABW999 IF NOT EQUAL
.
          MATCH     "1",ALSADELF                 * Deleted
          GOTO      CTABW100 IF EQUAL
.                                              * Output if no Assessment exists
CTABW900  ADD       ONE,MASSCNTR
.
CTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. Table of Missing GEM/FIM Assessments - WAH
.-----------------------------------------------------------------------------.
GTABW000  PACK      KEY24,DAADMNO,SP70
          CALL      RSPTFIM1
GTABW100  CALL      RKPTFIM1
          BRANCH    OVRCD,GTABW999
.
          MATCH     DAADMNO,PTFIVISN
          GOTO      GTABW999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT               * Deleted
          GOTO      GTABW100 IF EQUAL
.
          MATCH     "G",PTFITYPE
          GOTO      GTABW200 IF EQUAL
.
          MATCH     "R",PTFITYPE
          GOTO      GTABW200 IF EQUAL
.
          GOTO      GTABW100
.                                              * Get Associated Care Type
GTABW200  MOVE      CATCC,CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
.
          MATCH     SP3,CARECODE
          GOTO      GTABW900 IF EQUAL
.
          IF        TCFORM6=8 | TCFORM6=4
            GOTO      GTABW900
          ENDIF
.
          GOTO      GTABW999
.
GTABW900  ADD       ONE,MASSCNTR
.
GTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. Table of Missing HONOS 65+ Assessments - WAH
.-----------------------------------------------------------------------------.
HTABW000  PACK      KEY16,DAADMNO,SP70
          CALL      RSMHHON1
HTABW100  CALL      RKMHHON1
          BRANCH    OVRCD,HTABW999
.
          MATCH     DAADMNO,MHHNVISN
          GOTO      HTABW999 IF NOT EQUAL
.
          MATCH     "1",MHHNDELF               * Deleted
          GOTO      HTABW100 IF EQUAL
.
HTABW900  ADD       ONE,MASSCNTR
.
HTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. MMS Referral Assessment List - WAH
.-----------------------------------------------------------------------------.
MTABW000  PACK      KEY24,DAADMNO,SP70
          CALL      RSPMMMS1
MTABW100  CALL      RKPMMMS1
          BRANCH    OVRCD,MTABW999
.
          MATCH     DAADMNO,PMMMVISN
          GOTO      MTABW999 IF NOT EQUAL
.
          MATCH     "1",PMMMDELF                 * Deleted
          GOTO      MTABW100 IF EQUAL
.
MTABW900  ADD       ONE,MASSCNTR
.
MTABW999  RETURN
.
.*******************************************************************************
. Table of Missing RUG-ADL Assessments - WAH
.*******************************************************************************
RTABW000  PACK      KEY24,DAADMNO,SP70
          CALL      RSPMRUG1
RTABW100  CALL      RKPMRUG1
          BRANCH    OVRCD,RTABW999
.
          MATCH     PMRUVISN,DAADMNO
          GOTO      RTABW999 IF NOT EQUAL
.
          MATCH     ONEINIT,PMRUDELF
          GOTO      RTABW100 IF EQUAL
.
RTABW900  ADD       ONE,MASSCNTR
.
RTABW999  RETURN
.
+
.*******************************************************************************
. Advanced Care Plan Audit Maintenance
.*******************************************************************************
ADVCA000  MATCH     SP70,UPDTTYPE
          GOTO      ADVCA700 IF EQUAL
.
          MATCH     "U",UPDTTYPE                 * Update Adv Care Plan
          GOTO      ADVCA200 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete Adv Care Plan
          GOTO      ADVCA300 IF EQUAL
.
          GOTO      ADVCA900
.
ADVCA200  ***** check new key doesn't already exist ******
          PACK      KEY27,PMDAU001,PMDAU002,PMDAU003,PMDAU004,SP70
          CALL      RAPMDAU1
          IF        OVRCD<>1
            GOTO      ADVCA930
          ENDIF
.
          PACK      KEY27,PMDAU001,OLDAU002,OLDAU003,PMDAU004,SP70
          CALL      RDPMDAU1
          IF        OVRCD = 1
            GOTO      ADVCA920
          ENDIF
.
          CALL      MVPMDA00                     * move cgi to file
.
          CALL      UPPMDAU1                     * update details
.
          MOVE      ZERO,EXIT
          GOTO      ADVCA999
.
ADVCA300  PACK      KEY27,PMDAU001,PMDAU002,PMDAU003,PMDAU004,SP70 * Delete
          CALL      RDPMDAU1
          BRANCH    OVRCD,ADVCA920
.
          CALL      DEPMDAU1
.
          MOVE      ZERO,EXIT
          GOTO      ADVCA999
.
ADVCA700  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ADVCA910
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21                     * Read Pmi Extn
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      ADVCA700
          ENDIF
.
          PACK      KEY27,PMDAU001,PMDAU002,PMDAU003,PMDAU004,SP70
          CALL      RDPMDAU1
          IF        OVRCD=1
            MOVE       SP70,PMDEURNO
            MOVE       SP70,PMDECDAT
            MOVE       SP70,PMDECTIM
            MOVE       SP70,PMDERTYP
            MOVE       SP70,PMDEFL01
            MOVE       SP70,PMDEFL02
            MOVE       SP70,PMDEFL03
            MOVE       SP70,PMDEFL04
            MOVE       SP70,PMDEFL05
            MOVE       SP70,PMDEFL06
            MOVE       SP70,PMDEFL06
            MOVE       SP70,PMDEFL08
            MOVE       SP70,PMDEFL09
            MOVE       SP70,PMDEFL10
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Advanced Care Plan Audit",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMDAU999
.
          CALL      WEBBOD00   * Process Web Body
.
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ADVCA999
.
ADVCA900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADVCA999
.
ADVCA910  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADVCA999
.
ADVCA920  MOVE      "Invalid Advanced Care Plan Audit Record ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADVCA999
.
ADVCA930  MOVE      "Advanced Care Plan already on file.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADVCA999
.
ADVCA999  RETURN
+
.---------------------------------------------------------------------
. Move in Advanced Care Plan Audit details
.------------------------------------------------------------
MVPMDA00  MATCH     Z70,PMDAU001
          IF        !@EQUAL
            MOVE       PMDAU001,PMDEURNO
          ENDIF
.
          MATCH     Z70,PMDAU002
          IF        !@EQUAL
            MOVE       PMDAU002,PMDECDAT
          ENDIF
.
          MATCH     Z70,PMDAU003
          IF        !@EQUAL
            MOVE       PMDAU003,PMDECTIM
          ENDIF
.
          MATCH     Z70,PMDAU004
          IF        !@EQUAL
            MOVE       PMDAU004,PMDERTYP
          ENDIF
.
          MATCH     Z70,PMDAU005
          IF        !@EQUAL
            MOVE       PMDAU005,PMDEFL01
          ENDIF
.
MVPMDA99  RETURN
+
.*******************************************************************************
. Get Attending Doctor
.*******************************************************************************
GDOC0000  IF        ASTAT=1
            WRITE     HTMLFILE;ADOCTA;
          ELSE
            WRITE     HTMLFILE;TADOCT;
          ENDIF
.
GDOC9999  RETURN
+
.------------------------------------------------------------
. FHIR Condition (Problem)
.------------------------------------------------------------
RESCND00  PACK     FHRCONID,PMPBURNO,PMPBPNUM,SP70
          PACK     FHRPATID,PMPBURNO,SP70
          PACK     FHRENCID,PMPBURNO,PMPBLVIS,SP70
          REP      " -",FHRCONID
          SQUEEZE  FHRPATID
          REP      " -",FHRENCID
          CALL      PATNAM00
          MOVE      "wz",CATEGORY
          MOVE      PMPBRVST,CODE
          CALL      GETCOD00
          MOVE      TDESC,RVSTDESC
          STRIP     WBTPFIL  *  Template
          PACK      KEY10,PMPBESBY
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          WRITE    HTMLFILE;*+,"{ #"resourceType#": #"Condition#",":
                    "  #"id#" : #"PRB-",FHRCONID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-asserter-code#"":
                        " ,#"valueString#":#"",PMPBESBY,"#"},":
                    " { #"url#":#"%BASEURL/extension/URNumber#"":
                        " ,#"valueString#":#"",PMPBURNO,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-onset-time#"":
                        " ,#"valueString#":#"",PMPBESTI,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-problem-number#"":
                        " ,#"valueString#":#"",PMPBPNUM,"#"},";
.
          WRITE     HTMLFILE;"        {  #"url#" : #"%BASEURL/extension/dxc-hc-problemstatus-code#",";
          WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
          WRITE     HTMLFILE;"                #"coding#": [ {";
          WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-wx#", ";
          WRITE     HTMLFILE;"                  #"code#": #"",PMPBPRST,"#" ";
.
          PACK      KEY5,CATWX,PMPBPRST,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
          ENDIF
.
          WRITE     HTMLFILE;"                 } ]";
          WRITE     HTMLFILE;"            }";
          WRITE     HTMLFILE;"        }";
.
          MATCH    SP70,PMPBDCOD
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;", { #"url#":#"%BASEURL/extension/dxc-hc-abatement-time#"":
                        " ,#"valueString#":#"",PMPBARTI,"#"}";            
.
          ENDIF
.
          MATCH    SP70,PMPBNRDT
          IF       !@EQUAL & !@EOS
.
            UNPACK    PMPBNRDT,DIM4,DIM2,DIM2A
.
            WRITE     HTMLFILE;", { #"url#":#"%BASEURL/extension/dxc-hc-nextreview-date#"":
                        " ,#"valueString#":#"",DIM4,DASH,DIM2,DASH,DIM2A,"#"}";
.
          ENDIF
.
          MATCH    SP70,PMPBNRTI
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;", { #"url#":#"%BASEURL/extension/dxc-hc-nextreview-time#"":
                        " ,#"valueString#":#"",PMPBNRTI,"#"}";
.
          ENDIF
.
          MATCH    SP70,PMPBDCOD
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       ,{  #"url#" : #"%BASEURL/extension/dxc-hc-diagnosis-code#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"http://hl7.org/fhir/ValueSet/icd-10#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",PMPBDCOD,"#" ";
.
            MOVE      PMPBESDT,ICDRDDTE
            PACK      KEY9,PMPBDCOD,SP70
            CALL      RDPTICD1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",DDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        }";
.
          ENDIF
.
          MATCH    SP70,PMPBDSC1
          IF       !@EQUAL & !@EOS
          WRITE     HTMLFILE;*+,",{ #"url#":#"%BASEURL/extension/dxc-hc-description-1#"":
                        " ,#"valueString#":#"",PMPBDSC1,"#"}";
          ENDIF
.
          MATCH    SP70,PMPBDSC2
          IF       !@EQUAL & !@EOS
          WRITE     HTMLFILE;*+,",{ #"url#":#"%BASEURL/extension/dxc-hc-description-2#"":
                        " ,#"valueString#":#"",PMPBDSC2,"#"}";
          ENDIF
.
          MATCH     SP70,PMPBRVST
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;"       ,{  #"url#" : #"%BASEURL/extension/dxc-hc-reviewstatus-code#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-wz#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",PMPBRVST,"#" ";
.
            PACK      KEY5,CATWZ,PMPBRVST,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        }";
          ENDIF


.UPTOHERE
          WRITE    HTMLFILE;*+," ],":
                    "  #"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#", ":
                    "                  #"display#" : #"",PATFNAME,"#" },";
          MATCH    SP70,PMPBESBY
          IF       !@EQUAL
            WRITE     HTMLFILE;*+,"  #"asserter#": { #"reference#" : #"Practitioner/User-",PMPBESBY,"#",":
                    "   #"display#": #"",WBSENAM,"#" },";
          ENDIF
          MATCH    SP70,PMPBLVIS
          IF       !@EQUAL
             WRITE    HTMLFILE;*+,"  #"content#":  ":
                        "  { #"reference#" : #"Encounter/",FHRENCID,"#"}, ";
          ENDIF
.
.          MOVE      "ww",CATEGORY
.          MOVE      PMPBPRID,CODE
.          CALL      GETCOD00
.          MOVE      TDESC,PRIDDESC
.          MATCH     SP70,CODE
.          IF        !@EQUAL
.             PACK     KEY5,CATEGORY,CODE
.             STRIP    KEY5
.             REP      " -",KEY5
.             WRITE    HTMLFILE;*+,"  #"severity#" : {":
.                        "  #"coding#" : [":
.                        "     { #"system#"    : #"%BASEURL/ValueSet/Category-ww#",":
.                        "       #"code#"      : #"",PMPBPRID,"#",":
.                        "       #"display#"   : #"",PRIDDESC,"#" } ":
.                        "     ] },";
.          ENDIF
.
          MOVE      "wy",CATEGORY   
          MOVE      PMPBPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRTYDESC
          MATCH     SP70,CODE
          IF        !@EQUAL
             PACK     KEY5,CATEGORY,CODE
             STRIP    KEY5
             REP      " -",KEY5
             WRITE    HTMLFILE;*+,"  #"category#" : {":
                        "  #"coding#" : [":
                        "     { #"system#"    : #"%BASEURL/ValueSet/Category-wy#",":
                        "       #"code#"      : #"",PMPBPRTY,"#",":
                        "       #"display#"   : #"",PRTYDESC,"#" } ":
                        "     ] },";
          ENDIF
.
          WRITE    HTMLFILE;*+,"  #"code#" : {":
                      "  #"coding#" : [ {";
          MATCH    SP70,PMPBDCSY
          IF       !@EQUAL
            WRITE    HTMLFILE;*+," #"system#"      : #"",PMPBDCSY,"#",";
          ENDIF
          MATCH    SP70,PMPBDCOD
          IF       !@EQUAL
            WRITE    HTMLFILE;*+," #"code#"      : #"",PMPBDCOD,"#",";
          ENDIF
          STRIP    PMPBDSC1
          STRIP    PMPBDSC2
          WRITE    HTMLFILE;*+," #"display#"   : #"",PMPBDSC1,SP1,PMPBDSC2,"#" } ":
                     "     ] },";
.
          MOVE      "wx",CATEGORY
          MOVE      PMPBPRST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRSTDESC
          MATCH     SP70,PRSTDESC
          IF        !@EQUAL
             STRIP    PRSTDESC
             REP      DOWNCASE,PRSTDESC
             WRITE    HTMLFILE;*+,"  #"clinicalStatus#":     #"",PRSTDESC,"#",";
          ENDIF
.
          UNPACK   PMPBESDT,CCENT,CYEAR,CMON,CDAY
          WRITE    HTMLFILE;*+,"  #"onsetDateTime#" : #"":
                               CCENT,CYEAR,DASH,CMON,DASH,CDAY,"#"";
          MATCH    SP70,PMPBARDT
          IF       !@EQUAL
            UNPACK   PMPBARDT,CCENT,CYEAR,CMON,CDAY
            WRITE    HTMLFILE;*+,",  #"abatementDateTime#" : #"":
                                 CCENT,CYEAR,DASH,CMON,DASH,CDAY,"#"";
          ENDIF
          WRITE    HTMLFILE;*+,"}" 
RESCND99  RETURN
.
.*******************************************************************************
. Inpatient Allied Health Contacts
.*******************************************************************************
ICON0000  CALL      CURPER00
          CALL      CALCDT00                   * Calc Next & Last Period Dates
.
          CLEAR     WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                   * Create Output File and
          BRANCH    EXIT,ICON9999              * Write HTML Page Header
.
          CALL      WEBBOD00                   * Process Web Body
.
          CALL      WEBEND00                   * Process End of HTML File
.
ICON9999  RETURN
.
.*******************************************************************************
. Inpatient Allied Health Contact tags
.*******************************************************************************
ITAG0000  BRANCH    FLDITMNO,ITAG0100,ITAG0200,ITAG0300,ITAG0400,ITAG0500:
                             ITAG0600,ITAG0700,ITAG0800,ITAG0900,ITAG1000:
                             ITAG1100
.
ITAG0100  CALL      NEXT0000
          GOTO      ITAG9999
.
ITAG0200  CALL      PREV0000
          GOTO      ITAG9999
.
ITAG0300  CALL      CURSTD00                   * Current Start Date
          GOTO      ITAG9999
.
ITAG0400  CALL      CUREND00                   * Current End Date
          GOTO      ITAG9999
.
ITAG0500  CALL      SELV0000                   * View Type (Day Week Month)
          GOTO      ITAG9999
.
ITAG0600  MATCH     "1",OPTNCODE               * All Current admissions?
          IF        @EQUAL
            CALL      IAHTA000    * Missing Assessments list (curr admissions)
          ELSE
            CALL      IAHT0000    * Missing Assessments list (by discharge date)
          ENDIF
          GOTO      ITAG9999
.
ITAG0700  PACK      DFLTWARD,WARDCODE          * Ward Selection List
          CALL      WSEL0000
          GOTO      ITAG9999
.
ITAG0800  CALL      ASCD0000                   * Care Type Selection List
          GOTO      ITAG9999
.
ITAG0900  WRITE     HTMLFILE;OPTNCODE;         * Patient Type
          GOTO      ITAG9999
.
ITAG1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ITAG9999
.
ITAG1100  MOVE      "CC",CATEGORY              * Unit Selection List
          MOVE      CARECODE,CODE
          CALL      CODSEL00
          GOTO      ITAG9999
.
ITAG9999  RETURN
.
.*******************************************************************************
. Table of IP Admissions for AH Contacts (Current Admissions)
.*******************************************************************************
IAHTA000  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
IAHTA100  CALL      RDKMISS2
          BRANCH    OVRCD,IAHTA999
.
          MATCH     "2",DASTAT
          GOTO      IAHTA999 IF NOT EQUAL
.
          CALL      CLPATDSC
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            PACK    PMVXMHOS,SP70
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      IAHTA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CARECODE
          IF        !@EQUAL
            MATCH     ACARE,CARECODE
            GOTO      IAHTA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      IAHTA100 IF NOT EQUAL
          ENDIF
.
          CALL      IAHROW00
          GOTO      IAHTA100
.
IAHTA999  RETURN
.
.*******************************************************************************
. Table of IP Admissions for AH Contacts - (By Discharge Date)
.*******************************************************************************
IAHT0000  MOVE      ZERO,ADMCNTR
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSDSCH2
IAHT1000  CALL      RDKDSCH2
          BRANCH    OVRCD,IAHT9999
.
          ADD       ONE,ADMCNTR
          IF        (ADMCNTR%300) = 0
            WRITE     HTMLFILE;"// keep alive comment "
          ENDIF
.
          MATCH     DDATE,LASTDATE
          GOTO      IAHT9999 IF LESS        * Discharged after last period date
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,IAHT1000
.
          CALL      RDPMVX11
          IF        OVRCD=1
            PACK    PMVXMHOS,SP70
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      IAHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CARECODE
          IF        !@EQUAL
            MATCH     ACARE,CARECODE
            GOTO      IAHT1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                * position on admission
          CALL      RDPTRAN2                * read previous record
          BRANCH    OVRCD,IAHT1000          * shouldn't happen
.
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      IAHT1000 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      IAHT1000 IF NOT EQUAL
          ENDIF
.
          CALL      IAHROW00
          GOTO      IAHT1000
.
IAHT9999  RETURN
.
.*******************************************************************************
. Output IP admissions for AH contacts list row details
.*******************************************************************************
IAHROW00  MOVE      ZERO,ADMCNTR               * Reset keep alive count
.
          MOVE      AURNO,KEY8
          CALL      FMFT0000                   * Format output fields
.                                              * Get Care Type Description
          MOVE      CATCC,CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
.
          PACK      KEY32,DAADMNO,Z70
          CALL      RSPMENC2                   * Get last contcat date/time
IAHROW10  CALL      RPPMENC2
          BRANCH    OVRCD,IAHROW15
.
          MATCH     DAADMNO,PMENVISN
          GOTO      IAHROW15 IF NOT EQUAL
.
          MATCH     "1",PMENRSTA               * Deleted
          GOTO      IAHROW10 IF EQUAL
.
          GOTO      IAHROW20
.
IAHROW15  CALL      CLPMSENC
.
IAHROW20  CLEAR     HTMLLINK
          APPEND    "javascript:addContact('",HTMLLINK
          APPEND    AURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DAADMNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:linkPatient('",HTMLLNK2
          APPEND    AURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    DAADMNO,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                                      "#"",FORMATNM,"#",":           * 1
                                      "#"",DAADMNO,"#",":            * 2
                                      "#"",DISPDACT,ATIME,"#",":     * 3
                                      "#"",DISPDDSC,DTIME,"#",":     * 4
                                      "#"",DOCFNAME,"#",":           * 5
                                      "#"",TDESC,"#",":              * 6
                                      "#"",WBDESC,"#",":             * 7
                                      "#"",KEY3,"#",":               * 8
                                      "#"",ADATE,ATIME,"#",":        * 9
                                      "#"",DDATE,DTIME,"#",":        * 10
                                      "#"",PMENSDAT,PMENSTIM,"#",":  * 11
                                      "#"",SP1,"#",":                * 12     
                                      "#"",HTMLLNK2,"#");"           * 13
.
IAHROW99  RETURN
.
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Condition Resource asserter include
.------------------------------------------------------------------------------
RESPRA00  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            MOVE      SP70,DIM20
            MOVE      "w0",CATEGORY
            PACK      KEY5,CATEGORY,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          MATCH     SP70,WBSEDOC
          IF        !@EQUAL
            PACK      KEY10,WBSEDOC,SP70
          ELSE
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      KEY10,WBSEGPCD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            MOVE      SP70,TDESC
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCSPC1
              IF        !@EQUAL
                MOVE      "DT",KEY2
                PACK      KEY5,KEY2,PMHCSPC1,SP70
                CALL      RDCODE1
                IF        OVRCD=1
                  MOVE      SP70,TDESC
                ENDIF
              ENDIF
            ENDIF
            STRIP     KEY10
          ENDIF
.
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"User-",PMPBESBY,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-role#"":
                        " ,#"valueString#":#"",DIM20,"#"}";
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{ #"url#": #"%BASEURL/extension/dxc-hc-hcp#"":
                                "  ,#"valueReference#" : #"Practitioner/HCP-",KEY10,"#"}";
          ENDIF
.
          MATCH     SP70,TDESC
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{#"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                                  ",#"valueString#" : #"",TDESC,"#"}";
          ENDIF
.
          WRITE     HTMLFILE;" ],":
                    " #"identifier#": {":
                    "   #"use#": #"official#",":
                    "   #"system#": #"%BASEURL#",":
                    "   #"value#": #"",WBSELOGN,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": [":
                    "{ #"use#": #"usual#",":
                    "  #"text#": #"",WBSENAM,"#",":
                    "  #"family#": #".#",":
                    "  #"given#": [#"",WBSENAM,"#"] ":
                    "} ]";
.
          MATCH     SP70,WBSEEMAI
          IF        !@EQUAL
             WRITE     HTMLFILE;*+,",";
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"email#",":
                       "  #"value#": #"",WBSEEMAI,"#" } ]";
          ENDIF
.
          WRITE     HTMLFILE;*+,"  } ";
.
RESPRA99  RETURN
+
.------------------------------------------------------------
. FHIR Exit Sucess
.------------------------------------------------------------
FHREXT00  IF        FHIRTYPE<>1
            CALL      WINCLS00
            GOTO      FHREXT99
          ENDIF
.
          PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,FHREXT99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                             "  #"id#": #"allok#", ":
                             "  #"text#": { ":
                             "    #"status#": #"additional#", ":
                             "    #"div#": #"<div>All Ok</div>#" ":
                             "  }, ":
                             "  #"issue#": [ ":
                             "    { ":
                             "      #"severity#": #"information#", ":
                             "      #"code#": #"informational#", ":
                             "      #"details#": { ":
                             "        #"text#": #"All Ok#"":
                             "  } } ] }"
.
          CALL      CLOSHTML
FHREXT99  RETURN
+
          INC       APSMASIO/INC
          INC       ALLPCTIO/INC
          INC       BOKRC1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       PATIN1IO/INC
          INC       PATPR1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       OUTSITIO/INC
          INC       PATVISIO/INC
          INC       PATFN1IO/INC
          INC       PATDO1IO/INC
          INC       PATALRIO/INC
          INC       PATMA1IO/INC
          INC       PMSEVTIO/INC
          INC       PATDSCIO/INC
          INC       PATHSPIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATDADIO/INC
          INC       PATRE1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSTLEIO/INC
          INC       PMSRELIO/INC
          INC       PMSDTCIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSUPGIO/INC
          INC       PMSAPGIO/INC                                    * CAR 257776
          INC       PMSPRGIO/INC                                    * CAR 257776
          INC       PMSPITIO/INC                                    * CAR 257776
          INC       PMSIGRIO/INC                                    * C-0841644 
          INC       PMSIMPIO/INC                                    * CAR 257776
          INC       PMSRUGIO/INC
          INC       PMSMMSIO/INC
          INC       ALLSASIO/INC
          INC       MEHHONIO/INC
          INC       PMSSNCIO/INC
          INC       PMSSNPIO/INC                                    * CAR 257776
          INC       PATFIMIO/INC                                    * CAR 257776
          INC       OPRNURIO/INC                                    * CAR 257776
          INC       PMSUPOIO/INC
          INC       PMSHPGIO/INC
          INC       PMSHPOIO/INC
          INC       PATTRNIO/INC
          INC       PATUNAIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSENCIO/INC
          INC       PMSVX1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSPRBIO/INC
          INC       PMSAUPIO/INC
          INC       PMSDAUIO/INC
          INC       PMSUDTIO/INC
          INC       PMSUTXIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPATMIS
          INC       CLPATMAS
          INC       CLPATDSC
          INC       CLPMSENC
          INC       CLPMSUDT
          INC       CLPMSUPG
          INC       CLPMSUPO
          INC       DGCLICAC
          INC       IBAWEBCD
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMIGTNID
          INC       PMSPX2TM
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSHPGTM
          INC       PMSHPOTM
          INC       PMSRUGTM
          INC       PMSUPGCD
          INC       PMSUPGTM
          INC       PMSAPGTM                                        * CAR 257776
          INC       PATFIMTM                                        * CAR 257776
          INC       PATNAMCD                                        * CAR 257776
          INC       CLPATFIM                                        * CAR 257776
          INC       PMSUDTTM
          INC       PMSUPOTM
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       FHRDATCD
          INC       DAYOFWEK
          INC       TFILENAM
          INC       MODTIMFN
