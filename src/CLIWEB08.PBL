.-------------------------------------------------------------------------------
. Program       : CLIWEB08 
.
. Function      : Patient Correspondence Details 
.
. Modifications  :
.-------------------------------------------------------------------------------
. V12.00.04 20/10/2025  Ebon Clements  TSK 0961623
.           Added open of OUTBOKA3 and OUTBB1A1 to OPNOUT00
. V12.00.03 09/10/2025  J.Tan          TSK 0966942
.           Mod DELCOR00 - to Clear linked document from the Alert
. V12.00.02 08.10.2025  DA Sarkies     TSK 0964039
.           Added DocumentType ind6 (OBPCCTYP) to be returned as parameter 17
.           in SRTROW00
. V12.00.01 22/05/2025  Alina Bhari    TSK  0955096
.           Added alpanumeric visit number generation 
.           -BVISUP00,MRTCOD11,MRTCOD30,MRTCOD40,GETLTR00
. V11.05.03 08.10.2025  DA Sarkies     TSK 0964039
.           Added DocumentType ind6 (OBPCCTYP) to be returned as parameter 17
.           in SRTROW00
. V11.05.02 02/06/2025  Don Nguyen     TSK 0960938
.           Recompiled for PATNAMCD
. V11.05.01 11/04/2025  J.Tan          Task 0945921
.           Mod to remove Hold invoice for Upload document
. V11.04.12 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.11 22.07.2024  DA Sarkies      TSK 0939978
.           Added code to flag whether MyHR Button is disabled or not
. V11.04.10 05.06.2024  DA Sarkies      TSK 0939978
.           Added seaction to retrieve MyHR Consent Value
. V11.04.09 13/05/2024  Ebon Clements   TSK 0946661
.           Added PTCNEPIS parameter test to open and read of pmsehbaf
. V11.04.08 24/04/2024  Peter Vela          0939978
.           Added NIHC parameter check around MISC0500
. V11.04.07 13/03/2024  Peter Vela      TSK 0939978
.           Added Upload MyHR functionality to PCORRD10
. V11.04.06 06/03/2024  Peter Vela      TSK 0939978
.           Added NIHC Phase 3 functionality @ PCORRD000
.           Added NIHC related tags in MISC0000
.           Added trap around pmsndb
.           Added validation in WDSA0000 for NIHC document upload
. V11.04.05 06/03/2024  Don Nguyen      TSK 0917199
.           Modified create IFC logic to use "HOS" when single-hospital and
.           there is no record in the Hospital Details file (pathspaf); CREATIFC
. V11.04.04 27/02/2024  Don Nguyen      TSK 0917199
.           Modified create IFC logic to use the visit Hospital Code when
.           multi-hospital, otherwise use the web user's Hospital Code; CREATIFC
. V11.04.03 15/01/2024  Don Nguyen      TSK 0917199
.           Modified format of pipe-delimited data fields in the output file
.           for 'CreateIFCXML' script.
. V11.04.02 05/12/2023  Alina Bhari     TSK 0939178
.           Fixed Issue with writting view record to clinical document audit
. V11.04.01 24/11/2023  Alina Bhari     TSK 0939178
.           Write View Record to clinical document audit - PCORRD70
. V11.03.06 15/11/2023  Don Nguyen      TSK 0917199
.           Added ability to create an IFC .xml file (EpiSoft); via CREATIFC
. V11.03.05 25.09.2023   Sunny          TSK 0937587
.           Recompiled for FHRDATDF - Changed FHRWLOCC from DIM20 to DIM21
. V11.03.04 08/09/2023  Sunny           TSK 0937314
.           Fixed FHIR DocumentReference structure, context is not aligned with 
.           FHIR stu3 Standards 
. V11.03.03 31/07/2023  Peter Vela     TSK 0927262
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
.           to Practitioner User resource
. V11.03.02 14/06/2023  Peter Vela    TSK 0927262
.           ClinicalAide FHIR api
.           Added Subject include FHRSUBIN functionality
.           Added Author include FHRPARIN functionality
. V11.03.01 17/05/2023  Ebon Clements  TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.02.07 30/08/2022  Bella Turco    TSK 0921957
.           Continued adding PTCNNRTD to maintenance lists           
. V11.02.06 29/07/2022  Bella Turco    TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.05 29/04/2022 Ebon Clements   TSK 0888071
.           Added trigger to update visit extension file Adm paperwork,
.           consent form and medical history received to patient correspondence
.           delete report 1 - TVIS0000
. V11.02.04 01/04/2022  Jill Parkinson Task 0918603
.           Changed reha length from 387 to 418 and rehd from 155 to 398
. V11.02.03 11.03.2022  Alina Bhari    TSK 0913264
.           Added cgi variable RESLNK08
.           Added the selection list for laboratory
.           - MISC0200,RESLABFD,RESLABIO,RESLABA1
. V11.02.02 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 28/01/2022 Ebon Clements   TSK 0888071
.           Added trigger to update visit extension file Adm paperwork,
.           consent form and medical history received to patient correspondence
.           report 1 - TVIS0000
. V11.01.04 06.07.2021  DA Sarkies     TSK 0908383
.           Fixed quotes in relation to CB issues
. V11.01.03 21/06/2021  Ebon Clements  TSK 0907882
.           Set CPYFXCT3 to ZERO in CLRPAR00
. V11.01.02 02/03/2021  Don Nguyen     TSK 0903525
.           Re-worded error handling messages added previously for Task 0898865;
.           explicitly reference the 'ConvertHTML2PDF' script in the error
.           message (NEWCOR98).
. V11.01.01 16/02/2021  Don Nguyen     TSK 0902240
.           Added code to process '3rd Copy To Fax Number' (COPYTOP3); for HEA
.-------------------------------------------------------------------------------
. V11.00.02 09/12/2020  Don Nguyen     TSK 0898865
.           Added error handling in NEWCOR00 & UPDCOR00 for file uploads
.           09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 21/10/2020  Ebon Clements  TSK 0886441
.           Don't try to print discharge summary is SELPRINT is EOS - PRTA0000
.-------------------------------------------------------------------------------
. V10.13.02 05/12/2018  Don Nguyen     TSK 0838558
.           Deleted temp file (TEMPFILE) after processing (PCORRD00)
. V10.13.01 13/09/2018  Don Nguyen     TSK 0860288
.           Modified SendDocument routine (SENDD000) to only execute script if
.           necessary. Also cleared Fax number parameter (SENDTOPH) for
.           subsequent script execution for other Copy To fields.
.-------------------------------------------------------------------------------
. V10.12.05 07.06.2018  Richa Phogat   TSK 0850937
.           Added CORR6100 to display Clinical Document link only when documents
.           exististing for a particular visit have docment type as clinical and
.           Cat wi - indicator 3 = C
. V10.12.04 07.06.2018  Richa Phogat   TSK 0856928
.           Added check for SENDFAXB and ELECSENT under NEWCOR80 to create a
.           sent audit type when a document is sent via FAX or Electronically
. V10.12.03 29.05.2018  Richa Phogat   TSK 0856928
.           Added condition under NEWCOR80 to not create a sent autdit type when
.           a new clinical document is added/created
. V10.12.02 26.03.2018  Ebon Clements  TSK 0850163
.           Set exit to 1 after WEBERR00 call at PCORRD91
.           Added branch on exit after calls to WDSA0000
.           Added branch on exit after calls to PRTA0000
. V10.12.01 07.03.2018  Ania P         TSK 0852610
.           Added HPFX0000 for returning correct fax number
.-------------------------------------------------------------------------------
. V10.11.06 04.12.2017  B.G.Ackland    TSK 0835482 
.           FHIR Add Document Filter by Status
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 12.10.2017  Peter Vela     TSK 0845449
.           Changed branches to display error messages in NEWCOR90
. V10.11.03 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.02 03/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
.-------------------------------------------------------------------------------
. V10.10.06 15.06.2017  Ebon Clements  TSK 0833949 
.           SQUEEZE white space from fax numbers - SENDD000
. V10.10.05 07.06.2017  Ebon Clements  TSK 0833949 
.           Added sendtype 5 and copy to fax number - SENDD000
. V10.10.04 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
. V10.10.03 24.04.2017  B.G.Ackland    TSK 0835482 
.           FHIR Binary Resource Output 
. V10.10.02 13/04/2017  Jill Parkinson TSK 0836736
.           Added check for booking records when validating admissno
. V10.10.01 22.02.2017  Jill Parkinson TSK 0832932
.           Added write of Sent Audit records for clinical documents
. V10.09.03 22.02.2017  Jill Parkinson TSK 0832932
.           Recompiled for HL7REFDF to pack use KEY3 in WROBX00 and squeeze
.           RF1SEQ11
. V10.09.02 22.02.2017  Jill Parkinson TSK 0832932
.           Recompiled for HL7REFDF to pack HL7FILEN with KEY3
. V10.09.01 11.02.2017  B.G.Ackland    TSK 0832932
.           Generate a HL7 REF-I12 message file to send document to another system.
.           Used to securely transmit Discharge Summary type document using the
.           Telstra HealthConnex Argus product.
.           Message file to be written to a directory that can be polled by
.           the hospitals HL7 Interface Engine or a location that allows the Argus
.           product to pick up and send the message.
. V10.08.06 21.10.2016  B.G.Ackland    TSK 0824561
.           Validate Admission and UR Valid
. V10.08.05 20.06.2016  B.G.Ackland    TSK 0821137
.           Fix Username Display in Clinical Documents View
. V10.08.04 09.06.2016  J.Tan          TSK 0301518 
.           Mods to display Clinical Doc. for patient with No visit
. V10.08.03 25.05.2016  Jill Parkinson TSK 0819378 
.           Mods to display wbsenam in DISTAB00
. V10.08.02 03.05.2016  Brian Ackland   CAR 0769674
.           Forms Toolkit Access to Clinical Documents
. V10.08.01 24.03.2016  Brian Ackland   CAR 0769674
.           Fix SendDocument Execution to pass parameters 
.           and handle Copy To HCP or EMAIL Address
. V10.07.03 03/03/2016  Peter Mc        CAR 808331
.           Stop document security check on wrong user (document loader).
. V10.07.02 11.01.2016  B.G.Ackland     CAR 0809101
.           Added code to accept AJAX Type Call to Add Patient Document
.           Added CALLTYPE to identify AJAX Calls
.           REPLACED CALL to WEBERR00 to CALL SHWERR00
.           NXTPAG00 to Branch on CALLTYPE for AJXEND00
. V10.07.01 05.11.2015  Steve Armstrong  CAR 303363
.           Recompiled for changes to RESHEAFD
.----------------------------------------------------------------------
. V10.06.04 25.08.2015  Peter Vela      CAR 316185
.           Added validation for Able to be Electronically Sent in WDSA0000
. V10.06.03 20.08.2015  Davin           CAR 317991
.           Save default printer after printing document (UPDEFP00 @ PRTA9500)
. V10.06.02 10.07.2015  B.G.Ackland     CAR 319313
.           Added AJAX Remote Check for Draft Document Existing
. V10.06.01 17.03.2015  Peter Vela      CAR 305590
.           Added deleted validation to PATIMG00
. V10.05.06 19.02.2015  Peter Vela      CAR 309788
.           Added functionality to keep current draft for wahealth NEWCOR80
. V10.05.05 06.02.2015  B.G.Ackland     CAR 307632
.           Added Filter by Indicator 3
. V10.05.04 04.02.2015  Peter Vela      CAR 305590
.           Changed imgPath to OBPTURLP
. V10.05.03 02.02.2015  Peter Vela      CAR 305590
.           Skip deleted images in IMGLST00
. V10.05.02 04.12.2014  Peter Vela      CAR 301518
.           Validate for zero visit number in AUDLST00
. V10.05.01 08.10.2014  Peter Vela      CAR 301518
.           Added Clinical Documents audit functionality OBSAUDFD
. V10.04.08 18.06.2014  B.G.Ackland     CAR 283010
.           Additional Parameters Passed to ConvertHTML2PDF for Draft and Hospital Recognition
. V10.04.07 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.06 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.05 19/03/2014 B.G.Ackland    CAR 298934 
.           Added Patient Photo as Document Upload Type
.           Alias photopic request parameter for corsp001 to handle webcam
.           upload
.           New Update Type to Return View of Document UPDTTYPE=V
.           File View Script cliweb08.us2 
. V10.04.04 12/03/2014 B.G.Ackland    CAR 298700
.           Implement File Upload Control Script cliweb08.us1
.           This is executed on the upload temporary file before it is moved to
.           a storage location.
.           cliweb08.us1 <upload user id> <upload file> <storage location and
.           file>
.           The script can be configured to check the file and user id.  
.           If the file is not allowed to be uploaded it should be replaced.
.           17/03/2014 J.Tan          CAR 290918
.           Added new fields to Discharge Summary
. V10.04.03 20/02/2014 Steve Armstrong   CAR 290918
.           Recompiled for changes to PMSDSDFD
. V10.04.02 20/01/2014 Patrick Adair  CAR 293445
.           Increased CORSP001 to 100 to match eAdmissions File Name length
. V10.04.01 10/01/2014 Jill Parkinson CAR 293909
.           Increased htmlline to 4000
.-------------------------------------------------------------------------------
. V10.03.07 22/04/2013  Ebon Clements  CAR 261630
.           Removed port number from temp file name
. V10.03.06 05/04/2013  Don Nguyen     CAR 281647
.           Opened indexes PMSHCPA1 and PMSHCGA1 to get HCP details
. V10.03.05 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.04 21.03.2012  B.G.Ackland  CAR 265085
.           Draft Document Display
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 16/01/2012  B.G.Ackland
.           Updated for v10.00 changes for creating documents
. V10.03.01 24/11/2011  Jill Parkinson   CAR 249362
.           Added alert counter to obspcoaf
.-------------------------------------------------------------------------------
. V10.02.02 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.01 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
.-------------------------------------------------------------------------------
. V10.00.01 19/05/2010  Jill Parkinson CAR 207094
.           Added writes to pmsdsdaf and execute of fax script
.-------------------------------------------------------------------------------
. V9.12.01  18/02/2010  Jill Parkinson CAR 207094
.           Changed htmlline from 80 to 200
.-------------------------------------------------------------------------------
. V9.09.02  28/11/2007  Davin         CAR 151898
.           Added Parent Redirect routine (nextpage=5)
. V9.09.01  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
.-------------------------------------------------------------------------------
. V9.08.02  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.01  25/10/2006  Jill Habasque  CAR 121320
.           Added discharge summary list
.-------------------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 20/02/2006  Ebon Clements     CAR 76341   
.           Added referral and encounter file audit
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
.-------------------------------------------------------------------------------
. V9.04.01  22/12/2004 Ebon Clements CAR 56056
.           Added functionality to add a clinical document linked to a      
.           patient alert
.-------------------------------------------------------------------------------
. V9.03.04  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.03  26/03/2004  Peter Vela AR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
.           10/02/2004  Peter Vela CAR 38290
.           Added functionality for opening yearly RESLNKFD files
.           (reln1999, reln2000, reln2001, reln2002, etc...)
. V9.03.02  16/10/2003 Davin         CAR 39038
.           Added new table format to CORROW00 routine
. V9.03.01  23/06/2003 Ebon Clements CAR 40610
.           Changes NEWCOR00 to check for EOS in the admission number
.           This was a bug found for the Capital Coast Demonstration
.           14/04/2003 Tonii CAR 37193
.           Ported 5.10 changes:
.              Add an Unlock before CALL to WEBRED00
.              Correct Record Unlocking in DELCOR00 & UPDCOR00
.-------------------------------------------------------------------------------
. V9.02.06  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.05  18/12/2002 Jill Habasque SRF 34657
.           Recompiled for RESCLNCD - Added link types 07 and 08
. V9.02.04  09/10/2002 Peter Vela SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.03  06/03/2001 Harvinder SRF 15820
.                      Modified PCORRD70 routine to read the OBSPCTFD file
.                      Added CORR3300 to display location id of stored document
.                      Added CORR3400 to display whether location is Read Only ?
.                      Added CORR3500 to display Current Storage Location
. V9.02.02  03/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.01  11.09.2001 Harvinder
.           Modified for zero urnumber display in emergency
.-------------------------------------------------------------------------------
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  13.08.2001 J.Tan
.           Recompiled for PATMASTM
.-------------------------------------------------------------------------------
. V9.00.B04 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B03 18.06.2001 Ebon Clements 
.           Added allied health referral key details
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
.           Update Masterfile Indicator 4 for Clinical Document
.----------------------------------------------------------------------
.            V5.10.01 22.03.2001 B.G.Ackland
.                     I * D on Double Clicking
.            V5.09.03 24/01/2001 B.G.Ackland   
.                     Fix Year for Result Data Files
.            V5.09.02 12/01/2001 Bronko Sosic  
.                     Recompiled for PATMASTM / PATMISTM
.            V5.08.08 16.10.2000 B.G.Ackland
.                     Fix Headings
.            V5.08.07 15.10.2000 B.G.Ackland
.                     Implement Security
.            V5.08.06 28/09/2000 Bronko Sosic  
.                     Recompiled for PATMASTM / PATMISTM
.            V5.08.05 28.09.2000  Katie Nelson
.                     Replaced space with zero on last update date
.            V5.08.04 16/08/2000  Caleb Sharman
.                     Changed Health Fund variables to be 8 chars
.            V5.08.03 19/07/2000 Katie Nelson
.                     Added width to cells in correspondence table to stop
.                     the date/to/from cells from wrapping
.            V5.08.02 09/06/2000 Katie Nelson
.                     Changed the correspondence list to reverse order
.                     07.06.2000 B.G.Ackland
.                     Recompiled for PATMASTM                      
.            V5.08.01 25/05/2000 Pat Dirito 
.                     Recompiled for PATMASTM                      
.            V5.07.13 23/03/2000 Bronko Sosic
.                     Added startkey for GOTO button in option two
.	     V5.07.12 08/03/2000
.                     Fixed Display & save of OBPTROLY,OBPTCLDT &
.                     Display of current storage location tick box 
.                     23/02/2000 B.G.Ackland   
.                     Make Sure Fields Cleared before Display
.	     V5.07.11 15/02/2000 Pat Dirito    
.                     Added javascript control to ShowDetail
.	     V5.07.10 02/02/2000 Steven Watkins
.                     Recompiled for PATMASTM / PATMISTM
.            V5.07.09 14.01.2000 B.G.Ackland   
.                     Change Correspondence Table and Update
.            V5.07.08 13.01.2000 B.G.Ackland   
.                     New Fields in Download Table
.            V5.07.07 12.01.2000 B.G.Ackland   
.                     Updated Table to Handle Non Visit Related Correspondence
.            V5.07.06 11.01.2000 Katie Nelson  
.                     Fixed input date in add correspondance for Taranaki 
.            V5.07.05 06.01.2000 Katie Nelson  
.                     Y2K date correction in INPDTE00                      
.            V5.07.04 29.12.1999 B.G.Ackland  
.                     Recompiled for IBAWEBDF/IBAWEBCD                     
.            V5.07.03 20.12.1999 Katie Nelson 
.                     Recompiled for IBAWEBDF/IBAWEBCD                     
.            V5.07.02 11.11.1999 Katie Nelson 
.                     Added update routine CURLOC00 into the update option
.            V5.07.01 03.11.1999 Katie Nelson 
.                     Recompiled for WEBDATCD/DAYOFWEK                   
.            V5.07.00 17.06.1999 Pat Dirito
.                     Added Option 4 Download Data Fields Maintenance
.                     Added Option 5 Download Type Maintenance
.                     Added Option 6 Download Details Maintenance
.            V6.06.00 23.04.1999 Pat Dirito 
.                     Created Program
.                     06.05.1999 Katie Nelson
.                     Added Correspondence Table Maintenance Option
.
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    

          INC       WEBDATDF
          INC       FHRDATDF
          INC       ALLCONFD/INC
          INC       ALLENCFD/INC
          INC       ALLDEPFD/INC
          INC       ALLLINFD/INC
          INC       ALLREFFD/INC
          INC       ALLRLNFD/INC
          INC       APSMASFD/INC
          INC       ARCVX1FD/INC
          INC       CORFLDFD/INC      *  Download Download Fields
          INC       CORTYPFD/INC      *  Download Type 
          INC       CORDTTFD/INC      *  Download Details 
          INC       EMRCONFD/INC
          INC       EMRVISFD/INC
          INC       EMRICDFD/INC
          INC       EMRVCDFD/INC
          INC       EMRSITFD/INC
          INC       IBAPOLFD/INC
          INC       PATONLFD/INC

          INC       PMSBRQFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATCHCFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDGWFD/INC
          INC       PATFN1FD/INC
          INC       PATHSPFD/INC
          INC       PATIN1FD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PATNIDFD/INC
          INC       PATIPEFD/INC
          INC       PATONHFD/INC
          INC       PMSDSDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSPX2FD/INC
          INC       PMSNPLFD/INC            * NIHC IHI Polling
          INC       PMSPX2TD/INC
          INC       PMSWORFD/INC
          INC       PATRE1FD/INC
          INC       OBSAUDFD/INC
          INC       OBSPCOFD/INC       * Patient Correspondence
          INC       OBSPCTFD/INC       * Correspondence Storage Location Table
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       PATVISFD/INC
          INC       PATVADFD/INC
          INC       PATTRNFD/INC
          INC       PATDADFD/INC
          INC       PMSVX1FD/INC
          INC       OBSCNAFD/INC
          INC       PMSCCDFD/INC       * Concession Card Details
.
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATPR1FD/INC
          INC       PATWR1FD/INC
          INC       PATMI1FD/INC
          INC       AAEDI1FD/INC
          INC       AAEDE1FD/INC
          INC       BOKRC1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTDIAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTMA1FD/INC
          INC       OUTCTYFD/INC
          INC       OUTHEDFD/INC
          INC       OUTSESFD/INC
          INC       MRTCONFD/INC
          INC       MEHCONFD/INC
          INC       MEHVI1FD/INC
          INC       MRTVISFD/INC
          INC       MLTSECFD/INC
          INC       MRTMASFD/INC
          INC       MRTAUCFD/INC
          INC       MRTLOCFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       RESCLNFD/INC
          INC       RESLURFD/INC
          INC       RESLNKFD/INC
          INC       RESHEAFD/INC
          INC       PATALRFD/INC
          INC       PMSCEXFD/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
          INC       PMSEVTFD/INC
          INC       PMSNDBFD/INC
          INC       HL7CODFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       TFILEVAR/INC
          INC       HL7REFDF
.
          INC       RESLABFD/INC
          INC       IBALPCFD/INC
          INC       PMSEHBFD/INC
.
. HL7 Text Message Variables
.
SNDAPP    INIT      "webPAS.cliweb08"
MSGTYPE   INIT      "REF^I12"
.
. Variable Declarations  
.
AAEVFLAG  FORM      1
ALERTDES  DIM       20
ALLVISIT  FORM      1
ATYPDESC  DIM       25
CFILEPRE  DIM       3
CTYPDESC  DIM       25
DESTINAT  DIM       50
.
FILTDEPT  DIM       3
FILTDCTY  DIM       3   * Document Type Filter
FILTUSER  DIM       10  * User Filter
FILTAUTY  DIM       1   * Audit Type Filter
FILTAUDS  DIM       28  * Audit Type Filter Description
FILTDCDS  DIM       20  * Document Type Desc
FILTWEBU  DIM       30  * User Name Full Desc
.
FOLDERSF  DIM       3
FORM10    FORM      10
.
IPEVENT   INIT      "EV-IP"
OPEVENT   INIT      "EV-OP"
EMEVENT   INIT      "EV-EM"
.
LSTCLIN   DIM       6
.
RESLNK01  DIM       8   * Result Date
RESLNK02  DIM       5   * Time
RESLNK03  DIM       10  * DSS
RESLNK04  DIM       2   * Status
RESLNK05  DIM       1   * Normal
RESLNK06  DIM       25  * Provider
RESLNK07  DIM       20  * Reference
RESLNK08  DIM       3   * Laboratory code
ELECSENT  DIM       1
NIHCDOIN  DIM       1
NIHCHRIN  DIM       1
NMPNUMB   DIM       20
RECIPIEN  DIM       10
PRACTICE  DIM       10
PRACCNTR  DIM       2
.
RESULTKY  DIM       17
REFERLKY  DIM       8
RESULTYR  DIM       4
REFTDESC  DIM       20
YEAROPEN  DIM       4
UNIQUEID  FORM      4
TABCFLAG  FORM      1
AT        INIT      "@"
PREHEA    INIT      "reha"
PREHEB    INIT      "rehb"
PREHEC    INIT      "rehc"
PREHED    INIT      "rehd"
PREDEA    INIT      "reda"
PREDEB    INIT      "redb"
PREDEC    INIT      "redc"
PRELEN    INIT      "reln"    * I CAR 38290
.
CMNDLINE  DIM       127
DATELUPD  DIM       11        * last update date
DATELACC  DIM       11
DTYPDESC  DIM       25
LINKTYPE  DIM       2
LINKKEYS  DIM       10
.
.
HL7TABID  DIM       4
SAVISIT   DIM       8         * Input date          
SLOTNUMB  DIM       3
FORM8     FORM      8
CURRDATE  DIM       8         * Current date
CMDLINE   DIM       300       * Command line instruction
CMDPARA   DIM       100       * Command line parameters
CORRESID  FORM      4
COPYFKEY  DIM       20        * Document Copied From Key
CORSFILE  DIM       20     
CORSP001  DIM       100       * Correspondence File Name
CORSP002  DIM       8         * Input date          
CORSP003  DIM       3         * Type of correspondance
CORSP004  DIM       8         * Input Time        
CORSP005  DIM       1         * Mark as deleted 
CORSP006  DIM       2         * Security Level  
CORSP007  DIM       50        * Comment 1
CORSP008  DIM       50        * Comment 2
CORSP009  DIM       30        * From 
CORSP010  DIM       30        * To
CORSP011  DIM       3         * User Def Code 1
CORSP012  DIM       3         * User Def Code 2 1
CORSP013  DIM       3         * User Def Y/N 1  
CORSP014  DIM       3         * User Def Y/N 1   
CORSP015  DIM       8         * User Def Date 1  
CORSP016  DIM       8         * User Def Date 2  
CORSP017  DIM       2         * Alert Category
CORSP018  DIM       3         * Alert Code
CORSP019  DIM       3         * Alert Counter
DOCINDIC  DIM       1
DOCFNAM3  DIM       50
DOCFNAM4  DIM       50
DOCFNAM5  DIM       50
DOCFNAM6  DIM       50
DRAFTDOC  DIM       1         * Current Draft Document   1=true
HTMLLINE  DIM       4000        * HTML Page Submitted
HTMLLNK2  DIM       200
HTMLLNK3  DIM       200
HTMLLNK4  DIM       200
HTMLCNT   FORM      6         * HTML Page Submitted
TEMPNAME  DIM       8         * HTML Page Submitted
TEMPNAM1  DIM       13        
TEMPFILE  FILE      ASCII,FIXED=127
.
AUDITKEY  DIM       20        * Key to Patient Correspondence Table
AMBERSND  INIT      "\&"
ADMNDATE  DIM       12
.
CLAIMCOD  DIM       6
CODESTAT  FORM      1
CODEDESC  DIM       40
CHCDATA   DIM       30
.
DISPCLSS  DIM       11
.
DASH      INIT      "-"
DATE      DIM       11        * Correspondence Date
DETAILKY  DIM       20        * Key to Patient Correspondence Table
DETAILK1  DIM       20        * Save obspco key for Upload MyHR in PCORRD10
DESCSNAG  DIM       20
DIM4      DIM       4
DIM6      DIM       6
DIM8      DIM       8
DIM20     DIM       20
DIM100    DIM       100
DOCTCODE  DIM       6
DISCDATE  DIM       12
.
EMRGFLAG  DIM       1         * Flag for emergency
EPSCD001  FORM      2
EPSDDATT  DIM       25
EPISDTIM  DIM       8
EPISDDAT  DIM       8
EPSADATT  DIM       25
EPISATIM  DIM       8
EPISADAT  DIM       8
.
FORMACTN  DIM       3         * Form Action      
.
GENCHCDS  FORM      1
GENITNOW  FORM      1
.
INPTDATE  DIM       8         * parameter used in INPDTE00 to display a date
INPTWUID  DIM       10        * parameter used in DISUSR00 to display user 
INUSDESC  DIM       30
.
EMGSTAT1  INIT      "Current"
.
INPSTAT1  INIT      "Pre-adm"
INPSTAT2  INIT      "Current IP"
INPSTAT3  INIT      "Discharged"
INPSTA3A  INIT      "Disc-"
INPSTA3B  INIT      "Cancelled"
INPSTAT4  INIT      "Leave"
INPSTAT5  INIT      "Cancel"
ALLSTAT0  INIT      "Waiting"
ALLSTAT1  INIT      "Active"
ALLSTAT2  INIT      "Closed"
ALLSTAT3  INIT      "Inactive"
ALLSTAT4  INIT      "Cancelled"
ALLSTAT5  INIT      "Rejected"
.
LSTDOCT   DIM       6
.
KEYBED    DIM       3
KEYWRD    DIM       3
KEY8A     DIM       8
.
LINKTYP   DIM       3         * Type of Correspondence 
LNK2PRT   FORM      1
.
MHLRCODE  DIM       3
MBSDESC   DIM       40
CMDMOVE   INIT      "mv "
CMDFCHK   INIT      "cliweb08.us1 "
CMDVIEW   INIT      "cliweb08.us2 "
FHIRBIN   INIT      "cliweb08.us3 "
ONCLCLSS  INIT      "CareColour"
.
MEH01     INIT      "MEHWEB01"
.
NEXTPAGE  FORM      1         * Nextpage parameter
.
OBPCT001  DIM       4         * Storage Location ID
OBPCT002  DIM       80        * Storage Directory
OBPCT003  DIM       80        * URL Prefix
OBPCT004  DIM       1         * Read ONly 0=NO, 1=YES
OBPCT005  DIM       8         * Date Closed
OBPCT006  DIM       1         * Set as Cuurent Storage Location 0=No, 1=Yes
OBSPCOKY  DIM       20
OUTVAR    DIM       127
FILEPATH  DIM       127
.
SAVEPKEY  DIM       24
SAVKEY20  DIM       20
.
CATWI     INIT      "wi"
CATw0     INIT      "w0"
CLIDF001  DIM       5         * Data Field Number
CLIDF002  DIM       50        * Description
CLIDF003  DIM       20        * Group Description
CLIDF004  DIM       8         * Table
CLIDF005  DIM       8         * Field
.
CLICT001  DIM       5         * Download Type
CLICT002  DIM       35        * Description
CLICT003  DIM       2         * Security Level
CLICT004  DIM       5         * Copy from
CLICT005  DIM       5         * Copy to
.
CLICD001  DIM       5         * Download Type
CLICD002  DIM       5         * Data Field Number
CLICD003  DIM       3         * Download Sequence 
CLICD004  DIM       25        * Heading Name 
CLICD005  DIM       1         * Convert to Title Text
.
CODERNAM  DIM       35
CODEDFLG  FORM      1
.
DISCFLAG  FORM      1
DISPCART  DIM       20
DESCDOCM  DIM       30
DESCHOME  DIM       30
.
EDDISDOC  DIM       50
EDDISDIA  DIM       70
EMRVFTIM  DIM       8
EMRVFDAT  DIM       8
EMRFLAG   FORM      1
.
INFORMGP  DIM       1
HOSPTEXT  DIM       50
WARDBED   DIM       43
SHOWALLH  FORM      1
SHOWFRMT  DIM       1
SHOWPPRV  DIM       1
PMSVX044  DIM       3
.
ADIADESC  DIM       25
DDIADESC  DIM       2
PDIADESC  DIM       200
PRIDISCD  DIM       9
ARCFLAG   FORM      1
AUDITDTE  DIM       12
EVNTFLAG  FORM      1
FAXNUMBR  DIM       20
KPCRDRFT  DIM       1
NOCANVIS  DIM       1
RESLNKFL  DIM       8         * File name var for reslnk CAR 38290
RECIPNAM  DIM       20
SENDFAXB  DIM       1
TESTKEY   DIM       16        * Last Update date and time
TIME      DIM       5         * Time displayed in 00:00 format 
UPDATEKY  DIM       16        * Update key(date & time of last update) 
UPDTTYPE  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
UPDHLINV  DIM       1         * Remove Hold Invoice
STARTKEY  DIM       10        * Starting Key
CORRTYPE  DIM       5         * Current Field Number for Next & Prev pages
CORRDESC  DIM       35        * Download Type Description 
SECOPT    DIM       1
SHOWCARE  DIM       1
VSTATUS   DIM       100
VISTDATE  DIM       12
VISTRCOD  DIM       20
VISTDAY   DIM       5
VISTCOMH  INIT      "COM"
VISTEMER  INIT      "EMG"
VISTOUTP  INIT      "OP"
VISTINPT  INIT      "IP"
VISTALLH  INIT      "RF"
VISTEVNT  INIT      "EV"
VISTFLAG  FORM      1
VISTTIME  DIM       10
VISTLOC   DIM       70
VISCOUNT  FORM      5
VISTHOSP  DIM       3
VISADIAG  DIM       12
VISTTYPE  DIM       5
VISTDESC  DIM       25
VOLNDESC  DIM       16
.
WARDNAME  DIM       25
.
OEVSTA0   INIT      "Outpatient-ATTENDED"
OEVSTA1   INIT      "Outpatient-NO ATTENDANCE"
OEVSTA2   INIT      "Outpatient-CANCELLED"
OBRACKET  INIT      "("
CBRACKET  INIT      ")"
.
LOKKEY20  DIM       20                                               * I-90207
SAVE2PDF  FORM      1
HTML2PDF  INIT      "ConvertHTML2PDF"
SENDSUMM  INIT      "SendDischargeSummary"
PRINTEXE  INIT      "PrintDocument"
SENDTEXE  INIT      "SendDocument"
.
SETDFPRG  DIM       8         * Program ID for default printer
SETDFRPT  DIM       2         * Report No for default printer
.
SENDTYPE  FORM      1         * Passed to SendDocument.
.                                1=Fax
.                                2=Email
.                                3=Secure Gateway
.                                4=HL7 RF1 Messaging
.                                5=Fax ED Discharge Summary
SENDTOPH  DIM       25        * Passed to SendDocument. Fax to Phone Number
SENDFREM  DIM       70        * Passed to SendDocument. Email From Address
SENDTOEM  DIM       70        * Passed to SendDocument. Email To Address
COPYTOCT  FORM      1         * Email Copy to Count
COPYTOEM  DIM       70[9]     * Passed to SendDocument. CC Email Addresses (Not Implemented)
COPYPHCT  FORM      1         * 'Copy To Fax Number' Count
CPYFXCT3  FORM      1         * 'Copy To Fax Number' Count (3rd Copy To Fax)
COPYTOPH  DIM       25[9]     * 'Copy To Fax Number' (Passed to SendDocument)
COPYTOP3  DIM       25[9]     * 'Copy To Fax Number' (3rd Copy To Fax Number)
HCPFROMC  DIM       10        * Send From HCP Code (Not Implemented)
HCPSENDC  DIM       20        * Send To HCP Code/Practice Used to determine Provider No
HCPCOPCT  FORM      1         * HCP Copy to Count
HCPCOPYC  DIM       20[9]     * Copy To HCP Code/Practice Used to determine Provider No
PRINTFMT  DIM       10        * Printing Format for HTML to PDF conversion
DRAFTDES  DIM       20        * Display Draft
PATLINK   DIM       127       * Link to the next patient info
FILTER03  DIM       1         * Filter by Document List by Document Type (wi) Indicator 3
DOCTTYPE  DIM       3
DOCTSTAT  DIM       1
DOCSTCOD  DIM       20
DOCCLCOD  DIM       1
DOCCLDES  DIM       20
DOCTYCOD  DIM       20
DOCTYDES  DIM       50
CALLTYPE  FORM      1   * 0=Page, 1=AJAX
FHSTATUS  DIM       20  * FHIR Filter by Status Request parameter
.FHRSTAT   DIM       20
.FHRPATID  DIM       8
.FHRENCID  DIM       16
FHRDOCID  DIM       20
FHRFIRST  FORM      1
FHRCONFL  FORM      1
FHRCONID  DIM       13
SAVEWUID  DIM       10
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.
UNITCODE  DIM       6
UNITDESC  DIM       20
.
CATTC     INIT      "tc"
.
FHRDOCIN  FORM      1 
FHRSUBIN  FORM      1      * _include=DocumentReference:subject
FHRPARIN  FORM      1      * _include=DocumentReference:author
FHRCETIN  FORM      1      * _include=DocumentReference:content
FHRCXTIN  FORM      1      * _include=DocumentReference:context
.
.
CREATIFC  FORM      1      * Create an IFC (Informed Financial Consent) XML file
CREATNCF  FORM      1      * Create NCF (National Claim Form); Stationary Templt
IFCXHOSP  DIM       3      * IFC Hospital Code
IFCXEADM  DIM       20     * IFC eAdmission Number (Unique ID)
IFCXCLAI  DIM       3      * IFC Claim Code
IFCXELOS  DIM       15     * Total Exp. LOS $ (numeric value in 12.2 format)
IFCNCFCO  DIM       6      * NCF Stationary Code
.
CREAIFCX  INIT      "CreateIFCXML"
TXTFILEX  INIT      ".txt"
.
LABELTYP  DIM       10      * Type of Label To Print Coded Field
STATNCOD  DIM       6       * Stationary Code Coded Field
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
.
.*******************************************************************************
.*                   IFC file                                                  *
.*******************************************************************************
IFCFLTXT  FILE       HL7, FIXED=4096
.
.Name     Type      Size  Description
.----     ----      ----  -----------
IFCFHOSP  DIM          3  Hospital ID
.PIPE     DIM          1  Pipe Delimiter
IFCFEPID  DIM         20  EpiSoft ID
.PIPE     DIM          1  Pipe Delimiter
IFCFURNO  DIM          8  UR Number
.PIPE     DIM          1  Pipe Delimiter
IFCFADMN  DIM          8  Admission No.
.PIPE     DIM          1  Pipe Delimiter
IFCFLNAM  DIM         20  Last Name
.PIPE     DIM          1  Pipe Delimiter
IFCFFNAM  DIM         25  First Name
.PIPE     DIM          1  Pipe Delimiter
IFCFHFUN  DIM          6  Health Fund
.PIPE     DIM          1  Pipe Delimiter
IFCFFNUM  DIM         10  Health Fund Member No.
.PIPE     DIM          1  Pipe Delimiter
IFCFELOS  DIM         15  TotalELosCost (numeric value in 12.2 format)
.PIPE     DIM          1  Pipe Delimiter
IFCFUNID  DIM          4  Communication ID (unique identifier for each IFC doc)
.PIPE     DIM          1  Pipe Delimiter
IFCFACLA  DIM          3  Claim Type
.
STRETURN  FORM      1
.
.------------------------------------------------------------------------------
PRGID     INIT      "CLIWEB08"
VERSION   INIT      "V12.00.04"
PRGNAM    INIT      "Patient Correspondence Details"
.------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      UUOBPC1        * Unlock record                  * I-90207
          CALL      WEBRED00       * Read Fifo WEBPID and USERID    * C-90207
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      SHWERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PCORRD00  * Patient Correspondence Details           
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              * next page
          GOTO      MAIN1000
.
MAIN1200  CALL      CORMAN00  * Correspondence Table Maintenance           
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              * next page
          GOTO      MAIN1000
.
MAIN1300  CALL      CORDAT00  * Correspondence List by Date/Type
          GOTO      MAIN1000
.
MAIN1400  CALL      CORFLD00  * Download Data Fields Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              * next page
          GOTO      MAIN1000
.
MAIN1500  CALL      CORTYP00  * Download Type Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              * next page
          GOTO      MAIN1000
.
MAIN1600  CALL      CORDET00  * Download Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              * next page
          GOTO      MAIN1000
.
MAIN1700  CALL      CHKDOC00  * AJAX Check Document Available 
          GOTO      MAIN1000
.
MAIN1800  CALL      RHLINV00  * Remote script to check for Hold Invoice
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      SHWERR00
          STOP
.-------------------------------------------------------------------------------
. Check Document Available
.-------------------------------------------------------------------------------
CHKDOC00  CALL      XMLHED00
          PACK      KEY20,URNUMBER,ADMISSNO,Z70
          CALL      RSOBPC1
CHKDOC10  CALL      RPOBPC1
          BRANCH    OVRCD,CHKDOC90
          MATCH     URNUMBER,OBPCURNO
          GOTO      CHKDOC90 IF NOT EQUAL
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      CHKDOC90 IF NOT EQUAL
          MATCH     DOCTTYPE,OBPCCTYP
          GOTO      CHKDOC10 IF NOT EQUAL
          MATCH     DOCTSTAT,OBPCMDEL
          GOTO      CHKDOC10 IF NOT EQUAL
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OBPCURNO,OBPCCVIS,OBPCCPID:
                             "</RETURN_VALUE>"
          GOTO      CHKDOC99
.
CHKDOC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE></RETURN_VALUE>"
.
CHKDOC99  CALL      XMLEND00
          RETURN
.-------------------------------------------------------------------------------
.         Check for Hold invoice
.-------------------------------------------------------------------------------
RHLINV00  CALL      XMLHED00
          BRANCH    EXIT,RHLINV99
.
          CALL      CHLD0000                * Check if remove hold inv.required
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1,"|",PTCDLDES,"|":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
RHLINV99  RETURN
+
.-------------------------------------------------------------------------------
.  Next Page URL
.-------------------------------------------------------------------------------
NXTPG000  BRANCH    CALLTYPE,NXTPG100
          IF        NEXTPAGE=0 
            CALL      WINCLS00      * Refresh parent and close window
          ENDIF
 
          IF        NEXTPAGE=1      
            CALL      RDIREC00      * Redirect URL       
          ENDIF
.
          IF        NEXTPAGE=2      
            CALL      GOBACK00      * Go Back 1 html page 
          ENDIF 
.  
          IF        NEXTPAGE=3     
            CALL      DAH20000      * Go Back 2 html pages   
          ENDIF
.
          IF        NEXTPAGE=4     
            CALL      REDMAP00      * Redirect to map view for emergency   
          ENDIF
.
          IF        NEXTPAGE=5     
            CALL      PREDIR00      * parent redirect   
          ENDIF
          GOTO     NXTPG999
.
NXTPG100  CALL     AJXEND00
.
NXTPG999  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
.         REDMAP00
.------------------------------------------------------------
REDMAP00  CALL      OPENHTML
          BRANCH    EXIT,REDMAP90
.
          MATCH     "1",PTCNUFFR
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#"> {":
                               "getTop().location.reload();":
                               "}":
                               "</script>"
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               "top.location.reload();":
                               "}":
                               "</script>"
          ENDIF
.
          CALL      OPENHTML
          GOTO      REDMAP99
.
REDMAP90  DISPLAY   "*** Fifo Not Found ***"
.
REDMAP99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00
          CALL      GETTZ000
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      ALLLINA1,"alllinaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      HL7CODA1,"hl7codaf"
          OPEN      CORFLDA1,"corfldaf"
          OPEN      CORTYPA1,"cortypaf"
          OPEN      CORDTTA1,"cordttaf"
          OPEN      CORDTTA2,"cordttaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATCHCO1,"patchcof"
          OPEN      PATCHCO2,"patchcof"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      IBAPOLA1,"ibapolaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MRTAUCA2,"mrtaucaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      OBSCNAA1,"obscnaaf"
          OPEN      OBSAUDA1,"obsaudaf"
          OPEN      OBSAUDA2,"obsaudaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCOA2,"obspcoaf"
          OPEN      OBSPCOA3,"obspcoaf"
          OPEN      OBSPCOA4,"obspcoaf"
          OPEN      OBSPCOA5,"obspcoaf"
          OPEN      PMSDSDA1,"pmsdsdaf"
          OPEN      PATNIDA1,"patnidaf" 
.          OPEN      PMSNDBA2,"pmsndbaf"
.
          OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATONHA1,"patonhaf"
.         OPEN      RESLNKA1,"reslnkaf"        * D CAR 38290
.         OPEN      RESLNKA3,"reslnkaf"        * D CAR 38290
          OPEN      RESLURA1,"resluraf"
          OPEN      RESCLNA1,"resclnaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      OUTSITA1,"outsitaf"
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          CALL      OPICD1                      * Open ICD Disease files
          CALL      OPICO1                      * Open ICD Operation files
.
          OPEN      PATICDO1,"paticdof"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATI10O1,"pati10of"
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
.
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSEVTA1,"pmsevtaf"
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSHCGA1,"pmshcgaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,SIXTY;*133,MRCNEPSC
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,*69,MHCNUSE,*82,MHCNDVIS
          READ      CONTROLF,EIGHTY9;*180,EMCNLDAT
          READ      CONTROLF,HUND06;*217,ALCNCLNF
          READ      CONTROLF,HUND12;*101,PTCNUFFR,*104,PTCNWBDS
          READ      CONTROLF,HUND14;*87,PTCNRSAP,*95,PTCNRSFC,*103,PTCNRRAP:
                                    *111,PTCNRRFC,*119,PTCNRMIC,*131,PTCNRHLV:
                                    *239,PTCNDSCL
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND25;*238,PTCNNRTD,*246,PTCNINVH

.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPNAME
.
          CLEAR     TEMPNAM1
          APPEND    TEMPNAME,TEMPNAM1
          APPEND    "/html",TEMPNAM1
          RESET     TEMPNAM1
.
          OPEN      RESLABA1,"reslabaf"
.
          MOVE      ZERO,ARCFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ARCVX1A1,"arcvx1af"
          TRAPCLR   IO
          IF        OVRCD=0
            MOVE      ONE,ARCFLAG
          ENDIF
.
          OPEN      IBALPCA1,"ibalpcaf"
.
          MATCH     "1",PTCNEPIS       * Using Episoft Interface
          IF        @EQUAL
            OPEN      PMSEHBA1,"pmsehbaf"
          ENDIF
.
          MATCH     "3",PTCNUNET
          IF        @EQUAL
            OPEN      PMSNPLA1,"pmsnplaf"
            OPEN      PMSNDBA2,"pmsndbaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      SP70,URNUMBER 
          MOVE      SP70,ADMISSNO
          MOVE      SP70,DOCTTYPE
          MOVE      SP70,DOCTSTAT
          MOVE      SP70,FHSTATUS
          MOVE      SP70,FORMACTN
          MOVE      SP70,COPYFKEY
          MOVE      SP70,DRAFTDOC
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,UPDATEKY
          MOVE      SP70,VIEWTYPE
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,STARTKEY
          MOVE      SP70,CORRTYPE
          MOVE      SP70,FILTER03
          MOVE      SP70,DETAILKY
          MOVE      SP70,AUDITKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,UPDHLINV
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,LINKTYP  
          MOVE      Z70,SENDFAXB 
          MOVE      Z70,RECIPNAM 
          MOVE      Z70,FAXNUMBR 
          MOVE      SP70,ELECSENT 
          MOVE      SP70,NIHCDOIN
          MOVE      SP70,NIHCHRIN
          MOVE      SP70,RECIPIEN
          MOVE      SP70,PRACTICE
          MOVE      SP70,PRACCNTR
.
          MOVE      ZERO,SENDTYPE
          MOVE      SP70,SENDTOPH
          MOVE      SP70,SENDFREM
          MOVE      SP70,SENDTOEM
          MOVE      ZERO,COPYTOCT
          MOVE      SP70,COPYTOEM[1]
          MOVE      SP70,COPYTOEM[2]
          MOVE      SP70,COPYTOEM[3]
          MOVE      SP70,COPYTOEM[4]
          MOVE      SP70,COPYTOEM[5]
          MOVE      SP70,COPYTOEM[6]
          MOVE      SP70,COPYTOEM[7]
          MOVE      SP70,COPYTOEM[8]
          MOVE      SP70,COPYTOEM[9]
          MOVE      ZERO,COPYPHCT
          MOVE      ZERO,CPYFXCT3
          MOVE      SP70,COPYTOPH[1]
          MOVE      SP70,COPYTOPH[2]
          MOVE      SP70,COPYTOPH[3]
          MOVE      SP70,COPYTOPH[4]
          MOVE      SP70,COPYTOPH[5]
          MOVE      SP70,COPYTOPH[6]
          MOVE      SP70,COPYTOPH[7]
          MOVE      SP70,COPYTOPH[8]
          MOVE      SP70,COPYTOPH[9]
          MOVE      SP70,COPYTOP3[1]
          MOVE      SP70,COPYTOP3[2]
          MOVE      SP70,COPYTOP3[3]
          MOVE      SP70,COPYTOP3[4]
          MOVE      SP70,COPYTOP3[5]
          MOVE      SP70,COPYTOP3[6]
          MOVE      SP70,COPYTOP3[7]
          MOVE      SP70,COPYTOP3[8]
          MOVE      SP70,COPYTOP3[9]
.
          MOVE      SP70,HCPFROMC
          MOVE      SP70,HCPSENDC
          MOVE      ZERO,HCPCOPCT
          MOVE      SP70,HCPCOPYC[1]
          MOVE      SP70,HCPCOPYC[2]
          MOVE      SP70,HCPCOPYC[3]
          MOVE      SP70,HCPCOPYC[4]
          MOVE      SP70,HCPCOPYC[5]
          MOVE      SP70,HCPCOPYC[6]
          MOVE      SP70,HCPCOPYC[7]
          MOVE      SP70,HCPCOPYC[8]
          MOVE      SP70,HCPCOPYC[9]
.
          MOVE      SP70,SELPRINT
          MOVE      ZERO,NOCOPIES
          MOVE      ZERO,SAVE2PDF
          MOVE      SP70,OBPCT001 
          MOVE      SP70,OBPCT002 
          MOVE      SP70,OBPCT003 
          MOVE      SP70,OBPCT004 
          MOVE      SP70,OBPCT005
          MOVE      ZERO,OBPCT006 
.
          MOVE      SP70,CLIDF001
          MOVE      SP70,CLIDF002
          MOVE      SP70,CLIDF003
          MOVE      SP70,CLIDF004
          MOVE      SP70,CLIDF005
.
          MOVE      SP70,CLICT001 
          MOVE      SP70,CLICT002 
          MOVE      SP70,CLICT003 
          MOVE      SP70,CLICT004 
          MOVE      SP70,CLICT005 
.
          MOVE      SP70,CLICD001  
          MOVE      SP70,CLICD002  
          MOVE      SP70,CLICD003 
          MOVE      SP70,CLICD004 
          MOVE      SP70,CLICD005 
          MOVE      SP70,CORRTYPE
          MOVE      SP70,CORRDESC
.
          MOVE      SP70,RESLNK01
          MOVE      SP70,RESLNK02
          MOVE      SP70,RESLNK03
          MOVE      SP70,RESLNK04
          MOVE      SP70,RESLNK05
          MOVE      SP70,RESLNK06
          MOVE      SP70,RESLNK07
          MOVE      SP70,RESLNK08
.
          MOVE      SP70,CORSFILE
          MOVE      SP70,CORSP001
          MOVE      SP70,CORSP002
          MOVE      SP70,CORSP003
          MOVE      SP70,CORSP004
          MOVE      SP70,CORSP005
          MOVE      SP70,CORSP006
          MOVE      SP70,CORSP007
          MOVE      SP70,CORSP008
          MOVE      SP70,CORSP009
          MOVE      SP70,CORSP010
          MOVE      SP70,CORSP011
          MOVE      SP70,CORSP012
          MOVE      SP70,CORSP013
          MOVE      SP70,CORSP014
          MOVE      SP70,CORSP015
          MOVE      SP70,CORSP016
          MOVE      SP70,CORSP017
          MOVE      SP70,CORSP018
          MOVE      SP70,CORSP019
          MOVE      SP70,RESULTKY
          MOVE      SP70,PRINTFMT
          MOVE      SP70,REFERLKY
          MOVE      SP70,EMRGFLAG
          MOVE      ZERO,HTMLCNT
.
          MOVE      SP70,FILTDCTY
          MOVE      SP70,FILTUSER
          MOVE      SP70,FILTAUTY
.
          MOVE      SP70,KPCRDRFT
.
          MOVE      SP70,SETDFPRG
          MOVE      SP70,SETDFRPT
.
          MOVE      ZERO,CALLTYPE
          MOVE      ZERO,FHRFIRST
.
          MOVE      ZERO,FHRDOCIN
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,FHRCETIN
          MOVE      ZERO,FHRCXTIN
.
          MOVE      ZERO,CREATIFC
          MOVE      ZERO,CREATNCF
          MOVE      SP70,IFCXHOSP
          MOVE      SP70,IFCXEADM
          MOVE      SP70,IFCXCLAI
          MOVE      SP70,IFCXELOS
          MOVE      SP70,IFCNCFCO
.
CLRPAR99  RETURN
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "htmlline=",QRYNAME
          IF        @EQUAL
            CALL      GETHTM00     
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "calltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CALLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docttype",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctstat",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhstatus",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHSTATUS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "draftdoc",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DRAFTDOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filter03",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTER03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printfmt",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTFMT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "resultky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESULTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copyfkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COPYFKEY   * Copied from Document
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "referlky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFERLKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "detailky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DETAILKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "auditkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUDITKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formactn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMACTN
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "updateky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEKY
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "sendfaxb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SENDFAXB
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "recipnam=",QRYNAME
          IF        @EQUAL
            PACK      RECIPNAM,QRYDATA,SP70
            SQUEEZE   RECIPNAM
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "faxnumbr=",QRYNAME
          IF        @EQUAL
            PACK      FAXNUMBR,QRYDATA,SP70
            REP       "( ",FAXNUMBR
            REP       ") ",FAXNUMBR
            SQUEEZE   FAXNUMBR
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "elecsent=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ELECSENT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nihcdoin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NIHCDOIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nihchrin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NIHCHRIN
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "recipien=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECIPIEN
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "practice=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRACTICE
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "praccntr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRACCNTR
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updhlinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDHLINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "reslnk",QRYNAME
          IF        @EQUAL
            CALL      SETRES00
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "clidf",QRYNAME
          IF        @EQUAL
            CALL      SETLID00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp",QRYNAME
          IF        @EQUAL
            CALL      SETCOR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "photopic=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP001
          ENDIF
.
          MATCH     "obpct",QRYNAME
          IF        @EQUAL
            CALL      SETPCT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clict",QRYNAME
          IF        @EQUAL
            CALL      SETCLT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clicd",QRYNAME
          IF        @EQUAL
            CALL      SETDET00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emrgflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMRGFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "save2pdf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVE2PDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sendtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SENDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sendtoph=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SENDTOPH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sendfrem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SENDFREM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sendtoem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SENDTOEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hcpfromc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HCPFROMC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hcpsendc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HCPSENDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copytoem=",QRYNAME
          IF        @EQUAL
            ADD       ONE,COPYTOCT
            PACK      COPYTOEM[COPYTOCT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copytoph=",QRYNAME
          IF        @EQUAL
            ADD       ONE,COPYPHCT
            PACK      COPYTOPH[COPYPHCT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copytop3=",QRYNAME
          IF        @EQUAL
            ADD       ONE,CPYFXCT3
            PACK      COPYTOP3[CPYFXCT3],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hcpcopct=",QRYNAME
          IF        @EQUAL
            ADD       ONE,HCPCOPCT
            PACK      HCPCOPYC[HCPCOPCT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdcty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTDCTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtuser=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTUSER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtauty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTAUTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "kpcrdrft=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KPCRDRFT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdfprg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETDFPRG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdfrpt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETDFRPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrdocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRDOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrcetin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRCETIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrcxtin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRCXTIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "creatifc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREATIFC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "creatncf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREATNCF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ifcxeadm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IFCXEADM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ifcxclai=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IFCXCLAI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ifcxelos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IFCXELOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ifcncfco=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IFCNCFCO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Get Text Comments
.------------------------------------------------------------
GETHTM00  PREP      TEMPFILE,TEMPNAM1
          ADD       ONE,HTMLCNT
          PACK      HTMLLINE,QRYDATA,SP70,SP70
          WRITE     TEMPFILE,SEQ;HTMLLINE
.
GETHTM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETHTM99 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETHTM80 IF NOT EQUAL
          ADD       ONE,HTMLCNT
          PACK      HTMLLINE,QRYDATA,SP70,SP70
          WRITE     TEMPFILE,SEQ;*+,HTMLLINE
          GOTO      GETHTM10
.
GETHTM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETHTM99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Patient Download Fields 
.-------------------------------------------------------------------------------
SETRES00  UNPACK    QRYNAME,KEY6,KEY2
          MOVE      ZERO,F2
          MOVE      KEY2,F2
          STORE     QRYDATA,F2,RESLNK01,RESLNK02,RESLNK03,RESLNK04,RESLNK05:
                               RESLNK06,RESLNK07,RESLNK08
          RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Patient Download Fields 
.-------------------------------------------------------------------------------
SETLID00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETLID01,SETLID02,SETLID03,SETLID04,SETLID05
.
          GOTO      SETLID99
.
SETLID01  MOVE      QRYDATA,CLIDF001
          SQUEEZE   CLIDF001
          PACK      CLIDF001,CLIDF001,SP70
          GOTO      SETLID99
SETLID02  MOVE      QRYDATA,CLIDF002
          GOTO      SETLID99
SETLID03  MOVE      QRYDATA,CLIDF003
          GOTO      SETLID99
SETLID04  MOVE      QRYDATA,CLIDF004
          GOTO      SETLID99
SETLID05  MOVE      QRYDATA,CLIDF005
          GOTO      SETLID99
.
SETLID99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Patient Correspondence Details 
.-------------------------------------------------------------------------------
SETCOR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETCOR01,SETCOR02,SETCOR03,SETCOR04,SETCOR05:
                       SETCOR06,SETCOR07,SETCOR08,SETCOR09,SETCOR10:
                       SETCOR11,SETCOR12,SETCOR13,SETCOR14,SETCOR15:
                       SETCOR16,SETCOR17,SETCOR18,SETCOR19
.
          GOTO      SETCOR99
.
SETCOR01  MOVE      QRYDATA,CORSP001
          GOTO      SETCOR99
SETCOR02  MATCH     SP70,QRYDATA
          GOTO      SETCOR99 IF EQUAL 
          GOTO      SETCOR99 IF EOS   
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      CORSP002,CCENT,CYEAR,CMON,CDAY
          GOTO      SETCOR99
SETCOR03  MOVE      QRYDATA,CORSP003
          GOTO      SETCOR99
SETCOR04  MATCH     SP70,QRYDATA
          GOTO      SETCOR99 IF EQUAL
          GOTO      SETCOR99 IF EOS  
          MOVE      QRYDATA,CORSP004
          GOTO      SETCOR99
SETCOR05  MOVE      QRYDATA,CORSP005
          GOTO      SETCOR99
SETCOR06  MOVE      QRYDATA,CORSP006
          GOTO      SETCOR99
SETCOR07  MOVE      QRYDATA,CORSP007
          GOTO      SETCOR99
SETCOR08  MOVE      QRYDATA,CORSP008
          GOTO      SETCOR99
SETCOR09  MOVE      QRYDATA,CORSP009
          GOTO      SETCOR99
SETCOR10  MOVE      QRYDATA,CORSP010
          GOTO      SETCOR99
SETCOR11  MOVE      QRYDATA,CORSP011
          GOTO      SETCOR99
SETCOR12  MOVE      QRYDATA,CORSP012
          GOTO      SETCOR99
SETCOR13  MOVE      QRYDATA,CORSP013
          GOTO      SETCOR99
SETCOR14  MOVE      QRYDATA,CORSP014
          GOTO      SETCOR99
SETCOR15  MOVE      QRYDATA,CORSP015
          GOTO      SETCOR99
SETCOR16  MOVE      QRYDATA,CORSP016
          GOTO      SETCOR99
SETCOR17  MOVE      QRYDATA,CORSP017
          GOTO      SETCOR99
SETCOR18  MOVE      QRYDATA,CORSP018
          GOTO      SETCOR99
SETCOR19  MOVE      QRYDATA,CORSP019
          GOTO      SETCOR99
.
SETCOR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Correspondence Table Maintenance 
.-------------------------------------------------------------------------------
SETPCT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETPCT01,SETPCT02,SETPCT03,SETPCT04,SETPCT05,SETPCT06
.
          GOTO      SETPCT99
.
SETPCT01  MOVE      QRYDATA,OBPCT001
          GOTO      SETPCT99
.
SETPCT02  MOVE      QRYDATA,OBPCT002
          GOTO      SETPCT99
.
SETPCT03  MOVE      QRYDATA,OBPCT003
          GOTO      SETPCT99
.
SETPCT04  MOVE      QRYDATA,OBPCT004
          GOTO      SETPCT99
.
SETPCT05  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OBPCT005,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OBPCT005
          ENDIF 
          GOTO      SETPCT99
.
SETPCT06  MOVE      QRYDATA,OBPCT006
          GOTO      SETPCT99
.
SETPCT99  RETURN 
.-------------------------------------------------------------------------------
.   Set Parameters for Download Type Maintenance 
.-------------------------------------------------------------------------------
SETCLT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETCLT01,SETCLT02,SETCLT03,SETCLT04,SETCLT05
.
          GOTO      SETCLT99
.
SETCLT01  SQUEEZE   QRYDATA
          MOVE      QRYDATA,CLICT001
          PACK      CLICT001,CLICT001,SP70
          GOTO      SETCLT99
.
SETCLT02  MOVE      QRYDATA,CLICT002
          GOTO      SETCLT99
.
SETCLT03  MOVE      QRYDATA,CLICT003
          GOTO      SETCLT99
.
SETCLT04  MOVE      QRYDATA,CLICT004
          GOTO      SETCLT99
.
SETCLT05  MOVE      QRYDATA,CLICT005
          GOTO      SETCLT99
.
SETCLT99  RETURN 
.-------------------------------------------------------------------------------
.   Set Parameters for Download Details Maintenance 
.-------------------------------------------------------------------------------
SETDET00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SETDET01,SETDET02,SETDET03,SETDET04,SETDET05
.
          GOTO      SETDET99
.
SETDET01  SQUEEZE   QRYDATA
          MOVE      QRYDATA,CLICD001
          PACK      CLICD001,CLICD001,SP70
          GOTO      SETDET99
.
SETDET02  MOVE      QRYDATA,CLICD002
          GOTO      SETDET99
.
SETDET03  MOVE      QRYDATA,CLICD003
          GOTO      SETDET99
.
SETDET04  MOVE      QRYDATA,CLICD004
          GOTO      SETDET99
.
SETDET05  MOVE      QRYDATA,CLICD005
          GOTO      SETDET99
.
SETDET99  RETURN 
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60
          GOTO      PROFLD99
.
. Patient Correspondence Details
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      CORR0000      * Patient Correspondence Details
          GOTO      PROFLD99
. 
PROFLD13  CALL      MISC0000      * Other fields
          GOTO      PROFLD99
.
. Patient Correspondence Maintenance
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99   
.
PROFLD21  CALL      COMN0000      * Patient Correspondence Maintenance
          GOTO      PROFLD99
.
. Patient Correspondence Listing by Date/Type
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99   
.
PROFLD31  CALL      CORVS000      * Correspondence Visits
          GOTO      PROFLD99
.
. Download Data Feild Maintenance
.
PROFLD40  CALL      DLFD0000      * Download Data Field Maintenance
          GOTO      PROFLD99
.
. Download Type Maintenance
.
PROFLD50  CALL      CTYP0000      * Download Type Maintenance 
          GOTO      PROFLD99
.
. Download Detail Maintenance 
.
PROFLD60  CALL      CDTL0000      * Download Detail Maintenance 
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-------------------------------------------------------------------------------
. Patient Correspondence Details
.-------------------------------------------------------------------------------
PCORRD00  CALL      CLPATMAS  * Clear Master Details
          CALL      CLPMSPX2  * Clear Master Details
          CALL      CLOBSPCO  * Clear Correspondence Details
.
          MATCH     SP70,UPDTTYPE
          GOTO      PCORRD70 IF EQUAL
.
          MATCH     "A",UPDTTYPE
          GOTO      PCORRD10 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      PCORRD20 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      PCORRD30 IF EQUAL
.
          MATCH     "P",UPDTTYPE            * Insert Patient Photo
          GOTO      PCORRD35 IF EQUAL
.
          MATCH     "I",UPDTTYPE            * Insert Result Document
          GOTO      PCORRD40 IF EQUAL
.
          MATCH     "V",UPDTTYPE            * View
          GOTO      PCORRD45 IF EQUAL
.
          MATCH     "L",UPDTTYPE            * Link Document to Existing Result
          GOTO      PCORRD50 IF EQUAL
.
          MATCH     "P",UPDTTYPE            * Print
          GOTO      PCORRD55 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * Remove Result & Document
          GOTO      PCORRD60 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Send document
          GOTO      PCORRD65 IF EQUAL
.
          MATCH     "M",UPDTTYPE            * NIHC Phase 3 Upload MyHR
          GOTO      PCORRD66 IF EQUAL
.
          GOTO      PCORRD99
.
PCORRD10  CALL      ADDCOR00                * Add a Correspondence record 
          IF        EXIT<>1
            CALL      TVIS0000              * Trigger visit documents update
          ENDIF
.
          MATCH     "1",NIHCHRIN
          IF        @EQUAL
            MOVE      DETAILK1,DETAILKY
            CALL      NIHCHR00
          ENDIF
.
          CALL      RHLD0000                * Remove Hold invoice
          GOTO      PCORRD99
.
PCORRD20  CALL      UPDCOR00                * Update a correspondence record 
          IF        EXIT<>1
            CALL      TVIS0000              * Trigger visit documents update
          ENDIF
          GOTO      PCORRD99
.
PCORRD30  CALL      DELCOR00                * Delete a correspondence record 
          IF        EXIT<>1
            CALL      TVIS0000              * Trigger visit documents update
          ENDIF
          GOTO      PCORRD99
.
PCORRD35  CALL      ADDPID00                * Add Patient ID Photo
          GOTO      PCORRD99
.
PCORRD40  CALL      ADDRES00                * Add Result Document
          IF        EXIT<>1
            CALL      TVIS0000              * Trigger visit documents update
          ENDIF
          GOTO      PCORRD99
.
PCORRD45  CALL      VEWCOR00                * View Document
          MOVE      ONE,EXIT
          GOTO      PCORRD99
.
PCORRD50  MATCH     SP70,RESULTKY
          IF        !@EQUAL
            CALL      LNKRES00                * Add Result Document
            IF        EXIT<>1
              CALL      TVIS0000              * Trigger visit documents update
            ENDIF
            GOTO      PCORRD99
          ENDIF
          MATCH     SP70,REFERLKY
          IF        !@EQUAL
            CALL      LNKREF00                * Add Referral Document
            IF        EXIT<>1
              CALL      TVIS0000              * Trigger visit documents update
            ENDIF
            GOTO      PCORRD99
          ENDIF
          GOTO      PCORRD99
.
PCORRD55  CALL      PRTDC000                * Print Summary
          GOTO      PCORRD99
.
PCORRD60  CALL      REMRES00                * Remove Result Document
          GOTO      PCORRD99
.
PCORRD65  CALL      SENDS000                * Send Discharge Summary Method
          GOTO      PCORRD99
.
PCORRD66  CALL      SENDS000
          CALL      NIHCHR00                * NIHC Phase 3 Upload MyHR / Episode
          GOTO      PCORRD99
.
PCORRD70  MATCH     SP70,DETAILKY
          GOTO      PCORRD75 IF EQUAL
.
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,PCORRD92
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
          BRANCH    OVRCD,PCORRD90
          CALL      RDPMPX21
.
          MATCH     ".FORM",OBPCFEXT        * No Storage Location for Forms Toolkit
          GOTO      PCORRD80 IF EQUAL
.
          MOVE      OBPCSLID,KEY4           * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,PCORRD93
.
          MOVE      OBPCURNO,URNUMBER
          MOVE      OBPCCVIS,ADMISSNO
.
          GOTO      PCORRD80
.
PCORRD75  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,PCORRD90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,OBPCCVIS
.
PCORRD80  CALL      PATNAA00       * Format name with bold tags
          CLEAR     WEBTITLE
          APPEND    "Clinical Documents - ",WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PCORRD99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00 
.
          MOVE      ONE,EXIT
          GOTO      PCORRD99  
.
PCORRD90  CLEAR     WEBTITLE
          APPEND    "Invalid U/R Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MATCH     "Y",EMRGFLAG
          IF        @EQUAL
.            CALL      REDMAP00
            MOVE      ZERO,EXIT
          ELSE
            MOVE      ONE,EXIT
          ENDIF
.
          GOTO      PCORRD99
.
PCORRD91  CLEAR     WEBTITLE
          APPEND    "Invalid Visit Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PCORRD99
.
PCORRD92  CLEAR     WEBTITLE
          MOVE      "Invalid Read on Correspondence File ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PCORRD99
.
PCORRD93  CLEAR     WEBTITLE
          MOVE      "Invalid Storage Location",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PCORRD99
.
PCORRD99  PREP      TEMPFILE,TEMPNAM1
          CLOSE     TEMPFILE,DELETE
          RETURN
+
.------------------------------------------------------------------------------
.         Check for matching indicator7 of Hold Invoice and Document type
.         if Hold invoice to be applied
.         return F1=0 - found the match
.------------------------------------------------------------------------------
CHLD0000  MOVE      ZERO,F1
          PACK      PTCDLDES,SP70
.
          PACK      KEY8,ADMISSNO           * validate admissno
          CALL      RDIPEN1
          BRANCH    OVRCD,CHLD9999
.
.         Check if Invoice is currently on hold
.
          MATCH     SP70,PTIPRHLD
          GOTO      CHLD9999 IF EQUAL     * invoice not on Hold
          MATCH     SP70,CORSP003         * Document Type
          GOTO      CHLD9999 IF EQUAL
.
          MOVE      SP70,KEY1
          MOVE      "wi",KEY2
          PACK      KEY5,KEY2,CORSP003
          CALL      RDCODE1
          BRANCH    OVRCD,CHLD9999
.
          UNPACK    TCINDC7,KEY1
          MATCH     SP70,KEY1
          GOTO      CHLD9999 IF EQUAL
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD    * Hold Invoice code
          CALL      RDCODE1
          BRANCH    OVRCD,CHLD9999
.
          MATCH     KEY1,TCINDC7
          GOTO      CHLD9999 IF NOT EQUAL       * not matched
.
          MOVE      ONE,F1
.
CHLD9999  RETURN
+
.----------------------------------------------------------------------------
.         Remove Hold invoice 
.         indicator7 of Hold Invoice and Document type are both matched
.----------------------------------------------------------------------------
RHLD0000  MATCH     "1",UPDHLINV
          GOTO      PCORRD99 IF NOT EQUAL   * Not removing Hold Invoice
.
          PACK      KEY8,ADMISSNO           * validate admissno
          CALL      RDIPEN1
          BRANCH    OVRCD,RHLD9999
.
          PACK      PTONREAH,PTIPRHLD,SP70             * save reason for hold
          PACK      PTONDESC,PTIPRDES,SP70
.
          MOVE      SP70,PTIPRHLD
          PACK      PTIPRDES,SP70,SP70
          CALL      UPIPEN1
.
          MOVE      ADMISSNO,PTONVISN
          MOVE      " 3",PTONVAVL
.
          MOVE      WBSEUID,PTONURID
          MOVE      "R",PTONHACT              * removed hold for visit
          PACK      PTONHLIN,SP70
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMISS1
          IF        OVRCD=0
            MOVE      ACLAIM,PTONCLCD
            MOVE      AFUNDH,PTONHLFU
          ENDIF
.
RHLD2000  CALL      IBACLOCK
          PACK      PTONTDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",PTONTDAT
          MOVE      CTIMEIS,PTONTTIM
.
          PACK      KEY24,ADMISSNO,PTONTDAT,PTONTTIM,SP70
          CALL      RAPTONH1
          COMPARE   ZERO,OVRCD
          GOTO      RHLD2000 IF EQUAL
.
          CALL      WRPTONH1
.
          CALL      BVISUP00      * Send A08 when invoice hold removed
.
RHLD9999  RETURN
+
.----------------------------------------------------------------------------
. Read the relevant records for the patient and broadcast an HL7 update visit
. message (A08) - Based on "Send A08 when Invoice on Hold data is changed"
.----------------------------------------------------------------------------
BVISUP00  MATCH     "1",PTCNINVH
          GOTO      BVISUP99 IF NOT EQUAL        * sending A08?
.
          OPEN      PATRE1A1,"patre1af"
          CALL      IBACLOCK                     * current date/time
.
.         Read the relevant records for the patient and
.         broadcast an HL7 update visit message (A08)
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDDSCH1                      * check for discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.         Get the last transfer record
.
          PACK      KEY30,IPADMNO,Z70
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,BVISUP99               * eof - finish
.
          MATCH     IPADMNO,TADMN                * same admission still ?
          GOTO      BVISUP99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID              * get national id for dgate write
.
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast change admission details
.
BVISUP99  RETURN
.
.------------------------------------------------------------
. Show Error Based on Call Type.  0=Page, 1=AJAX
.------------------------------------------------------------
SHWERR00  IF        CALLTYPE=0
            CALL      WEBERR00
          ELSE
            CALL      AJXERR00
          ENDIF
          RETURN
.------------------------------------------------------------------------------
. Remote Update Completed
.------------------------------------------------------------------------------
AJXEND00  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>OK</RETURN_VALUE>"
          CALL      XMLEND00
AJXEND99  RETURN
.------------------------------------------------------------------------------
. Remote Update Error
.------------------------------------------------------------------------------
AJXERR00  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>",WEBTITLE,"</RETURN_VALUE>"
          CALL      XMLEND00
          MOVE      ONE,EXIT   * Branch Main Line to Next Request
          RETURN
.------------------------------------------------------------
. Clear Correspondence Details
.------------------------------------------------------------
CLOBSPCO  MOVE      SP70,OBPCURNO  * U/R Number                         
          MOVE      SP70,OBPCCVIS  * Visit Number                       
          MOVE      SP70,OBPCCPID  * Correspondence ID                  
          MOVE      SP70,OBPCINDT  * Input Date                         
          MOVE      SP70,OBPCCTYP  * Type of Correspondence             
          MOVE      SP70,OBPCINTM  * Time hh:mm:ss                      
          MOVE      SP70,OBPCINUS  * Input Web User ID                  
          MOVE      SP70,OBPCFEXT  * File Extension                     
          MOVE      SP70,OBPCMDEL  * Marked as Deleted                  
          MOVE      SP70,OBPCSLID  * Storage Location ID                
          MOVE      SP70,OBPCSLEV  * Security Level                     
          MOVE      SP70,OBPCCOM1  * Comment 1                          
          MOVE      SP70,OBPCCOM2  * Comment 2                          
          MOVE      SP70,OBPCCFRM  * From                               
          MOVE      SP70,OBPCCTOO  * To                                 
          MOVE      SP70,OBPCUDF1  * User Def Code 1 (Cat xx)           
          MOVE      SP70,OBPCUDF2  * User Def Code 2 (Cat xx)           
          MOVE      SP70,OBPCUYN1  * User Def Y/N 1                     
          MOVE      SP70,OBPCUYN2  * User Def Y/N 2                     
          MOVE      SP70,OBPCUDD1  * User Def Date 1                    
          MOVE      SP70,OBPCUDD2  * User Def Date 2                    
          MOVE      SP70,OBPCDTLU  * Date Last Update                   
          MOVE      SP70,OBPCTMLU  * Time Last Update                   
          MOVE      SP70,OBPCLUID  * Last Web User ID                   
          MOVE      SP70,OBPCSPAR  * Spare                              
          MOVE      SP70,OBPCINDT  * Clear Correspondence Input Date
          MOVE      SP70,OBPCCTYP  * Clear Correspondence Type
.
          RETURN
.-------------------------------------------------------------------------------
.  Add a Patient Photo ID
.-------------------------------------------------------------------------------
ADDPID00  MATCH     SP70,CORSP002           * validate input date
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      CORSP002,CCC,CYY,CMM,CDD     * Last Input date and time  
            REP       " 0",CORSP002
            PACK      CORSP004,CTIMEIS
          ENDIF
          MATCH     SP70,CORSP007           * Subject
          IF        @EQUAL
            MOVE      "Patient Webcam Photo Capture",CORSP007 
          ENDIF
          MATCH     SP70,CORSP003           * Document Type
          IF        @EQUAL
            MOVE      "pi ",CORSP003        * Predefined Patient Image Cat wi
          ENDIF
          MATCH     SP70,ADMISSNO
          CALL      GETVIS00 IF EQUAL
.
          CALL      NEWCOR00
          BRANCH    EXIT,ADDPID99
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      ADDPID99
.
ADDPID99  RETURN
.-------------------------------------------------------------------------------
.  Determine Latest Current Visit
.-------------------------------------------------------------------------------
GETVIS00   PACK     KEY24,URNUMBER,CORSP002,SP70
           CALL     RSPTVIS2
           CALL     RPPTVIS2
           BRANCH   OVRCD,GETVIS99
           MATCH    URNUMBER,PVIURNO
           GOTO     GETVIS99 IF NOT EQUAL
           MOVE     DPVIBILL,ADMISSNO
GETVIS99   RETURN
.-------------------------------------------------------------------------------
.  Add a patient correspondence record 
.-------------------------------------------------------------------------------
ADDCOR00  MATCH     SP70,CORSP002           * validate input date
          GOTO      ADDCOR95 IF EQUAL
          GOTO      ADDCOR95 IF EOS 
          MATCH     SP70,CORSP004           * validate input time
          GOTO      ADDCOR96 IF EQUAL
          GOTO      ADDCOR96 IF EOS 
.
          CALL      NEWCOR00
          BRANCH    EXIT,ADDCOR99
.
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      ADDCOR99
.
ADDCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid Admissno Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR92  CLEAR     WEBTITLE
          APPEND    "Invalid User ID - ",WEBTITLE
          APPEND    KEY10,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR93  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR94  MOVE      "Invalid File - ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR95  MOVE      "Invalid Date",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR96  MOVE      "Invalid Time",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDCOR99
.
ADDCOR99  RETURN
.-------------------------------------------------------------------------------
.  Print a document
.-------------------------------------------------------------------------------
PRTDC000  MATCH     SP70,DETAILKY
          GOTO      PRTDC700 IF EQUAL
.
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,PRTDC700
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
          BRANCH    OVRCD,PRTDC900
          CALL      RDPMPX21
.
          MOVE      OBPCSLID,KEY4           * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,PRTDC920
.
          CALL      PRTA0000                * Print Document
          BRANCH    EXIT,PRTDC999
.
          MOVE      ZERO,EXIT               * To go to next page
          GOTO      PRTDC999
.
PRTDC700  CLEAR     WEBTITLE
          APPEND    "Invalid Document- ",WEBTITLE
          APPEND    DETAILKY,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PRTDC999
.
PRTDC900  CLEAR     WEBTITLE
          APPEND    "Invalid U/R Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PRTDC999
.
PRTDC920  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location- ",WEBTITLE
          APPEND    OBPCSLID,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PRTDC999
.
PRTDC999  RETURN
.-------------------------------------------------------------------------------
.  View a document
.-------------------------------------------------------------------------------
VEWCOR00  MATCH     SP70,DETAILKY
          GOTO      VEWCOR90 IF EQUAL
.
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,VEWCOR90
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
          BRANCH    OVRCD,VEWCOR91
          CALL      RDPMPX21
.
          MOVE      OBPCSLID,KEY4           * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,VEWCOR92
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
          STRIP     OBPTSDIR
          PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          PACK      CMDLINE,CMDVIEW,SP1,OBPTSDIR,CORSFILE,SP1,FILNAM,SP70
          EXECUTE   CMDLINE,TASKID
.
          MOVE      ZERO,EXIT               * To go to next page
          GOTO      VEWCOR99
.
VEWCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid Document- ",WEBTITLE
          APPEND    DETAILKY,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      VEWCOR99
.
VEWCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid U/R Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      VEWCOR99
.
VEWCOR92  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location- ",WEBTITLE
          APPEND    OBPCSLID,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      VEWCOR99
.
VEWCOR99  RETURN
.-------------------------------------------------------------------------------
.  Send a discharge summary
.-------------------------------------------------------------------------------
SENDS000  MATCH     SP70,DETAILKY
          GOTO      SENDS700 IF EQUAL
.
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,SENDS700
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
          BRANCH    OVRCD,SENDS900
          CALL      RDPMPX21
.
          MOVE      OBPCSLID,KEY4           * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,SENDS920
.
          CALL      SENDD000                * Send Document Method - Does not need to be a Discharge Summary
          MOVE      ANSS,OBAUTYPE           * Sent
          CALL      OBSAUD00                * Clinical Documents Audit
.
          CALL      WDSA0000                * Send Summary
          BRANCH    EXIT,SENDS999
.
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      SENDS999
.
SENDS700  CLEAR     WEBTITLE
          APPEND    "Invalid Document- ",WEBTITLE
          APPEND    DETAILKY,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      SENDS999
.
SENDS900  CLEAR     WEBTITLE
          APPEND    "Invalid U/R Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      SENDS999
.
SENDS920  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location- ",WEBTITLE
          APPEND    OBPCSLID,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      SENDS999
.
SENDS999  RETURN
.-------------------------------------------------------------------------------
.   Delete a correspondence record 
.-------------------------------------------------------------------------------
DELCOR00  PACK      KEY20,DETAILKY
          MOVE      DETAILKY,LOKKEY20       * Save the key to Unlock   *I-90207
          CALL      RLOBPC1
          BRANCH    OVRCD,DELCOR90
          MATCH     "1",OBPCMDEL
          GOTO      DELCOR93 IF EQUAL   * deleted
.
          PACK      TESTKEY,OBPCDTLU,OBPCTMLU
          MATCH     UPDATEKY,TESTKEY
          GOTO      DELCOR91 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD     * Last Input date and time  
          REP       " 0",OBPCDTLU
          PACK      OBPCTMLU,CTIMEIS
.
          PACK      KEY10,USERID
          CALL      RDWBSE1
          BRANCH    OVRCD,DELCOR92
          MOVE      WBSEUID,OBPCLUID        * Last Web User ID
.
          MOVE      ONE,OBPCMDEL            * set flag as deleted
          MOVE      CORSP002,OBPCINDT  *   Input Date                         
          MOVE      CORSP003,OBPCCTYP  *   Type of Correspondence             
          MOVE      CORSP004,OBPCINTM  *   Time hh:mm:ss                      
          MOVE      CORSP007,OBPCCOM1  *   Comment 1                          
          MOVE      CORSP008,OBPCCOM2  *   Comment 2                          
          MOVE      CORSP009,OBPCCFRM  *   From                               
          MOVE      CORSP010,OBPCCTOO  *   To                                 
          MOVE      CORSP011,OBPCUDF1  *   User Def Code 1 (Cat xx)           
          MOVE      CORSP012,OBPCUDF2  *   User Def Code 2 (Cat xx)           
          MOVE      CORSP013,OBPCUYN1  *   User Def Y/N 1                     
          MOVE      CORSP014,OBPCUYN2  *   User Def Y/N 2                     
          MOVE      CORSP015,OBPCUDD1  *   User Def Date 1                    
          UNPACK    SP70,OBPCACAT,OBPCACOD,OBPCCNTR * Clear linked document
.
          CALL      UPOBPC1                 * Update the record
.....     CALL      UUOBPC1                 * Unlock the record -moved- D-90207
.
          MOVE      ANSD,OBAUTYPE           * Delete
          CALL      OBSAUD00                * Clinical Documents Audit
.
          MOVE      ZERO,EXIT 
          GOTO      DELCOR99
.
DELCOR90  MOVE      "Error: Invalid Detailky Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      DELCOR99
.
DELCOR91  MOVE      "Error: Invalid Update Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      DELCOR99
.
DELCOR92  CLEAR     WEBTITLE
          APPEND    "Invalid User ID - ",WEBTITLE
          APPEND    KEY10,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      DELCOR99
.
DELCOR93  MOVE      "Error: Document is already Marked as Deleted",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      DELCOR99
.
DELCOR99  MOVE      LOKKEY20,KEY20                                     *I-90207
          CALL      UUOBPC1                 * Unlock the record        *I-90207
          RETURN
+
.-------------------------------------------------------------------------------
.         Update a correspondence record 
.-------------------------------------------------------------------------------
UPDCOR00  PACK      KEY20,DETAILKY
          MOVE      DETAILKY,LOKKEY20       * Save the key to Unlock   *I-90207
          CALL      RLOBPC1
          BRANCH    OVRCD,UPDCOR90
          MATCH     "1",OBPCMDEL
          GOTO      UPDCOR94 IF EQUAL   * deleted
.
          PACK      TESTKEY,OBPCDTLU,OBPCTMLU
          MATCH     UPDATEKY,TESTKEY
          GOTO      UPDCOR91 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD     * Last Input date and time  
          REP       " 0",OBPCDTLU
          PACK      OBPCTMLU,CTIMEIS
.
          PACK      KEY10,USERID
          CALL      RDWBSE1
          BRANCH    OVRCD,UPDCOR92
.
          MATCH     SP70,CORSP001
          GOTO      UPDCOR10 IF EQUAL
.
          SCAN      "filename",CORSP001
          GOTO      UPDCOR10 IF EQUAL
          SCAN      ".",CORSP001
          GOTO      UPDCOR10 IF NOT EQUAL
          MOVE      CORSP001,OBPCFEXT
          RESET     CORSP001
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
.
          MOVE      OBPCSLID,KEY4       * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,UPDCOR93
          BRANCH    OBPTROLY,UPDCOR93
.
          STRIP     OBPTSDIR
          PACK      CMDLINE,CMDFCHK,USERID,SP1,CORSP001,SP1,CORSFILE
          EXECUTE   CMDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      UPDCOR95 IF NOT EQUAL   * "cliweb08.us1" script failed
.
          PACK      CMDLINE,CMDMOVE,CORSP001,SP1,OBPTSDIR,CORSFILE
          EXECUTE   CMDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      UPDCOR96 IF NOT EQUAL   * mv command failed
.
UPDCOR10  MOVE      WBSEUID,OBPCLUID        * Last Web User ID
.
          MOVE      CORSP002,OBPCINDT  *   Input Date                         
          MOVE      CORSP003,OBPCCTYP  *   Type of Correspondence             
          MOVE      CORSP004,OBPCINTM  *   Time hh:mm:ss                      
          MOVE      CORSP007,OBPCCOM1  *   Comment 1                          
          MOVE      CORSP008,OBPCCOM2  *   Comment 2                          
          MOVE      CORSP009,OBPCCFRM  *   From                               
          MOVE      CORSP010,OBPCCTOO  *   To                                 
          MOVE      CORSP011,OBPCUDF1  *   User Def Code 1 (Cat xx)           
          MOVE      CORSP012,OBPCUDF2  *   User Def Code 2 (Cat xx)           
          MOVE      CORSP013,OBPCUYN1  *   User Def Y/N 1                     
          MOVE      CORSP014,OBPCUYN2  *   User Def Y/N 2                     
          MOVE      CORSP015,OBPCUDD1  *   User Def Date 1                    
          MOVE      CORSP016,OBPCUDD2  *   User Def Date 1                    
          MOVE      CORSP017,OBPCACAT  *   Alert Category
          MOVE      CORSP018,OBPCACOD  *   Alert Code
          MOVE      CORSP019,OBPCCNTR  *   Alert Counter
          CALL      UPOBPC1            * Update the record
.....     CALL      UUOBPC1            * Unlock the record -moved- D-90207
.
          MOVE      ANSU,OBAUTYPE           * Update
          CALL      OBSAUD00                * Clinical Documents Audit
.
          MOVE      ZERO,EXIT 
          GOTO      UPDCOR99
.
UPDCOR90  MOVE      "Error: Invalid Update Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR91  MOVE      "Error: Invalid Update Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR92  CLEAR     WEBTITLE
          APPEND    "Invalid User ID - ",WEBTITLE
          APPEND    KEY10,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR93  MOVE      "Error: Invalid Storage Location",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR94  MOVE      "Error: Document has been Marked as Deleted",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR95  CLEAR     WEBTITLE
          APPEND    "Error: File upload failed (cliweb08.us1 script)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR96  CLEAR     WEBTITLE
          APPEND    "Error: File upload failed (filesystem move)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCOR99
.
UPDCOR99  MOVE      LOKKEY20,KEY20                                     *I-90207
          CALL      UUOBPC1                 * Unlock the record        *I-90207
          RETURN
.-------------------------------------------------------------------------------
.  Field IT numbers
.-------------------------------------------------------------------------------
CORR0000  BRANCH    FLDITMNO,CORR0100,CORR0200,CORR0300,CORR0400,CORR0500:
                             CORR0600,CORR0700,CORR0800,CORR0900,CORR1000: 
                             CORR1100,CORR1200,CORR1300,CORR1400,CORR1500:
                             CORR1600,CORR1700,CORR1800,CORR1900,CORR2000:
                             CORR2100,CORR2200,CORR2300,CORR2400,CORR2500:
                             CORR2600,CORR2700,CORR2800,CORR2900,CORR3000:
                             CORR3100,CORR3200,CORR3300,CORR3400,CORR3500:
                             CORR3600,CORR3700,CORR3800,CORR3900,CORR4000:
                             CORR4100,CORR4200,CORR4300,CORR4400,CORR4500:
                             CORR4600,CORR4700,CORR4800,CORR4900,CORR5000:
			     CORR5100,CORR5200,CORR5300,CORR5400,CORR5500:
                             CORR5600,CORR5700,CORR5800,CORR5900,CORR6000:
                             CORR6100,CORR6200
          GOTO      CORR9999      
.
CORR0100  CALL      CORPGE00                * Link to Document
          GOTO      CORR9999
.
CORR0200  MOVE      ZERO,TABCFLAG       
          CALL      TABCOR00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR0300  WRITE     HTMLFILE;OBPCCVIS; 
          GOTO      CORR9999
.
CORR0400  MATCH     SP70,OBPCINDT
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      OBPCINDT,CCC,CYY,CMM,CDD       * current date
          ENDIF
          MOVE      OBPCINDT,INPTDATE 
          CALL      INPDTE00                * Format/Display Date 
          GOTO      CORR9999
.
CORR0500  WRITE     HTMLFILE;OBPCINTM; 
          GOTO      CORR9999
.
CORR0600  MOVE      OBPCINUS,INPTWUID 
          CALL      DISUSR00                * Display User ID or Name 
          GOTO      CORR9999 
.
CORR0700  MOVE      CATwi,CATEGORY
          MOVE      OBPCCTYP,CODE
          CALL      CODITM00
          GOTO      CORR9999 
.
CORR0800  WRITE     HTMLFILE;OBPCMDEL;
          GOTO      CORR9999 
.
CORR0900  WRITE     HTMLFILE;OBPTSLID
          GOTO      CORR9999 
.
CORR1000  WRITE     HTMLFILE;OBPCSLEV;
          GOTO      CORR9999 
.
CORR1100  WRITE     HTMLFILE;OBPCCOM1;
          GOTO      CORR9999 
.
CORR1200  WRITE     HTMLFILE;OBPCCOM2;
          GOTO      CORR9999 
.
CORR1300  WRITE     HTMLFILE;OBPCCFRM;
          GOTO      CORR9999 
.
CORR1400  WRITE     HTMLFILE;OBPCCTOO;
          GOTO      CORR9999 
.
CORR1500  MOVE      "wo",CATEGORY
          MOVE      OBPCUDF1,CODE
          CALL      CODITM00
          GOTO      CORR9999 
.
CORR1600  MOVE      "wp",CATEGORY
          MOVE      OBPCUDF2,CODE
          CALL      CODITM00
          GOTO      CORR9999 
.
CORR1700  WRITE     HTMLFILE;OBPCUYN1;
          GOTO      CORR9999 
.
CORR1800  WRITE     HTMLFILE;OBPCUYN2;
          GOTO      CORR9999 
.
CORR1900  MOVE      OBPCUDD1,INPTDATE 
          CALL      INPDTE00                * Format/Display Date 
          GOTO      CORR9999 
.
CORR2000  MOVE      OBPCUDD2,INPTDATE
          CALL      INPDTE00                * Foramt/Display Date
          GOTO      CORR9999 
.
CORR2100  MOVE      OBPCDTLU,INPTDATE
          CALL      INPDTE00                * Foramt/Display Date
          GOTO      CORR9999 
.
CORR2200  WRITE     HTMLFILE;OBPCTMLU;
          GOTO      CORR9999
.
CORR2300  MOVE      OBPCLUID,INPTWUID 
          CALL      DISUSR00                * Display User ID or Name 
          GOTO      CORR9999
.
CORR2400  PACK      UPDATEKY,OBPCDTLU,OBPCTMLU 
          WRITE     HTMLFILE;UPDATEKY;
          GOTO      CORR9999
.
CORR2500  PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID 
          WRITE     HTMLFILE;DETAILKY;
          GOTO      CORR9999
.
CORR2600  MOVE      ZERO,TABCFLAG
          CALL      ALLCOR00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR2700  CALL      CTYSEL00                * Select List for Download Type
          GOTO      CORR9999
.
CORR2800  UNPACK    DIM127,D1,HL7TABID,DIM127
          CALL      HL7SEL00
          GOTO      CORR9999
.
CORR2900  WRITE     HTMLFILE;RESULTKY;
          GOTO      CORR9999
.
CORR3000  WRITE     HTMLFILE;REFERLKY;      * Referral Key
          GOTO      CORR9999
.
CORR3100  CALL      SORCOR00               * Filter of Patient Correspondence
          GOTO      CORR9999
.
CORR3200  MOVE      CATwi,CATEGORY
          MOVE      CORSP003,CODE           * Default selected Filter code
          CALL      CODITM00
          GOTO      CORR9999
.
CORR3300  WRITE     HTMLFILE;OBPCSLID;      * Location ID of stored document
          GOTO      CORR9999
.
CORR3400  WRITE     HTMLFILE;OBPTROLY;      * Location is Read Only ?
          GOTO      CORR9999
.
CORR3500  READ      CONTROLF,NINTY1;*219,CWEBCLOC     * Current Location
          WRITE     HTMLFILE;CWEBCLOC;
          GOTO      CORR9999
.
CORR3600  MOVE      ONE,TABCFLAG
          CALL      TABCOR00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR3700  MOVE      ONE,TABCFLAG
          CALL      ALLCOR00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR3800  WRITE     HTMLFILE;CORSP017;      * Alert Category          
          GOTO      CORR9999
.
CORR3900  WRITE     HTMLFILE;CORSP018;      * Alert Code
          GOTO      CORR9999
.
CORR4000  MATCH     SP70,OBPCACAT
          GOTO      CORR9999 IF EQUAL
.
          MOVE      OBPCACAT,CATEGORY         * Alert Description
          MOVE      OBPCACOD,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;
          GOTO      CORR9999
.
CORR4100  WRITE     HTMLFILE;OBPCACAT;      * Alert Category
          GOTO      CORR9999
.
CORR4200  WRITE     HTMLFILE;OBPCACOD;      * Alert Code
          GOTO      CORR9999
.
CORR4300  CALL      DISCOR00                * Table of discharge summaries
          GOTO      CORR9999
.
CORR4400  CALL      MEDCOR00                * Table of medication records
          GOTO      CORR9999
.
CORR4500  MOVE      ZERO,ALLVISIT
          CALL      DISSUM00                * TableSort discharge summaries
          GOTO      CORR9999                * current visit only
.
CORR4600  MOVE      ONE,ALLVISIT
          CALL      DISSUM00                * TableSort discharge summaries
          GOTO      CORR9999                * all visits
.
CORR4700  CALL      DISAUD00                * TableSort discharge summary audit
          GOTO      CORR9999
.
CORR4800  WRITE     HTMLFILE;CORSP019;      * Alert Counter
          GOTO      CORR9999
.
CORR4900  WRITE     HTMLFILE;OBPCCNTR;      * Alert counter
          GOTO      CORR9999
.
CORR5000  STRIP     OBPTURLP            * URL HTML File Name for TinyMCE Edit
          MOVE      ".html",KEY5
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      DIM100,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,KEY5
          ELSE
            PACK      DIM100,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,KEY5
          ENDIF
          STRIP     DIM100
          REP       " 0",DIM100
          MOVELPTR  DIM100,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      DIM100,OUTVAR
          WRITE     HTMLFILE;OUTVAR;
          SFORMAT   OUTVAR,127
          GOTO      CORR9999
.
CORR5100  MOVE      TWO,TABCFLAG
          CALL      ALLCOR00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR5200  MOVE      ZERO,F1
          MATCH     "2",PTCNDSCL
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      CORR9999
.
. Image Gallery View
.
CORR5300  UNPACK    DIM127,D1,LINKTYP,DIM127
          PACK      LINKTYP,LINKTYP,SP70
          CALL      IMGLST00
          GOTO      CORR9999
.
. Image Gallery View
.
CORR5400  CALL      PATIMG00
          GOTO      CORR9999
.
. Table Clinical Documents Audit (obsaudaf)
.
CORR5500  CALL      TABCDA00
          GOTO      CORR9999
.
CORR5600  WRITE     HTMLFILE;FILTER03;
          GOTO      CORR9999
.
. Output FHIR Binary Resource 
.
CORR5700  CALL      CHKSEC00
          BRANCH    EXIT,CORR9999
.
          MOVE      ANSV,OBAUTYPE           * Clinical Document View
          CALL      OBSAUD00                * Clinical Documents Audit
.
          MOVE      OBPCSLID,KEY4           * Storage Location ID
          CALL      RDOBPT1
          BRANCH    OVRCD,CORR9999
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
          STRIP     OBPTSDIR
          PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          PACK      CMDLINE,FHIRBIN,SP1,OBPTSDIR,CORSFILE,SP1,FILNAM,SP70
          EXECUTE   CMDLINE,TASKID
.
          GOTO      CORR9999
.
CORR5800  IF        FHRDOCIN=1
.
            MOVE      OBPCURNO,URNUMBER
            MOVE      OBPCCVIS,ADMISSNO
            PACK      SAVKEY20,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
            PACK      FHRDOCID,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
            REP       " -",FHRDOCID
            WRITE     HTMLFILE;*+," {":
                                  " #"fullUrl#": #"%BASEURL/DocumentReference/",FHRDOCID,"#",":
                                  " #"resource#": ";
            CALL      RESDOC00
            WRITE     HTMLFILE;*+,"}";
.
            IF        FHRSUBIN=1
.
              WRITE     HTMLFILE;*+,",{":
                                    " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                      " #"resource#": ";
              CALL      RESPAT00
.
              WRITE     HTMLFILE;*+,"}"
            ENDIF
.
            IF        FHRPARIN=1
.
              MATCH     SP70,OBPCINUS
              IF        !@EQUAL & !@EOS 
.
                PACK      KEY10,OBPCINUS,SP70
                CALL      RDWBSE1
                IF        OVRCD=ZERO
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",OBPCINUS,"#", ":
                            " #"resource#" : ";
                  CALL     RESPRA00         * FHIR Resource Practitioner Recorder
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
            IF        FHRCXTIN=1
.
              PACK      KEY20,SAVKEY20,SP70
              CALL      RDOBPC1
              IF        OVRCD=0
                MATCH     SP70,OBPCCVIS
                IF        !@EQUAL & !@EOS
                  MATCH     "00000000",OBPCCVIS
                  IF        !@EQUAL
.
                    MOVE      OBPCURNO,URNUMBER
                    MOVE      OBPCCVIS,ADMISSNO
                    PACK      FHRENCID,OBPCURNO,OBPCCVIS,SP70
                    REP       " -",FHRENCID
.
                    CALL      FHRCLR00
                    MOVE      OBPCCVIS,PVIBILL
                    CALL      FHRVIS00
.
                    WRITE     HTMLFILE;*+,",{":
                                          " #"fullUrl#": #"%BASEURL/Encounter/",FHRENCID,"#",":
                                        " #"resource#": ";
                    CALL      RESENC00
                    WRITE     HTMLFILE;*+," }";
.
                  ENDIF
                ENDIF
              ENDIF
.
            ENDIF
.
            IF        FHRCETIN=1
.
              PACK      KEY20,SAVKEY20,SP70
              CALL      RDOBPC1
              IF        OVRCD=0
.
                CALL      CHKSEC00
                BRANCH    EXIT,CORR9999
.
                MOVE      ANSV,OBAUTYPE           * Clinical Document View
                CALL      OBSAUD00                * Clinical Documents Audit
.
                MOVE      OBPCSLID,KEY4           * Storage Location ID
                CALL      RDOBPT1
                BRANCH    OVRCD,CORR9999
.
                STRIP     OBPCFEXT
                MATCH     "00000000",OBPCCVIS
                IF        @EQUAL
                  MOVE      "UR",KEY2
                  PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
                ELSE
                  PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
                ENDIF
                REP       " 0",CORSFILE
                STRIP     OBPTSDIR
                PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
                SQUEEZE   FILNAM
                PACK      CMDLINE,FHIRBIN,SP1,OBPTSDIR,CORSFILE,SP1,FILNAM,SP70
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Binary/",FHRDOCID,"#",":
                                    " #"resource#": ";
.
                EXECUTE   CMDLINE,TASKID
.
                WRITE     HTMLFILE;*+," }"; 
.
              ENDIF
.
            ENDIF
.
          ELSE
            MOVE      OBPCURNO,URNUMBER
            MOVE      OBPCCVIS,ADMISSNO
            CALL      RESDOC00
          ENDIF
          GOTO      CORR9999
.
CORR5900  CALL      FHRNXT00
          GOTO      CORR9999
.
CORR6000  CALL      FHRLST00
          GOTO      CORR9999
.
CORR6100  MOVE      ZERO,TABCFLAG
          CALL      CLIDOC00                * Table of Patient Correspondence
          GOTO      CORR9999
.
CORR6200  CALL      LNKALR00                * Check if document linked to Alert
          GOTO      CORR9999
.
CORR9999  RETURN
.
.-------------------------------------------------------------------------------
.         Check if document linked to an Alert
.-------------------------------------------------------------------------------
LNKALR00  MOVE      ZERO,F1
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,LNKALR90
.
          PACK      KEY16,OBPCURNO,OBPCACAT,OBPCACOD,SP70
          CALL      RSPTALR1
LNKALR10  CALL      RKPTALR1
          BRANCH    OVRCD,LNKALR90
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      LNKALR90 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      LNKALR90 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      LNKALR90 IF NOT EQUAL
.
          MOVE      ONE,F1
.
LNKALR90  WRITE     HTMLFILE;F1;
LNKALR99  RETURN
+
.-------------------------------------------------------------------------------
. MISC0000 - Miscellaneous output
.-------------------------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900
          GOTO      MISC9999
.
MISC0100  CALL      HPFX0000
          GOTO      MISC9999
.
MISC0200  RESET     KEY3
          PACK      KEY3,SP70
          CALL      RSRELB1
MISC0210  CALL      RKRELB1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY5,RELBLCD
          WRITE     HTMLFILE;"<option value=#"",RELBLCD,"#">",RELBDES:
                               "</option>"
          GOTO      MISC0210
.
MISC0300  IF        IBCNMHOS=ONE
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              WRITE     HTMLFILE;WBSEHOSP;
            ENDIF
          ELSE
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTHSHOSP;
            ENDIF
          ENDIF
          GOTO      MISC9999
.
MISC0400  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            MATCH     SP70,WBSEOCG
            IF        !@EQUAL & !@EOS
              PACK      KEY5,CATw0,WBSEOCG,SP70
              CALL      RDCODE1
              IF        OVRCD=0
.
                MATCH     "1",TCINDC4
                IF        @EQUAL
                  WRITE     HTMLFILE;"IHIAdmin";
                ENDIF
.
                MATCH     "2",TCINDC4
                IF        @EQUAL
                  WRITE     HTMLFILE;"MyHRAdmin";
                ENDIF
.
                MATCH     "3",TCINDC4
                IF        @EQUAL
                  WRITE     HTMLFILE;"DualIHIMyHRAdmin";
                ENDIF
.
              ENDIF
            ENDIF
          ENDIF
          GOTO      MISC9999
.
MISC0500  MATCH     "3",PTCNUNET
          GOTO      MISC9999 IF NOT EQUAL
.
          IF        IBCNMHOS=ONE
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL & !@EOS
.
                PACK      KEY53,WBSEHOSP,SP70
                CALL      RSPMNDB2
                CALL      RKPMNDB2
                BRANCH    OVRCD,MISC9999
.
                MATCH     WBSEHOSP,PMNBHOSP
                GOTO      MISC9999 IF NOT EQUAL
.
                WRITE     HTMLFILE;PMNBUPUR;
.
              ENDIF
            ENDIF
          ELSE
.
            PACK      KEY53,SP70
            CALL      RSPMNDB2
            CALL      RKPMNDB2
            BRANCH    OVRCD,MISC9999
.
            WRITE     HTMLFILE;PMNBUPUR;
.
          ENDIF
          GOTO      MISC9999
.
MISC0600  PACK      KEY8,OBPCCVIS 
          CALL      RDPMVX11
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;PMVXUDF7;
          GOTO      MISC9999
.
MISC0700  PACK      KEY8,OBPCCVIS
          CALL      RDVISA1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;PVITYPE;
          GOTO      MISC9999
.
MISC0800  PACK      KEY8,OBPCCVIS
          CALL      RDDSCH1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;DDATE;
          GOTO      MISC9999
.
MISC0900  PACK      KEY8,OBPCCVIS
          CALL      RDEMVIS1
          BRANCH    OVRCD,MISC9999
.
          IF        EMVISTAT = 2 | EMVISTAT = 3
            WRITE     HTMLFILE;"X";
          ELSE
            WRITE     HTMLFILE;"";
          ENDIF
          GOTO      MISC9999
.
MISC9999  RETURN
.
.------------------------------------------------------------
.         If GP fax number is blank, use Practice fax number
.------------------------------------------------------------
HPFX0000  PACK      GENPCODE,PMPXRHC1,SP70
          MATCH     SP70,GENPCODE
          GOTO      HPFX9999 IF EQUAL
.
          PACK      KEY10,GENPCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HPFX9999
.
          MATCH     SP70,PMHCFAXN       * Blank GP Fax number?
          GOTO      HPFX1820 IF NOT EQUAL
.
          MATCH     SP70,PMPXRH1G       * Blank practice?
          GOTO      HPFX1820 IF EQUAL
.
          MOVE      ZERO,F2
          MOVE      PMPXR1GC,F2
          PACK      KEY10,PMPXRH1G,SP70
          PACK      GPPCCODE,KEY10,F2
.
          PACK      KEY12,GPPCCODE,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,HPFX9999
.
          WRITE     HTMLFILE;PMHGPFAX;      * Practice fax number
          GOTO      HPFX9999
.
HPFX1820  WRITE     HTMLFILE;PMHCFAXN;      * GP fax number
          GOTO      HPFX9999
.
HPFX9999  RETURN
+
.-------------------------------------------------------------------------------
. Filter Table of All Patient Images
.-------------------------------------------------------------------------------
PATIMG00  MOVE      "pi ",LINKTYP
          MOVE      ZERO,RECNUMB
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
PATIMG20  CALL      RPOBPC5
          BRANCH    OVRCD,PATIMG99
          MATCH     URNUMBER,OBPCURNO
          GOTO      PATIMG99 IF NOT EQUAL
          MATCH     LINKTYP,OBPCCTYP     * Filter documents
          GOTO      PATIMG20 IF NOT EQUAL
          MATCH     "1",OBPCMDEL
          GOTO      PATIMG20 IF EQUAL
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          STRIP     OBPTSDIR
          WRITE     HTMLFILE;OBPTSDIR
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
          WRITE     HTMLFILE;CMDLINE
PATIMG99  RETURN
.-------------------------------------------------------------------------------
. Filter Table of All Patient Images
.-------------------------------------------------------------------------------
IMGLST00  MOVE      ZERO,RECNUMB
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
IMGLST20  CALL      RPOBPC5
          BRANCH    OVRCD,IMGLST99
          MATCH     URNUMBER,OBPCURNO
          GOTO      IMGLST99 IF NOT EQUAL
          MATCH     LINKTYP,SP70           * Display all documents
          IF        !@EQUAL
            MATCH     LINKTYP,OBPCCTYP     * Filter documents
            GOTO      IMGLST20 IF NOT EQUAL
            MATCH     "1",OBPCMDEL
            GOTO      IMGLST20 IF EQUAL
          ENDIF
          MOVE      OBPCFEXT,KEY6
          REPLACE   UPPLOW,KEY6
          MATCH     ".JPEG ",KEY6
          GOTO      IMGLST50 IF EQUAL
          MATCH     ".PNG  ",KEY6
          GOTO      IMGLST50 IF EQUAL
          MATCH     ".JPG  ",KEY6
          GOTO      IMGLST50 IF EQUAL
          MATCH     ".GIF  ",KEY6
          GOTO      IMGLST50 IF EQUAL
          GOTO      IMGLST20
.
IMGLST50  ADD       ONE,RECNUMB
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          STRIP     OBPTSDIR
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKFRM00
.
          CALL      CHKSEC00
          BRANCH    EXIT,IMGLST20
.
          UNPACK    OBPCDTLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DATELUPD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   
          PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
.
          MOVE      RECNUMB,KEY5
          SQUEEZE   KEY5
.
          WRITE     HTMLFILE;*+,"imgName[",KEY5,"]='",CMDLINE,"';"
          WRITE     HTMLFILE;*+,"imgFile[",KEY5,"]='",CMDLINE,"';"
          WRITE     HTMLFILE;*+,"imgPath[",KEY5,"]='",OBPTURLP,"';"
          WRITE     HTMLFILE;*+,"imgType[",KEY5,"]='",OBPCCTYP,"';"
          WRITE     HTMLFILE;*+,"imgTitle[",KEY5,"]='",DATELUPD,"';"
          WRITE     HTMLFILE;*+,"imgKey[",KEY5,"]='",DETAILKY,"';"
.
          GOTO      IMGLST20
.
IMGLST99  RETURN
+
.-------------------------------------------------------------------------------
. Hl7 Selection List
.-------------------------------------------------------------------------------
HL7SEL00  PACK      KEY14,HL7TABID,SP70
          CALL      RSHLCO1
HL7SEL10  CALL      RKHLCO1
          BRANCH    OVRCD,HL7SEL99
          MATCH     HL7TABID,HLCOTID
          GOTO      HL7SEL99 IF NOT EQUAL
          WRITE     HTMLFILE;"<option value=#"",HLCOCOD,"#">":
                             HLCODES,"</option>"
          GOTO      HL7SEL10
HL7SEL99  RETURN
.-------------------------------------------------------------------------------
. Table of Patient Correspondence
.-------------------------------------------------------------------------------
TABCOR00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          GOTO      TABCOR20 IF NOT EQUAL
.
.         Clinical documents not associated with a visit
.
          MOVE      ADMISSNO,DIM8
          REP       " 0",DIM8
          PACK      KEY20,URNUMBER,DIM8,SP70
          CALL      RSOBPC1
TABCOR10  CALL      RKOBPC1
          BRANCH    OVRCD,TABCOR99
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      TABCOR99 IF NOT EQUAL
          MATCH     DIM8,OBPCCVIS
          GOTO      TABCOR99 IF NOT EQUAL
.
          CALL      CORROW00
          GOTO      TABCOR10
.
.         Clinical documents associated with a particular visit
.
TABCOR20  PACK      KEY28,ADMISSNO,Z70
          CALL      RSOBPC2
TABCOR30  CALL      RPOBPC2
          BRANCH    OVRCD,TABCOR99
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      TABCOR99 IF NOT EQUAL
.
          CALL      CORROW00
          GOTO      TABCOR30
. 
TABCOR99  RETURN
.-------------------------------------------------------------------------------
. Table of Patient Correspondence (Cat wi – indicator 3=C)
.-------------------------------------------------------------------------------
CLIDOC00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          GOTO      CLIDOC20 IF NOT EQUAL
.
.         Clinical documents not associated with a visit
.
          MOVE      ADMISSNO,DIM8
          REP       " 0",DIM8
          PACK      KEY20,URNUMBER,DIM8,SP70
          CALL      RSOBPC1
CLIDOC10  CALL      RKOBPC1
          BRANCH    OVRCD,CLIDOC99
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      CLIDOC99 IF NOT EQUAL
          MATCH     DIM8,OBPCCVIS
          GOTO      CLIDOC99 IF NOT EQUAL
.
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      CLIDOC10 IF NOT EQUAL
.
          CALL      CORROW00
          GOTO      CLIDOC10
.
.         Clinical documents associated with a particular visit
.
CLIDOC20  PACK      KEY28,ADMISSNO,Z70
          CALL      RSOBPC2
CLIDOC30  CALL      RPOBPC2
          BRANCH    OVRCD,CLIDOC99
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      CLIDOC99 IF NOT EQUAL
.
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      CLIDOC30 IF NOT EQUAL
.
          CALL      CORROW00
          GOTO      CLIDOC30
. 
CLIDOC99  RETURN
.-------------------------------------------------------------------------------
. Table of All Patient Correspondence
.-------------------------------------------------------------------------------
ALLCOR00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          IF        NORECORD=0
            MOVE      "50",NORECORD         * Set Default No Records to Display
          ENDIF
.
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
ALLCOR20  CALL      RPOBPC5
          BRANCH    OVRCD,ALLCOR99
          MATCH     URNUMBER,OBPCURNO
          GOTO      ALLCOR99 IF NOT EQUAL
.
          CALL      CORROW00
.
          GOTO      ALLCOR20
. 
ALLCOR99  RETURN
.-------------------------------------------------------------------------------
. Table of Discharge Summaries
.-------------------------------------------------------------------------------
DISCOR00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
DISCOR20  CALL      RPOBPC5
          BRANCH    OVRCD,DISCOR99
          MATCH     URNUMBER,OBPCURNO
          GOTO      DISCOR99 IF NOT EQUAL
.
          MATCH     SP70,OBPCCTYP
          GOTO      DISCOR20 IF EQUAL
.
          PACK      KEY5,CATWI,OBPCCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DISCOR20
.
          MATCH     ANSD,TCINDC1
          GOTO      DISCOR20 IF NOT EQUAL
.
DISCOR30  CALL      DISROW00
.
          GOTO      DISCOR20
.
DISCOR99  RETURN
.-------------------------------------------------------------------------------
. Tablesort Discharge Summaries
.-------------------------------------------------------------------------------
DISSUM00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
DISSUM20  CALL      RPOBPC5
          BRANCH    OVRCD,DISSUM99
          MATCH     URNUMBER,OBPCURNO
          GOTO      DISSUM99 IF NOT EQUAL
.
          COMPARE   ONE,ALLVISIT
          IF        !@EQUAL
            MATCH     ADMISSNO,OBPCCVIS
            GOTO      DISSUM20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OBPCCTYP
          GOTO      DISSUM20 IF EQUAL
.
          PACK      KEY5,CATWI,OBPCCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DISSUM20
.
          MATCH     ANSD,TCINDC1
          GOTO      DISSUM20 IF NOT EQUAL
.
DISSUM30  CALL      DISTAB00
.
          GOTO      DISSUM20
.
DISSUM99  RETURN
.-------------------------------------------------------------------------------
. Tablesort Discharge summary output
.-------------------------------------------------------------------------------
DISTAB00  PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ViewDoc('",HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&detailky=",HTMLLINK
          APPEND    DETAILKY,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ShowAudit('",HTMLLNK2
          APPEND    DETAILKY,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MOVE      SP70,DTYPDESC
          PACK      KEY5,CATWI,OBPCCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DTYPDESC
          ENDIF
.
          CLEAR     HTMLLNK3
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          IF        OVRCD=0
            STRIP     OBPTURLP
            MATCH     "00000000",OBPCCVIS
            IF        @EQUAL
              MOVE      "UR",KEY2
              PACK      DIM100,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
            ELSE
              PACK      DIM100,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
            ENDIF
            STRIP     DIM100
            REP       " 0",DIM100
            APPEND    "javascript:showSummary('",HTMLLNK3
            APPEND    DIM100,HTMLLNK3
            APPEND    "')",HTMLLNK3
            RESET     HTMLLNK3
          ENDIF
.
          CLEAR     HTMLLNK4
          APPEND    "javascript:SendDoc('",HTMLLNK4
          APPEND    "cliweb08",HTMLLNK4
          APPEND    ".pbl?reportno=1",HTMLLNK4
          APPEND    "&template=020",HTMLLNK4
          APPEND    "&detailky=",HTMLLNK4
          APPEND    DETAILKY,HTMLLNK4
          APPEND    "')",HTMLLNK4
          RESET     HTMLLNK4
.
          PACK      INUSDESC,OBPCINUS,SP70
          PACK      KEY10,OBPCINUS
          CALL      RDWBSE1
          IF        OVRCD<>1
           PACK     INUSDESC,WBSENAM,SP70
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",HTMLLNK2,"#",":
                             "#"",HTMLLNK3,"#",":
                             "#"",OBPCINDT,OBPCINTM,"#",":
                             "#"",OBPCCTYP,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",INUSDESC,"#",":
                             "#"",OBPCCTOO,"#",":
                             "#"",HTMLLNK4,"#")"
.
DISTAB99  RETURN
+
.-------------------------------------------------------------------------------
. Discharge Summary Audit List
.-------------------------------------------------------------------------------
DISAUD00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          UNPACK    AUDITKEY,DIM8,DIM8,DIM4
          PACK      KEY28,DIM8,DIM4,Z70
          CALL      RSPMDSD1
DISAUD20  CALL      RPPMDSD1
          BRANCH    OVRCD,DISAUD99
.
          MATCH     DIM8,PMDDVISN
          GOTO      DISAUD99 IF NOT EQUAL
.
          MATCH     DIM4,PMDDCPID
          GOTO      DISAUD99 IF NOT EQUAL
.
DISAUD30  CALL      DISARW00
.
          GOTO      DISAUD20
.
DISAUD99  RETURN
.-------------------------------------------------------------------------------
. Tablesort Discharge summary audit row   
.-------------------------------------------------------------------------------
DISARW00  
          MATCH     "2",PTCNDSCL
          GOTO      DISARW10 IF EQUAL       * Discharge Summary layout Format 2
.
          WRITE     HTMLFILE;"t.addRow(#"#",":
                             "#"",PMDDVISN,"#",":
                             "#"",PMDDCPID,"#",":
                             "#"",PMDDDATE,PMDDTIME,"#",":
                             "#"",PMDDDEST,"#",":
                             "#"",PMDDFAXN,"#",":
                             "#"",PMDDCUID,"#")"
          GOTO      DISARW99
.
DISARW10  PACK      DOCFNAME,PMDDHCPC,SP70
          PACK      KEY10,PMDDHCPC,SP30
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"#",":
                             "#"",PMDDVISN,"#",":
                             "#"",PMDDCPID,"#",":
                             "#"",PMDDDATE,PMDDTIME,"#",":
                             "#"",PMDDDEST,"#",":
                             "#"",PMDDFAXN,"#",":
                             "#"",PMDDCUID,"#",";
.
          MATCH     "1",PMDDFAXS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PMDDESNT
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",PMDDHCPP,"#",":
                             "#"",DOCFNAME,"#")"
.
DISARW99  RETURN
+
.-------------------------------------------------------------------------------
. Table of Medication details
.-------------------------------------------------------------------------------
MEDCOR00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSPTVIS2
MEDCOR20  CALL      RKPTVIS2
          BRANCH    OVRCD,MEDCOR99
          MATCH     URNUMBER,PVIURNO
          GOTO      MEDCOR99 IF NOT EQUAL
.
          PACK      KEY12,DPVIBILL,SP70
          CALL      RSOBCA1
MEDCOR30  CALL      RKOBCA1
          BRANCH    OVRCD,MEDCOR20
.
          MATCH     DPVIBILL,OBCAVIS
          GOTO      MEDCOR20 IF NOT EQUAL
.
          MATCH     "008",OBCATYP
          GOTO      MEDCOR20 IF NOT EQUAL
.
          CALL      MEDROW00
.
          GOTO      MEDCOR20
.
MEDCOR99  RETURN
.-------------------------------------------------------------------------------
. Filter Table of All Patient Correspondence
.-------------------------------------------------------------------------------
SORCOR00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          CALL      TBHEAD00                 * Display table heading
.
          PACK      KEY28,URNUMBER,Z70
          CALL      RSOBPC5
SORCOR20  CALL      RPOBPC5
          BRANCH    OVRCD,SORCOR99
          MATCH     URNUMBER,OBPCURNO
          GOTO      SORCOR99 IF NOT EQUAL
.
          MOVE      CORSP003,LINKTYP
          PACK      LINKTYP,LINKTYP,SP70
          MATCH     LINKTYP,SP70           * Display all documents
          IF        !@EQUAL
            MATCH     LINKTYP,OBPCCTYP     * Filter documents
            GOTO      SORCOR20 IF NOT EQUAL
          ENDIF
.
          CALL      SORROW00
.
          GOTO      SORCOR20
.
SORCOR99  RETURN
.------------------------------------------------------------
. Output Correspondence Row for a Patient
.------------------------------------------------------------
CORROW00  UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   
.
          UNPACK    OBPCDTLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DATELUPD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
.
          STRIP     OBPTURLP 
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKFRM00
.
          CALL      CHKSEC00
          BRANCH    EXIT,CORROW99
.
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      CMDLINE,OUTVAR
.
          PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
.
          MOVE      SP70,ALERTDES
          PACK      KEY5,OBPCACAT,OBPCACOD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ALERTDES
          ENDIF
.
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
.
          MATCH     SP70,FILTER03
          GOTO      CORROW30 IF EQUAL
          MATCH     SP70,TCINDC3             * Indicator Blank so Include
          GOTO      CORROW30 IF EQUAL
          MATCH     FILTER03,TCINDC3         * Does Match Filter Indicator Exclude
          GOTO      CORROW99 IF NOT EQUAL
.
CORROW30  MOVE      SP70,DRAFTDES
          MATCH     "3",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Current Draft)",DRAFTDES
          ENDIF
          MATCH     "2",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Draft)",DRAFTDES
          ENDIF
.
          MOVE      SP70,OBSPCOKY
          PACK      OBSPCOKY,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          REP       " +",OBSPCOKY
.
          BRANCH    FHIRTYPE,CORROW80
          COMPARE   ONE,TABCFLAG
          GOTO      CORROW50 IF EQUAL
          COMPARE   TWO,TABCFLAG
          GOTO      CORROW70 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      OBPCMDEL,F1
          BRANCH    F1,CORROW40,CORROW40
          WRITE     HTMLFILE;"<tr><td><a onclick=#"viewCliDoc('",OBSPCOKY,"');#" ":
                             " href=#"",OUTVAR,"#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>",KEY11,"</td>":
                             "<td><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</td>":
                             "<td>&nbsp",OBPCCTOO,"</td>":
                             "<td>&nbsp",OBPCCFRM,"</td>":
                             "<td>&nbsp",ALERTDES,"</td></tr>";
          GOTO      CORROW90
CORROW40  WRITE     HTMLFILE;"<tr><td><strike><a onclick=viewCliDoc(#"",OBSPCOKY,"#"); ":
                             "href=#"",OUTVAR:
                             "#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>":
                             KEY11,"</strike></td><td>":
                             "<strike><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</strike></td>":
                             "<td><strike>&nbsp",OBPCCTOO,"</strike></td>":
                             "<td><strike>&nbsp",OBPCCFRM,"</strike></td>":
                             "<td><strike>&nbsp",ALERTDES,"</strike></td></tr>";
          GOTO      CORROW90
.
CORROW50  MOVE      ZERO,F1
          MOVE      OBPCMDEL,F1
          BRANCH    F1,CORROW60,CORROW60
          WRITE     HTMLFILE;"<tr><td><a onclick=viewCliDoc(#"",OBSPCOKY,"#"); ":
                             "href=#"",OUTVAR,"#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>",KEY11,"</td>":
                             "<td><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</td>":
                             "<td>&nbsp",DATELUPD,"</td>":
                             "<td>&nbsp",WBSENAM,"</td>":
                             "<td>&nbsp",ALERTDES,"</td></tr>";
          GOTO      CORROW90
.
CORROW60  WRITE     HTMLFILE;"<tr><td><strike><a onclick=viewCliDoc(#"",OBSPCOKY,"#"); ": 
                             "href=#"",OUTVAR:
                             "#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>":
                             KEY11,"</strike></td><td>":
                             "<strike><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</strike></td>":
                             "<td><strike>&nbsp",DATELUPD,"</strike></td>":
                             "<td><strike>&nbsp",WBSENAM,"</strike></td>":
                             "<td><strike>&nbsp",ALERTDES,"</strike></td></tr>";
          GOTO      CORROW90
.
CORROW70  CALL      SRTROW00  * Sort Row
          GOTO      CORROW90
.
CORROW80  CALL      FHRROW00  * FHIR Document Resource
          GOTO      CORROW90
.
CORROW90  REP       "+ ",DETAILKY
          SFORMAT   OUTVAR,127
.
CORROW99  RETURN
+
.------------------------------------------------------------
. Paging for Documents in FHIR
.------------------------------------------------------------
FHRNXT00  IF        DISNUMB=NORECORD
            ASSIGN    STARTNUM+NORECORD,F6
            MOVE      F6,KEY6
            SQUEEZE   KEY6
.            WRITE     HTMLFILE;*+,"nextpage=&startnum=",KEY6
          ENDIF
          RETURN
.
FHRLST00  ASSIGN    STARTNUM-NORECORD,F6
          IF        F6>=0
            MOVE      F6,KEY6
            SQUEEZE   KEY6
.            WRITE     HTMLFILE;*+,"prevpage=&startnum=",KEY6
          ENDIF
          RETURN
.------------------------------------------------------------
. FHIR Document Reference Details
.------------------------------------------------------------
FHRROW00  
.          ADD       ONE,RECNUMB
.          IF        STARTNUM>=RECNUMB
.            GOTO      FHRROW99
.          ENDIF
          MOVE      SP70,DRAFTDES
          MOVE      "current",FHRSTAT
          MOVE      "final",DOCSTCOD
          MATCH     "3",OBPCMDEL
          IF        @EQUAL
            MOVE      " (Current Draft)",DRAFTDES
            MOVE      "preliminary",DOCSTCOD
          ENDIF
          MATCH     "2",OBPCMDEL
          IF        @EQUAL
            MOVE      " (Draft)",DRAFTDES
            MOVE      "superseded",FHRSTAT
            MOVE      "preliminary",DOCSTCOD
          ENDIF
          MATCH     "1",OBPCMDEL
          IF        @EQUAL
            MOVE      " (DELETED)",DRAFTDES
            MOVE      "entered-in-error",FHRSTAT
            MOVE      "entered-in-error",DOCSTCOD
          ENDIF
          STRIP     DRAFTDES
          STRIP     FHRSTAT
          STRIP     DOCSTCOD
          MATCH     SP70,FHSTATUS
          IF        !@EQUAL
            MATCH     FHSTATUS,FHRSTAT
            GOTO      FHRROW99 IF NOT EQUAL
          ENDIF
.
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          ADD       ONE,DISNUMB
          MOVE      OBPCURNO,URNUMBER
          MOVE      OBPCCVIS,ADMISSNO
          PACK      SAVKEY20,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          PACK      FHRDOCID,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          REP       " -",FHRDOCID
          WRITE     HTMLFILE;*+," {":
                                " #"fullUrl#": #"%BASEURL/DocumentReference/",FHRDOCID,"#",":
                                " #"resource#": ";
          CALL      RESDOC00
          WRITE     HTMLFILE;*+,"}";
.
          IF        FHRSUBIN=1
.
            WRITE     HTMLFILE;*+,",{":
                                  " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
            CALL      RESPAT00
.
            WRITE     HTMLFILE;*+,"}"
          ENDIF
.
DEBUGLAB  IF        FHRPARIN=1
.
            MATCH     SP70,OBPCINUS
            IF        !@EQUAL & !@EOS
.
              PACK      KEY10,OBPCINUS,SP70
              CALL      RDWBSE1
              IF        OVRCD=ZERO
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",OBPCINUS,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner Recorder
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          IF        FHRCXTIN=1
.
            PACK      KEY20,SAVKEY20,SP70
            CALL      RDOBPC1
            IF        OVRCD=0
              MATCH     SP70,OBPCCVIS
              IF        !@EQUAL & !@EOS
                MATCH     "00000000",OBPCCVIS
                IF        !@EQUAL
.
                  MOVE      OBPCURNO,URNUMBER
                  MOVE      OBPCCVIS,ADMISSNO
                  PACK      FHRENCID,OBPCURNO,OBPCCVIS,SP70
                  REP       " -",FHRENCID
.
                  CALL      FHRCLR00
                  MOVE      OBPCCVIS,PVIBILL
                  CALL      FHRVIS00                
.
                  WRITE     HTMLFILE;*+,",{":
                                        " #"fullUrl#": #"%BASEURL/Encounter/",FHRENCID,"#",":
                                        " #"resource#": ";
                  CALL      RESENC00
                  WRITE     HTMLFILE;*+," }";
.
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          IF        FHRCETIN=1
.
            PACK      KEY20,SAVKEY20,SP70
            CALL      RDOBPC1
            IF        OVRCD=0
.
              CALL      CHKSEC00
              BRANCH    EXIT,CORR9999
.
              MOVE      ANSV,OBAUTYPE           * Clinical Document View
              CALL      OBSAUD00                * Clinical Documents Audit
.
              MOVE      OBPCSLID,KEY4           * Storage Location ID
              CALL      RDOBPT1
              BRANCH    OVRCD,CORR9999
.
              STRIP     OBPCFEXT
              MATCH     "00000000",OBPCCVIS
              IF        @EQUAL
                MOVE      "UR",KEY2
                PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
              ELSE
                PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
              ENDIF
              REP       " 0",CORSFILE
              STRIP     OBPTSDIR
              PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
              SQUEEZE   FILNAM
              PACK      CMDLINE,FHIRBIN,SP1,OBPTSDIR,CORSFILE,SP1,FILNAM,SP70
.
              WRITE     HTMLFILE;*+,",{":
                                    " #"fullUrl#": #"%BASEURL/Binary/",FHRDOCID,"#",":
                                  " #"resource#": ";
.
              EXECUTE   CMDLINE,TASKID
.
              WRITE     HTMLFILE;*+," }";
.
            ENDIF
.
          ENDIF
.
.          COMPARE   NORECORD,DISNUMB
.          GOTO      FHRROW99 IF NOT EQUAL
..
.          PACK      KEY28,URNUMBER,SP70
.          CALL      RSOBPC5           * Set to exit loop
.
FHRROW99  RETURN
+
.------------------------------------------------------------
.  FHIR Document Resource
.------------------------------------------------------------
RESDOC00  PACK      FHRPATID,OBPCURNO,SP70
          PACK      FHRDOCID,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRDOCID
.
          PACK      KEY5,CATwi,OBPCCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      ZERO,TCINDC1
          ENDIF
          MOVE      KEY5,DOCTYCOD
          MOVE      TDESC,DOCTYDES
          MOVE      TCINDC3,DOCCLCOD
          REP       " U",DOCCLCOD
          MOVE      "Unclassified",DOCCLDES
          MATCH     "A",TCINDC3
          IF        @EQUAL
            MOVE      "Administrative",DOCCLDES
          ENDIF
          MATCH     "C",TCINDC3
          IF        @EQUAL
            MOVE      "Clinical",DOCCLDES
          ENDIF
.
          STRIP     DOCTYCOD
          STRIP     DOCTYDES
          STRIP     OBPCCOM1
          STRIP     OBPCCOM2
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
.
          STRIP     OBPCINTM
          CLEAR     KEY8
          APPEND    OBPCINTM,KEY8
          APPEND    ":00",KEY8
          RESET     KEY8
          MOVE      KEY8,OBPCINTM
          STRIP     WBTPFIL  *  Template
.
          PACK      KEY10,OBPCINUS
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"DocumentReference#",":
                    " #"id#" : #"",FHRDOCID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    "  ],":
                    "  #"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#"}, ":
                    "  #"status#" : #"",FHRSTAT,"#",":
                    "  #"docStatus#" : #"",DOCSTCOD,"#",":
                    "  #"description#" : #"",OBPCCOM1,SP1,OBPCCOM2,DRAFTDES,"#",":
                    "  #"created#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY,"#",":
                    "  #"indexed#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                       "T",OBPCINTM,TIMEZONE,"#",":
                    "  #"securityLabel#" : [ {":
                    "    #"coding#" : [":
                    "     { #"code#"      : #"N#",":
                    "       #"display#"   : #"normal#" } ":
                    "     ] } ] ,":
                    "  #"type#" : {":
                    "    #"coding#" : [":
                    "     { #"system#"    : #"%BASEURL/ValueSet/Category-wi#",":
                    "       #"code#"      : #"",OBPCCTYP,"#",":
                    "       #"display#"   : #"",DOCTYDES,"#" } ":
                    "     ] },":
                    "  #"class#" : {":
                    "    #"coding#" : [":
                    "     { #"code#"      : #"",DOCCLCOD,"#",":
                    "       #"display#"   : #"",DOCCLDES,"#" } ":
                    "     ] },":
                    "  #"author#": [ { #"reference#" : #"Practitioner/User-",OBPCINUS,"#",":
                    "  #"display#" : #"",WBSENAM,"#"} ], ":
                    "  #"content#" : [ {":
                    "    #"attachment#" : {":
                    "      #"url#" : #"Binary/",FHRDOCID,"#"":
                    "  } } ] ";
          PACK      FHRENCID,OBPCURNO,OBPCCVIS,SP70
          REP       " -",FHRENCID
          MATCH     "00000000",OBPCCVIS
          IF        !@EQUAL
            MATCH     SP70,OBPCCVIS 
            IF        !@EQUAL
               WRITE    HTMLFILE;*+,",  #"context#": {":
                          "#"encounter#":   ":
                          "  { #"reference#" : #"Encounter/",FHRENCID,"#"} ":
                          "}"; 
            ENDIF
          ENDIF
          WRITE     HTMLFILE;*+,"}";
.
          RETURN

.------------------------------------------------------------
.  Correspondence Sort Table Row
.------------------------------------------------------------
SRTROW00  MOVE      SP70,KEY30
          PACK      KEY5,OBPCACAT,OBPCACOD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY30
          ENDIF
          PACK      KEY5,CATwi,OBPCCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      ZERO,TCINDC1
          ENDIF
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
.
.
          STRIP     OBPTSDIR
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTSDIR,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTSDIR,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          SFORMAT   FILEPATH,127
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   FILEPATH,LENGTH
          MOVE      CMDLINE,FILEPATH
.
          PACK      KEY20,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          REP       " +",KEY20,
          REP       "> ",OBPCCFRM
          REP       "< ",OBPCCFRM
.
          PACK      INUSDESC,OBPCINUS,SP70
          PACK      KEY10,OBPCINUS
          CALL      RDWBSE1
          IF        OVRCD<>1
             PACK     INUSDESC,WBSENAM,SP70
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(":
                    QUOTE,FILEPATH,QUOTE,COMMA:
                    QUOTE,OUTVAR,QUOTE,COMMA:
                    QUOTE,KEY20,QUOTE,COMMA:
                    QUOTE,OBPCINDT,OBPCINTM,QUOTE,COMMA:
                    QUOTE,OBPCCTYP,QUOTE,COMMA:
                    QUOTE,OBPCINUS,QUOTE,COMMA:
                    QUOTE,OBPCCOM1,QUOTE,COMMA:
                    QUOTE,OBPCCOM2,QUOTE,COMMA:
                    QUOTE,OBPCCFRM,QUOTE,COMMA:
                    QUOTE,OBPCCTOO,QUOTE,COMMA:
                    QUOTE,KEY30,QUOTE,COMMA:
                    QUOTE,TDESC,QUOTE,COMMA:
                    QUOTE,INUSDESC,QUOTE,COMMA:
                    QUOTE,WBSTLEV,QUOTE,COMMA:
                    QUOTE,TCFORM6,QUOTE,COMMA:
                    QUOTE,TCINDC1,QUOTE,COMMA:
                    QUOTE,OBPCMDEL,QUOTE,COMMA:
                    QUOTE,TCINDC6,QUOTE,COMMA,");"
.
          PACK      KEY10,USERID
          CALL      RDWBSE1
          RETURN
.------------------------------------------------------------
. Check for Forms Toolkit Link Requirement
.------------------------------------------------------------
CHKFRM00  MATCH     ".FORM",OBPCFEXT
          IF        @EQUAL
            CLEAR     CMDLINE
            APPEND    "../forms/LinkToForm.php?",CMDLINE
            APPEND    OBPCCFRM,CMDLINE
            APPEND    SP70,CMDLINE
            RESET     CMDLINE
            STRIP     CMDLINE
            MOVE      SP70,OBPCCFRM
          ENDIF
          RETURN
.------------------------------------------------------------
. Output Discharge summary row for a Patient
.------------------------------------------------------------
DISROW00  UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    OBPCDTLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DATELUPD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      VISTDATE,SP70
          PACK      KEY8,OBPCCVIS,SP70
          CALL      RDVISA1
          IF        OVRCD<>1
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                 SEP,OCT,NOV,DEC
            PACK      VISTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
.
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKFRM00
.
          CALL      CHKSEC00
          BRANCH    EXIT,DISROW99
.
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      CMDLINE,OUTVAR
.
          PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
.
          MATCH     SP70,FILTER03
          GOTO      DISROW30 IF EQUAL
          MATCH     SP70,TCINDC3             * Indicator Blank so Include
          GOTO      DISROW30 IF EQUAL
          MATCH     FILTER03,TCINDC3         * Does Match Filter Indicator Exclude
          GOTO      DISROW99 IF NOT EQUAL
.
DISROW30  MOVE      SP70,DRAFTDES
          MATCH     "3",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Current Draft)",DRAFTDES
          ENDIF
          MATCH     "2",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Draft)",DRAFTDES
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      OBPCMDEL,F1
          BRANCH    F1,DISROW80,DISROW80
          WRITE     HTMLFILE;"<tr><td><a href=#"",OUTVAR,"#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>",KEY11,"</td>":
                             "<td><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"&admissno=",ADMISSNO:
                             "&urnumber=",URNUMBER:
                             "');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</td>":
                             "<td>&nbsp",OBPCCVIS,"</td>":
                             "<td>&nbsp",VISTDATE,"</td>":
                             "</tr>";
          GOTO      DISROW90
.
DISROW80  WRITE     HTMLFILE;"<tr><td><strike><a href=#"",OUTVAR:
                             "#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>":
                             KEY11,"</strike></td><td>":
                             "<strike><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</strike></td>":
                             "<td><strike>&nbsp",OBPCCVIS,"</strike></td>":
                             "<td><strike>&nbsp",VISTDATE,"</strike></td>":
                             "</tr>";
          GOTO      DISROW90
.
DISROW90  REP       "+ ",DETAILKY
          SFORMAT   OUTVAR,127
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
DISROW99  RETURN
.------------------------------------------------------------
. Output Medication row for a Patient
.------------------------------------------------------------
MEDROW00  UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    OBCADLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DATELUPD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      VISTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      WBSENAM,SP70
          PACK      KEY10,OBCALID          * Last Web User ID
          CALL      RDWBSE1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          PACK      KEY12,OBCAVIS,OBCACID,SP70
          REP       " +",KEY12
.
          MATCH     "1",OBCAMDL
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>",KEY11,"</td>":
                               "<td><a href=#"javascript:ViewDoc('",LINKPRG:
                               ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                               "&nzteskey=",KEY12:
                               "&admissno=",ADMISSNO:
                               "&urnumber=",URNUMBER:
                               "');#">":
                               " <img border=0 src=../images/patweb90-1.gif":
                               " align=absmiddle hspace=4 ></a>":
                               "&nbsp",DPVIBILL,"</td>":
                               "<td>&nbsp",VISTDATE,"</td>":
                               "</tr>";
          ELSE
            WRITE     HTMLFILE;"<tr><td><strike>",KEY11,"</strike></td><td>":
                               "<strike><a href=#"javascript:ViewDoc('",LINKPRG:
                               ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                               "&nzteskey=",KEY12:
                               "&admissno=",ADMISSNO:
                               "&urnumber=",URNUMBER:
                               "');#">":
                               " <img border=0 src=../images/patweb90-1.gif":
                               " align=absmiddle hspace=4 ></a>":
                               "&nbsp",DPVIBILL,"</strike></td>":
                             "<td><strike>&nbsp",VISTDATE,"</strike></td>":
                             "</tr>";
          ENDIF
          GOTO      MEDROW90
.
MEDROW90  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
MEDROW99  RETURN
.------------------------------------------------------------
. Filter Correspondence Row for a Patient
.------------------------------------------------------------
SORROW00  UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
.
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKFRM00
.
          CALL      CHKSEC00
          BRANCH    EXIT,SORROW99
.
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      CMDLINE,OUTVAR
.
          PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
.
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
.
          MATCH     SP70,FILTER03
          GOTO      SORROW30 IF EQUAL
          MATCH     SP70,TCINDC3             * Indicator Blank so Include
          GOTO      SORROW30 IF EQUAL
          MATCH     FILTER03,TCINDC3         * Does Match Filter Indicator Exclude
          GOTO      SORROW99 IF NOT EQUAL
.
SORROW30  MOVE      SP70,DRAFTDES
          MATCH     "3",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Current Draft)",DRAFTDES
          ENDIF
          MATCH     "2",OBPCMDEL
          IF        @EQUAL
            MOVE      " - (Draft)",DRAFTDES
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      OBPCMDEL,F1
          BRANCH    F1,SORROW80,SORROW80
          WRITE     HTMLFILE;"<tr><td><a href=#"",OUTVAR,"#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>",KEY11,"</td>":
                             "<td><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</td>":
                             "<td>&nbsp",OBPCCTOO,"</td>":
                             "<td>&nbsp",OBPCCFRM,"</td></tr>";
          GOTO      SORROW90
.
SORROW80  WRITE     HTMLFILE;"<tr><td><strike><a href=#"",OUTVAR:
                             "#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=4 ></a>":
                             KEY11,"</strike></td><td>":
                             "<strike><a href=#"javascript:ViewDoc('",LINKPRG:
                             ".pbl?reportno=",LINKREP,"&template=",LINKTEM:
                             "&detailky=",DETAILKY,"');#">":
                             " <img border=0 src=../images/patweb90-1.gif":
                             " align=absmiddle hspace=4 ></a>":
                             TDESC,DRAFTDES,OBPCCOM1,OBPCCOM2,"</strike></td>":
                             "<td><strike>&nbsp",OBPCCTOO,"</strike></td>":
                              "<td><strike>&nbsp",OBPCCFRM,"</strike></td></tr>";
SORROW90  REP       "+ ",DETAILKY
          SFORMAT   OUTVAR,127
.
SORROW99  RETURN
.---------------------------------------------------------------------------
. Security based on document type or document security level
.---------------------------------------------------------------------------
CHKSEC00  MOVE      ZERO,EXIT
          MOVE      ZERO,TCFORM6
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ZERO,TCFORM6
            MOVE      ZERO,TCINDC1
          ENDIF
          COMPARE   ZERO,TCFORM6
          GOTO      CHKSEC50 IF NOT EQUAL
          MOVE      ZERO,F2
          MOVE      OBPCSLEV,F2
          MOVE      F2,TCFORM6
          COMPARE   ZERO,TCFORM6
          GOTO      CHKSEC99 IF EQUAL
.
CHKSEC50  PACK      KEY18,WBSEUID,PRGID
          CALL      RDWBST1
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
          IF        WBSTLEV<TCFORM6
            GOTO      CHKSEC80
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      CHKSEC99
CHKSEC80  MATCH     "1",TCINDC1        * Don't Display in List if Indicator
          GOTO      CHKSEC90 IF EQUAL  * Set to 1
.
          CLEAR     CMDLINE
          APPEND    "javascript:alert('Security Level Inadequate');",CMDLINE
          APPEND    "self.close();",CMDLINE
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          MOVE      ZERO,EXIT
          GOTO      CHKSEC99
CHKSEC90  MOVE      ONE,EXIT
CHKSEC99  RETURN
.-------------------------------------------------------------------------------
.  Display table heading
.-------------------------------------------------------------------------------
TBHEAD00   WRITE    HTMLFILE;"<tr><td class=HeadingCell width=15%>Date </td>":
                            "<td class=HeadingCell width=50%>Description </td>":
                             "<td class=HeadingCell>To </td>":
                             "<td class=HeadingCell>From </td>":
                             "</tr>"
TBHEAD99   RETURN
.-------------------------------------------------------------------------------
. Format/Display the Date 
.-------------------------------------------------------------------------------
INPDTE00  REP       " 0",INPTDATE 
          UNPACK    INPTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR   
.
          WRITE     HTMLFILE;KEY11;
.
INPDTE99  RETURN
.-------------------------------------------------------------------------------
. Display User ID or Name 
.-------------------------------------------------------------------------------
DISUSR00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F2
          BRANCH    F2,DISUSR10
.
          PACK      KEY10,INPTWUID
          CALL      RDWBSE1
          BRANCH    OVRCD,DISUSR99
.
          WRITE     HTMLFILE;WBSENAM
          GOTO      DISUSR99
.
DISUSR10  WRITE     HTMLFILE;INPTWUID
. 
DISUSR99  RETURN
.-------------------------------------------------------------------------------
. Link to Correspondence Details Page 
.-------------------------------------------------------------------------------
CORPGE00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.      
          REP       " +",TEMPLATE
          REP       " +",DETAILKY          
          REP       " +",URNUMBER          
.
          WRITE     HTMLFILE;LINKPRG,".pbl?reportno=",LINKREP:
                                         "&template=",LINKTEM:
                                         "&urnumber=",URNUMBER:
                                         "&detailky=",DETAILKY;
.
          REP       "+ ",TEMPLATE
          REP       "+ ",DETAILKY          
          REP       "+ ",URNUMBER          
.
CORPGE99  RETURN
.-------------------------------------------------------------------------------
.  Correspondence Table Maintenance           
.-------------------------------------------------------------------------------
CORMAN00  MATCH     SP1,UPDTTYPE            
          GOTO      CORMAN40 IF EQUAL       * Display
          GOTO      CORMAN40 IF EOS
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      CORMAN10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      CORMAN20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      CORMAN30 IF EQUAL
.
          GOTO      CORMAN93
.
CORMAN10  CALL      CHKCOR00  * Checks mandatory fields & checks for blank
          BRANCH    EXIT,CORMAN99 
.
          PACK      KEY4,OBPCT001,SP70
          CALL      RDOBPT1
          COMPARE   ZERO,OVRCD
          GOTO      CORMAN92 IF EQUAL 
.
          CALL      WRMTBL00                * Write to the maintenance table
.
          CALL      CURLOC00                * Update current storage location
.
          MOVE      ZERO,EXIT
          GOTO      CORMAN99
.
CORMAN20  CALL      CHKCOR00  * Checks mandatory fields & checks for blank
          BRANCH    EXIT,CORMAN99 
.
          PACK      KEY4,OBPCT001,SP70
          CALL      RDOBPT1
          BRANCH    OVRCD,CORMAN91
.
          CALL      UPMTBL00                * Update the maintenance table
.
          CALL      CURLOC00                * Update current storage location
.
          MOVE      ZERO,EXIT
          GOTO      CORMAN99
.
CORMAN30  PACK      KEY4,OBPCT001,SP70
          CALL      RDOBPT1
          BRANCH    OVRCD,CORMAN91
.
          CALL      DEMTBL00                * Delete the maintenance table
          MOVE      ZERO,EXIT
          GOTO      CORMAN99
.
CORMAN40  PACK      KEY4,OBPCT001,SP70
          CALL      RDOBPT1
          IF        OVRCD=1
            MOVE      SP70,OBPTSLID  
            MOVE      SP70,OBPTSDIR  
            MOVE      SP70,OBPTURLP  
            MOVE      SP70,OBPTROLY  
            MOVE      SP70,OBPTCRDT  
            MOVE      SP70,OBPTCLDT  
            MOVE      SP70,OBPTSPAR  
          ENDIF
.
          MOVE      "Correspondence Table Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File an Write HTML Page Header
          BRANCH    EXIT,CORMAN99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CORMAN99
.
CORMAN91  MOVE      "Storage Location ID does not exist.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORMAN99
.
CORMAN92  MOVE      "Storage Location ID exists.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORMAN99
.
CORMAN93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORMAN99
.
CORMAN99  RETURN
.------------------------------------------------------------------
. * Checks Storage Location:cannot be blank. And checks mandatory fields
.------------------------------------------------------------------
CHKCOR00  RESET     OBPCT001
          MATCH     SP70,OBPCT001     * Check if Page No. is blank?
          GOTO      CHKCOR90 IF EQUAL
.
          RESET     OBPCT002
          MATCH     SP70,OBPCT002
          GOTO      CHKCOR91 IF EQUAL
.
          RESET     OBPCT003
          MATCH     SP70,OBPCT003
          GOTO      CHKCOR92 IF EQUAL
          GOTO      CHKCOR98
.
CHKCOR90  MOVE      "Location ID Cannot be blank!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCOR99
.
CHKCOR91  MOVE      "Location Directory is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCOR99
.
CHKCOR92  MOVE      "URL Prefix is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCOR99
.
CHKCOR98  MOVE      ZERO,EXIT
CHKCOR99  RETURN
.-------------------------------------------------------------------------------
.  Write to the correspondence maintenance table
.-------------------------------------------------------------------------------
WRMTBL00  CALL      IBACLOCK
          PACK      OBPTCRDT,CCC,CYY,CMM,CDD
          REP       " 0",OBPTCRDT
. 
          MOVE      OBPCT001,OBPTSLID
          MOVE      OBPCT002,OBPTSDIR
          MOVE      OBPCT003,OBPTURLP
.
          MATCH     "1",OBPCT004      
          IF        @EQUAL 
            MOVE      ONE,OBPTROLY
          ELSE
            MOVE      ZERO,OBPTROLY 
          ENDIF 
.
          MOVE      OBPCT005,OBPTCLDT
.
          PACK      KEY4,OBPTSLID 
          CALL      WROBPT1
.
WRMTBL99  RETURN
.-------------------------------------------------------------------------------
.  Update current storage location
.-------------------------------------------------------------------------------
CURLOC00  MATCH     "1",OBPCT006
          IF        @EQUAL    
            MOVE      OBPTSLID,CWEBCLOC
            WRITAB    CONTROLF,NINTY1;*219,CWEBCLOC
          ENDIF
.
CURLOC99  RETURN
.-------------------------------------------------------------------------------
.  Update the correspondence maintenance table
.-------------------------------------------------------------------------------
UPMTBL00  CALL      IBACLOCK
          PACK      OBPTCRDT,CCC,CYY,CMM,CDD
          REP       " 0",OBPTCRDT
.
.
          PACK      KEY4,OBPTSLID
          CALL      RDOBPT1
          IF        OVRCD=0
            MOVE      OBPCT001,OBPTSLID
            MOVE      OBPCT002,OBPTSDIR
            MOVE      OBPCT003,OBPTURLP
.
            MATCH     "1",OBPCT004
            IF        @EQUAL
              MOVE      ONE,OBPTROLY
            ELSE
              MOVE      ZERO,OBPTROLY
            ENDIF
            MOVE      OBPCT005,OBPTCLDT
.
            CALL      UPOBPT1
          ENDIF
.
UPMTBL99  RETURN
.-------------------------------------------------------------------------------
.  Delete the correspondence maintenance table
.-------------------------------------------------------------------------------
DEMTBL00  PACK      KEY4,OBPTSLID
          CALL      RDOBPT1
          IF        OVRCD=0
            CALL      DEOBPT1
          ENDIF
.
DEMTBL99  RETURN
.-------------------------------------------------------------------------------
. Patient Correspondence Maintenance
.-------------------------------------------------------------------------------
COMN0000  BRANCH    FLDITMNO,COMN0100,COMN0200,COMN0300,COMN0400,COMN0500:
                             COMN0600,COMN0700,COMN0800,COMN0900,COMN1000
          GOTO      COMN9999      
.
COMN0100  WRITE     HTMLFILE;OBPTSLID;
          GOTO      COMN9999
.
COMN0200  WRITE     HTMLFILE;OBPTSDIR;
          GOTO      COMN9999
.
COMN0300  WRITE     HTMLFILE;OBPTURLP;
          GOTO      COMN9999
.
COMN0400  WRITE     HTMLFILE;OBPTROLY;
          GOTO      COMN9999
.
COMN0500  MATCH     SP70,OBPTCLDT
          GOTO      COMN9999 IF EQUAL
.
          UNPACK    OBPTCLDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2  
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC 
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      COMN9999
.
COMN0600  WRITE     HTMLFILE;OBPTCRDT;
          GOTO      COMN9999
.
COMN0700  CALL      STOTBL00                     * table of storage locations
          GOTO      COMN9999
.
COMN0800  CALL      NXTLOC00
          GOTO      COMN9999
.
COMN0900  CALL      PRVLOC00 
          GOTO      COMN9999
.
COMN1000  READ      CONTROLF,NINTY1;*219,CWEBCLOC 
          MATCH     OBPTSLID,CWEBCLOC
          IF        @EQUAL
            WRITE     HTMLFILE;"1";
          ELSE
            WRITE     HTMLFILE;"0";
          ENDIF
          GOTO      COMN9999
.
COMN9999  RETURN
.------------------------------------------------------------
. Link to Next set of storage locations
.------------------------------------------------------------
NXTLOC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
NEXTAL99  RETURN
.-------------------------------------------------------------------------------
. Link to previous set of storage locations
.-------------------------------------------------------------------------------
PRVLOC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
PREVAL99  RETURN
.-------------------------------------------------------------------------------
. Table of storage locations
.-------------------------------------------------------------------------------
STOTBL00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          CALL      TABHED00                * Call Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD     * Set Default No Records to Display
          ENDIF
. 
          PACK      KEY4,STARTKEY,SP70
          CALL      RSOBPT1
          IF        OVRCD=0
            CALL      RPOBPT1
          ENDIF
STOTBL10  CALL      RKOBPT1
          BRANCH    OVRCD,STOTBL90
.
          WRITE     HTMLFILE;"<tr><td><a href='javascript:ShowDetail02":
                            "(#"",LINKPRG,".pbl?reportno=",LINKREP,"&template=":
                             LINKTEM,"&obpct001=",OBPTSLID,"#");'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a> ",OBPTSLID:
                             "</td><td>",OBPTSDIR,"</td></tr>" 
          GOTO      STOTBL10
.
STOTBL90  CALL      NOMORE00    * Display No More Records Message
.
STOTBL99  RETURN
.-------------------------------------------------------------------------------
.  Call Table Heading
.-------------------------------------------------------------------------------
TABHED00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>":
                             "Storage Location ID</td>":
                             "<td class=HeadingCell>Description</td>":
                             "</tr>"      
TABHED99  RETURN 
.-------------------------------------------------------------------------------
.  Call Date range Table Heading
.-------------------------------------------------------------------------------
TBHED000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center colspan=5>":
                             " Correspondence ";
          CALL      CURSTD00
          WRITE     HTMLFILE;" to ";
          CALL      CUREND00
          WRITE     HTMLFILE;"</td></tr>";
        
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%><b>Date</b></td>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Type </td>":
                             "<td class=HeadingCell>To </td>":
                             "<td class=HeadingCell>From </td>":
                             "</tr>"      
TBHED999  RETURN 
.-------------------------------------------------------------------------------
.   Correspondence List by Date/Type
.-------------------------------------------------------------------------------
CORDAT00  CALL      IBACLOCK
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          APPEND    "Correspondence",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,CORDAT99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00 
          GOTO      CORDAT99
.
CORDAT99  RETURN
.------------------------------------------------------------
. Download Data Field Maintenance
.------------------------------------------------------------
CORFLD00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      CORFLD40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      CORFLD10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      CORFLD20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      CORFLD30 IF EQUAL
.
          GOTO      CORFLD93
.
CORFLD10  RESET     CLIDF001
          PACK      KEY5,CLIDF001,SP70
          CALL      RDCOFL1
          COMPARE   ZERO,OVRCD
          GOTO      CORFLD92 IF EQUAL
          CALL      CHKFLD00      * Checks mandatory fields
          BRANCH    EXIT,CORFLD99
          CALL      FLDSAV00      * Moves input variables to file variables
          PACK      KEY5,CLIDF001,SP70
          CALL      WRCOFL1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORFLD99
.
CORFLD20  PACK      KEY5,CLIDF001,SP70
          CALL      RDCOFL1
          BRANCH    OVRCD,CORFLD91
          CALL      CHKFLD00      * Checks mandatory fields
          BRANCH    EXIT,CORFLD99
          CALL      FLDSAV00      * Moves input variables to file variables
          CALL      UPCOFL1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORFLD99
.
CORFLD30  PACK      KEY5,CLIDF001,SP70
          CALL      RDCOFL1
          BRANCH    OVRCD,CORFLD91
          CALL      DECOFL1       * Deletes the data
          MOVE      ZERO,EXIT
          GOTO      CORFLD99
.
CORFLD40  PACK      KEY5,CLIDF001,SP70
          CALL      RDCOFL1
          IF        OVRCD=1
            CALL      CLRFLD00     * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Download Data Field Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CORFLD99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CORFLD99
.
CORFLD91  MOVE      "Download Data Field record does not exist",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORFLD99
.
CORFLD92  MOVE      "Download Data Field record exists",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORFLD99
.
CORFLD93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORFLD99
.
CORFLD99  RETURN
.-----------------------------------------------------------
. Initialize's file data (Data Field Maintenace)
.-----------------------------------------------------------
CLRFLD00  MOVE      SP70,COFLFNUM
          MOVE      SP70,COFLFDSC
          MOVE      SP70,COFLGRP
          MOVE      SP70,COFLTAB
          MOVE      SP70,COFLFLD
          MOVE      SP70,COFLFSPA
.
CLRFLD99  RETURN
.-----------------------------------------------------------------
. Moves cgi variables into file variables (Data Field Maintenance) 
.----------------------------------------------------------------- 
FLDSAV00  MOVE      CLIDF001,COFLFNUM
          MOVE      CLIDF002,COFLFDSC
          MOVE      CLIDF003,COFLGRP
          MOVE      CLIDF004,COFLTAB
          MOVE      CLIDF005,COFLFLD
          MOVE      SP70,COFLFSPA
.
FLDSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields (Data Field Maintenance) 
.------------------------------------------------------------
CHKFLD00  RESET     CLIDF001
          MATCH     SP70,CLIDF001
          GOTO      CHKFLD90 IF EQUAL
.
          RESET     CLIDF002
          MATCH     SP70,CLIDF002
          GOTO      CHKFLD92 IF EQUAL
.
          GOTO      CHKFLD98
.
CHKFLD90  MOVE      "Download Data Field No. is mandatory",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD92  MOVE      "Download description is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD98  MOVE      ZERO,EXIT
CHKFLD99  RETURN
.------------------------------------------------------------
. Download Type Maintenance
.------------------------------------------------------------
CORTYP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      CORTYP50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      CORTYP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      CORTYP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      CORTYP30 IF EQUAL
.
          MATCH     "S",UPDTTYPE    * Copy formaction
          GOTO      CORTYP40 IF EQUAL
.
          GOTO      CORTYP93
.
CORTYP10  RESET     CLICT001
          PACK      KEY5,CLICT001,SP70
          CALL      RDCOTY1
          COMPARE   ZERO,OVRCD
          GOTO      CORTYP92 IF EQUAL
          CALL      CHKTYP00      * Checks mandatory fields
          BRANCH    EXIT,CORTYP99
          CALL      TYPSAV00      * Moves input variables to file variables
          PACK      KEY5,CLICT001,SP70
          CALL      WRCOTY1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORTYP99
.
CORTYP20  PACK      KEY5,CLICT001,SP70
          CALL      RDCOTY1
          BRANCH    OVRCD,CORTYP91
          CALL      CHKTYP00      * Checks mandatory fields
          BRANCH    EXIT,CORTYP99
          CALL      TYPSAV00      * Moves input variables to file variables
          CALL      UPCOTY1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORTYP99
.
CORTYP30  PACK      KEY5,CLICT001,SP70 
          CALL      RDCOTY1
          BRANCH    OVRCD,CORTYP91
          CALL      DECOTY1       * Deletes the data
.
          PACK      KEY10,CLICT001,SP70  * Cascading Delete: Delete Details 
          CALL      RSCODT1
CORTYP31  CALL      RKCODT1
          BRANCH    OVRCD,CORTYP32
          MATCH     CLICT001,CODTCTYP
          GOTO      CORTYP32 IF NOT EQUAL  
          PACK      KEY10,CODTCTYP,CODTFLNO,SP70
          CALL      DECODT1
          GOTO      CORTYP31     
.
CORTYP32  MOVE      ZERO,EXIT
          GOTO      CORTYP99
.
. Copy Formaction  
.
CORTYP40  PACK      KEY5,CLICT004,SP70  * Check if Source exists
          CALL      RDCOTY1
          BRANCH    OVRCD,CORTYP91
          PACK      KEY5,CLICT005,SP70  * Make sure destination Doesn't exist
          CALL      RDCOTY1
          COMPARE   ZERO,OVRCD
          GOTO      CORTYP92 IF EQUAL
          CALL      CHKCPY00     * Check Mandatory Copy Fields        
          BRANCH    EXIT,CORTYP99
          CALL      CPYTYP00     * Copy Source Details  
          CALL      CPYDET00     * Copy Source Details  
          MOVE      ZERO,EXIT
          GOTO      CORTYP99
.
CORTYP50  PACK      KEY5,CLICT001,SP70
          CALL      RDCOTY1
          IF        OVRCD=1
            CALL      CLRTYP00     * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Download Type Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CORTYP99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CORTYP99
.
CORTYP91  MOVE      "Download Type record does not exist",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORTYP99
.
CORTYP92  MOVE      "Download Type record exists",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORTYP99
.
CORTYP93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORTYP99
.
CORTYP99  RETURN
.-----------------------------------------------------------
. Initialize's file data (Type Maintenace)
.-----------------------------------------------------------
CLRTYP00  MOVE      SP70,COTYCTYP 
          MOVE      SP70,COTYCDSC 
          MOVE      SP70,COTYCSEC 
          MOVE      SP70,COTYCSPA  
.
CLRTYP99  RETURN
.-----------------------------------------------------------------
. Moves cgi variables into file variables (Type Maintenance) 
.----------------------------------------------------------------- 
TYPSAV00  MOVE      CLICT001,KEY5  
          SQUEEZE   KEY5
          MOVE      KEY5,COTYCTYP
          MOVE      CLICT002,COTYCDSC 
          MOVE      CLICT003,COTYCSEC  
          MOVE      SP70,COTYCSPA  
.
TYPSAV99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields (Type Maintenance) 
.------------------------------------------------------------
CHKTYP00  RESET     CLICT001
          MATCH     SP70,CLICT001
          GOTO      CHKTYP90 IF EQUAL
.
          RESET     CLICT002
          MATCH     SP70,CLICT002
          GOTO      CHKTYP92 IF EQUAL
.
.          RESET     CLICT003
.          MATCH     SP70,CLICT003
.          GOTO      CHKTYP93 IF EQUAL
.
          GOTO      CHKTYP98
.
CHKTYP90  MOVE      "Download Type is mandatory",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKTYP99
.
CHKTYP92  MOVE      "Download description is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKTYP99
.
.CHKTYP93  MOVE      "Download Security Level mandatory!",WEBTITLE
.          CALL      SHWERR00
.          MOVE      ONE,EXIT
.          GOTO      CHKTYP99
.
CHKTYP98  MOVE      ZERO,EXIT
CHKTYP99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields (Type Maintenance: Copy Formaction ) 
.------------------------------------------------------------
CHKCPY00  RESET     CLICT004
          MATCH     SP70,CLICT001
          GOTO      CHKCPY90 IF EQUAL
.
          RESET     CLICT005
          MATCH     SP70,CLICT002
          GOTO      CHKCPY92 IF EQUAL
.
          GOTO      CHKCPY98
.
CHKCPY90  MOVE      "Copy from Type is mandatory",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCPY99
.
CHKCPY92  MOVE      "Copy to Type is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCPY99
.
CHKCPY98  MOVE      ZERO,EXIT
CHKCPY99  RETURN
.------------------------------------------------------------
. Copy Source Download Type to Destination Download Type  
.------------------------------------------------------------
CPYTYP00  PACK      KEY5,CLICT004,SP70
          CALL      RDCOTY1
          MATCH     CLICT004,COTYCTYP
          GOTO      CPYTYP99 IF NOT EQUAL
.
          MOVE      CLICT005,COTYCTYP
          PACK      KEY5,CLICT005,SP70  * Copy to Destination
          CALL      WRCOTY1
.
CPYTYP99  RETURN
.------------------------------------------------------------
. Copy Source Download Details to Destination Download Details  
.------------------------------------------------------------
CPYDET00  PACK      KEY10,CLICT004,SP70
          CALL      RSCODT1      
CPYDET10  CALL      RKCODT1             * Read each Source record
          BRANCH    OVRCD,CPYDET99
          MATCH     CLICT004,CODTCTYP
          GOTO      CPYDET99 IF NOT EQUAL
.
          MOVE      CLICT005,CODTCTYP
          PACK      KEY10,CLICT005,CODTFLNO  * Copy to Destination
          CALL      WRCODT1
          GOTO      CPYDET10
.
CPYDET99  RETURN
.------------------------------------------------------------
. Download Detail Maintenance
.------------------------------------------------------------
CORDET00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      CORDET40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      CORDET10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      CORDET20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      CORDET30 IF EQUAL
.
          GOTO      CORDET93
.
CORDET10  CALL      CHKDET00  * Checks mandatory fields & checks for blank
          BRANCH    EXIT,CORDET99
          PACK      KEY10,CLICD001,CLICD002,SP70  * ADD FORMACTION
          CALL      RDCODT1
          COMPARE   ZERO,OVRCD
          GOTO      CORDET92 IF EQUAL
          CALL      DETSAV00      * Moves input variables to file variables
          CALL      WRCODT1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORDET99
.
CORDET20  PACK      KEY10,CLICD001,CLICD002,SP70  * UPDATE FORMACTION
          CALL      RDCODT1
          BRANCH    OVRCD,CORDET91
          CALL      CHKDET00      * Checks mandatory fields
          BRANCH    EXIT,CORDET99
          CALL      DETSAV00      * Moves input variables to file variables
          CALL      UPCODT1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      CORDET99
.
CORDET30  PACK      KEY10,CLICD001,CLICD002,SP70   * DELETE FORMACTION
          CALL      RDCODT1
          BRANCH    OVRCD,CORDET91
          CALL      DECODT1       * Deletes the data
          MOVE      ZERO,EXIT
          GOTO      CORDET99
.
CORDET40  PACK      KEY5,CLICD001,SP70
          CALL      RDCOTY1
          BRANCH    OVRCD,CORDET94
          MOVE      COTYCTYP,CORRTYPE
          MOVE      COTYCDSC,CORRDESC
.
          PACK      KEY10,CLICD001,CLICD002,SP70
          CALL      RDCODT1
          IF        OVRCD=1
            CALL      CLRDET00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Download Detail Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CORDET99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      CORDET99
.
CORDET91  MOVE      "Download Detail does not exist",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORDET99
.
CORDET92  MOVE      "Download Detail exists",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORDET99
.
CORDET93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORDET99
.
CORDET94  MOVE      "Invalid Download Type.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CORDET99
.
CORDET99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRDET00  MOVE      SP70,CODTCTYP  
          MOVE      SP70,CODTFLNO  
          MOVE      SP70,CODTDSEQ  
          MOVE      SP70,CODTHEAD  
          MOVE      SP70,CODTCNVT  
          MOVE      SP70,CODTSPAR  
.
CLRDET99  RETURN
.------------------------------------------------------------
. Moves cgi variables into file variables
.------------------------------------------------------------
DETSAV00  MOVE      CLICD001,KEY5
          SQUEEZE   KEY5
          MOVE      KEY5,CODTCTYP  
          MOVE      CLICD002,CODTFLNO   
          MOVE      CLICD003,CODTDSEQ    
          MOVE      CLICD004,CODTHEAD    
          MOVE      CLICD005,CODTCNVT    
          MOVE      SP70,CODTSPAR  
.
DETSAV99  RETURN
.------------------------------------------------------------------
. * Checks Download Details: Mandatory fields
.------------------------------------------------------------------
CHKDET00  RESET     CLICD002
          MATCH     SP70,CLICD002
          GOTO      CHKDET91 IF EQUAL
.
          RESET     CLICD003
          MATCH     SP70,CLICD003
          GOTO      CHKDET91 IF EQUAL
.
          GOTO      CHKDET98
.
CHKDET90  MOVE      "Data Field Number is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKDET99
.
CHKDET91  MOVE      "Download Sequence is mandatory!",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKDET99
.
CHKDET98  MOVE      ZERO,EXIT
CHKDET99  RETURN
.-------------------------------------------------------------------------------
.  All Correspondence 
.-------------------------------------------------------------------------------
CORVS000  BRANCH    FLDITMNO,CORVS010,CORVS020,CORVS030,CORVS040:
                             CORVS050,CORVS060,CORVS070,CORVS080:
                             CORVS090,CORVS100,CORVS110,CORVS120:
                             CORVS130,CORVS140,CORVS150,CORVS160
.
CORVS010  CALL      NEXT0000
          GOTO      CORVS999
.
CORVS020  CALL      PREV0000
          GOTO      CORVS999
.
CORVS030  CALL      CURSTD00
          GOTO      CORVS999
.
CORVS040  CALL      CUREND00
          GOTO      CORVS999
.
CORVS050  CALL      CURYR000
          GOTO      CORVS999
.
CORVS060  CALL      CURMON00
          GOTO      CORVS999
.
CORVS070  CALL      SELV0000
          GOTO      CORVS999
.
CORVS080  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          MOVE      CORSP003,LINKTYP
          PACK      LINKTYP,LINKTYP,SP70
          MATCH     SP70,LINKTYP
          IF        @EQUAL
            CALL      TOPV0000               * correspondence by date
          ELSE
            CALL      TCTD0000               * correspondence by type and date
          ENDIF
          GOTO      CORVS999
.
CORVS090  WRITE     HTMLFILE;TEMPLATE;
          GOTO      CORVS999
.
CORVS100  WRITE     HTMLFILE;REPORTNO;
          GOTO      CORVS999
.
CORVS110  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CORVS999
.
CORVS120  MOVE      CATwi,CATEGORY
          MOVE      CORSP003,CODE
          CALL      CODITM00
          GOTO      CORVS999 
.
CORVS130  CALL      AUDLST00
          GOTO      CORVS999
.
CORVS140  MOVE      CATwi,CATEGORY
          MOVE      FILTDCTY,CODE
          CALL      CODITM00
          GOTO      CORVS999
.
CORVS150  WRITE     HTMLFILE;FILTAUTY;
          GOTO      CORVS999
.
CORVS160  CALL      AUDUSR00
          GOTO      CORVS999
.
CORVS999  RETURN
.-------------------------------------------------------------------------------
.  Table of correspondence by date
.-------------------------------------------------------------------------------
TOPV0000  
.CALL      TBHED000                * Call Table Heading
          PACK      KEY28,FRSTDATE,SP70
          CALL      RSOBPC3
TOPV0010  CALL      RKOBPC3
          BRANCH    OVRCD,TOPV9999
          MATCH     OBPCINDT,LASTDATE
          GOTO      TOPV9999 IF LESS
          MATCH     "1",OBPCMDEL         * Ignore Deleted
          GOTO      TOPV0010 IF EQUAL
          MATCH     "2",OBPCMDEL         * Ignore Drafts
          GOTO      TOPV0010 IF EQUAL
.
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
.
          CALL      TABROW00                * Output table row
.
          GOTO      TOPV0010
.
TOPV9999  RETURN
.------------------------------------------------------------
.  Table of correspondence by type and date
.------------------------------------------------------------
TCTD0000  
.CALL      TBHED000                * Call Table Heading
.
          PACK      KEY31,LINKTYP,FRSTDATE,SP70
          CALL      RSOBPC4
TCTD0010  CALL      RKOBPC4
          BRANCH    OVRCD,TCTD9999
          MATCH     OBPCCTYP,LINKTYP
          GOTO      TCTD9999 IF NOT EQUAL
          MATCH     OBPCINDT,LASTDATE
          GOTO      TCTD9999 IF LESS
          MATCH     "1",OBPCMDEL      * Ignore Deleted
          GOTO      TCTD0010 IF EQUAL
          MATCH     "2",OBPCMDEL      * Ignore Drafts
          GOTO      TCTD0010 IF EQUAL
.
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY8,OBPCURNO
          CALL      RDMAST1
.
          CALL      TABROW00                * Output table row
.
          GOTO      TCTD0010
.
TCTD9999  RETURN
.------------------------------------------------------------
.  Output table row
.------------------------------------------------------------
TABROW00  PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          BRANCH    OVRCD,TABROW99
.
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKFRM00
.
          CALL      CHKSEC00
          BRANCH    EXIT,TABROW99
.
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      CMDLINE,OUTVAR
.
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
.
          MATCH     SP70,FILTER03
          GOTO      TABROW30 IF EQUAL
          MATCH     SP70,TCINDC3             * Indicator Blank so Include
          GOTO      TABROW30 IF EQUAL
          MATCH     FILTER03,TCINDC3         * Does Match Filter Indicator Exclude
          GOTO      TABROW99 IF NOT EQUAL
.
TABROW30  PACK      DETAILKY,OBPCURNO,OBPCCVIS,OBPCCPID
          REP       " +",DETAILKY
.
          WRITE     HTMLFILE;"t.addRow(":
                    QUOTE,"javascript:ShowDoc('",OUTVAR,"');",QUOTE,COMMA:
                    QUOTE,"javascript:ViewDoc('",DETAILKY,"');",QUOTE,COMMA:
                    QUOTE,OBPCINDT,OBPCINTM,QUOTE,COMMA:
                    QUOTE,PSNAME,COMMA,PGNAME,COMMA:
                          PTITL,COMMA,PURNO,QUOTE,COMMA:
                    QUOTE,TDESC,QUOTE,COMMA:
                    QUOTE,OBPCCTOO,QUOTE,COMMA:
                    QUOTE,OBPCCFRM,QUOTE,COMMA:
                    QUOTE,OBPCCOM1,OBPCCOM2,QUOTE,");"
TABROW99  RETURN
.------------------------------------------------------------
. Link to Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",CORSP003
          REP       " +",FILTDCTY
          REP       " +",FILTUSER
          REP       " +",FILTAUTY
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&corsp003=",CORSP003:
                                 "&filtdcty=",FILTDCTY:
                                 "&filtuser=",FILTUSER:
                                 "&filtauty=",FILTAUTY;

          REP       "+ ",CORSP003
          REP       "+ ",FILTDCTY
          REP       "+ ",FILTUSER
          REP       "+ ",FILTAUTY
.
NEXT9999  RETURN
.-------------------------------------------------------------------------------
.  Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",CORSP003
          REP       " +",FILTDCTY
          REP       " +",FILTUSER
          REP       " +",FILTAUTY
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&corsp003=",CORSP003:
                                 "&filtdcty=",FILTDCTY:
                                 "&filtuser=",FILTUSER:
                                 "&filtauty=",FILTAUTY;
.
          REP       "+ ",CORSP003
          REP       "+ ",FILTDCTY
          REP       "+ ",FILTUSER
          REP       "+ ",FILTAUTY
.
PREV9999  RETURN
.------------------------------------------------------------
. Corespondence Data Fields Maintenance 
.------------------------------------------------------------
DLFD0000  BRANCH    FLDITMNO,DLFD0100,DLFD0200,DLFD0300,DLFD0400,DLFD0500:
                             DLFD0600,DLFD0700,DLFD0800,DLFD0900,DLFD1000
          GOTO      DLFD9999
.
DLFD0100  CALL      NEXTCR00      * Link to Next Group
          GOTO      DLFD9999
.
DLFD0200  CALL      PREVCR00      * Link to Last Group
          GOTO      DLFD9999
.
DLFD0300  MOVE      ZERO,LNK2PRT
          CALL      FLTAB000      * Table of Download Data Fields 
          GOTO      DLFD9999
.
DLFD0400  WRITE     HTMLFILE;COFLFNUM;
          GOTO      DLFD9999
.
DLFD0500  WRITE     HTMLFILE;COFLFDSC;
          GOTO      DLFD9999
.
DLFD0600  MATCH     SP70,STARTKEY
          GOTO      DLFD9999 IF EQUAL
          WRITE     HTMLFILE;STARTKEY;
          GOTO      DLFD9999
.
DLFD0700  MOVE      ONE,LNK2PRT   * Update Parent
          CALL      FLTAB000      * Table of Download Data Fields 
          GOTO      DLFD9999
.
DLFD0800  WRITE     HTMLFILE;COFLGRP;
          GOTO      DLFD9999
.
DLFD0900  WRITE     HTMLFILE;COFLTAB;
          GOTO      DLFD9999
.
DLFD1000  WRITE     HTMLFILE;COFLFLD;
          GOTO      DLFD9999
.
DLFD9999  RETURN
.------------------------------------------------------------
. Corespondence Type Maintenance 
.------------------------------------------------------------
CTYP0000  BRANCH    FLDITMNO,CTYP0100,CTYP0200,CTYP0300,CTYP0400,CTYP0500:
                             CTYP0600
          GOTO      CTYP9999
.
CTYP0100  CALL      NEXTCR00      * Link to Next Group
          GOTO      CTYP9999
.
CTYP0200  CALL      PREVCR00      * Link to Last Group
          GOTO      CTYP9999
.
CTYP0300  CALL      TYTAB000      * Table Download Types 
          GOTO      CTYP9999
.
CTYP0400  WRITE     HTMLFILE;COTYCTYP;
          GOTO      CTYP9999
.
CTYP0500  WRITE     HTMLFILE;COTYCDSC;
          GOTO      CTYP9999
.
CTYP0600  WRITE     HTMLFILE;COTYCSEC;
          GOTO      CTYP9999
.
CTYP0700  MATCH     SP70,STARTKEY
          GOTO      CTYP9999 IF EQUAL
          WRITE     HTMLFILE;STARTKEY;
          GOTO      CTYP9999
.
CTYP9999  RETURN
.------------------------------------------------------------
. Download Detail Maintenance 
.------------------------------------------------------------
CDTL0000  BRANCH    FLDITMNO,CDTL0100,CDTL0200,CDTL0300,CDTL0400,CDTL0500:
                             CDTL0600,CDTL0700,CDTL0800,CDTL0900,CDTL1000:
                             CDTL1100
          GOTO      CDTL9999
.
CDTL0100  CALL      NEXTCR00   * Link to Next Group
          GOTO      CDTL9999
.
CDTL0200  CALL      PREVCR00   * Link to Last Group
          GOTO      CDTL9999
.
CDTL0300  CALL      TDTAB000   * Table of Download Details by Data Field 
          GOTO      CDTL9999
.
CDTL0400  CALL      DDTAB000   * Table of Download Details by Download Sequence 
          GOTO      CDTL9999
.
CDTL0500  WRITE     HTMLFILE;CORRTYPE;
          GOTO      CDTL9999
.
CDTL0600  WRITE     HTMLFILE;CODTFLNO;
          GOTO      CDTL9999
.
CDTL0700  WRITE     HTMLFILE;CODTDSEQ;
          GOTO      CDTL9999
.
CDTL0800  WRITE     HTMLFILE;CODTHEAD;
          GOTO      CDTL9999
.
CDTL0900  MATCH     SP70,CODTCNVT
          IF        @EQUAL
            WRITE     HTMLFILE;"0";
          ELSE 
            WRITE     HTMLFILE;CODTCNVT;
          ENDIF 
          GOTO      CDTL9999
.
CDTL1000  MATCH     SP70,STARTKEY
          GOTO      CDTL9999 IF EQUAL
          WRITE     HTMLFILE;STARTKEY;
          GOTO      CDTL9999
.
CDTL1100  WRITE     HTMLFILE;CORRDESC;
          GOTO      CDTL9999
.
CDTL9999  RETURN
.------------------------------------------------------------
. Link to Next set of Download Data Fields 
.------------------------------------------------------------
NEXTCR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       " +",CORRTYPE
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY: 
                                 "&clicd001=",CORRTYPE; 
.
          REP       "+ ",STARTKEY
          REP       "+ ",CORRTYPE
.
NEXTCR99  RETURN
.-------------------------------------------------------------------------------
. Link to previous set of Download Data Fields 
.-------------------------------------------------------------------------------
PREVCR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       " +",CORRTYPE
.
          WRITE     HTMLFILE;"cliweb08.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY:
                                 "&clicd001=",CORRTYPE; 
.
          REP       "+ ",STARTKEY
          REP       "+ ",CORRTYPE
.
PREVCR99  RETURN
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.------------------------------------------------------------
. Download Data Fields Table
.------------------------------------------------------------
FLTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      FLHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY5,STARTKEY,SP70
          CALL      RSCOFL1
          IF        OVRCD=0
            CALL      RPCOFL1
          ENDIF
FLTAB100  CALL      RKCOFL1
          BRANCH    OVRCD,FLTAB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FLTAB100
          ENDIF
.
          CALL      FLROWA00      * Download Data Fields Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      FLTAB100 IF NOT EQUAL
          GOTO      FLTAB999
.
FLTAB900  CALL      NOMORE00      * Display No More Records Message
.
FLTAB999  RETURN
.------------------------------------------------------------
. Download Data Fields (TABLE HEADING)
.------------------------------------------------------------
FLHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>Field No.</td>":
                               "<td class=HeadingCell>Group</td>":
                               "<td class=HeadingCell>Description</td>":
                               "<td class=HeadingCell>Table</td>":
                               "<td class=HeadingCell>Field</td>":
                             "</tr>"
.
FLHED999  RETURN
.------------------------------------------------------------
. Download Data Fields (TABLE ROW)
.------------------------------------------------------------
FLROWA00  BRANCH    LNK2PRT,FLROWA10 
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail04":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&clidf001=",COFLFNUM,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             COFLFNUM,"</td>":
                             "<td>",COFLGRP,"</td>":
                             "<td>",COFLFDSC,"</td>":
                             "<td>",COFLTAB,"</td>":
                             "<td>",COFLFLD,"</td>":
                             "</tr>"
          GOTO      FLROWA99 
.
FLROWA10  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<A HREF=#"#" ":
                             "onClick=#"updateParent04('",COFLFNUM:
                             "','",COFLFDSC,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             COFLFNUM,"</td>":
                             "<td>",COFLGRP,"</td>":
                             "<td>",COFLFDSC,"</td>":
                             "<td>",COFLTAB,"</td>":
                             "<td>",COFLFLD,"</td>":
                             "</tr>"
.
FLROWA99 RETURN
.------------------------------------------------------------
. Download Type Table
.------------------------------------------------------------
TYTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      TYHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY5,STARTKEY,SP70
          CALL      RSCOTY1
          IF        OVRCD=0
            CALL      RPCOTY1
          ENDIF
TYTAB100  CALL      RKCOTY1
          BRANCH    OVRCD,TYTAB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      TYTAB100
          ENDIF
.
          CALL      TYROWA00      * Download Type Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      TYTAB100 IF NOT EQUAL
          GOTO      TYTAB900 
.
TYTAB900  CALL      NOMORE00      * Display No More Records Message
.
TYTAB999  RETURN
.------------------------------------------------------------
. Download Type (TABLE HEADING)
.------------------------------------------------------------
TYHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Download Type</td>":
                               "<td class=HeadingCell>Description</td>":
                               "<td class=HeadingCell width=20%>":
                               "Security Level</td>":
                             "</tr>"
.
TYHED999  RETURN
.------------------------------------------------------------
. Download Type (TABLE ROW)
.------------------------------------------------------------
TYROWA00  MATCH     SP70,COTYCSEC  
          IF        @EQUAL
            MOVE      "&nbsp;",KEY6
          ELSE
            PACK      KEY6,COTYCSEC,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail05":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&clict001=",COTYCTYP,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             COTYCTYP,"</td>":
                             "<td>",COTYCDSC,"</td>":
                             "<td>",KEY6,"</td>":
                             "</tr>"
.
TYROWA99 RETURN
.------------------------------------------------------------
. Table of Download Details by Data Field 
.------------------------------------------------------------
TDTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      TDHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY10,CORRTYPE,STARTKEY,SP70
          CALL      RSCODT1
          IF        OVRCD=0
            CALL      RPCODT1
          ENDIF
TDTAB100  CALL      RKCODT1
          BRANCH    OVRCD,TDTAB900
.
          MATCH     CORRTYPE,CODTCTYP
          GOTO      TDTAB900 IF NOT EQUAL 
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      TDTAB100
          ENDIF
.
          CALL      TDROWA00      * Download Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      TDTAB100 IF NOT EQUAL
          GOTO      TDTAB999
.
TDTAB900  CALL      NOMORE00      * Display No More Records Message
.
TDTAB999  RETURN
.------------------------------------------------------------
. Table of Download Details by Download Sequence 
.------------------------------------------------------------
DDTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      TDHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY13,CORRTYPE,SP3,STARTKEY,SP30
          CALL      RSCODT2
DDTAB100  CALL      RKCODT2
          BRANCH    OVRCD,DDTAB900
.
          MATCH     CORRTYPE,CODTCTYP                                          
          GOTO      TDTAB900 IF NOT EQUAL                                      
.
          MATCH     SP70,CODTDSEQ
          GOTO      DDTAB900 IF EQUAL
          MATCH     STARTKEY,CODTFLNO  
          GOTO      DDTAB100 IF LESS
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      DDTAB100
          ENDIF
.
          CALL      TDROWA00      * Download Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      DDTAB100 IF NOT EQUAL
          GOTO      DDTAB999
.
DDTAB900  CALL      NOMORE00      * Display No More Records Message
.
DDTAB999  RETURN
.------------------------------------------------------------
. Download Details (TABLE HEADING)
.------------------------------------------------------------
TDHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Field Number</td>":
                               "<td class=HeadingCell>Sequence</td>":
                               "<td class=HeadingCell>Heading Name</td>":
                             "</tr>"
.
TDHED999  RETURN
.------------------------------------------------------------
. Download Details (TABLE ROW)
.------------------------------------------------------------
TDROWA00  MATCH     SP70,CODTHEAD  
          IF        @EQUAL
            MOVE      "&nbsp;",KEY25
          ELSE
            PACK      KEY25,CODTHEAD,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&clicd001=",CODTCTYP:
                             "&clicd002=",CODTFLNO,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             CODTFLNO,"</td>":
                             "<td>",CODTDSEQ,"</td>":
                             "<td>",KEY25,"</td>":
                             "</tr>"
.
TDROWA99 RETURN
.------------------------------------------------------------
. Add Selection Options to Form (code value)
.------------------------------------------------------------
CTYSEL00  PACK      KEY5,SP70
          CALL      RSCOTY1
CTYSEL10  CALL      RKCOTY1
          BRANCH    OVRCD,CTYSEL99
          WRITE     HTMLFILE;"<option value=",COTYCTYP,">":
                               COTYCDSC,"</option>"
          GOTO      CTYSEL10
.
CTYSEL99  RETURN
.
.-------------------------------------------------------------------------------
.  Add a patient correspondence result record 
.-------------------------------------------------------------------------------
LNKRES00  MATCH     SP70,CORSP002           * validate input date
          GOTO      LNKRES90 IF EQUAL
          GOTO      LNKRES90 IF EOS 
          MATCH     SP70,CORSP004           * validate input time
          GOTO      LNKRES91 IF EQUAL
          GOTO      LNKRES91 IF EOS 
.
          MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,LNKRES92
.
          MOVE      RESULTKY,KEY17
          CALL      RDREHA1
          BRANCH    OVRCD,LNKRES92
.
          CALL      NEWCOR00
          BRANCH    EXIT,LNKRES99
.
          MOVE      ZERO,F2
          PACK      KEY20,RESULTKY,Z70
          CALL      RSRECL1
          CALL      RPRECL1
          BRANCH    OVRCD,LNKRES10
          PACK      KEY17,RECLRDT,RECLRTM,RECLRUN,SP70
          MATCH     KEY17,RESULTKY
          GOTO      LNKRES10 IF NOT EQUAL
          MOVE      RECLLNO,F2
LNKRES10  ADD       ONE,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          PACK      KEY20,RESULTKY,KEY2
          CALL      RDRECL1
          COMPARE   ZERO,OVRCD
          GOTO      LNKRES10 IF EQUAL
.
          UNPACK    KEY20,RECLRDT,RECLRTM,RECLRUN,RECLLNO
          MOVE      OBPCURNO,RECLURN
          MOVE      OBPCCVIS,RECLVIS
          MOVE      OBPCCPID,RECLCID
          MOVE      SP70,RECLSPA
          CALL      WRRECL1
.
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      LNKRES99
          
.
LNKRES90  MOVE      "Invalid Date",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKRES99
.
LNKRES91  MOVE      "Invalid Time",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKRES99
.
LNKRES92  MOVE      "Invalid Result Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKRES99
.
LNKRES99  RETURN
.-------------------------------------------------------------------------------
.  Add a patient correspondence referral record 
.-------------------------------------------------------------------------------
LNKREF00  MATCH     SP70,CORSP002           * validate input date
          GOTO      LNKREF90 IF EQUAL
          GOTO      LNKREF90 IF EOS 
          MATCH     SP70,CORSP004           * validate input time
          GOTO      LNKREF91 IF EQUAL
          GOTO      LNKREF91 IF EOS 
.
          MOVE      REFERLKY,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,LNKREF92
.
          CALL      NEWCOR00
          BRANCH    EXIT,LNKREF99
.
          MOVE      ZERO,F3
          PACK      KEY11,REFERLKY,Z70
          CALL      RSALLIN1
          CALL      RPALLIN1
          BRANCH    OVRCD,LNKREF10
          MATCH     REFERLKY,ALLIVISN
          GOTO      LNKREF10 IF NOT EQUAL
          MOVE      ALLILINK,F3
LNKREF10  ADD       ONE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          PACK      KEY11,REFERLKY,KEY3
          CALL      RDALLIN1
          COMPARE   ZERO,OVRCD
          GOTO      LNKREF10 IF EQUAL
.
          UNPACK    KEY11,ALLIVISN,ALLILINK
          MOVE      OBPCURNO,ALLIURNO
          MOVE      OBPCCPID,ALLICOID
          MOVE      SP70,ALLISPAR
          CALL      WRALLIN1
.
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      LNKREF99
.
LNKREF90  MOVE      "Invalid Date",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF91  MOVE      "Invalid Time",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF92  MOVE      "Invalid Referral Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF99  RETURN
.-------------------------------------------------------------------------------
.-------------------------------------------------------------------------------
.  Remove a patient correspondence result record 
.-------------------------------------------------------------------------------
REMRES00  MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,REMRES90
.
          PACK      RESLNKFL,PRELEN,RESULTKY          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA3,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      REMRES90 IF EQUAL                 * end I CAR 38290
.
          PACK      KEY29,RESULTKY,SP70
          CALL      RSRELN3
          CALL      RKRELN3
          BRANCH    OVRCD,REMRES90
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70
          MATCH     KEY17,RESULTKY
          GOTO      REMRES90 IF NOT EQUAL
          MATCH     "2",RELNRTY
          GOTO      REMRES91 IF NOT EQUAL
   
REMRES10  PACK      KEY29,RESULTKY,SP70
          CALL      RSRELN3
          CALL      RKRELN3
          BRANCH    OVRCD,REMRES20
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70
          MATCH     KEY17,RESULTKY
          GOTO      REMRES20 IF NOT EQUAL
          PACK      KEY29,RELNRDT,RELNRTM,RELNRUN,RELNLTY,RELNLKY,SP70
          CALL      DERELN3
          GOTO      REMRES10
   
REMRES20  MOVE      RESULTKY,KEY17
          CALL      RDREHA1
          BRANCH    OVRCD,REMRES90
          CALL      DEREHA1
.
REMRES30  PACK      KEY20,RESULTKY,SP70
          CALL      RSRECL1
          CALL      RKRECL1
          BRANCH    OVRCD,REMRES40
          PACK      KEY20,RECLRDT,RECLRTM,RECLRUN,RECLLNO,SP70
          MATCH     KEY20,RESULTKY
          GOTO      REMRES40 IF NOT EQUAL
          CALL      DERECL1
.
          PACK      KEY20,RECLURN,RECLVIS,RECLCID,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,REMRES30
          CALL      DEOBPC1
.
          GOTO      REMRES30
.
REMRES40  PACK      KEY25,RESULTKY,SP70
          CALL      RSRELU2
          CALL      RKRELU2
          BRANCH    OVRCD,REMRES80
          PACK      KEY25,RELURDT,RELURTM,RELURUN,RELUURN,SP70
          MATCH     KEY25,RESULTKY
          GOTO      REMRES80 IF NOT EQUAL
          CALL      DERELU2
          GOTO      REMRES40
.
REMRES80  MOVE      ZERO,EXIT
          GOTO      REMRES99
.
REMRES90  MOVE      "Invalid Result Key",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      REMRES99
.
REMRES91  MOVE      "Invalid Result Type",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      REMRES99
.
REMRES99  RETURN
.-------------------------------------------------------------------------------
.  Add a patient correspondence result record 
.-------------------------------------------------------------------------------
ADDRES00  MATCH     SP70,CORSP002           * validate input date
          GOTO      ADDRES95 IF EQUAL
          GOTO      ADDRES95 IF EOS 
          MATCH     SP70,CORSP004           * validate input time
          GOTO      ADDRES96 IF EQUAL
          GOTO      ADDRES96 IF EOS 
.
          CALL      NEWCOR00
          BRANCH    EXIT,ADDRES99
.
          MOVE      OBPCINDT,RESLNK01
          MOVE      OBPCINTM,RESLNK02
.
          CALL      NEWRES00
.
          MOVE      "01",KEY2
          PACK      KEY20,REHARDT,REHARTM,REHARUN,KEY2
          CALL      RDRECL1
          IF        OVRCD=1
            UNPACK    KEY20,RECLRDT,RECLRTM,RECLRUN,RECLLNO
            MOVE      OBPCURNO,RECLURN
            MOVE      OBPCCVIS,RECLVIS
            MOVE      OBPCCPID,RECLCID
            MOVE      SP70,RECLSPA
            CALL      WRRECL1
          ENDIF
.
          MOVE      ZERO,EXIT                * To go to next page
          GOTO      ADDRES99
.
ADDRES90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES91  CLEAR     WEBTITLE
          APPEND    "Invalid Admissno Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES92  CLEAR     WEBTITLE
          APPEND    "Invalid User ID - ",WEBTITLE
          APPEND    KEY10,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES93  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES94  MOVE      "Invalid File - ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES95  MOVE      "Invalid Date",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES96  MOVE      "Invalid Time",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      ADDRES99
.
ADDRES99  RETURN
+
.------------------------------------------------------------
.         New Correspondenance Item
.------------------------------------------------------------
NEWCOR00  MOVE      SP70,DETAILK1
.
          PACK      KEY8,ADMISSNO           * validate admissno
          MOVE      ADMISSNO,SAVISIT
          MATCH     SP70,ADMISSNO
          IF        @EQUAL|@EOS
            MOVE      "00000000",SAVISIT
            GOTO      NEWCOR20
          ENDIF
.
          MOVE     ADMISSNO,KEY8  * Validate Admission to UR No by reading
          CALL     RDVISA1        * visit
          IF       OVRCD<>1
            MATCH    PVIURNO,URNUMBER
            GOTO     NEWCOR93 IF NOT EQUAL
            GOTO     NEWCOR20
          ENDIF
.  no visit record exists, check inpatient booking
          PACK     KEY8,ADMISSNO,SP70  * Read Booking File
          CALL     RDBKREC1
          BRANCH   OVRCD,NEWCOR10
.
          MATCH    BKREURNO,URNUMBER
          GOTO     NEWCOR93 IF NOT EQUAL
          GOTO     NEWCOR20
.
.  no visit record exists, check outpatient booking
NEWCOR10  CALL      OUTFIL00              * Check user id site files
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,NEWCOR93
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      NEWCOR93 IF NOT EQUAL
          MATCH     OBAURNO,URNUMBER
          GOTO      NEWCOR93 IF NOT EQUAL
          GOTO      NEWCOR20
.
NEWCOR20  PACK      KEY8,URNUMBER         * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
.
          CALL      RDPMPX21
          MOVE      ONE,CORRESID
          PACK      KEY20,URNUMBER,SAVISIT,Z70
          CALL      RSOBPC1
          CALL      RPOBPC1              * Positions on last value
          BRANCH    OVRCD,NEWCOR50
          MATCH     URNUMBER,OBPCURNO
          GOTO      NEWCOR50 IF NOT EQUAL
          MATCH     SAVISIT,OBPCCVIS
          GOTO      NEWCOR50 IF NOT EQUAL
          MOVE      OBPCCPID,CORRESID
          ADD       ONE,CORRESID
.
NEWCOR50  MOVE      CORRESID,OBPCCPID       * Correspondence ID
          MOVE      SAVISIT,OBPCCVIS
          MOVE      URNUMBER,OBPCURNO
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD * Last update date 
          REP       " 0",OBPCDTLU
          MOVE      CTIMEIS,OBPCTMLU        * Last Update time
.
          MOVE      WBSEUID,OBPCINUS        * Web User ID
          MOVE      WBSEUID,OBPCLUID        * Last Web User ID
          MOVE      ZERO,OBPCMDEL           * Delete indicator not set
          MATCH     "1",DRAFTDOC
          IF        @EQUAL
            MOVE      THREE,OBPCMDEL        * Current Draft Document
          ENDIF
.
          MATCH     SP70,CORSP001
          IF        @EQUAL
            COMPARE   ZERO,HTMLCNT
            GOTO      NEWCOR94 IF EQUAL
            CLOSE     TEMPFILE
            CLEAR     CORSP001
            APPEND    TEMPNAME,CORSP001
            APPEND    ".html",CORSP001
            RESET     CORSP001
          ENDIF
.
          SCAN      ".",CORSP001
          MOVE      CORSP001,OBPCFEXT
          RESET     CORSP001
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT 
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT 
          ENDIF
          REP       " 0",CORSFILE
.
          READ      CONTROLF,NINTY1;*219,CWEBCLOC
          PACK      KEY4,CWEBCLOC
          CALL      RDOBPT1
          BRANCH    OVRCD,NEWCOR91
.
          MOVE      OBPTSLID,OBPCSLID       * Storage Location ID
          STRIP     OBPTSDIR
          PACK      CMDLINE,CMDFCHK,USERID,SP1,CORSP001,SP1,CORSFILE
          EXECUTE   CMDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      NEWCOR92 IF NOT EQUAL   * "cliweb08.us1" script failed
.
          PACK      CMDLINE,CMDMOVE,CORSP001,SP1,OBPTSDIR,CORSFILE
          EXECUTE   CMDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      NEWCOR97 IF NOT EQUAL       * move (mv) command failed
.
          IF        SAVE2PDF=1
            MOVE      CORSP003,KEY3         * Type of Correspondence
            MOVE      "F",KEY1
            MATCH     "1",DRAFTDOC
.
            IF        @EQUAL
              MOVE      "D",KEY1
            ENDIF
.
            PACK      CMDPARA,PRINTFMT,SP1,KEY1,SP1,WBSEHOSP,SP1,WBSEUID,SP1,URNUMBER,SP1,ADMISSNO
            PACK      CMDLINE,HTML2PDF,SP1,OBPTSDIR,CORSFILE,SP1,CMDPARA
.
            EXECUTE   CMDLINE,TASKID
            MATCH     "0",TASKID
            GOTO      NEWCOR98 IF NOT EQUAL     * ConvertHTML2PDF script failed
.
            MOVE      ".pdf",OBPCFEXT
.
            IF       CREATIFC=1
              MATCH     "1",PTCNEPIS             * Using Episoft Interface
              GOTO      NEWCO910 IF NOT EQUAL
.
              PACK      KEY20,IFCXEADM,SP70
              CALL      RDPMEHB1
              BRANCH    OVRCD,NEWCO910
.
              IF        IBCNMHOS=1
                PACK      KEY8,PMHBVISN,SP70
                CALL      RDPMVX11
                IF        OVRCD=0
                  MOVE      PMVXMHOS,IFCXHOSP
                ENDIF
              ELSE
                PACK      KEY3,SP70
                CALL      RSPTHSP1
                CALL      RKPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSHOSP,IFCXHOSP
                ELSE
                  MOVE      "HOS",IFCXHOSP
                ENDIF
              ENDIF
.
              CALL      TFILENAM            * Get temp filename
              PREP      IFCFLTXT,TFILNAME   * Create temp file
.
              MOVE      OBPCCPID,DIM4       * Get Correspondence ID
              REP       "0 ",DIM4           * replace zeros with spaces
              SQUEEZE   DIM4                * remove whitespaces
.
              SQUEEZE   IFCXHOSP
              SQUEEZE   IFCXELOS
.
              WRITE     IFCFLTXT,SEQ;*+,IFCXHOSP,*-,PIPE,*+,URNUMBER,*-,PIPE:
                                     ADMISSNO,PIPE,PMHBEAID,PIPE,*+,DIM4,*-:
                                     PIPE,*+,IFCXELOS,*-,PIPE,IFCXCLAI
.
              CLEAR     CMDLINE
              RESET     CMDLINE
.
              MOVELPTR  CORSFILE,F3
              SUB       FIVE,F3
              SETLPTR   CORSFILE,F3
              ENDSET    CORSFILE
              APPEND    OBPCFEXT,CORSFILE
              RESET     CORSFILE
.
.             Execute script (CreateIFCXML) to create the IFC .xml file in the
.             web spool directory ...
              PACK      CMDLINE,CREAIFCX,SP1,TFILNAME,TXTFILEX,SP1,OBPTSDIR,CORSFILE
.
              EXECUTE   CMDLINE,TASKID
              CLOSE     IFCFLTXT,DELETE          * Delete temp file
              MATCH     "0",TASKID
              GOTO      NEWCO910 IF NOT EQUAL    * CreateIFCXML script failed
.
              MOVE      PMHBEAID,OBPCEAID        * save eAdmission ID
.
.
.             Print NCF (Stationary Template) if required ...
              IF        CREATNCF=1
                MATCH     SP70,IFCNCFCO          * NCF Stationary Code blank ?
                GOTO      NEWCOR60 IF EQUAL
.
                PACK      STATNCOD,IFCNCFCO,SP70 * NCF Stationary Code
                PACK      SCHDPRNT,AT,SP70       * "@" printer selection
                MOVE      ONE,SCHDCOPY
                PACK      SUBSYSKY,SP70
                MOVE      SP70,LABELTYP
                MOVE      SP70,FREETXT1
                MOVE      SP70,FREETXT2
                MOVE      SP70,FREETXT3
                MOVE      SP70,FREETXT4
                MOVE      SP70,FREETXT5
                MOVE      SP70,FREETXT6
                MOVE      SP70,FREETXT7
.
.               The "EP" (EpiSoft Print) script will be executed (WEBPRTCD.PBL)
.               as a result of the "@" printer selection.
.               This script will take in the spool filename & IFC XML filename
.               as arguments and update the existing IFC XML file by adding the
.               contents of the spool file (Stationary Template print)
.               as Base64-encoded.
.
.               The XML filename for the "EP" script will be:
.                 "<HospitalCode>_<AdmissionNo>.xml"
.
                MOVE      ADMISSNO,DIM8
                SQUEEZE   DIM8
.
                CLEAR     KEY30
                APPEND    IFCXHOSP,KEY30
                APPEND    "_",KEY30
                APPEND    DIM8,KEY30
                APPEND    ".xml",KEY30
                RESET     KEY30
.
                CALL      ADDPRN00          * Add print job
              ENDIF
            ENDIF 
.
          ENDIF
.
NEWCOR60  MOVE      CORSP002,OBPCINDT       * Input date 
          REP       " 0",OBPCINDT
          MOVE      CORSP004,OBPCINTM       * Input time 
          MOVE      CORSP003,OBPCCTYP       * Type of Correspondence
          MOVE      CORSP006,OBPCSLEV       * Security Level
          MOVE      CORSP007,OBPCCOM1       * Comment 1
          MOVE      CORSP008,OBPCCOM2       * Comment 2
          MOVE      CORSP009,OBPCCFRM       * From 
          MOVE      CORSP010,OBPCCTOO       * To
          MATCH     SP70,OBPCCTOO
          IF        @EQUAL
            MATCH     Z70,RECIPNAM
            IF        !@EQUAL
              MATCH     SP70,RECIPNAM
              IF        !@EQUAL
                PACK      OBPCCTOO,RECIPNAM,AT,FAXNUMBR,SP70
              ENDIF
            ENDIF
          ENDIF
          MOVE      CORSP011,OBPCUDF1       * User Def Code 1
          MOVE      CORSP012,OBPCUDF2       * User Def Code 2
          MOVE      CORSP013,OBPCUYN1       * User Def Y/N 1
          MOVE      CORSP014,OBPCUYN2       * User Def Y/N 2
          MOVE      CORSP015,OBPCUDD1       * User Def Date 1
          MOVE      CORSP016,OBPCUDD2       * User Def Date 2
          MOVE      CORSP017,OBPCACAT  *   Alert Category
          MOVE      CORSP018,OBPCACOD  *   Alert Code          
          MOVE      CORSP019,OBPCCNTR  *   Alert Counter       
.
          MOVE      SAVISIT,OBPCCVIS
NEWCOR80  PACK      KEY12,OBPCCVIS,OBPCCPID
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROBPC1
          TRAPCLR   IO
          IF        OVRCD=1
            ADD       ONE,CORRESID
            MOVE      CORRESID,OBPCCPID     * Correspondence ID
            GOTO      NEWCOR80
          ENDIF
.
          PACK      DETAILK1,OBPCURNO,OBPCCVIS,OBPCCPID,SP70 
.
          MOVE      ANSA,OBAUTYPE           * Add
          CALL      OBSAUD00                * Clinical Documents Audit
.
          CALL      PRTA0000                * Print Document
          BRANCH    EXIT,NEWCOR99
.
          CALL      SENDD000                * Send Document
.
          COMPARE   "0",SENDTYPE            * Send Type Not Sent
          GOTO      NEWCOR81 IF NOT EQUAL
.
          MATCH     "1",SENDFAXB            * Send Fax
          IF        !@EQUAL
            MATCH     "1",ELECSENT          * Send Electronically
            GOTO      NEWCOR82 IF NOT EQUAL
          ENDIF
.
NEWCOR81  MOVE      ANSS,OBAUTYPE         * Sent
          CALL      OBSAUD00              * Clinical Documents Audit
.
NEWCOR82  CALL      WDSA0000                * Write discharge summary audit
          BRANCH    EXIT,NEWCOR99
.
          MOVE      ZERO,EXIT               * To go to next page
.
          MATCH     SP70,COPYFKEY
          IF        !@EQUAL
            MATCH     "1",KPCRDRFT
            IF        @EQUAL
              MATCH     "1",DRAFTDOC
              IF        @EQUAL
                CALL      UPDRFT00            * Update Previous Versions to
.                                             * Draft Documents
              ENDIF
            ELSE
              CALL      UPDRFT00            * Update Previous Versions to
.                                           * Draft Documents
            ENDIF
          ENDIF
.
          PACK      KEY8,URNUMBER           * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
          MATCH     "1",PTMXSIN4
          IF        !@EQUAL
            PACK      KEY8,URNUMBER         * validate UR
            CALL      RLPTMAS1
            BRANCH    OVRCD,NEWCOR90,NEWCOR96
            MOVE      "1",PTMXSIN4
            CALL      UPMAST1
            CALL      UUPTMAS1
          ENDIF
          GOTO      NEWCOR99
.
NEWCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR92  CLEAR     WEBTITLE
          APPEND    "Error: File upload failed (cliweb08.us1 script)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR93  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR94  MOVE      "Invalid File - ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR95  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No for UR - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR96  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR97  CLEAR     WEBTITLE
          APPEND    "Error: File upload failed (filesystem move)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR98  CLEAR     WEBTITLE
          APPEND    "Error: File upload failed (ConvertHTML2PDF script)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCO910  CLEAR     WEBTITLE
          APPEND    "Error: IFC XML file creation failed (CreateIFCXML script)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR99  RETURN
.--------------------------------------------------------------------------------
. Update Previous Versions to Draft Documents
. --------------------------------------------------------------------------------
UPDRFT00  PACK      KEY20,COPYFKEY
          CALL      RDOBPC1
          BRANCH    OVRCD,UPDRFT90
.
          MOVE      "2",OBPCMDEL            * Set as Draft
.
          CALL      UPOBPC1
.
          MOVE      ANSU,OBAUTYPE           * Update
          CALL      OBSAUD00                * Clinical Documents Audit
.
UPDRFT90  RETURN
.------------------------------------------------------------
. Write Discharge Summary audit
.------------------------------------------------------------
WDSA0000  MOVE      ZERO,EXIT
.
          MATCH     "1",NIHCDOIN
          GOTO      WDSA1000 IF EQUAL
.
          MATCH     "1",SENDFAXB             * sending fax?
.         GOTO      WDSA9999 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",ELECSENT
            GOTO      WDSA9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,CATWI,OBPCCTYP,SP70 * ignore if not a discharge summary
          CALL      RDCODE1
          BRANCH    OVRCD,WDSA9999
.
          MATCH     ANSD,TCINDC1
          GOTO      WDSA9999 IF NOT EQUAL
.
WDSA1000  PACK      PMDDVISN,OBPCCVIS,SP70
          PACK      PMDDCPID,OBPCCPID,SP70
          CALL      IBACLOCK
          PACK      PMDDDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",PMDDDATE
          PACK      PMDDTIME,CTIMEIS
          PACK      PMDDDEST,RECIPNAM,SP70
          PACK      PMDDFAXN,FAXNUMBR,SP70
          PACK      PMDDFAXS,SENDFAXB,SP70
.
          PACK      PMDDHCPC,RECIPIEN,SP70
.
          MATCH     "1",NIHCDOIN
          IF        @EQUAL
            PACK      PMDDHCPC,OBPCCOM2,SP70
          ENDIF
.
          PACK      PMDDHCPP,PRACTICE,SP70
          PACK      PMDDHCPT,PRACCNTR,SP70
          PACK      PMDDESNT,ELECSENT,SP70
          PACK      PMDDCUID,USERID,SP70
          PACK      PMDDSPAR,SP70
.
          PACK      KEY28,PMDDVISN,PMDDCPID,PMDDDATE,PMDDTIME,SP70
          CALL      RAPMDSD1
          IF        OVRCD=1
            CALL      WRPMDSD1
          ENDIF
.
          MATCH     "1",NIHCDOIN
          GOTO      WDSA2000 IF EQUAL
.
          MATCH     "1",SENDFAXB             * sending fax?
.         GOTO      WDSA9999 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",ELECSENT
            GOTO      WDSA9999 IF NOT EQUAL
          ENDIF
.
.****** call fax script here *****
          PACK      KEY4,OBPCSLID,SP70
          CALL      RDOBPT1
          BRANCH    OVRCD,WDSA9000
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
.
          STRIP     OBPTSDIR
          STRIP     PMDDDEST
          STRIP     PMDDFAXN
          PACK      CMDLINE,SENDSUMM,SP1,OBPTSDIR,CORSFILE,SP1,PMDDDEST,AMBERSND,PMDDFAXN,SP70
          EXECUTE   CMDLINE,TASKID
.
WDSA2000  MOVE      ZERO,EXIT
          GOTO      WDSA9999
.
WDSA9000  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location - ",WEBTITLE
          APPEND    OBPCSLID,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      WDSA9999
.
WDSA9999 RETURN
+
.------------------------------------------------------------
. Send Document
.------------------------------------------------------------
SENDD000  COMPARE   "0",SENDTYPE             * Send Type Not Sent
          GOTO      SENDD999 IF EQUAL
          COMPARE   "4",SENDTYPE             * Send Type for HL7 RF1 Messaging
          GOTO      SENDD900 IF EQUAL
          PACK      PMDDVISN,OBPCCVIS,SP70
          PACK      PMDDCPID,OBPCCPID,SP70
.
          PACK      KEY4,OBPCSLID,SP70
          CALL      RDOBPT1
          BRANCH    OVRCD,PRTA9000
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
.
          CALL      CHKSND00
.
          STRIP     OBPTSDIR
          STRIP     SENDTOPH
          SQUEEZE   SENDTOPH
          STRIP     SENDTOEM
          STRIP     SENDFREM
          PACK      SYSCMDLN,SENDTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SENDTYPE,SP1:
                             SENDTOPH,SP1,SENDTOEM,SP1,SENDFREM
          EXECUTE   SYSCMDLN,TASKID
.
. Perform Send Copy To based on Available Email Addresses in Array copytoem
.
          MOVE      "null",SENDTOPH      * clear Fax Number parameter
          MOVE      ZERO,F1
SENDD200  COMPARE   COPYTOCT,F1
          GOTO      SENDD299 IF EQUAL
          ADD       ONE,F1
.
          MATCH     SP70,COPYTOEM[F1]
          GOTO      SENDD200 IF EQUAL
.
          STRIP     COPYTOEM[F1]
          SQUEEZE   COPYTOEM[F1]
.
          PACK      SYSCMDLN,SENDTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SENDTYPE,SP1:
                             SENDTOPH,SP1,COPYTOEM[F1],SP1,SENDFREM
          EXECUTE   SYSCMDLN,TASKID
          GOTO      SENDD200
.
. Send Copy To based on Available HCPs in Array hcpcopyt
. Uses Home Email Address (NZ Healthlink Address)
.
SENDD299  MOVE      ZERO,F1
SENDD300  COMPARE   HCPCOPCT,F1
          GOTO      SENDD399 IF EQUAL
          ADD       ONE,F1
.
          MATCH     SP70,HCPCOPYC[F1]
          GOTO      SENDD300 IF EQUAL
.
          MOVE      HCPCOPYC[F1],KEY10
          CALL      RDPMHCP1
          BRANCH    OVRCD,SENDD300
.
          MATCH     SP70,PMHCHEML
          IF        @EQUAL
            MOVE      KEY10,PMHCHEML
          ENDIF
          STRIP     PMHCHEML
          PACK      SYSCMDLN,SENDTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SENDTYPE,SP1:
                             SENDTOPH,SP1,PMHCHEML,SP1,SENDFREM
          EXECUTE   SYSCMDLN,TASKID
          GOTO      SENDD300
.
. Perform Send Copy To based on Available Ph Numbers in Array copytoph
.
SENDD399  MOVE      ZERO,F1
SENDD400  COMPARE   COPYPHCT,F1
          GOTO      SENDD499 IF EQUAL
          ADD       ONE,F1
.
          MATCH     SP70,COPYTOPH[F1]
          GOTO      SENDD400 IF EQUAL
.
          STRIP     COPYTOPH[F1]
          SQUEEZE   COPYTOPH[F1]
.
          PACK      SYSCMDLN,SENDTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SENDTYPE,SP1:
                             SENDTOPH,SP1,COPYTOPH[F1],SP1,SENDFREM
          EXECUTE   SYSCMDLN,TASKID
          GOTO      SENDD400
.
SENDD499  MOVE      ZERO,F1
SENDD500  COMPARE   CPYFXCT3,F1
          GOTO      SENDD999 IF EQUAL
          ADD       ONE,F1
.
          MATCH     SP70,COPYTOP3[F1]
          GOTO      SENDD500 IF EQUAL
.
          STRIP     COPYTOP3[F1]
          SQUEEZE   COPYTOP3[F1]
.
          PACK      SYSCMDLN,SENDTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SENDTYPE,SP1:
                             SENDTOPH,SP1,COPYTOP3[F1],SP1,SENDFREM
          EXECUTE   SYSCMDLN,TASKID
          GOTO      SENDD500
.
SENDD900  CALL      GETFN000
          BRANCH    OVRCD,SENDD999  * Document Loaction Read Fail - Should
                                    * never happen
.
          CALL      HL7RF000        * Write HL7 REF-I12 Message File
.
SENDD999  RETURN
.-----------------------------------------------------------------
.  Return Document Name including Physical Path as CORSFILE
.-----------------------------------------------------------------
GETFN000  PACK      KEY4,OBPCSLID,SP70
          CALL      RDOBPT1        * Get Document Location
          BRANCH    OVRCD,GENFN999
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
GENFN999  RETURN
.-------------------------------------------------------------
. Check Send Parameters
.-------------------------------------------------------------
CHKSND00  MATCH     SP70,SENDTOPH
          IF        @EQUAL
            MOVE      "null",SENDTOPH
          ENDIF
.
          MATCH     SP70,HCPSENDC
          IF        !@EQUAL
            MOVE      HCPSENDC,SENDTOEM   * If blank use code
            MOVE      HCPSENDC,KEY10
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCHEML
              IF        !@EQUAL
                MOVE      PMHCHEML,SENDTOEM
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,HCPFROMC
          IF        !@EQUAL
            MOVE      HCPFROMC,SENDFREM   * If blank use code
            MOVE      HCPFROMC,KEY10
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCHEML
              IF        !@EQUAL
                MOVE      PMHCHEML,SENDFREM
              ENDIF
            ENDIF
          ENDIF

          MATCH     SP70,SENDTOEM
          IF        @EQUAL
            MOVE      "null",SENDTOEM
          ENDIF
.
          MATCH     SP70,SENDFREM
          IF        @EQUAL
            MOVE      WBSEEMAI,SENDFREM
            MATCH     SP70,SENDFREM
            IF        @EQUAL
              MOVE      "null",SENDFREM
            ENDIF
          ENDIF
          RETURN
.
.------------------------------------------------------------
. Print Document
.------------------------------------------------------------
PRTA0000  MOVE      ZERO,EXIT
.
          COMPARE   "0",NOCOPIES             * Number of Copies
          GOTO      PRTA9999 IF EQUAL
.
          MATCH     SP70,SELPRINT            * Ignore if Printer Blank
          GOTO      PRTA9999 IF EQUAL
          GOTO      PRTA9999 IF EOS
.
          MATCH     "S  ",SELPRINT           * Ignore if Spool Selected
          GOTO      PRTA9500 IF EQUAL
.
          PACK      PMDDVISN,OBPCCVIS,SP70
          PACK      PMDDCPID,OBPCCPID,SP70
.
          PACK      KEY4,OBPCSLID,SP70
          CALL      RDOBPT1
          BRANCH    OVRCD,PRTA9000
.
          STRIP     OBPCFEXT
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          REP       " 0",CORSFILE
.
          STRIP     OBPTSDIR
          STRIP     PMDDDEST
          STRIP     PMDDFAXN
          PACK      CMDLINE,PRINTEXE,SP1,OBPTSDIR,CORSFILE,SP1,SELPRINT,SP1,NOCOPIES,SP70
          EXECUTE   CMDLINE,TASKID
          GOTO      PRTA9500
.
PRTA9000  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location - ",WEBTITLE
          APPEND    OBPCSLID,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      PRTA9999
.
PRTA9500  CALL      UPDEFP00                * Update Default Printer
          MOVE      ZERO,EXIT
.
PRTA9999  RETURN
+
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  MATCH     SP70,SETDFPRG
          GOTO      UPDEFP99 IF EQUAL
.
          OPEN      IBAPDFA1,"ibapdfaf"
          PACK      KEY20,SETDFPRG,SETDFRPT,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          CALL      RDIBPD1
          IF        OVRCD=0
            MOVE      SELPRINT,IBPDPRT        * printer
            MOVE      NOCOPIES,IBPDCOP        * no of copies
            CALL      UPIBPD1
          ELSE
            MOVE      SELPRINT,IBPDPRT        * printer
            MOVE      NOCOPIES,IBPDCOP        * no of copies
            MOVE      SP70,IBPDDOC
            MOVE      SP70,IBPDNUM
            MOVE      SP70,IBPDSPA
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
+
.------------------------------------------------------------
. Clinical Documents Audit: Add, Update, View and Delete
. Input - OBAUTYPE (A,U,V,D,S)
.------------------------------------------------------------
OBSAUD00  MOVE      OBPCURNO,OBAUURNO
          MOVE      OBPCCVIS,OBAUVISN
          MOVE      OBPCCPID,OBAUCORR
          CALL      IBACLOCK
          PACK      OBAUDATE,CCC,CYY,CMM,CDD
          REP       " 0",OBAUDATE
          PACK      OBAUTIME,CTIMEIS 
          MOVE      USERID,OBAUWEBU
          MOVE      SP70,OBAUREAS
          PACK      OBAUSPAR,SP70 
.
          MATCH     ANSU,OBAUTYPE
          IF        @EQUAL
            MOVE      OBPCUDF1,OBAUREAS
          ENDIF
.
          PACK      KEY47,OBAUURNO,OBAUVISN,OBAUCORR,OBAUDATE:
                          OBAUTIME,OBAUWEBU,OBAUTYPE,SP70
          CALL      RAOBAUD1
          IF        OVRCD=1
            CALL      WROBAUD1
          ENDIF
.
OBSAUD99  RETURN
+
.------------------------------------------------------------
. Table Clinical Documents Audit
.------------------------------------------------------------
TABCDA00  PACK      KEY47,OBPCURNO,OBPCCVIS,OBPCCPID,Z70
          CALL      RSOBAUD1
TABCDA10  CALL      RPOBAUD1
          BRANCH    OVRCD,TABCDA99
.
          MATCH     OBPCURNO,OBAUURNO
          GOTO      TABCDA99 IF NOT EQUAL
.
          MATCH     OBPCCVIS,OBAUVISN
          GOTO      TABCDA99 IF NOT EQUAL
.
          MATCH     OBPCCPID,OBAUCORR
          GOTO      TABCDA99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr>";
.
          MATCH     ANSA,OBAUTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Added</td>";
            GOTO      TABCDA50
          ENDIF
.
          MATCH     ANSU,OBAUTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Updated</td>";
            GOTO      TABCDA50
          ENDIF
.
          MATCH     ANSV,OBAUTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Viewed</td>";
            GOTO      TABCDA50
          ENDIF
.
          MATCH     ANSD,OBAUTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Deleted</td>";
            GOTO      TABCDA50
          ENDIF
.
          MATCH     ANSS,OBAUTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Sent</td>";
            GOTO      TABCDA50
          ENDIF
.
TABCDA50  PACK      KEY10,OBAUWEBU,SP70          * Last Web User ID
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",WBSENAM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",OBAUWEBU,"</td>";
          ENDIF
.
          UNPACK    OBAUDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DATELACC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<td>",DATELACC," at ",OBAUTIME,"</td>";
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      TABCDA10
.
TABCDA99  RETURN
+
.-------------------------------------------------------------------------------
.  Table Clinical Documents Audit 
.-------------------------------------------------------------------------------
AUDLST00  UNPACK    DIM127,DIM1,LINKPRG,DIM127
          UNPACK    DIM127,DIM1,LINKREP,DIM127
          UNPACK    DIM127,DIM1,LINKTEM,DIM127
.
          PACK      KEY47,FRSTDATE,SP70
          CALL      RSOBAUD2
AUDLST10  CALL      RKOBAUD2
          BRANCH    OVRCD,AUDLST99
          MATCH     OBAUDATE,LASTDATE
          GOTO      AUDLST99 IF LESS
.
          MATCH     SP70,FILTDCTY
          IF        !@EQUAL
            PACK      KEY20,OBAUURNO,OBAUVISN,OBAUCORR,SP70
            CALL      RDOBPC1 
            BRANCH    OVRCD,AUDLST10
.
            MATCH     FILTDCTY,OBPCCTYP
            GOTO      AUDLST10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTUSER
          IF        !@EQUAL
            MATCH     FILTUSER,OBAUWEBU
            GOTO      AUDLST10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTAUTY
          IF        !@EQUAL
            MATCH     FILTAUTY,OBAUTYPE
            GOTO      AUDLST10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,FILTAUDS
          MATCH     ANSA,OBAUTYPE
          IF        @EQUAL
            MOVE      "Add",FILTAUDS
            PACK      FILTAUDS,FILTAUDS,SP70
            GOTO      AUDLST20
          ENDIF
.
          MOVE      SP70,FILTAUDS
          MATCH     ANSS,OBAUTYPE
          IF        @EQUAL
            MOVE      "Sent",FILTAUDS
            PACK      FILTAUDS,FILTAUDS,SP70
            GOTO      AUDLST20
          ENDIF
.
          MATCH     ANSU,OBAUTYPE
          IF        @EQUAL
            MOVE      "Update - ",FILTAUDS
            MOVE      "wo",CATEGORY 
            MOVE      OBAUREAS,CODE
            CALL      GETCOD00            
            PACK      FILTAUDS,FILTAUDS,TDESC,SP70
            GOTO      AUDLST20
          ENDIF
.
          MATCH     ANSD,OBAUTYPE
          IF        @EQUAL
            MOVE      "Delete",FILTAUDS
            PACK      FILTAUDS,FILTAUDS,SP70
            GOTO      AUDLST20
          ENDIF
.
          MATCH     ANSV,OBAUTYPE
          IF        @EQUAL
            MOVE      "View",FILTAUDS
            PACK      FILTAUDS,FILTAUDS,SP70
            GOTO      AUDLST20
          ENDIF
.
AUDLST20  MOVE      SP70,FILTDCDS
          PACK      KEY20,OBAUURNO,OBAUVISN,OBAUCORR,SP70
          CALL      RDOBPC1
          IF        OVRCD=0
            MOVE      "wi",CATEGORY
            MOVE      OBPCCTYP,CODE
            CALL      GETCOD00
            PACK      FILTDCDS,TDESC,SP70 
          ENDIF
.
          MOVE      SP70,FILTWEBU
          MATCH     SP70,OBAUWEBU
          IF        !@EQUAL
            PACK      KEY10,OBAUWEBU,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,FILTWEBU
            ENDIF
          ENDIF
.
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO 
          MOVE      SP70,FORMATNM
          MOVE      SP70,FOLDERSF
          PACK      KEY8,OBAUURNO,SP70       
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      RDPMPX21
            UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            CALL      CALCAGE
            PACK      ADMISSNO,OBAUVISN,SP70
            PACK      URNUMBER,OBAUURNO,SP70
            CALL      PATLN000
            CALL      PATFLD00                * Use standard Patient Folder sub
            MOVE      KEY3,FOLDERSF           * and store suffix
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          MOVE      OBAUVISN,DIM8
          MATCH     "00000000",DIM8
          IF        @EQUAL
            MOVE      SP70,DIM8
          ENDIF
          APPEND    DIM8,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CALL      AUDROW00
.
          GOTO      AUDLST10
.
AUDLST99  RETURN
+
.-------------------------------------------------------------------------------
.  Table Clinical Documents Audit Row
.-------------------------------------------------------------------------------
AUDROW00  WRITE     HTMLFILE;"t.addRow(#"",OBAUDATE,OBAUTIME,"#",":
                             "#"",FILTAUDS,"#",":
                             "#"",FILTDCDS,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",FOLDERSF,"#",":
                             "#"",DIM8,"#",":
                             "#"",FILTWEBU,"#",":
                             "#"",PATLINK,"#")"

.
AUDROW99  RETURN
+
.-------------------------------------------------------------------------------
.  User ID Selection List
.-------------------------------------------------------------------------------
AUDUSR00  PACK      KEY10,SP70
          CALL      RSWBSE1
AUDUSR10  CALL      RKWBSE1
          BRANCH    OVRCD,AUDUSR99
.
          MATCH     "1",WBSEACT
          GOTO      AUDUSR10 IF NOT EQUAL
.
          MATCH     SP70,FILTUSER
          IF        !@EQUAL
            MATCH     FILTUSER,WBSEUID
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",WBSEUID,"#" selected>":
                                 WBSENAM,"</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",WBSEUID,"#">":
                                 WBSENAM,"</option>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<option value=#"",WBSEUID,"#">":
                               WBSENAM,"</option>"  
          ENDIF
.
          GOTO      AUDUSR10
.
AUDUSR99  RETURN
+
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OUTFIL10
          MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDIAG1
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
OPNOUT99  RETURN
+
.---------------------------------------------------------------------
. Write COMWEB70 trigger to update visit extension file Adm paperwork,
. consent form and medical history received to patient correspondence
.---------------------------------------------------------------------
TVIS0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,TVIS1000
.
          MOVE      IBPLUNIQ,FORM10
TVIS1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      "016",IBPLTYPE     * Pooling Type
          MOVE      OBPCURNO,IBPLURNO
          MOVE      OBPCCVIS,IBPLVISN
          PACK      IBPLSKEY,SP70
          MOVE      SP70,IBPLPSCD
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,TVIS1000
          ELSE
            GOTO      TVIS1000
          ENDIF
.
TVIS9999  RETURN
+
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Recorder
.------------------------------------------------------------------------------
RESPRA00  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            MOVE      SP70,DIM20
            MOVE      "w0",CATEGORY
            PACK      KEY5,CATEGORY,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          MATCH     SP70,WBSEDOC
          IF        !@EQUAL
            PACK      KEY10,WBSEDOC,SP70
          ELSE
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      KEY10,WBSEGPCD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            MOVE      SP70,TDESC
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCSPC1
              IF        !@EQUAL
                MOVE      "DT",KEY2
                PACK      KEY5,KEY2,PMHCSPC1,SP70
                CALL      RDCODE1
                IF        OVRCD=1
                  MOVE      SP70,TDESC
                ENDIF
              ENDIF
            ENDIF
            STRIP     KEY10
          ENDIF
.
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"User-",OBPCINUS,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-role#"":
                        " ,#"valueString#":#"",DIM20,"#"}";
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{ #"url#": #"%BASEURL/extension/dxc-hc-hcp#"":
                                "  ,#"valueReference#" : #"Practitioner/HCP-",KEY10,"#"}";
          ENDIF
.
          MATCH     SP70,TDESC
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{#"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                                  ",#"valueString#" : #"",TDESC,"#"}";
          ENDIF
.
          WRITE     HTMLFILE;" ],":
                    " #"identifier#": {":
                    "   #"use#": #"official#",":
                    "   #"system#": #"%BASEURL#",":
                    "   #"value#": #"",WBSELOGN,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": [":
                    "{ #"use#": #"usual#",":
                    "  #"text#": #"",WBSENAM,"#",":
                    "  #"family#": #".#",":
                    "  #"given#": [#"",WBSENAM,"#"] ":
                    "} ]";
.
          MATCH     SP70,WBSEEMAI
          IF        !@EQUAL
             WRITE     HTMLFILE;*+,",";
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"email#",":
                       "  #"value#": #"",WBSEEMAI,"#" } ]";
          ENDIF
.
          WRITE     HTMLFILE;*+,"  } ";
.
RESPRA99  RETURN
+
FHRVIS00  PACK      KEY8,PVIBILL,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,FHRVIS90
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            COMPARE   FIVE,ASTAT
            GOTO      FHRVIS90 IF EQUAL
          ELSE
            MATCH     "2",NOCANVIS
            IF        @EQUAL
              COMPARE   FIVE,ASTAT
              GOTO      FHRVIS90 IF EQUAL
            ENDIF
          ENDIF
.
          MOVE      PMVXMHOS,VISTHOSP
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            MATCH     "1",PMVXINGP
            IF        !@EQUAL
              GOTO      FHRVIS90
            ENDIF
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",SHOWPPRV
            IF       @EQUAL
              IF       SHOWALLH=1
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,FHRVIS90
                ENDIF
              ELSE
                PACK     KEY10,USERID,SP70        * Re read logged in user to
                CALL     RDWBSE1                  * get hospital
                BRANCH   OVRCD,FHRVIS90
.
                MATCH    WBSEHOSP,PMVXMHOS        * Only show visits for logged
                GOTO     FHRVIS90 IF NOT EQUAL    * in hospital if pre adm from
              ENDIF
            ENDIF                               * prev details screen
          ENDIF
.
          ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
          IF        VISTFLAG<>0
            COMPARE   VISTFLAG,PVITYPE      * Match For Visit Type
            GOTO      FHRVIS90 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS        * flag to generate a phantom patchcof
          MOVE      ZERO,GENITNOW        * don't generate a patchcof yet
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
          MOVE      " 0",KEY2
          PACK      CHCDATA,PVIBILL,ADATE,ATIME,KEY2,ACARE,SP30
.
          PACK      DISPCLSS,SP70
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      DIM1,SP20
            PACK      DISPCLSS,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,FHRVIS90
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVI100             * Get Visit Details
          BRANCH    EXIT,FHRVIS90
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,FHRVIS30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      FHRVIS10 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      KEY6,PMEVPWRD,PMEVPBED
            CALL      FWBD0000
            PACK      VISTLOC,WARDBED,SP70
            IF        IBCNMHOS=1
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      FHRVIS30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      FHRVIS30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS
          ENDIF
.
FHRVIS10  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
          MATCH     SP70,PMEVCTYP
          GOTO      FHRVIS30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,FHRVIS30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
FHRVIS30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,FHRVIS90        * don't display
.
          CALL      MRTDES00             * Medical Record Location Details
.
.
          PACK      ADMISSNO,PVIBILL,SP70
          CALL      GFRSTA00 *  Encounter Status
          CALL      GFRCLS00 *  Encounter Class
          CALL      GFRSDT00 *  Encounter Start Date
          CALL      GFREDT00 *  Encounter End Date
          CALL      GFRLOC00 *  Encounter Location
          CALL      GFRREA00 *  Encounter Reason
          CALL      GFRDOC00 *  Encounter Doctor
.
          PACK      FHRPATID,URNUMBER,SP70
          PACK      FHRENCID,URNUMBER,ADMISSNO,SP70
          REP       " -",FHRENCID
          SQUEEZE   FHRPATID
          MOVE      PATFNAME,FHRPATN
          MOVE      ZERO,OVRCD
          GOTO      FHRVIS99
FHRVIS90  MOVE      ONE,OVRCD
FHRVIS99  RETURN
+
.******************************************************************************
MVPMAR00  PACK      PMVXVISN,ARVXVISN,SP70
          PACK      PMVXVSDT,ARVXVSDT,SP70
          PACK      PMVXDOCA,ARVXDOCA,SP70
          PACK      PMVXDOCT,ARVXDOCT,SP70
          PACK      PMVXCSNR,ARVXCSNR,SP70
          PACK      PMVXPOST,ARVXPOST,SP70
          PACK      PMVXPIND,ARVXPIND,SP70
          PACK      PMVXVLOC,ARVXVLOC,SP70
          PACK      PMVXCFSG,ARVXCFSG,SP70
          PACK      PMVXINGP,ARVXINGP,SP70
          PACK      PMVXCPTH,ARVXCPTH,SP70
          PACK      PMVXHCP1,ARVXHCP1,SP70
          PACK      PMVXHCP2,ARVXHCP2,SP70
          PACK      PMVXHCP3,ARVXHCP3,SP70
          PACK      PMVXHCP4,ARVXHCP4,SP70
          PACK      PMVXRHC1,ARVXRHC1,SP70
          PACK      PMVXRH1G,ARVXRH1G,SP70
          PACK      PMVXRH1C,ARVXRH1G,SP70
          PACK      PMVXRHC2,ARVXRHC2,SP70
          PACK      PMVXRH2G,ARVXRH2G,SP70
          PACK      PMVXRH2C,ARVXRH2C,SP70
          PACK      PMVXRHC3,ARVXRHC2,SP70
          PACK      PMVXRH3G,ARVXRH3G,SP70
          PACK      PMVXRH3C,ARVXRH3C,SP70
          PACK      PMVXRHC4,ARVXRHC4,SP70
          PACK      PMVXRH4G,ARVXRH4G,SP70
          PACK      PMVXRH4C,ARVXRH4C,SP70
          PACK      PMVXABRG,ARVXABRG,SP70
          PACK      PMVXCADM,ARVXCADM,SP70
          PACK      PMVXIRAD,ARVXIRAD,SP70
          PACK      PMVXIDUS,ARVXIDUS,SP70
          PACK      PMVXCRAV,ARVXCRAV,SP70
          PACK      PMVXRCCT,ARVXRCCT,SP70
          PACK      PMVXAPWD,ARVXAPWD,SP70
          PACK      PMVXAPBD,ARVXAPBD,SP70
          PACK      PMVXPOWD,ARVXPOWD,SP70
          PACK      PMVXPOBD,ARVXPOBD,SP70
          PACK      PMVXPSTY,ARVXPSTY,SP70
          PACK      PMVXVALW,ARVXVALW,SP70
          PACK      PMVXPALW,ARVXPALW,SP70
          PACK      PMVXINDC,ARVXINDC,SP70
          PACK      PMVXMDAV,ARVXMDAV,SP70
          PACK      PMVXFRMS,ARVXFRMS,SP70
          PACK      PMVXCSNG,ARVXCSNG,SP70
          MOVE      PMVXPWGT,ARVXPWGT
          MOVE      PMVXPHGT,ARVXPHGT
          PACK      PMVXDHWR,ARVXDHWR,SP70
          PACK      PMVXEDC1,ARVXEDC1,SP70
          PACK      PMVXEDC2,ARVXEDC2,SP70
          PACK      PMVXEDC3,ARVXEDC3,SP70
          PACK      PMVXHOME,ARVXHOME,SP70
          PACK      PMVXUDF1,ARVXUDF1,SP70
          PACK      PMVXUDF2,ARVXUDF2,SP70
          PACK      PMVXUDF3,ARVXUDF3,SP70
          PACK      PMVXUDF4,ARVXUDF4,SP70
          PACK      PMVXUDT1,ARVXUDT1,SP70
          PACK      PMVXUDT2,ARVXUDT2,SP70
          PACK      PMVXUDT3,ARVXUDT3,SP70
          PACK      PMVXUDT4,ARVXUDT4,SP70
          PACK      PMVXUDT5,ARVXUDT5,SP70
          PACK      PMVXUDT6,ARVXUDT6,SP70
          PACK      PMVXCDTE,ARVXCDTE,SP70
          PACK      PMVXCTIM,ARVXCTIM,SP70
          PACK      PMVXWEBC,ARVXWEBC,SP70
          PACK      PMVXLUPD,ARVXLUPD,SP70
          PACK      PMVXLUPT,ARVXLUPT,SP70
          PACK      PMVXWEBU,ARVXWEBU,SP70
          PACK      PMVXMHLS,ARVXMHLS,SP70
          PACK      PMVXPICD,ARVXPICD,SP70
          PACK      PMVXRMOR,ARVXRMOR,SP70
          PACK      PMVXASUT,ARVXASUT,SP70
          PACK      PMVXELPS,ARVXELPS,SP70
          PACK      PMVXEMPL,ARVXEMPL,SP70
          PACK      PMVXFINP,ARVXFINP,SP70
          PACK      PMVXOCCP,ARVXOCCP,SP70
          PACK      PMVXPALC,ARVXPALC,SP70
          PACK      PMVXPPAL,ARVXPPAL,SP70
          PACK      PMVXPPPT,ARVXPPPT,SP70
          PACK      PMVXPSOS,ARVXPSOS,SP70
          PACK      PMVXPYSP,ARVXPYSP,SP70
          PACK      PMVXQLDB,ARVXQLDB,SP70
          PACK      PMVXREAD,ARVXREAD,SP70
          PACK      PMVXUDIN,ARVXUDIN,SP70
          PACK      PMVXUREA,ARVXUREA,SP70
          PACK      PMVXUSAC,ARVXUSAC,SP70
          PACK      PMVXUVTH,ARVXUVTH,SP70
          PACK      PMVXINTR,ARVXINTR,SP70
          PACK      PMVXLNG1,ARVXLNG1,SP70
          PACK      PMVXASGC,ARVXASGC,SP70
          PACK      PMVXMHOS,ARVXMHOS,SP70
          PACK      PMVXDSPD,ARVXDSPD,SP70
          PACK      PMVXDSIF,ARVXDSIF,SP70
          PACK      PMVXPRMI,ARVXPRMI,SP70
          PACK      PMVXPRAI,ARVXPRAI,SP70
          PACK      PMVXPRES,ARVXPRES,SP70
          PACK      PMVXUITR,ARVXUITR,SP70
          PACK      PMVXRPOA,ARVXRPOA,SP70
          PACK      PMVXRCN1,ARVXRCN1,SP70
          PACK      PMVXRCN2,ARVXRCN2,SP70
          PACK      PMVXRHFU,ARVXRHFU,SP70
          PACK      PMVXRDVA,ARVXRDVA,SP70
          PACK      PMVXRSLO,ARVXRSLO,SP70
          PACK      PMVXMLOC,ARVXMLOC,SP70
          PACK      PMVXPACC,ARVXPACC,SP70
          PACK      PMVXEDU1,ARVXEDU1,SP70
          PACK      PMVXEDU2,ARVXEDU2,SP70
          PACK      PMVXEDU3,ARVXEDU3,SP70
          PACK      PMVXPRGM,ARVXPRGM,SP70
          PACK      PMVXCONF,ARVXCONF,SP70
          PACK      PMVXEOCL,ARVXEOCL,SP70
          PACK      PMVXSLOC,ARVXSLOC,SP70
          PACK      PMVXSCLI,ARVXSCLI,SP70
          PACK      PMVXSTRA,ARVXSTRA,SP70
          PACK      PMVXQASN,ARVXQASN,SP70
          PACK      PMVXATCP,ARVXATCP,SP70
          PACK      PMVXATIM,ARVXATIM,SP70
          PACK      PMVXITIM,ARVXITIM,SP70
          PACK      PMVXHFGN,ARVXHFGN,SP70
          PACK      PMVXHFSN,ARVXHFSN,SP70
          PACK      PMVXFUPI,ARVXFUPI,SP70
          PACK      PMVXPOEC,ARVXPOEC,SP70
          PACK      PMVXSPAR,ARVXSPAR,SP70
.
          RETURN
+
.------------------------------------------------------------
. Get Medical Record Coding Details
.------------------------------------------------------------
MRTCOD00  MOVE      ZERO,CODESTAT
.
          MATCH     "00000000",PVIDATE    * Bad Debt? If so Ignore!
          GOTO      MRTCOD90 IF EQUAL
.
          COMPARE   ZERO,DISCFLAG
          GOTO      MRTCOD20 IF EQUAL     * Doing all visits
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MRTCOD90
.
          MOVE      "CC",CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPCART
.
          COMPARE   ONE,MRCNEPSC          * Using Episode Coding
          GOTO      MRTCOD10 IF NOT EQUAL
.
          COMPARE   THREE,DISCFLAG
          GOTO      MRTCOD10 IF NOT EQUAL   * not doing discharges
.
          COMPARE   TWO,ASTAT
          IF        !@EQUAL
            COMPARE   THREE,ASTAT           * Discharges and current adm with
            GOTO      MRTCOD90 IF NOT EQUAL * at least one episode
          ENDIF
.
MRTCOD05  CALL      GEPS0000                * Get episode dates
          BRANCH    EXIT,MRTCOD90
          GOTO      MRTCOD11
.
MRTCOD10  COMPARE   DISCFLAG,ASTAT          * Match For Admission Status
          GOTO      MRTCOD90 IF NOT EQUAL
.
          COMPARE   THREE,DISCFLAG
          GOTO      MRTCOD20 IF NOT EQUAL   * not doing discharges
.
MRTCOD11  MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,MRTCOD90
.
          MATCH     SP3,PMSVX044
          IF        !@EQUAL
            MATCH     PMSVX044,PMVXCSNG   * Match for coder snags
            GOTO      MRTCOD90 IF NOT EQUAL
          ENDIF
.
          MOVE      "VN",CATEGORY
          MOVE      PMVXCSNG,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCSNAG
.
          PACK      KEY13,PVIBILL,EPSCD001                            *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          IF        OVRCD=0
            MATCH     PVIBILL,PTEDADMN
            IF        !@EQUAL
              MOVE      SP70,PTEDOPER   * No coder id
              MOVE      SP70,PTEDUSID   * No coder web user id
            ENDIF
          ENDIF
.
.       Codedflg = 0 for All, 1 for incomplete coding, 2 for complete coding
.
MRTCOD15  IF        CODEDFLG=1
            IF        MRCNEPSC=1
              MATCH     SP8,CHCODCMP
              GOTO      MRTCOD05 IF NOT EQUAL   * Coding completed
            ELSE
              MATCH     SP8,ACODDTE
              GOTO      MRTCOD90 IF NOT EQUAL   * Coding completed
            ENDIF
          ENDIF
.
          IF        CODEDFLG=2
            IF        MRCNEPSC=1
              MATCH     SP8,CHCODCMP
              GOTO      MRTCOD05 IF EQUAL     * Coding not completed
            ELSE
              MATCH     SP8,ACODDTE
              GOTO      MRTCOD90 IF EQUAL     * Coding not completed
            ENDIF
          ENDIF
.
MRTCOD20  MOVE      ZERO,CODESTAT
          IF        MRCNEPSC=1
            MATCH     SP8,CHCODCMP
            IF        !@EQUAL
              MOVE      ONE,CODESTAT       * coded
            ENDIF
          ELSE
            MATCH     SP8,ACODDTE
            IF        !@EQUAL
              MOVE      ONE,CODESTAT       * coded
            ENDIF
          ENDIF
.
          MOVE      SP70,PRIDISCD        * I CAR 18122
          PACK      PDIADESC,SP70,SP70,SP70
          PACK      KEY13,PVIBILL,EPSCD001,SP70                       *C-240107
          CALL      RSPTECD1
MRTCOD30  CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD40                         * TSK 0837871
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD40 IF NOT EQUAL
.
          COMPARE   PTEDEPNO,EPSCD001
          GOTO      MRTCOD40 IF NOT EQUAL
.
          MATCH     PTEDTYPE,CMDISP
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT                                    *C-240107
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MOVE      PTEDCODE,PRIDISCD
.
          MOVE      PTEDDESC,PDIADESC    * end I CAR 18122
.
MRTCOD40  IF        PVITYPE<>2
            MOVE      SP70,VISADIAG
            MOVE      SP70,ADIADESC
          ENDIF
.
          PACK      KEY13,PVIBILL,EPSCD001,SP70                       *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD45
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD45 IF NOT EQUAL
.
          COMPARE   PTEDEPNO,EPSCD001
          GOTO      MRTCOD45 IF NOT EQUAL
.
          MOVE      PTEDCODE,VISADIAG
          MOVE      PTEDDESC,ADIADESC          * disease description
          GOTO      MRTCOD50
.
MRTCOD45  MOVE      SP70,PTEDOPER   * No coder id
          MOVE      SP70,PTEDUSID   * No coder web user id
.
MRTCOD50  MOVE      SP70,AUDITDTE
          PACK      KEY18,PVIBILL,Z70
          CALL      RSMRAUC2             * get last coding Audit Date
          CALL      RPMRAUC2
          BRANCH    OVRCD,MRTCOD80
.
          MOVE      PVIBILL,KEY8
          MATCH     KEY8,MRACVISN
          GOTO      MRTCOD80 IF NOT EQUAL
.
.         MOVE      EPSCD001,KEY2
.         MATCH     KEY2,MRACEPSN
.         GOTO      MRTCOD80 IF NOT EQUAL
.
          MOVE      MRACADTE,AUDITDTE
.
MRTCOD80  MOVE      ZERO,EXIT
          GOTO      MRTCOD99
.
MRTCOD90  MOVE      ONE,EXIT
.
MRTCOD99  RETURN
+
.------------------------------------------------------------------------
.  Format 'ward/bed'  line in field WARDBED according to the
.  PTCNWBDS parameter (code, long name,short name)
.------------------------------------------------------------------------
FWBD0000 MOVE      PTCNWBDS,F1  * ward bed name option none,long,short
         CLEAR     WARDBED
         UNPACK    KEY6,KEYWRD,KEYBED

         IF        F1 = 0
           GOTO      FWBD8000
         ENDIF
.
         PACK       KEY6,KEYWRD,SP70
         CALL       RDWARD1
         BRANCH     OVRCD,FWBD8000
.
         IF         F1 = 2
           APPEND     PTWDSDES,WARDBED
         ELSE
           APPEND     WBDESC,WARDBED
         ENDIF
.
         MATCH      SP3,KEYBED
         GOTO       FWBD9999 IF EQUAL
.
         APPEND     "/",WARDBED
         PACK       KEY6,KEYWRD,KEYBED
         CALL       RDWARD1
         IF         OVRCD = 1
           APPEND     KEYBED,WARDBED
           GOTO       FWBD9999
         ENDIF
.
         IF        F1 = 2
           APPEND     PTWDSDES,WARDBED
         ELSE
           APPEND     WBDESC,WARDBED
         ENDIF
         GOTO       FWBD9999
.
FWBD8000 APPEND     KEYWRD,WARDBED
         MATCH      SP3,KEY3
         IF         !@EQUAL
           APPEND     "/",WARDBED
           APPEND     KEYBED,WARDBED
         ENDIF
         GOTO       FWBD99999
.
FWBD9999 RESET    WARDBED
         RETURN
+
.------------------------------------------------------------------------
.  Format hospital text  HOSPTEXT According to the
.  PTCNWBDS parameter (code, long name,short name)
.------------------------------------------------------------------------
FHOS0000  PACK      HOSPTEXT,SP70
          CLEAR     HOSPTEXT
          MATCH     KEY3,SP3
          GOTO      FHOS9999 IF EQUAL
          IF        IBCNMHOS <> 1
                 GOTO      FHOS9999
          ENDIF
          MOVE      PTCNWBDS,F1  * name option none,long,short
          CALL      RDPTHSP1
          IF        OVRCD = 1 | F1 = 0
            APPEND    KEY3,HOSPTEXT         * Hospital code
.           APPEND    DASH,HOSPTEXT
          ELSE
            IF       F1 = 2
              STRIP    PTHSSNAM
              APPEND   PTHSSNAM,HOSPTEXT    * Hospital short name
            ELSE
              STRIP    PTHSNAME
              APPEND   PTHSNAME,HOSPTEXT    * Hospital long name
            ENDIF
          ENDIF
          RESET      HOSPTEXT
          STRIP      HOSPTEXT
FHOS9999  RETURN
+
.------------------------------------------------------------
. Get status for patient event record
.------------------------------------------------------------
GETSTA00  MATCH     SP70,PMEVDDTE
          GOTO      GETSTA99 IF EQUAL
.
          MOVE      PMEVDDTE,DDATE
          UNPACK    PMEVDDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,DISCDATE
          GOTO      GETSTA99 IF EQUAL
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP70,PMEVDSTT
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSD,PMEVDSTT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,KEY10
              APPEND    KEY10,VSTATUS
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    PMEVDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETSTA99  RETURN
.------------------------------------------------------------
.         Check for Allied Health
.------------------------------------------------------------
CKAL0000  MOVE      ZERO,EXIT
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSEDALL
          ENDIF
.
          MOVE      ZERO,EVNTFLAG
          COMPARE   "9",PVITYPE
          GOTO      CKAL9999 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      CKAL1000 IF NOT EQUAL
.
. Event Type Visit
.------------------
.          PACK      VISTTYPE,VISTEVNT,SP10  * Event
          PACK      VISTTYPE,PMEVEVNT,SP10  * Event
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,CKAL9999
          MOVE      TWO,SECOPT
          MOVE      PMEVATIM,VISTTIME
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,EVNTFLAG
          MATCH     "E",TCINDC1
          IF        @EQUAL
            MOVE      EMEVENT,VISTTYPE
            MOVE      "1",EVNTFLAG         * Emergency event
          ELSE
            MATCH     "O",TCINDC1
            IF        @EQUAL
              MOVE      "2",EVNTFLAG       * Outpatient event
            ELSE
              MATCH     "I",TCINDC1
              IF        @EQUAL
                MOVE      "3",EVNTFLAG     * Inpatient event
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      PMEVUNIT,UNITCODE
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      VISTTYPE,PMEVEVNT,SP70
.         MATCH     "I",TCINDC1
.         IF        @EQUAL
.           MOVE      IPEVENT,VISTTYPE
.         ENDIF
.
          MATCH     "O",TCINDC1
          IF        @EQUAL
.           MOVE      OPEVENT,VISTTYPE
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
....         MOVE      TDESC,UNITDESC      * Display clinic type for outpatients
            MOVE      PMEVCTYP,UNITCODE
            PACK      VISTLOC,PMEVPLOC,SP70
            COMPARE   ONE,IBCNMHOS
            IF        @EQUAL
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,PMEVPLOC,SP70
            ENDIF
          ENDIF
          MOVE      "CL",CATEGORY
          MOVE      PMEVCCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMEVACON
          GOTO      CKAL0500 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    PMEVACON,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
CKAL0500  MATCH     SP70,PMEVCLID
          GOTO      CKAL9999 IF EQUAL
.
          PACK      KEY20,PMEVSITE,PMEVCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CKAL9999
.
          MATCH     PMEVSITE,OCASITE
          GOTO      CKAL9999 IF NOT EQUAL
.
          MATCH     PMEVCLID,OCACLIN
          GOTO      CKAL9999 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      CKAL9999 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
          GOTO      CKAL9999
.
CKAL1000  MATCH    " 2",PVISYST
          GOTO     CKAL9999 IF NOT EQUAL
.
. Allied Heath Type Visit
.-------------------------
          PACK     VISTTYPE,VISTALLH,SP10      * Allied Health
          MOVE     PVIBILL,KEY8
          CALL     RDALREF1              *TO GET DEPT OF THE REFERRAL TABLE
          BRANCH   OVRCD,CKAL9999
.
          CALL     INDHCP00
.
          MATCH     SP70,FILTDEPT              * Department Filter
          IF        !@EQUAL
            MATCH     ALREDEPT,FILTDEPT
            GOTO      CKAL9000 IF NOT EQUAL
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK     KEY3,ALREDEPT,SP70
          CALL     RDALDEP1
          BRANCH   OVRCD,CKAL9000
          MOVE     ALDESECU,SECOPT
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,CKAL5000
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      CKAL5000 IF NOT EQUAL
.
          APPEND    "Linked",REFTDESC
          GOTO      CKAL5000
.
CKAL5000  MOVE     SP70,ALENLINK           * Used to display linked mr volume
.
          MATCH    "2",ALDESECU
          IF       @EQUAL
            MATCH    WBSEDALL,ALREDEPT     * Check department
            GOTO     CKAL9000 IF NOT EQUAL * don't display
            REP      "20",SECOPT
          ENDIF
.
          MOVE     ALLSTAT0,VSTATUS
          MOVE     ZERO,FORM1
          MOVE     ALRESTAT,FORM1
          LOAD     VSTATUS,FORM1,ALLSTAT1,ALLSTAT2,ALLSTAT3,ALLSTAT4:
                                 ALLSTAT5
.
          PACK     KEY16,PVIBILL,Z70
          CALL     RSALENC1
          CALL     RPALENC1
          IF       OVRCD=0
            MATCH    DPVIBILL,ALENVISN   * Same visit number ?
            IF       @EQUAL
              MATCH    SP8,ALENSDAT
              IF       !@EQUAL
                UNPACK   ALENSDAT,CCENT,CYEAR,CMON,CDAY
                CALL     PACDATE
                REP      " 0",CPCDATE
                ENDSET   VSTATUS
                APPEND   "(Last Enc.",VSTATUS
                APPEND   CPDATE,VSTATUS
                APPEND   ")",VSTATUS
                RESET    VSTATUS
              ENDIF
            ELSE
              MOVE     SP70,ALENLINK         * Used to display linked mr volume
            ENDIF
          ENDIF
.
          MOVE      ALREDEPT,UNITCODE            * To get department
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70          * To get service provider name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      "&nbsp;",DOCFNAME
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,SP70
          ENDIF
.
          GOTO      CKAL9999
.
CKAL9000  MOVE      ONE,EXIT
+
CKAL9999  RETURN
+
.------------------------------------------------------------
. Get Medical Record Details
.------------------------------------------------------------
MRTDES00  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
          COMPARE   NINE,PVITYPE                 * If Allied Health display
          GOTO      MRTDES40 IF NOT EQUAL.       * the medical record for the
.                                                * Allied health linked visit
          MATCH     " 2",PVISYST
          GOTO      MRTDES40 IF NOT EQUAL.
.
          MATCH     SP70,ALENLINK                * Any linked visit
          GOTO      MRTDES99 IF EQUAL
.
          PACK      KEY8,ALENLINK,SP70
          GOTO      MRTDES45
.
MRTDES40  PACK      KEY8,PVIBILL,SP70
MRTDES45  CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,MRTDES99
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,MRTDES99
.
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      MRTDES99
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
          GOTO      MRTDES99
.
MRTDES90  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
MRTDES99  RETURN
+
. Get FHIR Encounter Statis
.
GFRSTA00  BRANCH    PVITYPE,GFRSTA10,GFRSTA20,GFRSTA30
          MOVE      "other",FHRSTAT
          GOTO      GFRSTA99
GFRSTA10  CALL      EMSTA000
          GOTO      GFRSTA99
GFRSTA20  CALL      OPSTA000
          GOTO      GFRSTA99
GFRSTA30  CALL      INSTA000
          GOTO      GFRSTA99
GFRSTA99  RETURN
+
. Get FHIR Encounter Class
.
GFRCLS00  BRANCH    PVITYPE,GFRCLS10,GFRCLS20,GFRCLS30     * HCP Name
          MOVE      "other",FHRCLAS
          GOTO      GFRCLS99
GFRCLS10  MOVE      "emergency",FHRCLAS
          GOTO      GFRCLS99
GFRCLS20  MOVE      "ambulatory",FHRCLAS
          GOTO      GFRCLS99
GFRCLS30  MOVE      "inpatient",FHRCLAS
GFRCLS99  RETURN
+
. Get FHIR Encounter Start Date
.
GFRSDT00  PACK      FHRSTRDT,SP70
          IF        PVITYPE=1
            UNPACK     EMVIDATE,CCENT,CYEAR,CMON,CDAY
            UNPACK     EMVITIME,KEY5
            GOTO       GFRSDT90              * EMR
          ENDIF
.
          IF        PVITYPE=3
            UNPACK     ADATE,CCENT,CYEAR,CMON,CDAY
            UNPACK     ATIME,KEY5
            GOTO       GFRSDT90
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRSDT99
.
.
          IF        PVITYPE=2
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
            UNPACK    OBATIME,KEY5
.
            MATCH     SP70,OTBBCITM   * Check In Time Seen
            IF        !@EQUAL
              MOVE     OTBBCITM,KEY5
            ENDIF
.
            MATCH     SP70,OTBBASTM   * Time Seen
            IF        !@EQUAL
              MOVE     OTBBASTM,KEY5
            ENDIF
            GOTO      GFRSDT90
          ENDIF
          GOTO      GFRSDT99
.
GFRSDT90  MOVE      ":00",KEY3
          PACK      FHRSTRDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,KEY5,KEY3,TIMEZONE
          GOTO      GFRSDT99
GFRSDT99  RETURN
+
. Get FHIR Encounter End Date
.
GFREDT00  MOVE      SP70,FHRENDDT
          MOVE      SP70,KEY5
          IF        PVITYPE=1
            MATCH      SP70,EMVIDDAT
            GOTO       GFREDT99 IF EQUAL
            UNPACK     EMVIDDAT,CCENT,CYEAR,CMON,CDAY
            MOVE       EMVIDTIM,KEY5
            GOTO       GFREDT90              * EMR
          ENDIF
.
          IF        PVITYPE=3
            MATCH      SP70,DDATE
            IF         @EQUAL
              PACK       KEY8,PVIBILL,SP70
              CALL       RDPMWOR1
              BRANCH     OVRCD,GFREDT99
              MATCH      SP70,PMWOEDAT
              GOTO       GFREDT99 IF EQUAL
              UNPACK     PMWOEDAT,CCENT,CYEAR,CMON,CDAY
              MOVE       PMWOEDTM,KEY5
            ELSE
              UNPACK   DDATE,CCENT,CYEAR,CMON,CDAY
              MOVE     DTIME,KEY5
            ENDIF
            GOTO      GFREDT90
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFREDT99
.
          IF        PVITYPE=2
            MATCH     SP70,OTBBDPTM     * Time of Departure
            IF        !@EQUAL
              UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      OTBBDPTM,KEY5
              GOTO      GFREDT90
            ENDIF
          ENDIF
          GOTO      GFREDT99
.
GFREDT90  MOVE      ":00",KEY3
          MATCH     SP70,KEY5
          IF        @EQUAL
            PACK      FHRENDDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY
          ELSE
            PACK      FHRENDDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,KEY5,KEY3,TIMEZONE
          ENDIF
          GOTO      GFREDT99
.
GFREDT99  RETURN
+
. Get FHIR Encounter Location
.
GFRLOC00  MOVE      ONE,STRETURN
          MOVE      ONE,F1
          IF        PVITYPE=1
            CALL      EMRLOC00
            GOTO      GFRLOC99
          ENDIF
.
          IF        PVITYPE=3
            CALL      INPLOC00
            GOTO      GFRLOC99
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRLOC99
          IF        PVITYPE=2
            CALL      OUTLOC00
          ENDIF
          GOTO      GFRLOC99

GFRLOC99  RETURN
+
. Get FHIR Encounter Reason
.
GFRREA00  PACK      FHRREAS,SP70,SP70
          IF        PVITYPE=1
            STRIP     EMVICOM1
            STRIP     EMVICOM2
            PACK      FHRREAS,EMVICOM1,SP1,EMVICOM2
            GOTO      GFRREA99
          ENDIF
.
          IF        PVITYPE=3
            STRIP     ADIAG1
            STRIP     ADIAG2
            PACK      FHRREAS,ADIAG1,SP1,ADIAG2
            GOTO      GFRREA99
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRREA99
          IF        PVITYPE=2
            PACK      FHRREAS,OBACOMM
          ENDIF
          GOTO      GFRREA99

GFRREA99  RETURN
+
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
.
          MATCH     SP70,LSTDOCT
          IF        !@EQUAL
            MOVE      DOCFNAME,FHRDOCN1
            CLEAR     FHRDOCC1
            APPEND    "HCP-",FHRDOCC1
            APPEND    LSTDOCT,FHRDOCC1
            RESET     FHRDOCC1
            MOVE      "CON",FHRDOCT1 *  Doctor Type
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      GFRDOC99 IF NOT EQUAL
.
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
.
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
GFRDOC99  RETURN
+
.------------------------------------------------------------
. Get the episode start and end date/times append * if
. not same as admission/discharge date/time
.------------------------------------------------------------
GEPS0000  MATCH     SP70,SAVEPKEY
          IF        @EQUAL
            PACK      SAVEPKEY,PVIBILL,SP70
            MOVE      ADATE,EPISADAT
            MOVE      ATIME,EPISATIM
          ELSE
            UNPACK    SAVEPKEY,KEY8,EPISADAT,EPISATIM
          ENDIF
.
. Find this episose end date/time
.
          PACK      KEY24,SAVEPKEY,SP70
          CALL      RDCHCO1
          CALL      RDKCHCO1
          IF        OVRCD = 1 & GENCHCDS = 1
            MOVE      ONE,GENITNOW
            GOTO      GEPS1000
          ENDIF
          BRANCH    OVRCD,GEPS9000               * Check for care type changes
.                                                * to get episode number
          UNPACK    SAVEPKEY,KEY8
          MATCH     DCHADMN,KEY8                 * Correct admission number ?
          IF        !@EQUAL
            MOVE      ONE,GENITNOW
            BRANCH    GENCHCDS,GEPS1000
            GOTO      GEPS9000
          ENDIF
.
GEPS1000  IF        GENCHCDS = 1
            IF        GENITNOW <> 1
              PACK      CHCDATA,CHADMN,CHDATE,CHTIME,CHEPISNO,CHCODE,SP30
            ELSE
.                                           * build a dummy patchcof record
              UNPACK    CHCDATA,KEY8A,EPISADAT,EPISATIM,KEY2,KEY3
              MOVE      KEY8A,CHADMN
              MOVE      KEY8A,DCHADMN
              MOVE      DDATE,CHDATE
              MOVE      DTIME,CHTIME
              UNPACK    SP70,CHCRDATE,CHCRTIME,CHCRUSID
              UNPACK    SP70,CHUPDATE,CHUPTIME,CHUPUSID
              MOVE      "CC",CHCATG
              MOVE      ACARE,CHCODE
              MOVE      KEY2,F2
              ADD       ONE,F2
              MOVE      F2,CHEPISNO
.....         MOVE      ACODDTE,CHCODCMP
              MOVE      SP8,CHCODCMP
.                                           * get an Oper Date if code/s exists
              PACK      KEY13,DCHADMN,CHEPISNO,SP20
              CALL      RSPTECD1
GEPS1100      CALL      RKPTECD1
              BRANCH    OVRCD,GEPS1200
.
              MATCH     DCHADMN,DPTEDADM
              GOTO      GEPS1200 IF NOT EQUAL
.
              COMPARE   F2,PTEDEPNO
              GOTO      GEPS1100 IF NOT EQUAL
.
              MATCH     PTEDDTCD,CHCODCMP
              IF        @LESS
                MOVE      PTEDDTCD,CHCODCMP
              ENDIF
              GOTO      GEPS1100
.
GEPS1200      PACK      KEY13,DCHADMN,CHEPISNO,SP20
              CALL      RSPTECO1
GEPS1300      CALL      RKPTECO1
              BRANCH    OVRCD,GEPS1500
.
              MATCH     DCHADMN,DPTEOADM
              GOTO      GEPS1500 IF NOT EQUAL
.
              COMPARE   F2,PTEOEPNO
              GOTO      GEPS1300 IF NOT EQUAL
.
              MATCH     PTEODTCD,CHCODCMP
              IF        @LESS
                MOVE      PTEODTCD,CHCODCMP
              ENDIF
              GOTO      GEPS1300

GEPS1500      MOVE      ZERO,GENCHCDS
              MOVE      ZERO,GENITNOW
            ENDIF
          ENDIF
.
GEPS2000  MOVE      CHEPISNO,EPSCD001                  * Save current episode
          PACK      SAVEPKEY,CHADMN,CHDATE,CHTIME,SP70 * number and key
.
          MOVE      CHDATE,EPISDDAT              * Episode discharge date
          MOVE      CHTIME,EPISDTIM              * Episde discharge time
.
          MOVE      "CC",CATEGORY
          MOVE      CHCODE,CODE                  * Get care type description
          CALL      GETCOD00
          MOVE      TDESC,DISPCART
.
GEPS4000  MOVE      SP70,EPSADATT                * Episode start date & time
          UNPACK    EPISADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPSADATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ENDSET    EPSADATT
          APPEND    " at ",EPSADATT
          APPEND    EPISATIM,EPSADATT
.
          MATCH     ADATE,EPISADAT
          IF        @EQUAL
            MATCH    ATIME,EPISATIM
            IF       @EQUAL
              RESET    EPSADATT
              GOTO     GEPS5000
            ENDIF
          ENDIF
.
          APPEND    " *",EPSADATT
          RESET     EPSADATT
.
GEPS5000  MOVE      SP70,EPSDDATT                * Episode end date & time
          UNPACK    EPISDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPSDDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ENDSET    EPSDDATT
          APPEND    " at ",EPSDDATT
          APPEND    EPISDTIM,EPSDDATT
.
          MATCH     DDATE,EPISDDAT
          IF        @EQUAL
            MATCH    DTIME,EPISDTIM
            IF       @EQUAL
              RESET    EPSDDATT
              GOTO     GEPS8000
            ENDIF
          ENDIF
.
          APPEND    " *",EPSDDATT
          RESET     EPSDDATT
.
GEPS8000  MOVE      ZERO,EXIT
          GOTO      GEPS9999
.
GEPS9000  MOVE      ONE,EXIT
          GOTO      GEPS9999
.
GEPS9999  RETURN
+
.------------------------------------------------------------
. Additional HCPs Indicator for ALREDEPT
.------------------------------------------------------------
INDHCP00  MOVE      SP70,DOCINDIC
.
          MATCH     SP70,ALREDEPT
          GOTO      INDHCP99 IF EQUAL
          GOTO      INDHCP99 IF EOS
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     "A",TCINDC22
          GOTO      INDHCP99 IF NOT EQUAL
.
          MOVE      "1",DOCINDIC
.
INDHCP99  RETURN
+
.------------------------------------------------------------
. Additional HCPs
.------------------------------------------------------------
ADDHCP00  MOVE      SP70,DOCFNAM3
          MOVE      SP70,DOCFNAM4
          MOVE      SP70,DOCFNAM5
          MOVE      SP70,DOCFNAM6
.         MOVE      SP70,DOCINDIC
.
.         MOVE      ALREDEPT,CODE
.         MOVE      "CG",CATEGORY
.         CALL      GETCOD00
.
.         MATCH     "A",TCINDC22
.         GOTO      ADDHCP99 IF NOT EQUAL
.
.         MOVE      "1",DOCINDIC
.
          MATCH     "1",DOCINDIC
          GOTO      ADDHCP99 IF NOT EQUAL
.
          MATCH     SP70,ALREUHC2
          IF        !@EQUAL
            PACK      KEY10,ALREUHC2,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM3
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC3
          IF        !@EQUAL
            PACK      KEY10,ALREUHC3,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM4
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC5
          IF        !@EQUAL
            PACK      KEY10,ALREUHC5,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM5
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC6
          IF        !@EQUAL
            PACK      KEY10,ALREUHC6,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM6
            ENDIF
          ENDIF
.
ADDHCP99  RETURN
+
. Emergency Encounter Status
.
EMSTA000  BRANCH    EMVISTAT,EMSTA110,EMSTA120,EMSTA130,EMSTA140
          GOTO      EMSTA999
EMSTA110  MATCH     SP70,EMVITRIG
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
          ELSE
            MOVE      "triaged",FHRSTAT
          ENDIF
          GOTO      EMSTA999
EMSTA120  MOVE      "finished",FHRSTAT
          GOTO      EMSTA999
EMSTA130  MOVE      "finished",FHRSTAT
          GOTO      EMSTA999
EMSTA140  MOVE      "cancelled",FHRSTAT
          GOTO      EMSTA999
EMSTA999  RETURN
+
. Outpatient Encounter Status
.
OPSTA000  BRANCH    OBASTAT,OPSTA110,OPSTA110,OPSTA110,OPSTA120,OPSTA130:
                            OPSTA110,OPSTA110,OPSTA110,OPSTA110
          GOTO      OPSTA999
OPSTA110  MOVE      "planned",FHRSTAT
          GOTO      OPSTA999
OPSTA120  MOVE      "finished",FHRSTAT
          GOTO      OPSTA999
OPSTA130  MOVE      "cancelled",FHRSTAT
          GOTO      OPSTA999
OPSTA999  RETURN
+
. Inpatient Encounter Status
.
INSTA000  BRANCH    ASTAT,INSTA110,INSTA120,INSTA130,INSTA140,INSTA150
INSTA110  MOVE      "planned",FHRSTAT
          GOTO      INSTA999
INSTA120  MOVE      "arrived",FHRSTAT
          GOTO      INSTA999
INSTA130  MOVE      "finished",FHRSTAT
          GOTO      INSTA999
INSTA140  MOVE      "onleave",FHRSTAT
          GOTO      INSTA999
INSTA150  MOVE      "cancelled",FHRSTAT
          GOTO      INSTA999
INSTA999  RETURN
+
.*******************************************************************************
. Get outpatient info
.*******************************************************************************
GETOUT00  MOVE      ZERO,EXIT
.
          MATCH     SP70,ADMISSNO
          GOTO      GETOUT90 IF EQUAL
.
          MOVE      "out",OSTFILE          * open default prefix of out
.         Get the outbokaf record
.
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD<>1
            MOVE      PVISITE,KEY6
            CALL      RDSITA1                      * site found ?
            BRANCH    OVRCD,GETOUT90
          ENDIF
.
          PACK      CFNAME,OSTFILE,FILBOKA6
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA6,CFNAME              * outbokaf opened ?
          TRAPCLR   IO
          BRANCH    OVRCD,GETOUT90
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,GETOUT90               * eof - finished
.
          MATCH     DOBAOUTN,ADMISSNO            * same visit number ?
          GOTO      GETOUT90 IF NOT EQUAL        * no - get next O/P record
.
.         Get the outbb1af record
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1                      * outbb1af record found ?
          BRANCH    OVRCD,GETOUT90               * no
.
          GOTO      GETOUT99
.
GETOUT90  MOVE      ONE,EXIT
          GOTO      GETOUT99
.
GETOUT99  RETURN
+
.------------------------------------------------------------
. Outpatient Location
.------------------------------------------------------------
OUTLOC00  PACK      KEY13,OBASITE,DASH,OBACLIN,SP70
          IF        F1=0
            WRITE     HTMLFILE;*+,"Clinic-",KEY13;
          ELSE
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1
              BRANCH    OVRCD,OUTLOC99
              MATCH     OBASITE,OCASITE
              GOTO      OUTLOC99 IF NOT EQUAL
              MATCH     OBACLIN,OCACLIN
              GOTO      OUTLOC99 IF NOT EQUAL
              IF        STRETURN=0
                WRITE     HTMLFILE;*+,OCADESC;
              ENDIF
              CLEAR     FHRLOCC
              APPEND    "Clinic-",FHRLOCC
              APPEND    OBASITE,FHRLOCC
              APPEND    OBACLIN,FHRLOCC
              APPEND    OBADATE,FHRLOCC
              RESET     FHRLOCC
              STRIP     FHRLOCC
              REP       " -",FHRLOCC
              MOVE      OCADESC,FHRLOCN
            ENDIF
          ENDIF
OUTLOC99  RETURN
+
. Emergency Location
.
EMRLOC00  PACK      KEY3,EMVILOCN,SP70
          MATCH     SP70,KEY3
          IF        @EQUAL
            PACK      KEY3,EMVISITE,SP70
            PACK      KEY3,EMVISITE,SP70
            CALL      RDEMSIT1
            CLEAR     FHRLOCC
            APPEND    "EmergencySite-", FHRLOCC
            APPEND    EMVISITE, FHRLOCC
            RESET     FHRLOCC
            MOVE      EMSTDESC,FHRLOCN
          ELSE
            CLEAR     FHRLOCC
            APPEND    "EmergencyLocation-",FHRLOCC
            APPEND    EMVILOCN,FHRLOCC
            RESET     FHRLOCC
            MOVE      FHRLOCC,FHRLOCN
          ENDIF
          BRANCH    STRETURN,EMRLOC99
          IF        F1=0
            WRITE     HTMLFILE;*+,"Emergency-",KEY3;
          ELSE
            WRITE     HTMLFILE;*+,FHRLOCN;
          ENDIF
          GOTO      EMRLOC99
.
EMRLOC99  RETURN
+
. Inpatient Location
.
INPLOC00  PACK      KEY6,AWARD,SP70
          PACK      KEY3,ABED
          MOVE      SP70,KEY9
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,INPLOC80
            MATCH     WSTBY,AADMNO
            GOTO      INPLOC80 IF NOT EQUAL
            PACK      KEY6,WWARD,SP70
            PACK      KEY3,WBED
            MOVE      "(Standby)",KEY9
          ENDIF
.
          IF        F1=0
            CLEAR     KEY16
            MATCH     SP70,KEY3
            IF        @EQUAL
              APPEND    "WARD-",KEY16
              MOVE      KEY6,WWARD
              APPEND    WWARD,KEY16
            ELSE
              APPEND    "Bed-",KEY16
              MOVE      KEY6,WWARD
              APPEND    WWARD,KEY16
              MOVE      KEY3,WBED
              APPEND    WBED,KEY16
            ENDIF
            APPEND    SP70,KEY16
            RESET     KEY16
            STRIP     KEY16
            REP       " -",KEY16
            WRITE     HTMLFILE;*+,KEY16;
          ELSE
            CALL      RDWARD1
            BRANCH    OVRCD,INPLOC80
            MOVE      WBDESC,KEY20
            STRIP     KEY20
            PACK      KEY6,WWARD,KEY3
            CALL      RDWARD1
            IF        OVRCD=0
              CLEAR     FHRLOCC
              MATCH     SP70,KEY3
              IF        @EQUAL | @EOS
                APPEND    "Ward-",FHRLOCC
              ELSE
                APPEND    "Bed-",FHRLOCC
              ENDIF
              APPEND    WWARD,FHRLOCC
              APPEND    WBED,FHRLOCC
              RESET     FHRLOCC
              STRIP     FHRLOCC
              REP       " -",FHRLOCC
              STRIP     WBDESC
              STRIP     KEY20
.              PACK      FHRLOCN,KEY20,DASH,WBDESC,KEY9
              PACK      FHRLOCN,KEY20,SP1,KEY9
              IF        STRETURN=0
                WRITE     HTMLFILE;*+,KEY20,"-",WBDESC,KEY9;
              ENDIF
            ELSE
              PACK      FHRLOCN,KEY20,KEY9
              CLEAR     FHRLOCC
              APPEND    "Ward-",FHRLOCC
              APPEND    WWARD,FHRLOCC
              RESET     FHRLOCC
              IF        STRETURN=0
                WRITE     HTMLFILE;*+,KEY20,KEY9;
              ENDIF
            ENDIF
          ENDIF
          GOTO      INPLOC99
.
INPLOC80  IF        STRETURN=0
            WRITE     HTMLFILE;*+,"N/A";
          ELSE
            PACK      FHRLOCC,SP70
            PACK      FHRLOCN,SP70
          ENDIF
          GOTO      INPLOC99
.
INPLOC99  RETURN
+
.------------------------------------------------------------
. FHIR Diagnosis and Procedures Related to Encounter
.------------------------------------------------------------
RESDIA00  MOVE      ZERO,FHRCONFL
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECD1
RESDIA10  CALL      RKPTECD1
          BRANCH    OVRCD,RESDIA20
          MATCH     DPTEDADM,ADMISSNO
          GOTO      RESDIA20 IF NOT EQUAL
.
          PACK      FHRCONID,DPTEDADM,DPTEDEPN,DPTEDCNT,SP70
          REP       " -",FHRCONID
.
          IF        FHRCONFL=0
            MOVE      ONE,FHRCONFL
            WRITE     HTMLFILE;*+,",#"diagnosis#" : [  ";
          ELSE
            WRITE     HTMLFILE;*+,", ";
          ENDIF
.
          WRITE     HTMLFILE;*+,"{ #"rank#": ",DPTEDCNT," ":
                     ",#"role#": [ { #"coding#": [ {":
                     "   #"system#": #"http://hl7.org/fhir/diagnosis-role#",":
                     "   #"code#": #"DD#" } ] } ]":
                     ",#"condition#" : ":
                     "   { #"reference#" : #"Condition/ECD-",FHRCONID,"#",":
                     "     #"display#" : #"",PTEDDESC,"#" } }  ";
          GOTO      RESDIA10
.
RESDIA20  PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECO1
RESDIA30  CALL      RKPTECO1
          BRANCH    OVRCD,RESDIA40
          MATCH     DPTEOADM,ADMISSNO
          GOTO      RESDIA40 IF NOT EQUAL
.
          IF        FHRCONFL=0
            MOVE      ONE,FHRCONFL
            WRITE     HTMLFILE;*+,",#"diagnosis#" : [ ";
          ELSE
            WRITE     HTMLFILE;*+,", ";
          ENDIF
.
          PACK      FHRCONID,DPTEOADM,DPTEOEPN,DPTEOCNT,SP70
          REP       " -",FHRCONID
          WRITE     HTMLFILE;*+,"{ #"rank#": ",DPTEOCNT," ":
                     ",#"procedure#" : ":
                     "   { #"reference#" : #"Condition/ECO-",FHRCONID,"#",":
                     "     #"display#" : #"",PTEODESC,"#" } } ";
.
          GOTO      RESDIA30
.
RESDIA40
RESDIA99  IF        FHRCONFL=1
            WRITE     HTMLFILE;*+,"]";
          ENDIF
          RETURN
+
.--------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.--------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
+
.------------------------------------------------------------
. Get Visit Details
.------------------------------------------------------------
GETVI100  MOVE      ZERO,EXIT
          MOVE      SP1,SECOPT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      SP70,VISTDAY
          MOVE      SP70,VISTLOC
          MOVE      SP70,ACLAIM
          MOVE      SP70,DDATE
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,ATYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,WARDNAME
          MOVE      SP70,REFTDESC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,DISCDATE
          MOVE      SP10,VISTTIME
          MOVE      "&nbsp;",DISCDATE
          MOVE      SP70,VISTRCOD
          MOVE      ZERO,AAEVFLAG
          MOVE      SP70,EMVISITE
.
. Emergency Visit First Seen Date and Time
          MOVE      SP70,EMRVFDAT
          MOVE      SP70,EMRVFTIM
.
          MOVE      SP10,AWARD
          MOVE      SP10,ACLAIM
          MOVE      ZERO,ASTAT
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      DOCFNAME,SP70
          RESET     DOCFNAME
          UNPACK    SP70,LSTDOCT,LSTCLIN    * work fields for Doct & Clin
          MOVE      PVIDOCT,LSTDOCT         * setup work Doctor code
          MOVE      SP70,EDDISDOC
          MOVE      SP70,EDDISDIA
.
.                            Emerg    Outpat   Inpat
          BRANCH    PVITYPE,GETVI105,GETVI110,GETVI115
          MOVE      PVIDOCT,LSTDOCT         * setup work Doctor code
          GOTO      GETVI160
.
.------------------------------------------------------------------------------
.       Emergency
.------------------------------------------------------------------------------
.
GETVI105  MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GETVI160
          MOVE      ADACOMP,ACLAIM
          MOVE      ADADOCT,PVIDOCT
          MOVE      ADADIAG,ADIADESC       * Diagnosis
          MOVE      ADADATE,PVIDATE
          MOVE      ADATIME,VISTTIME
.
          MATCH     EMCNLDAT,ADADATE
          IF        @LESS
            MOVE      ONE,AAEVFLAG          * Link to AAE Enquiry page
          ENDIF
.
          CALL      RDDISA1
          IF        OVRCD=0
            MOVE      ADSDIAG,DDIADESC
            MOVE      ADSDATE,DDATE
            MOVE      ADSDATE,EMVIDATE
            MOVE      ADSTIME,EMVIDTIM
            MOVE      ADSDISC,EMVIDSTA
          ENDIF
.
          MOVE      ZERO,EMVISTAT
          BRANCH    EMRFLAG,GETVI108
          MOVE      SP70,PTVADESC
          MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GETVI108         * EMR visit not found
.
          PACK      KEY5,EMVIDEST
          CALL      RDPTVAD1
          IF        OVRCD=0
            PACK      VSTATUS,PTVADESC,SP70
          ENDIF
          MOVE      EMVIDATE,PVIDATE
          MOVE      EMVITIME,VISTTIME
          MOVE      EMVIDRDT,EMRVFDAT      * Emergency Visit First Seen Date
          MOVE      EMVIDRTM,EMRVFTIM      * Emergency Visit First Seen Time
.
          MOVE      EMVIDOCT,PVIDOCT
          MOVE      PVIDOCT,LSTDOCT        * setup work Doctor code
.
          MATCH     "1",SHOWFRMT
          IF        @EQUAL
            MOVE      THREE,EMVISTAT       * Kids ED visits(events) hard coded
          ENDIF                            * to discharged
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MOVE      EMVIDDAT,DDATE
          ENDIF
.
          PACK      KEY5,ANSA,ANSA,EMVITRIG
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,VISTRCOD        * Triage Code
          ENDIF
.
          PACK      VISTLOC,SP70
          MATCH     EMVISITE,SP70
          GOTO      GETVI108 IF EQUAL       * No EMR site code
.
          PACK      KEY3,SP70
          CALL      RSEMSIT1
          CALL      RKEMSIT1
          BRANCH    OVRCD,GETVI108          * emrsitaf file is empty
          CALL      RKEMSIT1                * check more than 1 site exists
          BRANCH    OVRCD,GETVI106          * No, it's a single EMR site
.
.         Multi EMR site
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,GETVI108          * EMR site code not found
.
          PACK      VISTLOC,EMSTHSNO,DASH,EMVISITE
          PACK      KEY3,EMSTHSNO,SP70
          CALL      RDPTHSP1                * Hospital name
          IF        OVRCD=0
            PACK      VISTLOC,PTHSNAME,SP70
            STRIP     VISTLOC
            ENDSET    VISTLOC
            APPEND    DASH,VISTLOC
            APPEND    EMVISITE,VISTLOC
            APPEND    SP70,VISTLOC
            RESET     VISTLOC
          ENDIF
          COMPARE   ONE,IBCNMHOS
          IF        !@EQUAL
            PACK      VISTLOC,EMVISITE,SP70     * CAR 288134
          ENDIF
          GOTO      GETVI108
.
.         Single EMR site
.
GETVI106  PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,GETVI108          * EMR site code not found

          PACK      VISTLOC,EMSTDESC,SP70   * Single Hospital
          COMPARE   ONE,IBCNMHOS            * If Multi Hosp - include Hosp name
          IF        @EQUAL
            PACK      KEY3,EMSTHSNO,SP70
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,EMSTDESC,SP70
          ENDIF
          GOTO      GETVI108
.
GETVI108  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          IF        EMVISTAT=FOUR
            APPEND    INPSTA3B,VSTATUS
            GOTO      GETVI160
          ELSE
            IF        EMVISTAT=2 | EMVISTAT=3 | EMVISTAT=0
              APPEND    INPSTA3A,VSTATUS
            ELSE
              APPEND    EMGSTAT1,VSTATUS
            ENDIF
          ENDIF
.
          MATCH     SP70,DDATE
          GOTO      GETVI160 IF EQUAL
.
          MATCH     SP70,PTVADESC
          IF        !@EQUAL
            MOVE      PTVADESC,KEY10
            APPEND    KEY10,VSTATUS
          ELSE
            MATCH     SP70,EMVIDSTA
            IF        !@EQUAL
              PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,KEY20
                APPEND    KEY20,VSTATUS
              ENDIF
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    EMVIDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
          MATCH     SP70,EMVIUR02
          IF        !@EQUAL
            PACK      KEY6,EMVIUR02,SP70
          ELSE
            PACK      KEY6,EMVIDOCT,SP70
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD<>1
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,EDDISDOC     * WA health ED disharge doctor
          ENDIF
.
          CALL      WADD0000                * WA health ED discharge diagnosis
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,EMVIDOCT
          GOTO      GETVI181 IF NOT EQUAL
.
          MATCH     SP70,EMVIUR02
          GOTO      GETVI109 IF EQUAL
.
          MOVE      EMVIUR02,EMVIDOCT
.
GETVI181  MOVE      EMVIDOCT,KEY6           * Read the doctor's file to get name
          CALL      RDDOCT1
          IF        OVRCD=1
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
            GOTO      GETVI170
          ENDIF
.                                           * format doctors name
GETVI109  MOVE      PVIDOCT,LSTDOCT
          MATCH     SP6,EMVIDOCT
          IF        !@EQUAL
            MOVE      EMVIDOCT,LSTDOCT      * set doctor code for GETVI160
          ENDIF
.
          MATCH     "1",SHOWFRMT            * moved from GETVI160     *M-262001
          GOTO      GETVI170 IF EQUAL
.
          GOTO      GETVI160
.
.-----------------------------------------------------------------------------
.------ Outpatient - Read clinic file using PVIDOCT - contains "Clinic" or "DOC"
.-----------------------------------------------------------------------------
.
GETVI110  CALL      COTFIL00              * Open correct outpatient files
.
          MOVE      SP6,LSTCLIN           * create phantom "LSTCLIN" for Visit
          CALL      OCLI0000              * Get Outpatient details
.
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVI160 IF EQUAL
.
.                                         * Is PVIDOCT "Clinic" or "Doctor" ?
GETVI111  PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 1
            PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,GETVI112      * (then PVIDOCT is not a Clinic)
.
            MATCH     PVISITE,OCASITE
            GOTO      GETVI112 IF NOT EQUAL
.
            MATCH     PVIDOCT,OCACLIN
            GOTO      GETVI112 IF NOT EQUAL
          ENDIF
.
          MATCH     PVIDOCT,OCACLIN
          GOTO      GETVI112 IF NOT EQUAL * (then PVIDOCT is not a Clinic)
.
          MOVE      OCACLIN,LSTCLIN       * reposition "Clinic" and "Doctor"
          MOVE      OCADOCT,LSTDOCT       * set doctor code for GETVI160
          MOVE      OCADESC,DOCFNAME      * default - use "Clinic Name"
.
          GOTO      GETVI160
.
GETVI112  UNPACK    SP70,OCADOCT,OCACLIN,OCADESC
          CLEAR     DOCFNAME              * setup default message
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
          GOTO      GETVI170
.
.------------------------------------------------------------------------------
.         Inpatient
.------------------------------------------------------------------------------
GETVI115  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVI160
          LOAD      VSTATUS,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                   INPSTAT5
.
          MATCH     "1",SHOWCARE
          GOTO      GETVI116 IF NOT EQUAL
.
          IF        ASTAT=2
            CLEAR     VSTATUS
            APPEND    INPSTAT2,VSTATUS
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    "<BR>Care Type - ",VSTATUS
              APPEND    TDESC,VSTATUS
            ENDIF
            APPEND    SP70,VSTATUS
            RESET   VSTATUS
          ENDIF
.
GETVI116  MOVE      AMBS,VISADIAG
          MOVE      ADIAG1,ADIADESC
          MOVE      ATIME,VISTTIME
.
          PACK      DISPCLSS,SP70
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      DIM1,SP20
            PACK      DISPCLSS,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          CALL      CHKMEH00
.
          MOVE      SP70,DDATE
          CALL      GETLTR00             * Get last transfer record
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC       * Unit Description
.
          MOVE      "A ",CATEGORY
          MOVE      TATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETVI140
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      DDIAG,DDIADESC         * Discharged Diagnosis
.
          MOVE      SP20,KEY20
          IF        PTCNUADT<>1
            GOTO      GETVI130
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTDAD1
          BRANCH    OVRCD,GETVI130
          MATCH     SP70,PTDADCTS
          GOTO      GETVI130 IF EQUAL
.
          MOVE      SP20,KEY20
          MOVE      PTDADCTS,KEY5            * transfer destination
          CALL      RDPTVAD1
          IF        OVRCD=0
            MOVE      PTVADESC,KEY20     * Destination desc.
          ENDIF
          GOTO      GETVI135
.
GETVI130  IF        PTCNDRSM=1
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
          ENDIF
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ENDIF
.
GETVI135  PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
          IF        PTCNDRSM=1
            APPEND    DSTAT,VSTATUS
          ELSE
            APPEND    DDEST,VSTATUS
          ENDIF
          APPEND    " - ",VSTATUS
          APPEND    SP1,VSTATUS
.
          MATCH     SP20,KEY20
          IF        !@EQUAL
            APPEND    KEY20,VSTATUS
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    DTIME,VSTATUS
.
          MATCH     "1",SHOWCARE
          GOTO      GETVI139 IF NOT EQUAL
.
          IF        ASTAT=3
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    "<BR>Care Type - ",VSTATUS
              APPEND    TDESC,VSTATUS
            ENDIF
          ENDIF
.
GETVI139  APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETVI140  PACK      KEY6,AWARD,ABED
          PACK      KEY3,AWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          MOVE      WARDBED,WARDNAME
          STRIP     WARDNAME
.
          GOTO      GETVI160
.
.------------------------------------------------------------------------------
.                                 Format HCP Column                   *C-262001
.
GETVI160  MATCH     SP6,LSTDOCT
          GOTO      GETVI170 IF EQUAL
.
          MOVE      LSTDOCT,KEY6            * Read "patdo1af" for Doctor name
          CALL      RDDOCT1
          IF        OVRCD=1
            IF        PVITYPE = 2
              PACK      KEY10,LSTDOCT,SP10  * try "pmshcpaf" for Doctor Name
              CALL      RDPMHCP1
              BRANCH    OVRCD,GETVI170      * leave Clinic Name in DOCFNAME
.
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ELSE
              CLEAR     DOCFNAME
              APPEND    "Invalid Doctor - ",DOCFNAME
              APPEND    LSTDOCT,DOCFNAME
              RESET     DOCFNAME
            ENDIF
          ELSE                              * Doctor Name found - format it
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          IF        PVITYPE = 2
            CALL      FRMD0000              * Parameter for "clinic (doc name)"
          ENDIF
.
.----------------------------------------------------------------------------
.                                 Format the rest                     *C-262001
.
GETVI170  MOVE      "&nbsp;",VISTDESC
          MOVE      "&nbsp;",WARDNAME
          LOAD      VISTDESC,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
.
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTDESC
          ENDIF
          IF        PVITYPE=3
            LOAD      VISTDESC,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                     INPSTAT5
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Insurance Class
          MOVE      ACODE,CLAIMCOD
.
          PACK      KEY6,AWARD,SP70

          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
          LOAD      VISTTYPE,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTTYPE
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          PACK      VISTDAY,DAYNAM3,SP70
.
GETVI199  RETURN
+
.------------------------------------------------------------
. Wahealth ED discharge diaganosis ED full and lite
.------------------------------------------------------------
WADD0000  MOVE      EMVITXT2,EDDISDIA       * WA health ED discharge diagnosis
          MOVE      EMVIDATE,ICDRDDTE
          PACK      KEY9,PMVXPICD,SP70       * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      PT0DDSC2,EDDISDIA
          ENDIF
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
WADD1000  CALL      RKEMVCD1
          BRANCH    OVRCD,WADD9999
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      WADD9999 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      WADD2000 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      WADD1000 IF NOT EQUAL
.
WADD2000  MATCH     "000",EMVCSEQU
          GOTO      WADD1000 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      CODEDESC,EDDISDIA       * diagnosis
          ELSE
            MOVE      EMVCFTXT,EDDISDIA       * Free format diagnosis
          ENDIF
.
WADD9999  RETURN
+
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the visit files site code. If the site is invalid
.            or blank just open the default site of out.                        
.*******************************************************************************
COTFIL00  MATCH     SP70,PVISITE             * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
+
.------------------------------------------------------------
. Get Outpatient details
.------------------------------------------------------------
OCLI0000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
OCLI1000  CALL      RDKBOKA3
          BRANCH    OVRCD,OCLI9999
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBADATE,PVIDATE
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      OCLI1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          IF        OBASTAT=4
            MOVE      "Attended",VSTATUS
          ENDIF
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OCLI9999
.
          PACK      VISTLOC,OTHELTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70         * CAR 288134
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      KEY3,OTHEHOSP
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,OTHELTYP,SP70
            ENDIF
.
            MOVE      "CT",CATEGORY
            MOVE      OTHELTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 1
            UNPACK    SP70,OCTSITE,OCTCTYP,OCTGRP,OCTDESC,OCTXBOK,OCTXATT
            UNPACK    SP70,OCTBKT,OCTATT,OCTACT,OCTVACS
          ENDIF
.
          MOVE      OTHECTYP,UNITCODE
.
          MATCH     SP70,UNITDESC
          IF        @EQUAL
            MOVE      OCTDESC,UNITDESC
          ENDIF
.
OCLI9999  RETURN
+
.------------------------------------------------------------
.         Check for Mental Health visit
.------------------------------------------------------------
CHKMEH00  MOVE      ZERO,EXIT
          COMPARE   ONE,MHCNUSE
          GOTO      CHKMEH99 IF NOT EQUAL
.
          COMPARE   ZERO,MHCNDVIS
          GOTO      CHKMEH99 IF EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,CHKMEH99
.
          PACK      KEY18,USERID,MEH01,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,CHKMEH98
.
          COMPARE   MHCNDVIS,WBSTLEV
          GOTO      CHKMEH98 IF LESS
.
          PACK      KEY35,ANSM,ANSH,SP1,VSTATUS
          PACK      VSTATUS,KEY35,SP70
          GOTO      CHKMEH99
.
CHKMEH98  MOVE      ONE,EXIT
.
CHKMEH99  RETURN
+
.------------------------------------------------------------
. Get Last Transfer Record
.------------------------------------------------------------
GETLTR00  PACK      KEY30,PVIBILL,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETLTR10
          MATCH     PVIBILL,TADMN
          GOTO      GETLTR10 IF NOT EQUAL
          MOVE      TADOCT,PVIDOCT          * Clinician
.
          MATCH     "D",TMOVE
          GOTO      GETLTR99 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
          PACK      KEY6,TWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS00000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
          GOTO      GETLTR99
.
GETLTR10  MOVE      ADOCTA,PVIDOCT
          MOVE      ACLSSFT,TDEPT
          MOVE      ATYPE,TATYPE
.
GETLTR99  RETURN
+
.------------------------------------------------------------------------
. format HCP column - clinic (hcp)
.------------------------------------------------------------------------
.
FRMD0000  MOVE      ALCNCLNF,FORM1
          BRANCH    FORM1,FRMD1000,FRMD2000
.
.         Clinic Description ( HCP )
.
          PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
           STRIP     DOCFNAME
           STRIP     OCADESC
.
           APPEND    OCADESC,KEY50
           APPEND    SP1,KEY50
           APPEND    OBRACKET,KEY50
           APPEND    DOCFNAME,KEY50
           APPEND    CBRACKET,KEY50
.
           RESET     KEY50
           STRIP     KEY50
           CLEAR     DOCFNAME
           PACK      DOCFNAME,KEY50
           RESET     DOCFNAME
          ENDIF
.
          GOTO      FRMD9999
.
.         HCP
.
FRMD1000  GOTO      FRMD9999
.

.
.         Clinic Description
.
FRMD2000  PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
            PACK      DOCFNAME,OCADESC
          ELSE
            PACK      DOCFNAME,SP70
          ENDIF
.
          GOTO      FRMD9999
.
FRMD9999  RETURN
+
.------------------------------------------------------------
.  Lookup Code to get description
.------------------------------------------------------------
LOKCOD00  PACK      CODEDESC,SP70
          BRANCH    EMVCCSYS,LOKCOD10,LOKCOD99,LOKCOD99,LOKCOD99,LOKCOD50
.
.   User Defined
.
          GOTO      LOKCOD99
.
LOKCOD10  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDPTICD1
          IF        OVRCD=1
            MOVE      "Invalid Diagnosis Code ",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      DDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD50  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDEMICD1
          IF        OVRCD=1
            MOVE      "Invalid Emergency Diagnosis Code",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      EMICDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD99  RETURN
+
.----------------------------------------------------------------------
.  NIHC Phase 3 Upload MyHR / Episode (write to polling pmsnplaf table)
.----------------------------------------------------------------------
NIHCHR00  MATCH     "3",PTCNUNET
          GOTO      NIHCHR99 IF NOT EQUAL
.
          MATCH     SP70,DETAILKY
          GOTO      NIHCHR99 IF EQUAL
.
          PACK      KEY20,DETAILKY,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,NIHCHR99
.
          CALL      CLPMSNPL
.
          MOVE      "10",PMNPRTYP
          MOVE      OBPCURNO,PMNPURNO
          CALL      IBACLOCK
          PACK      PMNPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPRDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMNPRTIM
          MOVE      "   1",PMNPCNTR
.
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,PMNPHOSP
          ELSE
            OPEN      PATHSPA1,"pathspaf"
.
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD=0
              MOVE      PTHSHOSP,PMNPHOSP
            ENDIF
          ENDIF
.
          MOVE      USERID,PMNPRUID
          MOVE      "0",PMNPRSTA
          MOVE      PMNPRDAT,PMNPCDAT
          MOVE      PMNPRTIM,PMNPCTIM
          MOVE      PMNPRUID,PMNPCUID
.
          PACK      PMNPRCOD,OBPCCVIS,OBPCCPID,SP70
.
          CALL      WRPMNPL1
.
NIHCHR99  RETURN
+
          INC       IBAWEBCD
.
          INC       AAEDI1IO/INC
          INC       AAEDE1IO/INC
          INC       ALLLINIO/INC
          INC       ALLENCIO/INC
          INC       ALLDEPIO/INC
          INC       ALLREFIO/INC
          INC       ALLRLNIO/INC
          INC       APSMASIO/INC
          INC       ARCVX1IO/INC
          INC       CORFLDIO/INC      * Download Fields
          INC       CORTYPIO/INC      * Download Types 
          INC       CORDTTIO/INC      * Details 
          INC       EMRVISIO/INC
          INC       EMRICDIO/INC
          INC       EMRVCDIO/INC
          INC       EMRSITIO/INC
          INC       IBAPOLIO/INC
          INC       OBSAUDIO/INC      
          INC       OBSPCOIO/INC      * Patient Correspondence
          INC       OBSPCTIO/INC      * Correspondence Storage Table 
.          INC       PATDGWIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATNIDIO/INC
          INC       PATIPEIO/INC
          INC       PATONHIO/INC
          INC       PATCHCIO/INC
          INC       PMSCEXIO/INC
          INC       PMSTLEIO/INC
          INC       PMSWORIO/INC
          INC       PMSRELIO/INC
          INC       PMSEVTIO/INC
          INC       PMSDSDIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCLIO/INC
          INC       PMSHCGIO/INC
          INC       PMSCCDIO/INC      * Concession Card Details
          INC       PMSNDBIO/INC
.
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSPX2IO/INC
          INC       PMSNPLIO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC 
          INC       PATVADIO/INC
          INC       PATTRNIO/INC
          INC       PATDADIO/INC
          INC       PMSVX1IO/INC 
          INC       OBSCNAIO/INC 
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATWR1IO/INC
          INC       PATMI1IO/INC
          INC       BOKRC1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTMA1IO/INC
          INC       OUTDIAIO/INC
          INC       OUTSITIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       OUTHEDIO/INC
          INC       OUTSESIO/INC
          INC       RESCLNIO/INC
          INC       RESLURIO/INC
          INC       RESLNKIO/INC
          INC       RESHEAIO/INC
          INC       PATALRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       MRTMASIO/INC
          INC       MLTSECIO/INC
          INC       MRTVISIO/INC
          INC       MEHVI1IO/INC
          INC       MRTAUCIO/INC
          INC       MRTLOCIO/INC
          INC       HL7CODIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPMSNPL
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       DAYOFWEK
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       FHRDATCD
          INC       DGCLICAC
          INC       PMIGTNID
.
          INC       HL7REFCD
          INC       CLPATMAS
          INC       CLPATVIS
          INC       CLPATMIS
          INC       CLPATDSC
          INC       CLPATRE1
.
          INC       RESCLNCD
          INC       PATNAMCD
          INC       TFILENAM
          INC       IBALPCCD
          INC       IBALPCIO/INC
.
          INC       RESLABIO/INC            * Clinical Results Laboratory Master
          INC       PMSEHBIO/INC
.
