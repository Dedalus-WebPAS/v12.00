.******************************************************************************
.* EDWNONAD - This is a routine used by IBAPMS40 to extract NSW EDWARD        *
.*            Non Admitted Patient Data                                       *
.*                                                                            *
.* PARAMETERS  :                                                              *
.* RETURNS     :                                                              *
.* Mods        :                                                              *
.* V11.04.02 10/10/2024 Nikitha B      Task 0952518                           *
.*           Added ICD10 ED 12 code with value 47146 at ENMM1000 for object 61* 
.* V11.04.01 02/10/2024 Ebon Clements  Task 0951785                           *
.*           Send deletes of 63 objects prior to resend - ENII0000            *
.* V11.01.01 18/05/2021 Ebon Clements  Task 0886023                           *
.*           Added PTCNEXED - Collect extra container information test        *
.*           to report new object 64 - ENKK0000, 59 - ENLL0000                *
.*           61 - ENMM0000                                                    *
.* V11.00.07 01/09/2020 Ebon Clements  Task 0896519                           *
.*           Removed SQUEEZE ALREDREC from Obj 72 -  ENBB0000                 *
.*           Restored full length of ALRERDAT and ALREREXP SQUEEZE - ENBB0000 *
.*           Added OBJ 74 records for referral Reject, Activate and Waiting   *
.*           audit changes - EREF00000                                        *
.* V11.00.06 20/07/2020 Ebon Clements  Task 0894556                           *
.*           Use trigger source modifed date for DNA appointment offer        *
.*           outcome date. Removed offer outcome code from primary key        *
.*           ENJJ000                                                          *
.* V11.00.05 20/07/2020 Ebon Clements  Task 0894112                           *
.*           Fixed obj 57 key for LSOF0000 call in merge - OMRG7500           *
.* V11.00.04 13/07/2020 Ebon Clements  Task 0894112                           *
.*           Don't change obj 57 primary key in merge - OMRG0000              *
.* V11.00.03 06/07/2020 Ebon Clements  Task 0894112                           *
.*           Fixed OP visit update loop after DNA reported - ECHG6000         *
.*           Took urnumber out of object 57 primary key - ENAA0000            *
.*           Added source modified dates to merge - OMRG0000                  *
.* V11.00.02 02/06/2020 Ebon Clements  Task 0892640                           *
.*           Added reason for reschedule to obj 73  - ENJJ0000                *
.* V11.00.01 12/05/2020 Ebon Clements  Task 0891731                           *
.*           Report ALREVISN in REQUEST_FOR_SERVICE_RECORD_ID obj 73          *
.*           not OBAOUTNO - ENJJ0000                                          *
.* V10.15.06 12/12/2019 Ebon Clements  Task 0886198                           *
.*           Report campus code OTHEHCIA Obj 60 type 04 - ENHH0000            *
.* V10.15.05 28/11/2019 Ebon Clements  Task 0885366                           *
.*           Send Obj 73 Delete for cancelled bookings - ECAN0000             *
.* V10.15.04 20/11/2019 Ebon Clements  Task 0885051                           *
.*           Send referral cancellation date in REQUEST_REJECTION_DATE        *
.*           for cancelled referrals - ENBB0000                               *
.* V10.15.03 11/11/2019 Ebon Clements  Task 0883547                           *
.*           Removed O/I from obj 56 SERVICE_ACTIVITY_RECORD_ID               *
.* V10.15.02 29/10/2019 Ebon Clements  Task 0883547                           *
.*           Changed SERVICE_ACTIVITY_RECORD_ID for obj 54 and 56             *
.* V10.15.01 01/10/2019 Ebon Clements  Task 0882467                           *
.*           Removed leading space from new U/R after merge - OMRG0000        *
.* V10.14.15 01/10/2019 Ebon Clements  Task 0882096                           *
.*           Made obj 73 and 54 PLANNED_EVENT_OFFER_RECORD_ID the visit       *
.*           number then the booking YYMMDDHHMM - ENJJ0000 ENEE0000           *
.* V10.14.14 29/08/2019 Ebon Clements  Task 0880763                           *
.*           Send PTCNNIAI for the OSP_LOCAL_ID for O records - OBJ 63        *
.*           ENII0000                                                         *
.* V10.14.13 20/08/2019 Ebon Clements  Task 0880191                           *
.*           Removed century from the date and added 2 chars of the outcome   *
.*           code - PLANNED_EVENT_OFFER_RECORD_ID - ENJJ0000 Obj 73           *
.* V10.14.12 16/08/2019 Ebon Clements  Task 0879942                           *
.*           Added third O record for object 54 - ENDD0000                    *
.* V10.14.11 06/08/2019 Ebon Clements  Task 0878505                           *
.*           Test for 3024464 for OBJ 60 sub item 06 - EVENT_ATTRIBUTE_CODE   *
.*           ENHH0900                                                         *
.* V10.14.10 30/07/2019 Ebon Clements  Task 0878556                           *
.*           Changed reciprocal patients to test 11 to PTCDNHCP               *
.* V10.14.09 10/07/2019 Ebon Clements  Task 0878073                           *
.*           Fixed values reported for Obj 58 initial and subsequent visit    *
.*           ENGG0000                                                         *
.* V10.14.08 01/07/2019 Ebon Clements  Task 0876030                           *
.*           Fixed delete contact obj 63 key - CCHG0000                       *
.* V10.14.07 17/06/2019 Ebon Clements  Task 0876030                           *
.*           Report all seen date/times from the contact                      *
.*           Fixed CCHG0000 type 7 trigger time - 00:00:00                    *
.* V10.14.06 17/06/2019 Ebon Clements  Task 0876030                           *
.*           Fixed CCHG0000 type 7 trigger time - 00:00:00                    *
.* V10.14.05 07/06/2019 Ebon Clements  Task 0876030                           *
.*           Set source modified date prior to delete record calls - EDDK0000 *
.* V10.14.04 16/05/2019 Ebon Clements  Task 0874321                           *
.*           Fixed source modified dates - OBJ 54 - ENDD0000                  *
.*           Report multiple encounts for objects 54, 55, 56, 58, 60 and 63   *
.* V10.14.03 14/03/2019 Ebon Clements  Task 0871327                           *
.*           Changed PRIMARY_SETTING_TYPE_CODE to report 3 chars - ENGG0000   *
.* V10.14.02 06/03/2019 Ebon Clements  Task 0871327                           *
.*           Fixed length of ISP_DISP_SPEC_CODE - obj 54 - ENDD0000           *
.* V10.14.01 01/02/2019 Ebon Clements  Task 0869605                           *
.*           Changed request for service OBJ 72 and 74 to report ALRERHCP     *
.* V10.13.24 22/01/2019 Ebon Clements  Task 0869604                           *
.*           Added source modifed date/time to all objects - WRCOND00         *
.* V10.13.23 17/12/2018 Ebon Clements  Task 0867421                           *
.*           Fixed ISP_DISC_SPEC_CODE for (I) record obj 54 - ENDD0000        *
.* V10.13.22 11/12/2018 Ebon Clements  Task 0867421                           *
.*           Added SOURCE_CREATE_DATETIME to all objects at WRCOND00          *
.*           Fixed referral merge re send - OMRG8000                          *
.* V10.13.21 26/11/2018 Ebon Clements  Task R0864975                          *
.*           Added merge functionality for OBJ 57 to resend new U/R - OMRG0000*
.* V10.13.20 21/11/2018 Ebon Clements  Task 0864976                           *
.*           Added YEAR_LAST_ADMIT_TO_PSYC  to OBJ 55 - ENEE0000              *
.* V10.13.19 17/10/2018 Ebon Clements  Task 0865192                           *
.*           Added clinic read prior to Obj 54 ENDD0000 calls                 *
.* V10.13.18 16/10/2018 Ebon Clements  Task 0865192                           *
.*           Report actual doctor seen in OBJ 54 - ENDD0000 I record          *
.* V10.13.17 09/10/2018 Ebon Clements  Task 0862246                           *
.*           Populate ISP_DISC_SPEC_CODE (I) in ENII0000 using ALENHCP        *
.* V10.13.16 20/09/2018 Ebon Clements  Task 0862246                           *
.*           Fixed alteration file loop - ECHG0000                            *
.* V10.13.15 19/09/2018 Ebon Clements  Task 0862246                           *
.*           Fixed effective end date time format in OBJ 60 - ENHH0000        *
.* V10.13.14 17/09/2018 Ebon Clements  Task 0862246                           *
.*           Read outbb1af in ECHG0000                                        *
.* V10.13.13 14/09/2018 Ebon Clements  Task 0862246                           *
.*           Fixed object 56 Service activity - ENFF0000                      *
.* V10.13.02 12/09/2018 Ebon Clements  Task 0862246                           *
.*           Fixed object 55 servive event date time format - ENEE0000        *
.* V10.13.01 10/09/2018 Ebon Clements  Task 0862246                           *
.*           Fixed object 55 collaborative care flag - ENEE0000               *
.* V10.12.14 16/07/2018 Ebon Clements  Task 0858128                           *
.*           Fixed REQUESTING_ISP_ID report ALREHCP not ALENHCP - ENBB0000    *
.* V10.12.13 28/06/2018 Ebon Clements  Task 0858128                           *
.*           Fixed REQ_ACCEPTANCE_DATE - ENBB0000                             *
.* V10.12.12 25/06/2018 Ebon Clements  Task 0846913                           *
.*           Fixed back dated attendance - EBOK0000                           *
.* V10.12.11 02/05/2018 Ebon Clements  Task 0846913                           *
.*           Fixed PRIMARY_SETTING_TYPE_CODE - ENGG0000                       *
.* V10.12.10 30/04/2018 Ebon Clements  Task 0846913                           *
.*           Send 57 Client Service Event for attended bookings - EATT0000    *
.* V10.12.09 19/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed service event end time - ENEE0000                          *
.* V10.12.08 18/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed non admitted request received date - ENBB0000              *
.* V10.12.07 18/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed service activity sequence number ENFF0000                  *
.* V10.12.06 18/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed EFFECTIVE_START_DATETIME in ENDD0000                       *
.* V10.12.05 17/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed CHOC_EVENT_DISPOSITION_CODE - ENGG0000                     *
.* V10.12.04 16/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed client arrival and departure date - ENEE0000               *
.* V10.12.03 16/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed service provide source id for organisation - ENCC0000      *
.* V10.12.03 16/04/2018 Ebon Clements  Task 0846913                           *
.*           Fixed linked referal - ENRF0000                                  *
.* V10.12.02 06/03/2018 Ebon Clements  Task 0846913                           *
.*           Fixed EREF0000 loop                                              *
.* V10.12.01 21/02/2018 Ebon Clements  Task 0846913                           *
.*           Extract non admitted data                                        *
.* V10.12.00 23/01/2018 Jill Parkinson Task 0846167                           *
.*           Created include                                                  *
.******************************************************************************
EDNA0000  CALL      EREF0000           * Referral Request for Service 57/72/74
          CALL      EBOK0000           * OP bookings
          CALL      ERSH0000           * OP Rescheduled bookings
          CALL      ECAN0000           * OP Cancellations
          CALL      EATT0000           * OP Attended bookings
          CALL      ECHG0000           * OP visit alteration
          CALL      CCHG0000           * AH Change contact
          CALL      OMRG0000           * Process OP merges
.
EDNA9999  RETURN
+
.******************************************************************************
.* ECHG0000 - Loop pmsadwaf by creation date and find OP visits
.*            that have been updated after the created date to report
.******************************************************************************
ECHG0000  MOVE      FOUR,SDATFLAG           * EDWARD visit alteration trigger
.
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
ECHG1000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,ECHG9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      ECHG9999 IF LESS
.
          MATCH     "5  ",PMAWTYPE          * Outpatient Visit Update
          GOTO      ECHG1000 IF NOT EQUAL
.
          PACK      KEY8,PMAWVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ECHG1000
.
          PACK      KEY36,PMVXVISN,SP70
          CALL      RDSBOKA6                * Read booking
          CALL      RDKBOKA6
          BRANCH    OVRCD,ECHG1000
.
          MATCH     DOBAOUTN,PMVXVISN       * same visit number ?
          GOTO      ECHG1000 IF NOT EQUAL   * no - get next O/P record
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1                 * read booking extn
          BRANCH    OVRCD,ECHG1000
.
          CALL      ENRF0000                * Get linked referral
          IF        EXIT=1
            PACK      SRMDDATE,PMAWCDAT,SP70  * Set the source modified date
            PACK      SRMDTIME,PMAWCTIM,SP70  * to the trigger date
            CALL      DARF0000              * Send ref deletes as not public
            CALL      DOAP0000              * Send OP deletes as not public
            GOTO      ECHG1000
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,ECHG1000
.
          MATCH     "P",TCINDC1             * Extract public 
          GOTO      ECHG2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      ECHG2000 IF EQUAL
.
          PACK      SRMDDATE,PMAWCDAT,SP70  * Set the source modified date
          PACK      SRMDTIME,PMAWCTIM,SP70  * to the trigger date
          CALL      DOAP0000                * Send OP deletes as not public
          GOTO      ECHG1000
.
ECHG2000  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ECHG1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ECHG1000
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,ECHG1000
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      ECHG4000              * Read clinic
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                * Read clinic
          BRANCH    OVRCD,ECHG1000
.
          MATCH     OBASITE,OCASITE
          GOTO      ECHG1000 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      ECHG1000 IF NOT EQUAL
.
ECHG4000  COMPARE   ONE,OBASTAT             * Booked
          GOTO      ECHG5000 IF NOT EQUAL
.
. Send all objects are referral/OP might have changed to Public
.
          MOVE      ZERO,DELTFLAG
          CALL      ENBB0000           * 72  Request for service
.
          MOVE      ZERO,DELTFLAG  
          CALL      ENCC0000           * 74  Request for service provider
.
          MOVE      ZERO,RESCFLAG
          CALL      ENJJ0000           * 73 Planned event offer
.
          CALL      ENLL0000           * 59 Presenting Issue
          CALL      ENMM0000           * 61 Diagnosis
.
          GOTO      ECHG1000
.
ECHG5000  COMPARE   FOUR,OBASTAT            * Attended
          GOTO      ECHG6000 IF NOT EQUAL
.
. Send all objects are referral/OP might have changed to Public
.
          MOVE      ZERO,DELTFLAG
          CALL      ENBB0000           * 72  Request for service
.
          MOVE      ZERO,DELTFLAG
          CALL      ENCC0000           * 74  Request for service provider
.
          MOVE      ZERO,RESCFLAG
          CALL      ENJJ0000           * 73 Planned event offer
.
          CALL      ENLL0000           * 59 Presenting Issue
          CALL      ENMM0000           * 61 Diagnosis
.
          CALL      ENDD0000           * 54 Service activity provider
          CALL      ENEE0000           * 55 Service event
          CALL      ENFF0000           * 56 Service activity
          CALL      ENAA0000           * 57 Client Service Event
          CALL      ENGG0000           * 58 Service event CHOH
          CALL      ENHH0000           * 60 Service event attribute
          CALL      ENII0000           * 63 Service event provider
          CALL      ENKK0000           * 64 Onward referrral
          CALL      ENMM0000           * 61 Diagnosis
.
          GOTO      ECHG1000
.
ECHG6000  COMPARE   FIVE,OBASTAT            * DNA
          GOTO      ECHG1000 IF NOT EQUAL
.
          MOVE      ZERO,RESCFLAG
          CALL      ENJJ0000           * 73 Planned event offer
.
          CALL      ENLL0000           * 59 Presenting Issue
          CALL      ENMM0000           * 61 Diagnosis
.
          GOTO      ECHG1000
.
ECHG9999  RETURN
+
.******************************************************************************
.* DOAP0000 - Send delete of all OP booking objects
.******************************************************************************
DOAP0000  MATCH     SP70,ALREVISN           * Exit no referral
          GOTO      DOAP9999 IF EQUAL
.
          MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
.
          MOVE      "54 ",DELETOBJ                * Service activity provider
          PACK      DELETKEY,FOUR,OBAOUTNO,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "55 ",DELETOBJ                * Service event
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "56 ",DELETOBJ                * Service activity
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "57 ",DELETOBJ                * Client Service Event
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "58 ",DELETOBJ                * Service event CHOH
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "59 ",DELETOBJ                * Presenting Issue   
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "60 ",DELETOBJ                * Service event attribute
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "61 ",DELETOBJ                * Diagnosis
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "63 ",DELETOBJ                * Service event provider
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "64 ",DELETOBJ                * Onward Referral
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "73 ",DELETOBJ                * Planned event offer
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
DOAP9999  RETURN
+
.******************************************************************************
.* DARF0000 - Send delete of all AH referral objects        
.******************************************************************************
DARF0000  MATCH     SP70,ALREVISN           * Exit no referral
          GOTO      DARF9999 IF EQUAL
.
          MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
.
          MOVE      "72 ",DELETOBJ           * 72 Request for service
          PACK      DELETKEY,FOUR,ALREVISN,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "74 ",DELETOBJ           * 74 - Request for service provider
          PACK      DELETKEY,FOUR,ALREVISN,SP70,SP70
          CALL      EDDK0000

DARF9999  RETURN
+
.******************************************************************************
.* EREF0000 - Loop allaudaf and extract request for service 72/74
.******************************************************************************
EREF0000  MOVE      ONE,SDATFLAG            * Referral audit trigger
.
          PACK      KEY24,STRTDATE,SP70
          CALL      RSALAUD3
EREF1000  CALL      RKALAUD3                * Loop referral audit file
          BRANCH    OVRCD,EREF9999
.
          MATCH     ALAUADAT,ENDDATE        * Date created
          GOTO      EREF9999 IF LESS
.
          MATCH     "C",ALAUUPDT            * Skip closed
          GOTO      EREF1000 IF EQUAL
.
          MATCH     "E",ALAUUPDT            * Skip reinstate
          GOTO      EREF1000 IF EQUAL
.
          MATCH     "I",ALAUUPDT            * Skip inactivate
          GOTO      EREF1000 IF EQUAL
.
          MATCH     "M",ALAUUPDT            * Skip mark
          GOTO      EREF1000 IF EQUAL
.
          MATCH     "S",ALAUUPDT            * Skip transfer case team
          GOTO      EREF1000 IF EQUAL
.
          MATCH     "V",ALAUUPDT            * Skip view
          GOTO      EREF1000 IF EQUAL
.
          PACK      KEY8,ALAUVISN,SP70
          CALL      RDALREF1                * Read AH referral
          BRANCH    OVRCD,EREF1000
.
          PACK      KEY5,ANSC,ANSL,ALRECOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,EREF1000
.
          MATCH     "P",TCINDC1             * Extract public
          GOTO      EREF2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      EREF2000 IF EQUAL
.
          PACK      SRMDDATE,ALAUADAT,SP70  * Set the source modified date
          PACK      SRMDTIME,ALAUATIM,SP70  * to the trigger date
          CALL      DARF0000              * Send ref deletes as not public
          CALL      WOPA0000              * Write OP EDWARD visit update
          GOTO      EREF1000
.
EREF2000  CALL      WOPA0000                * Write OP EDWARD visit update
.
          MATCH     "A",ALAUUPDT            * Add referral
          IF        @EQUAL
            MOVE      ZERO,SDATFLAG         * Add trigger
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
            MOVE      ONE,SDATFLAG            * Referral audit trigger
          ENDIF
.
          MATCH     "H",ALAUUPDT            * Transfer HCP
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "J",ALAUUPDT            * Reject
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "N",ALAUUPDT            * Cancel status
          IF        @EQUAL
            MOVE      ONE,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ONE,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "P",ALAUUPDT            * Transfer department
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "R",ALAUUPDT            * Priority change
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "T",ALAUUPDT            * Activate
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "U",ALAUUPDT            * Update   
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          MATCH     "W",ALAUUPDT            * Waiting Status
          IF        @EQUAL
            MOVE      ZERO,DELTFLAG
            CALL      ENBB0000              * 72  Request for service
.
            MOVE      ZERO,DELTFLAG
            CALL      ENCC0000              * 74  Request for service provider
          ENDIF
.
          GOTO      EREF1000
.
EREF9999  RETURN
+
.******************************************************************************
. Write OP EDWARD visit update
.******************************************************************************
WOPA0000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
          CALL      RKALLNK1
          BRANCH    OVRCD,WOPA9999
.
          MATCH     ALREVISN,ALLNVISN
          GOTO      WOPA9999 IF NOT EQUAL
.
          MOVE      ALLNLNKV,PMAWVISN
          MOVE      FIVE,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          MOVE      ALAUADAT,PMAWCDAT,CCC,CYY,CMM,CDD
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WOPA9999  RETURN
+
.******************************************************************************
. ENAA0000 - 57 Client Service Event
.******************************************************************************
ENAA0000  CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENAA9999 IF EQUAL
.
ENAA0500  MOVE      ALREVISN,VISITNUM
          MOVE      OBAOUTNO,DIM8
          MOVE      ALREURNO,URNUMBER
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      "57",OBJECTTY                * Client Service Event
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,ZERO,ONE,SIX:
                             SP70,SP70
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
          SQUEEZE   DIM8
          SQUEEZE   URNUMBER
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             DIM8,DASH:
                             ENCTRNUM,TILDA:     * EVENT_RECORD_ID
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             URNUMBER:           * CLIENT_ID
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENAA0500 IF NOT EQUAL
.
ENAA9999  RETURN
+
.******************************************************************************
. ENBB0000 - 72 Request for service
.******************************************************************************
ENBB0000  MOVE      SP70,DIM5
          PACK      KEY6,ALREPSIT,SP70
          CALL      RDSITA1                      * Read OP preferred site
          BRANCH    OVRCD,ENBB1000   
.
          PACK      KEY5,OSTCATG,ALRESRCE,SP70   * Site source of ref category
          CALL      RDCODE1                      
          BRANCH    OVRCD,ENBB1000
.
          UNPACK    PTCDASC1,DIM5                * Ass field 1
.
ENBB1000  MOVE      ALREVISN,VISITNUM
          MOVE      ALREURNO,URNUMBER
          MOVE      "9475-001",DIM8
.
          MOVE      "72",OBJECTTY                * Request for service
          PACK      OBJECTKY,FOUR,ALREVISN,SP70,SP70
.
          MOVE      ALREDREC,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            MOVE      ALRERDAT,DIM8A
          ENDIF
.
          MOVE      SP70,DIM8B
          MOVE      ALREUDT3,DIM8B
          MATCH     SP70,DIM8B
          IF        @EQUAL
            MOVE      ALRERDAT,DIM8B
          ENDIF
.
          MOVE      ALRERHCP,DIM10
.
          MOVE      SP70,DIM8C
          MATCH     "4",ALRESTAT                 * Cancelled
          IF        @EQUAL
            MOVE      ALREDCAN,DIM8C
          ENDIF
.
          MATCH     "5",ALRESTAT                 * Rejected
          IF        @EQUAL
            MOVE      ALRESRDT,DIM8C
          ENDIF
.             
          SQUEEZE   VISITNUM
          SQUEEZE   DIM5
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM8C
          SQUEEZE   URNUMBER
          SQUEEZE   ALRERDAT
          SQUEEZE   ALREREXP
          SQUEEZE   DIM10
.
          PACK      OBJECTTX,PTCNNSSI,TILDA:     * REQ_FOR_SERVICE_SOURCE_ID
                             VISITNUM,TILDA:     * REQ_FOR_SERVICE_RECORD_ID
                             FOUR,TILDA:         * REQ_SERVICE_EVENT_TYPE_CODE
                             DIM5,TILDA:         * REQ_SOURCE_TYPE_CODE
                             ALRERDAT,TILDA:     * REQ_CORRESPONDENCE_DATE
                             DIM8A,TILDA:        * REQ_RECEIVED_DATE
                             ALREREXP,TILDA:     * REQ_EXPIRY_DATE
                             TILDA:              * REQ_COMMENTS
                             DIM8B,TILDA:        * REQ_ACCEPTANCE_DATE
                             DIM8C,TILDA:        * REQ_REJECTION_DATE
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             URNUMBER,TILDA:     * CLIENT_ID
                             ONE,ZERO,ZERO,TILDA:  * REQ_OSP_ID_TYPE_CODE
                             DIM8,TILDA:         * REQUESTING_OSP_SOURCE_ID
                             PTCNNIAI,TILDA:     * REQUESTING_OSP_ID
                             ZERO,THREE,FIVE:
                             TILDA:              * REQUESTING_ISP_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * REQUESTING_ISP_SOURCE_ID
                             DIM10:              * REQUESTING_ISP_ID
                             SP900
.
          PACK      ALRERDAT,ALRERDAT,SP70       * Restore full length
          PACK      ALREREXP,ALREREXP,SP70       * Restore full length
.
          PACK      SRCRDATE,ALRECDAT,SP70
          PACK      SRCRTIME,ALRECTIM,SP70
          PACK      SRMDDATE,ALRECDAT,SP70 
          PACK      SRMDTIME,ALRECTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          IF        DELTFLAG=1
            MOVE      ANSD,OBJECTRT
          ELSE
            MOVE      SP70,OBJECTRT
          ENDIF
          CALL      WRCOND00     * write record to container detail table
.
ENBB9999  RETURN
+
.******************************************************************************
. ENCC0000 - 74 Request for service provider
.******************************************************************************
ENCC0000  MOVE      ALREVISN,VISITNUM
.
          MOVE      "O",DIM1
          MOVE      "100",DIM3
          MOVE      "9475-001",DIM20
          MOVE      PTCNNIAI,DIM20A
.
          MOVE      "74",OBJECTTY                * REQUEST FOR SERVICE
          PACK      OBJECTKY,FOUR,ALREVISN,ALREVISN,ANSO,SP70,SP70
.
          SQUEEZE   DIM20
          SQUEEZE   DIM20A
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,PTCNNSSI,TILDA:     * RECORD_SOURCE_SYSTEM_CODE
                             VISITNUM,TILDA:     * REQ_FOR_SERVICE_RECORD_ID
                             VISITNUM,DASH:
                             DIM20A,TILDA:       * REQ_FOR_SRV_PROV_RECORD_ID
                             DIM1,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             DIM3,TILDA:         * SERVICE_PROVIDER_ID_TYPE_CODE
                             DIM20,TILDA:        * SERVICE_PROVIDER_SOURCE_ID
                             DIM20A,TILDA:       * SERVICE_PROVIDER_ID
                             SP900               * ISP_DISC_SPEC_CODE
.
          PACK      SRCRDATE,ALRECDAT,SP70
          PACK      SRCRTIME,ALRECTIM,SP70
          PACK      SRMDDATE,ALRECDAT,SP70 
          PACK      SRMDTIME,ALRECTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          IF        DELTFLAG=1
            MOVE      ANSD,OBJECTRT
          ELSE
            MOVE      SP70,OBJECTRT
          ENDIF
          CALL      WRCOND00     * write record to container detail table
.
ENCC5000  MOVE      "I",DIM1
          MOVE      "035",DIM3
          MOVE      PTCNNSSI,DIM20
          MOVE      ALRERHCP,DIM20A
.
          MOVE      SP70,DIM10
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ENCC6000

          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ENCC6000
.
          MOVE      PTCDUDF3,DIM10
.
ENCC6000  MOVE      "74",OBJECTTY                * REQUEST FOR SERVICE
          PACK      OBJECTKY,FOUR,ALREVISN,ALREVISN,ANSI,SP70,SP70
.
          SQUEEZE   DIM10
          SQUEEZE   DIM20
          SQUEEZE   DIM20A
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,PTCNNSSI,TILDA:     * RECORD_SOURCE_SYSTEM_CODE
                             VISITNUM,TILDA:     * REQ_FOR_SERVICE_RECORD_ID
                             VISITNUM,DASH:
                             DIM20A,TILDA:       * REQ_FOR_SRV_PROV_RECORD_ID
                             DIM1,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             DIM3,TILDA:         * SERVICE_PROVIDER_ID_TYPE_CODE
                             DIM20,TILDA:        * SERVICE_PROVIDER_SOURCE_ID
                             DIM20A,TILDA:       * SERVICE_PROVIDER_ID
                             DIM10:              * ISP_DISC_SPEC_CODE
                             SP900
.
          PACK      SRCRDATE,ALRECDAT,SP70
          PACK      SRCRTIME,ALRECTIM,SP70
          PACK      SRMDDATE,ALRECDAT,SP70 
          PACK      SRMDTIME,ALRECTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          IF        DELTFLAG=1
            MOVE      ANSD,OBJECTRT
          ELSE
            MOVE      SP70,OBJECTRT
          ENDIF
          CALL      WRCOND00     * write record to container detail table
.
ENCC9999  RETURN
+
.******************************************************************************
. EBOK0000 - Extract outpatient booking data
.******************************************************************************
EBOK0000  MOVE      ZERO,SDATFLAG             * Add trigger
.
          PACK      KEY24,STRTDATE,SP70
          CALL      RSPMVX14
EBOK1000  CALL      RKPMVX14                * Loop visit extn file
          BRANCH    OVRCD,EBOK9999
.
          MATCH     PMVXCDTE,ENDDATE        * Date created
          GOTO      EBOK9999 IF LESS
.
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPREA1
          BRANCH    OVRCD,EBOK1200
.
          MOVE      OPRSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
EBOK1200  PACK      KEY36,PMVXVISN,SP70
          CALL      RDSBOKA6                * Read booking
          CALL      RDKBOKA6
          BRANCH    OVRCD,EBOK1000
.
          MATCH     DOBAOUTN,PMVXVISN       * same visit number ?
          GOTO      EBOK1000 IF NOT EQUAL   * no - get next O/P record
.
          COMPARE   ONE,OBASTAT             * booked
          GOTO      EBOK1500 IF EQUAL
.
          COMPARE   FOUR,OBASTAT            * attended
          GOTO      EBOK1500 IF EQUAL
.
          COMPARE   SIX,OBASTAT             * suspended
          GOTO      EBOK1500 IF EQUAL
.
          GOTO      EBOK1000
.
EBOK1500  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1                 * read booking extn
          BRANCH    OVRCD,EBOK1000
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,EBOK1000
.
          MATCH     "P",TCINDC1             * Extract public
          GOTO      EBOK2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      EBOK2000 IF EQUAL
.
          GOTO      EBOK1000
.
EBOK2000  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,EBOK1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,EBOK1000 
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,EBOK1000
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      EBOK4000              * Read clinic
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                * Read clinic
          BRANCH    OVRCD,EBOK1000
.
          MATCH     OBASITE,OCASITE
          GOTO      EBOK1000 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      EBOK1000 IF NOT EQUAL
.
EBOK4000  CALL      ENRF0000                * Get linked referral 
          BRANCH    EXIT,EBOK1000
.
          MOVE      ZERO,RESCFLAG
          CALL      ENJJ0000                * 73 Planned event offer
.
          CALL      ENLL0000           * 59 Presenting Issue
          CALL      ENMM0000           * 61 Diagnosis
.
          COMPARE   FOUR,OBASTAT            * Attended
          GOTO      EBOK1000 IF NOT EQUAL
.
          MATCH     PMVXCDTE,OBADATE        * Back dated attendance
          GOTO      EBOK1000 IF NOT LESS
.
          CALL      ENDD0000           * 54 Service activity provider
          CALL      ENEE0000           * 55 Service event
          CALL      ENFF0000           * 56 Service activity
          CALL      ENAA0000           * 57  Client Service Event
          CALL      ENGG0000           * 58 Service event CHOH
          CALL      ENHH0000           * 60 Service event attribute
          CALL      ENII0000           * 63 Service event provider
          CALL      ENKK0000           * 64 Onward referrral
          CALL      ENMM0000           * 61 Diagnosis
.
          GOTO      EBOK1000
.
EBOK9999  RETURN
+
.******************************************************************************
. ERSH0000 - Extract outpatient resheduled bookings
.******************************************************************************
ERSH0000  MOVE      TWO,SDATFLAG              * Reschedule visit trigger
.
          PACK      KEY6,SP70
          CALL      RDSSITA1
ERSH1000  CALL      RDKSITA1                * Loop all sites
          BRANCH    OVRCD,ERSH9999
.
          MOVE      OSTSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
          PACK      KEY25,OSTSITE,STRTDATE,SP70
          CALL      RDSRSHA3
ERSH2000  CALL      RDKRSHA3                * Loop reshedule file
          BRANCH    OVRCD,ERSH1000
.
          MATCH     OSTSITE,OPRSSITE        * Correct site
          GOTO      ERSH1000 IF NOT EQUAL
.
          MATCH     OPRSRDTE,ENDDATE        * Date created
          GOTO      ERSH1000 IF LESS
.
          PACK      KEY36,DOPRSOUT,SP70
          CALL      RDSBOKA6                     * Read booking
          CALL      RDKBOKA6
          BRANCH    OVRCD,ERSH2000
.
          MATCH     DOBAOUTN,DOPRSOUT            * same visit number ?
          GOTO      ERSH2000 IF NOT EQUAL        * no - get next O/P record
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1                      * Read booking extn
          BRANCH    OVRCD,ERSH2000
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,ERSH2000
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,ERSH2000
.
          MATCH     "P",TCINDC1             * Extract public
          GOTO      ERSH3000 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      ERSH3000 IF EQUAL
.
          GOTO      ERSH2000
.
ERSH3000  CALL      ENRF0000                * Get linked referral 
          BRANCH    EXIT,ERSH2000
.
          MOVE      ONE,OBASTAT
.
          MOVE      ONE,RESCFLAG            * Yes reporting a reschedule
          CALL      ENJJ0000                * 73 Planned event offer New Appt
.
          CALL      ENLL0000                * 59 Presenting Issue
          CALL      ENMM0000                * 61 Diagnosis
.
          MOVE      OPRSDATE,OBADATE
          MOVE      OPRSTIME,OBATIME
          MOVE      OPRSBKDT,OBABKDTE
          MOVE      FIVE,OBASTAT
.
          MOVE      ONE,RESCFLAG            * Yes reporting a reschedule
          CALL      ENJJ0000                * 73 Planned event offer Old Appt
.
          CALL      ENLL0000                * 59 Presenting Issue
          CALL      ENMM0000                * 61 Diagnosis
.
          GOTO      ERSH2000
.
ERSH9999  RETURN
+
.******************************************************************************
. ECAN0000 - Extract outpatient cencelled bookings
.******************************************************************************
ECAN0000  MOVE      THREE,SDATFLAG            * Cancel visit trigger
.
          PACK      KEY6,SP70
          CALL      RDSSITA1
ECAN1000  CALL      RDKSITA1                * Loop all sites
          BRANCH    OVRCD,ECAN9999
.
          MOVE      OSTSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
          PACK      KEY22,OSTSITE,STRTDATE,SP70
          CALL      RSOTCAN4
ECAN2000  CALL      RKOTCAN4                * Loop cancellation file
          BRANCH    OVRCD,ECAN1000
.
          MATCH     OSTSITE,OPCNSITE        * Correct site
          GOTO      ECAN1000 IF NOT EQUAL
.
          MATCH     OPCNRDTE,ENDDATE        * Date created
          GOTO      ECAN1000 IF LESS
.
          CALL      CLOUTBOA
          CALL      CLOUTBB1
          CALL      CLALLREF
          MOVE      DOPCNOUT,OBAOUTNO
          MOVE      OPCNREFN,ALREVISN
.
          PACK      SRMDDATE,OPCNRDTE,SP70  * Set the source modified date
          PACK      SRMDTIME,OPCNRTIM,SP70  * to the trigger date
.
          MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
          MOVE      "73 ",DELETOBJ                * Planned event offer
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
          MOVE      "59 ",DELETOBJ                * Presenting issue
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          GOTO      ECAN2000
.
ECAN9999  RETURN
+
.******************************************************************************
. EATT0000 - Extract outpatient attended bookings
.******************************************************************************
EATT0000  MOVE      ZERO,SDATFLAG           * Add trigger
.
          PACK      KEY6,SP70
          CALL      RDSSITA1
EATT1000  CALL      RDKSITA1                * Loop all sites
          BRANCH    OVRCD,EATT9999
.
          MOVE      OSTSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
          PACK      KEY25,OSTSITE,STRTDATE,SP70
          CALL      RDSSESA6                * Sesssion for site and date
EATT2000  CALL      RDKSESA6
          BRANCH    OVRCD,EATT1000
.
          MATCH     OSESITE,OSTSITE         * Correct site  
          GOTO      EATT1000 IF NOT EQUAL
.
          MATCH     OSEDATE,ENDDATE         * Session date
          GOTO      EATT1000 IF LESS
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,EATT2000
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,EATT2000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
EATT3000  CALL      RDKBOKA1                * Check all bookings
          BRANCH    OVRCD,EATT2000
.
          MATCH     OBASITE,OSESITE         * Site
          GOTO      EATT2000 IF NOT EQUAL
.
          MATCH     OBACLIN,OSECLIN         * Clinic
          GOTO      EATT2000 IF NOT EQUAL
.
          MATCH     OBADATE,OSEDATE         * Date
          GOTO      EATT2000 IF NOT EQUAL
.
          MATCH     OBASTRT,OSESTRT         * Start time
          GOTO      EATT2000 IF NOT EQUAL
.
          COMPARE   FOUR,OBASTAT            * Attended bookings only
          GOTO      EATT3000 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,EATT3000
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,EATT3000
.
          MATCH     "P",TCINDC1             * Extract public 
          GOTO      EATT3500 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      EATT3500 IF EQUAL
.
          GOTO      EATT3000
.
EATT3500  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EATT3000
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      EATT4000              * Read clinic
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                * Read clinic
          BRANCH    OVRCD,EATT3000
.
          MATCH     OBASITE,OCASITE
          GOTO      EATT3000 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      EATT3000 IF NOT EQUAL
.
EATT4000  CALL      ENRF0000                * Get linked referral 
          BRANCH    EXIT,EATT3000
.
          CALL      ENDD0000           * 54 Service activity provider
          CALL      ENEE0000           * 55 Service event
          CALL      ENFF0000           * 56 Service activity
          CALL      ENAA0000           * 57 Client Service Event
          CALL      ENGG0000           * 58 Service event CHOH
          CALL      ENHH0000           * 60 Service event attribute
          CALL      ENII0000           * 63 Service event provider
          CALL      ENKK0000           * 64 Onward referrral
          CALL      ENMM0000           * 61 Diagnosis
.
          MATCH     OBADATE,OBABKDTE     * Booked and attended on the same day
          IF        @EQUAL
            MOVE      ZERO,RESCFLAG
            CALL      ENJJ0000           * 73 Planned event offer
.
            CALL      ENLL0000           * 59 Presenting Issue
            CALL      ENMM0000           * 61 Diagnosis
          ENDIF
.
          GOTO      EATT3000
.
EATT9999  RETURN
+
.******************************************************************************
. ENDD0000 - 54 Service activity provider        
.******************************************************************************
ENDD0000  MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
          MOVE      "54 ",DELETOBJ                * Service activity provider
          PACK      DELETKEY,FOUR,OBAOUTNO,OBAOUTNO,SP70,SP70
          CALL      EDDK0000 
.
          CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENDD9000 IF EQUAL
.
ENDD0500  CALL      ENCD0000              * Use contact date times/duration
.
          PACK      KEY18,ALENVISN,ALENENCT,SP70
          CALL      RDALITM1
ENDD1000  CALL      RKALITM1                * Only report this contact
          BRANCH    OVRCD,ENDD8000     
.
          MATCH     ALITVISN,ALENVISN       * Same visit number
          GOTO      ENDD8000 IF NOT EQUAL
.
          MATCH     ALITENCN,ALENENCT       * Same cntact number
          GOTO      ENDD8000 IF NOT EQUAL
.
          MATCH     SP70,ALITITMN           * Skip if item number is blank
          GOTO      ENDD1000 IF EQUAL
.         
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
          MOVE      ALITITMN,DIM9
.
          MOVE      "54",OBJECTTY                * Service activity provider
          PACK      OBJECTKY,FOUR,OBAOUTNO,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSO,SP70,SP70
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          MOVE      SP70,DIM8A
          MOVE      SP70,DIM5A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
            PACK      DIM5A,OTBBASTM,SP70
            REP       ": ",DIM5A
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      "9475-001",DIM8
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM5A
          SQUEEZE   DIM9
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM10B
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * ACTIVITY_SOURCE_ID 
                             VISITNUM,DIM9:
                             PTCNNCPP,OBADATE:
                             DIM5A,TILDA:        * ACTIVITY_RECORD_ID 
                             PTCNNCPP,TILDA:     * ACTIVITY_PROVIDER_RECORD_ID
                             ANSO,TILDA:         * SERVICE_PROVIDER_TYPE_CODE 
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE 
                             DIM8,TILDA:      * PROVIDER_SOURCE_ID 
                             PTCNNCPP,TILDA:      * SERVICE_PROVIDER_ID
                             TILDA:              * ISP_DISC_SPEC_CODE 
                             DIM10A,SP1,DIM8A:    * EFFECTIVE_START_DATETIME 
                             TILDA:
                             DIM10B,SP1,DIM8B:    * EFFECTIVE_END_DATETIME 
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
........  CALL      WRCOND00     * write record to container detail table
.
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
          MOVE      ALITITMN,DIM9
.
          MOVE      "54",OBJECTTY                * Service activity provider
          PACK      OBJECTKY,FOUR,OBAOUTNO,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSO,ANSO,SP70,SP70
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          MOVE      SP70,DIM8A
          MOVE      SP70,DIM5A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
            PACK      DIM5A,OTBBASTM,SP70
            REP       ": ",DIM5A
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      "9475-001",DIM8
          MOVE      OTHEHCLI,DIM20
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM5A
          SQUEEZE   DIM9
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM10B
          SQUEEZE   DIM20
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * ACTIVITY_SOURCE_ID
                             VISITNUM,DIM9:
                             DIM20,OBADATE:
                             DIM5A,TILDA:        * ACTIVITY_RECORD_ID
                             DIM20,TILDA:        * ACTIVITY_PROVIDER_RECORD_ID
                             ANSO,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE
                             DIM8,TILDA:      * PROVIDER_SOURCE_ID
                             DIM20,TILDA:      * SERVICE_PROVIDER_ID
                             TILDA:              * ISP_DISC_SPEC_CODE
                             DIM10A,SP1,DIM8A:    * EFFECTIVE_START_DATETIME
                             TILDA:
                             DIM10B,SP1,DIM8B:    * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
          MOVE      ALITITMN,DIM9
.
          MOVE      "54",OBJECTTY                * Service activity provider
          PACK      OBJECTKY,FOUR,OBAOUTNO,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSO,ANSO,ANSO,SP70,SP70
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          MOVE      SP70,DIM8A
          MOVE      SP70,DIM5A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
            PACK      DIM5A,OTBBASTM,SP70
            REP       ": ",DIM5A
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      "9475-001",DIM8
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM5A
          SQUEEZE   DIM9
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM10B
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * ACTIVITY_SOURCE_ID
                             VISITNUM,DIM9:
                             PTCNNIAI,OBADATE:
                             DIM5A,TILDA:        * ACTIVITY_RECORD_ID
                             PTCNNIAI,TILDA:     * ACTIVITY_PROVIDER_RECORD_ID
                             ANSO,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE
                             DIM8,TILDA:      * PROVIDER_SOURCE_ID
                             PTCNNIAI,TILDA:      * SERVICE_PROVIDER_ID
                             TILDA:              * ISP_DISC_SPEC_CODE
                             DIM10A,SP1,DIM8A:    * EFFECTIVE_START_DATETIME
                             TILDA:
                             DIM10B,SP1,DIM8B:    * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
........  CALL      WRCOND00     * write record to container detail table
.
          MOVE      OBADOCT,DIM20
          MATCH     SP70,OTBBADCS
          IF        !@EQUAL
            MOVE      OTBBADCS,DIM20
          ENDIF
          MATCH     SP70,ALENHCP
          IF        !@EQUAL
            MOVE      ALENHCP,DIM20
          ENDIF
.
          MATCH     SP70,DIM20            * Doctor seen
          GOTO      ENDD8000 IF EQUAL
.
          MOVE      ALITITMN,DIM9
.
          MOVE      "54",OBJECTTY                * Service activity provider
          PACK      OBJECTKY,FOUR,OBAOUTNO,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSI,SP70,SP70
.
          MATCH     SP70,DIM8A         * Don't report if not seen by Dr
          GOTO      ENDD8000 IF EQUAL
.
          PACK      KEY10,DIM20,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP
          ENDIF
.
          MOVE      SP70,DIM10
          MATCH     SP70,PMHCSPC1
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE     PTCDUDF3,DIM10
            ENDIF
          ENDIF
.
          MATCH     SP70,ALRERDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALRERDEP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    SP70,PTCDUDF3
              IF       !@EQUAL
                MOVE     PTCDUDF3,DIM10
              ENDIF
            ENDIF
          ENDIF
.
          SQUEEZE   DIM5A
          SQUEEZE   DIM9
          SQUEEZE   DIM20
          SQUEEZE   DIM10
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * ACTIVITY_SOURCE_ID
                             VISITNUM,DIM9:
                             DIM20,OBADATE:
                             DIM5A,TILDA:        * ACTIVITY_RECORD_ID
                             DIM20,TILDA:        * ACTIVITY_PROVIDER_RECORD_ID
                             ANSI,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE:
                             TILDA:              * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * PROVIDER_SOURCE_ID
                             DIM20,TILDA:        * SERVICE_PROVIDER_ID
                             DIM10,TILDA:          * ISP_DISC_SPEC_CODE
                             DIM10A,SP1,DIM8A:    * EFFECTIVE_START_DATETIME
                             TILDA:
                             DIM10B,SP1,DIM8B:    * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      ENDD1000                * Get next item
.
ENDD8000  CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENDD0500 IF NOT EQUAL
.
ENDD9000  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENDD9999  RETURN
+
.******************************************************************************
. ENRF0000 - Get linked referral for an OP visit
.******************************************************************************
ENRF0000  PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,ENRF8000
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      ENRF8000 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ENRF8000
.
          PACK      KEY5,ANSC,ANSL,ALRECOMP,SP70
          CALL      RDCODE1                 * Read claim code
          BRANCH    OVRCD,ENRF8000
.
          MATCH     "P",TCINDC1             * Extract public
          GOTO      ENRF7000 IF EQUAL
.
          MATCH     "11",PTCDNHCP           * Extract reciprocal
          GOTO      ENRF7000 IF EQUAL
.
          GOTO      ENRF8000
.
ENRF7000  MOVE      ZERO,EXIT
          GOTO      ENRF9999
.
ENRF8000  CALL      CLALLREF
          MOVE      ONE,EXIT
          GOTO      ENRF9999
.
ENRF9999  RETURN
+
.******************************************************************************
. ENEN0000 - Get first linked encounter for an OP visit
.******************************************************************************
ENEN0000  PACK      KEY24,DOBAOUTN,SP70
          CALL      RSALENC7
ENEN1000  CALL      RKALENC7
          BRANCH    OVRCD,ENEN8000
.
          MATCH     ALENLINK,DOBAOUTN
          GOTO      ENEN8000 IF NOT EQUAL
.
          MATCH     ALENVISN,ALREVISN
          GOTO      ENEN8000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                 * Cancelled
          GOTO      ENEN1000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ALENCOMP,SP70
          CALL      RDCODE1                      * Read claim code
          BRANCH    OVRCD,ENEN1000
.
          MATCH     "P",TCINDC1                  * Extract public
          GOTO      ENEN9999 IF EQUAL
.
          MATCH     "11",PTCDNHCP                * Extract reciprocal
          GOTO      ENEN9999 IF EQUAL
.
          GOTO      ENEN1000
.
ENEN8000  CALL      CLALLENC
          GOTO      ENEN9999
.
ENEN9999  RETURN
+
.******************************************************************************
. ENXT0000 - Get next linked encounter for an OP visit
.            Positional read done in ENEN0000
.******************************************************************************
ENXT0000  CALL      RKALENC7
          BRANCH    OVRCD,ENXT8000
.
          MATCH     ALENLINK,DOBAOUTN
          GOTO      ENXT8000 IF NOT EQUAL
.
          MATCH     ALENVISN,ALREVISN
          GOTO      ENXT8000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                 * Cancelled
          GOTO      ENXT0000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ALENCOMP,SP70
          CALL      RDCODE1                      * Read claim code
          BRANCH    OVRCD,ENXT0000
.
          MATCH     "P",TCINDC1                  * Extract public
          GOTO      ENXT9999 IF EQUAL
.
          MATCH     "11",PTCDNHCP                * Extract reciprocal
          GOTO      ENXT9999 IF EQUAL
.
          GOTO      ENXT0000
.
ENXT8000  CALL      CLALLENC
          GOTO      ENXT9999
.
ENXT9999  RETURN
+
.******************************************************************************
. ENEE0000 - 55 Service event
.******************************************************************************
ENEE0000  CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no referral
          GOTO      ENEE9000 IF EQUAL
.
ENEE0500  CALL      ENCD0000              * Use contact date times/duration
.
          MOVE      ALREVISN,DIM8
.
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      SP70,DIM5
          PACK      KEY5,ANSC,ANSC,OTHECART,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDASC2,DIM5          * Associated field 2
          ENDIF
.
          MATCH     SP70,DIM5
          IF        @EQUAL
            MOVE      ONE,DIM5
          ENDIF 
.
          MOVE      SP70,DIM8A
          MATCH     SP70,OTBBCITM
          IF        !@EQUAL
            PACK      DIM8A,OTBBCITM,COLON,ZERO,ZERO
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM20
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM20,DIM10A,SP1,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      SP70,DIM8C
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8C,OTBBASTM,COLON,ZERO,ZERO
          ENDIF
.
          MATCH     SP70,DIM8A         * Check in time blank
          IF        !@EQUAL
            MOVE      DIM8C,DIM8A      * Use time seen
          ENDIF
.
          MOVE      SP70,DIM4
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          IF        OVRCD<>1
            UNPACK    PTMXSLAC,DIM4                * Year last Psych adm
          ENDIF
.
          MOVE      "55",OBJECTTY                * Service event
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OTHECART,SP70,SP70
.
          UNPACK    OBABKDTE,DIM13
          PACK      DIM16,OBADATE,OBATIME,COLON,ZERO,ZERO
          MATCH     OBABKDTE,DIM16
          IF        @LESS
            PACK      DIM13,OBADATE,OBATIME * Use booking date not created date
          ENDIF                             * as it's a back dated appt
          REP       ": ",DIM13
          SQUEEZE   DIM13
          UNPACK    DIM13,D2,DIM10D        * Remove century
          PACK      DIM12,DIM10D,SP70      * YYMMDDHHMM(2 chars not used)
          SQUEEZE   DIM12
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM8
          SQUEEZE   DIM10A
          SQUEEZE   OTBBASTM
          SQUEEZE   DIM5
          SQUEEZE   DIM8A
          STRIP     DIM20
          SQUEEZE   DIM8C
          SQUEEZE   DIM5
          SQUEEZE   OTBBCITM
          SQUEEZE   DIM4
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID 
                             DIM8,TILDA:         * ENCOUNTER_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * EVENT_RECORD_ID 
                             PTCNNSSI,TILDA:     * REQ_FOR_SERVICE_SOURCE_ID 
                             DIM8,TILDA:     * REQ_FOR_SERVICE_RECORD_ID 
                             TILDA:          * WAIT_LIST_SERVICE_EVENT_TYPE_CODE
                             TILDA:          * WAIT_LIST_BOOKING_SOURCE_ID 
                             TILDA:          * WAIT_LIST_BOOKING_RECORD_ID 
                             PTCNNSSI,TILDA:     * PLANNED_EVENT_OFFER_SOURCE_ID
                             VISITNUM,DIM12:
                             TILDA:              * PLANNED_EVENT_OFFER_RECORD_ID
                             TILDA:              * SERVICE_CHAPTER_SOURCE_ID 
                             TILDA:              * SERVICE_CHAPTER_RECORD_ID 
                             DIM10A,SP1,DIM8C:   * SERVICE_EVENT_START_DATETIME
                             TILDA:
                             DIM20,TILDA:        * SERVICE_EVENT_END_DATETIME 
                             ANSY,TILDA:         * COLLABORATIVE_CARE_FLAG 
                             DIM5,TILDA:         * CARE_TYPE_NHDD_CODE 
                             NINE,TILDA:         * PREV_SPEC_TREATMENT_CODE 
                             DIM4,TILDA:         * YEAR_LAST_ADMIT_TO_PSYC 
                             SEVEN,TILDA:        * TREATMENT_PURPOSE_CODE 
                             TILDA:       * WEIGHT_AT_SERVICE_EVENT_START_GRAMS 
                             NINE,NINE,TILDA:    * PRIM_PROG_FUNDING_SOURCE_CODE
                             TILDA:              * CLIENT_MODE_OF_ARRIVAL_CODE 
                             DIM10A,SP1,DIM8A:
                             TILDA:              * CLIENT_ARRIVAL_DATETIME 
                             DIM20:           
                             SP900               * CLIENT_DEPARTURE_DATETIME
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENEE0500 IF NOT EQUAL
.
ENEE9000  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENEE9999  RETURN
+
.******************************************************************************
. ENFF0000 - 56 Service activity
.******************************************************************************
ENFF0000  MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
          MOVE      "56 ",DELETOBJ                * Service activity
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENFF9500 IF EQUAL
.
ENFF0500  CALL      ENCD0000              * Use contact date times/duration
.
          MOVE      ALREVISN,DIM8
.
          MOVE      ONE,F2
          MOVE      SP70,DIM9
          PACK      KEY18,ALENVISN,ALENENCT,SP70
          CALL      RDALITM1
ENFF1000  CALL      RKALITM1
          BRANCH    OVRCD,ENFF9000
.
          MATCH     ALITVISN,ALENVISN
          GOTO      ENFF9000 IF NOT EQUAL  
.
          MATCH     ALITENCN,ALENENCT
          GOTO      ENFF9000 IF NOT EQUAL  
.
          MATCH     SP70,ALITITMN
          GOTO      ENFF1000 IF EQUAL
.
          MOVE      ALITITMN,DIM9
          MOVE      F2,DIM2
          REP       " 0",DIM2
          ADD       ONE,F2
.
ENFF3000  MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      "7452-001",DIM8C
          MOVE      "11153",DIM5
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      SP70,DIM5A
          MOVE      SP70,DIM8A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
            PACK      DIM5A,OTBBASTM,SP70
            REP       ": ",DIM5A
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      ALENDIUN,DIM6
.
          MOVE      OBADOCT,DIM10
          MATCH     SP70,OTBBADCS
          IF        !@EQUAL
            MOVE      OTBBADCS,DIM10
          ENDIF
          MATCH     SP70,ALENHCP
          IF        !@EQUAL
            MOVE      ALENHCP,DIM10
          ENDIF
.
          MOVE      OTHEHCLI,DIM20
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM5A
          SQUEEZE   DIM8
          SQUEEZE   DIM6
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM8C
          SQUEEZE   DIM9
          SQUEEZE   DIM10
          SQUEEZE   DIM20
          SQUEEZE   OTBBASTM
.
          MOVE      "56",OBJECTTY                * Service activity
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSI,SP70,SP70

          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID 
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID 
                             PTCNNSSI,TILDA:     * SERVICE_ACTIVITY_SOURCE_ID 
                             VISITNUM,DIM9:
                             DIM10,OBADATE:
                             DIM5A,TILDA:    * SERVICE_ACTIVITY_RECORD_ID 
                             DIM2,TILDA:     * SERVICE_ACTIVITY_SEQUENCE_NUMBER 
                             DIM8C,TILDA:    * SERVICE_ACTIVITY_REF_SOURCE_ID 
                             DIM5,TILDA:     * SERVICE_ACTIVITY_REF_DOMAIN_ID 
                             DIM9,TILDA:          * SERVICE_ACTIVITY_CODE 
                             ZERO,FOUR,TILDA: * SERVICE_ACTIVITY_SOURCE_CODE 
                             ONE,TILDA:       * SERVICE_ACTIVITY_TYPE_CODE 
                             TILDA:           * SERVICE_ACTIVITY_COMMENTS 
                             DIM6,TILDA:      * SERVICE_ACTIVITY_DURATION 
                             DIM10A,SP1,DIM8A: 
                             TILDA:           * SERVICE_ACTIVITY_START_DATETIME
                             DIM10A,SP1,DIM8B: 
                             SP900            * SERVICE_ACTIVITY_END_DATETIME
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      "56",OBJECTTY                * Service activity
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,ALITITMC,ALITITMN:
                             ANSO,SP70,SP70

          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID
                             PTCNNSSI,TILDA:     * SERVICE_ACTIVITY_SOURCE_ID
                             VISITNUM,DIM9:
                             DIM20,OBADATE:
                             DIM5A,TILDA:    * SERVICE_ACTIVITY_RECORD_ID
                             DIM2,TILDA:     * SERVICE_ACTIVITY_SEQUENCE_NUMBER
                             DIM8C,TILDA:    * SERVICE_ACTIVITY_REF_SOURCE_ID
                             DIM5,TILDA:     * SERVICE_ACTIVITY_REF_DOMAIN_ID
                             DIM9,TILDA:          * SERVICE_ACTIVITY_CODE
                             ZERO,FOUR,TILDA: * SERVICE_ACTIVITY_SOURCE_CODE
                             ONE,TILDA:       * SERVICE_ACTIVITY_TYPE_CODE
                             TILDA:           * SERVICE_ACTIVITY_COMMENTS
                             DIM6,TILDA:      * SERVICE_ACTIVITY_DURATION
                             DIM10A,SP1,DIM8A:
                             TILDA:           * SERVICE_ACTIVITY_START_DATETIME
                             DIM10A,SP1,DIM8B:
                             SP900            * SERVICE_ACTIVITY_END_DATETIME
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      ENFF1000
.
ENFF9000  CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENFF0500 IF NOT EQUAL
.
ENFF9500  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENFF9999  RETURN
+
.******************************************************************************
. ENGG0000 - 58 Service event CHOH
.******************************************************************************
ENGG0000  CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENGG9000 IF EQUAL
.
ENGG0500  CALL      ENCD0000              * Use contact date times/duration
.
          MOVE      ALREVISN,DIM8
.
          MOVE      SP70,DIM1
          MOVE      SP70,DIM1B
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ENGG2100
.
          MATCH     "N",TCINDC1
          IF        @EQUAL
            MOVE     "1",DIM1
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            MOVE     "2",DIM1
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            MOVE     "2",DIM1
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        @EQUAL
            MOVE     "2",DIM1
          ENDIF
.
          MOVE      TCINDC7,DIM1B
.
ENGG2100  PACK      KEY5,CATZI,ALENUC35,SP70   * Use ind 7 from OBAVISIT
          CALL      RDCODE1                   
          IF        OVRCD<>1
            MATCH    SP70,TCINDC7              
            IF       !@EQUAL
              MOVE     TCINDC7,DIM1B    * Use ind 7 from ALENUC35 if populated
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM18
          MATCH     "2",DIM1B               * Group Session
          IF        @EQUAL
             UNPACK   OBASTRT,HOURD,D1,MIN
             PACK     DIM18,OBACLIN,OBADATE,HOURD,MIN,SP70
          ENDIF
.
          MOVE      SP70,DIM3
          PACK      KEY5,CATZN,ALENUC40,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM3              * HDP pos 1, 2 and 3 
          ENDIF
.
          MOVE      SP70,DIM2A
          PACK      KEY5,CATZL,ALENUC38,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM2A             * HDP pos 1 and 2
          ENDIF
.
          MOVE      SP70,DIM1A
          PACK      KEY5,CATZK,ALENUC37,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM1A             * HDP pos 1 
          ENDIF
.
          MOVE      SP70,DIM4
          PACK      KEY5,ANSC,ANSG,OCTGRP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDASC1,DIM4             * Associated Field 1
          ENDIF
.
          MOVE      SP70,DIM2B
          PACK      KEY5,ANSO,ANSZ,OTBBOUTC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM2B            * HDP pos 1 to 2
          ENDIF
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      SP70,DIM6
          IF        ALENDIUN=0
            MOVE      ZERO,DIM6                   * No direct contact
          ENDIF
.
          IF        ALENDIUN>=1 & ALENDIUN <=10
            MOVE     ONE,DIM6                    * Brief
          ENDIF
.
          IF        ALENDIUN>=11 & ALENDIUN <=20
            MOVE     TWO,DIM6                    * Short
          ENDIF
.
          IF        ALENDIUN>=21 & ALENDIUN <=40
            MOVE     THREE,DIM6                  * Medium
          ENDIF
.
          IF        ALENDIUN>=41 & ALENDIUN <=60
            MOVE     FOUR,DIM6                   * Long
          ENDIF
.
          IF        ALENDIUN>60
            MOVE     FIVE,DIM6                   * Prolonged
          ENDIF
.
          MOVE      SP70,DIM6A
          IF        ALENINUN=0
            MOVE      ZERO,DIM6A                 * No direct contact
          ENDIF
.
          IF        ALENINUN>=1 & ALENINUN <=10
            MOVE     ONE,DIM6A                   * Brief
          ENDIF
.
          IF        ALENINUN>=11 & ALENINUN <=20
            MOVE     TWO,DIM6A                   * Short
          ENDIF
.
          IF        ALENINUN>=21 & ALENINUN <=40
            MOVE     THREE,DIM6A                 * Medium
          ENDIF
.
          IF        ALENINUN>=41 & ALENINUN <=60
            MOVE     FOUR,DIM6A                  * Long
          ENDIF
.
          IF        ALENINUN>60
            MOVE     FIVE,DIM6A                  * Prolonged
          ENDIF
.
          MOVE      SP70,DIM8A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
          ENDIF
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM1
          SQUEEZE   DIM1A
          SQUEEZE   DIM1B
          SQUEEZE   DIM2
          SQUEEZE   DIM2A
          SQUEEZE   DIM3
          SQUEEZE   DIM4
          SQUEEZE   DIM6
          SQUEEZE   DIM6A
          SQUEEZE   DIM8
          SQUEEZE   DIM8A
          SQUEEZE   DIM10A
          SQUEEZE   DIM18
          SQUEEZE   OBAVISIT
.
          MOVE      "58",OBJECTTY                * Service event CHOH
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,ANSC,ANSH,ANSO:
                             ANSH,SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID 
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID 
                             OBAVISIT,TILDA:     * APPOINTMENT_TYPE_LOCAL_CODE 
                             DIM1,TILDA:   * INITIAL_OR_SUBSEQUENT_SERVICE_CODE 
                             DIM3,TILDA:   * PRIMARY_SETTING_TYPE_CODE 
                             DIM2A,TILDA:  * SERVICE_CONTACT_MODE_CODE  
                             DIM6,TILDA:  * DIRECT_CONTACT_TIME_BAND_CODE 
                             DIM6A,TILDA:  * INDIRECT_CONTACT_TIME_BAND_CODE
                             DIM1B,TILDA:     * GROUP_SESSION_FLAG  
                             DIM18,TILDA:     * GROUP_SESSION_ID 
                             TILDA:           * GROUP_LOCAL_ID 
                             TILDA:           * GROUP_REASON_CODE 
                             TILDA:           * GROUP_TARGET_POPULATION_CODE 
                             TILDA:           * GROUP_RECIPIENT_TYPE_CODE 
                             DIM1A,TILDA:     * CLIENT_PARTICIPATED_FLAG 
                             DIM4,TILDA:      * NAP_SERVICE_TYPE_CODE 
                             TILDA:           * CLIENT_CALLED_DATETIME 
                             DIM10A,SP1,DIM8A: * CLIENT_SEEN_DATETIME 
                             TILDA:
                             DIM2B:           * CHOC_EVENT_DISPOSITION_CODE 
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENGG0500 IF NOT EQUAL
.
ENGG9000  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENGG9999  RETURN
+
.******************************************************************************
. ENHH0000 - 60 Service event attribute
.******************************************************************************
ENHH0000  CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENHH9000 IF EQUAL
.
ENHH0500  CALL      ENCD0000              * Use contact date times/duration
.
          MOVE      ALREVISN,DIM8
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      OBADATE,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      SP70,DIM8A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot
          IF        @EQUAL
            CALL      STDUR000
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      SP70,DIM10
          PACK      KEY5,ANSC,ANSL,ALENCOMP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF4,DIM10             * User defined field 4
          ENDIF
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM8
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM10A 
          SQUEEZE   OTBBASTM
          SQUEEZE   DIM10
          SQUEEZE   ALENCOMP
 
          MOVE      "60",OBJECTTY                * Service event attribute
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OBADATE,ZERO,ONE:
                             SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID 
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID 
                             VISITNUM,DASH:
                             ZERO,ONE,TILDA:     * EVENT_ATTRIBUTE_RECORD_ID 
                             ZERO,ONE,TILDA:     * EVENT_ATTRIBUTE_TYPE_CODE 
                             ALENCOMP,TILDA:     * EVENT_ATTRIBUTE_LOCAL_CODE
                             DIM10,TILDA:        * EVENT_ATTRIBUTE_CODE 
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME 
                             DIM10A,SP1,DIM8B:* EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
....      MOVE      "60",OBJECTTY                * Service event attribute
....      PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OBADATE,ZERO,TWO:
....                         SP70,SP70
....
....      PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
....                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
....                         DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
....                         VISITNUM,DASH:
....                         ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID
....                         VISITNUM,DASH:
....                         ZERO,TWO,TILDA:     * EVENT_ATTRIBUTE_RECORD_ID
....                         ZERO,TWO,TILDA:    * EVENT_ATTRIBUTE_TYPE_CODE
....                         TEN4,TILDA:        * EVENT_ATTRIBUTE_LOCAL_CODE
....                         TEN4,TILDA:        * EVENT_ATTRIBUTE_CODE
....                         DIM10A,SP1,DIM8A:
....                         TILDA:              * EFFECTIVE_START_DATETIME
....                         DIM10A,SP1,DIM8B:    * EFFECTIVE_END_DATETIME
....                         SP900
....
....      PACK      SRCRDATE,ALENCDAT,SP70
....      PACK      SRCRTIME,ALENCTIM,SP70
....      PACK      SRMDDATE,ALENCDAT,SP70
....      PACK      SRMDTIME,ALENCTIM,SP70
....
....      CALL      OPSD0000               * Set source modified date
....
....      MOVE      SP70,OBJECTRT
....      CALL      WRCOND00     * write record to container detail table
.
          MATCH     SP70,OTHEHCAI
          IF        @EQUAL
            MOVE      PTCNNECI,DIM20
          ELSE
            MOVE      OTHEHCAI,DIM20
          ENDIF
.
          SQUEEZE   DIM20
.
          MOVE      "60",OBJECTTY                * Service event attribute
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OBADATE,ZERO,FOUR:
                            SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID
                             VISITNUM,DASH:
                             ZERO,FOUR,TILDA:    * EVENT_ATTRIBUTE_RECORD_ID
                             ZERO,FOUR,TILDA:    * EVENT_ATTRIBUTE_TYPE_CODE
                             DIM20,TILDA:        * EVENT_ATTRIBUTE_LOCAL_CODE
                             DIM20,TILDA:        * EVENT_ATTRIBUTE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME
                             DIM10A,SP1,DIM8B:    * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      SP70,SP10
          PACK      KEY5,CATZN,ALENUC40,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM10              * HDP
          ENDIF
.
          SQUEEZE   ALENUC40
          SQUEEZE   DIM10
.
          MOVE      "60",OBJECTTY                * Service event attribute
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OBADATE,ZERO,FIVE:
                             SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID
                             VISITNUM,DASH:
                             ZERO,FIVE,TILDA:    * EVENT_ATTRIBUTE_RECORD_ID
                             ZERO,FIVE,TILDA:    * EVENT_ATTRIBUTE_TYPE_CODE
                             ALENUC40,TILDA:     * EVENT_ATTRIBUTE_LOCAL_CODE
                             DIM10,TILDA:         * EVENT_ATTRIBUTE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME
                             DIM10A,SP1,DIM8B:   * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      SP70,DIM10B
          PACK      KEY5,CATZL,ALENUC38,SP70
          CALL      RDCODE1                      * Delivery Mode
          BRANCH    OVRCD,ENHH0900
.
          MATCH    "2",THCSCOD
          IF       @EQUAL
            MOVE     "2",DIM10B
            GOTO      ENHH1000
          ENDIF
.
          MATCH    ANSC,THCSCOD
          IF       @EQUAL
            MOVE     "2",DIM10B
            GOTO      ENHH1000
          ENDIF
.
ENHH0900  MATCH     SP70,OTHEHCAI
          IF        @EQUAL
            MOVE      "1",DIM10B
            GOTO      ENHH1000
          ENDIF
.
          MATCH     "3024464",OTHEHCAI
          IF        @EQUAL
            MOVE      "1",DIM10B
            GOTO      ENHH1000
          ENDIF
.       
          MOVE      "2",DIM10B
.
ENHH1000  SQUEEZE   DIM10B
.
          MOVE      "60",OBJECTTY                * Service event attribute
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,OBADATE,ZERO,SIX:
                             SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * SERVICE_EVENT_RECORD_ID
                             VISITNUM,DASH:
                             ZERO,SIX,TILDA:     * EVENT_ATTRIBUTE_RECORD_ID
                             ZERO,SIX,TILDA:     * EVENT_ATTRIBUTE_TYPE_CODE
                             TILDA:              * EVENT_ATTRIBUTE_LOCAL_CODE
                             DIM10B,TILDA:       * EVENT_ATTRIBUTE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME
                             DIM10A,SP1,DIM8B:   * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENHH0500 IF NOT EQUAL
.
ENHH9000  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENHH9999  RETURN
+
.******************************************************************************
. ENII0000 - 63 Service event provider
.******************************************************************************
ENII0000  MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
          MOVE      "63 ",DELETOBJ          * Service event provider
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      ENII9000 IF EQUAL
.
          MOVE      ONE,FIRSTENC            * First Encounter
.
ENII0500  CALL      ENCD0000              * Use contact date times/duration
.
          MOVE      ALREVISN,DIM8
          MOVE      OBAOUTNO,VISITNUM
          MOVE      ALENENCT,ENCTRNUM
.
          MOVE      "9475-001",DIM8C
          MOVE      PTCNNIAI,DIM20
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      SP70,DIM8A
          MATCH     SP70,OTBBASTM
          IF        !@EQUAL
            PACK      DIM8A,OTBBASTM,COLON,ZERO,ZERO
          ENDIF
.
          MATCH     SP70,OTBBDPTM      * Calculate departure time from slot 
          IF        @EQUAL
            CALL      STDUR000        
          ENDIF
.
          MOVE      SP70,DIM8B
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      DIM8B,OTBBDPTM,COLON,ZERO,ZERO
          ENDIF
.
          SQUEEZE   VISITNUM
          SQUEEZE   ENCTRNUM
.
          SQUEEZE   DIM8
          SQUEEZE   DIM8A
          SQUEEZE   DIM8B
          SQUEEZE   DIM20
          SQUEEZE   OTBBASTM
          SQUEEZE   OBACLIN
          SQUEEZE   ALENHCP
.
          MOVE      "63",OBJECTTY                * Service event provider
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,OBAOUTNO,ALENENCT,ANSO:
                             DIM20,SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID 
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * EVENT_RECORD_ID 
                             VISITNUM,DASH:
                             ENCTRNUM,DIM20:
                             TILDA:              * EVENT_PROVIDER_RECORD_ID
                             ANSO,TILDA:         * SERVICE_PROVIDER_TYPE_CODE 
                             ONE,ZERO,ZERO:
                             TILDA:              * PROVIDER_ID_TYPE_CODE 
                             DIM8C,TILDA:        * SERVICE_PROVIDER_SOURCE_ID 
                             DIM20,TILDA:        * SERVICE_PROVIDER_ID 
                             TILDA:              * ISP_DISC_SPEC_CODE
                             PTCNNIAI,TILDA:     * OSP_LOCAL_ID 
                             OBACLIN,TILDA:      * OSP_CHOC_SESSION_LOCAL_ID 
                             ANSN,TILDA:         * RESPONSIBLE_PROVIDER_FLAG 
                             TWO,TILDA:          * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME 
                             DIM10A,SP1,DIM8B:   * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MATCH     SP70,OTHEHCLI
          IF        @EQUAL
            MOVE      PTCNNCPP,DIM20
          ELSE
            MOVE      OTHEHCLI,DIM20
          ENDIF
.
          SQUEEZE   DIM20
.
          MOVE      "63",OBJECTTY                * Service event provider
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,OBAOUTNO,ALENENCT,ANSO:
                             DIM20,SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * EVENT_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,DIM20:
                             TILDA:              * EVENT_PROVIDER_RECORD_ID
                             ANSO,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO:
                             TILDA:              * PROVIDER_ID_TYPE_CODE
                             DIM8C,TILDA:        * SERVICE_PROVIDER_SOURCE_ID
                             DIM20,TILDA:        * SERVICE_PROVIDER_ID
                             TILDA:              * ISP_DISC_SPEC_CODE
                             PTCNNIAI,TILDA:     * OSP_LOCAL_ID
                             OBACLIN,TILDA:      * OSP_CHOC_SESSION_LOCAL_ID
                             ANSY,TILDA:         * RESPONSIBLE_PROVIDER_FLAG
                             ONE,TILDA:          * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME
                             DIM10A,SP1,DIM8B:   * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      SP70,DIM10
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ENII4000

          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ENII4000
.
          MOVE      PTCDUDF3,DIM10
.
ENII4000  MATCH     SP70,ALRERDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALRERDEP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    SP70,PTCDUDF3
              IF       !@EQUAL
                MOVE     PTCDUDF3,DIM10
              ENDIF
            ENDIF
          ENDIF
.
          IF        FIRSTENC=1
            MOVE      ANSY,DIM1
          ELSE
            MOVE      ANSN,DIM1
          ENDIF
.
          SQUEEZE   DIM10
.
          MOVE      "63",OBJECTTY                * Service event provider
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,OBAOUTNO,ALENENCT,ANSI:
                             SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_EVENT_SOURCE_ID
                             DIM8,TILDA:         * SERVICE_ENCOUNTER_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,TILDA:     * EVENT_RECORD_ID
                             VISITNUM,DASH:
                             ENCTRNUM,DASH:
                             ALENHCP,TILDA:      * EVENT_PROVIDER_RECORD_ID
                             ANSI,TILDA:         * SERVICE_PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE:
                             TILDA:              * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * SERVICE_PROVIDER_SOURCE_ID
                             ALENHCP,TILDA:      * SERVICE_PROVIDER_ID
                             DIM10,TILDA:        * ISP_DISC_SPEC_CODE
                             TILDA:              * OSP_LOCAL_ID
                             TILDA:              * OSP_CHOC_SESSION_LOCAL_ID
                             DIM1,TILDA:         * RESPONSIBLE_PROVIDER_FLAG
                             TWO,TILDA:          * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,DIM8A:
                             TILDA:              * EFFECTIVE_START_DATETIME
                             DIM10A,SP1,DIM8B:   * EFFECTIVE_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70 
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      ZERO,FIRSTENC           * Not the first Encounter
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      ENII0500 IF NOT EQUAL
.
ENII9000  PACK      KEY8,OBAOUTNO,SP70      * Restore original date/times after
          CALL      RDBOKB1                 * encounter date/time override
.
ENII9999  RETURN
.
.------------------------------------------------------------
. Calculate booking end time if no departure time captured
.------------------------------------------------------------
STDUR000  MATCH     SP70,OBAVISIT
          GOTO      STDUR999 IF EQUAL
.
          MATCH     SP70,OTBBASTM
          GOTO      STDUR999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      ZERO,LOOPCNTR
.
          UNPACK    OTBBASTM,KEY2,KEY1,MIN   * HH:MM
STDUR100  MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       OTHEDURN,MINUTES   * Add Duration time to minutes
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            IF        TIME >= 60
              MOVE      TIME,MINUTES
              ASSIGN    MINUTES-SIXTY,TIME
              MOVE      TIME,MINTIMEF
              MOVE      MINTIMEF,MIN
              ADD       TWO,HOUR                 * Add Two Hours
            ELSE
              MOVE      TIME,MINTIMEF
              MOVE      MINTIMEF,MIN
              ADD       ONE,HOUR                 * Add One Hour
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIMEF            * No Hour Change
            MOVE      MINTIMEF,MIN
          ENDIF
.
          PACK      ENDDTIME,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REP       " 0",ENDDTIME            * replace spaces with zero
          PACK      OTBBDPTM,HOUR,COLON,MIN
          REP       " 0",OTBBDPTM   
.
          ADD       ONE,LOOPCNTR
.
          COMPARE   TCFORM6,LOOPCNTR
          IF        @LESS
            UNPACK    ENDDTIME,KEY2,KEY1,MIN   * HH:MM
            GOTO      STDUR100
          ENDIF
.
STDUR999  RETURN
+
.******************************************************************************
. ENJJ0000 - 73 Service event offer
.*****************************************************************************
ENJJ0000  MOVE      OBAOUTNO,DIM8
.
          IF        OBASTAT=1 | OBASTAT=6 
            MOVE      "00",DIM5              * Booked/Suspended
          ENDIF
.
          IF        OBASTAT=4
            MOVE      "01",DIM5              * Attended
          ENDIF
.
          IF        OBASTAT=5
            MOVE      "05.04",DIM5           * DNA
          ENDIF
.
          IF        OBASTAT=5 & RESCFLAG=1
            MOVE      SP70,DIM5              * DNA due to a reschedule
            MATCH     SP70,OPRSREAS
            IF        !@EQUAL
              PACK      KEY5,ANSR,ANSR,OPRSREAS,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE     PTCDUDF3,DIM5      * Report reschedule reason
              ENDIF
            ENDIF
          ENDIF
.
          UNPACK    OBABKDTE,DIM8A,DIM8B
          UNPACK    OBABKDTE,DIM13
          PACK      DIM16,OBADATE,OBATIME,COLON,ZERO,ZERO
.
          MOVE      DIM8A,DATFIELD           * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          MOVE      OBADATE,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10C          * CCYY-MM-DD
.
          PACK      DIM8C,OBATIME,COLON,ZERO,ZERO
.
          MATCH     OBABKDTE,DIM16
          IF        @LESS
            PACK      DIM13,OBADATE,OBATIME
            MOVE      DIM10C,DIM10B         * Use booking date not created date
            MOVE      DIM8C,DIM8B           * as it's a back dated appt
          ENDIF
.
          MOVE      ALREVISN,VISITNUM
.
          SQUEEZE   DIM5
          SQUEEZE   DIM8
          SQUEEZE   VISITNUM
          SQUEEZE   OTBBOUTC
          SQUEEZE   DIM10C
          SQUEEZE   DIM8C
          SQUEEZE   DIM10B
          SQUEEZE   DIM8B
          REP       ": ",DIM13
          SQUEEZE   DIM13
.
          UNPACK    DIM13,D2,DIM10D        * Remove century
          PACK      DIM12,DIM10D,SP70      * YYMMDDHHMM(2 chars not used)
          SQUEEZE   DIM12
.
          MOVE      DIM10C,DIM10E          * OFFER_OUTCOME_DATETIM
          MOVE      DIM8C,DIM8E
.
.         DNA rescheduled record offer outcome date
.
          IF        RESCFLAG=1 & OBASTAT=5
            MOVE      OPRSRDTE,DATFIELD        * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10E          * CCYY-MM-DD
.                                                * Use actual date and time of
            MOVE      OPRSRTIM,DIM8E           * reschedule
          ENDIF
.
.  Set DNA offer outcome date/time to source modified date/time
.  Use rules from WRCOND00 to determine source modified date
          IF        RESCFLAG<>1 & OBASTAT=5
            PACK      SRCRDATE,PMVXCDTE,SP70
            PACK      SRCRTIME,PMVXCTIM,SP70
            CALL      OPSD0000                 * Get source modified date
.
            MATCH     SP1,SRCRDATE
            IF        @EQUAL
              PACK      SRCRDATE,ENDDATE
              MOVE      "23:59:00",SRCRTIME
            ENDIF
.
            MATCH     ANSD,OBJECTRT             * delete ?
            IF        !@EQUAL
              MOVE      "73",OBJECTTY                * Planned event offer
              PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,OBABKDTE,SP70,SP70
              PROC      CHKFIRST                * has record been sent before
            ENDIF
.
. Retain the source modifed time of 00:00:00 if the source created
. time is 00:00:00 (Add records)
.
            MATCH     "00:00:00",SRMDTIME
            IF        @EQUAL
              MATCH     "00:00:00",SRCRTIME
              IF        !@EQUAL
                MOVE      "23:59:00",SRMDTIME
              ENDIF
            ENDIF
.
            MOVE      SRMDDATE,DATFIELD        * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10E          * CCYY-MM-DD
            MOVE      SRMDTIME,DIM8E           * Use source modified date
          ENDIF
.
          SQUEEZE   DIM10E
          SQUEEZE   DIM8E
.
          MOVE      "73",OBJECTTY                * Planned event offer
          PACK      OBJECTKY,FOUR,ALREVISN,OBAOUTNO,OBABKDTE,SP70,SP70
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * PLANNED_EVENT_OFFER_SOURCE_ID
                             DIM8,DIM12:
                             TILDA:              * PLANNED_EVENT_OFFER_RECORD_ID
                             DIM10B,SP1,DIM8B:
                             TILDA:              * OFFER_ISSUED_DATETIME
                             OTBBOUTC,TILDA:     * OFFER_OUTCOME_LOCAL_CODE
                             DIM5,TILDA:         * OFFER_OUTCOME_CODE
                             DIM10E,SP1,DIM8E:
                             TILDA:              * OFFER_OUTCOME_DATETIME
                             DIM10C,SP1,DIM8C:
                             TILDA:              * SERVICE_EVENT_START_DATETIME
                             DIM10C,SP1,DIM8C:
                             TILDA:              * PRIMARY_INTERVENTION_DATETIME
                             PTCNNSSI,TILDA:     * REQUEST_FOR_SERVICE_SOURCE_ID
                             VISITNUM,TILDA:     * REQUEST_FOR_SERVICE_RECORD_ID
                             TILDA:              * WL_SERVICE_EVENT_TYPE_CODE
                             TILDA:              * WL_BOOKING_SOURCE_ID
                             SP900               * WL_BOOKING_RECORD_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70 
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          MOVE      SP70,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      ZERO,RESCFLAG
.
ENJJ9999  RETURN
+
.******************************************************************************
.* OMRG0000 - Loop patmrgaf and pmsadwaf and process any OP visit PMI merges
.******************************************************************************
OMRG0000  PACK      KEY25,STRTDATE,SP70
          CALL      RSPTMRG3
OMRG1000  CALL      RKPTMRG3                * Loop merge file
          BRANCH    OVRCD,OMRG5000
.
          MATCH     PTMRRDTE,ENDDATE        * Date created
          GOTO      OMRG5000 IF LESS
.
          PACK      KEY6,SP70
          CALL      RDSSITA1
OMRG1500  CALL      RDKSITA1                * Loop all sites
          BRANCH    OVRCD,OMRG1000
.
          MOVE      OSTSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
          PACK      KEY36,PTMRNWUR,SP70
          CALL      RDSBOKA3
OMRG2000  CALL      RDKBOKA3                * Look for all bookings
          BRANCH    OVRCD,OMRG1500
.
          MATCH     OBAURNO,PTMRNWUR        * Correct U/R
          GOTO      OMRG1500 IF NOT EQUAL
.
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                * Find linked referral
          BRANCH    OVRCD,OMRG2000
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      OMRG2000 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                * Read linked referral
          BRANCH    OVRCD,OMRG2000
.
          MOVE      "5  ",CHANGSTM                     * 5= Non admitted     
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "18",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,FOUR,ALREVISN,SP70,SP70   * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME059,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      OMRG2000 IF EQUAL
.
OMRG2500  MOVE      "5  ",CHANGSTM                     * 5= Non admitted
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT:
                             ZERO,ONE,SIX:
                             SP70,SP70                 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME059,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      OMRG2500 IF NOT EQUAL
.
          GOTO      OMRG2000
.
OMRG5000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
OMRG6000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,OMRG9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      OMRG9999 IF LESS
.
          MATCH     "12",PMAWTYPE            * AH Referral Changed U/R
          GOTO      OMRG8000 IF EQUAL
.
          MATCH     "10",PMAWTYPE            * OP Visit Changed U/R
          GOTO      OMRG6000 IF NOT EQUAL
.
          PACK      KEY6,SP70
          CALL      RDSSITA1
OMRG6500  CALL      RDKSITA1                * Loop all sites
          BRANCH    OVRCD,OMRG6000
.
          MOVE      OSTSITE,CHECKSIT
          CALL      COTFIL00                * Open OP files
.
          PACK      KEY36,PMAWVISN,SP70
          CALL      RDSBOKA6
OMRG7000  CALL      RDKBOKA6                * Look for all bookings
          BRANCH    OVRCD,OMRG6500
.
          MATCH     PMAWVISN,DOBAOUTN
          GOTO      OMRG6500 IF NOT EQUAL
.
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                * Find linked referral
          BRANCH    OVRCD,OMRG6000
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      OMRG6000 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                * Read linked referral
          BRANCH    OVRCD,OMRG6000
.
          MOVE      "5  ",CHANGSTM                     * 5= Non admitted
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "18",CHANGCOL                      * Change column
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,FOUR,ALREVISN,SP70,SP70   * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          CALL      ENEN0000                * Get first Enc
          MATCH     SP70,ALENVISN           * Don't report if no encounter
          GOTO      OMRG6000 IF EQUAL
.
OMRG7500  MOVE      "5  ",CHANGSTM                     * 5= Non admitted
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT:
                             ZERO,ONE,SIX:
                             SP70,SP70                 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          CALL      ENXT0000                * Get next Enc
          MATCH     SP70,ALENVISN           * Don't report if no more encounters
          GOTO      OMRG7500 IF NOT EQUAL
.
          GOTO      OMRG6000
.
OMRG8000  PACK      KEY8,PMAWVISN,SP70
          CALL      RDALREF1                * Read linked referral
          BRANCH    OVRCD,OMRG6000
.
          MOVE      "5  ",CHANGSTM                     * 5= Non admitted
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "18",CHANGCOL                      * Change column
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,FOUR,ALREVISN,SP70,SP70   * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          GOTO      OMRG6000
.
OMRG9999  RETURN
+
.******************************************************************************
.* CCHG0000 - Loop pmsadwaf by date and find AH contacts that have 
.*            been deleted/updated after the created date to report
.******************************************************************************
CCHG0000  MOVE      FOUR,SDATFLAG            * EDWARD visit alteration trigger
.
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
CCHG1000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,CCHG9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      CCHG9999 IF LESS
.
          MATCH     "7  ",PMAWTYPE          * AH Contact Update
          GOTO      CCHG1000 IF NOT EQUAL
.
          UNPACK    PMAWOLDV,DIM8,DIM8A     * Referral and encounter number
.
          PACK      KEY8,DIM8,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CCHG1000
.
          PACK      KEY16,DIM8,DIM8A,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,CCHG1000
.
          MATCH     "1",ALENRSTA            * Cancelled (Deleted)
          GOTO      CCHG2000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ALENCOMP,SP70
          CALL      RDCODE1                      * Read claim code
          BRANCH    OVRCD,CCHG1000
.
          MATCH     "P",TCINDC1              * Don't send deletes as contact
          GOTO      CCHG1000 IF EQUAL        * is public
.
          MATCH     "11",PTCDNHCP            * Don't send deletes as contact
          GOTO      CCHG1000 IF EQUAL        * is reciprocal
.
CCHG2000  MOVE      ALENLINK,OBAOUTNO       * Linked OP visit number
.
          MOVE      "5  ",DELETSTM          * 5= Non Admitted Patient Extract
.
          MOVE      "00:00:00",PMAWCTIM     * Overwrite encounter number
.                                           * that is stored in the time 
          PACK      SRMDDATE,PMAWCDAT,SP70  * Set the source modified date
          PACK      SRMDTIME,PMAWCTIM,SP70  * to the trigger date
.
          MOVE      "54 ",DELETOBJ                * Service activity provider
          PACK      DELETKEY,FOUR,OBAOUTNO,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "55 ",DELETOBJ                * Service event
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "56 ",DELETOBJ                * Service activity
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "57 ",DELETOBJ                * Service activity
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "58 ",DELETOBJ                * Service event CHOH
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "60 ",DELETOBJ                * Service event attribute
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          MOVE      "63 ",DELETOBJ                * Service event provider
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,OBAOUTNO,ALENENCT,SP70,SP70
          CALL      EDDK0000
.
          GOTO      CCHG1000
.
CCHG9999  RETURN
.
.******************************************************************************
.* OPSD0000 - Set source modified date                                  
.******************************************************************************
OPSD0000  IF        SDATFLAG=1
            PACK      SRMDDATE,ALAUADAT,SP70  * Referral audit trigger
            PACK      SRMDTIME,ALAUATIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,OPRSRDTE,SP70  * Reshedule visit trigger
            PACK      SRMDTIME,OPRSRTIM,SP70
          ENDIF
.
          IF        SDATFLAG=3
            PACK      SRMDDATE,OPCNRDTE,SP70  * Cancel visit trigger
            PACK      SRMDTIME,OPCNRTIM,SP70
          ENDIF
.
          IF        SDATFLAG=4
            PACK      SRMDDATE,PMAWCDAT,SP70  * EDWARD visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
OPSD9999  RETURN
.
.******************************************************************************
.* ENCD0000 - Use the encounter date/time if it's not the first encounter
.******************************************************************************
ENCD0000  UNPACK    ALENSTIM,KEY2,KEY1,MIN  * HH:MM
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       ALENDIUN,MINUTES        * Add direct units to minutes
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            IF        TIME >= 540
                MOVE      TIME,MINUTES
                ASSIGN    MINUTES-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-SIXTY,TIME
                MOVE      TIME,MINTIMEF
                MOVE      MINTIMEF,MIN
                ADD       TEN,HOUR                              * Add Ten Hours
            ELSE
              IF        TIME >= 480
                  MOVE      TIME,MINUTES
                  ASSIGN    MINUTES-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  MOVE      TIME,MINTIMEF
                  MOVE      MINTIMEF,MIN
                  ADD       NINE,HOUR                           * Add Nine Hours
              ELSE
                IF        TIME >= 420
                    MOVE      TIME,MINUTES
                    ASSIGN    MINUTES-HUND20,TIME
                    ASSIGN    TIME-HUND20,TIME
                    ASSIGN    TIME-HUND20,TIME
                    ASSIGN    TIME-SIXTY,TIME
                    MOVE      TIME,MINTIMEF
                    MOVE      MINTIMEF,MIN
                    ADD       EIGHT,HOUR                        * Add Eight Hours
                ELSE
                  IF        TIME >= 360
                      MOVE      TIME,MINUTES
                      ASSIGN    MINUTES-HUND20,TIME
                      ASSIGN    TIME-HUND20,TIME
                      ASSIGN    TIME-HUND20,TIME
                      MOVE      TIME,MINTIMEF
                      MOVE      MINTIMEF,MIN
                      ADD       SEVEN,HOUR                     * Add Seven Hours
                  ELSE
                    IF        TIME >= 300
                        MOVE      TIME,MINUTES
                        ASSIGN    MINUTES-HUND20,TIME
                        ASSIGN    TIME-HUND20,TIME
                        ASSIGN    TIME-SIXTY,TIME
                        MOVE      TIME,MINTIMEF
                        MOVE      MINTIMEF,MIN
                        ADD       SIX,HOUR                      * Add Six Hours
                    ELSE
                      IF        TIME >= 240
                         MOVE      TIME,MINUTES
                         ASSIGN    MINUTES-HUND20,TIME
                         ASSIGN    TIME-HUND20,TIME
                         MOVE      TIME,MINTIMEF
                         MOVE      MINTIMEF,MIN
                         ADD       FIVE,HOUR                    * Add Five Hours
                      ELSE
                        IF        TIME >= 180
                           MOVE      TIME,MINUTES
                           ASSIGN    MINUTES-HUND20,TIME
                           ASSIGN    TIME-SIXTY,TIME
                           MOVE      TIME,MINTIMEF
                           MOVE      MINTIMEF,MIN
                           ADD       FOUR,HOUR                  * Add Four Hours
                        ELSE
                          IF        TIME >= 120
                             MOVE      TIME,MINUTES
                             ASSIGN    MINUTES-HUND20,TIME
                             MOVE      TIME,MINTIMEF
                             MOVE      MINTIMEF,MIN
                             ADD       THREE,HOUR              * Add Three Hours
                          ELSE
                            IF        TIME >= 60
                               MOVE      TIME,MINUTES
                               ASSIGN    MINUTES-SIXTY,TIME
                               MOVE      TIME,MINTIMEF
                               MOVE      MINTIMEF,MIN
                               ADD       TWO,HOUR               * Add Two Hours
                            ELSE
                              MOVE      TIME,MINTIMEF
                              MOVE      MINTIMEF,MIN
                              ADD       ONE,HOUR                * Add One Hour
                            ENDIF
                          ENDIF
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIMEF              * No Hour Change
            MOVE      MINTIMEF,MIN
          ENDIF
.
. IF departure time is > 23:59 then hardcode it to 23:59
.
          IF        HOUR >= TWENTY4
            MOVE      TWENTY3,HOUR
            MOVE      FIFTY9,MINTIMEF
            MOVE      MINTIMEF,MIN
          ENDIF
.
          MOVE      ALENSDAT,OBADATE         * New seen date
.
          MOVE      ALENSTIM,OTBBCITM        * New check in time
          MOVE      ALENSTIM,OTBBASTM        * New seen time
.
          PACK      OTBBDPTM,HOUR,COLON,MIN  * New Departure time
          REP       " 0",OTBBDPTM            * replace spaces with zero
.
ENCD9999  RETURN
+
.******************************************************************************
. ENKK0000 - 64 Onward Referrral
.******************************************************************************
ENKK0000  MATCH     "1",PTCNEXED                 * Collect Extra Container Info
          GOTO      ENKK9999 IF NOT EQUAL
.
          COMPARE   FOUR,OBASTAT                     
          GOTO      ENKK9999 IF NOT EQUAL        * Only report if attended
.
          CALL      ENEN0000                     * Get first Enc
          MATCH     SP70,ALENVISN                * Don't report if no encounter
          GOTO      ENKK9999 IF EQUAL
.
          MOVE      "64",OBJECTTY                * ONWARD_REFERRAL
          PACK      OBJECTKY,FOUR,ALREVISN,DOBAOUTN,ONE,ONE,SP70,SP70
.
          MOVE      DOBAOUTN,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID
                             ONE,TILDA:          * REFERRAL_RECORD_ID
                             NINE,NINE,TILDA:    * TARGET_TYPE_CODE
                             TILDA:              * TARGET_OSP_ID_TYPE_CODE
                             TILDA:              * TARGET_OSP_SOURCE_ID
                             TILDA:              * TARGET_OSP_ID
                             TILDA:              * TARGET_ISP_ID_TYPE_CODE
                             TILDA:              * TARGET_ISP_SOURCE_ID
                             TILDA:              * TARGET_ISP_ID
                             SP900               * ISSUED_DATETIME
.
          PACK      SRCRDATE,ALENCDAT,SP70
          PACK      SRCRTIME,ALENCTIM,SP70
          PACK      SRMDDATE,ALENCDAT,SP70
          PACK      SRMDTIME,ALENCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          CALL      WRCOND00     * write record to container detail table
.
ENKK9999  RETURN
+
.******************************************************************************
.* ENLL0000 - 59 PRESENTING_ISSUE
.******************************************************************************
ENLL0000  MATCH     "1",PTCNEXED                 * Collect Extra Container Info
          GOTO      ENLL9999 IF NOT EQUAL
.
          MATCH     SP70,PMVXUDF1                * Dont report if blank
          GOTO      ENLL9999 IF EQUAL
.
          MOVE      "59",OBJECTTY               * PRESENTING_ISSUE
          PACK      OBJECTKY,FOUR,ALREVISN,DOBAOUTN,ONE,DOBAOUTN,PMVXUDF1:
                             SP70,SP70
.
          MOVE      DOBAOUTN,VISITNUM
          SQUEEZE   VISITNUM
          MOVE      PMVXUDF1,DIM50
          STRIP     DIM50
.
          PACK      OBJECTTX,FOUR,TILDA:     * SERVICE_EVENT_TYPE_CODE
                           PTCNNSSI,TILDA:   * SERVICE_EVENT_SOURCE_ID
                           VISITNUM,TILDA:   * SERVICE_ENCOUNTER_RECORD_ID
                           ONE,TILDA:        * SERVICE_EVENT_RECORD_ID
                           VISITNUM,TILDA:   * PRESENTING_ISSUE_RECORD_ID
                           ZERO,ONE,TILDA:   * PRESENTING_ISSUE_SEQUENCE_NUMBER
                           TILDA:            * PRESENTING_ISSUE_START_DATE
                           SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE:
                           TILDA:            * PRESENTING_ISSUE_REF_SOURCE_ID
                           TILDA:            * PRESENTING_ISSUE_REF_DOMAIN_ID
                           TILDA:            * PRESENTING_ISSUE_CODE
                           DIM50:            * PRESENTING_ISSUE_COMMENTS
                           SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          CALL      WRCOND00     * write record to container detail table
.
ENLL9999  RETURN
+
.******************************************************************************
. ENMM0000 - 61 Diagnosis
.******************************************************************************
ENMM0000  MATCH     "1",PTCNEXED                 * Collect Extra Container Info
          GOTO      ENMM9999 IF NOT EQUAL
.
          MOVE      "61 ",DELETOBJ                * Service event
          PACK      DELETKEY,FOUR,ALREVISN,OBAOUTNO,SP70,SP70
          CALL      EDDK0000
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDDIAG1
          BRANCH    OVRCD,ENMM9999
.
          MOVE      ZERO,DIAGCNTR
ENMM1000  ADD       ONE,DIAGCNTR
.
          IF        DIAGCNTR > 5
            GOTO      ENMM9999 
          ENDIF
.
          LOAD      DIM9,DIAGCNTR,OPDICODE,OPDICOD2,OPDICOD3,OPDICOD4,OPDICOD5
.
          MATCH     SP70,DIM9                  * Don't report if blank
          GOTO      ENMM1000 IF EQUAL
.
          MOVE      "22502",DIM5               * Pre-july 2019  icd 10 ed 10
.
          MATCH     PTCNGDX1,OBADATE           * arrival.date > icd 10 ed 11
          IF        !@LESS
            MOVE      "23856",DIM5
          ENDIF
.
          MATCH     PTCNGDX2,OBADATE           * arrival.date > icd 10 ed 12
          IF        !@LESS
            MOVE      "47146",DIM5
          ENDIF
.
          MOVE      "61",OBJECTTY                * Diagnosis
          PACK      OBJECTKY,FOUR,ALREVISN,DOBAOUTN,ONE,DOBASLOT:
                             OBACTYP,DIAGCNTR,DIM9,SP70,SP70
.
          MOVE      DOBAOUTN,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM9
          MOVE      DIAGCNTR,DIM2
          REP       " 0",DIM2
          MOVE      DOBASLOT,DIM3
          SQUEEZE   DIM3
          MOVE      OBACTYP,DIM6
          SQUEEZE   DIM6
.
          PACK      OBJECTTX,FOUR,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID
                             VISITNUM,DOBASLOT:
                             DIM6,DIM2,TILDA:    * DIAGNOSIS_RECORD_ID
                             DIM2,TILDA:         * SEQUENCE_NUMBER
                             TILDA:              * CONFIRMATION_STATUS_CODE
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE:
                             TILDA:              * REF_SOURCE_ID
                             DIM5,TILDA:         * REF_DOMAIN_ID
                             DIM9,TILDA:         * DIAGNOSIS_CODE
                             TILDA:              * DATE
                             TILDA:              * TYPE_CODE
                             SP900               * COMMENTS
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          CALL      OPSD0000               * Set source modified date
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      ENMM1000
.
ENMM9999  RETURN
