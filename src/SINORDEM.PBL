.SINORDEM - PEG Export (E-mail) Purchase Order
.
.  Returns  EXIT    (0=faxed 1=missing or locked)
.
.  Requires SIPAPON (Purchase order number)
.           NOPRINT (0=print from this routine, 1=print elsewhere)
.
.           Includes   : IBACODFD/INC IBAPRNFD/INC
.                        IBAIOCOD/INC IBAIOPRN/INC IBAPRINT
.                        SINTMPDF/INC SINCODFD/IO  SINORIFD/IO  APSMASFD/IO
.                        SINSIAFD/IO  SINPOAFD/IO  SINPOBFD/INC SINPOCFD/INC
.                        SINPODFD/IO
.
.----------------------------------------------------------------------
.
.         VF.09.00  22/05/2003  CAR 39306  New Module created from IBASIN59
.
.----------------------------------------------------------------------
.
.
.------------------------------------------------------------
. Export PEG Purchase Orders
.------------------------------------------------------------
SINORDEM  MOVE      ZERO,EXIT
.
          CALL      LCKPO000                  * Lock P/O (in SINORDFX)
          BRANCH    OVRCD,SINEML99,SINEML99
.
.                                             * Open E-mail work file
SINEML10  MOVE      SIPAPON,DIM7
          REP       " 0",DIM7
          MOVE      "P",DIM1
          PACK      EXPORTFN,DIM1,DIM7,SP70
          PREP      PEGFILE,EXPORTFN
.
          CALL      EMHED000                  * write E-mail header to file 
.
          CALL      EMDET000                  * write E-mail detail to file 
.
SINEML50  CALL      EMTRL000                  * write E-mail trailer to file
.
          CLOSE     PEGFILE
          CLEAR     KEY80
.                       Format - 'ibasin59.us1 filname "name@address" 1234'
          APPEND    "ibasin59.us1 ",KEY80
          APPEND    EXPORTFN,KEY80
......    APPEND    ".txt",KEY80
          APPEND    SP1,KEY80
          APPEND    "#"",KEY80
          STRIP     APMAUR2
          APPEND    APMAUR2,KEY80             * insert e-mail address
          APPEND    "#"",KEY80
          APPEND    SP1,KEY80
          APPEND    PASSCODE,KEY80
          RESET     KEY80
.
          EXECUTE   KEY80,TASKID              * e-mail the file
.
          PREP      PEGFILE,EXPORTFN          * delete the file
          CLOSE     PEGFILE
.
          CALL      SINAU000                  * Update Audit files
.
          CALL      UUSIPA1                   * un-lock the Purchase order
.                                             * prepare for next e-mail file
          ADD       ONE,PEGTXTFL
.
SINEML99  RETURN
.------------------------------------------------------------
. Init & Write PEG P/O Header export file
.------------------------------------------------------------
EMHED000  MOVE      ZERO,EXIT
.
          DISPLAY   *P1:24,*EL,"Email Purchase Order ",*V2LON,SIPAPON;
.
          MOVE      SIPAPON,SIP0ORDN
          SQUEEZE   SIP0ORDN
.
          PACK      SIP0RCID,APMACEDI,SP70
          STRIP     SIP0RCID
.
          PACK      SIP0SNID,SNCOHEAN,SP70
          STRIP     SIP0SNID
.
          PACK      SIP0ORDT,SIPADIN,SP70
          STRIP     SIP0ORDT
.
          PACK      SIP0INDT,SP70
          STRIP     SIP0INDT
.
          PACK      SIP0EXDT,SP70
          STRIP     SIP0EXDT
.
          PACK      SIP0DEDT,SP70
          STRIP     SIP0DEDT
.
          PACK      SIP0AFDT,SP70
          STRIP     SIP0AFDT
.
          PACK      SIP0BFDT,SP70
          STRIP     SIP0BFDT
.
          PACK      SIP0PUCN,SIPAICN,SP70
          STRIP     SIP0PUCN
.
          PACK      SIP0PUEM,SP70
          STRIP     SIP0PUEM
.
          PACK      SIP0PUPH,SP70
          STRIP     SIP0PUPH
.
          PACK      SIP0SUCO,APMASN1,SP70
          STRIP     SIP0SUCO
.
          PACK      SIP0DESP,SNCOHEAN,SP70
          STRIP     SIP0DESP
.
          PACK      SIP0DENM,HSHORT,SP70
          STRIP     SIP0DENM
.
          PACK      SIP0DEA1,SIPADEL,SP70
          STRIP     SIP0DEA1
.
          PACK      SIP0DEA2,CHADD1,SP70
          STRIP     SIP0DEA2
.
          PACK      SIP0DEA3,CHADD2,SP70
          STRIP     SIP0DEA3
.
          MOVE      CHPOST,DIM4
          PACK      SIP0DEPC,DIM4,SP70
          STRIP     SIP0DEPC
.
          PACK      SIP0BICD,SNCOHEAN,SP70
          STRIP     SIP0BICD
.
          PACK      SIP0BINM,HSHORT,SP70
          STRIP     SIP0BINM
.
          PACK      SIP0BIA1,CHADD1,SP70
          STRIP     SIP0BIA1
.
          PACK      SIP0BIA2,SP70
          STRIP     SIP0BIA2
.
          PACK      SIP0BIA3,CHADD2,SP70
          STRIP     SIP0BIA3
.
          MOVE      CHPOST,DIM4
          PACK      SIP0BIPC,DIM4,SP70
          STRIP     SIP0BIPC
.
          PACK      SIP0ITAX,SP70
          STRIP     SIP0ITAX
.
          PACK      SICDDESC,SP70
          MATCH     SP70,SIPAMES
          IF        !@EQUAL
            MOVE      "ME ",DIM3
            PACK      KEY6,DIM3,SIPAMES,SP70
            CALL      RDSICD1
          ENDIF
          PACK      SIP0FTX1,SICDDESC,SP70
          STRIP     SIP0FTX1
.
          PACK      SICDDESC,SP70
          MATCH     SP70,SIPACON
          IF        !@EQUAL
            MOVE      "CF ",DIM3
            PACK      KEY6,DIM3,SIPACON,SP70
            CALL      RDSICD1
          ENDIF
          PACK      SIP0FTX2,SICDDESC,SP70
          STRIP     SIP0FTX2
.
EMHED900  CALL      WRSIP01
.
EMHED999  RETURN
.------------------------------------------------------------
. Process E-mail P/O Detail data       
.------------------------------------------------------------
EMDET000  PACK      KEY10,SIPAPON,SP70
          CALL      RSSIPC1
.
EMDET100  CALL      RKSIPC1
          BRANCH    OVRCD,EMDET999
.
          MATCH     SIPAPON,SIPCPON
          GOTO      EMDET999 IF NOT EQUAL
.
          DISPLAY   *P26:24,", Line Item : ",*EL,*V2LON,SIPCITM,*HOFF;
          CALL      EMPEG000                  * set up the PEG data
.
          GOTO      EMDET100
.
EMDET999  RETURN
.------------------------------------------------------------
. Init & Write PEG P/O Detail export file
.------------------------------------------------------------
EMPEG000  PACK      SIP1PEAN,SP70
          PACK      SIP1UOM,SP70
          PACK      KEY27,SIPCCAT,SIPASUP,SIPCSUT,SP70
          CALL      RDSIIC1
          IF        OVRCD=0
            PACK      SIP1UOM,SIICUOM,SP70
.
            PACK      SIP1PEAN,SIICUR1,SP70
            MATCH     SIICUR1,SP70
            IF        @EQUAL
              PACK      KEY7,SIPCCAT,SP70
              CALL      RDSIIA1
              PACK      SIP1PEAN,SIIAUR1,SP70
            ENDIF
          ENDIF
          STRIP     SIP1PEAN
          STRIP     SIP1UOM
.
          MOVE      SIPCITM,SIP1LINE
          SQUEEZE   SIP1LINE
.
          PACK      SIP1PDCD,SIPCCAT,SP70
          SQUEEZE   SIP1PDCD
.
          PACK      SIP1SPPC,SIPCPN,SP70
          STRIP     SIP1SPPC
.
          PACK      SIP1ITDS,SIPCPD,SP70
          STRIP     SIP1ITDS
.
          MOVE      SIPCOQT,F12
          MOVE      F12,SIP1QTY
          SQUEEZE   SIP1QTY
.
          PACK      SIP1DEDT,SIPCEDD,SP70
          STRIP     SIP1DEDT
.
          PACK      SIP1AFDT,SP70
          STRIP     SIP1AFDT
.
          PACK      SIP1BFDT,SP70
          STRIP     SIP1BFDT
.
          PACK      SIP1EXDT,SP70
          STRIP     SIP1EXDT
.
          MOVE      "CAT",SIP1PRTY
          MATCH     SIPCCON,SP70
          IF        !@EQUAL
            MOVE      "CON",SIP1PRTY
          ENDIF
.
          MOVE      SIPCECT,F12P2
          MOVE      F12P2,SIP1UNPR
          SQUEEZE   SIP1UNPR
.
          MOVE      ZERO,SIP1NUMP
          SQUEEZE   SIP1NUMP
.
          PACK      SIP1PACK,SP70
          STRIP     SIP1PACK
.
          PACK      SIP1FUOM,SP70
          STRIP     SIP1FUOM
.
          MOVE      ZERO,SIP1FQTY
          SQUEEZE   SIP1FQTY
.
          MOVE      ZERO,SIP1DISP
          SQUEEZE   SIP1DISP
.
          MOVE      ZERO,SIP1REBP
          SQUEEZE   SIP1REBP
.
          PACK      SIP1ITAX,SP70
          STRIP     SIP1ITAX
.
          PACK      SIP1FTX1,SP70
          STRIP     SIP1FTX1
.
          PACK      SIP1FTX2,SP70
          STRIP     SIP1FTX2
.
.
..          PACK      SIP1SPA1,SP70,SP70
..          PACK      SIP1SPA2,SP70,SP70
..          PACK      SIP1SPA3,SP70,SP70
..          PACK      SIP1SPA4,SP70,SP70
.
EMPEG900  CALL      WRSIP11
.
EMPEG999  RETURN
.------------------------------------------------------------
. Init & Write PEG P/O Tail (Ending) export file
.------------------------------------------------------------
EMTRL000  MOVE      SIPAPON,SIP2ORDN
          SQUEEZE   SIP2ORDN
.
EMTRL900  CALL      WRSIP21
.
EMTRL999  RETURN
.------------------------------------------------------------
. Update the Audit files & Update P/O Printed date
.------------------------------------------------------------
SINAU000  PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
          MATCH     DIM8,SIPADPR
          IF        !@EQUAL
            MOVE      "2",AUDTTYPE
            CALL      WASIPA00
.
            MOVE      SIPAPON,KEY7
            CALL      RDSIPA1
            IF        OVRCD=0
              PACK      SIPADPR,CCC,CYY,CMM,CDD
              REP       " 0",SIPADPR
              CALL      UPSIPA1
            ENDIF
.
            MOVE      "3",AUDTTYPE
            CALL      WASIPA00
          ENDIF
.
SINAU999  RETURN
.
