.------------------------------------------------------------------------------
. Program       : OUTWEB02
.
. Function      : Outpatients Server
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.07 16/10/2025  Zumin Yu       TSK 0964943a
.           Formatting DNA patient warning message in CHKDNA10
. V12.00.06 17/09/2025  Ebon Clements  TSK 0965123
.           Recompiled for WRITBOOK - Set SAVBCOMP for pmsextaf read
. V12.00.05 18/08/2025  Zumin Yu       TSK 0964943
.           Updated DNA patient warning message in CHKDNA10
. V12.00.04 23/07/2025  Ebon Clements  TSK 0959840
.           Recompiled for WRITBOOK and ABFOTINV
. V12.00.03 13/06/2025  Alina Bhari    TSK 0946439
.           Set Flag to cancel appointment and close referral-CREFFLAG,MAIN1400
. V12.00.02 12/06/2025  Don Nguyen     TSK 0961881
.           Recompiled for PATNAMCD - resized VAR accordingly for Paediatric
. V12.00.01 15.05.2025  DA Sarkies     TSK 0955096 
.           Updated for Alpha-Numeric Visit Number  
.           13/05/2025 Ebon Clements   TSK 0955096
.           Added alpanumeric visit number generation - RFOL0000 - GENANVIS
. V11.05.08 01/05/2025 Ebon Clements   TSK 0960177
.           Don't read outlkbaf for empty slots - CASMTC00 - CHKS0000
. V11.05.07 20/03/2025  Davin          TSK 0956210
.           Recompiled for VALDIOPS (ICD10 Ed.13)
. V11.05.06 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.05 11/12/2024 Nikitha B       TSk 0950901
.           Added a check to skip unavilable slots with SHWUNAVL at EMSTB000. 
. V11.05.04 10/12/2024 Ebon Clements   TSK 0955016
.           Added blank test to slot template tier 2 code option - OEXB1001
. V11.05.03 27/11/2024 Thanh T         TSK 0939466
.           Recompiled for OUTDTRFD changes
. V11.05.02 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.01 26/11/2024 Thanh T         TSK 0945766
.           Recompiled for PMSQPXFD/PMSQPTFD changes
. V11.04.19 08/11/2024 PJ Le Febour    TSK 0950014b
.           recompiled for amendments to WRITBOOK  
. V11.04.18 08/11/2024 PJ Le Febour    TSK 0950014a
.           recompiled for amendments to WRITBOOK  
. V11.04.17 31/10/2024 Peter Vela      TSK 0953169
.           Added dashes to ScheduleR4 and SlotR4 FHIR API date/time stamps
.           Added SlotR4 status
. V11.04.16 29/10/2024 PJ Le Febour    TSK 0950014
.           OEXB1200 save OBACOMP to SAVBCOMP
.           Recompiled for WRITBOOK - UPMV0000 use SAVBCOMP read RDPMEXT1    
. V11.04.15 28/10/2024 Ebon Clements   TSK 0948906
.           Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V11.04.14 11/09/2024 Peter Vela     Outpatient FHIR API 0953169
.           Added Outpatient FHIR API
. V11.04.13 18/10/2024 Ebon Clements   TSK 0942992
.           Added index 7 by clinic type to clinic search - CLSRCH00
. V11.04.12 10.10.2024 PJ Le Febour    TSK 0951542c
.           OEXT8601 moved test of PTCOACTV
. V11.04.11 02.10.2024 DA Sarkies      TSK 0950760
.           Removed stray comma from UpdateParent
. V11.04.10 23/09/2024 J.Tan           TSK 0950577
.           Recompiled for PATIPERH - Fixed issue with Hold Invoice audit
. V11.04.09 20/06/2024 Thanh T        TSK 0947086
.           Recompiled for PMSHCGTM/PMSHCPTM changes
. V11.04.08 18/06/2024 Jacob Jackson  TSK 0947689
.           Ensure ICWA Date Sent/ICWA Responded is blank and Status field is
.           set to 'Pending'
. V11.04.07 17/06/2024 Jacob Jackson  TSK 0947689
.           Append OP visit number for reappointment booking
. V11.04.06 09/05/2024 PJ Le Febour   TSK 0906342e
.           EMPTYS00 added OTHEPCOD(Default Procedure)new param WRITE HTMLFILE
. V11.04.05 22/04/2024 Alina Bhari    TSK 0945381
.           Recompiled for WRITBOOK -correctly assigned clinic type from
.           the slot template master instead from clinic master         
. V11.04.04 08/04/2024 PJ Le Febour   TSK 0906342a
.           OEXB0000 - added OEXB1300 cater for Default Procedure Code Desc
. V11.04.03 15/03/2024 Jacob Jackson  TSK 0914658
.           Add updates to allow PMEXUYN1 to be changed
. V11.04.03 15/03/2024 Jacob Jackson  TSK 0914658
.           Add updates to allow PMEXUYN1 to be changed
. V11.04.02 13/03/2024 Ebon Clements  TSK 0929465
.           Update slot counts after single follow up appointment - UPDCNT00
. V11.04.01 07/03/2024 Ebon Clements  TSK 0914658
.           Aded clear of PMSEXTFD
. V11.03.17 06/11/2023 Jacob Jackson  TSK 0914658
.           Ensure relevant DB read is performed before calling
.           PMSEXTTM in OEXB1200
. V11.03.16 01/11/2023 PJ Le Febour   TSK 0857539d
.           FUSTB230 corrected spelling error in href urnumner to urnumber
. V11.03.15 12/10/2023 Davin          TSK 0903933
.           Recompiled for WRITBOOK - trigger HL7 A11 based on OTCNA11N
. V11.03.14 10/10/2023 Thanh T        TSK 0935874
.           Changed MAIN1600 to comment out the codes for PTCNUNET = '1'
.           since it is no longer used
. V11.03.13 02/10/2023 PJ Le Febour   TSK 0857539c
.           FUSTB230 added test when OTCNTMES = 0 display NO times   
. V11.03.12 02/10/2023 Jacob Jackson  TSK 0914658
.           Creation of new tag OEXB1200 to allow reading of PMEXUYN1
.           Add PMSEXTTD and PMSEXTTM
. V11.03.11 12/09/2023 PJ Le Febour   TSK 0857539a
.           1 do not display contact times when hospital parameter   
.               display = No
.           2 contact time not underlined when hospital parameter 
.               option = Yes Display Times
.           3 for time use alenstim instead of alenctim
.           4 correct redirect to referral to display correct patient
.             information
. V11.03.10 16/08/2023 PJ Le Febour   TSK 0857539
.           FUSTB230 display time of active contacts linked to referral
. V11.03.09 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes 
. V11.03.08 20/07/2023  Davin          TSK 0934998
.           Read pmi details for HL7 I13 message trigger 34 (UPDORT00)
. V11.03.07 04/07/2023  Nikitha B      TSK 0932738a
.           Modified to save Tier 2 code from Master- OTMATCOD at CASROW00
.           Added OXEB1100 tag to display OTMATCOD for Tier 2 code 
. V11.03.06 17/05/2023  Ebon Clements  TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.05 05/05/2023  Nikitha B     TSK 0929347
.           Fixed contract code for inactive state - CCOD1000
. V11.03.04 27.04.2023 DA Sarkies     TSK 0931079
.           Inserted call to RDSESA1 into CHKDUP60 to display correct clinic
. V11.03.03 04/04/2023 Bella Turco    TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit                
. V11.03.02 03/03/2023 Jacob Jackson  TSK 0925903
.           Change validation to include bookings from a referral
. V11.03.01 13/02/2023 Jacob Jackson  TSK 0925903
.           Add remote scripting code for getting information regarding 
.           referral claim code & updating that with outpatient booking
.           claim code / funding code if accepted.
. V11.02.13 27.04.2023 DA Sarkies     TSK 0931079
.           Inserted call to RDSESA1 into CHKDUP60 to display correct clinic
. V11.02.12 10/10/2022 J.Tan           TSK 0906597
.           Recompiled for ABFOTINV - ABF/NWAU Calculations 
. V11.02.11 04/08/2022  Ebon Clements TSK 0920141
.           Read OP letter file by index 2 - LTRSEL00 and LSEL0000
. V11.02.10 07/06/2022 Jacob Jackson   TSK 0918806
.           Recompiled for WRITBOOK - Add CNLH7FLG parameter
. V11.02.09 19/05/2022 J.Tan           TSK 0837128
.           Recompiled for PRFAINSR - to use Cat CL indic 24
. V11.02.08 20/04/2022 J.Tan           TSK 0837128
.           Recompiled for WRITBOOK - Default PRFA based on Claim Type
. V11.02.07 01.04.2022  DA Sarkies    TSK 0917793
.           Recompiled for VALDIOPS (ICD10 Ed.12)
. V11.02.06 30/03/2022  Davin         TSK 0917793
.           Recompiled for VALDIOPS (ICD10 Ed.12)
. V11.02.05 29.03.2022  DA Sarkies     TSK 0905641
.           Added CGI variable for additional HCPs.
. V11.02.04 16/02/2022  Ebon Clements  TSK 0911788
.           Added remote script to see if you can check in an OP appointment
.           from the update pmi contacts details screen - PMICHK00
. V11.02.03 14/02/2022  Ebon Clements  TSK 0864233
.           Added department using time seen to check in time edit - DEPE0000
. V11.02.02 09/02/2022 Thanh T         TSK 0905641
.           Added Additional HCP Code (1-4)      
. V11.02.01 07/02/2022  Thanh T        TSK 0896905
.           Recompiled for ALLDEPFD changes
. V11.01.19 22/12/2021  DA Sarkies     TSK 0889010
.           Added function to retrieve WC claim details and date in FUSTB000
. V11.01.18 21/12/2021  DA Sarkies     TSK 0889010
.           Added DB call to extract ACC number and date in OTTHI007 and 
.           OTTHI008. Added include to clear ACC fields.
. V11.01.17 17/12/2021  Ebon Clements  TSK 0914940
.           Recompiled for WRITBOOK - GCLM4000 A08 ACC update
. V11.01.16 08/12/2021  Ebon Clements  TSK 0912859
.           Added mosaiqrs cgi to allow supervisor reschedule to a MOSIAQ clinic
. V11.01.15 06/12/2021  Davin          TSK 0914201
.           Added tag for supervisor tier2 code (OEXB1000)
. V11.01.14 08/11/2021 J.Tan           TSK 0880410
.           Recompiled for PATIPERH - added Hospital and System
. V11.01.13 17/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFOTINV - Mod for Multiple NEP Values
. V11.01.12 03/11/2021  Ebon Clements TSK 0902439
.           Only check reserved slot status when performing a follow up if
.           slot type matches the orginal visit type. FNEW1100
.           Added SAVBB047 save and restore orginal slot type. FOLSLT00
. V11.01.11 22/10/2021  Thanh T       TSK 0912482
.           Added OEXB0900 to return VIEWOPCL flag 
. V11.01.10 29/09/2021  Ebon Clements TSK 0902439
.           Check reserved slot user id for bulk follow up appointments.
.           Don't book to that slot if another user has reserved it. FNEW1100
.           Set EXIT to 1 after invalid slot status warning - RFOL9010 RFOL9020
. V11.01.09 07/09/2021  Ebon Clements TSK 0901508
.           Removed speed improvements to clinic id read - CHCKIN00. V11.01.08
. V11.01.08 07/09/2021  Ebon Clements TSK 0901508
.           Made speed improvements to clinic id read - CHCKIN00.
.           Added waspeed test to DOMCLR00
. V11.01.07 07/09/2021  Ebon Clements TSK 0901508
.           Removed duplicate patmx1af read from multi session check in
.           list display - CHKSL000
.           Removed redundant call to CHKAPP00 from CHCKIN00.
.           Added wahspeed cgi to minimise reads of unused data at wahealth
.           CHCKIN00
. V11.01.06 17/08/2021  Ebon Clements TSK 0901508
.           Removed suspended session call CHKSUS00 from the multi session 
.           check in list CHCKIN00. It appears to be redundant as it will not
.           display suspended slots with a status of 6 anyway.
.           Moved SRCHCIND and SRCHLTYP filter before the mult hospital test
. V11.01.05 03/08/2021  Davin         TSK 0899597
.           Added tag OEXB0800 to get doctor from outhed/outma1/outcli hierarchy
. V11.01.04 24.06.2021  DA Sarkies    TSK 0907078
.           Added a false statemene to ines 12677-12681 to check to see if the
.           variable MOSAICQL contains a 0 or not. If it is, then places a
.           blank space here.
. V11.01.03 16/06/2021  Thanh T       TSK 0891886
.           Changed DOMCLR00 to return the color description for the confirmed
.           demographic date
. V11.01.02 09/03/2021  Ebon Clements TSK 0903662
.           Only allow an over bookings slot time to be updated if the slot
.           is empty - CASMTC00
. V11.01.01 18/02/2021  Thanh T       TSK 0891886
.           Added DOMCLR00 to return the color description for the confirmed
.           demographic date
.------------------------------------------------------------------------------
. V11.00.34 01/02/2021  Ebon Clements  TSK 0902319
.           Fixed clinic location display on clinic search - CLSRCH00
. V11.00.33 18/01/2021  Ebon Clements  TSK 0901932
.           Don't search for the next available appointment when rescheduling
.           MOSAIQ visit - NXTAID00 NXTAPP00
.           18/01/2021  Don Nguyen     TSK 0901212
.           Added semicolon to the end of WRITE calls in OEXT0820 to close off
.           string appropriately and remove excess space.
. V11.00.32 12/01/2021  Ebon Clements  TSK 0901440
.           Fixed deposit file read comdepaf index 2 key size - KEY26
. V11.00.31 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.30 30/11/2020  Thanh T       TSK 0892302
.           Changed CHKSL000 to add Service delivery description 
. V11.00.29 16/11/2020  Davin         TSK 0890602
.           Moved add slot routines to WRITBOOK
. V11.00.28 11/11/2020  Ebon Clements   TSK 0899720
.           Fixed unavailable slot free text display - EMSTB000
. V11.00.27 29/10/2020  Ebon Clements   TSK 0893528
.           Include multiple slot review visit types for add new slot screen
.           CLST3400 - VTYSEL00
. V11.00.26 22/10/2020  J.Tan           TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.25 20/10/2020  Davin         TSK 0890602
.           Recompiled for WRITBOOK - Set referral active date (URSR9100)
. V11.00.24 20/10/2020  Ebon Clements TSK 0890602
.           Added semi colon to SHOWFLAG tag - SLST6300
.           Allow all filter options on the follow up referral list - SLST6200
. V11.00.23 19/10/2020  Ebon Clements TSK 0890602
.           Don't allow bookings into MOSAIQ clinics - CLSRCH00
.           Mixed missing referral highlight - SRXP0000
. V11.00.22 19/10/2020  Davin         TSK 0890602
.           Moved common update booking routines to WRITBOOK
. V11.00.21 14/10/2020  Ebon Clements TSK 0890602
.           Added SUPERLEV cgi for MOSAIQ supervisor menu options
. V11.00.20 13/10/2020  Ebon Clements TSK 0890602
.           Added waiting/Active referral expiry date tags - OEXB0500 OEXB0600
.           14/10/2020  Thanh T       TSK 0894932
.           Changed WCOM0000 to fix the issue with visit comment not copying   
. V11.00.19 13/10/2020  Ebon Clements TSK 0890602
.           Added REFXCLAS referral expiry class to multi session check in
.           list - CHKSL000 - SRXP0000
. V11.00.18 12/10/2020  Ebon Clements TSK 0890602
.           Created new follow up referral list - FLST0000
. V11.00.17 06/10/2020  Ebon Clements TSK 0890602
.           Don't allow MOSAIQ visits to be rescheduled - CASMTC20 MOSAIQVS
.           Don't allow bookings into MOSAIQ clinics - MOSAIQCL
. V11.00.16 30/09/2020  Thanh T       TSK 0893522
.           Recompiled for PMSSMHCD changes 
. V11.00.15 22/09/2020  J.Tan          TSK 0897315
.           Mod CBIL0000 to use OBASTAT for Booking status
. V11.00.14 21/09/2020  Davin          TSK 0890602
.           Moved booking routines to WRITBOOK for use in HL7RECVR and OUTWEB02
. V11.00.13 10/08/2020 J.Tan           TSK 0886178
.           Mod ABF Claim not to Update PMI HF (New appointment/booking)
. V11.00.12 06/08/2020 Ebon Clements   TSK 0891776
.           Added additional phone number output combinations - FREF0000
. V11.00.11 08/07/2020 Tracey Nguyen   TSK 0867370
.           Output Clinic Type description, Clinic Id description and Case Team 
.           description - REFLET00
. V11.00.10 02/07/2020 Thanh T         TSK 0870618
.           Added CLST7100, CLST7200  
. V11.00.09 24/06/2020 J.Tan           TSK 0886178
.           Recompiled for ABFOTINV - write to invoice pending details file
. V11.00.08 20/04/2020 J.Tan           TSK 0890733
.           Recompiled for ABFOTINV - ABF new 2020 calculation
. V11.00.07 09/06/2020  J.Tan             TSK 0886178
.           Added tag to display Booking status readonly if ABF invoice raised
. V11.00.06 12/05/2020  Ebon Clements     TSK 0840244
.           Added abiltiy to select a new visit type for bulk follow up 
.           OUTBB047 - FNEW0000
. V11.00.05 22/04/2020  Ebon Clements     TSK 0850105
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.04 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.03 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.02 20/03/2020  Peter Vela     TSK 0889143
.           Fixed OUTLET IO calls
. V11.00.01 18/03/2020  Peter Vela     TSK 0889143
.           Recompiled for OUTLETFD
. V10.15.15 20/02/2020  Peter Vela      TSK 0887845
.           Recompiled for NZHISWIO
. V10.15.14 30/01/2020  Thanh T           TSK 0846970
.           Changed FUSTB028 to show the patient folder with color
. V10.15.13 28/01/2019  J.Tan            TSK 0857392
.           Added FNAMEP for ABF
. V10.15.12 09/12/2019  Thanh T           TSK 0846970
.           Added VIEWOPCL, SLST6100 and CLST7000 for outpatient case list
.           only
. V10.15.11 06/12/2019  Ebon Clements     TSK 0885272
.           Update booking pre admission status when cancelling a booking
.           CWAT0000
. V10.15.10 02/12/2019  Thanh T           TSK 0885298
.           Recompiled for BARCODEF changes
. V10.15.09 25/11/2019  Ebon Clements    TSK 0860142
.           Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V10.15.08 20/11/2019  Richa Phogat     TSK 0865482
.           Added PRIMARYE under REFLET70
. V10.15.07 19/11/2019  J.Tan            TSK 0884485
.           Mod Changing booking status to check for 'tobe invoiced' items
. V10.15.06 18/11/2019  Ebon Clements    TSK 0857392
.           Call UPOB0000 from remote check in REMBOK84 to update linked OP
.           visits pre admission status
. V10.15.05 18/10/2019  Ebon Clements    TSK 0857392
.           Set booking record pre admission status to booked - BBST0000
.           Fixed mapping of pre admission status cat BG & XG -  UPOB0000
. V10.15.04 23/10/2019  Ebon Clements    TSK 0308709
.           Recompiled for OUTBOATM - Clinic type linked visit types
. V10.15.03 22/10/2019  Ebon Clements    TSK 0308709
.           Added clinic type linked visit type functionality - VTYSEL00
. V10.15.02 10/10/2019  Richa Phogat     TSK 0861253
.           Added CLOUTTHI, OTTHI000
.           18/10/2019  Ebon Clements    TSK 0857392
.           User Tier 2 code from new clinic for bulk reschedule - WBKA0000
.           16/10/2019  J.Tan            TSK 0857392
.           Recompiled for OUT002 - initialise ABFFLAG
. V10.15.01 09/10/2019  J.Tan            TSK 0857392
.           Mod ABF to check Tier2 code Cat NC indc1=A
.------------------------------------------------------------------------------
. V10.14.27 26/09/2019  J.Tan            TSK 0857392
.           Recompiled for OUT002 - ABF outpatient invoice
. V10.14.26 22/08/2019  Ebon Clements    TSK 0879921
.           Allow unavailable slot be be change to available - VALUPD95
. V10.14.25 02/09/2019  Davin            TSK 0879208
.           Added call to PMIGTNID (get national id) for HL7 triggers 25,46
. V10.14.24 26/08/2019  Thanh T          TSK 0879452
.           Added SNDTETIM for SMSS0000 changes to include checking for booking
.           date/time against date message was sent
. V10.14.23 22/08/2019  Ebon Clements    TSK 0879921
.           Make sure slot is empty before allowing the visit type to be
.           updated - VALUPD95
. V10.14.22 31/07/2019  Peter Vela       TSK 0874259
.           Validate for existing patwc1af record before update in DEWCOM00
. V10.14.21 25/07/2019  Sunny            TSK 0877616
.           Recompiled for OTBBSRVD - Service delievery description 
. V10.14.20 22/07/2019  Ebon Clements    TSK 0859728
.           Ignore confirm PMI date edit for NZ - CONFRPMI
. V10.14.19 18/07/2019  Ebon Clements    TSK 0877629
.           Recompiled for OUTBOATM - Comments for follow up appointments
. V10.14.18 17/07/2019  Ebon Clements    TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.17 10/07/2019  Ebon Clements    TSK 0877824
.           Added VINAH audit trigger flags VINAHFLG, EPAUDFLG, RIAUDFLG and
.           VINAHREF to CLRPAR00
. V10.14.16 18/06/2019  Steve Armstrong  TSK 0874842
.           Mods to minimise the number of audit records written when calling
.           AMAS0000, REFX0000, FAPD0000 and VINAHDEF from WRTBOK00.
. V10.14.15 14/06/2019  Ebon Clements  TSK 0875173
.           Check for a cancelled over booking when reading outbokaf - UPDCNT60
. V10.14.14 13/06/2018  J.Tan          Task 0875795
.           Recompiled HICCLAIM - Provider number for Actual doctor seen
. V10.14.13 03/06/2019  Peter Vela      TSK 0857392 
.           Added write/update to pmscauaf for Supervisor function UPDBOK79
. V10.14.12 30/05/2019  Thanh T.        TSK 0872539
.           Recompiled for NZHISWIO changes
. V10.14.11 27/05/2019  Ebon Clements   TSK 0870183
.           Recompiled for OUTBOATM - Rescheduled appointment clinic type
. V10.14.10 24/05/2019  Ebon Clements   TSK 0868837
.           Recompiled for VINAHDEF - Episode patient ready for care date clear
. V10.14.09 21/05/2019  Ebon Clements   TSK 0874508
.           Changed to use common clear of WATOPAFD - CLWATOPA
. V10.14.08 13/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to VINAHDEF.
. V10.14.07 01/05/2019  Tracey Nguyen   TSK 0869558
.           Allowed for admissno to be optional input in CHKARQ00
. V10.14.06 19/03/2019  Thanh T.        TSK 0869558
.           Added RESLOT17,CHKARQ00 for checking the existence of appointment
.           request script
.           18/03/2019  Richa Phoagt    TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, MVACCREM
.           21/03/2019  Tracey Nguyen   TSK 0838668
.           Recompiled for OUTBOATM - Added CHARTREV in APPTSU00
. V10.14.05 19/03/2019  Don Nguyen      TSK 0869412
.           Recompiled for VALDIOPS - Added ICD10 Ed.11 - Go-live Date check
. V10.14.04 27/02/2019  Ken Bell        TSK 0869548
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
. V10.14.03 20/02/2019  Thanh T.        TSK 0870617
.           Added codes to retrieve CHCSCOD and MRCNBCHI from controlf file
.           for MRT label printing
. V10.14.02 18/02/2019  Ebon Clements   TSK 0828972      
.           Added set scanned medical record flag on discharge - scannedm
. V10.14.01 12/02/2019  Nicole Torrisi  TSK 0869113      
.           Added output of ALRERDAT to SLST5900 and CLST6900
.           05/02/2019  Ebon Clements   TSK 0870005
.           Added deftovrd to NEXT0000, PREV0000, NXGR0000 and PRGR0000
.------------------------------------------------------------------------------
. V10.13.15 23/01/2019  Thanh T.        TSK 0867313
.           Added PRTMRT00 for MRT barcode label printing
. V10.13.14 22/01/2019  Peter Vela      TSK 0867807
.           Changed PMMIRTYP to 2 in UPPMS000
. V10.13.13 21/01/2019  Peter Vela      TSK 0867807
.           Added referral details from allrefaf to outbb1af in WRTBOK40
. V10.13.12 11/12/2018  Nicole Torrisi  TSK 0867128
.           Changed FUSTB100 to output full addresses for Contact Details 
. V10.13.11 07/11/2018  Don Nguyen      TSK 0853817
.           Modified DEWCOM00 (Delete Workers comp. details) to set
.           Claim Status to 'Cancelled' if only one visit for the Claim Number
.           exists (NZ Only); instead of deleting it.
. V10.13.10 23/10/2018  Tracey Nguyen    TSK 0859743
.           Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
. V10.13.09 23/10/2018  Thanh T         TSK 0859743
.           Added MAIN2500, OTBBBKOV/OUTBB075 OTBBBKPR/OUTBB076
.           OTBBBKPM/OUTBB077 OTBBBKBA/OUTBB078 OTBBRDAT/OUTBB079
. V10.13.08 05/10/2018  Thanh T         TSK 0859743
.           Added MAIN2500, OTBBBKOV/OUTBB075 OTBBBKPR/OUTBB076
.           OTBBBKPM/OUTBB077 OTBBBKBA/OUTBB078 OTBBRDAT/OUTBB079
.           UPPMS000                  
. V10.13.07 04/10/2018  Richa Phogat       TSK 0862873
.           Added OEXB0300
. V10.13.06 19/09/2018  J.Tan        TSK 0863727
.           Added Restrictive Override code
. V10.13.05 21/08/2017  J.Tan        TSK 0859742
.           Added ECLIPSE new fields from pmsmtiaf
. V10.13.04 10/08/2018  Ebon Clements   TSK 0858724
.           Fixed exit branch after call to RFOL0000 in bulk followup BFOL0000
. V10.13.03 30/07/2018  Ebon Clements   TSK 0815359
.           Don't display IP department in selection lists
. V10.13.02 30/07/2018  Don Nguyen      TSK 0847735
.           Added CHKOPM00 - Remote script to check if Clinic is Mental Health
.           Recompiled for OUTBOATM - Added Clinic Group (Cat CG) code output
.           26/07/2018  Peter Vela      TSK 0833256
.           Added Colour coded OP Clinic Lists 
. V10.13.01 16/07/2018  Ania P          TSK 0838724
.           Adde Case Team output to CHKLET70
. V10.12.18 19/07/2018  Richa Phogat    TSK 0860079
.           Added condition for HL7TRGID='5' to write A05 row when UPDATETY!='4'
. V10.12.17 16/07/2018  Ania P          TSK 0838724
.           Adde Case Team output to REFLET70
. V10.12.16 05/07/2018  Thanh T         TSK 0857684
.           Recompiled for OUTBOATM changes
. V10.12.15 29/06/2018  Ebon Clements   TSK08596801
.           Recompiled for OUTBOATM - Comments order
. V10.12.14 27/06/2018  Ken Bell        TSK 0830161
.           Added background new background color for INDC1 'O'ther clinic type
. V10.12.13 27/06/2018  Thanh T         TSK 0859173
.           Fixed issue with Dignosis view of outpatient clinic
.           showing deleted comments
. V10.12.12 26/06/2018  Ken Bell        TSK 0830161
.           Added background colors and removed clinic name from unbooked slots
. V10.12.11 12/06/2018  Richa Phogat    TSK 0850937
.           Added UPOB0000
. V10.12.10 16/05/2017  Ebon Clements   TSK 0857085
.           Don't read OUTBB1FD when cancelling appointments as the slot
.           is empty and the visit number is zero -  UPDCNT60
. V10.12.09 02/05/2018  Ebon CLements  TSK 0846913 
.           Fixed save of resheduled appointment OPRSBKDT
.           Added write to EDWARD visit alteration file - WEDV0000
. V10.12.08 27/04/2018  Thanh Tieu     Task 0851975
.           Changed for triage status enhancement. Added codes to
.           output the triage status description TRGSDESC to show on various
.           templates.
. V10.12.07 13/04/2018  Ebon Clements   TSK 0855329
.           Fixed goto after bulk follow up to fix FIFO not found - UPDSES80
. V10.12.06 21/03/2018  Thanh T.       TSK 0854036
.           Added WTCNPACC field for Defaulting OP Clinic type for PAC
.           Appointments
. V10.12.05 16/03/2018  Peter Vela      TSK 0845330
.           Removed tick in checkbox AddEnc() FUSTB000
.           Changed CLST6800 to OCADOCT
. V10.12.04 14/03/2018  Richa Phogat    TSK 0853461
.           Recompiled for OUTBOATM - Removed count from OCANTB00 to display
.           complete list of cancelled appointments
. V10.12.03 05/03/2018  Ebon Clements   TSK 0846913
.           Populate original booking date/time in OUTCANFD and OUTRSHFD
. V10.12.02 13/02/2018  Peter Vela      TSK 0845330
.           Added tag for OTMACENC in CLST0000
. V10.12.01 07/02/2018  Ebon Clements   TSK 0843157
.           Use outhedaf clinic type for new over booking slots - ADDOVR00
. V10.11.16 18/12/2017  Ebon Clements   TSK 0846952
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.15 30/11/2017  Thanh Tieu      Task 0821710
.           Recompiled as OUTBOATM changed
. V10.11.14 27/11/2017  Thanh Tieu      Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.13 02/11/2017  Peter Vela      TSK 0842304
.           Added functionality to copy across data for Outpatient
.           Appointment from linked Referral for patwc1af, pmswx1af
.           accrfpaf, accdiaaf, acccmtaf
.           16/10/2017  Steve Armstrong TSK 0843876
.           Fixed duplicate trigger id's - 15 and 40 and renumbered
.           to 48 & 49.
.           24/10/2017  Peter Vela      TSK 0844621
.           Added validation in SHWBOK00 for closed/inactive/rejected/cancelled
.           referrals
. V10.11.12 24/10/2017  Ebon Clements   TSK 0841602
.           Added mandatory referral to EMPTYS00
. V10.11.11 05/10/2017  Thanh T.        TSK 0821710
.           Added new NWVCN000 section
. V10.11.10 13/09/2017  Ebon Clements   TSK 0841602
.           Added referral link write when booking from WL - WRTBOK00
. V10.11.09 11/09/2017  Thanh T.        TSK 0821710
.           Recompiled for OUTBOATM
. V10.11.08 31/08/2017  J.Tan           TSK 0837479
.           Added PMMICTYP - Consumption Type
. V10.11.07 18/08/2017  Ania P          TSK 0843179
.           Recompiled for IBAWEBCD
. V10.11.06 10/08/2017  Thanh T.        TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.05 30/07/2017  Thanh T.        TSK 0821710
.           Audit admission/outpatient/UR comments. changed OUTBOATM.
.           04/08/2017  Ebon Clements   TSK 0843265
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.04 30/07/2017  Thanh T.        TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 26/07/2017  Ebon Clements   TSK 0841129
.           Unlock OUTBOAFD record after web error in DISCOD00
. V10.11.02 21/07/2017  Ebon Clements   TSK
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.01 13/07/2017  Ebon Clements   TSK 0841129
.           Added nextpage 8 -  PREDIR00
.------------------------------------------------------------------------------
. V10.10.11 03/07/2017  Richa Phogat    TSK 0817112
.           Rollback changes done for task 0817112
. V10.10.10 20/06/2017  Richa Phogat    TSK 0817112
.           Added code to display Referred by Practice value (ALRERHCR) and 
.           Referring Practice Count (ALRERHCT) in OEXT8800
. V10.10.09 23/05/2017  Ebon Clements   TSK 0828866
.           Recompiled for VINAHDEF - Date referral accepted
. V10.10.08 10/05/2017  Ebon Clements  TSK 0837231
.           Added trap to outboxaf write - USLT0000
. V10.10.07 01/05/2017  Ebon Clements  TSK 0831449
.           Read clinic master prior to DNA letter print - PDNA0000
. V10.10.06 20/04/2017  Davin          TSK 0833226
.           Added ahautots to stop error messages - Called from AhAutoTimeSeen()
. V10.10.05 20/04/2017  Jill Parkinson TSK 0836114
.           Removed check for DISCFLAG=2 around DNA HL7 message from supervisor
. V10.10.04 10/04/2017  Ebon Clements  TSK 0836214
.           Added before and after referral audit - FAPD0000
. V10.10.03 05/04/2017  Peter Vela     TSK 0835607
.           Added floating div functionality for headers in MTVT0000
. V10.10.02 20/03/2017  Ebon Clements  TSK 0815431
.           Added appoinment request comments tag from OUTRCMFD
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Recompiled for VALDIOPS (ICD10 Ed.10)
. V10.09.07 01/03/2017  Tracey Nguyen  TSK 0833296
.           Added location type (Category CT) filter and searchfl to reduce 
.           performance issue for Multi Therapist View
. V10.09.02 10/02/2017  Ebon Clements  TSK 0833229
.           Fixed patient has a booking for this session test - CHKDUP00
. V10.09.01 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.09.04 14/12/2016  Peter Vela     TSK 0828021
.           Added Priority, Rescheduled Times to SLTN0000
. V10.09.03 12/12/2016  Ebon Clements  TSK 0830229
.           Always check extended slot space when restoring unavailable slot
.           to available - VALUPD00
. V10.09.02 08/12/2016  Ebon Clements  TSK 0826732
.           Added tag for original appt key for follow up appt - OEXT9800
. V10.09.01 06/12/2016  Peter Vela     TSK 0828021
.           Added Priority, Rescheduled Times to CASMTC00
.           05/12/2016  Peter Vela     TSK 0322357
.           Added showcpmi to PREV0000
.           02/12/2016  Jill Parkinson TSK 0822329
.           Added ACC Purchase order number and write pmswx1af
. V10.08.29 24/11/2016  Peter Vela     TSK 0820086
.           Added tag for WCCLMNO in OEXT9700
. V10.08.28 18/11/2016  Peter Vela     TSK 0827671
.           Added single space after Parent of <Initial>.
.           before write to patre1af
. V10.08.27 16/11/2016  Peter Vela     TSK 0322357
.           Added health fund to CHKSL000
. V10.08.26 28/10/2016  Ebon Clements  TSK 0809629
.           Added procedure and problems to FUSTB000
. V10.08.25 27/10/2016  Ania P         CAR 319994
.           Changed rules for ALERTSTR in FUSTB025
. V10.08.24 17/10/2016  Ania P         CAR 319994
.           Removed PTMXSIN1 check in FUSTB000
. V10.08.23 14/10/2016  Ebon Clements  TSK 0817582
.           Recompiled for VINAHDEF - Notified of first appointment default
. V10.08.22 07/10/2016  Ebon Clements  TSK 0815089
.           Added visit type filter filtvtyp for multi session list - CLISTM00
. V10.08.21 05/10/2016  Ebon Clements  TSK 0304330
.           Added Health fund/table to OP booking functionality
. V10.08.20 04/10/2016  Peter Vela     TSK 0823237
.           Restored outctyaf record in FUSTB100 after read by referral
. V10.08.19 22/09/2016  Ebon Clements  TSK 0294154
.           Fixed SMS response display on comfirmed appointment list - CONLST00
. V10.08.18 13/09/2016  Peter Vela     TSK 0822404
.           Added confpmiw validation for wahealth
. V10.08.17 09/09/2016  Peter Vela     TSK 0822404
.           Added CpmiError() validation for wahealth 
. V10.08.16 06/09/2016  Peter Vela     TSK 0825525
.           Added update to outboxaf in USLT0000
. V10.08.15 31/08/2016  Peter Vela     TSK 0822404
.           Added wahealth validation for clinic type in FNEW1100
. V10.08.14 24/08/2016  Peter Vela     TSK 0822811
.           Added Current Inpatient, Current Emr to CHKSL000
. V10.08.13 17/08/2016  Peter Vela     TSK 822796
.           Added hiddtier to CASMTC00
. V10.08.12 16/08/2016  Ebon Clements  TSK 0812854
  .         Fixed DNA letter print when making a new appointment - PDNA0000
. V10.08.11 10/08/2016  Ebon Clements  TSK 0813331
.           Added zero visit number error to REAP9040
. V10.08.10 08/08/2016  Ebon Clements  TSK 0817427
.           Added session tags to report 2 - OOSE0000
.           Added departure time edit for bulk departure - BDIS0000
.           Fixed check in time/seen time edit - UPDATE40
. V10.08.09 01/08/2016  Ebon Clements  TSK 0815093
.           Check OP appointment warnings for all sites - CHKDUP00
. V10.08.08 19/07/2016  Ebon Clements  TSK 0815093
.           Check OP appointment warnings for all the users sites - CHKDUP00
. V10.08.07 18/07/2016  Steve Armstrong  TSK 0293130
.           Mods to send an A08 message after the A13 when using the
.           Supervisor Update Screen to DNA an Attended visit.
.           Also updated a trigger ID from FORTY to FORTY5 as FORTY
.           was already being used.
.           15/07/2016  Ebon Clements     TSK 0294154
.           Added sms response to confimed appointment list - CONLST00
. V10.08.06 12/07/2016  Nicole Torrisi    TSK 0817053
.           Added Cat CG filter to Clinic Timetable view
. V10.08.05 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.04 08/06/2016  Jill Parkinson TSK 0316918
.           Added CLOUTHED to CLRPAR00
. V10.08.03 07/06/2016  Jill Parkinson TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.08.02 13/05/2016  Ebon Clements  TSK 0815929
.           Only search once for the next available appointment. Set next
.           appointment key to Z70 if no empty slot found - NXTAPP00 & NXTAID00
. V10.08.01 04/04/2016  Ebon Clements  TSK 0808991
.           Added option to use OUTBB034 instead of current time - UPDATE50
. V10.07.19 17/03/2016  Ebon Clements  TSK 0808991
.           Added option to use OUTBB032 instead of current time - UPDATE30
. V10.07.18 15/03/2016  Nicole Torrisi TSK 0321869
.           Changed EMSTB000 to show Clinic details on Empty Slow rows
. V10.07.17 29/01/2016  Peter Vela     CAR 0809347
.           Added open to PATAUDA2
. V10.07.16 18/12/2015  J.Tan          CAR 0808361
.           Mods checking for service fees (CFEE0000) in CBIL0000
. V10.07.15 17/12/2015  Ebon Clements  CAR 294154
.           Added SMS notification functionality
. V10.07.14 14/12/2015  Ebon Clements  CAR 0323651
.           Added option to use OUTBB033 instead of current time - UPDATE40
. V10.07.13 04/12/2015  Peter Vela     CAR 324343
.           Modified CLISTM000 to filter on WBSELTYP if SEARCHIN = 1
. V10.07.12 03/12/2015  Don Nguyen     CAR 324250
.           Modified BOKUPD10 to test for presence of TRNSFSRC on page submitted
. V10.07.11 01/12/2015  Ebon Clements  CAR 324321
.           Fixed clinic type test for system wide comments - CLST2200 
. V10.07.10 27/11/2015  Ebon Clements  CAR 324267
.           Only update contact outcome for contacts linked to the
.           current OP booking - CNTCT000
. V10.07.09 20/11/2015  Peter Vela     CAR 323902
.           Re read pmsvx1af in FUSTB100
. V10.07.08 13/11/2015  Peter Vela     CAR 323664
.           Fixed read of outbb1af in BDIS0000
. V10.07.07 12/11/2015  Don Nguyen     CAR 320393
.           Modified BOKUPD00 to write/update a 'patdadaf' record (NZ only)
.           Added OEXT9300 - Transfer Source Code/Desc output tag
.           Added TRNSFSRC - Transfer Source Code
. V10.07.06 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
. V10.07.05 26/10/2015  Ebon Clements  CAR 268970
.           Recompiled for OUTWMPFD index changes - GETMAP00
. V10.07.04 23/10/2015  Ebon Clements  CAR 320819
.           Added Inactive test to letter selection lists
. V10.07.03 16/10/2015  Peter Vela        CAR 322744
.           Recompiled for PMSVX1TM - Added code only display in VXTF7010 for
.           PMVXWEBC
. V10.07.02 13/10/2015  Peter Vela        CAR 316637
.           Fixed cell widths in CONLST00
. V10.07.01 01/10/2015  Peter Vela        CAR 316637
.           Added functionality to populate PMVXCNID and PMVXCNDT
. V10.06.31 23/09/2015  Ebon Clements     CAR 316643
.           Added single/multiple referral warning remote script - REFLET00
. V10.06.30 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.29 21/09/2015  Ebon Clements  CAR 316621
.           Fixed length of FRMTYP03 form printing cgi - PRNT0000
. V10.06.28 17/09/2015  Nicole Torrisi CAR 316621
.           Added Printing of Form letter for an Outpatient clinic
. V10.06.27 15/09/2015  Ebon Clements  CAR 309118
.           Don't allow update of discharge time if already discharged BDIS0000
. V10.06.26 11/09/2015  Ebon Clements  CAR 309841
.           Removed department test from bulk contacts list - ENCLST00
. V10.06.25 08/09/2015  Ebon Clements  CAR 309118
.           Added confirm PMI test to slotkeys display - FUSTB000
.           03/09/2015  Ebon Clements  CAR 316622
.           Added current IP and EMR flag to FUSTB000 - CURP0000
.           Added check U/R OP bookings for a date remote script - CHKSAP00
. V10.06.24 02/09/2016  Peter Vela     CAR 321242
.           Added disability alert icon to FUSTB200
.           01/09/2015  Ebon Clements  CAR 309118
.           Added casekeys and status to slotkeys checkbox for bulk process 
.           OP function - FUSTB000        
. V10.06.22 25/08/2015  Jill Parkinson CAR 320905 and CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.21 19/08/2015  Ebon Clements  CAR 309118
.           Skip bookings that already have a follow up done in bulk
.           follow up -  BFOL0000
. V10.06.20 19/08/2015  Peter Vela     CAR 316627
.           Added Suspended Clinic functionality to CLISTB00 CLSRCH00
. V10.06.19 18/08/2015  Peter Vela     CAR 320644
.           Added copy outpatient booking comments from DNA appointment to
.           new appointment UPDBOK26
.           11/08/2015  Peter Vela     CAR 319532
.           Recompiled for OUTBOATM - Added slot template location to APPTAB00
.           10/08/2015  Ebon Clements  CAR 309118
.           Added default outcome and attendance reason to bulk DNA - DNON0000
. V10.06.18 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.17 15/07/2015  Ebon Clements  CAR 310288
.           Added request appointment functionliay on DNA - NREQ0000
. V10.06.16 02/07/2015  Ebon Clements  CAR 318691
.           Added slot duration output to multi session check in - CHKSL000
. V10.06.23 28/08/2015  Ebon Clements  CAR 309118
.           Added referral number to slotkeys checkbox for bulk process 
.           OP function - FUSTB000        
. V10.06.22 25/08/2015  Jill Parkinson CAR 320905 and CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.21 19/08/2015  Ebon Clements  CAR 309118
.           Skip bookings that already have a follow up done in bulk
.           follow up -  BFOL0000
. V10.06.20 19/08/2015  Peter Vela     CAR 316627
.           Added Suspended Clinic functionality to CLISTB00 CLSRCH00
. V10.06.19 18/08/2015  Peter Vela     CAR 320644
.           Added copy outpatient booking comments from DNA appointment to
.           new appointment UPDBOK26
.           11/08/2015  Peter Vela     CAR 319532
.           Recompiled for OUTBOATM - Added slot template location to APPTAB00
.           10/08/2015  Ebon Clements  CAR 309118
.           Added default outcome and attendance reason to bulk DNA - DNON0000
. V10.06.18 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.17 15/07/2015  Ebon Clements  CAR 310288
.           Added request appointment functionliay on DNA - NREQ0000
. V10.06.16 02/07/2015  Ebon Clements  CAR 318691
.           Added slot duration output to multi session check in - CHKSL000
. V10.06.15 01/07/2015  Ebon Clements  CAR 312822
.           Don't write reshedule record if visit number is zero - LOGR0000
. V10.06.14 01/07/2015  Don Nguyen     CAR 317693
.           Recompiled for VALDIOPS - Removed Area checks '3' & '4' in VOPCD200
. V10.06.13 29/06/2015  Ebon Clements     CAR 317705
.           Fixed print of labels and forms when one type not setup - PRNT0000
. V10.06.12 10/06/2015  Steve Armstrong   CAR 313856
.           Mods to use CLVISINT & CLVISIAU instead of internal
.           clear routines
.           15/05/2015  Ebon Clements     CAR 315791
.           Don't write alllnkaf records if no referral number - WRTBOK00
. V10.06.11 15/05/2015  Ebon Clements     CAR 303890
.           Added visit base procedure and problem functionality
.           19/05/2015  Nicole Torrisi    CAR 312772
.           Recompiled for PATCODTM - Long Description
. V10.06.10 12/05/2015  Ebon Clements     CAR 303890
.           Added ALLPROFD and open
. V10.06.09 04/05/2015  Ebon Clements  CAR 315517
.           Added health purchaser tag - OEXT9100
. V10.06.08 01/05/2015  Ania P         CAR 315484
.           Fixed output of cat cg in OEXT8700
. V10.06.07 30/04/2015  Don Nguyen     CAR 314266
.           Recompiled for OUTBOATM - Modified OBOA3300 with test on indicator 1
. V10.06.06 29/04/2015  Don Nguyen     CAR 315661
.           Modified OEXT8600 to work with OTBBCONT (Contract Code).
.           Fixed existing code for Contract Codes add/update (cgi 'contcode');
.           added OUTBB074. The original code was done for CAR 208234.
. V10.06.05 20/04/2015  Don Nguyen     CAR 303885
.           Modified CHKDUP60 - output Clinic Description before location
. V10.06.04 14/04/2015  Don Nguyen     CAR 303885
.           Modified CHKDUP60 - added check for PTCNHDPS=1 (NZ)
. V10.06.03 31/03/2015  Peter Vela     CAR 298921
.           Recompiled for HICCLAIM
.           Changed OTBBADCS functionality to DIM 10
. V10.06.02 16/03/2015  Ebon Clements  CAR 298921
.           Reecompiled for changes to OUTBB1FD
.           17/03/2015  Davin          CAR 311669
.           Recompiled for VALDIOPS (ICD10 Ed.9)
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.------------------------------------------------------------------------------
. V10.05.22 02/03/2015  Ebon Clements  CAR 311848
.           Recompiled for OUTBOATM - Cancelled appointment hospital display
. V10.05.21 24/02/2015  Don Nguyen     CAR 303885
.           Modified CHKDUP60 for IBCNMHOS=1.
.           Recompiled for OUTBOATM - Modified APPTAB00 to output PTHSNAME.
. V10.05.20 20/02/2015  Ebon Clements  CAR 291413
.           Added polling server calls to recalculate referral expiry
.           date after a DNA - PNTX0000
. V10.05.19 16/02/2015  Ebon Clements  CAR 291413
.           Added update of active referral expiry date on new booking  REFX0000
. V10.05.18 16/01/2015  Ebon Clements  CAR 311035
.           Fixed furture session edit in bulk DNA - PRODNA00
. V10.05.17 08/12/2014  Ebon Clements  CAR 305618
.           Added VINAHDEF - Default VINAH field functionality
. V10.05.16 03/12/2014  Don Nguyen        CAR 301527
.           Added RETREW00 - return linked Referral to Waiting status.
.           Added CHKOPL00 - check linked Referral for Outpatient visit.
.           Added OEXT9000.
. V10.05.15 14/11/2014  Ebon Clements     CAR 292656
.           Added link cancelled OP visit to a referral functionality
.           Recompiled for OUTBOATM - Appointment comments on cancellation list
. V10.05.14 11/11/2014  Ebon Clements     CAR 306431
.           Added linked referral test to future booking edit - CHKFBK00
. V10.05.13 30/10/2014  Patrick Adair     CAR 306576
.           Correct invalid BRANCH in NEWBOK10 (NEWBOK99 not SHWBOK99)
.           Correct invalid BRANCH in CLST3500 (CLST9999 not GETCTY99)
.           Correct invalid BRANCH in SWAI0000 (SWAI9999 not UWAT9999)
.           24/10/2014  Patrick Adair     CAR 302971
.           Do Not default Visit type field for NZ - VTYSEL00
.           03/11/2014  Davin             CAR 294802
.           Added trigger 42 to send A08 instead of A04 from supervisor update
.           screen if booking status isn't changing (atndflag/updbok84)
. V10.05.12 23/10/2014  Davin             CAR 305297
.           Send A08 instead of A04 from wahealth outpatient discharge screen
. V10.05.11 16/10/2014  Ebon Clements     CAR 291413 
.           Write record for polling server for AH referral expiry
.           date recalulation on attendance - POLX0000
. V10.05.10 13/10/2014  Ania P            CAR 303879 
.           Added HP code output
. V10.05.09 06/10/2014  Ebon Clements     CAR 268970
.           Removed OUTCLIFD index 4 open as it was not used
. V10.05.08 19/09/2014  Ania P            CAR 304182
.           Fixed U*R by ensuring OTCNMTVS/OTCNMTVE is not zero
. V10.05.07 11/09/2014  Don Nguyen        CAR 302792
.           Recompiled for changes to VALDIOPS
.           10/09/2014  J.Tan             CAR 274958
.           Added Employer code to pmswx1af file
. V10.05.06 18/08/2014  Ania P            CAR 303879
.           Added OTBBPURC
.           13/08/2014  Peter Vela        CAR 304860
.           Recompiled for PMSVX1TM
. V10.05.05 05/08/2014  Peter Vela        CAR 302164
.           Added PMMIRBRS - Rebate Reason CAT Rr
. V10.05.04 05/08/2014  Ania P            CAR 208234
.           Slight modification of OEXT8800 to handle spaces
. V10.05.03 22/07/2014  Ebon Clements     CAR 303362
.           Added OTCNHSEC - Using Hospital Security Access in Mult
.                            Hospital Outpatients
. V10.05.02 16/07/2014  Ebon Clements     CAR 251384
.           Added tier 2 code functionality
. V10.05.01 15/07/2014  Don Nguyen        CAR 303564
.           Modified CLSRCH11 to replace spaces with '+' for SRCHREFN before use
. V10.04.15 02/07/2014  Ebon Clements     CAR 289315
.           Re read the correct referral record before leaving the auto
.           activate master referral function - AMAS0000
. V10.04.14 20/05/2014  Ebon Clements     CAR 300776
.           Re read correct outbokaf record before displaying checkbox DISLST24
. V10.04.13 09/05/2014  Don Nguyen        CAR 300097
.           Recompiled for NHIMASTM - Fixed SETMWD00 to clear date values
. V10.04.12 07.04.2014  Ania P            CAR 208234
.           Added sections for new contract code tables
.           07/04/2014  Ebon Clements     CAR 289785
.           Display extended slots as unavailable multi therapist view  MTSO0000
. V10.04.11 07/04/2014  Peter Vela        CAR 286158
.           Recompiled for PATMASTM
. V10.04.10 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.09 27/03/2014  Ebon Clements     CAR 227351
.           Recompiled for OUTBOATM - Cancelled appointment list
. V10.04.08 21/03/2014  Steve Armstrong   CAR 298483
.           Recompiled for changes to DGCLICOB, DGCLICON, DGCLICOR & DGCLICOC
.           20/03/2014  Patrick Adair    CAR 294644
.           Display inactive clinic sessons that exist prior to current date
. V10.04.07 04/03/2014  Ebon Clements    CAR 298070
.           Set exit to ZERO at end of ATTD0000 to fix incorrect error message
. V10.04.06 27/02/2014  Don Nguyen       CAR 291879
.           Call WIPL0000 for Booked, Attended, DNA
. V10.04.05 17/02/2014  Steve Armstrong  CAR 292355
.           Mods to reread the booking record (outbokaf) after calling RCAL000
.           in ATTD0000, to restore the booking details.
. V10.04.04 06/02/2013  Peter Vela       CAR 295606
.           Added ALCNDAMR to AMAS0000
. V10.04.03 17/01/2014  J.Tan        CAR 295008
.           Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.           20/01/2014  J.Tan        CAR 249828 
.           Added PMMIPMBS - Patient MBS Team and Counter
. V10.04.02 14/01/2014  Patrick Adair    CAR 230628
.           Added check for future booking for same site,clinic & type(CHKFBK00)
.           and added check into bulk discharge list (DISLST00)
. V10.04.01 12/12/2013  Ebon Clements  CAR 293092
.           Added notified and confirmed to interpreter audit
.           02/12/2013  Steve Armstrong  CAR 292355
.           AUDOTBOA - removed and made an external routine
.           AUDOTBOB - removed and made an external routine
.           CSLT0000 - removed and made an external routine (SLTCOUNT)
.           ADDATT00 - removed and replaced by RCAL0000
.           AWAT0000 - removed and made an external routine (ATWLLINK)
.           AWAI0000 - removed and made an external routine (ATWLLINK)
.           ASTP0000 - removed and made an external routine (ATWLLINK)
.           ASTA0000 - removed and made an external routine (ATWLLINK)
.           PCHG0000 - removed and made an external routine (POSTCHRG)
.           These changes will enable the sharing of code with HL7RECVR
.           for processing or O/P A03 & A04 messages.
.------------------------------------------------------------------------------
. V10.03.96 14/10/2013  Ania P         CAR 278232
.           Refactored code - now using COUNTSLT for session recalculation
. V10.03.95 10/10/2013  Davin          CAR 291578
.           Recompiled for BRHLCOMN - check pmsqpt for message id to stop I*D
. V10.03.94 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.93 03/10/2013  Ania P         CAR 285905
.           Added output 77 (Clinic Type Desc) to FUSTB000
. V10.03.92 02/10/2013  Peter Vela     CAR 291757
.           Recompiled for ALLREFTM
. V10.03.91 26/09/2013  Jill Parkinson CAR 291691
.           Recompiled for NZHISWIO - over 15 medical warnings looping
. V10.03.90 30/08/2013  Don Nguyen       CAR 273426
.           Recompiled for changes to CLALLREF
.           27/08/2013  Ebon Clements    CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.89 15/08/2013  Ebon Clements    CAR 289581
.           Fixed clinic type filter on clinic search - CLSRCH00
. V10.03.88 12/08/2013  Don Nguyen       CAR 289581
.           Isolated index selection (index 4) in CLSRCH00 for WA only
. V10.03.87 23/07/2013  Peter Vela       CAR 288287
.           Added validation for new visit type CHKOVR00 Check overbookings
. V10.03.86 30/06/2013  Davin            CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.85 18/07/2013  Jill Parkinson   CAR 288525
.           Recompiled for NZHISWIO
. V10.03.84 04/07/2013 Jill Parkinson    CAR 287923    
.           Added branches on exit after every WEBERR00 call - CANS0000,
.           PRODNA00,ADDSLT86,RSHSLT00
.           Removed WEBERR00 from PRNT9000 completely
. V10.03.83 30/06/2013  Davin            CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.82 25/06/2013  Peter Vela       CAR 248221
.           Added Outpatient redirect functionality - Redirect back to 
.           Original rescheduled appointment
. V10.03.81 14/06/2013  Ebon Clements    CAR 256943
.           Write OUTBOCFD record for linked referral - LNKR0000
. V10.03.80 05/05/2013  Peter Vela       CAR 285692
.           Stopped DNA Send Letter and Generate Letter Date from being
.           overwritten
. V10.03.79 28/05/2013  Peter Vela       CAR 261630
.           Removed port number from temp file name
. V10.03.78 20/05/2013  Don Nguyen       CAR 285199
.           Recompiled for changes to OUTBOATM (OBOX1100)
.           Added NXTAPP87 - Output Outpatients Clinic Description (site-based)
. V10.03.77 07/05/2013  J.Tan            CAR 284694
.           Mods Overseas Student PRFA to default to Local address
. V10.03.76 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.75 23/04/2013  Davin         CAR 284420
.           Recompiled for VALDIOPS (ICD10 Ed.8)
. V10.03.74 24/04/2013  Don Nguyen       CAR 284059
.           Recompiled for changes to PATCODTM
. V10.03.73 24/04/2013  Don Nguyen       CAR 283242
.           Added SLST5400 to output selection list for Clinic Location Type
. V10.03.72 22/04/2013  Ebon Clements    CAR 284166
.           Fixed reschedule duplicate appointment message - CHKDUP00
. V10.03.71 19/04/2013  Patrick Adair    CAR 246553
.           Display diagnosis details in Multi Therapist view
. V10.03.70 18/04/2013  Patrick Adair    CAR 245648
.           Added match of OSESTRT to OBASTRT in MTRW1500
. V10.03.69 09/04/2013  Peter Vela       CAR 283556
.           Added Add Slot functionality for DNA Appointment
. V10.03.68 03/04/2013  Davin            CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.67 26/03/2013  Ebon Clements    CAR 277862
.           Fixed mandatory referral patient column display in search - EMPTYS50
. V10.03.66 22/03/2013  Ebon Clements    CAR 278231
.           Added bulk contact to DNA patients functionality
. V10.03.65 19/03/2013  Jill Parkinson   CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.64 18/03/2013  Peter Vela       CAR 277267
.           Commented out SOP referral validation @ FAPD0000
. V10.03.63 18/03/2013  Ebon Clements    CAR 281895 
.           Added visit type to no slots available message - NXTAPP00 & NXTAID00
. V10.03.62 14/03/2013  Ebon Clements    CAR 282385 
.           Fixed setting value of DISCFLAG in UPDBOK00 for discharge message
.           Fixed sepervisor cancel discharge messaga sequence - UPDBOK83
. V10.03.61 06/03/2013  Peter Vela       CAR 279686
.           Added tags for Linked Referral Number and Linked Referral Department
. V10.03.60 20/02/2013  Peter Vela       CAR 274327
.           Added new TableType to CASMTC00
.           19/02/2013  Ebon Clements    CAR 277862
.           Added mandatory referral functionality
. V10.03.59 06/02/2013  Peter Vela       CAR 277436
.           Added SP70 validation for ALENOUTC at CNTCT000
. V10.03.58 06/02/2013  Peter Vela       CAR 277436
.           Added SP70 validation for ALENUTM2 at CNTCT000
. V10.03.57 06/02/2013  Peter Vela       CAR 277436
.           Added Z70 validation for CGI variables @ ATTD6000
. V10.03.56 31/01/2013  Ebon Clements    CAR 262292
.           Added language to interpreter audit       
. V10.03.55 23/01/2013  Patrick Adair    CAR 270888
.           Correct Patient Rescheduling Process
. V10.03.54 17/01/2013  Ebon Clements    CAR 262292
.           Recompiled for PMSVX1TM - Interpreter tag
. V10.03.53 17/12/2012  Peter Vela       CAR 276833
.           Added update to allencaf on Outpatient Appointment Attendance of 
.           Presenting Compalint, Outcome, Outcome Date/Time
. V10.03.52 28/11/2012  Ebon Clements    CAR 267173
.           Multi session patient list changes
.           27/11/2012  Peter Vela       CAR 262297
.           Recompiled for VISCMTFD
.           Added Patient Instructions
. V10.03.51 23/11/2012  Ebon Clements    CAR 276671
.           Changed session search to select the most efficient key - CLSRCH00
. V10.03.50 21/11/2012  Peter Vela       CAR 276423
.           Recompiled for OUTARTTM
. V10.03.49 16/10/2012  J.Tan            CAR 263723
.           Fixed re-appoint.to set Post address to PRFA for WA
. V10.03.48 12/10/2012  Saroeun Soeur    CAR 269143
.           call to OPDM0000 in procedure CHKSL000
. V10.03.47 11/10/2012  Peter Vela       CAR 270586
.           Added Slot Time to FUSTB000
. V10.03.46 19/09/2012  Peter Vela       CAR 270712
.           Added Clinic Location validation to FREF0000
. V10.03.45 31/08/2012  Peter Vela       CAR 266428
.           Added VSINCHON before write to visintaf
. V10.03.44 28/08/2012 Saroeun Soeur       CAR 261981
.           EMPTYS00 - added TCIND2 to output list 
. V10.03.43 10/08/2012 J.Tan               CAR 269432
.           Mods to check for 'Parent of' option for PRFA
. V10.03.42 03/08/2012 Peter Vela          CAR 267421
.           Commented out Update Status to waiting @ URSR9000
. V10.03.41 26.07.2012 Peter Vela   CAR 266428
.           Added INTDEL00 to INTUPD00
. V10.03.40 14.07.2012 B.G.Ackland  CAR267173
.           Performance Tuned New Tag for Appointment List Multi Session CheckIn
. V10.03.39 14.07.2012 B.G.Ackland  CAR267173
.           Performance Tuned New Tag for Appointment List Multi Session CheckIn
. V10.03.38 12/06/2012 Peter Vela          CAR 266428
.           Added validation for chart only indicator @ INTUPD00
. V10.03.37 07/06/2012 Ebon Clements       CAR 266682
.           Fixed save of patient comments max of 99 lines - GETCOM00
. V10.03.36 16/05/2012  Steve Armstrong  CAR 256322
.           Recompiled for changes to NZHISWIO.
.           15/05/2012 J.Tan               CAR 255708
.           Mods checking for Hold Invoices From Date
. V10.03.35 26.04.2012  Ebon Clements     CAR 261277
.           Populate first appointment booked on SOP int referral - FAPD0000
. V10.03.34 12.04.2012  Ebon Clements     CAR 261277
.           Auto activate master referral if internal is activated  - AMAS0000
. V10.03.33 16/03/2012  Steve Armstrong  CAR 260226
.           Further changes for appointment reschedules HL7 Triggers - 
.           Added UPDBOK81 to trigger A05 after reschedule.  Also moved
.           A38 trigger to UPDBOK50 to pick up the original booking date/time
.           instead of the new booking.
.           Also moved A38 trigger for clinic reschedules to pick up the
.           original booking date/time instead of the new booking.
. V10.03.32 14/03/2012  Davin            CAR 260226
.           Added alternate HL7 triggers for appointment reschedules - 
.           Replace A08 with A38 and A05 (based on parameter ptcnh7ra)
. V10.03.31 09/03/2012  Peter Vela       CAR 261183
.           Added check for cancellation in RCAL0000
. V10.03.30 01/03/2012  Ebon Clements    CAR 260528
.           Changed LOOPCNTR modulus test to IF test in CLSRCH00
. V10.03.29 29/02/2012  J.Tan            CAR 260930
.           Mods to write Extra Compensable details for Follow up appointment
. V10.03.28 29/02/2012  Ebon Clements    CAR 209358
.           Recompiled for OUTBOATM - Rescheduled appointment alert
. V10.03.27 21/02/2012  Saroeun Soeur    CAR 234857
.           Recompiled for PATCODTM
. V10.03.26 21/02/2012  Ebon Clements    CAR 242394 
.           Changed confirm appointment list to display phone numbers - CONLST00
. V10.03.25 20/02/2012  Steve Armstrong  CAR 260254
.           Added further call to DGCLICOB (A08) after reschedule for a non-
.           suspended clinic.
. V10.03.24 15/02/2012  Steve Armstrong  CAR 260254
.           Added call to DGCLICOB (A08) after superviser reschedule for a
.           clinic (RHSAPP00).
. V10.03.23 14/02/2012  Ebon Clements    CAR 250415
.           Fixed save of reason for appointment request - WREQ0000
. V10.03.22 13/02/2012  Ebon Clements   CAR 257102 
.           Don't call DGCLICON in REAP0000 for follow up appointments
. V10.03.21 09/02/2012  Jill Parkinson  CAR 253480
.           Changed BDIS8400 to call DGCLICOB instead of DGCLICOA
.           Changed BDEP8400 to call DGCLICOB instead of DGCLICOA
. V10.03.20 07/02/2012  Ebon Clements   CAR 258391
.           Added tag for show transport showtran
. V10.03.19 06/02/2012  Peter Vela      CAR 258382
.           Added tag for saved Disaster Code description
. V10.03.18 06/02/2012  Ebon Clements   CAR 258391
.           Added latest transport key tag - OEXT7700
. V10.03.17 01/02/2012  Ebon Clements   CAR 259014
.           Added visit type tag to next appointment tag - NXTAPP00
. V10.03.16 27/01/2012  Mike Laming     CAR 200172
.           Mods to CHKDNA00 to turn off DNA Warning with parameter OTCNRDWB
. V10.03.15 17/01/2012  J.Tan             CAR 258661
.           Fixed PRFA for WA Private Uninsured
. V10.03.14 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.13 12/01/2012  Ebon Clements    CAR 244332
.           Added population of visit extn file aboriginality
. V10.03.12 09/01/2012  Saroeun Soeur    CAR 234591
.           added JAVSDES for OCADESC at SMPTYS50
. V10.03.11 04/01/2011  Ebon Clements   CAR 253762
.           Don't save OPD actions for hospital based OPD users
. V10.03.10 22/12/201   Ebon Clements   CAR 256463
.           Added retain UR on slot insert functionality
. V10.03.09 09/12/2011  Ebon Clements   CAR 246872
.           Populate new fields in OUTCANFD and OUTRSHFD
. V10.03.08 06/12/2011  J.Tan           CAR 256194
.           Mods to update PRFA details for Public (for Extra compensable)
. V10.03.07 01/12/2011  Ebon Clements   CAR 256004
.           Default ref claim detail to OP if booked from a referral - RCLM0000
. V10.03.06 30/11/2011  Ebon Clements   CAR 255228
.           Added patient phone numbers to follow up referral list - FREF0000
. V10.03.05 25/11/2011  Ebon Clements   CAR 255521
.           Added read of visit extn for new appointment defaults - NEWBOK00
. V10.03.04 24/11/2011  Ebon Clements   CAR 255734
.           Added showcpmi to NEXT0000 and PREV0000
. V10.03.03 20/11/2011  Nicole Torrisi  CAR 240817
.           Recompiled for changes to OUTBOATM
. V10.03.02 17/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
. V10.03.01 14/11/2011  Ebon Clements   CAR 255228
.           Added NOK mobile to follow up referral list - FREF0000
. V10.02.33 20/10/2011  Steve Armstrong  CAR 247702 
.           Mods to use SAVEURNO to read patient PMI details in RSHA0000
.           and RSHS0000 prior to calling LOGR0000.
. V10.02.32 20/10/2011  Ebon Clements    CAR 253626 
.           Fixed I * C on workers comp file when re-scheduling
. V10.02.31 17/10/2011  Ebon Clements    CAR 251885 
.           Fixed date display in appointment request message - CHKREQ00
. V10.02.30 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.29 10/10/2011  Nicole Torrisi    CAR 246640
.           Added UCLM0000 to update visit date when re-scheduling an
.           appointment that has a patwc1af record
. V10.02.28 04/10/2011 Ebon Clements   CAR 252279
.           Fixed department and source of ref for appt request - WREQ0000
. V10.02.27 04/10/2011 Ebon Clements   CAR 251885
.           Only match request preferred date if populated - CHKREQ00
. V10.02.26 30/09/2011 Jill Parkinson  CAR 248486
.           Recompiled for IBAWEBCD - Restrict hospital access
. V10.02.25 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.24 13/09/2011  Steve Armstrong   CAR 247702
.           Changed code to use OBAURNO instead of URNUMBER when loading
.           PMI details prior to calling LOGR0000, so that DGCLICOR
.           has patient details.
. V10.02.23 08/09/2011  Peter Vela        CAR 249984
.           Mods to delete disptlaf dispataf and alternate id records when 
.           cancelling outpatient
. V10.02.22 06/09/2011  Peter Vela        CAR 249285
.           Added read of disptlaf in NEWBOK00
. V10.02.21 01/09/2011  Ebon Clements     CAR 242014
.           Added outpatient direct functionality
. V10.02.20 30/08/2011  Steve Armstrong   CAR 247702
.           Added read of PMI details before calling LOGR0000 so that
.           DGCLICOR has the current patient.
. V10.02.19 26/08/2011  Peter Vela     CAR 249292
.           Added prefix functionality to NWDALT00
. V10.02.18 24/08/2011  Davin          CAR 249091
.           Changed 'printer selected' cgis to 6 chars
. V10.02.17 23.08.2011  Ebon Clements  CAR 249416
.           Added end of search results line to CLSRCH00
. V10.02.16 22/08/2011  Ebon Clements  CAR 249416  
.           Add LOOPCNTR comment to keep apache listening - CLSRCH00
. V10.02.15 12/07/2011  Peter McMullen CAR 248483  
.           Recompile for OUTARTTM  
. V10.02.14 08/08/2011  Peter Vela        CAR 239559
.           Added Disaster functionality
. V10.02.13 03/08/2011  Ebon Clements     CAR 247287
.           Added display of funding source
. V10.02.12 22/07/2011  Ebon Clements     CAR 239525
.           Highlight chart review on booking view not just contact view
. V10.02.11 13/07/2011  Ebon Clements     CAR 242246
.           Added cgi vars for NMDS code, care type service delivery and
.           clinical risk
. V10.02.10 13/07/2011  Ebon Clements     CAR 242246
.           Recompiled for OUTBOATM - Display hospital on cancelled appt list
            13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.09 22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PATGSRFD:
.                - GSRSNAM & GSRGNAM extended to 30 chars.
.                - PTGSGNM2 added.
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
. V10.02.08 27/06/2011  Ebon Clements  CAR 242809          
.           Added clinical high risk to FUSTB000
. V10.02.07 22/06/2011  Ebon Clements  CAR 242809          
.           Added confirm PMI to multi session patient list
. V10.02.06 16/06/2011  Ebon Clements  CAR 239534          
.           Added using check in page functionality
. V10.02.05 03/06/2011  Ebon Clements  CAR 239525          
.           Added confirm PMI functionality 
. V10.02.04 20/05/2011  Ebon Clements  CAR 239554          
.           Added generate letter date functionality
. V10.02.03 13/05/2011  Ebon Clements  CAR 240720          
.           Added requested appointment functionality
. V10.02.02 10/05/2011  Davin          CAR 239539 WA Health
.           Allow 3 alert indicators to be displayed (ALERTST2 in FUSTB000)
. V10.02.01 16/03/2011  Jill Parkinson    CAR 239574
.           Increased printer size
.------------------------------------------------------------------------------
. V10.01.05 06/12/2010  Ebon Clements     CAR 233927
.           Added reason for hold update to invoice pending
. V10.01.04 03/12/2010  Ebon Clements     CAR 233307
.           Added contview and tablview to CLILNK00
. V10.01.03 24/11/2010  Jill Parkinson    CAR 233094
.           Added call to CHKHCU00 in NEWBOK00
. V10.01.02 22/11/2010  Ebon Clements     CAR 234016
.           Fixed reschedule booking after froup sesssion changes - DBOK0000
. V10.01.01 17/11/2010  Jill Parkinson    CAR 233088
.           Increased PTMAS038 from 10 to 19
. V10.00.29 12/10/2010  Peter Vela        CAR 230308
.           Added CHKGRP00 Check for Group Sessions
. V10.00.28 11/10/2010  Ebon Clements     CAR 169450
.           Read WL details to default values to PAC/PAS appointment - NEWBOK00
. V10.00.27 17/09/2010  Ebon Clements     CAR 230239
.           Re-Compiled for MRTVISCD - Home Location and Document type test
. V10.00.26 27/08/2010  Mike Laming       CAR 227913
.           Add ALRESTAT & ALREDCLO to "Fields for Booking" - OEXT0000
. V10.00.25 24/08/2010  Saroeun Soeur     CAR 224822
.           created table sort variable to control the row height based on 
.           the number of diagnosis - HEIGHTCT
. V10.00.24 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.23 18/08/2010 J.Tan            CAR 222031
.           Mods to set PMMIDUPD and PMMITUPD
. V10.00.22 12/08/2010 Ebon Clements     CAR 228051 
.           Write previous visits claim details on DNA new appointment UPDBOK20 
. V10.00.21 11/08/2010 Ebon Clements     CAR 228089 
.           Fixed bug in diagnosis display - FUSTB010
. V10.00.20 10/08/2010 Ebon Clements     CAR 216343 
.           Update allied health link booking in reschedule session - RSHS0000
. V10.00.19 22/07/2010 Ebon Clements     CAR 85133  
.           Recompiled for OUTBOATM - cancelled appointment list
. V10.00.18 21/07/2010 Peter Vela        CAR 221770
.           Added floating <div> functionality to MTDA0000
. V10.00.17 14/07/2010 Saroeun Soeur     CAR 160256
.           fixed js bug and display GP or Clinic independently.
. V10.00.16 12/07/2010 Ebon Clements     CAR 192810
.           Added chart review slot highlight - PRGPLB00 & CASSTB00
. V10.00.15 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.14 10/06/2010  Mike Laming    CAR 215594
.           Add param. OTCNDACI & mods at FUSTB010 for Diagnosis view for NZ
. V10.00.13 08/06/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.12 08/06/2010  Ebon Clements  CAR 207293
.           Added bulk discharge functionality - DISSLT00
. V10.00.11 03/06/2010  Ebon Clements  CAR 208220
.           Recompiled for OUTBOATM -  Added comment icon link to APPTSU00
. V10.00.10 02/06/2010  Saroeun  Soeur CAR 160256
.           OP Contact Details Template changes - FUSTB100
. V10.00.09 01/06/2010  Ebon Clements  CAR 222588
.           Added tag to indicate if visit has transport - OEXT5300
. V10.00.08 28/05/2010  J.Tan          CAR 222781
.           Fixed patipenaf file for un-attended patient
. V10.00.07 25/05/2010  Saroeun Soeur  CAR 222635
.           Recompiled from IBAWEBCD - LABELSEL
. V10.00.06 21/05/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.05 20/05/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.00.04 04/05/2010  Ebon Clements  CAR 221164
.           Added slot type to empty slots on multi therapist view MTSO0000
. V10.00.03 27/04/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.00.02 20/04/2010  Ebon Clements  CAR 219825
.           Fixed save of referral date if booked from AH referral (BOOKFLAG=2)
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.24  02/02/2010  Steve Armstrong   CAR 135505
.           Added DGCLII13 trigger
.           24/02/2010  Ebon Clements  CAR 207040
.           Added manage health fund program functionality
. V9.12.23  18/02/2010  Ebon Clements  CAR 214121
.           Added update of transport date when rescheduling appointments
. V9.12.22  21/01/2010  Ebon Clements  CAR 214121
.           Added OTCNINTR - Using visit based interpreter required
. V9.12.21  13/01/2010  Jill Parkinson CAR 211158
.           Recompiled for OUTBOATM - default cat CL won't select inactive code
. V9.12.20  18/12/2009 Ebon Clements  CAR 210960 
.           Allow reset of appointment confirmed when rescheduling visits
.           18/12/2009 Davin          CAR 212469 
.           Changed system wide comments tag (clst2200) to check for 'blanks'
.           not 'ALL' for site and clinic
. V9.12.19  10/12/2009 Peter McMullen CAR 210130 
.           convert to new dr name formatting routine DOCNM000                
. V9.12.18  30/10/2009 WeeLee Koo    CAR 208509
.           Fixed Comments,Presenting Complaint and Diagnosis for Bulk Follow Up
.           (WPRC0000,WDIA0000,WCOM0000)
. V9.12.17  07/10/2009 Ebon Clements CAR 205398
.           Display group session assigned HCP in multi therapist view time slot
. V9.12.16  24/09/2009 Saroeun Soeur CAR 205504
.           Recompiled for IBAWEBCD
. V9.12.15  26/08/2009 Ebon Clements CAR 202965
.           Added visit based CDM details FUSTB000
. V9.12.14  21/08/2009  Jill Habasque  CAR 204172
.           Mods to fix obaoutno in BOKUPD00 for reappointments
. V9.12.13  11/08/2009  Saroeun Soeur  CAR 198631
.           list all diagonsis description - FUSTB000
. V9.12.12  05/08/2009  WeeLee Koo     CAR 191121
.           Display referral date if booking from AH referrals - (BOOKFLAG=2)
. V9.12.11  03/08/2009  Peter Vela     CAR 202829
.           Added functionality for OTCNREVC - Visit Type when OTCNCrEV is set
.           to Yes
. V9.12.10  29/07/2009  Ebon Clements  CAR 202124
.           Added clear of OBAATTN for follow up appointments - RFOL1000
. V9.12.09  29/07/2009  Jill Habasque  CAR 145706
.           Mods to loop through all sites for GPLIS000
. V9.12.08  24/07/2009  Saroeun Soeur  CAR 201775
.           CASTAB20 - Fixed pm problem with time at midday
. V9.12.07  22/07/2009  Jill Habasque  CAR 145706
.           Added output of obatime in GPLIS000
. V9.12.06  21/07/2009  Jill Habasque  CAR 145706
.           Mods to only output in GPLIS000 if informgp = yes
. V9.12.05  08/07/2009  Ebon Clements  CAR 200816
.           Fixed claim default as bookings don't have a visit record - LCLM0000
. V9.12.04  08/07/2009  Ebon Clements  CAR 200735
.           Fixed syntax error in WINPAR00 and ERRLST00 redirect
. V9.12.03  18/06/2009  Ebon Clements  CAR 196539
.           Allow update of bookings if they are before the deceased date
. V9.12.02  22/05/2009  Ebon Clements  CAR 189992
.           Added multi session patient list 
. V9.12.01  12/05/2009  Jill Habasque  CAR 145706
.           Added GPLIS000
. V9.11.08  07/04/2009  Peter Vela     CAR 183976
.           Moved spaces to PMVXPILC before WRPMVX11
. V9.11.07  17/02/2009  Peter Vela     CAR 183976
.           Moved spaces to PMVXPOEC before WRPMVX11
. V9.11.06  09/12/2008  Peter Vela     CAR 185002
.           Added unavailable comments in Multi Therapist view
. V9.11.05  08/12/2008  Peter Vela     CAR 185002
.           Fixed display of unavailable slots in Multi Therapist View
. V9.11.04  26/11/2008  Peter Vela     CAR 181690
.           Adjusted table widths for Multi Therapist View
. V9.11.03  07/11/2008  Peter Vela     CAR 181690
.           Added tag for Keyin Doctor Code OMAKDOC
.           Added update outsesaf for outweb0202017.html Assign Health Care Prof
.           Fixed javascript in WINPAR00
.           Added reportno for Multi Therapist View
. V9.11.02  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.01  16/10/2008  Ebon Clements  CAR 171540
.           Added new tag to OEXT0000 for the referral department
. V9.10.07  01/09/2008  Ebon Clements  CAR 171027
.           Fixed display of clinic name - SESDET00 and CLITAB00
. V9.10.06  01/09/2008  Ebon Clements  CAR 175555
.           Fixed display of clinic name in CLSRCH00 and CLISTB00
. V9.10.05  26/08/2008  Ebon Clements  CAR 174175
.           Recompiled for PATNAMCD - DOB display bug
.           26/08/2008  Mike Laming       CAR 176293
.           Recompiled for VALDIOPS - correct "Posting Code" test
. V9.10.04  31/07/2008  Ebon Clements  CAR 171540
.           Fixed open of ALLAUDLN
. V9.10.03  24/07/2008  Jill Habasque  CAR 174560
.           Changed WEBWRN 120[30] to 120[99]
. V9.10.02  18/07/2008 Jill Habasque   CAR 173941
.           Mods to not call WRAP0000 if reportno is 6 (new appointment)
. V9.10.01  05/05/2008  J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.09.17  13/02/2008  Peter Vela    CAR 155334
.           Removed new pmsmtiaf variable
. V9.09.16  12/02/2008  J.Tan          CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.15  06/02/2008  Ebon Clements CAR 160547
.           Recompiled for PMSVX1TM - Appointment Confirmed tag
. V9.09.14  01/02/2008  Peter Vela    CAR 155334
.           Initialised new pmsmtiaf variable
. V9.09.13  14/01/2008  Ebon Clements CAR 146279
.           Added allied health referrals to CHKLET00
. V9.09.12  04/01/2008  J.Tan          CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.11  20/12/2007  Ebon Clements CAR 157301
.           Changed CONFAP00 to write missing visit extn file records
. V9.09.10  29/10/2007  Ebon Clements CAR 153567
.           Recompiled for OUTBOATM - Multi hospital test to VISSEL00
. V9.09.09  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.08  13/09/2007  Ebon Clements CAR 100599
.           Recompiled for VALDIOPS - Added OUTPFLAG
. V9.09.07  11/09/2007  Ebon Clements CAR 144926
.           Added srchcind to NEXT0000 and PREV0000
. V9.09.06  24/08/2007  Ebon Clements CAR 133923
.           Changed department selection lists to be in alphabetical order
.           10/08/2007  Steve Armstrong   CAR 145650
.           Added call to DGCLICOB when visit is updated to no longer be
.           an ACC (patwc1af) claim.
.           Added call to DGCLICOB when ACC (patwc1af) record is created.
. V9.09.05  01/08/2007  Jill Habasque  CAR 54741
.           Added clear of OBAATTN in REAP1000
. V9.09.04  12/07/2007  Jill Habasque  CAR 137140
.           Added check for deceased date in REMBOK00 (instead of just pcease)
. V9.09.03  03/07/2007  Ebon Clements  CAR 143552
.           Recompiled for OUTRFLTM - Referring gp on referral list display
. V9.09.02  20/06/2007  Ebon Clements  CAR 143100          
.           Fixed attended only test in ENCLST00
. V9.09.01  07/05/2007  Peter Vela     CAR SJOG ED Billing
.           Initialised new pmsmtiaf variables
.------------------------------------------------------------------------------
. V9.08.13  16/03/2007  Neelkamal Pyla CAR 121804
.           Added tag for OEXT0000 - OEXT4500 to display Correctional Health 
. V9.08.12  14/03/2007  Jill Habasque  CAR 130825
.           Changed WEBWRN 120[10] to 120[30]
. V9.08.11  06/03/2007  Neelkamal Pyla CAR 122583
.           Modified FUSTB000 to append Transport booked data to ALERTSTR
. V9.08.10  02/03/2007  Ebon Clements CAR 131383
.           Changed reads on the clinic file to use the effective date
. V9.08.09  28/02/2007  Ebon Clements CAR 119815
.           Recompiled for WEBDATCD - display +/- 1 week for day view
. V9.08.08  23/02/2007  Jill Habasque CAR 124992
.           Added check for IBCNMHOS before using WBSEHOSP
. V9.08.07  06/02/2007  Ebon Clements CAR 132335
.           Added attended only edit to ENCLST00
. V9.08.06  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.05  23/01/2007  Mike Laming   CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.04  14/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.03  26/10/2006  Steve Armstrong    CAR 121932
.           Fixed DGCLICON call in REAP0000 to only be called when not a
.           new appointment (as DGCLICON is called later in WRTBOK00 and
.           more data fields are populated at that stage).
. V9.08.02  19/10/2006  Ebon Clements  CAR 119559
.           Recompiled for PATCODTM - Include/Exclude cat codes with indicator
. V9.08.01  19/10/2006  Ebon Clements      CAR 121930
.           Added write of visit extn at UPDBOK20 non attendance new appointment
.------------------------------------------------------------------------------
. V9.07.19  13/09/2006  Ebon Clements      CAR 118970
.           Added tag for OCADOCT - CLST5400 
. V9.07.18  12/09/2006  J.Tan              CAR 118782
.           Fixed update booking not to write rec to outbit if already claimed
. V9.07.17  12/09/2006  Ebon Clements      CAR 110245
.           Recompiled for OUTHEDFD
. V9.07.16  07/09/2006  Jill Habasque      CAR 109852
.           Added output of alternate ID if PTCNDAUR=1
.           07/09/2006  Steve Armstrong    CAR 115764
.           Added call to DGCLICOD when non-attending a booking (in NATT0000).
.           Added call to DGCLICON when creating a new booking after a DNA
.           (in REAP0000).
. V9.07.15  06/09/2006  Steve Armstrong    CAR 108060
.           Added calls to PMIGTNID prior to all DGCLI* routines so that
.           the nhi variables are set.
. V9.07.14  31/08/2006  Ebon Clements CAR 111757
.           Added DEFTOVRD cgi and tag
. V9.07.13  31/08/2006  Ebon Clements      CAR 117488
.           Added unlock booking file after update extra booking screen
. V9.07.12  18/08/2006  Ebon Clements      CAR 110245
.           Delete trasnport details when cancelling appointments
. V9.07.11  29/08/2006  Ebon Clements      CAR 102597
.           Added print referral letter option to cancel appointment
. V9.07.10  18/08/2006  Ebon Clements      CAR 102579
.           Added OTRFL017 and OTRFL018 cgi vars for cancel referral letter
. V9.07.09  04/08/2006   J.Tan             CAR 114258
.           Recompiled for HICCLAIM-init batch no previously batched
. V9.07.08  27/07/2006  Ebon Clements     CAR 113702
.           Changed WEBERR to DIM 65
. V9.07.07  20/07/2006  Ebon Clements     CAR 99899
.           Fixed extra screen functionality
. V9.07.06  24/07/2006   J.Tan             CAR 113531
.           Recompiled for HICCLAIM - init adjm amount
. V9.07.05  17/07/2006  Peter Vela    CAR 112753
.           Recompiled for VALDIOPS
. V9.07.04  12/07/2006  Ebon Clements     CAR 103365
.           Added adm expected payor functionality 
. V9.07.03  05/07/2006  Ebon Clements     CAR 107628
.           Added referral source OBASRCR to CASSTB00 clinic list 
. V9.07.02  03/07/2006  Steve Armstrong   CAR 109733
.           Fixed attendance update to send A08 instead of another A04
. V9.07.01  20/06/2006  Ebon Clements CAR 105627
.           Added extra letter trigger
.------------------------------------------------------------------------------
. V9.06.04  08/06/2006  Ebon Clements CAR 104282
.           Read pmi master files with OBAURNO in BOKUPD00 not PVIURNO
. V9.06.03  17/05/2006  Ebon Clements CAR 105541
.           Added multi hospital test to VTYSEL00
. V9.06.02  17/05/2006  Mike Laming      CAR 101974
.           Recompiled for ICD10 Ed.5 changes to VALDIOPS
. V9.06.01  08/05/2006  Steve Armstrong  CAR 103759
.           Recompiled for changes to DGCLICON & OUTQUEFD
.------------------------------------------------------------------------------
. V9.05.04  03/04/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.03  23/03/2006  Ebon Clements CAR 79277
.           Added OUTBB065 - Send correspondence to carer          
. V9.05.02  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.01  09/03/2006  Steve Armstrong  CAR 99223
.           Recompiled for changes to DGCLICOR
. V9.05.B13 03/03/2006  Steve Armstrong  CAR 88829
.           Recompiled for changes to OUTQUEFD
. V9.05.B12 01/03/2006  Ebon Clements CAR 94327
.           Added search max booking days to NXTAPP00 and NXTAID00
. V9.05.B11 20/02/2006  Ebon Clements CAR 76341
.           Added referral file audits
. V9.05.B10 02/02/2006  Ebon Clements CAR 75599
.           Changed OTBB029 and OTBB030 to DIM 10 - Gp fields
. V9.05.B09 01/02/2006  Ebon Clements CAR 91752
.           Added outpatient header file tags to OEXT4000
. V9.05.B08 13/01/2006  Peter Vela    CAR 89639
.           Recompiled for OUTRFLTM - Removed single quotes from OTRLDIAG
. V9.05.B07 13/01/2006  Peter Vela    CAR 89639
.           Recompiled for OUTRFLTM - Removed single quotes from OTRLDIAG
. V9.05.B06 13/01/2006  Ebon Clements    CAR 76341
.           Added bulk encounter functionality for SACS
. V9.05.B05 14/12/2005  Steve Armstrong  CAR 88829
.           Recompiled for changes to DGCLICOA, DGCLICOB, DGCLICOC,
.           DGCLICOD, DGCLICON, DGCLICOR & DGCLUCOU (for HL7 messages).
. V9.05.B04 19/12/2005  Peter Vela    CAR 85872
.           Added tag for OTBBGPPC (code and description) in OEXT0000
. V9.05.B03 20/12/2005  Ebon Clements CAR 76341
.           Key length changes for encounter number
. V9.05.B02 16/12/2005  Ebon Clements CAR 76341
.           Added confirm appointment functionality
. V9.04.59  30/11/2005  J.Tan         CAR 77215
.           Recompiled for HICCLAIM - check if generated batch no already exists
. V9.04.58  28/11/2005  Ebon Clements CAR 86279
.           Added date range filter to SALT0000 - Suspended appointment list
. V9.04.57  14/10/2005  Ebon Clements CAR 59229
.           Changed RCAL0000,ADDTIM00 and SUBTIM00  to use slot
.           duration OTHEDURN not OMADURN
.           Changed CLISTB00 to output output OTHEDURN not OMADURN
. V9.04.56  07/09/2005  Ebon Clements CAR 71501
.           Added new tag SLST4400 - clinic list with location default
. V9.04.55  30/08/2005  Peter Vela CAR 62749
.           Repopulate OBAOUTNO for Print Cancellation Letters.
. V9.04.54  10/08/2005  J.Tan  CAR 69062
.           Recompiled for HICCLAIM - checking for blank payee prov.
. V9.04.53  08/08/2005 J.Tan  CAR 69062
.           Fixed to check and update payee prov when actual doc not changed
. V9.04.52  05/08/2005 J.Tan  CAR 69062
.           Recompiled for HICCLAIM - Checking for existing claim number
. V9.04.51  01/08/2005 J.Tan  CAR 69062
.           Changed claim index 7 to include voucher no
. V9.04.50  28/07/2005  J.Tan          CAR 69403
.           Mods field Actual doctor seen to be readonly after being batched
. V9.04.49  22/07/2005  J.Tan          CAR 68585
.           Changing status to 'Not attended' to remove records from HIC's files
. V9.04.48  07/07/2005  J.Tan          CAR 66498
.           Fixed reprint claim if MCI/Payee/Provider has changed
. V9.04.47  06/07/2005  Ebon Clements CAR 66119
.           Added tag for clinics medical practice - OEXT3700
. V9.04.46  04/07/2005  Ebon Clements CAR 66205
.           Added URSR0000 to update referral status when cancel/reschedule 
.           04/07/2005  Jill Habasque CAR 61468
.           Added DOCLMN00                                 
. V9.04.45  01/07/2005  J.Tan  
.           Recompiled for HICCLAIM - 85% of claim amount
. V9.04.44  28/06/2005  Ebon Clements  CAR 64974
.           Added using med claims flag to CASSTB00 for referral links
. V9.04.43  17/06/2005  J.Tan    CAR 56701     
.           Fixed cancelling appointments to remove records from HIC files
. V9.04.42  17/06/2005  Ebon Clements CAR 63385
.           Changed NEWBOK00 to read the clinic type and call SESDET00
.           for all bookings after the read of outbokaf
. V9.04.41  14/06/2005  Ebon Clements CAR 58654
.           Added bulk attend, depart and follow up functionality
. V9.04.40  09/06/2005  Peter Vela    CAR 58732
.           Added new cgi LETPRT10 for printing Non Attendance
.           07/06/2005  Ebon Clements CAR 61309
.           Created CLSRCH00 from CLISTB00 for appointment search.
.           Added link to referral list to FREF0000 if no referral linked
. V9.04.39  06/06/2005  Ebon Clements CAR 62018
.           Added cgi redirflg for hic claims clinic list redirects
. V9.04.38  02/06/2005  Davin         CAR 56698
.           Fixed exit flag when printing hic claims
. V9.04.37  02/06/2005  Davin
.           Fixed incorrect version
. V9.04.36  23/05/2005  Ebon Clements CAR 62018 62281
.           Recompiled for OUTBITFD - added provider usage
.           Fixed redirect in WRTBOK00 - Fixed in source V9.04.32 
. V9.04.35  20/05/2005  J.Tan         CAR 56699
.           Recompiled - added amount receive to hiccitaf file
. V9.04.34  19/05/2005  Ebon Clements CAR 62018
.           Fixed unavailable slot comments when converting extended slots
. V9.04.33  17/05/2005  Ebon Clements CAR 62018
.           Added medicare expiry date check to SETI0000         
.           Changed phone numbers in FREF0000 to use RCH contacts
. V9.04.32  12/05/2005  Ebon Clements CAR 61122
.           Added patient mobile to follow up referral list
. V9.04.31  12/05/2005  Ebon Clements CAR 60991
.           Added VSLTCOMM to EMSTB000 for kids slot comment and type display   
. V9.04.30  12/05/2005  Ebon Clements CAR 60929
.           Added warning that no ref linked in WRTBOK00 if using HIC
. V9.04.29  11/05/2005  Ebon Clements CAR 61122
.           Changed SLST3800 and SLST4000 to exit if websecaf defauls are blank
. V9.04.28  11/05/2005  J.Tan         CAR 61440
.           Added new field adjustment amount to hic files
. V9.04.27  10/05/2005  Ebon Clements CAR 61563
.           Changed missing referral to linked referral in FREF0000
. V9.04.26  09/05/2005  J.Tan         CAR 61122
.           Highlight red if no medicare expiry date
. V9.04.25  05/05/2005  Ebon Clements CAR 61122
.           Added using medclaims tag from the clinic master
. V9.04.24  04/05/2005  Ebon Clements CAR 61122
.           Only display referrals that need to be followed up in FREF0000
. V9.04.23  04/05/2005  Ebon Clements CAR 61122
.           Removed referral defaults from NEWBOK00 - should use tag in template
. V9.04.22  02/05/2005  J.Tan         CAR 61122
.           Fixed diagnosis warning messages
. V9.04.21  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.20  29/04/2005  Ebon Clements CAR 56697
.           Recompiled for HICCLAIM - OUTBITA1 file open prefix
. V9.04.19  28/04/2005  J.Tan         CAR 61122
.           Fixed diagnosis warning messages
.           Colour field for 'Linked referral'
. V9.04.18  27/04/2005  J.Tan         CAR 60991
.           Added tag to display field for 'Linked referral'
.           27/05/2005  J.Tan         CAR 61122
.           Default Visit type from referral slot type
.           Default GP from referral 
. V9.04.17  20/04/2005  Ebon Clements CAR 56699
.           Added update claim/referral functionality
. V9.04.16  18/04/2005  Davin         CAR 56697
.           Added claim comments field to FUSTB000
. V9.04.15  08/04/2005  Ebon Clements CAR 56670 & 56681
.           Added follow up referral letter list and referral field to FUSTB00
. V9.04.14  06/04/2005  Ebon Clements CAR 56678 & 56677
.           Added referral letter tags to OEXT0000 for expiry warning messages
.           Added link to current referral option to follow up appointments
.           06/04/2005  Davin         CAR 56697
.           Print hic claims from billing list view
.           Post cmbs template to a clinic
. V9.04.13  05/04/2005  Ebon Clements CAR 55594
.           Mods for Pre-Anaesthetic bookings
. V9.04.12  29/03/2005  Mike Laming   CAR 58922
.           Add parameter OTCNRSST to control call to NXTAPP00
.           Fix new bugs for re-scheduling NEW Visits & re-scheduling backwards
. V9.04.11  24/03/2005  Mike Laming   CAR 58922
.           Change routine NXTAPP00 to check re-scheduled slots are the same
.           visit type
. V9.04.10  16/03/2005  Davin              CAR 56697
.           Added new output fields to caselist tablesort tag (for HIC claims)
. V9.04.09  07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINOUT, HL7CISIN & HL7CISVR
. V9.04.08  03/02/2005  Ebon Clements CAR 56680 56681 56673
.           Mods for HIC claims
.           Added unavailable slot comments. Added tag for TABLVIEW
.           11/02/2005  Davin         CAR 56683
.           Added clinic indicator filter & tags for new FFS clinic list 
. ........  11/02/2005  Mike Laming              CAR 48413
.           Add Cancellation Comments free text field using "viscmtaf"
.           01/02/2005  J.Tan         CAR 56702
.           Added Room no to Clinic timetable
.           28/01/2005  Steve Armstrong  CAR 57424
.           Mods to change call from CISA04BR to CISA05BR
. V9.04.07  11/01/2005  Ebon Clements CAR 56397
.           Added cancelled to referral letter filter status
. V9.04.06  04/01/2005  Guomin Fu                CAR 49664
.           Removed checking on deceased flag when cancel booking in UPDBOK00
. V9.04.05  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for ADDVIS00 - medical record link
.           08/09/2004  Henry son                CAR 52585
.           Add Indeterminate to Sex check.
.           20/09/2004  Jill Habasque            CAR 53540
.           Recompiled for IBAWEBCD
. V9.04.04  30/08/2004 Ebon Clements             CAR 53089
.           Added hospital filter to CLISTB00
. V9.04.03  30/08/2004 Ebon Clements & Guomin Fu CAR 52130
.           Changed WSLT0000 to not allow you to enter slot number 0 
. V9.04.02  30/08/2004  Ebon Clements            CAR 52930
.           Populate visit extn file hospital code when creating bookings
. V9.04.01  20/08/2004  Guomin Fu                CAR 52822
.           Added JAVDES00 to remove "'" replace with "%60" for OCADESC
.------------------------------------------------------------------------------
. V9.03.51  10/08/2004  Mike Laming              CAR 40489
.           Changes to Interpreter Visit Details "visintaf" & Audit "visiauaf"
. V9.03.50  29/07/2004  Ebon Clements        CAR 19975
.           Added REVD0000 update waiting list review date
.           27/07/2004  Peter Vela           CAR 51304
.           Recompiled for OUTBOATM
. V9.03.49  21/07/2004  Peter Vela           CAR 51591
.           Changed all plum colored fonts to magenta
. V9.03.48  14/07/2004  Peter Vela           CAR 51518
.           Recompiled for OUTBOATM
. V9.03.47  05/07/2004  Steve Armstrong      CAR 51409
.           Recompiled for changes to DGCLICOR.
.           Also added call to PMIGTNID prior to calling DGCLICOR.
. V9.03.46  28/06/2004  Steve Armstrong      CAR 51167
.           Mods to include PAS-CIS Interface message (CISA04BR)
. V9.03.45  25/06/2004  Jill Habasque CAR 49987
.           Added tag to allow linking in report 11 
. V9.03.44  23/06/2004  Henry Son                CAR 49037
.           ICD10 Ed.4 Changes. Re-compile VALDIOPS.
. V9.03.43  17/06/2004  Peter Vela    CAR 49016  July 2004 PRS/2
.           - Recompiled for PMSPX2TM
.           17/06/2004  Ebon Clements CAR 50769                   
.           - Recompiled for DGHLCOMN
. V9.03.42  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.41  03/06/2004  Davin         CAR 50351
.           Changed default printer prgid to be OUTLABEL for label printing
.           31/05/2004  Ebon Clements CAR 50186
.           Added OTCNCSUM - Using clinic summary for appointment search
.           11/06/2004 J.Tan  CAR 50035
.           Mods to set mechanical vent var from pmsmtiaf
. V9.03.40  17/05/2004  Ebon Clements CAR 49821
.           Added clinic usage option to update OUTUSEFD
. V9.03.39  29/04/2004  Peter Vela    CAR 49129
.           Added Diagnosis Details Comments (patcmnfd) to FUSTB000
.           outweb0202004.html nz. 
. V9.03.38  23/04/2004  Peter Vela    CAR 48456
.           Recompiled for OUTRFLTM - Referral Letter List
.           20/04/2004  Peter Vela    CAR 48256
.           When booking from referral letter, write to outbokcf
.           When booking a re-appointment, check if referral date exists in
.           outbokcf. Write new outbokcf record for reappointment with the same
.           referral date.
. V9.03.37  16/04/2004  Peter Vela    CAR 47446
.           Print Group Labels SRS Added functionality to Print Group Labels
. V9.03.36  14/04/2004 Sylvek Litewka  CAR 48981
.           Recompiled for OUTRFLTM changes.
. V9.03.35  07/04/2004 J.Tan
.           Fixed OUT002 - outpatient charging
. V9.03.34  17/03/2004 Peter Vela      CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name
.           format) for sort lists.
. V9.03.33  09/04/2004 Ebon Clements  CAR 48097
.           Fixed update by, date and time in watopaaf and added PopUpFrame1 to
.           WINPAR00
.           09/03/2004 Jill Habasque  CAR 48126
.           Added read of outrf1af in shwbok30
. V9.03.32  01/03/2004 Jill Habasque  CAR 47884
.           Added error messages if trying to print labels that are not set up
. V9.03.31  24/02/2004 Ebon Clements     CAR 19968
.           Added waiting list pre admit clinic links
. V9.03.30  24/02/2004 Ebon Clements     CAR 47639
.           Display clinic comments and instructions from the clinic master
.           if the template is blank
. V9.03.29  12/02/2004 Ebon Clements     CAR 47407
.           Mods to only display clinic details from the users site code.
. V9.03.28  11/02/2004 Sylvek Litewka    CAR 47058
.           Recompiled for changes made to OUTRFLTM.PBL.
. V9.03.27  03/02/2004 Peter Vela    CAR 47209
.           Fixed opening of appointment comments temp file.
. V9.03.26  02/02/2004 Ebon Clements CAR 47050
.           Added form printing report 12 - PRTFRM00
. V9.03.25  23/01/2004 Ebon Clements CAR 38490 and 46979
.           Recompiled for MRTVISCD - Auto create medical records.
. V9.03.24  23/12/2003  Sylvek Litewka   CAR 45685
.           VIC DHS 2003 changes - recompiled for VALDIOPS.PBL changes.
.           22/12/2003  Steve Armstrong  CAR 45916
.           Fixed O/P broadcast messages from Supervisor screen
.           18/12/2003 Peter Vela     CAR 43134
.           Recompiled for MRTCONFD
.           15/12/2003 Ebon Clements CAR 45551
.           Change a referral letter back to unbooked when an appointment
.           is cancelled
.           15/12/2003 Ebon Clements CAR 45481
.           Mods for PMSCURFD file change - added outpatient site
.           11/12/2003 Peter Vela     CAR 40355
.           Recompiled for PATNAMCD
.           11/12/2003 Ebon Clements CAR 45549
.           Added update date,time and user when updating referral letters
.           09/12/2003 Sylvek Litewka CAR 20222
.           Modified procedure DISCOD00 to use Booking Date and RDPTICD1 IO
.           routine to access ICD Disease file.
. V9.03.23  05/12/2003 Ebon Clements  CAR 44091
.           Changed the cancel booking deposit error to user the new rcp files
. V9.03.22  12/11/2003 Ebon Clements  CAR 44091
.           Added an error if you try to cancel a booking with a deposit
. V9.03.21  07/11/2003 Ebon Clements  CAR 43484
.           Added PATCMNFD patient comments cgi variable and update functions
. V9.03.20  23/10/2003  J.Tan    CAR 44172         
.           Mods for Misc.theatre item file(pmsmitaf
. V9.03.19  17/10/2003 Ebon Clements  CAR 43921
.           Added delete of eoclnkaf if patient is non attended
. V9.03.18  09/10/2003 Ebon Clements  CAR 44206
.           Added template header fields to CLISTB00 lists 
. V9.03.17  30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
. V9.03.16  29/09/2003 Ebon Clements CAR 22361
.           Added reads of outhedaf to display the correct session setup details
. V9.03.15  24/09/2003 Ebon Clements CAR 41801
.           Added new cgi LETPRT09 for printing series booking letters.
. V9.03.14  19/09/2003 Jill Habasque CAR 42561
.           Moved call to PATFLD00 in FULLS000                               
. V9.03.13  19/09/2003 Ebon Clements CAR 41801
.           Mods for outpatient series bookings                              
. V9.03.12  10/09/2003 Sandra Barcham      43012
.           Open outpreaf without a prefix
. V9.03.11  18/07/2003 Ebon Clements   CAR 40619
.           Changed UPDSTA45 to delete the visit file record if doing a
.           supervisor status change from Attended to Did Not Attend.
. V9.03.10  17/07/2003 Ebon Clements   CAR 40633
.           Outpatient over bookings SRS
.           16/07/2003 Ebon Clements   CAR 41392
.           Changed CANS0000 to delete the visit extn file record
.           02/07/2003 Ebon Clements   CAR 40874
.           Added OUTBB064 cgi for the supervisor screen followup
.           02/07/2003 Ebon Clements   CAR 40837
.           Added DEPTFLAG cgi for the departure screen time defaults
. V9.03.09  15/07/2003 Sylvek Litewka  CAR 39213 
.           Added procedures SLTN0000 and SLNEN000.
.           Modified FUSTB000 to output VOUTCODE field (Visit Outcome Code).
. V9.03.08  02/07/2003 Sylvek Litewka  CAR 40978 (RCH)
.           Mods to CANS0000 and DBOK0000 (Cancellation and Rescheduling) to
.           convert slot types to REVIEW when a parameter OTCNCREV is set.
. V9.03.07  16/06/2003 Lina Vo       CAR 38705
.           Clear NXTAPPKY in NXTAPP95 when no next slots found
. V9.03.06  12/06/2003 Ebon Clements CAR 37705
.           Added SRCHCLID test to SLST2700 for session search screen
. V9.03.05  04/06/2003 Sylvek Litewka  CAR 39598
.           Mods to CANS0000 and DBOK0000 to check for Clinic Master Suspension
.           and to leave the visit type unchanged instead of converting it to
.           visit type found on the template.
. V9.03.04  26/05/2003 Lina Vo      CAR 37504
.           Write SLA/ASGC code from ibapostf to visit extension table for
.           New Bookings.
. V9.03.03  26/05/2003 J.Tan CAR 39169
.           Fixed Claim details for a followup outpatient booking
. V9.03.02  16/05/2003 J.Tan CAR 39114
.           Fixed default claim details for supervisor screen
. V9.03.01  15/05/2003 Sylvek Litewka  CAR 39071
.           Modified procedure SUSSES00 to populate new "outmspaf" fields 
.           OTMSRFDT and OTMSRTDT.
.------------------------------------------------------------------------------
. V9.02.111 22/04/2003 Jill Habasque   CAR 38357
.           Fixed position for PTCNGDV3                                   
. V9.02.110 11/04/2003 Sylvek Litewka  CAR 38158
.           Recompiled for changes made to include OUTRFLTM.PBL (Modified
.           ORFL4300 and ORFL4400 to pack search filter with itself and SP70).
. V9.02.109 02/04/2003  Sylvek Litewka  SRF 36816
.                       Added variable SAVCASEK and a call to RCAL0000 in 
.                       procedure UPDCNT00 where UPDATETY=5 (Reschedule).
.                       Added calls to RCAL0000 in procedures RSHSLT00 
.                       (Reschedule Session) and RSHAPP00 (Reschedule Suspended
.                       Appointments).
.           24/03/2003  Sylvek Litewka  SRF 23619,23643,35869,37462
.                       Mods to "Update Slots" functionality. Modified the 
.                       following procedures: ADDSLT00, AVASLT00, USLT0000 and
.                       DSLT0000. Added new procedures: VALUPD00 and UPDEXT00.
.                       Also added new server tag CLST3400 and modified 
.                       procedure VTYSEL00 to include processing for VISTFLAG=2.
. V9.02.108 27/02/2003  J.Tan   SRF 20178
.                       Fixed visit date on workers comp file
. V9.02.107 26/02/2003  J.Tan   SRF 20178
.                       Mods to get default claim details
.           24/02/2003  Sylvek Litewka  CAR 36688
.                       Modified EXTSLT30 to MOVE ZEROUR to OBAURNO instead of
.                       SP70. Removed (commented out) code related to RESHFLAG
.                       from procedures RSHSLT00, RSHS0000 and WBKA0000.
.                       Added variable SVRSKEYS to save SESSKEYS in RSHSLT00.
.           07/02/2003  Tonii CAR 35992
.                       Recompiled for PATMISTM
.           05/02/2003  Lina Vo        SRF 22709
.                       Open outpatient audit file with site prefix.   
. V9.02.106 24/01/2003  Sylvek Litewka SRF 22693
.                       Added procedure EOCACC00 to link the Follow-Up 
.                       Appointment with Episodes of Care Accident data. 
.                       Sylvek Litewka SRF 22711
.                       Modified procedure CHKLET00 to check only Outpatients
.                       Referral Letters (i.e where outrf1af.OTRLTREF = 0).
. V9.02.105 23/01/2003  Ebon Clements  SRF 35361
.                       Added RECALFLG to WRTBOK00 to call the recalculate
.                       clinic counts if an appointment is booked and the
.                       visit type is changed. This may make the booking process
.                       slower
.           22/01/2003  Sylvek Litewka SRF 22693
.                       Added read and display of PTCNUEOC for link to 
.                       EOC ACC screen.
.                       Sylvek Litewka SRF 35404
.                       Fixed to open the audit file "outaudb1.dat" when 
.                       control flag for booking audit is set.
.                       Sylvek Litewka SRF 35379
.                       Modified ATTD0000 procedure to use site code from 
.                       booking file (OBASITE) when writing patient visit
.                       record.
. V9.02.104 17/12/2002  Sylvek Litewka SRF 33923
.                       Removed call to GCST0000 from RCAL0000. It was causing
.                       the session status (OSESCSTT) to be cleared out. 
. V9.02.103 10/12/2002  Sylvek Litewka SRF 22711 
.                       Added LSTUNBFL flag which indicates that only 
.                       'Unbooked' outpatient referral letters are to be listed.
.                       This flag is used by OUTRFLTM.PBL.
. V9.02.102 29/11/2002  Lina Vo        SRF 22709 
.                       Changed program to open outpatient files with site 
.                       prefix.
.                       Ebon Clements  SRF 34210 
.                       Added error message to ADDSLT00 if the slot times are
.                       full when adding new slots.
. V9.02.101 06/11/2002  Sylvek Litewka SRF 22721 
.                       Added Remote Scripting Function SETTXS00 (in RESLOT00,
.                       UPDATETY=7). Added processing for Outpatient Extra 
.                       Screen Details (outxscaf). New procedure UPDBOK75 was
.                       created to write to "outxscaf" file.
. V9.02.100 24/10/2002  Ebon Clements SRF 22930 22929 22711
.                       Changed RCAL0000 to exclude unavailable slots in count
.                       Changed REAP0000 and WBKA0000 to not populate the      
.                       admission and ur numbers in extended slots
.                       Added BOOKFLAG for bookings from referral letters and
.                       Remote Scripting Function (in RESLOT00, UPDATETY=6).
. V9.02.99  14/10/2002  Lina Vo       SRF 22710
.                       Read controlf(OUTCONFD) for OTCNOCRD (Outcome Reappoint
.                       default code) and OTCNOCDD (Outcome Discharge default
.                       code). Added 2 new tag output for PROFLD(in OEXT0000).
. V9.02.98  09/10/2002  Peter Vela    SRF 17693
.                       Recompiled for PATMISTM - Admitting Point
. V9.02.97  07/10/2002  Ebon Clements SRF 22961
.                       Pack key before write/update of outdiagf in WRTBOK00    
. V9.02.96  03/10/2002  Ebon Clements SRF 18640
.                       Changed interpreter visit type to outpatient in INTAUD00
. V9.02.95  02/10/2002  Ebon Clements SRF 22483 22497     
.                       Recalculate session stats after cancel and reschedule  
.                       of an appointment.
. V9.02.94  24/09/2002  Ebon Clements SRF 20173 20139     
.                       Clear outcome,delete visit and write pre attendance when
.                       a supervisor status update is done(Attended to booked)
. V9.02.93  23/08/2002  Ebon Clements SRF 17673           
.                       Mods to allow for the new slot visit type - Unavailable
. V9.02.92  12/08/2002  Ebon Clements SRF 19167           
.                       Added a call to RCAL0000 to calculate session stats
.                       after the slot types have been updated in UPDSES20
. V9.02.91  01/08/2002  Ebon Clements SRF 20213           
.                       Added a trap around the write in PRNTUD00 to stop the
.                        I * D when multiple servers write a print record
. V9.02.90  19/07/2002  Jill Habasque SRF 19804           
.                       Added read of pmspx2af after all reads of master file  
. V9.02.89  11/07/2002  Ebon Clements SRF 18843           
.                       Added patient folder indicators to FUSTB000 clinic list
. V9.02.88  06/07/2002  Jill Habasque SRF 19273           
.                       Added given name and UR to current patients       
. V9.02.87  05/07/2002  J.Tan     SRF 18513
.                       Fixed charging for supervisor screen (CBIL0000)
. V9.02.86  29/06/2002  Ebon Clements SRF 19105             
.                       Recompiled for sigpipe trap  
. V9.02.85  24/06/2002  Tonii SVHM Transition II Extract 7
.                       Changed format of read and write of cciex7af 
. V9.02.84  20/06/2002  Ebon Clements 18671 and 18831 
.                       Recompiled for VALDIOPS - web error messages
.                       Changed SLST2100 clinic type selection list to be      
.                       in desciption order
. V9.02.83  05/06/2002  Ebon Clements 18368
.                       Added RAOTLPC1 to PRNTUD00 before the write for I * D
. V9.02.82  28/05/2002  Ebon Clements
.                       Added trap if sigpipe
.                       Mike Laming  SRF 15999  
.                       Recompiled for OUTRF1IO.INC
. V9.02.81  22/05/2002  Ebon Clements 17932        
.                       Changed FUSTB00 to output the correct alert string
. V9.02.80  22/05/2002  Ebon Clements 17932        
.                       Fixed GETCTY00 to return the correct clinic type code
.                       not the clinic id code. 
. V9.02.79  01/05/2002  Ebon Clements 17795
.                       Changed suspend sessions to change all appointments to
.                       suspended and not remove the session master
.                       Fixed CHKSUS00 date checks to validate a session date
.                       less than the suspended to date.
. V9.02.78  01/05/2002  Ebon Clements       
.                       Added report 11 for update of cancelled appointments
. V9.02.77  21/04/2002  Bronko Sosic 
.                       Recompiled for IBALPCCD                            
. V9.02.76  21/04/2002  Ebon Clements
.                       Added supervisor and next/prev buttons to suspended
.                       appointment list SALT0000
. V9.02.75  10/04/2002  Ebon Clements
.                       Added function REMBOK00 to UPDATE30 to attend a
.                       patient when the check in button is used
. V9.02.74  08/04/2002  Tonii  SVHM Transition II changes
.                       Fixed update of Referring GP field                   
. V9.02.73  03/04/2002  Ebon Clements
.                       Removed quotes from var in DIAGCM00 - javascript error
. V9.02.72  02/04/2002  Ebon Clements
.                       Recompiled for PATCODTM - default selection list
.           02/04/2002  Tonii  SVHM Transition II changes
.                       Added check if cciex7af table needs to be written to 
.                       a booking is updated
. V9.02.71  28/03/2002  Ebon Clements
.                       Fixed cgi for clinic type filter on clinic list
. V9.02.70  26/03/2002  Ebon Clements
.                       Added TRAP to WRBOKA1 in WSLT000 for I * D at RCH   
. V9.02.69  25/03/2002  Tonii   SVHM Transition II changes
.                       Added write to the new Extract 7 table (cciex7af)
.                       Program will only write to table if patient attends
.                       a booking
. V9.02.68  14/03/2002  Ebon Clements 
.                       Added code to read outma1af and populate OTBBCIND when  
.                       a patient is attended
. V9.02.67  06/03/2002  J.Tan
.                       Mods to recalc.charges if claim code/visit type changed
. V9.02.66  04/03/2002  Ebon Clements 
.                       Recompiled for mods to OUTBOATM
. V9.02.65  28/02/2002  Ebon Clements 
.                       Recompiled for mods to OUTBOATM
. V9.02.64  25/02/2002  Ebon Clements 
.                       Changed UPDBOK20 to call UPDBOK00 to update the
.                       DNA details for the DNA appointment not the new
.                       Appointment. Added date and time check to PRODNA00.
.                       Added DEFC000 to OUTBOATM for default claim code
. V9.02.63  21/02/2002  Jill Habasque
.                       Changed F2 to be SLOTCNT in UNASLT00            
. V9.02.62  20/02/2002  Davin  (defect 3251 - SVHM)
.                       Moved call to DGCLICOA from ATTD0000 to UPDBOK79
. V9.02.61  18/02/2002  Jill Habasque
.                       Added check for 99 on slotindx
. V9.02.60  14/02/2002  B.G.Ackland
.                       Fix Slot Index
. V9.02.59  11/02/2002  B.G.Ackland
.                       Optimise Clinic Lists Page
. V9.02.58  11/02/2002  B.G.Ackland
.                       Stop All Clinic List Display
. V9.02.57  11/02/2002  Ebon Clements 
.                       GETCTY00 read session file and clinic master file
.                       before read to get clinc type description
. V9.02.56  10/02/2002  B.G.Ackland
.                       Add Filer for Location
. V9.02.55  09/02/2002  B.G.Ackland
.                       Commit after Outpatient Number Allocation
. V9.02.54  08/02/2002  Pat Dirito
.                       Recompiled for MRTVISCD
. V9.02.53  07/02/2002  Ebon Clements 
.                       Clear OMACIND in NEWBOK00 if the casekeys if blank for
.                       adding a new booking at a patient level
. V9.02.52  05/02/2002  Ebon Clements 
.                       Added U/R number to suspended appointment list for kids
. V9.02.51  29/01/2002  Ebon Clements 
.                       Recompiled for OUTBOATM - clinic table reads 
.                       Call ADDVIS00 to write to MRTVISFD for outpatient
.                       bookings
.                       Only use the doctors name for the clinic description
.                       if the clinic description is blank. SESDET00
. V9.02.50  30/01/2002  B.G.Ackland
.                       Fix Appointment Summary in OUTBOATM to ignore
.                       extended slots. defect 3067 & 3066
. V9.02.49  14/01/2002  B.G.Ackland
.                       Fix Next Appointment by Clinic ID
.                       Fix Session Date List to ignore suspended session
. V9.02.48  14/01/2002  B.G.Ackland
.                       Fix Clinic ID Search 
. V9.02.47  03/02/2002  Ebon Clements 
.                       Display an warning when a patient is booked into
.                       different sessions on the same day
. V9.02.46  28/12/2001  Steve Armstrong
.                       Fix setting of OTBBCITM, OTBBASTM, OTBBDPTM and OTBBOUTC
.                       prior to DGCLICOA (attendance).
. V9.02.45  24/12/2001  B.G.Ackland
.                       Fix Cancelation to Revert Extended Slots
. V9.02.44  20/12/2001  B.G.Ackland
.                       Fix Redirect to check for casekeys before appending
. V9.02.43  13/12/2001  Ebon Clements 
.                       Added redirect to tac,vet and work cover screens
.                       for update booking
. V9.02.42  12/12/2001  Jill Habasque
.                       Added write to patre1af (person responsible)
. V9.02.41  06/12/2001  B.G.Ackland
.                       Fix Interpreter Audit Update
. V9.02.40  05/12/2001  B.G.Ackland
.                       Added Clinic Finish Time to Clinic Summary
. V9.02.39  03/12/2001  Katie Nelson/Harvinder   SRF 648628(nz)
.                       Recompiled for NHI tags added to PATMASTM
. V9.02.38  02.12.2001  B.G.Ackland
.                       Replace Day with Visit Type Code in Case List
.                       Changed Key used on Read of OUTMAB file to KEY21
.                       Revert Slot Type When Cancelling Booking
. V9.02.37  28/11/2001  B.G.Ackland
.                       Check Available Time
. V9.02.36  27/11/2001  Raghunandan Surve -HPS
.                       Fixed labels and forms
. V9.02.35  22/11/2001  B.G.Ackland
.                       Added merged patient alert for booking
. V9.02.34  22/11/2001  B.G.Ackland
.                       Update Resceduled Slot to Vacant with old Visit Type
. V9.02.33  18/11/2001  Steve Armstrong  
.                       Added CLOUTBOA/CLOUTBOB at start of WRTBOK00.
.                       Mods to load Visit Type and Clinic Type variables
.                       (old and new) prior to DGCLICOR call.
. V9.02.32  18/11/2001  B.G.Ackland
.                       Make Sure Sessions Only Display if Session Date
.                       is between Master Open & Close Dates
. V9.02.31  18/11/2001  B.G.Ackland
.                       Make Sure Sessions Only Display if Session Date
.                       Not Suspended
. V9.02.30  18/11/2001  B.G.Ackland
.                       Pop Up Forms & Label Print Page 
. V9.02.29  17/11/2001  B.G.Ackland
.                       Clear DNA on Supervisor Option
. V9.02.28  16/11/2001  B.G.Ackland
.                       Set Redirect for New Bookings to Include Booking No
.                       Steve Armstrong
.                       Added BRANCH at UPDBOK79 for DG broadcast messages.
.                       Also added call to DGCLICOB.
.                       Also added Load of OBAVISIT into OPCNVTYP prior to
.                       writing cancellation record.
. V9.02.27  13/11/2001  B.G.Ackland
.                       Adjustment to DG Transactions
. V9.02.26  13/11/2001  B.G.Ackland
.                       Added Rescheduled Appointments to Cancelled Appt List.
. V9.02.25  12/11/2001  B.G.Ackland
.                       Fixed time available, commented ResultIcon
. V9.02.24  09/11/2001  Raghunandan Surve - HPS 
.                       Fixed time available, commented ResultIcon
. V9.02.23  02/11/2001  B.G.Ackland
.                       Fix Supervisor Screen & Clinic Name
. V9.02.22  31/10/2001  B.G.Ackland
.                       Supervisor Screen & Clinic Name
. V9.02.21  26/10/2001  B.G.Ackland
.                       Fixed O/P problems
. V9.02.20  24/10/2001  B.G.Ackland
.                       Fix Follow Up Flag
. V9.02.19  23/10/2001  B.G.Ackland
.                       Fix Booking/Update/Reschedule/Follow Up
. V9.02.18  19/10/2001  Sai - HPS 
.                       Changed for showing presenting complaint/diag FUSTB000
. V9.02.17  18/10/2001  J.Tan
.                       Recompiled for OUT002 - clinic indicator from outbb1
. V9.02.16  13/10/2001  Raghu, Ashwin - HPS
.                       Fixed clear referral source if indicator is Yes,
.                       Check for patient booking in all the clinic and clinic
.                       type for the current date
. V9.02.15  12/10/2001  Glenn Saunders
.                       Use PATFLD00 to determine patient folder suffix. 
. V9.02.14  08/10/2001  Glenn Saunders
.                       Use PATFLD00 to determine patient folder suffix. 
.           09/10/2001  Ashwin - HPS
.                       Fixed for ICD10 code validation for everything related
.                       to patient appointment
. V9.02.13  05/10/2001  Raghu - HPS
.                       Fixed add slot to redirect to booking screen with
.                       correct casekeys
. V9.02.12  01/10/2001  Ashwin - HPS
.                       Fixed for all the view types from weekly to daily
. V9.02.11  26/09/2001  Ashwin - HPS
.                       Fixed for changing the view type of Session list from 
.                       weekly to daily and Fixed for DNA status updation in 
.                       UPDBOK20 and PRODNA00 routine
. V9.02.10  21/09/2001  Ashwin,Raghu - HPS
.                       Fixed for Interpreter,Fixed for Non booking of patient
.                       at Same Time,Fixed for Reshedule of Clinic Added 
.                       srchclty as querry parameter for clinic search Modified
.                       for redirecting to new booking on add slot
. V9.02.09  18/09/2001  Ashwin,Raghu - HPS
.                       Changed to display comments in Diagnosis details screen
.                       Fixed Invalid case problem,Slot already taken,Invalid
.                       Booking Status for reschedule and added day in DOSEDAY
.                       Fixed OBASTAT for Appointment search
. V9.02.08  11/09/2001  Brian
.                       Fixed update to Visit type. 
. V9.02.07  08/09/2001  Sai,Kuldeep - HPS
.                       Fixed for Appointment locked,Check in Time,Seen
.                       Time,Presenting Complaint,Extended Slot 
. V9.02.06  08/09/2001  Glenn Saunders                                        
.                       Changes keys for reads to patgsrn to reflect            .                       enhanced indexes.
. V9.02.05  05/09/2001  Ebon Clements
.                       Set up OTLPPTYP for letter rinting
. V9.02.04  01/09/2001  Ashwin - HPS
.                       Modified for Cancelled Appointment
. V9.02.03  30/08/2001  Mike Laming    RCH/SVHM
.           Add Datagate API O/P Confirm Appointment  (DGCLICOA)     
.                        API O/P Cancel Appointment   (DGCLICOC)     
.                        API O/P DNA Did Not Attend   (DGCLICOD)     
.                        API O/P New Appointment      (DGCLICON)     
.                        API O/P Re-sched Appointment (DGCLICOR)     
. V9.02.02  24.08.2001 Mishra ,HPS
.           Compiled for changes made in OUTBOATM(Preferred lang 3)
. V9.02.01  20.08.2001 HPS-ODC
.           Changes made for Bug Fixing
. V9.01.03  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.002 16.08.2001 Jagath, HPS
.           I*I Problem sovled for bb1bb1af
. V9.00.001 13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B10 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B09 29.06.2001 Ebon Clements
.           Recompiled for for OUTSRVFD    
. V9.00.B08 28.06.2001 HPS
.           Modified for Attendance check  
. V9.00.B07 28.06.2001 HPS, Ebon  
.           Time Display and other bugs fixed
. V9.00.B06 27.06.2001 HPS
.           Update appointment routine changed
. V9.00.B04 21.06.2001  HPS
. V9.00.B02 12.06.2001  Ashwin - HPS
.           Added Printing routine and Interpreter Table Processing
. V9.00.B01 28.05.2001  HPS Bangalore.
.           Modifications as required in Specification Document(OUTWEB02). 
.           covered under scope for phase I       
.-------------------------------------------------------------------------------
.  V5.10.05 17.04.2001  Glenn Saunders
.           Remove PTCNSNDX and associated processing  
.           Remove PATSUR (decommissioned). Replace with PATGSR
.  V5.10.04 06.04.2001  B.G.Ackland
.           Remove Table Headings from Case List Output
.           Place Headings in BSP templates
.  V5.10.03 05.04.2001  B.G.Ackland
.           Implement Template Mapping 
.  V5.10.02 22.03.2001  B.G.Ackland
.           Fix Links for Results
.  V5.09.03 15/01/2001  Bronko Sosic
.           Recompiled for PATMASTM
.  V5.09.02 04/01/2001  Bronko Sosic
.           Added include MRTVISCD to write a file to
.           MRTVISFD when a visit is added
.  V5.08.12 31/10/2000 B.G.Ackland
.           Fixed Category for Ref Source to Site Field
.  V5.08.11 31/10/2000 B.G.Ackland
.           Don't show Inactive Clinics and Types in Select Lists
.  V5.08.10 11/10/2000 Katie Nelson
.           Added read on Clinic Session Booking Table C in show booking
.  V5.08.09 28/09/2000 Bronko Sosic
.           Recompiled for PATMASTM / PATMISTM
.  V5.08.08 15/09/2000 Katie Nelson
.           Recompiled for OUTBOATM
.  V5.08.07 14/09/2000 Katie Nelson
.           509 Changes
.  V5.08.06 05/09/2000  Tonii
.           Mods to accept Unknown and Indeterminate as valid patient sex desc.
.  V5.08.05  16/08/2000  Caleb Sharman
.           Changed Health Fund variables to be 8 chars
.  V5.08.04 14.06.2000 K.C.Nelson 
.           Added refferal details to option 3
.  V5.08.03 07.06.2000 B.G.Ackland
.           Re Comp for PATMASTM
.  V5.08.02 22.05.2000 B.G.Ackland
.           Fix Reads for Clinic File
.  V5.08.01 17/05/2000 Pat Dirito    
.           Read to INDEX 2 to OUTCLIFD is now a KEY14. Now reads with clinic 
.           and last effective date.
.-------------------------------------------------------------------------------
.  V5.07.04 02/02/2000 Steven Watkins
.           Recompiled for PATMASTM / PATMISTM
.  V5.07.03 08.10.1999 K.C Nelson 
.           Fix Clinic Options List
.           05.01.2000 K.C Nelson 
.           Recompiled for WEBDATCD Y2K date corrections / PATMASTM changes
.  V5.07.02 04.10.1999 K.C Nelson 
.           Changes at Taranaki and changed bgcolor to HeadingCell
.  V5.07.01 12.07.1999 B.G.Ackland
.           Added Width & nowrap to Day Column
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
          INC       ROUNDUP5/INC
          INC       ABFVARS/INC
.
          INC       ACCAUDFD/INC             * New ACC Audit file
          INC       ACCDIAFD/INC             * AE Diagnosis
          INC       ALLAEFFD/INC
          INC       ALLCONFD/INC
          INC       ALLERCFD/INC
          INC       ALLGRPFD/INC
          INC       ALLRLNFD/INC
          INC       ALLQUEFD/INC
          INC       BOKRX1FD/INC
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       EMRICDFD/INC             * AE Diagnosis Codes
          INC       EMRVISFD/INC
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       IBAALVFD/INC
          INC       IBAPOLFD/INC
          INC       IBAPOSFD/INC
          INC       IBAGSTFD/INC
          INC       IBAGEDFD/INC
          INC       MLTSECFD/INC
          INC       NZHISIFD/INC
          INC       NHIDCDFD/INC
          INC       NHIDMCFD/INC
          INC       NHIDNRFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       NHIMCCFD/INC
          INC       NHIRELFD/INC
          INC       PATALRFD/INC
          INC       PATGSRFD/INC
          INC       PATONHFD/INC
          INC       TMPALIFD/INC
          INC       PATINVFD/INC
.
          INC       OUTARTFD/INC        * Requested Appointments
          INC       OUTARTTD/INC
          INC       OUTBOAFD/INC        * Bookings file A
          INC       OUTBB1FD/INC        * Bookings file B
          INC       OUTBOCFD/INC        * Bookings file C
          INC       OUTDCOFD/INC        * OP direct comments
          INC       OUTDANFD/INC        * OP direct actions
          INC       OUTDANTD/INC
          INC       OUTXSCFD/INC        * Extension File 
          INC       OUTXSCTD/INC        * Extension File - CGI parameters
          INC       OUTHEDTD/INC        * Template Header
          INC       OUTRCMFD/INC        * Appointment Request Comments
          INC       OUTXWPFD/INC        * Extension File Comments
          INC       OUTCLIFD/INC        * Clinic Ids
          INC       OUTCONFD/INC        * Outpatient System Parameters
          INC       OUTCANFD/INC        * Outpatient System Parameters
          INC       OUTCCTFD/INC        * Contract Codes
          INC       OUTCVTFD/INC        * Outpatients - Clinic Type Visit Types
          INC       OUTCTYFD/INC        * Clinic Types
          INC       OUTDCHFD/INC        * Default charge types
          INC       OUTDIAFD/INC        * Clinic Types
          INC       OUTDTRFD/INC        * DTR
          INC       OUTHISFD/INC        * Clinic Types
          INC       OUTLPCFD/INC        * Clinic Types
          INC       OUTMA1FD/INC        * Session Master file
          INC       OUTMABFD/INC        * Session Master file
          INC       OUTMSPFD/INC        * Session Master file
          INC       OUTPREFD/INC        * Outpatient Pre-attendance file
          INC       OUTPRCFD/INC        * Outpatient procedures and problems
          INC       OUTPRCTD/INC      
          INC       VISCMTFD/INC        * Cancellation Comments file   *I-48413
          INC       OUTRAPFD/INC        * Clinic Open Sessions file
          INC       OUTSESFD/INC        * Clinic Open Sessions file
          INC       OUTSITFD/INC        * Site file
          INC       OUTRF1FD/INC        * Referral List
          INC       OUTRSHFD/INC        * Referral List
          INC       OUTWMPFD/INC        * Template Mapping
          INC       BOKRC1FD/INC
          INC       OUTTXSFD/INC        * Outpatients Extra Templates file - FD
          INC       OUTTXSTD/INC        * Outpatients Extra Templates file - TD
          INC       OUTSIPFD/INC        * Outpat Site Specific Categories - FD
          INC       OUTSIPTD/INC        * Outpat Site Specific Categories - TD
          INC       OUTUSEFD/INC        * Clinic Usage
          INC       OUTBOXFD/INC        * Unavailable slot comments
          INC       OUTBITFD/INC        * Booking items
          INC       OUTTHIFD/INC        * Outpatient Telehealth Information 
.
          INC       APSMASFD/INC
          INC       PATCFAFD/INC
          INC       PATCOMM/INC
          INC       PMSCCDFD/INC        * Concession Card Details
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATIPEFD/INC
          INC       PATNIDFD/INC
          INC       PMSAIDFD/INC
          INC       PMSEXTFD/INC
          INC       PMSMTIFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSPAYFD/INC
          INC       PMSUPGFD/INC
          INC       PMSUPOFD/INC
          INC       PMSHPGFD/INC
          INC       PMSHPOFD/INC
          INC       PATIN1FD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIPFD/INC
          INC       PATPR1FD/INC
          INC       PATVISFD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PATCALAG/INC
          INC       RESLNKFD/INC
          INC       MLTSITFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       MRTCONFD/INC
          INC       SCRMASFD/INC
          INC       IBALPCFD/INC            *** HPS Code Starts Here *** 
          INC       PMSPX2FD/INC            
          INC       PMSPX2TD/INC
          INC       PMSQPTFD/INC
          INC       PMSTSPFD/INC
          INC       VISINTFD/INC           
          INC       VISIAUFD/INC          
          INC       OUTCMNFD/INC         
          INC       PMSVX1FD/INC            * Visit Extension Table        
          INC       PMSCAUFD/INC
          INC       PMSCDNFD/INC
          INC       PMSCURFD/INC            * Current Patient Table        
          INC       PMSVX1TD/INC
          INC       OUTSRVFD/INC            *** HPS Code Ends Here ***
          INC       PATCANFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       EOCLNKFD/INC
          INC       PATECDFD/INC
          INC       PMSCEXFD/INC
.
          INC       PATEORFD/INC
          INC       PMSCTCFD/INC
          INC       PATWC1FD/INC
          INC       PATWVEFD/INC
          INC       PATWMAFD/INC
          INC       PMSSRRFD/INC
          INC       PMSSRMFD/INC
          INC       PMSSMHFD/INC
          INC       PMSWX1FD/INC
. 
          INC       CCICONFD/INC
          INC       CCIEX7FD/INC
          INC       OUTCPBFD/INC
          INC       OUTCPCFD/INC
          INC       OUTLKBFD/INC        * Outpat Linked bookings table
          INC       OUTHEDFD/INC        * Outpatient template header file
          INC       OUTLETFD/INC
.
          INC       COMDEPFD/INC        * Receipting deposit details
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       WATMESFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC      
          INC       PATHSPFD/INC
          INC       MRTLOCFD/INC
          INC       BARCODFD/INC
.
          INC       ALLDEPFD/INC
          INC       ALLREFFD/INC
          INC       ALLREFTD/INC
          INC       ALLENCFD/INC
          INC       ALLRITFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLDIAFD/INC	
          INC       ALLCASFD/INC
          INC       ALLLNKFD/INC
          INC       ALLSTSFD/INC
.
          INC       PRIITMFD/INC
          INC       PRITHDFD/INC
          INC       PRITDTFD/INC
          INC       PRIDOCFD/INC
          INC       PRIPRAFD/INC
          INC       PRIEXCFD/INC
          INC       PRIMGPFD/INC
          INC       HICCLMFD/INC
          INC       HICCITFD/INC
          INC       HICBCNFD/INC
          INC       VISPAYFD/INC
          INC       TFILEVAR/INC
.
          INC       PMSADWFD/INC
.          INC       PMSIPLFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
.
          INC       PATFINFD/INC
          INC       COMPARFD/INC  
          INC       GTCMPATD/INC
          INC       PMSEXTTD/INC
.
.---------------------------------------------------------------------------
.  CGI Variables
.
CARET     INIT      "^"
.
ACCPORDN  DIM       20
ADDNEWPG  FORM      1          * Add new health fund program to patient
AHAUTOTS  FORM      1          * Called from AhAutoTimeSeen()
ALLFLAG   FORM      1
ATNDFLAG  FORM      1          * Attend Flag (for HL7 messaging)
.                                   0 = send A04 (just attended)
.                                   1 = send A08 (previously attended)
ATTDONLY  FORM      1
AVALTIME  DIM       5   * Slot Time in Format: (HH:MM)
MINTIME   FORM      2   * Set minutes to a form after computation
MESSAGID  DIM       20
MOSAIQVS  FORM      1          * MOSAIQ visit 
MOSAIQCL  FORM      1          * MOSAIQ clinic 
MOSAIQRS  FORM      1          * Allow supervisor reschedule to MOSAIC clinic
BOUTFLAG  FORM      "0"                     * flag for Booked Outpatient
BOOKDATE  DIM       8
BREAK     INIT      "<br>"
BBREFLIN  FORM      1
CALCDATE  DATE      8
SNDTETIM  DIM       16
SHOWFLAG  FORM      1
SUPERLEV  DIM       1
CATgb     INIT      "gb"
CATSD     INIT      "sd"
CATTC     INIT      "tc"
CATTZ     INIT      "Tz"
CATCL     INIT      "CL"
CONTVIEW  FORM      1
CHARTREV  FORM      1
CHECKDAT  DIM       1
CHECKREF  DIM       8                       * Auto activate internal referral
CISMFLAG  FORM      1
CONFRPMI  FORM      1
CONTTYPE  DIM       1
CONTCNTR  FORM      1
CNTRMTHD  FORM      3
CSEC      DIM       2
COUNTSES  FORM      2
COMMURNO  DIM       8
COMMADAT  DIM       8
COMMATIM  DIM       8
COMMTYPE  DIM       2
COPYDNAC  DIM       1
CURRDATE  DIM       8
CURRTIME  DIM       8
CURRDATX  DIM       8
CURRINPT  FORM      1
CURREMRP  FORM      1
DIM1A     DIM       1
DIM1B     DIM       1
DIM1C     DIM       1
DIM1D     DIM       1
DIM1E     DIM       1
DIM1F     DIM       1
DIM6      DIM       6
DIM50     DIM       50
.
DOMCOLOR  DIM       10
EPAUDFLG  FORM      1             * Episode audit flag
.                                    0 = no audits written
.                                    1 = before audit written
FHIRRECN  FORM      4
FHIRLOCH  DIM       50
FHIRSLOT  DIM       50
FHIRRCN2  FORM      4
.
FHIRSLST  DIM       20
FHIRSLS1  INIT      "Not Booked"
FHIRSLS2  INIT      "Booked"
FHIRSLS3  INIT      "Not Used"
FHIRSLS4  INIT      "Extended Slot"
FHIRSLS5  INIT      "Attended"
FHIRSLS6  INIT      "No Attendance"
FHIRSLS7  INIT      "Suspended"
FHIRSLS8  INIT      "Unavailable"
FHIRSLS9  INIT      "Reserved"
.
FHIRSTST  DIM       20
FHIRSTS0  INIT      "busy"
FHIRSTS1  INIT      "free"
FHIRSTS2  INIT      "busy-unavailable"
FHIRSTS3  INIT      "bust-tentative"
FHIRSTS4  INIT      "entered-in-error"
.
LABNAME   DIM       40
LABSEX    DIM       8
LABBDTE   DIM       8
LABBDTE1  DIM       10
LINKVTYP  FORM      1
NWAUFLAG  FORM      "0"
NZGNAME   DIM       18
NZSNAME   DIM       20
NZHOSP    DIM       1
DNASONLY  FORM      1
DNASAVSL  DIM       1
DNASAVGD  DIM       8
DISPHFND  DIM       19
EMPTYCEL  FORM      1
UNAVAILA  FORM      1
USEINVAD  FORM      1
SCANNEDM  DIM       1
SEARCHFL  DIM       1
SEARCHIN  DIM       1
SHOWEMPT  FORM      1
SHOWHOSC  FORM      1
SHOWCPMI  DIM       1
SHOWFOLL  DIM       1
SHOWDNAA  DIM       1
SHOWTRAN  DIM       1
SHOWRESC  DIM       1
SLOTREFN  DIM       8
SLOTURNO  DIM       8
SLOTREQK  DIM       32
SLOTCASK  DIM       28 
SLOTBTYP  DIM       1
SHWUNAVL  DIM       1
.
SUPRFLAG  FORM      1          * Supervisor flag for suspended appointment list
CANAFLAG  FORM      1          * Send A11 cancel attendance message
DASH      DIM       1
DASHFHIR  INIT      "-"
DAYDESC   DIM       10         * Day of Week Description
DEFTOVRD  DIM       1          * Allow override of defaluts
DEFTSTRT  DIM       5          * Default actual clinic start time
DEFTENDT  DIM       5          * Default actiual clinic end time
DEPTFLAG  FORM      1          * Flag for departure screen time defaults
DEPTCODE  DIM       3
DEFTOUTC  DIM       3          * Default outcome
DEFTATTN  DIM       3          * Default attendance code
DIACODES  DIM       6[10]
DISCFLAG  FORM      1          * Send discharge/cancel discharge message
.                              * 1 = A03 Discharge 2 = A13 Cancel discharger
DISSDESC  DIM       20
DISPCLHR  DIM       3
DISPDATE  DIM       11
DISPSUR   DIM       8          * Display Saved U/R Number
DISPSUSC  DIM       1
DISPVTYP  DIM       35
DISPBGCL  DIM       7          * Display Background Color 
DISRSTAT  DIM       10
DISPMUR   DIM       8          * Display Merged U/R Number
DISPSRVD  DIM       20
DISPT001  DIM       9
DISPT002  DIM       20
DIM12     DIM       12
DIM17     DIM       17
DIM20     DIM       20
DIM20A    DIM       20
DIM25     DIM       25
DIM28     DIM       28
DIM32     DIM       32
DIM60     DIM       60
DIM40     DIM       40
ERRFLAG   FORM      1
EMPTFLAG  FORM      1          * 1 = Yes session has empty slots
FNAMEP    DIM       8
FILTERCG  DIM       1          * Filter for Clinic Group (Cat CG)
FILTVTYP  DIM       3
INVDFLAG  FORM      "0"
IBAMFLAG  FORM      1
INDEXNUM  FORM      1
INVADMNO  DIM       8
INVVISTP  DIM       2
KEY5A     DIM       5
KEY5B     DIM       5
KEY550    DIM       550
HEIGHTCT  FORM      1
RECCNT    FORM      3
RECVMESG  DIM       50
REFXCLAS  DIM       11
REFXWCLS  DIM       11
REFXWDAT  DIM       8
REQUESTK  DIM       32
REQUESTA  DIM       1
RESETCAP  DIM       1
DRECCNT   DIM       3
REFSTAT   DIM       10         * referral status
REFRLVIS  DIM       8          * A/H referral visit number
REFCOUNT  FORM      2
RIAUDFLG  FORM      1             * Referral In audit flag
PRIMARYE  DIM       1          * Allow enc in primary ref
.                                    0 = no audits written
.                                    1 = before audit written
CLMCOUNT  FORM      3
CLMNNUMB  DIM       8
CLMNBTCH  DIM       5
CLININDC  DIM       1
CLNIDESC  DIM       20
EXPRICON  DIM       1          * ExpiryIconX.gif
GPCODE    DIM       10
LBED      DIM       3
LETTERNO  FORM      3   * Letter Number
LETTRREF  INIT      "LETTRREF"
LETTER    DIM       3   * Letter Number
LWARD     DIM       3
LOOPCNTR  FORM      8
MASTREFN  DIM       8                       * Master referral number
MRGEFLAG  FORM      1
NEWKEY28  DIM       28
NOPROGRM  FORM      1
PENDSDAT  DIM       8
PENDADAT  DIM       8
PENDDDAT  DIM       8
PENDFUND  DIM       6
PENDCLAM  DIM       3
PENDHOSP  DIM       3
PENDSYST  DIM       2
PROCODES  DIM       6[10]
SAVBB047  DIM       3
SAVDISKY  DIM       17
SAVEDPTM  DIM       5
SAVEURNO  DIM       8
SAVEADMN  DIM       8
SAVIADAT  DIM       8                       * Save internal ref date active
SAVEREFN  DIM       8
SAVPFUND  DIM       6
SAVSKEYS  DIM       25
SAVRFDAT  DIM       8          * I-48256
SAVRFOUT  DIM       8          * I-48256
SAVKEY10  DIM       10
SAVEOUTN  DIM       8
SAVVPRTY  DIM       3
SAVVREFN  DIM       8
SAVVTRGS  DIM       3
JAVSNAME  DIM       80         * I-52822
ENDNAME   DIM       80         * I-52822
EXPRDATE  DATE      8 
COMTFLAG  DIM       1
COMMLINK  DIM       127
REFRLINK  DIM       127
DISALRIN  DIM       1
DISPBNUM  DIM       5
DISPCLMN  DIM       8
DISPCMBS  DIM       10
DISPHCST  DIM       7
DISPMDAT  DIM       7
ENCADDED  DIM       3
HCSTFLAG  FORM      1
HIGHCOLR  DIM       1
HTMLLNK2  DIM       127
HTMLLNK3  DIM       127
HTMLLNK4  DIM       127
STRTNAME  DIM       80         * I-52822
VALDCODE  DIM       127
VALDDATE  DIM       8
VINAHFLG  FORM      1             * VINAH Flag
.                                   0 = writing after audits in VINAHDEF
.                                   1 = not writing after audits in VINAHDEF
VINAHREF  DIM       8
VISTHOSP  DIM       3                       * Visit Hospital Code
VISDHOSP  DIM       50                      * Visit Hospital Description
DATACHNG  FORM      1                                                  *I-40489
WARNINGF  FORM      1
WAHSPEED  FORM      1
FIRSTFLG  FORM      1
COUNTDNA  FORM      2
SKEY28    DIM       28
SPECANAM  DIM       20
INTERNAM  DIM       20
DUPFOUND  FORM      1
FLUPDESC  DIM       4
FUTRBOOK  FORM      1
VOUTCODE  DIM       3                  * Visit Outcome Code (Cat OZ)
VOUTDESC  DIM       20                 * Visit Outcome Description (Cat OZ)
VISCMFLG  FORM      1
CONFAPPT  DIM       1
CHKSITE   DIM       6
CHKCLIN   DIM       6
CHKSTRT   DIM       5
CHKCTYP   DIM       6
CHKADMN   DIM       8
CHKURNO   DIM       8
CHKTIME   DIM       5
NEWVTYP   DIM       3
NEXTFLAG  FORM      1
OLDVTYP   DIM       3
OLDADCS   DIM       10       * Old doctor seen
NEWSLOTS  FORM      3
OLDSLOTS  FORM      3
OPDMFLAG  FORM      1
CNTSLOTS  FORM      3
CLNEWBOK  FORM      1
BILLFLAG  FORM      1
BULKBILL  DIM       1
ODEPTTIM  DIM       5
REQSLOTS  FORM      3
REQTYPE   DIM       1                                                  *I-58922
SAVFORM1  FORM      1
SAVKEY12  DIM       12
SAVKEY25  DIM       25
SAVKEY28  DIM       28
RECALFLG  FORM      1
SLOTSTAT  FORM      1        * Slot Status
HBWAIT    FORM      1        * S27/P46 - Waiting Lists (1=ON,  2=OFF)BOKCONFD
WTCNPACC  DIM       6        * Default OP Clinic type for PAC Appointments
.
OUTCLAIM  INIT      "OUTCLAIM"
OUTLABEL  INIT      "OUTLABEL"              * used for default printer prgid
LABELOUT  INIT      "LABELOUT"
LETTROUT  INIT      "LETTROUT"
FORMSOUT  INIT      "FORMSOUT"
FORM12P2  FORM      12.2
FORM12D2  FORM      12.2
.
PRNTTYPE  FORM      1
LETNUMBR  DIM       3       * Letter number
LETPRNTR  DIM       6       * Letter printer
LETTNCOD  FORM      3
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
.
INTAUDTY  DIM       1
ALERTSTR  DIM       10
ALERTST2  DIM       10
RESVMINS  FORM      2
FORM4D    FORM      4
FORM10    FORM      10
SFORM4D   FORM      4
LOCKCNT   FORM      2
RSHCOUNT  FORM      2
SLOTTYPE  FORM      1
MM1       DIM       2
DD1       DIM       2
CC1       DIM       2
YY1       DIM       2
NXTAIDKY  DIM       28
NXTAPPKY  DIM       28
CASEKEY   DIM       28
SAVCKEYS  DIM       28
SEARCHTO  DATE      8
ADMISSNU  DIM       8
UPDTTIME  FORM      1
RESERVE   DIM       8
RESERVE1  DIM       2
RESERVE2  DIM       8
RESERVE3  DIM       8
REVWFLAG  FORM      1
HTIME     DIM       8
HCTIME    DIM       5
OUTPATE   DIM       8                   
HFCFDTE   DIM       8                       * Int'm date from (CCYYMMDD)
HFCFINVN  DIM       8                       * Save last invoice number 
KHH       DIM       2
KMM       DIM       2
KSS       DIM       2
KTF       FORM      2
KBLANK    DIM       1
KMM1      FORM      3
KKMIN     FORM      3
KHH1      FORM      2
KSECONDS  INIT      ":00"
KCDATE    DIM       8
KCCC      DIM       2
KCYY      DIM       2
KCMM      DIM       2
KCDD      DIM       2
KIDSONLY  FORM      1
.                                         
BSTATUS   DIM       10
DIM30     DIM       30                                                 *I-51518
LINKREFR  DIM       1
LINKEDRF  DIM       8
REFLINK   DIM       35
FULLONLY  FORM      1
VCTYP     DIM       6
VSESST    DIM       3
ENDATE    DIM       11       * Date Variable
DIDATE    DIM       11
PANTLOCN  DIM       2        * Patient Location1
PNTLOCTN  DIM       20       * Patient Location2
CLINDESC  DIM       30       * Clinic Description
UPDCONIN  DIM       1
WDAY      FORM      3
VSLOT     DIM       3
SLOTOPT   DIM       3
BEFSLOT   FORM      3
OUTCDESC  DIM       25
OUTPFLAG  FORM      1
VTYPDESC  DIM       70
VSLTCOMM  DIM       70
SARRDESC  DIM       25
SAVKEY6   DIM       6
PRTYDESC  DIM       20
MOREBOOK  FORM      1
NEXTPAGE  FORM      1
REDIREC1  DIM       227
REDIRFLG  DIM       1
FORM8     FORM      8
SELOPTCT  FORM      3
ATTDFLAG  FORM      1        * Booking Update in Case List (0=No 1=Yes)
DNOATTN   INIT      "Not Attd"
DBOOKED   INIT      "Booked  "
DIM3      DIM       3
DIM8      DIM       8
DIM9      DIM       9
AUDIFLAG  FORM      1  
UPDATETY  FORM      2
UPDATET1  DIM       1        * Update Type
UPBOOKRD  FORM      1
ADDSLOTK  DIM       28
NEWSLOTK  DIM       28
SAVSLOTK  DIM       28
LINKOUTN  DIM       8
PARNSLOT  FORM      3
PATLINK   DIM       127
F12P2     FORM      12.2
F8P2      FORM      8.2
.TEMPONE   DIM       1
TMPDATE   DIM       8
TXTLEN    FORM      3
TABLTYPE  FORM      1
D2TEMP    DIM       2
RESHFLAG  DIM       1
RESHKEYS  DIM       25
FOLLKEYS  DIM       25
SVRSKEYS  DIM       25
TIMESEEN  FORM      4
CKINTIME  FORM      4
BOOKFLAG  FORM      1                  * Flag for booking from referral letter
TMPLTYPE  DIM       1                  * Outpatients Extra Template type
CLSESKEY  DIM      28                  * Key to Clinic Session Booking file
NEXTSCRN  DIM       3                  * Outpatients Extra Redirect program  
LSTUNBFL  FORM      1                  * Flag to list unbooked letters only
SAVADMNO  DIM       8                  * Saved Admission number
SAVBCOMP  DIM       3                  * Saved Claim code
OUTCLMCD  DIM       20
REFCLMCD  DIM       20
CATDESCD  DIM       20
CATCOCHO  DIM       2
.
TOTSLCNT  FORM      3   * Total number of slots processed so far
NUMSLVIS  FORM      3   * Number of slots per visit type
PARNTSLT  FORM      3   * Holds the slot number of the parent slot
VALSLOTS  FORM      3   * Number of slots to validate
SLTEXFLG  FORM      1   * "Slots Exist" Flag. If ZERO then session is empty. 
.
TSITE     DIM       6
TCLINIC   DIM       6
TSTRT     DIM       5
CHKKEY19  DIM       19
SEXASSCD  FORM      1
FOUNDFLG  FORM      1
.
OTXWEND   FORM      2
OTXWEN2   FORM      2
OPDWEND   FORM      2
OVERBOOK  FORM      1       Over bookings flag
BOOKSERS  FORM      1       Series booking flag
.
COMM127   DIM       127  
COMFILAF  FILE      ASCII, FIXED=128   
COMFILBF  FILE      ASCII, FIXED=128
COMFILOF  FILE      ASCII, FIXED=128   
COMFILNM  DIM       8
COMFILNB  DIM       8
COMFILNO  DIM       8
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
COMFILPR  INIT      "out02a"
COMFILPB  INIT      "out02b"
COMFILPC  INIT      "out02c"
COMFILPO  INIT      "out02d"
OTXFLAG   FORM      1
OTXFLA2   FORM      1
OPDFLAG   FORM      1
.
FLGOTBOK  FORM      1
.
SAVDSPLC  DIM       9
SHWPRINT  FORM      1        Pop Up Printer Screen Options on Page Enter
BOOKSTAT  FORM      1        Change Booking Status
.
GPLBL001  DIM       6        Outpatient Site ID Group Labels            *I-47446
GPLBL002  DIM       8        Outpatient Clinic Date Group Labels        *I-47446
GPLBL003  DIM       5        Outpatient Clinic Time Group Labels        *I-47446
.
OUTBB001  DIM       3        Source of Referral (S)      
OUTBB002  DIM       3        Compensation Eligibility (CL)
OUTBB003  DIM       3        Patient Classification (A )
OUTBB004  DIM       3        Insurance Status (U1)
OUTBB005  DIM       3        Attendance Code (CA)
OUTBB006  DIM       6        Doctor's Code
OUTBB007  DIM       25       Comments
OUTBB008  DIM       6        Health fund code
OUTBB009  DIM       8        Health fund table
OUTBB010  DIM       3        No. of prev. visits charged
OUTBB011  DIM       8        Date (CCYYMMDD)
OUTBB012  DIM       3        Patient Category (P )
OUTBB013  DIM       3        Priority Code (PR)
OUTBB014  DIM       3        Reason for Reschedule (RR)
OUTBB015  DIM       1        Non-booked attendee flag
OUTBB016  DIM       6        Clinic type for tracking NBA.s
OUTBB017  DIM       3        User Defined Field 1 (O1)
OUTBB018  DIM       3        User Defined Field 2 (O2)
OUTBB019  DIM       3        User Defined Field 3 (O3)
OUTBB020  DIM       3        User Defined Field 4 (O4)
OUTBB021  DIM       8        Linked Outpatient Visit Number
OUTBB022  DIM       3        Department code (Cat AC)
OUTBB023  DIM       3        Transport Allocation (Cat OB)
OUTBB024  DIM       3        Language of Interpreter (Cat OL)
OUTBB025  DIM       8        Time First Seen
OUTBB026  DIM       8        Time Booked Out
OUTBB027  DIM       20       GPFH Approval Number
OUTBB028  DIM       20       ECR Approval Number
OUTBB029  DIM       10       Referring GP
OUTBB030  DIM       10       GP Practice Code
OUTBB031  DIM       10       Actual Doctor Seen
OUTBB032  DIM       5        Check In Time
OUTBB033  DIM       5        Time Actually Seen
OUTBB034  DIM       5        Time of Departure
OUTBB035  DIM       3        Outcome    (CAT OZ)
OUTBB036  DIM       1        Send Letter (Notify GP) (Y/N)
OUTBB037  DIM       2        GP Practice count
OUTBB038  DIM       3        District of Residence (Cat DA)
OUTBB039  DIM       4        Operator who made O/P Book/Re-app
OUTBB040  DIM       3        User Defined Field 5 (O5)
OUTBB041  DIM       3        User Defined Field 6 (O6)
OUTBB042  DIM       3        User Defined Field 7 (O7)
OUTBB043  DIM       3        User Defined Field 8 (O8)
OUTBB044  DIM       6        Patient Rank
OUTBB045  DIM       9        Diagnosis code (MBS or ICD9)
OUTBB046  DIM       50       Diagnosis description
OUTBB047  DIM       3        VISIT TYE (N,R,S)(CV)
OUTBB048  DIM       1        X-Ray Pulling List Indicator
OUTBB049  DIM       3        SESSION STATUS CODE (CS)
OUTBB050  DIM       3        DISCHARGE STATUS (Cat DO)
OUTBB051  DIM       2        Number of days to reserve for
OUTBB052  DIM       8        Referral Date (outbocaf.otbcrdat)
OUTBB053  DIM       3        Cancellation Reason
.
.                                           *** HPS Code Starts Here ***
OUTBB054  DIM       3        Special Arrangements Code
OUTBB055  DIM       9        Diagnosis code2 (MBS or ICD9)
OUTBB056  DIM       50       Diagnosis description2
OUTBB057  DIM       9        Diagnosis code3 (MBS or ICD9)
OUTBB058  DIM       50       Diagnosis description3
OUTBB059  DIM       9        Diagnosis code4 (MBS or ICD9)
OUTBB060  DIM       50       Diagnosis description4
OUTBB061  DIM       9        Diagnosis code5 (MBS or ICD9)
OUTBB062  DIM       50       Diagnosis description5
OUTBB063  DIM       3        Clinic Indicator      
OUTBB064  DIM       1        Supervisor flag to reset the followup made flag
OUTBB065  DIM       1        Send Correspondence to Carer                     
OUTBB066  DIM       8        Generate Letter Date        
OUTBB067  DIM       1        Send Generate Letter (Y/N)  
OUTBB068  DIM       3        NMDS Code (Category NM)
OUTBB069  DIM       3        Care Type (Category CC)
OUTBB070  DIM       3        Service Delivery Mode(Cat sd)
OUTBB071  DIM       1        Clinical High Risk
OUTBB072  DIM       3        Tier 2 Code (category NC)
OUTBB073  DIM       3        Health Purchaser (Cat HP)
OUTBB074  DIM       3        Contract Code (Cat gb)
OUTBB075  DIM       3        Referral Override (Cat ro)       
OUTBB076  DIM       3        Referral Period (Cat RF)
OUTBB077  DIM       2        Referral Period Months (1-98)
OUTBB078  DIM       1        Benefit Assignment Authorised
OUTBB079  DIM       8        Date of Referral
OUTBB080  DIM       10       Additional HCP1 
OUTBB081  DIM       10       Additional HCP2 
OUTBB082  DIM       10       Additional HCP3 
OUTBB083  DIM       10       Additional HCP4 
.
OTUSE001  DIM       5        Actual session start time
OTUSE002  DIM       5        Actual session end time
OTUSE003  DIM       3        Delay code (CAT CD)
.
NEWSLTIM  DIM       5        New Slot Time
UPDSLTIM  DIM       5        Update Slot Time
UPDSLTNO  DIM       3        Update Slot key
NEWSLTYP  DIM       3        New Slot Type
CNLH7FLG  FORM      1        Flag to not send A08 HL7 Message
.
DIAGOVR   FORM      1
.
PWATFLAG  FORM      2         2          20      Item flag 1
PWATITEM  DIM       9         9          22      Item code 1
PWATSUBC  DIM       3         3          31      Item sub code 1
PWATDESC  DIM       30        30         34      Item description 1
PWATIAMT  FORM     12.2       8          64      Item amount 1
.
WAITLKEY  DIM       19        * Waiting list key for pre admit clinic link
WAITFLAG  FORM      1         * Return to waiting list flag
WAITRKEY  DIM       19        * Return to waiting list key
.
DIM11     DIM       11
NXTBTCH   INIT      "0000001"
FORM8P2   FORM      8.2
TEMPAMNT  FORM      8.2
TEMPTOTV  FORM      8.2
FORM8P4   FORM      8.4
TIMEARRY  DIM       11[48]     * Time array 30 minute slots
GSESARRY  DIM       25[48]     * Session key for Group session 
TMARRCNT  FORM      3
WACLTYIN  DIM       1
WACPMICH  DIM       1
.
.*******************************************************************************
.                 Save variables for SVHM Transition II     
.*******************************************************************************
SAVOUTNO  DIM       8          * Outpatient Number
SAVDATE   DIM       8          
SAVURNO   DIM       8
SAVTIME   DIM       5      
SAVCLIN   DIM       6
SAVBDEPT  DIM       3
SAVSRCR   DIM       3
SAVCOMP   DIM       3
SAVDOCT   DIM       6
SAVRFGP   DIM       8
.
LASTOUTN  DIM       8
SAVKEY44  DIM       14
STATDESC  DIM       20
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
FLAGCLIN  FORM      1
WAITKEYS  DIM       18
SLOTCOMM  DIM       70
SLOTOVER  FORM      1
SLOTINDX  FORM      2
SLOTCNT   FORM      2
SLOTKEYS  DIM       28[99]
CASEKEYS  DIM       28
SAVCASEK  DIM       28  * Save Case keys
SESSKEYS  DIM       25
SESSKEYT  DIM       25
VIEWNAME  DIM       5
CLINICID  DIM       6
SRCHCLID  DIM       6
SAVECLID  DIM       6
SRCHCLTY  DIM       6
SRCHCGRP  DIM       6
SAVECLTY  DIM       6
SRCHLTYP  DIM       3
SRCHCIND  DIM       3
SRCHDOCT  DIM       6
SRCHEMPT  FORM      1   * Show clinics with available slots only
SRCHREFN  DIM       8   * Search AH Referral number for mandatory referral test
SRCHVTYP  DIM       3   * Search visit type
SESUSED   FORM      4
SESTOTAL  FORM      4
CODEST    INIT      "ST"
CODEA     INIT      "A "
STRTIM    DIM       5
ENDTIM    DIM       5
SESSFILL  FORM      3.1   Fill Percentage for Session
SESHEAD1  DIM       80
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
FRSTREAD  FORM      1
STRAMPM   DIM       2
TABLVIEW  DIM       1
VIEWOPCL  DIM       1
ENDAMPM   DIM       2
ENDDAY    FORM      2
ENDMON    FORM      2
ENDYER    FORM      4
CURDATE   DIM       8
.
MEDRTYPE  DIM       3
MINSCHD   FORM      5
MINUSED   FORM      5
MINAVAI   FORM      5
DIMHRS    DIM       2
DIMMIN    DIM       2
FORMHRS   FORM      2
FORMMIN   FORM      2
.
PSRHNAME  DIM       30
DOCTCODE  DIM       6
.
CASECNT   FORM      3
THISCAS   FORM      3
LSTCASE   FORM      3
.
ACTION    DIM       1
TAGMATCH  DIM       14
OLDEXPD   FORM      4
.
PTSTATUS  DIM       20
WAITMIN   FORM      6
ARRMIN    FORM      6
CURMIN    FORM      6
TABLNA    DIM       60
TIMEDISP  DIM       5
TIMEPERD  DIM       2
.
HCEEND    FORM      3
HCETOT    FORM      3
HCECNT    FORM      3
READDNR   FORM      1
TOTALALI  FORM      3
FORM3     FORM      3
COUNT     FORM      3
SEVRDESC  DIM       20
DNRCOD01  DIM       1
DNRCOD02  DIM       1
DNRCOD03  DIM       1
DNRCOD04  DIM       1
DNRCOD05  DIM       1
DNRCOD06  DIM       1
DNRCOD07  DIM       1
DNRCOD08  DIM       1
DNRCOD09  DIM       1
DNRCOD10  DIM       1
NMPNUMB   DIM       20        * actual number keyed in
HASH      INIT      "##"
PIPE      INIT      "|"
Z15       INIT      "zzzzzzzzzzzzzzz"
SP12      INIT      "            "
.
KEY2A     DIM       2
CHGUR     FORM      1
CHGADD    FORM      1
PTCUPDFL  FORM      1
MASUPDFL  FORM      1
PTMAS001  DIM       4                   
PTMAS002  FORM      1                                      
PTMAS003  FORM      3
PTMAS004  FORM      1
PTMAS005  DIM       20                                         
PTMAS006  DIM       25                                      
PTMAS007  DIM       19                                        
PTMAS008  DIM       35                                 
PTMAS009  DIM       35                                         
PTMAS010  DIM       35                            
PTMAS011  DIM       35                            
PTMAS012  DIM       8                       
PTMAS013  DIM       20                       
PTMAS014  DIM       20                        
PTMAS015  DIM       1
PTMAS016  DIM       3                  
PTMAS017  DIM       8
PTMAS018  FORM      3
PTMAS019  DIM       3             
PTMAS020  DIM       3                                  
PTMAS021  DIM       3             
PTMAS022  DIM       14        
PTMAS023  DIM       10        
PTMAS024  DIM       15        
PTMAS025  DIM       6       
PTMAS026  DIM       10        
PTMAS027  FORM      1        
PTMAS028  DIM       20        
PTMAS029  FORM      1        
PTMAS030  FORM      1        
PTMAS031  FORM      1        
PTMAS032  DIM       3        
PTMAS033  DIM       3        
PTMAS034  DIM       3        
PTMAS035  DIM       30
PTMAS036  DIM       6        
PTMAS037  DIM       8        
PTMAS038  DIM       19        
PTMAS039  DIM       3        
PTMAS040  DIM       3        
PTMAS041  DIM       3        
PTMAS042  DIM       3        
PTMAS043  DIM       3        
PTMAS044  DIM       3        
PTMAS045  FORM      1        
PTMAS046  FORM      1        
PTMAS047  FORM      1        
PTMAS048  FORM      2        
PTMAS049  DIM       20        
PTMAS050  DIM       35        
PTMAS051  DIM       35        
PTMAS052  DIM       35        
PTMAS053  DIM       35        
PTMAS054  DIM       8        
PTMAS055  DIM       20        
PTMAS056  DIM       20        
PTMAS057  DIM       10        
PTMAS058  FORM      3        
PTMAS059  DIM       2        
PTMAS060  DIM       6        
PTMAS061  DIM       8        
PTMAS062  DIM       3        
PTMAS063  DIM       2        
PTMAS064  DIM       6        
PTMAS065  DIM       14       
PTMAS066  DIM       6 
.
.                                           *** HPS Code Starts Here ***
LETPRT01  DIM       1       * Print Indicator - Pat Reappointment Letter
LETPRT02  DIM       1       * Print Indicator - GP Discharge Letter
LETPRT03  DIM       1       * Print Indicator - Pat Discharge Letter
LETPRT04  DIM       1       * Print Indicator - Std Booking Letter
LETPRT05  DIM       1       * Print Indicator - Std Reappointment Letter 
LETPRT06  DIM       1       * Print Indicator - Std Re-Schedule Letter
LETPRT07  DIM       1       * Print Indicator - Pat Cancellation Letter
LETPRT08  DIM       1       * Print Indicator - Hos Re-Schedule Letter
LETPRT09  DIM       1       * Print Indicator - Series booking letter  
LETPRT10  DIM       1       * Print Indicator - Non Attendance Letter
LETPRT11  DIM       1       * Print Indicator - Extra Letter
.
LETTYP11  DIM       3       * Print Letter Number - Extra Letter
.
FRMTYP03  DIM       6       * Outpatient form selection
.
LETPSL01  DIM       6       * Printer Selected - Pat Reapp Letter
LETPSL02  DIM       6       * Printer Selected - GP Discharge Letter
LETPSL03  DIM       6       * Printer Selected - Pat Discharge Letter
LETPSL04  DIM       6       * Printer Selected - Std Booking Letter
LETPSL05  DIM       6       * Printer Selected - Std Re-Appt Letter
LETPSL06  DIM       6       * Printer Selected - Std Re-Schd Letter
LETPSL07  DIM       6       * Printer Selected - Pat Cancel Letter
LETPSL08  DIM       6       * Printer Selected - Hos Re-Schd Letter
LETPSL09  DIM       6       * Printer Selected - Series booking letter
LETPSL10  DIM       6       * Printer Selected - Non Attendance Letter
LETPSL11  DIM       6       * Printer Selected - Extra Letter
.
LABPRT01  DIM       1       * Print Indicator - Booking Label
LABPRT02  DIM       1       * Print Indicator - Appt Mailing Label
LABPRT03  DIM       1       * Print Indicator - PMI Mailing Label
LABPRT04  DIM       1       * Print Indicator - GP Mailing Label
LABPRT05  DIM       1       * Print Indicator - MR Barcode Label
.
LABPNO01  DIM       3       * Number of Labels for Booking Label 
LABPNO02  DIM       3       * Number of Labels for Appt Mailing Label
LABPNO03  DIM       3       * Number of Labels for PMI Mailing Label
LABPNO04  DIM       3       * Number of Labels for GP Mailing Label
LABPNO05  DIM       3       * Number of Labels for MR Barcode Label
.
LABPSL01  DIM       6       * Printer Selected - Booking Label
LABPSL02  DIM       6       * Printer Selected - Appt Mailing Label
LABPSL03  DIM       6       * Printer Selected - PMI Mailing Label
LABPSL04  DIM       6       * Printer Selected - GP Mailing Label
LABPSL05  DIM       6       * Printer Selected - MR Barcode Label
.
FRMPRT01  DIM       1       * Print Indicator  - Standard MR3 Form
FRMPSL01  DIM       6       * Printer Selected - Standard MR3 Form
FRMPRT02  DIM       1       * Print Indicator  - Standard Invoice Form
FRMPSL02  DIM       6       * Printer Selected - Standard Invoice Form
FRMPRT03  DIM       1       * Print Indicator  - Outpatient Forms
FRMPSL03  DIM       6       * Printer Selected - Outpatient Forms
.
LABELTYP  DIM       10      * Type of Label To Print Coded Field
STATNCOD  DIM       6       * Stationary Code Coded Field
NOLABELS  DIM       3       * Number of Labels to Print
.
CLAIMPRT  DIM       1       * Print Indicator - Medicare Claim
CLAIMPSL  DIM       6       * Printer Selected - Medicare Claim
.
OTBIT001  DIM       2
OTBIT002  DIM       9
OTBIT003  DIM       3
OTBIT004  DIM       2
OTBIT005  DIM       9
OTBIT006  DIM       3
OTBIT007  DIM       2
OTBIT008  DIM       9
OTBIT009  DIM       3
OTBIT010  DIM       2
OTBIT011  DIM       9
OTBIT012  DIM       3
OTBIT013  DIM       2
OTBIT014  DIM       9
OTBIT015  DIM       3
OTBIT016  DIM       20                      * Item 1 provider usage
OTBIT017  DIM       20                      * Item 2 provider usage
OTBIT018  DIM       20                      * Item 3 provider usage
OTBIT019  DIM       20                      * Item 4 provider usage
OTBIT020  DIM       20                      * Item 5 provider usage
.
MBSDESC1  DIM       30 
MBSDESC2  DIM       30 
MBSDESC3  DIM       30 
MBSDESC4  DIM       30 
MBSDESC5  DIM       30 
MBSAMNT1  FORM      12.2    
MBSAMNT2  FORM      12.2    
MBSAMNT3  FORM      12.2    
MBSAMNT4  FORM      12.2    
MBSAMNT5  FORM      12.2    
.
OTRFL017  DIM       8                       * Request for App. Canc Date
OTRFL018  DIM       3                       * Reason for request (Cat RQ)
.
CHKGRPIN  FORM      1
CMBSDATE  DIM       8
CMBSFLAG  FORM      1
CMBSTEMP  DIM       4      * Template ID
ITMCOUNT  FORM      2
ITEMFLAG  DIM       2[5]
ITEMNUMB  DIM       9[5]
ITEMSUBN  DIM       3[5]
CLINTYPE  DIM       6            
OEMPTY    FORM      6
TMPFLG    FORM      1
CLILDESC  DIM       25                
SITEID    DIM       6              
CLINCID   DIM       6
SESSDATE  DIM       8
SESSTIME  DIM       5
OTSESCOM  DIM       25
OTSES001  DIM       3 
OTSES002  DIM       3 
OTSESHCP  DIM       10
SNEWKEYS  DIM       28            
NEWSKEYS  DIM       28
NEWVISTY  DIM       3
MARKKEYS  DIM       28[100]
MARKINDX  FORM      2
MARKCNT   FORM      2
.DIDATE    DIM       1
.ENDATE    DIM       1
XVISTYPE   DIM       3
XCHGFLAG   FORM      1
SESKYVL1  DIM        28
SESKYVL2  DIM        28
CLINDATE  DIM        11                     *** HPS ODC(13/08/01) Starts Here 
DIM10     DIM        10       
DIM5      DIM        5
NONATNDT  DIM        8
SLOTTIME  DIM        5                      
TEMPTIME  DIM        5                      
CLINTIME  DIM        5         
.
AUTCDFLG  FORM      1
TEMPCNT   FORM      1
WARNCNT   FORM      2       * Warning counter
WEBWRN    DIM       120[99] * Warning Array
WEBERR    DIM       65      * Output Web error
CODTYP    FORM      3       * Coding type
.                             9 - ICD9 coding
.                             101 - ICD10 version 1 coding
.                             102 - ICD10 version 2 coding
DSCOD     DIM       9       * Disease code
DSCODNO   FORM      2       * Disease code no
DISCODNO  FORM      2       * Disease code no
DSCODPFX  DIM       1       * Disease code prefix
ECODECNT  FORM      2       * 'E' code counter
EDITFLG   FORM      1       * Edit flag marker
FORM2A    FORM      2
FORM2B    FORM      2
F3A       FORM      3
F3B       FORM      3
OPCOD     DIM       9       * Operation code
OPCODNO   FORM      2       * Operation code no
SWAPFLG   FORM      1       * Swap flag
SDSCNCD   DIM       9       * Save the disease cancer code
SDSDGCD   DIM       9       * Save the disease dagger code
MIN       DIM       2       * Minutes Variable
MINUTES   FORM      6       * Minutes Variable
TIME      FORM      3       * Allows for negative Symbol
HOUR      FORM      2       * Hour Variable
FLTRSTAT  DIM       1       * Filter for Ref. Status (Booked/Unbooked)
FLTRCTYP  DIM       6       * Filter for Clinic Type
FLTRCLID  DIM       6       * Filter for Clinic Id
FLTRPRIO  DIM       3       * Filter for Priority
FLTRDCDE  DIM       6       * Filter for Doctor
FLTRRFGP  DIM       6       * Filter for Referring GP
SITECODE  DIM       6
CLNCTYPE  DIM       6
CLNCID    DIM       6
BSTATDSC  DIM       9
PRIODESC  DIM       20
.
VISTFLAG  FORM      1
WAHDISCH  FORM      1       * wahealth outpatient discharge screen flag (1=yes)
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SITEDONE  FORM      1
SITEPRFX  FORM      1
SLTVFLAG  FORM      1       * 1 = Yes empty slots for visit type available
LINK2PRT  FORM      1       * Link to parent variable
.                                           *** HPS Code Ends Here ***
CLMRECKY  DIM       28[99]
UMEDFLAG  DIM       1       * Using med claims flag 0=No, 1=Yes
.
PATIDENT  DIM       20
PATFOLDR  DIM       3
STATNAME  DIM       10
STATBOK   INIT      "Booked"
STATNOT   INIT      "Not Used"
STATEXT   INIT      "Extended"
STATATT   INIT      "Attended"
STATDNA   INIT      "DNA"
SHOWDNA   DIM       4    
FONTCOLR  DIM       12
CBSTAT1   DIM       9
CTCIDESC  DIM       25
CTCTDESC  DIM       25
DEFCLID   DIM       1 
DEFLTYP   DIM       1 
.
RETREFTW  FORM      1
.
TRNSFSRC  DIM       5        * Transfer Source Code (patdadaf)
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
VSTXUNIQ  FORM      3
QRYDATA1  DIM       240
NOTENUMB  FORM      6
FORM6     FORM      6
FLTRTRGS  DIM       3              * Filter Triage status
TRGSDESC  DIM       20
OPWAMVNY  DIM       1
.
CHWCURNO  DIM       8        * Check UR Number (Workers Compensation)
CHWCADMN  DIM       8        * Check Admission Number (Workers Compensation)
ACCDAT00  DIM       11       * Date for ACC/WC accident
.
CREFFLAG  FORM      1        * Flag set by Cancel Appt & Close Referral button
.
. The following fields are used in OUT002 - ABFOTINV
.
CEFFDATE  DIM       8
CNTRCEFR  FORM      1
CONTRCID  DIM       6
NOFEE     FORM      "0"
PROGFLAG  FORM      1
SAVCONTR  DIM       6
WEBFLAG   FORM      1
GROSSTOT  FORM      12.2
LSTRATE   FORM      12.2
LINETOT   FORM      12.2
LINEGST   FORM      12.2
CNEXTINV  FORM      8
DFDATE    DIM       8
RECFLAG   FORM      1
FGSTFLAG  FORM      1
XLINETOT  FORM      6.2
XLINEGST  FORM      6.2
TOTAMNT   FORM      12.2
NODAYS    FORM      6
RSDATTIM  DIM       25
ATTEXT    INIT      "at"
.
.*******************************************************************************
PRGID     INIT      "OUTWEB02"
VERSION   INIT      "V12.00.07"
PRGNAM    INIT      "Outpatient Processing"
.*******************************************************************************
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
          CALL      IBACLOCK       * get current date
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MAIN1000
.
MAIN1020  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      SESLST00   * Clinic List/Appointment Diary
          GOTO      MAIN1000
MAIN1200  CALL      CASLST00   * Case List
          GOTO      MAIN1000
.
MAIN1300  CALL      SHWBOK00   * Show Booking
.         CALL      CLSPOP00
          GOTO      MAIN1000
.
MAIN1400  CALL      UPDBOK00   * Update Booking Details
          BRANCH    EXIT,MAIN1000
.
          CALL      UPPMS000
.
          IF        PTCNHDPS=1
            MOVE      OBAOUTNO,ADMISSNO
            CALL      WRPORD00          * write/upd ACC Purchase Order
          ENDIF
.
          COMPARE   "8",UPDATETY  
          IF        !@EQUAL
            STRIP     REDIRECT                * HPS_ODC(Screen No.9)Starts here
            ENDSET    REDIRECT
.
            COMPARE   "6",UPDATETY
            IF        @EQUAL
              APPEND    "&admissno=",REDIRECT
              MOVE      OBAOUTNO,KEY8
              REP       " +",KEY8
              APPEND    KEY8,REDIRECT
            ENDIF
.
            COMPARE   "10",UPDATETY
            IF        @EQUAL
              APPEND    "&admissno=",REDIRECT
              MOVE      OBAOUTNO,KEY8
              REP       " +",KEY8
              APPEND    KEY8,REDIRECT
            ENDIF
.
            COMPARE   "4",UPDATETY
            IF        @EQUAL
              MATCH     "1",OPWAMVNY
              IF        @EQUAL
                APPEND    "&admissno=",REDIRECT
                MOVE      OBAOUTNO,KEY8
                REP       " +",KEY8
                APPEND    KEY8,REDIRECT
                PACK      KEY11,OBAOUTNO,PMEXCLAM,SP70
                CALL      RAPMEXT1
                IF        OVRCD=0
                  MOVE      "1  ",PMEXCAT2
                  MOVE      SP70,PMEXDAT1
                  MOVE      SP70,PMEXDAT2
                  CALL      UPPMEXT1
                ENDIF
              ENDIF
            ENDIF
.
            RESET     REDIRECT
            SCAN      "&casekeys=",REDIRECT
            IF        !@EQUAL
              STRIP     REDIRECT          
              ENDSET    REDIRECT
              APPEND    "&casekeys=",REDIRECT
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
              REP       " +",CASEKEYS
              APPEND    CASEKEYS,REDIRECT
            ENDIF
            RESET     REDIRECT
          ENDIF
.
          COMPARE   CREFFLAG,ONE
          IF        @EQUAL
            CALL      CLSPOP00
          ELSE
            CALL      NXTPAG00                * HPS_ODC(Screen No.9)Ends here
          ENDIF
          GOTO      MAIN1000
.
MAIN1500  CALL      NEWBOK00   * Show New Booking Page
          GOTO      MAIN1000
.
MAIN1600  CALL      WRTBOK00   * New Booking Details
          BRANCH    EXIT,MAIN1000
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,OBAURNO,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&admissno=",REDIRECT
          MOVE      OBAOUTNO,KEY8
          REP       " +",KEY8
          APPEND    KEY8,REDIRECT
          APPEND    "&casekeys=",REDIRECT
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
          APPEND    CASEKEYS,REDIRECT
          RESET     REDIRECT
.
          IF        FHIRTYPE=1
            COMPARE   FIVE,UPDATETY
            IF        @EQUAL
              MOVE      NEWSLOTK,DIM28
              REP       " -",DIM28 
              CLEAR     FHIRLOCH     
              APPEND    "Appointment/OUT-",FHIRLOCH
              APPEND    DIM28,FHIRLOCH
              RESET     FHIRLOCH
              STRIP     FHIRLOCH
            ENDIF
          ENDIF
.
          CALL      NXTPAG00   
          GOTO      MAIN1000
.
MAIN1700  CALL      UPDTIM00
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1200
.
MAIN1800  CALL      UPDSES00   * Update Session Details
          GOTO      MAIN1000
.
MAIN1900  CALL      RESLOT00   * Appointment Remote Scripting
          GOTO      MAIN1000
.
MAIN2000  CALL      WRTPRT00   * write to the file for printer CR 185
          CALL      WINCLS00
          GOTO      MAIN1000
.          * Outpatient Telehealth Info
MAIN2100  CALL      UPDCAN00   * Update Cancelled Appointment Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      PRTFRM00   * Schedule outpatient form printing
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      PRTGPL00   * Schedule Group Label Printing I-47446
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      MTHVW000   * Multi Therapist View 
          GOTO      MAIN1000
.
MAIN2500  CALL      REFBLK00           * Referral Bulk Billing
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame(#"",REDIRECT,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.*******************************************************************************
.             Output Next Page Based on CGI Parameter nextpage
.*******************************************************************************
NXTPAG00  MOVE      ONE,EXIT
          BRANCH    NEXTPAGE,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                             NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  MOVE      ZERO,EXIT
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      RDIREX00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      FHREXT00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.*******************************************************************************
.                              Redirect URL
.*******************************************************************************
RDIREX00  CALL      OPENHTML
          BRANCH    EXIT,RDIREX90
.
          MATCH     SP70,REDIREC1
          IF        !@EQUAL
            STRIP     REDIRECT
            ENDSET    REDIRECT
            STRIP     REDIREC1
            ENDSET    REDIREC1
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               "    location.href=#"",REDIRECT,REDIREC1,"#";":
                               "}":
                               "</script>"
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               "    location.href=#"",REDIRECT,"#";":
                               "}":
                               "</script>"
          ENDIF
.
          CALL      CLOSHTML
          GOTO      RDIREX99
.
RDIREX90  DISPLAY   "*** Fifo Not Found ***"
.
RDIREX99  RETURN
.
.******************************************************************************
.   Parent Redirect Content URL                                               *
.******************************************************************************
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "</script>"
          CALL      CLOSHTML
.
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.*******************************************************************************
.                         Goes back 1 page
.*******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F1
          SUB       ONE,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-",F1,");":
                             "    reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.*******************************************************************************
.                     Open Files and Initialize Variables
.*******************************************************************************
INIT0000  OPEN      PMSADWA1,"pmsadwaf"
          OPEN      PMSPX2A1,"pmspx2af"       * opened for fix of BUG/CR 47
          OPEN      PMSVX1A1,"pmsvx1af"       * for writing presenting complaint
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PATEORA1,"pateoraf"
          OPEN      PMSCURA1,"pmscuraf"       * for writing current patient
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      SCRMASA1,"scrmasaf"
          OPEN      PATMI1A2,"patmi1af" 
          OPEN      PATMI1A8,"patmi1af" 
          OPEN      PATRE1A1,"patre1af" 
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBAPOLA1,"ibapolaf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      PMSHCPA1,"pmshcpaf" 
          OPEN      IBAALVA1,"ibaalvaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IBAPOST1,"ibapostf"
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSPAYA1,"pmspayaf"
          OPEN      PMSPAYA2,"pmspayaf"
          OPEN      PMSTSPA1,"pmstspaf"
          OPEN      PMSCDNA1,"pmscdnaf"
          OPEN      PATIPEN1,"patipenf"      * Open invoice pending file
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATWC1A1,"patwc1af" 
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      PATINVR3,"patinvrf"
.
          OPEN      OUTDCOA1,"outdcoaf"
          OPEN      OUTDANA1,"outdanaf"
          OPEN      OUTDANA2,"outdanaf"
          OPEN      OUTCCTA1,"outcctaf"
          OPEN      PATCANA1,"patcanaf"
          OPEN      PATICUA1,"paticuaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      BOKRC1A1,"bokrc1af"  
          OPEN      PMSCEXA1,"pmscexaf"
.
          OPEN      IBALPCA1,"ibalpcaf" 
          OPEN      VISINTA1,"visintaf"  
          OPEN      VISIAUA1,"visiauaf"
          OPEN      EOCLNKA2,"eoclnkaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      ALLGRPA3,"allgrpaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLENCA6,"allencaf"
          OPEN      ALLENCA7,"allencaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLRITA1,"allritaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      ALLSTSA1,"allstsaf"
.
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
.
          OPEN      PRIITEM1,"priitemf"
          OPEN      PRITHDA1,"prithdaf"
          OPEN      PRITDTA1,"pritdtaf"
.
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      HICCLMA2,"hicclmaf"
          OPEN      OUTLETR1,"outletrf"
          OPEN      OUTLETR2,"outletrf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      OUTARTA1,"outartaf"
          OPEN      OUTDTRO1,"outdtrof"
          OPEN      OUTRCMA1,"outrcmaf"
          OPEN      OUTTHIA1,"outthiaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      PMSCAUA1,"pmscauaf"
.
          CALL      OPICD1             * Open ICD Disease files
          CALL      OPICO1             * Open ICD Operation files
.
          CALL      INTMAS00
.
. Read outpatient booking audit indicators
.
          READ      CONTROLF,THIRTY1;*51,HOAUDA,*52,HOAUDB
.
. Open outpatient file with site prefix
.
          MOVE      "out",CFILEPRE       * Save Current File Prefix
          CALL      OPNOUT00             * Open Outpatient Files
.
. Open outpatient file with no site prefix
.
          OPEN      OUTDCHA1,"outdchaf" 
          OPEN      OUTLPCA1,"outlpcaf" 
          OPEN      OUTRF1A1,"outrf1af"  
          OPEN      OUTRF1A2,"outrf1af"  
          OPEN      OUTWMPA1,"outwmpaf"  
          OPEN      OUTTXSA1,"outtxsaf"
          OPEN      OUTSIPA1,"outsipaf"
          OPEN      OUTSITA2,"outsitaf"     * I-47446
          OPEN      OUTSITA3,"outsitaf"     * I-47446
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      WEBSECA3,"websecaf"                                *I-51518
.
          READ      CONTROLF,TEN3;*213,CHCSCOD
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,PTCNBAGE,*180,PTCNCDRS:
                                     *209,PTCNADMT
          READ      CONTROLF,TWENTY1;*13,PTCNUNAK,*56,PTCNDEFT,*119,PTCNRPIK:
                             *138,PTCNNHII,PTCNNHID,PTCNDONR,PTCNMEDW,PTCNUDNG:
                             *178,PTCNMPTR,PTCNCDRS,PTCNLNCD,PTCNLP01:
                             *189,PTCNUONL:
                             PTCNPCON,PTCNNHIF,*204,PTCNAWRN,*226,PTCNMWAD:
                             *237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,TWENTY7;*46,HBWAIT
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,*187,OTCNCSRR:
                                     *239,OTCNOCRD,*242,OTCNOCDD
          READ      CONTROLF,THIRTY2;*108,OTCNCREV,OTCNCSUM,*111,OTCNAUPD:
                                     *115,OTCNRSST,*122,OTCNMTVS,*124,OTCNMTVE:
                                     *128,OTCNREVC,*131,OTCNINTR,*132,OTCNDACI:
                                     *138,OTCNRDWB,*141,OTCNHSEC,*142,OTCNDSUS:
                                     *145,OTCNDCCC,*153,OTCNTMES,*154,OTCNA11N
          READ      CONTROLF,SIXTY;*79,MRCNLAYT,*149,MRCNBCHI
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG
          READ      CONTROLF,SEVENTY1;*200,CCCNSVHM
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND05;*104,PTCNDGET,*147,CMDISM,*158,PTCNDGPV:
                                    *173,PTCNICUT,*210,PTCNLCLM
          READ      CONTROLF,ZERO;*43,IBCNMHOS:
                                  *85,IBCNUGST,*132,IBCNUMCI
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*213,ALCNLAUD
          READ      CONTROLF,HUND10;*248,PTCNEPAY
          READ      CONTROLF,HUND11;*12,WTCNPACC
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*101,PTCNUFFR
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,HUND18;*138,PTCNNEWC,*241,PTCNH7RA
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND21;*101,ALCNDAMR
.          READ      CONTROLF,HUND20;*158,PTCNUNET,*243,PTCNSMSN
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,FIFTY9;*220,PTCNUADT
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
          OPEN      PATDADA1,"patdadaf"     * Transfer Destination
          OPEN      PATVADA1,"patvadaf"     * Transfer Source Code
.
          MATCH     "0",OTCNMTVS            * value must be betweeb 1-48, if not
          IF        @EQUAL                  
            MOVE      "1",OTCNMTVS          * a U*R error will occur. Happens if
          ENDIF                             * value not previously set.
.
          MATCH     "0",OTCNMTVE            * value must be betweeb 1-48, if not
          IF        @EQUAL
            MOVE      "48",OTCNMTVE         * a U*R error will occur. Happens if
          ENDIF                             * value not previously set.
.
.          OPEN      PMSIPLA1,"pmsiplaf"     * Polling table for DHS Medicare
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MATCH     "1",ALCNRAUD            
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
. 
          IF        HBWAIT=1
            OPEN      WATOPAA1,"watopaaf"
            OPEN      WATOPAA2,"watopaaf"
            OPEN      WATOPSA1,"watopsaf"
            OPEN      WATOPSA2,"watopsaf"
            OPEN      WATTR1A1,"wattr1af"
            OPEN      WATTX1A1,"wattx1af"
            OPEN      WATMESA1,"watmesaf"
          ENDIF
.
          MATCH     "1",ALCNLAUD
          IF        @EQUAL
            OPEN      ALLAUDLN,"allaudln"
          ENDIF
.
          MOVE      ZERO,NOPROGRM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSHPGA1,"pmshpgaf"
          TRAPCLR   IO
          IF        OVRCD<>1
            OPEN      PMSHPOA1,"pmshpoaf"
            OPEN      PMSUPGA1,"pmsupgaf"
            OPEN      PMSUPOA1,"pmsupoaf"
          ELSE
            MOVE      ONE,NOPROGRM
          ENDIF
.
          MATCH     "1",PTCNSMSN
          IF        @EQUAL
            OPEN      PMSSMHA5,"pmssmhaf"
            OPEN      PMSSRRA1,"pmssrraf"
            OPEN      PMSSRMA2,"pmssrmaf"
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNB
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNO
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no.
.
          COMPARE   ONE,PTCNNHII
          GOTO      INIT9999 IF NOT EQUAL
.
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      NHIMASA2,"nhimasaf"
          OPEN      NHIETHA1,"nhiethaf"
          OPEN      NHIDNRA1,"nhidnraf"
          OPEN      NHIRELA1,"nhirelaf"
          OPEN      NHIDCDA1,"nhidcdaf"
          OPEN      NHIDMCA1,"nhidmcaf"
          OPEN      NHIMCCA1,"nhimccaf"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      TMPALIA1,"tmpaliaf"
.
          CALL      CONNECT
.
          GOTO      INIT9999             * Open Outpatient Files
.
INIT9000  DISPLAY   *R,"NO SITES EXIST IN OUTSITAF"
          DISPLAY   *R,"SERVER SHUTDOWN"
          STOP
.
INIT9999  RETURN
.*******************************************************************************
.                     Check Correct Files are Open for System
.*******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
OUTFIL99  RETURN
.*******************************************************************************
.                   Determine Template from Mapping Table
.*******************************************************************************
GETMAP00  MOVE      REPORTNO,F2
          PACK      KEY13,PRGID,F2,TEMPLATE,SP70
          REP       " 0",KEY13
.
          PACK      KEY25,SITECODE,CLINICID,KEY13,SP70
          CALL      RDOTWM1
          IF        OVRCD=0
            MOVE      OTWMMPTT,TEMPLATE
          ENDIF
          RETURN
.*******************************************************************************
.                              Clear Parameters
.*******************************************************************************
CLRPAR00  
.
          MOVE      ZERO,ADDNEWPG
          MOVE      ZERO,OTXWEND
          MOVE      ZERO,OTXWEN2
          MOVE      ZERO,OPDWEND
          MOVE      ZERO,OTXWEND
          MOVE      ONE,OTXFLAG
          MOVE      ONE,OTXFLA2
          MOVE      ONE,OPDFLAG
          MOVE      ZERO,NORECORD
          MOVE      ZERO,STARTNUM
          MOVE      SP70,INVADMNO
          MOVE      SP70,INVVISTP
          MOVE      ZERO,DISCFLAG
          MOVE      ZERO,CANAFLAG
          MOVE      ZERO,AHAUTOTS
          MOVE      ZERO,VSCMTFLG
          MOVE      ZERO,VSCMTLIN
.
          MOVE      ZERO,SHWPRINT
          MOVE      ZERO,BOOKSTAT
          MOVE      SP70,NXTAPPKY
          MOVE      SP70,NXTAIDKY
          MOVE      SP70,DOCTCODE
          MOVE      SP70,DEFTOVRD
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,CLNEWBOK
          MOVE      SP70,BULKBILL
          MOVE      SP70,ODEPTTIM
          MOVE      SP70,CLINICID
          MOVE      SP70,SRCHCLID
          MOVE      SP70,SRCHCLTY
          MOVE      SP70,SRCHCGRP
          MOVE      SP70,SRCHLTYP
          MOVE      SP70,SRCHCIND
          MOVE      SP70,SRCHDOCT
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,SESSKEYS
          MOVE      SP70,SESSKEYT
          MOVE      SP70,CASEKEYS
          MOVE      SP70,SAVCASEK
          MOVE      ZERO,SLOTINDX
          MOVE      ZERO,SLOTOVER
          MOVE      SP70,WAITKEYS
          MOVE      SP70,ADDSLOTK
          MOVE      SP70,NEWSLOTK
          MOVE      SP70,NEWSLTIM
          MOVE      Z70,UPDSLTIM
          MOVE      Z70,UPDSLTNO
          MOVE      SP70,NEWSLTYP
          MOVE      ZERO,UPDATETY
          MOVE      SP70,UPDATET1
          MOVE      ZERO,UPBOOKRD
          MOVE      ZERO,FLGOTBOK
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          PACK      REDIREC1,SP70,SP70,SP70,SP70
.                                           *** HPS Code Starts Here ***
          MOVE      Z70,ACCPORDN
          MOVE      SP70,NEWSKEYS 
          MOVE      SP70,NEWVISTY
          MOVE      SP70,OTSES001 
          MOVE      SP70,OTSES002 
          MOVE      SP70,OTSESCOM
          MOVE      SP70,OTSESHCP
          MOVE      ZERO,MARKINDX
          MOVE      ZERO,UPDTTIME
          MOVE      SP70,RESERVE1
          MOVE      SP70,RESERVE2
          MOVE      SP70,RESERVE3
          MOVE      SP70,SLOTCOMM
          MOVE      Z70,CONFAPPT
          MOVE      Z70,LETNUMBR
          MOVE      Z70,LETPRNTR
          MOVE      ZERO,SHOWEMPT
          MOVE      Z70,RESETCAP
          MOVE      ZERO,CONTVIEW
          MOVE      Z70,REQUESTK
          MOVE      SP70,REQUESTA
          MOVE      ZERO,SHOWCPMI
          MOVE      SP70,SHOWFOLL
          MOVE      SP70,SHOWDNAA
          MOVE      SP70,SHOWTRAN
          MOVE      SP70,SHOWRESC
          MOVE      SP70,UPDCONIN
          MOVE      ZERO,DNASONLY
          MOVE      SP70,SITECODE
          MOVE      ZERO,SHWUNAVL
.                                           *** HPS Code Ends Here ***
          CALL      CLRBB000 
          CALL      CPVXTF00 
          CALL      CLOUTHED 
.
          MOVE      Z70,PTMAS001 
          MOVE      ZERO,PTMAS002
          MOVE      ZERO,PTMAS003
          MOVE      ZERO,PTMAS004
          MOVE      Z70,PTMAS005  
          MOVE      Z70,PTMAS006  
          MOVE      Z70,PTMAS007  
          MOVE      Z70,PTMAS008  
          MOVE      Z70,PTMAS009  
          MOVE      Z70,PTMAS010  
          MOVE      Z70,PTMAS011  
          MOVE      Z70,PTMAS012  
          MOVE      Z70,PTMAS013
          MOVE      Z70,PTMAS014 
          MOVE      Z70,PTMAS015  
          MOVE      Z70,PTMAS016
          MOVE      Z70,PTMAS017 
          MOVE      ZERO,PTMAS018  
          MOVE      Z70,PTMAS019
          MOVE      Z70,PTMAS020 
          MOVE      Z70,PTMAS021  
          MOVE      Z70,PTMAS022  
          MOVE      Z70,PTMAS023 
          MOVE      Z70,PTMAS024
          MOVE      Z70,PTMAS025  
          MOVE      Z70,PTMAS026 
          MOVE      ZERO,PTMAS027
          MOVE      Z70,PTMAS028 
          MOVE      ZERO,PTMAS029
          MOVE      ZERO,PTMAS030  
          MOVE      ZERO,PTMAS031 
          MOVE      Z70,PTMAS032
          MOVE      Z70,PTMAS033  
          MOVE      Z70,PTMAS034 
          MOVE      Z70,PTMAS035
          MOVE      Z70,PTMAS036 
          MOVE      Z70,PTMAS037 
          MOVE      Z70,PTMAS038 
          MOVE      Z70,PTMAS039 
          MOVE      Z70,PTMAS040 
          MOVE      Z70,PTMAS041 
          MOVE      Z70,PTMAS042 
          MOVE      Z70,PTMAS043 
          MOVE      Z70,PTMAS044 
          MOVE      ZERO,PTMAS045
          MOVE      ZERO,PTMAS046
          MOVE      ZERO,PTMAS047
          MOVE      ZERO,PTMAS048
          MOVE      Z70,PTMAS049
          MOVE      Z70,PTMAS050
          MOVE      Z70,PTMAS051
          MOVE      Z70,PTMAS052
          MOVE      Z70,PTMAS053
          MOVE      Z70,PTMAS054
          MOVE      Z70,PTMAS055
          MOVE      Z70,PTMAS056
          MOVE      Z70,PTMAS057
          MOVE      ZERO,PTMAS058
          MOVE      Z70,PTMAS059
          MOVE      Z70,PTMAS060
          MOVE      Z70,PTMAS061
          MOVE      Z70,PTMAS062
          MOVE      Z70,PTMAS063
          MOVE      Z70,PTMAS064
          MOVE      Z70,PTMAS065
          MOVE      Z70,PTMAS066
.
          MOVE      Z70,LETPRT01 
          MOVE      Z70,LETPRT02
          MOVE      Z70,LETPRT03
          MOVE      Z70,LETPRT04
          MOVE      Z70,LETPRT05  
          MOVE      Z70,LETPRT06  
          MOVE      Z70,LETPRT07  
          MOVE      Z70,LETPRT08  
          MOVE      Z70,LETPRT09  
          MOVE      Z70,LETPRT10
          MOVE      Z70,LETPRT11
.
          MOVE      Z70,LETTYP11
          MOVE      Z70,FRMTYP03
.
          MOVE      Z70,LETPSL01  
          MOVE      Z70,LETPSL02  
          MOVE      Z70,LETPSL03  
          MOVE      Z70,LETPSL04  
          MOVE      Z70,LETPSL05
          MOVE      Z70,LETPSL06 
          MOVE      Z70,LETPSL07  
          MOVE      Z70,LETPSL08
          MOVE      Z70,LETPSL09
          MOVE      Z70,LETPSL10
          MOVE      Z70,LETPSL11
          MOVE      Z70,LABPRT01 
          MOVE      Z70,LABPRT02  
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04 
          MOVE      Z70,LABPRT05
          MOVE      Z70,LABPNO01  
          MOVE      Z70,LABPNO02  
          MOVE      Z70,LABPNO03 
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPNO05
          MOVE      Z70,LABPSL01  
          MOVE      Z70,LABPSL02 
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04 
          MOVE      Z70,LABPSL05
          MOVE      Z70,FRMPRT01
          MOVE      Z70,FRMPRT02  
          MOVE      Z70,FRMPRT03  
          MOVE      Z70,FRMPSL01 
          MOVE      Z70,FRMPSL02
          MOVE      Z70,FRMPSL03
          MOVE      Z70,LABELTYP  
          MOVE      Z70,STATNCOD 
          MOVE      Z70,NOCOPIES
          MOVE      Z70,NOLABELS 
          MOVE      Z70,SELPRINT 
          MOVE      SP70,CLINDATE           *** HPS ODC Code Here  
          MOVE      ZERO,MRGEFLAG
          MOVE      SP70,SAVEURNO
          MOVE      SP70,CLINTYPE
          MOVE      ZERO,BOOKFLAG
          MOVE      SP70,TMPLTYPE
          MOVE      SP70,NEXTSCRN
          MOVE      SP70,CLSESKEY
          MOVE      SP70,SAVSKEYS
          MOVE      ZERO,LSTUNBFL 
          MOVE      ZERO,RECALFLG
          MOVE      SP70,SVRSKEYS
          MOVE      ZERO,DEPTFLAG
          MOVE      SP70,WAITLKEY
          MOVE      ZERO,WAITFLAG
          MOVE      SP70,WAITRKEY
          MOVE      SP70,DEPTCODE
          MOVE      SP70,REFRLVIS
          MOVE      SP70,SEARCHFL
          MOVE      SP70,SEARCHIN
.
          CALL      CPOTXS00            * Outpatients Extra Screen Details
          CALL      CPOTAR00
.
          MOVE      SP70,GPLBL001       * I-47446
          MOVE      SP70,GPLBL002       * I-47446
          MOVE      SP70,GPLBL003       * I-47446
.
          MOVE      Z70,OTUSE001
          MOVE      Z70,OTUSE002
          MOVE      Z70,OTUSE003
          MOVE      SP70,DEFTSTRT
          MOVE      SP70,DEFTENDT
          MOVE      ZERO,SRCHEMPT
          MOVE      SP70,SRCHREFN
          MOVE      SP70,SRCHVTYP
          MOVE      ZERO,TABLVIEW
          MOVE      SP70,VIEWOPCL
          MOVE      SP70,SLOTREFN
          MOVE      SP70,SLOTURNO
          MOVE      SP70,SLOTREQK
          MOVE      SP70,SLOTCASK
          MOVE      SP70,SLOTBTYP
.
          MOVE      Z70,OTBIT001
          MOVE      Z70,OTBIT002
          MOVE      Z70,OTBIT003
          MOVE      Z70,OTBIT004
          MOVE      Z70,OTBIT005
          MOVE      Z70,OTBIT006
          MOVE      Z70,OTBIT007
          MOVE      Z70,OTBIT008
          MOVE      Z70,OTBIT009
          MOVE      Z70,OTBIT010
          MOVE      Z70,OTBIT011
          MOVE      Z70,OTBIT012
          MOVE      Z70,OTBIT013
          MOVE      Z70,OTBIT014
          MOVE      Z70,OTBIT015
          MOVE      Z70,OTBIT016
          MOVE      Z70,OTBIT017
          MOVE      Z70,OTBIT018
          MOVE      Z70,OTBIT019
          MOVE      Z70,OTBIT020
.
          MOVE      Z70,MBSDESC1
          MOVE      Z70,MBSDESC2
          MOVE      Z70,MBSDESC3
          MOVE      Z70,MBSDESC4
          MOVE      Z70,MBSDESC5
          MOVE      Z70,MBSAMNT1
          MOVE      Z70,MBSAMNT2
          MOVE      Z70,MBSAMNT3
          MOVE      Z70,MBSAMNT4
          MOVE      Z70,MBSAMNT5
.
          MOVE      Z70,OTRFL017
          MOVE      Z70,OTRFL018
.
          MOVE      ZERO,CMBSFLAG
          MOVE      Z70,CMBSTEMP
          MOVE      ZERO,WARNCNT
.
          MOVE      Z70,CLAIMPRT
          MOVE      Z70,CLAIMPSL
          MOVE      Z70,LINKREFR
          MOVE      ZERO,REDIRFLG
          MOVE      ONE,OUTPFLAG
          MOVE      SP70,VALDDATE
          MOVE      ZERO,PRIMARYE
.
          MOVE      ONE,CLMCOUNT
          WHILE     CLMCOUNT <= 99
            MOVE      SP70,CLMRECKY[CLMCOUNT]
            ADD       ONE,CLMCOUNT
          DO
          MOVE      ZERO,CLMCOUNT
.
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
          MOVE      ZERO,WAHDISCH
.
          MOVE      ZERO,RETREFTW
          CALL      CPOTPC00
          PACK      VALDCODE,SP70,SP70
          MOVE      SP70,COPYDNAC
.
          MOVE      Z70,TRNSFSRC
          MOVE      SP70,FILTERCG
          MOVE      SP70,FILTVTYP
.
          MOVE      SP70,WACLTYIN
          MOVE      SP70,WACPMICH
          MOVE      SP70,SCANNEDM
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no.
          MOVE      ZERO,BILLFLAG
          MOVE      ZERO,SHOWFLAG
          MOVE      SP70,SUPERLEV
          MOVE      ZERO,WAHSPEED
          MOVE      ZERO,MOSAIQRS
          MOVE      ZERO,CNLH7FLG
          MOVE      SP70,FHIRSLOT
          MOVE      SP70,FHIRLOCH
.
          MOVE      ZERO,CREFFLAG
.
CLRPAR99  RETURN
.*******************************************************************************
.                           Set Parameters
.*******************************************************************************
SETPAR00  MATCH     "clnewbok=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLNEWBOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bulkbill=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BULKBILL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "odepttim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ODEPTTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shwprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas",QRYNAME
          IF        @EQUAL
            CALL      SPMAS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "invadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn=",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newsltyp=",QRYNAME
          IF        @EQUAL
            PACK      NEWSLTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updsltno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDSLTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updsltim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDSLTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newsltim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWSLTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outbb",QRYNAME
          IF        @EQUAL
            MOVE      ONE,FLGOTBOK
            CALL      SETBB000 
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addslotk=",QRYNAME
          IF        @EQUAL
            PACK      ADDSLOTK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crefflag",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREFFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newslotk=",QRYNAME
          IF        @EQUAL
            PACK      NEWSLOTK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            PACK      REDIRECT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec1=",QRYNAME
          IF        @EQUAL
            PACK      REDIREC1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatet1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATET1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upbookrd=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPBOOKRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinicid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchclid=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCLID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchempt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHEMPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchrefn=",QRYNAME
          IF        @EQUAL
            PACK      SRCHREFN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchvtyp=",QRYNAME
          IF        @EQUAL
            PACK      SRCHVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchclty=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCLTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcgrp=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCGRP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "useinvad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEINVAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchltyp=",QRYNAME
          IF        @EQUAL
            PACK      SRCHLTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcind=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCIND,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdoct=",QRYNAME
          IF        @EQUAL
            PACK      SRCHDOCT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeyt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            PACK      CASEKEYS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotkeys=",QRYNAME
          IF        @EQUAL
            CALL      SLOTKY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitkeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otxwpcom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outptcom",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newcmmnt",QRYNAME
          IF        @EQUAL
            MOVE      TWO,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
            GOTO      SETPAR99
          ENDIF
.                                                *** HPS Code Starts Here ***
          MATCH     "clintype=",QRYNAME
          IF        @EQUAL
            PACK      CLINTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "letprt",QRYNAME
          IF        @EQUAL
            CALL     STLET000
            GOTO     SETPAR99
          ENDIF
.
.
          MATCH    "labprt",QRYNAME
          IF        @EQUAL
            CALL     STLAB000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "letpsl",QRYNAME
          IF        @EQUAL
            CALL     STPSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpno",QRYNAME
          IF        @EQUAL
            CALL     STPNO000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpsl",QRYNAME
          IF        @EQUAL
            CALL     STLSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "frmtyp03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMTYP03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lettyp11=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETTYP11
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmprt01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPRT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmprt02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPRT02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmprt03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPRT03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpsl01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPSL01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpsl02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPSL02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpsl03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPSL03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labeltyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABELTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nolabels=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOLABELS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTIME
            GOTO    SETPAR99
          ENDIF
.
          MATCH     "reserve1=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reserve2=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "reserve3=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE3,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.          
          MATCH    "newskeys=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,NEWSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "newvisty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWVISTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "markkeys=",QRYNAME
          IF        @EQUAL
            ADD       ONE,MARKINDX
            MOVE      QRYDATA,MARKKEYS[MARKINDX]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otses001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSES001
            GOTO      SETPAR99
          ENDIF
.       
          MATCH     "otses002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSES002
            GOTO      SETPAR99
          ENDIF
.       
          MATCH     "otsescom=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSESCOM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otseshcp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSESHCP
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "clindate=",QRYNAME
          IF        @EQUAL
            CALL      CLINDT00
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "pmsvx",QRYNAME
          IF        @EQUAL
            CALL      SPVXTF00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lstunbfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LSTUNBFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmpltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TMPLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outxs",QRYNAME
          IF        @EQUAL
            CALL      SPXSC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clseskey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLSESKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextscrn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTSCRN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEPTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitlkey=",QRYNAME
          IF        @EQUAL
            PACK      WAITLKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gplbl",QRYNAME              * I-47446
          IF        @EQUAL
            CALL      GRPLBL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otuse001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTUSE001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otuse002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTUSE002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otuse003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTUSE003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotcomm=",QRYNAME
          IF        @EQUAL
            PACK      SLOTCOMM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tablview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TABLVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewopcl=",QRYNAME
          IF        @EQUAL
SETPAR50    MOVE      QRYDATA,VIEWOPCL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptcode=",QRYNAME
          IF        @EQUAL
            PACK      DEPTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlvis=",QRYNAME
          IF        @EQUAL
            PACK      REFRLVIS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otbit",QRYNAME
          IF        @EQUAL
            MOVE      ONE,CMBSFLAG
            CALL      SPBIT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsdesc1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSDESC1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsdesc2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSDESC2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsdesc3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSDESC3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsdesc4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSDESC4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsdesc5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSDESC5
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsamnt1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSAMNT1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsamnt2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSAMNT2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsamnt3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSAMNT3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsamnt4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSAMNT4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbsamnt5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MBSAMNT5
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimprt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMPRT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimpsl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMPSL
            GOTO      SETPAR99
          ENDIF
.
. ******************************************* Start of addition        *I-48413
          MATCH     "cancommt",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00           * Get cancellation comments
            GOTO      SETPAR99
          ENDIF
.
. *******************************************   End of addition        *I-48413
.
          MATCH     "opdcommt",QRYNAME
          IF        @EQUAL
            CALL      GETOPD00           * Get OPD comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "clmprtno",QRYNAME
          IF         @EQUAL
            COMPARE   "99",CLMCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,CLMCOUNT
            PACK      CLMRECKY[CLMCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cmbstemp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CMBSTEMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkrefr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKREFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "confappt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONFAPPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otrfl017=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL017,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otrfl018=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTRFL018
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "letnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "letprntr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETPRNTR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftovrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTOVRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "searchfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SEARCHFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "searchin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SEARCHIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showempt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWEMPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "resetcap=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESETCAP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addnewpg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDNEWPG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otart",QRYNAME
          IF        @EQUAL
            CALL      SPOTAR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestk=",QRYNAME
          IF        @EQUAL
            PACK      REQUESTK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requesta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQUESTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcpmi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCPMI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotrefn=",QRYNAME
          IF        @EQUAL
            PACK      SLOTREFN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sloturno=",QRYNAME
          IF        @EQUAL
            PACK      SLOTURNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotreqk=",QRYNAME
          IF        @EQUAL
            PACK      SLOTREQK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotcask=",QRYNAME
          IF        @EQUAL
            PACK      SLOTCASK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotbtyp=",QRYNAME
          IF        @EQUAL
            PACK      SLOTBTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showfoll=",QRYNAME
          IF        @EQUAL
            PACK      SHOWFOLL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showdnaa=",QRYNAME
          IF        @EQUAL
            PACK      SHOWDNAA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF

.
          MATCH     "showtran=",QRYNAME
          IF        @EQUAL
            PACK      SHOWTRAN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showresc=",QRYNAME
          IF        @EQUAL
            PACK      SHOWRESC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patinstr",QRYNAME
          IF        @EQUAL
            CALL      GETINS00           * Patient Instructions
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updconin",QRYNAME
          IF        @EQUAL
            PACK      UPDCONIN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dnasonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DNASONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contcode=",QRYNAME
          IF        @EQUAL
.           MOVE      QRYDATA,OTCCCONT
.           MOVE      QRYDATA,OTBBCONT
            MOVE      QRYDATA,OUTBB074
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sitecode=",QRYNAME
          IF        @EQUAL
            PACK      SITECODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wahdisch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAHDISCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retreftw=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETREFTW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otprc",QRYNAME
          IF        @EQUAL
            CALL      SPOTPR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            PACK      VALDCODE,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copydnac=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COPYDNAC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            PACK      TRNSFSRC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtercg=",QRYNAME
          IF        @EQUAL
            PACK      FILTERCG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtvtyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wacltyin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WACLTYIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wacpmich=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WACPMICH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ahautots=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AHAUTOTS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "scannedm=",QRYNAME
          IF        @EQUAL
            PACK      SCANNEDM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "wahspeed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAHSPEED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mosaiqrs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOSAIQRS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cnlh7flg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNLH7FLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opwamvny=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPWAMVNY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shwunavl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWUNAVL
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.-----------------------------------------------------------------------------.
.         Set parameters for otbit
.-----------------------------------------------------------------------------.
SPBIT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPBIT010,SPBIT020,SPBIT030,SPBIT040,SPBIT050:
                       SPBIT060,SPBIT070,SPBIT080,SPBIT090,SPBIT100:
                       SPBIT110,SPBIT120,SPBIT130,SPBIT140,SPBIT150:
                       SPBIT160,SPBIT170,SPBIT180,SPBIT190,SPBIT200
.
          MOVE      ONE,EXIT
          GOTO      SPBIT999
.
SPBIT010  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT001
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT001
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT020  PACK      OTBIT002,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT030  MOVE      QRYDATA,OTBIT003
          GOTO      SPBIT999
.
SPBIT040  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT004
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT004
          ENDIF    
.
          GOTO      SPBIT999
.
SPBIT050  PACK      OTBIT005,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT060  MOVE      QRYDATA,OTBIT006
          GOTO      SPBIT999
.
SPBIT070  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT007
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT007
          ENDIF    
.
          GOTO      SPBIT999
.
SPBIT080  PACK      OTBIT008,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT090  MOVE      QRYDATA,OTBIT009
          GOTO      SPBIT999
.
SPBIT100  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT010
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT010
          ENDIF    
.
          GOTO      SPBIT999
.
SPBIT110  PACK      OTBIT011,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT120  MOVE      QRYDATA,OTBIT012
          GOTO      SPBIT999
.
SPBIT130  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT013
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT013
          ENDIF    
.
          GOTO      SPBIT999
.
SPBIT140  PACK      OTBIT014,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT150  MOVE      QRYDATA,OTBIT015
          GOTO      SPBIT999
.
SPBIT160  MOVE      QRYDATA,OTBIT016
          GOTO      SPBIT999
.
SPBIT170  MOVE      QRYDATA,OTBIT017
          GOTO      SPBIT999
.
SPBIT180  MOVE      QRYDATA,OTBIT018
          GOTO      SPBIT999
.
SPBIT190  MOVE      QRYDATA,OTBIT019
          GOTO      SPBIT999
.
SPBIT200  MOVE      QRYDATA,OTBIT020
          GOTO      SPBIT999
.
SPBIT999  RETURN
+
.
CLINDT00  UNPACK    QRYDATA,DIM10,CLINDATE,D1,CLINTIME 
          UNPACK    CLINDATE,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      NONATNDT,CCENT,CYEAR,CMON,CDAY          
          GOTO      CLINDT99
CLINDT99  RETURN 
.
SLOTKY00  COMPARE   "99",SLOTINDX
          GOTO      SLOTKY90 IF EQUAL
          ADD       ONE,SLOTINDX
          PACK      SLOTKEYS[SLOTINDX],QRYDATA,SP70
          MOVE      ZERO,SLOTOVER
          GOTO      SLOTKY99
.
SLOTKY90  MOVE      ONE,SLOTOVER
          GOTO      SLOTKY99 
.
SLOTKY99 RETURN
.*******************************************************************************
.                          Get Text Comments
.*******************************************************************************
GETEXT00  PREP      COMFILAF,COMFILNM
          MOVE      ZERO,OTXFLAG
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETEXT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETEXT90  MOVE      F3,OTXWEND
          OPEN      COMFILAF,COMFILNM
GETEXT99  RETURN
.
.*******************************************************************************
.                          Get Patient Instructions
.*******************************************************************************
GETINS00  PREP      COMFILBF,COMFILNB
          MOVE      ZERO,OTXFLA2
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETINS10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETINS90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETINS80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETINS10
.
GETINS80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETINS90  MOVE      F3,OTXWEN2
          OPEN      COMFILBF,COMFILNB
GETINS99  RETURN
.
.-----------------------------------------------------------------
. GTVISC00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVISC10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   NINTY9,VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
.
.*******************************************************************************
. Get OPD Comment                                 
.*******************************************************************************
GETOPD00  PREP      COMFILOF,COMFILNO
          MOVE      ZERO,OPDFLAG
          MOVE      ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
.
GETOPD10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETOPD90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETOPD80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
          GOTO      GETOPD10
.
GETOPD80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETOPD90  MOVE      F3,OPDWEND
          OPEN      COMFILOF,COMFILNO
GETOPD99  RETURN

.
.*******************************************************************************
.                        SET LETPRT PARAMETERS                 
.*******************************************************************************
.
STLET000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLET001,STLET002,STLET003,STLET004,STLET005:
                       STLET006,STLET007,STLET008,STLET009,STLET010:
                       STLET011
.
          MOVE      ONE,EXIT
          GOTO      STLET999
.
STLET001  MOVE      QRYDATA,LETPRT01
          GOTO      STLET999
.
STLET002  MOVE      QRYDATA,LETPRT02
          GOTO      STLET999
.
STLET003  MOVE      QRYDATA,LETPRT03
          GOTO      STLET999
.
STLET004  MOVE      QRYDATA,LETPRT04
          GOTO      STLET999
.
STLET005  MOVE      QRYDATA,LETPRT05
          GOTO      STLET999
.
STLET006  MOVE      QRYDATA,LETPRT06
          GOTO      STLET999
.
STLET007  MOVE      QRYDATA,LETPRT07
          GOTO      STLET999
.
STLET008  MOVE      QRYDATA,LETPRT08
          GOTO      STLET999
.
STLET009  MOVE      QRYDATA,LETPRT09
          GOTO      STLET999
.
STLET010  MOVE      QRYDATA,LETPRT10
          GOTO      STLET999
.
STLET011  MOVE      QRYDATA,LETPRT11
          GOTO      STLET999
.
STLET999  RETURN
.
.*******************************************************************************
.                        SET LABPRT PARAMETERS
.*******************************************************************************
STLAB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLAB001,STLAB002,STLAB003,STLAB004,STLAB005
.
          MOVE      ONE,EXIT
          GOTO      STLAB999
.
STLAB001  MOVE      QRYDATA,LABPRT01
          GOTO      STLAB999
.
STLAB002  MOVE      QRYDATA,LABPRT02
          GOTO      STLAB999
.
STLAB003  MOVE      QRYDATA,LABPRT03
          GOTO      STLAB999
.
STLAB004  MOVE      QRYDATA,LABPRT04
          GOTO      STLAB999
.
STLAB005  MOVE      QRYDATA,LABPRT05
          GOTO      STLAB999
.
STLAB999  RETURN
.
.*******************************************************************************
.                      SET LABPN PARAMETERS 
.*******************************************************************************
.
STPNO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPNO001,STPNO002,STPNO003,STPNO004,STPNO005
.
          MOVE      ONE,EXIT
          GOTO      STPNO999
.
STPNO001  MOVE      QRYDATA,LABPNO01
          GOTO      STPNO999
.
STPNO002  MOVE      QRYDATA,LABPNO02
          GOTO      STPNO999
.
STPNO003  MOVE      QRYDATA,LABPNO03
          GOTO      STPNO999
.
STPNO004  MOVE      QRYDATA,LABPNO04
          GOTO      STPNO999
.
STPNO005  MOVE      QRYDATA,LABPNO05
          GOTO      STPNO999
.
STPNO999  RETURN
.
.*******************************************************************************
.                      SET LETPSL PARAMETERS
.*******************************************************************************
.
STPSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPSL001,STPSL002,STPSL003,STPSL004,STPSL005:
                       STPSL006,STPSL007,STPSL008,STPSL009,STPSL010:
                       STPSL011
.
          MOVE      ONE,EXIT
          GOTO      STPSL999
.
STPSL001  MOVE      QRYDATA,LETPSL01
          GOTO      STPSL999
.
STPSL002  MOVE      QRYDATA,LETPSL02
          GOTO      STPSL999
.
STPSL003  MOVE      QRYDATA,LETPSL03
          GOTO      STPSL999
.
STPSL004  MOVE      QRYDATA,LETPSL04
          GOTO      STPSL999
.
STPSL005  MOVE      QRYDATA,LETPSL05
          GOTO      STPSL999
.
STPSL006  MOVE      QRYDATA,LETPSL06
          GOTO      STPSL999
.
STPSL007  MOVE      QRYDATA,LETPSL07
          GOTO      STPSL999
.
STPSL008  MOVE      QRYDATA,LETPSL08
          GOTO      STPSL999
.
STPSL009  MOVE      QRYDATA,LETPSL09
          GOTO      STPSL999
.
STPSL010  MOVE      QRYDATA,LETPSL10
          GOTO      STPSL999
.
STPSL011  MOVE      QRYDATA,LETPSL11
          GOTO      STPSL999
.
STPSL999  RETURN
.
.******************************************************************************
.                           SET LABPSL PARAMETERS
.******************************************************************************
.
STLSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLSL001,STLSL002,STLSL003,STLSL004,STLSL005
.
          MOVE      ONE,EXIT
          GOTO      STLSL999
.
STLSL001  MOVE      QRYDATA,LABPSL01
          GOTO      STLSL999
.
STLSL002  MOVE      QRYDATA,LABPSL02
          GOTO      STLSL999
.
STLSL003  MOVE      QRYDATA,LABPSL03
          GOTO      STLSL999
.
STLSL004  MOVE      QRYDATA,LABPSL04
          GOTO      STLSL999
STLSL005  MOVE      QRYDATA,LABPSL05
          GOTO      STLSL999
.
STLSL999  RETURN
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
RESLOT00  IF        FHIRTYPE=ONE
            PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
            SQUEEZE   FILNAM
            MOVE      ZERO,OVRCD
            MOVE      SP70,KEY60
            TRAP      OVERCOND GIVING KEY60 IF IO
            OPEN      HTMLFILE,FILNAM,WRONLY
            TRAPCLR   IO
            MOVE      OVRCD,EXIT
            BRANCH    EXIT,RESLOT99
          ELSE
            CALL      XMLHED00
            BRANCH    EXIT,RESLOT99
          ENDIF
.
          BRANCH    UPDATETY,RESLOT01,RESLOT02,RESLOT03,RESLOT04,RESLOT05:
                             RESLOT06,RESLOT07,RESLOT08,RESLOT09,RESLOT10:
                             RESLOT11,RESLOT12,RESLOT13,RESLOT14,RESLOT15:
                             RESLOT16,RESLOT17,RESLOT18,RESLOT19,RESLOT20
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      RESLOT90
.
RESLOT01  CALL      RESERV00 
          GOTO      RESLOT90
.
RESLOT02  CALL      CANCEL00 
          GOTO      RESLOT90
.
RESLOT03  CALL      UPDATE00 
          GOTO      RESLOT90
.
RESLOT04  CALL      UPDDNA00
          GOTO      RESLOT90
.
RESLOT05  CALL      CHKDUP00
          GOTO      RESLOT90
.
RESLOT06  CALL      CHKLET00                
          GOTO      RESLOT90
.
RESLOT07  CALL      SETTXS00                              
          GOTO      RESLOT90
.
RESLOT08  CALL      CONFAP00 
          GOTO      RESLOT90
.
RESLOT09  CALL      CHKREQ00
          GOTO      RESLOT90
.
RESLOT10  CALL      CHKFBK00
          GOTO      RESLOT90
.
RESLOT11  CALL      CCOD0000
          GOTO      RESLOT90
.
RESLOT12  CALL      CHKPRO00
          GOTO      RESLOT90
.
RESLOT13  CALL      CHKPRB00
          GOTO      RESLOT90
.
RESLOT14  CALL      CHKSAP00      * Check if U/R has appts on a given date
          GOTO      RESLOT90
.
RESLOT15  CALL      REFLET00                
          GOTO      RESLOT90
.
RESLOT16  CALL      CHKOPM00      * Check if Clinic is Mental Health Group
          GOTO      RESLOT90
.
RESLOT17  CALL      CHKARQ00      * Check if Appointment requests exist
          GOTO      RESLOT90
.
RESLOT18  CALL      PMICHK00      * Check in appointment from update pmi details
          GOTO      RESLOT90
.
RESLOT19  CALL      CHKORT00
          GOTO      RESLOT90
.
RESLOT20  CALL      UPDORT00
          GOTO      RESLOT90
.
RESLOT90  IF        FHIRTYPE=ONE
            CALL      CLOSHTML
          ELSE
            CALL      XMLEND00
          ENDIF
.
RESLOT99  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          RETURN
+
.---------------------------------------------------------------------------
. Check for Patient Booking into Same Time or Same Clinic Type for Same Day
. Check for Over Booking
. Check for DNA's
. Check for duplicates on the same day
.---------------------------------------------------------------------------
CHKDUP00  MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKDUP80
.
          MOVE      ZERO,WARNINGF
          MOVE      OBASITE,CHKSITE
          MOVE      OBACLIN,CHKCLIN
          MOVE      OBASTRT,CHKSTRT
          MOVE      OBACTYP,CHKCTYP
          MOVE      OBATIME,CHKTIME
          MOVE      ZERO,DUPFOUND
          MOVE      SP70,SAVKEY25
.
          PACK      KEY16,URNUMBER,OBADATE,SP70
          PACK      KEY36,URNUMBER,OBADATE,SP70
          CALL      RDSBOKA3
CHKDUP10  CALL      RDKBOKA3
          BRANCH    OVRCD,CHKDUP50
.
          MATCH     ADMISSNO,DOBAOUTN            * Ignore booking you are
          GOTO      CHKDUP10 IF EQUAL            * rescheduling
.
          PACK      KEY17,OBAURNO,OBADATE
          MATCH     KEY16,KEY17
          GOTO      CHKDUP50 IF NOT EQUAL
.
....      MATCH     CHKSITE,OBASITE                   * Check site access
....      IF        !@EQUAL
....        PACK      KEY16,USERID,SP70
....        CALL      RDMLSIT1                        * Access to all sites
....        IF        OVRCD=1
....          PACK      KEY16,USERID,OBASITE,SP70     * Access to this site
....          CALL      RDMLSIT1
....          IF        OVRCD=1
....            GOTO      CHKDUP10     * User doesn't have access to this site
....          ENDIF
....        ENDIF
....      ENDIF
.
          COMPARE   ONE,OBASTAT
          GOTO      CHKDUP10 IF NOT EQUAL
.
          MATCH     CHKTIME,OBATIME
          GOTO      CHKDUP70 IF EQUAL
.
CHKDUP20  MOVE      ONE,DUPFOUND
          PACK      SAVKEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      CHKDUP30
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1       
          BRANCH    OVRCD,CHKDUP10
.
CHKDUP30  MATCH     CHKSITE,OBASITE
          GOTO      CHKDUP10 IF NOT EQUAL
.
          MATCH     CHKCLIN,OBACLIN
          GOTO      CHKDUP10 IF NOT EQUAL
.
          MATCH     CHKSTRT,OBASTRT
          GOTO      CHKDUP10 IF NOT EQUAL
. 
          MOVE      "001",TEMPLATE
          CALL      SECLEV00
          IF        EXIT=0
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                      "Patient already has an Appointment for this Session."
            MOVE      ONE,WARNINGF
            GOTO      CHKDUP90
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Patient already has an Appointment for this Session.":
                    "</RETURN_VALUE>"
          MOVE      ZERO,EXIT
          GOTO      CHKDUP99
.
CHKDUP50  MOVE      ZERO,WARNINGF
          COMPARE   ZERO,DUPFOUND
          GOTO      CHKDUP90 IF EQUAL
.
CHKDUP60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                    "Patient has an Appointment on this day for ";
.
          IF        IBCNMHOS=1
            STRIP     OCADESC
            WRITE     HTMLFILE;*+,OCADESC,*-;
.
            IF        PTCNHDPS=1
.
.             Output the Clinic Location (NZ only)
.
              PACK      KEY25,SAVKEY25,SP70
              CALL      RDSESA1
              BRANCH    OVRCD,CHKDUP61
.
.
              PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT:
                        SP70
              CALL      RDOTHED1
              BRANCH    OVRCD,CHKDUP61
.
              PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
              CALL      RDMASA1
              BRANCH    OVRCD,CHKDUP61
.
              MATCH     OTHELTYP,SP70
              GOTO      CHKDUP61 IF EQUAL
.
              MOVE      "CT",CATEGORY       * Clinic Master Location Type
              MOVE      OTHELTYP,CODE
              PACK      KEY5,CATEGORY,CODE
              CALL      RDCODE1
              BRANCH    OVRCD,CHKDUP61
.
              STRIP     TDESC
              WRITE     HTMLFILE;" at ",TDESC;
            ENDIF
.
.           Get the Clinic Hospital
.
CHKDUP61    PACK      KEY25,SAVKEY25,SP70
            CALL      RDSESA1
            BRANCH    OVRCD,CHKDUP62
.
            PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT:
                      SP70
            CALL      RDOTHED1
            BRANCH    OVRCD,CHKDUP62
.
            PACK      KEY3,OTHEHOSP
            CALL      RDPTHSP1
            BRANCH    OVRCD,CHKDUP62
.
            WRITE     HTMLFILE;", ",PTHSNAME;
          ELSE
            WRITE     HTMLFILE;OCADESC
          ENDIF
.
CHKDUP62  MOVE      ONE,WARNINGF
          GOTO      CHKDUP99
.
CHKDUP70  PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1        
            BRANCH    OVRCD,CHKDUP75
.
            MATCH     OBASITE,OCASITE
            GOTO      CHKDUP75 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      CHKDUP75 IF NOT EQUAL
          ENDIF
.
          GOTO      CHKDUP76
.
CHKDUP75  MOVE      OBACLIN,OCADESC
.
CHKDUP76  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                    "Patient has an Appointment at this time for ":
                    OCADESC
          MOVE      ONE,WARNINGF
          GOTO      CHKDUP99
.
CHKDUP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Appointment Slot Key"
          MOVE      ONE,WARNINGF
          GOTO      CHKDUP99
.
CHKDUP90  CALL      CHKOVR00     * Check for Over Booking
          CALL      CHKDNA00     * Check for Consecutive DNA'a
          IF        WARNINGF=1
            WRITE     HTMLFILE;"</RETURN_VALUE>"
            GOTO      CHKDUP99
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
.
CHKDUP99  RETURN
.---------------------------------------------------------------------------
. Check for Unbooked Outpatient Referral Letters
.---------------------------------------------------------------------------
CHKLET00  READ      CONTROLF,THIRTY1;*174,OTCNULET
          COMPARE   ONE,OTCNULET
          GOTO      CHKLET60 IF NOT EQUAL   * not using referral letters
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSOTRFL2
CHKLET10  CALL      RKOTRFL2
          BRANCH    OVRCD,CHKLET60         
.
          MATCH     URNUMBER,OTRLURNO
          GOTO      CHKLET60 IF NOT EQUAL   
.
          COMPARE   ZERO,OTRLTREF           * Is it an Outpatient Ref Letter?
          GOTO      CHKLET10 IF NOT EQUAL   * If not, check next letter
.
          MATCH     SP70,OTRLBSIT
          GOTO      CHKLET10 IF NOT EQUAL   * Letter Booked
.
          MATCH     SP70,OTRLCDTE
          GOTO      CHKLET10 IF NOT EQUAL   * Skip cancelled letters
.
          MOVE      ONE,F1
.
          MOVE      SP70,KEY11
          MATCH     SP70,OTRLDATE
          GOTO      CHKLET50 IF EQUAL
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CHKLET50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    F1,"|",KEY11,"|",OTRLCTYP,"|",OTRLCONS:
                    "</RETURN_VALUE>"
.
          GOTO      CHKLET99
.
CHKLET60  PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
CHKLET65  CALL      RKALREF2
          BRANCH    OVRCD,CHKLET80
.
          MATCH     ALREURNO,URNUMBER
          GOTO      CHKLET80 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT                 * Waiting
          GOTO      CHKLET70 IF EQUAL
.
          MATCH     "1",ALRESTAT                 * Active
          GOTO      CHKLET70 IF EQUAL
.
          GOTO      CHKLET65
.
CHKLET70  UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE,"|",KEY11,"|",ALRECTYP,"|",ALRECLID,"|",ALREVISN,"|":
                    ALREUHC4:
                    "</RETURN_VALUE>"
.
          GOTO      CHKLET99
.
CHKLET80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
CHKLET99  RETURN
.---------------------------------------------------------------------------
. Check for Outpatients Extra Booking/Attendance Templates
.---------------------------------------------------------------------------
SETTXS00  CALL      CLOTTX00
          PACK      KEY28,CLSESKEY,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,SETTXS90
.
          MOVE      ONE,F1
          MATCH     "B",TMPLTYPE
          GOTO      SETTXS10 IF EQUAL  * Check for extra booking template
.
          MATCH     "A",TMPLTYPE
          GOTO      SETTXS20 IF EQUAL  * Check for extra attendance template
.
          MATCH     "S",TMPLTYPE
          GOTO      SETTXS10 IF EQUAL  * Check for extra booking template
.                                      * for series bookings
          GOTO      SETTXS90
.
SETTXS10  PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXBKSR
            GOTO      SETTXS50 IF NOT EQUAL * Record found, populate variables
          ENDIF
.
          PACK      KEY12,OBASITE,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXBKSR
            GOTO      SETTXS50 IF NOT EQUAL * Record found, populate variables
          ENDIF
.
          GOTO      SETTXS90
.
SETTXS20  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SETTXS90
.
          MATCH     "Y",OTMAIXTA
          GOTO      SETTXS90 IF NOT EQUAL   * Not using Extra Template screen
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXATSR
            GOTO      SETTXS60 IF NOT EQUAL * Record found, populate variables
          ENDIF
.
          PACK      KEY12,OBASITE,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXATSR
            GOTO      SETTXS60 IF NOT EQUAL * Record found, populate variables
          ENDIF
.
          GOTO      SETTXS90
.
SETTXS50  MATCH     "S",TMPLTYPE
          IF        @EQUAL
            MOVE      "outweb08",OTTXBKSR   * Override server and report
            MOVE      "05",OTTXBKRN         * for series bookings
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    F1,"|",OTTXBKSR,"|",OTTXBKRN,"|",OTTXBKTM:
                    "</RETURN_VALUE>"
.
          GOTO      SETTXS99
.
SETTXS60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    F1,"|",OTTXATSR,"|",OTTXATRN,"|",OTTXATTM:
                    "</RETURN_VALUE>"
.
          GOTO      SETTXS99
.
SETTXS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
SETTXS99  RETURN
.-------------------------------------------------------------------------------
. Check for Patient future booking into same Site, Clinic and Type
.-------------------------------------------------------------------------------
CHKFBK00  PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKFBK80
.
          MOVE      ZERO,WARNINGF
          MOVE      OBASITE,CHKSITE
          MOVE      OBACLIN,CHKCLIN
          MOVE      OBACTYP,CHKCTYP
          MOVE      ZERO,DUPFOUND
          MOVE      SP70,LINKEDRF           * Clear the linked referral number
          MOVE      ZERO,FUTRBOOK           * Future booking set to No
.
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2                * Check for a linked referral
          CALL      RKALLNK2
          BRANCH    OVRCD,CHKFBK05
.
          MATCH     DOBAOUTN,ALLNLNKV       * Same OP visit number
          GOTO      CHKFBK05 IF NOT EQUAL
.
          MOVE      ALLNVISN,LINKEDRF       * Save the linked referral number
.
CHKFBK05  PACK      KEY36,URNUMBER,OBADATE,SP70
          CALL      RDSBOKA3
CHKFBK10  CALL      RDKBOKA3
          BRANCH    OVRCD,CHKFBK90
.
          MATCH     ADMISSNO,DOBAOUTN            * Ignore current booking
          GOTO      CHKFBK10 IF EQUAL
.
          MATCH     URNUMBER,OBAURNO             * All records for this UR
          GOTO      CHKFBK90 IF NOT EQUAL
.
          MATCH     CHKSITE,OBASITE              * same site
          GOTO      CHKFBK10 IF NOT EQUAL
.
          MATCH     CHKCLIN,OBACLIN              * same clinic
          GOTO      CHKFBK10 IF NOT EQUAL
.
          MATCH     CHKCTYP,OBACTYP              * same clinic type
          GOTO      CHKFBK10 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT                  * booked
          GOTO      CHKFBK10 IF NOT EQUAL
.
          MOVE      ONE,FUTRBOOK                 * Yes future bookings exist
.
          MATCH     SP70,LINKEDRF                * Any linked referral
          IF        !@EQUAL
            PACK      KEY16,LINKEDRF,DOBAOUTN,SP70  * Check if booking is linked
            CALL      RDALLNK1                      * to the same referral
            BRANCH    OVRCD,CHKFBK10
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Patient has a future Appointment for this Session ";
.
          MATCH     SP70,LINKEDRF                * Any linked referral
          IF        !@EQUAL
            WRITE     HTMLFILE;" and Referral.";
          ENDIF
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      CHKFBK99
.
CHKFBK80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Appointment Slot Key":
                    "</RETURN_VALUE>"
          GOTO      CHKFBK99
.
CHKFBK90  IF        FUTRBOOK=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                      "Patient has a future Appointment for this Session ":
                      "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      " OK ":
                      "</RETURN_VALUE>"
          ENDIF
.
CHKFBK99  RETURN
.
.-------------------------------------------------------------------------------
. CCOD0000 - XML Validate Contract Code for Given Clinic Type
.-------------------------------------------------------------------------------
.
CCOD0000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MOVE      ONE,FRSTREAD
          PACK      KEY15,SITECODE,CLINTYPE,SP70
          CALL      RSOTCCT1
CCOD1000  CALL      RKOTCCT1
          IF        OVRCD=1
            IF        FRSTREAD=1
              GOTO      CCOD2000
            ELSE
              GOTO      CCOD9000
            ENDIF
          ENDIF
.
          MATCH     SITECODE,OTCCSITE
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      CCOD2000
            ELSE
              GOTO      CCOD9000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     CLINTYPE,OTCCCTYP
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      CCOD2000
            ELSE
              GOTO      CCOD9000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY5,CATgb,OTCCCONT
          CALL      RDCODE1
.
          MATCH     "A",PTCOACTV
          GOTO      CCOD1000 IF NOT EQUAL
.
          MOVE      ZERO,FRSTREAD
          WRITE     HTMLFILE;OTCCCONT,",",TDESC,"|";
          GOTO      CCOD1000
.
CCOD2000  PACK      KEY5,CATgb,SP70
          CALL      RDSCODE1
CCOD2100  CALL      RDKCODE1
          BRANCH    OVRCD,CCOD9000
.
          MATCH     CATgb,TCODE
          GOTO      CCOD9000 IF NOT EQUAL
.
          MATCH     SP1,ACODE
          GOTO      CCOD2100 IF EQUAL
.
          MATCH     "A",PTCOACTV
          GOTO      CCOD2100 IF NOT EQUAL
.
          WRITE     HTMLFILE;ACODE,",",TDESC,"|";
          GOTO      CCOD2100
.
CCOD9000  WRITE     HTMLFILE;"</RETURN_VALUE>";
.
CCOD9999  RETURN
.
.-------------------------------------------------------------------------------
. Check for DNA's
.-------------------------------------------------------------------------------
CHKDNA00  UNPACK    NEWSLOTK,OBASITE,OBACLIN,OBADATE
          UNPACK    OBADATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          SUB       ONE,F4
          PACK      FRSTDATE,F4,CMON,CDAY
          MOVE      ZERO,COUNTDNA
          MOVE      ZERO,FIRSTFLG
          MATCH     "1",OTCNRDWB            * test parameter          *I-200172
          IF        @EQUAL
            MOVE      ONE,FIRSTFLG          * turn off DNA Warning message
          ENDIF
          PACK      KEY36,URNUMBER,FRSTDATE,SP70
          CALL      RDSBOKA3
CHKDNA10  CALL      RDKBOKA3
          BRANCH    OVRCD,CHKDNA90
          MATCH     URNUMBER,OBAURNO
          GOTO      CHKDNA90 IF NOT EQUAL
          COMPARE   FIVE,OBASTAT
          GOTO      CHKDNA10 IF NOT EQUAL
          IF        FIRSTFLG=0
            MOVE      ONE,FIRSTFLG
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ENDIF
            WRITE     HTMLFILE;"Patient did not attend the following:",012:
                               "Date / Time":
                               011,"Clinic":
                               011,011,011,"Reason",012;
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CHKDNA10
.
          MOVE      SP70,TDESC
          MOVE      "CA",CATEGORY
          PACK      CODE,OBAATTN,SP70
          CALL      GETCOD00
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY14,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CHKDNA10
.
            MATCH     OBASITE,OCASITE
            GOTO      CHKDNA10 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      CHKDNA10 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;CDAY,"/",CMON,"/",CCENT,CYEAR,SP1,OBATIME,011:
                             OCADESC,011,TDESC
          ADD       ONE,COUNTDNA
          IF        COUNTDNA<10
            GOTO      CHKDNA10 
          ENDIF
.
CHKDNA90  
.
CHKDNA99  RETURN
.------------------------------------------------------------
. Check for Overbooking
.------------------------------------------------------------
CHKOVR00  MOVE      ZERO,EXIT
          MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKOVR90   * Should Never Happen
          MOVE      NEWSLOTK,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,CHKOVR90   * Should Never Happen
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CHKOVR90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHKOVR90
.
          CALL      CHKGRP00
          BRANCH    CHKGRPIN,CHKOVR90
.
          MOVE      "CV",CATEGORY
.
          MATCH     SP70,NEWVISTY
          IF        @EQUAL
            MOVE      OBAVISIT,CODE
          ELSE
            MOVE      NEWVISTY,CODE
          ENDIF
.
          CALL      GETCOD00
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MATCH     SP70,OSETIMEU
          IF        @EQUAL
            MOVE      "00",KEY2
            MOVE      COLON,KEY1
            MOVE      "00",MIN
          ELSE
            UNPACK    OSETIMEU,KEY2,KEY1,MIN  * HH:MM
          ENDIF
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
          ASSIGN    (HOUR*60)+MINUTES+(OTHEDURN*TCFORM6),MINUSED
.
          MATCH     SP70,OSETIMES
          IF        @EQUAL
            MOVE      "00",KEY2
            MOVE      COLON,KEY1
            MOVE      "00",MIN
          ELSE
            UNPACK    OSETIMES,KEY2,KEY1,MIN  * HH:MM
          ENDIF
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
          ASSIGN    (HOUR*60)+MINUTES,MINSCHD
.
          IF        MINUSED>MINSCHD
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ENDIF
            WRITE     HTMLFILE;"This will Over Book the Clinic."
            MOVE      ONE,EXIT
            GOTO      CHKOVR99
          ENDIF
.
CHKOVR90  MOVE      ZERO,EXIT
CHKOVR99  RETURN
.------------------------------------------------------------
. Determine Template & Check Security
.------------------------------------------------------------
SECLEV00  MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          PACK      TEMPLFIL,SP70,SP70
          PACK      KEY13,PRGID,KEY2,KEY3
          CALL      RDWBTP1
          IF        OVRCD=1
            MOVE     " 0",WBTPLEV
          ENDIF
.
          MOVE      ZERO,F2
          MOVE      WBTPLEV,F2
          COMPARE   ZERO,F2
          GOTO      SECLEV90 IF EQUAL
.
          PACK      KEY18,WBSEUID,WBTPPRG
          CALL      RDWBST1
          BRANCH    OVRCD,SECLEV80
          IF        WBSTLEV<F2
            GOTO      SECLEV80
          ENDIF
          GOTO      SECLEV90
.
SECLEV80  MOVE      ONE,EXIT
          GOTO      SECLEV99
.
SECLEV90  MOVE      ZERO,EXIT
.
SECLEV99  RETURN

.******************************************************************************
. REMOTE SCRIPTING ROUTINE - Slot Reservation
.******************************************************************************
RESERV00  IF        FHIRTYPE=ONE
            CLEAR     FHIRSLOT
            APPEND    "SlotR4/SLOT-",FHIRSLOT
            APPEND    CASEKEYS,FHIRSLOT
            RESET     FHIRSLOT
            STRIP     FHIRSLOT
            REP       " -",FHIRSLOT
          ENDIF
.
          MATCH     SP70,CASEKEYS
          GOTO      RESERV90 IF EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RLOTBOA1
          BRANCH    OVRCD,RESERV90,RESERV92
          COMPARE   ZERO,OBASTAT
          GOTO      RESERV10 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT
          GOTO      RESERV94 IF EQUAL
.
          COMPARE   NINE,OBASTAT
          GOTO      RESERV91 IF NOT EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDOTSRV1
          BRANCH    OVRCD,RESERV10
          MATCH     USERID,OTSRWEBU
          GOTO      RESERV93 IF NOT EQUAL
          GOTO      RESERV20
.
RESERV10  PACK      KEY16,RESERVE2,RESERVE3
          MATCH     SP70,KEY16            * Specified Reservation Date & Time
          CALL      CALRSV00 IF EQUAL     * Call to find expiry date & Time
.
          PACK      KEY28,CASEKEYS,SP70
          UNPACK    KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT
          CALL      RDOTSRV1
          COMPARE   ZERO,OVRCD
          GOTO      RESERV93 IF EQUAL   * Reservation Exists for Slot
.
          MOVE      RESERVE2,OTSREDAT
          MOVE      RESERVE3,OTSRETIM
          MOVE      USERID,OTSRWEBU
          PACK      OTSRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTSRRDAT
          CLOCK     TIME,OTSRRTIM
          MOVE      SP70,OTSRSPAR
          CALL      WROTSRV1
.
          MOVE      NINE,OBASTAT
          CALL      UPBOKA1
          CALL      UUOTBOA1
.
RESERV20  IF        FHIRTYPE=ONE
            MOVE      "All Ok",DIM50
            CALL      FHIROK00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      " OK ":
                      "</RETURN_VALUE>"
          ENDIF
.
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV90  IF        FHIRTYPE=ONE
            MOVE      "Invalid Appointment Slot Key",DIM50
            CALL      FHIRER00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Invalid Appointment Slot Key":
                      "</RETURN_VALUE>"
          ENDIF
.
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV91  IF        FHIRTYPE=ONE
            MOVE      "Appointment Locked",DIM50
            CALL      FHIRER00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Appointment Locked ":
                      "</RETURN_VALUE>"
          ENDIF
.
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV92  IF        FHIRTYPE=ONE
            MOVE      "Appointment Slot Not Available ",DIM50
            CALL      FHIRER00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Appointment Slot Not Available ":
                      "</RETURN_VALUE>"
          ENDIF
.
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV93  IF        FHIRTYPE=ONE
            MOVE      "Appointment Slot Reserved By Another User",DIM50
            CALL      FHIRER00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Appointment Slot Reserved By Another User":
                      "</RETURN_VALUE>"
          ENDIF
.
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV94  IF        FHIRTYPE=ONE
            MOVE      "Appointment Slot Reserved By Another User",DIM50
            CALL      FHIRER00
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "This slot is Unavailable":
                      "</RETURN_VALUE>"
          ENDIF

          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV99  RETURN
+
.------------------------------------------------------------------------------
.         FHIR API Error
.------------------------------------------------------------------------------
FHIRER00    STRIP     DIM50
            WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                               "Cache-Control: no-cache",012:
                               "Location: %BASEURL/",FHIRSLOT,012,012;
.
            WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                               "  #"id#": #"error#", ":
                               "  #"text#": { ":
                               "    #"status#": #"additional#", ":
                               "    #"div#": #"<div>Error</div>#" ":
                               "  }, ":
                               "  #"issue#": [ ":
                               "    { ":
                               "      #"severity#": #"error#", ":
                               "      #"code#": #"error#", ":
                               "      #"details#": { ":
                               "        #"text#": #"",DIM50,"#"":
                               "  } } ] }"
FHIRER99    RETURN
+
.------------------------------------------------------------------------------
.         FHIR API Ok    
.------------------------------------------------------------------------------
FHIROK00    STRIP     DIM50
            WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                               "Cache-Control: no-cache",012:
                               "Location: %BASEURL/",FHIRSLOT,012,012;
.
            WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                               "  #"id#": #"allok#", ":
                               "  #"text#": { ":
                               "    #"status#": #"additional#", ":
                               "    #"div#": #"<div>All Ok</div>#" ":
                               "  }, ":
                               "  #"issue#": [ ":
                               "    { ":
                               "      #"severity#": #"information#", ":
                               "      #"code#": #"information#", ":
                               "      #"details#": { ":
                               "        #"text#": #"",DIM50,"#"":
                               "  } } ] }"
FHIROK99    RETURN
+
.------------------------------------------------------------------------------
.         Remote Script to check in OP Clinic is of type Mental Health Group
.------------------------------------------------------------------------------
CHKOPM00  PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKOPM90
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CHKOPM90
.
          MOVE      "CG",KEY2
          PACK      KEY5,KEY2,OCTGRP,SP70        * Clinic Group
          CALL      RDCODE1
          BRANCH    OVRCD,CHKOPM90
.
          MATCH     "M",TCINDC4
          GOTO      CHKOPM91 IF EQUAL
.
CHKOPM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>0</RETURN_VALUE>"
          GOTO      CHKOPM99
.
CHKOPM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"
          GOTO      CHKOPM99
.
CHKOPM99  RETURN
+
.----------------------------------------------------
. Calculate Expiry Date & Time for Slot Reservation
.----------------------------------------------------
CALRSV00  SQUEEZE   RESERVE1
          MOVE      ZERO,RESVMINS
          MOVE      RESERVE1,RESVMINS
          IF        RESVMINS=0
            MOVE      "2",RESVMINS
          ENDIF
          CLOCK     TIME,CTIMEIS
          UNPACK    CTIMEIS,CHOUR,KEY1,CMIN,KEY1,CSEC
          MOVE      CHOUR,FORM2        * set up hours as a form
          MOVE      FORM2,FORM4D       * get in work variable
          MULT      "60",FORM4D        * get the minutes of full hours
          MOVE      CMIN,FORM2         * set up minutes as a form
          ADD       FORM2,FORM4D       * get the total min of end time
          ADD       RESVMINS,FORM4D    * add reservation mins
          MOVE      FORM4D,SFORM4D
.
          IF        FORM4D>1440
            SUB       "1440",FORM4D
            MOVE     CCC,CC
            MOVE     CYY,YY
            MOVE     CMM,MM
            MOVE     CDD,DD
            CALL     DMYCON
            ADD      ONE,JULDAY
            MOVE     JULDAY,JWKDAY
            MOVE     JULYR,JWKYER
            MOVE     JULCC,JWKCC
            CALL     JULCON
          ENDIF
.
          ASSIGN    FORM4D/SIXTY,FORM4D
          ASSIGN    FORM4D*SIXTY,FORM4D
          SUB       FORM4D,SFORM4D
          MOVE      SFORM4D,F2
          MOVE      F2,CMIN
          ASSIGN    FORM4D/SIXTY,FORM4D
          MOVE      FORM4D,F2
          MOVE      F2,CHOUR
          PACK      RESERVE2,CCC,CYY,CMM,CDD
          REP       " 0",RESERVE2
          PACK      RESERVE3,CHOUR,KEY1,CMIN,KEY1,CSEC
          REP       " 0",RESERVE3
          RETURN              
.******************************************************************************
.                     REMOTE SCRIPTING FUNCTION-  Update Times
.******************************************************************************
UPDATE00  MATCH     CASEKEYS,SP70
          GOTO      UPDATE94 IF EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDATE94
.
          PACK      CURDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURDATE
.
          MATCH     OBADATE,CURDATE
          GOTO      UPDATE93 IF LESS
.
          MATCH     SP70,ADMISSNO
          GOTO      UPDATE94 IF EQUAL
.
          PACK      KEY8,ADMISSNO
          CALL      RLOTBOB1
          BRANCH    OVRCD,UPDATE94,UPDATE95
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDATE92          * invalid UR number
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                * read 2nd master file extension
          BRANCH    OVRCD,UPDATE92          * invalid UR number
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,UPDATE91
.
          CLOCK     TIME,CTIMEIS
          BRANCH    UPDTTIME,UPDATE10,UPDATE20,UPDATE30,UPDATE40,UPDATE50
.
UPDATE10  MOVE      CTIMEIS,OTBBTMFS               * Time First Seen
          GOTO      UPDATE90
.
UPDATE20  MOVE      CTIMEIS,OTBBTMBO               * Time Booked Out
          GOTO      UPDATE90
.
UPDATE30  MATCH     SP70,OTBBASTM
          GOTO      UPDATE98 IF NOT EQUAL
.
          CALL      REMBOK00                      * Attend patients on check in
          IF        EXIT = 1
            CALL      UPBOKB1                     * Error with attendance
            CALL      UUOTBOB1
            CALL      UUOTBOA1
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
                CALL      IBACLOCK
                PACK      PMVXLUPD,CCC,CYY,CMM,CDD
                REP       " 0",PMVXLUPD
                MOVE      CTIMEIS,PMVXLUPT
                MOVE      USERID,PMVXWEBU
                CALL      UPPMVX11
            ENDIF

.
            GOTO      UPDATE99
          ENDIF
.
          MATCH     Z70,OUTBB032                 * Check in time received
          IF        !@EQUAL
            MOVE      OUTBB032,CTIMEIS
          ENDIF
.
          MOVE      CTIMEIS,OTBBCITM              * Check In Time
          GOTO      UPDATE90
.
UPDATE40  MATCH     SP70,OTBBCITM
          GOTO      UPDATE97 IF EQUAL            * Can't see a patient not
.
          MATCH     Z70,OUTBB033                 * Time seen received
          IF        !@EQUAL
            MOVE      OUTBB033,CTIMEIS
          ENDIF
.
          CALL      DEPE0000                     * Liked referral department
          BRANCH    EXIT,UPDATE48                * using check in time edits
.
          MATCH     OTBBCITM,CTIMEIS             * checked in
          GOTO      UPDATE96 IF LESS
.
UPDATE48  MOVE      CTIMEIS,OTBBASTM              * Time Actually Seen
          GOTO      UPDATE90
.
UPDATE50  MATCH     SP70,OTBBDPTM
          IF        @EQUAL
            MOVE      ONE,DISCFLAG                * Send A03 discharge message
          ENDIF
.
          MATCH     Z70,OUTBB034                 * Departure Time seen received
          IF        !@EQUAL
            MOVE      OUTBB034,CTIMEIS
          ENDIF
.
          MOVE      CTIMEIS,OTBBDPTM              * Time of Departure
          GOTO      UPDATE90
.
UPDATE90  CALL      UPBOKB1
          CALL      UUOTBOB1
          CALL      UUOTBOA1
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
            IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY7,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          MOVE      CTIMEIS,KEY5
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    KEY5:
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.
UPDATE91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Clinic Master.":
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.
UPDATE92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid U/R Number.":
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.
UPDATE93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Function Not Available For Sessions In The Future ":
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.
UPDATE94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Booking.":
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.
UPDATE95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Booking Record Locked.":
                    "</RETURN_VALUE>"
          GOTO      UPDATE99
.                                             Error condition for CR 147
UPDATE96  IF        AHAUTOTS<>1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Time Seen should be after the Checkin Time. U/R - ":
                      OBAURNO,"</RETURN_VALUE>"
          ENDIF
          CALL      UUOTBOB1
          GOTO      UPDATE99
.
UPDATE97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Can't enter Time Seen.Patient not checked in. U/R - ":
                    OBAURNO,"</RETURN_VALUE>"
          CALL      UUOTBOB1
          GOTO      UPDATE99
.
UPDATE98  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Can't change Check-in Time.Patient already seen. U/R -":
                    OBAURNO,"</RETURN_VALUE>"
          CALL      UUOTBOB1
          GOTO      UPDATE99
.
UPDATE99  RETURN                    
.*******************************************************************************
.                   REMOTE SCRIPTING FUNCTION-  Cancel Times 
.*******************************************************************************
CANCEL00  MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO    CANCEL90
          ENDIF
          PACK      KEY28,CASEKEYS,SP70
          CALL      RLOTBOA1
          BRANCH    OVRCD,CANCEL90,CANCEL90
.
          MOVE      OBASTRT,OTSRSTIM
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OTSRSTIM,OBASLOT,SP70
          CALL      RDOTSRV1
          IF        OVRCD=0
            CALL      DEOTSRV1
          ENDIF
.
          IF        OBASTAT=9
            MOVE      ZERO,OBASTAT
            CALL      UPBOKA1
          ENDIF
          CALL      UUOTBOA1
.
CANCEL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    "OK":
                    "</RETURN_VALUE>"
          GOTO      CANCEL99
.
CANCEL99  RETURN
.*******************************************************************************
.        VALIDATE SESSION DATE AND UPDATE STATUS OF OUTPATIENT SESSION 
.*******************************************************************************
UPDDNA00  MATCH     CASEKEYS,SP70
          GOTO      UPDDNA97 IF EQUAL
.
          UNPACK    CASEKEYS,OBASITE,OBACLIN,OBADATE
          PACK      CURDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURDATE
          REP       " 0",OBADATE
          MATCH     OBADATE,CURDATE
          GOTO      UPDDNA95 IF LESS
.
UPDDNA10  PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDDNA96
          COMPARE   "1",OBASTAT               * CHECK IF SESSION IS BOOKED
          GOTO      UPDDNA94 IF NOT EQUAL
          MOVE      TWO,AUDIFLAG
          CALL      AUDOTBOA
          MOVE      FIVE,OBASTAT
          CALL      UPBOKA1
.
          CALL      DHIC0000                 * Delete HIC CMBS items (if any)
.
          CALL      CWAT0000                * Cancel waiting list link PAC
          CALL      CWAI0000                * Cancel waiting list link PAS
.
          MOVE      OUTBB005,OBAATTN        * load DNA Reason
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOD                * DG O/P Did Not Attend Ap *I-90203
.
          MOVE      THREE,AUDIFLAG          * set flag to write a c audit
          CALL      AUDOTBOA                * write audit
          GOTO      UPDDNA98
.
UPDDNA94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    "OK":
                    "</RETURN_VALUE>"           
          GOTO      UPDDNA99
.     
UPDDNA95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Function Not Available For Sessions In The Future ":
                    "</RETURN_VALUE>"
          GOTO      UPDDNA99
.
UPDDNA96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Record Does Not Exist ",URNUMBER:
                    "</RETURN_VALUE>"
          GOTO      UPDDNA99
.
UPDDNA97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Record ",URNUMBER:
                    "</RETURN_VALUE>"
          GOTO      UPDDNA99
.
UPDDNA98  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    "OK":
                    "</RETURN_VALUE>"           
          GOTO      UPDDNA99
.     
UPDDNA99  RETURN
.
.*******************************************************************************
.                          Process Templated Fields
.*******************************************************************************
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD99,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD99,PROFLD99,PROFLD99:
                             PROFL210,PROFLD99,PROFL230,PROFL240,PROFL250
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  CALL      SLST0000  * Session Diary
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      CLST0000  * Case List
          GOTO      PROFLD99
.
PROFLD22  CALL      OEXT0000  * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37,PROFLD38,PROFLD39,PROFLD40
.
PROFLD31  CALL      MASF0000     * Masterfile Details 
          GOTO      PROFLD99
.
PROFLD32  CALL      OOSE0000     * Session Details
          GOTO      PROFLD99
.
PROFLD33  CALL      DOCF0000     * Doctor Details
          GOTO      PROFLD99
.
PROFLD34  CALL      OBOA0000     * Outpatient Booking File
          GOTO      PROFLD99
.
PROFLD35  CALL      MSXF0000     * Master Extension File
          GOTO      PROFLD99
.
PROFLD36  IF        PTCNNHII=1
            CALL      NHIF0000   * National System
          ENDIF
          GOTO      PROFLD99
.
PROFLD37  CALL      OEXT0000     * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD38  CALL      ORFL0000     * Referral Details
          GOTO      PROFLD99
.
PROFLD39  CALL      VXTF0000     * Visit Extension Details
          GOTO      PROFLD99
.
PROFLD40  CALL      OTTHI000     * Telehealth Information
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55
.
PROFLD51  CALL      MASF0000     * Masterfile Details 
          GOTO      PROFLD99
.
PROFLD52  CALL      OBOA0000     * Outpatient Booking File
          GOTO      PROFLD99
.
PROFLD53  CALL      OEXT0000     * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD54  CALL      ORFL0000     * Outpatient Referral letter file 
          GOTO      PROFLD99
.
PROFLD55  CALL      VXTF0000     * Visit Extension Details
          GOTO      PROFLD99
.
PROFL210  CALL      OPCN0000     * Cancelled Appointment File
          GOTO      PROFLD99
.
PROFL230  BRANCH    FLDSETNO,PROFL231                    * I-47446
.
PROFL231  CALL      GPLB0000     * Outpatient Referral letter file
          GOTO      PROFLD99
.
PROFL240  BRANCH    FLDSETNO,PROFL241       
.
PROFL241  CALL      MTVW0000     * Multi Therapist View
          GOTO      PROFLD99
.
PROFL250  BRANCH    FLDSETNO,PROFL251,PROFL252
          GOTO      PROFLD99
.
PROFL251  CALL      OBOA0000     * Outpatient Booking File
          GOTO      PROFLD99
.
PROFL252  CALL      ALRE0000     * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Extra Outpatient Fields for Booking/Follow up/Reschedule
.------------------------------------------------------------
OEXT0000  BRANCH    FLDITMNO,OEXT0100,OEXT0200,OEXT0300,OEXT0400,OEXT0500:
                             OEXT0600,OEXT0700,OEXT0800,OEXT0900,OEXT1000:
                             OEXT1100,OEXT1200,OEXT1300,OEXT1400,OEXT1500:
                             OEXT1600,OEXT1700,OEXT1800,OEXT1900,OEXT2000:
                             OEXT2100,OEXT2200,OEXT2300,OEXT2400,OEXT2500:
                             OEXT2600,OEXT2700,OEXT2800,OEXT2900,OEXT3000:
                             OEXT3100,OEXT3200,OEXT3300,OEXT3400,OEXT3500:
                             OEXT3600,OEXT3700,OEXT3800,OEXT3900,OEXT4000:
                             OEXT4100,OEXT4200,OEXT4300,OEXT4400,OEXT4500:
                             OEXT4600,OEXT4700,OEXT4800,OEXT4900,OEXT5000:
                             OEXT5100,OEXT5200,OEXT5300,OEXT5400,OEXT5500:
                             OEXT5600,OEXT5700,OEXT5800,OEXT5900,OEXT6000:
                             OEXT6100,OEXT6200,OEXT6300,OEXT6400,OEXT6500:
                             OEXT6600,OEXT6700,OEXT6800,OEXT6900,OEXT7000:
                             OEXT7100,OEXT7200,OEXT7300,OEXT7400,OEXT7500:
                             OEXT7600,OEXT7700,OEXT7800,OEXT7900,OEXT8000:
                             OEXT8100,OEXT8200,OEXT8300,OEXT8400,OEXT8500:
                             OEXT8600,OEXT8700,OEXT8800,OEXT8900,OEXT9000:
                             OEXT9100,OEXT9200,OEXT9300,OEXT9400,OEXT9500:
                             OEXT9600,OEXT9700,OEXT9800,OEXT9900
.
          WRITE     HTMLFILE;"Invalid Tag - OEXT0000"
          GOTO      OEXT9999
.
OEXT0100  CALL      SCODL000
          GOTO      OEXT9999
.
OEXT0200  CALL      RSHCNT00
          GOTO      OEXT9999
.
OEXT0300  WRITE     HTMLFILE;PMVXUDF1;      * PMSVX1FD (Visit Extension Table) 
          GOTO      OEXT9999
.
OEXT0400  CALL      NXTAPP00  * Next Available Appointment Details by Type
          GOTO      OEXT9999
.
OEXT0500  CALL      GETCTY00
          GOTO      OEXT9999
.
OEXT0600  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1
          GOTO      OEXT9999
.
OEXT0700  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT0800  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,OEXT0810,OEXT0820
.
          IF        OBASTAT=1
            WRITE     HTMLFILE;"<option value=1 selected>Booked</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=1>Booked</option>"
          ENDIF
          IF        OBASTAT=4
            WRITE     HTMLFILE;"<option value=4 selected>Attended</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=4>Attended</option>"
          ENDIF
          IF        OBASTAT=5
            WRITE     HTMLFILE;"<option value=5 selected>Did Not Attend</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=5>Did Not Attend</option>"
          ENDIF
          GOTO      OEXT9999
.
OEXT0810  WRITE     HTMLFILE;OBASTAT;
          GOTO      OEXT9999
.
OEXT0820  IF        OBASTAT=1
            WRITE     HTMLFILE;"Booked";
          ENDIF
          IF        OBASTAT=4
            WRITE     HTMLFILE;"Attended";
          ENDIF
          IF        OBASTAT=5
            WRITE     HTMLFILE;"Did Not Attend";
          ENDIF
          GOTO      OEXT9999
.
OEXT0900  WRITE     HTMLFILE;SHWPRINT;
          GOTO      OEXT9999
.
OEXT1000  CALL      NXTAID00  * Next Available Appointment Details by ID
          GOTO      OEXT9999
.                   
OEXT1100  MOVE      "R  ",CODE
          MOVE      ZERO,VISTFLAG
          CALL      VTYSEL00
          GOTO      OEXT9999
.                   
OEXT1200  WRITE     HTMLFILE;OTCNOCRD;
          GOTO      OEXT9999
.
OEXT1300  WRITE     HTMLFILE;OTCNOCDD;
          GOTO      OEXT9999
.
OEXT1400  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      OEXT9999
.
OEXT1500  WRITE     HTMLFILE;NEXTSCRN;  * redirect program after extra pgm
          GOTO      OEXT9999
.
OEXT1600  WRITE     HTMLFILE;PTCNUEOC;  * Using episode of care
          GOTO      OEXT9999
.
OEXT1700  WRITE     HTMLFILE;DEPTFLAG;  * Time default flag for departure screen
          GOTO      OEXT9999
.
OEXT1800  CALL      HTMS0000            * Is this booking part of a series.
          GOTO      OEXT9999
.
OEXT1900  WRITE     HTMLFILE;WAITLKEY;  * Waiting list key for pre admit clinics
          GOTO      OEXT9999
.
OEXT2000  WRITE     HTMLFILE;WAITFLAG;  * Return to Waiting list flag
          GOTO      OEXT9999
.
OEXT2100  IF        WAITFLAG=1
            PACK      WAITRKEY,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
            REP       " +",WAITRKEY
            WRITE     HTMLFILE;WAITRKEY;  * Return to Waiting list key PAC
          ELSE
            PACK      WAITRKEY,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
            REP       " +",WAITRKEY
            WRITE     HTMLFILE;WAITRKEY;  * Return to Waiting list key PAS
          ENDIF
          GOTO      OEXT9999
.
OEXT2200  WRITE     HTMLFILE;OTCNCSUM;  * Using clinic summary for app search
          GOTO      OEXT9999
.
OEXT2300  CALL      RDCM0000            * read cancellation comments   *I-48413
          GOTO      OEXT9999                                           *I-48413
.
OEXT2400  UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT2420
.
          MATCH     " 0",OTBIIFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"MBS";
            GOTO      OEXT9999
          ENDIF
.
          MATCH     " 1",OTBIIFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"AMA";
            GOTO      OEXT9999
          ENDIF
          GOTO      OEXT9999
.
OEXT2420  BRANCH    F1,OEXT9999             * No MBS default
          WRITE     HTMLFILE;"MBS";
          GOTO      OEXT9999
.
OEXT2500  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;OTBIITMN;
          GOTO      OEXT9999
.
OEXT2600  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;OTBISUBN;
          GOTO      OEXT9999
.
OEXT2700  UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          MOVE      OTBIIFLG,FORM2
          PACK      KEY22,OTBIIFLG,OTBIITMN,OTBISUBN,Z70 * Get current record
          CALL      RSPRIT1
OEXT2710  CALL      RPPRIT1
          BRANCH    OVRCD,OEXT9999
.
          COMPARE   FORM2,PRITFLAG           * Item Type
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     OTBIITMN,PRITITMN        * AMA/MBS Item
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     OTBISUBN,PRITSUBN        * Sub Item
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     SP70,OBADATE
          IF        !@EQUAL
            MATCH     PRITDAT1,OBADATE
            GOTO      OEXT2710 IF LESS
          ENDIF
.
          BRANCH    F1,OEXT2790
          WRITE     HTMLFILE;PRITDESC;       * AMA/MBS Description
          GOTO      OEXT9999
.
OEXT2790  WRITE     HTMLFILE;PRITSFEE;       * AMA/MBS schedule fee
          GOTO      OEXT9999
.
OEXT2800  MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1;
          GOTO      OEXT9999
.
OEXT2900  PACK      KEY4,SP70
          CALL      RSPRTHD1
OEXT2910  CALL      RKPRTHD1
          BRANCH    OVRCD,OEXT9999
.         MATCH     "1",PRTHINDC
.         IF        !@EQUAL
.           GOTO      OEXT2910        * Not Active
.         ENDIF
          PACK      KEY6,QUOTE,PRTHTMID,QUOTE
          MATCH     PRTHTMID,OTMAMBST
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               PRTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">",PRTHDESC,"</option>"
          ENDIF
          GOTO      OEXT2910
.
OEXT3000  MATCH     SP70,ALREREXP           * Open ended
          GOTO      OEXT9999 IF EQUAL
.
          MATCH     SP70,ALRERTYP           * No referral type
          GOTO      OEXT9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      OEXT9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
.
          MOVE      ALREREXP,CALCDATE
          SUB       F4,CALCDATE
.
          WRITE     HTMLFILE;CALCDATE;      * Referral warning date
.
          GOTO      OEXT9999
.
OEXT3100  MATCH     SP70,ALREREXP
          GOTO      OEXT9999 IF EQUAL
.
          WRITE     HTMLFILE;ALREREXP;
          GOTO      OEXT9999
.
OEXT3200  MATCH     SP70,ALRERDAT
          GOTO      OEXT9999 IF EQUAL
.
          WRITE     HTMLFILE;ALRERDAT;
          GOTO      OEXT9999
.
OEXT3300  MOVE      "No ",KEY3 
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,OEXT3320
          MATCH     DOBAOUTN,ALLNLNKV     * same visit no?
          GOTO      OEXT3320 IF NOT EQUAL
          MOVE      "Yes",KEY3
          WRITE     HTMLFILE;KEY3;
          GOTO      OEXT9999
.
OEXT3320  WRITE     HTMLFILE;"<font color=red size=3>",KEY3,"</font>";
          GOTO      OEXT9999
.
OEXT3400  WRITE     HTMLFILE;OTMAUMCI;       * Clinic using medclaims
          GOTO      OEXT9999
.
OEXT3500  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;OTBIPUSE;
          GOTO      OEXT9999
.
OEXT3600  WRITE     HTMLFILE;REDIRFLG;       * Hic claim redirect flag
          GOTO      OEXT9999
.
OEXT3700  WRITE     HTMLFILE;OTMAMPRC;       * Medical practice
          GOTO      OEXT9999
.
OEXT3800  MOVE      ZERO,FORM1
          PACK      KEY16,OBAOUTNO,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * read last hic claim record
          BRANCH    OVRCD,OEXT3820
          MATCH     DOBAOUTN,HCCLVISN
          GOTO      OEXT3820 IF NOT EQUAL   * Different visit number
          MATCH     " 0",HCCLSTAT
          GOTO      OEXT3820 IF EQUAL       * not batched
          MOVE      ONE,FORM1               * already batched
OEXT3820  WRITE     HTMLFILE;FORM1;
          GOTO      OEXT9999
.
OEXT3900  MOVE      ZERO,F2
          MOVE      OTBBGPPT,F2
          PACK      KEY10,OTBBGPPC,SP70
          PACK      GPPCCODE,KEY10,F2
          CALL      HCGDET00                * hcp practice details
          GOTO      OEXT9999
.
OEXT4000  UNPACK    DIM127,D1,KEY3,DIM127   * outhedaf file
          MOVE      KEY3,FLDITMNO
          CALL      OHED0000
          GOTO      OEXT9999
.
OEXT4100  WRITE     HTMLFILE;OTHECCAR;      * Collect Carer Details
          GOTO      OEXT9999
.
OEXT4200  MOVE      SP70,LETTER     * Letter to Pat. on reappointment
          CALL      SETLET00            * Letter Selection List
          GOTO      OEXT9999
.
OEXT4300  CALL      CHKE0000                * Display extra screen details
          GOTO      OEXT9999
.
OEXT4400  CALL      LTRSEL00                * Referral letter selection list
          GOTO      OEXT9999
.
OEXT4500  PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD=0
            WRITE     HTMLFILE;OCTUSDF1;
          ELSE
            WRITE     HTMLFILE;ZERO;
          ENDIF
          GOTO      OEXT9999
.
OEXT4600  WRITE     HTMLFILE;ALREVISN;      * Linked referral number
          GOTO      OEXT9999
.
OEXT4700  PACK      KEY24,OBAOUTNO,SP70
          CALL      RSALENC7
OEXT4750  CALL      RKALENC7
          BRANCH    OVRCD,OEXT9999
.
          MATCH     DOBAOUTN,ALENLINK
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled
          GOTO      OEXT4750 IF EQUAL
.
          WRITE     HTMLFILE;ALENENCT;
          GOTO      OEXT9999
.
OEXT4800  WRITE     HTMLFILE;ALREDEPT;      * Linked referral department
          GOTO      OEXT9999
.
OEXT4900  WRITE     HTMLFILE;OCADOCT;
          GOTO      OEXT9999
.
OEXT5000  WRITE     HTMLFILE;OMAKDOC;
          GOTO      OEXT9999
.
OEXT5100  MATCH     SP70,OSESGHCP
          GOTO      OEXT9999 IF EQUAL
          GOTO      OEXT9999 IF EOS
.
          MOVE      SP70,DOCFNAME
.
          PACK      KEY10,OSESGHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    OSESGHCP,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF 
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      OEXT9999
.
OEXT5200  WRITE     HTMLFILE;OSESGHCP;
          GOTO      OEXT9999
.
OEXT5300  PACK      KEY19,URNUMBER,ADMISSNO,SP70           * Read For Transport
          CALL      RSPMTSP1
          CALL      RKPMTSP1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     PMTSURNO,URNUMBER
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     PMTSVISN,ADMISSNO
          GOTO      OEXT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      OEXT9999
.
OEXT5400  WRITE     HTMLFILE;ALRESTAT;                                *I-227913
          GOTO      OEXT9999
.
OEXT5500  MATCH     SP8,ALREDCLO                                      *I-227913
          IF        @EQUAL
            MOVE      ALREDCAN,ALREDCLO
            MATCH     SP8,ALREDCLO
            IF        @EQUAL
              MOVE      ALRESRDT,ALREDCLO
            ENDIF
          ENDIF
          UNPACK    ALREDCLO,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      OEXT9999                                    * end *I-227913
.
OEXT5600  MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT5700  CALL      WATCOM00
          GOTO      OEXT9999
.
OEXT5800  WRITE     HTMLFILE;OTHENDPS;    * NUMBER OF DAYS PRIOR TO SEND LETTER
          GOTO      OEXT9999
.
OEXT5900  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY19,URNUMBER,ADMISSNO,SP70           * Read For Transport
          CALL      RSPMTSP1
          CALL      RKPMTSP1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     PMTSURNO,URNUMBER
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     PMTSVISN,ADMISSNO
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     "1",PMTSBOOK     
          IF       @EQUAL
            IF        F1=1
              WRITE    HTMLFILE;"(Booked)";
            ELSE
              WRITE    HTMLFILE;"Booked";
            ENDIF
          ELSE 
            IF        F1=1
              WRITE     HTMLFILE;"(Linked)";
            ELSE
              WRITE     HTMLFILE;"Linked";
            ENDIF
          ENDIF
          GOTO      OEXT9999
.
OEXT6000  CALL      DISSEL00
          GOTO      OEXT9999
.
OEXT6100  CALL      DISCD000
          GOTO      OEXT9999
.
OEXT6200  CALL      DISDS000
          GOTO      OEXT9999
.
OEXT6300  PACK      KEY34,URNUMBER,ADMISSNO,SP1,ONE,SP70
          CALL      RSOTDAN2
          CALL      RKOTDAN2
          BRANCH    OVRCD,OEXT9999
.
          MATCH     URNUMBER,OTDNURNO
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTDNVISN
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     " 1",OTDNATYP
          GOTO      OEXT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * OPD Message exists for visit
          GOTO      OEXT9999
.
OEXT6400  WRITE     HTMLFILE;SAVDSPLC;
          GOTO      OEXT9999
.
OEXT6500  WRITE     HTMLFILE;INVADMNO;
          GOTO      OEXT9999
.
OEXT6600  WRITE     HTMLFILE;INVVISTP;
          GOTO      OEXT9999
.
OEXT6700  WRITE     HTMLFILE;VISDHOSP;
          GOTO      OEXT9999
.
OEXT6800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,OEXT6810
.
          WRITE     HTMLFILE;SLOTREFN;
          GOTO      OEXT9999
.
OEXT6810  PACK      KEY8,SLOTREFN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,OEXT9999
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;TDESC;
          GOTO      OEXT9999
.
OEXT6900  WRITE     HTMLFILE;SLOTURNO;
          GOTO      OEXT9999
.
OEXT7000  WRITE     HTMLFILE;SLOTBTYP;
          GOTO      OEXT9999
.
OEXT7100  WRITE     HTMLFILE;SLOTREQK;
          GOTO      OEXT9999
.
OEXT7200  WRITE     HTMLFILE;SLOTCASK;
          GOTO      OEXT9999
.
OEXT7300  WRITE     HTMLFILE;SHOWFOLL;
          GOTO      OEXT9999
.
OEXT7400  WRITE     HTMLFILE;ADDSLOTK;
          GOTO      OEXT9999
.
OEXT7500  MATCH     SP70,ADDSLOTK         * Use next appt code to display added
          GOTO      OEXT9999 IF EQUAL     * slot details
.
          MOVE      ADDSLOTK,NXTAPPKY     * Set next slot to added slot key
          CALL      NXTAPP00  * Next Aailable Appointment Details by Type
          GOTO      OEXT9999
.
OEXT7600  WRITE     HTMLFILE;SHOWRESC;
          GOTO      OEXT9999
.
OEXT7700  PACK      KEY19,URNUMBER,ADMISSNO,SP70          * Read For Transport
          CALL      RSPMTSP1
          CALL      RKPMTSP1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     PMTSURNO,URNUMBER
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     PMTSVISN,ADMISSNO
          GOTO      OEXT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMTSUNIQ;      * Transport unique number
          GOTO      OEXT9999
.
OEXT7800  CALL      DISSD000
          GOTO      OEXT9999
.
OEXT7900  WRITE     HTMLFILE;SHOWTRAN;
          GOTO      OEXT9999
.
OEXT8000  MOVE      "013",KEY3
          MOVE      ADMISSNO,KEY8
          CALL      RDPI0000
          GOTO      OEXT9999
.
OEXT8100  MOVE      "014",KEY3
          MOVE      OTAROOBN,KEY8
          CALL      RDPI0000
          GOTO      OEXT9999
.
OEXT8200  MOVE      "0",KEY1
          CALL      LNKREF00
          GOTO      OEXT9999
.
OEXT8300  MOVE      "1",KEY1
          CALL      LNKREF00
          GOTO      OEXT9999
.
OEXT8400  WRITE     HTMLFILE;SHOWDNAA;
          GOTO      OEXT9999
.
OEXT8500  PACK      KEY11,ADMISSNO,Z70
          CALL      RDSRSHA1
          CALL      RDPRSHA1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     ADMISSNO,DOPRSOUT
          GOTO      OEXT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPRSSITE,OPRSCLIN,OPRSDATE,OPRSSTRT,DOPRSSLO;
          GOTO      OEXT9999
.
OEXT8600  MOVE      ONE,FRSTREAD
          PACK      KEY15,OBASITE,OBACTYP,SP70
          CALL      RSOTCCT1
OEXT8601  CALL      RKOTCCT1
          IF        OVRCD=1 
            IF        FRSTREAD=1
              GOTO      OEXT8602
            ELSE
              GOTO      OEXT9999
            ENDIF
          ENDIF
.
          MATCH     OBASITE,OTCCSITE
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      OEXT8602
            ELSE
              GOTO      OEXT9999
            ENDIF
          ENDIF
.
          MATCH     OBACTYP,OTCCCTYP
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      OEXT8602
            ELSE
              GOTO      OEXT9999
            ENDIF
          ENDIF
.
          PACK      KEY5,CATgb,OTCCCONT
          CALL      RDCODE1
.
.         MATCH     "A",PTCOACTV                                 *0951542
.         GOTO      OEXT8601 IF NOT EQUAL                        *0951542
.
          MATCH     OTBBCONT,OTCCCONT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value='",OTCCCONT,"' selected>",TDESC,"</option>";
          ELSE
.
            MATCH     "A",PTCOACTV
            GOTO      OEXT8601 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value='",OTCCCONT,"'>",TDESC,"</option>";
          ENDIF
          MOVE      ZERO,FRSTREAD
          GOTO      OEXT8601
.
OEXT8602  MOVE      CATgb,CATEGORY
          MOVE      OTBBCONT,CODE
          CALL      CODSEL00
          GOTO      OEXT9999
.
OEXT8700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,OEXT9999 
.
          BRANCH    F1,OEXT8701
.
          WRITE     HTMLFILE;OTBBCONT;
          GOTO      OEXT9999
.
OEXT8701  MATCH     SP3,OTBBCONT
          GOTO      OEXT9999 IF EQUAL
.
          PACK      KEY5,CATgb,OTBBCONT
          CALL      RDCODE1
          IF        OVRCD=1
            WRITE     HTMLFILE;"Unknown Code: ",OTBBCONT;
          ELSE
            WRITE     HTMLFILE;TDESC;
          ENDIF
.
          GOTO      OEXT9999
.
OEXT8800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,OEXT9999
.
          BRANCH    F1,OEXT8801

          WRITE     HTMLFILE;ALRECONT;
          GOTO      OEXT9999
.
OEXT8801  MATCH     SP3,ALRECONT
          GOTO      OEXT9999 IF NOT EQUAL
.
          PACK      KEY5,CATgb,ALRECONT
          CALL      RDCODE1
          IF        OVRCD=1
            WRITE     HTMLFILE;"Unknown Code: ",ALRECONT;
          ELSE
            WRITE     HTMLFILE;TDESC;
          ENDIF
.
          GOTO      OEXT9999
.
OEXT8900  PACK      KEY8,ALREVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;ALREPURC;
.
          GOTO      OEXT9999
.
OEXT9000  CALL      CHKOPL00           * Check linked Referral OP visits
          BRANCH    EXIT,OEXT9091
.
OEXT9090  WRITE     HTMLFILE;ZERO;
          GOTO      OEXT9999
.
OEXT9091  WRITE     HTMLFILE;ONE;
          GOTO      OEXT9999
.
OEXT9100  MOVE      "HP",CATEGORY
          MOVE      WTWMPHSP,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT9200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OTPR0000                * Procedures and Problems file
          GOTO      OEXT9999
.
OEXT9300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD<>0
            MOVE      SP70,PTDADCTS
          ENDIF
.
          MATCH     SP70,PTDADCTS
          GOTO      OEXT9999 IF EQUAL
.
          BRANCH    F1,OEXT9310
.
          WRITE     HTMLFILE;PTDADCTS;
          GOTO      OEXT9999
.
OEXT9310  PACK      KEY5,PTDADCTS,SP10
          CALL      RDPTVAD1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;PTVADESC;
          GOTO      OEXT9999
.
OEXT9400  MOVE      ZERO,F1
          CALL      CKIV0000                     * Check if invoice raised
          WRITE     HTMLFILE;EXIT;
          GOTO      OEXT9999
.
OEXT9500  WRITE     HTMLFILE;WACPMICH;
          GOTO      OEXT9999
.
OEXT9600  MATCH     SP70,OTBBFUND
          GOTO      OEXT9999 IF EQUAL
.
          STRIP     OTBBFUND
          STRIP     OTBBTBLE
          PACK      DISPHFND,LBRACK,OTBBFUND,SLASH,OTBBTBLE,RBRACK,SP70
          WRITE     HTMLFILE;DISPHFND;
          GOTO      OEXT9999
.
OEXT9700  MATCH     SP70,ALREVISN
          GOTO      OEXT9999 IF EQUAL
          GOTO      OEXT9999 IF EOS
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;WCCLMNO;
          GOTO      OEXT9999
.
.
OEXT9800  PACK      KEY8,ADMISSNO,SP20      * get ACC purchase order no
          CALL      RDPMWX11
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;PMWXPORD;
          GOTO      OEXT9999
.
OEXT9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OEXB0000                  * link to extra fields
          GOTO      OEXT9999
.
OEXT9999  RETURN
+
.------------------------------------------------------------
. Second Extra Outpatient Fields for Booking/Follow up/Reschedule
.------------------------------------------------------------
OEXB0000  BRANCH    FLDITMNO,OEXB0100,OEXB0200,OEXB0300,OEXB0400,OEXB0500:
                             OEXB0600,OEXB0700,OEXB0800,OEXB0900,OEXB1000:
                             OEXB1100,OEXB1200,OEXB1300
.
          WRITE     HTMLFILE;"Invalid Tag - OEXB0000"
          GOTO      OEXB9999
.
OEXB0100  PACK      KEY16,OBAOUTNO,Z70
          CALL      RSOTRAP2
          CALL      RPOTRAP2
          BRANCH    OVRCD,OEXB9999
.
          MATCH     OTRPRBKN,OBAOUTNO
          GOTO      OEXB9999 IF NOT EQUAL
.
          PACK      KEY36,OTRPOBKN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,OEXB0110
.
          MATCH     OTRPOBKN,OBAOUTNO
          GOTO      OEXB0110 IF NOT EQUAL
.
          WRITE     HTMLFILE;OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT;
.
OEXB0110  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          GOTO      OEXB9999
.
OEXB0200  COMPARE   THREE,BOOKFLAG               * From appointment request
          GOTO      OEXB9999 IF NOT EQUAL
.
          PACK      KEY13,OTARCMID,SP70
          CALL      RSOTRCM1
OEXB0210  CALL      RKOTRCM1
          BRANCH    OVRCD,OEXB9999
.
          MATCH     OTARCMID,OTRCUNIQ
          GOTO      OEXB9999 IF NOT EQUAL
.
          UNPACK    OTRCCOMM,DIM60
          WRITE     HTMLFILE;DIM60               * Only use 60 characters
          GOTO      OEXB0210
.
OEXB0300  UNPACK    DIM127,D1,KEY1,DIM127   * Default HCP
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY10,OCADOCT,SP70
.
          MATCH     SP70,OTMADEFD
          IF        !@EQUAL
            PACK      KEY10,OTMADEFD,SP70
          ENDIF
.
          MATCH     SP70,OTHEDEFD
          IF        !@EQUAL
            PACK      KEY10,OTHEDEFD,SP70
          ENDIF
.
          BRANCH    F1,OEXB0310
          CALL      RDPMHCP1
          BRANCH    OVRCD,OEXB9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      OEXB9999
.
OEXB0310  WRITE     HTMLFILE;KEY10;
          GOTO      OEXB9999
.
OEXB0400  MOVE      ONE,F1
          CALL      CKIV0000            * Check if ABF invoice raised
          WRITE     HTMLFILE;EXIT;
          GOTO      OEXB9999
.
OEXB0500  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MATCH     "1",ALRESTAT          * Waiting or Active referrals only
            GOTO      OEXB9999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ALREREXP           * Open ended
          GOTO      OEXB9999 IF EQUAL
.
          MATCH     SP70,ALRERTYP           * No referral type
          GOTO      OEXB9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OEXB9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      OEXB9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
.
          MOVE      ALREREXP,CALCDATE
          SUB       F4,CALCDATE
.
          WRITE     HTMLFILE;CALCDATE;      * Referral warning date
.
          GOTO      OEXB9999
.
OEXB0600  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MATCH     "1",ALRESTAT          * Waiting or Active referrals only
            GOTO      OEXB9999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ALREREXP
          GOTO      OEXB9999 IF EQUAL
.
          WRITE     HTMLFILE;ALREREXP;      * Referral expiry date
          GOTO      OEXB9999
.
OEXB0700  WRITE     HTMLFILE;SUPERLEV;      * Supervisor menu flag
          GOTO      OEXB9999
.
OEXB0800  UNPACK    DIM127,D1,FLDITEM,DIM127
          MOVE      FLDITEM,FLDITMNO
.
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            PACK      KEY6,OCADOCT,SP70     * Default Doctor (outcliaf)
          ELSE
            PACK      KEY6,OCACCONS,SP70    * Default Consultant (outcliaf)
          ENDIF
.
          MATCH     SP70,OTMADEFD
          IF        !@EQUAL
            PACK      KEY6,OTMADEFD,SP70    * Default Doctor (outma1af)
          ENDIF
.
          MATCH     SP70,OTHEDEFD
          IF        !@EQUAL
            PACK      KEY6,OTHEDEFD,SP70    * Default Doctor (outhedaf)
          ENDIF
.
          MATCH     SP70,KEY6
          GOTO      OEXB9999 IF EQUAL
.
          CALL      RDDOCT1
          BRANCH    OVRCD,OEXB9999
.
          CALL      DOCF0000                * Doctor Details
          GOTO      OEXB9999
.
OEXB0900  WRITE     HTMLFILE;VIEWOPCL;
          GOTO      OEXB9999
.
OEXB1000  MATCH     SP70,OTBBTCOD
          GOTO      OEXB1001 IF EQUAL
.
          PACK      KEY5,ANSN,ANSC,OTBBTCOD,SP70      * tier2 code outbb1af
          CALL      RDCODE1
          BRANCH    OVRCD,OEXB1001
          WRITE     HTMLFILE;"<option value=#"",OTBBTCOD,"#" selected>":
                              TDESC,"</option>"
.
          MATCH     OTBBTCOD,OTHETCOD
          GOTO      OEXB9999 IF EQUAL
.
OEXB1001  MATCH     SP70,OTHETCOD
          GOTO      OEXB9999 IF EQUAL
.
          PACK      KEY5,ANSN,ANSC,OTHETCOD,SP70      * tier2 code outhedaf
          CALL      RDCODE1
          BRANCH    OVRCD,OEXB9999
          WRITE     HTMLFILE;"<option value=#"",OTHETCOD,"#">":
                              TDESC,"</option>"
          GOTO      OEXB9999
.
OEXB1100  MOVE      "NC",CATEGORY                    *tier2 code outma1af 
          MOVE      OTMATCOD,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXB1200  PACK      KEY11,DOBAOUTN,OBACOMP
          MOVE      OBACOMP,SAVBCOMP                 *0950014

          CALL      RDPMEXT1
          IF        OVRCD=1
            CALL      CLPMSEXT
          ENDIF
.
          UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO
          CALL      PMEX0000               *Claim Extension Details
          GOTO      OEXB9999

OEXB1300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,OTHEPCOD
          GOTO      OEXB9999 IF EQUAL
.
          IF        F1=0
            WRITE     HTMLFILE;OTHEPCOD;  * Clinic type procedure code
          ELSE
            PACK      KEY21,OTHESITE,OTHECTYP,OTHEPCOD,SP70
            CALL      RDOTCPC1
            IF        OVRCD<>1
              WRITE     HTMLFILE;OTCPDESC; * Clinic type procedure desc
            ENDIF
          ENDIF
          GOTO      OEXB9999
.
OEXB9999  RETURN
+
.------------------------------------------------------------------------------
.         Telehealth Info Display and Update
.------------------------------------------------------------------------------
OTTHI000  BRANCH    FLDITMNO,OTTHI001,OTTHI002,OTTHI003,OTTHI004,OTTHI005:
                             OTTHI006,OTTHI007,OTTHI008
.
          WRITE     HTMLFILE;"Invalid Tag - OTTHI000"
          GOTO      OTTHI999
.
OTTHI001  MOVE      "OM",CATEGORY
          MOVE      OTTHSTAT,CODE
          CALL      CODITM00
          GOTO      OTTHI999
.
OTTHI002  WRITE     HTMLFILE;OTTHRSIT;
          GOTO      OTTHI999
.
OTTHI003  WRITE     HTMLFILE;OTTHRCOD;
          GOTO      OTTHI999
.
OTTHI004  WRITE     HTMLFILE;OTTHRADD;
          GOTO      OTTHI999
.
OTTHI005  STRIP     OTTHWURL;
          WRITE     HTMLFILE;*+,OTTHWURL;
          GOTO      OTTHI999
.
OTTHI006  WRITE     HTMLFILE;OTTHE164;
          GOTO      OTTHI999
.
.         Checks to see if there is a WC/ACC claim related to the admission
.         And prints the claim number
.
OTTHI007  MOVE      SP70,KEY8
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1                          * Locates Accident
          IF        OVRCD=1                          
                                                     * No Accident Found
            CALL      CLPATWC1                       * Clears WC Variable
          ENDIF
          WRITE     HTMLFILE;WCCLMNO;                * Displays accident number
          GOTO      OTTHI999
.
.         Checks to see if there is a WC/ACC claim related to the admission
.         and prints the date of the accident.
.
OTTHI008  MOVE      SP70,KEY8
          CALL      CLPATWC1                         * Clears WC Variables
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1                          * Locates Accident
          MATCH     SP70,WCACDAT                     * Confirms date exists
          GOTO      OTTHI999 IF EQUAL
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY    * Retrieves Date Values
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR  *Display Date
          GOTO      OTTHI999
.
OTTHI999  RETURN
.------------------------------------------------------------------------------
.         Check if any invoice already raised
.------------------------------------------------------------------------------
CKIV0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
CKIV1000  CALL      RDKINV3
          BRANCH    OVRCD,CKIV9000
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      CKIV9000 IF NOT EQUAL
.
          MATCH     "1",PTINCRST
          GOTO      CKIV1000 IF EQUAL     * Fully credited
.
.         F1=1 Checking for ABF Invoice
.
          IF        F1=1
            COMPARE   THREE,PTINCMIX
            GOTO      CKIV1000 IF NOT EQUAL   * Not ABF invoice
          ENDIF
.
          MOVE      ONE,EXIT
          GOTO      CKIV9999
.
CKIV9000  MOVE      ZERO,EXIT
CKIV9999  RETURN
+
.------------------------------------------------------------------------------
.                   CHKOPL00
.
.         Checks if the OP visit has any Linked Referral with linked OP visits
.         that are booked/attended (OBASTAT)
.
.         OR...
.
.         If any active Group Contact sessions for the linked Referral
.
.         RETURN :
.         ========
.           EXIT = 1 - No Linked Referral OR
.                      Group Contact session exists for Linked Referral OR
.                      There are linked OP visits (booked/attended)
.
.           EXIT = 0 - No active Group Contact sessions or linked OP visits for
.                      the linked Referral (booked/attended)
.------------------------------------------------------------------------------
CHKOPL00  MOVE      ZERO,EXIT
          MOVE      DOBAOUTN,SAVEADMN
.
          PACK      KEY16,SAVEADMN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,CHKOPL91     * no Referral links
.
          MATCH     SAVEADMN,ALLNLNKV  * same Outpatient visit no?
          GOTO      CHKOPL91 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT       * Referral link cancelled ?
          GOTO      CHKOPL91 IF EQUAL
.
          MOVE      ALLNVISN,SAVEREFN
          PACK      KEY8,SAVEREFN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CHKOPL91     * no linked Referral
.
.         Check for any linked Group Contact sessions (active)...
.
          PACK      KEY24,ALREURNO,SP70
          CALL      RSALGRP3
CHKOPL10  CALL      RKALGRP3
          BRANCH    OVRCD,CHKOPL20
.
          MATCH     ALREURNO,ALGPURNO  * same UR as referral?
          GOTO      CHKOPL20 IF NOT EQUAL
.
          MATCH     SAVEREFN,ALGPREFN  * same Referral visit no. ?
          IF        @EQUAL
            MATCH     "0",ALGPACTV     * active Group Contact session?
            GOTO      CHKOPL91 IF EQUAL
          ENDIF
.
          GOTO      CHKOPL10           * get next Group Contact session
.
.         Check other linked Outpatient visits for this Referral...
.
CHKOPL20  PACK      KEY16,SAVEREFN,SP70
          CALL      RSALLNK1
CHKOPL21  CALL      RKALLNK1
          BRANCH    OVRCD,CHKOPL90     * finished; no attended linked OP visits
.
          MATCH     SAVEREFN,ALLNVISN  * same Referral?
          GOTO      CHKOPL90 IF NOT EQUAL
.
          MATCH     SAVEADMN,ALLNLNKV  * same as our current OP visit?
          GOTO      CHKOPL21 IF EQUAL  * yes; ignore validation below
.
          MATCH     "1",ALLNSTAT       * Referral link cancelled ?
          GOTO      CHKOPL21 IF EQUAL
.
.         Get the Outpatient booking
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CHKOPL21     * get next linked OP visit for Referral
.
          BRANCH    OBASTAT,CHKOPL91,CHKOPL21,CHKOPL21,CHKOPL91
          GOTO      CHKOPL21           * get next linked OP visit for Referral
                                       * if NOT Booked (1) or Attended (4)
.
CHKOPL90  MOVE      ZERO,EXIT
          GOTO      CHKOPL99
.
CHKOPL91  MOVE      ONE,EXIT
.
CHKOPL99  RETURN
+
.------------------------------------------------------------------------------
. Check if visit has any OPD messages that are not completed
.------------------------------------------------------------------------------
OPDM0000  MOVE      ZERO,OPDMFLAG
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OPDM9999
.
          MATCH     SP70,WBSEOPDU                * Not an OPD user
          GOTO      OPDM9999 IF EQUAL
.
          PACK      KEY34,OBAURNO,DOBAOUTN,SP1,ONE,SP70
          CALL      RSOTDAN2
OPDM1000  CALL      RKOTDAN2
          BRANCH    OVRCD,OPDM9999
.
          MATCH     OBAURNO,OTDNURNO
          GOTO      OPDM9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,OTDNVISN
          GOTO      OPDM9999 IF NOT EQUAL
.
          MATCH     " 1",OTDNATYP
          GOTO      OPDM9999 IF NOT EQUAL
.
          MATCH     "1",OTDNCOMP
          GOTO      OPDM1000 IF EQUAL
.
          MOVE      ONE,OPDMFLAG            * Outstanding OPD message exists
.
OPDM9999  RETURN

.
.------------------------------------------------------------
. Display Comments
.------------------------------------------------------------
WATCOM00  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      WATCOM99 IF NOT EQUAL
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WATCOM10  CALL      RDKMESA1
          BRANCH    OVRCD,WATCOM99
.
          MATCH     WMURNO,WAURNO
          GOTO      WATCOM99 IF NOT EQUAL
.
          MATCH     WMCODE,WAPROC
          GOTO      WATCOM99 IF NOT EQUAL
.
          COMPARE   WMCNT,WACNT
          GOTO      WATCOM99 IF NOT EQUAL
.
          STRIP     WATEXT
          MOVELPTR  WATEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WATEXT,VAR
          WRITE     HTMLFILE;VAR,"\n";
          SFORMAT   VAR,127
.
          GOTO      WATCOM10
WATCOM99  RETURN
.
.------------------------------------------------------------
. Ouput Clinic Type for Selected Session (SESSKEYS)
.------------------------------------------------------------
GETCTY00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          MATCH     SP70,SESSKEYS
          GOTO      GETCTY99 IF EQUAL
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GETCTY99
.
          BRANCH    F1,GETCTY10
.
          WRITE     HTMLFILE;OCTDESC;
          GOTO      GETCTY99
.
GETCTY10  WRITE     HTMLFILE;OCTCTYP;
          GOTO      GETCTY99
.
GETCTY99  RETURN
.------------------------------------------------------------
. Get Next Available Appointment
.------------------------------------------------------------
NXTAPP00  PACK      SAVKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          MATCH     SP70,NXTAPPKY
          GOTO      NXTAPP80 IF NOT EQUAL
.
. Don't search for the next available appointment if it's a mosaiq visit
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE         * MOSAIQ Visit
            IF        @EQUAL
              MOVE      Z70,NXTAPPKY        * clear next appointment key
              GOTO      NXTAPP80
            ENDIF
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,REQSLOTS
          MOVE      TCINDC1,REQTYPE                                    *I-58922
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          MOVE      KEY8,CALCDATE
          ADD       OSTMAXD,CALCDATE
.
          PACK      KEY13,OBASITE,OBACTYP,ZERO
          PACK      KEY35,OBASITE,OBACTYP,ZERO,KEY8,SP70
          CALL      RDBOKA2
NXTAPP10  CALL      RDKBOKA2
          BRANCH    OVRCD,NXTAPP95
          PACK      KEY14,OBASITE,OBACTYP,OBASTAT,SP70
          MATCH     KEY13,KEY14
          GOTO      NXTAPP95 IF NOT EQUAL
.
          MATCH     OBADATE,CALCDATE
          GOTO      NXTAPP95 IF LESS
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NXTAPP10
.
          MATCH     ANSZ,TCINDC2            * Can not reschedule to an over
          GOTO      NXTAPP10 IF EQUAL       * booking
.
******************************************** Start of addition        *I-58922
          MATCH     "1",OTCNRSST            * check parameter
          IF        @EQUAL
            MATCH     TCINDC1,REQTYPE       * test the visit type
            GOTO      NXTAPP10 IF NOT EQUAL * not same visit type?
          ENDIF
.********************************************   End of addition        *I-58922
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,NXTAPP10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,NXTAPP10
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          BRANCH    MOSAIQCL,NXTAPP10       * MOSAIQ Clinic
.
          MATCH     "1",OTHEMREF
          IF        @EQUAL
            MATCH     SP70,ALREVISN         * Check if referral populated when
            GOTO      NXTAPP10 IF EQUAL     * referral is mandatory
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      NXTAPPKY,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          IF        REQSLOTS>1
            CALL      CHKSLT00
            BRANCH    EXIT,NXTAPP10
          ENDIF
.
          CALL      RESSLT00
          BRANCH    EXIT,NXTAPP10
.
NXTAPP80  MOVE      NXTAPPKY,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,NXTAPP95
.
          UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,NXTAPP81,NXTAPP82,NXTAPP83,NXTAPP84,NXTAPP85:
                       NXTAPP86,NXTAPP87
.
NXTAPP81  WRITE     HTMLFILE;CASEKEYS;
          GOTO      NXTAPP90
.
NXTAPP82  UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " at ",OBATIME;
          GOTO      NXTAPP90
.
NXTAPP83  PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OCADESC;
            GOTO      NXTAPP90
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          BRANCH    OVRCD,NXTAPP90
.
          MATCH     OBASITE,OCASITE
          GOTO      NXTAPP90 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      NXTAPP90 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      NXTAPP90
.
NXTAPP84  WRITE     HTMLFILE;OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT;
          GOTO      NXTAPP90
.
NXTAPP85  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      CODITM00
          GOTO      NXTAPP90
.
NXTAPP86  MOVE      NXTAPPKY,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,NXTAPP90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,NXTAPP90
.
          UNPACK    DIM127,D1,KEY3,DIM127   * outhedaf file
          MOVE      KEY3,FLDITMNO
          CALL      OHED0000
.
          MOVE      SAVKEY28,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,NXTAPP90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,NXTAPP90
.
          GOTO      NXTAPP90
.
NXTAPP87  PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OCADESC;
            GOTO      NXTAPP90
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          BRANCH    OVRCD,NXTAPP90
.
          MATCH     OBASITE,OCASITE
          GOTO      NXTAPP90 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      NXTAPP90 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      NXTAPP90
.
NXTAPP90  MOVE      SAVKEY28,CASEKEYS
          MOVE      SAVKEY28,KEY28
          CALL      RDBOKA1
.
          MOVE      SAVKEY28,KEY25
          CALL      RDSESA1
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          GOTO      NXTAPP99
.
NXTAPP95  UNPACK    DIM127,KEY1,ANS,DIM127
.
. Don't search for the next available appointment if it's a mosaiq visit
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE              * MOSAIQ Visit
            GOTO      NXTAPP97 IF EQUAL
          ENDIF
.
          MATCH     "3",ANS
          IF        @EQUAL
            MATCH     "1",OTCNRSST
            IF        @EQUAL
              WRITE     HTMLFILE;"No Slots Available - Visit Type";
            ELSE
              WRITE     HTMLFILE;"No Slots Available";
            ENDIF
          ENDIF
.
NXTAPP97  MOVE      Z70,NXTAPPKY          * clear next appointment key 
          MOVE      SAVKEY28,CASEKEYS
          MOVE      SAVKEY28,KEY28
          CALL      RDBOKA1
.
          MOVE      SAVKEY28,KEY25
          CALL      RDSESA1
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
.
NXTAPP99  RETURN
.------------------------------------------------------------
. Reserve Next Appointment Slot
.------------------------------------------------------------
RESSLT00  PACK      KEY28,CASEKEYS,SP70
          CALL      RLOTBOA1
          BRANCH    OVRCD,RESSLT95,RESSLT95
          COMPARE   ZERO,OBASTAT
          GOTO      RESSLT10 IF EQUAL
          COMPARE   NINE,OBASTAT
          GOTO      RESSLT95 IF NOT EQUAL
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDOTSRV1
          BRANCH    OVRCD,RESSLT10
          MATCH     USERID,OTSRWEBU
          GOTO      RESSLT95 IF NOT EQUAL
          GOTO      RESSLT20
.
RESSLT10  CALL      CALRSV00
          PACK      KEY28,CASEKEYS,SP70
          UNPACK    KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT
          CALL      RDOTSRV1
          COMPARE   ZERO,OVRCD
          GOTO      RESERV93 IF EQUAL   * Reservation Exists for Slot
.
          MOVE      RESERVE2,OTSREDAT
          MOVE      RESERVE3,OTSRETIM
          MOVE      USERID,OTSRWEBU
          PACK      OTSRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTSRRDAT
          CLOCK     TIME,OTSRRTIM
          MOVE      SP70,OTSRSPAR
          CALL      WROTSRV1
.
          MOVE      NINE,OBASTAT
          CALL      UPBOKA1
          CALL      UUOTBOA1
RESSLT20  MOVE      ZERO,EXIT
          GOTO      RESSLT99
.
RESSLT95  CALL      UUOTBOA1
          MOVE      ONE,EXIT
.
RESSLT99  RETURN
.------------------------------------------------------------
. Check Number of Slots are Available
. Ignore over bookings slots
.------------------------------------------------------------
CHKSLT00  PACK      KEY28,CASEKEYS
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKSLT90
.
CHKSLT10  CALL      RDKBOKA1
          BRANCH    OVRCD,CHKSLT90
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY25,CASEKEYS
          GOTO      CHKSLT90 IF NOT EQUAL
.
          COMPARE   THREE,OBASTAT           * an extended slot?        *I-58922
          GOTO      CHKSLT20 IF EQUAL       * continue if equal        *I-58922
          COMPARE   ZERO,OBASTAT
          GOTO      CHKSLT90 IF NOT EQUAL
.
CHKSLT20  PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70         * add label   *C-58922
          CALL      RDCODE1
          BRANCH    OVRCD,CHKSLT90
.
          MATCH     ANSZ,TCINDC2            * Can not reschedule to an over
          GOTO      CHKSLT90 IF EQUAL       * booking
.
          SUB       ONE,REQSLOTS
          COMPARE   ONE,REQSLOTS
          GOTO      CHKSLT10 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      CHKSLT99
.
CHKSLT90  MOVE      ONE,EXIT
.
CHKSLT99  RETURN
.------------------------------------------------------------
. Count Reschedules for Booking
.------------------------------------------------------------
RSHCNT00  MOVE      ZERO,RSHCOUNT
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1
RSHCNT10  CALL      RDKRSHA1
          BRANCH    OVRCD,RSHCNT90
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      RSHCNT90 IF NOT EQUAL
          ADD       ONE,RSHCOUNT
          GOTO      RSHCNT10
.
RSHCNT90  WRITE     HTMLFILE;RSHCOUNT;
RSHCNT99  RETURN
. ******************************************* Start of addition        *I-48413
.*******************************************************************************
.                    Read/Display Cancellation Comments
.*******************************************************************************
RDCM0000  MOVE      "005",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
RDCM1000  CALL      RKVSCMT1
          BRANCH    OVRCD,RDCM9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      RDCM9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      RDCM9999 IF NOT EQUAL
.
          UNPACK    VSCTDATA,DIM60,DIM40    * only use first 60 chars
          WRITE     HTMLFILE;DIM60
          GOTO      RDCM1000
.
RDCM9999  RETURN
. *******************************************   End of addition        *I-48413
+
.*******************************************************************************
.                          Session List 
.*******************************************************************************
SESLST00  MOVE      ONE,FLAGCLIN
          MATCH     SP70,CLINICID
          IF        @EQUAL
            MOVE      WBSECLI,CLINICID
          ENDIF
.
          MATCH     SP70,SITECODE
          IF        @EQUAL
            MOVE      WBSESIT,SITECODE
          ENDIF
.
          MATCH     SP70,CLINICID
          GOTO      SESLST10 IF EQUAL
.
          CALL      GETMAP00
          MOVE      ZERO,FLAGCLIN
.
          PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SESLST95
.
          MATCH     WBSESIT,OCASITE
          GOTO      SESLST95 IF NOT EQUAL
.
          MATCH     CLINICID,OCACLIN
          GOTO      SESLST95 IF NOT EQUAL
.
SESLST10  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Clinic Timetable",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,SESLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      SESLST99
.
SESLST95  MOVE      "INVALID CLINIC",WEBTITLE
          CALL      WEBERR00
.
SESLST99  RETURN
.*******************************************************************************
.                          Clinic Table
.*******************************************************************************
SLST0000  BRANCH    FLDITMNO,SLST0100,SLST0200,SLST0300,SLST0400,SLST0500:
                             SLST0600,SLST0700,SLST0800,SLST0900,SLST1000:
                             SLST1100,SLST1200,SLST1300,SLST1400,SLST1500:
                             SLST1600,SLST1700,SLST1800,SLST1900,SLST2000:
                             SLST2100,SLST2200,SLST2300,SLST2400,SLST2500:
                             SLST2600,SLST2700,SLST2800,SLST2900,SLST3000:
                             SLST3100,SLST3200,SLST3300,SLST3400,SLST3500:
                             SLST3600,SLST3700,SLST3800,SLST3900,SLST4000:
                             SLST4100,SLST4200,SLST4300,SLST4400,SLST4500:
                             SLST4600,SLST4700,SLST4800,SLST4900,SLST5000:
                             SLST5100,SLST5200,SLST5300,SLST5400,SLST5500:
                             SLST5600,SLST5700,SLST5800,SLST5900,SLST6000:
                             SLST6100,SLST6200,SLST6300,SLST6400,SLST6500:
                             SLST6600,SLST6700,SLST6800
.
SLST0100  CALL      NEXT0000
          GOTO      SLST9999
.
SLST0200  CALL      PREV0000
          GOTO      SLST9999
.
SLST0300  CALL      CURSTD00
          GOTO      SLST9999
.
SLST0400  CALL      CUREND00
          GOTO      SLST9999
.
SLST0500  CALL      CURYR000
          GOTO      SLST9999
.
SLST0600  CALL      CURMON00
          GOTO      SLST9999
.
SLST0700  CALL      SELV0000
          GOTO      SLST9999
.
SLST0800  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          BRANCH    FLAGCLIN,SLST9999
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      SLST9999
.
SLST1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      SLST9999
.
SLST1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      SLST9999
.
SLST1200  WRITE     HTMLFILE;CLINICID;
          GOTO      SLST9999
.
SLST1300  CALL      CLIOPT00
          GOTO      SLST9999
.
SLST1400  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      CLITAB00
          GOTO      SLST9999
.
SLST1500  CALL      CTYOPT00
          GOTO      SLST9999
.
SLST1600  MOVE      CLINICID,SAVKEY6
          MOVE      SRCHCLID,CLINICID
          CALL      CLIOPT00
          MOVE      SAVKEY6,CLINICID
          PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          GOTO      SLST9999
.
SLST1700  MATCH     SP70,SRCHDOCT
          GOTO      SLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHDOCT;
          GOTO      SLST9999
.
SLST1800  MATCH     SP70,SRCHDOCT
          GOTO      SLST9999 IF EQUAL
          MOVE      SRCHDOCT,DOCTCODE
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000 
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      SLST9999
.
SLST1900  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      CLISTB00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST2000  MOVE      ZERO,KIDSONLY
          MOVE      ZERO,SUPRFLAG
          CALL      SALT0000 
          GOTO      SLST9999
.                                           *** HPS Code Starts Here ***
.*******************************************************************************
. Standard Coded Field Option
.
.  Parameters    CLINIC TYPES
.
.  Tag Parameter 0=Description
.                1=Code
.                2=Selection List
.                3=Code with Indicators
.*******************************************************************************
SLST2100  ASSIGN    ONE,TMPFLG
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SLST2110,SLST2120,SLST2130
          GOTO      SLST9999
.
SLST2110  GOTO      SLST9999
.
SLST2120  MOVE      SP70,KEY42
          CALL      RDSCTYA2
SLST2125  CALL      RDKCTYA2
          BRANCH    OVRCD,SLST9999
          MATCH     OCTSITE,WBSESIT
          GOTO      SLST2125 IF NOT EQUAL
.
.         MOVE      ONE,TEMPONE
.         MATCH     TEMPONE,OCTACT
.         GOTO      SLST2125 IF EQUAL
.
          MATCH     OCTCTYP,CLINTYPE
          IF        @EQUAL
                    WRITE     HTMLFILE;"<option value=",OCTCTYP," selected>":
                              OCTDESC,"</option>"
          ELSE	
                    WRITE     HTMLFILE;"<option value=",OCTCTYP,">":
                              OCTDESC,"</option>"
          ENDIF
          GOTO      SLST2125
.
SLST2130  GOTO      SLST9999
.
SLST2200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,SRCHCLID
          GOTO      SLST9999 IF EQUAL
.
          BRANCH    F1,SLST2210
.
          PACK      KEY20,WBSESIT,SRCHCLID,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SLST2290
.
          MATCH     WBSESIT,OCASITE
          GOTO      SLST2290 IF NOT EQUAL
.
          MATCH     SRCHCLID,OCACLIN
          GOTO      SLST2290 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      SLST2290
.
SLST2210  WRITE     HTMLFILE;SRCHCLID;
          GOTO      SLST9999
.
SLST2290  PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          GOTO      SLST9999
.
SLST2300  MOVE      ONE,KIDSONLY
          MOVE      ZERO,SUPRFLAG
          CALL      SALT0000 
          GOTO      SLST9999
.
SLST2400  MOVE      "CT",CATEGORY
          MOVE      SRCHLTYP,CODE
          CALL      CODITM00
          GOTO      SLST9999
.
SLST2500  MATCH     SP70,SRCHCLTY
          GOTO      SLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHCLTY;
          GOTO      SLST9999 
.
SLST2600  MATCH     SP70,SRCHLTYP
          GOTO      SLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHLTYP;
          GOTO      SLST9999 
.
SLST2700  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MATCH     SP70,SRCHCLTY
          GOTO      SLST2710 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST2710 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST9999 IF EQUAL
.
SLST2710  CALL      CLISTB00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST2800  MOVE      ZERO,KIDSONLY           * Supervisor Suspended App List
          MOVE      ONE,SUPRFLAG
          CALL      SALT0000 
          GOTO      SLST9999
.
SLST2900  MOVE      ONE,KIDSONLY            * Supervisor Suspended App List
          MOVE      ONE,SUPRFLAG
          CALL      SALT0000 
          GOTO      SLST9999
.
SLST3000  CALL      NXTSUS00                * Next Group Suspended Appointments
          GOTO      SLST9999
.
SLST3100  CALL      PRVSUS00                * Prev Group Suspended Appointments
          GOTO      SLST9999
.
SLST3200  MOVE      ZERO,SUPRFLAG           * Supervisor Suspended App List-NZ
          CALL      SLTN0000
          GOTO      SLST9999
.
SLST3300  MOVE      ONE,SUPRFLAG            * Supervisor Suspended App List-NZ
          CALL      SLTN0000
          GOTO      SLST9999
.
SLST3400  MOVE      SRCHVTYP,CODE           * Visit type search
          MOVE      ZERO,VISTFLAG
          CALL      CLOUTHED                * Show all visit types as no 
          CALL      VTYSEL00                * visit is in context
          GOTO      SLST9999
.
SLST3500  WRITE     HTMLFILE;SRCHEMPT;
          GOTO      SLST9999
.
SLST3600  MATCH     SP70,SRCHCLTY
          GOTO      SLST3610 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST3610 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST3610 IF NOT EQUAL
.
          MATCH     SP70,SRCHCIND
          GOTO      SLST3610 IF NOT EQUAL
.           
          WRITE     HTMLFILE;WBSECLI;       * default clinic id
          GOTO      SLST9999
.
SLST3610  WRITE     HTMLFILE;SRCHCLID;
          GOTO      SLST9999
.
SLST3700  MATCH     SP70,SRCHCLTY
          GOTO      SLST3710 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST3710 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST3710 IF NOT EQUAL
.
          MATCH     SP70,SRCHCIND
          GOTO      SLST3710 IF NOT EQUAL
.
          WRITE     HTMLFILE;WBSELTYP;      * default clinic location type
          GOTO      SLST9999
.
SLST3710  WRITE     HTMLFILE;SRCHLTYP;
          GOTO      SLST9999
.
SLST3800  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,SRCHCLTY
          GOTO      SLST3810 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST3810 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST3810 IF NOT EQUAL
.
          MATCH     SP70,SRCHCIND
          GOTO      SLST3810 IF NOT EQUAL
.
          MOVE      WBSECLI,SRCHCLID        * default clinic id
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST3810 IF NOT EQUAL
.      
          MOVE      WBSELTYP,SRCHLTYP       * default clinic location type
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST3810 IF NOT EQUAL
.
          GOTO      SLST9999
.
SLST3810  CALL      CLISTB00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST3900  MOVE      "CI",CATEGORY           * clinic indicator
          MOVE      SRCHCIND,CODE
          CALL      CODITM00
          GOTO      SLST9999
.
SLST4000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,SRCHCLTY
          GOTO      SLST4010 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST4010 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST4010 IF NOT EQUAL
.
          MOVE      WBSECLI,SRCHCLID        * default clinic id
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST9999 IF EQUAL
.
SLST4010  CALL      FREF0000                * Follow up referral letter list
          GOTO      SLST9999
.
SLST4100  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MATCH     SP70,SRCHCLTY
          GOTO      SLST4110 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SLST4110 IF NOT EQUAL
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST9999 IF EQUAL
.
SLST4110  CALL      CLSRCH00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST4200  CALL      NXGR0000
          GOTO      SLST9999
.
SLST4300  CALL      PRGR0000
          GOTO      SLST9999
.
SLST4400  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST4410 IF NOT EQUAL
.
          MOVE      WBSELTYP,SRCHLTYP       * default clinic location type
.
          MATCH     SP70,SRCHLTYP
          GOTO      SLST4410 IF NOT EQUAL
.
          GOTO      SLST9999
.
SLST4410  CALL      CLISTB00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST4500  WRITE     HTMLFILE;DEFTOVRD;
          GOTO      SLST9999
.
SLST4600  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      ALSITE00
          GOTO      SLST9999
.
SLST4700  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     "1",SEARCHFL
          GOTO       SLST9999 IF NOT EQUAL
.
          CALL      CLISTM00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST4800  WRITE     HTMLFILE;SHOWEMPT;
          GOTO      SLST9999
.
SLST4900  WRITE     HTMLFILE;SHOWCPMI;
          GOTO      SLST9999
.
SLST5000  WRITE     HTMLFILE;TABLVIEW;
          GOTO      SLST9999
.
SLST5100  PACK      KEY5,CATTC,SP70
          CALL      RDSCODE1
SLST5150  CALL      RDKCODE1
          BRANCH    OVRCD,SLST9999
.
          MATCH     CATTC,TCODE
          GOTO      SLST9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      SLST5150 IF EQUAL
.
          MATCH     "2",TCINDC3          * indc3=2 --> This is 2nd contact only
          GOTO      SLST5150 IF EQUAL
.
          MATCH     "1",TCINDC1
          GOTO      SLST5150 IF NOT EQUAL
.
          WRITE     HTMLFILE;TDESC;              * NOK contact type description
          GOTO      SLST9999
.
SLST5200  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DEFLTYP,DIM127
          UNPACK    DIM127,D1,DEFCLID,DIM127
.
          MATCH     "1",DEFLTYP
          IF        @EQUAL
            MATCH     SP70,SRCHLTYP        * default location
            IF        @EQUAL
              MOVE      WBSELTYP,SRCHLTYP       * default clinic location type
            ENDIF
          ENDIF
.
          MATCH     "1",DEFCLID
          IF        @EQUAL
            MATCH     SP70,SRCHCLID        * default clinic id
            IF        @EQUAL
              MOVE      WBSECLI,SRCHCLID        * default clinic id
            ENDIF
          ENDIF
.
          CALL      CHCKIN00
          ASSIGN    ZERO,TMPFLG
          GOTO      SLST9999
.
SLST5300  WRITE     HTMLFILE;SRCHREFN;      * Search referral number for
          GOTO      SLST9999                * mandatory referral test
.
SLST5400  MOVE      "CT",CATEGORY           * Clinic Location Type
          MOVE      WBSELTYP,CODE           * Default selection with web user's
          CALL      CODITM00
          GOTO      SLST9999
.
SLST5500  WRITE     HTMLFILE;FILTERCG;      * Filter by Cat CG
          GOTO      SLST9999
.
SLST5600  MATCH     SP70,SRCHCGRP
          GOTO      SLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHCGRP;
          GOTO      SLST9999
.
SLST5700  MOVE      "CV",CATEGORY           * Visit Type Filter
          MOVE      FILTVTYP,CODE           
          CALL      CODITM00
          GOTO      SLST9999
.
SLST5800  WRITE     HTMLFILE;WTCNPACC;      * Default OP Clinic type - PAC
          GOTO      SLST9999
.
SLST5900  MATCH     SP70,SRCHREFN
          GOTO      SLST9999 IF EQUAL
.
          PACK      KEY8,SRCHREFN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,SLST9999
          WRITE     HTMLFILE;ALRERDAT;      * Referral date
          GOTO      SLST9999
.
SLST6000  WRITE     HTMLFILE;SRCHVTYP;               * Visit type search
          GOTO      SLST9999
.
SLST6100  WRITE     HTMLFILE;VIEWOPCL;
          GOTO      SLST9999
.
SLST6200  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
..        MATCH     SP70,SRCHCLTY
..        GOTO      SLST6210 IF NOT EQUAL
.
..        MATCH     SP70,SRCHLTYP
..        GOTO      SLST6210 IF NOT EQUAL
.
..        MATCH     SP70,SRCHCLID
..        GOTO      SLST6210 IF NOT EQUAL
.
..        MATCH     SP70,SRCHCLID
..        GOTO      SLST9999 IF EQUAL
.
SLST6210  CALL      FLST0000                * New Follow up referral letter list
          GOTO      SLST9999
.
SLST6300  IF        SHOWFLAG=0
            MOVE      WBSELTYP,SRCHLTYP       * default users location type
            MOVE      WBSECLI,SRCHCLID        * default users clinic id
            MOVE      ONE,SHOWFLAG
          ENDIF
          WRITE     HTMLFILE;SHOWFLAG;
          GOTO      SLST9999
.
SLST6400  WRITE     HTMLFILE;SRCHCLID;      * default clinic id
          GOTO      SLST9999
.
SLST6500  WRITE     HTMLFILE;SRCHLTYP;      * default location type
          GOTO      SLST9999
.
SLST6600  WRITE     HTMLFILE;WAHSPEED;      * Wahealht load speed view   
          GOTO      SLST9999
.
SLST6700  WRITE     HTMLFILE;MOSAIQRS;
          GOTO      SLST9999
.
SLST6800  CALL      FHRSCH00
          GOTO      SLST9999
.
SLST9999  RETURN
.------------------------------------------------------------
.     Inform GP outpatient bookings
.------------------------------------------------------------
ALSITE00  MOVE      ZERO,SITEDONE           * This site prefix done = No
          PACK      KEY9,SP70
          CALL      RDSSITA3
ALSITE10  CALL      RDKSITA3
          BRANCH    OVRCD,ALSITE95
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEDONE         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEDONE,ALSITE10       * Skip if this site prefix is done
.
          CALL      GPLIS000                * Output outpatient bookings
          MOVE      ONE,SITEDONE            * This site prefix done = yes
.
          GOTO      ALSITE10
.
ALSITE95
.
ALSITE99  RETURN
.
.*******************************************************************************
.                    List outpatient by Date for a GP
.*******************************************************************************
GPLIS000  PACK      KEY16,FRSTDATE,SP70
          CALL      RDSBOKB2
GPLIS100  CALL      RDKBOKB2
          BRANCH    OVRCD,GPLIS999
.
          MATCH     OBADATE,LASTDATE
          GOTO      GPLIS999 IF LESS
.
          PACK      ADMISSNO,DOBAOUTN,SP70
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,GPLIS100
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      GPLIS100 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GPLIS100
.
          MATCH     "1",PMVXINGP
          IF        !@EQUAL
            GOTO      GPLIS100             * only display if informgp=yes
          ENDIF
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,GPLIS100
.
          CALL      CHGP0000             * check GP
          BRANCH    EXIT,GPLIS100
.
 
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1 
          BRANCH    OVRCD,GPLIS100
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GPLIS100
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GPLIS100
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GPLIS100
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,GPLIS100
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,GPLIS100
.
            MATCH     OBASITE,OCASITE
            GOTO      GPLIS100 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      GPLIS100 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
          ENDIF
.
          MOVE      SP70,DIM3
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,DIM3
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC          *To get Visit Type
.
          REP       " +",OBAURNO
          REP       " +",ADMISSNO
          PACK      HTMLLINK,SP70,SP70
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&urnumber=",HTMLLINK
          APPEND    OBAURNO,HTMLLINK
          APPEND    "&admissno=",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          RESET     HTMLLINK
          STRIP     HTMLLINK
          REP       "+ ",OBAURNO
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",OSEDATE,OMASTART,DAYNAM3,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VTYPDESC,"#",": 
                             "#"",OBADATE,OBATIME,"#","; 
.
          BRANCH    OBASTAT,GPLIS110,GPLIS120,GPLIS130,GPLIS140,GPLIS150
          WRITE     HTMLFILE;"#" #",";
          GOTO      GPLIS800
.
GPLIS110  WRITE     HTMLFILE;"#"Booked#",";
          GOTO      GPLIS800
.
GPLIS120  WRITE     HTMLFILE;"#"Not Used#",";
          GOTO      GPLIS800
.
GPLIS130  WRITE     HTMLFILE;"#"Extended#",";
          GOTO      GPLIS800
.
GPLIS140  WRITE     HTMLFILE;"#"Attended#",";
          GOTO      GPLIS800
.
GPLIS150  WRITE     HTMLFILE;"#"DNA#",";
          GOTO      GPLIS800
.
GPLIS800  WRITE     HTMLFILE;"#"",DIM3,"#");"
          GOTO      GPLIS100
.
GPLIS999  RETURN
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,EXIT
         MOVE       SP70,GPCODE
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
CHGP9000 MOVE       ONE,EXIT
.
CHGP9999 RETURN
+
.*******************************************************************************
.                          Next Day, Week, Month
.*******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",CLINICID
          REP       " +",SRCHCLID
          REP       " +",SRCHLTYP
          REP       " +",SRCHVTYP
          REP       " +",SRCHCIND
          REP       " +",SHOWCPMI
          REP       " +",VIEWOPCL
          REP       " +",SRCHREFN
          REP       " +",FILTVTYP
          REP       " +",DEFTOVRD
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"outweb02.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&clinicid=",CLINICID:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&clintype=",CLINTYPE:
                             "&srchclty=",SRCHCLTY:
                             "&srchcgrp=",SRCHCGRP:
                             "&filtercg=",FILTERCG:
                             "&srchclid=",SRCHCLID:
                             "&srchltyp=",SRCHLTYP:
                             "&srchvtyp=",SRCHVTYP:
                             "&srchempt=",SRCHEMPT:
                             "&srchcind=",SRCHCIND:
                             "&showempt=",SHOWEMPT:
                             "&tablview=",TABLVIEW:
                             "&viewopcl=",VIEWOPCL:
                             "&showcpmi=",SHOWCPMI:
                             "&srchrefn=",SRCHREFN:
                             "&filtvtyp=",FILTVTYP:
                             "&deftovrd=",DEFTOVRD:
                             "&showflag=",SHOWFLAG:
                             "&mosaiqrs=",MOSAIQRS;

          REP       "+ ",CLINICID
          REP       "+ ",SRCHCLID
          REP       "+ ",SRCHLTYP
          REP       "+ ",SRCHVTYP
          REP       "+ ",SRCHCIND
          REP       "+ ",SHOWCPMI
          REP       "+ ",VIEWOPCL
          REP       "+ ",SRCHREFN
          REP       "+ ",FILTVTYP
          REP       "+ ",DEFTOVRD
.
NEXT9999  RETURN
.*******************************************************************************
.                          Previous Day, Week, Month
.*******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",CLINICID
          REP       " +",SRCHCLID
          REP       " +",SRCHLTYP
          REP       " +",SRCHVTYP
          REP       " +",SRCHCIND
          REP       " +",SHOWCPMI
          REP       " +",VIEWOPCL
          REP       " +",SRCHREFN
          REP       " +",FILTVTYP
          REP       " +",DEFTOVRD
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"outweb02.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&clinicid=",CLINICID:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&clintype=",CLINTYPE:
                             "&srchclty=",SRCHCLTY:
                             "&srchcgrp=",SRCHCGRP:
                             "&filtercg=",FILTERCG:
                             "&srchclid=",SRCHCLID:
                             "&srchltyp=",SRCHLTYP:
                             "&srchvtyp=",SRCHVTYP:
                             "&srchempt=",SRCHEMPT:
                             "&srchcind=",SRCHCIND:
                             "&showempt=",SHOWEMPT:
                             "&tablview=",TABLVIEW:
                             "&viewopcl=",VIEWOPCL:
                             "&showcpmi=",SHOWCPMI:
                             "&srchrefn=",SRCHREFN:
                             "&filtvtyp=",FILTVTYP:
                             "&deftovrd=",DEFTOVRD:
                             "&showflag=",SHOWFLAG:
                             "&mosaiqrs=",MOSAIQRS;
.
          REP       "+ ",CLINICID
          REP       "+ ",SRCHCLID
          REP       "+ ",SRCHLTYP
          REP       "+ ",SRCHVTYP
          REP       "+ ",SRCHCIND
          REP       "+ ",SHOWCPMI
          REP       "+ ",VIEWOPCL
          REP       "+ ",SRCHREFN
          REP       "+ ",FILTVTYP
          REP       "+ ",DEFTOVRD
.
PREV9999  RETURN
.*******************************************************************************
.                          Next Day, Week, Month
.*******************************************************************************
NXGR0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",CLINICID
          REP       " +",SRCHCLID
          REP       " +",SRCHLTYP
          REP       " +",SRCHVTYP
          REP       " +",VIEWOPCL
          REP       " +",SRCHREFN
          REP       " +",DEFTOVRD
.
          WRITE     HTMLFILE;"outweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&clinicid=",CLINICID:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&clintype=",CLINTYPE:
                                 "&srchclty=",SRCHCLTY:
                                 "&srchcgrp=",SRCHCGRP:
                                 "&srchclid=",SRCHCLID:
                                 "&srchltyp=",SRCHLTYP:
                                 "&srchvtyp=",SRCHVTYP:
                                 "&srchempt=",SRCHEMPT:
                                 "&viewopcl=",VIEWOPCL:
                                 "&srchrefn=",SRCHREFN:
                                 "&deftovrd=",DEFTOVRD:
                                 "&mosaiqrs=",MOSAIQRS;
.
          REP       "+ ",CLINICID
          REP       "+ ",SRCHCLID
          REP       "+ ",SRCHLTYP
          REP       "+ ",SRCHVTYP
          REP       "+ ",VIEWOPCL
          REP       "+ ",SRCHREFN
          REP       "+ ",DEFTOVRD
.
NXGR9999  RETURN
.*******************************************************************************
.                          Previous Day, Week, Month
.*******************************************************************************
PRGR0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",CLINICID
          REP       " +",SRCHCLID
          REP       " +",SRCHLTYP
          REP       " +",SRCHVTYP
          REP       " +",VIEWOPCL
          REP       " +",SRCHREFN
          REP       " +",DEFTOVRD
.
          WRITE     HTMLFILE;"outweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&clinicid=",CLINICID:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&clintype=",CLINTYPE:
                                 "&srchclty=",SRCHCLTY:
                                 "&srchcgrp=",SRCHCGRP:
                                 "&srchclid=",SRCHCLID:
                                 "&srchltyp=",SRCHLTYP:
                                 "&srchvtyp=",SRCHVTYP:
                                 "&srchempt=",SRCHEMPT:
                                 "&viewopcl=",VIEWOPCL:
                                 "&srchrefn=",SRCHREFN:
                                 "&deftovrd=",DEFTOVRD:
                                 "&mosaiqrs=",MOSAIQRS;
.
          REP       "+ ",CLINICID
          REP       "+ ",SRCHCLID
          REP       "+ ",SRCHLTYP
          REP       "+ ",SRCHVTYP
          REP       "+ ",VIEWOPCL
          REP       "+ ",SRCHREFN
          REP       "+ ",DEFTOVRD
.
PRGR9999  RETURN
.*******************************************************************************
.                          Output Session Table
.*******************************************************************************
SESTAB00  UNPACK    LASTDATE,KEY4,CMON,CDAY
          MOVE      CDAY,ENDDAY
          MOVE      CMON,ENDMON
          MOVE      KEY4,ENDYER
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          CALL      MTHEND00
          MOVE      CDAY,CURDAY
          MOVE      FRSTDATE,CURDATE
.
SESTAB10  LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CURDAY,KEY2
          REP       " 0",KEY2
          MATCH     CURDATE,TODAYDAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td bgcolor=#00ffff nowrap width=90>":
                               "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
            GOTO      SESTAB15
          ENDIF
          IF        WEEKDAY=6|WEEKDAY=7
            WRITE     HTMLFILE;"<tr><td bgcolor=##CCCCCC nowrap width=90>":
                               "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
            GOTO      SESTAB15
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap width=90>":
                             "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
.
SESTAB15  MOVE      ZERO,FRSTFLAG
.
          CALL      CHKOUT00     * Get Outpatient Sessions
.
SESTAB30  IF        FRSTFLAG=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>"
          ENDIF
          ADD       ONE,WEEKDAY
          IF        WEEKDAY=8
            MOVE      ONE,WEEKDAY
          ENDIF
          ADD       ONE,CURDAY
          UNPACK    CURDATE,KEY4,CMON,CDAY
          MOVE      CMON,CURMON
          MOVE      KEY4,CURYER
          IF        CURDAY>MTHENDDY
            MOVE      ONE,CURDAY
            ADD       ONE,CURMON
            IF        CURMON>12
              MOVE      ONE,CURMON
              ADD       ONE,CURYER
            ENDIF
          ENDIF
          PACK      CURDATE,CURYER,CURMON,CURDAY
          REP       " 0",CURDATE
.
          MATCH     CURDATE,LASTDATE
          GOTO      SESTAB99 IF LESS
          GOTO      SESTAB10
.
SESTAB99  RETURN
.*******************************************************************************
.                Get Outpatient Sessions for a Day for a Clinic
.*******************************************************************************
CHKOUT00  PACK      KEY25,OCASITE,OCACLIN,CURDATE,SP70
          CALL      RDSSESA1
CHKOUT10  CALL      RDKSESA1
          BRANCH    OVRCD,CHKOUT99
          MATCH     OCASITE,OSESITE
          GOTO      CHKOUT99 IF NOT EQUAL
          MATCH     OCACLIN,OSECLIN
          GOTO      CHKOUT99 IF NOT EQUAL
          MATCH     OSEDATE,CURDATE
          GOTO      CHKOUT99 IF NOT EQUAL
.
          CALL      CHKSUS00
          BRANCH    EXIT,CHKOUT10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CHKOUT10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHKOUT10
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CHKOUT10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CHKOUT10 IF LESS
          ENDIF
.
          BRANCH    OMASTAT,CHKOUT10
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CHKOUT10
.
          IF        FRSTFLAG=0
            MOVE      ONE,FRSTFLAG
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>"
          ENDIF
          MOVE      OMASTART,STRTIM
          MOVE      OMAEND,ENDTIM
          CALL      FMTTIM00
.
          MOVE      OSESLOTS,SESTOTAL
          MOVE      OSESLOTB,SESUSED
          CALL      CALBAR00
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/MaintenanceIcon.gif border=0":
                             " hspace=4 align=absmiddle onclick=":
                             "'location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&sesskeys=",SESSKEYS,"#"'>":
                             STRTIM,SP1,STRAMPM," to ":
                             ENDTIM,SP1,ENDAMPM,"</td>":
                             "<td>",OCTDESC,"</td>":
                             "<td ALIGN=LEFT NOWRAP ":
                             "WIDTH=100 HEIGHT=10 BGCOLOR=##000080>":
                             "<img src=../images/outweb02-3.gif ":
                             FILHIGHT,SP1,FILWIDTH:
                             " ALIGN=ABSBOTTOM>":
                             "</td></tr>"
          GOTO      CHKOUT10
.
CHKOUT99  RETURN
.*******************************************************************************
.                          Format Time
.*******************************************************************************
FMTTIM00  MOVE      "am",STRAMPM
          MOVE      "am",ENDAMPM
          UNPACK    STRTIM,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>12
            MOVE      "pm",STRAMPM
            SUB       "12",F2
            PACK      STRTIM,F2,KEY1,DIMMIN
            REP       " 0",STRTIM
          ENDIF
.
          UNPACK    ENDTIM,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>12
            MOVE      "pm",ENDAMPM
            SUB       "12",F2
            PACK      ENDTIM,F2,KEY1,DIMMIN
            REP       " 0",ENDTIM
          ENDIF
          RETURN
.*******************************************************************************
.                           Calculate Bar for Session
.*******************************************************************************
CALBAR00  MOVE      "8",FILHIGH
          ASSIGN    SESUSED/SESTOTAL*100.0,SESSFILL
          ASSIGN    SESUSED/SESTOTAL*100,F3
          IF        F3>100
            MOVE      "100",F3
          ENDIF
          IF        F3=0
            MOVE      ONE,F3
            MOVE      "1",FILHIGH
          ENDIF
          MOVE      F3,KEY3
          SQUEEZE   KEY3
          CLEAR     FILWIDTH
          APPEND    "WIDTH=",FILWIDTH
          APPEND    KEY3,FILWIDTH
          RESET     FILWIDTH
.
          MOVE      FILHIGH,KEY3
          SQUEEZE   KEY3
          CLEAR     FILHIGHT
          APPEND    "HEIGHT=",FILHIGHT
          APPEND    KEY3,FILHIGHT
          RESET     FILHIGHT
          RETURN
.*******************************************************************************
.                           Clinic Option List
.*******************************************************************************
CTYOPT00  PACK      KEY42,SP70
          CALL      RDSCTYA2
CTYOPT10  CALL      RDKCTYA2
          BRANCH    OVRCD,CTYOPT99
          MATCH     OCTSITE,WBSESIT     * Must be in the Same Site
          GOTO      CTYOPT10 IF NOT EQUAL
          MATCH     "1",OCTACT
          GOTO      CTYOPT10 IF EQUAL
.
          MATCH     SRCHCLTY,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>"
          ENDIF
.
          GOTO      CTYOPT10
.
CTYOPT99  RETURN
.*******************************************************************************
.                           Clinic Option List
.*******************************************************************************
CLIOPT00  PACK      KEY20,WBSESIT,SP70
          CALL      RDSCLIA1
CLIOPT10  CALL      RDKCLIA1
          BRANCH    OVRCD,CLIOPT99
.
          MATCH     OCASITE,WBSESIT     * Must be in the Same Site
          GOTO      CLIOPT99 IF NOT EQUAL
.
          MATCH     "1",OTCLIACT
          GOTO      CLIOPT10 IF EQUAL
.
          MATCH     SP70,OCADESC        * Ignore ID with no Description
          GOTO      CLIOPT20 IF NOT EQUAL
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000 
            MOVE      DOCFNAME,OCADESC
          ELSE
            MOVE      "Invalid Doctor Code",OCADESC
          ENDIF
.
CLIOPT20  MATCH     CLINICID,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected>(":
                               OCACLIN,") ",OCADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#">(":
                               OCACLIN,") ",OCADESC,"</option>"
          ENDIF
          GOTO      CLIOPT10
.
CLIOPT99  PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          RETURN
.                                           *** HPS Code Starts Here ***
.*******************************************************************************
.                         Suspended Appointments List Table 
.*******************************************************************************
SALT0000  MOVE      ZERO,ALLFLAG
          MOVE      SRCHCLTY,SAVECLTY      * Save clinic type for next and prev 
          MOVE      SRCHCLID,SAVECLID      * Save clinid id for next and prev
.
          IF        NORECORD=0
            MOVE      "50",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MATCH     SP70,SRCHCLTY
          GOTO      SALT0900 IF NOT EQUAL
.
          IF        SUPRFLAG = 1
            MOVE      ONE,ALLFLAG           * If Supervisor flag is yes display
          ELSE                              * records for all clinic types else
            GOTO      SALT9999              * exit as srchclty is required
          ENDIF
.
          PACK      KEY12,WBSESIT,SP70
          CALL      RDSCTYA1
SALT0100  CALL      RDKCTYA1
          BRANCH    OVRCD,SALT9999
          MATCH     WBSESIT,OCTSITE
          GOTO      SALT9999 IF NOT EQUAL
          MOVE      OCTCTYP,SRCHCLTY
.
SALT0900  PACK      KEY35,WBSESIT,SRCHCLTY,SIX,FRSTDATE,SP70
          CALL      RDSBOKA2
SALT1000  CALL      RDKBOKA2
          BRANCH    OVRCD,SALT9000
          MATCH     WBSESIT,OBASITE
          GOTO      SALT9000 IF NOT EQUAL
          MATCH     SRCHCLTY,OBACTYP
          GOTO      SALT9000 IF NOT EQUAL
          COMPARE   SIX,OBASTAT
          GOTO      SALT9000 IF NOT EQUAL
          MATCH     OBADATE,LASTDATE
          GOTO      SALT9000 IF LESS
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      SALT1000 IF EQUAL
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OBACLIN,SRCHCLID
            GOTO      SALT1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      SALT1500
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          BRANCH    OVRCD,SALT1000
.
          MATCH     OBASITE,OCASITE
          GOTO      SALT1000 IF NOT EQUAL 
.
          MATCH     OBACLIN,OCACLIN
          GOTO      SALT1000 IF NOT EQUAL 
.
SALT1500  PACK      SKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SALT1000
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     SKEY28,KEY28
          GOTO      SALT2000 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SALT1000
          ENDIF
.
          CALL      SLINE000                * Output Row in Table
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SALT1000 IF NOT EQUAL
.
          GOTO      SALT9999
.
SALT2000  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SALT1000
          ENDIF
.  
          IF        KIDSONLY = 1
            WRITE     HTMLFILE;"<tr><td>Invalid ":
                               OBAOUTNO,"</td>":
                               "<td>",SKEY28,"&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=center>&nbsp;</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>Invalid ":
                               OBAOUTNO,"</td>":
                               "<td>",SKEY28,"&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=center>&nbsp;</td></tr>"
          ENDIF
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SALT1000 IF NOT EQUAL
.
          GOTO      SALT1000
.             
SALT9000  BRANCH    ALLFLAG,SALT0100
.
SALT9999  RETURN 
.------------------------------------------------------------
. Output Suspended Patient Row
.------------------------------------------------------------
SLINE000  MOVE      ZERO,OVERBOOK
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC          *To get Visit Type
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Yes it is an over booking
          ENDIF
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000            SP3        *To get Patient Name
.
          CALL      CHKS0000                * Check if this is a series booking
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      ZERO,MOSAIQVS
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE         * MOSAIQ Visit
            IF        @EQUAL
              MOVE      ONE,MOSAIQVS        * Yes this is a MOSAIQ visit
            ENDIF
          ENDIF
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          IF        KIDSONLY = 1
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr bgcolor=magenta><td>";
            ELSE
              IF        BOOKSERS=1
                WRITE     HTMLFILE;"<tr bgcolor=green><td>";
              ELSE
                WRITE     HTMLFILE;"<tr><td>";
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif class=Icon ":
                               "onclick=#"getNextAvailable('",KEY28,"');#">":
                               SP1,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1:
                               CCENT,CYEAR," ",OBATIME,"</td>":
                               "<td>",OCADESC,"&nbsp;</td>":
                               "<td>",VTYPDESC,"&nbsp;</td>":
                               "<td>",FORMATNM,"&nbsp;</td>":
                               "<td>",OBAURNO,"&nbsp;</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td align=center>";
            IF         OVERBOOK=0 & MOSAIQVS <> 1
              WRITE      HTMLFILE;"<input type=checkbox name=markkeys value='":
                                  KEY28,"' checked>";
            ENDIF
            WRITE      HTMLFILE;"&nbsp;</td></tr>"
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr bgcolor=magenta><td>";
            ELSE
              IF        BOOKSERS=1
                WRITE     HTMLFILE;"<tr bgcolor=green><td>";
              ELSE
                WRITE     HTMLFILE;"<tr><td>";
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif class=Icon ":
                               "onclick=#"getNextAvailable('",KEY28,"');#">":
                               SP1,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1:
                               CCENT,CYEAR," ",OBATIME,"</td>":
                               "<td>",OCADESC,"&nbsp;</td>":
                               "<td>",VTYPDESC,"&nbsp;</td>":
                               "<td>",FORMATNM,"&nbsp;</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td align=center>";
            IF        OVERBOOK=0 & MOSAIQVS <> 1
              WRITE     HTMLFILE;"<input type=checkbox name=markkeys value='":
                                  KEY28,"' checked>";
            ENDIF
            WRITE       HTMLFILE;"&nbsp;</td></tr>"
          ENDIF
.
SLINE999  RETURN
.*******************************************************************************
.                    Suspended Appointments List Table - NZ
.*******************************************************************************
SLTN0000  MOVE      ZERO,ALLFLAG
          MOVE      SRCHCLTY,SAVECLTY      * Save clinic type for next and prev
          MOVE      SRCHCLID,SAVECLID      * Save clinid id for next and prev
.
          IF        NORECORD=0
            MOVE      "50",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MATCH     SP70,SRCHCLTY
          GOTO      SLTN0900 IF NOT EQUAL
.
          IF        SUPRFLAG = 1
            MOVE      ONE,ALLFLAG           * If Supervisor flag is yes display
          ELSE                              * records for all clinic types else
            GOTO      SLTN9999              * exit as srchclty is required
          ENDIF
.
          PACK      KEY12,WBSESIT,SP70
          CALL      RDSCTYA1
SLTN0100  CALL      RDKCTYA1
          BRANCH    OVRCD,SLTN9999
          MATCH     WBSESIT,OCTSITE
          GOTO      SLTN9999 IF NOT EQUAL
          MOVE      OCTCTYP,SRCHCLTY
.
SLTN0900  PACK      KEY35,WBSESIT,SRCHCLTY,SIX,SP70
          CALL      RDSBOKA2
SLTN1000  CALL      RDKBOKA2
          BRANCH    OVRCD,SLTN9000
          MATCH     WBSESIT,OBASITE
          GOTO      SLTN9000 IF NOT EQUAL
          MATCH     SRCHCLTY,OBACTYP
          GOTO      SLTN9000 IF NOT EQUAL
          COMPARE   SIX,OBASTAT
          GOTO      SLTN9000 IF NOT EQUAL
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      SLTN1000 IF EQUAL
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OBACLIN,SRCHCLID
            GOTO      SLTN1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      SLTN1500
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          BRANCH    OVRCD,SLTN1000
.
          MATCH     OBASITE,OCASITE
          GOTO      SLTN1000 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      SLTN1000 IF NOT EQUAL
.
SLTN1500  PACK      SKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SLTN1000
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     SKEY28,KEY28
          GOTO      SLTN2000 IF NOT EQUAL
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SLTN1000

          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SLTN1000
          ENDIF
.
          CALL      SLNEN000                * Output Row in Table
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SLTN1000 IF NOT EQUAL
.
          GOTO      SLTN9999
.
SLTN2000  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SLTN1000
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>Invalid ":
                             OBAOUTNO,"</td>":
                             "<td>",SKEY28,"&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=center>&nbsp;</td></tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SLTN1000 IF NOT EQUAL
.
          GOTO      SLTN1000
.
SLTN9000  BRANCH    ALLFLAG,SLTN0100
.
SLTN9999  RETURN
.------------------------------------------------------------
. Output Suspended Patient Row - NZ
.------------------------------------------------------------
SLNEN000  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC          *To get Visit Type
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000            SP3        *To get Patient Name
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,PRTYDESC
          MOVE      "PR",CATEGORY
          MOVE      OBAPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRTYDESC
.
          MOVE      ZERO,OPRSUNIQ
          PACK      KEY11,OBAOUTNO,Z70
          CALL      RDSRSHA1
          CALL      RDPRSHA1
          IF        OVRCD <> 1
            MATCH     OBAOUTNO,OPRSOUTN
            IF        !@EQUAL
              MOVE      ZERO,OPRSUNIQ
            ENDIF
          ENDIF
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MoveIcon.gif class=Icon ":
                             "onclick=#"getNextAvailable('",KEY28,"');#">":
                             SP1,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1:
                             CCENT,CYEAR," ",OBATIME,"</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",VTYPDESC,"&nbsp;</td>":
                             "<td>",FORMATNM,"&nbsp;</td>":
                             "<td>",PTELEP,"&nbsp;</td>";
.
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"<td>",PRTYDESC,"&nbsp;</td>":
                                 "<td>",OPRSUNIQ,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",SARRDESC,"&nbsp;</td>":
                             "<td align=center>":
                             "<input type=checkbox name=markkeys value='":
                             KEY28,"' checked></td></tr>"
.
SLNEN999  RETURN
.*******************************************************************************
.                             Case List 
.*******************************************************************************
CASLST00  CALL      SESDET00          * Get Session Details
          BRANCH    EXIT,CASLST95
.
          IF        FHIRTYPE=ONE
.
            MATCH     SP70,CASEKEYS
            IF        !@EQUAL & !@EOS
              PACK      KEY28,CASEKEYS,SP70
              CALL      RDBOKA1
              BRANCH    OVRCD,CASLST94
            ENDIF
          ENDIF
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDUSEA1
          IF        OVRCD=1
            CALL      CLUS0000        * Clear usage file vars
          ENDIF
.
          MOVE      OSECLIN,CLINICID  * Setup Clinic ID
          MOVE      OSESITE,SITECODE  * Site Code
          CALL      GETMAP00          * Get Template Mapping
.
          MATCH     "010",TEMPLATE
          IF        @EQUAL
            CALL      USAG0000        * Get default session usage details
          ENDIF
.
          CALL      CASTIT00          * Setup Case List Title
.
          CALL      WEBHED00
          BRANCH    EXIT,CASLST99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      CASLST99
.
CASLST94  MOVE      "CASE KEY INVALID",WEBTITLE
          CALL      WEBERR00
.
CASLST95  MOVE      "SESSION KEY INVALID",WEBTITLE
          CALL      WEBERR00
.
CASLST99  RETURN
.*******************************************************************************
. Get the default session actual start/end times according to the check in
. and departure times of patients
.*******************************************************************************
USAG0000  MOVE      SP70,DEFTSTRT
          MOVE      SP70,DEFTENDT
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDUSEA1
          BRANCH    OVRCD,USAG1000
.
          MATCH     SP70,OUSACST            * Calculate the defaults
          GOTO      USAG1000 IF EQUAL
.
          MATCH     SP70,OUSACEND           * Calculate the defaults
          GOTO      USAG1000 IF EQUAL
.
          GOTO      USAG9999
.
USAG1000  PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
USAG1200  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,USAG9999          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      USAG9999 IF NOT EQUAL   * different session
.
          COMPARE   FOUR,OBASTAT            * Attended only
          GOTO      USAG1200 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,USAG1200
.
          MATCH     SP70,OTBBCITM           * Is there a check in time
          GOTO      USAG1200 IF EQUAL
.
          MATCH     SP70,DEFTSTRT
          IF        @EQUAL
            MOVE      OTBBCITM,DEFTSTRT     * Default start time
          ELSE
            MATCH     DEFTSTRT,OTBBCITM     * Is this check in time earlier
            IF        @LESS
              MOVE      OTBBCITM,DEFTSTRT
            ENDIF
          ENDIF
.
          MATCH     SP70,OTBBDPTM           * Is there a departure time
          GOTO      USAG1200 IF EQUAL
.
          MATCH     SP70,DEFTENDT
          IF        @EQUAL
            MOVE      OTBBDPTM,DEFTENDT     * Default end time
          ELSE
            MATCH     OTBBDPTM,DEFTENDT
            IF        @LESS
              MOVE      OTBBDPTM,DEFTENDT   * Is this departure time later
            ENDIF
          ENDIF
.
          GOTO      USAG1200
.
USAG9999  RETURN
.*******************************************************************************
.                           Clinic Table
.*******************************************************************************
CLST0000  BRANCH    FLDITMNO,CLST0100,CLST0200,CLST0300,CLST0400:
                             CLST0500,CLST0600,CLST0700,CLST0800:
                             CLST0900,CLST1000,CLST1100,CLST1200:
                             CLST1300,CLST1400,CLST1500:
.                                           *** HPS Code Starts Here ***
                             CLST1600,CLST1700,CLST1800,CLST1900:
                             CLST2000,CLST2100,CLST2200,CLST2300:
                             CLST2400,CLST2500,CLST2600,CLST2700:
                             CLST2800,CLST2900,CLST3000,CLST3100:
                             CLST3200,CLST3300:
.                                           *** HPS Code Ends Here ***
                             CLST3400,CLST3500,CLST3600,CLST3700:      * I-47446
                             CLST3800,CLST3900,CLST4000,CLST4100:
                             CLST4200,CLST4300,CLST4400,CLST4500:
                             CLST4600,CLST4700,CLST4800,CLST4900:
                             CLST5000,CLST5100,CLST5200,CLST5300:
                             CLST5400,CLST5500,CLST5600,CLST5700:
                             CLST5800,CLST5900,CLST6000,CLST6100:
                             CLST6200,CLST6300,CLST6400,CLST6500:
                             CLST6600,CLST6700,CLST6800,CLST6900:
                             CLST7000,CLST7100,CLST7200,CLST7300
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      CLST9999
.
CLST0100  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSSESA1
CLST0110  CALL      RDKSESA1
          BRANCH    OVRCD,CLST9999
          CALL      CHKSUS00
          BRANCH    EXIT,CLST0110
          PACK      KEY12,OSESITE,OSECLIN
          MATCH     KEY12,SESSKEYS      
          IF        @EQUAL                  
            PACK      KEY25,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          ENDIF
          CALL      CLILNK00
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          GOTO      CLST9999
.
CLST0200  PACK      KEY25,SESSKEYS
          CALL      RDSSESA1
CLST0210  CALL      RDPSESA1
          BRANCH    OVRCD,CLST9999
          CALL      CHKSUS00
          BRANCH    EXIT,CLST0210
          PACK      KEY12,OSESITE,OSECLIN
          MATCH     KEY12,SESSKEYS       
          IF        @EQUAL                  
            PACK      KEY25,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          ENDIF                           
          CALL      CLILNK00
          PACK      KEY25,SESSKEYS
          CALL      RDSESA1
          GOTO      CLST9999
.
CLST0300  CALL      SESOPT00
          GOTO      CLST9999
.
CLST0400  WRITE     HTMLFILE;SESSKEYS;
          GOTO      CLST9999
.
CLST0500  MOVE      ZERO,ATTDFLAG
          MOVE      ZERO,FULLONLY
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST0600  WRITE     HTMLFILE;DOCFNAME;
          GOTO      CLST9999
.
CLST0700  MOVE      ONE,ATTDFLAG
          MOVE      ZERO,FULLONLY
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST0800  MOVE      TWO,ATTDFLAG
          MOVE      ZERO,FULLONLY
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST0900  MOVE      ZERO,FULLONLY
          CALL      CASSTB00
          GOTO      CLST9999
.
CLST1000  CALL      CASMTC00
          GOTO      CLST9999
.
CLST1100  MOVE      SP70,CODE
          MOVE      ZERO,VISTFLAG
          CALL      VTYSEL00
          GOTO      CLST9999
.
CLST1200  MOVE      ONE,FULLONLY
          CALL      CASSTB00
          GOTO      CLST9999
.
CLST1300  MOVE      ZERO,ATTDFLAG
          MOVE      ONE,FULLONLY
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST1400  WRITE     HTMLFILE;OCADESC;
          GOTO      CLST9999
.
CLST1500  UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYNAM3,"  ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               " at ",OSESTRT;
          GOTO      CLST9999
.
CLST1600  WRITE     HTMLFILE;OMAFIN;
          GOTO      CLST9999
.
CLST1700  WRITE     HTMLFILE;OMAEND;
          GOTO      CLST9999
.
CLST1800  MATCH     SP70,OTMAPROV
          GOTO      CLST9999 IF EQUAL
.
          WRITE     HTMLFILE;OTMAPROV;
          GOTO      CLST9999
.
CLST1900  GOTO      CLST9999
.
CLST2000  MOVE      "CS",CATEGORY
          MOVE      OSESCSTT,CODE
          CALL      CODITM00
          GOTO      CLST9999
.
CLST2100  WRITE     HTMLFILE;OSESCOMM;
          GOTO      CLST9999
.*******************************************************************************
.                        Write System Wide Comments
.*******************************************************************************
CLST2200  UNPACK    SESSKEYS,SITEID,CLINCID,SESSDATE,SESSTIME
.
          PACK      KEY19,SP70
          CALL      RSPCMNA1
CLST2210  CALL      RKPCMNA1
          BRANCH    OVRCD,CLST9999
.
          MATCH     SP6,OTCMSITE            * all sites
          GOTO      CLST2220 IF EQUAL
.
          MATCH     OTCMSITE,SITEID
          GOTO      CLST2210 IF NOT EQUAL
.
CLST2220  MATCH     SP6,OTCMCLIN            * all clinic types
          GOTO      CLST2230 IF EQUAL 
.
          MATCH     OTCMCLIN,OSESCTYP
          GOTO      CLST2210 IF NOT EQUAL
.
CLST2230  MATCH     SESSDATE,OTCMTDAT
          GOTO      CLST2210 IF LESS 
.
          MATCH     OTCMFDAT,SESSDATE
          GOTO      CLST2210 IF LESS
.
          MATCH     SP70,OTCMCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;OTCMCOM1,"<br>",OTCMCOM2,"<br>",OTCMCOM3,"<br>":
                             OTCMCOM4,"<br>";
          ELSE
            MATCH     SP70,OTCMCOM3
            IF        !@EQUAL
              WRITE     HTMLFILE;OTCMCOM1,"<br>",OTCMCOM2,"<br>":
                              OTCMCOM3,"<br>";
            ELSE
              MATCH     SP70,OTCMCOM2
              IF        !@EQUAL
                WRITE     HTMLFILE;OTCMCOM1,"<br>",OTCMCOM2,"<br>";
              ELSE
                WRITE     HTMLFILE;OTCMCOM1,"<br>";
              ENDIF
            ENDIF
          ENDIF
          GOTO      CLST2210
.*******************************************************************************
.                    Output Maintenance Case List Table
.*******************************************************************************
CLST2300  CALL      CASMTC00
          GOTO      CLST9999
.
CLST2400  MOVE      "RR",CATEGORY
          MOVE      OBARSCHD,CODE
          CALL      CODITM00           
          GOTO      CLST9999 
.
CLST2500  WRITE     HTMLFILE;OTMACLOC        
          GOTO      CLST9999 
.
CLST2600  MATCH     SP70,OTHECOM1 
          IF        @EQUAL
            MATCH     SP70,OTHECOM2         * No template comments so display
            GOTO      CLST2650 IF EQUAL     * comments from the clinic master
          ENDIF
. 
          MATCH     SP70,OTHECOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;OTHECOM1,"<br>",OTHECOM2;
          ELSE
            WRITE     HTMLFILE;OTHECOM1;
          ENDIF
          GOTO      CLST9999
.
CLST2650  MATCH     SP70,OMACOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;OMACOM1,"<br>",OMACOM2;
          ELSE
            WRITE     HTMLFILE;OMACOM1;
          ENDIF
          GOTO      CLST9999
.
CLST2700  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GETCTY99
          UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ANS,F1
          BRANCH    F1,CLST2720
.                                                                              
CLST2710  WRITE     HTMLFILE;OCTDESC;  
          GOTO      CLST9999
.
CLST2720  WRITE     HTMLFILE;OCTCTYP;                                          
          GOTO      CLST9999
.
CLST2800  MATCH     SP70,OTHEINS1
          IF        @EQUAL
            MATCH     SP70,OTHEINS2
            IF        @EQUAL
              MATCH     SP70,OTHEINS3       * No tempate instructoins so display
              GOTO      CLST2850 IF EQUAL   * them from the clinic master
            ENDIF
          ENDIF  
.
          MATCH     SP70,OTHEINS3
          IF        !@EQUAL
            WRITE     HTMLFILE;OTHEINS1,"<br>",OTHEINS2,"<br>",OTHEINS3;
          ELSE
            MATCH SP70,OTHEINS2
            IF        !@EQUAL
              WRITE     HTMLFILE;OTHEINS1,"<br>",OTHEINS2;
            ELSE
              WRITE     HTMLFILE;OTHEINS1
            ENDIF
          ENDIF
          GOTO      CLST9999
.
CLST2850  MATCH     SP70,OTMAINS3
          IF        !@EQUAL
            WRITE     HTMLFILE;OTMAINS1,"<br>",OTMAINS2,"<br>",OTMAINS3;
          ELSE
            MATCH SP70,OTMAINS2
            IF        !@EQUAL
              WRITE     HTMLFILE;OTMAINS1,"<br>",OTMAINS2;
            ELSE
              WRITE     HTMLFILE;OTMAINS1
            ENDIF
          ENDIF
          GOTO      CLST9999
.
CLST2900  MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      CODITM00
          GOTO      CLST9999          
.
CLST3000  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1
          GOTO      CLST9999          
.
CLST3100  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      CODITM00
          GOTO      CLST9999          
.                                           *** HPS Code Ends Here ***
CLST3200  MOVE      TWO,ATTDFLAG
          MOVE      ZERO,FULLONLY
          CALL      SCSTAB00                 * Same as CASTAB00 for search
          GOTO      CLST9999
.
CLST3300  MOVE      SP70,CODE
          MOVE      ONE,VISTFLAG
          CALL      VTYSEL00
          GOTO      CLST9999
.
CLST3400  MOVE      SP70,CODE                * Tag for add slot template
          MOVE      TWO,VISTFLAG
          CALL      VTYSEL00
          GOTO      CLST9999
.
CLST3500  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CLST9999
          UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ANS,F1
          BRANCH    F1,CLST3520
.
CLST3510  WRITE     HTMLFILE;OCTDESC;
          GOTO      CLST9999
.
CLST3520  WRITE     HTMLFILE;OCTCTYP;
          GOTO      CLST9999
.
CLST3600  MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      CODITM00
          GOTO      CLST9999          
.
CLST3700  CALL      PRGPLB00                * Print Group Labels List Table
          GOTO      CLST9999                * I-47446
.
CLST3800  WRITE     HTMLFILE;OUSACST;
          GOTO      CLST9999
.
CLST3900  WRITE     HTMLFILE;OUSACEND;
          GOTO      CLST9999
.
CLST4000  MOVE      "CD",CATEGORY
          MOVE      OUSDLY,CODE
          CALL      CODITM00
          GOTO      CLST9999
.
CLST4100  WRITE     HTMLFILE;DEFTSTRT;
          GOTO      CLST9999
.
CLST4200  WRITE     HTMLFILE;DEFTENDT;
          GOTO      CLST9999
.
CLST4300  WRITE     HTMLFILE;OTMAROOM;
          GOTO      CLST9999
.
CLST4400  WRITE     HTMLFILE;TABLVIEW;
          GOTO      CLST9999
.
CLST4500  MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      CODITM00
          GOTO      CLST9999
.
CLST4600  CALL      ATTLST00                * List patients to attend 
          GOTO      CLST9999
.
CLST4700  CALL      DEPLST00                * List patients to depart 
          GOTO      CLST9999
.
CLST4800  CALL      FOLLST00                * List patients to re-appoint
          GOTO      CLST9999
.
CLST4900  CALL      CONLST00                * List patients to confirm
          GOTO      CLST9999
.
CLST5000  WRITE     HTMLFILE;OTHEADEP;      * Allied Health Department
          GOTO      CLST9999
.
CLST5100  WRITE     HTMLFILE;OTHECENC;      * Collect Encounter Details
          GOTO      CLST9999
.
CLST5200  MOVE      ONE,ATTDONLY            * Allow bulk enc to attended only
          CALL      ENCLST00                * List patients to add Encounters
          GOTO      CLST9999
.
CLST5300  WRITE     HTMLFILE;OTHEDURN;      * Slot duration
          GOTO      CLST9999
.
CLST5400  WRITE     HTMLFILE;OCADOCT;       * Clinic doctor code
          GOTO      CLST9999
.
CLST5500  MOVE      ZERO,ATTDONLY           * Allow bulk enc to attended/booked
          CALL      ENCLST00                * List patients to add Encounters
          GOTO      CLST9999
.
CLST5600  CALL      DISLST00                * List patients to discharge
          GOTO      CLST9999
.
CLST5700  WRITE     HTMLFILE;CONTVIEW;      * Contact view flag
          GOTO      CLST9999
.
CLST5800  WRITE     HTMLFILE;OTHECPMI;      * Using confirm PMI
          GOTO      CLST9999
.
CLST5900  WRITE     HTMLFILE;OTHECPAG;      * Using check in page 
          GOTO      CLST9999
.
CLST6000  WRITE     HTMLFILE;OTHEMREF;      * Referral Mandatory 
          GOTO      CLST9999
.
CLST6100  WRITE     HTMLFILE;SRCHREFN;      * Search referral number for
          GOTO      CLST9999                * mandatory referral test
.
CLST6200  WRITE     HTMLFILE;DNASONLY;      * Encounters on DNA patients 
          GOTO      CLST9999                * only
.
CLST6300  MATCH     SP70,OSEDATE
          GOTO      CLST9999 IF EQUAL
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CLST9999
.
CLST6400  WRITE     HTMLFILE;OSECLIN;
          GOTO      CLST9999
.
CLST6500  WRITE     HTMLFILE;OSESCTYP;
          GOTO      CLST9999
.
CLST6600  WRITE     HTMLFILE;OTMACENC;
          GOTO      CLST9999
.
CLST6700  WRITE     HTMLFILE;OTMAADEP;
          GOTO      CLST9999
.
CLST6800  WRITE     HTMLFILE;OCADOCT;
          GOTO      CLST9999
.
CLST6900  MATCH     SP70,SRCHREFN
          GOTO      CLST9999 IF EQUAL
.
          PACK      KEY8,SRCHREFN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CLST9999
          WRITE     HTMLFILE;ALRERDAT;      * Referral date
          GOTO      CLST9999
.
CLST7000  WRITE     HTMLFILE;VIEWOPCL;
          GOTO      CLST9999
.
CLST7100  CALL      TDYSES00
          WRITE     HTMLFILE;SESSKEYT;         
          GOTO      CLST9999
.
CLST7200  CALL      TDYSES00
          PACK      KEY25,SESSKEYT,SP70
          CALL      CLILNK00
          GOTO      CLST9999
.
CLST7300  CALL      RESSLO00
          GOTO      CLST9999
.
CLST9999  RETURN
.*******************************************************************************
.                             Clinic Link
.*******************************************************************************
CLILNK00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
         
          REP       " +",KEY25
          REP       " +",TABLVIEW
          REP       " +",SRCHREFN
          REP       " +",WACPMICH
.
          WRITE     HTMLFILE;"outweb02.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&sesskeys=",KEY25:
                             "&redirflg=",REDIRFLG:
                             "&tablview=",TABLVIEW:
                             "&viewopcl=",VIEWOPCL:
                             "&contview=",CONTVIEW:
                             "&srchrefn=",SRCHREFN:
                             "&dnasonly=",DNASONLY:
                             "&wacpmich=",WACPMICH:
                             "&mosaiqrs=",MOSAIQRS;
.
          REP       "+ ",KEY25
          REP       "+ ",TABLVIEW
          REP       "+ ",SRCHREFN
          REP       "+ ",WACPMICH
.
          RETURN
.*******************************************************************************
.                         Sessions Options
.*******************************************************************************
SESOPT00  MOVE      ZERO,SELOPTCT
          PACK      KEY25,SESSKEYS
          CALL      RDSSESA1
SESOPT10  CALL      RDPSESA1
          BRANCH    OVRCD,SESOPT20
          PACK      KEY12,OSESITE,OSECLIN
          MATCH     KEY12,SESSKEYS
          GOTO      SESOPT20 IF NOT EQUAL
.
          ADD       ONE,SELOPTCT
          IF        SELOPTCT<10
            GOTO      SESOPT10
          ENDIF
.
SESOPT20  MOVE      ZERO,SELOPTCT
.
SESOPT30  CALL      RDKSESA1
          BRANCH    OVRCD,SESOPT99
          PACK      KEY12,OSESITE,OSECLIN
          MATCH     KEY12,SESSKEYS
          GOTO      SESOPT99 IF NOT EQUAL
          ADD       ONE,SELOPTCT
          IF        SELOPTCT>25
            GOTO      SESOPT99
          ENDIF
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CALL      CHKSUS00
          BRANCH    EXIT,SESOPT30
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          MATCH     SESSKEYS,KEY28
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",KEY28,"#" selected>":
                               DAYNAM3,"  ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               " at ",OSESTRT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",KEY28,"#" >":
                               DAYNAM3,"  ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               " at ",OSESTRT,"</option>"
          ENDIF
          GOTO      SESOPT30
.
SESOPT99  PACK      KEY25,SESSKEYS
          CALL      RDSESA1
          RETURN
.
.*******************************************************************************
. Get the first session of today date
.*******************************************************************************
TDYSES00  MOVE      SP70,SESSKEYT
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      SESSKEYS,KEY12
          PACK      KEY25,KEY12,KEY8,SP70
.
          CALL      RDSSESA1
TDYSES10  CALL      RDKSESA1
          BRANCH    OVRCD,TDYSES99
.
          PACK      KEY12,OSESITE,OSECLIN
          MATCH     KEY12,SESSKEYS
          GOTO      TDYSES99 IF NOT EQUAL
.
          MATCH     KEY8,OSEDATE
          GOTO      TDYSES99 IF NOT EQUAL
.
          PACK      SESSKEYT,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
.
TDYSES99  RETURN
.
.*******************************************************************************
.                            Case List Title
.*******************************************************************************
CASTIT00  UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CLEAR     WEBTITLE
          APPEND    "Clinic List for ",WEBTITLE
          UNPACK    OMASTART,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>12
            SUB       "12",F2
            APPEND    F2,WEBTITLE
            APPEND    KEY1,WEBTITLE
            APPEND    DIMMIN,WEBTITLE
            APPEND    " pm",WEBTITLE
          ELSE
            APPEND    F2,WEBTITLE
            APPEND    KEY1,WEBTITLE
            APPEND    DIMMIN,WEBTITLE
            APPEND    " am",WEBTITLE
          ENDIF
          APPEND    SP1,WEBTITLE
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          RETURN
.*******************************************************************************
.                        Output Case List Table
.*******************************************************************************
CASTAB00  MOVE      SP70,LINKPRG
          UNPACK    DIM127,D1,LINKPRG,DIM127 
          PACK      LINKPRG,LINKPRG,SP70
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CASTAB10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CASTAB99          * end of session
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CASTAB99 IF NOT EQUAL   * different sessio
.
          COMPARE   SEVEN,OBASTAT
          GOTO      CASTAB10 IF EQUAL
          COMPARE   SIX,OBASTAT
          GOTO      CASTAB10 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      CASTAB10 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      CASTAB10 IF EQUAL
          MATCH     ZEROVISN,OBAOUTNO
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CASTAB10 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
.
          COMPARE   TWO,ATTDFLAG
          GOTO      CASTAB20 IF NOT EQUAL
          COMPARE   ZERO,OBASTAT
          GOTO      CASTAB10 IF NOT EQUAL

CASTAB20  IF        FULLONLY=1
            COMPARE   ZERO,OBASTAT
            GOTO      CASTAB10 IF EQUAL
          ENDIF
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        MOSAIQCL=1
              WRITE     HTMLFILE;"<tr class='MosaiqClinic'>";
            ELSE
              WRITE     HTMLFILE;"<tr>";
            ENDIF
.
            WRITE     HTMLFILE;"<td align=center width=60 nowrap>";
            GOTO      CASTAB30
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td align=center width=60 nowrap>";
.
CASTAB30  UNPACK    OBATIME,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2         * check if midday
          IF        F2>=12
            IF        F2=12
              WRITE     HTMLFILE;F2,KEY1,DIMMIN," pm</td>";
            ELSE
              SUB       "12",F2
              WRITE     HTMLFILE;F2,KEY1,DIMMIN," pm</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;F2,KEY1,DIMMIN," am</td>";
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            CALL      EMPTYS00
            GOTO      CASTAB10
          ENDIF
          COMPARE   TWO,ATTDFLAG
          GOTO      CASTAB10 IF EQUAL
.
          CALL      FULLS000
          GOTO      CASTAB10
.
CASTAB99  RETURN
.*******************************************************************************
.                            Show Empty Slot
.*******************************************************************************
EMPTYS00  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MOVE      TCINDC1,CLININDC
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic     
          ELSE
            MOVE      ZERO,MOSAIQCL      
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
.....  I CAR 52822  - "'" causing problem in table view display
          MOVE      OCADESC,JAVSNAME
          CALL      JAVDES00
.....
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>":
                             "<td>";
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,SRCHREFN         * Check if referral populated when
            GOTO      EMPTYS50 IF EQUAL     * referral is mandatory 
          ENDIF
.
          BRANCH    MOSAIQCL,EMPTYS50       * MOSAIQ Clinic
.
          WRITE     HTMLFILE;"<a href='javascript:updateParent(#"":
                             CASEKEYS,"#",#"":
                             JAVSNAME,"#",#"":
                            DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ":
                             OBATIME,"#",#"":
                             OBAVISIT,"#",#"":
                             OCTCTYP,"#",#"":
                             OCTDESC,"#",#"":
                             CLININDC,"#",#"":
                             CLNIDESC,"#",#"":
                             OTMAUMCI,"#",#"":
                             OTHECCAR,"#",#"":
                             OTHENDPS,"#",#"":
                             OTHENMDS,"#",#"":
                             OTHECART,"#",#"":
                             OTHESRVD,"#",#"":
                             OTHECLHR,"#",#"":
                             TCINDC2,"#",#"":
                             OTHETCOD,"#",#"":
                             OTHEMREF,"#",#"":
                             OTMATCOD,"#",#"": 
                             OTHEPCOD,"#");'>":  
                             "<img src=../images/AppointmentIcon.gif border=0>":
                             "</a>";
.
EMPTYS50  WRITE     HTMLFILE;"&nbsp;</td><td>&nbsp;</td></tr>"
.
EMPTYS99 RETURN
.------------------------------------------------------------
. Format Description/Name (for Javascript)
.*** format the surname and given name by changing any ' to %60
.---------------------------------------------------------------
.JAVDES00  SCAN      "'",JAVSNAME             * find any apostrophies
.          GOTO      JAVDES99 IF NOT EQUAL
..
.          MOVE      JAVSNAME,ENDNAME
.          REP       "' ",ENDNAME             * remove the apostrophy
..
.          LENSET    JAVSNAME
.          RESET     JAVSNAME                 * get all characters before '
.          MOVE      JAVSNAME,STRTNAME
..
.          REP       "'%",STRTNAME
.          STRIP     STRTNAME
.          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted string
..
.JAVDES99  RETURN
.*******************************************************************************
.                              Full Slot
.*******************************************************************************
FULLS000  CALL      CASDET00
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
          MOVE      DISPSEX,ANS
          CALL      PATFLD00
          MATCH     SP70,LINKPRG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap>":
                      "<img src=../images/PatientFolder",KEY3,".gif":
                      " class=Icon>";
          ELSE
             WRITE     HTMLFILE;"<td nowrap>":
                       "<a href=#"",LINKPRG,".pbl?reportno=",LINKREP:
                       "&template=",LINKTEM:
                       "&casekeys=",CASEKEYS,"#">":
                       "<img src=../images/PatientFolder",KEY3,".gif":
                       " class=Icon></a>";
          ENDIF
          IF        !(ATTDFLAG=1)
.            WRITE     HTMLFILE;"<img src=../images/ResultIcon.gif class=Icon ":
.                               "onclick='ResultLink(#"",PURNO,"#",":
.                               "#"",OBAOUTNO,"#");'>";
          ENDIF
          WRITE     HTMLFILE;SP1,FORMATNM,"</td>";
          REP       "+ ",CASEKEYS
          CALL      BOKSTA00
          WRITE     HTMLFILE;"</tr>"
          RETURN
.
BOKSTA00  BRANCH    OBASTAT,BOKSTA10,BOKSTA20,BOKSTA30,BOKSTA40,BOKSTA50
          GOTO      BOKSTA99
.
BOKSTA10  WRITE     HTMLFILE;"<td>Booked</td>";
          GOTO      BOKSTA99
.
BOKSTA20  WRITE     HTMLFILE;"<td>Not Used</td>";      * Should not get here
          GOTO      BOKSTA99
.
BOKSTA30  WRITE     HTMLFILE;"<td>Extended</td>"; * Should not get here
          GOTO      BOKSTA99
.
BOKSTA40  WRITE     HTMLFILE;"<td>Attended</td>";
          GOTO      BOKSTA99
.
BOKSTA50  WRITE     HTMLFILE;"<td>DNA</td>";
          GOTO      BOKSTA99
.
BOKSTA99  RETURN
.*******************************************************************************
.                         Get Case Details
.*******************************************************************************
CASDET00  CALL      CLPATMAS
          MATCH     "       0",OBAURNO
          IF        @EQUAL
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPRAM1
            BRANCH    OVRCD,CASDET99          * invalid UR number
          ELSE
            PACK      KEY8,OBAURNO,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,CASDET99          * invalid UR number
.
            PACK      KEY8,OBAURNO,SP70
            CALL      RDPMPX21                * read 2nd master file extension
            BRANCH    OVRCD,CASDET99          * invalid UR number
          ENDIF
.
CASDET99  RETURN
.*******************************************************************************
.                 Get Outpatient Sessions for a Date Range
.*******************************************************************************
CLITAB00  PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
CLITAB10  CALL      RDKSESA6
          BRANCH    OVRCD,CLITAB99
.
          MATCH     WBSESIT,OSESITE
          GOTO      CLITAB99 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      CLITAB99 IF LESS
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      CLITAB10 IF NOT EQUAL
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,CLITAB10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CLITAB10
          BRANCH    OMASTAT,CLITAB10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CLITAB10
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLITAB10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CLITAB10 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OMATYP,SRCHCLTY
            GOTO      CLITAB10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CLITAB10
.
            MATCH     OSESITE,OCASITE
            GOTO      CLITAB10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      CLITAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHDOCT
          IF        !@EQUAL
            MATCH     OCADOCT,SRCHDOCT
            GOTO      CLITAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000 
            ENDIF
          ENDIF
.
          MOVE      OMASTART,STRTIM
          MOVE      OMAEND,ENDTIM
          CALL      FMTTIM00
.
          PACK      KEY12,OMASITE,OMATYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td>":
                             "<A HREF=",LINKPRG,".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&sesskeys=",SESSKEYS,">":
                             "<img src=../images/DateLookup.gif border=0":
                             " hspace=4 align=absmiddle>":
                             "</a>":
                             DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                             "</td>":
                             "<td>",STRTIM,SP1,STRAMPM," to ":
                             ENDTIM,SP1,ENDAMPM,"</td>":
                             "<td>",OCTDESC,"</td>":
                             "<td>",OCADESC,"</td>":
                             "<td>",DOCFNAME,"</td></tr>"
          GOTO      CLITAB10
CLITAB99  RETURN
.*******************************************************************************
.                         Show Booking Details
.*******************************************************************************
SHWBOK00  PACK      CASEKEYS,CASEKEYS,SP70
          MATCH     SP70,CASEKEYS
          GOTO      SHWBOK30 IF NOT EQUAL
.
. HPS Code Starts Here
          MATCH     "010",TEMPLATE
          GOTO      SHWBOK40 IF EQUAL
          MATCH     "011",TEMPLATE
          GOTO      SHWBOK40 IF EQUAL
          MATCH     "015",TEMPLATE
          GOTO      SHWBOK40 IF EQUAL
          MATCH     "017",TEMPLATE
          GOTO      SHWBOK40 IF EQUAL
. HPS Code Ends Here
.
          MATCH     SP70,INVADMNO
          IF        !@EQUAL
            CALL      OHVIS000
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,SHWBOK10
          COMPARE   "2",PVITYPE
          GOTO      SHWBOK94 IF NOT EQUAL
.
          CALL      OUTVIS00
          BRANCH    EXIT,SHWBOK99
          GOTO      SHWBOK30
.
SHWBOK10  MOVE      ADMISSNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,SHWBOK97
          CALL      OUTPRE00
          BRANCH    EXIT,SHWBOK99
          GOTO      SHWBOK30
.
SHWBOK30  MATCH     "004",TEMPLATE
          IF        @EQUAL
.
            PACK      KEY16,ADMISSNO,SP70
            CALL      RSALLNK2
            CALL      RKALLNK2
            BRANCH    OVRCD,SHWBOK31
.
            MATCH     ADMISSNO,ALLNLNKV
            GOTO      SHWBOK31 IF NOT EQUAL
.
            MATCH     SP70,ALLNVISN
            GOTO      SHWBOK31 IF EQUAL
.
            PACK      KEY8,ALLNVISN
            CALL      RDALREF1
            BRANCH    OVRCD,SHWBOK31
.
            MATCH     "2",ALRESTAT
            GOTO      SHWBOK92 IF EQUAL
.
            MATCH     "3",ALRESTAT
            GOTO      SHWBOK92 IF EQUAL
.
            MATCH     "4",ALRESTAT
            GOTO      SHWBOK92 IF EQUAL
.
            MATCH     "5",ALRESTAT
            GOTO      SHWBOK92 IF EQUAL
.
          ENDIF
.
SHWBOK31  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,SHWBOK95
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=1
            MOVE      SP70,OPDICODE
            MOVE      SP70,OPDIDESC
.                                           *** HPS Code Starts Here ***
            MOVE      SP70,OPDICOD2         
            MOVE      SP70,OPDIDES2
            MOVE      SP70,OPDICOD3
            MOVE      SP70,OPDIDES3
            MOVE      SP70,OPDICOD4
            MOVE      SP70,OPDIDES4
            MOVE      SP70,OPDICOD5
            MOVE      SP70,OPDIDES5         
.                                           *** HPS Code Ends Here ***
          ENDIF
.
          MOVE      ADMISSNO,KEY8      * Get Referral Details
          CALL      RDOTRFL1
          IF        OVRCD=1
            CALL      CLOUTRFL
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70 * Visit Extenstion details
          CALL      RDPMVX11          
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70 * Outpatient Telehealth Info
          CALL      RDOTTHI1
          IF        OVRCD=1
            CALL      CLOUTTHI
          ENDIF
.
          MOVE      CASEKEYS,SESSKEYS
          CALL      SESDET00
          BRANCH    EXIT,SHWBOK96
.
          MOVE      OSECLIN,CLINICID   * Setup Clinic ID
          MOVE      OSESITE,SITECODE   * Site Code
          CALL      GETMAP00           * Get Template Mapping
.
          CALL      CLOUTBOB
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SHWBOK97
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          CALL      CLPATMAS
          CALL      CLPMSPX2
          MATCH     "       0",OBAURNO
          IF        @EQUAL
            MOVE      OBAOUTNO,KEY8           * visit number
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,OBAURNO            * r5
            CALL      RDMAST1
            BRANCH    OVRCD,SHWBOK93
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
          CALL      PATNAA00
.
          MOVE      SP70,OTBCRDAT             * I-48256
          MOVE      SP70,OTBCSPAR
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTBOC1                  * end I-48256
.
          PACK      KEY5,OBAOUTNO,SP70
          CALL      RDOTPRC1
          IF        OVRCD=1
            CALL      CLOUTPRC
          ENDIF 
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          IF        OVRCD=1
            CALL      CLWATOPA              * Waiting list link PAC
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPS2
          IF        OVRCD=1
            CALL      CLWTOS00              * Waiting list link PAS
          ENDIF
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
SHWBOK32  CALL      RKALLNK2                * check for associated referral
          IF        OVRCD=1
            PACK      ALLNLNKV,SP70
            PACK      ALLNVISN,SP70
            CALL      CLALLREF
            GOTO      SHWBOK35
          ENDIF
.
          MATCH     DOBAOUTN,ALLNLNKV
          IF        !@EQUAL
            CALL      CLALLREF
            GOTO      SHWBOK35
          ENDIF
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1                * get associated referral details
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
SHWBOK35  COMPARE   ONE,PTCNNHII
          GOTO      SHWBOK80 IF NOT EQUAL
.  
          MOVE      URNUMBER,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,SHWBOK98
.         
.         CALL      CHKHCU00
.         BRANCH    EXIT,SHWBOK99
          MOVE      ZERO,READDNR     * Set Flag as Donor Details Not Read
.
. HPS Code Starts Here
          GOTO      SHWBOK80
SHWBOK40  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SHWBOK99
          CALL      RDPMPX21
          BRANCH    OVRCD,SHWBOK99
. HPS Code Ends Here
.
SHWBOK80  MOVE      "Appointment Details",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,SHWBOK99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      SHWBOK99
.
SHWBOK92  MOVE      "Bookings Cannot be made from an Inactive/Cancelled/Rejected/Closed Referral",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK93  MOVE      "U/R Invalid.",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK94  CLEAR     WEBTITLE
          APPEND    "Visit is Not for an Appointment - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK95  MOVE      "INVALID CASE KEY",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK96  MOVE      "INVALID SESSION KEY",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK97  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK98  MOVE      "INVALID NHI RECORD",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK99  RETURN
.
.------------------------------------------------------------
. Get other hospital visit details
.------------------------------------------------------------
OHVIS000  PACK      KEY8,INVADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,OHVIS999
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      VISDHOSP,PTHSNAME,SP70
          ENDIF
.
          PACK      INVVISTP,SP1,TWO,SP70
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS999  RETURN
+
.*******************************************************************************
.             Get Booking Details Based on Pre-Attendance Details
.*******************************************************************************
OUTPRE00  MOVE      OPRSITE,WBSESIT
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,OUTPRE99
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTPRE90  
          MOVE      ADMISSNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
          CALL      RDBOKA1
          BRANCH    OVRCD,OUTPRE90 
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      ZERO,EXIT
          GOTO      OUTPRE99
.
OUTPRE90  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OUTPRE99
.
OUTPRE99  RETURN
.*******************************************************************************
.                Get Booking Details Based on Visit File Details
.*******************************************************************************
OUTVIS00  MOVE      PVISITE,WBSESIT
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,OUTVIS99
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTVIS90  
          MOVE      ADMISSNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          PACK      CASEKEYS,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDSBOKA1
OUTVIS10  CALL      RDKBOKA1
          BRANCH    OVRCD,OUTVIS90 
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     KEY20,CASEKEYS
          GOTO      OUTVIS90 IF NOT EQUAL
          MATCH     OBAOUTNO,PVIBILL         * Set up billing number    
          GOTO      OUTVIS10 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      OUTVIS99
.
OUTVIS90  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OUTVIS99
.
OUTVIS99  RETURN
.*******************************************************************************
.                    Stationery Codes Selection List
.*******************************************************************************
SCODL000  PACK      KEY6,SP70
          CALL      RSIBTH1
SCODL100  CALL      RKIBTH1
          BRANCH    OVRCD,SCODL999
.
          WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">":
                             IBTHDESC,"</option>"
          GOTO      SCODL100
.
SCODL999  RETURN
+
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {"
          COMPARE   ZERO,WARNCNT
          GOTO      ERRLST20 IF EQUAL
.
          MOVE      ONE,F2
ERRLST10  WRITE     HTMLFILE;"    alert(#"",WEBWRN[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,WARNCNT
          GOTO      ERRLST20 IF LESS
          GOTO      ERRLST10
.
ERRLST20  WRITE     HTMLFILE;" if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame(#"",REDIRECT,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  location.href=#"",REDIRECT,"#";":
                             "  }} ":
                             "</script>"

          CALL      CLOSHTML
          GOTO      ERRLST98
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST98  MOVE      ZERO,WARNCNT
ERRLST99  RETURN
.------------------------------------------------------------
. Write to the current patient list
.------------------------------------------------------------
WRCPAT00  CALL      CALRAN00
.
          MATCH     STRTDATE,OBADATE        * before start date
          GOTO      WRCPAT99 IF LESS
.
          MATCH     OBADATE,LASTDATE        * after end date
          GOTO      WRCPAT99 IF LESS
.
          MOVE      DOBAOUTN,PMCUVISN
          MOVE      OBADATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "2",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      OBASITE,PMCUOSIT
          MOVE      OTHEHOSP,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPAT99  RETURN
+
.------------------------------------------------------------
. Calculate the date range for current patient records
.------------------------------------------------------------
CALRAN00  READ      CONTROLF,HUND01;*49,CWEBSDAY  * no of days for search
          MOVE      SP70,STRTDATE
          MOVE      SP70,LASTDATE
.
. ---  calculate starting date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          SUB       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
. ---  calculate last date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          ADD       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      LASTDATE,CC,YY,MM,DD
          REP       " 0",LASTDATE
.
CALRAN99  RETURN
+
.------------------------------------------------------------
.         Check if we need to update PRFA
.------------------------------------------------------------
CPRA0000  
.         MATCH     SAVCOMP,OBACOMP
.         GOTO      CPRA9999 IF EQUAL        * Compensation code hasn't changed
.
          PACK      OBACOMP,OBACOMP,SP70
          MATCH     SP70,OBACOMP
          GOTO      CPRA9999 IF EQUAL        * Blank Compensation code
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CPRA9999
.
          MOVE      SP70,DIM1
          MOVE      TCINDC1,DIM1
          REP       "P~J~ ~",DIM1
          MATCH     "~",DIM1
          GOTO      CPRA1000 IF EQUAL        * Public
          MATCH     "E",DIM1
          GOTO      CPRA9999 IF NOT EQUAL
.
          MOVE      "7",KEY1           * Local Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA9999      * default to patient details
          GOTO      CPRA1200
.
CPRA1000  MOVE      "2",KEY1                 * Postal Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA2000
.
CPRA1200  MOVE      SP1,ANS
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
.
          MOVE      PTMASNAM,PACSNAMX
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAMX,PKNAME
.
          MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          MOVE      OBAOUTNO,PKADMN
          CALL      PARN0000                  * Check for 'Parent of'
.
          PACK      KEY8,OBAOUTNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          GOTO      CPRA9999
.
CPRA2000  PACK      KEY3,OBACOMP,SP70
          CALL      PRAD0000           * write to person responsible file
CPRA9999  RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.*******************************************************************************
. Update Interpreter Audit Table
.  Input - CASEKEYS  Key To Booking
.          INTAUDTY  Audit Type
.*******************************************************************************
INTAUD00  CALL      CLVISIAU
          PACK      VSIACDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSIACDAT
          MOVE      CTIMEIS,VSIACTIM
          MOVE      INTAUDTY,VSIARTYP
.
          MOVE      VSINVISN,VSIAVISN
          MOVE      VSINDATE,VSIADATE
          MOVE      VSINTIME,VSIATIME
.....     MOVE      "2",VSIATYPE                                        D-40489
          MOVE      VSINTYPE,VSIATYPE                                  *I-40489
          MOVE      VSINSUBK,VSIASUBK
          MOVE      VSINWUID,VSIAWUID
          MOVE      PMPXLNG1,VSIALNG1
          MOVE      PMPXLNG2,VSIALNG2
          MOVE      PMPXLNG3,VSIALNG3
          MOVE      VSINNOTF,VSIANOTF
          MOVE      VSINCONF,VSIACONF
.
          PACK      KEY25,VSIACDAT,VSIACTIM,VSIARTYP,VSIAVISN,SP70
          CALL      RAVSIAU1
          IF        OVRCD=0
            CALL      UPVSIAU1
          ELSE
            CALL      WRVSIAU1
          ENDIF
          MOVE      ZERO,EXIT
INTAUD99  RETURN   
+
.------------------------------------------------------------------------------
. Print MRT barcode labels for 1 patient (UR) and multiple volumes
. One spool file is created for each patient (UR) and volume
.------------------------------------------------------------------------------
PRTMRT00  MATCH     "1",LABPRT05
          GOTO      PRTMRT99 IF NOT EQUAL
.
          MOVE      LABPSL05,SELPRINT
          MOVE      LABPNO05,NOLABELS
          MOVE      NOLABELS,HTLNUM
          COMPARE   ZERO,HTLNUM
          GOTO      PRTMRT99 IF EQUAL
.
          MOVE      ZERO,SLOTCNT
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PRTMRT91
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PRTMRT92
.
PRTMRT20  COMPARE   "99",SLOTCNT
          GOTO      PRTMRT80 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT > SLOTINDX
            GOTO      PRTMRT80
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,PRTMRT20
          MOVE      OBAURNO,URNUMBER
.
          IF        IBCNMHOS = 1
            PACK      KEY20,URNUMBER,OTHEHOSP,SP70
          ELSE
            PACK      KEY20,URNUMBER,SP70
          ENDIF
.
          CALL      RSMRMAS1
PRTMRT30  CALL      RKMRMAS1
          BRANCH    OVRCD,PRTMRT90
.
          MATCH     URNUMBER,MRMAURNO          * same U/R number?
          GOTO      PRTMRT20 IF NOT EQUAL      * no. back to next patient
.
          IF        IBCNMHOS = 1
            MATCH     OTHEHOSP,MRMAHHOS        * same home hospital
            GOTO      PRTMRT20 IF NOT EQUAL
          ENDIF
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PRTMRT95
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PTCNNHII = 1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            BRANCH    OVRCD,PRTMRT96
          ENDIF
.
          MOVE      URNUMBER,CPPURNO
          UNPACK    SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
          MATCH     "0",DIM1A
          GOTO      PRTMRT50 IF NOT EQUAL
.
          MOVE      SP1,DIM1A
.
          MATCH     "0",DIM1B
          GOTO      PRTMRT50 IF NOT EQUAL
.
          MOVE      SP1,DIM1B
.
          MATCH     "0",DIM1C
          GOTO      PRTMRT50 IF NOT EQUAL
.
          MOVE      SP1,DIM1C
.
          MATCH     "0",DIM1D
          GOTO      PRTMRT50 IF NOT EQUAL
.
          MOVE      SP1,DIM1D
.
          MATCH     "0",DIM1E
          GOTO      PRTMRT50 IF NOT EQUAL
.
          MOVE      SP1,DIM1E
.
PRTMRT50  PACK      SELPRINT,DIM1A,DIM1B,DIM1C,DIM1D,DIM1E,DIM1F
.
          PACK      KEY6,SELPRINT,SP70
          CALL      RDPRTA1
          IF        OVRCD = 1
            MOVE      SP70,PRTTYPE
          ENDIF
.
          MOVE      "MRT Barcode Labels",SCHEDDSC
          CALL      OPNPRINT
          CALL      BARCODEF                      * format Bar code labels
          CALL      BARCODEL                      * print Bar Code Labels
          CALL      CLSPRINT
.
          GOTO      PRTMRT30                      * back to next volume
.
PRTMRT80  MOVE      ZERO,EXIT
          GOTO      PRTMRT99
.
PRTMRT90  MOVE      "Medical Record Does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTMRT99
.
PRTMRT91  MOVE      "Clinic Session Record Does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTMRT99
.
PRTMRT92  MOVE      "Ouptpatient Master Header Record Does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTMRT99
.
PRTMRT95  MOVE      "Invalid UR",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTMRT99
.
PRTMRT96  MOVE      "Missing nhimasaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTMRT99
.
PRTMRT99  RETURN
+
.*******************************************************************************
.                            New Booking Details
.*******************************************************************************
NEWBOK00  CALL      CLPATMAS       * Clear All Patient Details
          CALL      CLPMSPX2       * Clear All Patient Details
          MATCH     SP70,URNUMBER
          GOTO      NEWBOK05 IF EQUAL
.         IF        !@EQUAL
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,NEWBOK91
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            COMPARE   FOUR,PSTAT              * EBS Unknown U/R
            GOTO      NEWBOK97 IF EQUAL
.
            IF        PSTAT=1 | PSTAT=2
              MOVE      PURNO,SAVEURNO
              MOVE      PPSNAME,URNUMBER
              MOVE      ONE,MRGEFLAG
              GOTO      NEWBOK00
            ENDIF
.         ENDIF
.
NEWBOK05  CALL      CLOUTBOA       * Clear All Outpatient Details
          CALL      CLOUTBOB       * Clear All Outpatient Details
.
          MOVE      ADMISSNO,KEY8  * Get Referral Details
          CALL      RDOTRFL1
          IF        OVRCD=1
            CALL      CLOUTRFL
          ENDIF
.
          MOVE      ADMISSNO,KEY8  * Get Allied Health Referral Details
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLPMSVX1
          ELSE
            MOVE      ADMISSNO,KEY8  * Get visit extn details
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
          ENDIF
.
          MOVE      SP70,SAVDSPLC
          PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
NEWBOK07  CALL      RKDSPTL1
          BRANCH    OVRCD,NEWBOK08
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      NEWBOK08 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      NEWBOK07 IF NOT EQUAL
.
          MOVE      DSPLCODE,SAVDSPLC
.
NEWBOK08  MATCH     Z70,REQUESTK                 * Requested appointment details
          IF        !@EQUAL
            PACK      KEY32,REQUESTK,SP70
            CALL      RDOTART1
            IF        OVRCD=1
              CALL      CLOUTART
            ENDIF
          ELSE
            CALL      CLOUTART
          ENDIF
.
          IF        HBWAIT=1
            PACK      KEY19,WAITLKEY,SP70   * Using w/list
            CALL      RDTREA1
            IF        OVRCD=1
              CALL      CLWATTR1
            ENDIF
.         
            PACK      KEY19,WAITLKEY,SP70
            CALL      RDWTTX11
            IF        OVRCD=1
              CALL      CLWATTX1
            ENDIF
          ELSE
            CALL      CLWATTR1
            CALL      CLWATTX1
          ENDIF
.
          IF        CLNEWBOK=1
            MOVE      SP70,CASEKEYS
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            MOVE      SP70,OMACIND
            GOTO      NEWBOK10
          ENDIF
.
          MOVE      CASEKEYS,SESSKEYS
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,NEWBOK92
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      NEWBOK94 IF LESS
            ELSE
              GOTO      NEWBOK94
            ENDIF     
          ENDIF
.
          MOVE      CASEKEYS,SESSKEYS
          CALL      SESDET00                  * Read session details for all 
          BRANCH    EXIT,NEWBOK96             * bookings regardless of status
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          COMPARE   ZERO,OBASTAT
          GOTO      NEWBOK10 IF EQUAL
          COMPARE   NINE,OBASTAT
          GOTO      NEWBOK93 IF NOT EQUAL
.
          MOVE      CASEKEYS,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      NEWBOK95 IF NOT EQUAL    * Record isn't vacant !!
          ENDIF
          MOVE      ZERO,OBASTAT             * Make sure record isn't booked
.
NEWBOK10  MOVE      "New Appointment ",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,NEWBOK99
.
          IF        PTCNNHII=1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      NEWBOK99
            ENDIF
            MOVE      URNUMBER,DIM20
            SQUEEZE   DIM20
            UNPACK    DIM20,DIM1
            TYPE      DIM1
            GOTO      NEWBOK90 IF EQUAL        * numeric prefix on URNUMBER
.
            SCAN      "T-",URNUMBER             * check if temporary number
            IF        !@EQUAL
              RESET     URNUMBER
              CALL      CONNECT
              BRANCH    EXIT,NEWBOK99
              MOVE      SP1,NZIBMWST      * prevent call to SETMED if we miss
              CALL      CHKHCU00
              MATCH     SP70,NZIBMWST
              IF        !@EQUAL
                PROC      SETMED00
              ENDIF
              CALL      DISCNNCT
              BRANCH    EXIT,NEWBOK99
            ENDIF
            RESET     URNUMBER
          ENDIF
.
NEWBOK90  CALL      WEBBOD00
.
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00
          GOTO      NEWBOK99
.
NEWBOK91  MOVE      "Invalid Patient U/R ",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK92  CLEAR     WEBTITLE
          APPEND    "Invalid Slot - ",WEBTITLE
          APPEND    KEY28,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK93  MOVE      "Slot Already Taken",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK94  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK95  MOVE      "Slot Reserved.",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK96  MOVE      "Invalid Session key",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99 
.
NEWBOK97  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK99  RETURN
.*******************************************************************************
.                    Get Outpatient Sessions for a Range
.*******************************************************************************
CLISTB00  IF        FHIRTYPE=ONE
            MOVE      ZERO,FHIRRECN
          ENDIF
.
          PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
CLISTB10  CALL      RDKSESA6
          BRANCH    OVRCD,CLISTB99
.
          MATCH     WBSESIT,OSESITE
          GOTO      CLISTB99 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      CLISTB99 IF LESS
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CLISTB10
.          BRANCH    OMASTAT,CLSRCH10            * Display inactive clinic if
          IF        OMASTAT<>0
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            MATCH     OSEDATE,CURRDATE           * clinic date prior to curr date
            IF        @LESS
              GOTO      CLISTB10
            ENDIF
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CLISTB10
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CLISTB10
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      CLISTB10 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,SRCHCIND           * filter on clinic indicator
          IF        !@EQUAL
            MATCH     SRCHCIND,OTHECIND
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLISTB10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CLISTB10 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHCGRP
          IF        !@EQUAL
            PACK      KEY12,OTHESITE,OTHECTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=0
              MATCH     OCTGRP,SRCHCGRP
              GOTO      CLISTB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          MOVE      SP70,DISPSUSC
          MATCH     "1",OTCNDSUS
          IF        @EQUAL
            CALL      CHKSUS00
            IF        EXIT=ONE
              MOVE      "1",DISPSUSC
            ENDIF
          ELSE
            CALL      CHKSUS00
            BRANCH    EXIT,CLISTB10
          ENDIF
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,CLISTB10
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CLISTB10
.
            MATCH     OSESITE,OCASITE
            GOTO      CLISTB10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHDOCT
          IF        !@EQUAL
            MATCH     OCADOCT,SRCHDOCT
            GOTO      CLISTB10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.                                           *** HPS Code Starts Here ***        
          COMPARE   ONE,TMPFLG                   
          GOTO      CLISTB20 IF EQUAL      
.                                           *** HPS Code Ends Here *** 
CLISTB11  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.                                          
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.                                         
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&sesskeys=",HTMLLINK
          APPEND    SESSKEYS,HTMLLINK
          APPEND    "&viewopcl=",HTMLLINK
          APPEND    VIEWOPCL,HTMLLINK
          RESET     HTMLLINK
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
.
          IF        FHIRTYPE=ONE
            CALL      RESSCH00
            GOTO      CLISTB10
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DAYNAM3,"#",":                   1
                             "#"",OSEDATE,OMASTART,DAYNAM3,"#",":  2
                             "#"",OMAEND,"#",":                    3
                             "#"",OCTDESC,"#",":                   4
                             "#"",OCADESC,"#",":                   5
                             "#"",TDESC,"#",":                     6
                             "#"",OEMPTY,"#",":                    7
                             "#"",OSESSLTN,"#",":                  8
                             "#"",OSEBNEW,"#",":                   9
                             "#"",OSEBRV,"#",":                    0
                             "#"",OSEBSPC,"#",":                   1
                             "#"",DOCFNAME,"#",":                  2
                             "#"",OSETIMES,"#",":                  3
                             "#"",OSETIMEU,"#",":                  4
                             "#"",OSESSLTN,"#",":                  5
                             "#"",OSESSLTR,"#",":                  6
                             "#"",OSESSLTS,"#",";                  7
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
          WRITE     HTMLFILE;"#"",OSESSLTN,"#",":                  8
                             "#"",OSESSLTR,"#",":                  9
                             "#"",OSESSLTS,"#",":                  0
                             "#"",OSESLOTB,"#",":                  1
                             "#"",OTHEDURN,"#",":                  2
                             "#"",OTHEBFIN,"#",":                  3
                             "#"",OTHESEND,"#",":                  4
                             "#"",OTMAROOM,"#",":                  5
                             "#"",DISPSUSC,"#");"                 *6
          GOTO      CLISTB10
.
CLISTB20  MATCH     OMATYP,CLINTYPE
          GOTO      CLISTB10 IF NOT EQUAL
          GOTO      CLISTB11      
.
CLISTB99  RETURN
+
.------------------------------------------------------------
. Check sessions for available slots and visit type filter.
. SRCHEMPT = 1 - Search for a matching clinic id, type and slot
.                that is available.
. SRCHEMPT = 0 - Search for a matching clinic id, type and slot
.                that is available or full.
.
. Exit = 0 - OK display session
.        1 - Do not display session
.------------------------------------------------------------
CHKAPP00  COMPARE   ONE,SRCHEMPT            * Yes only check for sessions with
          GOTO      CHKAPP10 IF EQUAL       * empty slots
.
          MATCH     SP70,SRCHVTYP           * Check for slot visit type
          GOTO      CHKAPP10 IF NOT EQUAL
.
          GOTO      CHKAPP90    
.
CHKAPP10  MOVE      ZERO,EMPTFLAG         
          MOVE      ZERO,SLTVFLAG
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
CHKAPP20  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CHKAPP95          * end of session
.
          MATCH     OBASITE,OSESITE
          GOTO      CHKAPP95 IF NOT EQUAL
.
          MATCH     OBACLIN,OSECLIN 
          GOTO      CHKAPP95 IF NOT EQUAL
.
          MATCH     OBADATE,OSEDATE
          GOTO      CHKAPP95 IF NOT EQUAL
.
          MATCH     OBASTRT,OSESTRT
          GOTO      CHKAPP95 IF NOT EQUAL
.
          COMPARE   ZERO,SRCHEMPT
          IF        @EQUAL
            MATCH     SRCHVTYP,OBAVISIT     * If searching for the next clinic
            GOTO      CHKAPP90 IF EQUAL     * did this clinic have a matching
          ENDIF                             * slot of this visit type
.
          COMPARE   SEVEN,OBASTAT           * Unavailable
          GOTO      CHKAPP20 IF EQUAL
.
          COMPARE   SIX,OBASTAT             * Suspended
          GOTO      CHKAPP20 IF EQUAL
.
          COMPARE   THREE,OBASTAT           * Extended Slot
          GOTO      CHKAPP20 IF EQUAL
.
          COMPARE   TWO,OBASTAT             * Not Used
          GOTO      CHKAPP20 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            GOTO      CHKAPP20
          ENDIF
.
          COMPARE   ZERO,OBASTAT
          GOTO      CHKAPP20 IF NOT EQUAL
.
          MOVE      ONE,EMPTFLAG            * Set empty slots available to yes
.
          MATCH     SRCHVTYP,OBAVISIT
          IF        @EQUAL
            MOVE      ONE,SLTVFLAG          * Set matching slot types to yes
          ENDIF
.
          COMPARE   ONE,SRCHEMPT            * Checking for empty slots
          IF        @EQUAL
            COMPARE   ONE,EMPTFLAG
            GOTO      CHKAPP20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHVTYP           * Checking for slot types
          IF        !@EQUAL
            COMPARE   ONE,SLTVFLAG
            GOTO      CHKAPP20 IF NOT EQUAL
          ENDIF
.
CHKAPP90  MOVE      ZERO,EXIT
          GOTO      CHKAPP99
.
CHKAPP95  MOVE      ONE,EXIT
          GOTO      CHKAPP99
.
CHKAPP99  RETURN
.
.*******************************************************************************
.                           Output Case List Table
.*******************************************************************************
CASSTB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZEROVISN,LASTOUTN
          MOVE      ZERO,RECCNT
.
          IF        FHIRTYPE=ONE
            MOVE      ZERO,FHIRRCN2
          ENDIF
.
          PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CASSTB10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CASSTB99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CASSTB99 IF NOT EQUAL   * different sessio
.
          COMPARE   SIX,OBASTAT
          GOTO      CASSTB10 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      CASSTB10 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      CASSTB10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CASSTB10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
          MOVE      SP70,OTXWDESC
.
          IF        (OBASTAT=0|OBASTAT=9|OBASTAT=7)
            CALL      EMSTB000 * Empty Slot/Suspended/Reserved
          ELSE
            CALL      FUSTB000 * Full Slot
          ENDIF
.
          GOTO      CASSTB10
CASSTB99  RETURN
.*******************************************************************************
.                                Show Empty Slot
.*******************************************************************************
EMSTB000  BRANCH    FULLONLY,EMSTB999
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
          MOVE      TDESC,VSLTCOMM
.
          MOVE      ZERO,CHARTREV                  * No
....      IF        CONTVIEW=1
            MATCH     ANSC,TCINDC8                 * Chart Review Slot
            IF        @EQUAL
              MOVE     ONE,CHARTREV                * Yes
            ENDIF
....      ENDIF
.
          MATCH     ANSU,TCINDC6            * Get slot comment if unavailable
          IF        @EQUAL
            MATCH     "1",SHWUNAVL       
            GOTO      EMSTB999 IF EQUAL     * skip unavialable slots
.
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      RDOTBOX1
            IF        OVRCD=0
              MATCH     SP70,OTBXCOMM
              IF        !@EQUAL
                MOVE      OTBXCOMM,VSLTCOMM
              ENDIF
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateSlot('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OCADESC,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DAYNAM3,HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    CDAY,HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    MTHNAM3,HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    CCENT,HTMLLINK
          APPEND    CYEAR,HTMLLINK
          APPEND    " at ",HTMLLINK
          APPEND    OBATIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          IF        FHIRTYPE=ONE
            CALL      RESSLF00
            GOTO      EMSTB999
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBADATE,OBATIME,"#",":
                             "#"",OBASLOT,"#",":
                             "#"",OBAVISIT,"#",":
                             "#"",VTYPDESC,"#",";
          IF        OBASTAT=7
            WRITE     HTMLFILE;"#"",VSLTCOMM,"#",";
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";
          ENDIF
.
          MATCH     "1",VIEWOPCL
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",OBASTAT,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",CASEKEYS,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",";
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",OBASTAT,"#",":
                               "#"javascript:alert('No Booking')#",":
                               "#"javascript:alert('No Booking')#",":
                               "#"javascript:alert('No Booking')#",":
                               "#"javascript:alert('No Booking')#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",CASEKEYS,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",":
                               "#"",SP1,"#",";
          ENDIF
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<font color=magenta>",OBAVISIT,"</font>#",";
          ELSE
            MATCH      ANSU,TCINDC6
            IF         @EQUAL
              WRITE     HTMLFILE;"#"<font color=red>",OBAVISIT,"</font>#",";
            ELSE
              WRITE      HTMLFILE;"#"",OBAVISIT,"#",";
            ENDIF
          ENDIF
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
.           WRITE     HTMLFILE;"#"<font color=magenta>",VTYPDESC,"</font>#");"
            WRITE     HTMLFILE;"#"<font color=magenta>",VTYPDESC,"</font>#",";
          ELSE
            MATCH      ANSU,TCINDC6
            IF         @EQUAL
.             WRITE     HTMLFILE;"#"<font color=red>",VTYPDESC,"</font>#");"
              WRITE     HTMLFILE;"#"<font color=red>",VTYPDESC,"</font>#",";
            ELSE
.             WRITE      HTMLFILE;"#"",VTYPDESC,"#");"
              WRITE      HTMLFILE;"#"",VTYPDESC,"#",";  
            ENDIF
          ENDIF
.
          CALL      DOMCLR00                      * Get Demographic date color
.
          WRITE     HTMLFILE;"#"";
          CALL      VICMNT00
          WRITE     HTMLFILE;"#",";
.
          WRITE      HTMLFILE;"#"",SP1,"#",":                    * 39
                              "#"",SP1,"#",":                    * 40
                              "#"",SP1,"#",":                    * 41
                              "#"",SP1,"#",":                    * 42
                              "#"",SP1,"#",":                    * 43
                              "#"",SP1,"#",":                    * 44
                              "#"",SP1,"#",":                    * 45
                              "#"",SP1,"#",":                    * 46
                              "#"",SP1,"#",":                    * 47
                              "#"",SP1,"#",":                    * 48
                              "#"",SP1,"#",":                    * 49
                              "#"",SP1,"#",":                    * 50
                              "#"",SP1,"#",":                    * 51
                              "#"",SP1,"#",":                    * 52      
                              "#"",SP1,"#",":                    * 53      
                              "#"",SP1,"#",":                    * 54      
                              "#"",SP1,"#",":                    * 55      
                              "#"",OCTDESC,"#",":                * 56 - Clinic Type
                              "#"",OCADESC,"#",":                * 57 - Clinic Name
                              "#"",OCTCTYP,"#",":                * 58 - Clinic Type Code
                              "#"",SP1,"#",":                    * 59      
                              "#"",SP1,"#",":                    * 60      
                              "#"",SP1,"#",":                    * 61     
                              "#"",SP1,"#",":                    * 62     
                              "#"",SP1,"#",":                    * 63     
                              "#"",CHARTREV,"#",":               * 64     
                              "#"",SP1,"#",":                    * 65     
                              "#"",SP1,"#",":                    * 66     
                              "#"",SP1,"#",":                    * 67     
                              "#"",SP1,"#",":                    * 68     
                              "#"",SP1,"#",":                    * 69     
                              "#"",SP1,"#",":                    * 70     
                              "#"",SP1,"#",":                    * 71     
                              "#"",SP1,"#",":                    * 72     
                              "#"",SP1,"#",":                    * 73     
                              "#"",SP1,"#",":                    * 74     
                              "#"",SP1,"#",":                    * 75     
                              "#"",SP1,"#",":                    * 76     
                              "#"",SP1,"#",":                    * 77     
                              "#"",OTHEMREF,"#",":               * 78
                              "#"",SP1,"#",":                    * 79
                              "#"",SP1,"#",":                    * 80
                              "#"",SP1,"#",":                    * 81
                              "#"",SP1,"#",":                    * 82
                              "#"",SP1,"#",":                    * 83
                              "#"",SP1,"#",":                    * 84
                              "#"",SP1,"#",":                    * 85
                              "#"",SP1,"#",":                    * 86
                              "#"",SP1,"#",";                    * 87
          COMPARE   MOSAIQCL,ZERO
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",SP1,"#",";                   * 88  
          ELSE 
            WRITE     HTMLFILE;"#"",MOSAIQCL,"#",";              * 88
          ENDIF
      
          WRITE     HTMLFILE;"#"",SP1,"#",":                    * 89
                              "#"",SP1,"#",":                    * 90
                              "#"",DOMCOLOR,"#");"               * 91
.
EMSTB999  RETURN
.*******************************************************************************
.                              Full Slot
.*******************************************************************************
FUSTB000  CALL      CASDET00
          MOVE      ZERO,HEIGHTCT
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,CHARTREV                  * No
          MATCH     ANSC,TCINDC8                   * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV                  * Yes
          ENDIF
.                                          
          IF        OBASTAT=5  
            MOVE      "DNA",KEY4
          ELSE
            MOVE      SP70,KEY4
          ENDIF
          MOVE      TDESC,VTYPDESC
          PACK      KEY8,OBAURNO,SP70              * Read For Alert
          CALL      RDPTMSX1
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG1,CODE
          CALL      GETCOD00
          MOVE      TDESC,INTERNAM
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SPECANAM
.
.                                           * Diagnosis/Presenting Complaint
FUSTB010  UNPACK    SP70,DOPDIOUT,OPDIDESC         
          PACK      KEY8,OBAOUTNO,SP70      * Read For Diagnosis
          CALL      RDDIAG1
          IF        OVRCD = 1
            PACK      OPDIDES2,SP70
            PACK      OPDIDES3,SP70
            PACK      OPDIDES4,SP70
            PACK      OPDIDES5,SP70
          ENDIF
.
          UNPACK    SP70,PMVXUDF1
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11                * Read for Presenting Complaint
.
          PACK      KEY550,SP70,SP70,SP70
          CLEAR     KEY550
.
          MATCH     "1",OTCNDACI
          IF        !@EQUAL
.                                           * original selections
            MATCH     SP70,OPDIDESC
            GOTO      FUSTB012 IF EQUAL     * only use Presenting complaint
          ENDIF
.
FUSTB011  MATCH     SP70,OPDIDESC           * set up each Diagnosis
          IF        !@EQUAL
            APPEND    OPDIDESC,KEY550
            APPEND    "<br />",KEY550
            ADD       ONE,HEIGHTCT
          ENDIF
.
          MATCH     SP70,OPDIDES2
          IF        !@EQUAL
            APPEND    OPDIDES2,KEY550
            APPEND    "<br />",KEY550
            ADD       ONE,HEIGHTCT
          ENDIF
.
          MATCH     SP70,OPDIDES3
          IF        !@EQUAL
            APPEND    OPDIDES3,KEY550
            APPEND    "<br />",KEY550
            ADD       ONE,HEIGHTCT
          ENDIF
.
          MATCH     SP70,OPDIDES4
          IF        !@EQUAL
            APPEND    OPDIDES4,KEY550
            APPEND    "<br />",KEY550
            ADD       ONE,HEIGHTCT
          ENDIF
.
          MATCH     SP70,OPDIDES5
          IF        !@EQUAL
            APPEND    OPDIDES5,KEY550
            APPEND    "<br />",KEY550
            ADD       ONE,HEIGHTCT
          ENDIF
.
          MATCH     "1",OTCNDACI
          GOTO      FUSTB014 IF NOT EQUAL          * using original set up
.
FUSTB012  MATCH     SP70,PMVXUDF1
          IF        !@EQUAL
            APPEND    PMVXUDF1,KEY550
          ENDIF
.
FUSTB014  RESET     KEY550
          STRIP     KEY550                         
.
FUSTB020  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
            MOVE      OBAOUTNO,PVIBILL
            MOVE      OBADATE,PVIDATE
            MOVE      "2",PVITYPE
            MOVE      " 2",PTVITYPE
          ENDIF
.
          PACK      KEY8,OBAURNO,SP70              * Read For Patient
          CALL      RDMAST1                        * Telephone numbers
          MOVE      OBAOUTNO,OUTPATE
          CALL      CLPMSPX2
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                 
.
          CALL      PATFLD00                       * Get patient folder
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
FUSTB022  CALL      RKALLNK2                * check for associated referral
          IF        OVRCD=1
            PACK      ALLNLNKV,SP70
            PACK      ALLNVISN,SP70
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      FUSTB025
          ENDIF
.
          MATCH     DOBAOUTN,ALLNLNKV
          IF        !@EQUAL
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      FUSTB025
          ENDIF
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1                * get associated referral details
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      FUSTB025 
          ENDIF
.
          PACK      KEY24,OBAOUTNO,SP70
          CALL      RSALENC7
FUSTB023  CALL      RKALENC7
          IF        OVRCD=1
            CALL      CLALLENC
            GOTO      FUSTB025 
          ENDIF
.
          MATCH     DOBAOUTN,ALENLINK
          IF        !@EQUAL
            CALL      CLALLENC
            GOTO      FUSTB025
          ENDIF
.
          MATCH     "1",ALENRSTA            * Cancelled
          GOTO      FUSTB023 IF EQUAL
.
FUSTB025  CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          RESET     HTMLLINK
          CLEAR     ALERTSTR
.
          MOVE      SP70,DISALRIN
          MOVE      ZERO,EXIT
.
          PROC      DISPALRT
          IF        EXIT=0
            APPEND    PTMXSIN1,ALERTSTR
            MOVE      "0",DISALRIN
          ENDIF
.
          IF        EXIT=1
            APPEND    SP1,ALERTSTR
            MOVE      "1",DISALRIN
          ENDIF
.
          IF        EXIT=2
            APPEND    PTMXSIN1,ALERTSTR
            MOVE      "1",DISALRIN
          ENDIF
.
.         APPEND    PTMXSIN1,ALERTSTR
          APPEND    PTMXSIN2,ALERTSTR
          APPEND    PTMXSIN3,ALERTSTR
          APPEND    PTMXSIN4,ALERTSTR
          APPEND    PTMXSIN5,ALERTSTR
.
          MATCH     SP70,OTBBSPCA
          IF        @EQUAL
            APPEND    ZERO,ALERTSTR
          ELSE
            APPEND    ONE,ALERTSTR
          ENDIF
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     SP70,PMVXINTR
            IF        @EQUAL
              APPEND    ZERO,ALERTSTR
            ELSE
              MATCH     "0",PMVXINTR
              IF        !@EQUAL
                APPEND    ONE,ALERTSTR
              ELSE
                APPEND    ZERO,ALERTSTR
              ENDIF
            ENDIF
          ELSE
            MATCH     SP70,PMPXINTR
            IF        @EQUAL
              APPEND    ZERO,ALERTSTR
            ELSE
              MATCH     "0",PMPXINTR
              IF        !@EQUAL
                APPEND    ONE,ALERTSTR
              ELSE
                APPEND    ZERO,ALERTSTR
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "PV",CATEGORY
          MOVE      PMPXPRVI,CODE
          CALL      GETCOD00
          MATCH     ANSP,TCINDC1
          IF        @EQUAL
            APPEND    ONE,ALERTSTR
          ELSE
            APPEND    ZERO,ALERTSTR
          ENDIF
.
          PACK      KEY19,OBAURNO,OBAOUTNO,SP70            * Read For Transport
          CALL      RSPMTSP1
FUSTB026  CALL      RKPMTSP1
          BRANCH    OVRCD,FUSTB027
.
          MATCH     PMTSURNO,OBAURNO
          GOTO      FUSTB027 IF NOT EQUAL
.
          MATCH     PMTSVISN,DOBAOUTN
          GOTO      FUSTB027 IF NOT EQUAL
.
          MATCH     "1",PMTSBOOK
          IF        @EQUAL
            APPEND    ONE,ALERTSTR
            GOTO      FUSTB028
          ENDIF
.
          GOTO      FUSTB026
.
FUSTB027  APPEND    ZERO,ALERTSTR
.
FUSTB028  MOVE      SP70,FLUPDESC
          MATCH     "1",OTBBFLUP
          IF        @EQUAL
            MOVE      "Done",FLUPDESC
          ENDIF
.
          MOVE      OTBBOUTC,VOUTCODE
.
          MOVE      "OZ",CATEGORY
          MOVE      OTBBOUTC,CODE
          CALL      GETCOD00
          PACK      VOUTDESC,TDESC,SP70
.
          CALL      CHKS0000                * Check if this is a series booking
          CALL      DCMBS000                * check for any CMBS items
          CALL      SETX0000                * Set highlight colour
          CALL      SRXW0000  * Set referral expiry highlight colour class
          CALL      GHCST000                * Get hic claim status
.
          APPEND    SP70,ALERTSTR
          RESET     ALERTSTR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS
          ENDIF
.
          PACK      ALERTST2,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:
                          PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,SP70
          REP       " 0",ALERTST2
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PTMADCDT
          IF        !@EQUAL
            UNPACK    PTMADCDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      ZERO,CONFRPMI 
          IF        PTCNHDPS<>1
            MATCH     "1",OTHECPMI
            IF        @EQUAL
              IF        CHARTREV<>1
                MATCH     OBADATE,PTMADCDT
                IF        @LESS
                  MOVE      ONE,CONFRPMI  
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      CURP0000                * Check if current OP or EMR
.
          IF        FHIRTYPE=ONE
            CALL      RESSLF00
            GOTO      FUSTB999
          ENDIF
.
          MATCH     "1",VIEWOPCL
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",OBADATE,OBATIME,"#",":         *1
                               "#"",OBASLOT,"#",":                 *2
                               "#"",OBAVISIT,"#",":                *3
                               "#"",VTYPDESC,"#",":                *4
            "#"","<img src=../images/PatientFolder",KEY3,".gif":
                               " class=ListIcon>",FORMATNM,"#",";  *5
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",OBADATE,OBATIME,"#",":         *1
                               "#"",OBASLOT,"#",":                 *2
                               "#"",OBAVISIT,"#",":                *3
                               "#"",VTYPDESC,"#",":                *4
                               "#"",FORMATNM,"#",";                *5
          ENDIF
.
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MATCH     SP70,KEY20
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",KEY20,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",OBAURNO,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",OBAURNO,"#",";               *6
          ENDIF
          WRITE     HTMLFILE;"#"",OUTPATE,"#",":                 *7
                             "#"",DISPSEX,"#",":                 *8
                             "#"";                 
          CALL      WRTAGE00                                     *9
          WRITE     HTMLFILE;"#",":
                             "#"",SP1,"#",":                     *10
                             "#"",SP1,"#",":                     *11
                             "#"",SP1,"#",":                     *12
                             "#"",SP1,"#",":                     *13
                             "#"",OTBBASTM,"#",":                *14
                             "#"",OTBBCITM,"#",":                *15
                             "#"",OTBBDPTM,"#",":                *16
                             "#"",OBASTAT,"#",":                 *17
                             "#"",SP1,"#",":                     *18
                             "#"",SP1,"#",":                     *19
                             "#"",FLUPDESC,"#",":                *20
                             "#"",KEY4,"#",":                    *21
                             "#"",KEY550,"#",":                  *22
.                             "#"",OPDIDES2,"#",":               *23
.                             "#"",OTXWDESC,"#",":               *24
                             "#"";
          CALL      DIAGCM00                                     *23
          WRITE     HTMLFILE;"#",": 
                             "#"",ALERTSTR,"#",":                *24
                             "#"",PTELEP,"#",":                  *25
                             "#"",PTELEB,"#",":                  *26
                             "#"",PTMXCELL,"#",":                *27
                             "#"",CASEKEYS,"#",":                *28
                             "#"",INTERNAM,"#",":                *29
                             "#"",SPECANAM,"#",";                *30
.                                           
.
          BRANCH    OBASTAT,FUSTB030,FUSTB040,FUSTB050,FUSTB060,FUSTB070
          WRITE     HTMLFILE;"#" #",";
          GOTO      FUSTB080
.
FUSTB030  WRITE     HTMLFILE;"#"Booked#",";
          GOTO      FUSTB080
.
FUSTB040  WRITE     HTMLFILE;"#"Not Used#",";
          GOTO      FUSTB080
.
FUSTB050  WRITE     HTMLFILE;"#"Extended#",";
          GOTO      FUSTB080
.
FUSTB060  WRITE     HTMLFILE;"#"Attended#",";
          GOTO      FUSTB080
.
FUSTB070  WRITE     HTMLFILE;"#"DNA#",";
          GOTO      FUSTB080
.
FUSTB080  WRITE     HTMLFILE;"#"",KEY3,"#",":              * 32
                             "#"",VOUTCODE,"#",";          * 33
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MATCH     ANSZ,TCINDC2                                           *34
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<font color=magenta>",OBAVISIT,"</font>#",";
          ELSE
            IF        BOOKSERS=1
              WRITE     HTMLFILE;"#"<font color=green>",OBAVISIT,"</font>#",";
            ELSE
              MATCH     ANSU,TCINDC6
              IF        @EQUAL
                WRITE     HTMLFILE;"#"<font color=red>",OBAVISIT,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",OBAVISIT,"#",";       * 34
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     ANSZ,TCINDC2                                           *35
          IF        @EQUAL
.           WRITE     HTMLFILE;"#"<font color=magenta>",VTYPDESC,"</font>#");"
            WRITE     HTMLFILE;"#"<font color=magenta>",VTYPDESC,"</font>#",";  
          ELSE
            IF        BOOKSERS=1
.             WRITE     HTMLFILE;"#"<font color=green>",VTYPDESC,"</font>#");"
              WRITE     HTMLFILE;"#"<font color=green>",VTYPDESC,"</font>#",";
            ELSE
              MATCH      ANSU,TCINDC6
              IF         @EQUAL
.               WRITE     HTMLFILE;"#"<font color=red>",VTYPDESC,"</font>#");"
                WRITE     HTMLFILE;"#"<font color=red>",VTYPDESC,"</font>#",";
              ELSE
.               WRITE      HTMLFILE;"#"",VTYPDESC,"#");"                    * 35
                WRITE      HTMLFILE;"#"",VTYPDESC,"#",";     
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#"";
          CALL      VICMNT00
          WRITE     HTMLFILE;"#",";
.
          MOVE      ZERO,COMTFLAG
          MOVE      "006",DIM3
          PACK      KEY14,OBAOUTNO,DIM3,SP70
          CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,FUSTB085
.
          MATCH     DOBAOUTN,VSCTVIST
          GOTO      FUSTB085 IF NOT EQUAL
.
          MATCH     DIM3,VSCTTYPE                * HIC claim comments
          GOTO      FUSTB085 IF NOT EQUAL
.
          MOVE      ONE,COMTFLAG
.
FUSTB085  WRITE      HTMLFILE;"#"",OBACOMP,"#",":     * 37 - claim code
                              "#"",COMTFLAG,"#",":    * 38 - claim comment flag
                              "#"",HIGHCOLR,"#",":    * 39 - highlight colours
                              "#"",ALREREXP,"#",":    * 40 - ref. expiry date
                              "#"",DISPHCST,"#",":    * 41 - claim status
                              "#"",DISPCMBS,"#",":    * 42 - cmbs item(s)
                              "#"",DISPBNUM,"#",";    * 43 - batch number
.
. Print checkbox: disable if batched (hcstflag=1)
.                 default to ticked if not printed (hcstflag<>2)
.                 default to unticked if incomplete claim details
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
FUSYB086  MOVE      ZERO,FORM1                        * 44 - print checkbox
          IF        HCSTFLAG=1
            WRITE     HTMLFILE;"#"<input type=checkbox name=clprt",DRECCNT:
                      " disabled>";
            GOTO      FUSTB100
          ENDIF
.
.          MATCH     "1",VIEWOPCL
.          IF        @EQUAL
            
FUSYB087   MOVE      HIGHCOLR,FORM1
           IF        (FORM1=1 | FORM1=2) & (HCSTFLAG<>2)
FUSTB090    WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=clprt":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",CASEKEYS,"'>";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=clprt",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",CASEKEYS,"'>";
          ENDIF
.
FUSTB100  WRITE      HTMLFILE;"#",#"",ALREVISN,"#",":    * 45 - Referral Number
                              "#"",ALREDEPT,"#",":       * 46 - Referral Number
                              "#"",DISPCLMN,"#",":       * 47 - Referral Dept
                              "#"",UMEDFLAG,"#",":       * 48 - Using med claims
                              "#"",OTHEADEP,"#",":       * 49 - A/H Departmetn  
                              "#"",OTHECENC,"#",":       * 50 - Collect Enc
                              "#"",ALENENCT,"#",":       * 51 - Linked Enc 
                              "#"",OBASRCR,"#",":        * 52 - source of ref
                              "#"",OBAOUTNO,"#",":       * 53 - Visit number
                              "#"",OCTDESC,"#",":        * 54 - Clinic Type
                              "#"",OCADESC,"#",":        * 55 - Clinic Name
                              "#"",OCTCTYP,"#",";        * 56 - Clinic Type Code
.
          IF        (OBASTAT=1) | (OBASTAT=4) | (OBASTAT=5)
.
            UNPACK    SP70,PMVXCONF
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11                * Read for Confirmed
.
            MATCH     "1",VIEWOPCL 
            IF        @EQUAL
              MATCH     "1",PMVXCONF                       * 57 - Confirmed
              IF        @EQUAL
                WRITE     HTMLFILE;"#"<input type=checkbox name=mcask",DRECCNT:
                         " checked disabled":
                         " onClick=UpdateConf(this); value='",CASEKEYS,"'>";
              ELSE
                WRITE     HTMLFILE;"#"<input type=checkbox name=mcask",DRECCNT:
                         " disabled":
                         " onClick=UpdateConf(this); value='",CASEKEYS,"'>";
              ENDIF
            ELSE   
              MATCH     "1",PMVXCONF                       * 57 - Confirmed
              IF        @EQUAL
                WRITE     HTMLFILE;"#"<input type=checkbox name=mcask",DRECCNT:
                         " checked":
                         " onClick=UpdateConf(this); value='",CASEKEYS,"'>";
              ELSE
                WRITE     HTMLFILE;"#"<input type=checkbox name=mcask",DRECCNT:
                         " onClick=UpdateConf(this); value='",CASEKEYS,"'>";
              ENDIF
            ENDIF   
          ELSE
            WRITE     HTMLFILE;"&nbsp";
          ENDIF
.
          WRITE     HTMLFILE;"#",#"";
          CALL      VCDM0000                               * 58 Visit Based CDM
.
.     *************************************************************************
.          CAR 160256 - Enhancement Specification
.                       adding extra fields to contact list
.     *************************************************************************
.
          WRITE     HTMLFILE;"#",#"",PADD1,"<br />",PADD2,"<br />":    * 59
                             PSUBRB,"<br />",PADD4,"<br />":           * 591
                             PPOST,"#",":                              * 59
                             "#"",PTMXADD1,"<br />",PTMXADD2,"<br />": * 60
                             PTMXADD3,"<br />",PTMXADD4,"<br />":      * 60
                             PTMXPOST,"#",";                           * 60
.
          PACK      DOCFNAME,SP70
          PACK      PMHGPNAM,SP70
.  
          MATCH     PMPXRHC1,SP70                                      * 61 
          IF        !@EQUAL
            PACK    KEY10,PMPXRHC1,SP70
            CALL    RDPMHCP1
            IF      OVRCD<>1
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ELSE
              MOVE      "&nbsp;",DOCFNAME
            ENDIF
          ENDIF
.
          MATCH     PMPXRH1G,SP70
          IF        !@EQUAL
              PACK      KEY12,PMPXRH1G,SP70
              CALL      RSPMHCG1
              CALL      RKPMHCG1
              IF        OVRCD=1
                MOVE     "&nbsp;",PMHGPNAM
              ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#"",DOCFNAME,"<br />",PMHGPNAM;
.          
          WRITE     HTMLFILE;"#",#"",CHARTREV;        * 62
.
          WRITE     HTMLFILE;"#",#"",HEIGHTCT;        * 63
          WRITE     HTMLFILE;"#",#"",ALERTST2;        * 64 
.
          MATCH     "1",OTHECPMI
          IF        @EQUAL
            WRITE     HTMLFILE;"#",#"",DISPDATE; 
          ELSE
            WRITE     HTMLFILE;"#",#"",DISPDATE;      * 65 
          ENDIF
          WRITE     HTMLFILE;"#",#"",DISPDATE;        * 66 
.
          WRITE     HTMLFILE;"#",#"",CONFRPMI;        * 67 
          WRITE     HTMLFILE;"#",#"",OTHECPAG;        * 68 
          WRITE     HTMLFILE;"#",#"",OTHECOM1,"<br>": 
                                     OTHECOM2;        * 69
          WRITE     HTMLFILE;"#",#"",OTHEINS1,"<br>":
                                     OTHEINS2,"<br>":
                                     OTHEINS3;        * 70
.
          MOVE      SP70,DISPCLHR
          MATCH     "1",OTBBCLHR
          IF        @EQUAL
            MOVE      "Yes",DISPCLHR                  * Clinical high risk
          ENDIF
.
          MOVE      SP70,DISPSRVD
          MATCH     SP70,OTBBSRVD
          IF        !@EQUAL
            PACK      KEY5,CATSD,OTBBSRVD,SP70  
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTBBSRVD,TDESC
            ENDIF
            MOVE    TDESC,DISPSRVD                    * Service Delivery Mode
          ENDIF
          CALL      OPDM0000                          * Check for OPD Messages
.
          WRITE     HTMLFILE;"#",#"",DISPCLHR;        * 71
          WRITE     HTMLFILE;"#",#"",DISPSRVD;        * 72
          WRITE     HTMLFILE;"#",#"",OPDMFLAG;        * 73
          WRITE     HTMLFILE;"#",#"",OTHEDURN;        * 74
          WRITE     HTMLFILE;"#",#"",OTBBDPTM,SP1,VOUTDESC; * 75
.
          WRITE     HTMLFILE;"#",#"",ZERO;            * 76
.
          MATCH     SP8,ALREVISN
          IF        !@EQUAL
            PACK      SAVKEY12,OCTSITE,OCTCTYP,SP70
.
            PACK      KEY12,ALREPSIT,ALRECTYP,SP70
            CALL      RDCTYA1                                           
            IF        OVRCD=0         
              WRITE     HTMLFILE;"#",#"",OCTDESC;    * 77              
            ELSE
              WRITE     HTMLFILE;"#",#"","Unknown Clinic";
            ENDIF
.
            MOVE      SAVKEY12,KEY12
            CALL      RDCTYA1          
          ELSE
            WRITE     HTMLFILE;"#",#"",SP1;
          ENDIF
.
          MATCH     "1",WACPMICH
          IF        !@EQUAL
            MATCH     "1",OTHECPMI
            IF        @EQUAL
                MATCH     OBADATE,PTMADCDT
                IF        @LESS
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=d_slotkeys ":
                            " onclick='CpmiError(this);'>";
                  GOTO      FUSTB104
                ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"#",#"<input type=checkbox name=slotkeys":
                    " value='":
                    OBASLOT,ALREVISN,OUTPATE,CASEKEYS,OBAURNO,OBASTAT,"'>"; *78
          ELSE 
.
            MATCH     "1",OTHECPMI
            IF        @EQUAL
                MATCH     OBADATE,PTMADCDT
                IF        @LESS
            WRITE     HTMLFILE;"#",#"<input type=checkbox name=slotkeys":
                    " value='":
                    OBASLOT,ALREVISN,OUTPATE,CASEKEYS,OBAURNO,OBASTAT,"'>":
                    "<input type=hidden name=confpmiw":
                    " value='":
                    OBAURNO,"'>"; *80
                  GOTO      FUSTB104
                ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"#",#"<input type=checkbox name=slotkeys":
                    " value='":
                    OBASLOT,ALREVISN,OUTPATE,CASEKEYS,OBAURNO,OBASTAT,"'>"; *78
.
          ENDIF
.
FUSTB104  PACK      HTMLLNK3,SP70,SP70      * Link to AH contacts
.
          MATCH     SP70,ALREVISN           * Any AH referral number
          GOTO      FUSTB105 IF EQUAL
.
          MATCH     "1",OTHECENC            * Collecting contacts
          GOTO      FUSTB105 IF NOT EQUAL
.
          MATCH     SP70,ALENENCT           * Linked contacts
          GOTO      FUSTB105 IF EQUAL
.
          REP       " +",OBAURNO
          REP       " +",ALREVISN
          REP       " +",ALREDEPT
          REP       " +",OUTPATE
.
          CLEAR     HTMLLNK3
          APPEND    "<img src=../images/CommentIcon.gif ",HTMLLNK3
          APPEND    "onclick=ListContacts('",HTMLLNK3
          APPEND    OBAURNO,HTMLLNK3
          APPEND    "','",HTMLLNK3
          APPEND    ALREVISN,HTMLLNK3
          APPEND    "','",HTMLLNK3
          APPEND     ALREDEPT,HTMLLNK3
          APPEND    "','",HTMLLNK3
          APPEND    ALREVISN,HTMLLNK3
          APPEND    OUTPATE,HTMLLNK3
          APPEND    "');>",HTMLLNK3
          RESET     HTMLLNK3
.
          REP       "+ ",OBAURNO
          REP       "+ ",ALREVISN
          REP       "+ ",ALREDEPT
          REP       "+ ",OUTPATE
.
FUSTB105  WRITE     HTMLFILE;"#",#"",HTMLLNK3;                       * 79
.
          PACK      HTMLLNK4,SP70,SP70      * Link to series bookings
.
          PACK      KEY24,OBAURNO,OUTPATE,SP70   * Is this a master
          CALL      RDOTLKB1                     * series record
          COMPARE   ONE,OVRCD       
          GOTO      FUSTB120 IF NOT EQUAL
.
          PACK      KEY24,OBAURNO,OUTPATE,SP70   * Is this a child
          CALL      RSOTLKB2                     * series booking
          CALL      RKOTLKB2
          BRANCH    OVRCD,FUSTB200
.
          MATCH     OBAURNO,OTLKURNO
          GOTO      FUSTB200 IF NOT EQUAL
.
          MATCH     OUTPATE,OTLKLBOK
          GOTO      FUSTB200 IF NOT EQUAL
.
FUSTB120  REP       " +",OTLKURNO
          REP       " +",OTLKOBOK
          REP       " +",OUTPATE

          CLEAR     HTMLLNK4
          APPEND    "<img src=../images/CommentIcon.gif ",HTMLLNK4
          APPEND    "onclick=SeriesLink('",HTMLLNK4
          APPEND    OTLKURNO,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    OTLKOBOK,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    OUTPATE,HTMLLNK4
          APPEND    "');>",HTMLLNK4
          RESET     HTMLLNK4
.
          REP       "+ ",OTLKURNO
          REP       "+ ",OTLKOBOK
          REP       "+ ",OUTPATE
.
FUSTB200  WRITE     HTMLFILE;"#",#"",HTMLLNK4;                 * 80
          MOVE      ZERO,SAVFORM1
          MOVE      FORM1,SAVFORM1
.
          WRITE     HTMLFILE;"#",#"",DISALRIN:                 * 81
                             "#",#"",CURRINPT,CURREMRP;        * 82
.
          MOVE      SP70,DISPHFND
          MATCH     SP70,OTBBFUND
          IF        !@EQUAL
            STRIP     OTBBFUND
            STRIP     OTBBTBLE
            PACK      DISPHFND,BREAK,OTBBFUND,SLASH,OTBBTBLE,SP70
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",OBACOMP,DISPHFND;         * 83
.
          PACK      KEY5,OBAOUTNO,SP70
          CALL      RDOTPRC1
          IF        OVRCD=1
            CALL      CLOUTPRC
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",OTPRDESC:                 * 86 Procedures
                             "<br>",OTPRDES2:
                             "<br>",OTPRDES3:
                             "<br>",OTPRDES4:
                             "<br>",OTPRDES5;
.
          WRITE     HTMLFILE;"#",#"";                          * 87 Problems
.
          PACK      KEY21,OBASITE,OBACTYP,OTPRPRB1,SP70
          CALL      RDOTCPB1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OTPBDESC;
          ENDIF
.
          PACK      KEY21,OBASITE,OBACTYP,OTPRPRB2,SP70
          CALL      RDOTCPB1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<br>",OTPBDESC;
          ENDIF
.
          PACK      KEY21,OBASITE,OBACTYP,OTPRPRB3,SP70
          CALL      RDOTCPB1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<br>",OTPBDESC;
          ENDIF
.
          WRITE     HTMLFILE;"#",#"";
.
          IF        PTCNHDPS=1
.
            MATCH     "1",OTMACENC
.           GOTO      FUSTB300 IF NOT EQUAL
            IF        !@EQUAL
              MATCH     "2",OTMACENC
              IF        !@EQUAL
                GOTO      FUSTB250 IF NOT EQUAL
              ENDIF
            ENDIF
.
            MATCH     DOBAOUTN,ALLNLNKV
            GOTO      FUSTB250 IF NOT EQUAL
.
            WRITE     HTMLFILE;"<input type=checkbox name=addcn",DRECCNT:
                      " onclick='this.checked=false;AddEnc(this.value);'":
" value='",OBAURNO,ALLNVISN,ALREDEPT,ALRESTAT,OBADATE,OBATIME,OTMADEFD,"'>";

            MATCH     "0",OTCNTMES                * display contact times NO
            GOTO      FUSTB250 IF EQUAL
.
.           Display Time of Contacts linked to the referral                   
.           Match date of the Outpatient Clinic
.           Only display Contacts(Active) 
.
            MOVE      ZERO,CONTCNTR
            PACK      KEY32,ALLNVISN,OBADATE,SP70
            CALL      RSALENC6
FUSTB230    CALL      RKALENC6
            BRANCH    OVRCD,FUSTB250
.
            MATCH     ALENSDAT,OBADATE            * contacts outpatient date?
            GOTO      FUSTB250 IF NOT EQUAL       * exit if not a match
.           
            MATCH     "1",ALENRSTA                * cancelled?
            GOTO      FUSTB230 IF EQUAL           * skip 

            UNPACK    ALENSTIM,DIMHRS,DIM1A,DIMMIN * hh:mm format
.
            ADD       ONE,CONTCNTR                * First 3 contacts

            MATCH     "2",OTCNTMES                * display and redirect YES
            IF        @EQUAL                
              WRITE     HTMLFILE;"<br><a href='":
                               "allweb02.pbl?reportno=02&template=002":
                               "&urnumber=",OBAURNO:
                               "&admissno=",ALLNVISN:
                               "'>",DIMHRS,DIM1A,DIMMIN,"</a>";
            ENDIF

            MATCH     "1",OTCNTMES                * display and redirect NO 
            IF        @EQUAL
              WRITE     HTMLFILE;"<br>",DIMHRS,DIM1A,DIMMIN;
            ENDIF

            MATCH     "0",OTCNTMES                * display NO times
            IF        @EQUAL
              WRITE     HTMLFILE;"<br>";
            ENDIF

            IF        CONTCNTR<=2
              GOTO      FUSTB230                  * Display 3 contacts
            ENDIF
          ENDIF
.
FUSTB250  WRITE     HTMLFILE;"#",#"";
.
          MATCH     "1",OTCNDCCC
          IF        @EQUAL
            WRITE     HTMLFILE;OBASTAT;
          ENDIF
.
FUSTB300  CALL      DOMCLR00                       * Get Demographic date color
.
.         Checks to see if there is an ACC/WC Number related to the appointment
.         Retrieves it from the BD if there is
.
FUSTB310  MOVE      SP70,KEY8
          PACK      KEY8,OUTPATE,SP70
          CALL      RDWCOM1                        * Checks WC DB for claim
          IF        OVRCD=1
            CALL      CLPATWC1                     * Clears value if there isn;t
          ENDIF
.
.         Checks to see if there is an ACC/WC Number related to the appointment
.         Retrieves the accident date if there is
.
FUSTB320  MOVE      SP70,KEY8
          MOVE      SP70,ACCDAT00
          CALL      CLPATWC1
          PACK      KEY8,OUTPATE,SP70
          CALL      RDWCOM1
          MATCH     SP70,WCACDAT
          GOTO      FUSTB400 IF EQUAL
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCDAT00,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR


FUSTB400  WRITE     HTMLFILE;"#",#"",ZERO;            * 88
          WRITE     HTMLFILE;"#",#"",REFXWCLS;        * 89
          WRITE     HTMLFILE;"#",#"",REFXWDAT;        * 90
          WRITE     HTMLFILE;"#",#"",DOMCOLOR;        * 91 
          WRITE     HTMLFILE;"#",#"<span class=TextBlue>",WCCLMNO;      * 92 
          WRITE     HTMLFILE;"</span>#",#"<span class=TextBlue>",ACCDAT00; * 93 
          WRITE     HTMLFILE;"</span>#");"                                 
.
          MOVE      SAVFORM1,FORM1
          IF        (FORM1=1 | FORM1=2) & (HCSTFLAG<>2)
            WRITE     HTMLFILE;" UpdateArray('",CASEKEYS,"');" * Array from
          ENDIF                                       
.
          GOTO      FUSTB999
.
FUSTB999  RETURN
.
.-----------------------------------------------------------------------------
. Check if demographic confirm date is less than the current date minus the 
. system parameter number of days. If it is, returns DOMCOLOR = "Red",
. otherwise, returns DOMCOLOR = ""  
.-----------------------------------------------------------------------------
DOMCLR00  MOVE      SP70,DOMCOLOR
.
          MATCH     SP70,PTMADCDT
          GOTO      DOMCLR99 IF EQUAL
. 
          BRANCH    WAHSPEED,DOMCLR99       * Skip not required at wahealth
. 
          MOVE      "OTCFDRED",CPARPARM
          MOVE      IBCNMHOS,CPARMHOS
          MOVE      USERID,CPARUSER
          CALL      GTCMPA00
          BRANCH    CPARERRO,DOMCLR99
.    
          MATCH     ANSY,CMPAVALU 
          GOTO      DOMCLR99 IF NOT EQUAL 
.
          MOVE      "OTCFDDAY",CPARPARM
          CALL      GTCMPA00
          BRANCH    CPARERRO,DOMCLR99
.
          SQUEEZE   CMPAVALU
          MOVE      CMPAVALU,DIM3
          SQUEEZE   DIM3
          MOVE      ZERO,F3
          MOVE      DIM3,F3
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",DIM8
          MOVE      DIM8,CALCDATE
          SUB       F3,CALCDATE    
.
DOMCLR50  MATCH     CALCDATE,PTMADCDT
          IF        @LESS 
            MOVE      "Red",DOMCOLOR
          ENDIF
.
          GOTO      DOMCLR99
.
DOMCLR99  RETURN
+
.-----------------------------------------------------------------------------.
. Display first CMBS Item (if any)
.-----------------------------------------------------------------------------.
DCMBS000  PACK      DISPCMBS,SP70
          PACK      KEY10,OBAOUTNO,SP10
          CALL      RSOTBIT1
DCMBS100  CALL      RKOTBIT1
          BRANCH    OVRCD,DCMBS999
.
          MATCH     DOBAOUTN,OTBIVISN
          GOTO      DCMBS999 IF NOT EQUAL   * Different visit number
.
          MOVE      OTBIITMC,FORM2
          IF        FORM2 > 1
            MOVE      DISPCMBS,DIM9
            PACK      DISPCMBS,HASH,DIM9,SP70    * multiple items exist
            GOTO      DCMBS999
          ENDIF
          PACK      DISPCMBS,OTBIITMN,SP70  * one item exists
          GOTO      DCMBS100
.
DCMBS999  RETURN
+
.-----------------------------------------------------------------------------.
. Set table highlight/expiry colours
. HIGHCOLR - 0 = Red, 1 = Green, 2 = Orange, 3 = Poo
.-----------------------------------------------------------------------------.
SETX0000  MOVE      SP1,HIGHCOLR            * initialise to blank
          MOVE      ZERO,UMEDFLAG           * Using medclaims
.
          MATCH     "1",IBCNUMCI            * Using meclaims system
          GOTO      SETX1000 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI            * Clinic Using meclaims 
          GOTO      SETX1000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSI,OTHECIND,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETX1000
.
          MATCH     "P",TCINDC1
          IF        @EQUAL
            MOVE      ONE,UMEDFLAG          * Using medclaim in this clinic
          ENDIF
.
SETX1000  MATCH     "011",TEMPLATE
          GOTO      SETX9999 IF NOT EQUAL
.
          MOVE      ONE,HIGHCOLR            * set col=green
.
          PACK      KEY5,ANSC,ANSI,OTHECIND,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETX9999
.
          MATCH     ANSP,TCINDC1            * only highlight ffs clinics
          GOTO      SETX9999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETX9999
.
          MATCH     ANSC,TCINDC3            * only highlight medicare patients
          GOTO      SETX5000 IF NOT EQUAL
.
          MATCH     SP70,ALRERTYP           * If no referral type, col=red
          IF        @EQUAL
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,DISPCMBS           * If no cmbs items, col=red
          IF        @EQUAL
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PMEDI              * If no medicare number, col=red
          IF        @EQUAL
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PTMXMCCD           * If no medicare ref number, col=red
          IF        @EQUAL
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PMPXMEDC           * If no medicare expiry date,col=red
          IF        @EQUAL
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
. Check referral expiry date
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      SETX9999 IF EQUAL
.
          MATCH     ALREREXP,OBADATE        * If expiry<=Clinic date, col=red
          IF        !@LESS
            MOVE      ZERO,HIGHCOLR
            GOTO      SETX9999
          ENDIF
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETX9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      SETX9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    OBADATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     TWO,HIGHCOLR
          ENDIF
          GOTO      SETX9999
.
. Check for unexpected claim code
.
SETX5000  MATCH     "2",TCINDC9             * public?
          GOTO      SETX6000 IF EQUAL
.
          MATCH     "1",TCINDC1             * international?
          GOTO      SETX6000 IF EQUAL
.
          MOVE      ZERO,FORM2
SETX5500  ADD       ONE,FORM2
          COMPARE   SIX,FORM2               * wcomp, tac or dva?
          GOTO      SETX9999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      SETX6000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      SETX6000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      SETX6000 IF EQUAL
          GOTO      SETX5500
.
SETX6000  MOVE      THREE,HIGHCOLR          * unexpected claim code
.
SETX9999  RETURN
+
.-----------------------------------------------------------------------------.
. Get HIC claim status
.-----------------------------------------------------------------------------.
GHCST000  PACK      DISPHCST,SP70           * claim status
          PACK      DISPBNUM,SP70           * batch number
          PACK      DISPCLMN,SP70           * claim number
          MOVE      ZERO,HCSTFLAG           * claim status flag
.
          BRANCH    WAHSPEED,GHCST999       * Skip not required at wahealth
.
          PACK      KEY16,OBAOUTNO,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * read last hic claim record
          BRANCH    OVRCD,GHCST999
.
          MATCH     DOBAOUTN,HCCLVISN
          GOTO      GHCST999 IF NOT EQUAL   * Different visit number
.
          MATCH     " 0",HCCLSTAT
          IF        @EQUAL
            MOVE      "Printed",DISPHCST    * claim for visit is printed
            MOVE      TWO,HCSTFLAG          * claim is printed
          ENDIF
.
          MATCH     " 1",HCCLSTAT
          IF        @EQUAL
            MOVE      "Batched",DISPHCST    * claim for visit is batched
            MOVE      ONE,HCSTFLAG          * claim is batched
          ENDIF
          MOVE      HCCLBTCH,DISPBNUM       * display batch number
          MOVE      HCCLCLMN,DISPCLMN       * display claim number
.
GHCST999  RETURN
+
.------------------------------------------------------------
. Update the DNA reason and outcome if defaults exist
.------------------------------------------------------------
DNON0000  MOVE      SP70,DEFTOUTC           * Default outcome
          MOVE      SP70,DEFTATTN           * Default attendance code
.
          PACK      KEY5,ANSO,ANSZ,SP70
          CALL      RDSCODE1
DNON1000  CALL      RDKCODE1
          BRANCH    OVRCD,DNON3000
.
          MATCH     "OZ",TCODE
          GOTO      DNON3000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                      * Skip inactive codes
          GOTO      DNON1000 IF EQUAL
.
          MATCH     ANSD,TCINDC3                      * Default code
          GOTO      DNON1000 IF NOT EQUAL
.
          MOVE      ACODE,DEFTOUTC
.
DNON3000  PACK      KEY5,ANSC,ANSA,SP70
          CALL      RDSCODE1
DNON4000  CALL      RDKCODE1
          BRANCH    OVRCD,DNON5000
.
          MATCH     "CA",TCODE
          GOTO      DNON5000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                      * Skip inactive codes
          GOTO      DNON4000 IF EQUAL
.
          MATCH     ANSD,TCINDC1                      * Default code
          GOTO      DNON4000 IF NOT EQUAL
.
          MOVE      ACODE,DEFTATTN
.
DNON5000  MATCH     SP70,DEFTOUTC
          IF        @EQUAL
            MATCH     SP70,DEFTATTN         * Exit no default codes setup
            GOTO      DNON9999 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,DNON9999
.
          MOVE      DEFTOUTC,OTBBOUTC       * Update outcome
          MOVE      DEFTATTN,OBAATTN        * Update attendance code
.
          CALL      UPBOKB1
.
DNON9999  RETURN
+
.*******************************************************************************
. Update Time UPDATETY 1-5
. 1. OTBBCITM  DIM       5        5        210  Check In Time
. 2. OTBBASTM  DIM       5        5        215  Time Actually Seen
. 3. OTBBDPTM  DIM       5        5        220  Time of Departure
. 4. OTBBTMFS  DIM       8        8        134  Time First Seen
. 5. OTBBTMBO  DIM       8        8        142  Time Booked Out
.*******************************************************************************
UPDTIM00  MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,UPDTIM95,UPDTIM93
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1 
          BRANCH    OVRCD,UPDTIM96
.
          CLOCK     TIME,CTIMEIS
          MOVE      ZERO,F1
          MOVE      UPDATETY,F1
          STORE     CTIMEIS,F1,OTBBCITM,OTBBASTM,OTBBDPTM,OTBBTMFS,OTBBTMBO
.
          CALL      UPBOKB1                  * Update the booking
          CALL      UUOTBOA1
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
          CALL      WINCLS00
.          MOVE      TWO,REPORTNO
          MOVE      ONE,EXIT
.          MOVE      CASEKEYS,SESSKEYS
          GOTO      UPDTIM99
.
UPDTIM93  MOVE      "Booking Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTIM99
.
UPDTIM95  MOVE      "Invalid Case ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTIM99
.
UPDTIM96  MOVE      "Invalid Booking Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTIM99
.
UPDTIM99  RETURN
.*******************************************************************************
.                        Update Session Details
.*******************************************************************************
UPDSES00  BRANCH   UPDATETY,UPDSES05,UPDSES10,UPDSES15,UPDSES20,UPDSES25:
                            UPDSES30,UPDSES35,UPDSES40,UPDSES45,UPDSES50:
                            UPDSES60,UPDSES65,UPDSES70,UPDSES75,UPDSES80:
                            UPDSES85,UPDSES90,UPDSES95
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDSES99
.
UPDSES05  CALL      ADDSLT00    * Add New Slot to a Session
          BRANCH    EXIT,UPDSES99
.
          GOTO      UPDSES98
.
UPDSES10  CALL      DELSLT00    * Delete Empty Slot from A Session
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98
.
UPDSES15  CALL      UNASLT00    * Make an Empty Slot unavailable from a Session
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98      
.
UPDSES20  CALL      UPDSLT00                * Update visit type.
          BRANCH    EXIT,UPDSES99
          CALL      RCAL0000                * Recalculate session slot stats
          GOTO      UPDSES98
.
UPDSES25  CALL      RSHSLT00
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98 
.
UPDSES30  CALL      AVASLT00    * Make an Empty Slot Available from a Session
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98      
.
UPDSES35  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          MOVE      OTSES001,OSESCSTT
          MOVE      OTSESCOM,OSESCOMM
          CALL      UPSESA1
          CALL      NXTPAG00                
          GOTO      UPDSES99
.
UPDSES40  CALL      RSHAPP00
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98
.
UPDSES45  CALL      PRODNA00                * HPS-ODC Added 
          BRANCH    EXIT,UPDSES99
          GOTO      UPDSES98
.
UPDSES50  CALL      SUSSES00     
          CALL      NXTPAG00                
          GOTO      UPDSES99
.
UPDSES60  CALL      OVRTIM00               * Update over bookings slot time
          BRANCH    EXIT,UPDSES99
.
          GOTO      UPDSES98
.
UPDSES65  CALL      UPDUSG00                * Update session usage details
.
          CALL      NXTPAG00
          GOTO      UPDSES99
.
UPDSES70  CALL      ATTSLT00                * Attend selected patients
.
          MOVE      SESSKEYS,SAVSKEYS
          CALL      RCAL0000                * Recalculate slot counts
.
          COMPARE   ZERO,WARNCNT
          GOTO      UPDSES98 IF EQUAL       * No warning message
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      UPDSES99
.
UPDSES75  CALL      DEPSLT00                * Depart selected patients
.
          MOVE      SESSKEYS,SAVSKEYS
          CALL      RCAL0000                * Recalculate slot counts
.
          COMPARE   ZERO,WARNCNT
          GOTO      UPDSES98 IF EQUAL       * No warning message
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      UPDSES99
.
UPDSES80  CALL      FOLSLT00                * Re-Appoint selected patients
.
          MOVE      NEWSKEYS,SAVSKEYS
          CALL      RCAL0000                * Recalculate slot counts
.
          COMPARE   ZERO,WARNCNT
          GOTO      UPDSES98 IF EQUAL       * No warning message
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
.
          GOTO      UPDSES99
.
UPDSES85  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          MOVE      OTSESHCP,OSESGHCP
          CALL      UPSESA1
          CALL      NXTPAG00
          GOTO      UPDSES99
.
UPDSES90  CALL      DISSLT00                * Discharge selected patients
.
          MOVE      SESSKEYS,SAVSKEYS
          CALL      RCAL0000                * Recalculate slot counts
.
          COMPARE   ZERO,WARNCNT
          GOTO      UPDSES98 IF EQUAL       * No warning message
.         
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT                
          GOTO      UPDSES99
.
UPDSES95  CALL      TIMSLT00                * Bulk time seen selected patients
.
          MOVE      SESSKEYS,SAVSKEYS
          CALL      RCAL0000                * Recalculate slot counts
.
          COMPARE   ZERO,WARNCNT
          GOTO      UPDSES98 IF EQUAL       * No warning message
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      UPDSES99

.
UPDSES98  CALL      OPENHTML
          BRANCH    EXIT,UPDSES99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
          GOTO      UPDSES99
.
UPDSES99  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          RETURN
.------------------------------------------------------------
. Suspend Session  
.------------------------------------------------------------
SUSSES00  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SUSSES99
.
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
          CALL      RPOTMSP1
          BRANCH    OVRCD,SUSSES10
          MATCH     OSESITE,OTMSSITE
          GOTO      SUSSES10 IF NOT EQUAL
          MATCH     OSECLIN,OTMSCLIN
          GOTO      SUSSES10 IF NOT EQUAL
          MOVE      OSEDAY,ANS
          MATCH     ANS,OTMSDOWK
          GOTO      SUSSES10 IF NOT EQUAL
.
          MOVE      OTMSSUSP,F3
          ADD       ONE,F3
          GOTO      SUSSES20 
.
SUSSES10  MOVE      ONE,F3
.
SUSSES20  MOVE      OSESITE,OTMSSITE
          MOVE      OSECLIN,OTMSCLIN
          MOVE      OSEDAY,OTMSDOWK
          MOVE      OSESTRT,OTMSSTIM
          MOVE      F3,OTMSSUSP
          MOVE      OSEDATE,OTMSFDAT   
          MOVE      OSEDATE,OTMSTDAT
          MOVE      OSEDATE,OTMSRFDT        * Set Susp Range From Date
          MOVE      OSEDATE,OTMSRTDT        * Set Susp Range To Date
          MOVE      OTSES002,OTMSREAS
          PACK      OTMSEDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTMSEDAT
          CLOCK     TIME,OTMSETIM
          MOVE      USERID,OTMSEUID
          PACK      KEY24,OTMSSITE,OTMSCLIN,OTMSDOWK,OTMSSUSP,OTMSFDAT
          CALL      RDOTMSP1
          IF        OVRCD=0
            ADD       ONE,F3
            GOTO      SUSSES20
          ENDIF
          CALL      WROTMSP1
.
          CALL      SLTSUS00
.
SUSSES99  RETURN
.--------------------------------------------------------------------
. Update session usage details
.--------------------------------------------------------------------
UPDUSG00  PACK      KEY25,SESSKEYS,SP70
          CALL      RDUSEA1
          IF        OVRCD=1
            UNPACK    SESSKEYS,OUSSITE,OUSCLIN,OUSDATE,OUSSTRT
            CALL      MOVUSE00              * Move cgi vars to file vars
            MOVE      SP70,OUSSPARE
            CALL      WRUSEA1
          ELSE
            CALL      MOVUSE00              * Move cgi vars to file vars
            CALL      UPUSEA1
          ENDIF

UPDUSG99  RETURN
.--------------------------------------------------------------------
. Move cgi vars to OUTUSEFD file vars
.--------------------------------------------------------------------
MOVUSE00  MATCH     Z70,OTUSE001
          IF        !@EQUAL
            MOVE      OTUSE001,OUSACST
          ENDIF
.
          MATCH     Z70,OTUSE002
          IF        !@EQUAL
            MOVE      OTUSE002,OUSACEND
          ENDIF
.
          MATCH     Z70,OTUSE003
          IF        !@EQUAL
            MOVE      OTUSE003,OUSDLY
          ENDIF
.
MOVUSE99  RETURN
.--------------------------------------------------------------------
. Clear OUTUSEFD file vars
.--------------------------------------------------------------------
CLUS0000  MOVE      SP70,OUSSITE
          MOVE      SP70,OUSCLIN
          MOVE      SP70,OUSDATE
          MOVE      SP70,OUSSTRT
          MOVE      SP70,OUSACST
          MOVE      SP70,OUSACEND
          MOVE      SP70,OUSDLY
          MOVE      SP70,OUSSPARE
.
CLUS9999  RETURN
.--------------------------------------------------------------------
. Change the Status(DOBASTAT) in the Outboaaf table
.--------------------------------------------------------------------
SLTSUS00  PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
SLTSUS10  CALL      RDKBOKA1
          BRANCH    OVRCD,SLTSUS99
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      SLTSUS99 IF NOT EQUAL   * different sessio
.
          IF        (OBASTAT=1|OBASTAT=0)
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
            CALL      RLOTBOA1
            MOVE      "6",OBASTAT
            CALL      UPBOKA1
            CALL      UUOTBOA1
            GOTO      SLTSUS10
          ENDIF
.
          COMPARE   FOUR,OBASTAT
          GOTO      SLTSUS10 IF EQUAL
          COMPARE   FIVE,OBASTAT
          GOTO      SLTSUS10 IF EQUAL
.
          GOTO      SLTSUS10
.
SLTSUS99  RETURN
.------------------------------------------------------------
. Process DNA for a Session                 * HPS CODE Starts
. Process DNA if all session start times are in the past
.------------------------------------------------------------
PRODNA00  PACK      KEY28,SESSKEYS,Z70  * Key for the record to DNA
          CALL      RDSBOKA1             
PRODNA10  CALL      RDPBOKA1             
          BRANCH    OVRCD,PRODNA99      
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     KEY28,SESSKEYS
          GOTO      PRODNA99 IF NOT EQUAL
          COMPARE   ONE,OBASTAT              * Is this a SUSPENDED booking ?
          GOTO      PRODNA10 IF NOT EQUAL
.
PRODNA20  UNPACK    SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT
          PACK      NONATNDT,CCC,CYY,CMM,CDD
          REP       " 0",NONATNDT
          CLOCK     TIME,CTIMEIS
          MOVE      OBADATE,CDYSTDTE       * Validates the Inactivate Date
          MOVE      NONATNDT,CDYSFDTE
.
          MATCH     NONATNDT,OBADATE       * OK session is in the past
          GOTO      PRODNA30 IF LESS
.
          CALL      CALCDAYS
          IF        CDYSDAYS > 0
            IF        CDYSDAYS=1
              MATCH     OBATIME,CTIMEIS
              GOTO      PRODNA90 IF LESS   * Slot start time must be in the past
              GOTO      PRODNA30
            ELSE
              GOTO      PRODNA90
            ENDIF
          ENDIF                             * HPS_ODC Ends Here
.
PRODNA30  MOVE      TWO,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          MOVE      FIVE,OBASTAT
          CALL      UPBOKA1
          MOVE      THREE,AUDIFLAG              * set flag to write a c audit
          CALL      AUDOTBOA                    * write audit
.
          CALL      DNON0000                 * Update DNA reason and outcome
          CALL      DHIC0000                 * Delete HIC CMBS items (if any)
          CALL      PNTX0000                 * DNA referral expiry update
          GOTO      PRODNA10
.
PRODNA90  MOVE      "No update for session dates in future",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRODNA99
.
PRODNA99  RETURN                           
.
.*******************************************************************************
.                      OVRTIM00: UPDATE VISIT TYPE
.*******************************************************************************
OVRTIM00  MATCH     Z70,UPDSLTNO
          GOTO      OVRTIM90 IF EQUAL
.
          PACK      KEY28,SESSKEYS,UPDSLTNO,SP70
          CALL      RDBOKA1                        * Position on old slot
          BRANCH    OVRCD,OVRTIM90                 * Finished updating record
.
          MATCH     Z70,UPDSLTIM
          IF        !@EQUAL
            MOVE     UPDSLTIM,OBATIME
          ENDIF
.
          CALL      UPBOKA1
.
          MOVE      ZERO,EXIT
          GOTO      OVRTIM99
.
OVRTIM90  MOVE      "Invalid Slot Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OVRTIM99
.
OVRTIM99  RETURN
+
.*******************************************************************************
.                       Delete Slot From Session
.*******************************************************************************
DELSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot to be deleted
.
DELSLT10  COMPARE   "99",SLOTCNT
          GOTO      DELSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      DELSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      DSLT0000
          BRANCH    EXIT,DELSLT95
          GOTO      DELSLT10
.
DELSLT90  MOVE      ZERO,EXIT
          GOTO      DELSLT99
.
DELSLT95  MOVE      ONE,EXIT
.
DELSLT99  RETURN
.                                           *** HPS Code Starts Here ***
.******************************************************************************
.                  Reschedule suspended appointments 
.******************************************************************************
RSHAPP00  MOVE      ZERO,MARKCNT      * Loop through each slot to be updated 
RSHAPP10  ADD       ONE,MARKCNT
          IF        MARKCNT>MARKINDX
            GOTO      RSHAPP90
          ENDIF
          PACK      CASEKEYS,MARKKEYS[MARKCNT]
          PACK      SESSKEYS,MARKKEYS[MARKCNT]
          CALL      RSHA0000
          BRANCH    EXIT,RSHAPP95
          GOTO      RSHAPP10
.
RSHAPP90  MOVE      NEWSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "To" session
          MOVE      ZERO,EXIT
          GOTO      RSHAPP99
.
RSHAPP95  MOVE      NEWSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "To" session
          MOVE      ONE,EXIT
.
RSHAPP99  RETURN
.
RSHA0000  PACK      KEY28,CASEKEYS,SP70  * Key for the record to reschedule
          MOVE      KEY28,SESSKEYS
          CALL      RDBOKA1              * Just validate the record first
          BRANCH    OVRCD,RSHA9000       * Record has disappeared
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,RSHA9000
.
          MOVE      OBAVISIT,NEWVTYP     * New Visit Type
          MOVE      OBAVISIT,OUTBB047    * New Visit Type
.
          COMPARE   SIX,OBASTAT          * Is this a SUSPENDED booking ?
          GOTO      RSHA9004 IF NOT EQUAL
.
          MOVE      OBAURNO,SAVEURNO     * save U/R
.
          MOVE      SP70,SAVEREFN           * Clear linked AH referral number
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,RSHA0500          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      RSHA0500 IF NOT EQUAL
.
          MOVE      ALLNVISN,SAVEREFN       * Linked AH referral number
.
RSHA0500  MATCH     SP70,SAVEREFN           * Check if referral mandatory
          GOTO      RSHA0700 IF NOT EQUAL   * for clinic
.
          MOVE      NEWSKEYS,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,RSHA0700
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RSHA0700
.
          MATCH     "1",OTHEMREF           
          IF        @EQUAL
            MOVE      ZERO,EXIT             * Skip this booking a referral
            GOTO      RSHA9999              * is mandatory
          ENDIF
.
RSHA0700  MOVE      ZERO,EXIT
          PACK      KEY28,NEWSKEYS,SP70
          CALL      RDBOKA1
          COMPARE   ZERO,OVRCD
          GOTO      RSHA1100 IF EQUAL
.
RSHA1000  CALL      RDKBOKA1
          BRANCH    OVRCD,RSHA9300
.
RSHA1100  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY25,NEWSKEYS
          GOTO      RSHA9300 IF NOT EQUAL 
.
          COMPARE   ZERO,OBASTAT
          GOTO      RSHA1000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RSHA1000
.
          MATCH     ANSU,TCINDC6                 * Skip unavailable slots
          GOTO      RSHA1000 IF EQUAL
.
          MATCH     ANSZ,TCINDC2                 * Skip
          GOTO      RSHA1000 IF EQUAL
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      NEWSLOTK,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          MOVE      OBAVISIT,OLDVTYP
.
          MOVE      SAVEURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 1
            CALL      CLPATMAS
          ENDIF
          MOVE      SAVEURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL      CLPMSPX2
          ENDIF
.
.         Check if we need to send an A38 cancellation message for
.         a reschedule.  If so, we need to re-read the original booking record
.         and send the cancellation, then reposition on the new booking record
.         again.
.
          PACK      NEWKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            MOVE      CASEKEYS,KEY28
            CALL      RDBOKA1                * re-read original booking record
            BRANCH    OVRCD,RSHA9000         * record has disappeared
.
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY7,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOC               * DG O/P Cancel Appoint
.
            MOVE      NEWKEY28,KEY28
            CALL      RDBOKA1                * reposition on new booking record
            BRANCH    OVRCD,RSHA9000         * record has disappeared
          ENDIF
.
          CALL      LOGR0000              * Log the rescheduling
          CALL      PRFL0000              * update outrf1af
.
          CALL      WBKA0000              * Write the new booking
          BRANCH    EXIT,RSHA9008
.
          CALL      PMIGTNID               * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            MOVE      TWENTY8,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICON             * DG O/P New Appoint.
          ELSE
            MOVE      TWENTY3,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOB    * Send Change O/P Booking Details message
          ENDIF
.
          CALL      UWAT0000              * Update waiting list link booking PAC
          CALL      UWAI0000              * Update waiting list link booking PAS
.
          CALL      ULNK0000              * Update allied health link booking
          CALL      UMBS0000              * Update cmbs item table
          CALL      UTRN0000              * Update Transport Details
          CALL      UCLM0000              * Update claim details
.                                                                   * CAR 270888
          PACK      KEY8,OBAOUTNO,SP10
          CALL      DEPMCUR1              * Remove existing Curr Patient Record
          CALL      WRCPAT00              * Re-instate Current Patient Record
.
          CALL      DBOK0000              * Delete the old booking
.
          CALL      BOKUPD00
.
RSHA8900  MOVE      ZERO,EXIT
          CALL      UUOTBOA1
.
          MATCH     "1",LETPRT06           * Print re-schedule letter 
          GOTO      RSHA9999 IF NOT EQUAL
          MOVE      LETPSL06,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "6",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARSLT
          GOTO      RSHA9999 IF EQUAL
          MOVE      OTMARSLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
          GOTO      RSHA9999
.
RSHA9000  CLEAR     WEBTITLE
          APPEND    "Invalid Case Key ",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9004  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            MOVE      "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            MOVE      "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9005  MOVE      "Invalid Case Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9006  MOVE      "Invalid Booking Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9008  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "New Slot Key is Reserved or Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9300  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "No more slots available in Session.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHA9999
.
RSHA9999  RETURN
.*******************************************************************************
.             DSLT0000: Delete an empty slot from the bookings file 
.*******************************************************************************
DSLT0000  PACK      KEY28,CASEKEYS,SP70      * Key for the record to delete
          UNPACK    KEY28,SESSKEYS,VSLOT     * Key for the record to delete
          CALL      RDBOKA1                  * Just validate the record first
          BRANCH    OVRCD,DSLT9000           * Record has disappeared
.
          COMPARE   NINE,OBASTAT             * Is thsi slot Reserved?
          GOTO      DSLT9200 IF EQUAL        * Yes, can not delete
.
          COMPARE   ZERO,OBASTAT             * Make sure slot is empty
          GOTO      DSLT9100 IF NOT EQUAL    * Slot is not empty
.
          MATCH     ZEROVISN,OBAOUTNO        * Extra check, just to be sure
          GOTO      DSLT9100 IF NOT EQUAL    * Slot is not empty
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      DEBOKA1                  * Delete the record
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      DEOTBOX1
.
          MOVE      FOUR,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOA                 * write the audit
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBSCH00                 * Increment Booking Count
.
.         Now scan forward for any extended slots that should also be deleted
.
DSLT1000  PACK      KEY28,CASEKEYS,SP70      * Key to start checking from
          CALL      RDSBOKA1                 * Position on old slot
          CALL      RDKBOKA1                 * Get the next record
          BRANCH    OVRCD,DSLT8000           * Finished deleting record
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     CASEKEYS,SESSKEYS        * Still the same session ?
          GOTO      DSLT8000 IF NOT EQUAL    * No. Finished deleting record
.
          COMPARE   THREE,OBASTAT            * Extended slot ?
          GOTO      DSLT8000 IF NOT EQUAL    * No. Finished deleting record
          MOVE      OBAEXSL,SLOTOPT          * Parent slot no to a dim field
.
          MATCH     VSLOT,SLOTOPT            * Still the same session ?
          GOTO      DSLT8000 IF NOT EQUAL    * No. Finished deleting record
.
.         Delete this extended slot
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      DEBOKA1                  * Delete the record
          MOVE      FOUR,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOA                 * write the audit
          GOTO      DSLT1000                 * Check for another extended slot
.
DSLT8000  MOVE      ZERO,EXIT
          GOTO      DSLT9999
.
.         Record has disappeared
.
DSLT9000  MOVE      "Invalid Booking Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSLT9999
.
.         Booking record not empty
.
DSLT9100  MOVE      "Booking must be made Available",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSLT9999
.
.         Booking record not empty
.
DSLT9200  MOVE      "This Visit is Currently Reserved.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSLT9999
.
DSLT9999  RETURN
.
.*******************************************************************************
.                    UNASLT00: MAKE A SLOT UNAVAILABLE
.*******************************************************************************
UNASLT00  MOVE      ZERO,SLOTCNT * Loop through each slot to be made unavailable
          MOVE      SESSKEYS,SAVSKEYS  * Save session key for stats update
.
UNASLT10  COMPARE   "99",SLOTCNT
          GOTO      UNASLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      UNASLT90
          ENDIF
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          MOVE      SEVEN,SLOTTYPE
          CALL      USLT0000
          BRANCH    EXIT,UNASLT95
          GOTO      UNASLT10
.
UNASLT90  CALL      RCAL0000      * Recalculate slot counts
          MOVE      ZERO,EXIT
          GOTO      UNASLT99
.
UNASLT95  CALL      RCAL0000      * Recalculate slot counts
          MOVE      ONE,EXIT
.
UNASLT99  RETURN
.*******************************************************************************
.                    AVASLT00: MAKE A SLOT AVAILABLE
.*******************************************************************************
AVASLT00  MOVE      ZERO,SLOTCNT * Loop through each slot to be made available
          MOVE      SESSKEYS,SAVSKEYS  * Save session key for stats update
.
AVASLT10  COMPARE   "99",SLOTCNT
          GOTO      AVASLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      AVASLT90
          ENDIF
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
.
          CALL    VALUPD00        * Validate Update
          IF      EXIT = ONE
            GOTO    AVASLT95      * Error, go to exit
          ENDIF
          IF      EXIT = TWO
            MOVE    ZERO,EXIT     * Selected slot already processed (extended)
            GOTO    AVASLT10      * Process next selected slot
          ENDIF
.
          CALL      UPDEXT00
          BRANCH    EXIT,AVASLT95
          GOTO      AVASLT10
AVASLT90  CALL      RCAL0000      * Recalculate slot counts
          MOVE      ZERO,EXIT
          GOTO      AVASLT99
.
AVASLT95  CALL      RCAL0000      * Recalculate slot counts 
          MOVE      ONE,EXIT
.
AVASLT99  RETURN
.*******************************************************************************
.   USLT0000: Make an empty slot available/unavailable from the bookings file 
.*******************************************************************************
USLT0000  PACK      KEY28,CASEKEYS,SP70      * Key for the record to update
          UNPACK    KEY28,SESSKEYS,VSLOT     * Key for the record to update
          CALL      RDBOKA1                  * Just validate the record first
          BRANCH    OVRCD,USLT9000           * Record has disappeared
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH    ANSZ,TCINDC2
            IF       @EQUAL
              GOTO     USLT9200              * Can't make over bookings
            ENDIF                            * unavailable
          ENDIF
.
          COMPARE   ZERO,OBASTAT             * Make sure slot is empty
          GOTO      USLT0100 IF EQUAL        * Slot is not empty
          COMPARE   SEVEN,OBASTAT            * Make sure slot is empty
          GOTO      USLT9100 IF NOT EQUAL    * Slot is not empty
.
USLT0100  MATCH     ZEROVISN,OBAOUTNO        * Extra check, just to be sure
          GOTO      USLT9100 IF NOT EQUAL    * Slot is not empty
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          MOVE      SLOTTYPE,OBASTAT         * set status
          MATCH     SP70,NEWSLTYP
          IF        !@EQUAL
            MOVE      NEWSLTYP,OBAVISIT 
          ENDIF
          CALL      UPBOKA1                 
.
.         MATCH     SP70,SLOTCOMM            * No slot comment to add
.         GOTO      USLT0500 IF EQUAL
.
.         UNPACK    KEY28,OTBXSITE,OTBXCLIN,OTBXDATE,OTBXSTRT,OTBXSLOT
.         MOVE      SLOTCOMM,OTBXCOMM
.         MOVE      SP70,OTBXSPAR
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      RDOTBOX1
          IF        OVRCD=1
            UNPACK    KEY28,OTBXSITE,OTBXCLIN,OTBXDATE,OTBXSTRT,OTBXSLOT
            MOVE      SLOTCOMM,OTBXCOMM
            MOVE      SP70,OTBXSPAR
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WROTBOX1
            TRAPCLR   IO
          ELSE
            MOVE      SLOTCOMM,OTBXCOMM
            CALL      UPOTBOX1 
          ENDIF
.
USLT0500  MOVE      THREE,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOA                 * write the audit
.
. Replaced by RCAL0000
....      IF        SLOTTYPE=0
....        PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
....        CALL      ADDSCH00                 * Increment Booking Count
....      ENDIF
....      IF        SLOTTYPE=7
....        PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
....        CALL      SUBSCH00                 * Increment Booking Count
....      ENDIF
.
.
.         Now scan forward for any extended slots that should also be changed
.
USLT1000  PACK      KEY28,CASEKEYS,SP70      * Key to start checking from
          CALL      RDSBOKA1                 * Position on old slot
USLT2000  CALL      RDKBOKA1                 * Get the next record
          BRANCH    OVRCD,USLT8000           * Finished deleting record
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     CASEKEYS,SESSKEYS        * Still the same session ?
          GOTO      USLT8000 IF NOT EQUAL    * No. Finished deleting record
.
          COMPARE   THREE,OBASTAT            * Extended slot ?
          GOTO      USLT8000 IF NOT EQUAL    * No. Finished deleting record
          MOVE      OBAEXSL,SLOTOPT          * Parent slot no to a dim field
.
          MATCH     VSLOT,SLOTOPT            * Still the same session ?
          GOTO      USLT8000 IF NOT EQUAL    * No. Finished deleting record
.
.         extended slot
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          MOVE      SLOTTYPE,OBASTAT         * set status to unavailable(new) 
          MOVE      NEWSLTYP,OBAVISIT 
          MOVE      ZERO,OBAEXSL
          MATCH     SP70,NEWSLTYP
          IF        !@EQUAL
            MOVE      NEWSLTYP,OBAVISIT 
          ENDIF
          CALL      UPBOKA1                 
.
          MOVE      THREE,AUDIFLAG           * set to a write audit
          CALL      AUDOTBOA                 * write the audit
.
.         MATCH     SP70,SLOTCOMM            * No slot comment to add
.         GOTO      USLT2000 IF EQUAL
.
.         UNPACK    KEY28,OTBXSITE,OTBXCLIN,OTBXDATE,OTBXSTRT,OTBXSLOT
.         MOVE      SLOTCOMM,OTBXCOMM
.         MOVE      SP70,OTBXSPAR
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      RDOTBOX1
          IF        OVRCD=1
            UNPACK    KEY28,OTBXSITE,OTBXCLIN,OTBXDATE,OTBXSTRT,OTBXSLOT
            MOVE      SLOTCOMM,OTBXCOMM
            MOVE      SP70,OTBXSPAR
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WROTBOX1
            TRAPCLR   IO
          ELSE
            MOVE      SLOTCOMM,OTBXCOMM
            CALL      UPOTBOX1
          ENDIF
.
          GOTO      USLT2000                 * Check for another extended slot
.
USLT8000  MOVE      ZERO,EXIT
          GOTO      USLT9999
.
.         Record has disappeared
.
USLT9000  MOVE      "Invalid Booking Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      USLT9999
.
.         Booking record not empty
.
USLT9100  MOVE      "Booking must be made Available",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      USLT9999
.
USLT9200  MOVE      "Over Bookings can not be made Unavailable",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      USLT9999
.
USLT9999  RETURN
.
.*******************************************************************************
.                      VALUPD00: Validate Update 
. This procedure validates whether a selected slot can be successfully updated 
. to a new Visit Type. It checks the number of slots required for a new Visit
. Type and validates whether there is enough available slots for extended slots
. to be created. Slots that are booked, currently unavailable and extended 
. slots can not be used in update process.
.
. Return Values: EXIT - indicates whether update can be successful or not.
.                       EXIT = 0 : Update can be successful
.                       EXIT = 1 : Error, update can not be successful
.                       EXIT = 2 : Selected slot has already been processed
.  
.*******************************************************************************
VALUPD00  MOVE      ZERO,EXIT
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,VALUPD90
.
          IF        OBASTAT = THREE         
            MOVE      TWO,EXIT              * Slot already processed (extended)
            GOTO      VALUPD99              * Go to exit
          ENDIF  
.
          COMPARE   NINE,OBASTAT             * Is this slot Reserved?
          GOTO      VALUPD92 IF EQUAL        * Yes, can not update
.
          COMPARE   ZERO,OBASTAT             * Make sure slot is empty
          GOTO      VALUPD05 IF EQUAL        * Slot is not empty
.
          COMPARE   SEVEN,OBASTAT            * Make sure slot is empty
          GOTO      VALUPD95 IF NOT EQUAL    * Slot is not empty
.
VALUPD05  MATCH     ZEROVISN,OBAOUTNO        * Extra check, just to be sure
          GOTO      VALUPD95 IF NOT EQUAL    * Slot is not empty
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH    ANSZ,TCINDC2
            IF       @EQUAL
              GOTO     VALUPD93              * Can't make over bookings
            ENDIF                            * unavailable
          ENDIF
.
          MOVE      NEWSLTYP,CODE
          CALL      GETSCT00                * Get slot count for new visit
          MOVE      CNTSLOTS,NEWSLOTS
.
          MOVE      OBAVISIT,CODE
          CALL      GETSCT00                * Get slot count for old visit
          MOVE      CNTSLOTS,OLDSLOTS
.          
          MATCH     NEWSLTYP,OBAVISIT       * Any change in visit type?
          GOTO      VALUPD99 IF EQUAL       * No, go to exit
.
          MATCH     "U",TCINDC6
          IF        !@EQUAL
            COMPARE   NEWSLOTS,OLDSLOTS       * Is the number of slots the same?
            GOTO      VALUPD99 IF EQUAL       * Yes, go to exit.
          ENDIF
.
          IF        NEWSLOTS < OLDSLOTS
            GOTO      VALUPD99              
          ENDIF
.
          MOVE      OLDSLOTS,NUMSLVIS
          MOVE      NEWSLOTS,VALSLOTS
          MOVE      ZERO,TOTSLCNT
.
VALUPD10  ADD       ONE,TOTSLCNT
          SUB       ONE,NUMSLVIS
.
.         Process all slots that belong to that visit type
.
          IF        NUMSLVIS > 0
            CALL      RDKBOKA1
            BRANCH    OVRCD,VALUPD91
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
            MATCH     KEY28,SESSKEYS        * Same session?
            GOTO      VALUPD91 IF NOT EQUAL * No, visit can not be updated.
            MATCH     ZEROVISN,OBAOUTNO     * Is this visit empty?
            GOTO      VALUPD91 IF NOT EQUAL * No, can not perform update
            COMPARE   THREE,OBASTAT         * This should be extended slot
            GOTO      VALUPD20 IF NOT EQUAL * If not, process as visit slot
            GOTO      VALUPD10
          ENDIF
.
.         All slots for this visit type have been processed. If total number
.         of slots processed is equal to number of slots in new visit type
.         then update can be successful.
.
          IF        TOTSLCNT = VALSLOTS
            GOTO      VALUPD30
          ENDIF
.
.         If total number of slots processed is greater than number of slots
.         in the new visit type, then update can not proceed as it would 
.         result in partial conversion of existing visit to the new visit.
.
          IF        TOTSLCNT > VALSLOTS
            GOTO      VALUPD91
          ENDIF
.
.         The total number of slots processed is less than number of slots
.         in the new visit type. Therefore fetch next visit, check if it is
.         available, get number of slots in this visit and go back to process
.         all slots in this visit.
.
          CALL      RDKBOKA1
          BRANCH    OVRCD,VALUPD91
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY28,SESSKEYS        * Same session?
          GOTO      VALUPD91 IF NOT EQUAL * No, visit can not be updated.
VALUPD20  COMPARE   ZERO,OBASTAT          * Is this visit empty?
          GOTO      VALUPD91 IF NOT EQUAL * No, can not perform update
          MATCH     ZEROVISN,OBAOUTNO     * Is this visit empty?
          GOTO      VALUPD91 IF NOT EQUAL * No, can not perform update
.
          MOVE      OBAVISIT,CODE
          CALL      GETSCT00
          MOVE      CNTSLOTS,NUMSLVIS
.
          MATCH     ANSZ,TCINDC2          * Can not extend into over bookings
          GOTO      VALUPD94 IF EQUAL
.
          GOTO      VALUPD10 
.            
VALUPD30  MOVE      ZERO,EXIT
          GOTO      VALUPD99
.
VALUPD90  MOVE      "Invalid Booking Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD91  MOVE      "No Space Available for Extended Slots.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD92  MOVE      "This Visit is Currently Reserved.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD93  MOVE      "Over Bookings can not be modified.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD94  MOVE      "No space available due to over bookings.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD95  MOVE      "Booking must be made Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALUPD99
.
VALUPD99  RETURN
.
.*******************************************************************************
.         UPDEXT00: UPDATE SLOTS INCLUDING EXTENDED SLOTS
. This procedure performs the Update of a given slot/visit to a New Visit Type.
. Depending on the update performed, it can convert existing slots to be 
. extended slots where required and release the extended slots if they are no 
. longer needed making them available.
.*******************************************************************************
UPDEXT00  MOVE      ZERO,EXIT
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDEXT90
.
          MOVE      OBASLOT,PARNTSLT
          MOVE      ZERO,OBASTAT
          MOVE      NEWSLTYP,OBAVISIT
          CALL      UPBOKA1
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      DEOTBOX1                * Delete unavailabel slot comment
.
          MOVE      THREE,AUDIFLAG          * Set to write audit file
          CALL      AUDOTBOA
.
          IF        ((NEWSLOTS = OLDSLOTS) & (NEWSLOTS = ONE))
            GOTO      UPDEXT99
          ENDIF
. 
          MOVE      NEWSLTYP,CODE
          CALL      GETSCT00
          MOVE      CNTSLOTS,NUMSLVIS
.
UPDEXT10  CALL      RDKBOKA1           * Process all slots for new Visit Type
          BRANCH    OVRCD,UPDEXT99
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY28,SESSKEYS
          GOTO      UPDEXT99 IF NOT EQUAL
          SUB       ONE,NEWSLOTS
          COMPARE   ZERO,NEWSLOTS
          GOTO      UPDEXT30 IF EQUAL
.
          MOVE      NEWSLTYP,OBAVISIT       * Convert to extended slot
          MOVE      PARNTSLT,OBAEXSL
          MOVE      THREE,OBASTAT
          CALL      UPBOKA1
          MOVE      THREE,AUDIFLAG          * Set to write audit file
          CALL      AUDOTBOA
          GOTO      UPDEXT10
.
UPDEXT20  CALL      RDKBOKA1           * Loop through left over extended slots
          BRANCH    OVRCD,UPDEXT99
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY28,SESSKEYS
          GOTO      UPDEXT99 IF NOT EQUAL
.
UPDEXT30  COMPARE   PARNTSLT,OBAEXSL   * Release extended slot
          GOTO      UPDEXT99 IF NOT EQUAL
.
          IF        NUMSLVIS = ONE
            MOVE      NEWSLTYP,OBAVISIT
          ELSE     
            MOVE      "R  ",OBAVISIT
          ENDIF
          MOVE      ZERO,OBASTAT
          MOVE      ZERO,OBAEXSL
          CALL      UPBOKA1
          MOVE      THREE,AUDIFLAG          * Set to write audit file
          CALL      AUDOTBOA
          GOTO      UPDEXT20
.
UPDEXT90  MOVE      "Error Occured While Updating Visit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDEXT99          
.
UPDEXT99  RETURN
.
.*******************************************************************************
.                      UPDSLT00: UPDATE VISIT TYPE
.*******************************************************************************
UPDSLT00  MOVE      ZERO,SLOTCNT * Loop through each slot to be made unavailable
          MOVE      SESSKEYS,SAVSKEYS  * Save session key for stats update
.
UPDSLT10  COMPARE   "99",SLOTCNT
          GOTO      UPDSLT99 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      UPDSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      UPDT0000
          BRANCH    EXIT,UPDSLT95
.
          GOTO      UPDSLT10
.
UPDSLT90  MOVE      ZERO,EXIT
          GOTO      UPDSLT99
.
UPDSLT95  MOVE      ONE,EXIT
.
UPDSLT99  RETURN
.*******************************************************************************
.      UPDT0000: Update visit type for a empty slot from the bookings file 
.*******************************************************************************
UPDT0000  PACK      KEY28,CASEKEYS,SP70      * Key for the record to delete
          UNPACK    KEY28,SESSKEYS,VSLOT     * Key for the record to delete
          CALL      RDBOKA1                  * Just validate the record first
          BRANCH    OVRCD,UPDT9000           * Record has disappeared
.
          COMPARE   ZERO,OBASTAT             * Make sure slot is empty
          GOTO      UPDT9100 IF NOT EQUAL    * Slot is not empty
.
          MATCH     ZEROVISN,OBAOUTNO        * Extra check, just to be sure
          GOTO      UPDT9100 IF NOT EQUAL    * Slot is not empty
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBSCH00                 * Increment Booking Count
.
          MOVE      OBAVISIT,OLDVTYP
          MOVE      NEWSLTYP,NEWVTYP
.
          MOVE      NEWSLTYP,OBAVISIT 
          CALL      UPBOKA1                 
          MOVE      THREE,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOA                 * write the audit
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDSCH00                 * Increment Booking Count
.
.         Now scan forward for any extended slots that should also be updated
.
          PACK      KEY28,CASEKEYS,SP70      * Key to start checking from
          CALL      RDSBOKA1                 * Position on old slot
UPDT1000  CALL      RDKBOKA1                 * Get the next record
          BRANCH    OVRCD,UPDT8000           * Finished updating record
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     CASEKEYS,SESSKEYS        * Still the same session ?
          GOTO      UPDT8000 IF NOT EQUAL    * No. Finished updating record
.
          COMPARE   THREE,OBASTAT            * Extended slot ?
          GOTO      UPDT8000 IF NOT EQUAL    * No. Finished updating record
          MOVE      OBAEXSL,SLOTOPT          * Parent slot no to a dim field
.
          MATCH     VSLOT,SLOTOPT            * Still the same session ?
          GOTO      UPDT8000 IF NOT EQUAL    * No. Finished updating record
.
.         Update extended slot
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          MOVE      NEWSLTYP,OBAVISIT 
          CALL      UPBOKA1 

          MOVE      THREE,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOA                  * write the audit
          GOTO      UPDT1000                  * Check for another extended slot
.
UPDT8000  MOVE      NEWVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,NEWSLOTS
.
          MOVE      OLDVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,OLDSLOTS
.
          COMPARE   OLDSLOTS,NEWSLOTS
          GOTO      UPDT8900 IF EQUAL
.
          MOVE      CASEKEYS,NEWSLOTK
          CALL      EXTSLT00
.
UPDT8900  MOVE      ZERO,EXIT
          GOTO      UPDT9999
.
.         Record has disappeared
.
UPDT9000  MOVE      "Invalid Booking Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDT9999
.
.         Booking record not empty
.
UPDT9100  MOVE      "Booking must be made available",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDT9999
.
UPDT9999  RETURN
.                                           *** HPS Code Starts Here ***
.*******************************************************************************
.                         Diagnosis Comments 
.*******************************************************************************
DIAGCM00  PACK      KEY12,OBAOUTNO,SP70
          CALL      RSOTXWP1
DIAGCM10  CALL      RKOTXWP1
          BRANCH    OVRCD,DIAGCM99
          MATCH     OTXWOUTN,OBAOUTNO
          GOTO      DIAGCM99 IF NOT EQUAL
          STRIP     OTXWDESC
          MOVELPTR  OTXWDESC,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      OTXWDESC,VAR
          PACK      D2,QUOTE,SP70                 * remove quote for tablesort
          REP       D2,VAR
          WRITE     HTMLFILE;VAR,"<br>";
          SFORMAT   VAR,127
          GOTO      DIAGCM10
. 
DIAGCM99  RETURN
.*******************************************************************************
.                           Reschedule session
.*******************************************************************************
RSHSLT00  MOVE      ZERO,SLOTCNT * Loop through each slot to be updated
.
... CAR 36688 - START (Commented out the next line of code)
...          MOVE      ZERO,RESHFLAG
... CAR 36688 - END
.
          MOVE      SESSKEYS,SVRSKEYS
RSHSLT10  COMPARE   "99",SLOTCNT
          GOTO      RSHSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      RSHSLT90
          ENDIF
          PACK      CASEKEYS,SVRSKEYS,SLOTKEYS[SLOTCNT]
          CALL      RSHS0000
          BRANCH    EXIT,RSHSLT95
          GOTO      RSHSLT10
.
RSHSLT90  MOVE      SVRSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "From" session
          MOVE      NEWSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "To" session
          MOVE      ZERO,EXIT
          GOTO      RSHSLT99
.
RSHSLT95  MOVE      SVRSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "From" session
          MOVE      NEWSKEYS,SAVSKEYS
          CALL      RCAL0000           * Recalculate slots in "To" session
          MOVE      ONE,EXIT
.
RSHSLT99  RETURN
.
RSHS0000  PACK      KEY28,CASEKEYS,SP70      * Key for the record to reschedule
          CALL      RDBOKA1                  * Just validate the record first
          BRANCH    OVRCD,RSHS9000           * Record has disappeared
          MOVE      OBAVISIT,XVISTYPE    *visit type for rec to be rescheduled
.
          COMPARE   ONE,OBASTAT              * Is this a  booking ?
          GOTO      RSHS9004 IF NOT EQUAL
.
          MOVE      OBAVISIT,NEWVTYP     * New Visit Type
          MOVE      OBAVISIT,OUTBB047    * New Visit Type
          MOVE      OBAURNO,SAVEURNO     * save U/R
.
          MOVE      SP70,SAVEREFN           * Clear linked AH referral number
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,RSHS0500          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      RSHS0500 IF NOT EQUAL
.
          MOVE      ALLNVISN,SAVEREFN       * Linked AH referral number
.
RSHS0500  MATCH     SP70,SAVEREFN           * Check if referral mandatory
          GOTO      RSHS0700 IF NOT EQUAL   * for clinic
.
          MOVE      NEWSKEYS,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,RSHS0700
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RSHS0700
.
          MATCH     "1",OTHEMREF
          IF        @EQUAL
            MOVE      ZERO,EXIT             * Skip this booking a referral
            GOTO      RSHS9999              * is mandatory
          ENDIF
.
RSHS0700  PACK      KEY28,NEWSKEYS,SP70
          CALL      RDBOKA1
          COMPARE   ZERO,OVRCD
          GOTO      RSHS1100 IF EQUAL
.
RSHS1000  CALL      RDKBOKA1
          BRANCH    OVRCD,RSHS9300
.
RSHS1100  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY25,NEWSKEYS
          GOTO      RSHS9300 IF NOT EQUAL 
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RSHS1000
.
          MATCH     ANSU,TCINDC6                 * Skip unavailable slots
          GOTO      RSHS1000 IF EQUAL
.
          MATCH     ANSZ,TCINDC2                 * Skip
          GOTO      RSHS1000 IF EQUAL
.
          COMPARE   NINE,OBASTAT
          GOTO      RSHS2000 IF EQUAL
          COMPARE   ZERO,OBASTAT
          GOTO      RSHS1000 IF NOT EQUAL
          MATCH     XVISTYPE,OBAVISIT
          GOTO      RSHS1000 IF NOT EQUAL
.
... CAR 36688 - START (Removed test for RESHFLAG = "2")
...RSHS2000  MATCH     "2",RESHFLAG
...          IF        @EQUAL
...            UNPACK    NEWSKEYS,RESHKEYS
...            PACK      NEWSLOTK,RESHKEYS,OBASLOT,SP70     *for WBKA0000
...          ELSE
...            PACK      NEWSLOTK,NEWSKEYS,SP70
...          ENDIF
...
RSHS2000  UNPACK    NEWSKEYS,RESHKEYS
          PACK      NEWSLOTK,RESHKEYS,OBASLOT,SP70     *for WBKA0000
... CAR 36688 - END
.
          MOVE      OBAVISIT,OLDVTYP
.
          MOVE      SAVEURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 1
            CALL      CLPATMAS
          ENDIF
          MOVE      SAVEURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL      CLPMSPX2
          ENDIF
.
.         Check if we need to send an A38 cancellation message for
.         a reschedule.  If so, we need to re-read the original booking record
.         and send the cancellation, then reposition on the new booking record
.         again.
.
          PACK      NEWKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            MOVE      CASEKEYS,KEY28
            CALL      RDBOKA1                * re-read original booking record
            BRANCH    OVRCD,RSHS9000         * record has disappeared
.
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY9,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOC               * DG O/P Cancel Appoint
.
            MOVE      NEWKEY28,KEY28
            CALL      RDBOKA1                * reposition on new booking record
            BRANCH    OVRCD,RSHS9000         * record has disappeared
          ENDIF
.
          CALL      LOGR0000              * Log the rescheduling
          CALL      PRFL0000              * update outrf1af
.
... CAR 36688 - START (Commented out the next line of code)
...          MOVE      "1",RESHFLAG
... CAR 36688 - END
.
          CALL      WBKA0000              * Write the new booking
          BRANCH    EXIT,RSHS9008
.         
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            MOVE      THIRTY,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICON             * DG O/P New Appoint.
          ELSE
            MOVE      TWENTY4,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOB    * Send Change O/P Booking Details message
          ENDIF
.
          CALL      ULNK0000              * Update allied health link booking
          CALL      UMBS0000              * Update cmbs item table
          CALL      UTRN0000              * Update Transport Details
          CALL      UCLM0000              * Update claim details
.                                                                   * CAR 270888
          PACK      KEY8,OBAOUTNO,SP10
          CALL      DEPMCUR1              * Remove existing Curr Patient Record
          CALL      WRCPAT00              * Re-instate Current Patient Record
.
          CALL      DBOK0000              * Delete the old booking
.
          CALL      BOKUPD00
.
          MATCH     "1",LETPRT06           * Print re-schedule letter
          GOTO      RSHS8000 IF NOT EQUAL
          MOVE      LETPSL06,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "6",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARSLT
          GOTO      RSHS8000 IF EQUAL
          MOVE      OTMARSLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
RSHS8000  MOVE      ZERO,EXIT
          GOTO      RSHS9999          
.
RSHS9000  MOVE      "Invalid Booking Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHS9999
RSHS9004  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            MOVE      "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            MOVE      "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHS9999
.
RSHS9005  MOVE      "Invalid Case ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHS9999
.
RSHS9008  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "New Slot Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHS9999

RSHS9300  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "No slots available in Session.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RSHS9999
.
RSHS9999  RETURN
+                                           *** HPS Code Ends Here ***
.*******************************************************************************
.                     Output Maintenance Case List Table
.*******************************************************************************
CASMTC00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,TABLTYPE
          MOVE      ANS,TABLTYPE
          MOVE      ZERO,OVERBOOK
.
          MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CASMTC10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CASMTC99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CASMTC99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      CASMTC10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      CASMTC10 IF EQUAL
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CASMTC10 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      ZERO,BOOKSERS
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            CALL      CHKS0000              * Check if this is a series booking
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MOVE      ZERO,CHARTREV                * No
          MATCH     ANSC,TCINDC8                 * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV                * Yes
          ENDIF
.
          MATCH     ANSU,TCINDC6            * Get slot comment if unavailable
          IF        @EQUAL
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      RDOTBOX1
            IF        OVRCD=0
              MATCH     SP70,OTBXCOMM
              IF        !@EQUAL
                MOVE      OTBXCOMM,VTYPDESC
              ENDIF
            ENDIF 
          ENDIF
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MOVE      TCINDC1,CLININDC
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MOVE      OCADESC,JAVSNAME
          CALL      JAVDES00
.
          BRANCH    TABLTYPE,CASMTC20
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr height=25><td align=right ":
                                 "bgcolor=magenta>",OBASLOT,"</td>":
                                 "<td align=center bgcolor=magenta nowrap>";
.
              IF     (OBASTAT=0|OBASTAT=9)
                WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif ":
                              "hspace=4":
                              " class=ListIcon onclick='UpdateSlotTime(#"":
                              OBASLOT,"#",#"",OBATIME,"#");'>";
              ENDIF
.
              WRITE     HTMLFILE;OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               IF        BOOKSERS=1
                 WRITE     HTMLFILE;"<tr height=25 bgcolor=green>":
                                    "<td align=right>";
               ELSE
                 IF        CHARTREV=1
                   WRITE     HTMLFILE;"<tr height=25":
                                      " class=#"TableRowChartReview#">":
                                      "<td align=right>";
                 ELSE
                   WRITE     HTMLFILE;"<tr height=25><td align=right>";
                 ENDIF
               ENDIF
.
               WRITE     HTMLFILE;OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>";
.
              IF        TABLTYPE<>2
                WRITE     HTMLFILE;"<td align=center bgcolor=magenta>":
                                 "<input type=checkbox name=slotkeys value= '":
                                 OBASLOT,"'></td>";
.
                WRITE     HTMLFILE;"<input type=hidden name=#"hiddcsky#" ":
                                   "value=#"",CASEKEYS,"#">":
                                   "<input type=hidden name=#"hiddjavs#" ":
                                   "value=#"",JAVSNAME,"#">":
                                   "<input type=hidden name=#"hidddate#" ":
   "value=#"",DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ",OBATIME,"#">":
                                   "<input type=hidden name=#"hiddvist#" ":
                                   "value=#"",OBAVISIT,"#">":
                                   "<input type=hidden name=#"hiddctyp#" ":
                                   "value=#"",OCTCTYP,"#">":
                                   "<input type=hidden name=#"hiddcdsc#" ":
                                   "value=#"",OCTDESC,"#">":
                                   "<input type=hidden name=#"hiddcind#" ":
                                   "value=#"",CLININDC,"#">":
                                   "<input type=hidden name=#"hiddclds#" ":
                                   "value=#"",CLINDESC,"#">":
                                   "<input type=hidden name=#"hiddotmu#" ":
                                   "value=#"",OTMAUMCI,"#">":
                                   "<input type=hidden name=#"hiddothc#" ":
                                   "value=#"",OTHECCAR,"#">":
                                   "<input type=hidden name=#"hiddothn#" ":
                                   "value=#"",OTHENDPS,"#">":
                                   "<input type=hidden name=#"hiddothm#" ":
                                   "value=#"",OTHENMDS,"#">":
                                   "<input type=hidden name=#"hiddotha#" ":
                                   "value=#"",OTHECART,"#">":
                                   "<input type=hidden name=#"hiddoths#" ":
                                   "value=#"",OTHESRVD,"#">":
                                   "<input type=hidden name=#"hiddothl#" ":
                                   "value=#"",OTHECLHR,"#">":
                                   "<input type=hidden name=#"hiddind2#" ":
                                   "value=#"",TCINDC2,"#">":
                                   "<input type=hidden name=#"hiddtier#" ":
                                   "value=#"",OTHETCOD,"#">";
              ENDIF
.
              WRITE     HTMLFILE;"</tr>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
              IF        TABLTYPE<>2
                WRITE     HTMLFILE;"<td align=center>":
                                 "<input type=checkbox name=slotkeys value= '":
                                 OBASLOT,"'></td>";
.
                WRITE     HTMLFILE;"<input type=hidden name=#"hiddcsky#" ":
                                   "value=#"",CASEKEYS,"#">":
                                   "<input type=hidden name=#"hiddjavs#" ":
                                   "value=#"",JAVSNAME,"#">":
                                   "<input type=hidden name=#"hidddate#" ":
   "value=#"",DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ",OBATIME,"#">":
                                   "<input type=hidden name=#"hiddvist#" ":
                                   "value=#"",OBAVISIT,"#">":
                                  "<input type=hidden name=#"hiddctyp#" ":
                                   "value=#"",OCTCTYP,"#">":
                                   "<input type=hidden name=#"hiddcdsc#" ":
                                   "value=#"",OCTDESC,"#">":
                                   "<input type=hidden name=#"hiddcind#" ":
                                   "value=#"",CLININDC,"#">":
                                   "<input type=hidden name=#"hiddclds#" ":
                                   "value=#"",CLINDESC,"#">":
                                   "<input type=hidden name=#"hiddotmu#" ":
                                   "value=#"",OTMAUMCI,"#">":
                                   "<input type=hidden name=#"hiddothc#" ":
                                   "value=#"",OTHECCAR,"#">":
                                   "<input type=hidden name=#"hiddothn#" ":
                                   "value=#"",OTHENDPS,"#">":
                                   "<input type=hidden name=#"hiddothm#" ":
                                   "value=#"",OTHENMDS,"#">":
                                   "<input type=hidden name=#"hiddotha#" ":
                                   "value=#"",OTHECART,"#">":
                                   "<input type=hidden name=#"hiddoths#" ":
                                   "value=#"",OTHESRVD,"#">":
                                   "<input type=hidden name=#"hiddothl#" ":
                                   "value=#"",OTHECLHR,"#">":
                                   "<input type=hidden name=#"hiddind2#" ":
                                   "value=#"",TCINDC2,"#">":
                                   "<input type=hidden name=#"hiddtier#" ":
                                   "value=#"",OTHETCOD,"#">";
              ENDIF
.
              WRITE     HTMLFILE;"</tr>"
            ENDIF
            GOTO      CASMTC10
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>";
.
            IF        TABLTYPE<>2
              WRITE     HTMLFILE;"<td align=center bgcolor=red>":
                                "<input type=checkbox name=slotkeys value= '":
                                OBASLOT,"'></td>";
.
              WRITE     HTMLFILE;"<input type=hidden name=#"hiddcsky#" ":
                                 "value=#"",CASEKEYS,"#">":
                                 "<input type=hidden name=#"hiddjavs#" ":
                                 "value=#"",JAVSNAME,"#">":
                                   "<input type=hidden name=#"hidddate#" ":
   "value=#"",DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ",OBATIME,"#">":
                                   "<input type=hidden name=#"hiddvist#" ":
                                   "value=#"",OBAVISIT,"#">":
                                  "<input type=hidden name=#"hiddctyp#" ":
                                   "value=#"",OCTCTYP,"#">":
                                   "<input type=hidden name=#"hiddcdsc#" ":
                                   "value=#"",OCTDESC,"#">":
                                   "<input type=hidden name=#"hiddcind#" ":
                                   "value=#"",CLININDC,"#">":
                                   "<input type=hidden name=#"hiddclds#" ":
                                   "value=#"",CLINDESC,"#">":
                                   "<input type=hidden name=#"hiddotmu#" ":
                                   "value=#"",OTMAUMCI,"#">":
                                   "<input type=hidden name=#"hiddothc#" ":
                                   "value=#"",OTHECCAR,"#">":
                                   "<input type=hidden name=#"hiddothn#" ":
                                   "value=#"",OTHENDPS,"#">":
                                   "<input type=hidden name=#"hiddothm#" ":
                                   "value=#"",OTHENMDS,"#">":
                                   "<input type=hidden name=#"hiddotha#" ":
                                   "value=#"",OTHECART,"#">":
                                   "<input type=hidden name=#"hiddoths#" ":
                                   "value=#"",OTHESRVD,"#">":
                                   "<input type=hidden name=#"hiddothl#" ":
                                   "value=#"",OTHECLHR,"#">":
                                   "<input type=hidden name=#"hiddind2#" ":
                                   "value=#"",TCINDC2,"#">":
                                   "<input type=hidden name=#"hiddtier#" ":
                                   "value=#"",OTHETCOD,"#">";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>"
            GOTO      CASMTC10
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>";
.
            IF        TABLTYPE<>2
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>";
.
            IF        TABLTYPE<>2
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>"
          ENDIF
          GOTO      CASMTC10
.                                           * HPS ODC Code Added Bug (196) Ends
.
CASMTC20  COMPARE   ONE,OBASTAT
          GOTO      CASMTC10 IF NOT EQUAL
.
          CALL      CASDET00
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CASMTC10
.
          MATCH     SP70,OTBBCITM
          GOTO      CASMTC10 IF NOT EQUAL
.
          MATCH     SP70,OTBBASTM
          GOTO      CASMTC10 IF NOT EQUAL
.
          MATCH     SP70,OTBBDPTM
          GOTO      CASMTC10 IF NOT EQUAL
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          MOVE      SP70,PRTYDESC
          MOVE      "PR",CATEGORY
          MOVE      OBAPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRTYDESC
.
          MOVE      ZERO,OPRSUNIQ
          PACK      KEY11,OBAOUTNO,Z70
          CALL      RDSRSHA1
          CALL      RDPRSHA1
          IF        OVRCD <> 1
            MATCH     OBAOUTNO,OPRSOUTN
            IF        !@EQUAL
              MOVE      ZERO,OPRSUNIQ
            ENDIF
          ENDIF
.
          MOVE      ZERO,MOSAIQVS
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE         * MOSAIQ Visit
            IF        @EQUAL
              MOVE      ONE,MOSAIQVS        * Yes this is a MOSAIQ visit
            ENDIF
          ENDIF
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<tr bgcolor=magenta>":
                               "<td align=right>",OBASLOT,"/":
                               OBAEXSL,"</td><td align=center>",OBATIME,"</td>":
                               "<td>",VTYPDESC,"&nbsp;</td>":
                               "<td>",FORMATNM,"</td>";
.
            IF        PTCNHDPS=1
              WRITE     HTMLFILE;"<td>",PRTYDESC,"&nbsp;</td>":
                                 "<td>",OPRSUNIQ,"&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>",SARRDESC,"&nbsp;</td>":
                               "<td align=center>&nbsp;</td></tr>"
          ELSE
            IF        BOOKSERS=1
              WRITE     HTMLFILE;"<tr bgcolor=green><td align=right>":
                                 OBASLOT,"/",OBAEXSL;
            ELSE 
              WRITE     HTMLFILE;"<tr><td align=right>",OBASLOT,"/",OBAEXSL;
            ENDIF
.
            WRITE     HTMLFILE;"</td><td align=center>",OBATIME,"</td>":
                               "<td>",VTYPDESC,"&nbsp;</td>":
                               "<td>",FORMATNM,"</td>";
.
            IF        PTCNHDPS=1
              WRITE     HTMLFILE;"<td>",PRTYDESC,"&nbsp;</td>":
                                 "<td>",OPRSUNIQ,"&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>",SARRDESC,"&nbsp;</td>";
.
            IF        MOSAIQVS=1
              WRITE     HTMLFILE;"<td align=center>&nbsp;</td></tr>"
            ELSE
              WRITE     HTMLFILE;"<td align=center>":
                                 "<input type=checkbox name=slotkeys value='":
                                 OBASLOT,"' checked></td></tr>"
            ENDIF
          ENDIF
          GOTO      CASMTC10
.
CASMTC99  RETURN
.*******************************************************************************
.                   Set Parameters for Master Details
.*******************************************************************************
SPMAS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMAS010,SPMAS020,SPMAS030,SPMAS040,SPMAS050:
                       SPMAS060,SPMAS070,SPMAS080,SPMAS090,SPMAS100:
                       SPMAS110,SPMAS120,SPMAS130,SPMAS140,SPMAS150:
                       SPMAS160,SPMAS170,SPMAS180,SPMAS190,SPMAS200:
                       SPMAS210,SPMAS220,SPMAS230,SPMAS240,SPMAS250:
                       SPMAS260,SPMAS270,SPMAS280,SPMAS290,SPMAS300:
                       SPMAS310,SPMAS320,SPMAS330,SPMAS340,SPMAS350:
                       SPMAS360,SPMAS370,SPMAS380,SPMAS390,SPMAS400:
                       SPMAS410,SPMAS420,SPMAS430,SPMAS440,SPMAS450:
                       SPMAS460,SPMAS470,SPMAS480,SPMAS490,SPMAS500:
                       SPMAS510,SPMAS520,SPMAS530,SPMAS540,SPMAS550:
                       SPMAS560,SPMAS570,SPMAS580,SPMAS590,SPMAS600:
                       SPMAS610,SPMAS620,SPMAS630,SPMAS640,SPMAS650:
                       SPMAS660
.
          MOVE      ONE,EXIT
          GOTO      SPMAS999

SPMAS010  MOVE      QRYDATA,PTMAS001
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS020  MOVE      QRYDATA,PTMAS002
          GOTO      SPMAS900
.
SPMAS030  MOVE      QRYDATA,PTMAS003
          GOTO      SPMAS900
.
SPMAS040  MOVE      QRYDATA,PTMAS004
          GOTO      SPMAS900
.
SPMAS050  MOVE      QRYDATA,PTMAS005
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS060  MOVE      QRYDATA,PTMAS006
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS070  MOVE      QRYDATA,PTMAS007
          GOTO      SPMAS900
.
SPMAS080  MOVE      QRYDATA,PTMAS008
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS090  MOVE      QRYDATA,PTMAS009
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS100  MOVE      QRYDATA,PTMAS010
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS110  MOVE      QRYDATA,PTMAS011
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS120  MOVE      QRYDATA,PTMAS012
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS130  MOVE      QRYDATA,PTMAS013
          GOTO      SPMAS900
.
SPMAS140  MOVE      QRYDATA,PTMAS014
          GOTO      SPMAS900
.
SPMAS150  MOVE      QRYDATA,PTMAS015
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS160  MOVE      QRYDATA,PTMAS016
          GOTO      SPMAS900
.
SPMAS170  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS017,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS180  MOVE      QRYDATA,PTMAS018
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS190  MOVE      QRYDATA,PTMAS019
          GOTO      SPMAS900
.
SPMAS200  MOVE      QRYDATA,PTMAS020
          GOTO      SPMAS900
.
SPMAS210  MOVE      QRYDATA,PTMAS021
          GOTO      SPMAS900
.
SPMAS220  MOVE      QRYDATA,PTMAS022
          GOTO      SPMAS900
.
SPMAS230  MOVE      QRYDATA,PTMAS023
          GOTO      SPMAS900
.
SPMAS240  MOVE      QRYDATA,PTMAS024
          GOTO      SPMAS900
.
SPMAS250  UNPACK    QRYDATA,KEY2,KEY1,KEY2A
          PACK      PTMAS025,KEY2,KEY2A
          GOTO      SPMAS900
.
SPMAS260  MOVE      QRYDATA,PTMAS026
          GOTO      SPMAS900
.
SPMAS270  MOVE      QRYDATA,PTMAS027
          GOTO      SPMAS900
.
SPMAS280  MOVE      QRYDATA,PTMAS028
          GOTO      SPMAS900
.
SPMAS290  MOVE      QRYDATA,PTMAS029
          GOTO      SPMAS900
.
SPMAS300  MOVE      QRYDATA,PTMAS030 
          GOTO      SPMAS900
.
SPMAS310  MOVE      QRYDATA,PTMAS031
          GOTO      SPMAS900
.
SPMAS320  MOVE      QRYDATA,PTMAS032
          GOTO      SPMAS900
.
SPMAS330  MOVE      QRYDATA,PTMAS033
          GOTO      SPMAS900
.
SPMAS340  MOVE      QRYDATA,PTMAS034
          GOTO      SPMAS900
.
SPMAS350  MOVE      QRYDATA,PTMAS035
          GOTO      SPMAS900
.
SPMAS360  MOVE      QRYDATA,PTMAS036
          GOTO      SPMAS900
.
SPMAS370  MOVE      QRYDATA,PTMAS037
          GOTO      SPMAS900
.
SPMAS380  MOVE      QRYDATA,PTMAS038
          GOTO      SPMAS900
.
SPMAS390  MOVE      QRYDATA,PTMAS039
          GOTO      SPMAS900
.
SPMAS400  MOVE      QRYDATA,PTMAS040
          GOTO      SPMAS900
.
SPMAS410  MOVE      QRYDATA,PTMAS041
          GOTO      SPMAS900
.
SPMAS420  MOVE      QRYDATA,PTMAS042
          GOTO      SPMAS900
.
SPMAS430  MOVE      QRYDATA,PTMAS043
          GOTO      SPMAS900
.
SPMAS440  MOVE      QRYDATA,PTMAS044
          GOTO      SPMAS900
.
SPMAS450  MOVE      QRYDATA,PTMAS045
          GOTO      SPMAS900
.
SPMAS460  MOVE      QRYDATA,PTMAS046
          GOTO      SPMAS900
.
SPMAS470  MOVE      QRYDATA,PTMAS047
          GOTO      SPMAS900
.
SPMAS480  MOVE      QRYDATA,PTMAS048
          GOTO      SPMAS900
.
SPMAS490  MOVE      QRYDATA,PTMAS049
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS500  MOVE      QRYDATA,PTMAS050
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS510  MOVE      QRYDATA,PTMAS051
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS520  MOVE      QRYDATA,PTMAS052
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS530  MOVE      QRYDATA,PTMAS053
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS540  MOVE      QRYDATA,PTMAS054
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS550  MOVE      QRYDATA,PTMAS055
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS560  MOVE      QRYDATA,PTMAS056
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS570  MOVE      QRYDATA,PTMAS057
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS580  MOVE      QRYDATA,PTMAS058
          GOTO      SPMAS900
.
SPMAS590  MOVE      QRYDATA,PTMAS059
          GOTO      SPMAS900
.
SPMAS600  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS060,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS610  MATCH     SP70,QRYDATA
          GOTO      SPMAS900 IF EQUAL 
          GOTO      SPMAS900 IF EOS     
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS061,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS620  MOVE      QRYDATA,PTMAS062
          GOTO      SPMAS900
.
SPMAS630  MOVE      QRYDATA,PTMAS063
          GOTO      SPMAS900
.
SPMAS640  MOVE      QRYDATA,PTMAS064
          GOTO      SPMAS900
.
SPMAS650  MOVE      QRYDATA,PTMAS065
          GOTO      SPMAS900
.
SPMAS660  MOVE      QRYDATA,PTMAS066
          GOTO      SPMAS900
.
SPMAS900  MOVE      ONE,MASUPDFL
.
SPMAS999  RETURN
+
.*******************************************************************************
.  close the popup and direct to a new popup
.*******************************************************************************
CLSPOP00  CALL      OPENHTML
          BRANCH    EXIT,CLSPOP99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
.
          CALL      CLOSHTML
CLSPOP99  RETURN
.---------------------------------------------------
.    Write to the file ibalpcaf.dat (IBALPCFD.INC) CR 185
.---------------------------------------------------
WRTPRT00  MOVE      SELPRINT,SCHDPRNT      * printer code
          MOVE      NOLABELS,SCHDCOPY     * number of copies
          MOVE      SP70,STATNCOD
          MOVE      CASEKEYS,SUBSYSKY
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
          CALL      ADDPRN00
.
WRTPRT99  RETURN
.---------------------------------------------------
. Reduce Schedule Count on Session
.---------------------------------------------------
SUBSCH00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,SUBSCH98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
SUBSCH10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,SUBSCH98,SUBSCH90
          SUB       TCFORM6,OSESLOTS
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSESSLTN
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSESSLTR
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSESSLTS
          ENDIF
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      SUBSCH99
SUBSCH90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      SUBSCH10
          ENDIF
SUBSCH98  MOVE      ONE,EXIT
SUBSCH99  RETURN
+
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.*******************************************************************************
.------------------------------------------------------------
. Get Next Available Appointment by Clinic ID
.------------------------------------------------------------
NXTAID00  PACK      SAVKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          MATCH     SP70,NXTAIDKY
          GOTO      NXTAID80 IF NOT EQUAL
.
. Don't search for the next available appointment if it's a mosaiq visit
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE         * MOSAIQ Visit
            IF        @EQUAL
              MOVE      Z70,NXTAIDKY        * clear next appointment key
              GOTO      NXTAID80
            ENDIF
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,REQSLOTS
          MOVE      TCINDC1,REQTYPE                                    *I-58922
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          MOVE      KEY8,CALCDATE
          ADD       OSTMAXD,CALCDATE
.
          PACK      CHKKEY19,OBASITE,OBACTYP,OBACLIN,ZERO
          PACK      KEY35,OBASITE,OBACTYP,OBACLIN,ZERO,KEY8,SP70
          CALL      RDBOKA4
NXTAID10  CALL      RDKBOKA4
          BRANCH    OVRCD,NXTAID95
          PACK      KEY19,OBASITE,OBACTYP,OBACLIN,OBASTAT,SP70
          MATCH     CHKKEY19,KEY19
          GOTO      NXTAID95 IF NOT EQUAL
.
          MATCH     OBADATE,CALCDATE
          GOTO      NXTAID95 IF LESS
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NXTAID10
.
          MATCH     ANSZ,TCINDC2            * Can not reschedule to an over
          GOTO      NXTAID10 IF EQUAL       * booking
.
.******************************************** Start of addition        *I-58922
          MATCH     "1",OTCNRSST            * check parameter
          IF        @EQUAL
            MATCH     TCINDC1,REQTYPE       * test the visit type
            GOTO      NXTAID10 IF NOT EQUAL * not same visit type?
          ENDIF
.********************************************   End of addition        *I-58922
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,NXTAID10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,NXTAID10
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          BRANCH    MOSAIQCL,NXTAID10       * MOSAIQ Clinic
.
          MATCH     "1",OTHEMREF
          IF        @EQUAL
            MATCH     SP70,ALREVISN         * Check if referral populated when
            GOTO      NXTAID10 IF EQUAL     * referral is mandatory
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      NXTAIDKY,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          IF        REQSLOTS>1
            CALL      CHKSLT00
            BRANCH    EXIT,NXTAID10
          ENDIF
.
          CALL      RESSLT00
          BRANCH    EXIT,NXTAID10
.
NXTAID80  MOVE      NXTAIDKY,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,NXTAID95
.
          UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,NXTAID81,NXTAID82,NXTAID83
.
NXTAID81  WRITE     HTMLFILE;CASEKEYS;
          GOTO      NXTAID90
.
NXTAID82  UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " at ",OBATIME;
          GOTO      NXTAID90
.
NXTAID83  PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OCADESC;
            GOTO      NXTAID90
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          BRANCH    OVRCD,NXTAID90
.
          MATCH     OBASITE,OCASITE
          GOTO      NXTAID90 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      NXTAID90 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      NXTAID90
.
NXTAID90  MOVE      SAVKEY28,CASEKEYS
          MOVE      SAVKEY28,KEY28
          CALL      RDBOKA1

          MOVE      SAVKEY28,KEY25
          CALL      RDSESA1
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          GOTO      NXTAID99
.
NXTAID95  UNPACK    DIM127,KEY1,ANS,DIM127
.
. Don't search for the next available appointment if it's a mosaiq visit
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDIBALV1
          IF        OVRCD<>1
            MATCH     " M",IBAVTYPE              * MOSAIQ Visit
            GOTO      NXTAID97 IF EQUAL
          ENDIF
.
          MATCH     "3",ANS
          IF        @EQUAL
            MATCH     "1",OTCNRSST
            IF        @EQUAL
              WRITE     HTMLFILE;"No Slots Available - Visit Type";
            ELSE 
              WRITE     HTMLFILE;"No Slots Available";
            ENDIF
          ENDIF
.
NXTAID97  MOVE      Z70,NXTAIDKY          * clear next appointment key
          MOVE      SAVKEY28,CASEKEYS
          MOVE      SAVKEY28,KEY28
          CALL      RDBOKA1
.
          MOVE      SAVKEY28,KEY25
          CALL      RDSESA1
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
.
NXTAID99  RETURN
.
.*******************************************************************************
.                        Output Case List Table Search
.*******************************************************************************
SCSTAB00  MOVE      SP70,LINKPRG
          UNPACK    DIM127,D1,LINKPRG,DIM127
          PACK      LINKPRG,LINKPRG,SP70
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
SCSTAB10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,SCSTAB99          * end of session
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      SCSTAB99 IF NOT EQUAL   * different sessio
.
          COMPARE   SIX,OBASTAT
          GOTO      SCSTAB10 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      SCSTAB10 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      SCSTAB10 IF EQUAL
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      SCSTAB10 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
.
          COMPARE   TWO,ATTDFLAG
          GOTO      SCSTAB20 IF NOT EQUAL
          COMPARE   ZERO,OBASTAT
          GOTO      SCSTAB10 IF NOT EQUAL

SCSTAB20  IF        FULLONLY=1
            COMPARE   ZERO,OBASTAT
            GOTO      SCSTAB10 IF EQUAL
          ENDIF
          WRITE     HTMLFILE;"<tr><td align=center width=60 nowrap>";
          UNPACK    OBATIME,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>12
            SUB       "12",F2
            WRITE     HTMLFILE;F2,KEY1,DIMMIN," pm</td>";
          ELSE
            WRITE     HTMLFILE;F2,KEY1,DIMMIN," am</td>";
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            CALL      SMPTYS00
            GOTO      SCSTAB10
          ENDIF
          COMPARE   TWO,ATTDFLAG
          GOTO      SCSTAB10 IF EQUAL
.
          CALL      FULLS000
          GOTO      SCSTAB10
.
SCSTAB99  RETURN
.
.*******************************************************************************
.                            Show Empty Slot Search
.*******************************************************************************
SMPTYS00  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,CLNIDESC
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SMPTYS50
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SMPTYS50
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SMPTYS50
.
          MOVE      SP70,TDESC           * Clinic indicator description
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLNIDESC
          MOVE      TCINDC1,CLININDC
.
SMPTYS50  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      OCADESC,JAVSNAME
          CALL      JAVDES00
.
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>":
                             "<td>":
                             "<a href='javascript:updateParent(#"":
                             CASEKEYS,"#",#"":
                             JAVSNAME,"#",#"":
                            DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ":
                             OBATIME,"#",#"":
                             OBAVISIT,"#",#"":
                             OCTCTYP,"#",#"":
                             OCTDESC,"#",#"":
                             CLNIDESC,"#",#"":
                             CLININDC,"#",#"":
                             OTMAUMCI,"#",#"":
                             OTHECCAR,"#",#"":
                             OTHENDPS,"#",#"":
                             OTHENMDS,"#",#"":
                             OTHECART,"#",#"":
                             OTHESRVD,"#",#"":
                             OTHECLHR,"#",#"":
                             SP1,"#",#"":
                             OTHETCOD,"#",#"":
                             OTHEMREF,"#");'>":
                             "<img src=../images/AppointmentIcon.gif border=0>":
                             "</a></td>":
                             "<td>&nbsp;</td></tr>"
SMPTYS99 RETURN
+
.*******************************************************************************
. REMBOK00  - Remote script function to attend a booking.
.             This code is a direct copy of UPDBOK00 update type 1 Attendance
.             with remote script errors not web errors and details for
.             newslotk removed
.*******************************************************************************
REMBOK00  MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,REMBOK95,REMBOK93
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,REMBOK96
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,REMBOK85
          COMPARE   ONE,PCEASE
          IF        @EQUAL
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      REMBOK86 IF LESS
            ELSE
              GOTO      REMBOK86
            ENDIF
          ENDIF
          CALL      RDPMPX21
          BRANCH    OVRCD,REMBOK85
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      VALICD00
          BRANCH    EXIT,REMBOK99
.
.----------------------------------------
. Attendance
.----------------------------------------
REMBOK10  COMPARE   ONE,OBASTAT              * Is this a booking ?
          GOTO      REMBOK15 IF EQUAL
.
          GOTO      REMBOK94                 * Invalid status to attend
.
REMBOK15  CALL      ATTD0000                 * Attendance
          BRANCH    EXIT,REMBOK89
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          CALL      XCHG0000                 * Get the charge for this patient
          CALL      POSTCHRG                 * Post the charge to the Dtrof file
.
REMBOK80  MOVE      ONE,FLGOTBOK             * Set flag to yes so all records
          CALL      BOKUPD00                 * are written
          BRANCH    EXIT,REMBOK95,REMBOK96
.
REMBOK84  CALL      UPOB0000                * Update linked outpatient booking
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOA    * Send O/P Confirm Appointment message

          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Booking Updated",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      REMBOK99
.
REMBOK85  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Patient UR":
                    "</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK86  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Patient is Deceased":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Booking can't be attended in future":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Booking Record Locked":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK94  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            MOVE      "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            MOVE      "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>"
          WRITE     HTMLFILE;WEBTITLE:
                    "</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Case":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Booking Status":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      REMBOK99
.
REMBOK99  RETURN
.
.-------------------------------------------------------------
. Link to Prev Group of Suspended Appointments
.-------------------------------------------------------------
PRVSUS00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",LASTDATE
          REP       " +",VIEWTYPE
.
          WRITE     HTMLFILE;"outweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&srchclty=",SAVECLTY:
                                 "&srchclid=",SAVECLID:
                                 "&viewtype=",VIEWTYPE:
                                 "&lastdate=",LASTDATE;
.
          REP       "+ ",LASTDATE
          REP       "+ ",VIEWTYPE
.
PRVSUS99  RETURN
.
.-----------------------------------------------------------
. Link to Next Group of Suspended Appoimtments 
.-----------------------------------------------------------
NXTSUS00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",LASTDATE
          REP       " +",VIEWTYPE
.
          WRITE     HTMLFILE;"outweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&srchclty=",SAVECLTY:
                                 "&srchclid=",SAVECLID:
                                 "&viewtype=",VIEWTYPE:
                                 "&lastdate=",LASTDATE;
.
          REP       "+ ",LASTDATE
          REP       "+ ",VIEWTYPE
.
NXTSUS99  RETURN
.
.------------------------------------------------------------------------------
. Update Cancelled Appointment Details          
.------------------------------------------------------------------------------
UPDCAN00  COMPARE   ZERO,UPDATETY
          GOTO      UPDCAN40 IF EQUAL
.
          COMPARE   ONE,UPDATETY    * Update formaction
          GOTO      UPDCAN20 IF EQUAL
.
          GOTO      UPDCAN90
.
.         ************ UPDATE FORMACTION **********
.
UPDCAN20  PACK      KEY8,ADMISSNO,SP70
          BRANCH    OTXFLAG,UPDCAN30        * bypass if no comments    *I-48413
          CALL      UPCOM000                * update text comments     *I-48413
.
UPDCAN30  CALL      RDOTCAN1                                           *C-48413
          BRANCH    OVRCD,UPDCAN91,UPDCAN92
.
          MATCH     Z70,OUTBB053
          IF        !@EQUAL
            MOVE      OUTBB053,OPCNREAS          * Moves cgi to file variables
          ENDIF
.
          CALL      UPOTCAN1                     * Updates the data
.
          CALL      COPD0000                     * Write OPD Cancel action
.
          MOVE      ZERO,EXIT
          GOTO      UPDCAN99
.
.
.         ************ DISPLAY FORMACTION **********
.
UPDCAN40  PACK      KEY8,ADMISSNO,SP70
          CALL      RDOTCAN1                      * Read department table
          IF        OVRCD=1
            CALL      CLOUTCAN                    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Cancelled Appointments",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,UPDCAN99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      UPDCAN99
.
UPDCAN90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAN99
.
UPDCAN91  MOVE      "Invalid Case Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAN99
.
UPDCAN92  MOVE      "Cancellation Details Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAN99
.
UPDCAN99  CLOSE     COMFILOF,DELETE
          RETURN
.-----------------------------------------------------------
OPCN0000  BRANCH    FLDITMNO,OPCN0100,OPCN0200,OPCN0300,OPCN0400,OPCN0500:
                             OPCN0600
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      OPCN9999
.
OPCN0100  MOVE      "CB",CATEGORY                * Cancellation Reason
          MOVE      OPCNREAS,CODE
          CALL      CODITM00
          GOTO      OPCN9999
.
OPCN0200  WRITE     HTMLFILE;ADMISSNO;
          GOTO      OPCN9999
.
OPCN0300  REP       " +",OPCNURNO
          REP       " +",ADMISSNO
          UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",OPCNURNO:
                                 "&admissno=",ADMISSNO;
          REP       "+ ",OPCNURNO
          REP       "+ ",ADMISSNO
          GOTO      OPCN9999
.
OPCN0400  WRITE     HTMLFILE;OPCNURNO;
          GOTO      OPCN9999
.
OPCN0500  CALL      RDCM0000            * read cancellation comments   *I-48413
          GOTO      OPCN9999                                           *I-48413
.
OPCN0600  UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      KEY2,COMMTYPE           * OPD Comment type
          MOVE      OPCNURNO,COMMURNO   
          MOVE      OPCNRDTE,COMMADAT
          MOVE      OPCNRTIM,COMMATIM
.
          CALL      DISCOM00                * Display OPD comments
          GOTO      OPCN9999
.
OPCN9999  RETURN
.
.**********************************************************************
.*                               GCST0000                             *
.*        Get Clinic Status                                           *
.**********************************************************************
GCST0000  PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP10
          CALL      RDSBOKA1
          BRANCH    OVRCD,GCST9999
.
          CALL      RDKBOKA1
          BRANCH    OVRCD,GCST9999
          MATCH     OSESITE,OBASITE
          GOTO      GCST9999 IF NOT EQUAL
          MATCH     OSECLIN,OBACLIN
          GOTO      GCST9999 IF NOT EQUAL
          MATCH     OSEDATE,OBADATE
          GOTO      GCST9999 IF NOT EQUAL
          MATCH     OSESTRT,OBASTRT
          GOTO      GCST9999 IF NOT EQUAL
.
          PACK      OSESCSTT,OBASESST,SP10
.
GCST9999  RETURN
.
.------------------------------------------------------------
. Visit Type Selection Options 
. Category CV - Indictor 6 ="U"navailable slot type
. OVERBOOK - 0 = Do not display over bookings sloty types
. OVERBOOK - 1 = Only display over bookings sloty types
. Only display visit types linked to the clinic type if any exists
. otherwise display all
.------------------------------------------------------------
VTYSEL00  MOVE      ZERO,OVERBOOK
          MOVE      ZERO,LINKVTYP           * Display all visit types
.
          PACK      KEY15,OTHESITE,OTHECTYP,SP70
          CALL      RSOTCVT1
          CALL      RKOTCVT1                * Check the clinic type for
          BRANCH    OVRCD,VTYSEL05          * linked visit types
.
          MATCH     OTHESITE,OCVTSITE       * Same Site
          GOTO      VTYSEL05 IF NOT EQUAL
.
          MATCH     OTHECTYP,OCVTCTYP       * Same Clinic Type
          GOTO      VTYSEL05 IF NOT EQUAL
.
          MOVE      ONE,LINKVTYP            * Only display linked visit types
.
VTYSEL05  PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH    ANSZ,TCINDC2
            IF       @EQUAL
              MOVE     ONE,OVERBOOK        * Yes only display over booking types
            ENDIF
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
VTYSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,VTYSEL99
.
          MATCH     CATEGORY,TCODE
          GOTO      VTYSEL99 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      VTYSEL10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      VTYSEL10 IF EQUAL
.
          IF        VISTFLAG=0
            MATCH     "U",TCINDC6           * Skip unavailable
            GOTO      VTYSEL10 IF EQUAL
.
            IF        OVERBOOK =1
              MATCH     ANSZ,TCINDC2          * Skip over bookings
              GOTO      VTYSEL10 IF NOT EQUAL
            ELSE
              MATCH     ANSZ,TCINDC2          * Skip over bookings
              GOTO      VTYSEL10 IF EQUAL
            ENDIF
          ENDIF
.
          IF        VISTFLAG=1
            MATCH     "U",TCINDC6           * Only display unavailable
            GOTO      VTYSEL10 IF NOT EQUAL
          ENDIF
.
          IF        VISTFLAG=2
            MATCH     "U",TCINDC6           * Exclude unavailable
            GOTO      VTYSEL10 IF EQUAL
.
            MATCH     ANSZ,TCINDC2          * Display over bookings for add
            GOTO      VTYSEL50 IF EQUAL
.
            MATCH     ANSN,TCINDC1          * Skip new slots
            GOTO      VTYSEL50 IF EQUAL
.
....        IF        TCFORM6 > ONE
....          GOTO     VTYSEL10             * Skip if not a single slot
....        ENDIF
          ENDIF
.
VTYSEL50  PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            IF        PTCNHDPS=1
              MATCH     "N",TCINDC9
              GOTO      VTYSEL90 IF EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY20," selected>":
                               TDESC,"</option>"
            GOTO      VTYSEL10
          ENDIF
.
          IF        LINKVTYP=1
            PACK      KEY15,OTHESITE,OTHECTYP,ACODE,SP70
            CALL      RDOTCVT1          * Only display linked visit types
            BRANCH    OVRCD,VTYSEL10
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,VTYSEL10
            ENDIF
          ENDIF
.
VTYSEL90  WRITE     HTMLFILE;"<option value=",KEY20,">",TDESC,"</option>"
          GOTO      VTYSEL10
.
VTYSEL99  RETURN
+
.**********************************************************************
.*  HTMS0000  - Output tag to indicate if this booking is part of a   *
.*              series or not. 1=Yes 0=NO                             *
.**********************************************************************
HTMS0000  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY24,URNUMBER,ADMISSNO,SP70 * Is this a master record
          CALL      RDOTLKB1
          BRANCH    OVRCD,HTMS1000
.
          GOTO      HTMS8600
.
HTMS1000  PACK      KEY24,URNUMBER,ADMISSNO,SP70 * Check non master records
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,HTMS8500
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      HTMS8500 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTLKLBOK
          GOTO      HTMS8500 IF NOT EQUAL
.
HTMS8000  IF        F1=1
            WRITE     HTMLFILE;"Series";       * Yes this is part of a series
          ELSE
            WRITE     HTMLFILE;ONE;            * Yes this is part of a series
          ENDIF
          GOTO      HTMS9999
.
HTMS8500  IF        F1=1
            WRITE     HTMLFILE;" ";           * No this is not part of a series
          ELSE
            WRITE     HTMLFILE;ZERO;          * No this is not part of a series
          ENDIF
          GOTO      HTMS9999
.
HTMS8600  IF        F1=2
            WRITE     HTMLFILE;TWO;           * Yes this is a master series book
            GOTO      HTMS9999
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;" Master Series";  * Yes this is part of a series
          ELSE
            WRITE     HTMLFILE;ONE;            * Yes this is part of a series
          ENDIF
.
HTMS9999  RETURN
.
.
.**********************************************************************
.*  CHKS0000  - Check if this bookings is part of a series            *
.*              Returns BOOKSERS 1=Yes 0=NO                           *
.**********************************************************************
CHKS0000  MOVE      ZERO,BOOKSERS
          PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Is this a master record
          CALL      RDOTLKB1
          BRANCH    OVRCD,CHKS1000
.
          GOTO      CHKS8000
.
CHKS1000  PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Check non master records
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,CHKS8500
.
          MATCH     OBAURNO,OTLKURNO
          GOTO      CHKS8500 IF NOT EQUAL
.
          MATCH     DOBAOUTN,OTLKLBOK
          GOTO      CHKS8500 IF NOT EQUAL
.
CHKS8000  MOVE      ONE,BOOKSERS             * Yes this is part of a series
          GOTO      CHKS9999
.
CHKS8500  MOVE      ZERO,BOOKSERS            * No this is not part of a series
          GOTO      CHKS9999
.
CHKS9999  RETURN
+
.------------------------------------------------------------------------------
. Schedule outpatient form printing
.------------------------------------------------------------------------------
PRTFRM00  COMPARE   ZERO,UPDATETY
          GOTO      PRTFRM70 IF EQUAL
.
          COMPARE   ONE,UPDATETY            * Print Outpatient Form
          GOTO      PRTFRM20 IF EQUAL
.
          COMPARE   TWO,UPDATETY            * Print Bulk Claim Forms
          GOTO      PRTFRM30 IF EQUAL
.
          COMPARE   THREE,UPDATETY          * Post CMBS Template to Clinic     
          GOTO      PRTFRM40 IF EQUAL
.
          GOTO      PRTFRM90
.
.         ************ Schedule Print Form **********
.
PRTFRM20  CALL      SFRM0000                * Schedule form printing
          GOTO      PRTFRM99
.
.         ************ Schedule Print Bulk Claim Forms **********
.
PRTFRM30  CALL      SBCP0000                * Schedule bulk claims printing
          GOTO      PRTFRM99
.
.         ************ Post CMBS Template to all patients within clinic *****
.
PRTFRM40  CALL      PMBS0000                * Post CMBS Template to a clinic
          BRANCH    EXIT,PRTFRM91
          GOTO      PRTFRM99
.
.         ************ DISPLAY FORMACTION **********
.
PRTFRM70  CLEAR     WEBTITLE
          MOVE      "Outpatient Form Printing",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRTFRM99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRTFRM99
.
PRTFRM90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTFRM99
.
PRTFRM91  MOVE      "CMBS Template does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTFRM99
.
PRTFRM99  RETURN
.
.------------------------------------------------------------------------------
. Schedule outpatient form printing
.------------------------------------------------------------------------------
SFRM0000  MATCH     SP70,CASEKEYS
          GOTO      SFRM3000 IF EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,SFRM9000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SFRM9000
.
          GOTO      SFRM5000
.
SFRM3000  MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SFRM9000
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SFRM9000
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      SFRM9000 IF NOT EQUAL
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
SFRM5000  MATCH     "1",CLAIMPRT
          IF        @EQUAL
            CALL      HICCLAIM                * writes record to hicclmaf
            BRANCH    EXIT,SFRM8000,SFRM8000
            MOVE      "HICCLM",STATNCOD
          ENDIF
          MOVE      SELPRINT,SCHDPRNT
          MOVE      NOCOPIES,SCHDCOPY

          MOVE      STATNCOD,STATNCOD
          MOVE      SP70,LETTNCOD
          MOVE      ONE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
SFRM8000  MOVE      ZERO,EXIT
          GOTO      SFRM9999

SFRM9000  MOVE      "Invalid Case.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SFRM9999
.
SFRM9999  RETURN
.
.------------------------------------------------------------------------------
. Schedule bulk claims printing
.------------------------------------------------------------------------------
SBCP0000  MOVE      ONE,CLMCOUNT
SBCP1000  MOVE      CLMRECKY[CLMCOUNT],CASEKEYS
          REP       "+ ",CASEKEYS
          MATCH     SP70,CASEKEYS           * Any more records to print?
          GOTO      SBCP9500 IF EQUAL
.
          MOVE      ZERO,EXIT
          CALL      HICCLAIM                * writes record to hicclmaf
          BRANCH    EXIT,SBCP9000,SBCP9000
.
          MOVE      CLAIMPSL,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "HICCLM",STATNCOD
          MOVE      ZERO,LETTNCOD
          MOVE      ONE,PRNTTYPE
.
          MOVE      OUTCLAIM,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
SBCP9000  ADD       ONE,CLMCOUNT
          GOTO      SBCP1000
.
SBCP9500  MOVE      ZERO,EXIT
SBCP9999  RETURN
.
.------------------------------------------------------------------------------
. Post CMBS Template to all patients in a clinic
.------------------------------------------------------------------------------
PMBS0000  UNPACK    SESSKEYS,DIM12,CMBSDATE,DIM8
          CALL      TMBS0000                * Get common CMBS template items
          BRANCH    EXIT,PMBS9500
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
PMBS1000  CALL      RDKBOKA1                * loop booking file
          BRANCH    OVRCD,PMBS9000
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      PMBS9000 IF NOT EQUAL   * different session
.
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      PMBS1000 IF EQUAL
.
          PACK      KEY16,OBAOUTNO,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * check for hic claim record
          BRANCH    OVRCD,PMBS5000
.
          MATCH     DOBAOUTN,HCCLVISN
          GOTO      PMBS5000 IF NOT EQUAL   * Different visit number
.
          MATCH     " 1",HCCLSTAT
          GOTO      PMBS1000 IF EQUAL       * don't post if batched claim exists
.
PMBS5000  CALL      PITM0000                * post cmbs template to patient
          GOTO      PMBS1000
.
PMBS9000  MOVE      ZERO,EXIT               * ok
          GOTO      PMBS9999
.
PMBS9500  MOVE      ONE,EXIT                * error posting cmbs template
PMBS9999  RETURN
.
.------------------------------------------------------------------------------
. Post CMBS Template to outpatient item table
.------------------------------------------------------------------------------
PITM0000  PACK      KEY10,OBAOUTNO,SP10
          CALL      RSOTBIT1
          CALL      RKOTBIT1
          BRANCH    OVRCD,PITM1000
          MATCH     DOBAOUTN,OTBIVISN
          GOTO      PITM1000 IF NOT EQUAL    * Different visit number
.
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      DEOTBIT1
          GOTO      PITM0000
.
PITM1000  MOVE      ZERO,F2
          MOVE      ZERO,FORM2
          MOVE      OBAOUTNO,OTBIVISN         * Visit number
.
PITM1200  COMPARE   FIVE,F2
          GOTO      PITM9999 IF EQUAL         * reach maximum of 5 MBS items
          ADD       ONE,F2

          MOVE      ITEMFLAG[F2],OTBIIFLG     * item type
.
          MATCH     Z70,OTBIIFLG
          GOTO      PITM1200 IF EQUAL
.
          MATCH     SP70,OTBIIFLG
          GOTO      PITM1200 IF EQUAL
.
          MOVE      ITEMNUMB[F2],OTBIITMN     * item number
          MOVE      ITEMSUBN[F2],OTBISUBN     * subitem number
.
          MATCH     SP70,OTBIITMN
          GOTO      PITM1200 IF EQUAL
.
          MATCH     Z70,OTBIITMN
          GOTO      PITM1200 IF EQUAL
.
          ADD       ONE,FORM2
          MOVE      FORM2,OTBIITMC
.
          MOVE      OBADATE,OTBIDATE
          MOVE      OBAURNO,OTBIURNO
          MOVE      "0",OTBISTAT
          UNPACK    SP70,OTBICDAT,OTBICTIM,OTBICUID
          UNPACK    SP70,OTBIUDAT,OTBIUTIM,OTBIUUID
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      RAOTBIT1
          IF        OVRCD=1
            MOVE      KEY8,OTBICDAT             * date created
            CLOCK     TIME,OTBICTIM             * time created
            MOVE      USERID,OTBICUID           * web user id
            CALL      WROTBIT1
          ELSE
            MOVE      KEY8,OTBIUDAT             * date updated
            CLOCK     TIME,OTBIUTIM             * time updated
            MOVE      USERID,OTBIUUID           * web user id
            CALL      UPOTBIT1
          ENDIF
          GOTO      PITM1200
.
PITM9999  RETURN
.
.------------------------------------------------------------------------------
. Get common CMBS template items
. INPUTS: CMBSTEMP - Common Template ID
.         CMBSDATE - Date (eg clinic date) to compare to 'effective date'
.------------------------------------------------------------------------------
TMBS0000  MOVE      ZERO,ITMCOUNT                * init item counter
          PACK      KEY8,CMBSTEMP,SP70
          CALL      RSPRTDT1
          CALL      RKPRTDT1                     * read template id file
          BRANCH    OVRCD,TMBS9500
.
          MATCH     CMBSTEMP,PRTDTMID            * check if template id exists
          GOTO      TMBS9500 IF NOT EQUAL
.
          CALL      RPPRTDT1
TMBS1000  CALL      RKPRTDT1                     * loop thru template id file
          BRANCH    OVRCD,TMBS9000
.
          MATCH     CMBSTEMP,PRTDTMID
          GOTO      TMBS8000 IF NOT EQUAL        * same template id?
.
          PACK      KEY2,SP1,PRTDTYPE
          PACK      KEY22,KEY2,PRTDCODE,PRTDSUBI,Z70
          CALL      RSPRIT1
TMBS2000  CALL      RPPRIT1                      * validate each item
          BRANCH    OVRCD,TMBS8000
.
          MATCH     KEY2,DPRITFLG
          GOTO      TMBS8000 IF NOT EQUAL
.
          MATCH     PRTDCODE,PRITITMN
          GOTO      TMBS8000 IF NOT EQUAL
.
          MATCH     SP70,PRTDSUBI
          IF        !@EQUAL
            MATCH     PRTDSUBI,PRITSUBN
            GOTO      TMBS8000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CMBSDATE
          IF        !@EQUAL
            MATCH     PRITDAT1,CMBSDATE
            GOTO      TMBS2000 IF LESS
          ENDIF
          GOTO      TMBS8500
.
TMBS8000  MOVE      SP70,DPRITFLG                * clear item vars
          MOVE      SP70,PRITITMN
          MOVE      SP70,PRITSUBN
.
TMBS8500  ADD       ONE,ITMCOUNT
          MOVE      DPRITFLG,ITEMFLAG[ITMCOUNT]  * save item type
          MOVE      PRITITMN,ITEMNUMB[ITMCOUNT]  * save item number
          MOVE      PRITSUBN,ITEMSUBN[ITMCOUNT]  * save subitem number
.
          IF        ITMCOUNT < 5
            GOTO      TMBS1000                   * only want max of 5 items
          ENDIF
.
TMBS9000  MOVE      ZERO,EXIT                    * ok
          GOTO      TMBS9999
.
TMBS9500  MOVE      ONE,EXIT                     * error loading cmbs template
TMBS9999  RETURN
+
.-----------------------------------------------------------------------------
. CLWTOS00 - Clear waiting list pre anawsthetic outpatient link file
.-----------------------------------------------------------------------------
CLWTOS00  MOVE      SP70,WTOSURNO
          MOVE      SP70,WTOSCODE
          MOVE      SP70,WTOSCOUN
          MOVE      SP70,WTOSSITE
          MOVE      SP70,WTOSCLIN
          MOVE      SP70,WTOSDATE
          MOVE      SP70,WTOSSTRT
          MOVE      SP70,WTOSSLOT
          MOVE      SP70,WTOSOUTN
          MOVE      SP70,WTOSOSTA
          MOVE      SP70,WTOSPDAT
          MOVE      SP70,WTOSPTIM
          MOVE      SP70,WTOSSTAT
          MOVE      SP70,WTOSCDAT
          MOVE      SP70,WTOSCTIM
          MOVE      SP70,WTOSCUID
          MOVE      SP70,WTOSUDAT
          MOVE      SP70,WTOSUTIM
          MOVE      SP70,WTOSUUID
          MOVE      SP70,WTOSSPAR
.
CLWTOS99  RETURN
.
.*******************************************************************************
.                     Output Print Group Labels List Table             * I-47446
.*******************************************************************************
PRGPLB00  MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
PRGPLB10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,PRGPLB99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      PRGPLB99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      PRGPLB10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      PRGPLB10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      PRGPLB10 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          MATCH     ANSC,TCINDC8                 * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV                * Yes
          ELSE
            MOVE     ZERO,CHARTREV               * No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr height=25>":
                              "<td align=right bgcolor=magenta>":
                              OBASLOT,"</td>":
                              "<td align=center bgcolor=magenta nowrap>":
                                  OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               IF        CHARTREV=1
                 WRITE     HTMLFILE;"<tr height=25><td align=right ":
                                    "class=#"ChartReview#">":
                                    OBASLOT,"</td>":
                                    "<td align=center class=#"ChartReview#">":
                                    OBATIME,"</td>":
                                    "<td class=#"ChartReview#">&nbsp;":
                                    VTYPDESC,"</td>";
               ELSE
                 WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                    OBASLOT,"</td>":
                                    "<td align=center>",OBATIME,"</td>":
                                    "<td>&nbsp;",VTYPDESC,"</td>";
               ENDIF
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              IF        CHARTREV=1
                WRITE     HTMLFILE;"<td class=#"ChartReview#">&nbsp;</td>":
                                   "<td align=center class=#"ChartReview#">"
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                   "<td align=center>"
              ENDIF
            ENDIF
            GOTO      PRGPLB20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      PRGPLB20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            IF        CHARTREV=1
              WRITE     HTMLFILE;"<td class=#"ChartReview#">",FORMATNM,"</td>":
                                 "<td align=center class=#"ChartReview#">"
            ELSE
              WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                                 "<td align=center>"
            ENDIF
          ENDIF
          GOTO      PRGPLB20
.
PRGPLB20  IF        (OBASTAT=1|OBASTAT=4)
            WRITE     HTMLFILE;"<input type=checkbox name=slotkeys checked ":
                               "value='",OBASLOT,"'></td></tr>"
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=slotkeys ":
                               "value='",OBASLOT,"'></td></tr>"
          ENDIF
.
          GOTO      PRGPLB10
.
PRGPLB99  RETURN
.------------------------------------------------------------------------------
. Schedule Group Label Printing                                       * I-47446
.------------------------------------------------------------------------------
PRTGPL00  COMPARE   ZERO,UPDATETY
          GOTO      PRTGPL70 IF EQUAL
.
          COMPARE   ONE,UPDATETY
          GOTO      PRTGPL20 IF EQUAL
.
          COMPARE   TWO,UPDATETY
          GOTO      PRTGPL30 IF EQUAL
.
          GOTO      PRTGPL90
.
.         ************ Schedule Print Labels **********
.
PRTGPL20  CALL      SGPL0000                * Schedule group label printing
          CALL      PRTMRT00                * MRT barcode label printing
          GOTO      PRTGPL99
.
PRTGPL30  CALL      SGLB0000                * Schedule group label printing
          GOTO      PRTGPL99
.
.         ************ DISPLAY FORMACTION **********
.
PRTGPL70  CLEAR     WEBTITLE
          MOVE      "Group Label Printing",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRTGPL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL99  RETURN
.------------------------------------------------------------------------------
. Schedule Group Label Printing                                       * I-47446
.------------------------------------------------------------------------------
SGPL0000  MOVE      ZERO,SLOTCNT
.
SGPL0010  COMPARE   "99",SLOTCNT
          GOTO      SGPL9999 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      SGPL9999
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,SGPL0010
.
          CALL      PRNT0000
.
          GOTO      SGPL0010
.
SGPL9999  RETURN
.------------------------------------------------------------------------------
. Schedule Group Label Printing                                       * I-47446
.------------------------------------------------------------------------------
SGLB0000  PACK      SESSKEYS,GPLBL001,CLINICID,GPLBL002,GPLBL003,SP70
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
SGLB0100  CALL      RDKBOKA1
          BRANCH    OVRCD,SGLB9999
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     SESSKEYS,KEY25
          GOTO      SGLB9999 IF NOT EQUAL
.
          CALL      PRNT0000
.
          GOTO      SGLB0100
.
SGLB9999  RETURN
.
.------------------------------------------------------------------------------
. Group Label Tags                                                    * I-47446
.------------------------------------------------------------------------------
GPLB0000  BRANCH    FLDITMNO,GPLB0100
.
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      GPLB9999
.
GPLB0100  UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GPLB0110,GPLB0120
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,GPLB9999
          WRITE     HTMLFILE;OSTDESC;        * Description
          GOTO      GPLB9999
GPLB0110  WRITE     HTMLFILE;WBSESIT;       * Code
          GOTO      GPLB9999
GPLB0120  MOVE      WBSESIT,SITECODE
          CALL      SELSIT00                 * Options
          GOTO      GPLB9999
.
GPLB9999  RETURN
.
.------------------------------------------------------------------------------
. Set GPLBL Parameters                                                * I-47446
.------------------------------------------------------------------------------
GRPLBL00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,GRPLBL01,GRPLBL02,GRPLBL03
.
          MOVE      ONE,EXIT
          GOTO      GRPLBL99
.
GRPLBL01  MOVE      QRYDATA,GPLBL001
          GOTO      GRPLBL99
.
GRPLBL02  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      GPLBL002,CCENT,CYEAR,CMON,CDAY
          GOTO      GRPLBL99
.
GRPLBL03  MOVE      QRYDATA,GPLBL003
          GOTO      GRPLBL99
.
GRPLBL99  RETURN
.
.-----------------------------------------------------------------------
. Retrieve the all visit comment details
.-----------------------------------------------------------------------
VICMNT00  MOVE      OBAOUTNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
VICMNT10  CALL      RPVSMDT1
          BRANCH    OVRCD,VICMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VICMNT10 IF EQUAL
.
. Retrieve comment header
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     SP70,VSCMDATE
            GOTO     VICMNT20
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VSCMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VICMNT20  PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSENAM,VSCMUSRN
          ELSE
            MOVE      VSMDUSER,VSCMUSRN
          ENDIF
          STRIP     VSCMUSRN
.
VICMNT30  PACK      VSCMLINE,VSCMDATE,SP1,VSMDTIME,SP1,VSCMUSRN,SP1,VSMDOCCG
          STRIP     VSCMLINE
          MOVELPTR  VSCMLINE,F3
.
          IF        F3 > 0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
.
          MOVE      VSCMLINE,VAR
          PACK      D2,QUOTE,SP70
          REP       D2,VAR
          WRITE     HTMLFILE;VAR,"<br>";
          SFORMAT   VAR,70
.
          CALL      VICMTX00
.
          GOTO      VICMNT10
.
VICMNT99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
VICMTX00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VICMTX20  CALL      RKVSMTX1
          BRANCH    OVRCD,VICMTX99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VICMTX99 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,F3
.
          IF        F3 > 0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
.
          MOVE      VSMTCMNT,VAR
          PACK      D2,QUOTE,SP70
          REP       D2,VAR
          WRITE     HTMLFILE;VAR,"<br>";
          SFORMAT   VAR,70
.
          GOTO      VICMTX20
.
VICMTX99  RETURN
.
.******************************************************************************
.      write a record to the Referral Status History Table
.******************************************************************************
WRTRSH00  MOVE      ALREVISN,ALSTVISN       * Populate all the fields and write
          MOVE      ALRESTAT,ALSTSTAT
          PACK      ALSTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      WBSEUID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RAALSTS1
          IF        OVRCD=0
            CALL      UPALSTS1                * update to the file
          ELSE
            CALL      WRALSTS1                * write to the file
          ENDIF
.
WRTRSH99  RETURN
+
.*******************************************************************************
.                    Get Outpatient Sessions for a Range
.*******************************************************************************
FREF0000  PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
FREF1000  CALL      RDKSESA6
          BRANCH    OVRCD,FREF9999
.
          MATCH     WBSESIT,OSESITE
          GOTO      FREF9999 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      FREF9999 IF LESS
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      FREF1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,FREF1000
          BRANCH    OMASTAT,FREF1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,FREF1000
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,FREF1000
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      FREF1000 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLISTB10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      FREF1000 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      FREF1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      FREF1000 IF NOT EQUAL
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,FREF1000
.
FREF5000  MOVE      ZEROVISN,LASTOUTN
          MOVE      ZERO,RECCNT
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
FREF5100  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,FREF1000          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      FREF1000 IF NOT EQUAL   * different sessio
.
          COMPARE   SIX,OBASTAT
          GOTO      FREF5100 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      FREF5100 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      FREF5100 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      FREF5100 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
          MOVE      SP70,OTXWDESC
.
          IF        (OBASTAT=0|OBASTAT=9|OBASTAT=7)
            GOTO      FREF5100 * Skip Empty
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,FREF5100
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,FREF5100          * invalid UR number
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                * read 2nd master file extension
          BRANCH    OVRCD,FREF5100          * invalid UR number
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * To get Patient Name
          CALL      PATFLD00                * Patient Folder
.
          MOVE      SP70,DISPMDAT
          MATCH     SP70,PMPXMEDC
          IF        !@EQUAL
            UNPACK    PMPXMEDC,CCENT,CYEAR,CMON,CDAY
            PACK      DISPMDAT,CMON,SLASH,CCENT,CYEAR,SP70
          ENDIF
.
          PACK      REFRLINK,SP70,SP70
          CLEAR     REFRLINK
          APPEND    "javascript:LinkRef('",REFRLINK
          APPEND    OBAURNO,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    DOBAOUTN,REFRLINK
          APPEND    "')",REFRLINK
          RESET     REFRLINK
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
FREF5500  CALL      RKALLNK2                * check for associated referral
          IF        OVRCD=1
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FREF5600
          ENDIF
.
          MATCH     DOBAOUTN,ALLNLNKV
          IF        !@EQUAL
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FREF5600
          ENDIF
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1                * get associated referral details
          IF        OVRCD=1
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FREF5600
          ENDIF
.
          CALL      GHCST000                * Get hic claim status
.
          CLEAR     REFRLINK
          APPEND    "javascript:UpdateRef('",REFRLINK
          APPEND    ALREURNO,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    ALREVISN,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    ALREDEPT,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    DOBAOUTN,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    DISPCLMN,REFRLINK
          APPEND    "')",REFRLINK
          RESET     REFRLINK
.
          MOVE      "Yes",DISRSTAT
          CALL      SETI0000                * Set highlight colour
.
FREF5600  MATCH     "1",EXPRICON            * Only display due to expire, no ref
          GOTO      FREF5100 IF EQUAL       * and missing details referrals
.
          MOVE      ZERO,COMTFLAG
          MOVE      SP70,COMMLINK
.
          MOVE      "006",DIM3  
.
          PACK      KEY14,OBAOUTNO,DIM3,SP70
          CALL      RSVSCMT1
FREF5700  CALL      RKVSCMT1
          BRANCH    OVRCD,FREF6000
.
          MATCH     DOBAOUTN,VSCTVIST
          GOTO      FREF6000 IF NOT EQUAL
.
          MATCH     DIM3,VSCTTYPE                * HIC claim comments
          GOTO      FREF6000 IF NOT EQUAL
.
          MOVE      ONE,COMTFLAG
.
          CLEAR     COMMLINK
          APPEND    "javascript:UpdateComm('",COMMLINK
          APPEND    OBAOUTNO,COMMLINK
          APPEND    "','",COMMLINK
          APPEND    OBAURNO,COMMLINK
          APPEND    "')",COMMLINK
          RESET     COMMLINK
.
FREF6000  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          RESET     HTMLLINK
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000
          ELSE
            CALL      CLPMSCEX              * Clear extra contacts if not used
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBATIME,"#",":     
                             "#"",OBAVISIT,"#",":     
                             "#"",OBAURNO,"#",":     
                             "#"",FORMATNM,"#",":     
                             "#"",KEY3,"#",":     
                             "#"",PMEDI," ",PTMXMCCD,"#",":     
                             "#"",DISPMDAT,"#",":     
                             "#"",ALREREXP,"#",":     
                             "#"",OBACOMP,"#",":     
                             "#"",PTELEP," ",PMPXMBNO,"#",":    * 10
                             "#"",PMPXMMNO,"#",":     
                             "#"",EXPRICON,"#",":     
                             "#"",DISRSTAT,"#",":     
                             "#"",COMTFLAG,"#",":           * Comments Yes/No
                             "#"",COMMLINK,"#",":           * Comment URL
                             "#"",REFRLINK,"#",":           * Comment URL
                             "#"",DISPCLMN,"#",":           * Claim Number
                             "#"",PMCETELM,"#",":
                             "#"",PMCETELP," ",PMCETELB,"#",":
                             "#"",PTELEP," ",PTELEB,"#",":
                             "#"",PTMXCELL,"#",":
                             "#"",PTELEP," ",PTELEB," ",PTMXCELL,"#",": * 22
                             "#"",PMPXMBNO," ",PMPXMMNO,"#");"          * 23
.
          GOTO      FREF5100
.
FREF9999  RETURN
.
.-----------------------------------------------------------------------------.
. Set table highlight/expiry colours
. HIGHCOLR - 0 = Red, 1 = Green, 2 = Orange, 3 = Poo, 4=Blank
.-----------------------------------------------------------------------------.
SETI0000  MOVE      ONE,EXPRICON            * set col=green
.
          PACK      KEY5,ANSC,ANSI,OTHECIND,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETI9999
.
          MATCH     ANSP,TCINDC1            * only highlight ffs clinics
          GOTO      SETI9999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETI9999
.
          MATCH     ANSC,TCINDC3            * only highlight medicare patients
          GOTO      SETI5000 IF NOT EQUAL
.
          MATCH     SP70,ALRERTYP           * If no referral type, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETI9999
          ENDIF
.
...       MATCH     SP70,DISPCMBS           * If no cmbs items, col=red
...       IF        @EQUAL
...         MOVE      ZERO,EXPRICON
...         GOTO      SETI9999
...       ENDIF
.
          MATCH     SP70,PMEDI              * If no medicare number, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETI9999
          ENDIF
.
          MATCH     SP70,PTMXMCCD           * If no medicare ref number, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETI9999
          ENDIF
.
          MATCH     SP70,PMPXMEDC           * If no medicare expiry date,col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETI9999
          ENDIF
.
. Check referral expiry date
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      SETI9999 IF EQUAL
.
          MATCH     ALREREXP,OBADATE        * If expiry<=Clinic date, col=red
          IF        !@LESS
            MOVE      ZERO,EXPRICON
            GOTO      SETI9999
          ENDIF
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETI9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      SETI9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    OBADATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     TWO,EXPRICON
          ENDIF
          GOTO      SETI9999
.
. Check for unexpected claim code
.
SETI5000  MATCH     "2",TCINDC9             * public?
          GOTO      SETI6000 IF EQUAL
.
          MATCH     "1",TCINDC1             * international?
          GOTO      SETI6000 IF EQUAL
.
          MOVE      ZERO,FORM2
SETI5500  ADD       ONE,FORM2
          COMPARE   SIX,FORM2               * wcomp, tac or dva?
          GOTO      SETI9999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      SETI6000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      SETI6000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      SETI6000 IF EQUAL
          GOTO      SETI5500
.
SETI6000  MOVE      THREE,EXPRICON          * unexpected claim code
.
SETI9999  RETURN
.
.*******************************************************************************
.                    Get Outpatient Sessions for a Range
.*******************************************************************************
CLSRCH00  MOVE      ZERO,LOOPCNTR
.
          MOVE      ZERO,RECCNT
          MOVE      LASTDATE,SEARCHTO       * Search to date
          ADD       OSTMAXD,SEARCHTO        * Add site max search days
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.                                           
          MOVE      SIX,INDEXNUM          * Index site, date
.
.         Use different index for WA (CAR 276671)
.
          IF        PTCNHDPS=6
            MATCH     SP70,SRCHCLTY
            IF        !@EQUAL
              MOVE      FOUR,INDEXNUM     * Index site, clinic type
            ENDIF
          ELSE
            MATCH     SP70,SRCHCLTY
            IF        !@EQUAL
              MOVE      SEVEN,INDEXNUM    * Index site, clinic type
            ENDIF
          ENDIF
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MOVE      ONE,INDEXNUM        * Index site, clinic id
          ENDIF
.
          IF        INDEXNUM=1
            PACK      KEY25,WBSESIT,SRCHCLID,FRSTDATE,SP70
            CALL      RDSSESA1
            GOTO      CLSRCH10
          ENDIF
.
          IF        INDEXNUM=4
            PACK      KEY31,WBSESIT,SRCHCLTY,FRSTDATE,SP70
            CALL      RDSSESA4
            GOTO      CLSRCH10
          ENDIF
.
          IF        INDEXNUM=6
            PACK      KEY25,WBSESIT,FRSTDATE,SP70
            CALL      RDSSESA6
          ENDIF
.
          IF        INDEXNUM=7
            PACK      KEY31,WBSESIT,SRCHCLTY,FRSTDATE,SP70
            CALL      RDSSESA7
            GOTO      CLSRCH10
          ENDIF
.
CLSRCH10  IF        INDEXNUM=1
            CALL      RDKSESA1
            BRANCH    OVRCD,CLSRCH90
.
            MATCH     WBSESIT,OSESITE
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSECLIN,SRCHCLID
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSEDATE,SEARCHTO
            GOTO      CLSRCH90 IF LESS
.
            MATCH     SP70,SRCHCLTY
            IF        !@EQUAL
              MATCH     OSESCTYP,SRCHCLTY
              GOTO      CLSRCH10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        INDEXNUM=4
            CALL      RDKSESA4
            BRANCH    OVRCD,CLSRCH90
.
            MATCH     WBSESIT,OSESITE
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSESCTYP,SRCHCLTY
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSEDATE,SEARCHTO
            GOTO      CLSRCH90 IF LESS
          ENDIF
.
          IF        INDEXNUM=6
            CALL      RDKSESA6
            BRANCH    OVRCD,CLSRCH90
.
            MATCH     WBSESIT,OSESITE
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSEDATE,SEARCHTO
            GOTO      CLSRCH90 IF LESS
          ENDIF
.
          IF        INDEXNUM=7
            CALL      RDKSESA7
            BRANCH    OVRCD,CLSRCH90
.
            MATCH     WBSESIT,OSESITE
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSESCTYP,SRCHCLTY
            GOTO      CLSRCH90 IF NOT EQUAL
.
            MATCH     OSEDATE,SEARCHTO
            GOTO      CLSRCH90 IF LESS
          ENDIF
.
          ADD       ONE,LOOPCNTR
.
.  Write record number in a comment to keep apache listening if no matching
.  clinics are found per 4,000 records
.
          IF        (LOOPCNTR = 4000)
            WRITE     HTMLFILE;"<!--",LOOPCNTR,"-->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CLSRCH10
.          BRANCH    OMASTAT,CLSRCH10            * Display inactive clinic if
          IF        OMASTAT<>0
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            MATCH     OSEDATE,CURRDATE           * clinic date prior to curr date
            IF        @LESS
              GOTO      CLSRCH10   
            ENDIF
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CLSRCH10
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CLSRCH10
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      CLSRCH10 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,SRCHCIND           * filter on clinic indicator
          IF        !@EQUAL
            MATCH     SRCHCIND,OTHECIND
            GOTO      CLSRCH10 IF NOT EQUAL
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLSRCH10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CLSRCH10 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      CLSRCH10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      CLSRCH10 IF NOT EQUAL
          ENDIF
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
.         CALL      CHKSUS00
.         BRANCH    EXIT,CLSRCH10
.
          MOVE      SP70,DISPSUSC
          MATCH     "1",OTCNDSUS
          IF        @EQUAL
            CALL      CHKSUS00
            IF        EXIT=ONE
              MOVE      "1",DISPSUSC
            ENDIF
          ELSE
            CALL      CHKSUS00
            BRANCH    EXIT,CLSRCH10
          ENDIF
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,CLSRCH10
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CLSRCH10
.
            MATCH     OSESITE,OCASITE
            GOTO      CLSRCH10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      CLSRCH10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHDOCT
          IF        !@EQUAL
            MATCH     OCADOCT,SRCHDOCT
            GOTO      CLSRCH10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.                                           *** HPS Code Starts Here ***
CLSRCH11  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&sesskeys=",HTMLLINK
          APPEND    SESSKEYS,HTMLLINK
.
          REP       " +",SRCHREFN
          APPEND    "&srchrefn=",HTMLLINK
          APPEND    SRCHREFN,HTMLLINK
          REP       "+ ",SRCHREFN
          APPEND    "&viewopcl=",HTMLLINK
          APPEND    VIEWOPCL,HTMLLINK
          APPEND    "&mosaiqrs=",HTMLLINK
          APPEND    MOSAIQRS,HTMLLINK
.
          RESET     HTMLLINK
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CLSRCH10
          ENDIF
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        MOSAIQCL=1
            WRITE     HTMLFILE;"<tr class='MosaiqClinic'>":
                               "<td><img src=../images/BlankIcon25.png ":
                               "class=Icon>";
            GOTO      CLSRCH20
          ELSE
            WRITE     HTMLFILE;"<tr>";
          ENDIF
.
          MATCH     "1",DISPSUSC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=ClinicSuspended >":
                               "<img src=../images/BlankIcon.gif ":
                               "class=Icon>";
          ELSE
            WRITE     HTMLFILE;"<td><img src=../images/OPSessionIcon.gif ":
                               "class=Icon ":
                               "onclick=#"ShowSession('",HTMLLINK,"');#">";
          ENDIF
.
CLSRCH20  WRITE     HTMLFILE;SP1,CDAY,SP1,MTHNAM3,SP1:
                             CCENT,CYEAR," at ",OMASTART,SP1,DAYNAM3,"</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",TDESC,"&nbsp;</td>":
                             "<td>",OEMPTY,"&nbsp;</td>":
                             "<td>",OSEBNEW,"&nbsp;</td>":
                             "<td>",OSEBRV,"&nbsp;</td>":
                             "<td>",OSEBSPC,"&nbsp;</td>":
                             "<tr>"
.
          MOVE      ZERO,LOOPCNTR
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CLSRCH10 IF NOT EQUAL
          GOTO      CLSRCH99
.
CLSRCH90  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=8 align=center>":
                              "End of search results</td>"
.
CLSRCH99  RETURN
.
.*******************************************************************************
.                     Output list of patients to attend                        
.*******************************************************************************
ATTLST00  MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
ATTLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,ATTLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      ATTLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      ATTLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      ATTLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      ATTLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr height=25>":
                              "<td align=right bgcolor=magenta>":
                              OBASLOT,"</td>":
                              "<td align=center bgcolor=magenta nowrap>":
                                  OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      ATTLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      ATTLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,ATTLST10
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBCITM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBASTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",OTBBCITM,"&nbsp;</td>":
                               "<td>",OTBBASTM,"&nbsp;</td>":
                               "<td>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
ATTLST20  IF        (OBASTAT=1)
            WRITE     HTMLFILE;"<input type=checkbox name=slotkeys ":
                               "checked value='",OBASLOT,"'></td></tr>"
          ELSE
            WRITE     HTMLFILE;"&nbsp;</td></tr>"
          ENDIF
.
          GOTO      ATTLST10
.
ATTLST99  RETURN
.
.*******************************************************************************
.                     Output list of patients to attend
.*******************************************************************************
CONLST00  MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CONLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CONLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CONLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      CONLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      CONLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CONLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr height=25>":
                              "<td align=right bgcolor=magenta>":
                              OBASLOT,"</td>":
                              "<td align=center bgcolor=magenta nowrap>":
                                  OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      CONLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      CONLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CONLST10
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",PTELEP,"&nbsp;</td>":
                               "<td bgcolor=magenta>",PTELEB,"&nbsp;</td>":
                               "<td bgcolor=magenta>",PTMXCELL,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",PTELEP,"&nbsp;</td>":
                               "<td>",PTELEB,"&nbsp;</td>":
                               "<td>",PTMXCELL,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
CONLST20  IF        (OBASTAT=1) | (OBASTAT=4) | (OBASTAT=5)
            MATCH     "1",PMVXCONF
            IF        @EQUAL
              WRITE     HTMLFILE;"<table width='100%'><tr><td width=20%>":
                                 "<input type=checkbox name=slotkeys checked ":
                                 "onclick=#"UpdateConf(this);#" ":
                                 "value='",SESSKEYS,OBASLOT,"'>";
.
              WRITE     HTMLFILE;"</td><td width=80%>";
              MATCH     SP70,PMVXCNID
              IF        !@EQUAL & !@EOS
                PACK      KEY10,PMVXCNID,SP70
                CALL      RDWBSE1
                IF        OVRCD=0
                  WRITE     HTMLFILE;WBSENAM;
                ELSE
                  WRITE     HTMLFILE;PMVXCNID;
                ENDIF
              ENDIF
.
              WRITE     HTMLFILE;"<br>";
              MATCH     SP70,PMVXCNDT
              IF        !@EQUAL & !@EOS
                UNPACK    PMVXCNDT,CCENT,CYEAR,CMON,CDAY,KEY5
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                          NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,KEY5
              ENDIF
.
                                             
              WRITE     HTMLFILE;"</td</tr></table></td>"
            ELSE
              WRITE     HTMLFILE;"<table width='100%'><tr><td width=20%>":
                             "<input type=checkbox name=slotkeys ":
                             "onclick=#"UpdateConf(this);#" ":
                             "value='",SESSKEYS,OBASLOT,"'></td>":
                              "<td width=80%>&nbsp;</td></tr></table></td>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"&nbsp;</td>"
          ENDIF
.
          MATCH     "1",PTCNSMSN
          IF        @EQUAL
            IF        (OBASTAT=6|OBASTAT=7)
                WRITE     HTMLFILE;"<td bgcolor=red>";
            ELSE
              IF        OVERBOOK=1
                WRITE     HTMLFILE;"<td bgcolor=magenta>";
              ELSE
                WRITE     HTMLFILE;"<td>";
              ENDIF
            ENDIF
.
            PACK      KEY2,SP1,TWO,SP70     * OP visit
            PACK      KEY30,OBAOUTNO,SP70   * OP Visit Number
            CALL      SMSS0000              * Get SMS status for visit
            WRITE     HTMLFILE;KEY50;
.
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      CONLST10
.
CONLST99  RETURN
.
.*******************************************************************************
.                     Output list of patients to depart
.*******************************************************************************
DEPLST00  MOVE      ZEROVISN,LASTOUTN
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
DEPLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,DEPLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      DEPLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      DEPLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      DEPLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF         !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      DEPLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
               WRITE     HTMLFILE;"<tr height=25>":
                                  "<td align=right bgcolor=magenta>":
                                  OBASLOT,"</td>":
                                  "<td align=center ":
                                  "bgcolor=magenta>",OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      DEPLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      DEPLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,DEPLST10
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBCITM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBASTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",OTBBCITM,"&nbsp;</td>":
                               "<td>",OTBBASTM,"&nbsp;</td>":
                               "<td>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
DEPLST20  COMPARE   FOUR,OBASTAT            * Attended only
          GOTO      DEPLST30 IF NOT EQUAL 
.
          MATCH     SP70,OTBBDPTM           * Any departure time
          GOTO      DEPLST30 IF NOT EQUAL

          WRITE     HTMLFILE;"<input type=checkbox name=slotkeys ":
                             "checked value='",OBASLOT,"'></td></tr>"
.
          GOTO      DEPLST10
.
DEPLST30  WRITE     HTMLFILE;"&nbsp;</td></tr>"
.
          GOTO      DEPLST10
.
DEPLST99  RETURN
.
.
.*******************************************************************************
.                     Output list of patients to discharge
.*******************************************************************************
DISLST00  MOVE      ZEROVISN,LASTOUTN
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
DISLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,DISLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      DISLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      DISLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      DISLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      DISLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
               WRITE     HTMLFILE;"<tr height=25>":
                                  "<td align=right bgcolor=magenta>":
                                  OBASLOT,"</td>":
                                  "<td align=center ":
                                  "bgcolor=magenta>",OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      DISLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      DISLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,DISLST10
.
          MOVE      "DO",CATEGORY
          MOVE      OBADISCH,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISSDESC
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBCITM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBASTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBDPTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",DISSDESC,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",OTBBCITM,"&nbsp;</td>":
                               "<td>",OTBBASTM,"&nbsp;</td>":
                               "<td>",OTBBDPTM,"&nbsp;</td>":
                               "<td>",DISSDESC,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
DISLST20  COMPARE   FOUR,OBASTAT            * Attended only
          GOTO      DISLST30 IF NOT EQUAL
.
          MATCH     SP70,OBADISCH           * Any discharge status 
          GOTO      DISLST30 IF NOT EQUAL
.                                                * save current record key
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
.                                                * check for future bookings
          MOVE      OBASITE,CHKSITE
          MOVE      OBACLIN,CHKCLIN
          MOVE      OBACTYP,CHKCTYP
          MOVE      DOBAOUTN,CHKADMN
          MOVE      OBAURNO,CHKURNO
.
          PACK      KEY36,OBAURNO,OBADATE,SP70
          CALL      RDSBOKA3
DISLST22  CALL      RDKBOKA3
          BRANCH    OVRCD,DISLST24
.
          MATCH     CHKADMN,DOBAOUTN             * Ignore current booking
          GOTO      DISLST22 IF EQUAL
.
          MATCH     CHKURNO,OBAURNO              * All records for this UR
          GOTO      DISLST24 IF NOT EQUAL
.
          MATCH     CHKSITE,OBASITE              * same site
          GOTO      DISLST22 IF NOT EQUAL
.
          MATCH     CHKCLIN,OBACLIN              * same clinic
          GOTO      DISLST22 IF NOT EQUAL
.
          MATCH     CHKCTYP,OBACTYP              * same clinic type
          GOTO      DISLST22 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT                  * booked
          GOTO      DISLST22 IF NOT EQUAL
.
          GOTO      DISLST26
.
DISLST24  CALL      RDBOKA1                      * reposition on current record
.
          WRITE     HTMLFILE;"<input type=checkbox name=slotkeys ":
                             "checked value='",OBASLOT,"'></td></tr>"
.
          GOTO      DISLST10
.
DISLST26  CALL      RDBOKA1                      * reposition on current record
.
DISLST30  WRITE     HTMLFILE;"&nbsp;</td></tr>"
.
          GOTO      DISLST10
.
DISLST99  RETURN
.
.*******************************************************************************
.                     Output list of patients to add encounters to
.*******************************************************************************
ENCLST00  MOVE      ZEROVISN,LASTOUTN
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
ENCLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,ENCLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      ENCLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      ENCLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      ENCLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      ENCLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ENCLST10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ENCLST10
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
               WRITE     HTMLFILE;"<tr height=25>":
                                  "<td align=right bgcolor=magenta>":
                                  OBASLOT,"</td>":
                                  "<td align=center ":
                                  "bgcolor=magenta>",OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      ENCLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      ENCLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,ENCLST10
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          MOVE      "No",ENCADDED
          PACK      KEY24,DOBAOUTN,SP70
          CALL      RSALENC7
ENCLST12  CALL      RKALENC7
          BRANCH    OVRCD,ENCLST15
.
          MATCH     DOBAOUTN,ALENLINK
          GOTO      ENCLST15 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled
          GOTO      ENCLST12 IF EQUAL
.
          MOVE      "Yes",ENCADDED
.
ENCLST15  IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBCITM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBASTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBDPTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",ENCADDED,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",OTBBCITM,"&nbsp;</td>":
                               "<td>",OTBBASTM,"&nbsp;</td>":
                               "<td>",OTBBDPTM,"&nbsp;</td>":
                               "<td>",ENCADDED,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
ENCLST20  PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,ENCLST50
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      ENCLST50 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ENCLST50
.
          IF        DNASONLY=1
            COMPARE   FIVE,OBASTAT          * Only allow encounters on 
            GOTO      ENCLST35 IF EQUAL     * DNA patients
.
            GOTO      ENCLST50
          ENDIF
.
          IF        ATTDONLY=0
            COMPARE   ONE,OBASTAT           * Skip booked if only allow
            GOTO      ENCLST35 IF EQUAL     * bulk enc to attended patients
          ENDIF
.
          COMPARE   FOUR,OBASTAT 
          GOTO      ENCLST35 IF EQUAL
         
          GOTO      ENCLST50
.
ENCLST35  WRITE     HTMLFILE;"<input type=checkbox name=referral ":
                             "checked value='",ALLNVISN,OBAOUTNO,"'></td></tr>"
.
          GOTO      ENCLST10
.
ENCLST50  WRITE     HTMLFILE;"&nbsp;</td></tr>"
.
          GOTO      ENCLST10
.
ENCLST99  RETURN
.
.
.*******************************************************************************
.                     Output list of patients to re-appoint
.*******************************************************************************
FOLLST00  MOVE      ZEROVISN,LASTOUTN
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
FOLLST10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,FOLLST99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      FOLLST99 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OBASTAT
          GOTO      FOLLST10 IF EQUAL
.
          COMPARE   TWO,OBASTAT
          GOTO      FOLLST10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      FOLLST10 IF EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * Over booking Yes
          ELSE
            MOVE      ZERO,OVERBOOK              * Over booking No
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<tr height=25><td align=right bgcolor=red>":
                               OBASLOT,"</td>":
                               "<td align=center bgcolor=red>",OBATIME,"</td>":
                               "<td bgcolor=red>&nbsp;",VTYPDESC,"</td>";
          ELSE
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<tr height=25>":
                              "<td align=right bgcolor=magenta>":
                              OBASLOT,"</td>":
                              "<td align=center bgcolor=magenta nowrap>":
                                  OBATIME,"</td>":
                                  "<td bgcolor=magenta>&nbsp;",VTYPDESC,"</td>";
            ELSE
               WRITE     HTMLFILE;"<tr height=25><td align=right>":
                                  OBASLOT,"</td>":
                                  "<td align=center>",OBATIME,"</td>":
                                  "<td>&nbsp;",VTYPDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        (OBASTAT=0|OBASTAT=9)
            IF        OVERBOOK=1
              WRITE     HTMLFILE;"<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td bgcolor=magenta>&nbsp;</td>":
                                 "<td align=center bgcolor=magenta>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                 "<td align=center>"
            ENDIF
            GOTO      FOLLST20
          ENDIF
.
          IF        (OBASTAT=6|OBASTAT=7)
            WRITE     HTMLFILE;"<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td bgcolor=red>&nbsp;</td>":
                               "<td align=center bgcolor=red>"
            GOTO      FOLLST20
          ENDIF
.
          CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,FOLLST10
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SARRDESC
.
          IF        OVERBOOK=1
            WRITE     HTMLFILE;"<td bgcolor=magenta>",FORMATNM,"</td>":
                               "<td bgcolor=magenta>",SARRDESC,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBCITM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBASTM,"&nbsp;</td>":
                               "<td bgcolor=magenta>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center bgcolor=magenta>"
          ELSE
            WRITE     HTMLFILE;"<td>",FORMATNM,"</td>":
                               "<td>",SARRDESC,"&nbsp;</td>":
                               "<td>",OTBBCITM,"&nbsp;</td>":
                               "<td>",OTBBASTM,"&nbsp;</td>":
                               "<td>",OTBBDPTM,"&nbsp;</td>":
                               "<td align=center>"
          ENDIF
.
FOLLST20  COMPARE   ZERO,OBASTAT            * booking
          GOTO      FOLLST30 IF EQUAL
.
          COMPARE   SIX,OBASTAT             * suspended
          GOTO      FOLLST30 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT           * unavailable
          GOTO      FOLLST30 IF EQUAL
.
          COMPARE   NINE,OBASTAT           * reserved    
          GOTO      FOLLST30 IF EQUAL
.
          MATCH     "1",OTBBFLUP           * Follow up done
          GOTO      FOLLST30 IF EQUAL
.
          WRITE     HTMLFILE;"<input type=checkbox name=slotkeys ":
                             "checked value='",OBASLOT,"'></td></tr>"
.
          GOTO      FOLLST10
.
FOLLST30  WRITE     HTMLFILE;"&nbsp;</td></tr>"
.
          GOTO      FOLLST10
.
FOLLST99  RETURN
.
.*******************************************************************************
.                      Attent selected patients
.*******************************************************************************
ATTSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot
.
ATTSLT10  COMPARE   "99",SLOTCNT
          GOTO      ATTSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      ATTSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      BATT0000
          BRANCH    EXIT,ATTSLT95
          GOTO      ATTSLT10
.
ATTSLT90  MOVE      ZERO,EXIT
          GOTO      ATTSLT99
.
ATTSLT95  MOVE      ONE,EXIT
.
ATTSLT99  RETURN
.
.*******************************************************************************
.                       Depart selected patients
.*******************************************************************************
DEPSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot
.
DEPSLT10  COMPARE   "99",SLOTCNT
          GOTO      DEPSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      DEPSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      BDEP0000
          BRANCH    EXIT,DEPSLT95
          GOTO      DEPSLT10
.
DEPSLT90  MOVE      ZERO,EXIT
          GOTO      DEPSLT99
.
DEPSLT95  MOVE      ONE,EXIT
.
DEPSLT99  RETURN
.
.
.*******************************************************************************
.                       Bulk time seen for selected patients
.*******************************************************************************
TIMSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot
.
TIMSLT10  COMPARE   "99",SLOTCNT
          GOTO      TIMSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      TIMSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      BTIM0000
          BRANCH    EXIT,TIMSLT95
          GOTO      TIMSLT10
.
TIMSLT90  MOVE      ZERO,EXIT
          GOTO      TIMSLT99
.
TIMSLT95  MOVE      ONE,EXIT
.
TIMSLT99  RETURN
.
.*******************************************************************************
.                       Discharge selected patients
.*******************************************************************************
DISSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot
.
DISSLT10  COMPARE   "99",SLOTCNT
          GOTO      DISSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      DISSLT99
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      BDIS0000
          BRANCH    EXIT,DISSLT95
          GOTO      DISSLT10
.
DISSLT90  MOVE      ZERO,EXIT
          GOTO      DISSLT99
.
DISSLT95  MOVE      ONE,EXIT
.
DISSLT99  RETURN
.
.*******************************************************************************
.                       Re-Appoint selected patients
.*******************************************************************************
FOLSLT00  MOVE      ZERO,SLOTCNT      * Loop through each slot
          MOVE      SESSKEYS,SAVSKEYS * Save session key
          MOVE      OUTBB047,SAVBB047 * Save new visit type (if any)
.
FOLSLT10  COMPARE   "99",SLOTCNT
          GOTO      FOLSLT90 IF EQUAL
.
          ADD       ONE,SLOTCNT
          IF        SLOTCNT>SLOTINDX
            GOTO      FOLSLT99
          ENDIF
.
          MOVE      SAVSKEYS,SESSKEYS  * Restore sesskeys as is gets changed
.                                      * to the new bookings session
          MOVE      SAVBB047,OUTBB047  * Restore new visit type (if any)
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      FNEW0000           * Generate new slot key for follow up
          BRANCH    EXIT,FOLSLT10
.
          PACK      CASEKEYS,SESSKEYS,SLOTKEYS[SLOTCNT]
          CALL      BFOL0000
          BRANCH    EXIT,FOLSLT95
          GOTO      FOLSLT10
.
FOLSLT90  MOVE      ZERO,EXIT
          GOTO      FOLSLT99
.
FOLSLT95  MOVE      ONE,EXIT
.
FOLSLT99  RETURN
.
.*******************************************************************************
.                       Process departure of selected patients
.*******************************************************************************
BDEP0000  MOVE      ONE,FLGOTBOK
.
          MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BDEP9500,BDEP9300
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BDEP9600
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,BDEP9500
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BDEP8500
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      BDEP8600 IF LESS
            ELSE
              GOTO      BDEP8600
            ENDIF
          ENDIF
.
          CALL      RDPMPX21
          BRANCH    OVRCD,BDEP8500
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
.----------------------------------------
. Discharge
.----------------------------------------
BDEP3000  MATCH     "4",DOBASTAT
          GOTO      BDEP8700 IF NOT EQUAL
.
          MATCH     SP70,OTBBDPTM          * Check if already departed
          GOTO      BDEP9800 IF NOT EQUAL
.
          MATCH     OTBBCITM,OUTBB034
          GOTO      BDEP9700 IF LESS
.         
          MATCH     SP70,OTBBASTM
          IF        @EQUAL
            MOVE      OTBBCITM,OTBBASTM     * Time seen = check in time if
          ENDIF                             * time seen is blank
.         
          MATCH     OTBBASTM,OUTBB034
          GOTO      BDEP9700 IF LESS
.         
          CALL      UPBOKB1                 * Update time seen
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
BDEP7900  CALL      BOKUPD00
          BRANCH    EXIT,BDEP9500,BDEP9600
.
BDEP8400  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY8,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB    * Send Update O/P Booking  message
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY9,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP8500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP8600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient is Deceased U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP8700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Appointment has no recorded Attendance U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record Locked U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9400  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            APPEND    "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            APPEND    "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
.
          APPEND    " U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
.
          ADD       ONE,WARNCNT
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Appointment - (",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Departure time should be greater than ",WEBTITLE
          APPEND    "check in & time seen UR - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9800  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Appointment has already been departed U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDEP9999
.
BDEP9999  RETURN
.
.*******************************************************************************
.                       Process time seen of selected patients
.*******************************************************************************
BTIM0000  MOVE      ONE,FLGOTBOK
.
          MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BTIM9500,BTIM9300
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BTIM9600
.
          MATCH     SP70,OTBBASTM
          GOTO      BTIM9400 IF NOT EQUAL
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,BTIM9500
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BTIM8500
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      BTIM8600 IF LESS
            ELSE
              GOTO      BTIM8600
            ENDIF
          ENDIF
.
          CALL      RDPMPX21
          BRANCH    OVRCD,BTIM8500
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
.----------------------------------------
. Discharge
.----------------------------------------
BTIM3000  MATCH     "4",DOBASTAT
          GOTO      BTIM8700 IF NOT EQUAL
.
          MATCH     OTBBCITM,OUTBB033
          GOTO      BTIM9700 IF LESS
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
BTIM7900  CALL      BOKUPD00
          BRANCH    EXIT,BTIM9500,BTIM9600
.
BTIM8400  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB    * Send Update O/P Booking  message
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM8500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM8600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient is Deceased U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM8700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Appointment has no recorded Attendance U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record Locked U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM9400  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking already has a time seen U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BTIM9500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Appointment - (",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM9600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM9700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Time seen should be greater than ",WEBTITLE
          APPEND    "check in time U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BTIM9999
.
BTIM9999  RETURN
.
.*******************************************************************************
.                       Process discharge of selected patients
.*******************************************************************************
BDIS0000  MOVE      ONE,FLGOTBOK
.
          MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BDIS9500,BDIS9300
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BDIS9600
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MATCH     Z70,OUTBB033
          IF        !@EQUAL
            MATCH     SP70,OTBBASTM         * Patient already seen
            GOTO      BDIS9750 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,OUTBB034
          IF        !@EQUAL
            MATCH     SP70,OTBBDPTM         * Patient already departed
            GOTO      BDIS9700 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OBADISCH           * Any discharge status
          GOTO      BDIS9700 IF NOT EQUAL
.
.         MOVE      OBAOUTNO,KEY8
.         CALL      RDBOKB1
.         BRANCH    OVRCD,BDIS9600
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BDIS8500
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      BDIS8600 IF LESS
            ELSE
              GOTO      BDIS8600
            ENDIF
          ENDIF
.
          CALL      RDPMPX21
          BRANCH    OVRCD,BDIS8500
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
.----------------------------------------
. Discharge
.----------------------------------------
BDIS3000  MATCH     "4",DOBASTAT
          GOTO      BDIS8700 IF NOT EQUAL
.
          MATCH     Z70,OUTBB033
          IF        !@EQUAL
            MATCH     OTBBCITM,OUTBB033    * Time seen less that check in
            GOTO      BDIS9800 IF LESS
          ENDIF
.
          MATCH     Z70,OUTBB034
          IF        !@EQUAL
            MATCH     SP70,OTBBASTM        * Can't be departed if not seen
            GOTO      BDIS9860 IF EQUAL
.
            MATCH     OTBBASTM,OUTBB034    * Departure time less that time seen
            GOTO      BDIS9850 IF LESS
          ENDIF
.
BDIS7900  CALL      BOKUPD00
          BRANCH    EXIT,BDIS9500,BDIS9600
.
BDIS8400  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB    * Send Update O/P Booking message
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY6,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS8500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS8600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient is Deceased U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS8700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Appointment has no recorded Attendance U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record Locked U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9400  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            APPEND    "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            APPEND    "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
.
          APPEND    " U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
.
          ADD       ONE,WARNCNT
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Appointment - (",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9700  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking already discharged U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9750  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking already Seen U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9800  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Time seen should be greater than ",WEBTITLE
          APPEND    "check in time U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9850  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Departure time should be greater than ",WEBTITLE
          APPEND    "time seen U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9860  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient not Seen, Cannot be departed ",WEBTITLE
          APPEND    "U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BDIS9999
.
BDIS9999  RETURN
.
.*******************************************************************************
.                      Process attendance of selected patients
.*******************************************************************************
BATT0000  MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BATT9500,BATT9300
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BATT9600
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BATT8500
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      BATT8600 IF LESS
            ELSE
              GOTO      BATT8600
            ENDIF
          ENDIF
.
          CALL      RDPMPX21
          BRANCH    OVRCD,BATT8500
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
.----------------------------------------
. Attendance
.----------------------------------------
BATT1000  COMPARE   ONE,OBASTAT              * Is this a booking ?
          GOTO      BATT1500 IF EQUAL
.
          GOTO      BATT9400                 * Invalid status to attend
.
BATT1500  CALL      ATTD0000                 * Attendance
          BRANCH    EXIT,BATT8900
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          CALL      XCHG0000                 * Get the charge for this patient
          CALL      POSTCHRG                 * Post the charge to the Dtrof file
.
BATT8000  MOVE      ONE,FLGOTBOK             * Set flag to yes so all records
          CALL      BOKUPD00                 * are written
          BRANCH    EXIT,BATT9500,BATT9600
.
BATT8400  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN6,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOA    * Send O/P Confirm Appointment message

          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          CALL      UUOTBOB1
.
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT8500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT8600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient is Deceased U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT8900  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Bookings can't be attended in future ",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
. 
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      BATT9999
.
BATT9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record Locked U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT9400  CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            APPEND    "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            APPEND    "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
.
          APPEND    " U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
.
          ADD       ONE,WARNCNT
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT9500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Appointment - (",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT9600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BATT9999
.
BATT9999  RETURN
.
.*******************************************************************************
.                      Process follow up of selected patients
.*******************************************************************************
BFOL0000  MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BFOL9500,BFOL9300
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BFOL9600
.
          MATCH     "1",OTBBFLUP            * Follow up already booked
          GOTO      BFOL9900 IF EQUAL
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,BFOL8500
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      BFOL8600 IF LESS
            ELSE
              GOTO      BFOL8600
            ENDIF
          ENDIF
.
.
          CALL      RDPMPX21
          BRANCH    OVRCD,BFOL8500
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MATCH     SP70,NEWSLOTK
          GOTO      BFOL9800 IF EQUAL
.
.         The following save varaibles are used by EOCACC00 procedure
.
          MOVE      OBAOUTNO,SAVADMNO     * Save original admission number
          MOVE      OBACOMP,SAVBCOMP      * Save original claim code
.

          MOVE      ONE,OTBBFLUP          * Follow Up Appointment Made
          CALL      UPBOKB1
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
          MOVE      SP70,OTBBFLUP
.
          MOVE      OBAURNO,URNUMBER
          CALL      RFOL0000              * Re-appoint for bulk follow up
          BRANCH    EXIT,BFOL9950
.
.         Get claim details of the original admission no and copy to the new
.         appointment outpatient number
.
          CALL      GCLM0000              * Write claim details
          CALL      EOCACC00
.
          CALL      LNKR0000              * Write referral letter link
.
BFOL7900  CALL      BOKUPD00
          BRANCH    EXIT,BFOL9500,BFOL9600
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            IF        @EQUAL
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
              CALL      INTUPD00                 * Interpreter Table Processing
            ENDIF
          ENDIF
.
BFOL8200  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICON    * DG API O/P New Appoint.
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          CALL      UUOTBOB1
.
          CALL      PRNT0000
.
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL8500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL8600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Patient is Deceased U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record Locked U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9500  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Appointment - (",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9600  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid Booking Status U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9800  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "New Slot Key is Reserved or Invalid U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9900  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Follow Up Booking Already Processed for U/R - ",WEBTITLE
          APPEND    OBAURNO,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
.
BFOL9950  CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9999  RETURN
.
.*******************************************************************************
.            RFOL0000: Generate and post a new outpatient number for
.                      bulk followup
.*******************************************************************************
RFOL0000  COMMIT
          BEGIN
.
          READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OPROUTN
          ELSE
            MOVE      " 10",PRXCODE
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8V  * Get the next Outpatient number
            ADD       ONE,FORM8V              * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8V  * Post new outpatient no
            SUB       ONE,FORM8V              * Go back to original O/P Number
            MOVE      FORM8V,OPROUTN
            CALL      RELSLK00
          ENDIF
.
          COMMIT
          BEGIN
.
RFOL0500  PACK      KEY8,OPROUTN             * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for bokb file
          CALL      RDABOKB1
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
.         We have a valid outpatient number. Post the Boka data
.
RFOL0700  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          BRANCH    OVRCD,RFOL9020
.
.         Update this record with the booking data
.
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      RFOL1000 IF EQUAL
          COMPARE   NINE,OBASTAT             * Make sure record isn't booked
          GOTO      RFOL9010 IF NOT EQUAL    * Record isn't vacant !!
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      RFOL9020 IF NOT EQUAL * Record is locked by another
            CALL      DEOTSRV1
          ENDIF
.
RFOL1000  MOVE      OPROUTN,OBAOUTNO         * Outpatient number
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      "       0",URNUMBER
            CALL      WRTZUR00
          ENDIF
          MOVE      URNUMBER,OBAURNO         * U/R Number
          MOVE      ONE,OBASTAT              * Status = Booked
          MOVE      ZERO,OBAPULL             * Clear pulling list flag
          CLOCK     TIME,CTIMEIS             * Get the current time
          PACK      OBABKDTE,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",OBABKDTE            * Zero-fill booking date/time
          CALL      UPBOKA1
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          CALL      PPRE0000                 * Updating the pre-attend file data
.
          MOVE      ZERO,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          PACK      KEY25,SESSKEYS,SP70      * Get session and slot template 
          CALL      RDSESA1                  * details
          IF        OVRCD<>1
            PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT:
                            OSESSHNO,OSESSDAT,SP70
            CALL      RDOTHED1
            IF        OVRCD=1
              CALL     CLOUTHED             
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70       * Key for bokb file
          CALL      RDABOKB1                 * Write the bokb record
          IF        OVRCD=1
            MOVE      LINKOUTN,OBALADMN
            MOVE      OBACTYP,OBBCTYP        * Store Clinic Type (SRF 103335)
            MOVE      SP10,OTBBADCS
            MOVE      SP10,OTBBCITM
            MOVE      SP10,OTBBASTM
            MOVE      SP10,OTBBDPTM
            MOVE      SP10,OTBBOUTC
            MOVE      SP70,OTBBCIND          * Clear before write
            MOVE      SP70,OTBBCIND          * Clear before write
            MOVE      SP70,OBAATTN
            MOVE      OTHETCOD,OTBBTCOD
            MOVE      OTHENMDS,OTBBNMDS
            MOVE      OTHECART,OTBBCART
            MOVE      OTHESRVD,OTBBSRVD
            MOVE      SP70,OTBBHCP1
            MOVE      SP70,OTBBHCP2
            MOVE      SP70,OTBBHCP3
            MOVE      SP70,OTBBHCP4
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
            PACK      KEY3,OBACOMP,SP70
            CALL      PRAD0000           * write to person responsible file
          ENDIF
.
          CALL      WRAP0000
          CALL      WPRC0000             * write Presenting Complaint
          CALL      WDIA0000             * write Diagnosis
          CALL      WCOM0000             * write Comments
.
          MATCH     OLDVTYP,NEWVTYP
          GOTO      RFOL8900 IF EQUAL
.
          CALL      EXTSLT00
          GOTO      RFOL8900
.
RFOL8900  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      ZERO,EXIT
          GOTO      RFOL9999                * Finished posting data
.
.         Booking record has the wrong status
.
RFOL9010  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Booking Record has wrong status - ",WEBTITLE
          APPEND    NEWSLOTK,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ONE,EXIT
          GOTO      RFOL9999
.
RFOL9020  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "New Booking Record not Available - ",WEBTITLE
          APPEND    NEWSLOTK,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ONE,EXIT
          GOTO      RFOL9999
.
RFOL9999  COMMIT
          BEGIN
          RETURN
.
.*******************************************************************************
.            WPRC0000: Copy Presenting Complaint from old Admission to New
.*******************************************************************************
.
WPRC0000  PACK      KEY8,SAVADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,WPRC9999
.
          MOVE      OBAOUTNO,KEY8
          MOVE      OBAOUTNO,PMVXVISN
          CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS             * Get the current time
          PACK      PMVXCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMVXCDTE
          MOVE      CTIMEIS,PMVXCTIM
          MOVE      USERID,PMVXWEBC
          CALL      RAPMVX11
          IF        OVRCD=1
            CALL      WRPMVX11
          ENDIF
.
WPRC9999  RETURN
.
.*******************************************************************************
.            WDIA0000: Copy Diagnosis from old Admission to New
.*******************************************************************************
.
WDIA0000  PACK      KEY8,SAVADMNO,SP70
          CALL      RDDIAG1
          BRANCH    OVRCD,WDIA5000
.
          MOVE      OBAOUTNO,KEY8
          MOVE      OBAOUTNO,DOPDIOUT
          CALL      RDADIAG1
          IF        OVRCD=1
            CALL      WRDIAG1
          ENDIF
.
WDIA5000  PACK      KEY8,SAVADMNO,SP70
          CALL      RDOTPRC1
          BRANCH    OVRCD,WDIA9999
.
          MOVE      OBAOUTNO,OTPROUTN
          PACK      KEY8,OTPROUTN,SP70
          CALL      RAOTPRC1
          IF        OVRCD=1
            CALL      WROTPRC1
          ENDIF
.
WDIA9999  RETURN
.
.-----------------------------------------------------------------------
. Copy visit comment details
.-----------------------------------------------------------------------
WCOM0000  MOVE      OBAOUTNO,KEY8
          MOVE      VSCMTTYP,KEY3
          CALL      DLVCM000                  * delete visit comments
          
          MOVE      SAVADMNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,SP70
.
          CALL      RSVSMDT1
WCOM0010  CALL      RKVSMDT1
          BRANCH    OVRCD,WCOM9999
.
          MATCH     KEY8,VSMDVISN
          GOTO      WCOM9999 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      WCOM9999 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      WCOM0010 IF EQUAL
.
. Insert comment header
.
          MOVE      OBAOUTNO,VSMDVISN
          CALL      WRVSMDT1           
.
          CALL      WCCMTX00
.
          GOTO      WCOM0010
.
WCOM9999  RETURN
.
.---------------------------------------------------------------------
. Copy comment text details
.---------------------------------------------------------------------
.
WCCMTX00  PACK      KEY20,KEY8,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
WCCMTX20  CALL      RKVSMTX1
          BRANCH    OVRCD,WCCMTX99
.
          MATCH     KEY8,VSMTVISN
          GOTO      WCCMTX99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      WCCMTX99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      WCCMTX99 IF NOT EQUAL
.
          MOVE      OBAOUTNO,VSMTVISN
          CALL      WRVSMTX1 
.
          GOTO      WCCMTX20
.
WCCMTX99  RETURN
.
.*******************************************************************************
.            FNEW0000: Generate NEWSLOTK for each appointment
.*******************************************************************************
FNEW0000  MOVE      SP70,NEWSLOTK           * Clear new slot key

          PACK      KEY28,CASEKEYS,SP70      * Key for the record to re-appoint
          CALL      RDBOKA1                  * Just validate the record first
          BRANCH    OVRCD,FNEW9100           * Record has disappeared
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,FNEW9100
.
          MATCH     Z70,OUTBB047           * Did we receive a new visit type
          IF        !@EQUAL
            MOVE      OUTBB047,OBAVISIT
          ELSE
            MOVE      OBAVISIT,OUTBB047    * New Visit Type
          ENDIF
.
          MOVE      OBAVISIT,XVISTYPE    * visit type for rec to be rescheduled
          MOVE      OBAVISIT,NEWVTYP     * New Visit Type
.
          PACK      KEY28,NEWSKEYS,SP70
          CALL      RDBOKA1
          COMPARE   ZERO,OVRCD
          GOTO      FNEW1100 IF EQUAL
.
FNEW1000  CALL      RDKBOKA1
          BRANCH    OVRCD,FNEW9300
.
FNEW1100  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          MATCH     KEY25,NEWSKEYS
          GOTO      FNEW9300 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,FNEW1000
.
          MATCH     ANSU,TCINDC6                 * Skip unavailable slots
          GOTO      FNEW1000 IF EQUAL
.
          MATCH     ANSZ,TCINDC2                 * Skip
          GOTO      FNEW1000 IF EQUAL
.
          MATCH     "1",WACLTYIN                 * Match visit type
          IF        !@EQUAL
            MATCH     XVISTYPE,OBAVISIT          
            GOTO      FNEW1000 IF NOT EQUAL
          ENDIF
.
          COMPARE   NINE,OBASTAT                      * Reserved
          IF        @EQUAL
            PACK      KEY28,NEWSKEYS,OBASLOT,SP70     * New slot key
            CALL      RDOTSRV1
            IF        OVRCD=0
              MATCH     USERID,OTSRWEBU
              GOTO      FNEW1000 IF NOT EQUAL * Record is locked by another
.                                             * so we can't use the slot
              GOTO      FNEW2000                            
            ENDIF
          ENDIF
.
          COMPARE   ZERO,OBASTAT                 * Booked
          GOTO      FNEW1000 IF NOT EQUAL
.
FNEW2000  UNPACK    NEWSKEYS,FOLLKEYS
          PACK      NEWSLOTK,FOLLKEYS,OBASLOT,SP70     * New slot key 
          MOVE      OBAVISIT,OLDVTYP
.
FNEW9000  MOVE      ZERO,EXIT
          GOTO      FNEW9999
.
FNEW9100  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "Invalid booking status  - ",WEBTITLE
          APPEND    CASEKEYS,WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ONE,EXIT
          GOTO      FNEW9999
.
FNEW9300  ADD       ONE,WARNCNT
          CLEAR     WEBTITLE
          APPEND    "No slots available in Session.",WEBTITLE
          RESET     WEBTITLE
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          MOVE      ONE,EXIT
          GOTO      FNEW9999
.
FNEW9999  RETURN
+
.*******************************************************************************
. Remote script to update appointment confirmed Yes/No
.*******************************************************************************
CONFAP00  MATCH     CASEKEYS,SP70
          GOTO      CONFAP91 IF EQUAL
.
CONFAP10  PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CONFAP91
.
          PACK      KEY8,OBAURNO,SP70          
          CALL      RDMAST1
          BRANCH    OVRCD,CONFAP92          * invalid UR number
.           
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                * read 2nd master file extension
          BRANCH    OVRCD,CONFAP92          * invalid UR number
. 
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
            CALL      MVVXTF00
            MOVE      OBAOUTNO,PMVXVISN
            MOVE      USERID,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PVIDATE,PMVXVSDT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPILC
            MOVE      PMPXABRG,PMVXABRG
            CALL      WRPMVX11
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
          ENDIF
.
          MATCH     Z70,CONFAPPT
          IF        !@EQUAL
            MOVE      CONFAPPT,PMVXCONF     * Update appointment confirmed
.
            MATCH     "1",PMVXCONF
            IF        @EQUAL
              MOVE      USERID,PMVXCNID
              CALL      IBACLOCK
              PACK      PMVXCNDT,CCC,CYY,CMM,CDD,CTIMEIS
              REP       " 0",PMVXCNDT
            ELSE
              MOVE      SP70,PMVXCNID
              MOVE      SP70,PMVXCNDT
            ENDIF
.
            CALL      UPPMVX11
          ENDIf
.
CONFAP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    "OK":
                    "</RETURN_VALUE>"
          GOTO      CONFAP99
.
CONFAP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Case ",CASEKEYS:
                    "</RETURN_VALUE>"
          GOTO      CONFAP99
.
CONFAP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid U/R ",OBAURNO:
                    "</RETURN_VALUE>"
          GOTO      CONFAP99
.
CONFAP99  RETURN
.
.
.-------------------------------------------------------------------
.     writing here for allied health department drop down
.-------------------------------------------------------------------
ARFT0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
ARFT0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,ARFT9999
.
          MATCH     "CG",TCODE
          GOTO      ARFT9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      ARFT0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ARFT0100
.
          MATCH     "1",ALDEACTV
          GOTO      ARFT0100 IF EQUAL       * Skip Inactive
.
          MATCH     OTHEADEP,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=",ALDEDEPT,">":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ALDEDEPT,">":
                               TDESC,"</option>"
          ENDIF
          GOTO      ARFT0100
.
ARFT9999  RETURN
.
.-----------------------------------------------------------
. Displays Letter Selection List
.-----------------------------------------------------------
SETLET00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      ZERO,F3
          MOVE      LETTER,LETTERNO
          PACK      KEY6,LETTER,F3,SP70
          CALL      RDOTLET1
          BRANCH    OVRCD,SETLET20
          BRANCH    F1,SETLET10,SETLET20
          WRITE     HTMLFILE;OTLTTEXT;
          GOTO      SETLET99
.
SETLET10  WRITE     HTMLFILE;DOTLTLTN;
          GOTO      SETLET99
.
SETLET20  CALL      LSEL0000
.
SETLET99  RETURN
.------------------------------------------------------------
. Letter Selection List
.------------------------------------------------------------
LSEL0000  MOVE      ZERO,OTLTLINO
          PACK      KEY6,OTLTLINO,SP70
          CALL      RSOTLET2
LSEL0100  CALL      RKOTLET2
          BRANCH    OVRCD,LSEL9999
.
          COMPARE   ZERO,OTLTLINO
          GOTO      LSEL9999 IF NOT EQUAL

          MOVE      OTLTTEXT,KEY40
          PACK      KEY5,QUOTE,DOTLTLTN,QUOTE
          COMPARE   LETTERNO,OTLTLTNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY40,"</option>"
          ELSE
            MATCH     "1",OTLTACTV                 * Skip Inactive
            GOTO      LSEL0100 IF EQUAL
.
            MATCH     "1",OTLTCOMM                 * Skip if SMS
            GOTO      LSEL0100 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY40,"</option>"
          ENDIF
          GOTO      LSEL0100
.
LSEL9999  RETURN
.
.------------------------------------------------------------
. Display extra booking screen detail
.------------------------------------------------------------
CHKE0000  PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXBKSR
            GOTO      CHKE5000 IF NOT EQUAL * Record found, populate variables
.
            MATCH     ANSY,OTMAIXTA
            IF        @EQUAL
              MATCH     SP70,OTTXATSR
              GOTO      CHKE5000 IF NOT EQUAL * Record found, populate variables
            ENDIF
          ENDIF
.
          PACK      KEY12,OBASITE,SP70
          CALL      RDOTTXS1
          IF        OVRCD=0
            MATCH     SP70,OTTXBKSR
            GOTO      CHKE5000 IF NOT EQUAL * Record found, populate variables
.
            MATCH     ANSY,OTMAIXTA
            IF        @EQUAL
              MATCH     SP70,OTTXATSR
              GOTO      CHKE5000 IF NOT EQUAL * Record found, populate variables
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;ZERO;          * No
          GOTO      CHKE9999
.
CHKE5000  WRITE     HTMLFILE;ONE;           * Yes
.
CHKE9999  RETURN
+
.------------------------------------------------------------
. Letter Selection List
.------------------------------------------------------------
LTRSEL00  MOVE      ZERO,OTLTLINO
          PACK      KEY6,OTLTLINO,SP70
          CALL      RSOTLET2
LTRSEL10  CALL      RKOTLET2
          BRANCH    OVRCD,LTRSEL99
.
          COMPARE   ZERO,OTLTLINO
          GOTO      LTRSEL99 IF NOT EQUAL
.
          MATCH     "R",OTLTTYPE            * Is this referral letter type?
          GOTO      LTRSEL10 IF NOT EQUAL   * No, skip this record.
.
          MATCH     "1",OTLTACTV                 * Skip Inactive
          GOTO      LTRSEL10 IF EQUAL
.
          MATCH     "1",OTLTCOMM                 * Skip if SMS
          GOTO      LTRSEL10 IF EQUAL
.
          MOVE      OTLTTEXT,KEY40
          PACK      KEY5,QUOTE,DOTLTLTN,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY5,">",KEY40,"</option>"
          GOTO      LTRSEL10
.
LTRSEL99  RETURN
+
.******************************************************************************
.         MHINC - MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.*******************************************************************************
.                          Multi Therapist View 
.*******************************************************************************
MTHVW000  CALL      CURPER00
          CALL      CALCDT00  
.
          MOVE      "Multi Therapist View",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MTHVW999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
MTHVW999  RETURN
.
.------------------------------------------------------------------------------
. Multi Therapist Tags                                                         
.------------------------------------------------------------------------------
MTVW0000  BRANCH    FLDITMNO,MTVW0100,MTVW0200,MTVW0300,MTVW0400,MTVW0500:
                             MTVW0600,MTVW0700
.
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      MTVW9999
.
MTVW0100  CALL      MTVT0000
          GOTO      MTVW9999
.
MTVW0200  CALL      SELV0000
          GOTO      MTVW9999
.
MTVW0300  CALL      PREV0000
          GOTO      MTVW9999
.
MTVW0400  CALL      NEXT0000
          GOTO      MTVW9999
.
MTVW0500  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MTVW9999
.
MTVW0600  MATCH     SP70,SRCHCLTY
          GOTO      MTVW9999 IF EQUAL
          WRITE     HTMLFILE;SRCHCLTY;
          GOTO      MTVW9999
.
MTVW0700  MATCH     SP70,SRCHLTYP
          GOTO      MTVW9999 IF EQUAL
          WRITE     HTMLFILE;SRCHLTYP;
          GOTO      MTVW9999
.
MTVW9999  RETURN
.
.------------------------------------------------------------------------------
. Multi Therapist View Table                                 
.------------------------------------------------------------------------------
MTVT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
.         CALL      IBACLOCK
.         PACK      CURRDATE,CCC,CYY,CMM,CDD     * Set up current date
.         REP       " 0",CURRDATE
.         MOVE      CTIMEIS,CURRTIME             * Set up current time
.
          MATCH     "1",SEARCHFL                 * Search button
          GOTO      MTVT9999 IF NOT EQUAL

          CALL      MTAR0000                   * Setup time slot array
          CALL      MTDA0000                   * Display first column time slots
          CALL      MTTB0000                   * Display Multi Therapist Table
.
MTVT9999  RETURN
.
.------------------------------------------------------------
. Set time array fields for appointment time classes
.------------------------------------------------------------
MTAR0000  MOVE      "00:00-00:29",TIMEARRY[1]
          MOVE      "00:30-00:59",TIMEARRY[2]
          MOVE      "01:00-01:59",TIMEARRY[3]
          MOVE      "01:30-01:59",TIMEARRY[4]
          MOVE      "02:00-02:29",TIMEARRY[5]
          MOVE      "02:30-02:59",TIMEARRY[6]
          MOVE      "03:00-03:29",TIMEARRY[7]
          MOVE      "03:30-03:59",TIMEARRY[8]
          MOVE      "04:00-04:29",TIMEARRY[9]
          MOVE      "04:30-04:59",TIMEARRY[10]
          MOVE      "05:00-05:29",TIMEARRY[11]
          MOVE      "05:30-05:59",TIMEARRY[12]
          MOVE      "06:00-06:29",TIMEARRY[13]
          MOVE      "06:30-06:59",TIMEARRY[14]
          MOVE      "07:00-07:29",TIMEARRY[15]
          MOVE      "07:30-07:59",TIMEARRY[16]
          MOVE      "08:00-08:29",TIMEARRY[17]
          MOVE      "08:30-08:59",TIMEARRY[18]
          MOVE      "09:00-09:29",TIMEARRY[19]
          MOVE      "09:30-09:59",TIMEARRY[20]
          MOVE      "10:00-10:29",TIMEARRY[21]
          MOVE      "10:30-10:59",TIMEARRY[22]
          MOVE      "11:00-11:29",TIMEARRY[23]
          MOVE      "11:30-11:59",TIMEARRY[24]
          MOVE      "12:00-12:29",TIMEARRY[25]
          MOVE      "12:30-12:59",TIMEARRY[26]
          MOVE      "13:00-13:29",TIMEARRY[27]
          MOVE      "13:30-13:59",TIMEARRY[28]
          MOVE      "14:00-14:29",TIMEARRY[29]
          MOVE      "14:30-14:59",TIMEARRY[30]
          MOVE      "15:00-15:29",TIMEARRY[31]
          MOVE      "15:30-15:59",TIMEARRY[32]
          MOVE      "16:00-16:29",TIMEARRY[33]
          MOVE      "16:30-16:59",TIMEARRY[34]
          MOVE      "17:00-17:29",TIMEARRY[35]
          MOVE      "17:30-17:59",TIMEARRY[36]
          MOVE      "18:00-18:29",TIMEARRY[37]
          MOVE      "18:30-18:59",TIMEARRY[38]
          MOVE      "19:00-19:29",TIMEARRY[39]
          MOVE      "19:30-19:59",TIMEARRY[40]
          MOVE      "20:00-20:29",TIMEARRY[41]
          MOVE      "20:30-20:59",TIMEARRY[42]
          MOVE      "21:00-21:29",TIMEARRY[43]
          MOVE      "21:30-21:59",TIMEARRY[44]
          MOVE      "22:00-22:29",TIMEARRY[45]
          MOVE      "22:30-22:59",TIMEARRY[46]
          MOVE      "23:00-23:29",TIMEARRY[47]
          MOVE      "23:30-23:59",TIMEARRY[48]
.
MTAR9999  RETURN
.
.------------------------------------------------------------
. Display first column time slots
.------------------------------------------------------------
MTDA0000    SQUEEZE   OTCNMTVS
            MATCH     SP70,OTCNMTVS
            IF        @EQUAL|@EOS
              MOVE      ONE,TMARRCNT
            ELSE
              MOVE      OTCNMTVS,TMARRCNT
            ENDIF
            SUB       ONE,TMARRCNT
.
  WRITE     HTMLFILE;"<td width=30 valign=top><div id=#"timecolumn#" style=#"position:relative#"><table cellspacing=0 cellpadding=1 border=1":
                             " width=30>":
                             "<tr>":
                             "<td height=60>":
                             "<div id=#"hcptime#" style=#"position:relative#">":
                             "<table width=100% height=100%>":
                             "<tr><td bgcolor=#CCCCCC>":
                             "<b>HCP<br>Time</b>":
                             "</td></tr>":
                             "</table>":
                             "</div>":
                             "</td>":
                             "</tr>";
.
MTDA1000  ADD       ONE,TMARRCNT
.
          PACK      KEY5,TIMEARRY[TMARRCNT]
          WRITE     HTMLFILE;"<tr>":
                           "<td height=60 bgcolor=#ffffff><b>",KEY5,"</b></td>":
                             "</tr>";
.
          SQUEEZE   OTCNMTVE
          MATCH     SP70,OTCNMTVE
          IF        @EQUAL|@EOS
            MOVE      FORTY8,FORM2
          ELSE
            MOVE      OTCNMTVE,FORM2
          ENDIF
          COMPARE   FORM2,TMARRCNT
          GOTO      MTDA1000 IF LESS
.
          WRITE     HTMLFILE;"</table></div></td>";
.
MTDA9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table Row  
.------------------------------------------------------------
MTRW0000  SQUEEZE   OTCNMTVS
          MATCH     SP70,OTCNMTVS
          IF        @EQUAL|@EOS
            MOVE      ONE,TMARRCNT
          ELSE
            MOVE      OTCNMTVS,TMARRCNT
          ENDIF
          SUB       ONE,TMARRCNT
.
          CALL      MTHD0000                          * Display Row Header
.         
MTRW1000  ADD       ONE,TMARRCNT
.
          MOVE      SP7,DISPBGCL                      * Display BG Color
          MOVE      ZERO,EMPTYCEL
          MOVE      ZERO,UNAVAILA
          MOVE      ZERO,MOREBOOK
.         
          UNPACK    TIMEARRY[TMARRCNT],KEY5B,DASH,KEY5A
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
MTRW1500  CALL      RDKBOKA1
          BRANCH    OVRCD,MTRW2300          
.
          IF        MOREBOOK=ONE
.
            MATCH     OSESITE,OBASITE
            GOTO      MTRW1800 IF NOT EQUAL
.
            MATCH     OSECLIN,OBACLIN
            GOTO      MTRW1800 IF NOT EQUAL
.
            MATCH     OSEDATE,OBADATE
            GOTO      MTRW1800 IF NOT EQUAL
.
            MATCH     OSESTRT,OBASTRT
            GOTO      MTRW1800 IF NOT EQUAL
.
          ELSE          
.
            MATCH     OSESITE,OBASITE
            GOTO      MTRW2300 IF NOT EQUAL
.
            MATCH     OSECLIN,OBACLIN
            GOTO      MTRW2300 IF NOT EQUAL 
.
            MATCH     OSEDATE,OBADATE
            GOTO      MTRW2300 IF NOT EQUAL
.
            MATCH     OSESTRT,OBASTRT
            GOTO      MTRW2300 IF NOT EQUAL
.
          ENDIF
.
          MATCH     KEY5A,OBASTRT
          IF        !@EQUAL & !@LESS
            GOTO      MTRW1500
          ENDIF
.
          MATCH     KEY5B,OBATIME
          IF        @LESS
            GOTO      MTRW1900
          ENDIF
.
          MATCH     KEY5A,OBATIME
          IF        !@EQUAL & !@LESS
            GOTO      MTRW1500
          ENDIF 
.
          MATCH     ZEROVISN,OBAOUTNO
          IF        @EQUAL
            MOVE      ONE,EMPTYCEL
            MOVE      SP70,DISPVTYP
.
            MOVE      "CV",CATEGORY
            MOVE      OBAVISIT,CODE
            CALL      GETCOD00
.
.           BG Color for New,Special,Other
            MATCH     ANSN,TCINDC1
            IF        @EQUAL
              MOVE      "#ffcccc",DISPBGCL
            ENDIF
            MATCH     ANSS,TCINDC1
            IF        @EQUAL
              MOVE      "#fdff80",DISPBGCL
            ENDIF
            MATCH     ANSO,TCINDC1
            IF        @EQUAL
              MOVE      "#80fdfd",DISPBGCL
            ENDIF

            MATCH     ANSZ,TCINDC2
            IF        @EQUAL
              CLEAR     DISPVTYP
              APPEND    "<font color=magenta>(",DISPVTYP
              APPEND    OBAVISIT,DISPVTYP
              APPEND    ")</font>",DISPVTYP
              RESET     DISPVTYP
            ELSE
              MATCH     ANSU,TCINDC6
              IF        @EQUAL
                CLEAR     DISPVTYP
                APPEND    "<font color=red>(",DISPVTYP
                APPEND    OBAVISIT,DISPVTYP
                APPEND    ")</font>",DISPVTYP
                RESET     DISPVTYP
              ELSE
                PACK      DISPVTYP,LBRACK,OBAVISIT,RBRACK,SP70
              ENDIF
            ENDIF
.
            MATCH     "3",DOBASTAT
            IF        @EQUAL
              MOVE      ONE,UNAVAILA
.
              MOVE      "Extended Slot",VSLTCOMM
            ENDIF
.
            MATCH     "7",DOBASTAT
            IF        @EQUAL
              MOVE      ONE,UNAVAILA
.
              MOVE      SP70,VSLTCOMM
              MOVE      TDESC,VSLTCOMM
.
              MATCH     ANSU,TCINDC6           * Get slot comment if unavailable
              IF        @EQUAL
                PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
                CALL      RDOTBOX1
                IF        OVRCD=0
                  MATCH     SP70,OTBXCOMM
                  IF        !@EQUAL
                    MOVE      OTBXCOMM,VSLTCOMM
                  ENDIF
                ENDIF
              ENDIF
.
            ENDIF
            GOTO      MTRW1500
          ENDIF
.
          IF        MOREBOOK=ONE
            MATCH     ZEROVISN,OBAOUTNO
            GOTO      MTRW1500 IF EQUAL
            WRITE     HTMLFILE;" <font color=red><b>+</b></font>";
            GOTO      MTRW1800
          ELSE
            CALL    MTPD0000
            GOTO    MTRW1500
          ENDIF
.
MTRW1800  CALL      PSES0000                   * Display group session icon
.
          WRITE     HTMLFILE;"</td></tr>";
          GOTO      MTRW2500
.
MTRW1900  MOVE      OBATIME,AVALTIME
          CALL      STDUR000
.
          MATCH     KEY5B,AVALTIME
          GOTO      MTRW1500 IF LESS
.
          MATCH     ZEROVISN,OBAOUTNO
          IF        @EQUAL
            MOVE      ONE,EMPTYCEL
            MOVE      SP70,DISPVTYP
.
            MOVE      "CV",CATEGORY
            MOVE      OBAVISIT,CODE
            CALL      GETCOD00
.
.           BG Color for New,Special,Other
            MATCH     ANSN,TCINDC1
            IF        @EQUAL
              MOVE      "#ffcccc",DISPBGCL
            ENDIF
            MATCH     ANSS,TCINDC1
            IF        @EQUAL
              MOVE      "#fdff80",DISPBGCL
            ENDIF
            MATCH     ANSO,TCINDC1
            IF        @EQUAL
              MOVE      "#80fdfd",DISPBGCL
            ENDIF
.
            MATCH     ANSZ,TCINDC2
            IF        @EQUAL
              CLEAR     DISPVTYP
              APPEND    "<font color=magenta>(",DISPVTYP
              APPEND    OBAVISIT,DISPVTYP
              APPEND   ")</font>",DISPVTYP
              RESET     DISPVTYP
            ELSE
              MATCH      ANSU,TCINDC6
              IF         @EQUAL
                CLEAR     DISPVTYP
                APPEND    "<font color=red>(",DISPVTYP
                APPEND    OBAVISIT,DISPVTYP
                APPEND   ")</font>",DISPVTYP
                RESET     DISPVTYP
              ELSE
                PACK       DISPVTYP,LBRACK,OBAVISIT,RBRACK,SP70
              ENDIF
            ENDIF
.
            MATCH     "3",DOBASTAT
            IF        @EQUAL
              MOVE      ONE,UNAVAILA
.
              MOVE      "Extended Slot",VSLTCOMM
            ENDIF
.
            MATCH     "7",DOBASTAT
            IF        @EQUAL
              MOVE      ONE,UNAVAILA
.
              MOVE      SP70,VSLTCOMM
              MOVE      TDESC,VSLTCOMM
.
              MATCH     ANSU,TCINDC6           * Get slot comment if unavailable
              IF        @EQUAL
                PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
                CALL      RDOTBOX1
                IF        OVRCD=0
                  MATCH     SP70,OTBXCOMM
                  IF        !@EQUAL
                    MOVE      OTBXCOMM,VSLTCOMM
                  ENDIF
                ENDIF
              ENDIF
.
            ENDIF
            GOTO      MTRW1500
          ENDIF
.
          CALL      MTPD0000
          GOTO      MTRW1500
.
MTRW2300  IF        EMPTYCEL=ONE
            CALL      MTSO0000
          ELSE
            WRITE     HTMLFILE;"<tr>":
                               "<td height=60>&nbsp;";
.
            CALL      PSES0000                   * Display group session icon
.
            WRITE     HTMLFILE;"</td></tr>";
          ENDIF
.
MTRW2500  SQUEEZE   OTCNMTVE
          MATCH     SP70,OTCNMTVE
          IF        @EQUAL|@EOS
            MOVE      FORTY8,FORM2
          ELSE
            MOVE      OTCNMTVE,FORM2
          ENDIF
          COMPARE   FORM2,TMARRCNT
          GOTO      MTRW1000 IF LESS
.
MTRW3000  WRITE     HTMLFILE;"</table></td>";
.
MTRW9999  RETURN
.
.------------------------------------------------------------
. Check if the sessions HCP or assigned group session HCP
. is running any more group sessions today
.------------------------------------------------------------
GSES0000  MOVE      ONE,COUNTSES
          WHILE     COUNTSES <= 48
            MOVE      SP70,GSESARRY[COUNTSES]
            ADD       ONE,COUNTSES
          DO
          MOVE      ZERO,COUNTSES
.
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY10
            GOTO      GSES1000
          ENDIF
.
          MATCH     SP70,OSESGHCP
          IF        !@EQUAL
            MOVE      OSESGHCP,KEY10
            GOTO      GSES1000
          ENDIF
.
          GOTO      GSES9999
.
GSES1000  PACK      SAVKEY25,OSESITE,OSEDATE,OSESTRT,OSECLIN,SP70
.
          PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
GSES2000  CALL      RDKSESA6
          BRANCH    OVRCD,GSES9000
.
          MATCH     WBSESIT,OSESITE
          GOTO      GSES9000 IF NOT EQUAL
.
          MATCH     OSEDATE,FRSTDATE
          GOTO      GSES9000 IF NOT EQUAL
.
          PACK      DIM25,OSESITE,OSEDATE,OSESTRT,OSECLIN,SP70
          MATCH     DIM25,SAVKEY25          * Skip if the same session
          GOTO      GSES2000 IF EQUAL  
.
          MATCH     KEY10,OSESGHCP          * Group session for same HCP
          GOTO      GSES2000 IF NOT EQUAL
.
          MOVE      ONE,COUNTSES
          WHILE     COUNTSES <= 48
            UNPACK    TIMEARRY[COUNTSES],KEY5B,DASH,KEY5A
             MATCH    KEY5B,OSESTRT
             IF       !@LESS
               MATCH    OSESTRT,KEY5A
               IF       !@LESS
                 PACK      GSESARRY[COUNTSES],OSESITE,OSECLIN,OSEDATE,OSESTRT
               ENDIF
             ENDIF  
             ADD       ONE,COUNTSES
          DO
          GOTO      GSES2000
.
GSES9000  PACK      KEY25,SAVKEY25          * Read original session record
          CALL      RDSESA6                   
.
GSES9999  RETURN
.
.------------------------------------------------------------
. Display the session icon for any group sessions run by
. this HCP in this time slot
.------------------------------------------------------------
PSES0000  MATCH     SP70,GSESARRY[TMARRCNT]
          GOTO      PSES9999 IF EQUAL
.
          MOVE      GSESARRY[TMARRCNT],KEY20
          CALL      RDCLIA1
          BRANCH    OVRCD,PSES1000
.
          GOTO      PSES2000
.
PSES1000  MOVE      GSESARRY[TMARRCNT],KEY20
          MOVE      GSESARRY[TMARRCNT],KEY12
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,PSES9999
.
          PACK      DIM12,OCASITE,OCACLIN
 
          MATCH     DIM12,KEY12
          GOTO      PSES9999 IF NOT EQUAL
.
PSES2000  REP       " +",GSESARRY[TMARRCNT]
          WRITE     HTMLFILE;"<br><a href='":
                             "outweb02.pbl?reportno=02&template=004&sesskeys=":
                             GSESARRY[TMARRCNT]:
                             "' onclick='SetMulTherCookie();'>";
.
          WRITE     HTMLFILE;OCADESC,"</a>";
.
PSES9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table
.------------------------------------------------------------
MTTB0000  MOVE      ZERO,CNTRMTHD
.
          PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
MTTB0010  CALL      RDKSESA6
          BRANCH    OVRCD,MTTB9999
.
          MATCH     WBSESIT,OSESITE
          GOTO      MTTB9999 IF NOT EQUAL
.
          MATCH     OSEDATE,FRSTDATE
          GOTO      MTTB9999 IF NOT EQUAL
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,MTTB0010
          BRANCH    OMASTAT,MTTB0010
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,MTTB0010
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,MTTB0010
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      MTTB0010 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      MTTB0010 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      MTTB0010 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP               * location type filter
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,MTTB0010
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,MTTB0010
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,MTTB0010
.
            MATCH     OSESITE,OCASITE
            GOTO      MTTB0010 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          CALL      GSES0000                      * Check group session HCP
.
          CALL      MTRW0000
.
          GOTO      MTTB0010
.
MTTB9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table Row Header
.------------------------------------------------------------
MTHD0000  ADD       ONE,CNTRMTHD
.
          WRITE     HTMLFILE;"<td valign=top width=200>":
                             "<table cellspacing=0 cellpadding=1 border=1":
                             " width=200>":
                             "<tr>":
                             "<td height=60>";
.
          MOVE      SP70,SESSKEYS
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
.
          MOVE      CNTRMTHD,DIM3
          REP       " 0",DIM3
.
          WRITE     HTMLFILE;"<div id=#"mthd",DIM3,"#" style=#"position:relative#">":
                             "<table width=100% height=100%>":
                             "<tr><td bgcolor=#CCCCCC>":
                             "<a href='":
                             "outweb02.pbl?reportno=02&template=004&sesskeys=":
                             SESSKEYS,"' onclick='SetMulTherCookie();'>";
.
          MATCH     SP70,OSESGHCP
          GOTO      MTHD0500 IF EQUAL
          GOTO      MTHD0500 IF EOS
.
          MOVE      SP70,DOCFNAME
.
          PACK      KEY10,OSESGHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    OSESGHCP,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"<b>",DOCFNAME;
          GOTO      MTHD0600
.
MTHD0500  WRITE     HTMLFILE;"<b>",OSESGHCP;
.
MTHD0600  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          BRANCH    OVRCD,MTHD0700
.
          WRITE     HTMLFILE;" ",OCADESC,"</a><br>",OSESTRT,"</b>":
                             "</td></tr></table></div>":
                             "</td>":
                             "</tr>";
          GOTO      MTHD9999
.
MTHD0700  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,MTHD0800
.
          MATCH     OSESITE,OCASITE
          GOTO      MTHD0800 IF NOT EQUAL
.
          MATCH     OSECLIN,OCACLIN
          GOTO      MTHD0800 IF NOT EQUAL
.
          WRITE     HTMLFILE;" ",OCADESC,"</a><br>",OSESTRT,"</b>":
                             "</td></tr></table></div>":
                             "</td>":
                             "</tr>";
          GOTO      MTHD9999
.
MTHD0800  WRITE     HTMLFILE;" ",OSECLIN,"<br>",OSESTRT,"</b>":
                             "</td></tr></table></div>":
                             "</td>":
                             "</tr>";
.
MTHD9999  RETURN
.------------------------------------------------------------
.                             STDUR000                       
.              Calculate end time of slot
.------------------------------------------------------------
STDUR000  UNPACK    AVALTIME,KEY2,KEY1,MIN  * HH:MM
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.         
          ADD       OTHEDURN,MINUTES   * Add Duration time to minutes
          SUB       ONE,MINUTES
          ASSIGN    MINUTES-SIXTY,TIME    
          IF        TIME >= 0 
            IF        TIME >= 60
              MOVE      TIME,MINUTES
              ASSIGN    MINUTES-SIXTY,TIME
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       TWO,HOUR                 * Add Two Hours
            ELSE
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       ONE,HOUR                 * Add One Hour
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIME            * No Hour Change
            MOVE      MINTIME,MIN
          ENDIF
.
          PACK      AVALTIME,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REPLACE   " 0",AVALTIME            * replace spaces with zero
.
          UNPACK    AVALTIME,KEY2,KEY1,MIN
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,SLOTTIME  * pack time Form variable (Loop Control)
.
STDUR999  RETURN
.---------------------------------------------------------------
.                             MTPD0000
.              Display Patient Details for Multi Therapist view
.---------------------------------------------------------------
MTPD0000  CALL      CASDET00
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          CALL      PATFLD00
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        @EQUAL
            CALL      MTSO0000
.           WRITE     HTMLFILE;"<tr><td height=60>&nbsp;";
            GOTO      MTPD9000
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70      * Read For Diagnosis
          CALL      RDDIAG1
          IF        OVRCD = 1
            PACK      OPDIDESC,SP70
          ENDIF
          PACK      DIM30,OPDIDESC
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MTPD1000
.
          MATCH     "N",TCINDC1
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td height=60 bgcolor=pink>";
            GOTO      MTPD2000
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td height=60 bgcolor=yellow>";
            GOTO      MTPD2000
          ENDIF 
.
          MATCH     "O",TCINDC1
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td height=60 bgcolor=#00FAFA>";
            GOTO      MTPD2000
          ENDIF 
.
MTPD1000  WRITE     HTMLFILE;"<tr><td height=60>";
.
MTPD2000  WRITE     HTMLFILE;"<a href=#"",LINKPRG,".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",CASEKEYS,"#">":
                             "<img src=../images/PatientFolder",KEY3,".gif":
                             " class=Icon></a>":
                             "<img src=../images/EditIcon.gif":
                             " class=Icon":
                             " onclick=#"";
.
          REP       "+ ",CASEKEYS
.
          WRITE     HTMLFILE;"document.PatientLinks.casekeys.value='":
                    CASEKEYS,"';":
                    " PatientLinkTo(#'outweb02.pbl#',3,5,1,700,400);#">&nbsp;":
                             FORMATNM;
.
          MATCH   DIM30,SP70
          IF      !@EQUAL
            WRITE     HTMLFILE;"<br />",DIM30;
          ENDIF
.
MTPD9000  MOVE    ONE,MOREBOOK
.
MTPD9999  RETURN
.---------------------------------------------------------------
.                             MTSO0000
.              Display Empty Slot for Multi THerapist View     
.---------------------------------------------------------------
MTSO0000  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          BRANCH    OVRCD,MTSO0700
.
          GOTO      MTSO0750
.
MTSO0700  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,MTSO0800
.
          MATCH     OSESITE,OCASITE
          GOTO      MTSO0800 IF NOT EQUAL
.
          MATCH     OSECLIN,OCACLIN
          GOTO      MTSO0800 IF NOT EQUAL
.
MTSO0750  IF        UNAVAILA=ONE
            WRITE     HTMLFILE;"<tr><td height=60><font color=red>":
                               VSLTCOMM,"<br>UNAVAILABLE</font>";
.
            CALL      PSES0000                   * Display group session icon
.
            WRITE     HTMLFILE;"</td></tr>";
          ELSE
            MATCH     SP7,DISPBGCL
            IF        @EQUAL 
              WRITE     HTMLFILE;"<tr><td height=60>":
                                 "<a href='":
                                 "outweb02.pbl?reportno=02&template=004&sesskeys=":
                                 SESSKEYS,"' onclick='SetMulTherCookie();'>":
                                 "<img src=../images/AppointIcon.gif":
                                 " class=Icon></a>&nbsp;",DISPVTYP;
            ELSE
              WRITE     HTMLFILE;"<tr><td height=60 bgcolor=",DISPBGCL,">":
                                 "<a href='":
                                 "outweb02.pbl?reportno=02&template=004&sesskeys=":
                                 SESSKEYS,"' onclick='SetMulTherCookie();'>":
                                 "<img src=../images/AppointIcon.gif":
                                 " class=Icon></a>&nbsp;",DISPVTYP;
            ENDIF
.
            CALL      PSES0000                   * Display group session icon
.
            WRITE     HTMLFILE;"</td></tr>";
          ENDIF
          GOTO      MTSO9999
.
MTSO0800  IF        UNAVAILA=ONE
            WRITE     HTMLFILE;"<tr><td height=60>":
                               OBACLIN,"<br><font color=red>UNAVAILABLE</font>";
.
            CALL      PSES0000                   * Display group session icon
.
            WRITE     HTMLFILE;"</td></tr>";
          ELSE
            MATCH     SP7,DISPBGCL
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr><td height=60>":
                                 "<a href='":
                                 "outweb02.pbl?reportno=02&template=004&sesskeys=":
                                 SESSKEYS,"' onclick='SetMulTherCookie();'>":
                                 "<img src=../images/AppointIcon.gif":
                                 " class=Icon></a>&nbsp;",DISPVTYP;
            ELSE
              WRITE     HTMLFILE;"<tr><td height=60 bgcolor=",DISPBGCL,">":
                                 "<a href='":
                                 "outweb02.pbl?reportno=02&template=004&sesskeys=":
                                 SESSKEYS,"' onclick='SetMulTherCookie();'>":
                                 "<img src=../images/AppointIcon.gif":
                                 " class=Icon></a>&nbsp;",DISPVTYP;
            ENDIF
.
            CALL      PSES0000                   * Display group session icon
.
            WRITE    HTMLFILE;"</td></tr>";
          ENDIF
.
MTSO9999  RETURN
.
.*******************************************************************************
. Get Outpatient Sessions for a Range and display all appointment for
. the muti session case list
.*******************************************************************************
CLISTM00  PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
CLISTM10  CALL      RDKSESA6
          BRANCH    OVRCD,CLISTM99
.
          MATCH     WBSESIT,OSESITE
          GOTO      CLISTM99 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      CLISTM99 IF LESS
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      CLISTM10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CLISTM10 
          BRANCH    OMASTAT,CLISTM10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CLISTM10
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CLISTM10
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      CLISTM10 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,SRCHCIND           * filter on clinic indicator
          IF        !@EQUAL
            MATCH     SRCHCIND,OTHECIND
            GOTO      CLISTM10 IF NOT EQUAL
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLISTM10 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CLISTM10 IF LESS
          ENDIF
.
          MATCH     "1",SEARCHIN
          IF        @EQUAL
            MATCH     SP70,WBSELTYP
            IF        !@EQUAL
              MATCH     OTHELTYP,WBSELTYP
              GOTO      CLISTM10 IF NOT EQUAL
            ENDIF
          ELSE
            MATCH     SP70,SRCHLTYP
            IF        !@EQUAL
              MATCH     OTHELTYP,SRCHLTYP
              GOTO      CLISTM10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      CLISTM10 IF NOT EQUAL
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,CLISTM10
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,CLISTM10
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CLISTM10
.
            MATCH     OSESITE,OCASITE
            GOTO      CLISTM10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      CLISTM10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHDOCT
          IF        !@EQUAL
            MATCH     OCADOCT,SRCHDOCT
            GOTO      CLISTM10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.                                           *** HPS Code Starts Here ***
          COMPARE   ONE,TMPFLG
          GOTO      CLISTM20 IF EQUAL
.                                           *** HPS Code Ends Here ***
CLISTM11  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      ZERO,FULLONLY
          CALL      CASSTM00
.
          GOTO      CLISTM10
.
CLISTM20  MATCH     OMATYP,CLINTYPE
          GOTO      CLISTM10 IF NOT EQUAL
          GOTO      CLISTM11
.
CLISTM99  RETURN
.
.*******************************************************************************
.                           Output Case List Table
.*******************************************************************************
CASSTM00  MOVE      ZEROVISN,LASTOUTN
          MOVE      ZERO,RECCNT
          PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CASSTM10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CASSTM99          * end of session
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CASSTM99 IF NOT EQUAL   * different sessio
.
          COMPARE   SIX,OBASTAT
          GOTO      CASSTM10 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      CASSTM10 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      CASSTM10 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CASSTM10 IF EQUAL
          ENDIF
.
          MATCH     SP70,FILTVTYP
          IF        !@EQUAL
            MATCH     FILTVTYP,OBAVISIT          * Visit type filter
            GOTO      CASSTM10 IF NOT EQUAL
          ENDIF
.
          MOVE      OBAOUTNO,LASTOUTN
          MOVE      SP70,OTXWDESC
.
          IF        (OBASTAT=0|OBASTAT=9|OBASTAT=7)
            COMPARE   ZERO,SHOWEMPT
            GOTO      CASSTM10 IF EQUAL
            CALL      EMSTB000 * Empty Slot/Suspended/Reserved
          ELSE
            CALL      FUSTB000 * Full Slot
          ENDIF
.
          GOTO      CASSTM10
.
CASSTM99  RETURN
+
.*******************************************************************************
. Activate a waiting master referral if the linked internal referral is active
. Requires CHECKREF - Internal Referral Number
.*******************************************************************************
AMAS0000  MATCH     "1",ALCNDAMR
          GOTO      AMAS9999 IF EQUAL
.
          PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Read the referral to see if it's
          BRANCH    OVRCD,AMAS9999          * an internal referral
.
          MATCH     "1",ALREUYN4            * Exit if not an internal referral
          GOTO      AMAS9999 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Exit if not active
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALREDACT,SAVIADAT       * Save internal referral date active
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          PACK      KEY16,CHECKREF,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,AMAS9999
.
          MATCH     CHECKREF,ALRLLNKV       * Linked referrals
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number

          PACK      KEY8,MASTREFN,SP70
          CALL      RDALREF1                * Read the master referral
          BRANCH    OVRCD,AMAS9999
.
          MATCH     "1",ALREUYN4            * Exit if not an master referral
          GOTO      AMAS9000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Exit if not waiting
          GOTO      AMAS9000 IF NOT EQUAL
.
          IF        RIAUDFLG = 0
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            MOVE      ONE,RIAUDFLG
          ENDIF
.
          MOVE      "1",ALRESTAT            * Set status to active
          MOVE      SAVIADAT,ALREDACT
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      ARMHI000                * Set MHINC indicator
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
.         Check if we need to write an after audit record
.
          IF        RIAUDFLG = 1
            MOVE      ALREVISN,VINAHREF     * save the master referral no.
          ENDIF
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
AMAS9000  PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Re read original referral
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
AMAS9999  RETURN
.
.---------------------------------------------------------------------------
. Check for Unbooked Outpatient Referral Letters
.---------------------------------------------------------------------------
CHKREQ00  MATCH     SP70,NEWSLOTK
          GOTO      CHKREQ80 IF EQUAL
.
          PACK      KEY28,NEWSLOTK,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKREQ80
.
          PACK      KEY25,NEWSLOTK,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,CHKREQ80
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHKREQ80
.
          PACK      KEY32,URNUMBER,SP70
          CALL      RSOTART1
CHKREQ10  CALL      RKOTART1
          BRANCH    OVRCD,CHKREQ80
.
          MATCH     OTARURNO,URNUMBER
          GOTO      CHKREQ80 IF NOT EQUAL
.
          MATCH     "2",OTARSTAT                 * Ignore Booked
          GOTO      CHKREQ10 IF EQUAL
.
          MATCH     "3",OTARSTAT                 * Ignore Cancelled
          GOTO      CHKREQ10 IF EQUAL
.
          PACK      DIM32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          MATCH     REQUESTK,DIM32               * Ignore if linked to this 
          GOTO      CHKREQ10 IF EQUAL            * request
.
          MATCH     OBACTYP,OTARCLTY             * Matching clinic Id or Type
          IF        !@EQUAL
            MATCH     OBACLIN,OTARCLID
            GOTO      CHKREQ10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OTARPRDT
          IF        !@EQUAL
            MATCH     OBADATE,OTARPRDT           * Matching preferred date
            GOTO      CHKREQ10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,OUTBB022
          IF        !@EQUAL
            MATCH     SP70,OUTBB022
            IF        !@EQUAL & !@EOS
              MATCH     OUTBB022,OTARADEP          * Matching preferred unit
              GOTO      CHKREQ10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     OTHEHOSP,OTARPRHS            * Matching preferred hospital
          GOTO      CHKREQ10 IF NOT EQUAL
.
          MATCH     REFRLVIS,OTARREFN            * Matching referral number
          GOTO      CHKREQ10 IF NOT EQUAL
.
          MOVE      SP70,KEY11
          MATCH     SP70,OTARPRDT
          IF        !@EQUAL
           UNPACK    OTARPRDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      KEY12,OTARPRSI,OTARCLTY,SP70
          CALL      RDCTYA1
          IF        OVRCD=1
            MOVE      OBACTYP,OCTDESC
          ENDIF
.
          PACK      KEY20,OTARPRSI,OTARCLID,OTARPRDT,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            MATCH     SP70,OTARPRDT
            IF        @EQUAL
              PACK      KEY20,OTARPRSI,OTARCLID,Z70
            ELSE
              PACK      KEY20,OTARPRSI,OTARCLID,OTARPRDT,Z70
            ENDIF
.
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CHKREQ50
.
            MATCH     OTARPRSI,OCASITE
            GOTO      CHKREQ50 IF NOT EQUAL
.
            MATCH     OTARCLID,OCACLIN
            GOTO      CHKREQ50 IF NOT EQUAL
          ENDIF
.
CHKREQ50  PACK      KEY5,ANSA,ANSC,OTARADEP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE     OTARADEP,TDESC
          ENDIF
.
          PACK      KEY3,OTARPRHS,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      OTARPRHS,PTHSNAME
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE,"|",KEY11,"|",OCTDESC,"|",OCADESC,"|":
                    TDESC,"|",PTHSNAME,"|",OTARREFN:
                    "</RETURN_VALUE>"
.
          GOTO      CHKREQ99
.
CHKREQ80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
CHKREQ99  RETURN
+
.------------------------------------------------------------
. DISSEL00 - Display Selection List for Disasters
.------------------------------------------------------------
.
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "3",DSMAACTV
          GOTO      DISSEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DSMACODE,"#">":
                             DSMADESC,"</option>"
          GOTO      DISSEL10
.
DISSEL99  RETURN
+
.------------------------------------------------------------
. DISCD000 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCD000  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCD010  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCD999
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCD999 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISCD010 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSPLCODE;
          ENDIF
.
DISCD999  RETURN
.
.------------------------------------------------------------
. DISDS000 - Get Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISDS000  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISDS010  CALL      RKDSPTL1
          BRANCH    OVRCD,DISDS999
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISDS999 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISDS010 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            PACK      KEY9,DSPLCODE,SP70
            CALL      RDDSMAS1
            IF        OVRCD=0
              WRITE     HTMLFILE;DSMADESC;
            ENDIF
          ENDIF
.
DISDS999  RETURN
.
.------------------------------------------------------------
. DISSD000 - Get Saved Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISSD000  MATCH     SP70,SAVDSPLC
          IF        !@EQUAL & !@EOS
            PACK      KEY9,SAVDSPLC,SP70
            CALL      RDDSMAS1
            IF        OVRCD=0
              WRITE     HTMLFILE;DSMADESC;
            ENDIF
          ENDIF
.
DISSD999  RETURN
+
.*******************************************************************************
. Display comments
.*******************************************************************************
DISCOM00  PACK      KEY29,COMMURNO,COMMADAT,COMMATIM,COMMTYPE,SP70
          CALL      RAOTDCO1
DISCOM10  CALL      RKOTDCO1
          BRANCH    OVRCD,DISCOM99
.
          MATCH     COMMURNO,OTDOURNO
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMADAT,OTDOADAT
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMATIM,OTDOATIM
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMTYPE,COMMTYPE
          GOTO      DISCOM99 IF NOT EQUAL
.
          STRIP     OTDOCOMM
          MOVELPTR  OTDOCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      OTDOCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      DISCOM10
.
DISCOM99  RETURN
+
.*******************************************************************************
. Populate the first appointment booked field for SOP internal referrals
.*******************************************************************************
FAPD0000  MATCH     "1",ALREUYN4                 * Exit if master referral
          GOTO      FAPD9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1                      * Read department
          BRANCH    OVRCD,FAPD9999
.
.         MATCH     ANSO,TCINDC8                 * SOP referrals only
.         GOTO      FAPD9999 IF NOT EQUAL
.
          MATCH     SP70,ALREUDT8                * Exit if first appointment
          GOTO      FAPD9999 IF NOT EQUAL        * booked alredy populated
.
          IF        EPAUDFLG = 0
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            MOVE      ONE,EPAUDFLG
          ENDIF
.
          MOVE      OBADATE,ALREUDT8             * Set to booking date
.
          CALL      UPALREF1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
FAPD9999  RETURN
+
.*******************************************************************************
. Get Outpatient Sessions for a Range and display all appointment for
. the muti session case list
.*******************************************************************************
CHCKIN00  PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
CHCKIN10  CALL      RDKSESA6
          BRANCH    OVRCD,CHCKIN99
.
          MATCH     WBSESIT,OSESITE
          GOTO      CHCKIN99 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      CHCKIN99 IF LESS
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      CHCKIN10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHCKIN10
.
          MATCH     SP70,SRCHCIND           * filter on clinic indicator
          IF        !@EQUAL
            MATCH     SRCHCIND,OTHECIND
            GOTO      CHCKIN10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      CHCKIN10 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CHCKIN10
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      CHCKIN10 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CHCKIN10
          BRANCH    OMASTAT,CHCKIN10
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CHCKIN10 IF LESS
.
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CHCKIN10 IF LESS
          ENDIF
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTCIDESC
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTCTDESC
.
......    CALL      CHKSUS00
......    BRANCH    EXIT,CHCKIN10
.
......    CALL      CHKAPP00          * Check slot visit type and status
......    BRANCH    EXIT,CHCKIN10
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CHCKIN10
.
            MATCH     OSESITE,OCASITE
            GOTO      CHCKIN10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      CHCKIN10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHDOCT
          IF        !@EQUAL
            MATCH     OCADOCT,SRCHDOCT
            GOTO      CHCKIN10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.                                           *** HPS Code Starts Here ***
          COMPARE   ONE,TMPFLG
          GOTO      CHCKIN20 IF EQUAL
.                                           *** HPS Code Ends Here ***
CHCKIN11  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      ZERO,FULLONLY
          CALL      CASCHK00
.
          GOTO      CHCKIN10
.
CHCKIN20  MATCH     OMATYP,CLINTYPE
          GOTO      CHCKIN10 IF NOT EQUAL
          GOTO      CHCKIN11
.
CHCKIN99  RETURN
.
.*******************************************************************************
.                           Output Case List Table
.*******************************************************************************
CASCHK00  MOVE      ZEROVISN,LASTOUTN
          MOVE      ZERO,RECCNT
          PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CASCHK10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CASCHK99          * end of session
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CASCHK99 IF NOT EQUAL   * different sessio
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      CASCHK10 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
          IF        (OBASTAT=1|OBASTAT=4|OBASTAT=5)
            CALL      CHKSL000 * Full Slot
          ENDIF
.
          GOTO      CASCHK10
.
CASCHK99  RETURN
.
.*******************************************************************************
.                              Full Slot
.*******************************************************************************
CHKSL000  CALL      CASDET00
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
          MOVE      DSEXDESC,DISPSEX
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          CALL      PATFLD00                          * Get patient folder
          MOVE      KEY3,PATFOLDR
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,CHARTREV                  * No
          MATCH     ANSC,TCINDC8                 * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV                * Yes
          ENDIF
.                                           *** HPS Code Starts Here ***
          IF        OBASTAT=5  
            MOVE      "DNA",SHOWDNA
          ELSE
            MOVE      SP70,SHOWDNA
          ENDIF
          MOVE      TDESC,VTYPDESC
.....     PACK      KEY8,OBAURNO,SP70                 * Read For Alert
.....     CALL      RDPTMSX1
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG1,CODE
          CALL      GETCOD00
          MOVE      TDESC,INTERNAM
.
          MOVE      "SA",CATEGORY
          MOVE      OTBBSPCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,SPECANAM
.
          MOVE      "OZ",CATEGORY
          MOVE      OTBBOUTC,CODE
          CALL      GETCOD00
          PACK      VOUTDESC,TDESC,SP70
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
            MOVE      OBAOUTNO,PVIBILL
            MOVE      OBADATE,PVIDATE
            MOVE      "2",PVITYPE
            MOVE      " 2",PTVITYPE
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          RESET     HTMLLINK
.
          UNPACK    SP70,PMVXUDF1
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11                * Read for interpretor/confirmed status
.
          CALL      GETALS00  * Get Alert String
          CALL      CHKS0000  * Check if this is a series booking
          CALL      DCMBS000  * check for any CMBS items
          CALL      GHCST000  * Get hic claim status
          CALL      GETSTA00  * Get Status                (STATNAME,CBSTAT1,DISPCLHR,FLUPDESC)
          CALL      GETAID00  * Get Patient ID            (PATIDENT)
          CALL      GETCPM00  * Get Confirm PMI  Flag     (CONFRPMI,DISPDATE-PTMADCDT)
          CALL      GETSDC00  * Get Service Delivery Mode (DISPSRVD)
          CALL      GETCLR00  * Get Style Font Color
          CALL      GETALH00  * Get Allied Health Details
          CALL      SRXP0000  * Set referral expiry highlight colour class
.
          CALL      SETX0000  * Set highlight colour
          CALL      SRXW0000  * Set referral expiry highlight colour class
          CALL      OPDM0000  * check appointment msg and if it is completed
.
          CALL      CURP0000
.
          MOVE      SP70,DISPHFND
          MATCH     SP70,PFUNDH
          IF        !@EQUAL
            STRIP     PFUNDH
            STRIP     PFNDTB
            PACK      DISPHFND,PFUNDH,SLASH,PFNDTB,SP70
          ENDIF
.
          CALL      DOMCLR00                       * Get Demographic date color
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBADATE,OBATIME,"#",":         *1
                             "#"",OBASLOT,"#",":                 *2
                             "#"",OBAVISIT,"#",":                *3
                             "#"",VTYPDESC,"#",":                *4
                             "#"",FORMATNM,"#",":                *5
                             "#"",PATIDENT,"#",":                *6
                             "#"",OBAOUTNO,"#",":                *7
                             "#"",DISPSEX,"#",":                 *8
                             "#"";                 
.
CHKSL500  CALL      WRTAGE00                                     *9
          WRITE     HTMLFILE;"#",":
                             "#"",OTBBASTM,"#",":                *10
                             "#"",OTBBCITM,"#",":                *11
                             "#"",OTBBDPTM,"#",":                *12
                             "#"",OBASTAT,"#",":                 *13
                             "#"",FLUPDESC,"#",":                *14
                             "#"",SHOWDNA,"#",":                 *15
                             "#"",ALERTSTR,"#",":                *16
                             "#"",PTELEP,"#",":                  *17
                             "#"",PTELEB,"#",":                  *18
                             "#"",PTMXCELL,"#",":                *19
                             "#"",CASEKEYS,"#",":                *20
                             "#"",INTERNAM,"#",":                *21
                             "#"",SPECANAM,"#",":                *22
                             "#"",STATNAME,"#",":                *23
                             "#"",PATFOLDR,"#",":                *24
                             "#"",OTBBOUTC,"#",":                *25
                             "#"<font color=",FONTCOLR,">",OBAVISIT,"</font>#",":  *26
                             "#"<font color=",FONTCOLR,">",VTYPDESC,"</font>#",":  *27
                             "#"",OBACOMP,"#",":                 *28 - claim code
                             "#"",HIGHCOLR,"#",":                *29 - highlight colours
                             "#"",OBASRCR,"#",":                 *30 - source of ref
                             "#"",OBAOUTNO,"#",":                *31 - Visit number
                             "#"",OCTDESC,"#",":                 *32 - Clinic Type
                             "#"",OCADESC,"#",":                 *33 - Clinic Name
                             "#"",OCTCTYP,"#",":                 *34 - Clinic Type Code
                             "#"<input type=checkbox name=mcask",DRECCNT,CBSTAT1:
                             " onClick=UpdateConf(this); value='",CASEKEYS,"'>#",":   *35
                             "#"",CHARTREV,"#",":                *36
                             "#"",CTCTDESC,"#",":                *37 - Location Cat CT
                             "#"",ALERTST2,"#",":                *38 - Alert String 2
                             "#"",DISPDATE,"#",":                *39 - Confirm PMI Date
                             "#"",CONFRPMI,"#",":                *40 - Confirm PMI
                             "#"",OTHECPAG,"#",":                *41 - Use Checkin Page
                             "#"",OPDMFLAG,"#",":                *42 - Message Flag
                             "#"",ALREVISN,"#",":                *43 - Referral Number
                             "#"",ALREDEPT,"#",":                *44 - Referral Number
                             "#"",DISPCLMN,"#",":                *45 - Referral Dept
                             "#"",UMEDFLAG,"#",":                *46 - Using med claims
                             "#"",OTHEADEP,"#",":                *47 - A/H Departmetn  
                             "#"",OTHECENC,"#",":                *48 - Collect Enc
                             "#"",ALENENCT,"#",":                *49 - Linked Enc 
                             "#"",CTCIDESC,"#",":                *50 - Clinic Indicator
                             "#"",OTBBDPTM,SP1,VOUTDESC,"#",":   *51 - Clinic Indicator
                             "#"",OTHEDURN,"#",":                *52 - Slot duration
                             "#"",CURRINPT,CURREMRP,"#",":    *53 - Cur Inp, Emr
                             "#"",DISPHFND,"#",":             *54 - Health Fund 
                             "#"",REFXCLAS,"#",":             *55 - Ref Expiry  
                             "#"",REFXWCLS,"#",":             *56 - Ref Expiry W
                             "#"",ALREREXP,"#",":             *57 - Ref Expiry D
                             "#"",DISPSRVD,"#",":             *58 - Service Delivery
                             "#"",DOMCOLOR,"#");"             *59 - Demographic date color
.
          GOTO      CHKSL999
.
CHKSL999  RETURN
.------------------------------------------------------------
. Get Confirm PMI FLag & Date
.------------------------------------------------------------
GETCPM00  MOVE      ZERO,CONFRPMI 
          IF        PTCNHDPS<>1
            MATCH     "1",OTHECPMI
            IF        @EQUAL
              IF        CHARTREV<>1
                MATCH     OBADATE,PTMADCDT
                IF        @LESS
                  MOVE      ONE,CONFRPMI  
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PTMADCDT
          IF        !@EQUAL
            UNPACK    PTMADCDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          RETURN
.------------------------------------------------------------
. Get Alternate Display ID 
.------------------------------------------------------------
GETAID00  MATCH     "1",PTCNDAUR
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS
          ENDIF
          PACK      PATIDENT,OBAURNO,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MATCH     SP70,KEY20
            IF        !@EQUAL
              MOVE      KEY20,PATIDENT
            ENDIF
          ENDIF
          STRIP     PATIDENT
          RETURN
.------------------------------------------------------------
. Get Status and Sundry Items
.------------------------------------------------------------
GETSTA00  MOVE      SP70,STATNAME
          LOAD      STATNAME,OBASTAT,STATBOK,STATNOT,STATEXT,STATATT,STATDNA
          MOVE      SP70,CBSTAT1
          IF        (OBASTAT=1) | (OBASTAT=4) | (OBASTAT=5)
            MATCH     "1",PMVXCONF                       * 59 - Confirmed
            IF        @EQUAL
              MOVE      " checked ",CBSTAT1
            ENDIF   
          ENDIF
.
          MOVE      SP70,DISPCLHR
          MATCH     "1",OTBBCLHR
          IF        @EQUAL
            MOVE      "Yes",DISPCLHR                  * Clinical high risk
          ENDIF
.
          MOVE      SP70,FLUPDESC
          MATCH     "1",OTBBFLUP
          IF        @EQUAL
            MOVE      "Done",FLUPDESC
          ENDIF
.
          RETURN
.
.------------------------------------------------------------
. Get Service Delivery Mode Description
.------------------------------------------------------------
GETSDC00  MOVE      SP70,DISPSRVD
          MATCH     SP70,OTBBSRVD
          IF        !@EQUAL
            PACK      KEY5,CATSD,OTBBSRVD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTBBSRVD,TDESC
            ENDIF
            MOVE    TDESC,DISPSRVD                    * Service Delivery Mode
          ENDIF
          RETURN
.------------------------------------------------------------
. Get Style Font Color
.------------------------------------------------------------
GETCLR00  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      "black",FONTCOLR
          MATCH     ANSZ,TCINDC2                                           *36
          IF        @EQUAL
            MOVE      "magenta",FONTCOLR
          ELSE
            IF        BOOKSERS=1
              MOVE      "green",FONTCOLR
            ELSE
              MATCH     ANSU,TCINDC6
              IF        @EQUAL
                MOVE      "red",FONTCOLR
              ENDIF
            ENDIF
          ENDIF
          RETURN
.------------------------------------------------------------
.  Get Alert String
.------------------------------------------------------------
GETALS00  PACK      ALERTST2,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:
                             PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15,SP70
          REP       " 0",ALERTST2
          CLEAR     ALERTSTR
          APPEND    PTMXSIN1,ALERTSTR
          APPEND    PTMXSIN2,ALERTSTR
          APPEND    PTMXSIN3,ALERTSTR
          APPEND    PTMXSIN4,ALERTSTR
          APPEND    PTMXSIN5,ALERTSTR
.
          MATCH     SP70,OTBBSPCA
          IF        @EQUAL
            APPEND    ZERO,ALERTSTR
          ELSE
            APPEND    ONE,ALERTSTR
          ENDIF
.
          CALL      CHKINT00             * Append Interpretor
          CALL      CHKCPV00             * Append Category PV Indicator P
          CALL      CHKTRN00             * Append Transport Flag to ALERTSTR
.
          APPEND    SP70,ALERTSTR
          RESET     ALERTSTR
.
          RETURN
.------------------------------------------------------------
. Append Interpretor
.------------------------------------------------------------
CHKINT00  MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     SP70,PMVXINTR
            IF        @EQUAL
              APPEND    ZERO,ALERTSTR
            ELSE
              MATCH     "0",PMVXINTR
              IF        !@EQUAL
                APPEND    ONE,ALERTSTR
              ELSE
                APPEND    ZERO,ALERTSTR
              ENDIF
            ENDIF
          ELSE
            MATCH     SP70,PMPXINTR
            IF        @EQUAL
              APPEND    ZERO,ALERTSTR
            ELSE
              MATCH     "0",PMPXINTR
              IF        !@EQUAL
                APPEND    ONE,ALERTSTR
              ELSE
                APPEND    ZERO,ALERTSTR
              ENDIF
            ENDIF
          ENDIF
          RETURN
.------------------------------------------------------------
.  Append Category PV Indicator P
.------------------------------------------------------------
CHKCPV00  MOVE      "PV",CATEGORY
          MOVE      PMPXPRVI,CODE
          CALL      GETCOD00
          MATCH     ANSP,TCINDC1
          IF        @EQUAL
            APPEND    ONE,ALERTSTR
          ELSE
            APPEND    ZERO,ALERTSTR
          ENDIF
          RETURN
.------------------------------------------------------------
. Append Transport Flag to ALERTSTR
.------------------------------------------------------------
CHKTRN00  PACK      KEY19,OBAURNO,OBAOUTNO,SP70            * Read For Transport
          CALL      RSPMTSP1
CHKTRN10  CALL      RKPMTSP1
          BRANCH    OVRCD,CHKTRN90
          MATCH     PMTSURNO,OBAURNO
          GOTO      CHKTRN90 IF NOT EQUAL
          MATCH     PMTSVISN,DOBAOUTN
          GOTO      CHKTRN90 IF NOT EQUAL
          MATCH     "1",PMTSBOOK
          IF        @EQUAL
            APPEND    ONE,ALERTSTR
            GOTO      CHKTRN99
          ENDIF
          GOTO      CHKTRN10
CHKTRN90  APPEND    ZERO,ALERTSTR
CHKTRN99  RETURN
.------------------------------------------------------------
. Get Allied Health
.------------------------------------------------------------
GETALH00  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                * check for associated referral
          IF        OVRCD=1
            PACK      ALLNLNKV,SP70
            PACK      ALLNVISN,SP70
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      GETALH99
          ENDIF
.
          MATCH     DOBAOUTN,ALLNLNKV
          IF        !@EQUAL
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      GETALH99
          ENDIF
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1                * get associated referral details
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLENC
            GOTO      GETALH99 
          ENDIF
.
          PACK      KEY24,OBAOUTNO,SP70
          CALL      RSALENC7
GETALH50  CALL      RKALENC7
          IF        OVRCD=1
            CALL      CLALLENC
            GOTO      GETALH99 
          ENDIF
.
          MATCH     DOBAOUTN,ALENLINK
          IF        !@EQUAL
            CALL      CLALLENC
            GOTO      GETALH99
          ENDIF
.
          MATCH     "1",ALENRSTA            * Cancelled
          GOTO      GETALH50 IF EQUAL
.
GETALH99  RETURN
.
.*******************************************************************************
.                    Read/Display Patient Instructions 
.*******************************************************************************
RDPI0000  
.         MOVE      "013",KEY3
          PACK      KEY14,KEY8,KEY3,SP70
          CALL      RSVSCMT1
RDPI1000  CALL      RKVSCMT1
          BRANCH    OVRCD,RDPI9999          * end of file
          MATCH     VSCTVIST,KEY8           * same Admission Number?
          GOTO      RDPI9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      RDPI9999 IF NOT EQUAL
.
          UNPACK    VSCTDATA,DIM60,DIM40    * only use first 60 chars
          WRITE     HTMLFILE;DIM60
          GOTO      RDPI1000
.
RDPI9999  RETURN
+
.*******************************************************************************
.                Get Linked Referral Number
.*******************************************************************************
LNKREF00  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,LNKREF99          * not a referral
.
          MATCH     ADMISSNO,ALLNLNKV
          GOTO      LNKREF99 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LNKREF99
.
          MATCH     "4",ALRESTAT
          GOTO      LNKREF99 IF EQUAL
.
          MATCH     "0",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;ALREVISN; 
          ENDIF
.
          MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;ALREDEPT;
          ENDIF
.
LNKREF99 RETURN
+
.------------------------------------------------------------
. Validate clinic type procedure
.------------------------------------------------------------
CHKPRO00  PACK      KEY21,WBSESIT,CLINTYPE,VALDCODE,SP70
          CALL      RDOTCPC1
          BRANCH    OVRCD,CHKPRO90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OTCPDESC,"|":
                             "</RETURN_VALUE>"
.
          GOTO      CHKPRO99
.
CHKPRO90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Procedure - ",KEY21:
                             "</RETURN_VALUE>"
          GOTO      CHKPRO99
.
CHKPRO99  RETURN
.
.------------------------------------------------------------
. Validate clinic type problem
.------------------------------------------------------------
CHKPRB00  PACK      KEY21,WBSESIT,CLINTYPE,VALDCODE,SP70
          CALL      RDOTCPB1
          BRANCH    OVRCD,CHKPRB90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OTPBDESC,"|":
                             "</RETURN_VALUE>"
.
          GOTO      CHKPRB99
.
CHKPRB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Problem - ",KEY21:
                             "</RETURN_VALUE>"
          GOTO      CHKPRB99
.
CHKPRB99  RETURN
.
.------------------------------------------------------------------------------
. Check if the U/R is a current IP or EMR patient
. Returns: CURRINPT = 0 - Not a current IP
.                     1 - Current IP in users hospital
.                     2 - Current IP at another hospital
.          CURREMRP = 0 - Not a current EMR patient
.                     1 - Current EMR patient in users site
.                     2 - Current EMR patient at another site
.------------------------------------------------------------------------------
CURP0000  MOVE      ZERO,CURRINPT                * Not a current IP
          MOVE      ZERO,CURREMRP                * Not a current EMR patient
.
          PACK      KEY17,OBAURNO,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                     * Check for current IP
          BRANCH    OVRCD,CURP5000
.
          MATCH     OBAURNO,AURNO                * Same U/R
          GOTO      CURP5000 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT                    * Current IP
          GOTO      CURP5000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                     * Read visit extn file
          BRANCH    OVRCD,CURP5000
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP
            IF        @EQUAL
              MOVE      ONE,CURRINPT        * Current IP in users hospital
            ELSE
              MOVE      TWO,CURRINPT        * Current IP at another hospital
            ENDIF
          ELSE
            MOVE      ONE,CURRINPT          * Current IP in users hospital
          ENDIF
.
CURP5000  PACK      KEY16,OBAURNO,Z70
          CALL      RSEMVIS3
          CALL      RPEMVIS3                * Check for current EMR
          BRANCH    OVRCD,CURP9999
.
          MATCH     OBAURNO,EMVIURNO             * Same U/R
          GOTO      CURP9999 IF NOT EQUAL
.
          COMPARE   ONE,EMVISTAT                 * Current EMR visit
          GOTO      CURP9999 IF NOT EQUAL
.
          MATCH     EMVISITE,WBSEESC
          IF        @EQUAL
            MOVE      ONE,CURREMRP     * Current EMR patient in users site
          ELSE
            MOVE      TWO,CURREMRP     * Current EMR patient at another site
          ENDIF
.
CURP9999  RETURN
.
.---------------------------------------------------------------------------
. Check if a patient is booked/attened in any OP clinic for a 
. given date at any site 
.---------------------------------------------------------------------------
CHKSAP00  MOVE      ZERO,SITEPRFX           * This site prefix done = No
.
          PACK      KEY9,SP70
          CALL      RDSSITA3
CHKSAP10  CALL      RDKSITA3                * Check all OP sites
          BRANCH    OVRCD,CHKSAP90
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEPRFX         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEPRFX,CHKSAP10       * Skip if this site prefix is done
          MOVE      ONE,SITEPRFX            * This site prefix done = yes
.
          PACK      KEY36,URNUMBER,VALDDATE,SP70
          CALL      RDSBOKA3
CHKSAP30  CALL      RDKBOKA3
          BRANCH    OVRCD,CHKSAP10               
.
          MATCH     URNUMBER,OBAURNO             * Correct U/R
          GOTO      CHKSAP10 IF NOT EQUAL

          MATCH     VALDDATE,OBADATE             * Correct Date
          GOTO      CHKSAP10 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT                  * Booked
          GOTO      CHKSAP40 IF EQUAL
.
          COMPARE   FOUR,OBASTAT                 * Attended
          GOTO      CHKSAP40 IF EQUAL
.
          GOTO      CHKSAP30
.
CHKSAP40  PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      CHKSAP50
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CHKSAP30
.
          MATCH     OBASITE,OCASITE
          GOTO      CHKSAP30 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      CHKSAP30 IF NOT EQUAL
.
CHKSAP50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                    "Patient has an Appointment on this day for ";
.
          IF        IBCNMHOS<>1
            WRITE     HTMLFILE;OCADESC
            GOTO      CHKSAP70
          ENDIF
.
          STRIP     OCADESC
          WRITE     HTMLFILE;*+,OCADESC,*-;
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,CHKSAP70
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT:
                          OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHKSAP70
.
          COMPARE   ONE,PTCNHDPS
          GOTO      CHKSAP60 IF NOT EQUAL
.
.         Output the Clinic Location (NZ only)
.
          MATCH     OTHELTYP,SP70
          GOTO      CHKSAP60 IF EQUAL
.
          MOVE      "CT",CATEGORY       * Clinic Master Location Type
          MOVE      OTHELTYP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          BRANCH    OVRCD,CHKSAP60
.
          STRIP     TDESC
          WRITE     HTMLFILE;" at ",TDESC;
.
.         Get the Clinic Hospital
.
CHKSAP60  PACK      KEY3,OTHEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKSAP70
.
          WRITE     HTMLFILE;", ",PTHSNAME;
.
CHKSAP70  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      CHKSAP99
.
CHKSAP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHKSAP99
.
CHKSAP99  RETURN
.
.---------------------------------------------------------------------------
. Check for Waiting/Active AH Referral Letters
.---------------------------------------------------------------------------
REFLET00  MOVE      SP70,SAVEREFN                * Clear save referral number
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
REFLET10  CALL      RKALREF2                     * Read referrals for this U/R
          BRANCH    OVRCD,REFLET20
.
          MATCH     ALREURNO,URNUMBER            * Correct U/R
          GOTO      REFLET20 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT                 * Waiting
          IF        !@EQUAL
            MATCH     "1",ALRESTAT               * Active
            GOTO      REFLET10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SAVEREFN                * Multiple waiting/active
          GOTO      REFLET80 IF NOT EQUAL        * referrals found
.         
          MOVE      ALREVISN,SAVEREFN            * Save referral number
          GOTO      REFLET10
.
. One waiting or active referral
.
REFLET20  MATCH     SP70,SAVEREFN                * No waiting/active referals
          GOTO      REFLET90 IF EQUAL
.
          PACK      KEY8,SAVEREFN,SP70           * Re read saved referral
          CALL      RDALREF1
          BRANCH    OVRCD,REFLET90
.
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          IF        OVRCD=0
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      ALDEPENC,PRIMARYE
            ENDIF
          ENDIF
.
.-------- Clinic Type description
          MOVE      SP70,OCTDESC
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
.-------- Case Team description
          MOVE      SP70,ALCADESC
          PACK      KEY10,ALREUHC4,SP70
          CALL      RDALCAS1
.          
.-------- Clinic Id description
          MOVE      SP70,OCADESC
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,REFLET30
.
          MATCH     ALREPSIT,OCASITE
          GOTO      REFLET30 IF NOT EQUAL
.
          MATCH     ALRECLID,OCACLIN
          GOTO      REFLET30 IF NOT EQUAL
          GOTO      REFLET50
.
REFLET30  MOVE      SP70,OCADESC               * Clinic desc not found
.         
REFLET50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE,"|",KEY11,"|",ALRECTYP,"|",ALRECLID,"|",ALREVISN,"|":
                    ALREUHC4,"|",PRIMARYE,"|",OCTDESC,"|",OCADESC,"|",ALCADESC:
                    "</RETURN_VALUE>"
          GOTO      REFLET99
.
. Multiple waiting or active referrals
.
REFLET80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    TWO:                                
                    "</RETURN_VALUE>"
          GOTO      REFLET99
.
. No waiting or active referrals
.
REFLET90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
REFLET99  RETURN
.
.---------------------------------------------------------------------------
. Check if appointmnet requests exist
.---------------------------------------------------------------------------
CHKARQ00  PACK      KEY32,URNUMBER,ADMISSNO,Z70
          CALL      RSOTART1
CHKARQ10  CALL      RPOTART1
          BRANCH    OVRCD,CHKARQ90
.
          MATCH     URNUMBER,OTARURNO           * same ur number
          GOTO      CHKARQ90 IF NOT EQUAL
.
          MATCH     SP70,ADMISSNO              * Visit number available?
          IF        @EQUAL | @EOS
            GOTO      CHKARQ20                 * No,check requested status
          ELSE 
            MATCH     ADMISSNO,OTARREFN        * Yes, check same referral/visit
            GOTO      CHKARQ90 IF NOT EQUAL
          ENDIF
.
CHKARQ20  MATCH     "0",OTARSTAT               * Check requested status
          GOTO      CHKARQ10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:
                    "</RETURN_VALUE>"
          GOTO      CHKARQ99
.
CHKARQ90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
          GOTO      CHKARQ99
.
CHKARQ99  RETURN
+
.*******************************************************************************
. Check outpatient booking claim type has linked referral and is the same 
.*******************************************************************************
CHKORT00  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,CHKORT10
          GOTO      CHKORT20
.
CHKORT10  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                   * Check if linked referral exists
          BRANCH    OVRCD,CHKORT90
.
          MATCH     ADMISSNO,ALLNLNKV
          GOTO      CHKORT90 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1
          BRANCH    OVRCD,CHKORT90
.
CHKORT20  MATCH     ALRECOMP,OUTBB002
          GOTO      CHKORT90 IF EQUAL
.
          MATCH     URNUMBER,ALREURNO
          GOTO      CHKORT90 IF NOT EQUAL
.
	  MATCH     SP70,ALRECOMP
          GOTO      CHKORT90 IF EQUAL
.
          MATCH     SP70,OUTBB002
          GOTO      CHKORT90 IF EQUAL
.
          PACK      KEY5,CATCL,ALRECOMP
          CALL      RDCODE1
          BRANCH    OVRCD,CHKORT90
.
          MOVE      TDESC,REFCLMCD
.
          PACK      KEY5,CATCL,OUTBB002
          CALL      RDCODE1
          BRANCH    OVRCD,CHKORT90
.
          MOVE      TDESC,OUTCLMCD
.
          PACK      KEY5,CATCL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKORT90
.
          MOVE      TDESC,CATDESCD
.
CHKORT80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE,"|",REFCLMCD,"|",OUTCLMCD,"|",CATDESCD:
                    "</RETURN_VALUE>"
          GOTO      CHKORT99
.
CHKORT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
          GOTO      CHKORT99   
.
CHKORT99  RETURN
+
.*******************************************************************************
. Update referral claim details to match details found in outpatient
.*******************************************************************************
UPDORT00  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,UPDORT10
          GOTO      UPDORT20
.
UPDORT10  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,UPDORT90
.
          MATCH     ADMISSNO,ALLNLNKV
          GOTO      UPDORT90 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1
          BRANCH    OVRCD,UPDORT90
.         
UPDORT20  MOVE      OUTBB002,ALRECOMP
          CALL      UPALREF1
.
          PACK      KEY8,ALREURNO
          CALL      RDMAST1                 * read pmi details for I13 message
          BRANCH    OVRCD,UPDORT90
.
          PACK      KEY8,PURNO
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDORT90
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          PACK      D3,PMSVX141,SP70
          MATCH     Z70,D3
          IF        !@EQUAL
.0934998    PACK      KEY8,PMVXVISN
            PACK      KEY8,ALREVISN
            CALL      RDPMVX11 
            BRANCH    OVRCD,UPDORT90
.
            MATCH     D3,PMVXFSRC
            IF        !@EQUAL
              MOVE      D3,PMVXFSRC
              CALL      UPPMVX11
            ENDIF
          ENDIF
.
UPDORT80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:
                    "</RETURN_VALUE>"
          GOTO      UPDORT99
.
UPDORT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
          GOTO      UPDORT99
.
UPDORT99  RETURN
+
.*******************************************************************************
.                        Write ACC Details
.*******************************************************************************
WRTACC00  MATCH     ANSN,PTCNLCLM
          GOTO      WRTACC99 IF NOT EQUAL
.
         MATCH      SP70,REFRLVIS
         GOTO       WRTACC99 IF EQUAL
         GOTO       WRTACC99 IF EOS
.
         PACK       KEY8,REFRLVIS,SP70
         CALL       RDWCOM1
         IF         OVRCD=ZERO
           PACK       KEY8,ADMISSNO,SP70
           CALL       RDAWCOM1
           IF         OVRCD=ONE
             MOVE       ADMISSNO,WCADMNO
             CALL       WRWCOM1
           ENDIF
         ENDIF
.
         PACK       KEY8,REFRLVIS,SP70
         CALL       RDPMWX11
         IF         OVRCD=ZERO
           PACK       KEY8,ADMISSNO,SP70
           CALL       RAPMWX11
           IF         OVRCD=ONE
             MOVE       ADMISSNO,PMWXVISN
             CALL       WRPMWX11
           ENDIF
         ENDIF
.
WRTACC99 RETURN
+
.--------------------------------------------------------------------------
. Referral Bulk Billing Maintenance
.--------------------------------------------------------------------------
REFBLK00  MOVE      ZERO,EXIT
          SQUEEZE   UPDATET1
          MATCH     SP70,UPDATET1 
          GOTO      REFBLK40 IF EOS
.
          MATCH     "U",UPDATET1            * Update Formaction
          GOTO      REFBLK20 IF EQUAL
.
          GOTO      REFBLK93
.
.         ************ UPDATE FORMACTION **********
.
REFBLK20  PACK      KEY8,ADMISSNO,SP70      
          CALL      RDBOKB1 
          BRANCH    OVRCD,REFBLK92
.
. Moves cgi to file variables
.
          MATCH     Z70,OUTBB075
          IF        !@EQUAL
            MOVE      OUTBB075,OTBBBKOV
          ENDIF
.
          MATCH     Z70,OUTBB076
          IF        !@EQUAL
            MOVE      OUTBB076,OTBBBKPR
          ENDIF
.
          MATCH     Z70,OUTBB077
          IF        !@EQUAL
            MOVE      OUTBB077,OTBBBKPM
          ENDIF
.
          MATCH     Z70,OUTBB078
          IF        !@EQUAL
            MOVE      OUTBB078,OTBBBKBA
          ENDIF
.
          MATCH     Z70,OUTBB079
          IF        !@EQUAL
            MOVE      OUTBB079,OTBBRDAT
          ENDIF
.
          MATCH     Z70,OUTBB080
          IF        !@EQUAL
            MOVE      OUTBB080,OTBBHCP1
          ENDIF
.
          MATCH     Z70,OUTBB081
          IF        !@EQUAL
            MOVE      OUTBB081,OTBBHCP2
          ENDIF
.
          MATCH     Z70,OUTBB082
          IF        !@EQUAL
            MOVE      OUTBB082,OTBBHCP3
          ENDIF
.
          MATCH     Z70,OUTBB083
          IF        !@EQUAL
            MOVE      OUTBB083,OTBBHCP4
          ENDIF
.
          CALL      UPBOKB1                  * Update booking details
          BRANCH    OVRCD,REFBLK92
.
          MOVE      ZERO,EXIT
          GOTO      REFBLK99
.
REFBLK40  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70      * Outpatient booking details
          CALL      RDBOKB1 
          BRANCH    OVRCD,REFBLK92
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2                * Check for a linked referral
          CALL      RKALLNK2
          BRANCH    OVRCD,REFBLK42
.
          MATCH     ADMISSNO,ALLNLNKV       * Same OP visit number
          GOTO      REFBLK42 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,REFBLK42
.
          MATCH     "1",ALRESTAT
          IF        !@EQUAL
            CALL      CLALLREF
          ENDIF
.
REFBLK42  CLEAR     WEBTITLE
          MOVE      "Bulk Billing Referral Details.",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,REFBLK99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK92  MOVE      "Invalid Outpatient Booking.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK99  RETURN
+
.------------------------------------------------------------------------------
PATCALF
PRLN0000
WOUT0000
NXTTRAN1  RETURN    * Dummy routine for AAECHRG
.
.
.------------------------------------------------------------------------------
. Follow up referral list  - get outpatient sessions for a range
.------------------------------------------------------------------------------
FLST0000  PACK      KEY25,WBSESIT,FRSTDATE,SP70
          CALL      RDSSESA6
FLST1000  CALL      RDKSESA6
          BRANCH    OVRCD,FLST9999
.
          MATCH     WBSESIT,OSESITE
          GOTO      FLST9999 IF NOT EQUAL
.
          MATCH     OSEDATE,LASTDATE
          GOTO      FLST9999 IF LESS
.
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      FLST1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,FLST1000
.
          BRANCH    OMASTAT,FLST1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,FLST1000
.
          MATCH     "1",OTHEMREF                       * Mandatory Referral
          GOTO      FLST1000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,FLST1000
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      FLST1000 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CLISTB10 IF LESS
.
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      FLST1000 IF LESS
          ENDIF
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      FLST1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SRCHLTYP
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      FLST1000 IF NOT EQUAL
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,FLST1000
.
FLST5000  MOVE      ZEROVISN,LASTOUTN
          MOVE      ZERO,RECCNT
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
FLST5100  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,FLST1000          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      FLST1000 IF NOT EQUAL   * different sessio
.
          COMPARE   SIX,OBASTAT
          GOTO      FLST5100 IF EQUAL
          COMPARE   THREE,OBASTAT
          GOTO      FLST5100 IF EQUAL
          COMPARE   TWO,OBASTAT
          GOTO      FLST5100 IF EQUAL
.
          MATCH     OBAOUTNO,ZEROVISN
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      FLST5100 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
          MOVE      SP70,OTXWDESC
.
          IF        (OBASTAT=0|OBASTAT=9|OBASTAT=7)
            GOTO      FLST5100 * Skip Empty
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,FLST5100
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,FLST5100          * invalid UR number
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                * read 2nd master file extension
          BRANCH    OVRCD,FLST5100          * invalid UR number
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * To get Patient Name
          CALL      PATFLD00                * Patient Folder
.
          MOVE      SP70,DISPMDAT
          MATCH     SP70,PMPXMEDC
          IF        !@EQUAL
            UNPACK    PMPXMEDC,CCENT,CYEAR,CMON,CDAY
            PACK      DISPMDAT,CMON,SLASH,CCENT,CYEAR,SP70
          ENDIF
.
          PACK      REFRLINK,SP70,SP70
          CLEAR     REFRLINK
          APPEND    "javascript:LinkRef('",REFRLINK
          APPEND    OBAURNO,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    DOBAOUTN,REFRLINK
          APPEND    "')",REFRLINK
          RESET     REFRLINK
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
FLST5500  CALL      RKALLNK2                * check for associated referral
          IF        OVRCD=1
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FLST5600
          ENDIF
.
          MATCH     DOBAOUTN,ALLNLNKV
          IF        !@EQUAL
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FLST5600
          ENDIF
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1                * get associated referral details
          IF        OVRCD=1
            CALL      CLALLREF
            MOVE      FOUR,EXPRICON
            MOVE      "No",DISRSTAT
            GOTO      FLST5600
          ENDIF
.
          MATCH    "0",ALRESTAT
          IF       !@EQUAL
            MATCH    "1",ALRESTAT                * Only show waiting and
            GOTO     FLST5100 IF NOT EQUAL       * active referrals
          ENDIF
.
          MOVE      "Yes",DISRSTAT
          CALL      STHI0000                * Set highlight colour
.
          CLEAR     REFRLINK
          APPEND    "javascript:UpdateRef('",REFRLINK
          APPEND    ALREURNO,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    ALREVISN,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    ALREDEPT,REFRLINK
          APPEND    "','",REFRLINK
          APPEND    EXPRICON,REFRLINK
          APPEND    "')",REFRLINK
          RESET     REFRLINK
.
FLST5600  MATCH     "1",EXPRICON            * Only display expired or
          GOTO      FLST5100 IF EQUAL       * about to expire
.
FLST6000  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          RESET     HTMLLINK
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000
          ELSE
            CALL      CLPMSCEX              * Clear extra contacts if not used
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBATIME,"#",":
                             "#"",OBAVISIT,"#",":
                             "#"",OBAURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",KEY3,"#",":
                             "#"",PMEDI," ",PTMXMCCD,"#",":
                             "#"",DISPMDAT,"#",":
                             "#"",ALREREXP,"#",":
                             "#"",OBACOMP,"#",":
                             "#"",PTELEP," ",PMPXMBNO,"#",":    * 10
                             "#"",PMPXMMNO,"#",":
                             "#"",EXPRICON,"#",":
                             "#"",DISRSTAT,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":                    * 15
                             "#"",REFRLINK,"#",":           * Comment URL
                             "#"",SP1,"#",":          
                             "#"",PMCETELM,"#",":
                             "#"",PMCETELP," ",PMCETELB,"#",":
                             "#"",PTELEP," ",PTELEB,"#",":
                             "#"",PTMXCELL,"#",":
                             "#"",PTELEP," ",PTELEB," ",PTMXCELL,"#",": * 22
                             "#"",PMPXMBNO," ",PMPXMMNO,"#");"          * 23
.
          GOTO      FLST5100
.
FLST9999  RETURN
.
.-----------------------------------------------------------------------------.
. Set table highlight/expiry colours
. HIGHCOLR - 0 = Red, 1 = Green, 2 = Orange
.-----------------------------------------------------------------------------.
STHI0000  MOVE      ONE,EXPRICON            * set col=green
.
. Check referral expiry date
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      STHI9999 IF EQUAL
.
          MATCH     ALREREXP,OBADATE        * If expiry<=Clinic date, col=red
          IF        !@LESS
            MOVE      ZERO,EXPRICON
            GOTO      STHI9999
          ENDIF
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,STHI9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      STHI9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    OBADATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     TWO,EXPRICON
          ENDIF
          GOTO      STHI9999
.
STHI9999  RETURN
.
.-----------------------------------------------------------------------------.
. Set class highlight colour for referral not linked/expired or about to 
. xexpire
. REFXCLAS - RefExpired or RefExpiring
.-----------------------------------------------------------------------------.
SRXP0000  MOVE      SP70,REFXCLAS            * Referral expiry class
          MOVE      SP70,REFXWDAT            * Referral expiry warning date
.
          MATCH     "1",OTHEMREF             * Referral mandatory for
          GOTO      SRXP9999 IF NOT EQUAL    * this clinic
.
          MATCH     SP70,ALREVISN            * No linked referral
          IF        @EQUAL
            MOVE      "RefExpired",REFXCLAS
            GOTO      SRXP9999
          ENDIF
.
          MATCH    "0",ALRESTAT
          IF       !@EQUAL
            MATCH    "1",ALRESTAT                * Only show waiting and
            GOTO     SRXP9999 IF NOT EQUAL       * active referrals
          ENDIF
.
          MATCH     SP70,ALREVISN            * No linked referral
          IF        @EQUAL
            MOVE      "RefExpired",REFXCLAS
            GOTO      SRXP9999
          ENDIF
.
. Check referral expiry date
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      SRXP9999 IF EQUAL
.
          MATCH     ALREREXP,OBADATE        * If expiry<=Clinic date
          IF        !@LESS
            MOVE      "RefExpired",REFXCLAS
            GOTO      SRXP9999
          ENDIF
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SRXP9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      SRXP9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    OBADATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     "RefExpiring",REFXCLAS
            MOVE      ALREREXP,CALCDATE
            SUB       F4,CALCDATE
            MOVE      CALCDATE,REFXWDAT     * Referral expiry warning date
          ENDIF
          GOTO      SRXP9999
.
SRXP9999  RETURN
.
.-----------------------------------------------------------------------------.
. Set class highlight colour for referral not linked/expired or about to
. xexpire
. Used when a clinic has not got mandatory referral set to yes.
. REFXWLAS - RefExpired or RefExpiring
.-----------------------------------------------------------------------------.
SRXW0000  MOVE      SP70,REFXWCLS            * Referral expiry class
          MOVE      SP70,REFXWDAT            * Referral expiry warning date
.
          MATCH    "0",ALRESTAT
          IF       !@EQUAL
            MATCH    "1",ALRESTAT                * Only show waiting and
            GOTO     SRXW9999 IF NOT EQUAL       * active referrals
          ENDIF
.
          MATCH     SP70,ALREVISN            * No linked referral
          IF        @EQUAL
            MOVE      "RefExpired",REFXWCLS
            GOTO      SRXW9999
          ENDIF
.
. Check referral expiry date
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      SRXW9999 IF EQUAL
.
          MATCH     ALREREXP,OBADATE        * If expiry<=Clinic date
          IF        !@LESS
            MOVE      "RefExpired",REFXWCLS
            GOTO      SRXW9999
          ENDIF
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SRXW9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      SRXW9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    OBADATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     "RefExpiring",REFXWCLS
            MOVE      ALREREXP,CALCDATE
            SUB       F4,CALCDATE
            MOVE      CALCDATE,REFXWDAT     * Referral expiry warning date
          ENDIF
          GOTO      SRXW9999
.
SRXW9999  RETURN
.
.-----------------------------------------------------------------------------.
. Check if the linked referrals department is using the check in to time
. seems edits. Cat CG ind 28 = S or D means it's not.
.------------------------------------------------------------------------------
DEPE0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2                * Check for a linked referral
          CALL      RKALLNK2
          BRANCH    OVRCD,DEPE8000
.
          MATCH     ADMISSNO,ALLNLNKV       * Same OP visit number
          GOTO      DEPE8000 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70      * Read AH Referral
          CALL      RDALREF1
          BRANCH    OVRCD,DEPE8000
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DEPE8000
.
          MATCH     "S",TCINDC28            * No contact/check in time edit
          GOTO      DEPE9000 IF EQUAL
.
          MATCH     "D",TCINDC28            * No contact/check in time edit
          GOTO      DEPE9000 IF EQUAL
.
DEPE8000  MOVE      ZERO,EXIT               * Yes using edits
          GOTO      DEPE9999
.
DEPE9000  MOVE      ONE,EXIT                * Not using edits
          GOTO      DEPE9999
.
DEPE9999  RETURN
.
.---------------------------------------------------------------------------
. Check if an OP appointment can be checked in from the update pmi
. contacts details screen
.---------------------------------------------------------------------------
PMICHK00  PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6                     * Read OP booking
          BRANCH    OVRCD,PMICHK90
.
          MATCH     ADMISSNO,DOBAOUTN            * Corrent visit number
          GOTO      PMICHK90 IF NOT EQUAL
.
          MATCH     URNUMBER,OBAURNO             * Correct U/R
          GOTO      PMICHK90 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT                  * Status of booked
          GOTO      PMICHK90 IF NOT EQUAL
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1                      * Read PMI
          BRANCH    OVRCD,PMICHK90
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                      * Read PMI Extn 2
          BRANCH    OVRCD,PMICHK90
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1                      * Read session
          BRANCH    OVRCD,PMICHK90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1                     * Read slot template header
          BRANCH    OVRCD,PMICHK90
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,PMICHK15                * no Referral links
.
          MATCH     ADMISSNO,ALLNLNKV             * same Outpatient visit no?
          GOTO      PMICHK15 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT                  * Referral link cancelled ?
          GOTO      PMICHK15 IF EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,PMICHK15                * no linked Referral
.
          GOTO      PMICHK20
.
PMICHK15  CALL      CLALLREF                       * Clear referral file fields
.
PMICHK20  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,CHARTREV                  * No
          MATCH     ANSC,TCINDC8                   * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV                  * Yes
          ENDIF
.
          MOVE      ZERO,CONFRPMI
          IF        PTCNHDPS<>1
            MATCH     "1",OTHECPMI
            IF        @EQUAL
              IF        CHARTREV<>1
                MATCH     OBADATE,PTMADCDT
                IF        @LESS
                  MOVE      ONE,CONFRPMI
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
. Patient can be checked in so check in button will display
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    OBASTAT,"|",OTHECPAG,"|",CASEKEYS,"|":
                    OTHECENC,"|",CONFRPMI,"|",ALREVISN,"|":
                    "</RETURN_VALUE>"
          GOTO      PMICHK99
.
. Patient already check in so check in button will not display
.
PMICHK90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
.
PMICHK99  RETURN
.
.------------------------------------------------------------------------------------
. Outpatient Clinic Sched FHIR API Logical ID and _id Response - copied from CLISTB00
.------------------------------------------------------------------------------------
FHRSCH00  COMPARE   ONE,FHIRTYPE
          GOTO      FHRSCH99 IF NOT EQUAL
.
          MATCH     SP70,SESSKEYS
          GOTO      FHRSCH99 IF EQUAL
          GOTO      FHRSCH99 IF EOS
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,FHRSCH99
.
          MATCH     WBSESIT,OSESITE
          GOTO      FHRSCH99 IF NOT EQUAL
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,FHRSCH99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,FHRSCH99
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,FHRSCH99
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      FHRSCH99 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      FHRSCH99 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      FHRSCH99 IF LESS
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          MOVE      SP70,DISPSUSC
          MATCH     "1",OTCNDSUS
          IF        @EQUAL
            CALL      CHKSUS00
            IF        EXIT=ONE
              MOVE      "1",DISPSUSC
            ENDIF
          ELSE
            CALL      CHKSUS00
            BRANCH    EXIT,FHRSCH99
          ENDIF
.
          CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,FHRSCH99
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,FHRSCH99
.
            MATCH     OSESITE,OCASITE
            GOTO      FHRSCH99 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      FHRSCH99 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
.
.          WRITE     HTMLFILE;"INSERT JSON HERE";          
.
          MOVE     SP70,DIM25
          MOVE     SESSKEYS,DIM25
          REP      " -",DIM25
.
          MOVE     "true",DIM5
          IF       OMASTAT=ONE
            MOVE     "false",DIM5
          ENDIF
.
          WRITE    HTMLFILE;*+,"{ #"resourceType#": #"ScheduleR4#",":
                   " #"id#": #"CLINIC-",DIM25,"#",":
                   " #"identifier#": [ { #"value#": #"",DIM25,"#" } ],":
                   " #"active#": ",DIM5,",":
                   " #"extension#": [":
                   " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                   " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
.
.         Extension Clinic Type code/description replaces servicetype?
.         ------------------------------------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-code#"":
                        " ,#"valueString#":#"",OCTCTYP,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-description#"":
                        " ,#"valueString#":#"",OCTDESC,"#"},":
.
.         Extension Clinic ID/description 
.         --------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid#"":
                        " ,#"valueString#":#"",OCACLIN,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid-description#"":
                        " ,#"valueString#":#"",OCADESC,"#"},";
.
.         Extension Category CG replaces servicecategory?
.         -----------------------------------------------
.
          MATCH    SP70,OCTGRP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-clinictype-groupcode#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSG,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OCTGRP,"#" ";
.
            PACK      KEY5,ANSC,ANSG,OCTGRP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension Category CT 
.         ---------------------
.
          MATCH    SP70,OTHELTYP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-dxc-hc-locationtype#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OTHELTYP,"#" ";
.
            PACK      KEY5,ANSC,ANST,OTHELTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-sesskeys#"":
                   " ,#"valueString#":#"",SESSKEYS,"#"}";
.
          MOVE     OEMPTY,DIM6
          SQUEEZE  DIM6
.  
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-empty-slots#"":
                   " ,#"value#": ",DIM6,"}";
.
          MOVE     OSEBNEW,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-new-slots#"":
                   " ,#"value#": ",DIM3,"}";
.
          MOVE     OSEBRV,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-review-slots#"":
                   " ,#"value#": ",DIM3,"}";

          MOVE     OSEBSPC,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-special-slots#"":
                   " ,#"value#": ",DIM3,"}";
.
          WRITE    HTMLFILE;" ]";
.
          MATCH    SP70,DRTYPE
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"           ,#"specialty#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSD,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",DRTYPE,"#" ";
.
            PACK      KEY5,ANSD,ANST,DRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
.
          ENDIF
.
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            PACK      KEY6,OCADOCT,SP70
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              STRIP     DOCFNAME
              WRITE     HTMLFILE;*+,"  ,#"actor#":  [ {":
                        "  #"reference#" : #"Practitioner/HCP-",OCADOCT,"#",":
                        "  #"display#" : #"",DOCFNAME,"#" ":
                        " } ] ";
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM20
          MOVE      SP70,DIM20A
          MATCH     SP70,OSEDATE
          IF        !@EQUAL 
.
            PACK      DIM20,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OMASTART:
                      COLON,ZERO,ZERO,ANSZ,SP70
            PACK      DIM20A,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OMAEND:
                      COLON,ZERO,ZERO,ANSZ,SP70
.
            WRITE     HTMLFILE;*+,"  ,#"planningHorizon#":  {":
                      "  #"start#" : #"",DIM20,"#",":
                      "  #"end#" : #"",DIM20A,"#" ":
                      " } ";

.
          ENDIF
.
          MATCH     SP70,OMACOM1 
          IF        !@EQUAL
            MATCH     SP70,OMACOM2
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,",#"comment#" : #"",OMACOM1," ",OMACOM2,"#"";
            ELSE
              WRITE     HTMLFILE;*+,",#"comment#" : #"",OMACOM1,"#"";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;*+,"  }";
.
FHRSCH99  RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Sched FHIR API List Response 
.------------------------------------------------------------------------------------
RESSCH00  MOVE     SP70,DIM25
          MOVE     SESSKEYS,DIM25
          REP      " -",DIM25
          REP      "+-",DIM25
.
          MOVE     "true",DIM5
          IF       OMASTAT=ONE
            MOVE     "false",DIM5
          ENDIF
.
          IF       FHIRRECN>ZERO
            WRITE     HTMLFILE;",";
          ENDIF
.
          ADD      ONE,FHIRRECN   
.
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/ScheduleR4/CLINIC-",DIM25,"#", ":
                    " #"resource#" : ";
.
          WRITE    HTMLFILE;*+,"{ #"resourceType#": #"ScheduleR4#",":
                   " #"id#": #"CLINIC-",DIM25,"#",":
                   " #"identifier#": [ { #"value#": #"",DIM25,"#" } ],":
                   " #"active#": ",DIM5,",":
                   " #"extension#": [":
                   " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                   " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
.
.         Extension Clinic Type code/description replaces servicetype?
.         ------------------------------------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-code#"":
                        " ,#"valueString#":#"",OCTCTYP,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-description#"":
                        " ,#"valueString#":#"",OCTDESC,"#"},":
.
.         Extension Clinic ID/description
.         --------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid#"":
                        " ,#"valueString#":#"",OCACLIN,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid-description#"":
                        " ,#"valueString#":#"",OCADESC,"#"},";
.
.         Extension Category CG replaces servicecategory?
.         -----------------------------------------------
.
          MATCH    SP70,OCTGRP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-clinictype-groupcode#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSG,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OCTGRP,"#" ";
.
            PACK      KEY5,ANSC,ANSG,OCTGRP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension Category CT
.         ---------------------
.
          MATCH    SP70,OTHELTYP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-dxc-hc-locationtype#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OTHELTYP,"#" ";
.
            PACK      KEY5,ANSC,ANST,OTHELTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-sesskeys#"":
                   " ,#"valueString#":#"",SESSKEYS,"#"}";
.
          MOVE     OEMPTY,DIM6
          SQUEEZE  DIM6
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-empty-slots#"":
                   " ,#"value#": ",DIM6,"}";
.
          MOVE     OSEBNEW,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-new-slots#"":
                   " ,#"value#": ",DIM3,"}";
.
          MOVE     OSEBRV,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-review-slots#"":
                   " ,#"value#": ",DIM3,"}";

          MOVE     OSEBSPC,DIM3
          SQUEEZE  DIM3
.
          WRITE    HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-special-slots#"":
                   " ,#"value#": ",DIM3,"}";
.
          WRITE    HTMLFILE;" ]";
.
          MATCH    SP70,DRTYPE
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"           ,#"specialty#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSD,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",DRTYPE,"#" ";
.
            PACK      KEY5,ANSD,ANST,DRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
.
          ENDIF
.
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            PACK      KEY6,OCADOCT,SP70
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              STRIP     DOCFNAME
              WRITE     HTMLFILE;*+,"  ,#"actor#":  [ {":
                        "  #"reference#" : #"Practitioner/HCP-",OCADOCT,"#",":
                        "  #"display#" : #"",DOCFNAME,"#" ":
                        " } ] ";
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM20
          MOVE      SP70,DIM20A
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
.
            PACK      DIM20,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OMASTART:
                      COLON,ZERO,ZERO,ANSZ,SP70
            PACK      DIM20A,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OMAEND:
                      COLON,ZERO,ZERO,ANSZ,SP70
.
            WRITE     HTMLFILE;*+,"  ,#"planningHorizon#":  {":
                      "  #"start#" : #"",DIM20,"#",":
                      "  #"end#" : #"",DIM20A,"#" ":
                      " } ";

.
          ENDIF
.
          MATCH     SP70,OMACOM1
          IF        !@EQUAL
            MATCH     SP70,OMACOM2
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,",#"comment#" : #"",OMACOM1," ",OMACOM2,"#"";
            ELSE
              WRITE     HTMLFILE;*+,",#"comment#" : #"",OMACOM1,"#"";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;*+,"  }";
.
          WRITE    HTMLFILE;*+,"}"
.
RESSCH99  RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Slot FHIR API Logical ID and _id Response
.------------------------------------------------------------------------------------
RESSLO00  COMPARE   ONE,FHIRTYPE
          GOTO      RESSLO99 IF NOT EQUAL
.
          MATCH     SP70,CASEKEYS
          GOTO      RESSLO99 IF EQUAL
          GOTO      RESSLO99 IF EOS
.
          MOVE      CASEKEYS,SESSKEYS
.
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RESSLO99
.
          MATCH     WBSESIT,OSESITE
          GOTO      RESSLO99 IF NOT EQUAL
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RESSLO99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RESSLO99
.
          IF        IBCNMHOS=1
            MATCH     "1",OTCNHSEC
            IF        @EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,RESSLO99
              ENDIF
            ELSE
              MATCH     SP70,WBSEHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,OTHEHOSP            * Users hospital must
                GOTO      RESSLO99 IF NOT EQUAL        * match
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      RESSLO99 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      RESSLO99 IF LESS
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
.          MOVE      SP70,DISPSUSC
.          MATCH     "1",OTCNDSUS
.          IF        @EQUAL
.            CALL      CHKSUS00
.            IF        EXIT=ONE
.              MOVE      "1",DISPSUSC
.            ENDIF
.          ELSE
.            CALL      CHKSUS00
.            BRANCH    EXIT,RESSLO99
.          ENDIF
.
.          CALL      CHKAPP00          * Check slot visit type and status
.          BRANCH    EXIT,RESSLO99
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,RESSLO99
.
            MATCH     OSESITE,OCASITE
            GOTO      RESSLO99 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      RESSLO99 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,OCADOCT
          IF        !@EQUAL
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      OCADOCT,DOCTCODE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,RESSLO99
.
.
          MOVE     SP70,DIM28
          MOVE     CASEKEYS,DIM28
          REP      " -",DIM28
          REP      "+-",DIM28
.
.          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/SlotR4/SLOT-",DIM28,"#", ":
.                    " #"resource#" : ";
.
           WRITE    HTMLFILE;*+,"{ #"resourceType#": #"SlotR4#",":
                    " #"id#": #"SLOT-",DIM28,"#",":
                    " #"identifier#": [ { #"value#": #"",DIM28,"#" } ],":
                   " #"extension#": [":
                   " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                   " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
.
.         Extension Clinic Type code/description replaces servicetype?
.         ------------------------------------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-code#"":
                        " ,#"valueString#":#"",OCTCTYP,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-description#"":
                        " ,#"valueString#":#"",OCTDESC,"#"},":
.
.         Extension Clinic ID/description
.         --------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid#"":
                        " ,#"valueString#":#"",OCACLIN,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid-description#"":
                        " ,#"valueString#":#"",OCADESC,"#"},";
.
.         Extension Category CG replaces servicecategory?
.         -----------------------------------------------
.
          MATCH    SP70,OCTGRP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-clinictype-groupcode#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSG,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OCTGRP,"#" ";
.
            PACK      KEY5,ANSC,ANSG,OCTGRP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension Category CV replaces appointmentType?
.         -----------------------------------------------
.
          MATCH    SP70,OBAVISIT
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-visittype#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSV,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OBAVISIT,"#" ";
.
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension slotstatus replaces status because of custom values?
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slotstatus#"":
                   " ,#"value#": ",OBASTAT,"},";
.
          MOVE     FHIRSLS1,FHIRSLST
          LOAD     FHIRSLST,OBASTAT,FHIRSLS2,FHIRSLS3,FHIRSLS4,FHIRSLS5,FHIRSLS6:
                                    FHIRSLS7,FHIRSLS8,FHIRSLS9
.
          STRIP    FHIRSLST
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slotstatdesc#"":
                   " ,#"value#": #"",FHIRSLST,"#"},";

.
.         Extension Patient UR Number
.         ----------------------------------------------------------------
.
          MATCH    SP70,OBAURNO
          IF       !@EQUAL
.
            MATCH    "       0",OBAURNO
            IF       !@EQUAL
.
              MOVE     OBAURNO,DIM8
              REP      " -",DIM8
.
              WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-patientreference#",":
                       "  #"valueReference#" : #"Patient/",DIM8,"#"},";
            ENDIF

            MATCH    SP70,DOBAOUTN
            IF       !@EQUAL
.
              MATCH    "       0",DOBAOUTN
              IF       !@EQUAL
.
                PACK     DIM16,DIM8,DOBAOUTN,SP70
                REP      " -",DIM16
.
                WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-encounterreference#",":
                         "  #"valueReference#" : #"Encounter/",DIM16,"#"},";
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
.         Extension Case Keys
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-casekeys#"":
                   " ,#"valueString#":#"",CASEKEYS,"#"},";
.
.         Extension Slot Time
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slottime#"":
                   " ,#"valueTime#":#"",OBATIME,":00#"}";
.
          WRITE    HTMLFILE;" ]";
.
          MATCH    SP70,DRTYPE
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"           ,#"specialty#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSD,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",DRTYPE,"#" ";
.
            PACK      KEY5,ANSD,ANST,DRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
.
          ENDIF
.
          MOVE      SP70,DIM20
          MATCH     SP70,OBADATE
          IF        !@EQUAL
.
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
.
            PACK      DIM20,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OBASTRT:
                      COLON,ZERO,ZERO,ANSZ,SP70
.
            WRITE     HTMLFILE;*+," , #"start#" : #"",DIM20,"#"";

.
          ENDIF
.
.         SlotR4 status
.         ------------------
.         
          MATCH    SP70,DOBASTAT
          IF       !@EQUAL & !@EOS
.
            MOVE     FHIRSTS1,FHIRSTST
            LOAD     FHIRSTST,OBASTAT,FHIRSTS0,FHIRSTS2,FHIRSTS2,FHIRSTS0,FHIRSTS2:
                                      FHIRSTS4,FHIRSTS2,FHIRSTS2
.
            STRIP    FHIRSTST
.
            WRITE     HTMLFILE;*+," , #"status#" : #"",FHIRSTST,"#"";
.
          ENDIF
.

.
          MATCH   SP70,SESSKEYS
          IF      !@EQUAL
            WRITE     HTMLFILE;*+,"  ,#"schedule#":  [ {":
                      "  #"reference#" : #"ScheduleR4/CLINIC-",SESSKEYS,"#"":
                      " } ] ";
          ENDIF
.




.
          WRITE     HTMLFILE;*+,"  }";
.
.          WRITE    HTMLFILE;*+,"}"
.
.          WRITE     HTMLFILE;"HELLO FROM OUTWEB02 RESSLO00! CASEKEYS: ",CASEKEYS;
.
RESSLO99  RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Slot FHIR API List
.------------------------------------------------------------------------------------
RESSLF00  COMPARE   ONE,FHIRTYPE
          GOTO      RESSLF99 IF NOT EQUAL
.
          MATCH     SP70,CASEKEYS
          GOTO      RESSLF99 IF EQUAL
          GOTO      RESSLF99 IF EOS
.
.          MOVE      CASEKEYS,SESSKEYS
.
.
          MOVE     SP70,DIM28
          MOVE     CASEKEYS,DIM28
          REP      " -",DIM28
          REP      "+-",DIM28
.
          IF       FHIRRCN2>ZERO
            WRITE     HTMLFILE;",";
          ENDIF
.
          ADD      ONE,FHIRRCN2
.
           WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/SlotR4/SLOT-",DIM28,"#", ":
                     " #"resource#" : ";
.
           WRITE    HTMLFILE;*+,"{ #"resourceType#": #"SlotR4#",":
                    " #"id#": #"SLOT-",DIM28,"#",":
                    " #"identifier#": [ { #"value#": #"",DIM28,"#" } ],":
                   " #"extension#": [":
                   " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                   " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
.
.         Extension Clinic Type code/description replaces servicetype?
.         ------------------------------------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-code#"":
                        " ,#"valueString#":#"",OCTCTYP,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinictype-description#"":
                        " ,#"valueString#":#"",OCTDESC,"#"},":
.
.         Extension Clinic ID/description
.         --------------------------------
.
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid#"":
                        " ,#"valueString#":#"",OCACLIN,"#"},":
                   " { #"url#":#"%BASEURL/extension/dxc-hc-clinicid-description#"":
                        " ,#"valueString#":#"",OCADESC,"#"},";
.
.         Extension Category CG replaces servicecategory?
.         -----------------------------------------------
.
          MATCH    SP70,OCTGRP
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-clinictype-groupcode#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSG,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OCTGRP,"#" ";
.
            PACK      KEY5,ANSC,ANSG,OCTGRP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension Category CV replaces appointmentType?
.         -----------------------------------------------
.
          MATCH    SP70,OBAVISIT
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       {  #"url#" : #"%BASEURL/extension/dxc-hc-visittype#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSC,ANSV,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OBAVISIT,"#" ";
.
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        },";
.
          ENDIF
.
.         Extension slotstatus replaces status because of custom values?
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slotstatus#"":
                   " ,#"value#": ",OBASTAT,"},";
.
          MOVE     FHIRSLS1,FHIRSLST
          LOAD     FHIRSLST,OBASTAT,FHIRSLS2,FHIRSLS3,FHIRSLS4,FHIRSLS5,FHIRSLS6:
                                    FHIRSLS7,FHIRSLS8,FHIRSLS9
.
          STRIP    FHIRSLST
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slotstatdesc#"":
                   " ,#"value#": #"",FHIRSLST,"#"},";
.
.         Extension Patient UR Number
.         ----------------------------------------------------------------
.
          MATCH    SP70,OBAURNO
          IF       !@EQUAL
.
            MATCH    "       0",OBAURNO
            IF       !@EQUAL
.
              MOVE     OBAURNO,DIM8
              REP      " -",DIM8
.
              WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-patientreference#",":
                       "  #"valueReference#" : #"Patient/",DIM8,"#"},";
            ENDIF

            MATCH    SP70,DOBAOUTN
            IF       !@EQUAL
.
              MATCH    "       0",DOBAOUTN
              IF       !@EQUAL
.
                PACK     DIM16,DIM8,DOBAOUTN,SP70
                REP      " -",DIM16
.
                WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-encounterreference#",":
                         "  #"valueReference#" : #"Encounter/",DIM16,"#"},";
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
.         Extension Case Keys
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-casekeys#"":
                   " ,#"valueString#":#"",CASEKEYS,"#"},";
.
.         Extension Slot Time
.         ----------------------------------------------------------------
.
          WRITE    HTMLFILE;" { #"url#":#"%BASEURL/extension/dxc-hc-slottime#"":
                   " ,#"valueTime#":#"",OBATIME,":00#"}";
.
          WRITE    HTMLFILE;" ]";
.
          MATCH    SP70,DRTYPE
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"           ,#"specialty#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-",ANSD,ANST,"#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",DRTYPE,"#" ";
.
            PACK      KEY5,ANSD,ANST,DRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
.
          ENDIF
.
          MOVE      SP70,DIM20
          MATCH     SP70,OBADATE
          IF        !@EQUAL
.
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
.
            PACK      DIM20,CCENT,CYEAR,DASHFHIR,CMON,DASHFHIR,CDAY,ANST,OBASTRT:
                      COLON,ZERO,ZERO,ANSZ,SP70
.
            WRITE     HTMLFILE;*+," , #"start#" : #"",DIM20,"#"";

.
          ENDIF
.
.         SlotR4 status
.         ------------------
.
          MATCH    SP70,DOBASTAT
          IF       !@EQUAL & !@EOS
.
            MOVE     FHIRSTS1,FHIRSTST
            LOAD     FHIRSTST,OBASTAT,FHIRSTS0,FHIRSTS2,FHIRSTS2,FHIRSTS0,FHIRSTS2:
                                      FHIRSTS4,FHIRSTS2,FHIRSTS2
.
            STRIP    FHIRSTST
.
            WRITE     HTMLFILE;*+," , #"status#" : #"",FHIRSTST,"#"";
.
          ENDIF
.
          
.
          MATCH   SP70,SESSKEYS
          IF      !@EQUAL
            MOVE      SESSKEYS,DIM25
            REP       " -",DIM25

            WRITE     HTMLFILE;*+,"  ,#"schedule#":  [ {":
                      "  #"reference#" : #"ScheduleR4/CLINIC-",DIM25,"#"":
                      " } ] ";
          ENDIF
.




.
          WRITE     HTMLFILE;*+,"  }";
.
          WRITE    HTMLFILE;*+,"}"
.
.          WRITE     HTMLFILE;"HELLO FROM OUTWEB02 RESSLF00! CASEKEYS: ",CASEKEYS;
.
RESSLF99  RETURN
+
.------------------------------------------------------------
. FHIR Exit Sucess
.   Return Location Header
.------------------------------------------------------------
FHREXT00  IF        FHIRTYPE<>1
            CALL      WINCLS00
            GOTO      FHREXT99 
          ENDIF
.
          PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,FHREXT99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                             "  #"id#": #"allok#", ":
                             "  #"text#": { ":
                             "    #"status#": #"additional#", ":
                             "    #"div#": #"<div>All Ok</div>#" ":
                             "  }, ":
                             "  #"issue#": [ ":
                             "    { ":
                             "      #"severity#": #"information#", ":
                             "      #"code#": #"informational#", ":
                             "      #"details#": { ":
                             "        #"text#": #"All Ok#"":
                             "  } } ] }"
.
          CALL      CLOSHTML
FHREXT99  RETURN
+
.------------------------------------------------------------------------------
          INC       OUT002
.
          INC       ATWLLINK
          INC       AUDOTBOA
          INC       AUDOTBOB
          INC       CLACCAUD                    * Clear ACC Audit file variables
          INC       CLMRTMAS
          INC       CLVISINT
          INC       CLVISIAU
          INC       CLWATOPA
          INC       CLWATTR1
          INC       CLWATTX1
          INC       SLTCOUNT
          INC       HICCLAIM
          INC       PATIPERH
          INC       ROUNDUP5
          INC       OUTDANTM 
          INC       OUTARTTM
          INC       POSTCHRG
          INC       BARCODEF       * Bar Code Labels format routine
          INC       BARCODEL       * Bar Code Labels print routine
.
          INC       ACCAUDIO/INC
          INC       ACCDIAIO/INC   * AE Diagnosis
          INC       ALLQUEIO/INC
          INC       BOKRX1IO/INC
          INC       IBAALVIO/INC
          INC       IBAPOLIO/INC
          INC       EMRICDIO/INC   * AE Diagnosis Codes
          INC       EMRVISIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       OUTARTIO/INC       * Requested Appointments
          INC       OUTBOAIO/INC       * Bookings file A
          INC       OUTBB1IO/INC       * Bookings file B
          INC       OUTBOCIO/INC       * Bookings file C
          INC       OUTDCOIO/INC       * OP direct comments
          INC       OUTDANIO/INC       * OP direct actions
          INC       OUTXSCIO/INC       * Extension File
          INC       OUTXWPIO/INC       * Extension File Comments
          INC       OUTCLIIO/INC       * Clinic Ids
          INC       OUTCANIO/INC       * Clinic Types
          INC       OUTCCTIO/INC        * Contract Codes
          INC       OUTCTYIO/INC       * Clinic Types
          INC       OUTDCHIO/INC        * Default charge types
          INC       OUTDIAIO/INC       * Clinic Types
          INC       OUTDTRIO/INC       * DTR
          INC       OUTLPCIO/INC        * Clinic Types
          INC       OUTMA1IO/INC       * Session Master file
          INC       OUTMABIO/INC       * Session Master file
          INC       OUTRCMIO/INC
          INC       OUTSESIO/INC       * Clinic Open Sessions file
          INC       OUTSITIO/INC       * Site file
          INC       OUTPREIO/INC       * Outpatient Pre-attendance file
          INC       OUTPRCIO/INC        * Outpatient procedures and problems
          INC       VISCMTIO/INC       * Cancellation Comments file    *I-48413
          INC       OUTRF1IO/INC       * Referral List
          INC       OUTHISIO/INC
          INC       OUTRAPIO/INC
          INC       OUTRSHIO/INC
          INC       OUTWMPIO/INC       * Template Mapping
          INC       OUTMSPIO/INC        * Session Master file
          INC       OUTTXSIO/INC       * Outpatients Extra Templates file
          INC       OUTSIPIO/INC       * Outpat Site Specific Categories file
          INC       OUTUSEIO/INC       * Clinic Usage
.
          INC       NHIMASTM
          INC       NHIDCDIO/INC
          INC       NHIDMCIO/INC
          INC       NHIDNRIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NHIMCCIO/INC
          INC       NHIRELIO/INC
          INC       TMPALIIO/INC
          INC       PATINVIO/INC
.
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       IBAPOSIO/INC
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       PATALRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCFAIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATIN1IO/INC
          INC       PATIPEIO/INC
          INC       PATNIDIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCLIO/INC
          INC       PMSQPTIO/INC
          INC       SCRMASIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATNIPIO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       RESLNKIO/INC
          INC       MLTSITIO/INC
          INC       MRTMASIO/INC
          INC       MRTVISIO/INC
          INC       PMSPX2IO/INC            *** HPS Code Starts Here ***
          INC       IBALPCIO/INC        
          INC       IBALPCCD
          INC       PMSCDNDS
          INC       PMSCDNIO/INC
          INC       VISINTIO/INC       
          INC       PMSVX1IO/INC       
          INC       PMSCURIO/INC       
          INC       VISIAUIO/INC      
          INC       OUTCMNIO/INC     
          INC       OUTCPBIO/INC
          INC       OUTCPCIO/INC
          INC       OUTSRVIO/INC            *** HPS Code Ends Here ***
          INC       OUTCVTIO/INC
          INC       EOCLNKIO/INC
          INC       PATECDIO/INC
          INC       PMSCEXIO/INC
          INC       PATWC1IO/INC
          INC       PATWVEIO/INC
          INC       PATWMAIO/INC
          INC       PMSWX1IO/INC
          INC       PMSMTIIO/INC
          INC       OUTLKBIO/INC            * Outpat Linked bookings table
          INC       OUTBOXIO/INC 
          INC       OUTBITIO/INC  
          INC       OUTTHIIO/INC            * Outpatient Telehealth Info
.
          INC       CCIEX7IO/INC
.
          INC       BRHLCOMN
          INC       COUNTSLT
          INC       MRTVISCD
          INC       DGCLICOA                * DG O/P Confirm Appoint.  *I-90203
          INC       DGCLICOB                * DG O/P Change Booking Details
          INC       DGCLICOC                * DG O/P Cancel Appoint.   *I-90203
          INC       DGCLICOD                * DG O/P DNA DidNot Attend *I-90203
          INC       DGCLICOG                * DG O/P Discharge
          INC       DGCLICOH                * DG O/P Cancel Discharge
          INC       DGCLICON                * DG O/P New Appointment   *I-90203
          INC       DGCLICOR                * DG O/P Re-sched Appoint. *I-90203
          INC       DGCLICOU                * DG O/P Unattend an O/P Booking
          INC       DGCLICUP
          INC       DGCLII13
.
          INC       EXPPAYCD
          INC       PATDOCTM    * Template Fill-in for Doctors File
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PATMASTM    * Template Fill-in for Patient Master File
          INC       CLPMSPX2
          INC       CLPATVIS
          INC       CLPMSUPO
          INC       CLPMSUPG
          INC       CLPMSEXT
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       CLPATMAS
          INC       CLPATRE1
          INC       CLPMSVX1
          INC       CLOUTTHI
          INC       PMSVX1TM
          INC       PMSHPGTM
          INC       OUTBOATM      
          INC       OUTHEDTM
          INC       OUTRFLTM
          INC       CLOUTRFL
          INC       OUTSESTM
          INC       PATDOCCD    * Create Patient Name String
          INC       PATNAMCD    * Create Patient Name String
          INC       NAMSTRCD    * Create Name String
          INC       IBAWEBCD    * Standard WEB Functions
          INC       DAYOFWEK
          INC       WEBDATCD    
          INC       NZHISWIO
          INC       CALCAGE 
          INC       PATSNDX 
          INC       PATSNX2
          INC       PATGSRIO/INC
          INC       VALDIOPS
          INC       PATCANIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       OUTHEDIO/INC
          INC       OUTLETIO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLOUTCAN
          INC       CLOUTPRC
          INC       CLOUTRSH
          INC       CLPMSPAY
          INC       OUTTXSTM
          INC       OUTXSCTM
          INC       OUTPRCTM
          INC       CLOUTXSC
          INC       OUTSIPTM
          INC       PMIGTNID
          INC       CLALLREF
          INC       CLALLENC
          INC       CLOUTHED
          INC       CLPMSCEX
          INC       CLPMSWX1
          INC       CLOUTBB1
          INC       PATCLMTM
          INC       PMSCEXCD
          INC       PMSSMHCD
          INC       ALLREFTM
          INC       CLVISPAY
          INC       CLPMSMTI
          INC       COMDEPIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC      
          INC       WATMESIO/INC
          INC       PATHSPIO/INC
          INC       PATEORIO/INC
          INC       PMSCTCIO/INC
          INC       MRTLOCIO/INC
          INC       ALLDEPIO/INC
          INC       ALLREFIO/INC
          INC       ALLENCIO/INC
          INC       ALLGRPIO/INC
          INC       ALLRLNIO/INC
          INC       ALLRITIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLDIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLLNKIO/INC
          INC       ALLSTSIO/INC
          INC       MLTSECIO/INC
          INC       PRIITMIO/INC
          INC       PRITHDIO/INC
          INC       PRITDTIO/INC
          INC       PRIDOCIO/INC
          INC       PRIPRAIO/INC
          INC       PRIEXCIO/INC
          INC       PRIMGPIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSAIDIO/INC
          INC       PMSADWIO/INC
          INC       PMSCAUIO/INC
          INC       PMSEXTIO/INC
          INC       PMSPAYIO/INC
          INC       PMSSRRIO/INC
          INC       PMSSRMIO/INC
          INC       PMSSMHIO/INC
          INC       PMSTSPIO/INC
          INC       PMSUPGIO/INC
          INC       PMSUPOIO/INC
          INC       PMSHPGIO/INC
          INC       PMSHPOIO/INC
.          INC       PMSIPLIO/INC
          INC       HICCLMIO/INC
          INC       HICCITIO/INC
          INC       HICBCNIO/INC
          INC       VISPAYIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATONHIO/INC
          INC       TFILENAM
.          INC       PMSIPLCD
          INC       VINAHDEF
          INC       WRITBOOK
          INC       PRFAINSR           * Default PRFA based on claim code
.
          INC       CHKWCCLM           * Check multiple Workers Comp claims
.
          INC       PATFINIO/INC
.
          INC       COMPARIO/INC
          INC       CLCOMPAR
          INC       GTCMPA00
          INC       CLPATWC1           * Clear WC/ACC Claim Variables
          INC       GENANVIS
          INC       PMSEXTTM
