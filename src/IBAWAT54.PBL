.---------------------------------------------------------------------
. Program       : IBAWAT54
.
. Function      : Waiting List Patient Extract Print Letters Server
.
. Modifications : 
.
.---------------------------------------------------------------------
. V12.00.02  05/09/2025  Thanh T           TSK 0949457
.            Added LXPUSRAC-LXPUSRIL fields
.            Moved all LX fields to WATLETDF.PBL
. V12.00.01  20/05/2025 Thanh T            TSK 0955096
.            Changed for alphanumeric visit number
.---------------------------------------------------------------------
. V11.04.01  17/07/2024  Thanh T           TSK 0939648    
.            Added LXPXSN18 to LXPXSN30
. V11.03.01  15/08/2023  Don Nguyen       TSK 0935736
.            Recompiled for SMSPRXML - Skip inactive extra contacts for SMS
. V11.02.02  19/04/2022  Thanh T          TSK 0903453
.            Added LXPXUCC4, LXUCC4LD, LXPXATF1, LXPXUCC5, LXUCC5LD and
.            LXPXATF2 fields
. V11.02.01  09/02/2022  Thanh T       TSK 0905641
.            Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes
. V11.01.02  28/06/2021  Sunny            TSK 0893817
.            Added %systype - PTCNSTYP (LCSYSTYP/LXSYSTYP)
.            Changed FORM3 from DIM to FORM               
. V11.01.01  02/07/2021  Ebon Clements    TSK 0900650  
.            Recompiled for SMSPRXML      
. V11.00.05  16/07/2020  Tracey Nguyen    TSK 0893621
.            Added %smsusrnm (LCCSMSUN/LXXSMSUN)
. V11.00.04  15/04/2020  Thanh T          TSK 0879163
.            Changed SET0182 for Sex category changes
. V11.00.03  08/04/2020  Thanh T          TSK 0879163      
.            Changed SET0182 for Sex category changes     
. V11.00.02  20/03/2020  Peter Vela       TSK 0889143
.            Fixed OUTLET IO calls
. V11.00.01  19/03/2020  Peter Vela       TSK 0889143
.            Recompiled for WATLETFD
.---------------------------------------------------------------------
. V10.15.01  07/02/2020  Ebon Clements    TSK 0887235
.            Recompiled for PMSCEXCD - extra contact postal address
. V10.13.01  23/01/2018  Nicole Torrisi   TSK 0868849
.            Added LXPASLOC and LXPACLOC
. V10.12.01  07/05/2018  Richa Phogat     TSK 0852348
.            Added LXRELDES - Removal Reason Long Description(Cat WR)
. V10.11.01  30/10/2017  Peter Vela       TSK 0843931
.            Added to Waiting List Letter variables:
.            WL Suspension From Date               
.            WL Suspension To Date                
.            WL Suspension Reason Code Cat WN    
.            WL Suspension Reason Description Cat WN  
.            WL Consultant Address 1                 
.            WL Consultant Address 2                
.            WL Consultant Address 3               
.            WL Consultant Address 4              
.            WL Consultant Post Code             
.            WL Consultant State                
. V10.10.01  24/05/2017  Thanh T.          TSK 0825240
.            Added Days Not Ready for surgery for Patient and Clinical
.            fields
.---------------------------------------------------------------------
. V10.08.06  17/11/2016  Peter Vela        TSK 0828936
.            Added %wxidus %wtstay
. V10.08.05  20/09/2016  Ebon Clements     TSK 0823657
.            Fixed SMS letter type read test - PRTLST00
. V10.08.04  15/09/2016  Don Nguyen        TSK 0294154  
.            Modified PRTLST00 to call PRMSGH00 & PRMSGF00
.            14/09/2016  Ebon Clements     TSK 0294154  
.            Added CONTTYPS                          
. V10.08.03  16/08/2016  Peter Vela        TSK 319220
.            Increased PRTSTRNG to 80
.            Increased DISPSTRN to 80
.            04/08/2016  Don Nguyen        TSK 0294154
.            Recompiled for WATLETCD - Added PRIN9050 to skip line count check
. V10.08.02  25/07/2016  Don Nguyen        TSK 0294154
.            Added SMSPRXML - print XML metatags for SMS (PRIN0000).
.            Recompiled for changes to WATLETCD.
. V10.08.01  07/06/2016  Jill Parkinson    TSK 0820003
.            Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.07.02  09/03/2016  Ebon Clements     TSK 0294154
.            Added %smsid, %smscode, %smskey, %smsurno, %smsuser, 
.            %smsphone 
. V10.07.01  11/01/2016  Ebon Clements     TSK 0294154
.            Added option 5 send SMS for extract selection 
. V10.06.02  21/09/2015  Davin             CAR 313906
.            Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.01  02/06/2015  Peter Vela        CAR 308967
.            Changed LXWRDESC to length 80
. V10.05.01  06/10/2014  Ebon Clements     CAR 268970
.            Change to use OUTCLIFD index 1 instead of index 2
. V10.04.02  18/03/2014  Don Nguyen        CAR 291879
.            Added LXIHINUM. Recompiled for changes to WATLETCD
. V10.04.01  31/12/2013  Don Nguyen        CAR 294389
.            Recompiled for changes to WATLETFD & WATLETIO    
. V10.03.08  08/07/2013  Peter Vela        CAR 286022
.            Added UPPLOW conversion for PADD4
. V10.03.07  05/07/2013  Peter Vela        CAR 287964
.            Removed asterisk initialisation for %adda %addb %suburb %addd 
.            %pcode
. V10.03.06  05/07/2013  Peter Vela        CAR 286022
.            Removed call to CASE0000 for %fname %gname %addb
. V10.03.05  03/07/2013  Peter Vela        CAR 286022
.            Removed call to CASE0000 for %title %sname %adda %suburb %addd
. V10.03.04  18/04/2013  Ania P            CAR 281663
.            Recompile for changes to WATLETCD
. V10.03.03  30/01/2012  Peter Vela        CAR 257930
.            Added LXWTCHRC - Reason Code Urgency Update
.            Added LXWTCHRD - Reason Desc Urgency Update
.            Added LXWTCHOV - Original Value Urgency Update
. V10.03.02  30/01/2012  Davin             CAR 257512
.            Recompiled for changes to WATLETCD
. V10.03.01  09/11/2011  Ebon Clements     CAR 248529
.            Added multiple contacts of the same type functionality
. V10.02.06  25/10/2011  Ebon Clements     CAR 253354                     
.            Recompiled for changes to WATLETCD                             
. V10.02.05  21/09/2011  Davin             CAR 248749
.            Recompiled for changes to WATLETCD
. V10.02.04  15/09/2011  Ebon Clements     CAR 250738
.            Recompiled for changes to WATLETCD
. V10.02.03  08/08/2011  Peter McMullen    CAR 248749
.            Recompiled for changes to WATLETCD     
. V10.02.02  22/06/2011  Steve Armstrong   CAR 240722
.            Recompiled for changes to PMSCEXCD 
. V10.02.01  14/06/2011  Ebon Clements     CAR 239530
.            Added print extra contact functionality
.---------------------------------------------------------------------
. V10.00.01  29/06/2010  Peter McMullen   CAR 224562 
.            Add code to support %reresi tag         
.---------------------------------------------------------------------
.                 V9.09.04  18/10/2007  Steve Armstrong  CAR 149755
.                           Recompiled for changes to WATLETCD.
.                           Created new RGGP... & RGPR... variables
.                           instead of using LX... variables and extended
.                           the length of some of the RGGP... & RGPR...
.                           variables to 55.
.                 V9.09.03  15/08/2007  Peter Vela      CAR 143567
.                           Added Waiting List Consultant email
.                           address (patdo1af,pmshcpaf)
.                 V9.09.02  03/07/2007  Peter Vela      CAR 143555
.                           Added Reg GP Prac Email Address
.                 V9.09.01  01/08/2007  Peter Vela      CAR 143555
.                           Added Reg GP Phone Number
.                           Added Reg GP Prac Fax Number
.---------------------------------------------------------------------
.                 V9.07.01  30/08/2006  Peter Vela      CAR 117576
.                           Added patient date of birth
.                           Added local GP preferred method of contact
.---------------------------------------------------------------------
.                 V9.06.01  08/06/2006  Ramesh VK       CAR 86021
.                           Added patient sex %psex
.---------------------------------------------------------------------
.                 V9.05.01  31/03/2006 Peter Vela    CAR 86019
.                           Added procedure description (WMDESC.wattr1af)
.---------------------------------------------------------------------
.                 V9.04.11  15/11/2005 Peter Vela    CAR 83840
.                           Added Admit Ward, Admit Date, Admit Time
.                           (patmi1af)
.                 V9.04.10  05/10/2005 Mike Laming   CAR 52354
.                           Add WTWMCSST & WTWMCSDT - Recompiled for WATLETCD
.                           and WATLETDF 
.                 V9.04.09  19/08/2005 Peter Vela    CAR 69456
.                           Recompiled for WATLETCD and WATLETDF
.                 V9.04.08  09/08/2005 Peter Vela    CAR 67204     
.                           Recompiled for WATLETCD and WATLETDF    
.                 V9.04.07  27/07/2005 Peter Vela    CAR 68536
.                           Recompiled for WATLETCD and WATLETDF
.                 V9.04.06  20/07/2005 Peter Vela    CAR 63023
.                           Recompiled for WATLETCD and WATLETDF
.                 V9.04.05  27/06/2005 Peter Vela    CAR 62391
.                           Recompiled for WATLETCD and WATLETDF 
.                 V9.04.04  22/06/2005 Peter Vela    CAR 60667
.                           Fixed %wrprad, %wxprat, %wrprod, %wxprot variables
.                           22/06/2005 Peter Vela    CAR 59792
.                           Fixed %wxadmw variable
.                           22/06/2005 Peter Vela    CAR 45249
.                           Fixed %age variable
.                 V9.04.03  21/06/2005 Ebon Clements CAR 62391
.                           Recompiled for WATLETCD and WATLETDF for
.                           PAS and PAC clinics
.                 V9.04.02  02/05/2005  Peter Vela CAR 60667
.                           Recompiled for WATLETCD WATLETDF
.                 V9.04.01  07/04/2005  Peter Vela CAR 59792
.                           Recompiled for WATLETCD WATLETDF
.                 V9.03.02  24/12/2003  Peter Vela CAR 45149
.                           Recompiled for WATLETCD
.                 V9.03.01  15/12/2003  Peter Vela CAR 45249
.                           Recompiled for WATLETCD and WATLETDF
.                 V5.10.01  07/08/2002  Guomin Fu  SRF 14267
.                           Recompiled for WATLETCD 
.                 V5.09.00  19/07/2000  Pat Dirito
.                           Created Program
.----------------------------------------------------------------------
          INC       STD001FD    
          INC       WATLETDF
.
          INC       IBASEQFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC 
          INC       PATDO1FD/INC
          INC       BOKRX1FD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PMSCEXFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSOOSFD/INC
          INC       PATMI1FD/INC
          INC       PATWR1FD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC
          INC       PATHSPFD/INC
          INC       BOKRC1FD/INC
          INC       WATEPSFD/INC
          INC       WATTR1FD/INC
          INC       WATPROFD/INC
          INC       WATLHIFD/INC
          INC       WATVWLFD/INC
          INC       WATLETFD/INC
          INC       WATCONFD/INC
          INC       WATSUSFD/INC
          INC       WEBCONFD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       WATCHAFD/INC
          INC       WATTX1FD/INC
          INC       WEBERRFD/INC
          INC       WEBSECFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCLIFD/INC
          INC       OUTHEDFD/INC
          INC       OUTMA1FD/INC
          INC       OUTSESFD/INC
          INC       OUTSITFD/INC
          INC       MLTCODFD/INC
.
.  Local Variable Definitions
.
.
BJDAY     FORM      3
CATTC     INIT      "tc"
CJDAY     FORM      3
BOTTMARG  FORM      2
BOOKNO    DIM       8       
BTYPE     DIM       20
CATACTIV  FORM      1
CATEGORY  DIM       2
CFILEPRE  DIM       3
CHECKSIT  DIM       6
CODE      DIM       3
CONTTYPE  DIM       1
COUNTER   FORM      5
COUNT     FORM      2
DADATE    DIM       19        
DATELINE  DIM       19
WORKDEPT  DIM       3      
DESCCAT   DIM       20           * description for department (cata A)
DNABDATE  DIM       19      
DEXT      DIM       3
DOCTNAM   DIM       33   
DOCLINE   DIM       33
DUMMY     DIM       1
DIM8      DIM       8
DIM55     DIM       55
DIM70     DIM       70
DIM127    DIM       127
DIMAGE    DIM       3                * I CAR 45249
DISPSTRN  DIM       80
EADMDESC  DIM       20
EXTRCTID  DIM       4    * Extract ID
ELECATYP  DIM       3    
ENDSTR    FORM      2
FDATE     DIM       19    
FNAMER    DIM       8
FORM3     FORM      3 
FORM3A    DIM       3
FORM8     DIM       8 
FIRSTCH   FORM      1
FULLNAME  DIM       52      
GADATE    DIM       19 
HOUR      DIM       2      
TWOHUN24  FORM      "224"
HTMLFILE  FIFO      ASCII, FIXED=250
IBCNMHOS  FORM      1
IDDIM1    DIM       8
INITIAL   DIM       4
LDATE     DIM       19    
LEAVPSMS  FORM      1        * Don't send overdue leave SMS to patient
LEAVFSMS  DIM       20       * First SMS number of not sending to patient
LETTFORM  FORM      3
LETTER    DIM       3
LEFTMARG  FORM      2
LINE      DIM       55
LRDATE    DIM       19    
MTHNAM3   DIM       3
MINUTE    DIM       2a
MONTH     DIM       9
NAFDATE   DIM       19     
NAMELINE  DIM       52
NATDATE   DIM       19    
PACCOM    DIM       20
PERCPOS   FORM      2
PDESC     DIM       50
PDATE     DIM       19   
PTIME     DIM       8      
PHYSPAGE  FORM      3
PRTSTRNG  DIM       80
QUOTE     INIT      "#""
REFPRTY   DIM       20
REFUNIT   DIM       20
RESPSEX   DIM       6
RESPNAME  DIM       52
RESPADDA  DIM       25
RESPADDB  DIM       25
RESPSUBR  DIM       15
RESPPOST  DIM       4
RESPADDD  DIM       25
RFDADD1   DIM       30        
RFDADD2   DIM       30
RFDADD3   DIM       30
RFDADD4   DIM       30
RFDTITL   DIM       10
.
RFGPSNAM  DIM       20
RFGPGNAM  DIM       20
RFGPADD1  DIM       35
RFGPADD2  DIM       35
RFGPADD3  DIM       35
RFGPADD4  DIM       35
RFGPPOST  DIM       8
.
RGGPSNAM  DIM       35
RGGPGNAM  DIM       35
RGGPADD1  DIM       55
RGGPADD2  DIM       55
RGGPADD3  DIM       55
RGGPADD4  DIM       55
RGGPPOST  DIM       8
RGGPFAXN  DIM       20
RGGPSEML  DIM       80
RGGPMOBN  DIM       20
RGGPPAGR  DIM       20
RGGPPAGN  DIM       20
RGGPPRV1  DIM       10
RGGPSTEL  DIM       20
.
RGPRSURG  DIM       55            * Registered GP PRACTICE vars
RGPRSAD1  DIM       55
RGPRSAD2  DIM       55
RGPRSAD3  DIM       55
RGPRSAD4  DIM       55
RGPRSPCD  DIM       8
RGPRTELE  DIM       20
RGPRFAXN  DIM       20
RGPRPEML  DIM       55
.
RFPRSURG  DIM       25            * Referring GP PRACTICE vars
RFPRSAD1  DIM       35
RFPRSAD2  DIM       35
RFPRSAD3  DIM       35
RFPRSAD4  DIM       35
RFPRSPCD  DIM       8
RFPRTELE  DIM       20
.
SENDSMSO  FORM      1
SRCHVAR   DIM       15               * Last column of display
SRCHNUM   FORM      3
STARTSTR  FORM      2
TOPMARG   FORM      2
TEMPHOUR  FORM      3
TEMPHOUR2 FORM      2
TEMP2     FORM      2
TEMP3     FORM      3
TEMP55    DIM       55
TEMP70    DIM       70
TIMELINE  DIM       8
URDIM     DIM       8      
WLETPLEN  FORM      3
XTIME     DIM       8      
XXDATE    DIM       19       
TEMP1     FILE      ASCII,FIXED=399
.
LETRCOMM  DIM       1                  * Letter Communication Method
.                                         0 or Blank = Printed Letter
.                                         1 = SMS Notification
CONTPNMS  DIM       200                * Pipe-delimited list of phone numbers
CONTMSGI  DIM       200                * Pipe-delimited list of msg id's
CONTTYPS  DIM       200                * Pipe-delimited list of contact types
MAXCOUNT  INIT      "10"               * Max count for SMS phone numbers
.
.    Constants
.
CATAP     INIT      "ap"                                               *I-59792
CODEA     INIT      "A "          *          A  (patient classification)
CODECZ    INIT      "CZ"
CODECG    INIT      "CG"          *          CG (directorate)
CODERS    INIT      "RS"          *          RS (resident status)
CODET     INIT      "T "          * Catagory T                
CODETP    INIT      "TP"          * Catagory TP (priority)
CODEW1    INIT      "W1"          * Catagory W1
CODEW2    INIT      "W2"          * Catagory W2
CODEW3    INIT      "W3"          * Catagory W3
CODEW4    INIT      "W4"          * Catagory W4
CODEWS    INIT      "WS"          *          WS (short notice)
CODEWU    INIT      "WU"          * Catagory WU (clinic/unit)
CODEBK    INIT      "BK"
CODEBP    INIT      "BP"
CODEX5    INIT      "X5"
CODEX6    INIT      "X6"
CODEX7    INIT      "X7"
CODEX8    INIT      "X8"
CODES     INIT      "S "
CODEVI    INIT      "VI"
CODEWR    INIT      "WR"
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
NINETY4   FORM      "94"
.
STAR52    INIT      "****************************************************"
STAR50    INIT      "**************************************************"
TWOHUN28  FORM      "228"
VAR       DIM       127
.
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090"
.
.------------------------------------------------------------------------
PRGID     INIT      "IBAWAT54"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Waiting List Patient Extracts Letters"
.------------------------------------------------------------------------
MAIN0000  CALL      INIT0000       * Initialise 
          KEYIN     *P1:5,"Extract ID : ",EXTRCTID
          KEYIN     *P1:7,"Letter ID  : ",LETTER
.         KEYIN     *P1:7,"Letter ID  : ",LETTFORM
.
MAIN1100  CALL      PRTLST00      * Print Letters for Extract  
          GOTO      MAIN9000
.
MAIN9000  
.
MAIN9999  CHAIN     PGM
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      DISPHEAD
          OPEN      IBASEQA1,"ibaseqaf"
          OPEN      WATEPSA1,"watepsaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATVWLA1,"watvwlaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA2,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATHSPA1,"pathspaf"          
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      WATLETR1,"watletrf"
          OPEN      WATLETR2,"watletrf"
          OPEN      WATOPAA1,"watopaaf"
          OPEN      WATOPSA1,"watopsaf"
          OPEN      WATCHAA1,"watchaaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      OUTSITA1,"outsitaf"
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          OPEN      CONTROLF,"controlf"  * Open the control file
.
          READ      CONTROLF,THIRTY7;*122,WTCNTPUC,*185,WTCNTPDS,*211,WTCNWLSC:
                                     *213,WTCNULHI
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND28;*210,PTCNSTYP
.
          MATCH     "1",PTCNSMSN
          IF        @EQUAL
            OPEN      PMSOOSA1,"pmsoosaf"
          ENDIF
.
          IF        WTCNULHI = 1
            OPEN      WATLHIA1,"watlhiaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Waiting List Patient Extracts
.------------------------------------------------------------
PRTLST00  MOVE      LETTER,LETTFORM
          PACK      KEY6,LETTFORM,SP1,SP1,ZERO,SP70
          CALL      RDLET1
          BRANCH    OVRCD,PRTLST99
.
          MOVE      SP1,LETRCOMM
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      PRTLST05 IF NOT EQUAL
.
          MOVE      ZERO,SENDSMSO
          MOVE      WLETCOMM,LETRCOMM       * store our Communication Method
          MATCH     "1",LETRCOMM
          IF        @EQUAL
            MOVE      ONE,SENDSMSO      * Sending an SMS
            CALL      PRMSGH00          * print SMS Messages XML Header tag
          ENDIF
.
PRTLST05  PACK      KEY23,EXTRCTID,SP70 
          CALL      RSWTEPS1
PRTLST10  CALL      RKWTEPS1
          BRANCH    OVRCD,PRTLST90
. 
          MATCH     EXTRCTID,WTEPEID    * Check Extract ID
          GOTO      PRTLST90 IF NOT EQUAL
.
          MATCH     "1",WTEPDEL         * Check Deleted Flag
          GOTO      PRTLST10 IF EQUAL
.
          IF        SENDSMSO=1
            PACK      KEY8,WTEPURN,SP70
            CALL      RDPMOOS1              * Opt out of SMS
            COMPARE   ZERO,OVRCD
            GOTO      PRTLST10 IF EQUAL
          ENDIF
.
          MOVE      WTEPURN,KEY8        * Read PMI Details
          CALL      RDMAST1
          BRANCH    OVRCD,PRTLST90 
          CALL      RDPMPX21
.
          PACK      KEY19,WTEPURN,WTEPPRO,WTEPCNT,SP70  * Waiting List Details
          CALL      RDTREA1
          BRANCH    OVRCD,PRTLST90 
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,PRTLST90
.
          MOVE      WMBOOK,DIM8VISN  
          MOVE      DIM8VISN,KEY8
          CALL      RDBKREC1              * Read booking file
          IF        OVRCD=1
            MOVE      SP8,BKREPDAT        * Pre-assesment date
            MOVE      SP8,BKREPTIM        * Pre-assesment time
            MOVE      SP8,BKREATIM        * Expected assesment time
            MOVE      SP8,BKREEDAT        * Expected due date
          ENDIF
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDPTVIS1
          IF        OVRCD = 1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDPMVX11
          IF        OVRCD = 1
            CALL      CLPMSVX1 
          ENDIF
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDPTMIS1
          IF        OVRCD = 1
            CALL      CLPATMIS
          ENDIF
.
          CALL      SET0000               * Set up values for % var's
          CALL      WHIS0000              * Write to the history file
          CALL      PRIN0000              * Print Letters
.
          GOTO      PRTLST10              * Read next record.
.
PRTLST90  MATCH     "1",PTCNSMSN          * Using SMS Notifications?
          GOTO      PRTLST99 IF NOT EQUAL
.
          MATCH     "1",LETRCOMM
          IF        @EQUAL
            CALL      PRMSGF00            * print SMS Messages XML Footer tag
          ENDIF
.
PRTLST99  RETURN
+
.**********************************************************************
.*                              SET0000                               *
.*             SET up the values for all the "%" variables            *
.**********************************************************************
SET0000   *  The follwowing has been modifed for the web. There
.            is no need to read a temp here...  We can just set the 
.            relavent variables.
.
          MOVE      WMBOOK,BOOKNO    * Booking Number
          MOVE      WMURNO,URDIM     * U/R
.
          MOVE      "99",CDAY
          UNPACK    CDATE,CDAY,DUMMY,CMON,DUMMY,CCENT,CYEAR
          CALL      FDAT0000                    * format todays date
          MOVE      DATELINE,FDATE
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      FDOC0000                        * format doctors name
          MOVE      DOCLINE,DOCTNAM
.
          MOVE      SP70,LXWRWLCC
          MOVE      SP70,LXWTWLA1
          MOVE      SP70,LXWTWLA2
          MOVE      SP70,LXWTWLA3
          MOVE      SP70,LXWTWLA4
          MOVE      SP70,LXWTWLPT
          MOVE      SP70,LXWTWLST
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCHCPC,LXWRWLCC               * doctor code
            MOVE      PMHCSEML,LXWLCHEM
.
            MOVE      PMHCADR1,LXWTWLA1
            MOVE      PMHCADR2,LXWTWLA2
            MOVE      PMHCADR3,LXWTWLA3
            MOVE      PMHCADR4,LXWTWLA4
            MOVE      PMHCPOST,LXWTWLPT
            MOVE      PMHCSTAT,LXWTWLST
          ENDIF
.
          PACK      KEY6,WMDOCTOR,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      PTDOSEML,LXWLCDEM
          ENDIF
.
          MOVE      SP70,LXWRWLCP
          PACK      KEY9,WMDOCTOR,WMUNIT,SP70
          CALL      RDWTVWL1
          IF        OVRCD=0
            MOVE      WTVWTELE,LXWRWLCP               * Consultant Surgery Tel
          ENDIF
.
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format expected due date
          MOVE      DATELINE,XXDATE
.
          CALL      FNAM0000                    * format patients name
          MOVE      NAMELINE,FULLNAME
.
          MOVE      "99",HOUR
          UNPACK    BKREATIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format expected due time
          MOVE      TIMELINE,XTIME
.
          MOVE      "99",CDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format date on list
          MOVE      DATELINE,LDATE
.
          MOVE      "99",CDAY
          UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format pre-assessment date
          MOVE      DATELINE,PDATE
.
          MOVE      "99",HOUR
          UNPACK    BKREPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format pre-assessment time
          MOVE      TIMELINE,PTIME
.
          MOVE      "99",CDAY
          UNPACK    WMDATE2,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format last review date
          MOVE      DATELINE,LRDATE
.
          MOVE      WMPCAT,WORKDEPT             * Department
.
          MOVE      "99",CDAY
          UNPACK    WTWMDTAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                        * Decision to admit date
          MOVE      DATELINE,DADATE
.
          MOVE      "99",CDAY
          UNPACK    WTWMGADD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                      * Guareented admission date
          MOVE      DATELINE,GADATE
.
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                       * Do not admit before date
          MOVE      DATELINE,DNABDATE
.
          MOVE      SP70,NAFDATE          * Contained nothing in IBAWAT30?
          MOVE      SP70,NATDATE          * Contained nothing in IBAWAT30?
          MOVE      WTWMEATY,ELECATYP     * Elective Admission Type "CC"      
.            
. get referred doctor's address
.
          MOVE      SP30,RFDTITL
          MOVE      SP30,RFDADD1
          MOVE      SP30,RFDADD2
          MOVE      SP30,RFDADD3
          MOVE      SP30,RFDADD4
.
          MATCH     ZEROVISN,BKREBOOK
          IF        !@EQUAL 
            MATCH     SP6,BKRESDOC
            IF        !@EQUAL
              MOVE      BKRESDOC,KEY6
              CALL      RDDOCT1
              IF        OVRCD=1       
                MOVE      SP30,RFDADD1
                MOVE      SP30,RFDADD2
              ELSE 
                MOVE      DTITL,RFDTITL     * Refer Doctors Title 
                MOVE      DSADD1,RFDADD1    * Reffered Doctors Address
                MOVE      DSADD2,RFDADD2    * Reffered Doctors Address
                MOVE      DSADD3,RFDADD3    * Reffered Doctors Address
                MOVE      DSADD4,RFDADD4    * Reffered Doctors Address
              ENDIF
            ENDIF
          ENDIF
.
. *********** From here on the code is identical to IBAWAT30 ****************
.
          CALL      CLRV0000                             * initialise var's
.          DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
.
.------ read files to get values of other % variables ------
.------ not already formatted -------
.
          ADD       ONE,COUNTER
          MOVE      SP3,BKREWARD
          MOVE      BOOKNO,DIM8VISN
          MOVE      DIM8VISN,KEY8
          CALL      RDBKREC1
          IF        OVRCD = 1
            CALL    CLBOKREC
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
            IF        OVRCD = 1
              CALL      CLBKRX00
            ENDIF
          ENDIF
.
          CALL      SHSP0000             * set up hospital details
          CALL      RCLI0000             * Set referring clinician fields
.
          PACK      KEY5,CODEBK,BKRETYPE * booking type
          CALL      RDCODE1
          BRANCH    OVRCD,SET0010
          MOVE      TDESC,BTYPE
.
SET0010   PACK      KEY5,CODEBP,BKREACCM * preferred accomadation
          CALL      RDCODE1
          BRANCH    OVRCD,SET0015
          MOVE      TDESC,PACCOM
.
SET0015   MOVE      WMCODE,KEY9
          CALL      RDPROA1
          BRANCH    OVRCD,SET0020
          MOVE      WPDESC,PDESC
.
SET0020   PACK      KEY5,CODEWU,WMUNIT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0021
          MOVE      TDESC,REFUNIT
.
SET0021   PACK      KEY5,CODETP,WMPTY
          CALL      RDCODE1
          BRANCH    OVRCD,SET0022
          MOVE      TDESC,REFPRTY
.
SET0022   MATCH     SP3,WORKDEPT
          GOTO      SET0025 IF EQUAL
          PACK      KEY5,CODEA,WORKDEPT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0025
          MOVE      TDESC,DESCCAT
.
SET0025   MOVE      URDIM,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "9",CONTTYPE          * OTH Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXOCNAME     * Other Contact Details
            MOVE      PMCETITL,LXOCTITL
            MOVE      PMCESNAM,LXOCSNAM
            MOVE      PMCEGNAM,LXOCGNAM
            MOVE      PMCEGNM2,LXOCGNM2
            MOVE      PMCEADD1,LXOCADD1
            MOVE      PMCEADD2,LXOCADD2
            MOVE      PMCEADD3,LXOCADD3
            MOVE      PMCEADD4,LXOCADD4
            MOVE      PMCEPOST,LXOCPOST
            MOVE      PMCETELP,LXOCTELP
            MOVE      PMCETELB,LXOCTELB
            MOVE      PMCETELM,LXOCTELM
            MOVE      PMCERELP,LXOCRELP
            MOVE      PMCEEMAI,LXOCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXOCSLET
            ELSE
              MOVE     DNO,LXOCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * NOK2 Contact
            CALL      NOK20000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXP2NAME     * NOK2 Contact Details
            MOVE      PMCETITL,LXP2TITL
            MOVE      PMCESNAM,LXP2SNAM
            MOVE      PMCEGNAM,LXP2GNAM
            MOVE      PMCEGNM2,LXP2GNM2
            MOVE      PMCEADD1,LXP2ADD1
            MOVE      PMCEADD2,LXP2ADD2
            MOVE      PMCEADD3,LXP2ADD3
            MOVE      PMCEADD4,LXP2ADD4
            MOVE      PMCEPOST,LXP2POST
            MOVE      PMCETELP,LXP2TELP
            MOVE      PMCETELB,LXP2TELB
            MOVE      PMCETELM,LXP2TELM
            MOVE      PMCERELP,LXP2RELP
            MOVE      PMCEEMAI,LXP2EMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP2SLET
            ELSE
              MOVE     DNO,LXP2SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "C",CONTTYPE          * CAR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPCNAME     * Carer Contact Details
            MOVE      PMCETITL,LXPCTITL
            MOVE      PMCESNAM,LXPCSNAM
            MOVE      PMCEGNAM,LXPCGNAM
            MOVE      PMCEGNM2,LXPCGNM2
            MOVE      PMCEADD1,LXPCADD1
            MOVE      PMCEADD2,LXPCADD2
            MOVE      PMCEADD3,LXPCADD3
            MOVE      PMCEADD4,LXPCADD4
            MOVE      PMCEPOST,LXPCPOST
            MOVE      PMCETELP,LXPCTELP
            MOVE      PMCETELB,LXPCTELB
            MOVE      PMCETELM,LXPCTELM
            MOVE      PMCERELP,LXPCRELP
            MOVE      PMCEEMAI,LXPCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPCSLET
            ELSE
              MOVE     DNO,LXPCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * EMR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXECNAME     * Emergency Contact Details
            MOVE      PMCETITL,LXECTITL
            MOVE      PMCESNAM,LXECSNAM
            MOVE      PMCEGNAM,LXECGNAM
            MOVE      PMCEGNM2,LXECGNM2
            MOVE      PMCEADD1,LXECADD1
            MOVE      PMCEADD2,LXECADD2
            MOVE      PMCEADD3,LXECADD3
            MOVE      PMCEADD4,LXECADD4
            MOVE      PMCEPOST,LXECPOST
            MOVE      PMCETELP,LXECTELP
            MOVE      PMCETELB,LXECTELB
            MOVE      PMCETELM,LXECTELM
            MOVE      PMCERELP,LXECRELP
            MOVE      PMCEEMAI,LXECEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXECSLET
            ELSE
              MOVE     DNO,LXECSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "7",CONTTYPE          * Local Address Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPLNAME     * Local Address Contact Details
            MOVE      PMCETITL,LXPLTITL
            MOVE      PMCESNAM,LXPLSNAM
            MOVE      PMCEGNAM,LXPLGNAM
            MOVE      PMCEGNM2,LXPLGNM2
            MOVE      PMCEADD1,LXPLADD1
            MOVE      PMCEADD2,LXPLADD2
            MOVE      PMCEADD3,LXPLADD3
            MOVE      PMCEADD4,LXPLADD4
            MOVE      PMCEPOST,LXPLPOST
            MOVE      PMCETELP,LXPLTELP
            MOVE      PMCETELB,LXPLTELB
            MOVE      PMCETELM,LXPLTELM
            MOVE      PMCERELP,LXPLRELP
            MOVE      PMCEEMAI,LXPLEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPLSLET
            ELSE
              MOVE     DNO,LXPLSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Preferred Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPRNAME     * Preferred Contact Details
            MOVE      PMCETITL,LXPRTITL
            MOVE      PMCESNAM,LXPRSNAM
            MOVE      PMCEGNAM,LXPRGNAM
            MOVE      PMCEGNM2,LXPRGNM2
            MOVE      PMCEADD1,LXPRADD1
            MOVE      PMCEADD2,LXPRADD2
            MOVE      PMCEADD3,LXPRADD3
            MOVE      PMCEADD4,LXPRADD4
            MOVE      PMCEPOST,LXPRPOST
            MOVE      PMCETELP,LXPRTELP
            MOVE      PMCETELB,LXPRTELB
            MOVE      PMCETELM,LXPRTELM
            MOVE      PMCERELP,LXPRRELP
            MOVE      PMCEEMAI,LXPREMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPRSLET
            ELSE
              MOVE     DNO,LXPRSLET
            ENDIF
          ENDIF
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,PNKNAME      * NEXT OF KIN 1 NAME
            MOVE      PMCETITL,LXP1TITL     * title
            MOVE      PMCESNAM,LXP1SNAM     * surname
            MOVE      PMCEGNAM,LXP1GNAM     * given name 1
            MOVE      PMCEGNM2,LXP1GNM2     * given name 2
            MOVE      PMCEADD1,PNKADD1      * N.O.K 1 ADDRESS LINE 1
            MOVE      PMCEADD2,PNKADD2      * N.O.K 1 ADDRESS LINE 2
            MOVE      PMCEADD3,PNKSUBR      * N.O.K 1 ADDRESS LINE 3
            MOVE      PMCEADD4,PNKADD4      * N.O.K 1 ADDRESS LINE 4
            MOVE      PMCEPOST,PNKPOST      * N.O.K 1 POSTCODE
            MOVE      PMCETELP,PNKTELP      * N.O.K 1 PRIVATE TELEPHONE
            MOVE      PMCETELP,LXP1TELP
            MOVE      PMCETELB,PNKTELB      * N.O.K 1 BUSINESS TELEPHONE
            MOVE      PMCETELB,LXP1TELB
            MOVE      PMCETELM,PMPXKMOB     * N.O.K 1 MOBILE
            MOVE      PMCETELM,LXP1TELM
            MOVE      PMCERELP,PNKRELP      * N.O.K 1 RELATIONSHIP
            MOVE      PMCERELP,LXP1RELP
            MOVE      PMCEEMAI,PMPXKEML     * N.O.K 1 EMAIL
            MOVE      PMCEEMAI,LXP1EMAI
            MOVE      PMCESLET,PMPXKCRP     * N.O.K 1 Send Letter
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP1SLET
            ELSE
              MOVE     DNO,LXP1SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPONAME     * Postal Address Formatted Name
            MOVE      PMCETITL,LXPOTITL     * title
            MOVE      PMCESNAM,LXPOSNAM     * surname
            MOVE      PMCEGNAM,LXPOGNAM     * given name 1
            MOVE      PMCEGNM2,LXPOGNM2     * given name 2
            MOVE      PMCEADD1,PTMXADD1     * POSTAL ADDRESS LINE 1
            MOVE      PMCEADD2,PTMXADD2     * POSTAL ADDRESS LINE 2
            MOVE      PMCEADD3,PTMXADD3     * POSTAL ADDRESS LINE 3
            MOVE      PMCEADD4,PTMXADD4     * POSTAL ADDRESS LINE 4
            MOVE      PMCEPOST,PTMXPOST     * POSTAL POSTCODE
            MOVE      PMCETELP,LXPOTELP
            MOVE      PMCETELB,LXPOTELB
            MOVE      PMCETELM,LXPOTELM
            MOVE      PMCERELP,LXPORELP
            MOVE      PMCEEMAI,LXPOEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPOSLET
            ELSE
              MOVE     DNO,LXPOSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXMSNA     * MOTHER SURNAME
            MOVE      PMCEGNAM,PMPXMGNA     * MOTHER GIVEN NAME
            MOVE      PMCETITL,PMPXMTLE     * MOTHER TITLE
            MOVE      PMCEADD1,PMPXMAD1     * MOTHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXMAD2     * MOTHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXMAD3     * MOTHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXMAD4     * MOTHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXMPOS     * MOTHER POSTCODE
            MOVE      PMCETELP,PMPXMPNO     * MOTHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXMBNO     * MOTHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXMMNO     * MOTHER MOBILE
            MOVE      PMCEEMAI,PMPXMEML     * MOTHER EMAIL
            MOVE      PMCECONT,PMPXMCNT     * MOTHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXMCRP     * MOTHER SEND LETTER
            MOVE      SP70,PMPXMLAB         * MOTHER NAME OF LABEL
            MOVE      PMCERELP,PMPXMREL     * MOTHER RELATIONSHIP
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXFSNA     * FATHER SURNAME
            MOVE      PMCEGNAM,PMPXFGNA     * FATHER GIVEN NAME
            MOVE      PMCETITL,PMPXFTLE     * FATHER TITLE
            MOVE      PMCEADD1,PMPXFAD1     * FATHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXFAD2     * FATHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXFAD3     * FATHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXFAD4     * FATHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXFPOS     * FATHER POSTCODE
            MOVE      PMCETELP,PMPXFPNO     * FATHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXFBNO     * FATHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXFMNO     * FATHER MOBILE
            MOVE      PMCEEMAI,PMPXFEML     * FATHER EMAIL
            MOVE      PMCECONT,PMPXFCNT     * FATHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXFCRP     * FATHER SEND LETTER
            MOVE      SP70,PMPXFLAB         * FATHER NAME OF LABEL
            MOVE      PMCERELP,PMPXFREL     * FATHER RELATIONSHIP
          ENDIF
.
          PACK      RESPNAME,PNKNAME,SP20,SP20,SP20
          MATCH     SP70,RESPNAME
          GOTO      SET0040 IF EQUAL
          MOVE      PNKADD1,RESPADDA
          MOVE      PNKADD2,RESPADDB
          MOVE      PNKADD4,RESPADDD
          MOVE      PNKSUBR,RESPSUBR
          MOVE      PNKPOST,RESPPOST
          GOTO      SET0050
.
SET0040   MOVE      FULLNAME,RESPNAME
          MOVE      PADD1,RESPADDA
          MOVE      PADD2,RESPADDB
          MOVE      PPOST,RESPPOST
          MOVE      PSUBRB,RESPSUBR
          MOVE      PADD4,RESPADDD
.
SET0050   CALL      CLGP0000             * Clear Gp details
          PACK      KEY10,PMPXRHC1,SP20
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0060
          MOVE      PMHCSNAM,RGGPSNAM
          MOVE      PMHCGNAM,RGGPGNAM
          MOVE      PMHCADR1,RGGPADD1
          MOVE      PMHCADR2,RGGPADD2
          MOVE      PMHCADR3,RGGPADD3
          MOVE      PMHCADR4,RGGPADD4
          MOVE      PMHCPOST,RGGPPOST
          MOVE      PMHCFAXN,RGGPFAXN
          MOVE      PMHCSEML,RGGPSEML
          MOVE      PMHCMOBN,RGGPMOBN
          MOVE      PMHCPAGR,RGGPPAGR
          MOVE      PMHCPAGN,RGGPPAGN
          MOVE      PMHCPRV1,RGGPPRV1
          MOVE      PMHCSTEL,RGGPSTEL
.
          PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,LXWRLDFN
.                                                                      *I-52354
          MATCH     "Y",WTWMCSST
          IF        @EQUAL
            MOVE     DYES,LXWRCSST
          ELSE
            MOVE     DNO,LXWRCSST
          ENDIF
.
          MOVE      SP70,LXWRCSDT
          MOVE      "99",CDAY
          UNPACK    WTWMCSDT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRCSDT
.
SET0060   PACK      KEY10,WTWMRFGP,SP20
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0063
          MOVE      PMHCSNAM,RFGPSNAM
          MOVE      PMHCGNAM,RFGPGNAM
          MOVE      PMHCADR1,RFGPADD1
          MOVE      PMHCADR2,RFGPADD2
          MOVE      PMHCADR3,RFGPADD3
          MOVE      PMHCADR4,RFGPADD4
          MOVE      PMHCPOST,RFGPPOST
.
. get the Registered GP Practice address
.
SET0063   PACK      PMHGPRAC,PMPXRH1G,SP20
          PACK      KEY12,PMHGPRAC,PMPXR1GC
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0065
          MOVE      PMHGPNAM,RGPRSURG
          MOVE      PMHGADD1,RGPRSAD1
          MOVE      PMHGADD2,RGPRSAD2
          MOVE      PMHGADD3,RGPRSAD3
          MOVE      PMHGADD4,RGPRSAD4
          MOVE      PMHGPOST,RGPRSPCD
          MOVE      PMHGPTEL,RGPRTELE
          MOVE      PMHGPFAX,RGPRFAXN
          MOVE      PMHGPEML,RGPRPEML
.
. get the Referring GP Practice address
.
SET0065   PACK      PMHGPRAC,WTWMGPPC,SP20
          PACK      KEY12,PMHGPRAC,WTWMGPPT
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0070
          MOVE      PMHGPNAM,RFPRSURG
          MOVE      PMHGADD1,RFPRSAD1
          MOVE      PMHGADD2,RFPRSAD2
          MOVE      PMHGADD3,RFPRSAD3
          MOVE      PMHGADD4,RFPRSAD4
          MOVE      PMHGPOST,RFPRSPCD
          MOVE      PMHGPTEL,RFPRTELE
.
SET0070   MOVE      SP20,TDESC
          MATCH     SP3,ELECATYP
          PACK      KEY5,ANSC,ANSC,ELECATYP
          CALL      RDCODE1
          MOVE      TDESC,EADMDESC
.
SET0071   MATCH     "                         ",RESPADDA
          GOTO      SET0072 IF NOT EQUAL
          MOVE      "*************************",RESPADDA
.
SET0072   MATCH     "                              ",RFDADD1
          GOTO      SET0073 IF NOT EQUAL
          MOVE      "******************************",RFDADD1
.
SET0073   MATCH     "                              ",RFDADD2
          GOTO      SET0074 IF NOT EQUAL
          MOVE      "******************************",RFDADD2
.
SET0074   MATCH     "      ",RESPSEX
          GOTO      SET0075 IF NOT EQUAL
          MOVE      "******",RESPSEX
.
SET0075   MATCH     "                         ",RESPADDB
          GOTO      SET0080 IF NOT EQUAL
          MOVE      "*************************",RESPADDB
.
SET0080   MATCH     "               ",RESPSUBR
          GOTO      SET0085 IF NOT EQUAL
          MOVE      "***************",RESPSUBR
.
SET0085   MATCH     "    ",RESPPOST
          GOTO      SET0090 IF NOT EQUAL
          MOVE      "****",RESPPOST
.
SET0090   
.         MATCH     "                         ",PADD1
.         GOTO      SET0140 IF NOT EQUAL
.         MOVE      "*************************",PADD1
.
SET0140   
.         MATCH     "                         ",PADD4
.         GOTO      SET0141 IF NOT EQUAL
.         MOVE      "*************************",PADD4
.
SET0141   
.         MATCH     "                         ",PSUBRB
.         GOTO      SET0144 IF NOT EQUAL
.         MOVE      "*************************",PSUBRB
.
SET0144   
.         MATCH     "                         ",PADD2
.         GOTO      SET0146 IF NOT EQUAL
.         MOVE      "*************************",PADD2

.
SET0146   MATCH     "                         ",PGNAME
          GOTO      SET0148 IF NOT EQUAL
          MOVE      "*************************",PGNAME
.
SET0148   MATCH     "                    ",PSNAME
          GOTO      SET0150 IF NOT EQUAL
          MOVE      "********************",PSNAME
.
SET0150   
.         MATCH     "    ",PPOST
.         GOTO      SET0155 IF NOT EQUAL
.         MOVE      "****",PPOST
.
SET0155   MATCH     "            ",PTELEP
          GOTO      SET0160 IF NOT EQUAL
          MOVE      "************",PTELEP
.
SET0160   MATCH     "                    ",BTYPE
          GOTO      SET0164 IF NOT EQUAL
          MOVE      "********************",BTYPE
.
SET0164   MATCH     "                    ",PACCOM
          GOTO      SET0166 IF NOT EQUAL
          MOVE      "********************",PACCOM
.
SET0166   MATCH     SP70,PDESC
          GOTO      SET0170 IF NOT EQUAL
          MOVE      STAR50,PDESC
.
SET0170   MATCH     "                    ",REFUNIT
          GOTO      SET0175 IF NOT EQUAL
          MOVE      "********************",REFUNIT
.
SET0175   MATCH     "                    ",REFPRTY
          GOTO      SET0180 IF NOT EQUAL
          MOVE      "********************",REFPRTY
.
SET0180   
.         MATCH     "               ",PSUBRB
.         GOTO      SET0181 IF NOT EQUAL
.         MOVE      "***************",PSUBRB
.
SET0181   MATCH     "    ",PTITL
          GOTO      SET0182 IF NOT EQUAL
          MOVE      "****",PTITL
.
SET0182   MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00
          MOVE      DSEXASC1,RESPSEX
          GOTO      SET0190
.
SET0190   CALL      IBACLOCK
          PACK      AGEDATE,CC,YY,MM,DD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          MOVE      PSAGEYRS,DIMAGE
.
.------ move all the form totals to dims and ------
.------ compress any multiple blanks ------
.
SET8000   MOVE      BOOKNO,IDDIM1
.
          MATCH     SP3,WMUDEF5
          IF        !@EQUAL
            PACK      KEY5,CODEX5,WMUDEF5
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF5
              MOVE      LXUDEF5,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF5
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF6
          IF        !@EQUAL
            PACK      KEY5,CODEX6,WMUDEF6
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF6
              MOVE      LXUDEF6,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF6
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF7
          IF        !@EQUAL
            PACK      KEY5,CODEX7,WMUDEF7
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF7
              MOVE      LXUDEF7,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF7
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF8
          IF        !@EQUAL
            PACK      KEY5,CODEX8,WMUDEF8
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF8
              MOVE      LXUDEF8,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF8
            ENDIF
          ENDIF
.
          MOVE      SP70,LXREMCOD
          MOVE      SP70,LXREMDES
          MOVE      SP70,LXRELDES
          MATCH     SP3,WMREMOVE
          IF        !@EQUAL
            PACK      LXREMCOD,WMREMOVE,SP70
            PACK      KEY5,CODEWR,WMREMOVE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXREMDES
              MOVE      LXREMDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXREMDES
              MOVE      PTCDLDES,LXRELDES
              MOVE      LXRELDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXRELDES
            ENDIF
          ENDIF
.
          MOVE      WTWMRANK,LXPRANK
          MOVE      WMREASON,LXWRWLDI
.

         MATCH     SP70,BKRERESI
          IF        !@EQUAL
            PACK      KEY5,CODET,BKRERESI,SP70   * Resident
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRERESI
            ENDIF
          ELSE
            MATCH     SP70,PTYPE
            IF        !@EQUAL
              PACK      KEY5,CODET,PTYPE,SP70   * Resident
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE      TDESC,LXRERESI
              ENDIF
            ENDIF
          ENDIF

.
.------  move all names, addresses etc to LINE and convert to lower case ------
.
          MOVE      PSEX,LINE
          CALL      CASE0000
          MOVE      LINE,PSEX
.
          MOVE      BTYPE,LINE
          CALL      CASE0000
          MOVE      LINE,BTYPE
          MOVE      PACCOM,LINE
          CALL      CASE0000
          MOVE      LINE,PACCOM
          MOVE      PDESC,LINE
          CALL      CASE0000
          MOVE      LINE,PDESC
          MOVE      REFUNIT,LINE
          CALL      CASE0000
          MOVE      LINE,REFUNIT
          MOVE      REFPRTY,LINE
          CALL      CASE0000
          MOVE      LINE,REFPRTY
.
.         MOVE      PADD1,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD1
.
.         MOVE      PADD2,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD2
.
.         MOVE      PSUBRB,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSUBRB
.
.         MOVE      PADD4,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD4
.
          REP       UPPLOW,PADD4
.
.         MOVE      PTITL,LINE
.         CALL      CASE0000
.         MOVE      LINE,PTITL
          MOVE      RESPNAME,LINE
          CALL      CASE0000
          MOVE      LINE,RESPNAME
.         MOVE      PGNAME,LINE
.         CALL      CASE0000
.         MOVE      LINE,PGNAME
.         MOVE      PSNAME,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSNAME
          MOVE      PTMASNAM,LXPTLSNM            * Patient Long Surname
          MOVE      LXPTLSNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXPTLSNM
          MOVE      RESPSEX,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSEX
          MOVE      RESPADDA,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDA
          MOVE      RESPADDB,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDB
          MOVE      RESPSUBR,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSUBR
.         MOVE      PSUBRB,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSUBRB
          MOVE      EADMDESC,LINE
          CALL      CASE0000
          MOVE      LINE,EADMDESC

          MOVE      PTHSNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSNAME
.
          MOVE      PTHSADD1,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD1
.
          MOVE      PTHSADD2,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD2
.
          MOVE      PTHSADD3,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD3
.
          MOVE      PTHSADD4,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD4
.
          MOVE      RGPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSURG
          MOVE      RGPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD1
          MOVE      RGPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD2
          MOVE      RGPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD3
          MOVE      RGPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD4
          MOVE      RGPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRTELE
.
          MOVE      RFPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSURG
          MOVE      RFPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD1
          MOVE      RFPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD2
          MOVE      RFPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD3
          MOVE      RFPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD4
          MOVE      RFPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRTELE
.
          MOVE      PTMXCELL,LINE              * load cellular phone number
          CALL      CASE0000
          MOVE      LINE,LXCELL
          MOVE      PTMXADD1,LINE              * load postal address line 1
          CALL      CASE0000
          MOVE      LINE,LXPADDA
          MOVE      PTMXADD2,LINE              * load postal address line 2
          CALL      CASE0000
          MOVE      LINE,LXPADDB
          MOVE      PTMXADD3,LINE              * load postal address line 3
          CALL      CASE0000
          MOVE      LINE,LXPADDC
          MOVE      PTMXADD4,LINE              * load postal address line 4
          CALL      CASE0000
          MOVE      LINE,LXPADDD
          MOVE      PTMXPOST,LINE              * load postal Post Code
          CALL      CASE0000
          MOVE      LINE,LXPPOST
.
          MOVE      SP70,LXWRPRED
          MOVE      "99",CDAY                            
          UNPACK    WTWMREAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRED
.
          MOVE      SP70,LXWXPRET
          MOVE      "99",HOUR
          UNPACK    WTTXPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRET
.
          MOVE      SP70,LXWXADMW
          MATCH     SP70,WTTXADMW
          IF        !@EQUAL
            PACK      KEY5,CATAP,WTTXADMW,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWXADMW
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWRPAND
          MOVE      "99",CDAY
          UNPACK    WTWMTRPA,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPAND
.
          MOVE      SP70,LXWXPANT
          MOVE      "99",HOUR
          UNPACK    WTTXPANT,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPANT
.
          MOVE      SP70,LXWRPRAD
          MOVE      "99",CDAY
          UNPACK    WMDATE3,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRAD
.
          MOVE      SP70,LXWXPRAT
          MOVE      "99",HOUR
          UNPACK    WTTXPATM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRAT
.
          MOVE      SP70,LXWRPROD
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPROD
.
          MOVE      SP70,LXWXPROT
          MOVE      "99",HOUR
          UNPACK    WTTXPOTM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPROT
.
          CALL      PACC0000
          CALL      PACLOC00
.         
          CALL      PASC0000
          CALL      PASLOC00
.
          MOVE      SP70,LXPMIXWD
          PACK      KEY6,PTMIXWRD,SP70
          CALL      RDAWARD1
          CALL      RDKWARD1
          IF        OVRCD = 0
            MATCH     PTMIXWRD,WWARD
            IF        @EQUAL
              MOVE      WBDESC,LXPMIXWD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXPMIATM
          MOVE      "99",HOUR
          UNPACK    ATIME,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXPMIATM
.
          MOVE      SP70,LXPMIADT
          MOVE      "99",CDAY
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIADT
.
          MOVE      SP70,LXWRDESC
          MATCH     SP70,WMDESC
          IF        !@EQUAL|!@EOS
            MOVE      WMDESC,LXWRDESC
          ENDIF
.
          MATCH     SP70,BKRXADWD
          IF        !@EQUAL
            MOVE      "ap",TCODE
            PACK      KEY5,TCODE,BKRXADWD,SP70  * Admitting Ward
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRXADWD
            ENDIF
          ENDIF
.
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                 * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREEDAT
.
          MOVE      BKREATIM,LXREATIM         * Booking Time
.
          MOVE      SP70,LXVXAPWD
          MATCH     SP70,PMVXAPWD
          IF        !@EQUAL
            PACK      KEY5,CATAP,PMVXAPWD,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXVXAPWD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXPMIDOB
          MOVE      "99",CDAY
          MOVE      PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIDOB
.
          MOVE      SP70,LXWRLPCC
          MOVE      PMHCPRFC,LXWRLPCC
.
          MOVE      SP70,LXWRLDPC
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRLDPC
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWRSRCR
          MATCH     SP70,WTWMSRCR
          IF        !@EQUAL
            PACK      KEY5,CODES,WTWMSRCR,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRSRCR
              MOVE      LXWRSRCR,LINE
              CALL      CASE0000
              MOVE      LINE,LXWRSRCR
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWTCHOV
          MOVE      SP70,LXWTCHRD
          MOVE      SP70,LXWTCHRC
.
          PACK      KEY35,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTCHA1
SET8710   CALL      RPWTCHA1
          BRANCH    OVRCD,SET8720
.
          MATCH     WMURNO,WTCHURNO
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     WMCODE,WTCHPROC
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     DWMCNT,WTCHPCNT
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     "02",WTCHUPTY
          GOTO      SET8710 IF NOT EQUAL
.
          MOVE      WTCHOVAL,LXWTCHOV
          MOVE      WTCHREAS,LXWTCHRC
.
          MATCH     SP70,WTCHREAS
          GOTO      SET8720 IF EQUAL
.
          PACK      KEY5,ANSW,ANSD,WTCHREAS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SET8720
.
          MOVE      TDESC,LXWTCHRD
.
SET8720   MOVE      SP70,LXWTSUFT
          MOVE      SP70,LXWTSUTT
          MOVE      SP70,LXWTSURC
          MOVE      SP70,LXWTSURD
.
          PACK      KEY21,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTSUS1
          CALL      RPWTSUS1
          BRANCH    OVRCD,SET9000
.
          MATCH     WMURNO,WTSUURNO
          GOTO      SET9000 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      SET9000 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      SET9000 IF NOT EQUAL
.
.         MATCH     SP70,WTSUFDAT
.         IF        !@EQUAL
.           UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      NAFDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.         ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
.           UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      NATDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CALL      IBACLOCK
            PACK      DIM8,CC,YY,MM,DD
            REP       " 0",DIM8
.
            MATCH     DIM8,WTSUTDAT
            GOTO      SET8730 IF NOT LESS
.
          ELSE
.
SET8730     MATCH       SP70,WTSUFDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUFDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUFT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MATCH       SP70,WTSUTDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUTDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUTT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MOVE        WTSUREAS,LXWTSURC
.
            MATCH       SP70,WTSUREAS
            IF          !@EQUAL & !@EOS
              PACK        KEY5,ANSW,ANSN,WTSUREAS,SP70
              CALL        RDCODE1
              IF          OVRCD=0
                MOVE        TDESC,LXWTSURD
              ENDIF
            ENDIF
.
          ENDIF
.
SET9000   CALL      GSMSID00                 * Get SMS message id
          MOVE      IBSQNEXT,LXXSMSID        * SMS message id
.
          PACK      LXXSMSKY,SP1,NINE,WMURNO,WMCODE,WMCNT,SP70  * SMS key 
          MOVE      LETTER,LXSMSCOD          * SMS Code (Letter Number)
          MOVE      PTMXCELL,LXXSMSPH        * SMS Phone Number
          MOVE      PURNO,LXXSMSUR           * SMS U/R
          MOVE      SP70,LXXSMSUS            * SMS User
          MOVE      SP70,LXXSMSUN            * SMS User Name
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD<>1
           MATCH      PASSCODE,WBSEPCD
           IF         @EQUAL
             MOVE      WBSEUID,LXXSMSUS      * SMS User
             MOVE      WBSENAM,LXXSMSUN      * SMS User Name
           ENDIF
          ENDIF
.
          MOVE      SP70,LXWXIDUS
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,CODEVI,WTTXINTD           * Intended stay duration
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXWXIDUS
            ENDIF
          ENDIF
.
          MOVE      WMSTAY,LXWTSTAY
.
SET9999   RETURN
.**********************************************************************
.*                           FDAT0000                                 *
.*                  routine to Format the DATe                        *
.**********************************************************************
FDAT0000  CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT2000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT2000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                               DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                                MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          BUMP      CDAY
.
.------ pack the formatted date ------
.
FDAT1000  PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT2000  MOVE      "                  ",DATELINE
.         MOVE      "99th December 1999",DATELINE
          GOTO      FDAT9999
.
FDAT9999  RETURN
.**********************************************************************
.*                              FDOC0000                              *
.*                   routine to Format DOCtor's name                  *
.**********************************************************************
FDOC0000  CLEAR     DOCLINE
          CALL      RDPMHCP1                        * read doctor file
          BRANCH    OVRCD,FDOC7000
          CLEAR     INITIAL
          APPEND    SP1,INITIAL
          MOVE      PMHCGNAM,ANS
          APPEND    ANS,INITIAL
          APPEND    ". ",INITIAL
          RESET     INITIAL
          PACK      DOCLINE,PMHCTITL,INITIAL,PMHCSNAM   * pack formatted doctors
          MOVE      DOCLINE,LINE                   *   name
          CALL      COMP0000                       * compress blanks
          CALL      CASE0000                       * convert to lower case
          MOVE      LINE,DOCLINE
          GOTO      FDOC9999
.
.------ doctors name does not exist ------
.
FDOC7000  MOVE      "*********************************",DOCLINE
          GOTO      FDOC9999
.
FDOC9999  RETURN
.**********************************************************************
.*                              COMP0000                              *
.*            routine to COMPress excessive blanks in LINE            *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL   * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                   * compress multiple blanks
          GOTO      COMP8000 IF EOS         *   from in-between words
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
.**********************************************************************
.*                             CASE0000                               *
.*  routine to convert all except first character of each word to     *
.*        lower CASE                                                  *
.**********************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL       * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW              * test to see if char is a letter
          GOTO      CASE1100 IF EQUAL
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                * any char but a letter found
.
CASE1100  RESET     UPPLOW
          OR        040,LINE                * actual conversion to lower case
.
CASE2000  MOVE      ZERO,FIRSTCH            * not on first char. any more
.
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS     * move to next character
          RESET     LINE                    * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH             * first character was a space
          GOTO      CASE3000
.
CASE9999  RETURN
.**********************************************************************
.*                           FNAM0000                                 *
.*                routine to Format patient's NAMe                    *
.**********************************************************************
FNAM0000  CLEAR     NAMELINE
          RESET     PTITL
          MATCH     SP4,PTITL               * test title for spaces
          GOTO      FNAM2000 IF EQUAL
.
FNAM0500  CMATCH    SP1,PTITL
          GOTO      FNAM1000 IF EQUAL
          MOVE      PTITL,ANS               * append title to nameline
          APPEND    ANS,NAMELINE
          BUMP      PTITL
          GOTO      FNAM1000 IF EOS
          GOTO      FNAM0500
.
FNAM1000  APPEND    DOT,NAMELINE
          APPEND    SP1,NAMELINE
          MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1700 IF EQUAL
.
FNAM1500  APPEND    PGNAME,NAMELINE         * append given name to nameline
          APPEND    SP1,NAMELINE
.
FNAM1700  APPEND    PSNAME,NAMELINE
          RESET     NAMELINE
          MOVE      NAMELINE,LINE           * append surname to name line
          CALL      COMP0000                * compress blanks
.         CALL      CASE0000                * convert to lower case
          MOVE      LINE,NAMELINE
          GOTO      FNAM9999
.
FNAM2000  MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1500 IF NOT EQUAL
          GOTO      FNAM1700
.
FNAM9999  RETURN
.**********************************************************************
.*                           FTIM0000                                 *
.*                   routine to Format the TIMe                       *
.**********************************************************************
FTIM0000  CLEAR     TIMELINE
          MATCH     "99",HOUR
          GOTO      FTIM7000 IF EQUAL
          MATCH     SP2,HOUR
          GOTO      FTIM7000 IF EQUAL
          MOVE      HOUR,TEMPHOUR
          SUBTRACT  TEN2,TEMPHOUR
          GOTO      FTIM1000 IF LESS
          GOTO      FTIM2000 IF EQUAL
          COMPARE   TEN2,TEMPHOUR
          GOTO      FTIM0050 IF NOT EQUAL
          MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          GOTO      FTIM1100
.
FTIM0050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM0100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM0100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "pm",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM1000  ADD       TEN2,TEMPHOUR
          GOTO      FTIM1050 IF NOT EQUAL
          MOVE      TEN2,HOUR
          GOTO      FTIM1100
.
FTIM1050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM1100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM1100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "am",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM2000  MOVE      TEN2,HOUR
          GOTO      FTIM0100
.
FTIM7000  MOVE      "        ",TIMELINE
.         MOVE      "99:99 pm",TIMELINE
          GOTO      FTIM9999
.
FTIM9999  RETURN
.**********************************************************************
.*                              CLRV0000                              *
.*      routine to initialise all unformatted variables to "*"        *
.**********************************************************************
CLRV0000  MOVE      "*",PSEX
          MOVE      "                         ",PADD1
          MOVE      "                         ",PADD2
          MOVE      "                         ",PSUBRB
          MOVE      "                         ",PADD4
          MOVE      "*************************",PGNAME
          MOVE      "********************",PSNAME
          MOVE      "    ",PPOST
          MOVE      "************",PTELEP
          MOVE      STAR52,RESPNAME
          MOVE      STAR50,PDESC
          MOVE      "*************************",RESPADDA
          MOVE      "*************************",RESPADDB
          MOVE      "******",RESPSEX
          MOVE      "****",RESPPOST
          MOVE      "***************",RESPSUBR
          MOVE      "********************",BTYPE
          MOVE      "********************",PACCOM
          MOVE      "********************",REFUNIT
          MOVE      "********************",REFPRTY
          MOVE      "               ",PSUBRB
          MOVE      "****",PTITL
          MOVE      "********************",DESCCAT
          MOVE      "********************",LXCELL
          MOVE      "***********************************",LXPADDA
          MOVE      "***********************************",LXPADDB
          MOVE      "***********************************",LXPADDC
          MOVE      "***********************************",LXPADDD
          MOVE      "********",LXPPOST
          MOVE      "********************",LXUDEF5
          MOVE      "********************",LXUDEF6
          MOVE      "********************",LXUDEF7
          MOVE      "********************",LXUDEF8
          MOVE      "******",LXPRANK
          MOVE      "********************",LXWRLDMB
          MOVE      "********************",LXWRLDPR
          MOVE      "********************",LXWRLDPG
          MOVE      "********************",LXWRLDPV
          MOVE      "************************************************************",LXWRLDFN
          MOVE      "***",LXWRCSST
          MOVE      "*******************",LXWRCSDT
          MOVE      "********************",LXPMIXWD
          MOVE      "********",LXPMIATM
          MOVE      "*******************",LXPMIADT
          MOVE      "********************",LXRXADWD
          MOVE      "********",LXREATIM
          MOVE      "*******************",LXREEDAT
          MOVE      "********************",LXVXAPBD 
          MOVE      "**************************************************",LXWRDESC
          MOVE      "*******************",LXPMIDOB
          MOVE      "********************",LXWRLDPC
          MOVE      "***",LXWRLDPC
          MOVE      "********************",LXWRLSTL
          MOVE      "********************",LXWRLPFX
          MOVE      "****************************************",LXWRLPEM
          MOVE      "****************************************",LXWLCHEM
          MOVE      "****************************************",LXWLCDEM
          MOVE      "****************",LXXSMSID
          MOVE      "******************************",LXXSMSKY
          MOVE      "***",LXSMSCOD
          MOVE      "********************",LXXSMSPH
          MOVE      "********",LXXSMSUR
          MOVE      "**********",LXXSMSUS
          MOVE      "******************************",LXXSMSUN
          MOVE      "*",LXSYSTYP
CLRV9999  RETURN
.*****************************************************************************
.*                             SHSP0000                                      *
.*               Set up HoSPital details for multi hospital                  *
.*****************************************************************************
SHSP0000  PACK      PTHSHOSP,SP30,SP30
          PACK      PTHSNAME,SP30,SP30
          PACK      PTHSADD1,SP30,SP30
          PACK      PTHSADD2,SP30,SP30
          PACK      PTHSADD3,SP30,SP30
          PACK      PTHSADD4,SP30,SP30
          PACK      PTHSPCOD,SP30,SP30
          PACK      PTHSTELE,SP30,SP30
.
          PACK      BKREWARD,BKREWARD,SP3
          MATCH     SP3,BKREWARD
          GOTO      SHSP9999 IF EQUAL
.
SHSP5000  PACK      KEY6,BKREWARD,SP10
          CALL      RDWARD1
          BRANCH    OVRCD,SHSP9999
.
          PACK      KEY3,PTWDHOSN
          CALL      RDPTHSP1
.
SHSP9999  RETURN
.****************************************************************************
.*                              CLGP0000                                    *
.*                          CLear GP details                                *
.****************************************************************************
CLGP0000  MOVE      SP70,RGGPSNAM
          MOVE      SP70,RGGPGNAM
          MOVE      SP70,RGGPADD1
          MOVE      SP70,RGGPADD2
          MOVE      SP70,RGGPADD3
          MOVE      SP70,RGGPADD4
          MOVE      SP70,RGGPPOST
          MOVE      SP70,RGGPFAXN
          MOVE      SP70,RGGPSEML
          MOVE      SP70,RGGPMOBN
          MOVE      SP70,RGGPPAGR
          MOVE      SP70,RGGPPAGN
          MOVE      SP70,RGGPPRV1
          MOVE      SP70,RGGPSTEL
          MOVE      SP70,RFGPSNAM
          MOVE      SP70,RFGPGNAM
          MOVE      SP70,RFGPADD1
          MOVE      SP70,RFGPADD2
          MOVE      SP70,RFGPADD3
          MOVE      SP70,RFGPADD4
          MOVE      SP70,RFGPPOST
.
. Registered GP Practice address
.
          MOVE      SP70,RGPRSURG
          MOVE      SP70,RGPRSAD1
          MOVE      SP70,RGPRSAD2
          MOVE      SP70,RGPRSAD3
          MOVE      SP70,RGPRSAD4
          MOVE      SP70,RGPRSPCD
          MOVE      SP70,RGPRTELE
          MOVE      SP70,RGPRFAXN
          MOVE      SP70,RGPRPEML
.
. Referring GP Practice address
.
          MOVE      SP70,RFPRSURG
          MOVE      SP70,RFPRSAD1
          MOVE      SP70,RFPRSAD2
          MOVE      SP70,RFPRSAD3
          MOVE      SP70,RFPRSAD4
          MOVE      SP70,RFPRSPCD
          MOVE      SP70,RFPRTELE
.
CLGP9999  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
OPNOUT99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the site code. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
COTFIL00  MATCH     SP70,CHECKSIT            * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      CHECKSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic name
.------------------------------------------------------------
PACC0000  MOVE      SP70,LXWRPRCC
          MOVE      SP70,LXWRPRAC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PACC1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PACC9000 IF EQUAL
.
          GOTO      PACC1000
.
PACC9000  MOVE      WTOPSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOPSITE,WTOPCLIN,WTOPDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOPSITE,OCASITE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCLIN,OCACLIN
          GOTO      PACC9999 IF NOT EQUAL
.
          MOVE      OCACLIN,LXWRPRCC
          MOVE      OCADESC,LXWRPRAC
.
PACC9999  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic location
.------------------------------------------------------------
PACLOC00  PACK      KEY36,WTOPOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PACLOC99
.
          MATCH     DOBAOUTN,WTOPOUTN
          GOTO      PACLOC99 IF NOT EQUAL
.
          MOVE      WTOPOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PACLOC99
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPACLOC
.
PACLOC99  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic name
.------------------------------------------------------------
PASC0000  MOVE      SP70,LXWRPACC
          MOVE      SP70,LXWRPANC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPS1
PASC1000  CALL      RKWTOPS1
          BRANCH    OVRCD,PASC9999
.
          MATCH     WTOSURNO,WMURNO
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCODE,WMCODE
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCOUN,DWMCNT
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     "0",WTOSSTAT
          GOTO      PASC9000 IF EQUAL
.
          GOTO      PASC1000
.
PASC9000  MOVE      WTOSSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOSSITE,WTOSCLIN,WTOSDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOSSITE,OCASITE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOSCLIN,OCACLIN
          GOTO      PACC9999 IF NOT EQUAL
.
          MOVE      OCACLIN,LXWRPACC
          MOVE      OCADESC,LXWRPANC
.
PASC9999  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic location
.------------------------------------------------------------
PASLOC00  PACK      KEY36,WTOSOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PASLOC99
.
          MATCH     DOBAOUTN,WTOSOUTN
          GOTO      PASLOC99 IF NOT EQUAL
.
          MOVE      WTOSOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PASLOC99
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPASLOC
.
PASLOC99  RETURN
.
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBKRX00  MOVE      SP70,BKRXPOWD  *  Post-Op Ward (patwr1af)
          MOVE      SP70,BKRXADWD  * Admitting Ward (patwr1af)
          MOVE      SP70,BKRXCDTE  * Contact Date (ccyymmdd)
          MOVE      SP70,BKRXPSTY  * Parent Staying (0=NO,1=YES)
          MOVE      SP70,BKRXCNDT  * Confirmation Date (ccyymmdd)
          MOVE      SP70,BKRXUDF1  * User Defined Field 1 (Cat BE)
          MOVE      SP70,BKRXUDF2  * User Defined Field 2 (Cat BF)
          MOVE      SP70,BKRXUDF3  * User Defined Field 3 (Cat BG)
          MOVE      SP70,BKRXUDF4  * User Defined Field 4 (Cat BH)
          MOVE      SP70,BKRXUDF5  * User Defined Field 5 (Cat BL)
          MOVE      SP70,BKRXUDD1  * User Defined Date 1 (ccyymmdd)
          MOVE      SP70,BKRXUDD2  * User Defined Date 2 (ccyymmdd)
          MOVE      SP70,BKRXUDD3  * User Defined Date 3 (ccyymmdd)
          MOVE      SP70,BKRXUDD4  * User Defined Date 4 (ccyymmdd)
          MOVE      SP70,BKRXUFF1  * Procedure Description 1
          MOVE      SP70,BKRXUFF2  * Procedure Description 2
          MOVE      SP70,BKRXUFF3  * Procedure Description 3
          MOVE      SP70,BKRXUFF4  * User Defined Free Format 4
          MOVE      SP70,BKRXEDC1  * Extra Doctor Code 1 (pmshcpaf)
          MOVE      SP70,BKRXEDC2  * Extra Doctor Code 2 (pmshcpaf)
          MOVE      SP70,BKRXEDC3  * Extra Doctor Code 3 (pmshcpaf)
          MOVE      SP70,BKRXODTE  * Operation Date (ccyymmdd)
          MOVE      SP70,BKRXOPRD  * Operation Period (Cat SP)
          MOVE      SP70,BKRXCRDT  * Date record created (ccyymmdd)
          MOVE      SP70,BKRXCRTM  * Time record created (hh:mm:ss)
          MOVE      SP70,BKRXWEBC  * WEB User Id rec. creator (websecaf)
          MOVE      SP70,BKRXLUPD  * Last Update Date (ccyymmdd)
          MOVE      SP70,BKRXLUPT  * Last Update Time (hh:mm:ss)
          MOVE      SP70,BKRXWEBU  * WEB User Id rec. updater (websecaf)
          MOVE      SP70,BKRXASRC  * Admission Source (Category S)
          MOVE      SP70,BKRXBLDT  * Blood Type (category BO)
          MOVE      SP70,BKRXCTTY  * Contact Type (Letter No.-watletaf)
          MOVE      SP70,BKRXSGBK  * Surgical Booking
          RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBOKREC  MOVE      SP70,BKRESNAM  *       Surname
          MOVE      SP70,BKRELOCK  *        Lock variable
          MOVE      SP70,BKREADOC  *        Attending Doctor
          MOVE      SP70,BKRESDOC  *        Referring Doctor
          MOVE      SP70,BKREEDAT  *        Expected due date (CCYYMMDD)
          MOVE      SP70,BKREATIM  *        Expected assessment time
          MOVE      SP70,BKREPDAT  *        Pre-assessment date
          MOVE      SP70,BKREPTIM  *        Pre-assessment time
          MOVE      SP70,BKREADAT  *        Date booking was made CCYYMMDD
          MOVE      SP70,BKRETYPE  *        Booking type (Cat "BK")
          MOVE      SP70,BKRECANC  *        Cancellation reason (Cat "BC")
          MOVE      SP70,BKRESTAT  *        Booking status
          MOVE      SP70,BKREOMEM  *        Benefit fund member (Y/N/U)
          MOVE      SP70,BKREPREV  *        Previous inpatient (Y/N/U)
          MOVE      SP70,BKREACCM  *        Preferred accommodation (Cat BP)
          MOVE      SP70,BKREPROC  *        Waiting list procedure code
          MOVE      SP70,DBKRECNT  *        Waiting list procedure count
          MOVE      SP70,BKREWARD  *        Expected ward
          MOVE      SP70,BKREADMN  *        Maternity admission number
          MOVE      SP70,BKREPREA  *        Deposit paid (Y/N) Matern only
          MOVE      SP70,BKREEBED  *        Expected bed
          MOVE      SP70,BKRECLSS  *        Patient Cat./Adm Class. (Cat P)
          MOVE      SP70,BKREATYP  *        Adm Type/Pat. Class (Cat A)
          MOVE      SP70,BKREDEPT  *        Department (Cat AC)
          MOVE      SP70,BKRETDOC  *        Associated Doctor
          MOVE      SP70,BKRECLMT  *        Claim type (Cat CL)
          MOVE      SP70,BKRERFGP  *        Referring GP
          MOVE      SP70,BKREGPPC  *        GP Practice code
          MOVE      SP70,BKREGPFA  *       GPFH Approval Number
          MOVE      SP70,BKRERESI  *        Resident Status (Cat T)
          MOVE      SP70,BKREEATY  *        Elective Admission Type  (Cat CC)
          MOVE      SP70,BKREECRA  *       ECR Approval Number
          MOVE      SP70,BKREGPPT  *        GP Practice count
          MOVE      SP70,BKREDOFR  *        District of Residence (Cat DA)
          MOVE      SP70,BKREOPER  *        Operator who made I/P Booking
          MOVE      SP70,DBKREELO  *        Expected Length of Stay (Days)
          MOVE      SP70,BKREBKDT  *        Booking date (ccyymmdd)
          MOVE      SP70,BKRESPAR  *        Spare
          MOVE      SP70,BKREINDC
          RETURN
.
.
.------------------------------------------------------------
. Set referring clinician fields (WTTXRCLI)
.------------------------------------------------------------
RCLI0000  MOVE      SP70,LXRCLINF
          MOVE      SP70,LXRCLTLE
          MOVE      SP70,LXRCLSNM
          MOVE      SP70,LXRCLGNM
          MOVE      SP70,LXRCLAD1
          MOVE      SP70,LXRCLAD2
          MOVE      SP70,LXRCLAD3
          MOVE      SP70,LXRCLAD4
          MOVE      SP70,LXRCLPST
.
          MATCH     SP70,WTTXRCLI           * Referring clinician
          GOTO      RCLI9999 IF EQUAL       * blank
.
          PACK      KEY10,WTTXRCLI,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,RCLI9999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXRCLINF
          MOVE      PMHCTITL,LXRCLTLE
          MOVE      PMHCSNAM,LXRCLSNM
          MOVE      PMHCGNAM,LXRCLGNM
          MOVE      PMHCADR1,LXRCLAD1
          MOVE      PMHCADR2,LXRCLAD2
          MOVE      PMHCADR3,LXRCLAD3
          MOVE      PMHCADR4,LXRCLAD4
          MOVE      PMHCPOST,LXRCLPST
.
RCLI9999  RETURN
.
.******************************************************************************
.*                                  NOK20000                                  *
.*                         Get NOK2 Contact Details                           *
.******************************************************************************
NOK20000  PACK      KEY5,CATTC,SP70
          CALL      RDSCODE1
NOK21000  CALL      RDKCODE1
          BRANCH    OVRCD,NOK25000
.
          MATCH     CATTC,TCODE
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      NOK21000 IF EQUAL
.
          MATCH     CONTTYPE,TCINDC1
          IF        @EQUAL
            MATCH     "2",TCINDC3                * indc1=1 and indc3=2
            GOTO      NOK22000 IF EQUAL
          ENDIF
          GOTO      NOK21000
.
NOK22000  PACK      KEY14,PURNO,ACODE,SP70
          CALL      RSPMCEX1
NOK22100  CALL      RKPMCEX1
          BRANCH    OVRCD,NOK25000
.
          MATCH     PURNO,PMCEURNO          * Same U/R
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     ACODE,PMCETYPE          * Same Contact Type
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV            * Ignore if inactive
          GOTO      NOK22100 IF EQUAL
.
          GOTO      NOK29999
.
NOK25000  CALL      CLPMSCEX                * Clear extra contact file vars
.
NOK29999  RETURN
+
. =========================================================================
.         I/O Includes
. =========================================================================
          INC       CLPATMIS
          INC       CLPMSCEX
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPATVIS
          INC       SMSMESID
.
          INC       PMSCEXCD
          INC       SEXDSP00
.
          INC       IBASEQIO/INC
          INC       WATEPSIO/INC
          INC       WATTR1IO/INC
          INC       WATPROIO/INC
          INC       WATLHIIO/INC
          INC       WATLETIO/INC
          INC       WATVWLIO/INC
          INC       WATCHAIO/INC
          INC       PATDO1IO/INC
          INC       BOKRX1IO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATCODIO/INC
          INC       PATHSPIO/INC
          INC       PMSCEXIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSOOSIO/INC
          INC       PATMI1IO/INC
          INC       PATWR1IO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       BOKRC1IO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       WATTX1IO/INC
          INC       WATSUSIO/INC
          INC       WEBERRIO/INC
          INC       WEBSECIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTCLIIO/INC
          INC       OUTHEDIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSESIO/INC
          INC       OUTSITIO/INC
          INC       MLTCODIO/INC

          INC       CALCAGE
          INC       WATLETCD 
          INC       STD001IO
          INC       SMSPRXML           * Print XML metatags for SMS
          INC       PATCODTM
