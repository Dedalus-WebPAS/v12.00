.----------------------------------------------------------------------
.
. Function      : NIHC IHI Polling JSON Response
.                 Server
.
. Modifications :
.
.----------------------------------------------------------------------
. V11.04.05 12/07/2024  Peter Vela       TSK 0939978
.           Added validation for PMSIHESC = 2 Different IHI Number returned
. V11.04.04 18/01/2024  Peter Vela       TSK 0939978
.           Added validation to not poll PMNPRTYP = 10 (Upload to MyHR)
.           at MAIN1000
.           10/01/2024  Peter Vela       TSK 0939978
.           Recompiled for PMSNDBFD - Added Episode and Upload URLs
. V11.04.03 19/12/2023  Peter Vela       TSK 0935874
.           Fixed right justification of counter at NIHCRS9B
. V11.04.02 30/11/2023  Peter Vela       TSK 0935874
.           Recompiled for PMSIHEFD - Added indexes 4,5,6 and added Exception
.           Description
.           Added functionality to write exception descriptions to pmsiheaf
.           Clear verification status if response is unverified or provisional
.           Populate PMIEADAT / PMIEATIM with create date/time if blank
.           before each WRPMIHE1 call
.           Changed to goto CIHI5000 after deleting pmsaidaf record when
.           response status is 10
.           Commented out check for IHI activation status at CIHI2000
.           Move "1" to pmsiheaf verificationstatus if IHI response is
.           "retired" or "expired"
. V11.04.01 15/11/2023  Peter Vela       TSK 0935874
.           Added pack of JSONREDE to PMNPEROR at NIHCRS99 
.           Added HTML response parsing in NIHCRS00
.           CIHI2100 - If existing different IHI number exists then
.           delete and write new IHI into pmsaidaf
.           Added population of PMNPUDAT PMNPUTIM PMNPUUID to each update of 
.           pmsnplaf
.           Fixed population of userid in pmsihiaf before write and update
.           GetIHI - on status 27, write/update resolved status to pmsihiaf
.           Check PMISRSDE when writing to Response Description in pmsirsaf
.           Added functionality to CIHI5000 to alwasy write to pmsihiaf
.           when there is a status change in the IHI Number
.           Added further vaildations for Reponse Status 10 for 
.           expired and retired IHI numbers
. V11.03.05 10/11/2023  Peter Vela       TSK 0935874
.           Added duplicate exception message to pmsnplaf.PMNPEROR
.           if duplicate is detection and written to pmsiheaf
.           in the reponse from the NIHC server
. V11.03.04 23/10/2023  Peter Vela       TSK 0935874
.           Added multihospital validation for PMNBHOSP
.           Added GetIHI values to Clear IHI record write in GTIHIN00
.           Added save create user date/time for Get IHI write to pmsihiaf
. V11.03.03 10/10/2023  Peter Vela    TSK 0935874
.           Recompiled for PMSNDBFD - New URL variables
.           Recompiled for PMSIHIFD - Fixed IO calls
. V11.03.02 06/10/2023  Peter Vela       TSK 0935874
.           Added check for blank IHI number in CIHI5000
. V11.03.01 19/09/2023  Peter Vela       TSK 0935874
.           Created NIHC IHI Polling Response Server
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       CHKDIGVR/INC
          INC       EMRICDFD/INC
          INC       EMRHISFD/INC 
          INC       APSMASFD/INC
          INC       AAEDE1FD/INC
          INC       EMRLPCFD/INC
          INC       EMRCONFD/INC                                       *I-50421
          INC       EMRLOCFD/INC
          INC       EMRSITFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       ELTRONVR/INC
          INC       EOCLNKFD/INC
          INC       EOCREFFD/INC
          INC       EMRVISFD/INC
          INC       EMRCLIFD/INC
          INC       EMRGRCFD/INC
          INC       EMRPROFD/INC                                       *I-50421
          INC       EMRUNKFD/INC
          INC       IBADLABS/INC
          INC       IBATMDFD/INC
          INC       MEHDLSFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OPRNURFD/INC
          INC       PATCONFD/INC
          INC       AAECONFD/INC   *****
          INC       PATALRFD/INC   *****
          INC       PMSALNFD/INC
          INC       PATDO1FD/INC
          INC       PATFN1FD/INC
          INC       PATGO1FD/INC
          INC       PATHSPFD/INC
          INC       PMSCCDFD/INC
          INC       PMSCEXFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSIHIFD/INC
          INC       PMSMDTFD/INC
          INC       PMSMTXFD/INC
          INC       PATIN1FD/INC
          INC       PRIITMFD/INC
          INC       PATITMFD/INC                                       *I-50421
          INC       PATICDFD/INC                                       *I-50421
          INC       PATICOFD/INC                                       *I-50421
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PMSAIDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSRELFD/INC              
          INC       PMSTLEFD/INC   
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC                                       *I-55214
          INC       PATWC1FD/INC 
          INC       PMSWX1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
          INC       PMSNDBFD/INC
          INC       PMSNPLFD/INC
          INC       PMSIRQFD/INC
          INC       PMSIRSFD/INC
          INC       PMSIHEFD/INC
          INC       PMSIERFD/INC
.
          INC       SCRPSTFD/INC
          INC       SCRSBGFD/INC
          INC       SCRSLTFD/INC
          INC       SCRMASFD/INC
          INC       PATHGPFD/INC
.
          INC       EMRDCMFD/INC       
          INC       OBSDETFD/INC                                       *I-54627
          INC       OBSMTXFD/INC
          INC       OBSMDTFD/INC
          INC       EMRISMFD/INC 
          INC       EMRINCFD/INC 
          INC       EMRWFMFD/INC
          INC       EMRVCDFD/INC
          INC       EMRMTXFD/INC
          INC       EMRVPRFD/INC
          INC       VISCMTFD/INC
          INC       VISCODFD/INC
          INC       VISMDTFD/INC
          INC       VISXDCFD/INC
          INC       EMRMANFD/INC 
          INC       VISMTXFD/INC
          INC       WEBB2BFD/INC
          INC       WEBOPVFD/INC
          INC       TFILEVAR/INC

.
ANSLI     INIT      "i"
ANSLW     INIT      "w"
DAYDESC   DIM       9
DEEXDATE  DIM       8
DIM16     DIM       16
DIM21     DIM       21
DIM23     DIM       23
DIM24     DIM       24
DIM26     DIM       26
DIM27     DIM       27
DIM30     DIM       30
DIM35     DIM       35
DIM50     DIM       50
DIM80     DIM       80
DIM100    DIM       100
DFNAME    DIM       60
DSMOKE    DIM       3
GATTIMER  FORM      3
GETTOKF4  FORM      4
GPFRMTNM  DIM       40
LINEA17   DIM       17
LINEB17   DIM       17
LINEC17   DIM       17
LINED17   DIM       17
LINEE17   DIM       17
LINEF17   DIM       17
LINEG17   DIM       17
LINEH17   DIM       17
LINEI17   DIM       17
LINEA37   DIM       37
LINEB37   DIM       37
LINEC37   DIM       37
LINED37   DIM       37
LINEE37   DIM       37
LINEF37   DIM       37
LINEG37   DIM       37
LINEH37   DIM       37
LINEI37   DIM       37
TYPE4     INIT      "004"
TYPE5     INIT      "005"
SAVKEY5   DIM       5
SAVENCOM  FORM      1
SAVEDCOM  FORM      1
SAVDOC    DIM       10
SKEY8     DIM       8
DOCTIME   DIM       8
HOUR      DIM       2
MEDINUMB  DIM       13
MIN       DIM       2
MONTHDES  DIM       9
NUM3      FORM      3
PTFRMTNM  DIM       40
SEC       DIM       2
MEDNOTES  DIM       70
TEMPDATE  DIM       12
IHIDUPUR  DIM       8
PMSIHEIN  DIM       1
PMSIHESC  DIM       1
SAVEASTA  DIM       1
SAVEAST1  DIM       1
.
NEWCOUNT  FORM      10
.
ADLABEL   FORM      2
ATT       DIM       80         * attribute string
AFTDECP   FORM      2          * After Decimal Place
AFTDECPF  FORM      2          * After Decimal Place Format String
.
BEFDECP   FORM      2          * Before Decimal Place
BEFDECPF  FORM      2          * Before Decimal Place Format String
BIRTHDAT  DIM       10            * formatted DOB variable
.
CALDAYS    FORM      3
CDEFPRT2  DIM       6
CHG       FORM      1
CHKMNCNT  FORM      1          * check mandatory fields cycle counter
CLAIMCOD  DIM       3
CLMDET1   DIM       50
CLMDET2   DIM       50
CMDLINE   DIM       200
CONTTYPE  DIM       1
CONTTYP2  FORM      1
COUNTER   FORM      1
CPPAPER2  FORM      2
CURRROW   FORM      3
CODEDESC  DIM       100                                                *I-50421
.
CIHIADAT  DIM       8
CIHIATIM  DIM       8
CIHIVSTA  DIM       1
CIHIASTA  DIM       1
.
GIHICDAT  DIM       8
GIHICTIM  DIM       8
GIHICUID  DIM       10
.
DANS1     DIM       20
DCASE     DIM       3
DECIMALP  INIT      "."  
DIM2L     DIM       2
DIM3      DIM       3
DIM6      DIM       6
DIM4      DIM       4
DIM5      DIM       5                                                  *I-54309
DIM8      DIM       8             * U/R variable (spaces removed)
DIM9      DIM       9
DIM10     DIM       10 
DIM10A    DIM       10
DIM10B    DIM       10
DIM11     DIM       11
DIM11G    DIM       11            * given name variable for small labels
DIM11S    DIM       11            * surname variable for small labels
DIM12     DIM       12
DIM14     DIM       14
DIM15     DIM       15
DIM17     DIM       17
DIM18     DIM       18            * given name variable for large labels
DIM20     DIM       20
DIM25     DIM       25
DIM31     DIM       31            * formatted address
DIM60     DIM       60
DOCTCODE  DIM       6
BURNO     DIM       9
BADMNO    DIM       9
PTURNO    DIM       8             * U/R variable (spaces removed)
PTADMNO   DIM       8             * Admission No variable (spaces removed)
EDOCNAME  DIM       23
PSURNAME  DIM       23
PGIVNAME  DIM       23
PCLMTYPD  DIM       20
PADDRSS1  DIM       23 
PADDRSS2  DIM       23
PAGEYRS   DIM       4
PGPNAME   DIM       30
PRTLABL1  DIM       17
PRTLABL2  DIM       20
PRTLABL3  DIM       16
PRTLABL4  DIM       15
PRTLABL5  DIM       17
PRTLABL6  DIM       24
.
EMRFLAG   FORM      1 
EMRPREV   DIM       20 
EMRSEEN   DIM       8
EMRDOCT   DIM       13
EMRINSUR  DIM       5
EMRDESC   DIM       20
EMRURNO   DIM       8
ENDFLG    FORM      1
.
FIRSTCH   FORM      1                                                  *I-60700
FIELDNO   FORM      5
FORM1A    FORM      1                                                  *I-54627
FORM1B    FORM      1                                                  *I-54627
FORM3     FORM      3
FORM3A    FORM      3                                                  *I-50421
FORM5     FORM      5
FORM21    FORM      21
FORMAT21  FORM      21
FRMPRINT  DIM       6
.                                                                     *I-196463
DIM3A     DIM       3
DIM3B     DIM       3
DIM15A    DIM       15
DIM50A    DIM       50
DIM80A    DIM       80
.
LINSREQD  FORM      5
PAGENUMB  FORM      3
PAGETOTL  FORM      3
PAGEMAXL  FORM      3                       * Maximum lines per page
PASSNO    FORM      1
PGLINES   DIM       6
PRINTEND  FORM      1
.
WFLINE3A  DIM       20
WFLINE2A  DIM       20
WFLINE8A  DIM       20
WFLINE6A  DIM       20
WFLINE4A  DIM       20
WFLINE7A  DIM       20
WFLINE5A  DIM       20
WFLINE1A  DIM       20
.
HIGH14    DIM       4
HIGH24    DIM       4
HIGH34    DIM       4
.HELPAGE   FORM      1
.HELPRNT   FORM      3
.HELSIZE   FORM      1
.HEMR5COD  DIM       6            * Code for user defined stationary
HEPMR5B   FORM      "1"          * Patient MR5 form sheet 1=Yes, 0=No
.HEMR5L    FORM      "1"          * Layout for MR5.
.                                  0 = Modbury
.                                  1 = User Defined
.
IHINUMBR  DIM       20
JYEAR     FORM      2
.
LASTROW   FORM      3
LABSIZE   FORM      1
LARGELAB  DIM       16
SMALLLAB  DIM       21
LBLPRINT  DIM       6
LABELATT  DIM       80[24]
LABELDAT  DIM       80[24]
LABELTYP  DIM       10
LLCNT     FORM      5
LEFTBRAK  INIT      "(" 
LINE60    DIM       60                                                 *I-60700
.
MANDINUR  FORM      1
MADESC    DIM       3
MODE4     DIM       4
.
MBIRURNO  DIM       8
MBIRTYOR  DIM       24
.
.
NEGOFSET  DIM       8             * U/R variable (spaces removed)
NMPNUMB   DIM       20
NOLABEL   FORM      3
NOTEFILT  DIM       3
.
OPFLG     FORM      1
.
PRDGFLAG  FORM      1
PRINTVAR  DIM       80
PRNTSTRT  FORM      3
PRIDSYET  FORM      1
.
QADD1     DIM       25
QADD2     DIM       25
QADD4     DIM       15
QGNAME    DIM       14
QLOCDOC   DIM       30
QMEDI     DIM       10
QOCCUP    DIM       14
QPOST     DIM       4
QSAGE     FORM      3
QSEX      DIM       1
QSNAME    DIM       15
QSUBRB    DIM       15
QTELEP    DIM       12
QTITL     DIM       4
.
RESPONSD  DIM       3             * Cat EZ code for doctor responsible
RESPONSN  DIM       3             * Cat EZ code for nurse responsible
RESPONSC  DIM       3             * Cat EZ code for psc responsible
REFDEVF6  FORM      6
.
RTAOVRCD  FORM      1
.
SAVTYP    DIM       3
SAVKEY27  DIM       27
SAVKEY29  DIM       29
SAVEURNO  DIM       8
SAVEHOSP  DIM       3
SAVERUID  DIM       10
SCRID     DIM       2
SHRTBDAT  DIM       8
SHRTMDAT  DIM       7
SHRTVDAT  DIM       8
SVSTNCOD  DIM       6
STATNCOD  DIM       6
SIT4      DIM       4
SRC4      DIM       4
.
.TEMPTRID  DIM       24
TEMPMSID  DIM       36
.TRIDFILE  DIM       8
MSIDFILE  DIM       8
.
UNIQF5    FORM      5
VADESC    DIM       3
VARIABLE  DIM       127
VISITDAT  DIM       10            * formatted emergency visit date variable
VISITNUM  DIM       8             * emergency visit number variable
VISNOTES  DIM       100
.
WAITTIME  FORM      4
WCDESC    DIM       3
WCNAME    DIM       20
WDATE1    DIM       8
WDATE2    DIM       8
XPRIDIAG  DIM       6      * Primary Diagnosis
XADDIAG1  DIM       6      * Additional Diagnosis 1
.
VISXDCIN  FORM      1
.
ANSHP     INIT      "HP"
ANSPP     INIT      "PP"
CODEA     INIT      "A "
CODEA1    INIT      "A1"
CODEA2    INIT      "A2"
CODEA3    INIT      "A3"
CODEA4    INIT      "A4"
CODEA5    INIT      "A5"
CODEA6    INIT      "A6"
CODEA7    INIT      "A7"
CODEA8    INIT      "A8"
CODEAA    INIT      "AA"
CODEAE    INIT      "AE"
CODEAI    INIT      "AI"
CODEAP    INIT      "AP"
CODEAR    INIT      "AR"
CODECL    INIT      "CL"
CODEC     INIT      "C "
CODECC    INIT      "CC"
CODECT    INIT      "ct"
CODEEA    INIT      "EA"
CODEES    INIT      "ES"
CODEEP    INIT      "EP"
CODEED    INIT      "ED"
CODEEW    INIT      "EW"
CODEEZ    INIT      "EZ"
CODEH1    INIT      "H1"
CODEH2    INIT      "H2"
CODEH3    INIT      "H3"
CODEM     INIT      "M "
CODEP     INIT      "P "
CODEP1    INIT      "P1"
CODEP2    INIT      "P2"
CODEP3    INIT      "P3"
CODEP4    INIT      "P4"
CODEP5    INIT      "P5"
CODEP6    INIT      "P6"
CODER     INIT      "R "
CODERA    INIT      "RA"
CODET     INIT      "T "
CODEU1    INIT      "U1"
CODEV6    INIT      "V6"
CODEV7    INIT      "V7"
CODEV8    INIT      "V8"
CODES     INIT      "S "
CATcw     INIT      "cw"
CATEA     INIT      "ea"
CATEB     INIT      "eb"
CATEC     INIT      "ec"
CATED     INIT      "ed"
CATEE     INIT      "ee"
CATEF     INIT      "ef"
CATEG     INIT      "eg"
CATEH     INIT      "eh"
CATEI     INIT      "ei"
CATEJ     INIT      "ej"
CATEK     INIT      "ek"
CATEL     INIT      "el"
CATEM     INIT      "em"
CATEN     INIT      "en"
CATEO     INIT      "eo"
CATEP     INIT      "ep"
CATEQ     INIT      "eq"
CATER     INIT      "er"
CATES     INIT      "es"
CATET     INIT      "et"
CATEU     INIT      "eu"
CATEV     INIT      "ev"
CATEW     INIT      "ew"
CATEY     INIT      "ey"
CATHP     INIT      "HP"
CATLS     INIT      "LS"
CATTC     INIT      "tc"
CATWS     INIT      "ws"                                               *I-59548
CATWT     INIT      "wt"
CATWU     INIT      "wu"
CATWQ     INIT      "wq"                                               *I-59548
CATWR     INIT      "wr"                                               *I-59548
CATW0     INIT      "w0"
DASH      INIT      "-"
OTHER     INIT      "Other"
SP12      INIT      "            "
SP127     INIT      "                                          ":
                    "                                          ":
                    "                                           "
SP40      INIT      "                                       "
X27       INIT      "XXXXXXXXXXXXXXXXXXXXXXXXXXX"
X100      INIT      "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX":
                    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
ZERO4     INIT      "0000"
.
CARET     INIT      "^"
MJAN      INIT      "January"
MFEB      INIT      "February"
MMAR      INIT      "March"
MAPR      INIT      "April"
MMAY      INIT      "May"
MJUN      INIT      "June"
MJUL      INIT      "July"
MAUG      INIT      "August"
MSEP      INIT      "September"
MOCT      INIT      "October"
MNOV      INIT      "November"
MDEC      INIT      "December"
.
. webServices PRODA Variables
.
WBSPROPF  FILE      ASCII,FIXED=256
WBSACTVF  FILE      ASCII,FIXED=256
WBSTOKNF  FILE      ASCII,FIXED=256
WBSACTIF  FILE      ASCII,FIXED=256
WBSTOKIF  FILE      ASCII,FIXED=256
WBSACTEF  FILE      ASCII,FIXED=256
WBSTRIDF  FILE      ASCII,FIXED=256
WBSMSIDF  FILE      ASCII,FIXED=256
WBSOPVRF  FILE      ASCII,FIXED=500
.
PRODAIND  DIM       1
.
PRDAPATH  DIM       120
ACTVPATH  DIM       120
TOKNPATH  DIM       120
ACTIPATH  DIM       120
TOKIPATH  DIM       120
ACTEPATH  DIM       120
.TRIDPATH  DIM       120
MSIDPATH  DIM       120
.
PRDAFILE  INIT      "webPAS_PRODA.properties"
ACTVFILE  INIT      "webPAS_PRODA_ActivateDevice_curl_response"
TOKNFILE  INIT      "webPAS_PRODA_GetAccessToken_curl_response"
ACTIFILE  INIT      "webPAS_PRODA_ActivateDevice_curl_response_indicator"
TOKIFILE  INIT      "webPAS_PRODA_GetAccessToken_curl_response_indicator"
ACTEFILE  INIT      "webPAS_PRODA_ActivateDevice_curl_expiry_indicator"
.
WBSACTIN  DIM       1
WBSTOKIN  DIM       1
WBSACTE1  DIM       1
WBSACTE2  DIM       1
WBSACTE3  DIM       1
.
OPENBRAC  DIM       1
CLOSBRAC  DIM       1
.
DEVISLAB  DIM       20
KEYSTLAB  DIM       17
KEYEXLAB  DIM       17
DEVIXLAB  DIM       20
.
DEVISVAL  DIM       6
KEYSTVAL  DIM       6
KEYEXVAL  DIM       19
DEVIXVAL  DIM       19
.
ACCTKLAB  DIM       16
ACCTKVAL  DIM       837
ACCDELAB  DIM       30
ACCDEVAL  DIM       19
ACCKELAB  DIM       16
ACCKEVAL  DIM       19
ACCTTLAB  DIM       16
ACCTTVAL  DIM       6
ACCEILAB  DIM       15
ACCEIVAL  DIM       4
.
. ----- WebServices B2B Device Properties -----
.
WBSPROID  DIM       60                * Product ID
WBSJKSLO  DIM       60                * JKS/Certificate File Location
WBSPRORG  DIM       60                * PRODA Organisation ID
WBSDVNAM  DIM       60                * Device Name
WBSCLIID  DIM       60                * Client ID
WBSACTAU  DIM       60                * Access Token Audience
WBSACTVC  DIM       60                * Activation Code
WBSDACUR  DIM       60                * Device Activation URL
WBSDAUUR  DIM       60                * Device Authentication URL
WBSRDKUR  DIM       60                * Refresh Device Key URL
WBSWSCLI  DIM       60                * WebServices Claiming Client Id
WBSLOCAT  DIM       60                * Location Id
WBSNOTEM  DIM       60                * Notification Email
.
WBSPILAB  DIM       17                * Product ID Label
WBSJKLAB  DIM       20                * JKS File Location Label
WBSPOLAB  DIM       18                * Proda Org Id Label
WBSDNLAB  DIM       18                * Device Name Label
WBSCILAB  DIM       16                * Client ID Label
WBSATLAB  DIM       27                * Access Token Audience Label
WBSACLAB  DIM       22                * Activation Code Label
WBSDALAB  DIM       27                * Device Activation URL Label
WBSDULAB  DIM       31                * Device Authentication URL Label
WBSRDLAB  DIM       27                * Refresh Device Key URL Label
WBSWSLAB  DIM       27                * WebServices Claiming Client Id Label
WBSLOLAB  DIM       18                * Location Id Label
WBSNOLAB  DIM       25                * Notification Email Label
.
WBSRV001  DIM       60                * Product ID
WBSRV002  DIM       60                * JKS/Certificate File Location
WBSRV003  DIM       60                * PRODA Organisation ID
WBSRV004  DIM       60                * Device Name
WBSRV005  DIM       60                * Client ID
WBSRV006  DIM       60                * Access Token Audience
WBSRV007  DIM       60                * Activation Code
WBSRV008  DIM       60                * Device Activation URL
WBSRV009  DIM       60                * Device Authentication URL
WBSRV010  DIM       60                * Refresh Device Key URL
WBSRV011  DIM       60                * WebServices Claiming Client Id
WBSRV012  DIM       60                * Location Id
WBSRV013  DIM       60                * Notification Email
.
. ----- WebServices OPV - PVM Data Variables -----
.
. .properties file  Len    Pos
.-----------------  ---    ---
PRPLAB01  INIT      "webpas.opvTransactionId="
PRPVAL01  DIM       24
PRPLAB02  INIT      "webpas.opvMessageId="
PRPVAL02  DIM       36
PRPLAB03  INIT      "webpas.opvSubjectId="
PRPVAL03  DIM       10
.
. _opvw_pvm file    Len    Pos
.---------------    ---    ---
.LCBRAC    INIT    "{"
.QUOTE     INIT      "#""
OPVLAB01  INIT    "patient"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.LCBRAC    INIT    "{"
.QUOTE     INIT      "#""
OPVLAB02  INIT    "identity"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.LCBRAC    INIT    "{"
.QUOTE     INIT      "#""
OPVLAB03  INIT    "dateOfBirth"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL03  DIM     10
.QUOTE     INIT      "#""
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB04  INIT    "familyName"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL04  DIM     40
.QUOTE     INIT      "#""
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB05  INIT    "givenName"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL05  DIM     40
.QUOTE     INIT      "#""
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB06  INIT    "sex"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL06  DIM     1
.QUOTE     INIT      "#""
.RCBRAC    INIT    "}"
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB07  INIT    "medicare"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.LCBRAC    INIT    "{"
.QUOTE     INIT      "#""
OPVLAB08  INIT    "memberNumber"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL08  DIM     10
.QUOTE     INIT      "#""
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB09  INIT    "memberRefNumber"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL09  DIM     1
.QUOTE     INIT      "#""
.RCBRAC    INIT    "}"
.RCBRAC    INIT    "}"
.COMMA     INIT    ","
.QUOTE     INIT      "#""
OPVLAB10  INIT    "typeCode"
.QUOTE     INIT      "#""
.COLON     INIT    ":"
.QUOTE     INIT      "#""
OPVVAL10  DIM     3
.QUOTE     INIT      "#""
.RCBRAC    INIT    "}"
.
.PROPFLNM  DIM       35 
.PROPFILE  FILE      ASCII,FIXED=256
.PROPLITR  INIT      ".properties"
.
OPVWFLNM  DIM       33
OPVWFILE  FILE      ASCII,FIXED=256
OPVWLITR  INIT      "_opvw_pvm"
.
OPVEFLNM  DIM       36
OPVEFILE  FILE      ASCII,FIXED=500
OPVELITR  INIT      "_opvw_errors"
.
OPVELINE  DIM       500
.
OPVRFLNM  DIM       38
OPVRFILE  FILE      ASCII,FIXED=500
OPVRLITR  INIT      "_opvw_response"
.
OPVRLINE  DIM       500
OPVRWORK  DIM       500
.
JSONCODE  DIM       4
JSONTEXT  DIM       500
JSONMNUM  DIM       10
JSONMREF  DIM       1
.JSONFNAM  DIM       40
.
.   ****** NIHC DASHBOARD VARIABLES ***********
.
NHCJKSLO  DIM       100               * JKS/Certificate File Location
NHCDVNAM  DIM       100               * Device Name
NHCNIHCU  DIM       200               * NIHC URL
NHCNICCU  DIM       200               * NIHC Clear URL
NHCALGOR  DIM       100               * Certificate Algorithm
NHCHOSPC  DIM       100               * Hospital Code
.
NHCJKLAB  DIM       20                * JKS File Location Label
NHCDNLAB  DIM       18                * Device Name Label
NHCNILAB  DIM       18                * NIHC URL Label
NHCNCLAB  DIM       23                * NIHC Clear URL Label
NHCALLAB  DIM       21                * Certificate Algorithm Label
NHCHOLAB  DIM       20                * Hospital Code Label
.
NHCIH001  DIM       100               * JKS/Certificate File Location
NHCIH002  DIM       100               * Device Name
NHCIH003  DIM       200               * NIHC URL
NHCIH004  DIM       200               * NIHC Clear URL
NHCIH005  DIM       100               * Certificate Algorithm
NHCIH006  DIM       100               * Hospital Code
.
. ----- NIHC IHI Data Variables -----
.
NPRLAB01  INIT      "webpas.nihcihiTransactionId="
NPRVAL01  DIM       24
.
. _nihcihi  file     Len    Pos
.---------------    ---    ---
LCBRAC    INIT    "{"
IHILAB01  INIT    "#"User#":"
.LCBRAC    INIT    "{"
IHILAB02  INIT    "#"Role#":"
.QUOTE     INIT      "#""
IHIVAL02  DIM     50
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB03  INIT    "#"Name#":"
.QUOTE     INIT      "#""
IHIVAL03  DIM     30
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB04  INIT    "#"Login#":"
.QUOTE     INIT      "#""
IHIVAL04  DIM     100
.QUOTE     INIT      "#""
.RCBRAC    INIT    "}"
.COMMA     INIT    ","
IHILAB05  INIT    "#"CheckIHI#":"
.LCBRAC    INIT    "{"
IHILAB06  INIT    "#"HospitalCodeSystem#":"
.QUOTE     INIT      "#""
IHIVAL06  DIM     20
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB07  INIT    "#"DateOfBirth#":"
.QUOTE     INIT      "#""
IHIVAL07  DIM     10
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB08  INIT    "#"HospitalCode#":"
.QUOTE     INIT      "#""
IHIVAL08  DIM     20
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB09  INIT    "#"FamilyName#":"
.QUOTE     INIT      "#""
IHIVAL09  DIM     40
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB10  INIT    "#"GivenName#":"
.QUOTE     INIT      "#""
IHIVAL10  DIM     40
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB11  INIT    "#"Sex#":"
.QUOTE     INIT      "#""
IHIVAL11  DIM     50
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB12  INIT    "#"MedicareNumber#":"
.QUOTE     INIT      "#""
IHIVAL12  DIM     10
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB13  INIT    "#"MedicareIRN#":"
.QUOTE     INIT      "#""
IHIVAL13  DIM     1
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB14  INIT    "#"PASID#":"
.QUOTE     INIT      "#""
IHIVAL14  DIM     8
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB15  INIT    "#"Ihi#":"
.QUOTE     INIT      "#""
IHIVAL15  DIM     16
.QUOTE     INIT      "#""
.COMMA     INIT    ","
IHILAB16  INIT    "#"DVA#":"
.QUOTE     INIT      "#""
IHIVAL16  DIM     8
.QUOTE     INIT      "#""
.RCBRAC    INIT    "}"
.COMMA     INIT    ","
IHILAB17  INIT    "#"dateOfBirth#":"
.QUOTE     INIT      "#""
IHIVAL17  DIM     10
.QUOTE     INIT      "#""
RCBRAC    INIT    "}"
.
IHIVAL18  DIM     50                           * NIHC IHI Role work variable
IHILAB19  INIT    "#"forced#": #"True#""
IHILAB20  INIT    "#"ClearPatientIHI#":"
.
PROPFLNM  DIM       35
PROPFILE  FILE      ASCII,FIXED=256
PROPLITR  INIT      ".properties"
.
NIHCFLNM  DIM       32
NIHCFILE  FILE      ASCII,FIXED=256
NIHCLITR  INIT      "_nihcihi"
.
NHCPROPF  FILE      ASCII,FIXED=256
NIHCPATH  DIM       120
NHCIFILE  INIT      "webPAS_NIHCIHI.properties"
.
NHCIHIND  DIM       1
.
NHCTRIDF  FILE      ASCII,FIXED=256
TRIDPATH  DIM       120
.
TRIDFILE  DIM       8
TEMPTRID  DIM       24
.
IHICATAI  DIM       3                  * Cat AI Code for an IHI Number
.
NHCEFLNM  DIM       39
NHCEFILE  FILE      ASCII,FIXED=500
NHCELITR  INIT      "_nihcihi_errors"
.
NHCELINE  DIM       500
.
NHCRFLNM  DIM       41
NHCRFILE  FILE      ASCII,FIXED=500
NHCRLITR  INIT      "_nihcihi_response"
.
NHCRLINE  DIM       500
NHCRWORK  DIM       500
.
. NIHC Response Work Variables (From Response Schema)
. ---------------------------------------------------
.
JSONERRM  DIM       500                * NIHCErrorMessage
JSONRECO  DIM       100                * ResponseCode
JSONREDE  DIM       500                * ResponseCodeDescription
JSONREDT  DIM       500                * ResponseCodeDetails
JSONSTAT  DIM       10                 * Status
.
JSONPDOB  DIM       100                * DateOfBirth
JSONFNAM  DIM       100                * FamilyName
JSONGNAM  DIM       100                * GivenName
JSONIHIN  DIM       100                * Ihi Number
JSONIHIV  DIM       100                * IhiLastValidated
JSONIHIR  DIM       100                * IhiRecordStatus
JSONIHIS  DIM       100                * IhiStatus
JSONPSEX  DIM       100                * Sex
JSONAORG  DIM       100                * AlternateOrganisationName
JSONHOSP  DIM       100                * HospitalCode
JSONHOCS  DIM       100                * HospitalCodeSystem
.
. PROGRAM CONSTANTS
. -----------------
.
. Site specific soft font (16602). Change to this when delivery to site
.
ARIAL10N  INIT      "(8U(s1p10.00v0s0b16602T"  * Arial 10pt font/normal
ARIAL10B  INIT      "(8U(s1p10.00v0s3b16602T"  * Arial 10pt font/bold
.
.ARIAL10N  INIT      "(8U(s1p10.00v0s0b0T"     * Time Roman 10pt font/normal
.ARIAL10B  INIT      "(8U(s1p10.00v0s3b0T"     * Time Roman 10pt font/bold
.
HORZT001  INIT      "&a1C"      * tab to column 1
HORZT028  INIT      "&a28C"     * tab to column 28 
HORZT049  INIT      "&a49C"     * tab to column 49 
HORZT050  INIT      "&a50C"     * tab to column 50 
HORZT057  INIT      "&a57C"     * tab to column 57
HORZT082  INIT      "&a82C"     * tab to column 82 
HORZT086  INIT      "&a86C"     * tab to column 86
HORZT099  INIT      "&a99C"     * tab to column 99
HORZT100  INIT      "&a100C"    * tab to column 100
HORZT113  INIT      "&a113C"    * tab to column 113
HORZT141  INIT      "&a141C"    * tab to column 141
HORZT148  INIT      "&a148C"    * tab to column 148
HORZT149  INIT      "&a149C"    * tab to column 149
HORZT155  INIT      "&a155C"    * tab to column 155 
HORZT170  INIT      "&a170C"    * tab to column 170 
.
LINESPAC  INIT      "&l6D"      * line spacing - 6 lines/inch
.
NBARCODE  INIT      "(6U(s0p6.25h18.0v0s-6b0T*"      * Barcode style
.
PRIRESET  INIT      "E"         * printer reset
.
TMARGIN   INIT      "&l1e68F"   * top margin - 1 line
.                                   text length - 68 lines
.
.         Vertical movement is required for the barcode otherwise
.         it will print above the top line of the large labels (verttab1/2)
.
VERTTAB1  INIT      "*p+30Y"    * move 30 PCL units down (for barcode)
VERTTAB2  INIT      "*p-30Y"    * move 30 PCL units up (for barcode)
VERTTAB3  INIT      "*p+5Y"     * move 5  PCL units up (vertical space between
VERTTAB5  INIT      "*p+5Y"     * move 2  PCL units up (vertical space between
CONST1    INIT      "ED  UR"
CONST2    INIT      "A/T"
CONST3    INIT      "GP:"
.--------------------------------------------------------------------------------
NSETBOLD  INIT      "(s0bT"
SETBOLD   INIT      "(s7bT"
.
ALRCOMM   DIM       100
MULTILIN  FORM      1  
.--------------------------------------------------------------------------------
PRGID     INIT      "IHIWEB03"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "NIHC IHI - Polling Response Server"
.--------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
.
          CALL      INIT0000       * Open Files
.
MAIN0000  COMMIT
.
          BEGIN
.
          DISPLAY   *W2
.
          MATCH     "3",PTCNUNET
          GOTO      MAIN0000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
.
          PACK      KEY29,ONE,SP70
          CALL      RSPMNPL5
MAIN1000  CALL      RKPMNPL5
          BRANCH    OVRCD,MAIN9999
.
          MATCH     "1",PMNPRSTA                 * Processed Record?
          GOTO      MAIN9999 IF NOT EQUAL
.
          MATCH     "10",PMNPRTYP
          GOTO      MAIN1000 IF EQUAL
.
          MATCH     SP70,PMNPUNIQ
          GOTO      MAIN1000 IF EQUAL
.
          PACK      KEY53,PMNPHOSP,SP70          * Read B2B Device Table
          CALL      RSPMNDB2
          CALL      RKPMNDB2
          BRANCH    OVRCD,MAIN1000
.
          IF        IBCNMHOS=ONE
            MATCH     PMNPHOSP,PMNBHOSP            * Same Hospital
            GOTO      MAIN1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMNBDPTH
          GOTO      MAIN1000 IF EQUAL
.
          CALL      PROPN000                     * Valid Properties File?
.
          MATCH     "1",NHCIHIND
          GOTO      MAIN1000 IF EQUAL
.
          PACK      KEY8,PMNPURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            MOVE      "patma1af record not found.",NHCELINE
            GOTO      MAIN3500 
          ENDIF
.
          PACK      SAVKEY29,PMNPRSTA,PMNPRDAT,PMNPRTIM,PMNPURNO,PMNPCNTR,SP70
          MOVE      SP70,IHIDUPUR
          MOVE      SP70,PMSIHEIN
          MOVE      SP70,PMSIHESC
.
          OPEN      NHCPROPF,NIHCPATH
.
. Parse _nihcihi file (NIHCIHI Response JSON file)
. **************************************************
.
MAIN2000  CLEAR     CMDLINE
          APPEND    PMNBDPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/nihcihi/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    PMNPUNIQ,CMDLINE
          APPEND    NHCRLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NHCRFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            GOTO      MAIN3000
          ENDIF
.
          CALL      NIHCRS00                   * Parse NIHCIHI Response JSON
.
          GOTO      MAIN8000
.
. Parse _nihcihi_errors file (NIHCIHI Stderrs/Stdout file)
. ******************************************************
.
MAIN3000  CLEAR     CMDLINE
          APPEND    PMNBDPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/nihcihi/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    PMNPUNIQ,CMDLINE
          APPEND    NHCELITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NHCEFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      "Response files not found.",NHCELINE  
            GOTO      MAIN3500
          ENDIF
.
MAIN3100  READ      NHCEFILE,SEQ;NHCELINE
          IF        @OVER
            MOVE      "Refer to NIHCIHI JSON Details.",NHCELINE
            GOTO      MAIN3500 
          ENDIF
.
          SCAN      "error",NHCELINE
          IF        @EQUAL
            GOTO      MAIN3500
          ENDIF
.
          GOTO      MAIN3100
.
MAIN3500  PACK      KEY29,PMNPRSTA,PMNPRDAT,PMNPRTIM,PMNPURNO,PMNPCNTR,SP70
          CALL      RDPMNPL5
.
          MOVE      NHCELINE,PMNPEROR
.
          CALL      IBACLOCK
          PACK      PMNPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPUDAT
          MOVE      CTIMEIS,PMNPUTIM         
          MOVE      PMNPCUID,PMNPUUID
.
          CALL      UPPMNPL5
.
          GOTO      MAIN8000
.
. ******************************************************************************
.
MAIN8000  PACK      KEY29,PMNPRSTA,PMNPRDAT,PMNPRTIM,PMNPURNO,PMNPCNTR,SP70
          CALL      RDPMNPL5
.
          MATCH     "Successful",PMNPEROR
          IF        @EQUAL
            MATCH     SP70,IHIDUPUR
            IF        !@EQUAL
              PACK      DIM80,SP70,SP70
              MOVE      "IHI Exception: Duplicate IHI found in UR Number: ",DIM80
              PACK      PMNPEROR,DIM80,IHIDUPUR,SP70
            ENDIF
          ENDIF
.
          CALL      IBACLOCK
          PACK      PMNPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPUDAT
          MOVE      CTIMEIS,PMNPUTIM
          MOVE      PMNPCUID,PMNPUUID
.
          MOVE      "2",PMNPRSTA
          CALL      UPPMNPL5
.
MAIN9000  CLOSE     NHCPROPF
          CLOSE     NHCRFILE
          CLOSE     NHCEFILE
.
          GOTO      MAIN1000
.
MAIN9999  CLOSE     NHCPROPF
          CLOSE     NHCRFILE
          CLOSE     NHCEFILE
.
          GOTO      MAIN0000
+
.------------------------------------------------------------
.  Parse NIHCIHI Response JSON
.------------------------------------------------------------
.
NIHCRS00  PACK      JSONERRM,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70
          PACK      JSONRECO,SP70,SP70
          PACK      JSONREDE,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70
          PACK      JSONREDT,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70
          MOVE      SP70,JSONSTAT
.
          PACK      JSONPDOB,SP70,SP70
          PACK      JSONFNAM,SP70,SP70
          PACK      JSONGNAM,SP70,SP70
          PACK      JSONIHIN,SP70,SP70
          PACK      JSONIHIV,SP70,SP70
          PACK      JSONIHIR,SP70,SP70
          PACK      JSONIHIS,SP70,SP70
          PACK      JSONPSEX,SP70,SP70
          PACK      JSONAORG,SP70,SP70
          PACK      JSONHOSP,SP70,SP70
          PACK      JSONHOCS,SP70,SP70
.
NIHCRS01  READ      NHCRFILE,SEQ;NHCRLINE
          GOTO      NIHCRS99 IF OVER
.
. ***********************************************************
. <HTML>
. ***********************************************************
.
          SCAN      "<HTML>",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            MOVE      "Refer to NIHCIHI JSON Details.",JSONERRM 
.
          ENDIF
.
. ***********************************************************
. NIHCErrorMessage
. ***********************************************************
.
          SCAN      "#"NIHCErrorMessage#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONERRM
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONERRM
            REP       ", ",JSONERRM
          ENDIF
.
. ***********************************************************
. ResponseCode
. ***********************************************************
.
          SCAN      "#"ResponseCode#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONRECO
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONRECO
            REP       ", ",JSONRECO
          ENDIF
.
. ***********************************************************
. ResponseCodeDescription
. ***********************************************************
.
          SCAN      "#"ResponseCodeDescription#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONREDE
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONREDE
            REP       ", ",JSONREDE
          ENDIF
.
. ***********************************************************
. ResponseCodeDetails
. ***********************************************************
.
          SCAN      "#"ResponseCodeDetails#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONREDT
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONREDT
            REP       ", ",JSONREDT
          ENDIF
.
. ***********************************************************
. Status
. ***********************************************************
.
          SCAN      "#"Status#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONSTAT
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONSTAT
            REP       ", ",JSONSTAT
          ENDIF
.
. ***********************************************************
. DateOfBirth
. ***********************************************************
.
          SCAN      "#"DateOfBirth#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONPDOB
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONPDOB
            REP       ", ",JSONPDOB
          ENDIF
.
. ***********************************************************
. FamilyName
. ***********************************************************
.
          SCAN      "#"FamilyName#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONFNAM
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONFNAM
            REP       ", ",JSONFNAM
          ENDIF
.
. ***********************************************************
. GivenName
. ***********************************************************
.
          SCAN      "#"GivenName#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONGNAM
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONGNAM
            REP       ", ",JSONGNAM
          ENDIF
.
. ***********************************************************
. Ihi
. ***********************************************************
.
          SCAN      "#"Ihi#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONIHIN
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONIHIN
            REP       ", ",JSONIHIN
          ENDIF
.
. ***********************************************************
. IhiLastValidated
. ***********************************************************
.
          SCAN      "#"IhiLastValidated#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONIHIV
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONIHIV
            REP       ", ",JSONIHIV
          ENDIF
.
. ***********************************************************
. IhiRecordStatus
. ***********************************************************
.
          SCAN      "#"IhiRecordStatus#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONIHIR
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONIHIR
            REP       ", ",JSONIHIR
          ENDIF
.
. ***********************************************************
. IhiStatus
. ***********************************************************
.
          SCAN      "#"IhiStatus#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONIHIS
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONIHIS
            REP       ", ",JSONIHIS
          ENDIF
.
. ***********************************************************
. Sex
. ***********************************************************
.
          SCAN      "#"Sex#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONPSEX
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONPSEX
            REP       ", ",JSONPSEX
          ENDIF
.
. ***********************************************************
. AlternateOrganisationName
. ***********************************************************
.
          SCAN      "#"AlternateOrganisationName#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONAORG
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONAORG
            REP       ", ",JSONAORG
          ENDIF
.
. ***********************************************************
. HospitalCode
. ***********************************************************
.
          SCAN      "#"HospitalCode#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONHOSP
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONHOSP
            REP       ", ",JSONHOSP
          ENDIF
.
. ***********************************************************
. HospitalCodeSystem
. ***********************************************************
.
          SCAN      "#"HospitalCodeSystem#"",NHCRLINE
          IF        @EQUAL
            RESET     NHCRLINE
.
            SCAN      ":",NHCRLINE
            IF        @EQUAL
              MOVE      NHCRLINE,NHCRWORK
              REP       ": ",NHCRWORK
              REP       "#" ",NHCRWORK
              LJUSTIFY  NHCRWORK
              MOVE      NHCRWORK,JSONHOCS
              RESET     NHCRLINE
            ENDIF
.
            REP       "#" ",JSONHOCS
            REP       ", ",JSONHOCS
          ENDIF
.
NIHCRS90  GOTO      NIHCRS01
.
.
. Update pmsnplaf - Reponse Description
. -------------------------------------
.
NIHCRS99  PACK      KEY29,PMNPRSTA,PMNPRDAT,PMNPRTIM,PMNPURNO,PMNPCNTR,SP70
          CALL      RDPMNPL5
.
          MATCH     SP70,JSONERRM
          IF        @EQUAL
            PACK      PMNPEROR,JSONSTAT,SP1,JSONREDE
          ELSE
            PACK      PMNPEROR,JSONSTAT,SP1,JSONERRM
          ENDIF
.
          PACK      JSONSTAT,JSONSTAT,SP70
          MATCH     "1         ",JSONSTAT
          IF        @EQUAL
            MATCH     SP70,JSONERRM
            IF        @EQUAL
              MOVE      "Successful",PMNPEROR
            ENDIF
          ENDIF
.
          CALL      IBACLOCK
          PACK      PMNPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPUDAT
          MOVE      CTIMEIS,PMNPUTIM
          MOVE      PMNPCUID,PMNPUUID
.
          CALL      UPPMNPL5
.
.
. Write pmsirsaf - Response Details
. ---------------------------------
.
.         CALL      CLPMSIRS
.
          MOVE      PMNPRTYP,PMISRTYP
          MOVE      PMNPRCOD,PMISCODE
          MOVE      PMNPRDAT,PMISRDAT
          MOVE      PMNPRTIM,PMISRTIM
          MOVE      PMNPCUID,PMISRUID
          MOVE      JSONFNAM,PMISSURN
          MOVE      JSONGNAM,PMISFNAM
.
          MATCH     SP70,JSONPDOB
          IF        !@EQUAL & !@EOS
            UNPACK    JSONPDOB,CCENT,CYEAR,DIM1,CMON,DIM1,CDAY
            PACK      PMISBDAT,CCENT,CYEAR,CMON,CDAY,SP70
          ENDIF
.
          MOVE      JSONPSEX,PMISPSEX
          MOVE      JSONIHIN,PMISIHIN
          MOVE      JSONHOSP,PMISNAME
          MOVE      JSONIHIR,PMISVSTA
          MOVE      JSONIHIS,PMISASTA
          MOVE      JSONHOCS,PMISUNIT
          MOVE      JSONSTAT,PMISRSCD

          MATCH     SP70,JSONERRM
          IF        @EQUAL
            MOVE      JSONREDE,PMISRSDE
          ELSE
            MOVE      JSONERRM,PMISRSDE
          ENDIF
.
          PACK      KEY68,PMISRTYP,PMISCODE,PMISRDAT,PMISRTIM,SP70
          CALL      RAPMIRS1
          IF        OVRCD=1
            CALL      WRPMIRS1
          ENDIF
.
. Write/update pmsihiaf - IHI Details - Get IHI
. ---------------------------------------------
.
          MATCH     "07",PMNPRTYP
          IF        @EQUAL
.
.           MATCH     SP70,JSONIHIN
.           IF        !@EQUAL & !@EOS
.
.             MATCH     "null",JSONIHIN
.             IF        !@EQUAL
.
.               Write pmsiheaf / pmsieraf - Exceptions and Errors Validations
.               -------------------------------------------------------------
.
                CALL      CIHI0000                 * Check IHI edits
                BRANCH    EXIT,NIHCRS9A
.
                MOVE      PMNPURNO,PMIHURNO
                MOVE      JSONIHIN,PMIHIHIN
                MOVE      JSONIHIR,PMIHVSTA
                MOVE      JSONIHIS,PMIHASTA
.
                PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,SP70
                CALL      RDPMIHI1
                IF        OVRCD=0
                  MOVE      PMIHCDAT,GIHICDAT
                  MOVE      PMIHCTIM,GIHICTIM
                  MOVE      PMIHCUID,GIHICUID
                ENDIF
.
                CALL      CLPMSIHI
.
                MOVE      PMNPURNO,PMIHURNO
                MOVE      JSONIHIN,PMIHIHIN
                CALL      IBACLOCK
                PACK      PMIHADAT,CCC,CYY,CMM,CDD
                REP       " 0",PMIHADAT
                MOVE      CTIMEIS,PMIHATIM
                PACK      PMIHEDAT,CCC,CYY,CMM,CDD
                REP       " 0",PMIHEDAT
                MOVE      CTIMEIS,PMIHETIM
                MOVE      JSONIHIR,PMIHVSTA
                MOVE      JSONIHIS,PMIHASTA
.
                MATCH     "1         ",JSONSTAT
                IF        !@EQUAL
.
                  MATCH     "10        ",JSONSTAT
                  IF        @EQUAL 
.
                    MOVE      SP70,SAVEAST1
.
                    SCAN      "retired",JSONERRM
                    IF        @EQUAL
                      MOVE      THREE,SAVEAST1
                      MOVE      ONE,PMIHVSTA
                      MOVE      THREE,PMIHASTA
                      MOVE     "1",PMIEVSTA
                    ENDIF
                    RESET     JSONERRM
.
                    SCAN      "expired",JSONERRM
                    IF        @EQUAL
                      MOVE      FOUR,SAVEAST1
                      MOVE      ONE,PMIHVSTA
                      MOVE      FOUR,PMIHASTA
                      MOVE     "1",PMIEVSTA
                    ENDIF
                    RESET     JSONERRM
.
                    CALL      WRPIHEB0
.
                  ELSE
.
                    MATCH     "1",PMSIHEIN
                    IF        !@EQUAL
                      MOVE      JSONIHIS,SAVEAST1
.
                       MOVE     "1",PMIEVSTA

                       MATCH       "25        ",JSONSTAT      * Unverified
                       IF        @EQUAL
                         MOVE      SP70,PMIEVSTA              * clear ver status
                       ENDIF
. 
                       MATCH       "26        ",JSONSTAT      * Provisional
                       IF        @EQUAL
                       MOVE      SP70,PMIEVSTA                * clear ver status
                       ENDIF

                      CALL      WRPIHEB0 
                    ENDIF
.
                  ENDIF
.
                ENDIF
.
                MOVE      "0",PMIHSTAT
                MOVE      SP70,PMIHOURN
                MOVE      "1",PMIHIHIS
                MOVE      PMNPUNIQ,PMIHMESI
                MOVE      PMNPHOSP,PMIHINTB
                MOVE      PMNPCUID,PMIHNUID
.
                PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,SP70
                CALL      RAPMIHI1
                IF        OVRCD=1
                  PACK      PMIHCDAT,CCC,CYY,CMM,CDD
                  REP       " 0",PMIHCDAT            * Created Date (CCYYMMDD)
                  MOVE      CTIMEIS,PMIHCTIM  * Created Time (HH:MM:SS)
                  MOVE      PMNPCUID,PMIHCUID  * Created By (websecaf)
                  CALL      WRPMIHI1
                ELSE
                  MOVE      GIHICDAT,PMIHCDAT
                  MOVE      GIHICTIM,PMIHCTIM
                  MOVE      GIHICUID,PMIHCUID
.
                  PACK      PMIHUDAT,CCC,CYY,CMM,CDD  * Updated date (CCYYMMDD)
                  REP       " 0",PMIHUDAT
                  MOVE      CTIMEIS,PMIHUTIM  * Updated Time (HH:MM:SS)
                  MOVE      PMNPCUID,PMIHUUID  * Updated By (websecaf)
                  CALL      UPPMIHI1
                ENDIF

.             ENDIF
.           ENDIF
          ENDIF
.
.         Write new pmsnplaf record "07", if original record is an "09"
.         ClearIHI then Auto GetIHI
.         -------------------------------------------------------------
.
NIHCRS9A  MATCH     "09",PMNPRTYP
          IF        @EQUAL
.
            PACK      SAVKEY29,PMNPRSTA,PMNPRDAT,PMNPRTIM,PMNPURNO,PMNPCNTR,SP70
            MOVE      PMNPURNO,SAVEURNO
            MOVE      PMNPHOSP,SAVEHOSP
            MOVE      PMNPRUID,SAVERUID
.
NIHCRS9B    CALL      CLPMSNPL
.
            MOVE      SAVEURNO,PMNPURNO
            MOVE      "   1",PMNPCNTR
            MOVE      SAVEHOSP,PMNPHOSP
            MOVE      "07",PMNPRTYP
            MOVE      SAVERUID,PMNPRUID
            MOVE      "0",PMNPRSTA
            CALL      IBACLOCK
            PACK      PMNPRDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMNPRDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMNPRTIM
            MOVE      PMNPRDAT,PMNPCDAT
            MOVE      PMNPRTIM,PMNPCTIM
            MOVE      PMNPRUID,PMNPCUID
.
            PACK      KEY28,PMNPURNO,PMNPRDAT,PMNPRTIM,PMNPCNTR,SP70
            CALL      RAPMNPL1
            IF        OVRCD=0
              DISPLAY   *W1
              GOTO      NIHCRS9B
            ENDIF
.
            CALL      WRPMNPL1
.
            MOVE      SAVKEY29,KEY29
            CALL      RDPMNPL5
.
          ENDIF
.
.         Delete IHI from pmsaidaf if pmsnplaf request type if "08" or "09"
.         and JSON response status is "1"
.         -----------------------------------------------------------------
.
          MATCH       "08",PMNPRTYP
          GOTO        NIHCRS9C IF EQUAL
.
          MATCH       "09",PMNPRTYP
          GOTO        NIHCRS9C IF EQUAL   
.
          GOTO        NIHCRS9D
.
NIHCRS9C  
.          PACK        JSONIHIN,JSONIHIN,SP70,SP70
.          MATCH       SP70,JSONIHIN
.          GOTO        NIHCRS9D IF EQUAL
.
          PACK        JSONSTAT,JSONSTAT,SP70
          MATCH       "1         ",JSONSTAT
          IF          @EQUAL
.
            CALL        DIHI0000
.
.           Write/update pmsihiaf - IHI Details - Clear IHI
.           -----------------------------------------------
.
            MATCH     SP70,IHIVAL15
            IF        !@EQUAL & !@EOS
.
              CALL      GTIHIN00
.
              CALL      CLPMSIHI
.
              MOVE      PMNPURNO,PMIHURNO
              MOVE      IHIVAL15,PMIHIHIN 
              CALL      IBACLOCK
              PACK      PMIHEDAT,CCC,CYY,CMM,CDD
              REP       " 0",PMIHEDAT
              MOVE      CTIMEIS,PMIHETIM
              MOVE      "1",PMIHSTAT
              MOVE      SP70,PMIHOURN
              MOVE      "1",PMIHIHIS
              MOVE      PMNPUNIQ,PMIHMESI
              MOVE      PMNPHOSP,PMIHINTB
              MOVE      PMNPCUID,PMIHNUID
.
              MOVE      CIHIADAT,PMIHADAT
              MOVE      CIHIATIM,PMIHATIM
              MOVE      CIHIVSTA,PMIHVSTA
              MOVE      CIHIASTA,PMIHASTA 
.
              PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,PMIHEDAT,PMIHETIM,SP70
              CALL      RAPMIHI1
              IF        OVRCD=1
                PACK      PMIHCDAT,CCC,CYY,CMM,CDD
                REP       " 0",PMIHCDAT            * Created Date (CCYYMMDD)
                MOVE      CTIMEIS,PMIHCTIM  * Created Time (HH:MM:SS)
                MOVE      PMNPCUID,PMIHCUID  * Created By (websecaf)
                CALL      WRPMIHI1
              ELSE
                PACK      PMIHUDAT,CCC,CYY,CMM,CDD  * Updated date (CCYYMMDD)
                REP       " 0",PMIHUDAT
                MOVE      CTIMEIS,PMIHUTIM  * Updated Time (HH:MM:SS)
                MOVE      PMNPCUID,PMIHUUID  * Updated By (websecaf)
                CALL      UPPMIHI1
              ENDIF
.
            ENDIF
.
          ELSE
.
            MOVE      JSONIHIS,SAVEAST1
            MOVE      SP70,PMIEVSTA
            CALL      WRPIHEB0
.
          ENDIF
.
NIHCRS9D
.
          RETURN
+
.------------------------------------------------------------
.  Open NIHC IHI Text Files
.------------------------------------------------------------
PROPN000  MOVE      SP70,NHCIHIND
.
          CLEAR     NIHCPATH
          APPEND    PMNBDPTH,NIHCPATH
          RESET     NIHCPATH
          STRIP     NIHCPATH
          ENDSET    NIHCPATH
          APPEND    SLASH,NIHCPATH
          APPEND    NHCIFILE,NIHCPATH
          RESET     NIHCPATH
.
          MOVE      ZERO,NHCIHIND
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NHCPROPF,NIHCPATH
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NHCIHIND
            GOTO      PROPN999
          ENDIF
          CLOSE     NHCPROPF
.
PROPN999  RETURN
+
.----------------------------------------------------------------------
. Find the IHI cat AI code and see if U/R already has an active IHI
.----------------------------------------------------------------------
.
CIHI0000  PACK      KEY5,ANSA,ANSI,SP70
          CALL      RDSCODE1
CIHI1000  CALL      RDKCODE1
          BRANCH    OVRCD,CIHI9000
.
          MATCH     "AI",TCODE              * Cat AI - Alternate id
          GOTO      CIHI9000 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV           * Skip inactive codes
          GOTO      CIHI1000 IF EQUAL
.
          MATCH     ANSI,TCINDC2            * IHI Code
          GOTO      CIHI1000 IF NOT EQUAL
.
          MOVE      ACODE,IHICATAI          * Save cat AI code for an IHI number
.
. Check if U/R already has an active IHI
.
CIHI2000  PACK      KEY31,PURNO,IHICATAI,SP70
          CALL      RSPMAID1
CIHI2100  CALL      RKPMAID1
          BRANCH    OVRCD,CIHI3000
.
          MATCH     PURNO,PMAIURNO          * Same U/R
          GOTO      CIHI3000 IF NOT EQUAL
.
          MATCH     IHICATAI,PMAITYPE       * Alternate Id
          GOTO      CIHI3000 IF NOT EQUAL
.
.         MATCH     "1",PMAIASTA            * IHI Activation Status
.         GOTO      CIHI2100 IF NOT EQUAL
.
          MOVE      JSONIHIN,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI2100 IF EQUAL
.
          PACK      JSONSTAT,JSONSTAT,SP70
          MATCH     "10        ",JSONSTAT
          IF        @EQUAL
            PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
            CALL      RDPMAID1
            IF        OVRCD=0
              CALL      DEPMAID1          * Delete old IHI Number
.
              SCAN      "retired",JSONERRM
              IF        @EQUAL
                MOVE      THREE,PMAIASTA
              ENDIF
              RESET     JSONERRM
.
              SCAN      "expired",JSONERRM
              IF        @EQUAL
                MOVE      FOUR,PMAIASTA
              ENDIF
              RESET     JSONERRM
.
              CALL      WRPIHI00          * Insert Clear/delete record in pmsihi
.              CALL      WRPIHE00          * Insert exception record in pmsiheaf
            ENDIF
.            GOTO      CIHI8000                * Error already has an active IHI
.            GOTO      CIHI9000
             GOTO      CIHI5000
          ELSE
            PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
            CALL      RDPMAID1
            IF        OVRCD=0
              CALL      DEPMAID1          * Delete old IHI Number
.
              MOVE      JSONIHIN,DIM20
              RJUSTIFY  DIM20
.
              MATCH     DIM20,PMAIALID
              IF        !@EQUAL
                MOVE      TWO,PMSIHESC
              ENDIF
.
              MATCH       "27        ",JSONSTAT
              IF        @EQUAL
                MOVE      FIVE,PMAIASTA
              ELSE
                MOVE      JSONIHIS,PMAIASTA
              ENDIF
.
              MATCH       "25        ",JSONSTAT          * Unverified
              IF        @EQUAL
                MOVE      SP70,PMAIVSTA                  * clear ver status
              ENDIF 
.
              MATCH       "26        ",JSONSTAT	         * Provisional
              IF        @EQUAL
                MOVE      SP70,PMAIVSTA                  * clear ver status
              ENDIF
.
              CALL      WRPIHI00          * Insert Clear/delete record in pmsihi
              CALL      WRPIHE00          * Insert exception record in pmsiheaf
              MOVE      ONE,PMSIHEIN
            ENDIF
            GOTO      CIHI5000              * Insert new one returned from NIHC
          ENDIF
.
. Check if IHI is used by another U/R
.
CIHI3000  MOVE      JSONIHIN,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
.
          PACK      KEY31,DIM20,SP70
          CALL      RSPMAID2
CIHI3100  CALL      RKPMAID2
          BRANCH    OVRCD,CIHI4000
.
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI4000 IF NOT EQUAL
.
          MATCH     PURNO,PMAIURNO          * Skip if U/R Number matches
          GOTO      CIHI3100 IF EQUAL
.
          MATCH     "1",PMAIASTA            * IHI Activation Status
          GOTO      CIHI3100 IF NOT EQUAL
.
          GOTO      CIHI8100                * Error IHI used by another U/R
.
CIHI4000  COMPARE   ONE,PCEASE              * Deceased
          GOTO      CIHI5000 IF NOT EQUAL
.
. Check the activation status has not changed for a deceased U/R
.
          PACK      KEY31,PURNO,IHICATAI,SP70
          CALL      RSPMAID1
CIHI4100  CALL      RKPMAID1
          BRANCH    OVRCD,CIHI5000
.
          MATCH     PURNO,PMAIURNO          * Same U/R
          GOTO      CIHI5000 IF NOT EQUAL
.
          MATCH     IHICATAI,PMAITYPE       * Alternate Id
          GOTO      CIHI5000 IF NOT EQUAL
.
          MOVE      JSONIHIN,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI4100 IF NOT EQUAL
.
          MATCH     JSONIHIS,PMAIASTA       * Activation status has not
          GOTO      CIHI5000 IF EQUAL       * changed
.
          MATCH     "1",JSONIHIS            * Write error deceased patient
          GOTO      CIHI8200 IF EQUAL       * had an active IHI returned
.
          MATCH     "2",JSONIHIS            * Deceased so proceed with
          GOTO      CIHI8200 IF EQUAL       * update
.
          MATCH     "3",JSONIHIS            * Retired, update IHI number
          GOTO      CIHI5000 IF EQUAL
.
          MATCH     "4",JSONIHIS            * Write error deceased patient
          GOTO      CIHI8300 IF EQUAL       * had a retired IHI returned
.
. Save or Update the IHI number in the alternate id table
.
CIHI5000  MATCH     SP70,JSONIHIN
          GOTO      CIHI9999 IF EQUAL
.
          MOVE      JSONIHIN,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
.
          MOVE      SP70,SAVEASTA
.
          PACK      KEY31,PURNO,IHICATAI,DIM20,SP70
          CALL      RDPMAID1
          IF        OVRCD=0 
            MOVE      PMAIASTA,SAVEASTA
          ENDIF
.
          MOVE      PURNO,PMAIURNO     * UR Number
          MOVE      IHICATAI,PMAITYPE  * Alternate ID Type (Cat AI)
.          MOVE      JSONIHIN,DIM20          * Right justify IHI
.          RJUSTIFY  DIM20
          MOVE      DIM20,PMAIALID     * Alternate ID
          MOVE      ZERO,PMAIDISU      * Display instead of UR 1=Yes
          MOVE      SP70,PMAIHOSP  * Hospital Code
          MOVE      SP70,PMAIRDAT  * Registration date (ccyymmdd)
.
          CALL      IBACLOCK
.
          MOVE      JSONIHIR,PMAIVSTA  * IHI Verification Status
          MOVE      JSONIHIS,PMAIASTA  * IHI Activation Status
.
          PACK      PMAIADAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIADAT   * IHI Date of Assignment (CCYYMMDD)
          MOVE      CTIMEIS,PMAIATIM  * IHI Time of Assignment (HH:MM:SS)
          MOVE      JSONFNAM,PMAISURN  * IHI Surname
          MOVE      JSONGNAM,PMAIGIVN  * Given Name
          MOVE      SP70,PMAISPAR      * Spare
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD=1
            PACK      PMAICRDT,CCC,CYY,CMM,CDD
            REP       " 0",PMAICRDT      * Date Created
            MOVE      CTIMEIS,PMAICRTM   * Time Created
            MOVE      PMNPCUID,PMAICRUD  * User ID Created
            CALL      WRPMAID1         * Write new IHI Number to alternate ID
          ELSE
            PACK      PMAIUPDT,CCC,CYY,CMM,CDD
            REP       " 0",PMAIUPDT      * Date Updated
            MOVE      CTIMEIS,PMAIUPTM   * Time Updated
            MOVE      PMNPCUID,PMAIUPUD  * User ID Updated
            CALL      UPPMAID1         * Update IHI Number in alternate ID
.
            MATCH     SP70,SAVEASTA
            IF        !@EQUAL
              MATCH     SAVEASTA,PMAIASTA
              IF        !@EQUAL
                MOVE      ONE,PMSIHESC
                CALL      WRPIHE00
              ENDIF
            ENDIF    
.
          ENDIF
.
          IF        PCEASE=1
            MATCH     "3",JSONIHIS            * Write error deceased patient
            GOTO      CIHI8400 IF EQUAL       * returned a retired IHI
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CIHI9999
.
. Write error U/R Already has an active IHI
.
CIHI8000  MOVE      PMNPRTYP,PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,JSONIHIN,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "U/R Already has an active IHI",PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
.   *** Write error IHI number already used by another U/R
.
CIHI8100  MOVE      PURNO,PMIEURNO      * U/R Number
          MOVE      JSONIHIN,PMIEIHIN   * IHI Number
.          MOVE      PMAIURNO,PMIEOTUR   * Other U/R IHI Number Combination
          PACK      PMIEOTUR,PMAIURNO,SP70
          MOVE      PMAIADAT,PMIEADAT   * Date of Assignment (CCYYMMDD)
          MOVE      PMAIATIM,PMIEATIM   * Time of Assignment (HH:MM:SS)
          MOVE      PMAIVSTA,PMIEVSTA   * IHI Verification Status
          MOVE      PMAIASTA,PMIEASTA   * IHI Activation Status
          MOVE      "1",PMIEIHIS        * IHI Source
          MOVE      SP70,PMIEHISV       * HI Service Version Number
          MOVE      PMNPUNIQ,PMIEMESI   * HI Service Message ID
          CALL      IBACLOCK
          PACK      PMIECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIECDAT            * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIECTIM   * Created Time (HH:MM:SS)
.
          MATCH     SP70,PMIEADAT
          IF        @EQUAL | @EOS
            MOVE      PMIECDAT,PMIEADAT
            MOVE      PMIECTIM,PMIEATIM
          ENDIF
.
          MOVE      PMNPCUID,PMIECUID   * Created By (websecaf)
          PACK      PMIEUDAT,CCC,CYY,CMM,CDD    * Updated date (CCYYMMDD)
          REP       " 0",PMIEUDAT
          MOVE      CTIMEIS,PMIEUTIM   * Updated Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIEUUID   * Updated By (websecaf)
          MOVE      SP70,PMIESPAR       * Spare
.
          MOVE      PMIEOTUR,IHIDUPUR
.
          PACK      DIM80,SP70,SP70
          MOVE      "IHI Exception: Duplicate IHI found in UR Number: ",DIM80
          PACK      PMIEDESC,DIM80,IHIDUPUR,SP70
.
          PACK      KEY72,PMIEURNO,PMIEIHIN,PMIEOTUR,PMIEADAT,PMIEATIM,SP70
          CALL      RAPMIHE1
          IF        OVRCD=1
            CALL      WRPMIHE1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had an active IHI returned
.
CIHI8200  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,JSONIHIN,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had an active IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had a expired IHI returned
.
CIHI8300  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,JSONIHIN,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had a expired IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had a retired IHI returned
.
CIHI8400  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,JSONIHIN,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had a retired IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
CIHI9000  MOVE      ONE,EXIT
          GOTO      CIHI9999
.
CIHI9999  RETURN
+
.----------------------------------------------------------------------
. Delete IHI Numbers for that UR
.----------------------------------------------------------------------
DIHI0000  MOVE      SP70,IHIVAL15
.
          PACK      KEY5,ANSA,ANSI,SP70
          CALL      RDSCODE1
DIHI1000  CALL      RDKCODE1
          BRANCH    OVRCD,DIHI9999
.
          MATCH     "AI",TCODE              * Cat AI - Alternate id
          GOTO      DIHI9999 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV           * Skip inactive codes
          GOTO      DIHI1000 IF EQUAL
.
          MATCH     ANSI,TCINDC2            * IHI Code
          GOTO      DIHI1000 IF NOT EQUAL
.
          MOVE      ACODE,IHICATAI          * Save cat AI code for an IHI number
.
. Check if U/R already has an active IHI
.
DIHI2000  PACK      KEY31,PURNO,IHICATAI,SP70
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,DIHI1000
.
          MATCH     PURNO,PMAIURNO          * Same U/R
          GOTO      DIHI1000 IF NOT EQUAL
.
          MATCH     IHICATAI,PMAITYPE       * Alternate Id
          GOTO      DIHI1000 IF NOT EQUAL
.
.         MOVE      JSONIHIN,DIM20          * Right justify IHI
.         RJUSTIFY  DIM20
.         MATCH     PMAIALID,DIM20          * IHI Number matches
.         IF        @EQUAL
            PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
            CALL      RDPMAID1
            IF        OVRCD=0
              MOVE      PMAIALID,DIM20
              LJUSTIFY  DIM20
              MOVE      DIM20,IHIVAL15
              CALL      DEPMAID1
            ENDIF
.         ENDIF
.
.
          GOTO      DIHI2000          
.
DIHI9999  RETURN
+
.------------------------------------------------------------
. Program Initialisation
.------------------------------------------------------------
INIT0000  MOVE      ONE,EMRFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA2,"emrvisaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,EMRFLAG
          ENDIF
          OPEN      EMRCLIA1,"emrcliaf"
.
          OPEN      EMRHISA1,"emrhisaf"
          OPEN      EMRDCMA1,"emrdcmaf"
          OPEN      OBSDETA1,"obsdetaf"                                *I-54627
          OPEN      OBSMDTA1,"obsmdtaf"     * Patient Medical Notes
          OPEN      OBSMTXA1,"obsmtxaf"     * Patient Medical Notes fre

          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRWFMA1,"emrwfmaf"
          OPEN      EMRWFMA2,"emrwfmaf"
          OPEN      EMRWFMA3,"emrwfmaf"
          OPEN      EMRWFMA4,"emrwfmaf"
          OPEN      EMRISMA1,"emrismaf"
          OPEN      EMRINCA1,"emrincaf"
          OPEN      EMRINCA2,"emrincaf"
          OPEN      EMRINCA3,"emrincaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRVCDA2,"emrvcdaf"                               *I-215117
          OPEN      EMRMTXA3,"emrmtxaf"
.
          OPEN      EMRUNKA1,"emrunkaf"
          OPEN      EMRLPCA1,"emrlpcaf"
          OPEN      EMRLOCA1,"emrlocaf"
          OPEN      EMRPROA1,"emrproaf"                                *I-50421
          OPEN      EMRSITA1,"emrsitaf"
.
          OPEN      OPRNURA1,"oprnuraf"                   
          OPEN      PATALRT1,"patalrtf"                                *I-54627
          OPEN      PATALTT1,"pataltaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PMSMDTA1,"pmsmdtaf"
          OPEN      PMSALNA1,"pmsalnaf"
          OPEN      PMSMDTA1,"pmsmdtaf"
          OPEN      PMSMTXA1,"pmsmtxaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSAIDA2,"pmsaidaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATVISA1,"patvisaf"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATITEM1,"patitemn"                                *I-50421
          OPEN      PATICDO1,"paticdof"                                *I-50421
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PMSVX1A1,"pmsvx1af"                                *I-55214
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PRIITEM1,"priitemf"
          OPEN      VISCODA1,"viscodaf"
          OPEN      VISMDTA1,"vismdtaf"
.
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IHAPASS1,"ihapassf"
          OPEN      IBACODE1,"ibacodef"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      WEBSECA3,"websecaf"
.
          OPEN      SCRSBGA1,"scrsbgaf"
          OPEN      SCRPSTA1,"scrpstaf"
          OPEN      SCRMASA1,"scrmasaf"
          OPEN      PATHGRP1,"pathgrpf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWO;*182,CSNAME                           *I-54627
.
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,THIRTY;*89,HELPAGE,*90,HELPRNT,HELSIZE
.
          READ      CONTROLF,FIFTY9;*132,CALRDESC
          READ      CONTROLF,SEVENTY8;*64,AECNLABL
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,EIGHTY9;*138,EMCNICDF                     *I-50421
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND22;*8,EMCNURSE
          READ      CONTROLF,HUND29;*1,PTCNWSDR,*61,PTCNWSIN,*62,PTCNRKDY:
                                    *68,PTCNTKMN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          IF        EMCNICDF=0
              OPEN      PATICDD1,"paticddf"
              OPEN      PATICDD2,"paticddf"
              OPEN      PATI10D1,"pati10df"
              OPEN      PATI10D2,"pati10df"
          ELSE
              OPEN      EMRICDA1,"emricdaf"
              OPEN      EMRICDA2,"emricdaf"
              OPEN      EMRICDA3,"emricdaf"
          ENDIF
.
          OPEN      PMSIHIA1,"pmsihiaf"     * IHI Details
          OPEN      PMSIHIA2,"pmsihiaf"
.
          MOVE      ZERO,VISXDCIN
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      VISXDCA1,"visxdcaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,VISXDCIN
          ENDIF
.
. **** WebServices ****
.
          OPEN      WEBB2BA1,"webb2baf"
          OPEN      WEBB2BA2,"webb2baf"
          OPEN      WEBB2BA3,"webb2baf"
.
          OPEN      WEBOPVA1,"webopvaf"
          OPEN      WEBOPVA2,"webopvaf"
          OPEN      WEBOPVA3,"webopvaf"
          OPEN      WEBOPVA4,"webopvaf"
.
. **** NIHC IHI ****
.
          OPEN      PMSNDBA1,"pmsndbaf"
          OPEN      PMSNDBA2,"pmsndbaf"
          OPEN      PMSNPLA1,"pmsnplaf"
          OPEN      PMSNPLA2,"pmsnplaf"
          OPEN      PMSNPLA5,"pmsnplaf"
          OPEN      PMSIRQA1,"pmsirqaf"
          OPEN      PMSIRSA1,"pmsirsaf"
          OPEN      PMSIHEA1,"pmsiheaf"
          OPEN      PMSIERA1,"pmsieraf"
.
          RETURN
+
.--------------------------------------------------------------------------
. Get Last GetIHI information to put into the Clear IHI record for pmsihiaf
.--------------------------------------------------------------------------
GTIHIN00  MOVE      SP70,CIHIADAT
          MOVE      SP70,CIHIATIM
          MOVE      SP70,CIHIVSTA
          MOVE      SP70,CIHIASTA
.
          PACK      DIM20,IHIVAL15,SP70
.
          PACK      KEY62,PMNPURNO,DIM20,Z70
          CALL      RSPMIHI2
GTIHIN50  CALL      RPPMIHI2
          BRANCH    OVRCD,GTIHIN99
.
          MATCH     PMNPURNO,PMIHURNO
          GOTO      GTIHIN99 IF NOT EQUAL
.
          MATCH     DIM20,PMIHIHIN
          GOTO      GTIHIN99 IF NOT EQUAL
.
          MATCH     SP70,PMIHADAT
          GOTO      GTIHIN50 IF EQUAL
          GOTO      GTIHIN50 IF EOS
.
          MOVE      PMIHADAT,CIHIADAT
          MOVE      PMIHATIM,CIHIATIM
          MOVE      PMIHVSTA,CIHIVSTA
          MOVE      PMIHASTA,CIHIASTA          
.
GTIHIN99  RETURN
+
.--------------------------------------------------------------------------
. Insert Clear/Delete record in pmsihiaf - for different IHI retured / 
.                                          no IHI found in HI service
.--------------------------------------------------------------------------
WRPIHI00      CALL      CLPMSIHI
.
              MOVE      PMNPURNO,PMIHURNO
              MOVE      PMAIALID,PMIHIHIN
              LJUSTIFY  PMIHIHIN
              PACK      PMIHIHIN,PMIHIHIN,SP70
              CALL      IBACLOCK
              PACK      PMIHEDAT,CCC,CYY,CMM,CDD
              REP       " 0",PMIHEDAT
              MOVE      CTIMEIS,PMIHETIM
              MOVE      "1",PMIHSTAT
              MOVE      SP70,PMIHOURN
              MOVE      "1",PMIHIHIS
              MOVE      PMNPUNIQ,PMIHMESI
              MOVE      PMNPHOSP,PMIHINTB
              MOVE      PMNPCUID,PMIHNUID
.
              MOVE      PMAIADAT,PMIHADAT
              MOVE      PMAIATIM,PMIHATIM
              MOVE      PMAIVSTA,PMIHVSTA
              MOVE      PMAIASTA,PMIHASTA
.
              PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,PMIHEDAT,PMIHETIM,SP70
              CALL      RAPMIHI1
              IF        OVRCD=1
                PACK      PMIHCDAT,CCC,CYY,CMM,CDD
                REP       " 0",PMIHCDAT            * Created Date (CCYYMMDD)
                MOVE      CTIMEIS,PMIHCTIM  * Created Time (HH:MM:SS)
                MOVE      PMNPCUID,PMIHCUID  * Created By (websecaf)
                CALL      WRPMIHI1
              ELSE
                PACK      PMIHUDAT,CCC,CYY,CMM,CDD  * Updated date (CCYYMMDD)
                REP       " 0",PMIHUDAT
                MOVE      CTIMEIS,PMIHUTIM  * Updated Time (HH:MM:SS)
                MOVE      PMNPCUID,PMIHUUID  * Updated By (websecaf)
                CALL      UPPMIHI1
              ENDIF
.
WRPIHI99  RETURN
+
.--------------------------------------------------------------------------
. Insert Exception record in pmsiheaf for different IHI returned
.--------------------------------------------------------------------------
WRPIHE00  MOVE      PMNPURNO,PMIEURNO      * U/R Number
          MOVE      JSONIHIN,PMIEIHIN   * IHI Number
.          MOVE      PMAIURNO,PMIEOTUR   * Other U/R IHI Number Combination
          PACK      PMIEOTUR,PMAIURNO,PMAIALID,SP70
          MOVE      PMAIADAT,PMIEADAT   * Date of Assignment (CCYYMMDD)
          MOVE      PMAIATIM,PMIEATIM   * Time of Assignment (HH:MM:SS)
          MOVE      PMAIVSTA,PMIEVSTA   * IHI Verification Status
          MOVE      PMAIASTA,PMIEASTA   * IHI Activation Status
          MOVE      "1",PMIEIHIS        * IHI Source
          MOVE      SP70,PMIEHISV       * HI Service Version Number
          MOVE      PMNPUNIQ,PMIEMESI   * HI Service Message ID
          CALL      IBACLOCK
          PACK      PMIECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIECDAT            * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIECTIM   * Created Time (HH:MM:SS)
.
          MATCH     SP70,PMIEADAT
          IF        @EQUAL | @EOS
            MOVE      PMIECDAT,PMIEADAT
            MOVE      PMIECTIM,PMIEATIM
          ENDIF
.
          MOVE      PMNPCUID,PMIECUID   * Created By (websecaf)
.          PACK      PMIEUDAT,CCC,CYY,CMM,CDD    * Updated date (CCYYMMDD)
.          REP       " 0",PMIEUDAT
.          MOVE      CTIMEIS,PMIEUTIM   * Updated Time (HH:MM:SS)
.          MOVE      "iba9",PMIEUUID   * Updated By (websecaf)
          MOVE      SP70,PMIESPAR       * Spare
.
          MATCH     "1",PMSIHESC
          IF        @EQUAL
            MOVE      "1 IHI Status Change",PMIEDESC
          ELSE
            MATCH     "2",PMSIHESC
            IF        @EQUAL
              MOVE      "1 Different IHI Number Returned",PMIEDESC
            ELSE
              MATCH     SP70,JSONERRM
              IF        @EQUAL
                PACK      PMIEDESC,JSONSTAT,SP1,JSONREDE
              ELSE
                PACK      PMIEDESC,JSONSTAT,SP1,JSONERRM
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY72,PMIEURNO,PMIEIHIN,PMIEOTUR,PMIEADAT,PMIEATIM,SP70
          CALL      RAPMIHE1
          IF        OVRCD=1
            CALL      WRPMIHE1
          ENDIF
WRPIHE99  RETURN
+
.---------------------------------------------------------------------------
. Insert Exception record in pmsiheaf (pass in Activation Status - SAVEAST1)
.---------------------------------------------------------------------------
WRPIHEB0  MOVE      PMNPURNO,PMIEURNO      * U/R Number
          MOVE      JSONIHIN,PMIEIHIN   * IHI Number
          MOVE      SP70,PMIEOTUR   * Other U/R IHI Number Combination
.          MOVE      PMIHADAT,PMIEADAT   * Date of Assignment (CCYYMMDD)
.          MOVE      PMIHATIM,PMIEATIM   * Time of Assignment (HH:MM:SS)
.          MOVE      "1",PMIEVSTA   * IHI Verification Status
          MOVE      SAVEAST1,PMIEASTA   * IHI Activation Status
          MOVE      "1",PMIEIHIS        * IHI Source
          MOVE      SP70,PMIEHISV       * HI Service Version Number
          MOVE      PMNPUNIQ,PMIEMESI   * HI Service Message ID
          CALL      IBACLOCK
          PACK      PMIECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIECDAT            * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIECTIM   * Created Time (HH:MM:SS)
          MOVE      PMNPCUID,PMIECUID   * Created By (websecaf)
.
.          MATCH     SP70,PMIEADAT
.          IF        @EQUAL | @EOS
            MOVE      PMIECDAT,PMIEADAT
            MOVE      PMIECTIM,PMIEATIM
.          ENDIF
.
          MOVE      SP70,PMIESPAR       * Spare
.
          MATCH     SP70,JSONERRM
          IF        @EQUAL
            PACK      PMIEDESC,JSONSTAT,SP1,JSONREDE
          ELSE
            PACK      PMIEDESC,JSONSTAT,SP1,JSONERRM
          ENDIF
.
          PACK      KEY72,PMIEURNO,PMIEIHIN,PMIEOTUR,PMIEADAT,PMIEATIM,SP70
          CALL      RAPMIHE1
          IF        OVRCD=1
            CALL      WRPMIHE1
          ENDIF
WRPIHEB9  RETURN
+
.---------------------------------------------------------------
. Clear Parameters (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
CLRPAR00  RETURN 
.---------------------------------------------------------------
. Set Parameters   (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
SETPAR00  RETURN
.---------------------------------------------------------------
. Process Fields   (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
PROFLD00  RETURN
.------------------------------------------------------------
+
          INC       IBAWEBCD
.
          INC       CLPMSVX1
          INC       CLPMSNPL
          INC       CLPMSIRS
          INC       CLPMSIHI
          INC       DXPATCOD
          INC       GCCARD00
          INC       GTIHINUM
          INC       NAMSTRCD
          INC       WEBDITEM
          INC       WEBBGRND
.
          INC       APSMASIO/INC
          INC       EMRCHMAN
          INC       EMRLPCIO/INC
          INC       EMRLOCIO/INC
          INC       EMRSITIO/INC
          INC       EMRVISIO/INC
          INC       EMRCLIIO/INC
          INC       EMRGRCIO/INC
          INC       EMRPROIO/INC                                       *I-50421
          INC       EMRUNKIO/INC
          INC       IBATMDIO/INC
          INC       MEHDLSIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       PATGO1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       AAEDE1IO/INC    *****
          INC       PATALRIO/INC
          INC       PMSALNIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM 
          INC       AAESETLB        *****
          INC       OPRNURIO/INC
          INC       PRIITMIO/INC
          INC       PATITMIO/INC                                       *I-50421
          INC       PATICOIO/INC                                       *I-50421
          INC       PATICDIO/INC                                       *I-50421
          INC       PATNIDIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC                                       *I-55214
          INC       PATDO1IO/INC
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC
          INC       PMSCCDIO/INC
          INC       PMSCEXIO/INC
          INC       PMSIHIIO/INC
          INC       PMSMDTIO/INC
          INC       PMSMTXIO/INC
          INC       PMSPX2IO/INC
          INC       PMSNDBIO/INC
          INC       PMSNPLIO/INC
          INC       PMSIRQIO/INC
          INC       PMSIRSIO/INC
          INC       PMSIHEIO/INC
          INC       PMSIERIO/INC
          INC       PATFN1IO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PMSAIDIO/INC
          INC       PATRE1IO/INC
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC 
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PATVADIO/INC
.
          INC       PATATRIO/INC
          INC       MULBIR00
.
          INC       SCRPSTIO/INC
          INC       SCRSBGIO/INC
          INC       SCRSLTIO/INC
          INC       SCRMASIO/INC

.
          INC       EOCLNKIO/INC
          INC       EOCREFIO/INC
          INC       EMRISMIO/INC
          INC       EMRINCIO/INC
          INC       EMRWFMIO/INC
          INC       EMRVCDIO/INC
          INC       EMRMTXIO/INC
          INC       EMRVPRIO/INC
          INC       VISCMTIO/INC
          INC       VISCODIO/INC
          INC       VISMTXIO/INC
          INC       VISMDTIO/INC
          INC       VISXDCIO/INC
          INC       EMRMANIO/INC
          INC       OBSDETIO/INC                                       *I-54627
          INC       OBSMTXIO/INC
          INC       OBSMDTIO/INC
          INC       EMRDCMIO/INC   
          INC       EMRHISIO/INC 
          INC       EMRICDIO/INC 
          INC       PATHGPIO/INC
          INC       WEBB2BIO/INC
          INC       WEBOPVIO/INC

          INC       PATDOCTM
          INC       PATITMRD
.
          INC       PACADDRS
          INC       PMIGTNID
          INC       PMSCEXCD
          INC       CALCAGE
          INC       CALCYRS
          INC       AGECHK
          INC       PATDOCCD
          INC       CLPATMAS
          INC       CLPMSCEX
          INC       CLPMSHCP
          INC       CLPMSPX2
          INC       CLEMRVIS                                          *I-153218
          INC       CLPATVIS                                          *I-153218
          INC       DAYOFWEK
          INC       SGCHKDIG
          INC       GETALTID
          INC       TFILENAM
.
