.******************************************************************************
.* System   :  OUTPATIENTS                                                    *
.* Program  :  IBAOUT71                                                       *
.* Desc     :  ADHOC LETTER PRINTING                                          *
.******************************************************************************
.* Date     :  31/07/90                                                       *
.* Author   :  Paul Duncan                                                    *
.* Comment  :                                                                 *
.* Mod's    :                                                                 *
.*                                                                            *
.******************************************************************************
.* V12.00.02 05/09/2025  Thanh T        TSK 0949457                           *
.*           Recompiled for OUTLVLET/OUTPLTCD changes                         *
.* V12.00.01 16/05/2025  Ebon Clements  TSK 0955096                           *
.*           Alphanueric visit number changes                                 *
.* V11.04.06 05/08/2024  Ebon Clements  TSK 0893817                           *
.*           Recompiled for OUTPLTCD                                          *
.* V11.04.05 22/07/2024  Thanh T        TSK 0939648                           *
.*           Recompiled for OUTPLTCD changes                                  *
.* V11.04.04 15/04/2024  Sunny          TSK 0893817                           *
.*           Recompiled for OUTPLTCD                                          *
.* V11.04.03 28/11/2023  Peter Vela     TSK 0935874                           *
.*           Recompiled for OUTPLTCD - Added validation for PTCNUNET = 3      *
.* V11.04.02 14/11/2023  Sunny          TSK 0893817                           *
.*           Recompiled for OUTPLTCD                                          *
.* V11.04.01 24/11/2023  Ebon Clements  TSK 0940232                           *
.*           Check all hospital access after printed by keyin                 *
.*           KPID0000 - ALHSPA00                                              *
.* V11.03.01 15/08/2023  Don Nguyen       TSK 0935736                         *
.*           Recompiled for SMSPRXML - Skip inactive extra contacts for SMS   *
.* V11.02.02 04/04/2022  Sunny          TSK 0899125                           *
.*           Recompiled for OUTLVLET                                          *
.* V11.02.01 09/02/2022  Thanh T        TSK 0905641                           *
.*           Recompiled as OUTHEDFD/OUTMA1FD changes                          *
.* V11.01.03 27/09/2021  Sunny          TSK 0893817                           *
.*           Recompiled for OUTLVLET and OUTPLTCD - Added %ogpcdes            *
.* V11.01.02 13/07/2021  Sunny          TSK 0893817                           * 
.*           Recompiled for OUTLVLET and OUTPLTCD - Added %systype            * 
.* V11.01.01 02/07/2021  Ebon Clements    TSK 0900650                         *
.*           Recompiled for SMSPRXML                                          *
.* V11.00.09 17/12/2020  Ebon Clements    TSK 0900728                         *
.*           Recompiled for OUTLVLET and OUTPLTCD - Rescheduled from day var  *
.* V11.00.08 04/11/2020  Ebon Clements    TSK 0897862                         *
.*           Fixed save and load of clinic type description OTLACTYP          *
.*           LDTM0000 and LOAD9999                                            *
.* V11.00.07 09/09/2020  Tracey Nguyen    TSK 0888555                         *
.*           Modified 'Send Clinic SMS' (Option 8) to use Visit Type (code)   *
.*           array values to filter instead of Visit Type (code) range.       *
.*           (similar to task 0868740)                                        *
.*           1)Added VTYPEARR,VTYPEKEY,VTYPESIZ,VTYPECNT,CHKVTYPE, CHVTYP00   *
.*           2)Modified VIST0000, BOKA0000,RSHD0000,CANC0000                  *
.* V11.00.06 16/07/2020  Tracey Nguyen    TSK 0893621                         *
.*           Recompiled for OUTLVLET/OUTPLTCD                                 *
.*            - Added %smsusrnm (LCCSMSUN/LXXSMSUN)                           *
.* V11.00.05 03/06/2020 Ebon Clements   TSK 0888555                           *
.*           Added read of outbokaf in SET0000 and SETV0000                   *
.* V11.00.04 15/04/2020 Thanh T         TSK 0879163                           *
.*           Added SEXDSP00                                                   *
.* V11.00.03 20/03/2020  Peter Vela     TSK 0889143                           *
.*           Fixed OUTLET IO calls                                            *
.* V11.00.02 18/03/2020  Peter Vela     TSK 0889143                           *
.*           Recompiled for OUTLETFD                                          *
.* V11.00.01 10/03/2020  Jill Parkinson Task 0879163                          *
.*           Added SEXDSCIO include                                           *
.******************************************************************************
.* V10.15.04 07/02/2020  Ebon Clements     TSK 0887235                        *
.*           Recompiled for PMSCEXCD - extra contact postal address           *
.* V10.15.03 05/12/2019  Thanh T           TSK 0885188                        *
.*           Added STAR30                                                     * 
.* V10.15.02 29/10/2019  Ebon Clements     TSK 0861253                        *
.*           Added PRNTLONG print long line functionality for telehealth      *
.* V10.15.01 14/10/2019  Richa Phogat      TSK 0861253                        *
.*           Added OUTTHIFD/OUTTHIIO, CODEOM                                  * 
.* V10.14.11 28/08/2019  Thanh T.          TSK 0877294i                       *
.*           Changed TIME0000 to fix the issue when the Hour is 00:MM, it     *
.*           should show as 12:MM AM and not 0:MM AM.                         * 
.* V10.14.10 02/08/2019  Thanh T.       TSK 0867186                           *
.*           Changed BOKA4000 to process only rows which the user has         *
.*           hospital access in multi hospital mode                           *
.* V10.14.09 01/08/2019  Don Nguyen     TSK 0870988 / 0874819                 *
.*           Fixed issue where letter (SMS) was not being printed due to      *
.*           erroneous exit condition triggered by Clinic Type validation;    *
.*           Removed EXIT condition from EXTR0000 and subsequent BRANCH call. *
.*           Simplified code to locate starting Clinic Code (ECLF4000).       *
.*           Added missing IDDD to KEY20 at CLIN5200 for Clinic (CLRANTO) read*
.* V10.14.08 25/07/2019  Sunny            TSK 0877616                         *
.*           Recompiled for OTBBSRVD - Service delievery description          * 
.* V10.14.07 09/07/2019  Thanh T.       TSK 0867186                           *
.*           Added HOSP0000 for hospital selection in multi hospital mode     *
.* V10.14.06 09/07/2019  Don Nguyen     TSK 0870988 / 0874819                 *
.*           Re-worked code to loop through ALL clinics (ECLF4000) when       *
.*           Clinic From Range is blank.                                      *
.*           Added checks for null Generate Letter Date range.                *
.*           Added validation for Clinic Type count keyin value (numeric).    *
.* V10.14.05 04/06/2019  Nicole Torrisi    TSK 0870873                        *
.*           Recompiled for OUTPLTCD and OUTLVLET                             *
.* V10.14.04 10/04/2019  Jill Parkinson TSK 0856017                           *
.*           Corrected code at ML73100 and ML8339 to check if sending an SMS  *
.* V10.14.03 29/03/2019  Don Nguyen     TSK 0872256 / 0870988                 *
.*           Fixed 'Failed PID' web error by changing the order of processing *
.*           to take in the Letter ID selection and User ID (printed by)      *
.*           before data extraction (ML6500).                                 *
.* V10.14.02 28/03/2019  Don Nguyen     TSK 0872256 / 0870988                 *
.*           Added check for SMS letter type when extracting data (EXTR0000)  *
.*           to prevent a blank date range (and sending out old SMS's).       *
.*           Added check for execution source (web) to prevent the use of     *
.*           user login Outpatient Site Code (IDDD) to validate Clinic Code.  *
.* V10.14.01 12/03/2019  Nicole Torrisi TSK 0870242                           *
.*           Recompiled for OUTPLTCD                                          *
.*----------------------------------------------------------------------------*
.* V10.13.02 16/01/2019  Don Nguyen     TSK 0868740                           *
.*           Modified 'Send Clinic SMS' (Option 8) to use Clinic Type (code)  *
.*           array values to filter instead of Clinic Type (code) range.      *
.* V10.13.01 08/10/2018  Ebon Clements  TSK 0856017                           *
.*           Set generate letter date from/to to SP70/ZEDS in KSID0000        *
.* V10.11.04 27/11/2017  Thanh T.       TSK 0821710                           *
.*           Recompiled as PATMISTD changed                                   *
.* V10.11.03 28/08/2017  Thanh T.       TSK 0821710                           *
.*           Recomp for OUTPLTCD                                              *
.* V10.11.02 11/08/2017  Ania P         TSK 0843055                           *
.*           Recomp for OUTPLTCD                                              *
.* V10.11.01 17/07/2017  Ebon Clements  TSK 0817112                           *
.*           Recompiled for OUTPLTCD - Linked referral referring GP           *
.******************************************************************************
.* V10.10.02 25/05/2017  Richa Phogat   TSK 0830804                           *
.*           Recompile for OUTPLTCD - Service Delivery Mode                   *
.* V10.10.01 23/03/2017  Thanh T.          TSK 0832066                        *
.*           Changed DVA PREPAT/PMPXDVAC fields to use the new                *
.*           concession card PMCDCNUM/PMCDDVAC fields                         * 
.* V10.08.06 20/09/2016  Ebon Clements     TSK 0823657                        *
.*           Recompile for OUTPLTCD - SMS letter type                         *
.* V10.08.05 16/09/2016  Ebon Clements     TSK 0823657                        *
.*           Recompiled for OUTPLTCD - hospital name                          *
.* V10.08.04 15/09/2016  Don Nguyen        TSK 0294154                        *
.*           Recompiled for SMSPRXML & OUTPLTCD                               *
.*           14/09/2016  Ebon Clements     TSK 0294154                        *
.*           Added CONTTYPS                                                   *
.*           Changed Z70 test to Z10 for generate letter to date - DGLRANTO   *
.* V10.08.03 23/08/2016  Peter Vela        TSK 0822268                        *
.*           Recompiled for OUTPLTCD                                          *
.* V10.08.02 25/07/2016  Don Nguyen        TSK 0294154                        *
.*           Added SMSPRXML - print XML metatags for SMS (PRIN0000).          *
.*           Recompiled for changes to OUTPLTCD.                              *
.* V10.08.01 07/06/2016  Jill Parkinson    TSK 0820003                        *
.*           Recompiled for PMSCEXCD - allow patmx1af/patma1af details        *
.* V10.07.05 11/01/2016  Ebon Clements     TSK 0294154                        *
.*           Added opt 8 send clinic SMS                                      *
.* V10.07.04 11/01/2016  Ebon Clements     TSK 0294154                        *
.*           Added opt out of SMS to option 5                                 *
.* V10.07.03 06/01/2016  Ebon Clements     TSK 0294154                        *
.*           Added SMS functionality option 7                                 *
.* V10.07.02 23/12/2015  Peter Vela        CAR 0324687                        *
.*           Recompiled for OUTPLTCD                                          *
.* V10.07.01 04/11/2015  Ebon Clements     CAR 268970                         *
.*           Change to use OUTCLIFD index 1 instead of index 2                *
.* V10.06.01 21/09/2015  Davin             CAR 313906                         *
.*           Recompiled for PMSCEXCD - allow patmx1af/patma1af details        *
.* V10.05.01 17/12/2014  Ebon Clements     CAR 261630                         *
.*           Removed port number from temp file name                          *
.* V10.03.10 12/11/2013  Davin             CAR 292499                         *
.*           Recompiled for changes to OUTLVLET, OUTPLTCD                     *
.* V10.03.09 05/07/2013  Don Nguyen        CAR 287965                         *
.*           Recompiled for changes to OUTPLTCD                               *
.* V10.03.08 02/07/2013 Peter Vela         CAR 286022                         *
.*           Recompiled for OUTPLTCD                                          *
.* V10.03.07 18/04/2013 Ania P             CAR 281663                         *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V10.03.06 03/12/2012  Peter Vela        CAR 262297                         *
.*           Recompiled for OUTLVLET, OUTPLTCD                                *
.* V10.03.05 17/10/2012  Jill Parkinson    CAR 273375                         *
.*           Recompiled for DATECONV - first day of year calculation          *
.* V10.03.04 05/09/2012  Peter Vela        CAR 271262                         *
.*           Initialised SITE variable before call to GOTP0000                *
.* V10.03.03 10/09/2011  Peter McMullen    CAR 259587                         *
.*           Remove all references to redundant file patyears                 *
.* V10.03.02 30/01/2012  Davin             CAR 257512                         *
.*           Recompiled for changes to OUTLVLET, OUTPLTCD                     *
.* V10.03.01 10/11/2011  Ebon Clements     CAR 248529                         *
.*           Added multiple contacts of the same type functionality           *
.* V10.02.05 20/09/2011  Davin             CAR 248749                         *
.*           Recompiled for changes to OUTLVLET, OUTPLTCD                     *
.* V10.02.04 10/09/2011  Peter McMullen    CAR 248749                         *
.*           Recompiled for changes to OUTLVLET, OUTPLTCD                     *
.* V10.02.03 22/06/2011  Steve Armstrong   CAR 240722                         *
.*           Recompiled for changes to PMSCEXCD                               *
.* V10.02.02 07/06/2011 Ebon Clements    CAR 239530                           *
.*           Added print extra contact functionality                          *
.* V10.02.01 30/05/2011  Ebon Clements    CAR 239552                          *
.*           Added printed by to OP letter history and option 6 clinic letters*
.* V9.11.02  11/11/2008  Steve Armstrong  CAR 179910                          *
.*           Recompiled for changes to OUTPLTCD.                              *
.* V9.11.01  31/10/2008 Sandra Barcham CAR 178932                             *
.*           Recompiled for OUTLVLET - Extend carer name from 20 to 60 chars  *
.******************************************************************************
.* V9.09.04  07/03/2008  Jill Habasque CAR 163399                             *
.*           Recompiled for OUTPLTCD                                          *
.* V9.09.03  29/01/2008  Ebon Clements CAR 139569                             *
.*           Recompiled for OUTLVLET -  Print Reg. GP Practice details        *
.* V9.09.02  24/10/2007  Mike Laming   CAR 131844                             *
.*           Recompiled for OUTLVLET and OUTPLTDF                             *
.* V9.09.01  24/10/2007  Mike Laming   CAR 131844                             *
.*           Recompiled for OUTLVLET and OUTPLTCD 
.******************************************************************************
.* V9.07.03  01/09/2006  Peter Vela    CAR 114297                             *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.07.02  25/07/2006  Ebon Clements CAR 998990                             *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.07.01  21/06/2006  Peter Vela    CAR 108110                             *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.******************************************************************************
.* V9.06.04  31/05/2006  Peter Vela    CAR 106057                             *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.*           Added PMSRELFD and PMSRELIO                                      *
.* V9.06.03  30/05/2006  Peter Vela    CAR 104807                             *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.06.02  23/05/2006  Ebon Clements CAR 79277                              *
.*           Print postal/pmi address on carer label if carer details blank   *
.* V9.06.01  27/04/2006  Peter Vela      CAR 102166                           *
.*           Recompiled for OUTPLTCD - Changed title code to title description*
.******************************************************************************
.* V9.05.02  30/03/2006  Peter Vela      CAR 85995                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.05.01  28/03/2006  Ebon Clements   CAR 79277                            *
.*           Added carer contact details                                      *
.******************************************************************************
.* V9.04.16  07/11/2005  Ebon Clements   CAR 72172                            *
.*           Added SVCQ0000 to set values for outbokaf variables used         *
.*           in LETEXE00                                                      *
.* V9.04.15  03/11/2005  Peter Vela      CAR 79842                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.04.14  18/10/2005  Peter Vela      CAR 80192                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.04.13  07/10/2005  Peter Vela      CAR 79300                            *
.*           Added open of outcanaf                                           *
.* V9.04.12  01/09/2005  Peter Vela      CAR 62749                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.04.11  29/07/2005  Peter Vela      CAR 63400                            *
.*           Fixed branch in OPTN0000                                         *
.* V9.04.10  28/06/2005  Jill Habasque   CAR 63400                            *
.*           Fixed index for outladaf                                         *
.* V9.04.09  17/06/2005  Peter Vela      CAR 63400                            *
.*           Changed LOAD0000 OSTSITE to SITE                                 *
.* V9.04.08  16/06/2005  Peter Vela      CAR 63400                            *
.*           Put back options 2,3 and 4                                       *
.*           Put back KSID0000                                                 *
.*           Put back DELT0000                                                 *
.*           Put back SETV0000                                                 *
.* V9.04.07  14/06/2005  Peter Vela      CAR 58732                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.*           09/06/2005  Peter Vela      CAR 62622                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.04.06  27/04/2005  Peter Vela      CAR 57513                            *
.*           Recompiled for OUTPLTCD                                          *
.* V9.04.05  29/03/2005  Peter Vela      CAR 59546                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.*           17/03/2005  Peter Vela      CAR 59283                            *
.*           Added open to outrf1af                                           *
.* V9.04.04  23/03/2005  Peter Vela      CAR 59618                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.*           23/03/2005  Peter Vela      CAR 57244                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.*           23/03/2005  Peter Vela      CAR 59277                            *
.*           Recompiled for OUTLVLET and OUTPLTCD                             *
.* V9.04.03  24/09/2004  Peter Vela      CAR 53708                            *
.*           Recompiled for OUTPLTCD (add variables to Letters)               *
.* V9.04.02  31/08/2004  Guomin Fu       CAR 40390                            *
.*           Recompiled for OUTPLTCD (add variables to Letters)               *
.* V9.04.01  16/08/2004  Peter Vela      CAR 52435                            *
.*           Removed option 2, 3 and 4                                        *
.*           Removed KSID0000                                                 *
.*           Removed DELT0000                                                 *
.*           Removed SETV0000                                                 *
.*           Removed reads and writes to outladaf                             *
.******************************************************************************
.* V9.03.08  30/06/2004  Mike Laming     CAR 40390                            *
.*           Recompiled for OUTPLTCD (add variables to Letters)               *
.* V9.03.07  12/05/2004 Ebon Clements      CAR 49743                          *
.*           Recompiled for OUTPLTCD - Comments are now in PATCMNFD           *
.* V9.03.06  15/03/2004 Guomin Fu          47288                              *
.*           Recompiled for OUTPLTCD                                          *
.* V9.03.05  06/02/2004  Sylvek Litewka  CAR 47000                            *
.*           Added variable LTTYPIND (Letter Type Indicator) and recompiled   *
.*           for OUTPLTCD changes.                                            *
.* V9.03.04  15/12/2003 Peter Vela         45249                              *
.*           Recompiled for OUTPLTCD                                          *
.* V9.03.03  29/10/2003 Sandra Barcham     43783                              *
.*           Recompiled for NZHISIIO and NZHISIUP                             *
.* V9.03.02  11/09/2003 Sandra Barcham     43010                              *
.*           Remove site prefix for open of outpreaf & outphoaf               *
.* V9.03.01  26/06/2003  CAR 39819   Mike Laming                              *
.*           Recompiled for OUTLVLET & OUTPLTCD -                             *
.*           Added %rflcldes (Referral Clinic Description)                    *
.******************************************************************************
.* V9.02.04  11/04/2003  Tonii  CAR 35446                                     *
.*           Rearranged options on screen:                                    *
.*           - Option 2 moved to Option 5                                     *
.*           - Added in Option  2 - Generate letters by Selection ID          *
.*           - Added in Option  3 - Delete by Selection ID                    *
.*           - Added in Option  4 - Print selected letters                    *
.*           Rearranged Mainline code to accomodate new options               *
.*           - Added routine KSID0000 to keyin Selection ID                   *
.*           - Added routine DELT0000 to delete records in outladaf           *
.* V9.02.03  31/01/2003  Tracey Nguyen SRF 22709                              *
.*           Changed open OUTCLIA2,OUTCTYA1,OUTPREA1 to use site              *
.*           prefixes and added open OUTXWPA1 as required by OUTPLTCD         *
.* V9.02.02  01/11/2001  Greg Horvat                                          *
.*           Recompiled for ACTCOMN1 - Added xtra option to the               *
.*           parameter PNSWRACE                                               *
.* V9.02.01  16/10/2001 Dean Cramer                                           *
.*           Fix were some new files not openned or included                  *
.******************************************************************************
.* V9.00.B01 13/07/2001  Sandra Barcham                                       *
.*           Replace GP with HCP                                              *
.******************************************************************************
.*       V5.10.B01  26/03/2001  Glenn Saunders                                *
.*                  Remove access to PTCNSNDX and associated processing.      *
.*                  Remove all references to PATSUR file (old surname file).  *
.*       V5.08.05   27/11/2000  Dean Cramer                                   *
.*                  Fix where embedded spaces apear in some dates             *
.*                  Fix field format run time error condition                 *
.*       V5.08.04   19/09/2000  Steve Armstrong   srf 647263                  *
.*                  Recompiled for changes to OUTDSCLN                        *
.*       V5.08.03   04/09/2000  Caleb Sharman  SRF 647175                     *
.*                  Y2K date fix in FDAT1000                                  *
.*       V5.08.02   21/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*       V5.08.01   17/05/2000  Steve Armstrong                               *
.*                  Fixed bug in looping through OUTCLIA1 (ECLF0000)          *
.*       V5.08.B03  15/03/2000  Steve Armstrong    5.08 Mods                  *
.*                  Mods for changes to OUTCLIFD (effective date)             *
.*       V5.08.B02  02/03/2000  Tonii                                         *
.*                  Recompiled for OUTPLTCD changes                           *
.*       V5.08.B01  14/01/2000  J.Tan                                         *
.*                  Fixed o/p referral letter fields (v5.08 changes)          *
.******************************************************************************
.*       V5.07.01   09/12/1999  J.Tan                                         *
.*                  Added o/p referral letter fields (v5.08 changes)          *
.*       V5.07.B01  10/12/1998  Jim Stathopoulos                              *
.*                  507 Changes                                               * 
.******************************************************************************
.*        V5.04.08  25/06/97 J.Tan     SRF 620066                             *
.*                  Recompiled for OUTPLTCD - Slot time to a 12 clock AM/PM   *
.*        V5.04.07  14/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.*        V5.04.06  15/05/97 J.Tan     SRF 620066                             *
.*                  Recompiled for OUTPLTCD - booking time to a 12 clock AM/PM*
.*        V5.04.05  29/04/1997  Howellsy       rha                            *
.*                  Recompiled for OUTPLTCD                                   *
.*        V5.04.04  25/03/1997  Greg Horvat      SRF 617348                   *
.*                  Recompiled for OUTPLTCD - Added xtra screen variables     *
.*        V5.04.03  18/02/97 Howellsy     WHT                                 *
.*                  Added Cell Phone, Postal Add1-4, Postal Post Code         *
.*        V5.04.02  08/10/1996    Howellsy    SRF 642106                      *
.*                  Recompiled to fix nhi problem.                            *
.*        V5.04.01  29/07/1996    Justin Coates                               *
.*                  redefine srchnum as a form 3 not a form 1                 *
.******************************************************************************
.*        V5.03.04  20/11/1995    Justin Coates  (SUHT mods)                  *
.*                  Recompiled for OUTPLTCD.                                  *
.*        V5.03.03  14/11/1995    Justin Coates  (SUHT mods)                  *
.*                  allow for two types of standard re-schedule letters       *
.*        V5.03.02  02/10/1995    Max White  SRF 441372                       *
.*                  Recompiled for OUTPLTCD.                                  *
.*        V5.03.01  10/07/1995    Max White  SRF 441324 / Quote 440069        *
.*                  Added %day     - clinic day (Monday, Tuesday ..)          *
.*                        %cldate  - clinic date (1st, 2nd ...)               *
.*                        %month   - clinic month (January, February ..)      *
.*                        %year    - clinic century & year (1995 ...)         *
.*                        %loctype - clinic location type                     *
.*                        %locn    - clinic location                          *
.******************************************************************************
.
          INC       STD001FD
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC
          INC       ALLLNKFD/INC
          INC       BOKRC1FD/INC
          INC       NHIMASFD/INC
          INC       NZHISIFD/INC
          INC       IBASEQFD/INC
          INC       OUTADLFD/INC
          INC       OUTLADFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBOCFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBUDFD/INC
          INC       OUTCANFD/INC
          INC       OUTCLIFD/INC
          INC       OUTCONFD/INC
          INC       OUTCTYFD/INC
          INC       OUTDIAFD/INC                                       *I-58732
          INC       OUTLETFD/INC
          INC       OUTLHIFD/INC
          INC       OUTLPCFD/INC
          INC       OUTMA1FD/INC
          INC       OUTPLTDF/INC
          INC       OUTPREFD/INC
          INC       OUTRF1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTSITFD/INC
          INC       OUTSIPFD/INC
          INC       OUTXSCFD/INC
          INC       OUTXWPFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCODFD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDNRFD/INC
          INC       PATDO1FD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSOOSFD/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
          INC       PATGSRFD/INC
          INC       PATHSPFD/INC
          INC       PATINVFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATPR1FD/INC
          INC       PATREMFD/INC
          INC       PATRE1FD/INC
          INC       PATSDNFD/INC
          INC       PATSMWFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSVX1FD/INC
          INC       SCRPSTFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATWMAFD/INC                                       *I-59546
          INC       PATWC1FD/INC                                       *I-59546
          INC       PMSCCDFD/INC                                       *I-59546
          INC       PMSIHIFD/INC
          INC       PMSCEXFD/INC
          INC       TFILEVAR/INC
          INC       VISCMTFD/INC
          INC       OUTTHIFD/INC
          INC       WEBERRFD/INC
          INC       WEBSECFD/INC
          INC       MLTSECFD/INC
.
.**********************************************************************
.*                             CONSTANTS                              *
.**********************************************************************
AM        INIT      "am"
AST30     INIT      "******************************"
ATTENDED  INIT      "Attended"
.
BOOKED    INIT      "Booked"
BJDAY     FORM      3
CJDAY     FORM      3
COUNT1    FORM      2
.
CANCELED  INIT      "Cancelled"
CATEGORY  DIM       2
CATHP     INIT      "HP"
CODEA     INIT      "A "
CODECZ    INIT      "CZ"
CODEC     INIT      "C "
CODECA    INIT      "CA"
CODECB    INIT      "CB"
CODECL    INIT      "CL"
CODECV    INIT      "CV"
CODES     INIT      "S "
CODEOB    INIT      "OB"
CODELA    INIT      "LA"
CODEP     INIT      "P "
CODEPR    INIT      "PR"
CATTC     INIT      "tc"
CODEU1    INIT      "U1"
CODEO1    INIT      "O1"
CODEO5    INIT      "O5"
CODEO6    INIT      "O6"
CODEO7    INIT      "O7"
CODEO8    INIT      "O8"
CODEOM    INIT      "OM"
CODESA    INIT      "SA"
CODEVK    INIT      "VK"
CODEVI    INIT      "VI"
CODEVR    INIT      "VR"
CODEVJ    INIT      "VJ"
CODEVB    INIT      "VB"
CODEVA    INIT      "VA"
CODEDX    INIT      "DX"
CODEPV    INIT      "PV"
.
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
DOLLAR    INIT      "$"
.
FINISH    INIT      "Finish"
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
.
NONATT    INIT      "Non-attended"
DTEMPOUT  DIM       8
.
OTLPUID   DIM       10
OTLPLOGN  DIM       80
.
PM        INIT      "pm"
.
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090"
RESCHED   INIT      "Rescheduled from"
.                    " -----------"
SPECCHAR  INIT      "%"
START     INIT      "Start "
STAR52    INIT      "****************************************************"
TO        INIT      " TO "
.
VALSTAT   INIT      "BANRCbanrc"
VAR       DIM       127
VARD127   DIM       127
.
Z10       INIT      "zzzzzzzzzz"
.
FIRSTC1   INIT      "   *"
FIRSTC2   INIT      "  **      ****    *****"
FIRSTC3   INIT      " * *     *          *"
FIRSTC4   INIT      "   *      ****      *"
FIRSTC5   INIT      "   *          *     *"
FIRSTC6   INIT      "   *     *    *     *"
FIRSTC7   INIT      " *****    ****      *"
.
SECONDC1  INIT      " *****"
SECONDC2  INIT      "*     *  *    *  *****"
SECONDC3  INIT      "      *  **   *  *    *"
SECONDC4  INIT      " *****   * *  *  *    *"
SECONDC5  INIT      "*        *  * *  *    *"
SECONDC6  INIT      "*        *   **  *    *"
SECONDC7  INIT      "*******  *    *  *****"
.
BCLASS1   INIT      " *****"
BCLASS2   INIT      "*     *  *         **     ****    ****"
BCLASS3   INIT      "*        *        *  *   *       *"
BCLASS4   INIT      "*        *       *    *   ****    ****"
BCLASS5   INIT      "*        *       ******       *       *"
BCLASS6   INIT      "*     *  *       *    *  *    *  *    *"
BCLASS7   INIT      " *****   ******  *    *   ****    ****"
.
BPOST1    INIT      "******"
BPOST2    INIT      "*     *   ****    ****    *****    **     ****   ******"
BPOST3    INIT      "*     *  *    *  *          *     *  *   *    *  *"
BPOST4    INIT      "******   *    *   ****      *    *    *  *       *****"
BPOST5    INIT      "*        *    *       *     *    ******  *  ***  *"
BPOST6    INIT      "*        *    *  *    *     *    *    *  *    *  *"
BPOST7    INIT      "*         ****    ****      *    *    *   ****   ******"
.
.**********************************************************************
.*                       GLOBAL VARIABLES                             *
.**********************************************************************
SRCHNUM   FORM      3  
ABNORMAL  DIM       1
ALLHSPAC  FORM      1        * User has all hospital access flag
BANNLINE  DIM       55
BALANCE   FORM      8.2
BALDISP   DIM       12
BOTTMARG  FORM      2
BRANFR    DIM       8
BRANTO    DIM       8
CANDATE   DIM       10
CLRANFR   DIM       6
CLRANTO   DIM       6
CODE      DIM       2
COFFDATE  DIM       8
CONTTYPE  DIM       1
COUNT     FORM      3
COUNTER   FORM      4
CMDLINE   DIM       50
DATE      DIM       8
DATELINE  DIM       20
DBMFR     DIM       10
DBMTO     DIM       10
DBMRANFR  DIM       8
DBMRANTO  DIM       8
DBRANFR   DIM       10
DBRANTO   DIM       10
DCEASEFL  FORM      1
DCLRANFR  DIM       6
DCLRANTO  DIM       6
DEXT      DIM       3
DGLFR     DIM       10
DGLTO     DIM       10
DGLRANFR  DIM       8
DGLRANTO  DIM       8
DIMAGE    DIM       3
DIMOUTN   DIM       8
DIM3      DIM       3
DIM4      DIM       4
DIM4A     DIM       4
DIM4B     DIM       4
DIM4C     DIM       4
DIM8      DIM       8
DIM14     DIM       14
DIM30     DIM       30
DIM40     DIM       40
DIM55     DIM       55
DIM70     DIM       70
DISPSTRN  DIM       1200
DOCLINE   DIM       33
DSSRANFR  DIM       6
DSSRANTO  DIM       6
DSTRANFR  DIM       6
DSTRANTO  DIM       6
DURRANFR  DIM       8
DURRANTO  DIM       8
ECLINTYP  DIM       6
ENDSTR    FORM      2
EOUTCOME  DIM       3
FRMTTIME  DIM       8
FILTHOSP  DIM       3
FIRSTCH   FORM      1
FLAGGLET  FORM      1
FLAGIDNO  FORM      1
FLAGSURN  FORM      1
FLAGVIST  FORM      1
FLAGFOLL  FORM      1
FLAGABNY  FORM      1
FLAGABNN  FORM      1
FLAGBALN  FORM      1
FLAGLLET  FORM      1
FLAGLDAT  FORM      1
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
CFNAMEB   DIM       8
CFNAMEA   DIM       8
PRFIXA    INIT      "OUT71A"
PRFIXB    INIT      "OUT71B"
FOLLDAT1  DIM       8
FOLLDAT2  DIM       8
FOLFORM1  FORM      6
FOLFORM2  FORM      6
FOLTEST   DIM       6
FORM3     FORM      3
FORM3A    FORM      3
FSTATUS   FORM      1
IBCNMHOS  FORM      1
IDNO1     FORM      8
IDNO2     FORM      8
IHINUMBR  DIM       20
INITIAL   DIM       4
LEAVPSMS  FORM      1        * Don't send overdue leave SMS to patient
LEAVFSMS  DIM       20       * First SMS number of not sending to patient
LEFTMARG  FORM      2
LETDESC   DIM       25
LETTER    DIM       3
LETTFORM  FORM      3
LLETDAT1  DIM       8
LLETDAT2  DIM       8
LETFORM1  FORM      6
LETFORM2  FORM      6
LETTEST   DIM       6
LINE      DIM       55
LETRTYPE  DIM       1                       * S = Standard , M = Miscellaneous
LTTYPIND  DIM       1        * Letter Type Indicator (used by OUTPLTCD)
MEDNUM    DIM       10
MLETPLEN  FORM      3
MONTH     DIM       9
NAMELINE  DIM       52
NMPNUMB   DIM       20
PATCOUNT  FORM      4
PCLSDATE  DIM       8
PERCPOS   FORM      2
PHYSPAGE  FORM      3
PRINTEDB  DIM       10
PRNTLONG  FORM      1
PRTSTRNG  DIM       1200
PRTSTR70  DIM       70
RESHFROM  DIM       20
RESHTIME  DIM       8
RESHTO    DIM       20
.
SCNDGNAM  DIM       40
SKEY20    DIM       20
SAVKEY20  DIM       20
SMFLAG    FORM      1
SAVESITE  DIM       6
SCLINTYP  DIM       6
SELECTDC  DIM       35
SELECTID  DIM       4
SP40      DIM       40
SSRANFR   DIM       5
SSRANTO   DIM       5
STATUS    DIM       1
STARTSTR  FORM      2
STATDESC  DIM       20
STRANFR   DIM       6
STRANTO   DIM       6
SURN1     DIM       20
SURN2     DIM       20
SOUTCOME  DIM       3
SPOSTCLS  DIM       1
TEMP3     FORM      3
TEMP55    DIM       55
TEMP70    DIM       70
TODAY     DIM       8
TOPMARG   FORM      2
TOTAL     FORM      8.2
TOTLPAID  FORM      8.2
TOTALINV  FORM      8.2
TMPCLIN   DIM       6                                                  *I-52435
USERID    DIM       10       * User ID
VTRANFR   DIM       3
VTRANTO   DIM       3
URRANFR   DIM       8
URRANTO   DIM       8
VISDAT1   DIM       8
VISDAT2   DIM       8
VISFORM1  FORM      6
VISFORM2  FORM      6
VISTEST   DIM       6
VTFR      DIM       6
VTTO      DIM       6
.
WORKGP    DIM       10
WORKDATE  DIM       8
WORKTIME  DIM       5
.
LETRCOMM  DIM       1                  * Letter Communication Method
.                                         0 or Blank = Printed Letter
.                                         1 = SMS Notification
CONTPNMS  DIM       200                * Pipe-delimited list of phone numbers
CONTMSGI  DIM       200                * Pipe-delimited list of msg id's
CONTTYPS  DIM       200                * Pipe-delimited list of contact types
MAXCOUNT  INIT      "10"               * Max count for SMS phone numbers
.
SMSLETTR  FORM      1                  * SMS Letter flag
CLINTARR  DIM       6[99]              * Clinic Type filter array (max 99)
CLINTKEY  DIM       2                  * Clinic Type filter array size (keyin)
CLINTSIZ  FORM      2                  * Clinic Type filter array size
CLINTCNT  FORM      2                  * Clinic Type array counter
CHKCLITY  DIM       6                  * Clinic Type code for checking
.
VTYPEARR  DIM       3[99]              * Visit Type filter array (max 99)
VTYPEKEY  DIM       2                  * Visit Type filter array size (keyin)
VTYPESIZ  FORM      2                  * Visit Type filter array size
VTYPECNT  FORM      2                  * Visit Type array counter
CHKVTYPE  DIM       3                  * Visit Type code for checking
.
STAR30    INIT      "******************************"
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
ZEDS      INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
+
TEMP1     IFILE     SQL, FIXED=523, KEY="U1-1,2-9,401-406,503-508"
TEMPDLST  DIM       1
.
.----------------------------------------------------------------------
PRGID     INIT      "IBAOUT71"
PRGNAM    INIT      "Adhoc Letter Printing"
VERSION   INIT      "V12.00.02"
.----------------------------------------------------------------------
+
.**********************************************************************
.*                           MAINLINE                                 *
.*                      Controlling Logic                             *
.**********************************************************************
ML0000    CALL      INIT0000                      * display header,
.
ML0200    CALL      OPTN0000                      * main option screen
          BRANCH    EXIT,ML9999                   * exit chosen
          CALL      CLRP0000                      * clear all input parameters
          IF        OTCNSLET = 1
            BRANCH    OPTION,ML0500,ML8000,ML8200,ML8000,ML8300,ML0500:        
                             ML8000,ML0400
          ELSE
            BRANCH    OPTION,ML0500,ML8000,ML8200,ML8000,ML9999,ML0500:       
                             ML8000,ML0400
          ENDIF
.
.------ mainline for general letters ------
.
ML0400    MOVE      ONE,SMSLETTR                  * SMS Letter
.
ML0500    CALL      GOPN0000                      * general letter option screen
          CALL      CLR0000                       * clear working variables
          CALL      BRAN0000                      * Keyin Booking Date Range
.
ML0600    CALL      SEL0000                       * select field or OK to post
          BRANCH    EXIT,ML0200                   * exit chosen
          BRANCH    CCITEM,ML1000,ML2000,ML3000,ML4000,ML5000:
                           ML6000,ML6100,ML6150,ML6200,ML6250:
                           ML6300,ML6400
          GOTO      ML6500                        * Post selected
.
.------ parameter fields for selection ------
.
ML1000    CALL      BRAN0000                      * Keyin Booking Date Range
          BRANCH    EXIT,ML0200
          GOTO      ML0600
.
ML2000    CALL      STAT0000                      * Keyin Booking Status
          GOTO      ML0600
.
ML3000    CALL      OTST0000                      * Keyin Outpatient Site Code
          GOTO      ML0600                        * range
.
ML4000    CALL      CLIN0000                      * Keyin Outpatient Clinic Code
          GOTO      ML0600                        * range
.
ML5000    CALL      SSTT0000                      * Keyin Sess Start Time range
          GOTO      ML0600
.
ML6000    CALL      URNO0000                      * Keyin UR Number range
          GOTO      ML0600
.
ML6100    CALL      KDEC0000                      * Keyin Deceased Patients
          GOTO      ML0600
.
ML6150    CALL      VIST0000                      * Keyin Visit Type range
          BRANCH    EXIT,ML0200
          GOTO      ML0600
.
ML6200    CALL      KDBM0000                      * Keyin Date Booking Made
          BRANCH    EXIT,ML0200                   * range
          GOTO      ML0600
.
ML6250    CALL      KCTY0000                      * Keyin Clinic Type range
          BRANCH    EXIT,ML0200
          GOTO      ML0600
.
ML6300    CALL      KOTC0000                      * Keyin Outcome range
          BRANCH    EXIT,ML0200
          GOTO      ML0600
.
ML6400    CALL      KDGL0000                      * Keyin Generate Letter Date
          BRANCH    EXIT,ML0200                   * range
          GOTO      ML0600
.
.         (P)ost selected
.
ML6500    
.
.-----   If we are using new files and standard letters then we don't ----
.-----   need to ask for letter type because it is based on the       ----
.-----   booking status on bokb.                                      ----
.
          IF        OPTION<>SIX
            CALL      LSEL0000                    * Select letter
            BRANCH    EXIT,ML0200                 * Don't continue
          ENDIF
.         
          CALL      KPID0000                      * Keyin printed by
          BRANCH    EXIT,ML0200
.         
          CALL      HOSP0000                      * Keyin hospital Id
          BRANCH    EXIT,ML0200
.
          CALL      EXTR0000                      * Extract details
.         BRANCH    EXIT,ML0200
.
          MOVE      SP1,SPOSTCLS
          MOVE      SP20,KEY21
          MOVE      SP1,LETRCOMM
.
..jp      MATCH     "1",PTCNSMSN            * Using SMS Notifications?
..jp      GOTO      ML7100 IF NOT EQUAL
.
          COMPARE   "1",SMSLETTR            * Using SMS Notifications?
          GOTO      ML7100 IF NOT EQUAL
.
          MOVE      ZERO,FORM3              * read letter file header record
          PACK      KEY6,LETTER,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,ML7500
.
          MOVE      OTLTCOMM,LETRCOMM       * store our Communication Method
          MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGH00              * print SMS Messages XML Header tag
          ENDIF
.
ML7100    CALL      RSTMP
ML7200    CALL      SET0000                 * set up values for % var's
          BRANCH    EXIT,ML7500             * end of temp file
.
          MOVE      PRINTEDB,TEMPPUID       * Printed by user id
.
          CALL      PRIN0000                * print letter
          BRANCH    EXIT,ML7200,ML7200
.
ML7500    MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGF00              * print SMS Messages XML Footer tag
          ENDIF
.
          DISPLAY   *P1:24,*EL,*B,"Printing Completed.  ";
          CALL      HITENTER
          GOTO      ML0200
. 
.------ Generate selected ID                                           *I-63400
.
ML8000    CALL      KSID0000
          BRANCH    EXIT,ML0200
.
          CALL      KPID0000                  * Keyin printed by
          BRANCH    EXIT,ML0200
.         
          CALL      HOSP0000                  * Keyin hospital Id
          BRANCH    EXIT,ML0200
.
          IF        OPTION=7
            CALL      LSEL0000                * Keyin SMS message/Letter
            BRANCH    EXIT,ML0200
.
            MOVE      LETTER,OTALLTYP         * Populate SMS message to send
          ENDIF
.
          IF        OPTION = 4 | OPTION = 7
            CALL      CTMP0000
            GOTO      ML8050
          ENDIF
.
          CALL      DELT0000                * Delete records in outladaf
.
          CALL      EXTR0000                * Extract details
.         BRANCH    EXIT,ML0200
.
          CALL      WTMP0000
          BRANCH    EXIT,ML0200
.
ML8050    MOVE      SP10,SAVESITE
          MOVE      SP1,SPOSTCLS
          MOVE      SP1,LETRCOMM
          PACK      KEY25,SELECTID,SP20
.
          MOVE      ZERO,FORM3              * read letter file header record
          PACK      KEY6,LETTER,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,ML8150
.
          MOVE      OTLTCOMM,LETRCOMM       * store our Communication Method
          MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGH00              * print SMS Messages XML Header tag
          ENDIF
.
ML8090    CALL      RSOTLAD1
ML8100    CALL      SETV0000                      * set up values for % var's
          BRANCH    EXIT,ML8150                   * end of temp file
.
          MOVE      PRINTEDB,TEMPPUID             * Printed by user id
.
          CALL      PRIN0000                      * print letters
          BRANCH    EXIT,ML8100,ML8100
.
ML8150    MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGF00              * print SMS Messages XML Footer tag
          ENDIF
.
          DISPLAY   *P1:24,*EL,*B,"Printing Completed.  " 
          GOTO      ML0200
.
.------ Delete selected ID
.
ML8200    CALL      KSID0000
          CALL      DELT0000
          GOTO      ML0200                                        *end I-63400
.
.------   Standard Letter Option ------
.
ML8300    MOVE      ZERO,FSTATUS
          CALL      DSLS0000                * Display the standrd letter screen
.
          CALL      DBMR0000                * Keyin booking date range
          BRANCH    EXIT,ML0200
.
          CALL      KSOM0000               * standard or miscellaneous letters
.
          CALL      CONTQST
          BRANCH    CEXIT,ML8310,ML8300,ML0200                         *C-63400
.
ML8310    IF        SMFLAG = 1
            MOVE      SP1,SPOSTCLS
            GOTO      ML8330                                           *C-63400
          ENDIF
         
ML8320    CALL      LSEL0000                      * select general letter
          BRANCH    EXIT,ML0200                   * dont continue
.
          MOVE      SP1,SPOSTCLS
          MOVE      SP1,LETRCOMM
.
.jp       MATCH     "1",PTCNSMSN            * Using SMS Notifications?
.jp       GOTO      ML8330 IF NOT EQUAL
.
          COMPARE   "1",SMSLETTR
          GOTO      ML8330 IF NOT EQUAL
.
          MOVE      ZERO,FORM3              * read letter file header record
          PACK      KEY6,LETTER,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,ML8340
.
          MOVE      OTLTCOMM,LETRCOMM       * store our Communication Method
          MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGH00              * print SMS Messages XML Header tag
          ENDIF
.
ML8330    CALL      KPID0000                * Keyin printed by
          BRANCH    EXIT,ML0200
.         
          CALL      HOSP0000                * Keyin hospital Id
          BRANCH    EXIT,ML0200
.
          CALL      XTRA0000                * extract details
          BRANCH    EXIT,ML0200
.
ML8340    CALL      SET0000                 * set up values for % var's
          IF        EXIT = 1                                         
            MATCH     "1",LETRCOMM          * SMS Notification?
            IF        @EQUAL
              CALL      PRMSGF00            * print SMS Messages XML Footer tag
            ENDIF
.
            DISPLAY   *P1:24,*EL,*B,"Printing Completed.  ";
            CALL      HITENTER
            GOTO      ML0200
          ENDIF
.
          MOVE      PRINTEDB,TEMPPUID             * Printed by user id
.
          CALL      PRIN0000                      * print letters
          BRANCH    EXIT,ML8340,ML8340
          GOTO      ML9999
.
ML9999    CALL      KTMP0000
          CHAIN     PGM
+
.**********************************************************************
.*                           INIT0000                                 *
.*                   Display header and open files                    *
.**********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ONE,CNEWDS
          PACK      SP40,SP20,SP20
          MOVE      ZERO,SMSLETTR
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD   * Set todays date
          REP       " 0",TODAY
.
          DISPLAY   *P51:24,"Opening  controlf";
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,THIRTY1;*214,OTCNPSTC,*215,OTCNNDAY:
                                     *218,OTCNLHIA,*225,OTCNSLET
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND28;*210,PTCNSTYP
.
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          IF        @EQUAL
            OPEN      PMSOOSA1,"pmsoosaf"
          ENDIF
.
.-------  If we are uing postage classes then calculate the cut off date ----
.
          IF        OTCNPSTC = 1
            CALL      COFF0000
          ENDIF
.
          OPEN      WEBSECA3,"websecaf"
          OPEN      IBASEQA1,"ibaseqaf"
          DISPLAY   *P51:24,"Opening  patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P60:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P60:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          DISPLAY   *P60:24,"patinvrf";
          OPEN      PATINVR3,"patinvrf"
          DISPLAY   *P60:24,"patremdf";
          OPEN      PATREMD1,"patremdf"
.
          DISPLAY   *P60:24,"patgsrnf";
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P60:24,"outadlaf";
          OPEN      OUTADLA1,"outadlaf"
.
          DISPLAY   *P60:24,"outladaf";
          OPEN      OUTLADA1,"outladaf"
.
          DISPLAY   *P60:24,"outsipaf";
          OPEN      OUTSIPA1,"outsipaf"
.
          DISPLAY   *P60:24,"outrf1af";                                *I-59283
          OPEN      OUTRF1A1,"outrf1af"
.
          DISPLAY   *P60:24,"outletrf";
          OPEN      OUTLETR1,"outletrf"
          DISPLAY   *P60:24,"outletrf";
          OPEN      OUTLETR2,"outletrf"
          DISPLAY   *P60:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
          DISPLAY   *P60:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P60:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P60:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
          DISPLAY   *P60:24,"pmscexaf";
          OPEN      PMSCEXA1,"pmscexaf"
.
          DISPLAY   *P60:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P60:24,"pmshcgaf";
          OPEN      PMSHCGA1,"pmshcgaf"
          DISPLAY   *P60:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA2,"pmshcpaf"
          DISPLAY   *P60:24,"pmstleaf"
          OPEN      PMSTLEA1,"pmstleaf"
          DISPLAY   *P60:24,"pmsrelaf"
          OPEN      PMSRELA1,"pmsrelaf"
          DISPLAY   *P60:24,"patre1af";
          OPEN      PATRE1A1,"patre1af"
          DISPLAY   *P60:24,"vismdtaf";
          OPEN      VISMDTA1,"vismdtaf"
          DISPLAY   *P60:24,"vismtxaf";
          OPEN      VISMTXA1,"vismtxaf"
          DISPLAY   *P72:24,"patwmabf"
          OPEN      PATWMAB1,"patwmabf"                                *I-59546
          DISPLAY   *P72:24,"patwc1af"
          OPEN      PATWC1A1,"patwc1af"                                *I-59546
          DISPLAY   *P72:24,"pmsccdaf"
          OPEN      PMSCCDA1,"pmsccdaf"                                *I-59546
          DISPLAY   *P72:24,"outdiagf"
          OPEN      OUTDIAG1,"outdiagf"                                *I-58732
.
          DISPLAY   *P65:24,"outthiaf"
          OPEN      OUTTHIA1,"outthiaf"
.
          DISPLAY   *P65:24,"viscmtaf"
          OPEN      VISCMTA1,"viscmtaf"
.
          DISPLAY   *P65:24,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          DISPLAY   *P65:24,"allrefaf"
          OPEN      ALLREFA1,"allrefaf"
.
          DISPLAY   *P60:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          DISPLAY   *P64:24,"mltsecaf"
          OPEN      MLTSECA1,"mltsecaf"
.
          PACK      CFNAME,UID,FILCANA1          * opening outcanaf
          DISPLAY   *P60:24,CFNAME
          OPEN      OUTCANA1,CFNAME
.
          PACK      CFNAME,UID,FILCLIA1          * opening outcliaf
          DISPLAY   *P60:24,CFNAME;
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME,UID,FILCTYA1          * opening outctyaf
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCTYA1,CFNAME
.
          PACK      CFNAME,UID,FILSESA1          * opening outsesaf
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA1,CFNAME
.
          PACK      CFNAME,UID,FILHEDA1          * opening outhedaf
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME,UID,FILXWPA1          * opening outxwpaf
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTXWPA1,CFNAME
.  
. ------- set up port dependant temporary file ------
.
          CALL TFILENAM * Get temp file name in create
          MOVE TFILNAME,CFNAMEA 
.
          CALL TFILENAM * Get temp file name in create
          MOVE TFILNAME,CFNAMEB 
.
          CALL      ALHSPA00
.
INIT9999  RETURN
+
.****************************************************************************
.*                             COFF0000                                     *
.*                       Calculate the cutt-off date                        *
.****************************************************************************
.
COFF0000  UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       OTCNNDAY,JULDAY
          MOVE      JULYR,JWKYER
          MOVE      JULDAY,JWKDAY
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      COFFDATE,CC,YY,MM,DD
          REPLACE   " 0",COFFDATE
.
COFF9999  
          RETURN
.
.**********************************************************************
.*                           OPTN0000                                 *
.*                   Display the main option screen                   *
.*  0 = Exit                                                          *
.*  1 = General Letter Menu                                           *
.**********************************************************************
OPTN0000  MOVE      FALSE,EXIT
          MOVE      ZERO,SMSLETTR
.
          MOVE      SEVEN,CVERT
          HLINE     *G37,2,51,80
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON," 0",*HOFF," = Exit":
                    *P1:5,*V2LON," 1",*HOFF," = General Letter Menu":
                *P1:6,*V2LON," 2",*HOFF," = Delete and Regenerate Selection ID":
                    *P1:7,*V2LON," 3",*HOFF," = Delete Selection ID": 
                    *P1:8,*V2LON," 4",*HOFF," = Print Letters for Selection ID";
          IF        OTCNSLET = 1
            DISPLAY   *P1:9,*V2LON," 5",*HOFF," = Print Standard Letters"
            DISPLAY   *P1:10,*V2LON," 6",*HOFF," = Print Clinic Letters"
            DISPLAY   *P1:11,*V2LON," 7",*HOFF," = Send SMS for Selection ID"
            DISPLAY   *P1:12,*V2LON," 8",*HOFF," = Send Clinic SMS"
            MOVE      TEN3,CVERT                                      *C-63400
          ELSE
            DISPLAY   *P1:10,*V2LON," 6",*HOFF," = Print Clinic Letters"
            DISPLAY   *P1:11,*V2LON," 7",*HOFF," = Send SMS for Selection ID"
            DISPLAY   *P1:12,*V2LON," 8",*HOFF," = Send Clinic SMS"
            MOVE      TEN2,CVERT
          ENDIF
.
OPTN1000  DISPLAY   *P1:CVERT,*EL,"Select Item : ";
          KEYIN     *P15:CVERT,*V2LON,OPTION;
          COMPARE   ZERO,OPTION
          GOTO      OPTN9000 IF EQUAL
          IF        OTCNSLET = 1
            BRANCH    OPTION,OPTN9999,OPTN9999,OPTN9999,OPTN9999,OPTN9999:
                             OPTN9999,OPTN9999,OPTN9999
          ELSE
            BRANCH    OPTION,OPTN9999,OPTN9999,OPTN9999,OPTN9999,OPTN1100:
                             OPTN9999,OPTN9999,OPTN9999
          ENDIF
OPTN1100  BEEP
          GOTO      OPTN1000
.
.------ exit option chosen ------
.
OPTN9000  MOVE      TRUE,EXIT
.
OPTN9999  RETURN
+
.**********************************************************************
.*                               GOPN0000                             *
.*           Display menu for general letter option                   *
.**********************************************************************
GOPN0000  DISPLAY   *P51:2,*V2LON," - General Letters ",*P1:3,*EF:
                    *P2:5,*V2LON,"1":
                    *P2:6,"2":
                    *P2:8,"3":
                    *P2:9,"4":
                    *P2:10,"5":
                    *P2:11,"6":
                    *P2:12,"7":
                    *P2:13,"8":
                    *P2:14,"9":
                    *P1:15,"10":
                    *P1:16,"11" :
                    *P1:17,"12" 
          DISPLAY   *P3:5,*HOFF,". Booking Dates                         : ":
                    *P56:5,"to":
                    *P3:6,". (B)ooked, (A)ttendees, (N)on-Attendees,  ":
                    *P3:7,"  (R)escheduled or (C)ancelled Bookings : ":
                    *P3:8,". Outpatient Sites                      : ":
                    *P56:8,"to":
                    *P3:9,". Outpatient Clinics                    : ":
                    *P56:9,"to":
                    *P3:10,". Session Start Times                   : ":
                    *P56:10,"to":
                    *P3:11,". U/R Numbers                           : ":
                    *P56:11,"to":
                    *P3:12,". Include Deceased Patients (Y/N) ?     : ":
                    *P45:12,*V2LON,DNO,*HOFF:
                    *P3:13,". Visit Type                            : ";
          IF        SMSLETTR=0
            DISPLAY   *P56:13,"to";
          ENDIF
.
          DISPLAY   *P3:14,". Date Booking's made                   : ":
                    *P56:14,"to":
                    *P3:15,". Clinic Type                           : ";
.
          IF        SMSLETTR=0
            DISPLAY   *P56:15,"to";
          ENDIF
.
          DISPLAY   *P3:16,". Outcome                               : ":
                    *P56:16,"to": 
                    *P3:17,". Generate letter Date                  : ":
                    *P56:17,"to"
.
GOPN9999  RETURN
+
.************************************************************************
.*                          CLR0000                                     *
.*               Clear the working variables                            *
.*                   called by : ML                                     *
.************************************************************************
CLR0000   UNPACK    SP30,BRANFR,BRANTO,DBRANTO,STATUS
          UNPACK    SP30,STRANFR,STRANTO,DSTRANFR,DSTRANTO
          UNPACK    SP30,CLRANFR,CLRANTO,DCLRANFR,DCLRANTO
          UNPACK    SP30,SSRANFR,SSRANTO,DSSRANFR,DSSRANTO
          UNPACK    SP30,URRANFR,URRANTO,DURRANFR,DURRANTO
          UNPACK    SP30,SOUTCOME,SCLINTYP
          MOVE      SP10,DBRANFR
          MOVE      SP10,VTRANFR
          MOVE      Z10,BRANTO
          MOVE      Z10,STRANTO
          MOVE      Z10,SSRANTO
          MOVE      Z10,CLRANTO
          MOVE      Z10,URRANTO
          MOVE      Z10,VTRANTO
          MOVE      ZERO,DCEASEFL
          MOVE      ANSM,LETRTYPE
          MOVE      Z10,EOUTCOME
          MOVE      Z10,ECLINTYP
          MOVE      SP1,LETRCOMM
          PACK      CONTPNMS,SP70,SP70,SP70
          PACK      CONTMSGI,SP70,SP70,SP70
          MOVE      SP70,FILTHOSP
.
CLR9999   RETURN
+
.**********************************************************************
.*                               FOPN0000                             *
.*           Display menu for financial letter option                 *
.**********************************************************************
FOPN0000  DISPLAY   *P51:2,*V2LON,"- Financial Letters ",*P1:3,*EF:
	    *P1:5,*V2LON,"1":
	    *P1:6,"2":
	    *P1:7,"3":
	    *P1:8,"4":
	    *P1:9,"5":
	    *P2:5,*HOFF,". I.D. Number Range             : ":
	    *P2:6,". Surname Range                 : ":
	    *P2:7,". Visit Date Range              : ":
	    *P2:8,". Minimum Balance Owing         : ":
	    *P2:9,". Date Range Since Last Letter  : ";
.
FOPN9999  RETURN
+
.**********************************************************************
.*                           CLRP0000                                 *
.*                  Clears all input parameters                       *
.**********************************************************************
CLRP0000  MOVE      ONE,IDNO1
          MOVE      ZERO,SMFLAG
	  MOVE      "99999999",IDNO2
	  MOVE      "A",SURN1
	  MOVE      "Z",SURN2
	  PACK      VISDAT1,SP8
	  PACK      VISDAT2,SP8
	  MOVE      ZERO,VISFORM1
	  MOVE      ZERO,VISFORM2
	  PACK      FOLLDAT1,SP8
	  PACK      FOLLDAT2,SP8
	  MOVE      ZERO,FOLFORM1
	  MOVE      ZERO,FOLFORM2
	  PACK      FOLTEST,SP6
	  PACK      LETTEST,SP6
	  PACK      VISTEST,SP6
	  MOVE      ZERO,LETFORM1
	  MOVE      ZERO,LETFORM2
	  PACK      ABNORMAL,SP1
	  PACK      LETTER,SP3
	  PACK      LETDESC,SP30
	  MOVE      ZERO,BALANCE
	  MOVE      ZERO,TOTALINV
	  MOVE      ZERO,TOTLJOUR
	  MOVE      ZERO,SHRTPAID
	  MOVE      ZERO,TOTLPAID
	  MOVE      ZERO,TOTAL
	  MOVE      FALSE,FLAGIDNO
	  MOVE      FALSE,FLAGSURN
	  MOVE      FALSE,FLAGVIST
	  MOVE      FALSE,FLAGFOLL
	  MOVE      FALSE,FLAGABNY
	  MOVE      FALSE,FLAGABNN
	  MOVE      FALSE,FLAGBALN
	  MOVE      FALSE,FLAGLLET
	  MOVE      FALSE,FLAGLDAT
	  MOVE      FALSE,FLAGGLET
          UNPACK    SP30,RESHFROM,RESHTO,CANDATE
          MOVE      SP30,RESHTIME
.
CLRP9999  RETURN
+
.**********************************************************************
.*                             DISP0000                               *
.*         Display field values again for question mark option        *
.**********************************************************************
DISP0000  DISPLAY   *P36:5,*V2LON,IDNO1,*HOFF,TO:
		    *P48:5,*V2LON,IDNO2:
		    *P36:6,SURN1,*HOFF,TO:
		    *P60:6,*V2LON,SURN2;
	  MATCH     SP8,VISDAT1
	  GOTO      DISP1000 IF EQUAL
	  DISPLAY   *P36:7,*V2LON,VISDAT1,*HOFF,TO:
		    *P48:7,*V2LON,VISDAT2;
.
DISP1000  DISPLAY   *P36:8,*V2LON,BALDISP:
		    *P36:9,LLETDAT1,*HOFF,TO:
		    *P48:9,*V2LON,LLETDAT2;
.
DISP9999  RETURN
+
.**********************************************************************
.*                             SEL0000                                *
.*                Select field to modify or OK to post - General      *
.**********************************************************************
SEL0000   MOVE      FALSE,EXIT
	  CALL      MAINQST
	  COMPARE   ZERO,CCITEM                     * zero to post
	  GOTO      SEL9999 IF EQUAL
	  COMPARE   "-1",CCITEM                     * -1 to cancel
	  GOTO      SEL9000 IF EQUAL
	  COMPARE   TEN3,CCITEM
	  GOTO      SEL0000 IF NOT LESS             * invalid selection
	  GOTO      SEL9999
.
.------ cancel option chosen ------
.
SEL9000   MOVE      TRUE,EXIT
.
SEL9999   RETURN
+
.******************************************************************************
.*                                  KSID0000              Called by: MAIN0000 *
.*                              Keyin Selection ID                   *I-63400 *
.******************************************************************************
KSID0000  MOVE      ZERO,CQUEST             * ? flag - no
          MOVE      "4",CVERT
KSID0500  KEYIN     *P1:CVERT,*EF,"Selection ID : ",*V2LON,SELECTID;
.
          PACK      SELECTID,SELECTID,SP4
          MATCH     SP4,SELECTID
          GOTO      KSID8500 IF EQUAL       * Spaces
          GOTO      KSID8500 IF EOS         * Nothing
.
          PACK      KEY4,SELECTID
          CALL      RDOTADL1                * Read a adhoc letter file rec
          COMPARE   ONE,OVRCD
          GOTO      KSID5000 IF NOT EQUAL   * Record exists
.
          GOTO      KSID9500
.
KSID5000  MOVE      OTALSEID,SELECTID     * selection ID
          MOVE      OTALSEDC,SELECTDC     * Selection Description
.
          MOVE      OTALBDFR,BRANFR 
          MOVE      OTALBDTO,BRANTO
          MATCH     SP8,BRANTO
          IF        @EQUAL
            MOVE      ZEDS,BRANTO 
          ENDIF
.
          MOVE      OTALBKTY,STATUS       * Booking type code
          MOVE      STATUS,ANS
          REP       "B1R2C3A4N5",ANS        * get into numeric form
          MOVE      ANS,FSTATUS             * get as a form
          LOAD      STATDESC,FSTATUS,BOOKED,RESCHED,CANCELED,ATTENDED,NONATT
.
          MOVE      OTALSIFR,STRANFR     * Site code from
          MOVE      OTALSITO,STRANTO     * Site code to
          MATCH     SP6,STRANTO
          IF        @EQUAL
            MOVE      ZEDS,STRANTO
          ENDIF
. 
          MOVE      OTALCLFR,CLRANFR     * Clinic Code From
          MOVE      OTALCLTO,CLRANTO     * Clinic Code To
          MATCH     SP6,CLRANTO
          IF        @EQUAL
            MOVE      ZEDS,CLRANTO
          ENDIF
. 
          MOVE      OTALSTFR,SSRANFR     * Session Time From
          MOVE      OTALSTTO,SSRANTO     * Session Time To
          MATCH     SP6,SSRANTO
          IF        @EQUAL
            MOVE      ZEDS,SSRANTO
          ENDIF
. 
          MOVE      OTALURFR,URRANFR     * U/R number From
          MOVE      OTALURTO,URRANTO     * U/R number To
          MATCH     SP6,URRANTO
          IF        @EQUAL
            MOVE      ZEDS,URRANTO
          ENDIF
. 
          MOVE      ZERO,DCEASEFL
          MATCH     ANSY,OTALDPYN
          IF        @EQUAL
            MOVE      ONE,DCEASEFL
          ENDIF
.
          MOVE      OTALVTFR,VTRANFR      * Visit Type From
          MOVE      OTALVTTO,VTRANTO      * Visit Type To
          MATCH     SP6,VTRANTO
          IF        @EQUAL
            MOVE      ZEDS,VTRANTO
          ENDIF
. 
          MOVE      OTALMDFR,DBMRANFR
          MOVE      OTALMDTO,DBMRANTO
          MATCH     SP6,DBMRANTO
          IF        @EQUAL
            MOVE      ZEDS,DBMRANTO
          ENDIF
.
          MOVE      OTALCTFR,SCLINTYP     * Clinic Type From
          MOVE      OTALCTTO,ECLINTYP     * Clinic Type To
          MATCH     SP6,ECLINTYP
          IF        @EQUAL
            MOVE      ZEDS,ECLINTYP
          ENDIF
. 
          MOVE      OTALOCFR,SOUTCOME     * Outcome Code From
          MOVE      OTALOCTO,EOUTCOME     * Outcome Code To
          MATCH     SP6,EOUTCOME
          IF        @EQUAL
            MOVE      ZEDS,EOUTCOME
          ENDIF
.
.         Generate Letter Date filters not used in adhoc letters
.
          MOVE      SP70,DGLRANFR         * Generate letter date from
          MOVE      ZEDS,DGLRANTO         * Generate letter date to
. 
          MOVE      OTALLTYP,LETTER       * Letter to print
.
          DISPLAY   *P16:4,*EL,*V2LON,SELECTID,*HOFF,SP2,SELECTDC;
          GOTO      KSID9000
.
KSID8500  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          GOTO      KSID9500
.
KSID9000  MOVE      ZERO,EXIT
          GOTO      KSID9999
.
KSID9500  MOVE      ONE,EXIT
KSID9999  RETURN
.
.******************************************************************************
.*                                  KPID0000              Called by: MAIN0000 *
.*                              Keyin Printed by user Id                      *
.******************************************************************************
KPID0000  MOVE      "5",CVERT
          KEYIN     *P1:CVERT,*EF,"Printed By User ID : ",*V2LON,PRINTEDB;
.
          PACK      PRINTEDB,PRINTEDB,SP70
          MOVE      PRINTEDB,USERID
.
          CALL      ALHSPA00
.
          MOVE      ZERO,EXIT
          GOTO      KPID9999
.
KPID9500  MOVE      ONE,EXIT
KPID9999  RETURN
.
.****************************************************************************
.* Get Hospital id                                                          *
.****************************************************************************
HOSP0000  IF        IBCNMHOS = 1
            MOVE      "5",CVERT
            KEYIN     *P1:CVERT,*EF,"Hosiptal ID : ";

.           DISPLAY   *P15:5,SP3
            MOVE      "15",ECOL
            MOVE      FIVE,EVERT
            MOVE      SP3,CKYIDEF3
            MOVE      ZERO,CKYIMAND
HOSP1100    CALL      PATHSPKY
            IF        EXIT = ONE
              MOVE      SP70,FILTHOSP
            ELSE
              IF        EXIT = 2
                MOVE      SP70,FILTHOSP
                GOTO      HOSP9400
              ELSE
                MOVE      KEY3,FILTHOSP
              ENDIF
            ENDIF
          ENDIF
.
HOSP1199  MOVE      ZERO,EXIT
          GOTO      HOSP9999
.
HOSP9400  DISPLAY   *P1:24,*EL,*B,*V2LON,"** Invalid Hospital ID ** ";
          CALL      HITENTER
          GOTO      HOSP0000
.
HOSP9999  RETURN
.
.------------------------------------------------------------------------------
. Get user has access to all hospital flag
.------------------------------------------------------------------------------
ALHSPA00  MOVE     ZERO,ALLHSPAC
.
          PACK      KEY13,USERID,SP70
          CALL      RDMLSEC1
          IF        OVRCD=0
            MOVE     ONE,ALLHSPAC           * user has All hospital access
          ENDIF
.
ALHSPA99  RETURN
.
.**********************************************************************
.*                           DELT0000                        *I-63400 *
.*              Delete records in outladaf                            *
.**********************************************************************
DELT0000  PACK      KEY25,SELECTID,SP20
          CALL      RSOTLAD1
DELT1000  CALL      RKOTLAD1
          BRANCH    OVRCD,DELT9999
.
          MATCH     SELECTID,OTLASEID
          GOTO      DELT9999 IF NOT EQUAL
.
          PACK      KEY25,OTLASEID,OTLAPCLS,OTLAOUTN,OTLACLID,OTLACLTY
          CALL      DEOTLAD1
          GOTO      DELT1000
.
DELT9999  RETURN
+
.**********************************************************************
.*                           BRAN0000                                 *
.*                     Keyin Booking Date range                       *
.**********************************************************************
BRAN0000  MOVE      FALSE,EXIT
          DISPLAY   *P45:5,SP10,*P59:5,SP10
          MOVE      "45",CCOL
	  UNPACK    SP10,CDAY,CMON,CYEAR,CCENT
          MOVE      CCC,CCENT
	  MOVE      FIVE,CVERT
	  CALL      KEYDATE
	  BRANCH    CQUEST,BRAN0000         * no question mark available
.
	  MATCH     SP2,CDAY
	  GOTO      BRAN0100 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      BRAN9000 IF EQUAL
.
	  BRANCH    OVRCD,BRAN0000          * field is manditory
          
	  PACK      BRANFR,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BRANFR
          CALL      PACDATE
          MOVE      CPCDATE,DBRANFR
          REP       " 0",DBRANFR
	  GOTO      BRAN1000
.
BRAN0100  MOVE      START,DBRANFR
	  MOVE      SP10,BRANFR
          DISPLAY   *P45:5,*V2LON,DBRANFR
.
BRAN1000  MOVE      FALSE,EXIT
	  MOVE      "59",CCOL
	  MOVE      FIVE,CVERT
          MOVE      ONE,CCANLDTE            * space will cancel default
	  CALL      KEYDATE
	  BRANCH    CQUEST,BRAN1000         * no question mark available
.
	  MATCH     SP2,CDAY
	  GOTO      BRAN1100 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      BRAN9000 IF EQUAL
.
	  BRANCH    OVRCD,BRAN1000          * field is manditory
	  PACK      BRANTO,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BRANTO
          CALL      PACDATE
          MOVE      CPCDATE,DBRANTO
          REP       " 0",DBRANTO
	  GOTO      BRAN2000
.
BRAN1100  MOVE      FINISH,DBRANTO
	  MOVE      Z10,BRANTO
	  DISPLAY   *P59:5,*V2LON,DBRANTO
.
BRAN2000  MATCH     BRANFR,BRANTO           * valid range?
	  GOTO      BRAN3000 IF LESS
.
            
	  MOVE      FALSE,EXIT
	  GOTO      BRAN9999
.
.------ invalid date range entered ------
.
BRAN3000  DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
	  CALL      HITENTER
	  GOTO      BRAN0000
.
.------ zero entered for first date number ------
.
BRAN9000  MOVE      TRUE,EXIT
.
BRAN9999  RETURN
+
.**********************************************************************
.*                           SSTT0000                                 *
.*                     Keyin session start range                      *
.**********************************************************************
SSTT0000  DISPLAY   *P59:10,*EL
	  MOVE      "45",CCOL
	  MOVE      TEN,CVERT
	  UNPACK    SP10,CMIN,CHOUR
	  CALL      KEYTIME
	  BRANCH    CQUEST,SSTT0000         * no question mark available
.
	  MATCH     SP2,CHOUR
	  GOTO      SSTT0100 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      SSTT9000 IF EQUAL
.
	  BRANCH    OVRCD,SSTT0000          * field is mandatory
	  PACK      SSRANFR,CHOUR,COLON,CMIN
	  PACK      DSSRANFR,CHOUR,COLON,CMIN
	  PACK      DSSRANTO,CHOUR,COLON,CMIN
	  GOTO      SSTT1000
.
SSTT0100  MOVE      START,DSSRANFR
	  MOVE      SP10,SSRANFR
	  DISPLAY   *P45:10,*V2LON,DSSRANFR
.
SSTT1000  MOVE      FALSE,EXIT
	  MOVE      "59",CCOL
	  MOVE      TEN,CVERT
          MOVE      ONE,CCANLDTE
	  CALL      KEYTIME
          BRANCH    CQUEST,SSTT1000         * no question mark available
.
          MATCH     SP2,CHOUR
          GOTO      SSTT1100 IF EQUAL
.
          MATCH     EXITCHAR,CHOUR
          GOTO      SSTT9000 IF EQUAL
.
          BRANCH    OVRCD,SSTT1000          * invalid time try again
          PACK      SSRANTO,CHOUR,COLON,CMIN
          PACK      DSSRANTO,CHOUR,COLON,CMIN
          GOTO      SSTT2000
.
SSTT1100  MOVE      FINISH,DSSRANTO
          MOVE      Z10,SSRANTO
          DISPLAY   *P59:10,*V2LON,DSSRANTO
          GOTO      SSTT9999
.
SSTT2000  
          MATCH     SSRANFR,SSRANTO
          GOTO      SSTT3000 IF LESS
.
          MOVE      FALSE,EXIT
          GOTO      SSTT9999
.
.------ invalid time range entered ------
.
SSTT3000  DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
          CALL      HITENTER
          GOTO      SSTT0000
.
.------ zero entered for first to date  ------
.
SSTT9000  MOVE      TRUE,EXIT
.
SSTT9999  RETURN
+
.**********************************************************************
.*                             STAT0000                               *
.*                  Keyin Booking Status                              *
.**********************************************************************
STAT0000  KEYIN     *P45:7,*DV,*EL,UNDLN1:
                    *P45:7,*V2LON,STATUS;   * keyin required status
.
          ENDSET    STATUS
          APPEND    SP10,STATUS
          RESET     STATUS
.
          MATCH     SP1,STATUS
          GOTO      STAT1000 IF EQUAL
.
          RESET     VALSTAT
          SCAN      STATUS,VALSTAT
          GOTO      STAT0000 IF NOT EQUAL
.
          MOVE      STATUS,ANS
          REP       "B1R2C3A4N5",ANS        * get into numeric form
          MOVE      ANS,FSTATUS             * get as a form
          LOAD      STATDESC,FSTATUS,BOOKED,RESCHED,CANCELED,ATTENDED,NONATT
          DISPLAY   *P45:7,*EL,*V2LON,STATDESC
          GOTO      STAT9999
.
.------ spaces entered for status ------
.
STAT1000  DISPLAY   *P45:7,*EL,*V2LON,"All"
.
STAT9999  RETURN
+
.**********************************************************************
.*                             OTST0000                               *
.*                    Input Site Code range                           *
.**********************************************************************
OTST0000  UNPACK    SP30,DSTRANFR,DSTRANTO
          DISPLAY    *P45:8,SP6,*P59:8,SP6
          KEYIN     *P45:8,*DV,UNDLN6,*P45:8,*V2LON,STRANFR,*P45:8,*DV,STRANFR
.
          ENDSET    STRANFR
          APPEND    SP10,STRANFR
          RESET     STRANFR
.
          MATCH     SP6,STRANFR
          GOTO      OTST1000 IF EQUAL
.
          MATCH     QUEST,STRANFR
          GOTO      OTST0500 IF NOT EQUAL
.
.         ? entered
.
OTST0100  CALL      OUTDSSIT
.
OTST0150  DISPLAY   *P1:24,*EL,"Starting Site Code : "
.
OTST0200  KEYIN     *P22:24,*DV,UNDLN6,*P22:24,*V2LON,STRANFR:
                    *P22:24,*DV,STRANFR
.
          ENDSET    STRANFR
          APPEND    SP10,STRANFR
          RESET     STRANFR
.
          MATCH     SP6,STRANFR
          GOTO      OTST0400 IF EQUAL
.
          MATCH     QUEST,STRANFR
          GOTO      OTST0100 IF EQUAL
.
          PACK      KEY6,STRANFR                 * validate site 
          CALL      RDSITA1
          BRANCH    OVRCD,OTST0300
          MOVE      STRANFR,DSTRANFR
          CALL      REDISPS                      * redisp screen
          GOTO      OTST5000
.
OTST0300  
          DISPLAY    *P1:24,*EL,*B,"Site Code not on file. ";
          CALL       HITENTER
          GOTO       OTST0150
.
OTST0400
          MOVE      START,DSTRANFR
          CALL      REDISPS                      * redisp screen
          GOTO      OTST5000
.
.         validate what was entered (? not entered)
.
OTST0500  PACK      KEY6,STRANFR                 * validate site 
          CALL      RDSITA1
          BRANCH    OVRCD,OTST2000
          MOVE      STRANFR,DSTRANFR
.
          GOTO      OTST5000
.
.------ spaces entered for from site ------
.
OTST1000  MOVE      START,DSTRANFR
          DISPLAY   *P45:8,*V2LON,DSTRANFR;
          GOTO      OTST5000
.
OTST2000 
          DISPLAY   *P1:24,*EL,*B,"Site code not on file. ";
          CALL      HITENTER
          GOTO      OTST0000
.
OTST5000  KEYIN     *P59:8,*DV,UNDLN6,*P59:8,*V2LON,STRANTO,*P59:8,*DV,STRANTO
.
          ENDSET    STRANTO
          APPEND    SP10,STRANTO
          RESET     STRANTO
.
          MATCH     SP6,STRANTO
          GOTO      OTST6000 IF EQUAL
.
          MATCH     QUEST,STRANTO
          GOTO      OTST5500 IF NOT EQUAL
OTST5100  CALL      OUTDSSIT
.
OTST5150  DISPLAY   *P1:24,*EL,"Ending Site Code : "
.
OTST5200  KEYIN     *P20:24,*DV,UNDLN6,*P20:24,*V2LON,STRANTO:
                    *P20:24,*DV,STRANTO
.
          ENDSET    STRANTO
          APPEND    SP10,STRANTO
          RESET     STRANTO
.
          MATCH     SP6,STRANTO
          GOTO      OTST5400 IF EQUAL
.
          MATCH     QUEST,STRANTO
          GOTO      OTST5100 IF EQUAL
.
          PACK      KEY6,STRANTO                 * validate site 
          CALL      RDSITA1
          BRANCH    OVRCD,OTST5300
          MOVE      STRANTO,DSTRANTO
          CALL      REDISPS                      * redisp screen
          GOTO      OTST9999
.
OTST5300  
          DISPLAY    *P1:24,*EL,*B,"Site Code not on file. ";
          CALL       HITENTER
          GOTO       OTST5150
.
OTST5400
          MOVE      FINISH,DSTRANTO
          MOVE      Z10,STRANTO
          CALL      REDISPS                      * redisp screen
          GOTO      OTST9000
.
OTST5500  PACK      KEY6,STRANTO                 * validate site 
          CALL      RDSITA1
          BRANCH    OVRCD,OTST7000
          MOVE      STRANTO,DSTRANTO
.
          GOTO      OTST9000
.
.------ spaces entered for from site ------
.
OTST6000  MOVE      FINISH,DSTRANTO
          MOVE      Z10,STRANTO
          DISPLAY   *P59:8,*EL,*V2LON,DSTRANTO;
          GOTO      OTST9000
.
OTST7000 
          DISPLAY   *P1:24,*EL,*B,"Site code not on file. ";
          CALL      HITENTER
          GOTO      OTST5000
.
OTST9000  MATCH     STRANFR,STRANTO          * valid range?
          GOTO      OTST9999 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
          CALL      HITENTER
          GOTO      OTST0000
.
OTST9999  RETURN
+
.**********************************************************************
.*                             CLIN0000                               *
.*                    Input Clinic Code range                         *
.**********************************************************************
CLIN0000  UNPACK    SP30,DCLRANFR,DCLRANTO
.
          DISPLAY   *P45:9,SP6,*P59:9,SP6
          KEYIN     *P45:9,*DV,UNDLN6,*P45:9,*V2LON,CLRANFR,*P45:9,*DV,CLRANFR
.
          ENDSET    CLRANFR
          APPEND    SP10,CLRANFR
          RESET     CLRANFR
.
          MATCH     SP6,CLRANFR
          GOTO      CLIN1000 IF EQUAL
.
          MATCH     QUEST,CLRANFR
          GOTO      CLIN0500 IF NOT EQUAL
CLIN0100  CALL      OUTDSCLN
.
CLIN0150  DISPLAY   *P1:24,*EL,"Starting Clinic Code : "
.
CLIN0200  KEYIN     *P24:24,*DV,UNDLN6,*P24:24,*V2LON,CLRANFR:
                    *P24:24,*DV,CLRANFR
.
          ENDSET    CLRANFR
          APPEND    SP10,CLRANFR
          RESET     CLRANFR
.
          MATCH     SP6,CLRANFR
          GOTO      CLIN0400 IF EQUAL
.
          MATCH     QUEST,CLRANFR
          GOTO      CLIN0100 IF EQUAL
.
          MATCH     "IBARSH",PGM            * Coming from the web?
          GOTO      CLIN0201 IF EQUAL       * Don't use User Login OP Site Code
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY20,IDDD,CLRANFR,KEY8
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     IDDD,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
.
              MATCH     CLRANFR,OCACLIN
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,CLIN0300
.
CLIN0201  MOVE      CLRANFR,DCLRANFR
          CALL      REDISPS                      * redisp screen
          GOTO      CLIN5000
.
CLIN0300  DISPLAY    *P1:24,*EL,*B,"Clinic Code not on file. ";
          CALL       HITENTER
          GOTO       CLIN0150
.
CLIN0400  MOVE      START,DCLRANFR
          DISPLAY   *P45:9,*V2LON,DCLRANFR;
          CALL      REDISPS                      * redisp screen
          GOTO      CLIN5000
.
CLIN0500  MATCH     "IBARSH",PGM            * Coming from the web?
          GOTO      CLIN0501 IF EQUAL       * Don't use User Login OP Site Code
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY20,IDDD,CLRANFR,KEY8
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     IDDD,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
.
              MATCH     CLRANFR,OCACLIN
              IF        !@EQUAL
                 MOVE      ONE,OVRCD
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,CLIN2000
.
CLIN0501  MOVE      CLRANFR,DCLRANFR
          GOTO      CLIN5000
.
.------ spaces entered for from clinic ------
.
CLIN1000  MOVE      START,DCLRANFR
          DISPLAY   *P45:9,*V2LON,DCLRANFR;
          GOTO      CLIN5000
.
CLIN2000  DISPLAY   *P1:24,*EL,*B,"Clinic code not on file. ";
          CALL      HITENTER
          GOTO      CLIN0000
.
CLIN5000  KEYIN     *P59:9,*DV,UNDLN6,*P59:9,*V2LON,CLRANTO,*P59:9,*DV,CLRANTO
.
          ENDSET    CLRANTO
          APPEND    SP10,CLRANTO
          RESET     CLRANTO
.
          MATCH     SP6,CLRANTO
          GOTO      CLIN6000 IF EQUAL
.
          MATCH     QUEST,CLRANTO
          GOTO      CLIN5500 IF NOT EQUAL
.
CLIN5100  CALL      OUTDSCLN
.
CLIN5150  DISPLAY   *P1:24,*EL,"Ending Clinic Code : "
.
CLIN5200  KEYIN     *P22:24,*DV,UNDLN6,*P22:24,*V2LON,CLRANTO:
                    *P22:24,*DV,CLRANTO
.
          ENDSET    CLRANTO
          APPEND    SP10,CLRANTO
          RESET     CLRANTO
.
          MATCH     SP6,CLRANTO
          GOTO      CLIN5400 IF EQUAL
.
          MATCH     QUEST,CLRANTO
          GOTO      CLIN5100 IF EQUAL
.
          MATCH     "IBARSH",PGM            * Coming from the web?
          GOTO      CLIN5201 IF EQUAL       * Don't use User Login OP Site Code
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY20,IDDD,CLRANTO,KEY8
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     IDDD,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
.
              MATCH     CLRANTO,OCACLIN
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,CLIN5300
.
CLIN5201  MOVE      CLRANTO,DCLRANTO
          CALL      REDISPS                      * redisp screen
          GOTO      CLIN9999
.
CLIN5300  DISPLAY    *P1:24,*EL,*B,"Clinic Code not on file. ";
          CALL       HITENTER
          GOTO       CLIN5150
.
CLIN5400  MOVE      FINISH,DCLRANTO
          MOVE      Z10,CLRANTO
          CALL      REDISPS                      * redisp screen
          GOTO      CLIN9000
.
CLIN5500  MATCH     "IBARSH",PGM            * Coming from the web?
          GOTO      CLIN5501 IF EQUAL       * Don't use User Login OP Site Code
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY20,IDDD,CLRANTO,KEY8
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     IDDD,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
.
              MATCH     CLRANTO,OCACLIN
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,CLIN7000
.
CLIN5501  MOVE      CLRANTO,DCLRANTO
          GOTO      CLIN9000
.
.------ spaces entered for from site ------
.
CLIN6000  MOVE      FINISH,DCLRANTO
          MOVE      Z10,CLRANTO
          DISPLAY   *P59:9,*EL,*V2LON,DCLRANTO;
          GOTO      CLIN9000
.
CLIN7000  DISPLAY   *P1:24,*EL,*B,"Clinic code not on file. ";
          CALL      HITENTER
          GOTO      CLIN5000
.
CLIN9000  MATCH     CLRANFR,CLRANTO          * valid range?
          GOTO      CLIN9999 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
          CALL      HITENTER
          GOTO      CLIN0000
.
CLIN9999  RETURN
+

.************************************************************************
.*                           URNO0000                                   *
.*        Keyin the ur number range                                     *
.*                   called by : ML6000                                 *
.************************************************************************
URNO0000  UNPACK    SP30,DURRANFR,DURRANTO
          DISPLAY    *P45:11,SP8,*P59:11,SP8
          MOVE      "45",CCOL
          MOVE      TEN1,CVERT
          MOVE      TWO,SRCHSYS
          MOVE      ZERO,SRCHOPT
          CALL      KURN                        * keyin ur
          BRANCH    EXIT,URNO1000              * go from start
          BRANCH    OVRCD,URNO2000              * go from start
.
          MOVE      PURNO,URRANFR
          MOVE      PURNO,DURRANFR
          GOTO      URNO5000                    * get next one
.
URNO1000  MOVE      START,DURRANFR
          DISPLAY   *P45:11,*V2LON,DURRANFR
          GOTO      URNO5000
.
URNO2000  
          DISPLAY   *P1:24,*EL,*B,"Invalid U/R Number. ";
          CALL      HITENTER
          GOTO      URNO0000
.
URNO5000  
          MOVE      "59",CCOL
          MOVE      TEN1,CVERT
          MOVE      TWO,SRCHSYS
          MOVE      ZERO,SRCHOPT
          CALL      KURN                        * keyin ur
          BRANCH    EXIT,URNO6000              * go to end
.
          MOVE      PURNO,URRANTO
          MOVE      PURNO,DURRANTO
          GOTO      URNO9000                    * get next one
.
URNO6000  MOVE      FINISH,DURRANTO
          MOVE      Z10,URRANTO
          DISPLAY   *P59:11,*V2LON,DURRANTO
          GOTO      URNO9000                    * get next one
.
URNO7000  
          DISPLAY   *P1:24,*EL,*B,"Invalid U/R Number. ";
          CALL      HITENTER
          GOTO      URNO5000
.
URNO9000  MATCH    URRANFR,URRANTO             * valid range?
          GOTO     URNO9999 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Invalid Range. ";
          CALL      HITENTER
          GOTO      URNO0000
.
URNO9999  RETURN
+
.
.*****************************************************************************
.*                               KDEC0000                                    *
.*                         Keyin if they want deceased                       *
.*****************************************************************************
.
KDEC0000  DISPLAY   *P1:24,*EL,"(",*V2LON,ANSY,*HOFF,")es or (",*V2LON,ANSN:
                    *HOFF,")o"
          MOVE      ANSN,ANS
          KEYIN     *P45:12,*DV,DNO:
                    *P45:12,*V2LON,*RV,ANS
.
          PACK      ANS,ANS,SP1
          MATCH     ANS,SP1
          IF        @EQUAL
            DISPLAY   *P45:12,*V2LON,"No "
            MOVE      ZERO,DCEASEFL 
            GOTO      KDEC9999
          ENDIF
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          IF        @EQUAL
            DISPLAY   *P45:12,*V2LON,"Yes"
            MOVE      ONE,DCEASEFL 
            GOTO      KDEC9999
          ENDIF
          MATCH     ANSN,ANS
          IF        @EQUAL
            DISPLAY   *P45:12,*V2LON,"No "
            MOVE      ZERO,DCEASEFL 
            GOTO      KDEC9999
          ENDIF
          BEEP
          GOTO      KDEC0000
                    
KDEC9999  RETURN
.
.****************************************************************************
.*                            VIST0000                                      *
.*                       Keyin the visit type range                         * 
.****************************************************************************
.
VIST0000  MOVE      ZERO,EXIT
.
          BRANCH    SMSLETTR,VIST1000  * Get Visit Type codes array
          GOTO      VIST2000           * Get Visit Type range
.
.
.         Get Visit Type codes (array)...
.
VIST1000  MOVE      ZERO,VTYPECNT      * Visit Type array counter
          MOVE      ZERO,VTYPESIZ      * Visit Type array size
          MOVE      SP10,VTYPEKEY      * Visit Type array size keyin
.
          MOVE      ZERO,F3
VIST1050  ADD       ONE,F3
          IF        F3 <= 99
            PACK      VTYPEARR[F3],SP70,SP70
            GOTO      VIST1050
          ENDIF
.
          DISPLAY   *P45:15,*EL
          DISPLAY   *P1:20,*EL
          DISPLAY   *P1:21,*EL
          DISPLAY   *P1:22,*EL
.
          MOVE      "20",EVERT
          KEYIN     *P1:EVERT,*EL,"Number of Visit Types: ",*V2LON,VTYPEKEY;
          MATCH     SP70,VTYPEKEY
          IF        @EOS | @EQUAL
.
.           Blank input; i.e. ALL Visit Types selected
.
            MOVE       SP3,VTRANFR
            MOVE       Z10,VTRANTO
.
            DISPLAY   *P25:EVERT,*V2LON,"All",*HOFF;
            DISPLAY   *P45:15,*V2LON,"All Visit Types",*HOFF;
            GOTO      VIST9999
          ENDIF
.
          MOVE      VTYPEKEY,VTYPESIZ
          IF        VTYPESIZ < 1
            MOVE      ONE,EXIT
            GOTO      VIST9999
          ENDIF
.
          MOVE      ONE,VTYPECNT
          ADD       ONE,EVERT
.
VIST1100  DISPLAY   *P1:EVERT,*EL,"Visit Type ",*V2LON,VTYPECNT,*HOFF,": ";
          MOVE      "17",ECOL
.
          MOVE      ONE,CKYIMAND       * Mandatory code
          MOVE      "CV",CODE         
          CALL      PATCODKY           * Keyin Visit Type code
          BRANCH    EXIT,VIST1900
          IF        EXIT = 2             
.           Exit character keyed in (\)
            DISPLAY   *P1:22,*EL       * Clear our code description line
            GOTO      VIST1900
          ENDIF
.
          PACK      VTYPEARR[VTYPECNT],ACODE,SP70
.
          DISPLAY   *P1:22,*EL," Added ",*P17:22,*V2LON,TDESC,*HOFF;
          ADD       ONE,VTYPECNT
.
          COMPARE   VTYPESIZ,VTYPECNT
          GOTO      VIST1100 IF LESS
          GOTO      VIST1100 IF EQUAL
.
VIST1900  SUB       ONE,VTYPECNT
          DISPLAY   *P45:15,*V2LON,VTYPECNT," Visit Types selected",*HOFF;
          MOVE      ZERO,EXIT
          GOTO      VIST9999
.
.
.         Get Visit Type range...
.
VIST2000  MOVE      "CV",CODE
          MOVE      SP3,CKYIDEF3
          MOVE      TEN3,EVERT
          MOVE      "45",ECOL
.
          DISPLAY   *PECOL:EVERT,SP6
          CALL      PATCODKY
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      VIST9999
          ENDIF
.
          MOVE      ZERO,EXIT
          MOVE      ACODE,VTRANFR
          PACK      VTRANFR,VTRANFR,SP3
          MATCH     SP3,VTRANFR
          IF        @EQUAL
            DISPLAY   *P45:13,*V2LON,"Start"
            MOVE      "Start ",VTFR
          ELSE
            DISPLAY   *P45:13,*V2LON,VTRANFR
            MOVE      VTRANFR,VTFR
          ENDIF
          
          MOVE      TEN3,EVERT
          MOVE      "59",ECOL
.
          DISPLAY   *PECOL:EVERT,SP6
          CALL      PATCODKY
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      VIST9999
          ENDIF
.
          MOVE      ZERO,EXIT
          MOVE      ACODE,VTRANTO
          PACK      VTRANTO,VTRANTO,SP3
          MATCH     SP3,VTRANTO
          IF        @EQUAL
            DISPLAY   *P59:13,*V2LON,"Finish"
            MOVE      Z10,VTRANTO
            MOVE      "Finish",VTTO
          ELSE
            DISPLAY   *P59:13,*V2LON,VTRANTO
            MOVE      VTRANTO,VTTO
          ENDIF
.
          MATCH     VTRANFR,VTRANTO
          IF        @LESS
            DISPLAY   *P1:24,"Invalid Range.  ";
            CALL      HITENTER
            GOTO      VIST0000
          ENDIF
          
VIST9999  RETURN
.
.**********************************************************************
.*                           KDBM0000                                 *
.*                     Keyin date booking made range                  *
.**********************************************************************
KDBM0000  MOVE      FALSE,EXIT
          DISPLAY   *P45:14,SP10,*P59:14,SP10
	  MOVE      "45",CCOL
	  MOVE      TEN4,CVERT
	  UNPACK    SP10,CDAY,CMON,CYEAR,CCENT
          MOVE      CCC,CCENT
	  CALL      KEYDATE
	  BRANCH    CQUEST,KDBM0000         * no question mark available
.
	  MATCH     SP2,CDAY
	  GOTO      KDBM0100 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      KDBM9000 IF EQUAL
.
	  BRANCH    OVRCD,KDBM0000          * field is manditory
          
	  PACK      DBMRANFR,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DBMRANFR
          CALL      PACDATE
          MOVE      CPCDATE,DBMFR
	  GOTO      KDBM1000
.
KDBM0100  MOVE      SP10,DBMRANFR
          MOVE      "Start     ",DBMFR
	  DISPLAY   *P45:14,*V2LON,"Start"
.
KDBM1000  MOVE      FALSE,EXIT
	  MOVE      "59",CCOL
	  MOVE      TEN4,CVERT
          MOVE      ONE,CCANLDTE            * space will cancel default
	  CALL      KEYDATE
	  BRANCH    CQUEST,KDBM1000         * no question mark available
.
	  MATCH     SP2,CDAY
	  GOTO      KDBM1100 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      KDBM9000 IF EQUAL
.
	  BRANCH    OVRCD,KDBM1000          * field is manditory
	  PACK      DBMRANTO,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DBMRANTO
          CALL      PACDATE
          MOVE      CPCDATE,DBMTO
	  GOTO      KDBM2000
.
KDBM1100  MOVE      Z10,DBMRANTO
          MOVE      "Finish    ",DBMTO
	  DISPLAY   *P59:14,*V2LON,"Finish"
.
KDBM2000  MATCH     DBMRANFR,DBMRANTO       * valid range?
	  GOTO      KDBM3000 IF LESS
.
	  MOVE      FALSE,EXIT
	  GOTO      KDBM9999
.
.------ invalid date range entered ------
.
KDBM3000  DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
	  CALL      HITENTER
	  GOTO      KDBM0000
.
.------ zero entered for first date number ------
.
KDBM9000  MOVE      TRUE,EXIT
.
KDBM9999  RETURN
.
.
.**********************************************************************
.*                           KDGL0000                                 *
.*                     Keyin generate letter date range               *
.**********************************************************************
KDGL0000  MOVE      FALSE,EXIT
          DISPLAY   *P45:17,SP10,*P59:17,SP10
          MOVE      "45",CCOL
          MOVE      TEN7,CVERT
          UNPACK    SP10,CDAY,CMON,CYEAR,CCENT
          MOVE      CCC,CCENT
          CALL      KEYDATE
          BRANCH    CQUEST,KDGL0000         * no question mark available
.
          MATCH     SP2,CDAY
          GOTO      KDGL0100 IF EQUAL
.
          MATCH     EXITCHAR,CDAY
          GOTO      KDGL9000 IF EQUAL
.
          BRANCH    OVRCD,KDGL0000          * field is manditory

          PACK      DGLRANFR,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DGLRANFR
          CALL      PACDATE
          MOVE      CPCDATE,DGLFR
          GOTO      KDGL1000
.
KDGL0100  MOVE      SP10,DGLRANFR
          MOVE      "Start     ",DGLFR
          DISPLAY   *P45:17,*V2LON,"Start"
.
KDGL1000  MOVE      FALSE,EXIT
          MOVE      "59",CCOL
          MOVE      TEN7,CVERT
          MOVE      ONE,CCANLDTE            * space will cancel default
          CALL      KEYDATE
          BRANCH    CQUEST,KDGL1000         * no question mark available
.
          MATCH     SP2,CDAY
          GOTO      KDGL1100 IF EQUAL
.
          MATCH     EXITCHAR,CDAY
          GOTO      KDGL9000 IF EQUAL
.
          BRANCH    OVRCD,KDGL1000          * field is manditory
          PACK      DGLRANTO,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DGLRANTO
          CALL      PACDATE
          MOVE      CPCDATE,DGLTO
          GOTO      KDGL2000
.
KDGL1100  MOVE      Z10,DGLRANTO
          MOVE      "Finish    ",DGLTO
          DISPLAY   *P59:17,*V2LON,"Finish"
.
KDGL2000  MATCH     DGLRANFR,DGLRANTO       * valid range?
          GOTO      KDGL3000 IF LESS
.
          MOVE      FALSE,EXIT
          GOTO      KDGL9999
.
.------ invalid date range entered ------
.
KDGL3000  DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
          CALL      HITENTER
          GOTO      KDGL0000
.
.------ zero entered for first date number ------
.
KDGL9000  MOVE      TRUE,EXIT
.
KDGL9999  RETURN
+
.
.***********************************************************************
.*                         KCTY0000                                    *
.*                Keyin a range of Clinic Types                        *
.***********************************************************************
.
KCTY0000  BRANCH    SMSLETTR,KCTY1000  * Get Clinic Type codes array
          GOTO      KCTY2000           * Get Clinic Type range
.
.
.         Get Clinic Type codes (array)...
.
KCTY1000  MOVE      ZERO,CLINTCNT      * Clinic Type array counter
          MOVE      ZERO,CLINTSIZ      * Clinic Type array size
          MOVE      SP10,CLINTKEY      * Clinic Type array size keyin
.
          MOVE      ZERO,F3
KCTY1050  ADD       ONE,F3
          IF        F3 <= 99
            PACK      CLINTARR[F3],SP70,SP70
            GOTO      KCTY1050
          ENDIF
.
          DISPLAY   *P45:15,*EL
          DISPLAY   *P1:20,*EL
          DISPLAY   *P1:21,*EL
          DISPLAY   *P1:22,*EL
.
          MOVE      "20",EVERT
          KEYIN     *P1:EVERT,*EL,"Number of Clinic Types: ",*V2LON,CLINTKEY;
          MATCH     SP70,CLINTKEY
          IF        @EOS | @EQUAL
.
.           Blank input; i.e. ALL Clinic Types selected
.
            MOVE       SP6,SCLINTYP
            MOVE       Z10,ECLINTYP
.
            DISPLAY   *P25:EVERT,*V2LON,"All",*HOFF;
            DISPLAY   *P45:15,*V2LON,"All Clinic Types",*HOFF;
            GOTO      KCTY9999
          ELSE
            TYPE      CLINTKEY    * validate if keyin value is numeric
            GOTO      KCTY1000 IF NOT EQUAL
          ENDIF
.
          MOVE      CLINTKEY,CLINTSIZ
          IF        CLINTSIZ < 1
            MOVE      ONE,EXIT
            GOTO      KCTY9999
          ENDIF
.
.
.         Keyin each Clinic Type code now...
.
          MOVE      ONE,CLINTCNT
          ADD       ONE,EVERT
.
KCTY1100  DISPLAY   *P1:EVERT,*EL,"Clinic Type ",*V2LON,CLINTCNT,*HOFF,": ";
          MOVE      "17",ECOL
.
          MOVE      ONE,CKYIMAND       * Mandatory code
          CALL      KYOUTCTY           * Keyin Clinic Type code
          BRANCH    EXIT,KCTY1900
          IF        EXIT = 2             
.           Exit character keyed in (\)
            DISPLAY   *P1:22,*EL       * Clear our code description line
            GOTO      KCTY1900
          ENDIF
.
          PACK      CLINTARR[CLINTCNT],OCTCTYP,SP70
.
          DISPLAY   *P1:22,*EL," Added ",*P17:22,*V2LON,OCTDESC,*HOFF;
          ADD       ONE,CLINTCNT
.
          COMPARE   CLINTSIZ,CLINTCNT
          GOTO      KCTY1100 IF LESS
          GOTO      KCTY1100 IF EQUAL
.
KCTY1900  SUB       ONE,CLINTCNT
          DISPLAY   *P45:15,*V2LON,CLINTCNT," Clinic Type(s) selected",*HOFF;
          MOVE      ZERO,EXIT
          GOTO      KCTY9999
.
.
.         Get Clinic Type range...
.
KCTY2000  MOVE      TEN5,EVERT
          MOVE      "45",ECOL 
          DISPLAY   *P59:EVERT,*EL
.
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
.
          CALL      KYOUTCTY
          IF        EXIT = 1
           MOVE       ZERO,EXIT
           DISPLAY    *PECOL:EVERT,*V2LON,"Start "
           MOVE       SP6,SCLINTYP
           GOTO       KCTY5000
          ENDIF
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KCTY9999
          ENDIF
          MOVE      OCTCTYP,SCLINTYP
.
KCTY5000  MOVE      "59",ECOL 
          CALL      KYOUTCTY
          IF        EXIT = 1
           MOVE       ZERO,EXIT
           DISPLAY    *PECOL:EVERT,*V2LON,"Finish"
           MOVE       Z10,ECLINTYP
           GOTO       KCTY9000
          ENDIF
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KCTY9999
          ENDIF
          MOVE      OCTCTYP,ECLINTYP
.
KCTY9000  MATCH     SCLINTYP,ECLINTYP
          IF        @LESS
            DISPLAY    *P1:24,*B,*EL,"Invalid range. ";
            CALL       HITENTER
            GOTO       KCTY0000
          ENDIF
.
KCTY9999  RETURN
+
.
.***********************************************************************
.*                         KOTC0000                                    *
.*                Keyin a range of outcomes                            *
.***********************************************************************
.
KOTC0000  MOVE      TEN6,EVERT
          MOVE      "45",ECOL 
          DISPLAY   *P59:EVERT,*EL
          PACK      CODE,ANSO,ANSZ
.
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
.
          CALL      PATCODKY
          IF        EXIT = 1
           MOVE       ZERO,EXIT
           DISPLAY    *PECOL:EVERT,*V2LON,"Start "
           MOVE       SP6,SOUTCOME
           GOTO       KOTC5000
          ENDIF
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KOTC9999
          ENDIF
          MOVE      ACODE,SCLINTYP
.
KOTC5000  MOVE      "59",ECOL 
          CALL      PATCODKY
          IF        EXIT = 1
           MOVE       ZERO,EXIT
           DISPLAY    *PECOL:EVERT,*V2LON,"Finish"
           MOVE       Z10,EOUTCOME
           GOTO       KOTC9000
          ENDIF
          IF        EXIT = 2
            MOVE      ONE,EXIT
            GOTO      KOTC9999
          ENDIF
          MOVE        ACODE,EOUTCOME
.
KOTC9000  MATCH     SCLINTYP,ECLINTYP
          IF        @LESS
            DISPLAY    *P1:24,*B,*EL,"Invalid range. ";
            CALL       HITENTER
            GOTO       KOTC0000
          ENDIF
.
          
KOTC9999  RETURN
.
.************************************************************************
.*                             KSOM0000                                 *
.*                  Keyin for standard or misc. letters                 *
.************************************************************************
.
KSOM0000
          KEYIN     *P36:7,*EL,*V2LON,ANS:
                    *P36:7,*DV,ANS
          REP       UPPLOW,ANS
.
          MATCH     ANSM,ANS
          IF        @EQUAL
            MOVE      ZERO,SMFLAG
            DISPLAY   *P37:7,"iscellaneous"
            GOTO      KSOM9999
          ENDIF
.
          MATCH     ANSS,ANS
          IF        @EQUAL
            MOVE      ONE,SMFLAG
            DISPLAY   *P37:7,"tandard     "
            GOTO      KSOM9999
          ENDIF
          BEEP
          GOTO      KSOM0000
.
KSOM9999  RETURN 
.
.************************************************************************
.*                        GETSVAR                                       *
.*          dummy routine required by kurn                              *
.*                   called by : KURN                                   *
.************************************************************************
GETSVAR   RETURN
.************************************************************************
.*                         REDISPS                                      *
.*       redisplay adhoc enquiry screen                                 *
.*                   called by : KURN                                   *
.************************************************************************
REDISPS   CALL      GOPN0000            
          DISPLAY   *P45:5,*V2LON,DBRANFR,*HOFF,*P56:5,"to",*P59:5,*V2LON:
                    DBRANTO:
                    *P45:7,STATDESC:
                    *P45:8,DSTRANFR,*HOFF,*P56:8,"to",*P59:8,*V2LON:
                    DSTRANTO:
                    *P45:9,DCLRANFR,*HOFF,*P56:9,"to",*P59:9,*V2LON:
                    DCLRANTO:
                    *P45:10,DSSRANFR,*HOFF,*P56:10,"to",*P59:10,*V2LON:
                    DSSRANTO:
                    *P45:11,DURRANFR,*HOFF,*P56:11,"to",*P59:11,*V2LON:
                    DURRANTO:
                    *P45:13,VTFR,*HOFF,*P56:13,"to",*P59:13,*V2LON:
                    VTTO: 
                    *P45:14,DBMFR,*HOFF,*P56:14,"to",*P59:14,*V2LON:
                    DBMTO 
.
          RETURN
+
.**********************************************************************
.*                          BALN0000                                  *
.*                   Input minimum balance                            *
.**********************************************************************
BALN0000  MOVE      TRUE,FLAGBALN
          MOVE      ZERO,BALANCE
          DISPLAY   *P36:8,UNDLN11;
          KEYIN     *P36:8,*V2LON,*RV,BALANCE            * keyin balance
          PACK      BALDISP,DOLLAR,BALANCE               * set up balance
          MOVE      BALDISP,LINE                         *   display
          CALL      COMP0000                             * compress multiple
          MOVE      LINE,BALDISP                         *   blanks
          DISPLAY   *P36:8,*V2LON,BALDISP
          GOTO      BALN9999
.
BALN9999  RETURN
+
+
.**********************************************************************
.*                           EXTR0000                                 *
.*         Extracts the required information from various files       *
.*              for general letters                                   *
.**********************************************************************
EXTR0000  MOVE      TRUE,EXIT
          IF        SMSLETTR=1
            MATCH     SP70,BRANFR      * Blank From Booking Date range
            IF        @EQUAL
              MATCH     ZEDS,BRANTO    * Blank To Booking Date range
              IF        @EQUAL
                DISPLAY   *P1:24,*EL,*B,"Invalid Booking Date range (blank)":
                          " for SMS! ";
                CALL      HITENTER
                GOTO      EXTR9999     * bail; we don't want blank date range
              ENDIF
            ENDIF
          ENDIF
          CALL      CTMP0000                * create the tempfile  
          MOVE      ZERO,PATCOUNT
          DISPLAY   *P1:24,*EL,"Searching : ",*P29:24,"Processing : ":
                    *P58:24,"No. found :";
.
          MOVE      STRANFR,KEY6            * starting site as key
          CALL      RDSITA1
          COMPARE   ZERO,OVRCD
          GOTO      EXTR2000 IF EQUAL       * valid item
.
          MOVE      SP6,KEY6                * start entered
          CALL      RDSSITA1                * position at start of file
.
. ------- next read site file ------
.
EXTR1000  CALL      RDKSITA1
          BRANCH    OVRCD,EXTR9999
.
EXTR2000  MATCH     OSTSITE,STRANTO
          GOTO      EXTR9999 IF LESS        * finished the range
.
          MOVE      OSTDESC,TEMPSITE        * save description
          DISPLAY   *P13:24,*V2LON,OSTSITE  * display site to show working
          CALL      ECLF0000                * extract from clinic file
          GOTO      EXTR1000                * get next site
.
EXTR9999  RETURN
+
.************************************************************************
.*                         ECLF0000                                     *
.*       Extract all relevant records for outcliaf file                 *
.*                   called by : EXTR2000                               *
.************************************************************************
ECLF0000  PACK      CFNAME,OSTFILE,FILCLIA1   * open site dependent clinic file
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME,OSTFILE,FILBOKA1   * open outboka and outbokb if 
          OPEN      OUTBOKA1,CFNAME           * status is not (R)esh. or (C)anc
.
          PACK      CFNAME,OSTFILE,FILBB1A1
          CALL      OPOTBB11                  
.
          PACK      CFNAME,OSTFILE,FILRSHA2   * open reshedule file
          OPEN      OUTRSHA2,CFNAME
.
          PACK      CFNAME,OSTFILE,FILCANA3   * open cancellation file
          OPEN      OUTCANA3,CFNAME
.
.         start the processing
.
ECLF4000  PACK      KEY20,OSTSITE,CLRANFR,SP20
          CALL      RDSCLIA1
          CALL      RDKCLIA1
          BRANCH    OVRCD,ECLF9999
.
          MATCH     OSTSITE,OCASITE
          IF        !@EQUAL
            MOVE      ONE,OVRCD           * Clinic Site doesn't match
          ELSE
            MATCH     SP70,CLRANFR        * Clinic Code Start blank; continue
            GOTO      ECLF5100 IF EQUAL
.
            MATCH     CLRANFR,OCACLIN     * Clinic Code within range?
            IF        @LESS
              MOVE      ONE,OVRCD         * No; Clinic Code before Start Range
            ENDIF
          ENDIF
.
          COMPARE   ZERO,OVRCD
          GOTO      ECLF5100 IF EQUAL     * Got our starting Clinic Code
          GOTO      ECLF9999              * No matching Clinic/Site; finished 
.
ECLF5000  CALL      RDKCLIA1                  * read next record
          BRANCH    OVRCD,ECLF9999
.
ECLF5100  DISPLAY   *P20:24,*V2LON,OCACLIN    * display the clinic
.
          MATCH     OSTSITE,OCASITE           * same site still ?
          GOTO      ECLF9999 IF NOT EQUAL     * no - finished
.
          MATCH     OCACLIN,CLRANTO           * clinic in range?
          GOTO      ECLF9999 IF LESS          * reached the end of the range
          PACK      SKEY20,OCASITE,OCACLIN,OCADATE
.
ECLF5200  MATCH     SP1,STATUS                * doing all?
          GOTO      ECLF9000 IF EQUAL         * using all statuses
          MOVE      ONE,CVERT
.
          BRANCH    FSTATUS,ECLF6000,ECLF7000,ECLF8000,ECLF6000,ECLF6000
.                           Booked   Resch    Cancel   Attended Non-Att
          GOTO      ECLF9000
.
ECLF6000  CALL      BOKA0000                  * do it in the boka file 
          MOVE      SKEY20,KEY20
          CALL      RDSCLIA1
          GOTO      ECLF5000
.
ECLF7000  CALL      RSHD0000                  * do it in the reshedule file
          MOVE      SKEY20,KEY20
          CALL      RDSCLIA1
          GOTO      ECLF5000
.
ECLF8000  CALL      CANC0000                  * do it in the cancellation file 
          MOVE      SKEY20,KEY20
          CALL      RDSCLIA1
          GOTO      ECLF5000
.
ECLF9000  CALL      BOKA0000                  * do it in the boka file 
          CALL      RSHD0000                  * do it in the reshedule file
          CALL      CANC0000                  * do it in the cancellation file 
          MOVE      SKEY20,KEY20
          CALL      RDSCLIA1
          GOTO      ECLF5000
.
ECLF9999  RETURN
+
.************************************************************************
.*                          BOKA0000                                    *
.*         Initialize and read thru boka file, getting all relevent pats*
.*                   called by : ECLF6000,ECLF9000                      *
.************************************************************************
BOKA0000  PACK     KEY28,OSTSITE,OCACLIN,BRANFR,SSRANFR,SP3
          CALL     RDSBOKA1
.
BOKA1000  CALL     RDKBOKA1                 * read next record
          BRANCH   OVRCD,BOKA9999
.
          DISPLAY  *P42:24,*V2LON,OBADATE   * display the date
.
          MATCH    OBASITE,OSTSITE 
          GOTO     BOKA9999 IF NOT EQUAL    * different site
.
          MATCH    OBACLIN,OCACLIN
          GOTO     BOKA9999 IF NOT EQUAL    * different clinic
.
          MATCH    OBADATE,BRANTO
          GOTO     BOKA9999 IF LESS         * clinic date is too late
.
          BRANCH   OBASTAT,BOKA1500,BOKA1000,BOKA1000,BOKA1500,BOKA1500
.                          Booked   Not used Extended Attended Not-attended
          GOTO     BOKA1000                 * not booked
.
BOKA1500  MATCH    SP1,STATUS
          GOTO     BOKA2000 IF EQUAL        * using all statuses
.
          COMPARE  FSTATUS,OBASTAT
          GOTO     BOKA1000 IF NOT EQUAL    * not the right status
.
.         check time ranges
.
BOKA2000  MATCH    SSRANFR,OBATIME
          GOTO     BOKA1000 IF LESS         * clinic time too early
.
          MATCH    OBATIME,SSRANTO
          GOTO     BOKA9999 IF LESS         * clinic time too late
.
          MATCH    OBAURNO,URRANTO
          GOTO     BOKA1000 IF LESS         * UR number too early
.
          MATCH    URRANFR,OBAURNO 
          GOTO     BOKA1000 IF LESS         * UR number too late
.
          MOVE     OBABKDTE,DIM8
          REP      " 0",DIM8
          MATCH    DBMRANFR,DIM8 
          GOTO     BOKA1000 IF LESS         * date booking made is too early
.
          MATCH    DIM8,DBMRANTO
          GOTO     BOKA1000 IF LESS         * Date Booking Made is too late
.
          BRANCH   SMSLETTR,BOKA2100        * SMS Letter?
.
          MATCH    VTRANFR,OBAVISIT 
          GOTO     BOKA1000 IF LESS         * Validate the visit type       
.
          MATCH    OBAVISIT,VTRANTO
          GOTO     BOKA1000 IF LESS         * Validate the visit type       
.
          MATCH    SCLINTYP,OBACTYP  
          GOTO     BOKA1000 IF LESS         * Validate the clinic type       
.
          MATCH    OBACTYP,ECLINTYP
          GOTO     BOKA1000 IF LESS         * Validate the clinic type       
.
          GOTO     BOKA2200
.
BOKA2100  MOVE     OBAVISIT,CHKVTYPE        * Validate Visit Type
          CALL     CHKVTY00                 * Check if exists in array
          BRANCH   EXIT,BOKA1000            * Doesn't exist get next record

          MOVE     OBACTYP,CHKCLITY         * Validate Clinic Type
          CALL     CHKCLI00                 * Check if exists in array
          BRANCH   EXIT,BOKA1000            * Doesn't exist; get next record
.
          GOTO     BOKA2200                 * Found matching Clinic Type
.                                           *  and Visit Type
BOKA2200  MOVE     OBAURNO,TEMPURNO
          PACK     KEY8,OBAOUTNO
          CALL     RDBOKB1                  * read the bokb file
          BRANCH   OVRCD,BOKA1000           * invalid data
. 
          MATCH    SOUTCOME,OTBBOUTC        * Validate the outcome
          GOTO     BOKA1000 IF LESS
.
          MATCH    OTBBOUTC,EOUTCOME        * Validate the outcome
          GOTO     BOKA1000 IF LESS
.
          MATCH    SP70,DGLRANFR            * Generate Letter Date - From range?
          GOTO     BOKA4000 IF EOS          * Skip test
          GOTO     BOKA4000 IF EQUAL        * Skip test
.
          MATCH    Z10,DGLRANTO             * Generate Letter Date - To range?
          GOTO     BOKA4000 IF EOS          * Skip test
          GOTO     BOKA4000 IF EQUAL        * Skip test
.
BOKA3000  MATCH    "1",OTBBSNGL             * Send Letter Must be Yes
          GOTO     BOKA1000 IF NOT EQUAL 
.
          MATCH    DGLRANFR,OTBBGLDT
          GOTO     BOKA1000 IF LESS         * Generate letter date is too early
.
          MATCH    OTBBGLDT,DGLRANTO
          GOTO     BOKA1000 IF LESS         * Generate letter date is too late
.
BOKA4000  MOVE     OCACLIN,TMPCLIN                                     *I-52435
.
          IF        IBCNMHOS = 0
            GOTO      BOKA4020
          ENDIF
.
          MOVE      DOBAOUTN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,BOKA1000
. 
          MATCH     SP70,FILTHOSP           * Hospital Filter
          IF        !@EQUAL
            MATCH     PMVXMHOS,FILTHOSP
            GOTO      BOKA1000 IF NOT EQUAL
          ELSE
            IF        ALLHSPAC = ZERO
              PACK      KEY13,USERID,PMVXMHOS,SP70  * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,BOKA1000      * no access to hospital
            ENDIF
          ENDIF
.
BOKA4020  CALL     VBOA0000                   * set up file variables
          MOVE     ONE,POSTCLSS
          IF       OTCNPSTC = 1
            MOVE      OBADATE,PCLSDATE        * Postage class date
            CALL     CPCL0000                 * calculate the postage class
.                                               1 = 1st class 2 = 2nd class
          ENDIF
          MOVE      OSTSITE,SITE
          MOVE      SP1,TEMPRSHF
          CALL      GOTP0000                   * got a patient- keep going
          PACK      KEY21,POSTCLSS,TEMPOUTN,TEMPCLID,TEMPCLTY
          CALL      RATMP                 
          IF        OVRCD=1
            CALL      WRTMP                 * write to tempfile
          ENDIF
          MOVE      TMPCLIN,OCACLIN                                    *I-52435
.
          GOTO      BOKA1000
.
BOKA9999  RETURN
+
.************************************************************************
.*                          RSHD0000                                    *
.*         Initialize and read thru RSHD file, getting all relevent pats*
.*                   called by : ECLF6000,ECLF9000                      *
.************************************************************************
RSHD0000  PACK     KEY36,OSTSITE,OCACLIN,BRANFR,SSRANFR,SP30
          CALL     RDSRSHA2
.
RSHD1000  CALL     RDKRSHA2                   * read next record
          BRANCH   OVRCD,RSHD9999
.
          MATCH    OPRSSITE,OSTSITE            * right site?
          GOTO     RSHD9999 IF NOT EQUAL      * if not - go out
.
          MATCH    OPRSCLIN,OCACLIN            * right clinic?
          GOTO     RSHD9999 IF NOT EQUAL      * if not - go out
.
          MATCH    OPRSDATE,BRANTO             * in date range ?
          GOTO     RSHD9999 IF LESS           * if not - go out
.
          MATCH    BRANFR,OPRSDATE             * in date range ?
          GOTO     RSHD1000 IF LESS           * if not - go out
.
          MATCH    SSRANFR,OPRSSTRT             * in time range ?
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MATCH    OPRSSTRT,SSRANTO             * in time range ?
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          PACK     KEY28,OPRSSITE,OPRSNCLI,OPRSNDAT,OPRSNSTR,OPRSNSLO
          CALL     RDBOKA1                    * read booking file for ur
          BRANCH   OVRCD,RSHD1000        
.
          MATCH    DOPRSOUT,DOBAOUTN
          GOTO     RSHD1000 IF NOT EQUAL
.
          MATCH    URRANFR,OBAURNO            * in ur range ?
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MATCH    OBAURNO,URRANTO            * in ur range ?
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MOVE     OBABKDTE,DIM8
          REP      " 0",DIM8
          MATCH    DBMRANFR,DIM8 
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MATCH    DIM8,DBMRANTO
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          BRANCH   SMSLETTR,RSHD1100        * SMS Letter?
.
          MATCH    VTRANFR,OBAVISIT 
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MATCH    OBAVISIT,VTRANTO
          GOTO     RSHD1000 IF LESS           * if not - get next record
.
          MATCH    SCLINTYP,OBACTYP  
          GOTO     RSHD1000 IF LESS           * Validate the clinic type       
.
          MATCH    OBACTYP,ECLINTYP
          GOTO     RSHD1000 IF LESS           * Validate the clinic type       
.
          GOTO     RSHD2000
.
RSHD1100  MOVE     OBAVISIT,CHKVTYPE        * Validate Visit Type
          CALL     CHKVTY00                 * Check if exists in array?
          BRANCH   EXIT,RSHD1000            * Doesn't exist; get next record
.
          MOVE     OBACTYP,CHKCLITY         * Validate Clinic Type
          CALL     CHKCLI00                 * Check if exists in array?
          BRANCH   EXIT,RSHD1000            * Doesn't exist; get next record
.
          GOTO     RSHD2000                 * Found matching Clinic Type
.                                           *  and Visit Type
RSHD2000  MOVE     OBAURNO,TEMPURNO
          PACK     KEY8,OBAOUTNO
          CALL     RDBOKB1
.
          MATCH    SOUTCOME,OTBBOUTC        * Validate the outcome
          GOTO     RSHD1000 IF LESS
      
          MATCH    OTBBOUTC,EOUTCOME        * Validate the outcome
          GOTO     RSHD1000 IF LESS
.
          MATCH    SP70,DGLRANFR            * Generate Letter Date - From range?
          GOTO     RSHD4000 IF EOS          * Skip test
          GOTO     RSHD4000 IF EQUAL        * Skip test
.
          MATCH    Z10,DGLRANTO             * Generate Letter Date - To range?
          GOTO     RSHD4000 IF EOS          * Skip test
          GOTO     RSHD4000 IF EQUAL        * Skip test
.
RSHD3000  MATCH    "1",OTBBSNGL             * Send Letter Must be Yes
          GOTO     RSHD1000 IF NOT EQUAL
.
          MATCH    DGLRANFR,OTBBGLDT
          GOTO     RSHD1000 IF LESS         * Generate letter date is too early
.
          MATCH    OTBBGLDT,DGLRANTO
          GOTO     RSHD1000 IF LESS         * Generate letter date is too late
.
RSHD4000  MATCH    OBADATE,OPRSNDAT
          IF       @LESS
            MOVE     OBADATE,PCLSDATE
          ELSE
            MOVE     OPRSNDAT,PCLSDATE
          ENDIF
          MOVE     ONE,POSTCLSS
          IF       OTCNPSTC = 1
            CALL     CPCL0000                 * calculate the postage class
.                                               1 = 1st class 2 = 2nd class
          ENDIF
.
          MOVE     OCACLIN,TMPCLIN                                     *I-52435
          CALL     VBOA0000                   get variables from bokb for gotp
.
          MOVE      OSTSITE,SITE
          MOVE      SP1,TEMPRSHF
          CALL      GOTP0000                   * got a patient- keep going
          PACK      KEY21,POSTCLSS,TEMPOUTN,TEMPCLID,TEMPCLTY
          CALL      RATMP                 
          IF        OVRCD=1
            CALL      WRTMP                 * write to tempfile
          ENDIF
          MOVE      TMPCLIN,OCACLIN                                    *I-52435
.
          GOTO      RSHD1000
.
RSHD9999  RETURN
+
.************************************************************************
.*                          CANC0000                                    *
.*         Initialize and read thru CANC file, getting all relevent pats*
.*                   called by : ECLF6000,ECLF9000                      *
.************************************************************************
CANC0000  MATCH     SP70,DGLRANFR      * Generate Letter Date - From range?
          GOTO      CANC0010 IF EOS
          GOTO      CANC0010 IF EQUAL
.
          GOTO      CANC9999      * Skip cancelled visits if using any range
.
CANC0010  MATCH     Z10,DGLRANTO       * Generate Letter Date - To range?
          GOTO      CANC0020 IF EOS
          GOTO      CANC0020 IF EQUAL
.
          GOTO      CANC9999      * Skip cancelled visits if using any range
.
CANC0020  PACK      KEY33,OSTSITE,OCACLIN,BRANFR,SSRANFR,SP30
          CALL      RSOTCAN3
.
CANC1000  CALL      RKOTCAN3                   * read next record
          BRANCH    OVRCD,CANC9999
.
          MATCH     OPCNSITE,OSTSITE            * right site?
          GOTO      CANC9999 IF NOT EQUAL      * if not - go out
.
          MATCH     OPCNCLIN,OCACLIN            * right clinic?
          GOTO      CANC9999 IF NOT EQUAL      * if not - go out
.
          MATCH     OPCNDATE,BRANTO             * in date range ?
          GOTO      CANC1000 IF LESS           * if not - go out
.
          MATCH     BRANFR,OPCNDATE             * in date range ?
          GOTO      CANC1000 IF LESS           * if not - go out
.
          MATCH     OPCNSTRT,SSRANTO             * in time range ?
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     SSRANFR,OPCNSTRT             * in time range ?
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     OPCNURNO,URRANTO            * in ur range ?
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     URRANFR,OPCNURNO            * in ur range ?
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          PACK      KEY28,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,OPCNSLOT
          CALL      RDBOKA1                    * read booking file for ur
          BRANCH    OVRCD,CANC1000        
.
          MOVE      OBABKDTE,DIM8
          REP       " 0",DIM8
          MATCH     DBMRANFR,DIM8 
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     DIM8,DBMRANTO
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          BRANCH    SMSLETTR,CANC1100       * SMS Letter?
.
          MATCH     VTRANFR,OBAVISIT 
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     OBAVISIT,VTRANTO
          GOTO      CANC1000 IF LESS           * if not - get next record
.
          MATCH     SCLINTYP,OBACTYP  
          GOTO      CANC1000 IF LESS           * Validate the clinic type       
.
          MATCH     OBACTYP,ECLINTYP
          GOTO      CANC1000 IF LESS           * Validate the clinic type       
. 
          GOTO      CANC2000
.
CANC1100  MOVE      OBAVISIT,CHKVTYPE       * Validate Visit Type
          CALL      CHKVTY00                * Check if exists in array?
          BRANCH    EXIT,CANC1000           * Doesn't exist; get next record
.
          MOVE      OBACTYP,CHKCLITY        * Validate Clinic Type
          CALL      CHKCLI00                * Check if exists in array?
          BRANCH    EXIT,CANC1000           * Doesn't exist; get next record
.
          GOTO      CANC2000                * Found matching Clinic Type
.                                           *  and Visit Type
CANC2000  CALL      VCAN0000                * get variables from canc file
          MOVE      OPCNDATE,PCLSDATE       * Postage class date
          MOVE      ONE,POSTCLSS
          IF        OTCNPSTC = 1
            CALL      CPCL0000                 * calculate the postage class
.                                               1 = 1st class 2 = 2nd class
          ENDIF
          MOVE      OSTSITE,SITE
          MOVE      SP1,TEMPRSHF
          CALL      GOTP0000                   * got a patient- keep going
          PACK      KEY21,POSTCLSS,TEMPOUTN,TEMPCLID,TEMPCLTY
          CALL      RATMP                 
          IF        OVRCD=1
            CALL      WRTMP                 * write to tempfile
          ENDIF
.
          GOTO      CANC1000
.
CANC9999  RETURN
+
.******************************************************************************
.*                           CHKCLI00                                         *
.*                  Check Clinic Type (code) exists in our filter array       *
.*                                                                            *
.*        Parameter:                                                          *
.*          CHKCLITY - Clinic Type (code)                                     *
.*                                                                            *
.*        Return:                                                             *
.*              EXIT : 0 - Exists                                             *
.*                     1 - Does NOT exist                                     *
.******************************************************************************
CHKCLI00  IF        CLINTCNT = 0
            GOTO      CHKCLI90    * ALL Clinic Types selected; bypass check
          ENDIF
.
          MOVE      ZERO,F3
CHKCLI10  ADD       ONE,F3
          MATCH     CLINTARR[F3],CHKCLITY
          GOTO      CHKCLI90 IF EQUAL
.
          COMPARE   CLINTCNT,F3
          GOTO      CHKCLI10 IF LESS
.
          GOTO      CHKCLI91
.
CHKCLI90  MOVE      ZERO,EXIT     * Clinic Type exists
          GOTO      CHKCLI99
.
CHKCLI91  MOVE      ONE,EXIT      * Clinic Type does NOT exist
          GOTO      CHKCLI99
.
CHKCLI99  RETURN
+
.******************************************************************************
.* CHKVTY00 Check Visit Type (code) exists in our filter array                *
.*                                                                            *
.*        Parameter:                                                          *
.*          CHKVTYPE - Visit Type (code)                                      *
.*                                                                            *
.*        Return:                                                             *
.*              EXIT : 0 - Exists                                             *
.*                     1 - Does NOT exist                                     *
.******************************************************************************
CHKVTY00  IF        VTYPECNT = 0
            GOTO      CHKVTY90    * ALL Visit Types selected; bypass check
          ENDIF
.
          MOVE      ZERO,F3
CHKVTY10  ADD       ONE,F3
          MATCH     VTYPEARR[F3],CHKVTYPE
          GOTO      CHKVTY90 IF EQUAL
.
          COMPARE   VTYPECNT,F3
          GOTO      CHKVTY10 IF LESS
.
          GOTO      CHKVTY91
.
CHKVTY90  MOVE      ZERO,EXIT     * Visit Type exists
          GOTO      CHKVTY99
.
CHKVTY91  MOVE      ONE,EXIT      * Visit Type does NOT exist
          GOTO      CHKVTY99
.
CHKVTY99  RETURN
+
.************************************************************************
.*                          CPCL0000                                    *
.*                   Calculate The Postage Class                        *
.************************************************************************
.
CPCL0000  
          MATCH     PCLSDATE,COFFDATE
.
.---   If the cut-off date is less than "appointmnet" date - send 2nd class ---
.---   If cut off date is equal to the appointment date - send first class ----
.
          IF        @LESS
            MOVE      TWO,POSTCLSS
            GOTO      CPCL9999
          ENDIF
          IF        @EQUAL
            MOVE      ONE,POSTCLSS
            GOTO      CPCL9999
          ENDIF
.
.------   If the "appointment" date is less than today then send second class
.
          MATCH     TODAY,PCLSDATE
          IF        @LESS
            MOVE      TWO,POSTCLSS
            GOTO      CPCL9999
          ENDIF

.
.------   Else we have 1st class postage -----
.
          MOVE      ONE,POSTCLSS
.
CPCL9999  RETURN
+
.************************************************************************
.*                          VCAN0000                                    *
.*            move canc details to tempfile variables                   *
.*                   called by : CANC2000                               *
.************************************************************************
VCAN0000  MOVE      OPCNOUTN,TEMPOUTN
          MOVE      OPCNURNO,TEMPURNO
.
          MOVE      OPCNDATE,WORKDATE
          CALL      FDAT0000                * format attendence date
          MOVE      DATELINE,TEMPATDT       
.
          MOVE      OPCNSTRT,WORKTIME
          CALL      TIME0000                * format attendence time
          MOVE      FRMTTIME,TEMPATTM 
.
          MOVE      OPCNCOMP,TEMPCOMP        * pass comp. eligib.
          MOVE      OBAINS,TEMPINSR         * pass insurance status
          MOVE      OPCNCAT,TEMPPCAT         * pass patient category
          MOVE      OPCNCLAS,TEMPCLSS       * pass patient classification
          MOVE      OPCNPRTY,TEMPPRTY        * pass patient priority
          MOVE      OPCNSRCR,TEMPSREF        * pass source of referral 
.
VCAN9999  RETURN
+
.************************************************************************
.*                          LOAD0000                                    *
.*            move tempfile variables into Adhoc Letter list            *
.*                   called by : CANC2000                               *
.************************************************************************
LOAD0000  MOVE      SELECTID,OTLASEID
          MOVE      POSTCLSS,OTLAPCLS
          MOVE      TEMPOUTN,OTLAOUTN
          MOVE      TEMPATDT,OTLAATDT
          MOVE      TEMPATTM,OTLAATTM
          MOVE      TEMPBDAT,OTLABDAT
          MOVE      TEMPCTRY,OTLACTRY
          MOVE      TEMPCOMP,OTLACOMP        * pass comp. eligib.
          MOVE      TEMPTDAY,OTLATDAY
          MOVE      TEMPNAME,OTLANAME
          MOVE      TEMPINSR,OTLAINSR         * pass insurance status
          MOVE      TEMPPCAT,OTLAPCAT         * pass patient category
          MOVE      TEMPCLSS,OTLACLSS       * pass patient classification
          MOVE      TEMPPRTY,OTLAPRTY        * pass patient priority
          MOVE      TEMPPSEX,OTLAPSEX
          MOVE      TEMPSREF,OTLASREF
          MOVE      TEMPURNO,OTLAURNO
          MOVE      TEMPSITE,OTLASITE
          MOVE      TEMPBKDT,OTLABKDT
          MOVE      TEMPBTIM,OTLABTIM
          MOVE      TEMPSLOT,OTLASLOT
          MOVE      TEMPSTIM,OTLASTIM
          MOVE      TEMPCLID,OTLACLID
          MOVE      TEMPCLDX,OTLACLDX
          MOVE      TEMPDTIT,OTLADTIT
          MOVE      TEMPDSNM,OTLADSNM
          MOVE      TEMPDGNM,OTLADGNM
          MOVE      TEMPDOCT,OTLADOCT
          MOVE      SITE,OTLASITC
          MOVE      TEMPCLTY,OTLACLTY
          MOVE      TEMPDATE,OTLADATE
          MOVE      TEMPSTRT,OTLASTRT
          MOVE      TEMPRSHF,OTLARSHF
          MOVE      ZERO,OTLADLST
          MOVE      TEMPCTYP,OTLACTYP
.
LOAD9999  RETURN
+
.************************************************************************
.*                          LDTM0000                                    *
.*            move outladaf variables into tempfile variables           *
.************************************************************************
LDTM0000  PACK      SELECTID,OTLASEID
          PACK      POSTCLSS,OTLAPCLS
          MOVE      OTLAOUTN,TEMPOUTN
          PACK      TEMPATDT,OTLAATDT
          PACK      TEMPATTM,OTLAATTM
          PACK      TEMPBDAT,OTLABDAT
          PACK      TEMPCTRY,OTLACTRY
          PACK      TEMPCOMP,OTLACOMP        * pass comp. eligib.
          PACK      TEMPTDAY,OTLATDAY
          PACK      TEMPNAME,OTLANAME
          PACK      TEMPINSR,OTLAINSR         * pass insurance status
          PACK      TEMPPCAT,OTLAPCAT         * pass patient category
          PACK      TEMPCLSS,OTLACLSS       * pass patient classification
          PACK      TEMPPRTY,OTLAPRTY        * pass patient priority
          PACK      TEMPPSEX,OTLAPSEX
          PACK      TEMPSREF,OTLASREF
          PACK      TEMPURNO,OTLAURNO
          PACK      TEMPSITE,OTLASITE
          PACK      TEMPBKDT,OTLABKDT
          PACK      TEMPBTIM,OTLABTIM
          PACK      TEMPSLOT,OTLASLOT
          PACK      TEMPSTIM,OTLASTIM
          PACK      TEMPCLID,OTLACLID
          PACK      TEMPCLDX,OTLACLDX
          PACK      TEMPDTIT,OTLADTIT
          PACK      TEMPDSNM,OTLADSNM
          PACK      TEMPDGNM,OTLADGNM
          PACK      TEMPDOCT,OTLADOCT
          PACK      SITE,OTLASITC
          PACK      TEMPCLTY,OTLACLTY
          PACK      TEMPDATE,OTLADATE
          PACK      TEMPSTRT,OTLASTRT
          PACK      TEMPRSHF,OTLARSHF
          PACK      TEMPDLST,OTLADLST
          PACK      TEMPCTYP,OTLACTYP
.
LDTM9999  RETURN
+
.************************************************************************
.*                          SVCQ0000                                    *
.* Set values of outbokaf fields that are used in LETEXE00 for          *
.* vcq letter printing as outbokaf is not read                          *
.************************************************************************
SVCQ0000  MOVE      OTLAURNO,OBAURNO
          MOVE      OTLAOUTN,OBAOUTNO
          MOVE      OTLASITC,OBASITE
          MOVE      OTLACLID,OBACLIN
          MOVE      OTLADATE,OBADATE
          MOVE      OTLASTRT,OBASTRT
          MOVE      OTLASLOT,OBASLOT
.
SVCQ9999  RETURN
+
.**********************************************************************
.*                           FDAT0000                                 *
.*                 Routine to format the date                         *
.**********************************************************************
FDAT0000  REP       " 0",WORKDATE
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT7000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT7000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                    DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                    MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          BUMP      CDAY
.
.------ pack the formatted date ------
.
FDAT1000  REP       " 0",CYEAR
          PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT7000  MOVE      "99th December 1999",DATELINE
.
FDAT9999  RETURN
+
.************************************************************************
.*                              TIME0000                                *
.*       Format the time in WORKTIME output in FRMTTIME                 *
.*                   called by :  VBOA VCAN                             *
.************************************************************************
TIME0000  UNPACK    WORKTIME,CHOUR,ANS,CMIN
          MOVE      CHOUR,FORM2
.
          IF        FORM2<12
            MATCH     "00",CHOUR                 * 00:45 becomes 12:45 am
            IF        @EQUAL
              MOVE      TEN2,FORM2 
            ENDIF
            PACK      LINE,CHOUR,COLON,CMIN,SP1,AM   * am
          ELSE
            MATCH     "12",CHOUR                 * 22:45 becomes 10:45 pm
            IF        !@EQUAL
              SUB       TEN2,FORM2
              MOVE      FORM2,CHOUR
            ENDIF
            PACK      LINE,CHOUR,COLON,CMIN,SP1,PM   * pm
          ENDIF
.
          CALL      COMP0000                * supress zeros
          MOVE      LINE,FRMTTIME
.
          RETURN
+
.**********************************************************************
.*                              FDOC0000                              *
.*                 Routine to format doctors name                     *
.**********************************************************************
FDOC0000  CLEAR     DOCLINE
          CALL      RDDOCT1                        * read doctor file
          BRANCH    OVRCD,FDOC7000
          CLEAR     INITIAL
          APPEND    SP1,INITIAL
          MOVE      DGNAME,ANS
          APPEND    ANS,INITIAL
          APPEND    ". ",INITIAL
          RESET     INITIAL
          PACK      DOCLINE,DTITL,INITIAL,DSNAME   * pack formatted doctors
          MOVE      DOCLINE,LINE                   *   name
          CALL      COMP0000                       * compress blanks
          CALL      CASE0000                       * convert to lower case
          MOVE      LINE,DOCLINE
          GOTO      FDOC9999
.
.------ doctors name does not exist ------
.
FDOC7000  MOVE      "*********************************",DOCLINE
          GOTO      FDOC9999
.
FDOC9999  RETURN
+
.**********************************************************************
.*                           FNAM0000                                 *
.*                 Routine to format patients name                    *
.**********************************************************************
FNAM0000  CLEAR     NAMELINE
          RESET     PTITL
          MATCH     SP4,PTITL                     * test title for spaces
          GOTO      FNAM2000 IF EQUAL
.
FNAM0500  CMATCH    SP1,PTITL
          GOTO      FNAM1000 IF EQUAL
          MOVE      PTITL,ANS                    * append title to nameline
          APPEND    ANS,NAMELINE
          BUMP      PTITL
          GOTO      FNAM1000 IF EOS
          GOTO      FNAM0500
.
FNAM1000  APPEND    DOT,NAMELINE
          APPEND    SP1,NAMELINE
          MATCH     SP20,PGNAME                  * test given name for
          GOTO      FNAM1700 IF EQUAL            *    spaces
.
FNAM1500  APPEND    PGNAME,NAMELINE
          APPEND    SP1,NAMELINE                 * append given name to
.                                                   *    nameline
FNAM1700  APPEND    PSNAME,NAMELINE
          RESET     NAMELINE                     * append surname to
          MOVE      NAMELINE,LINE                *    nameline
          CALL      COMP0000                     * compress blanks
          CALL      CASE0000                     * convert to lower case
          MOVE      LINE,NAMELINE
          GOTO      FNAM9999
.
FNAM2000  MATCH     SP20,PGNAME                  * test given name for
          GOTO      FNAM1500 IF NOT EQUAL        *     spaces
          GOTO      FNAM1700
.
FNAM9999  RETURN
+
.**********************************************************************
.*                              COMP0000                              *
.*       Routine to compress excessive blanks in LINE                 *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL        * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                        * compress multiple blanks
          GOTO      COMP8000 IF EOS              *   from in-between words
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
+
.**********************************************************************
.*                             CASE0000                               *
.*  Routine to convert all except first character of each word to     *
.*        lower case                                                  *
.**********************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL            * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW                   * test to see if char is
          GOTO      CASE1100 IF EQUAL            *   a letter
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                     * any char but a letter
          *         found
.
CASE1100  OR        040,LINE                     * actual conversion to
          RESET     UPPLOW
          *         lower case (believe it
          *         or not!)
.
CASE2000  MOVE      ZERO,FIRSTCH                 * not on first char any
.                                                   *   more
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS          * move to next char
          RESET     LINE                         * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH                  * first char was a space
          GOTO      CASE3000
.
CASE9999  RETURN
+
.**********************************************************************
.*                              LSEL0000                              *
.*                Select general letter to print                      *
.*        Returns : EXIT = 1      dont want to continue               *
.**********************************************************************
LSEL0000  MOVE      TRUE,FLAGGLET
          MOVE      ZERO,EXIT
          MOVE      SP10,SAVESITE
          MOVE      ZERO,COUNTER
          DISPLAY   *P1:4,*EF:
                    *P1:5,"Select Letter to Print : ";
          MOVE      SP3,LETTER
          MOVE      "26",ECOL
          MOVE      FIVE,EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP3,CKYIDEF3
.
          CALL      OUTLETKY
          BRANCH    EXIT,LSEL7000,LSEL7500
.
          MOVE      DIM3,LETTER
          DISPLAY   *P30:5,OTLTTEXT
          GOTO      LSEL9999
.
.------ zero entered for letter code, used as an exit char ------
.
LSEL7000  DISPLAY   *P1:24,"Are you sure you want to exit? (",*V2LON,"Y":
                    *HOFF,"/",*V2LON,"N",*HOFF,")",*EL;
.
LSEL7010  KEYIN     *P38:24,*DV,UNDLN1:
                    *P38:24,*V2LON,ANS:
                    *P38:24,*DV,ANS
.
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      LSEL0000 IF EQUAL       * No entered
.
          MATCH     ANSY,ANS
          GOTO      LSEL7500 IF EQUAL       * Yes entered
.
          BEEP
          GOTO      LSEL7010
.
.------ user wants to exit, branch back to main menu ------
.
LSEL7500  MOVE      TRUE,EXIT
.
LSEL9999  RETURN
+
.**********************************************************************
.*                  SET0000                     Called by : ML7200    *
.*             Set up the values for all the "%" variables            *
.**********************************************************************
.
.------ read the temporary file ------
.
SET0000   CALL      RKTMP                   * read next record
          BRANCH    OVRCD,SET9000           * end of file
.
.-------  Test if are printing postage class banners -----
.
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      SET1000 IF NOT EQUAL
.
          IF        OPTION=7 | OPTION=8
            PACK      KEY8,TEMPURNO,SP70
            CALL      RDPMOOS1              * Opt out of SMS
            COMPARE   ZERO,OVRCD
            GOTO      SET0000 IF EQUAL
          ENDIF
.
SET1000   IF        OTCNPSTC = 1
            MATCH     SPOSTCLS,POSTCLSS
            IF        !@EQUAL
              MOVE      POSTCLSS,SPOSTCLSS
              MOVE      POSTCLSS,FORM1
              
              PERFORM   FORM1,FCBN0000,SCBN0000
.                             "1st" or "2nd"  Class Banners
              CALL      CPBN0000            * print "Class Postage" Banner
            ENDIF
          ENDIF
.
          MATCH     SAVESITE,SITE    
          IF        !@EQUAL
            MOVE      SITE,SAVESITE
            PACK      KEY6,SITE
            CALL      RDSITA1
            BRANCH    OVRCD,SET0000
.
            IF        OTCNLHIA = 1
              PACK      CFNAME,OSTFILE,FILLHIA1
              OPEN      OUTLHIA1,CFNAME     * outpatients letter file
            ENDIF
            PACK      CFNAME,OSTFILE,FILCLIA1
            OPEN      OUTCLIA1,CFNAME
            PACK      CFNAME,OSTFILE,FILCTYA1
            OPEN      OUTCTYA1,CFNAME
            PACK      CFNAME,OSTFILE,FILBOKA1
            OPEN      OUTBOKA1,CFNAME
            PACK      CFNAME,OSTFILE,FILBB1A1
            CALL      OPOTBB11
            PACK      CFNAME,OSTFILE,FILMA1A1
            CALL      OPOTMA11
            PACK      CFNAME,OSTFILE,FILSESA1
            OPEN      OUTSESA1,CFNAME
            PACK      CFNAME,OSTFILE,FILHEDA1
            OPEN      OUTHEDA1,CFNAME
          ENDIF
.
          PACK      KEY28,SITE,TEMPCLID,TEMPDATE,TEMPSTRT,TEMPSLOT,SP70
          CALL      RDBOKA1
.
          CALL      SEVA0000
          BRANCH    CEXIT,SET0000
.
          MOVE      FALSE,EXIT
          GOTO      SET9999
.
SET9000   MOVE      TRUE,EXIT
.
SET9999   RETURN
+
.**********************************************************************
.*                  SETV0000                    Called by : ML8600    *
.*             Set up the values for all the "%" variables   *I-63400 *
.**********************************************************************
.
.------ read the outladaf file ------
.
SETV0000  CALL      RKOTLAD1
          BRANCH    OVRCD,SETV9000           * end of file
.
          MATCH     SELECTID,OTLASEID
          GOTO      SETV9000 IF NOT EQUAL
.
          MATCH     "1",OTLADLST             * record selected for deletion
          GOTO      SETV0000 IF EQUAL
.
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      SETV1000 IF NOT EQUAL
.
          IF        OPTION=7 | OPTION=8
            PACK      KEY8,OTLAURNO,SP70
            CALL      RDPMOOS1              * Opt out of SMS
            COMPARE   ZERO,OVRCD
            GOTO      SETV0000 IF EQUAL
          ENDIF
.
.-------  Test if are printing postage class banners -----
.
SETV1000  IF        OTCNPSTC = 1
            MATCH     SPOSTCLS,OTLAPCLS
            IF        !@EQUAL
              MOVE      OTLAPCLS,SPOSTCLSS
              MOVE      OTLAPCLS,FORM1
.             
              PERFORM   FORM1,FCBN0000,SCBN0000
.                            "1st" or "2nd"  Class Banners
              CALL      CPBN0000            * print "Class Postage" Banner
            ENDIF
          ENDIF
.
          PACK      KEY21,OTLAPCLS,OTLAOUTN,OTLACLID,OTLACLTY
          CALL      RDTMP
          IF        OVRCD=1
            CALL      LDTM0000
          ENDIF
.
          CALL      SVCQ0000                * Set outbok vars for vcq letters
.
          MATCH     SP6,SAVESITE
          GOTO      SETV2000 IF EQUAL
.
          MATCH     SAVESITE,OTLASITC
          GOTO      SETV3000 IF EQUAL
.
SETV2000  MOVE      OTLASITC,SAVESITE
          PACK      KEY6,OTLASITC
          CALL      RDSITA1
          BRANCH    OVRCD,SETV0000
.
          IF        OTCNLHIA = 1
            PACK      CFNAME,OSTFILE,FILLHIA1
            OPEN      OUTLHIA1,CFNAME     * outpatients letter file
          ENDIF
          PACK      CFNAME,OSTFILE,FILCLIA1
          OPEN      OUTCLIA1,CFNAME
          PACK      CFNAME,OSTFILE,FILCTYA1
          OPEN      OUTCTYA1,CFNAME
          PACK      CFNAME,OSTFILE,FILBOKA1
          OPEN      OUTBOKA1,CFNAME
          PACK      CFNAME,OSTFILE,FILBB1A1
          CALL      OPOTBB11
          PACK      CFNAME,OSTFILE,FILMA1A1
          CALL      OPOTMA11
          PACK      CFNAME,OSTFILE,FILSESA1
          OPEN      OUTSESA1,CFNAME
          PACK      CFNAME,OSTFILE,FILHEDA1
          OPEN      OUTHEDA1,CFNAME
.
SETV3000  PACK      KEY28,SITE,TEMPCLID,TEMPDATE,TEMPSTRT,TEMPSLOT,SP70
          CALL      RDBOKA1
.
          CALL      SEVA0000
          BRANCH    CEXIT,SETV0000
.
          MOVE      FALSE,EXIT
          GOTO      SETV9999
.
SETV9000  MOVE      TRUE,EXIT
.
SETV9999  RETURN
+
.**********************************************************************
.*                               MORE0000                             *
.*                  Any more letters to print?                        *
.**********************************************************************
MORE0000  MOVE      FALSE,EXIT
          KEYIN     *P1:7,*EF,"Any more letters for the same people (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      MORE9000 IF EQUAL       * no entered
.
          MATCH     ANSY,ANS
          GOTO      MORE1000 IF EQUAL       * yes entered
.
          BEEP
          GOTO      MORE0000
.
.------ there are more letters to print ------
.
MORE1000  MOVE      TWO,EXIT
          MOVE      FALSE,FLAGLLET
          GOTO      MORE9999
.
MORE9000  MOVE      TRUE,EXIT
.
MORE9999  RETURN
+
.*****************************************************************************
.*                           WTMP0000                               *I-63400 *
.*                      Loop through tempfile and write into outladaf        *
.*****************************************************************************
.
WTMP0000  PACK      KEY21,SP70
          CALL      RSTMP
WTMP1000  CALL      RKTMP
          BRANCH    OVRCD,WTMP9999
.
          CALL      LOAD0000 
.
          PACK      KEY25,OTLASEID,OTLAPCLS,OTLAOUTN,OTLACLID,OTLACLTY
          CALL      RAOTLAD1
          IF        OVRCD=1
            CALL      WROTLAD1
          ELSE
            CALL      UPOTLAD1
          ENDIF
.
          GOTO      WTMP1000
.
WTMP9999  CALL      CTMP0000
          RETURN
+
.*****************************************************************************
.*                           CTMP0000                                        *
.*                        Create the 1st Tempfile                            *
.*****************************************************************************
.
CTMP0000  CALL      KTMP0000
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    CFNAMEA,CMDLINE
          APPEND    " 523 U1-1,2-9,401-406,503-508",CMDLINE
          APPEND    SP30,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TEMP1,CFNAMEA
CTMP9999  RETURN
.
.
.*****************************************************************************
.*                           KTMP0000                                        *
.*                        Kill the 1st Tempfile                              *
.*****************************************************************************
.
KTMP0000  CLOSE     TEMP1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    CFNAMEA,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          
KTMP9999  RETURN
.
.************************************************************************
.*                       I/O for tempfile                               *
.************************************************************************
.
RATMP     RESET     KEY21
          MOVE      ZERO,OVRCD
          READ      TEMP1,KEY21;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMP     RESET     KEY21
          READ      TEMP1,KEY21;;
          RETURN
.
RKTMP     MOVE      ZERO,OVRCD
          READKS    TEMP1;POSTCLSS,DTEMPOUT,TEMPATTD,TEMPATDT,TEMPATTM,TEMPBDAT:
                    TEMPCTRY,TEMPCTYP,TEMPCOMP,TEMPTDAY,TEMPNAME,TEMPINSR:
                    TEMPPCAT,TEMPCLSS,TEMPPRTY,TEMPPSEX,TEMPSREF,TEMPURNO:
                    TEMPSITE,TEMPBKDT,TEMPBTIM,TEMPSLOT,TEMPSTIM,TEMPCLID:
                    TEMPCLDX,TEMPDTIT,TEMPDSNM,TEMPDGNM,TEMPDOCT,SITE:
                    TEMPCLTY,TEMPDATE,TEMPSTRT,TEMPRSHF,TEMPDLST
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPOUT,TEMPOUTN
          RETURN
.
RDTMP     RESET     KEY21
          MOVE      ZERO,OVRCD
          READ      TEMP1,KEY21;POSTCLSS,DTEMPOUT,TEMPATTD,TEMPATDT,TEMPATTM:
                    TEMPBDAT:
                    TEMPCTRY,TEMPCTYP,TEMPCOMP,TEMPTDAY,TEMPNAME,TEMPINSR:
                    TEMPPCAT,TEMPCLSS,TEMPPRTY,TEMPPSEX,TEMPSREF,TEMPURNO:
                    TEMPSITE,TEMPBKDT,TEMPBTIM,TEMPSLOT,TEMPSTIM,TEMPCLID:
                    TEMPCLDX,TEMPDTIT,TEMPDSNM,TEMPDGNM,TEMPDOCT,SITE:
                    TEMPCLTY,TEMPDATE,TEMPSTRT,TEMPRSHF,TEMPDLST
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPOUT,TEMPOUTN
          RETURN
.
WRTMP     RESET     KEY21
          MOVE      TEMPOUTN,DTEMPOUT
          WRITE    TEMP1,KEY21;POSTCLSS,DTEMPOUT,TEMPATTD,TEMPATDT,TEMPATTM:
                    TEMPBDAT:
                    TEMPCTRY,TEMPCTYP,TEMPCOMP,TEMPTDAY,TEMPNAME,TEMPINSR:
                    TEMPPCAT,TEMPCLSS,TEMPPRTY,TEMPPSEX,TEMPSREF,TEMPURNO:
                    TEMPSITE,TEMPBKDT,TEMPBTIM,TEMPSLOT,TEMPSTIM,TEMPCLID:
                    TEMPCLDX,TEMPDTIT,TEMPDSNM,TEMPDGNM,TEMPDOCT,OSTSITE:
                    TEMPCLTY,TEMPDATE,TEMPSTRT,TEMPRSHF,TEMPDLST
          RETURN
.
.*****************************************************************************
.*                                 FCBN0000                                  *
.*                        Print "1st" in banner form                         *
.*****************************************************************************
.
FCBN0000
          CALL      UND80
          PRINT     *N,*N
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,FIRSTC1,FIRSTC2,FIRSTC3,FIRSTC4,FIRSTC5:
                                     FIRSTC6,FIRSTC7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
FCBN9999  RETURN
.*****************************************************************************
.*                                 SCBN0000                                  *
.*                        Print "2nd" in banner form                         *
.*****************************************************************************
.
SCBN0000
          CALL      UND80
          PRINT     *N,*N
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,SECONDC1,SECONDC2,SECONDC3,SECONDC4:
                                     SECONDC5,SECONDC6,SECONDC7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
SCBN9999  RETURN
.*****************************************************************************
.*                                 CPBN0000                                  *
.*                        Print "Class Postage" in banner form               *
.*****************************************************************************
.
CPBN0000
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,BCLASS1,BCLASS2,BCLASS3,BCLASS4:
                                     BCLASS5,BCLASS6,BCLASS7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,BPOST1,BPOST2,BPOST3,BPOST4:
                                     BPOST5,BPOST6,BPOST7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
          PRINT     *N,*N
          CALL      UND80
          PRINT     *F
CPBN9999  RETURN
.
.****************************************************************************
.*                             DSLS0000                                     *
.*                      Display the standard letter screen                  *
.****************************************************************************
.
DSLS0000  DISPLAY   *P1:3,*EF:
                    *P1:5,"Dates Booking made               : ",*P47:5,"to":
                    *P1:7,*V2LON,ANSS,*HOFF:
                    *P2:7,"tandard or ",*V2LON,ANSM,*HOFF:
                    "iscellaneous Letter : "
DSLS9999  RETURN

+
.**********************************************************************
.*                           XTRA0000                                 *
.*         Extracts the required information from various files       *
.*              for general letters                                   *
.**********************************************************************
XTRA0000  MOVE      TRUE,EXIT
          CALL      CTMP0000                * create the tempfile  
          MOVE      ZERO,PATCOUNT
          DISPLAY   *P1:24,*EL,"Searching : ",*P29:24,"Processing : ":
                    *P58:24,"No. found :";
.
          DISPLAY   *P64:24,"outpreaf";
          OPEN      OUTPREA1,"outpreaf"
.
          MOVE      SP6,KEY6                * start entered
          CALL      RDSSITA1                * position at start of file
.
. ------- next read site file ------
.
XTRA1000  CALL      RDKSITA1
          BRANCH    OVRCD,XTRA9999
.
          MOVE      OSTDESC,TEMPSITE        * save description
          DISPLAY   *P13:24,*V2LON,OSTSITE  * display site to show working
          CALL      ESBL0000                * extract from clinic file
          GOTO      XTRA1000                * get next site
.
XTRA9999  PACK      KEY21,SP20
          CALL      RSTMP
          RETURN
+
.************************************************************************
.*                         ESBL0000                                     *
.*       Extract all relevant records Standard booking letters          *
.*                   called by : XTRA2000                               *
.************************************************************************
ESBL0000  PACK      CFNAME,OSTFILE,FILCLIA1   * open site dependent clinic file
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME,OSTFILE,FILBOKA1   * open outboka and outbokb if 
          OPEN      OUTBOKA1,CFNAME           * status is not (R)esh. or (C)anc
.
          PACK      CFNAME,OSTFILE,FILBB1A1
          CALL      OPOTBB11                  
.
          PACK      CFNAME,OSTFILE,FILBUDA2
          OPEN      OUTBUDA2,CFNAME
.
          PACK      CFNAME,OSTFILE,FILRSHA1      * open reshedule file
          OPEN      OUTRSHA1,CFNAME
.
          PACK      KEY16,BRANFR,SP20
          CALL      RSOTBUD2
.
ESBL1000  CALL      RKOTBUD2
          BRANCH    OVRCD,ESBL5000
.
          MATCH     OTBUSITE,OSTSITE
          GOTO      ESBL1000 IF NOT EQUAL
.
          MATCH     OTBUDATE,BRANTO
          GOTO      ESBL5000 IF LESS
.
          PACK      KEY8,OTBUADMN
          CALL      RDPREA1
          BRANCH    OVRCD,ESBL1000
.     
.-----   Get Boka and Bokb records for required info -----
.
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
          CALL      RDBOKA1
          BRANCH    OVRCD,ESBL1000
.
          MOVE     OBAURNO,TEMPURNO
.
          PACK      KEY8,OTBUADMN
          CALL      RDBOKB1
          BRANCH    OVRCD,ESBL1000
.
          MATCH     ANSY,OTBBSNDL
          GOTO      ESBL1000 IF NOT EQUAL
.
. ---  Check if rescheduled ------
.
          MOVE      SP3,OPRSREAS
          PACK      KEY11,OTBUADMN,ZEDS                                
          CALL      RDSRSHA1
          CALL      RDPRSHA1
          IF        OVRCD = 0
            MATCH     OTBUADMN,OPRSOUTN
            IF        @EQUAL
              MOVE      OPRSDATE,OBADATE
            ENDIF
          ENDIF
.
          DISPLAY  *P42:24,*V2LON,OBADATE   * display the date
.
          CALL      VBOA0000
          MOVE      ONE,POSTCLSS
          IF        OTCNPSTC = 1
            MOVE      OBADATE,PCLSDATE
            CALL      CPCL0000
          ENDIF
.
          MOVE      OSTSITE,SITE
          MOVE      SP1,TEMPRSHF
          CALL      GOTP0000
          PACK      KEY21,POSTCLSS,DTEMPOUT,TEMPCLID,TEMPCLTY
          CALL      RATMP                 
          IF        OVRCD=1
            CALL      WRTMP                 * write to tempfile
          ENDIF
.
          GOTO      ESBL1000
.
ESBL5000  PACK      CFNAME,OSTFILE,FILRSHA3      * open reshedule file
          OPEN      OUTRSHA3,CFNAME
.
          MOVE      SP3,OPRSREAS
          PACK      KEY25,OSTSITE,BRANFR,SP30
          CALL      RDSRSHA3
.
ESBL5100  CALL      RDKRSHA3
          BRANCH    OVRCD,ESBL9999
.
          MATCH     OPRSSITE,OSTSITE
          GOTO      ESBL9999 IF NOT EQUAL
.
          MATCH     OPRSRDTE,BRANTO
          GOTO      ESBL9999 IF LESS
.
          PACK      KEY8,OPRSOUTN
          CALL      RDPREA1
          BRANCH    OVRCD,ESBL5100
.     
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
          CALL      RDBOKA1
          BRANCH    OVRCD,ESBL5100
.
          MOVE      OBAURNO,TEMPURNO
.
          PACK      KEY8,OPRSOUTN
          CALL      RDBOKB1
          BRANCH    OVRCD,ESBL5100
.
          MATCH     ANSY,OTBBSNDL
          GOTO      ESBL5100 IF NOT EQUAL
.
          DISPLAY  *P42:24,*V2LON,OBADATE   * display the date
.
          CALL      VBOA0000
          MOVE      ONE,POSTCLSS
          IF        OTCNPSTC = 1
            MOVE      OBADATE,PCLSDATE
            CALL      CPCL0000
          ENDIF
.
          MOVE      OSTSITE,SITE
          MOVE      ANSR,TEMPRSHF
          CALL      GOTP0000
          PACK      KEY21,POSTCLSS,DTEMPOUT,TEMPCLID,TEMPCLTY
          CALL      RATMP                 
          IF        OVRCD=1
            CALL      WRTMP                 * write to tempfile
          ENDIF
.
          GOTO      ESBL5100
.
ESBL9999  RETURN
.
.**********************************************************************
.*                           DBMR0000                                 *
.*                     Keyin booking range                            *
.**********************************************************************
DBMR0000  MOVE      FALSE,EXIT
          MOVE      "36",CCOL
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
	  MOVE      FIVE,CVERT
	  CALL      KEYDATE
	  BRANCH    CQUEST,DBMR0000         * no question mark available
.
	  MATCH     SP2,CDAY
	  GOTO      DBMR0000 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      DBMR9000 IF EQUAL
.
	  BRANCH    OVRCD,DBMR0000          * field is manditory
          
	  PACK      BRANFR,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BRANFR
.
........  MATCH     TODAY,BRANFR
........  IF        @LESS
........    BEEP
........    DISPLAY   *P1:24,*EL,"Date cannot be in the past. ";
........    CALL      HITENTER
........    GOTO      DBMR0000
........  ENDIF
.
          CALL      PACDATE
          MOVE      CPCDATE,DBRANFR
          REP       " 0",DBRANFR
.
DBMR1000  MOVE      FALSE,EXIT
    	  MOVE      "50",CCOL
	  MOVE      FIVE,CVERT
          MOVE      ONE,CCANLDTE            * space will cancel default
	  CALL      KEYDATE
	  BRANCH    CQUEST,DBMR1000         * no question mark available
.
          MATCH     SP2,CDAY
	  GOTO      DBMR1000 IF EQUAL
.
	  MATCH     EXITCHAR,CDAY
	  GOTO      DBMR9000 IF EQUAL
.
	  BRANCH    OVRCD,DBMR1000          * field is manditory
	  PACK      BRANTO,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BRANTO
          CALL      PACDATE
          MOVE      CPCDATE,DBRANTO
          REP       " 0",DBRANTO
.
DBMR2000  MATCH     BRANFR,BRANTO           * valid range?
	  GOTO      DBMR3000 IF LESS
            
	  MOVE      FALSE,EXIT
	  GOTO      DBMR9999
.
.------ invalid date range entered ------
.
DBMR3000  DISPLAY   *P1:24,*EL,*B,"Invalid range. ";
	  CALL      HITENTER
	  GOTO      DBMR0000
.
.------ zero entered for first date number ------
.
DBMR9000  MOVE      TRUE,EXIT
.
DBMR9999  RETURN
+
OPEN0000
CLOS0000  RETURN
+
.
.************************************************************
.*                     I/O ROUTINES                         *
.************************************************************
.
          INC       STD001IO
.
          INC       CALCAGE
          INC       GCCARD00/PBL
          INC       GTIHINUM
          INC       PMSCEXCD
          INC       PATCOMN1
          INC       PATSNDX
          INC       PATSNX2
          INC       SMSMESID
          INC       SEXDSP00
.  
          INC       ALLREFIO/INC
          INC       ALLLNKIO/INC
          INC       PATMA1IO/INC
          INC       PATVISIO/INC
          INC       PATREMIO/INC
          INC       PATINVIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATGSRIO/INC
          INC       PATRE1IO/INC
          INC       PATPR1IO/INC
          INC       PATMI1IO/INC
          INC       PATHSPIO/INC
.
          INC       OUTADLIO/INC
          INC       OUTLADIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBOCIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCANIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       OUTDIAIO/INC                                       *I-58732
          INC       OUTLETIO/INC
          INC       OUTPREIO/INC
          INC       OUTRSHIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSITIO/INC
          INC       OUTLHIIO/INC
          INC       OUTLPCIO/INC
          INC       OUTRF1IO/INC
          INC       OUTXWPIO/INC
          INC       BOKRC1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSIHIIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PMSTLEIO/INC
          INC       OUTBUDIO/INC
          INC       PATWR1IO/INC
          INC       OUTXSCIO/INC
          INC       OUTSESIO/INC
          INC       OUTSIPIO/INC
          INC       OUTHEDIO/INC
.
          INC       OUTLETKY
.
          INC       OUTDSCLN
          INC       OUTDSSIT
          INC       PATCODKY
          INC       OUTPLTCD             
          INC       OUTDSCTY
          INC       KYOUTCTY
          INC       DATECONV
          INC       PATHSPKY

          INC       NHIMASIO/INC
          INC       NZIBSRCH
          INC       NZHISIIO
          INC       CLPATMAS
          INC       CLPMSCEX
          INC       TFILENAM
          INC       IBASEQIO/INC
          INC       PATALRIO/INC
          INC       PATDNRIO/INC
          INC       PATSDNIO/INC
          INC       PATSMWIO/INC
          INC       PATNIDIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATWMAIO/INC
          INC       PATWC1IO/INC                                       *I-59546
          INC       PMSCCDIO/INC                                       *I-59546
          INC       PMSCEXIO/INC
          INC       PMSOOSIO/INC
          INC       PMSRELIO/INC
          INC       OUTTHIIO/INC
          INC       VISCMTIO/INC
          INC       WEBERRIO/INC
          INC       WEBSECIO/INC
          INC       MLTSECIO/INC
.
          INC       SMSPRXML           * Print XML metatags for SMS
          INC       SEXDSCIO
.
AGECHK    RETURN
+
