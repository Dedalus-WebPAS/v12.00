.******************************************************************************
.* System   : ACCIDENT & EMERGENCY                                            *
.* Program  : IBAAAE20                                                        *
.* Desc     : Print A&E Invoices                                              *
.******************************************************************************
.* Date     : 05/10/1988                                                      *
.* Author   : Graeme Williams                                                 *
.* Function : This program allows printing of A&E invoices.                   *
.* Mods     :                                                                 *
.******************************************************************************

.******************************************************************************
.* V12.00.02 13/06/2025  J.Tan          TSK 0961623                           *
.*           Fixed keyin Alphanumeric Visit number                            *
.* V11.05.03 31/03/2025 J.Tan            TSK 0958197                          *
.*           Mod checking if ABF invoice has been raised                      *
.* V11.05.02 27/03/2025 J.Tan            TSK 0958197                          *
.*           Mod checking for Discharged status for print zero amount of Inv. *
.* V11.05.01 07/11/2024 Thanh T          TSK 0946085                          *
.*           Recompiled for RCPCONFD changes                                  *
.******************************************************************************
.* V11.03.06 08/11/2023  Nikitha B      TSK 0927699c                          *
.*           Read CAPPRVNO and PTCNHABN for Hospital Approval and ABN number. *
.* V11.03.05 04/10/2023  Nikitha B     TSK 0927699                            *
.*           Recomplied for PATINVHL, PATINVTL - Stationary variables         *
.* V11.03.04 04/10/2023  J.Tan          TASK 0938230                          *
.*           Recompiled for ABFAECCL - Emergency ABF                          *
.* V11.03.03 15/06/2023  Bella Turco    TSK 0931756                           *
.            Recompiled for PRTINVBD                                          *
.* V11.03.02 06/03/2023  Thanh T        TSK 0917199                           *
.*           Recompiled for RCPDTEFD changes                                  *
.* V11.03.01 06/01/2023  J.Tan            TSK 0925233                         *
.*           Mod checking for Cancelled visit and $0 invoice raised           *
.* V11.02.03 11/10/2022  J.Tan            TSK 0908346                         *
.*           Mod checking Clinical Doc.for printing inv.(CHKCLDCP)            *
.* V11.02.02 29/06/2022 J.Tan           TSK 0920712                           *
.*           Recompiled for ABFAECCL - I*D on emrvcdaf file                   *
.* V11.02.01 03/03/2022  J.Tan           TSK 0902652                          *
.*           Recompiled for AAECATBI - Pat.Invoice new functionality          *
.* V11.01.08 17/11/2021  J.Tan          TSK 0913621                           *
.*           Recompiled for ABFAEINV - Mod for Multiple NEP Values            *
.* V11.01.07 28/10/2021 J.Tan           TSK 0913056                           *
.*           Recompiled for ABFAECCL-ADMFLAG and CCAR0000(Clinical Care)      *
.* V11.01.06 13/10/2021 J.Tan    TSK 0905305                                  *
.*           Recompiled for ABFAECCL - Adjustment type 068 & 069              *
.* V11.01.05 01/10/2020  J.Tan           TSK 0911732                          *
.*           Recompiled for AAEINVS - checking 'tobe invoiced' amount (CKPD000*
.* V11.01.04 14/09/2021  Davin           TSK 0911277                          *
.*           Recompiled for PRTINVBD                                          *
.* V11.01.03 10/09/2021  Davin           TSK 0911277                          *
.*           Recompiled for PATINVTL - Changed field 20 length to 12.2        *
.* V11.01.02 24/08/2021  Davin          TSK 0897318                           *
.*           Recompiled for PATINVTL - added field 57(Adjustment Total)       *
.*           24/08/2021  J.Tan           TSK 0905305                          *
.*           Recompiled for AAECATBI - AE Care class (ABFAECCL)               *
.*           31/08/2021  J.Tan           TSK 0910799                          *
.*           Recompiled for PRTINVBD - printing Referring ADF                 *
.* V11.01.01 27/04/2021  Thanh T        TSK 0895165                           *
.*           Recompiled for OPRARDFD changes                                  *
.* V11.00.07 19/01/2021  J.Tan          TSK 0883075                           *
.*           Recompiled for PRTINVBD - mod to print ADF address line on invoic*
.* V11.00.06 14/10/2020  J.Tan          TSK 0894879                           *
.*           Recompiled for PRTINVBD - Print 30 item desc.for RCH Invoice     *
.* V11.00.05 01/07/2020 J.Tan           TSK 0886178                           *
.*           Recompiled for AAECATBI - write to invoice pending details       *
.* V11.00.04 29/06/2020  J.Tan           TSK 0893767                          *
.*           Recompiled for ABFAEINV - Changed CALCFLAG to 01/01/2021         *
.* V11.00.03 20/04/2020 J.Tan           TSK 0890733                           *
.*           Recompiled for ABFAEINV - ABF new 2020 calculation               *
.* V11.00.02 08/04/2020 J.Tan           TSK 0868813                           *
.*           Recompiled for PATINVHL                                          *
.*           15/04/2020 Thanh T         TSK 0879163                           *
.*           Added SEXDSP00                                                   *
.* V11.00.01 19/03/2020  J.Tan          TSK 0838262                           *
.*           Added PATITMRD                                                   *
.* V10.15.03 16/01/2020  J.Tan            TSK 0887166                         *
.*           Recompiled for PRTINVBD - I*C rcpdteaf index 6                   *
.* V10.15.02 23/10/2019  J.Tan            TSK 0857392                         *
.*           Added Print Bulk ABF invoices                                    *
.  V10.12.01  28/02/2018  J.Tan          TSK 0852351                          *
.            Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)      *
.* V10.11.01 20/07/2017  Ebon Clements  TSK 0268970                           *
.*           Change to use OUTCLIFD index 1 instead of index 2                *
.* V10.04.04 01/05/2014  J.Tan          CAR 261630                            *
.*           Removed patauc Cash audit file and pataum Misch.charge audit file*
.* V10.04.03 15/04/2014  J.Tan          CAR 261630                            *
.*           Removed port number from temp file name                          *
.* V10.04.02 26/02/2014  J.Tan          CAR 275810                            *
.*           Recompiled for PRTINVBD - to print Defence Force details         *
.* V10.04.01 20/01/2014  J.Tan          CAR 273713                            *
.*           Recompiled for PRTINVBD-Print payment types of a receipt on inv. *
.* V10.03.07 09/12/2013  Ania P         CAR 294740                            *
.*           Recompiled for PATINVHL                                          *
.* V10.03.06 12/09/2013  Peter Vela     CAR 271911                            *
.*           Recompiled for PATINVTL                                          *
.* V10.03.05 20/06/2013  Davin          CAR 287161                            *
.*           Recompiled for PATGBCRN - right justify ptcnhbpi                 *
.* V10.03.04 17/04/2013  Don Nguyen     CAR 282342                            *
.*           Recompiled for PATINVHL, PATINVTL                                *
.* V10.03.03 09/04/2013  Don Nguyen     CAR 282342                            *
.*           Recompiled for PATGBCRN, PATINVHL, PATINVTL                      *
.* V10.03.02 05/03/2013  Patrick Adair  CAR 281898                            *
.*           Recompiled for PRTINVBD PATCATAI                                 *
.* V10.03.01 18/07/2012  Don Nguyen     CAR 264561                            *
.*           Recompiled for PATGBCRN                                          *
.******************************************************************************
.* V10.02.02 25/06/2011 Steve Armstrong    CAR 240722                         *
.*           Removed references to PATLOCFD.                                  *
.* V10.02.01 07/04/2011  Jill Parkinson CAR 239574                            *
.*           Removed open of ibaprntf                                         *
.******************************************************************************
.* V10.01.02 13/01/2011  Mike Laming   CAR 233084                             *
.*           Added include CLPATINV for AAEINVS & Recompiled                  *
.* V10.01.01 21/12/2010  Mike Laming   CAR 233046                             *
.*           Re-compiled for AAECATBI - Mods to Misc.Charges PATMCHFD         *
.******************************************************************************
.* V10.00.01 27/09/2010 J.Tan      CAR 230664                                 *
.*           Recompiled for AAECATBI - HEC Invoice layout                     * 
.******************************************************************************
.* V9.12.04  04/12/2009 Peter Vela CAR 202333                                 *
.*           Recompiled for PATINVHL - Changed variable 88 to surname only    * 
.* V9.12.03  24/08/2009 J.Tan  CAR 186102                                     *
.*           Recompiled for NZPCATAI - Mods to display Win/Loss after invoiced*
.* V9.12.02  21/07/2009  J.Tan          CAR 199603                            *
.*           Recompiled for PATCATAI - prints ICD codes on TAC/WC Inv.        *
.* V9.12.01  03/07/2009  Peter Vela    CAR 199927                             *
.*           Recompiled for EMROPOCK - Check if PMMIAMTT = 0 GPRC4000         *
.******************************************************************************
.* V9.11.02  23/03/2009  Davin         CAR 178015                             *
.*           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number *
.* V9.11.01  14/10/2008  Peter Vela    CAR 159227                             *
.*           Recompiled for PATINVHL - Added Emergency Invoice                *
.*           Arrival Date and Time                                            *
.******************************************************************************
.* V9.10.01  06/08/2008 J.Tan      CAR 175246                                 *
.*           Recompiled for AAECATBI                                          *
.******************************************************************************
.* V9.09.12  04/03/2008 J.Tan          CAR 157583                             *
.*           Recompiled for AAECATBI - Invoice total with 'Out of Pocket "    *
.* V9.09.11  27/12/2007 Peter Vela     CAR 155907                             *
.*           Recompiled for PATINVTL                                          *
.* V9.09.10  16/11/2007 Peter Vela     CAR 110766                             *
.*           Recompiled for PATINVHL                                          *
.* V9.09.09  12/11/2007 J.Tan          CAR 151803                             *
.*           Recompiled for AAECATBI - ED Billing                             *
.* V9.09.08  26/10/2007 Peter Vela     CAR 151159                             *
.*           Added status 4 cancelled                                         *
.* V9.09.07  10/08/2007 Peter Vela     CAR 146143                             *
.*           Recompiled for PATCATAI                                          *
.* V9.09.06  25/07/2007 Peter Vela     CAR 144787                             *
.*           Recompiled for PATCATAI                                          *
.* V9.09.05  05/07/2007 Peter Vela     CAR 144548                             *
.*           Recompiled for PATANVS                                           *
.* V9.09.04  03/07/2007 Peter Vela     CAR 142173                             *
.*           Recompiled for PATCATAI                                          *
.* V9.09.03  29/06/2007 Peter Vela     CAR 142173                             *
.*           Recompiled for PATCATAI                                          *
.* V9.09.02  25/06/2007 Peter Vela     CAR 142173                             *
.*           Recompiled for PATCATAI                                          *
.* V9.09.01  07/06/2007 J.Tan          CAR 142173                             *
.*           Mods for Emergency events                                        *
.******************************************************************************
.* V9.08.10  19/02/2007 Peter Vela     CAR 135241                             *
.*           Recompiled for WEBDINVS - St. John of God invoice layout         *
.* V9.08.09  22/02/2007 Mike Laming   CAR 119436                              *
.*           Add PMSOSDTM (PROC FLAGDEBT) for Outstanding Debt Alert ind.     *
.* V9.08.08  07/02/2007  Ebon Clements CAR 120001                             *
.*           Added nz private billing files                                   *
.* V9.08.07  31/01/2007  Peter Vela    CAR 127930                             *
.*           Recompiled for EMRSITFD                                          *
.* V9.08.06  13/12/2006  J.Tan         CAR 127625                             *
.*           Mods to JH HRN                                                   *
.* V9.08.05  05/12/2006  J.Tan         CAR 127092                             *
.*           Recompiled for PATCATAI - JH Invoices                            *
.* V9.08.04  27/11/2006  Steve Armstrong   CAR 126039                         *
.*           Recompiled for changes to SGCHKDIG                               *
.* V9.08.03  16/11/2006  Steve Armstrong   CAR 124160                         *
.*           Recompiled for PATINVHL (Singapore HRN)                          *
.*           Recompiled for PATINVTL (Singapore HRN)                          *
.* V9.08.02  14/11/2006  Peter Vela    CAR 124547                             *
.*           Recompiled for AAEINVS                                           *
.* V9.08.01  29/09/2006  Peter Vela    CAR 120319                             *
.*           Recompiled for PATINVHL                                          *
.******************************************************************************
.* V9.07.05  25/09/2006  Peter Vela    CAR 118940                             *
.*           Recompiled for PATCATAI                                          *
.* V9.07.04  20/09/06 J.Tan    CAR 119336                                     *
.*           Added claim code to Suggested classification file                *
.* V9.07.03  12/09/2006  Jill Habasque CAR 109852                             *
.*           Added procedure GETALTID                                         *
.* V9.07.02  02/08/2006  Peter Vela    CAR 113658                             *
.*           Recompiled for PATINV21 - Fixed Date and Cash Payment            *
.*           display                                                          *
.* V9.07.01  25/07/2006  Peter Vela    CAR 113658                             *
.*           Recompiled for PATCATAI - Fixed "Journal Total" display          *
.******************************************************************************
.* V9.06.02  16/05/2006  Peter Vela    CAR 104103                             *
.*           Recompiled for PATCATAI - PTCNINVL=12                            *
.* V9.06.01  24/04/2006  J.Tan         CAR 102287                             *
.*           Recompiled for PATINVHL - Added fields for multi hospital details*
.******************************************************************************
.* V9.05.02  29/03/2006  Peter Vela    CAR 95780                              *
.*           Recompiled for PATINVHL - Added emg mobile contact numbers       *
.* V9.05.01  26/03/2006  Peter Vela    CAR 61299                              *
.*           Recompiled for PATINVHL                                          *
.******************************************************************************
.* V9.04.13  17/11/2005  Peter Vela    CAR 84547                              *
.*           Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1     *
.* V9.04.12  25/10/2005 Sandra Barcham   81362                                *
.*           Recompiled for AAEINVS - fix fincode for deposits                *
.* V9.04.11  06/10/2005 J.Tan   CAR  78676                                    *
.*           Recompiled for AAECATBI - Printing RCH invoice                   *
.* V9.04.10  29/09/2005 J.Tan   CAR  77671                                    *
.*           Recompiled for AAECATBI - Printing invoice                       *
.* V9.04.09  14/07/2005  Peter Vela    CAR 62172                              *
.*           Added invoice total variable                                     *
.* V9.04.08  17/02/2005  Mike Laming   CAR 56030                              *
.*           Re-compile for PATINV25 - fix screen painted tail printing       *
.* V9.04.07  21/12/2004 Lina Vo CAR 54555                                     *
.*           Removed close of controlf - causes I*C in includes               *
.* V9.04.06  05/10/2004 J.Tan   CAR 53798                                     *
.*           Removed PATDSMSC                                                 *
.* V9.04.05  04/10/2004  Peter Vela CAR 52906                                 *
.*           Recompiled for PATCATAI                                          *
.*           23/09/2004  Lina Vo  CAR 53660                                   *
.*           Recompiled for AAEINVS & PATCATAI                                *
.* V9.04.04  03/09/2004  Lina Vo  CAR 52998                                   *
.*           Initialise Page Number for PATINVHL                              *
.* V9.04.03  31/08/2004  J.Tan    CAR 53073                                   *
.*           Mods for multi hospital                                          *
.* V9.04.02  27/08/2004  J.Tan    CAR 52835                                   *
.*           Recompiled for PATCATAI - multi hospital                         *
.* V9.04.01  23/08/2004  J.Tan  CAR 52835                                     *
.*           Recompiled for AAEINVS - Multi hospital                          *
.******************************************************************************
.* V9.03.12  12/08/2004  J.Tan  CAR 52504                                     *
.*           Recompiled for AAEINVS                                           *
.* V9.03.11  06/04/2004  Peter Vela    CAR 48227                              *
.*           Added VARGBCRN and PATGBCRN - BPAY Reference Number              *
.* V9.03.10  03/02/2004  J.Tan  CAR 45047                                     *
.*           Recompiled for PATCATAI - Non-banked Cash                        *
.* V9.03.09  18/12/2003  J.Tan                                                *
.*           Recompiled for AAECATBI - mods for new reciepting files          *
.* V9.03.08  11/12/2003  J.Tan                                                *
.*           Recompiled for AAEINVS - replaced patcash with comdepaf          *
.* V9.03.07  21/11/2003  J.Tan   CAR  44161                                   *
.*           Recompiled for PATCATAI - print credit note                      *
.* V9.03.06  07/11/2003  Peter Vela    CAR 44849                              *
.*           Recompiled for PATINVTL                                          *
.* V9.03.05  31/10/2003  Peter Vela    CAR 44757                              *
.*           Recompiled for PATINVTL                                          *
.* V9.03.04  20/10/2003  J.Tan    CAR 44172                                   *
.*           Recompiled for AAECATBI - Misc.theatre item file(pmsmitaf)       *
.*           29/10/2003 Sandra Barcham   43783                                *
.*           Recompiled for NZHISIIO and NZHISIUP                             *
.* V9.03.03  17/09/2003  CAR 40497   Lina Vo                                  *
.*           Recompile for AAECATBI, AAEINVS, PATDSMSC, PATMCHFD & IO.        *
.* V9.03.02  02/09/2003  CAR 42713   Mike Laming                              *
.*           Recompiled for PATINVTL (correct GST twice in final Total)       *
.* V9.03.01  30/07/2003  J.Tan                                                *
.*           Recompiled for AAEINVS                                           *
.******************************************************************************
.*       V9.02.20  11/04/2003  Davin  CAR/Quote 23297 (misc. charges keyin)   *
.*                 Recompiled for AAEINVS - default patient/rebate amounts    *
.*       V9.02.19  31/01/2003  Lina Vo      Defect 22709                      *
.*                 Remove open of outpreaf.                                   *
.*       V9.02.18  06/11/2002  Dean Cramer  Defect 23687                      *
.*                 Recompile for AAECATBI- SVM format adjustment              *
.*       V9.02.17  05/11/2002  J.Tan                                          *
.*                 Recompile for AAEINVS - Fixed print HF on invoice          *
.*       V9.02.16  01/07/2002  Dean Cramer                                    *
.*                 Recompile for AAAECATBI - Fix STVM blank lines error       *
.*       V9.02.15  21/06/2002  Dean Cramer                                    *
.*                 Recompile for AAAECATBI - RCH format changes               *
.*       V9.02.14  11/06/2002  J.Tan                                          *
.*                 Added patrfn                                               *
.*       V9.02.13  30/05/2002  J.Tan defect 18151                             *
.*                 Recomp.for AAEINVS - check if record already exist in exist*
.*       V9.02.12  29/05/2002  J.Tan                                          *
.*                 Recompiled for PATINVHL - fixed insurance claim variable   *
.*        V9.02.11  28/05/2002  J.Tan                                         *
.*                  Recompiled for AAECATBI - for I*D on aaedtref             *
.*        V9.02.10  22/05/2002  J.Tan                                         *
.*                  Mods to check parameter to print claim details            *
.*        V9.02.09  02/04/2002  J.Tan                                         *
.*                  Mods printing invoice                                     *
.*        V9.02.08  29/04/2002  J.Tan                                         *
.*                  Mods to open emrvisaf file                                *
.*        V9.02.07  01/03/2002  J.Tan                                         *
.*                  Recompiled for AAEINVS- commented out reading theatre fees*
.*        V9.02.06  07/12/2001  Tonii                                         *
.*                  Recompiled for PATCATAI - Casemix changes                 *
.*        V9.02.05  22.11.2001  J.Tan                                         *
.*                  Mods for view outstanding amount of invoice only          *
.*        V9.02.04  20.11.2001  B.G.Ackland                                   *
.*                  Remove pi's from Program
.*        V9.02.03  01/11/2001  Greg Horvat                                   *
.*                  Recompiled for ACTCOMN1 - Added xtra option to the        *
.*                  parameter PNSWRACE                                        *
.*        V9.02.02  17/10/2001  Dean Cramer                                   *
.*                  Recompiled for AAEINVS, make so spools, printer select    *
.*                  at end.                                                   *
.*        V9.02.01  22/09/2001  Tonii  SRF 13075                              *
.*                  Recompiled for PATDINVS                                   *
.******************************************************************************
.*        V5.10.B01 21/03/2001  Glenn Saunders                                *
.*                  Remove all references to PATSUR file (old surname file).  *
.*        V5.08.12  22/11/2000  Greg Horvat                                   *
.*                  Recompiled for PATCATAI - Commented out any code to do    *
.*                  with Hong Kong or Mt Alvernia                             *
.*        V5.08.11  15/11/2000  Jill Habasque                                 *
.*                  Recompiled for AAEINVS                                    *
.*        V5.08.10  09/11/2000  Ebon Clements SRF 6891                        *
.*                  Recompiled for PATINVS read patmchgf with key26           *
.*        V5.08.09  29/09/2000  Jill Habasque SRF 3060                        *
.*                  Recompiled for PATINVHL                                   *
.*        V5.08.08  15/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund table variables to 8 chars            *
.*        V5.08.07  24/07/2000  Davin                                         *
.*                  Recompiled for PATINVTL - template multipage invoice tail *
.*        V5.08.06  06/07/2000  Davin                                         *
.*                  Recompiled for PATINVHL, PATINVTL & PATCATAI              *
.*        V5.08.05  29/06/2000  Steve Armstrong                               *
.*                  Recompiled for PATCATAI                                   *
.*        V5.08.04  28/06/2000  Steve Downing                                 *
.*                  Recompiled for PATFIGFD/IO                                *
.*        V5.08.03  18/05/2000  Jill Habasque                                 *
.*                  Recompiled for changes to AAECATBI                        *
.*        V5.08.02  17/05/2000  Jill Habasque                                 *
.*                  Recompiled for AAEINVS                                    *
.*        V5.08.01  03/04/2000  Davin                                         *
.*                  Added parameters for invoice templating                   *
.*        V5.08.B06 30/03/2000  Davin                                         *
.*                  Recompiled for invoice templating                         *
.*        V5.08.B05 14/03/2000  Greg Horvat                                   *
.*                  Recompiled for PATINVT3 & PATINVT7                        *
.*        V5.08.B04 10/03/2000  J.Tan                                         *
.*                  Recompiled for AAEDTR                                     *
.*        V5.08.B03 08/03/2000  Steve Downing                                 *
.*                  Fixed read position for IBCNUGST                          *
.*        V5.08.B02 29/02/2000  Greg Horvat                                   *
.*                  Recompiled for PATINVT3 & PATINVT7 - Moved the getting of *
.*                  the primary disease code to a procedure                   *
.*                  25/02/2000  Greg Horvat                                   *
.*                  Recompiled for PATINVT5                                   *
.*        V5.08.B01 22/02/2000  Steve Downing                                 *
.*                  Recompiled for AAEINVS - initialise GST variables         *
.******************************************************************************
.*        V5.07.04  15/10/1999  Steve Armstrong                               *
.*                  Removed reference to CSTRTYR (not used)                   *
.*        V5.07.03  13/07/1999  N Harrington                                  *
.*                  Recompiled for AAECATBI, added web variables              *
.*        V5.07.02  21/06/1999  J.Tan  SRF 632459                             *
.*                  Recompiled for PATCATAI - printing accommodation          *
.*        V5.07.01  08/06/99 J.Tan                                            *
.*                  Recompiled for casemix                                    *
.*        V5.07.B05 14/01/1999  Nicole Harrington  507 Rebounds - Error 071   *
.*                  Fixed length of display date for AAEINVS                  *
.*        V5.07.B04 13/01/1999  Jim Stathopoulos                              *
.*                  Fixed Global Compile Errors                               *
.*        V5.07.B03 11/01/1999  Jill Habasque                                 *
.*                  Changed ACCDTE from DIM 8 to DIM 10                       *
.*        V5.07.B02 23/11/1998  Nicole Harrington                             *
.*                  5.07 changes                                              *
.*        V5.07.00  22/10/1998  Jim Stathopoulos                              *
.*                  507 Changes                                               *
.******************************************************************************
.*        V5.05.01  14/10/1997  Steve Armstrong    SRF 643393                 *
.*                  Recompiled for removal of THC invoice message             *
.******************************************************************************
.*        V5.04.03  14/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.*        V5.04.02  22/07/1996  Steve Armstrong  SRF 641785                   *
.*                  Recompiled for changes to PATINV15                        *
.*        V5.04.01  15/06/1996  Greg Horvat      SRF 616143                   *
.*                  Recompiled for PATCATAI & PATINV17 - Added new invoice    *
.*                  layout for MBF - layout 17                                *
.*        V5.03.03  16/04/1996    Howellsy   5.04                             *
.*                  Changed Accident & Emergency to Emergency.                *
.*        V5.03.02  04/08/1995  Greg Horvat      SRF 611050                   *
.*                  Recompiled for PATINV16 - Fixed invoice line ups          *
.*        V5.03.01  01/08/1995  Greg Horvat      SRF 610897                   *
.*                  Recompiled for AAECATBI & AAEINVS - Changed Port Mac.     *
.*                  invoice to print the attending doctor in the body of the  *
.*                  invoice                                                   *
.*        V5.03.B2  24/05/1995  Paul Howells     SRF 134644                   *
.*                  Check whether using invoice pending file before writing.  *
.******************************************************************************
.*            V5.01.01  16/08/89 Graeme Williams                               *
.*                      New PATSRCH routine                                    *
.*            V5.01.02  25/08/89 Graeme Williams                               *
.*                      Added GST to AAECATBI                                  *
.*            V5.01.03  30/08/89 K.Peak            SRF 102146                  *
.*                      Fixed display of other invs                            *
.*            V5.01.04  30/08/89 Graeme Williams                               *
.*                      New PATCOMN1 routine                                   *
.*            V5.01.05  05/09/89 K.Peak            SRF 102218, 102210          *
.*                      Fixed error message & fixed I * L 46614                *
.*            V5.01.06  06/09/89 S.Barcham                                     *
.*                      Fixed 12733 I * C                                      *
.*            V5.01.07  07/09/89 K.Peak            SRF 102239                  *
.*                      Sub. 1 line for 2 page invs                            *
.*                      08/09/89 K.Peak            SRF 102263                  *
.*                      Zero filled accommodation date                         *
.*            V5.01.08  13/09/89 M.Ohleiter                                    *
.*                      Included word processor for comments                   *
.*            V5.01.09  19/09/89 Graeme Williams   SRF 102348, 102346          *
.*                      Changes to PATCATAI                                    *
.*            V5.01.10  20/09/89 Graeme Williams   SRF 101341, 101345          *
.*                      Changes to PATINVS                                     *
.*            V5.01.11  21/09/89 K.Peak            SRF 102239                  *
.*                      2 Invoices message fixed                               *
.*            V5.01.12  07/12/89 E.Phan                                        *
.*                      Altered IBAPRNFD                                       *
.*            V5.01.13  15/01/90 DIG                                           *
.*                      Recompiled for changes to AAEDI1FD + IO                *
.*            V5.01.14  16/01/90 K.Peak            SRF 103661                  *
.*                      Fixed the printing of St.And Melb invoices PATCATAI    *
.*            V5.01.15  17/01/90 K.Peak            SRF 103661                  *
.*                      Fixed the re-printing of SAM invoices                  *
.*            V5.01.16  03.04.90 J.Tan             SRF 104451                  *
.*                      Check item date with visit discharge date - AAEINVS    *
.*            V5.01.17  17/04/90 J.Tan             SRF 104698                  *
.*                      Mods to use BEQPROG indicator                          *
.*            V5.01.18  15/05/90 J.Tan             SRF 104959                  *
.*                      Mods deposit date of the financial summary             *
.*            V5.01.19  18/05/90  E.Phan                                       *
.*                      Removed Fee Category file & implement A&E Misc Charges *
.*            V5.01.20  22/05/90 J.Tan             SRF 104901                  *
.*                      Added 8 new theatre classifications                    *
.*            V5.01.21  30/05/90  E.Phan           SRF 105159                  *
.*                      Check for zero claim code & blank hf in aaemchgf first *
.*            V5.01.22  30/05/90  E.Phan           SRF 105159                  *
.*                      Check for zero claim code & blank hf in aaemchgf first *
.*            V5.01.23  06/06/90 D.Di.Paola        SRF 103773                  *
.*                      Recompiled for changes to AAECONFD                     *
.*            V5.01.24  14/06/90  J.Tan            SRF 725                     *
.*                      Fixed A&E Item charges                                 *
.*            V5.01.25  24/07/90 Paul Duncan                                   *
.*                      Implemented second surname file                        *
.*            V5.01.26  14/09/90 i chung           SRF 106167                  *
.*                      Fixed spelling error in AAEINVS                        *
.*            V5.01.121 19/12/90 D.Di.Paola        SRF 107397                  *
.*                      Recompiled for PATURAFD                                *
.*            V5.01.122 15/01/91 J.Tan             SRF 107488                  *
.*                      Recompiled for AAEINVS                                 *
.*            V5.01.123 22/01/91 J.Tan             SRF 107540                  *
.*                      Recompiled for PATINVT7                                *
.*            V5.01.124 01/02/91 J.Tan             SRF 107757                  *
.*                      Recompiled for AAEINVS - "?" option on item code       *
.*            V5.01.125 24/01/1992  Graeme Williams                            *
.*                      New Zealand Billing Changes                            *
.*            V5.01.126 31/01/1992  Graeme Williams                            *
.*                      Alter invoice layouts to print on laser printers       *
.*            V5.01.127 23/03/92 J.Tan             SRF 113203                  *
.*                      Recompiled for AAECATBI (V5.01.02)                     *
.*            V5.01.128 12/06/92 Graeme Williams   SRF 114865                  *
.*                      Changes for 9 character miscellaneous items            *
.*            V5.01.129 26/06/92 i chung           SRF 115282                  *
.*                      Recompiled for AAEINVS (V5.01.17)                      *
.*            V5.01.130 05/11/1992  Graeme Williams                            *
.*                      Recompiled because No. of Services was added to the DTR*
.*            V5.01.131 06/11/1992  Graeme Williams                            *
.*                      Recompiled for PATINVT8   (5.01.06)                    *
.*            V5.01.132 23/11/1992  Justin Coates  (HONG KONG changes)         *
.*                      Recompiled for AAEINVS/PATINV10                        *
.*            V5.01.133 27/11/1992  Justin Coates   (HONG KONG changes)        *
.*                      Recompiled for AAEINVS/PATINV10 (line12)               *
.*            V5.01.134 27/11/1992  Justin Coates   (HONG KONG changes)        *
.*                      Recompiled for PATINV10 (line12)                       *
.*        V5.01.135 14/12/1992  Graeme Williams            SRF 119448          *
.*                  Recompiled for PATINV10                                    *
.*        V5.01.136 23/12/92 J.Tan   SRF 119673 119674                         *
.*                  Recompiled for PATINV10                                    *
.*        V5.01.137 06/01/93  DIG     QUOTE 7522                               *
.*                  Recompiled for PATINV11                                    *
.*        V5.01.138 27/11/1992  Justin Coates   (West Gippsland)               *
.*                  Recompiled for PATINV12                                    *
.*        V5.01.139 04/02/1993    Justin Coates  SRF 120070 & SRF 120071       *
.*                  Re-compile for PATINV10                                    *
.*        V5.01.140 30/12/92 Whirlpool                                         *
.*                  Dudley Adress changes                                      *
.*        V5.01.141 15/02/93  J.Tan    SRF 120626                              *
.*                  Recompiled for PATINV10                                    *
.*        V5.01.142 28/05/93 J.Tan   SRF 120832                                *
.*                  Recompiled for PATINV10                                    *
.*        V5.01.143 22/06/93 Rob. Sumsion  SRF122783                           *
.*                  Recompiled for PATINVS changes                             *
.*        V5.01.144 29/06/93 Rob. Sumsion  SRF122783                           *
.*                  Recompiled for PATINVS changes                             *
.*        V5.01.145 11/08/1993  Glenn Berry      SRF 122092                    *
.*                  Recompiled for PATINVT8                                    *
.*        V5.01.146 19/08/1993  Glenn Berry   Bulletin 27  SRF 117999          *
.*                  Recompiled for AAEINVS/PATINV12 changes                    *
.*                  Added read of PTCNPAOF                                     *
.*        V5.01.147 30/08/1993  Steve Armstrong      SRF 122092                *
.*                  Recompiled for NZHIS                                       *
.*        V5.01.148 27/08/93  "Mahannama" ROD                                  *
.*                  Recompiled for NZHIS                                       *
.*        V5.01.149 23/11/93  Paul Howells       NZHIS                         *
.*                  Added PATALRFD & IO for NZHISIIO                           *
.*        V5.01.150 26/11/1993  Glenn Berry      Hawkes Bay Changes            *
.*                  Added PATINV13                                             *
.*        V5.01.151 14/01/1994  Sandra Barcham                                 *
.*                  fix global recompile                                       *
.*        V5.01.152 28/01/1994  Glenn Berry      Hawkes Bay Changes            *
.*                  Recompile for AAEINVS (fixed not printing invoice number)  *
.*        V5.01.153 18/02/1994    Justin Coates  (SRF 127956)                  *
.*                  recompile for PATDSMSC - fix I*C                           *
.*        V5.01.154 23/03/1994    Matt Surridge                                *
.*                  Recompile for NZHISIIO and DONORDET.                       *
.*        V5.01.155 24/05/1995  Matt Surridge                                 *
.*                  Fixed bugs for global recompile.                          *
.*        V5.01.156 21/07/1994  Rob Leonard  SRF 130881                       *
.*                  Recompiled for PATINV12                                   *
.*        V5.01.157 03/08/1994  Rob Leonard  Quote 8064                       *
.*                  Added PATINV15 - Taranaki                                 *
.*        V5.01.158 12/08/1994  Rob Leonard                                   *
.*                  Changed Taranaki invoice layout to be GST inclusive       *
.*        V5.02.01  30.11.1994    B.G.Ackland                                 *
.*                  Remove Date of Death Link to NHI/MWS                      *
.*                  Recompile for Latest NHI/MWS Changes                      *
.*        V5.02.02  14/02/1995  Greg Horvat      SRF 134920 134922 134932     *
.*                  Recompiled for IBAPRINT                                   *
.*        V5.02.03  20/02/1995  Greg Horvat      SRF 134879                   *
.*                  Recompiled for PATAUMFD & PATIOAUM - added new variable & *
.*                  changed to write to this new variable                     *
.*        V5.02.04  22/02/1995  Greg Horvat      SRF 135134                   *
.*                  Recompiled for PATCATAI - Changed printing of E.F.R.      *
.*        V5.02.05  02/03/1995  Greg Horvat      SRF 134196  Quote 8277       *
.*                  Recompiled for PATCALFN & AAECATBI                        *
.*        V5.02.06  14/03/1995  Greg Horvat      SRF 134573  Quote 8300       *
.*                  Recompiled for PATBNKFD & PATIOBNK - Added PTBFRDTE       *
.*        V5.02.07  19/04/1995  Steve Armstrong                               *
.*                  Recompiled                                                *
.*        V5.02.08  28/04/1995  Paul Howells         SRF 134946               *
.*                  Recompiled for changes to PATINVS                         *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
          INC       CHKCLDCD/INC
          INC       AAECONFD/INC
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDI1FD/INC
          INC       AAEDTRFD/INC
          INC       AAEMCHFD/INC
          INC       BOKRC1FD/INC
          INC       CHKDIGVR/INC
          INC       EMRHTRFD/INC
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       IBACONFD/INC
          INC       IBAGEDFD/INC
          INC       IBAPRNFD/INC
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
          INC       IBAGSTFD/INC
          INC       NZHISIFD/INC
          INC       NZPCFNFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRFNFD/INC
          INC       NZPRDTFD/INC
          INC       NZPSPRFD/INC
          INC       MLTCFNFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTDTRFD/INC
          INC       OUTPREFD/INC
          INC       OUTSITFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       PATALRFD/INC
          INC       PATCODFD/INC
          INC       PATCOMM/INC
          INC       PATCMXFD/INC
          INC       PATCONFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       PATDINVS/INC
          INC       COMDEPFD/INC
          INC       RCPBNKFD/INC
          INC       RCPCONFD/INC
          INC       RCPREGFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBDTFD/INC
          INC       RCPCRSFD/INC
          INC       PATCFAFD/INC
          INC       PATFX1FD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATICDFD/INC
          INC       PATFIGFD/INC
          INC       PATFINFD/INC
          INC       PATFN1FD/INC
          INC       PATGSRFD/INC
          INC       PATIBLFD/INC
          INC       PATINLFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATIRNFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PMSPRGFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       NHIMASFD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATREMFD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATTFEFD/INC
          INC       PATTRNFD/INC
          INC       PATURAFD/INC
          INC       PATVISFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
.
          INC       PATDNRFD/INC
          INC       PATHSPFD/INC
          INC       PATSDNFD/INC
.......   INC       PATMWSFD/INC
          INC       PATSMWFD/INC
          INC       PATNIDFD/INC
          INC       PMSCNOFD/INC
          INC       PMSFCIFD/INC
          INC       PMSMTIFD/INC
          INC       PMSTLEFD/INC
          INC       PMSVX1FD/INC
          INC       PRIITMFD/INC
.
          INC       PMSABFFD/INC
          INC       WEBSECFD/INC
.
          INC       SCRPSTFD/INC
.
          INC       VARGBCRN/INC          * I-48227
.
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
.
TEMPFILE  IFILE     SQL, FIXED=215, KEY="u1-8"
.
DUNIQUE    DIM       8         8         1      UNIQUE COUNTER
UNIQUE     FORM      8         
.ADANUMB   FORM      8         8         9      A & E NUMBER
.ATDDATE   DIM       8         8        17      DATE YYMMDD
.ATPATAMT  FORM      8.2       6        25      AMOUNT - PATIENT PORTION
.ADAURNO   DIM       8         8        31      U/R NUMBER
.MCHARGE   DIM       9         9        39      CHARGE CODE
.MDESC     DIM       30        30       48      DESCRIPTION
.PNAME     DIM       35        35       78      PATIENT NAME
.ATRECEPT  DIM       8         8       113      RECEIPT NUMBER
MULTNUM    FORM      2         2       121      MULT NUM
.MINDIC    FORM      1         2       123      INDICATOR FOR CHANGING DESC.
.ADACOMP   DIM       3         3       125      COMPENSATION CODE (CL)
.PFUNDH    DIM       6         6       128      HEALTH FUND TABLE
.PFNDTB    DIM       4         4       134      HEALTH FUND TABLE
.IAMT      FORM      5         4       138      MBS AMOUNT
.MMSCGRP   DIM       3         3       142      MISC CHRGE GROUP (CATEGORY F
.MNINV     FORM      1         2       145      NUMBER OF INVS - 1 or 2 ONLY
.IBAND1    DIM       3         3       147      THEATRE CLASS 1 (CAT TB)
.IBAND2    DIM       3         3       150      THEATRE CLASS 2 (CAT TB)
.IBAND3    DIM       3         3       153      THEATRE CLASS 3 (CAT TB)
.IBAND4    DIM       3         3       156      THEATRE CLASS 4 (CAT TB)
.IBAND5    DIM       3         3       159      THEATRE CLASS 5 (CAT TB)
.IBAND6    DIM       3         3       162      THEATRE CLASS 6 (CAT TB)
.IBAND7    DIM       3         3       165      THEATRE CLASS 7 (CAT TB)
.IBAND8    DIM       3         3       168      THEATRE CLASS 8 (CAT TB)
.ATPATPOR  FORM      8.2       6       171      PATIENT PORTION OF CHARGE
.ATREBPOR  FORM      8.2       6       177      REBATE PORTION OF CHARGE
MBSFLAG    FORM      1         2       183      MBSFLAG
PCENFLG    FORM      1         2       185      PERCENTAGE FEE FLAG
.ADACLASS  DIM       3         3       187      Patient Classification
.IBAND9    DIM       3         3       190      THEATRE CLASS 9
.IBAND10   DIM       3         3       193      THEATRE CLASS 9
.IBAND11   DIM       3         3       196      THEATRE CLASS 9
.IBAND12   DIM       3         3       199      THEATRE CLASS 9
.IBAND13   DIM       3         3       202      THEATRE CLASS 9
.IBAND14   DIM       3         3       205      THEATRE CLASS 9
.IBAND15   DIM       3         3       208      THEATRE CLASS 9
.IBAND16   DIM       3         3       211      THEATRE CLASS 9
.PTMCKREB  DIM       1         1       214      KEYIN REBATE FLAG
. End of Record                        215
.
.        EXTRA VARIABLES
.
ACTION    DIM       1
ADIAG     DIM       50
ACCDTE    DIM       10      * Accommodation date used in AAECATBI
ADMISSNO  DIM       8
.
CMDLINE   DIM       50
CN        INIT      "CN"
CODE      DIM       2
CODEADM   INIT      "A "
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODECL    INIT      "CL"
CODEDP    INIT      "DP"
CURSESS   DIM       16
CURRDATE  DIM       8
.
CCENT1    DIM       2
CYEAR1    DIM       2
CMON1     DIM       2
CDAY1     DIM       2
.
CPDATE1   DIM       10
CWEBDNAM  DIM       2
CWEBDNAI  DIM       1
.
DOWNCASE  INIT      "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz"
DAYSDIFF  FORM      2
DOCTCODE  DIM       6
DOCFNAME  DIM       50
DIM5A     DIM       5
DIM12     DIM       12
DISPNAME  DIM       60
.
EFTPOS    INIT      "EFTPOS"
EMCNGINV  DIM       1
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
.
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FMTSNAME  DIM       35
FORM5     FORM      5
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
.
HOSPID    DIM       3
HDUDAY1   FORM      3          * HIGH DEPENDENCY
HDUDAY2   FORM      3
HDUFLG    FORM      "0"
.HEMBSTHE  FORM      1
.HSTANDM   FORM      1
.
LINENO    FORM      2
LWCHG     FORM      6.2        * LABOUR WARD FEE
LWCODE    INIT      "LW"
LWDT      DIM       8
.
MAXSEPDY  FORM      "35"
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MBSLOP    FORM      2
MBSNUM    FORM      "0"
MODE1     DIM       1
NAME35    DIM       35
OPTDES1   INIT      "                    "
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCODE    INIT      "OT"
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8          * OTHER ITEMS
OTDT2     DIM       8
OTFLG     FORM      "0"
OPOCFLAG  FORM      1
.
SURGFLG   FORM      "0"
SAVAMNT   FORM      12.2
SCNDGNAM  DIM       40
SERVDOCT  DIM       10
.
TFFSAMNT  FORM      12.2
THDUDT1   DIM       8
THDUDT2   DIM       8
THEACHG   FORM      6.2        * THEATRE FEE
THEADT    DIM       8
THEADTE   DIM       8
.
DCC       DIM       2
DDD       DIM       2
DYY       DIM       2
DMM       DIM       2
DESCOPT   DIM       20
DIM1A     DIM       1
DIM2A     DIM       2
DIM4      DIM       4
DIM9      DIM       9
DIM12A    DIM       12
DIM14     DIM       14
DIM14A    DIM       14
DIM18     DIM       18
DIM30     DIM       30
DIM32     DIM       32
DIM70     DIM       70
DNAME     DIM       20
DIRECT    INIT      "DIRECT DEP"
.
ENDDTE    DIM       8
ENDNAM    DIM       6
.
FNAMER    DIM       8
.
ITEMCD    FORM      1
.
KEYFLAG   FORM      1
KEY12A    DIM       12
.
LASTREC   FORM      "0"
LINECNT   FORM      2
LNO       FORM      2
.
MINOWE    FORM      8.2
MULTAMT   FORM      8.2
MINFLD    FORM      2
MAXSCRN   FORM      2
MENUTYPE  DIM       2
MONEY1    INIT      "MONEY ORD"
.
NMPNUMB   DIM       20
.
OUT       INIT      "OUT"
ONAME     DIM       30
OPERCODE  DIM       4
.
PAGECNT   FORM      3
PSTROL    FILE      ASCII, FIXED=256
.
REGIST8   DIM       2
.
SAVKEY12  DIM       12
SMCHARGE  DIM       9
SMITMTYP  FORM      1
SMMSCGRP  DIM       3
SADMNO    FORM      8
SAVADM    DIM       8
SAVDAT    DIM       8
SAVITEM   DIM       4
SAVMAMT   FORM      6.2
SAVTYP    FORM      1
SEC       FORM      5
SELFLG    FORM      "0"
SP12      INIT      "            "  
SP14      INIT      "              "
SPLING    FORM      2
STRTDAT   DIM       8
STRTNAM   DIM       6
.
TAMTT     FORM      6.2
TAMTP     FORM      6.2
TEMPAMT   FORM      6.2
THCFLG    FORM      2
THFUND    FORM      6.2
TPADM     FORM      8
TPREC     DIM       8
TPTRNO    FORM      3
TPUR      DIM       8
.
USERID    DIM       10
.
VSITE     DIM       6
VAR       FORM      1
.
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FILE      ASCII, FIXED=256
WTEXT     FORM      1
.
XAMT      FORM      4.2
XMBS      FORM      5
XDESC     DIM       30
XXADM     DIM       8
XXDATE    DIM       8
XXMULT    FORM      2
XXNAM     DIM       22
Z15       INIT      "zzzzzzzzzzzzzzz"
ZTWO      FORM      "00"
ZEIGHT    INIT      "00000000"
.
TEMP1     FILE      ASCII,FIXED=79
.
.         Web Variables (only the include files use these variables)
.
DAYFORMT  DIM       4
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
HTMLFILE  FIFO      ASCII, FIXED=250
MTHNAM3   DIM       3
MTHNAM3A  DIM       3
.
.         end web variables
.
PRGID     INIT      "IBAAAE20"
PRGNAM    INIT      "Print Emergency Invoices"
VERSION   INIT      "V12.00.02"
+
.         DISPLAY SCREEN HEADER AND OPEN FILES
.
          CALL      DISPHEAD
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          DISPLAY   *P56:24,"Opening aaede1af";
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDE1A3,"aaede1af"
.
          DISPLAY   *P64:24,"aaedi1af";
          OPEN      AAEDI1A1,"aaedi1af"
.
          DISPLAY   *P64:24,"emrvisaf";
          OPEN      EMRVISA1,"emrvisaf"
.
          DISPLAY   *P64:24,"aaedtref";
          OPEN      AAEDTRE1,"aaedtref"
.
          DISPLAY   *P64:24,"pmsmtiaf";
          OPEN      PMSMTIA1,"pmsmtiaf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
.
          DISPLAY   *P64:24,"patfinsf";
          OPEN      PATFINS1,"patfinsf"
.
          DISPLAY   *P64:24,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P64:24,"patirnge";
          OPEN      PATIRNG1,"patirnge"
.
          DISPLAY   *P64:24,"patitemn";
          OPEN      PATITEM1,"patitemn"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          OPEN      IBAGEDA1,"ibagedaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"oprardaf";
          OPEN      OPRARDA1,"oprardaf"
.
          DISPLAY   *P64:24,"oprdetaf";
          OPEN      OPRDETA1,"oprdetaf"
.
          DISPLAY   *P64:24,"oprdetaf";
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"nzpfigaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
.
          DISPLAY   *P64:24,"nzprfnaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
.
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
.
          DISPLAY   *P64:24,"nzpfinaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          OPEN      PATIPEN1,"patipenf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      PATINVR3,"patinvrf"
.
...  used in ABFAECCL
          CALL      TFILENAM                * Get file name calculating Exponent
          MOVE      TFILNAME,FNAMEN
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMER
.
.         Read in parameters
.
          READ      CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC:
                                  *43,IBCNMHOS:
                                  *85,IBCNUGST
          READ      CONTROLF,TEN;*66,CINVLAY,*79,CAPPRVNO:
                                 *94,CAGECOFF,*96,CNEXTINV:
                                 *166,CMEMB
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST:
                                 CHPADD1,CHPADD2,CHPPOST,CHTELEB:
                            *211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN9;*219,CINVRAE
          READ      CONTROLF,TWENTY;*193,PTCNDCLM,*198,PTCNPIOP,PTCNBCUT
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*60,PTCNCCRR,PTCNCLOR:
                                     *136,PTCNMITM,*200,PTCNICRA,*235,PTCNDPL8:
                                     *237,PTCNPAOF
          READ      CONTROLF,THIRTY;*131,HEMBSTHE,HSTANDM,HINVDES,*168,HNUMDES:
                                    *200,AECNFTYP
          READ      CONTROLF,FIFTY9;*66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY8;*40,AECNAEIH,*46,AECNAEIT
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR
          READ      CONTROLF,EIGHTY8;*86,CDAILYDT
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          UNPACK    CDAILYDT,DCC,DYY,DMM,DDD
.
          MOVE      ZERO,PRABFINV
          MATCH     SP3,PTCNDCLM
          GOTO      INIT0200 IF NOT EQUAL
          MOVE      "0  ",PTCNDCLM
.
INIT0200  RESET     HNUMDES,9
.
NEXT70    CMATCH    SP1,HNUMDES
          GOTO      NEXT71 IF NOT EQUAL
          BUMP      HNUMDES BY -1
          GOTO      NEXT71 IF EOS
          GOTO      NEXT70
.
NEXT71    MOVEFPTR  HNUMDES,VAR
          RESET     HNUMDES,VAR
          LENSET    HNUMDES
          RESET     HNUMDES
.
.         Setting BEQPROG to a one means that the comments maintenance will
.         not lock or unlock the admission record (which doesn't exist for
.         outpatients anyway)
.
          MOVE      ONE,BEQPROG
          MOVE      ZERO,DISPROG       * Not discharge program
.
.         Select the printer to be used
.
          MATCH     "IBARSH",PGM
          GOTO      START IF EQUAL
.
          CALL      SELPRINT
          MOVE      CPRTFLG,SPLING          * Save the spooling flag
+
.         START OF PROGRAN
.
START     HLINE     *G37,2,52,80
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Line-up Print":
                    *P1:6,*V2LON,TWO,*HOFF," = Single Patient by ":
                                           *+,HNUMDES,*-:
                    *P1:7,*V2LON,THREE,*HOFF," =                by U/R Number":
                    *P1:8,*V2LON,FOUR,*HOFF," = All ",*+,HNUMDES,*-:
                                            " patients in a given date range":
                    *P1:9,*V2LON,FIVE,*HOFF," = All ",*+,HNUMDES,*-:
                                           " patients owing at least X dollars";
.
          MATCH     "1",PTCNUABF
          IF        @EQUAL
           DISPLAY *P1:10,*V2LON,SIX,*HOFF," = Bulk ABF Invoice for a given ":
                                          "date range";
          ENDIF
.
          KEYIN     *P1:12,*EL,"Select Option : ",*V2LON,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      ENDIT IF EQUAL
.
          MOVE      ZERO,WEBFLAG
          MATCH     "IBARSH",PGM
          IF        @EQUAL
            MOVE      ONE,WEBFLAG
          ENDIF
.
REPEAT    MATCH     "1",PTCNUABF
          IF        @EQUAL
            BRANCH    OPTION OF START,OPTION2,OPTION3,OPTION4,OPTION5,OPTION4
          ELSE
            BRANCH    OPTION OF START,OPTION2,OPTION3,OPTION4,OPTION5
          ENDIF
          BEEP
          GOTO      START
.
.        This is used when returning from options 2 to 6
.
REPEAT1   MOVE      ZERO,PRABFINV
          MATCH     "1",PTCNUABF
          IF        @EQUAL
            BRANCH    OPTION TO REPEAT,REPEAT,REPEAT,OPT4I,OPT5C,OPT4I
          ELSE
            BRANCH    OPTION TO REPEAT,REPEAT,REPEAT,OPT4I,OPT5C
          ENDIF
          GOTO      REPEAT
+
.        Second Option
.
OPTION2   MOVE      SP70,ADANUMB
          DISPLAY   *P52:2,*V2LON,"- Patient by ",*+,HNUMDES,*-," ",*P1:3,*EF;
          KEYIN     *P1:4,*DV,HNUMDES," : ",*EL,*V2LON,ADANUMB;
          GOTO      START IF EOS
.
          MATCH     SP70,ADANUMB
          GOTO      START IF EQUAL
.
          MATCH     ZEROVISN,ADANUMB
          GOTO      START IF EQUAL
.
          CALL      GUSR0000                * get web user id
.
.        Read in visit record
.
          MOVE      ADANUMB,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF INVADMN
.
.        Read in Master file record record
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF INVADMN
          CALL      RDPMPX21
.
.        Locate Booking Record
.
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          IF        OVRCD=1
            CALL      RDPMEVT1         * check for emergency event
            BRANCH    OVRCD OF INVADMN
            MOVE      PMEVCCOD,ADACOMP
            MOVE      PMEVACON,ADADOCT
            MOVE      PMEVADTE,ADADATE
          ENDIF
.
          GOTO      PRINTLN
+
.        Third Option
.
OPTION3   DISPLAY   *P52:2,*V2LON,"- Patient by U/R ",*P1:3,*EF;
          DISPLAY   *P1:4,"U/R Number : ";
          MOVE      "14",CCOL
          MOVE      FOUR,CVERT
          MOVE      TWO,SRCHOPT
          CALL      KURN
          MOVE      CPPURNO,PVIURNO
.
          COMPARE   ONE,EXIT
          GOTO      START IF EQUAL
.
          CALL      GUSR0000                * get web user id
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF INVURNO
          CALL      RDPMPX21
.
.       Find the last admission number that has an invoice pending
.
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
OPT3LP1   CALL      RDKVISA2
          BRANCH    OVRCD OF INVPAID
.
          MATCH     PURNO,PVIURNO
          GOTO      INVPAID IF NOT EQUAL
.
          COMPARE   ONE,PVITYPE
          GOTO      OPT3LP1 IF NOT EQUAL
.
.        Locate Booking Record
.
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          IF        OVRCD=1
            CALL      RDPMEVT1         * check for emergency event
            BRANCH    OVRCD OF OPT3LP1
            MOVE      PMEVCCOD,ADACOMP
            MOVE      PMEVACON,ADADOCT
            MOVE      PMEVADTE,ADADATE
          ENDIF
.
.
.        Check that they have an invoice pending
.
          MOVE      PVIBILL,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD OF OPT3LP1
          GOTO      PRINTLN
+
.        Fourth Option
.
OPTION4   DISPLAY   *P52:2,*V2LON,"- From ",*P1:3,*EF,*HOFF:
                    *P1:4,"From Date : ";
.
.        Get the from date
.
          UNPACK    SP6 WITH CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
.
          MOVE      FOUR,CVERT
          MOVE      TEN3,CCOL
          CALL      KEYDATE
.
          MATCH     SP2,CDAY
          GOTO      START IF EQUAL
.
          PACK      STRTDAT WITH CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDAT
.
          DISPLAY   *P58:2,*V2LON,SP1,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,SP1;
.
.        Get the to date
.
          DISPLAY   *P1:5,"  To Date : ";
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
.
          MOVE      FIVE,CVERT
          CALL      KEYDATE
.
          PACK      ENDDTE WITH CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDTE
.
          DISPLAY   *P70:2,*V2LON,"to ",CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,SP1;
.
          MATCH     STRTDAT,ENDDTE
          GOTO      OPT4F IF NOT LESS
          DISPLAY   *P40:5,*B,*V2LON,"** Invalid Date Range **",*W;
          GOTO      OPTION4
.
OPT4F     IF        OPTION=4
            CALL      GETRNGE
          ENDIF
          CALL      KHOS0000
.
.        Check that these is the correct parameters
.
OPT4G     CALL      GUSR0000                * get web user id
.
          KEYIN     *P1:24,*EL,"Ok to Continue (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,"/",*V2LON,"C",*HOFF,") ? ",*V2LON,ANS;
          RESET     ANS
.
          MATCH     "Y",ANS
          GOTO      OPT4H IF EQUAL
          MATCH     "N",ANS
          GOTO      OPTION4 IF EQUAL
          MATCH     "C",ANS
          GOTO      START IF EQUAL
          BEEP
          GOTO      OPT4G
.
.        Open spool file
.
OPT4H     
.         MATCH    "IBARSH",PGM
.         GOTO     OPT4H2 IF EQUAL
.
          CALL      OPNPRINT
          MOVE      THREE,CPRTFLG   * Allow all receipts to be spooled together
.
OPT4H2    PACK      KEY21 WITH STRTDAT,SP30
          CALL      RDSDETA3
.
OPT4I     CALL      RDKDETA3
          BRANCH    OVRCD OF OPT4Z
.
          MATCH     ADADATE,ENDDTE
          GOTO      OPT4Z IF LESS
.
          UNPACK    ADADATE WITH CCENT,CYEAR,CMON,CDAY
.
          DISPLAY   *P1:24,*EL,*P50:24,"Scanning : ":
                    *V2LON,ADANUMB,SP1,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
          MOVE      ADANUMB,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD TO OPT4I
.
          MOVE      ADAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF OPT4I
          CALL      RDPMPX21
.
          IF        OPTION=4
            CALL      CHKRNGE
            BRANCH    OVRCD OF OPT4I
          ENDIF
          GOTO      PRINTLN
.
OPT4Z     MATCH     "IBARSH",PGM
          GOTO      OPT4Y IF EQUAL
.
          DISPLAY   *P1:24,*EL,*P26:24,*V2LON:
                    "***  Generation Completed  ***",*W;
          MOVE      SPLING,CPRTFLG       * Restore the original setting
.
OPT4Y     CALL      CLSPRINT
.
          GOTO      START
.
.        Option 5 : All OutPatients with amounts to be billed of
.        X dollars or more
.
OPTION5   DISPLAY   *P52:2,*V2LON,"- Owing at least X ",*P1:3,*EF;
          KEYIN     *P1:4,"Minimum amount owing : ",*EL,*V2LON,MINOWE:
                    *P24:4,*DV,MINOWE;
.
          COMPARE   ZERO,MINOWE
          GOTO      START IF LESS
.
          DISPLAY   *P70:2,*V2LON,*EL,"$",MINOWE;
          CALL      GETRNGE
          CALL      KHOS0000
          CALL      GUSR0000                * get web user id
.
OPT5A     KEYIN     *P1:24,*EL,"Ok to Continue (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,"/",*V2LON,"C",*HOFF,") ? ",*V2LON,ANS;
          RESET     ANS
.
          MATCH     "Y",ANS
          GOTO      OPT5B IF EQUAL
          MATCH     "N",ANS
          GOTO      OPTION5 IF EQUAL
          MATCH     "C",ANS
          GOTO      START IF EQUAL
          BEEP
          GOTO      OPT5A
.
.        Open a spool file
.
OPT5B     MATCH     "IBARSH",PGM
          GOTO      OPT5B2 IF EQUAL
.
          CALL      OPNPRINT
          MOVE      THREE,CPRTFLG   * Allow all receipts to be spooled together
.
OPT5B2    MOVE      ZEROVISN,IPADMNO
.
.        Read in next invoice pending record
.
          MOVE      IPADMNO,KEY8
          CALL      RDSIPEN1
OPT5C     CALL      RDKIPEN1
          BRANCH    OVRCD OF OPT5Z
          DISPLAY   *P1:24,*EL,*P50:24,"Scanning : ",*V2LON,IPADMNO;
.
          COMPARE   ONE,IPSYSTM
          GOTO      OPT5C IF NOT EQUAL
.
          MOVE      IPADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF OPT5C
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF OPT5C
          CALL      RDPMPX21
.
          CALL      CHKRNGE
          BRANCH    OVRCD OF OPT5C
.
.        Locate Booking Record
.
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          IF        OVRCD=1
            CALL      RDPMEVT1         * check for emergency event
            BRANCH    OVRCD OF OPT5C
            MOVE      PMEVCCOD,ADACOMP
            MOVE      PMEVACON,ADADOCT
            MOVE      PMEVADTE,ADADATE
          ENDIF
.
          GOTO      PRINTLN
.
OPT5Z     MATCH     "IBARSH",PGM
          GOTO      OPT5X IF EQUAL
.
          DISPLAY   *P1:24,*EL,*P26:24,*V2LON:
                    "***  Generation Completed  ***",*W;
          MOVE      SPLING,CPRTFLG       * Restore the original setting
.
OPT5X     CALL      CLSPRINT
          GOTO      START
+
.------------------------------------------------------------------------------
.         Check for ABF funding
.------------------------------------------------------------------------------
WABF0000  MOVE      ZERO,PRABFINV
          MOVE      ZERO,EXIT
.
          MATCH     "1",PTCNUABF
          GOTO      WABF2000 IF NOT EQUAL     * Not using ABF
.
          PACK      KEY5,ANSC,ANSL,ADACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,WABF2000
.
          MATCH     "A",TCINDC2
          GOTO      WABF2000 IF NOT EQUAL
.
.         Set PRABFINV for 'Calculating to be invoiced' amount (PROGFLAG=1)
.         Option 6 - PRABFINV = 1 for ABF charge only
.         Others   - PRABFINV = 2 for Item only
.
           IF        OPTION=6
             MOVE      ONE,PRABFINV         * ABF Charge only
           ELSE
             MOVE      TWO,PRABFINV         * Item charge only
           ENDIF
          GOTO      WABF9999
.
WABF2000  COMPARE   SIX,OPTION
          GOTO      WABF9999 IF NOT EQUAL   * Not printing ABF
.
.         we are doing option 6 (printing ABF invoices) but patient is not
.         an ABF patient or system parameter Using ABF Billing is not set
.
WABF9000  MOVE      ONE,EXIT
WABF9999  RETURN
+
.------------------------------------------------------------------------------
PRINTLN   
.
.    Check Clinical Document Mapping table to determine if Invoice can be raised
.
          MOVE      ADANUMB,KEY8
          CALL      RDPMVX11
.
          MOVE      SP70,INDMHOSP
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ENDIF
          MOVE      ADACOMP,INDMCLAM
          MOVE      "E",INDMSYST
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
          MOVE      ADAURNO,INDMURNO
          MOVE      ADANUMB,INDMADNO
.
          PROC      CHKCLDCP
          BRANCH    EXIT,REPEAT1
.
.        Calculate the amount of the invoice and determine if two invoices
.        are required (already done if we are in option 6)
.
          MOVE      ONE,PROGFLAG
.
          CALL      WABF0000                 * Check for ABF funding
          BRANCH    EXIT,REPEAT1
.
.        Check for an outstanding debt
.
          CALL      AAETBI
.
          IF        OPTION=5
            COMPARE   MINOWE,NETTOT
            GOTO      REPEAT1 IF LESS
          ENDIF
.
.        Lock the patient record to stop anyone else from using it
.
          MOVE      ADANUMB,KEY8
          CALL      RLAEDEA1
          BRANCH    OVRCD,LKERROR,LKERROR
.
.         Set PRABFINV for Printing (PROGFLAG=3)
.         Option 6 - PRABFINV = 1 for printing ABF charge only
.         Others   - PRABFINV = 0 for printing Item only
.
           IF        OPTION<>6
             IF         PRABFINV=2
               MOVE      ZERO,PRABFINV       * Item charge only
             ENDIF
             COMPARE   ZERO,GROSSTOT
             CALL      PRNTINV0 IF NOT EQUAL
           ELSE
             IF        PRABFINV=1
.
.              If ABF invoice amount is zero, check if a $0 amount of invoice
.              had already been raised
.
               IF         GROSSTOT=0
                 CALL       ZERI0000          * Check if $0 inv.has been raised
                 BRANCH     EXIT,PRIN200,PRIN200  * ABF invoice has been raised
               ENDIF
               CALL      PRNTINV0              * print zero dollar invoice
             ELSE
               COMPARE   ZERO,GROSSTOT
               CALL      PRNTINV0 IF NOT EQUAL
             ENDIF
           ENDIF
.
PRIN200   MOVE      ADANUMB,KEY8
          CALL      UUAEDEA1
.
.        If not a batch of invoices, goto next invoice
.
          BRANCH    OPTION OF REPEAT1,REPEAT1,REPEAT1
.
          BRANCH    CINVFF OF PRIN400
          GOTO      REPEAT1
.
PRIN400   IF        PTCNINVL<>9 
            IF        GROSSTOT<>0
.             PRINT     *F;      * Single formfeed to seperate batched invoices
            ENDIF
          ENDIF
          GOTO      REPEAT1
.
GETSVAR   RETURN
+
.        Subroutine to ask the operator for a name range
.
GETRNGE   MOVE      "A     ",STRTNAM
          MOVE      "zzzzzz",ENDNAM
.
          KEYIN     *P1:7,*EL,*P1:9,*EL:
                    *P1:7,"Enter Starting Name : ",*DV,*V2LON,STRTNAM:
                    *P23:7,*RV,STRTNAM,*HOFF:
                    *P1:9,"Enter Ending Name   : ",*DV,*V2LON,ENDNAM:
                    *P23:9,*RV,ENDNAM;
.
          MATCH     STRTNAM,ENDNAM
          RETURN    IF NOT LESS
.
          DISPLAY   *P40:9,*B,*V2LON,"** Invalid Name range **",*W2;
          GOTO      GETRNGE
.
.        Subroutine to check that the patient is in the required name range
.
CHKRNGE   MOVE      ZERO,OVRCD
          MATCH     STRTNAM,PSNAME
          GOTO      OVERCOND IF LESS
.
          MATCH     PSNAME,ENDNAM
          GOTO      OVERCOND IF LESS
.
          IF          IBCNMHOS=1
            MATCH       SP10,HOSPID
            IF          !@EQUAL
              PACK        KEY8,PVIBILL,SP8
              CALL        RDPMVX11
              BRANCH      OVRCD,CHKR999
              MATCH       PMVXMHOS,HOSPID
              GOTO        OVERCOND IF NOT EQUAL
            ENDIF
          ENDIF
.
CHKR999   RETURN
+
.*******************************************************************************
.       Check for cancelled visit or $0 invoice has been raised
.       Do not raise invoice if patient is not discharged
.*******************************************************************************
ZERI0000  MOVE      ZERO,EXIT
          MOVE      ADANUMB,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            BRANCH   EMVISTAT,ZERI9000           * not discharged
            COMPARE  FOUR,EMVISTAT
            GOTO     ZERI9000 IF EQUAL           * Cancelled visit
          ENDIF
.
          PACK      KEY16,ADANUMB,Z70            * position in invoice file
          CALL      RDSINV3
ZERI1000  CALL      RDPINV3                      * read the next record
          BRANCH    OVRCD,ZERI9999               * no more records
.
          MATCH     ADANUMB,PINVADM              * same admission # ?
          GOTO      ZERI9999 IF NOT EQUAL        * no
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ZERI1000 IF NOT EQUAL        * Credit note
.
          COMPARE   THREE,PTINCMIX
          GOTO      ZERI9200 IF EQUAL            * ABF Invoice
.
          COMPARE   ZERO,PINVAMT
          GOTO      ZERI1000 IF NOT EQUAL
.
ZERI9000  MOVE      ONE,EXIT                     * found an invoice with $0
          GOTO      ZERI9999
.
ZERI9200  MOVE      TWO,EXIT                     * ABF invoice raised already
ZERI9999  RETURN
+
.*******************************************************************************
.       Keyin hospital ID
.*******************************************************************************
KHOS0000  MOVE       ZERO,EXIT
          MOVE       SP70,HOSPID
          COMPARE    ONE,IBCNMHOS
          GOTO       KHOS9999 IF NOT EQUAL
.
          DISPLAY    *P1:15,*EL,"Hospital Id : ";
          MOVE       TEN5,ECOL
          MOVE       "15",EVERT
          MOVE       SP3,CKYIDEF3
          MOVE       ZERO,CKYIMAND           * Not Mandatory
          OPEN       PATHSPA1,"pathspaf"
.
          CALL       PATHSPKY
          BRANCH     EXIT,KHOS1000,KHOS9000
          MOVE       PTHSHOSP,HOSPID
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS1000  MOVE       "All Hospitals",PTHSNAME
          MOVE       SP70,HOSPID
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS9000  MOVE       ONE,EXIT
KHOS9999  RETURN
+
.        End of program
.
ENDIT     CLOSE     PSTROL,DELETE
          CLOSE     WORK,DELETE
          CLOSE     TEMP1,DELETE
          CHAIN     PGM
+
.
INVURNO   DISPLAY   *P30:4,*EL,*B,*V2LON,"** U/R Number does not exist **",*W2;
          GOTO      REPEAT
.
INVADMN   DISPLAY   *P30:4,*EL,*B,*V2LON:
                    "** ",*+,HNUMDES,*-," Number does not exist **",*W2;
          GOTO      REPEAT
.
INVPAID   DISPLAY   *P30:4,*EL,*B,*V2LON,"** Patient has no Admissions ***",*W2;
          GOTO      REPEAT
.
LKERROR   DISPLAY   *P1:24,*EL,"*** Patient Admission busy on Terminal ":
                    *V2LON,ADALOCK,*HOFF," ***   ",*BLINKON,"Please Wait",*W3;
          GOTO      REPEAT1
.
.       Display the top screen after the question mark option
.
DISPB     DISPLAY   *P1:4,*EF,"U/R Number: ",*V2LON,PVIURNO,*HOFF:
                    *P20:4,"   Name : ",*V2LON,PNAME,*HOFF:
                    *P1:5,"Admission : ",*V2LON,PVIBILL,*HOFF;
.
.       This is a dummy routine that need to be defined for PATDSBFE that
.       is called from PATCRATE
.
DATAB     RETURN
.
WEBERR00 
DLUM0000
OLUM0000
IPRH0000
CHKCMXPT  RETURN
+
.-------------------------------------------------
. Format Doctors Given Name
.-------------------------------------------------
DOCGIV00  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV00 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
.         Check for any more names
.
          SETLPTR   NAME35,35              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME35,CCITEM          * reset to this point
          PACK      KEY35,NAME35,SP70      * reset form pointer
          MOVE      KEY35,NAME35

DOCGIV10  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV10 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this Initial
.
          UNPACK    NAME35,KEY1,KEY50
          APPEND    KEY1,DISPNAME
          APPEND    SP1,DISPNAME
.
          GOTO      DOCGIV99
.
.         Rest of the string is one name
.
DOCGIV20  UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
DOCGIV99  RETURN
+
.*******************************************************************************
.*                                  GUSR0000               Called by: MAIN0000 *
.*                               Get Web User Id                               *
.*******************************************************************************
.
GUSR0000  KEYIN     *P1:20,*EF,"Web User Id  : ",*V2LON,USERID
.
          PACK      USERID,USERID,SP70
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,GUSR9100
.
          MOVE      ZERO,EXIT
          GOTO      GUSR9999
.
GUSR9100  MOVE      ONE,EXIT
GUSR9999  RETURN
+
.------------------------------------------------------------
. Procedure to get Doctor Code from Outpatient Clinic ID
. COPTION - 1 Return DOCTCODE
.           2 Output Location
.           3 (N/A)
.           4 Output Menu Type
.           5 Output Unit
.------------------------------------------------------------
          DEFPROC  OUTDET00
.
          INC      OUTPREFD/INC
          INC      OUTCLIFD/INC
          INC      OUTBOAFD/INC
          INC      OUTMA1FD/INC
          INC      OUTBB1FD/INC
.
KEYBOA    DIM      28
KEYCLI    DIM      20
.
          MOVE     SP70,DOCTCODE
          COMPARE  ZERO,PVITYPE
          GOTO     OUTDET50 IF EQUAL
.
          PACK     KEY6,PVISITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,PVISITE,PVIDOCT,PVIDATE,SP70
          BRANCH   COPTION,OUTDET60
.
          PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYBOA,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL     RDSBOKA1
OUTDET10  CALL     RDKBOKA1
          BRANCH   OVRCD,OUTDET95
          PACK     KEYBOA,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH    KEY20,KEYBOA
          GOTO     OUTDET95 IF NOT EQUAL
          MATCH    OBAOUTNO,PVIBILL         * Set up billing number
          GOTO     OUTDET10 IF NOT EQUAL
          GOTO     OUTDET80
.
OUTDET50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     OUTPREA1,"outpreaf"   * Pre Attendance File
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
          MOVE     ADMISSNO,KEY8
          CALL     RDPREA1               * Check for Pre-Attendance
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY6,OPRSITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,OPRSITE,OPRCLIN,OPRDATE,SP70
          PACK     KEYBOA,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
.
          BRANCH   COPTION,OUTDET60,OUTDET70,OUTDET70,OUTDET70
.
OUTDET60  MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILCLIA1 * Determine Doctor from Clinic ID
          TRAP     OVERCOND IF IO
          OPEN     OUTCLIA1,KEY8         * Clinic Details
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY20,KEYCLI,Z70      * Read for Current Effective Clinic
          CALL     RDCLIA1
          IF       OVRCD=0
            GOTO     OUTDET65
          ENDIF
.
          CALL     RDSCLIA1
          CALL     RDPCLIA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET65  MOVE     OCADOCT,DOCTCODE
.
          MATCH    SP70,DOCTCODE
          IF       @EQUAL
            MOVE     OCACCONS,DOCTCODE
          ENDIF
.
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET70  PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          MOVE     KEYBOA,KEY28
          CALL     RDBOKA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET80  IF       COPTION=4
            PACK     MENUTYPE,TWO,OBASTAT * Outpatient Booking
            MOVE     ZERO,EXIT
            GOTO     OUTDET99
          ENDIF
.
          IF       COPTION=5
            PACK     CFNAME,OSTFILE,FILBB1A1
            CALL     OPOTBB11
            MOVE     ADMISSNO,KEY8
            CALL     RDBOKB1
            IF       OVRCD=0
              MATCH    SP6,OTBBDEPT
              GOTO     OUTDET95 IF EQUAL
              MOVE     OTBBDEPT,CODE       * Unit code
              MOVE     ZERO,EXIT
            ENDIF
            GOTO     OUTDET99
          ENDIF
.
          MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILMA1A1  * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTMA1A1,KEY8          * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL     RDMASA1
          BRANCH   OVRCD,OUTDET95
.
          WRITE    HTMLFILE;OTMACLOC;
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET95  MOVE     ONE,EXIT
          GOTO     OUTDET99
.
          INC       OUTCLIIO/INC
          INC      OUTPREIO/INC
          INC       OUTBOAIO/INC
          INC       OUTMA1IO/INC
          INC       IBAOVRIO/INC
          INC       OUTBB1IO/INC
.
OUTDET99  ENDPROC
.------------------------------------------------------------
. Procedure to get Emergency Details
.   COPTION = 1 Return Consultant DOCTCODE
.             2 Output Location
.             3 Output Triage Status
.             4 Output Menu Type
.------------------------------------------------------------
          DEFPROC  EMRCHK00
.
          INC      EMRVISFD/INC
          INC      EMRLOCFD/INC
.
EMRCHK10  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     EMRVISA1,"emrvisaf"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRCHK90
.
          MOVE     ADMISSNO,KEY8
          CALL     RDEMVIS1
          BRANCH   OVRCD,EMRCHK90
.
          COMPARE  FOUR,EMVISTAT
          GOTO     EMRCHK90 IF EQUAL
.
          MOVE     EMVIDOCT,DOCTCODE
          IF       COPTION=4
            PACK     MENUTYPE,ONE,EMVISTAT
            GOTO     EMRCHK99
          ENDIF
          IF       COPTION=2
            IF       EMVISTAT=1
              OPEN     EMRLOCA1,"emrlocaf"
              MOVE     "Other Departments",EMLODESC
              MOVE     EMVILOCN,KEY3
              CALL     RDEMLOC1
              WRITE    HTMLFILE;"Emergency - ",EMLODESC;
            ELSE
              WRITE    HTMLFILE;"Discharged";
            ENDIF
          ENDIF
          IF       COPTION=3
            WRITE    HTMLFILE;EMVITRIG;
          ENDIF
          GOTO     EMRCHK99
.
EMRCHK90  MOVE     PVIDOCT,DOCTCODE
          IF       COPTION=2
            WRITE    HTMLFILE;"Emergency";
          ENDIF
          GOTO     EMRCHK99
.
          INC      EMRVISIO/INC
          INC      EMRLOCIO/INC
          INC       IBAOVRIO/INC
.
EMRCHK99  ENDPROC
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.==============================================================================
.
          INC       STD001IO
          INC       AAECATBI
          INC       AAECMNT
          INC       AAEINVS
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATINV
          INC       CLPATINP
          INC       PATDOCCD
          INC       AAEDE1IO/INC
          INC       AAEDEBIO/INC
          INC       AAEDI1IO/INC
          INC       AAEDTRIO/INC
          INC       AAEMCHIO/INC
          INC       BOKRC1IO/INC
          INC       EMRHTRIO/INC
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       IBAPRNIO/INC
          INC       IBATMDIO/INC
          INC       IBATMHIO/INC
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       IBAPRINT
          INC       MLTCFNIO/INC
          INC       NZHISIIO
          INC       NZIBSRCH
          INC       NZPCFNIO/INC
          INC       NZPFIGIO/INC
          INC       NZPRFNIO/INC
          INC       NZPRDTIO/INC
          INC       NZPSPRIO/INC
          INC       NZPFINIO/INC
          INC       NZPIVBIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTDTRIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       OUTCLIIO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       PATHSPKY
          INC       PATCALFN
          INC       PATCATAI
          INC       PATCOMN1
          INC       PATDRGIO/INC
          INC       PATGBCRN             * I-48227
          INC       PATINLIO/INC
          INC       PATINVHL
          INC       PATINVTL
          INC       PRTINVBD
          INC       PATALRIO/INC
          INC       PATCMXIO/INC
          INC       PATCODIO/INC
          INC       COMDEPIO/INC
          INC       RCPBNKIO/INC
          INC       RCPREGIO/INC
          INC       RCPDTEIO/INC
          INC       RCPBDTIO/INC
          INC       RCPCRSIO/INC
          INC       PATCFAIO/INC
          INC       PATFX1IO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATICDIO/INC
          INC       PATINPIO/INC
          INC       PATFIGIO/INC
          INC       PATFINIO/INC
          INC       PATFN1IO/INC
          INC       PATGSRIO/INC
          INC       PATIBLIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATIRNIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PMSPRGIO/INC
          INC       PMSEXTIO/INC
          INC       PMSEVTIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATTFEIO/INC
          INC       PATURAIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWR1IO/INC
          INC       PATWMAIO/INC
          INC       PATWVEIO/INC
          INC       NHIMASIO/INC
          INC       PRIITMIO/INC
          INC       PATSNDX
          INC       PATSNX2
          INC       GETALTID
          INC       PMSOSDTM                * Outstanding Debt alert routine
          INC       PRNTICDC
          INC       SEXDSP00
          INC       CHKCLDCP
.
          INC       PATDNRIO/INC
          INC       PATHSPIO/INC
          INC       PATSDNIO/INC
......    INC       PATMWSIO/INC
          INC       PATSMWIO/INC
          INC       PATNIDIO/INC
          INC       PMSMTIIO/INC
          INC       PMSTLEIO/INC
          INC       PMSCNOIO/INC
          INC       PMSFCIIO/INC
          INC       PMSVX1IO/INC
.
          INC       PMSABFIO/INC
          INC       WEBSECIO/INC
.
          INC       CALCAGE
          INC       CHKSUGCL
          INC       NAMSTRCD
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       PATITMRD
          INC       TFILENAM                * Generate Temp File Name
.
          INC       WEBERRIO/INC            * Web Server Error Logging
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       CLPATDTR
.
AGECHK    RETURN
.
..........................................................................
