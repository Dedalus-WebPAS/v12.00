.*****************************************************************************
.*  Include  :  NZHISWUP.PBL                                                 *
.*                                                                           *
.*  Function :  This include contains the routines required to               *
.*              update the NZ National Database for the Web Servers.         *
.*                                                                           *
.*  Includes :  NZHISIFD.INC - data variables used by this include           *
.*                                                                           *
.*  Routines :                                                               *
.*              NEWHCU   -  Get New NHI No. for patient                      *
.*              UPDHCU   -  Update Nat. database with details                *
.*              MRGHCU   -  Inform NHI of Merge of 2 Nat. No.'s              *
.*              UPDDNR   -  Update Donor and Contact details                 *
.*              UPDMWS   -  Update Medical Warning details                   *
.*                                                                           *
.*        V9.03.01  24/10/2003  Jill Habasque SRF 43783                      *
.*                  Split reads of fifos into errors first, then fields      *
.*        V9.02.01  21/03/2003  Jill Habasque SRF 36883                      *
.*                  Added length and timeout on all fifo reads               *
.*                                                                           *
.*****************************************************************************
.************************************************************************
.*  NEWHCU  :  Get a new NHI Number for a patient                       *
.*             Parameters : PMI details in NZIB.... form                *
.************************************************************************
NEWHCU    MOVE      "2 ",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "655",WRLNGTH                 * FIFO record length (write)
          WRITE     NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF:
                    NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM,NZIBADD1:
                    NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBPANO,NZIBDOB:
                    NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                    NZIBSEX,NZIBACNT:
                    NZIBALSR[1],NZIBALG1[1],NZIBALG2[1],NZIBALG3[1],NZIBALPN[1]:
                    NZIBALSR[2],NZIBALG1[2],NZIBALG2[2],NZIBALG3[2],NZIBALPN[2]:
                    NZIBALSR[3],NZIBALG1[3],NZIBALG2[3],NZIBALG3[3],NZIBALPN[3]:
                    NZIBALSR[4],NZIBALG1[4],NZIBALG2[4],NZIBALG3[4],NZIBALPN[4]:
                    NZIBSCRB,NZIBDUPL,NZIBUPDT;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "86",RDLNGTH                 * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          MATCH     "AA",NZIBAPPC                 * valid read?
          GOTO      NWHCU900 IF NOT EQUAL         * error
.
          MOVE      "276",RDLNGTH                 * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBNMPI,NZIBSURN,NZIBGIV1:
                    NZIBGIV2,NZIBGIV3,NZIBPRNM:
                    NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                    NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                    NZIBSEX;
.
          MOVE      ZERO,OVRCD                    * valid read
          GOTO      NWHCU999
.
NWHCU900  MOVE      ONE,OVRCD                     * an error was encountered
.
NWHCU999  RETURN
.************************************************************************
.*  UPDHCU  :  Update National database with details from local system  *
.************************************************************************
UPDHCU    MATCH     NZTMPURP,NMPNUMB
          GOTO      UPHCU800 IF EQUAL       * have a Temp NHI Number 
.
          MOVE      "4 ",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "311",WRLNGTH                 * FIFO record length (write)
          WRITE    NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF,NZIBNMPI:
                          NZIBNMCF,NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX,NZIBSCRB,NZIBDUPL,NZIBUPDT;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "86",RDLNGTH                 * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          MATCH     "AA",NZIBAPPC                 * valid read?
          GOTO      UPHCU900 IF NOT EQUAL         * error
.
          MOVE      "276",RDLNGTH                 * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBNMPI:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX;
.
UPHCU800  MOVE      ZERO,OVRCD                    * valid read
          GOTO      UPHCU999
.
UPHCU900  MOVE      ONE,OVRCD                     * an error was encountered
.
UPHCU999  RETURN
.************************************************************************
.*  MRGHCU  :  Inform the NHI of the merger of two national numbers     *
.************************************************************************
MRGHCU    MOVE      "7 ",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "45",WRLNGTH
          WRITE     NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF:
                             NZIBNMPI,NZIBALNO;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "86",RDLNGTH
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          MATCH     "AA",NZIBAPPC               * valid read?
          GOTO      MRHCU900 IF NOT EQUAL         * error
.
          MOVE      ZERO,OVRCD                    * valid read
          GOTO      MRHCU999
.
MRHCU890  MOVE      TWO,OVRCD                     * Application rejected
          GOTO      MRHCU999
.
MRHCU900  MOVE      ONE,OVRCD                     * an error was encountered
.
MRHCU999  RETURN
+
.******************************************************************************
.*  UPDDNR  :  Update the Donor and Contact details for a patient on Nat. Sys *
.******************************************************************************
UPDDNR    MATCH     NZTMPURP,NMPNUMB
          GOTO      UPDNR800 IF EQUAL       * have a Temp U/R Number 
.
          MOVE      "14",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "342",WRLNGTH                 * FIFO record length (write)
          WRITE     NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF:
                             NZIBNMPI,NZIBUACT,NZIBSTSU:
                             NZIBPCSN,NZIBPCG1,NZIBPCG2,NZIBPCG3,NZIBPRNM:
                             NZIBPCA1,NZIBPCA2,NZIBPCSB,NZIBPCTW,NZIBPCCT:
                             NZIBRELC,NZIBWKPH,NZIBAHPH;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          MATCH     "AA",NZIBAPPC                 * valid read?
          GOTO      UPDNR900 IF NOT EQUAL         * error
.
UPDNR800  MOVE      ZERO,OVRCD                    * valid read
          GOTO      UPDNR999
.
UPDNR890  MOVE      TWO,OVRCD                     * Application rejected
          GOTO      UPDNR999
.
UPDNR900  MOVE      ONE,OVRCD                     * an error was encountered
.
UPDNR999  RETURN
+
.****************************************************************************
.*  UPDWMS  :  Update the Medical Warning details for a patient on Nat. Sys *
.****************************************************************************
UPDMWS    
          MATCH     NZTMPURP,NMPNUMB
          GOTO      UPMWS800 IF EQUAL       * have a Temp NHI Number 
.
          MOVE      "13",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "157",WRLNGTH                 * FIFO record length (write)
          WRITE     NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF:
                             NZIBNMPI,NZIBUACT,NZIBSEVR:
                             NZIBDTON,NZIBWTXT,NZIBMARC,NZIBFACC:
                             NZIBDOCC,NZIBSYSI,NZIBMWCD,NZIBENTM;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          MATCH     "AA",NZIBAPPC               * valid read?
          GOTO      UPMWS900 IF NOT EQUAL         * error
.
UPMWS800  MOVE      ZERO,OVRCD                    * valid read
          GOTO      UPMWS999
.
UPMWS890  MOVE      TWO,OVRCD                     * Application rejected
          GOTO      UPMWS999
.
UPMWS900  MOVE      ONE,OVRCD                     * an error was encountered
.
UPMWS999  RETURN
.------------------------------------------------------------
. Check for Illegal Characters ^~|&!
.----------------------------------------------------------------
CHRCHK00  SCAN     "&",NHMAS001
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS002
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS003
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS004
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS005
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS006
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS007
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS008
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS009
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS010
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS011
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS012
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS013
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS014
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS015
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS016
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS017
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "&",NHMAS018
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS001
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS002
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS003
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS004
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS005
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS006
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS007
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS008
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS009
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS010
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS011
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS012
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS013
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS014
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS015
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS016
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS017
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "^",NHMAS018
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS001
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS002
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS003
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS004
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS005
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS006
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS007
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS008
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS009
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS010
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS011
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS012
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS013
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS014
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS015
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS016
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS017
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "~",NHMAS018
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS001
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS002
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS003
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS004
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS005
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS006
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS007
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS008
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS009
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS010
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS011
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS012
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS013
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS014
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS015
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS016
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS017
          GOTO     CHRCHK90 IF EQUAL
          SCAN     "|",NHMAS018
          GOTO     CHRCHK90 IF EQUAL
          MOVE     ZERO,EXIT
          GOTO     CHRCHK99
.
CHRCHK90  MOVE     "Illegal Character Found (&~~^) - ",WEBTITLE
          CALL     WEBERR00 
          MOVE     ONE,EXIT
.
CHRCHK99  RETURN
