.------------------------------------------------------------------------------- 
. Program       : OBSFHRCD 
.
. Function      : FHIR AllergyIntolerance and Flag Common Code
.               : This procedure is called from OBAPALPR and CLIWEB01
.
. Modifications :
.-------------------------------------------------------------------------------
. V11.03.03 01/09/2023  Jacob Jackson  TSK 0935070
.           Make reviewdate/reviewdttm extension value empty if 
.           PTALRDTE is not populated
. V11.03.02 29/08/2023  Sunny          TSK 0935067 
.           Changed RESALL00 to show the Severity description 
. V11.03.01 23/08/2023  Thanh T        TSK 0935069
.           Changed RESALL00 to Add Severity code to extension 
.------------------------------------------------------------------------------- 
. V10.11.03 27.11.2017  B.G.Ackland    TSK 0835482 
.           FHIR Severity Mild 1-3, Modererate 4-6, Sever 7-9
. V10.11.02 14.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Fix Asseter having extra }
. V10.11.01 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.00 14.08.2017  B.G.Ackland    TSK 0835482 
.           Re-organise code for common usage by CLIWEB01
.------------------------------------------------------------------------------- 
. Output FHIR Format AllergyIntolerance - Allergies
.------------------------------------------------------------------------------- 
RESALL00  STRIP     WBTPFIL
          PACK      FHRPATID,PTALURNO,SP70
          SQUEEZE   FHRPATID
.
          MOVE      "active",FHRSTAT
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MOVE      "inactive",FHRSTAT
          ENDIF
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            MOVE      "inactive",FHRSTAT
          ENDIF
          STRIP     FHRSTAT
          PACK      KEY10,PTALUSID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          MATCH     SP70,PTALRDTE
          IF        !@EQUAL
            UNPACK    PTALRDTE,CCENT,CYEAR,CMON,CDAY
            PACK      DESC01,CCENT,CYEAR,DASH,CMON,DASH,CDAY,SP70
            STRIP     DESC01
          ELSE 
            MOVE      SP70,DESC01
            STRIP     DESC01
          ENDIF
.
          MOVE      "false",KEY5
          MATCH     "1",PTALCPAC
          IF        @EQUAL
            MOVE      "true",KEY5
          ENDIF
.
          UNPACK    PTALCDTE,CCENT,CYEAR,CMON,CDAY
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"AllergyIntolerance#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"clinicalStatus#": #"",FHRSTAT,"#",":
                    " #"verificationStatus#": #"confirmed#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-externalidentifier#"":
                        " ,#"valueString#":#"",PTALTPID,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-icd10#"":
                        " ,#"valueString#":#"",PTALICDC,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-reviewdttm#"":
                        " ,#"valueDateTime#":#"",DESC01,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-shortcomment#"":
                        " ,#"valueString#":#"",PTALRCOM,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-inithospital#"":
                        " ,#"valueReference#": {":
                        "   #"reference#": #"Location/Hospital-",PTALHOSP,"#"} },":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-carepathway#"":
                        " ,#"valueBoolean#": ",KEY5," },":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-severity#"":
                        " ,#"valueString#":#"",PTALLSEV,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"assertedDate#": #"",CCENT,CYEAR,"-",CMON,"-",CDAY,"#",":
                    " #"recordedDate#": #"",CCENT,CYEAR,"-",CMON,"-",CDAY,"#",":
                    " #"recorder#": {#"reference#": #"Practitioner/User-",PTALUSID,"#", ":
                    " #"display#" : #"",WBSENAM,"#" },";
          MATCH     SP70,PTALRQBY
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,"   #"asserter#": {":
                        "   #"reference#": #"Practitioner/HCP-",PTALRQBY,"#",":
                        "   #"display#": #"",DOCFNAME,"#" },";
          ENDIF
          UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,CCENT,CYEAR,DASH,CMON,DASH,CDAY
          WRITE     HTMLFILE;*+,"   #"patient#": {#"reference#": #"Patient/",FHRPATID,"#" },":
                    "   #"onsetDateTime#": #"",KEY10,"#",":
                    "   #"onsetPeriod#": {":
                    "   #"fhir_comments#" : #"complete-date#", ":
                    "   #"start#" : #"",KEY10,"#" ";
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            PACK      KEY10,CCENT,CYEAR,DASH,CMON,DASH,CDAY
            WRITE     HTMLFILE;*+,",   #"end#" : #"",KEY10,"#"";
          ENDIF
.
          MOVE      SP70,TCINDC20
          PACK      KEY5,PTALCATG,PTALCODE   * Key is cat and code
          CALL      RDCODE1                  * Read patient codes file
          IF        OVRCD=1
            MOVE      KEY5,PTCDLDES
            MOVE      SP70,TDESC 
          ENDIF
.
          MOVE      "other",FHRCLAS
          MATCH     "M",TCINDC20
          IF        @EQUAL
            MOVE      "medication",FHRCLAS
          ENDIF
          MATCH     "E",TCINDC20
          IF        @EQUAL
            MOVE      "environment",FHRCLAS
          ENDIF
          MATCH     "F",TCINDC20
          IF        @EQUAL
            MOVE      "food",FHRCLAS
          ENDIF
          MATCH     "B",TCINDC20
          IF        @EQUAL
            MOVE      "biologic",FHRCLAS
          ENDIF
          STRIP     FHRCLAS
.
          WRITE     HTMLFILE;*+,"},   #"code#": {":                 
                    "     #"coding#": [ {":
                    "       #"system#": #"%BASEURL/ValueSet/Category-",PTALCATG,"#", ":
                    "       #"code#": #"",PTALCODE,"#", ":
                    "       #"display#": #"",PTCDLDES,"#"":
                    "     } ]":
                    "   },":
                    "   #"category#": [ #"",FHRCLAS,"#" ],": 
                    "   #"type#": #"allergy#"";
          WRITE     HTMLFILE;*+,",   #"note#": [ { #"text#" : #"";
          CALL      FHRALC00
          WRITE     HTMLFILE;*+,"#"} ]";
          MATCH     SP70,PTALREAC
          IF        @EQUAL
            MOVE       "unknown",PTALREAC
            MOVE       "Reaction Unknown",ALRTREAD
          ENDIF
          STRIP     PTALREAC
          STRIP     ALRTREAD
          MOVE      SP70,FHRCLAS
          MATCH     "1",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "2",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "3",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "4",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "5",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "6",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "7",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          MATCH     "8",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          MATCH     "9",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          STRIP     FHRCLAS
          WRITE     HTMLFILE;*+,", #"reaction#": [ { " : 
                    "  #"severity#": #"",FHRCLAS,"#",":
                    "  #"manifestation#": [ {":
                    "    #"coding#": [ {":
                    "      #"system#": #"%BASEURL/ValueSet/Category-wn#",":
                    "      #"code#": #"",PTALREAC,"#",":
                    "      #"display#": #"",ALRTREAD,"#"":
                    "    } ]":
                    "  } ]":
                    "} ] }";
.
RESALL99  RETURN
.------------------------------------------------------------------------------- 
. Output FHIR Format Flag - NON Allergies
.------------------------------------------------------------------------------- 
RESFLG00  
          PACK      FHRPATID,PTALURNO,SP70
          SQUEEZE   FHRPATID
          STRIP     WBTPFIL
.
          MOVE      "active",FHRSTAT
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MOVE      "inactive",FHRSTAT
          ENDIF
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            MOVE      "inactive",FHRSTAT
          ENDIF
          STRIP     FHRSTAT
.
          PACK      KEY10,PTALUSID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,CCENT,CYEAR,DASH,CMON,DASH,CDAY
.
          MATCH     SP70,PTALRDTE
          IF        !@EQUAL
            UNPACK    PTALRDTE,CCENT,CYEAR,CMON,CDAY
            PACK      DESC01,CCENT,CYEAR,DASH,CMON,DASH,CDAY,SP70
            STRIP     DESC01
          ELSE
            MOVE      SP70,DESC01
            STRIP     DESC01
          ENDIF
.
          UNPACK    PTALCDTE,CCENT,CYEAR,CMON,CDAY
.
          PACK      KEY5,PTALCATG,PTALCODE   * Key is cat and code
          CALL      RDCODE1                  * Read patient codes file
          IF        OVRCD=1
            MOVE      KEY5,PTCDLDES
            MOVE      SP70,TDESC
          ENDIF
.
          MOVE      "false",KEY5
          MATCH     "1",PTALCPAC
          IF        @EQUAL
            MOVE      "true",KEY5
          ENDIF
.
          MOVE      SP70,FHRCLAS
          MATCH     "1",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "2",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "3",PTALLSEV
          IF        @EQUAL
            MOVE      "mild",FHRCLAS
          ENDIF
          MATCH     "4",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "5",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "6",PTALLSEV
          IF        @EQUAL
            MOVE      "moderate",FHRCLAS
          ENDIF
          MATCH     "7",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          MATCH     "8",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          MATCH     "9",PTALLSEV
          IF        @EQUAL
            MOVE      "severe",FHRCLAS
          ENDIF
          STRIP     FHRCLAS
.         
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Flag#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"status#": #"",FHRSTAT,"#",":
                    " #"extension#": [";
          MATCH     SP70,PTALRQBY
          IF        !@EQUAL
            WRITE     HTMLFILE;*+," { #"url#":#"%BASEURL/extension/dxc-hc-requestedby#"":
                        " ,#"valueReference#": {":
                        "   #"reference#": #"Practitioner/HCP-",PTALRQBY,"#",":
                        "   #"display#": #"",DOCFNAME,"#" } },";
          ENDIF
.         
          WRITE     HTMLFILE;*+," { #"url#":#"%BASEURL/extension/dxc-hc-comments#"":
                        " ,#"valueString#":#"";
          CALL      FHRALC00
          WRITE     HTMLFILE;*+,"#"},";
.
          WRITE     HTMLFILE;*+," { #"url#":#"%BASEURL/extension/dxc-hc-externalidentifier#"":
                        " ,#"valueString#":#"",PTALTPID,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-icd10#"":
                        " ,#"valueString#":#"",PTALICDC,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-severity#"":
                        " ,#"valueString#":#"",PTALLSEV,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-severity-description#"":
                        " ,#"valueString#":#"",FHRCLAS,"#"},":           
                    " { #"url#":#"%BASEURL/extension/dxc-hc-reviewdate#"":
                        " ,#"valueDateTime#":#"",DESC01,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-shortcomment#"":
                        " ,#"valueString#":#"",PTALRCOM,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-inithospital#"":
                        " ,#"valueReference#": {":
                        "   #"reference#": #"Location/Hospital-",PTALHOSP,"#"} },":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-carepathway#"":
                        " ,#"valueBoolean#": ",KEY5," },":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"recordedDate#": #"",CCENT,CYEAR,"-",CMON,"-",CDAY,"#",":
                    " #"subject#": { #"reference#": #"Patient/",FHRPATID,"#" }, ":
                    " #"author#": { #"reference#": #"Practitioner/User-",PTALUSID,"#", ":
                    " #"display#" : #"",WBSENAM,"#" }, ":
                    " #"category#": {":
                    "   #"coding#": [ {":
                    "     #"system#": #"%BASEURL/ValueSet/alertType#", ":
                    "     #"code#": #"",PTALCATG,"#",":
                    "     #"display#": #"",ALRTCATD,"#"":
                    "   } ]":
                    " }, ":
                    " #"code#": {":
                    "   #"coding#": [ {":
                    "     #"system#": #"%BASEURL/ValueSet/Category-",PTALCATG,"#", ":
                    "     #"code#": #"",PTALCODE,"#", ":
                    "     #"display#": #"",PTCDLDES,"#"":
                    "   } ]":
                    " }, ":
                    " #"period#": {":
                    "   #"fhir_comments#" : #"complete-date#", ":
                    "   #"start#" : #"",KEY10,"#" ";
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            PACK      KEY10,CCENT,CYEAR,DASH,CMON,DASH,CDAY
            WRITE     HTMLFILE;*+,",   #"end#" : #"",KEY10,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"} }"
RESFLG99  RETURN
.---------------------------------------------------------------------
. FHIR Notes Output
.---------------------------------------------------------------------
FHRALC00  MOVE      SP70,ALRCOMM
          MATCH     "       0",URNUMBER
          GOTO      FHRALC50 IF NOT EQUAL
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALA1
FHRALC10  CALL      RKPMALA1
          BRANCH    OVRCD,FHRALC99
          MATCH     PTALURNO,PMANURNO
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      FHRALC99 IF NOT EQUAL
          MOVE      PMANCOMM,ALRCOMM
          REP       "#"'",ALRCOMM
          RESET     ALRCOMM
          WRITE     HTMLFILE;ALRCOMM;
          WRITE     HTMLFILE;*+," ",ALRCOMM;
          GOTO      FHRALC10
.
FHRALC50  PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1
FHRALC60  CALL      RKPMALN1
          BRANCH    OVRCD,FHRALC99
          MATCH     PTALURNO,PMANURNO
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      FHRALC99 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      FHRALC99 IF NOT EQUAL
          MOVE      PMANCOMM,ALRCOMM
          REP       "#"'",ALRCOMM
          RESET     ALRCOMM
          WRITE     HTMLFILE;*+," ",ALRCOMM;
          GOTO      FHRALC60
.
FHRALC99  RETURN
.
