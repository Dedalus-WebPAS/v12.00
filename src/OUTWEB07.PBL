.----------------------------------------------------------------------
. Program       : OUTWEB07
.
. Function      : Outpatients invoices
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.02 30/06/2025  Peter Vela       TSK 0939466
.           Fixed Eclipse Webservieces DVAW validations D1217000
.           and D1216S00
. V12.00.01 26/05/2025  Bella Turco      TSK 0955096
.           Alphanumeric changes                        
. V11.05.02 21/02/2025  J.Tan   TSK 0955356
.           Recompiled for PATCALFN - Financial details
. V11.05.01 18/02/2025 Peter Vela        TSK 0939466
.           Added Eclipse Webservices DVAW functionality
. V11.04.03 07/11/2024 Thanh T           TSK 0946085
.           Added RCCNSTRF field - Display Statement Reference
. V11.04.02 30/09/2024  J.Tan            TSK 0951977
.           Mod Print/Raise invoice for ABF patient (items only)
. V11.04.01 04/03/2024  PJ Le Febour     TSK 0929044dc
.           update WBBSCUID WBBSCDAT WBBSCTIM before call WRWBBBS1
. V11.03.06 08/11/2023  Nikitha B      TSK 0927699c
.           Read CAPPRVNO and PTCNHABN for Hospital Approval ABN number.
. V11.03.05 04/10/2023  Nikitha B     TSK 0927699
.           Recomplied for PATINVHL, PATINVTL - Stationary variables
. V11.03.04 10/07/2023  J.Tan          TSK 0923703
.           Recompiled for ABFAEINV - Hospital remoteness
. V11.03.03 15/06/2023  Bella Turco    TSK 0931756
.           Recompiled for PRTINVBD             
. V11.03.02 25/05/2023  J.Tan          TSK 0923703
.           Recompiled for ABF new calculations
. V11.03.01 24/11/2022 J.Tan          TSK 0906597
.           Recompiled for ABFOTINV - checking Contract Close off date
. V11.02.04 11/11/2022  J.Tan          TSK 0906597
.           Recompiled for ABFOTINV - Multidisciplinary clinic Cat CQ TCINDC2=M
. V11.02.03 19/07/2022 J.Tan           TSK 0906597
.           Mod for NWAU calculations NWAUFLAG 
.           19/09/2022 Thanh T         TSK 0908346
.           Called CHKCLDCP to check if the clinical document is setup for
.           the claim type clininal document mapping table. This will determine
.           the disabled status of the Invoice button
. V11.02.02 16/03/2022  J.Tan           TSK 0902652
.           Recompiled for OUTCATBI - Patient Invoice new functionality
. V11.02.01 02/02/2022 Peter Vela      TSK 0902857
.           Added WebServices parameter validation around BBSW0000
. V11.01.08 11/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFOTINV - Mod for Multiple NEP Values
. V11.01.07 14/09/2021  Davin          TSK 0911277
.           Recompiled for PRTINVBD
. V11.01.06 10/09/2021  Davin          TSK 0911277
.           Recompiled for PATINVTL - Changed field 20 length to 12.2
. V11.01.05 31/08/2021  J.Tan          TSK 0910799
.           Recompiled for PRTINVBD - printing Referring ADF
. V11.01.04 24/08/2021  Davin          TSK 0897318
.           Recompiled for PATINVTL - added field 57(Adjustment Total)
. V11.01.03 21/07/2021   Peter Vela     TSK 0909175
.           Added WebServices BBSW functionality
. V11.01.02 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
. V11.01.01 24/03/2021  Ebon Clements  TSK 0904373
.           CrossBrowser - fixed close bold tag
. V11.00.10 19/01/2021  J.Tan          TSK 0883075
.           Recompiled for PRTINVBD - mod to print ADF address on invoice
. V11.00.09 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.08 14/10/2020  J.Tan          TSK 0894879
.           Recompiled for PRTINVBD - Print 30 item desc.for RCH Inv.
. V11.00.07 06/08/2020 J.Tan            TSK 0892319
.           Recompiled for ABFOTINV - Added Adjustment type 026 and 027
. V11.00.06 03/08/2020 J.Tan      TSK 0886178
.           Recompiled for ABFOTDET - fixed displaying ABF calculation
. V11.00.05 09/06/2020 J.Tan           TSK 0886178
.           Recompiled for ABFOTDET - mod to ABF details
. V11.00.04 29/06/2020  J.Tan           TSK 0893767
.           Recompiled for ABFOTINV - Changes CALCFLAG to 01/01/2021
. V11.00.03 20/04/2020 J.Tan           TSK 0890733
.           Recompiled for ABFOTINV - ABF new 2020 calculation
. V11.00.02 08/04/2020 J.Tan             TSK 0868813
.           Recompiled for PATINVHL
. V11.00.01 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V10.15.03 31/12/2019  J.Tan            TSK 0886176
.           Added INVOICNO tag for 'ABF details' option from Invoiced screen
. V10.15.02 11/10/2019  Peter Vela       TSK 0882906
.           Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF
.           09/10/2019  J.Tan           TSK 0857392
.           Recompiled for OUTCATBI - checking Tier 2 for ABF
. V10.15.01 09/10/2019  J.Tan           TSK 0857392
.           Recompiled for ABFOTINV - added Remoteness area adjustment
. V10.14.04 11/07/2019  Peter Vela      TSK 0857392
.           Added mods for ABF
.           21/06/2019  J.Tan           TSK 0857392
.           Mod for ABF invoice
. V10.14.03 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.02 28/02/2019  Peter Vela     Task 0867807
.           Added outpatient master validation in BULKBL00
. V10.14.01 15/01/2019  Peter Vela     Task 0867807
.           Recompiled for OUTCATBI
. V10.13.06 11/01/2019  Peter Vela     Task 0867807
.           Recompiled for OUTCATBI
.           11/12/2018  J.Tan          Task 0859743
.           Added printing Bulk Billing DB4 Form
. V10.13.05 21/12/2018  Peter Vela     Task 0859743
.           Recompiled for OUTECTFD
. V10.13.04 30/11/2018  Peter Vela     TSK 0859743
.           Added Bulk Billing functionality for Raise and Raise and Claim
.           invoice 
. V10.13.03 26/10/2018  Thanh T        TSK 0859743
.           Added BULKBL00, MISC0000 for OUTCATBI Changes
. V10.13.02 25/10/2018  Thanh T        TSK 0859743
.           Added CATECODE for OUTCATBI Changes
. V10.13.01 23/10/2018  Thanh T        TSK 0859743
.           Added Main1300 for updating bulk billing extra details    
. V10.12.01 28/02/2018  J.Tan          TSK 0852351
.           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)
. V10.11.04 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.03 25/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments.
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.01 13/06/2017  J.Tan          TSK 0839991
.           Recompiled for PATDBTYP (PATCMSTP)
. V10.08.02 07/11/2016  Ebon Clements   TSK 0827937
.           Recompiled for PATINVHL - Hospital approval number
. V10.08.01 26/07/2016  J.Tan           TSK 0825883
.           Fixed OUTPAT00 - validating Outpatient visit
. V10.07.01 22/12/2015  J.Tan           CAR 0303942
.           Recompiled for OUTCATBI - Additional payment types
. V10.06.06 14/08/2015  J.Tan           CAR 320073
.           Recompiled for PATCATAI - reprint invoice for unreleased cash
. V10.06.05 07/08/2015  Davin          CAR 317002
.           Recompiled for PRTINVBD - Print pmexname for ADF MO
. V10.06.04 14/07/2015  Peter Vela     CAR 318700
.           Recompiled for PRBILCMN - Validate for deleted VISMDT
.           record
. V10.06.03 15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.02 02/04/2015  Ania P         CAR 313236                     
.           Recompiled for PRTINVBD                                   
. V10.06.01 25/03/2015 J.Tan      CAR 314662
.           Fixed Billing Comments for Outpatient invoice
. V10.05.03 10/02/2015 J.Tan      CAR 311717
.           Recompiled for PATINVHL
. V10.05.02 12/01/2014  Peter Vela     CAR 310738
.           Recompiled for PRTINVBD
. V10.05.01 28/10/2014 J.Tan     CAR 304455
.           Recompiled for PATINVHL - fixed Doctor Name and Provider no
. V10.04.07 27/05/2014  J.Tan           CAR 295319
.           Added tag for Balance payable to check for inv.with a credit balance
. V10.04.06 01/05/2014  J.Tan           CAR 261630
.           Removed patauc Cash audit file
. V10.04.05 15/04/2014  J.Tan           CAR 261630
.           Recompiled for PATCMNTS - Removed port number from temp file name
. V10.04.04 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 26/02/2014  J.Tan          CAR 275810
.           Recompiled for PRTINVBD - to print Defence Force details
. V10.04.01 20/01/2014  J.Tan          CAR 273713
.           Recompiled for PRTINVBD -Print payment types of a receipt on invoice
.----------------------------------------------------------------------
. V10.03.12 09/12/2013  Ania P         CAR 294740
.           Recompiled for PATINVHL
. V10.03.11 12/09/2013  Peter Vela     CAR 271911
.           Recompiled for PATINVTL
. V10.03.10 20/06/2013  Davin          CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.09 17/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATINVHL, PATINVTL
. V10.03.08 09/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN, PATINVHL, PATINVTL
. V10.03.07 26/03/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN
. V10.03.06 18/03/2013  J.Tan          CAR 280802
.           Recompiled for PATINVHL - Outpatient HF membership
. V10.03.05 05/03/2013  Patrick Adair  CAR 281898
.           Recompiled for PRNTICDC
. V10.03.04 18/07/2012  Don Nguyen     CAR 264561
.           Recompiled for PATGBCRN
. V10.03.03 01/05/2011 J.Tan           CAR 237245
.           Recompiled for OUTCATBI -JH inv.to print rounding -ve amt in bracket
. V10.03.02 21/03/2012 J.Tan         CAR 262115
.           Recompiled for OUTCATBI - Mods to display/print Quantity
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.02.05 04/11/2011 J.Tan           CAR 237245
.           Recompiled for OUTCATBI - JH inv.to print rounding amount
. V10.02.04 12/10/2011 J.Tan  CAR 235370 
.           Recompiled for PATINVHL - NHI names for SX
. V10.02.03 29/09/2011 J.Tan  CAR 252227
.           Recompiled for PRTINVBD - fixed printing items
. V10.02.02 21/04/2009  J.Tan         CAR 237245
.           Recompiled for OUTCATBI - Insurance Providers for Johns Hopkins
. V10.02.01 04/04/2011  Jill Parkinson CAR 239574
.           Removed open of ibaprntf
. V10.01.03 13/01/2011  Mike Laming   CAR 233084
.           Added include CLPATINV for OUTINVS & Recompiled
. V10.01.02 15/12/2010  Mike Laming   CAR 233046
.           Recompiled for OUTCATBI - Mods to Misc.Charges PATMCHFD
. V10.01.01 30/10/2010 J.Tan          CAR 233043
.           Recompiled for OUTCATBI - mods to print invoice
. V9.12.06  04/12/2009  Peter Vela    CAR 202333
.           Recompiled for PATINVHL - Changed variable 88 to surname only 
. V9.12.05  05/10/2009  J.Tan         CAR 191624                      
.           Recompiled for OUTINVS - set Deposit Applied date to Current date
. V9.12.04  24/08/2009 J.Tan  CAR 186102
.           Recompiled for NZPCATAI - Mods to display Win/Loss after invoiced
. V9.12.03  21/07/2009  J.Tan          CAR 199603
.           Recompiled for PATCATAI - prints ICD codes on TAC/WC Inv.
. V9.12.02  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.01  20/07/2009  Mike Laming   CAR 187485
.           Someone added NZPCFNaf to PATINVHL and broke this
. V9.11.03  01/04/2009  J.Tan         CAR 192772
.           Recompiled for PATCATAI - Mods to Johns Hopkins invoice
. V9.11.02  23/03/2009  Davin         CAR 178015
.           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number
. V9.11.01  14/10/2008  Peter Vela    CAR 159227
.           Recompiled for PATINVHL - Added Emergency Invoice
.           Arrival Date and Time
. V9.10.03  21/05/2008  J.Tan         CAR 167702
.           Recompiled for OUTCATBI - Cabrini invoice layout
. V9.10.02  13/05/2008  Ebon Clements CAR 166566
.           Recompiled for PATINVHL
. V9.10.01  13/05/2008 J.Tan      CAR 162313
.           Added Deposit status to comdepaf
. V9.09.08  27/12/2007 Peter Vela     CAR 155907
.           Recompiled for PATINVTL
. V9.09.07  16/11/2007 Peter Vela     CAR 110766
.           Recompiled for PATINVHL
. V9.09.06  10/08/2007 Peter Vela     CAR 146143
.           Recompiled for PATCATAI
. V9.09.05  25/07/2007 Peter Vela     CAR 144787
.           Recompiled for PATCATAI
. V9.09.04  03/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.03  29/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.02  25/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.01  14/06/2007  J.Tan            CAR 142173
.           Recompiled for PATCATAI - Emergency events
. V9.08.21  02/05/2007  J.Tan            CAR 132276
.           Recompiled for OUTCATBI - SX GST
. V9.08.20  05/03/2007  J.Tan            CAR 130462
.           Recompiled for OUTCATBI - JH GST
. V9.08.19  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.18  22/02/2007 Mike Laming   CAR 119436
.           Add PMSOSDTM (PROC FLAGDEBT) for Outstanding Debt Alert ind.
. V9.08.17  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.16  23/01/2007  Mike Laming   CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.15  11/01/2007  Mike Laming       CAR 103368
.           Add PATEDTFD/IO for CCPS EDI Extract in OUTINVS
. V9.08.14  20/12/2006  J.Tan             CAR 128646
.           Recompiled for OUTCATBI - Rounding
. V9.08.13  19/12/2006  J.Tan             CAR 128646
.           Fixed Printing invoice for multiple users
. V9.08.12  19/12/2006  J.Tan             CAR 128646
.           Fixed Printing invoice for multiple users
. V9.08.11  13/12/2006  J.Tan             CAR 127625
.           Mods to JH HRN
. V9.08.10  13/12/2006  J.Tan             CAR 127726
.           Recompiled for OUTCATBI - JH GST Discount
. V9.08.09  11/12/2006  J.Tan             CAR 127646
.           Recompiled for modifications to JH invoices
. V9.08.08  05/12/2006  J.Tan             CAR 127092
.           Mods SELF PRFA for JH Invoice
. V9.08.07  04/12/2006  J.Tan          CAR 126763
.           Recompiled for OUTCATBI -Added quantity column to JH Detailed inv.
. V9.08.06  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.05  27/11/2006  J.Tan         CAR 125987
.           Recompiled for PATCATBI - fixed displaying Item transaction date
. V9.08.04  16/11/2006  Steve Armstrong   CAR 124160
.           Recompiled for PATINVHL (Singapore HRN)
.           Recompiled for PATINVTL (Singapore HRN)
. V9.08.03  14/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.02  26/10/2006  J.Tan         CAR 122541
.           Recompiled for PATCATBI - Alternate Item group for JH Invoice
. V9.08.01  29/09/2006  Peter Vela    CAR 120319
.           Recompiled for PATINVHL
.----------------------------------------------------------------------
. V9.07.04  25/09/2006  Peter Vela    CAR 118940
.           Recompiled for PATCATBI
. V9.07.03  02/08/2006  Peter Vela    CAR 113658
.           Recompiled for PATINV21 - Fixed Date and Cash Payment
.           display
. V9.07.02  31/07/2006 J.Tan      CAR 103365
.           Mods for John hopkins invoice
. V9.07.01  25/07/2006  Peter Vela    CAR 113658
.           Recompiled for PATCATAI - Fixed "Journal Total" display
. V9.06.02  16/05/2006  Peter Vela    CAR 104103
.           Recompiled for PATCATAI - PTCNINVL=12
. V9.06.01  24/04/2006  J.Tan         CAR 102287
.           Recompiled for PATINVHL - Added fields for multi hospital details
. V9.05.03  29/03/2006 Peter Vela    CAR 95780
.           Recompiled for PATINVHL - Added emg mobile contact numbers
. V9.05.02  6/03/2006  Peter Vela    CAR 61299
.           Recompiled for PATINVHL
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.23  17/11/2005  Peter Vela    CAR 84547
.           Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1
. V9.04.22  25/10/2005  Sandra Barcham CAR 81362
.           Recompiled for OUTINVS - fix fincode pack for deposits
. V9.04.21  28/09/2005  Jeni Tan       CAR 78676
.           Recompiled for OUTCATBI - printing invoice amounts
. V9.04.20  28/09/2005  Jeni Tan       CAR 77671
.           Recompiled for OUTCATBI - printing invoice amounts
. V9.04.19  12/08/2005  Jeni Tan       CAR 62750
.           Removed redefined variables
. V9.04.18  01/08/2005 J.Tan   CAR  69340
.           Recompiled for PATCATAI - fixed printing credit note total
. V9.04.17  14/07/2005  Peter Vela    CAR 62172
.           Recompiled for PATINVTL
. V9.04.16  14/07/2005  J.Tan         CAR 57854
.           Mods checking date range file for current date
. V9.04.15  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.14  17/02/2005  Mike Laming   CAR 56030
.           Re-compile for PATINV25 - fix screen painted tail printing 
. V9.04.13  30/12/2004  J.Tan       CAR 55977
.           Recompiled for OUTINVS - Calvary outpatient invoice layout 
. V9.04.12  09/12/2004  J.Tan         CAR 55635
.           Recompiled for PATINVTL - Receipt amount on invoice tail
. V9.04.11  06/12/2004  Lina Vo       CAR 54561 
.           Recompiled for OUTINVS                                 
. V9.04.10  29/11/2004  Mike Laming   CAR 54534 
.           Re-comple for PATCMSTP - fix Addit.Charge Description  
. V9.04.09  10/11/2004  J.Tan   CAR 55024
.           Recompiled for OUTCATBI - SVHM outpatient invoice layout
. V9.04.08  14/10/2004  J.Tan   CAR 54312
.           Recompiled for OUTCATBI - SVHM outpatient invoice layout
. V9.04.07  06/10/2004  J.Tan   CAR 53798
.           Removed PATMSCDS
. V9.04.06  04/10/2004  Peter Vela CAR 52906
.           Recompiled for PATCATAI
.           23/09/2004  Lina Vo  CAR 53660 
.           Recompile for OUTINVS & PATCATAI                                    
. V9.04.05  03/09/2004  Lina Vo  CAR 52998 
.           Initialise Page Number for PRTINVHL                       
. V9.04.04  30/08/2004  J.Tan    CAR 53073
.           Mods to display Hospital ID on invoice heading
. V9.04.03  27/08/2004  J.Tan    CAR 52835 
.           Recompiled for PATCATAI - multi hospital
. V9.04.02  27/08/2004  J.Tan    CAR 52891
.           Recompiled for PATCATAI - printing journals over payments
. V9.04.01  20/08/2004 J.Tan   CAR 52835
.           Recompiled for PATCATAI - Multi hospitals  
. V9.03.26  13/08/2004 J.Tan   CAR 52504
.           Recompiled for OUTINVS - fixed pending cash
. V9.03.25  30/06/2004 J.Tan   CAR 51112
.           Recompiled for OUTINVS - Checking for Unrelease deposit 
. V9.03.24  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.23  01/06/2004 J.Tan  CAR 50273
.           Recompiled for OUTINVS - updating invoice number in rcpdteaf
. V9.03.22  28/05/2004 J.Tan  CAR 50111
.           Fixed to read controlf file for type of invoice layout
. V9.03.21  27/05/2004 J.Tan  CAR 50108
.           Recompiled for OUTINVS  - Deposit date
. V9.03.20  13/05/2004 J.Tan  CAR 49827
.           Recompiled for OUTINVS - Mods to get non-banked deposit
. V9.03.19  28/04/2004 J.Tan  CAR 36504
.           Recompiled for OUTCATBI - displaying cash for outpatient invoice
. V9.03.18  16/04/2004 J.Tan  CAR 47920
.           Mods to check for zero amount of invoice total
. V9.03.17  16/04/2004 J.Tan  CAR 47922
.           Mods to display invoice number after printing invoice
. V9.03.16  06/04/2004 Peter Vela CAR 48227
.           Added VARGBCRN and PATGBCRN - BPAY Reference Number
. V9.03.15  26/03/2004 Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.14  04/02/2004  J.Tan  CAR 46269
.           Mods for cancelling items from the next invoice screen
. V9.03.13  03/02/2004  J.Tan  CAR 45047
.           Recompiled for PATCATAI - Non-banked Cash
. V9.03.12  19/12/2003 J.Tan   CAR 44093
.           Replaced patcashf with comdepaf
. V9.03.11  21/11/2003  J.Tan   CAR  44161
.           Recompiled for PATCATAI - print credit note
. V9.03.10  07/11/2003  Peter Vela CAR 44849
.           Recompiled for PATINVTL
. V9.03.09  03/11/2003  Peter Vela CAR 44757
.           Recompiled for PATINVTL
. V9.03.08  20/10/2003  J.Tan    CAR 44172
.           Recompiled for OUTCATBI - Misc.theatre item file(pmsmitaf)
. V9.03.07  28/10/2003 J.Tan
.           Recompiled for viscmtaf
. V9.03.06  30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
. V9.03.05  15/09/2003 Lina Vo  CAR 40497      
.           Recompiled for OUTCATBI, OUTINVS, PATMCHFD & IO. 
.           Added KEY26A for OUTCATBI & OUTINVS.
. V9.03.04  04/09/2003 Mike Laming  CAR 42713
.           Recompiled for PATINVTL (correct GST twice in final Total)
. V9.03.03  01/08/2003 J.Tan
.           Recompiled for OUTINVS - Change colour for the invoice heading
. V9.03.02  27/06/2003 J.Tan  
.           Mods to check if any invoice to be printed
. V9.03.01  16/06/2003 J.Tan  CAR 39832
.           Mods to check for valid outpatient visit
. V9.02.00  27/03/2003 J.Tan 
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       STDHLPDF
.
          INC       CHKDIGVR/INC
          INC       CHKCLDCD/INC
          INC       IBATMDFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
          INC       AAECONFD/INC
          INC       EMRCONFD/INC
          INC       OUTMA1FD/INC        * Session Master file
          INC       OUTCONFD/INC
          INC       OUTBOAFD/INC        * Bookings file A
          INC       OUTBB1FD/INC        * Bookings file B
          INC       OUTBOCFD/INC        * Bookings file C
          INC       OUTCLIFD/INC
          INC       OUTDTRFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       OUTHEDFD/INC
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDTRFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       COMDEPFD/INC
          INC       VISPAYFD/INC
          INC       VISPAYTD/INC
.
          INC       PMSADJFD/INC
          INC       PMSABFFD/INC
          INC       OUTPWOFD/INC
          INC       PATCFAFD/INC
          INC       PATINPFD/INC
          INC       PMSCIDFD/INC
          INC       PMSTLEFD/INC
          INC       OUTHTRFD/INC
.
          INC       NZPFINFD/INC
          INC       NZPFIGFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRFNFD/INC
          INC       NZPCFNFD/INC
          INC       NZPRDTFD/INC
          INC       NZPSPRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       PATBFEFD/INC
          INC       PATCRAFD/INC
          INC       PATDO1FD/INC   * Doctor File
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATFINFD/INC
          INC       PATFIGFD/INC
          INC       PATDTRFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PATHLFFD/INC
          INC       PATHDFFD/INC
          INC       PATHSPFD/INC
          INC       PATAFEFD/INC
          INC       PATASDFD/INC
          INC       PATCMXFD/INC
          INC       PATIRNFD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATIPRFD/INC
          INC       PATIBLFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATREMFD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC   * Patients Visits File
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSEXTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSMTIFD/INC
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSPRGFD/INC
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       PATEDTFD/INC            * CCPS EDI Summary Table
          INC       PATFX1FD/INC            * Health Fund Extension
          INC       PATTFEFD/INC
          INC       OUTSITFD/INC
          INC       OUTECTFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATPR1FD/INC
          INC       PMSPX2FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRBLFD/INC
          INC       PATRE1FD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATDGWFD/INC
          INC       PATITMFD/INC
          INC       PATICDFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATWVEFD/INC
          INC       PATWMAFD/INC
          INC       PATWC1FD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PMSCNOFD/INC
          INC       PMSFCIFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       RCPBNKFD/INC
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC
          INC       RCPCRSFD/INC
          INC       MLTCFNFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       VARGBCRN/INC          * I-48227
          INC       WEBDINVS/INC
          INC       TFILEVAR/INC
          INC       VISMDTFD/INC
          INC       PATMISTD/INC   
          INC       OUTSESFD/INC   
          INC       WEBBBSFD/INC
          INC       WEBDVWFD/INC
          INC       WEBB2BFD/INC
.
          INC       RSHWEBDF
.
.----------------------------------------------------------------------
GSTCODE    DIM       6
GSTAPP     FORM      1
.-----------------------------------------------------------------------
.
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
SBWINDOW  FORM      1
.
CALDAYS   FORM      4
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODECL    INIT      "CL"
CURRDATE  DIM       8       * Current Date
CURSESS   DIM       16
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
CATECODE  DIM       3
CMDLINE   DIM       50
BULKBILL  DIM       1  
.
DAYFORMT  DIM       4
DIM1A     DIM       1
DIM2A     DIM       2
DIM3      DIM       3
DIM4      DIM       4
DIM12A    DIM       12
DIM14     DIM       14
DIM18     DIM       18
DIM18A    DIM       18
DIM30     DIM       30
DIM30A    DIM       30
DOCTCODE  DIM       8
DOCTNAM   DIM       36
DOCLINE1  DIM       62
DOCLINE2  DIM       62
.
MSCHG014  DIM       1
MSCHG015  DIM       1
MSCHG016  DIM       50
MSCHG017  DIM       6
MSCHG018  DIM       1
MSCHG019  DIM       2
MSCHG020  DIM       3
MSCHG021  DIM       3
MSCHG022  DIM       3
.
FGSTFLAG  FORM      1
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FORM5     FORM      5
FORM52    FORM      5.2
FORM42    FORM      4.2
FORM8     FORM      8 
FORM122   FORM      12.2
.
HJNL      DIM       2
HDUDAY1   FORM      3                       * High Dependency
HDUDAY2   FORM      3
HDUFLG    FORM      "0"
.
INVOICNO  DIM       8
INVIACTV  DIM       1
ITEMCD    FORM      1
JOURFLAG  FORM      1
JOURTOT   FORM      6.2
KEY12A    DIM       12
KEY21A    DIM       21
KEY26A    DIM       26
KEY29A    DIM       29
KEYFLAG   FORM      1
LNO       FORM      2
LWCHG     FORM      6.2        * LABOUR WARD FEE
LWCODE    INIT      "LW"
LWDT      DIM       8
.
MPGEFLAG  FORM      1
MULTAMT   FORM      8.2
MAMLFLAG  FORM      1
MBSDESC   DIM       70
MBSLOP    FORM      2
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MBSNUM    FORM      "0"
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCODE    INIT      "OT"
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8          * OTHER ITEMS
OTDT2     DIM       8
OTFLG     FORM      "0"
.
PSAGETYP  DIM       3
PSAGECON  DIM       3
.
RACLUEBB  DIM       1
RACLUDVA  DIM       1
RCCNSTRF  DIM       1        * Display Statement Reference
REGIST8   DIM       2
.
SAVKEY12  DIM       12
SELFLG    FORM      "0"
SERVDOCT  DIM       10
SP12      INIT      "            "
SP14      INIT      "              "
SAVECOL   FORM      2
SAVDISC   FORM      6.2
SAVALLW   FORM      6.2
SAVVERT   FORM      2
SAVHTOP   FORM      2
SMCHARGE  DIM       9
SMMSCGRP  DIM       3
SURGFLG   FORM      "0"
SNETTOT   FORM      8.2
.
TFFSAMNT  FORM      12.2
TRANSNUM  DIM       6
TABLNA    DIM       25
THEACHG   FORM      6.2                     * Theatre Fee
THDUDT1   DIM       8
THDUDT2   DIM       8
THEADTE   DIM       8
THCFLG    FORM      2
TEMPAMT   FORM      6.2
WDATE1    DIM       8
WDATE2    DIM       8
.
ZERO4     INIT      "0000"                  * needed by CMGETTHR
ZERO8     INIT      "0000    "              * needed by PATINVS
XAMT      FORM      4.2
XMBS      FORM      5
XDESC     DIM       30
XXADM     DIM       8
XXDATE    DIM       8
XXMULT    FORM      2
XXNAM     DIM       22
.
.----------------------------------------------------------------------
PRGID     INIT      "OUTWEB07"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Outpatient Invoice Web Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MAIN1000
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      OUTPAT00            * outpatients
          GOTO      MAIN1000
.
MAIN1200  CALL      PRTINV00
          BRANCH    EXIT,MAIN1000
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Complete. Invoice Number:",WEBTITLE
          APPEND    CNEXTINV,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      PMSMTI00                * Miscellaneous charge items Maint
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00                * next page
          MOVE      ONE,EXIT
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                              " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      IHAPASS1,"ihapassf"
          OPEN      IBAPRTA1,"ibaprtaf"
          OPEN      IBACODE1,"ibacodef"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBASPOL1,"ibaspolf"
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      OUTSITA2,"outsitaf"      * Open pre-attendance file
          OPEN      OUTECTA1,"outectaf"
          OPEN      OUTECTA2,"outectaf"
          OPEN      PATFINS1,"patfinsf"
          OPEN      PATFIGA1,"patfigaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      COMDEPA1,"comdepaf"
          OPEN      PATDRGA2,"patdrgaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      PATINPA1,"patinpaf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,TEN;*66,CINVLAY,*79,CAPPRVNO:
                                 *94,CAGECOFF,*96,CNEXTINV:
                                *166,CMEMB,*183,CVIEWIP
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2,CHPPOST:
                                  CHTELEB,*211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM,*198,PTCNPIOP
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*60,PTCNCCRR,PTCNCLOR:
                                    *136,PTCNMITM,*138,PTCNNHII,*174,PTCNDONR:
                                    *178,PTCNMPTR,*190,PTCNPCON:
                                    *200,PTCNICRA,*235,PTCNDPL8,*237,PTCNPAOF
          READ      CONTROLF,THIRTY;*132,HSTANDM,HINVDES
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,OTCNCFEE,*203,OTCNPZIN:
                                     *219,OTCNIVUR
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,FIFTY9;*66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*247,PTCNCDIS
          READ      CONTROLF,HUND27;*122,PTCNUEBB,*123,PTCNEDBO
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*89,PTCNPPIN:
                                    *193,PTCNBBSW,*249,PTCNDVAW
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
+
.*******************************************************************************
.                     Check Correct Files are Open for System
.*******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
OUTFIL99  RETURN
+
.*******************************************************************************
.                    Open Outpateint Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKC1  * Get the name of the BOKC1 file
          CLOSE     OUTBOKC1
          OPEN      OUTBOKC1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          CLOSE     OUTDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
          PACK      CFNAME,CFILEPRE,FILMA1A2
          CLOSE     OUTMA1A2
          CALL      OPOTMA12                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Set up physical filename
          CLOSE     OUTBB1A1
          CALL      OPOTBB11
          PACK      CFNAME,CFILEPRE,FILBB1A2  * Set up physical filename
          CLOSE     OUTBB1A2
          CALL      OPOTBB12
.
          PACK      CFNAME,CFILEPRE,FILBOKA6
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          RETURN
+
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,TRANSNUM
          MOVE      SP70,SELPRINT
          MOVE      SP70,NOCOPIES
          MOVE      SP70,SBWINDOW
          MOVE      SP70,EXPPAYER
.
          MOVE      Z70,MSCHG014
          MOVE      Z70,MSCHG015
          MOVE      Z70,MSCHG016
          MOVE      Z70,MSCHG017
          MOVE      Z70,MSCHG018
          MOVE      Z70,MSCHG019
          MOVE      Z70,MSCHG020
          MOVE      Z70,MSCHG021
          MOVE      Z70,MSCHG022
.
          MOVE      SP70,RACLUEBB
          MOVE      ZERO,PRABFINV
          MOVE      SP70,INVOICNO
          MOVE      ZERO,IPATFLAG
          MOVE      ZERO,NWAUFLAG
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "exppayer=",QRYNAME
          IF        @EQUAL
            PACK      EXPPAYER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mschg",QRYNAME     
          IF        @EQUAL
            CALL      MISCH000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "racluebb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLUEBB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prabfinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRABFINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVOICNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
.     Miscellaneou charge items
.------------------------------------------------------------
MISCH000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          SUBTRACT  TEN3,F3
          BRANCH    F3,MISCH140,MISCH150:
                       MISCH160,MISCH170,MISCH180,MISCH190,MISCH200:
                       MISCH210,MISCH220
          GOTO      MISCH9999
.
MISCH140  MOVE      QRYDATA,MSCHG014
          GOTO      MISCH9999
.
MISCH150  MOVE      QRYDATA,MSCHG015
          GOTO      MISCH9999
.
MISCH160  MOVE      QRYDATA,MSCHG016
          GOTO      MISCH9999
.
MISCH170  MOVE      QRYDATA,MSCHG017
          GOTO      MISCH9999
.
MISCH180  MOVE      QRYDATA,MSCHG018
          GOTO      MISCH9999
.
MISCH190  MOVE      QRYDATA,MSCHG019
          GOTO      MISCH9999
.
MISCH200  MOVE      QRYDATA,MSCHG020
          GOTO      MISCH9999
.
MISCH210  MOVE      QRYDATA,MSCHG021
          GOTO      MISCH9999
.
MISCH220  MOVE      QRYDATA,MSCHG022
          GOTO      MISCH9999
.
MISCH999  RETURN
.
.------------------------------------------------------------
. Output Outpatient Enquiry Page
.------------------------------------------------------------
OUTPAT00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
.
          CALL      CLPATMAS
          CALL      CLPMSPX2
.
          PACK      KEY8,URNUMBER
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
.
          IF        MASTFLAG=1
            MOVE      "Can't find Patient Master details",WEBTITLE
            CALL      WEBERR00
            GOTO      OUTPAT99
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,OUTPAT92
          CALL      RDPMVX11
          BRANCH    OVRCD,OUTPAT92
.
          MOVE      PVISITE,OBASITE          * Site code
          MOVE      PVIURNO,OBAURNO          * U/R number
.
          MOVE      PVISITE,KEY6             * For this site ...
          CALL      RDSITA1                  * Get file prefix
          BRANCH    OVRCD,OUTPAT92
.
          PACK      CFNAME,OSTFILE,FILBB1A2  * Set up physical filename
          CALL      OPOTBB12
.
          PACK      KEY16,PVIDATE,PVIBILL    * Key is date & outpatient no.
          CALL      RDBOKB2                  * Read record
          BRANCH    OVRCD,OUTPAT92
.
          CALL      BULKBL00 
          CALL      DVAWBL00
.
          PACK      CFNAME,OSTFILE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          CALL      ITMN0000      * Get number of items
          MOVE      TWO,PROGFLAG
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      OBACOMP,INDMCLAM
          MOVE      "O",INDMSYST
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
.
          MOVE      URNUMBER,INDMURNO
          MOVE      ADMISSNO,INDMADNO
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
OUTPAT05  CALL      PATNAA00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
.
          BRANCH    EXIT,OUTPAT99
.
          CALL      WEBBOD00   * Output Templated Body of HTML
.
OUTPAT90  CALL      WEBEND00   * Output End of Web Page
          GOTO      OUTPAT99
.
OUTPAT92  MOVE      "Invalid Outpatient Visit record",WEBTITLE
          CALL      WEBERR00
          GOTO      OUTPAT99
.
OUTPAT99  RETURN
.
.------------------------------------------------------------
. Set bulk billing indicator
.------------------------------------------------------------
BULKBL00  MOVE      SP1,BULKBILL
          MATCH     "1",PTCNUEBB
          GOTO      BULKBL99 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,BULKBL99
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      BULKBL99 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      BULKBL99 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,BULKBL99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,BULKBL99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,BULKBL99
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      BULKBL99 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      BULKBL99 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      BULKBL99 IF NOT EQUAL
.
          MOVE      "1",BULKBILL
.
BULKBL99  RETURN
.
.------------------------------------------------------------
. Get number of items charged - Only for John Hopkins/SX
.------------------------------------------------------------
ITMN0000  MOVE      ZERO,TOTCHRG
          COMPARE   FIVE,CFEETYP
          GOTO      ITMN1000 IF EQUAL        * SX
          COMPARE   NINE,CFEETYP
          GOTO      ITMN9999 IF NOT EQUAL
.
ITMN1000  PACK      KEY15,ADMISSNO,TWO,SP70
          CALL      RSPMMTI2
ITMN3000  CALL      RKPMMTI2
          BRANCH    OVRCD,ITMN8000
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      ITMN8000 IF NOT EQUAL    * Not same admission
.
          UNPACK    PMMIRTYP,KEY1
          REP       "2X3X",KEY1
          MATCH     "X",KEY1
          GOTO      ITMN3000 IF NOT EQUAL
.
          ADD       ONE,TOTCHRG              * increase number of items
          GOTO      ITMN3000
.
.         Get details of Expected payer
.
ITMN8000  MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          IF        OVRCD=1
            PACK      PKNAME,SP70,SP10
            UNPACK    SP70,PKADD1
            UNPACK    SP70,PKADD2,PKSUBR
            UNPACK    SP70,PKADD4,PKPOST
          ENDIF
.
          MATCH     SP70,EXPPAYER
          IF        @EQUAL
            CALL      GPAY0000            * Get default payer
            MOVE      VSPAPAYC,EXPPAYER
          ENDIF
.
          MATCH     "PRFA",EXPPAYER
          GOTO      ITMN9999 IF EQUAL
.
          PACK      KEY14,EXPPAYER,ZERO8,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            PACK      PKNAME,HFNAME,SP70
            PACK      PKADD1,HFADD1,SP70
            PACK      PKADD2,HFADD2,SP70
            PACK      PKSUBR,HFADD3,SP70
            PACK      PKADD4,HFADD4,SP70
            PACK      PKPOST,HFPCODE,SP70
          ENDIF
.
ITMN9999  RETURN
+
.------------------------------------------------------------
. Print Invoice
.------------------------------------------------------------
PRTINV00  MOVE      ZERO,EXIT 
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRTINV81
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,PRTINV81
.
          PACK      CFNAME,CFILEPRE,FILBB1A2
          MOVE      PVISITE,KEY6             * For this site ...
          CALL      RDSITA1                  * Get file prefix
.
          PACK      CFNAME,OSTFILE,FILBB1A2  * Set up physical filename
          CALL      OPOTBB12
          PACK      KEY16,PVIDATE,PVIBILL    * Key is date & outpatient no.
          CALL      RDBOKB2                  * Read record
          BRANCH    OVRCD,PRTINV81
.
          MOVE      PVISITE,OBASITE
          MOVE      PVIBILL,OBAOUTNO
          MOVE      PVIURNO,OBAURNO
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8           * Zero fill the current date
          PACK      KEY14,KEY8,SP70     * Position to this date
          CALL      RDSDRGA2            * Go to this date in the file
          CALL      RDKDRGA2            * Get the first record on or after date
          BRANCH    OVRCD,PRTINV82      * No records in file.
.
          MATCH     DRGFDTE,KEY8        * Is the date before the from date ?
          GOTO      PRTINV82 IF LESS    * Yes. Date not found in file.
.
          MATCH     "031",TEMPLATE
          GOTO      PRTINV62 IF EQUAL
          MATCH     "032",TEMPLATE
          GOTO      PRTINV64 IF NOT EQUAL
.
PRTINV62  MOVE      ONE,JHFLAG          * John Hopkins invoice
.
PRTINV64  MOVE      ONE,WEBFLAG
          MOVE      ONE,PROGFLAG
.
          MOVE      ZERO,IPATFLAG
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            MATCH     "003",TEMPLATE
            IF        @EQUAL
              MOVE      TWO,IPATFLAG          * Patient Inv.New Functionality
            ENDIF
          ENDIF
.
          IF        PRABFINV=0
            CALL      GABF0000                * Check for ABF Calculate itm only
          ENDIF
.
          CALL      OUTTBI 
          COMPARE   ZERO,GROSSTOT
          GOTO      PRTINV80 IF EQUAL           * no outstanding amount
.
          CALL      OPNPRINT
          MOVE      THREE,PROGFLAG
          CALL      PRNTINV0
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      BBSW0000
          ELSE
            CALL      EDBS0000
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      DVAW0000
          ENDIF
.
          CALL      CLSPRINT
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      DB4W0000       * DB4 Form BBSW
          ELSE
            CALL      DB4F0000       * DB4 Form DBS
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      D1217000                * D1217 Form DVAW
            CALL      D1216S00                * D1216S Form DVAW
          ENDIF
.
.
          MATCH     SP70,EXPPAYER
          IF        !@EQUAL
            PACK      KEY14,ADMISSNO,EXPPAYER,SP70
            CALL      RDVSPAY1
            IF        OVRCD=0
              MOVE      ONE,VSPAISEN          * Set to Yes for sending invoice
              CALL      UPVSPAY1
            ENDIF
          ENDIF
.
.         Update Reassign debt for Patient invoice
.
          IF        IPATFLAG=2
            PROC      PATRDEBT         * Update Reassign debt
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PRTINV99
.
PRTINV80  MOVE      "No Invoice details to be printed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV81  MOVE      "Missing Master/Visit/Booking Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV82  UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    "Date: ",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    "- not found in Period Range file.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV99  RETURN
+
.------------------------------------------------------------------------------
.         Check for ABF raise invoice
.------------------------------------------------------------------------------
GABF0000  MATCH     "1",PTCNUABF
          GOTO      GABF9999 IF NOT EQUAL      * Not Using ABF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,GABF9999
.
          MATCH     "A",TCINDC2              * ABF Funding ?
          GOTO      GABF9999 IF NOT EQUAL
.
          PACK      KEY5,ANSN,ANSC,OTBBTCOD
          CALL      RDCODE1
          BRANCH    OVRCD,GABF9999
.
          MATCH     "A",TCINDC1
          GOTO      GABF9999 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,GABF9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      GABF9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      GABF9999 IF NOT EQUAL
.
          COMPARE   FOUR,OBASTAT
          GOTO      GABF9999 IF NOT EQUAL
.
          MOVE      TWO,PRABFINV         * Calculate Item charges only
.
GABF9999  RETURN
+
.------------------------------------------------------------------------------
.         Generating DB4 Form
.------------------------------------------------------------------------------
DB4F0000  MATCH     "1",PTCNUEBB
          GOTO      DB4F9999 IF NOT EQUAL     * Not using Eclipse Bulk billing
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,DB4F9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      DB4F9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      DB4F9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,DB4F9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,DB4F9999
.
          MATCH     SP70,OBACOMP
          GOTO      DB4F9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4F9999            * Invalid code
.
          MATCH     "P",TCINDC1
          GOTO      DB4F9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4F9999            * Invalid code
          MATCH     "P",TCINDC1
          GOTO      BULKBL99 IF NOT EQUAL
.
          MOVE      "IBAADT16",SCHDPGID
          MOVE      "Generating DB4 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
DB4F9999  RETURN
+
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      INVD0000
          GOTO      PROFLD99
.
PROFLD13  CALL      MISC0000     * miscellaneous data
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      INVD0000         * Patient Invoices
          GOTO      PROFLD99
.
PROFLD33  CALL      MCHG0000         * Misc.Item pending
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.----------------------------------------------------------------
. Get miscellaneous data
.----------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      MISC9999
.
MISC0100  MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1;
          GOTO      MISC9999
.
MISC0200  MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1;
          GOTO      MISC9999
.
MISC0300  CALL      ECLDBS00
          GOTO      MISC9999
.
MISC0400  CALL      QABF0000            * Check for ABF funding
          GOTO      MISC9999
.
MISC0500  MOVE      ZERO,NWAUFLAG
          MOVE      SP70,KEY3
          UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY3,KEY3,SP70
          MATCH     "001",KEY3
          IF        @EQUAL
            MOVE      ONE,NWAUFLAG          * NWAU Calculations
          ENDIF
          CALL      ABFOTDET
          MOVE      ZERO,NWAUFLAG
          GOTO      MISC9999
.
MISC0600  WRITE     HTMLFILE;INVIACTV;       * Patient invoice inactive flag
          GOTO      MISC9999
.
MISC0700  CALL      ECLDVA00
          GOTO      MISC9999
.
MISC9999  RETURN
+
.------------------------------------------------------------
.   Verify Patient Invoice
.------------------------------------------------------------
INVD0000  BRANCH    FLDITMNO,INVD0100,INVD0200,INVD0300,INVD0400,INVD0500:
                             INVD0600,INVD0700,INVD0800,INVD0900,INVD1000:
                             INVD1100,INVD1200,INVD1300,INVD1400,INVD1500:
                             INVD1600,INVD1700,INVD1800,INVD1900,INVD2000:
                             INVD2100
          GOTO      INVD9999
.
INVD0100  CALL      SELPRT00                * Select Printer
          GOTO      INVD9999
.
INVD0200  CALL      OUTD0000                * Display Outpatient Invoice
          GOTO      INVD9999
.
INVD0300  WRITE     HTMLFILE;TRANSNUM;
          GOTO      INVD9999
.
INVD0400  MOVE      ZERO,PRABFINV
          CALL      ZERINV00                * Check for zero invoice amount
          WRITE     HTMLFILE;FORM1;
          GOTO      INVD9999
.
INVD0500  COMPARE   ONE,IBCNMHOS
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXMHOS,KEY3
            OPEN      PATHSPA1,"pathspaf"
            CALL      RDPTHSP1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTHSNAME;
            ENDIF
          ENDIF
          GOTO      INVD9999
.
INVD0600  MOVE      ONE,JHFLAG
          CALL      OUTD0000           * Display JH Outpatient Invoice
          MOVE      ZERO,JHFLAG
          GOTO      INVD9999
.
INVD0700  MATCH     SP70,EXPPAYER
          IF        @EQUAL
            CALL      DPAY0000         * Use default expected payer
          ELSE
            CALL      EPAY0000         * Expected payers/Funders List
          ENDIF
          GOTO      INVD9999
.
INVD0800  WRITE     HTMLFILE;TOTCHRG;
          GOTO      INVD9999
.
INVD0900  CALL      GPAY0000         * Get the default next expected payer
          WRITE     HTMLFILE;VSPAPAYC;
          GOTO      INVD9999
.
INVD1000  WRITE     HTMLFILE;PKADD1;
          GOTO      INVD9999
.
INVD1100  WRITE     HTMLFILE;PKADD2;
          GOTO      INVD9999
.
INVD1200  WRITE     HTMLFILE;PKSUBR;
          GOTO      INVD9999
.
INVD1300  WRITE     HTMLFILE;PKADD4;
          GOTO      INVD9999
.
INVD1400  WRITE     HTMLFILE;PKPOST;
          GOTO      INVD9999
.
INVD1500  WRITE     HTMLFILE;EXPPAYER;
          GOTO      INVD9999
.
INVD1600  MOVE      ONE,PROGFLAG
          CALL      OUTTBI 
          CALL      GCSH0000
          SUB       FORM12P2,GROSSTOT
          WRITE     HTMLFILE;GROSSTOT;
          GOTO      INVD9999
.
INVD1700  CALL      NXBC0000                * Next Invoice billing comment
          GOTO      INVD9999
.
INVD1800  WRITE     HTMLFILE;PRABFINV;
          GOTO      INVD9999

INVD1900  MOVE      ONE,PRABFINV
          CALL      ZERINV00                * Check for zero invoice amount
          WRITE     HTMLFILE;FORM1;
          GOTO      INVD9999
.
INVD2000  MOVE      SP70,D8
          PACK      D8,INVOICNO,SP70
          MATCH     SP70,D8
          GOTO      INVD2020 IF NOT EQUAL
.
          CALL      ABIV0000                * Get ABF Invoice number
          MOVE      ZERO,F8
          MOVE      D8,F8
          COMPARE   ZERO,F8
          GOTO      INVD9999 IF EQUAL       * No ABF Invoice raised
.
INVD2020  MOVE      ", Invoice : ",KEY12
          PACK      KEY20,KEY12,D8,SP70
          WRITE     HTMLFILE;KEY20;
          GOTO      INVD9999
.
INVD2100  MATCH     "1",PTCNPPIN
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      TWO,IPATFLAG
          CALL      OUTD0000                * Display Outpatient Invoice
          GOTO      INVD9999
.
INVD9999  RETURN
.
.------------------------------------------------------------
. Display Misc.item fields
.------------------------------------------------------------
MCHG0000  BRANCH    FLDITMNO,MCHG0100,MCHG0200,MCHG0300,MCHG0400,MCHG0500:
                             MCHG0600,MCHG0700,MCHG0800,MCHG0900,MCHG1000:
                             MCHG1100,MCHG1200,MCHG1300,MCHG1400,MCHG1500:
                             MCHG1600,MCHG1700,MCHG1800,MCHG1900,MCHG2000:
                             MCHG2100,MCHG2200
          GOTO      MCHG9999
.
MCHG0100  MATCH     PMMITDAT,SP70
          GOTO      MCHG9999 IF EQUAL
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      MCHG9999
.
MCHG0200  WRITE     HTMLFILE;PMMIITEM;
          GOTO      MCHG9999
.
MCHG0300  WRITE     HTMLFILE;PMMIDESC;
          GOTO      MCHG9999
.
MCHG0400  IF        PMMISERV < 1
            MOVE      ONE,PMMISERV
          ENDIF
          WRITE     HTMLFILE;PMMISERV;
          GOTO      MCHG9999
.
MCHG0500  WRITE     HTMLFILE;PMMIREFN;
          GOTO      MCHG9999
.
MCHG0600  WRITE     HTMLFILE;PMMIAMTP;           * patient portion
          GOTO      MCHG9999
.
MCHG0700  IF        PMMIRBAT=0 & PMMIAMTG<>0
            WRITE     HTMLFILE;PMMIAMTG;         * keyin amount
          ELSE
            WRITE     HTMLFILE;PMMIRBAT;         * rebate portion
          ENDIF
          GOTO      MCHG9999
.
MCHG0800  MOVE      PMMIAMTP,FORM122             * Patient Misc.amount per unit
          IF        PMMISERV > 1
            MOVE      PMMIAMTP,FORM122
            MULT      PMMISERV,FORM122
          ENDIF
          WRITE     HTMLFILE;FORM122;
          GOTO      MCHG9999
.
MCHG0900  MOVE      PMMIRBAT,FORM122             * Funder Misc.amount per unit
.
          IF        PMMIRBAT=0 & PMMIAMTG<>0
            MOVE      PMMIAMTG,FORM122           * Keyin item amount
          ENDIF
.
          IF        PMMISERV > 1
            MULT      PMMISERV,FORM122
          ENDIF
          WRITE     HTMLFILE;FORM122;
          GOTO      MCHG9999
.
MCHG1000  WRITE     HTMLFILE;PMMIRTYP;
          GOTO      MCHG9999
.
MCHG1100  MULT      "-1",PMMIAMTP
          WRITE     HTMLFILE;PMMIAMTP;           * Discount
          GOTO      MCHG9999
.
MCHG1200  WRITE     HTMLFILE;PMMIINCT;           * Community billing item
          GOTO      MCHG9999
.
MCHG1300  WRITE     HTMLFILE;PMMIACOI;
          GOTO      MCHG9999
.
MCHG1400  WRITE     HTMLFILE;PMMIDSOV;
          GOTO      MCHG9999
.
MCHG1500  WRITE     HTMLFILE;PMMISTXT;
          GOTO      MCHG9999
.
MCHG1600  WRITE     HTMLFILE;PMMILSPN;
          GOTO      MCHG9999
.
MCHG1700  WRITE     HTMLFILE;PMMIMPOV;
          GOTO      MCHG9999
.
MCHG1800  WRITE     HTMLFILE;PMMINMPT;
          GOTO      MCHG9999
.
MCHG1900  MOVE      "Sd",CATEGORY
          MOVE      PMMISDCD,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG2000  WRITE     HTMLFILE;PMMITDUR;
          GOTO      MCHG9999
.
MCHG2100  MOVE      "Ro",CATEGORY
          MOVE      PMMIROVR,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG2200  WRITE     HTMLFILE;PMMITRAN;
          GOTO      MCHG9999
.
MCHG9999  RETURN
+
.------------------------------------------------------------
.         Check for ABF funding
.------------------------------------------------------------
QABF0000  MOVE      ZERO,F1
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      RDCODE1
          BRANCH    OVRCD,QABF9000
.
          MATCH     "A",TCINDC2          * ABF Funding ?
          GOTO      QABF9000 IF NOT EQUAL
.
          MATCH     SP70,OTBBTCOD
          GOTO      QABF9000 IF EQUAL         * Blank Tier 2
.
          PACK      KEY5,ANSN,ANSC,OTBBTCOD
          CALL      RDCODE1
          BRANCH    OVRCD,QABF9000
.
          MATCH     "A",TCINDC1
          GOTO      QABF9000 IF NOT EQUAL
.
          MOVE      ONE,F1
.
QABF9000  WRITE     HTMLFILE;F1;
.
QABF9999  RETURN
+
.------------------------------------------------------------
.         Check Next invoice billing comments
.------------------------------------------------------------
NXBC0000  MOVE      ZERO,F1
          MOVE      "003",KEY3
          PACK      KEY17,ADMISSNO,KEY3,Z70
          CALL      RSVSMDT1
NXBC1000  CALL      RPVSMDT1
          BRANCH    OVRCD,NXBC9000
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      NXBC1000 IF EQUAL        * Deleted
.
          MOVE      ONE,F1
.
NXBC9000  WRITE     HTMLFILE;F1;
NXBC9999  RETURN
+
.------------------------------------------------------------
.         Get default next expected payer
.------------------------------------------------------------
GPAY0000  PACK      KEY10,ADMISSNO,SP70
          CALL      RSVSPAY2
GPAY1000  CALL      RKVSPAY2
          BRANCH    OVRCD,GPAY8000
          MATCH     ADMISSNO,VSPAVISN        * Same visit no?
          GOTO      GPAY8000 IF NOT EQUAL
.
          BRANCH    VSPAISEN,GPAY1000       * Already sent
          GOTO      GPAY9999
.
GPAY8000  MOVE      "PRFA",VSPAPAYC
GPAY9999  RETURN
+
.------------------------------------------------------------
. Display OUT Invoice Details
.------------------------------------------------------------
OUTD0000  MOVE      OBAOUTNO,KEY8
.         MOVE      ONE,PROGFLAG
.         CALL      OUTTBI 
.
          MOVE      ZERO,INVTYPE            * Standard invoice
          IF        CFEETYP=9
            MOVE      ONE,INVTYPE           * Default to summary
          ENDIF
.
          IF        JHFLAG=1
            MATCH     "031",TEMPLATE
            IF        @EQUAL
              MOVE      ONE,INVTYPE         * John Hopkins Summary invoice
            ELSE
              MOVE      TWO,INVTYPE         * John Hopkins Detailed invoice
            ENDIF
          ENDIF
.
          MOVE      TWO,PROGFLAG
          MOVE      ONE,INVPRTD
          MOVE      ZERO,PAGENO
          CALL      INVPRT                          *Display the invoice
          MOVE      ZERO,EXIT
.
OUTD9999  RETURN
.
.------------------------------------------------------------
. Check for zero invoice amount
.------------------------------------------------------------
ZERINV00  MOVE      ZERO,FORM1
          MOVE      ONE,WEBFLAG
          MOVE      OBAOUTNO,KEY8
.
          MATCH     "1",PTCNUABF
          GOTO      ZERINV20 IF NOT EQUAL      * Not Using ABF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,ZERINV20
.
          MATCH     "A",TCINDC2              * ABF Funding ?
          GOTO      ZERINV20 IF NOT EQUAL
.
          PACK      KEY5,ANSN,ANSC,OTBBTCOD
          CALL      RDCODE1
          BRANCH    OVRCD,ZERINV20
.
          MATCH     "A",TCINDC1
          GOTO      ZERINV20 IF NOT EQUAL
.
          IF        OBASTAT=4 & PRABFINV=0
            MOVE      TWO,PRABFINV         * Calculate Item charges only
          ENDIF
.
ZERINV20  MOVE      ONE,PROGFLAG
          CALL      OUTTBI 
          COMPARE   ZERO,GROSSTOT             * check for zero invoice amount
          GOTO      ZERINV92 IF NOT EQUAL
.
          BRANCH    PRABFINV,ZERINV90         * ABF Invoice only
.
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      ZERO,EXIT
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,ZERINV90
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      ZERINV92 IF EQUAL         * Found items to be invoiced
.
ZERINV90  MOVE      ONE,FORM1                 * Print option disabled
          MOVE      ZERO,PRABFINV
          GOTO      ZERINV99
.
ZERINV92  MOVE      ZERO,FORM1                * Print option available
          MOVE      ZERO,PRABFINV
.
ZERINV99  RETURN
+
.------------------------------------------------------------
. Get ABF Invoice number
.------------------------------------------------------------
ABIV0000  MOVE      ZERO,D8
          OPEN      PATINVR3,"patinvrf"
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RDSINV3
ABIV1000  CALL      RDKINV3
          BRANCH    OVRCD,ABIV9999
.
          MATCH     PINVADM,OBAOUTNO
          GOTO      ABIV9999 IF NOT EQUAL
.
          COMPARE   THREE,PTINCMIX           * ABF Invoice ?
          GOTO      ABIV1000 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABIV1000 IF NOT EQUAL    * Credit notes
.
          MOVE      PINVNO,D8
.
ABIV9999  RETURN
+
.*******************************************************************************
.         Get the default charging claim code for multi hospital
.*******************************************************************************
DCLM0000  IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
DCLM9999  RETURN
+
.***************************************************************************
.         Subroutine to get the total cash amount currently entered
.***************************************************************************
GCSH0000  OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          MOVE      ZERO,FORM12P2
.
          MOVE      OBAOUTNO,AADMNO
          MOVE      AADMNO,DAADMNO
          MOVE      "0",CMDESTAT
          PACK      KEY26,AADMNO,CMDESTAT,SP70
          CALL      RSCMDEP2
GCSH1000  CALL      RKCMDEP2
          BRANCH    OVRCD,GCSH5000
.
          MATCH     DAADMNO,CMDEADMN
          GOTO      GCSH5000 IF NOT EQUAL
          MATCH     "0",CMDESTAT
          GOTO      GCSH5000 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,GCSH1000
.
          ADD       RCDTAMNT,FORM12P2
          GOTO      GCSH1000
.
.         Check for any non-banked deposits
.
GCSH5000  PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
GCSH7000  CALL      RKRCDTE6
          BRANCH    OVRCD,GCSH9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      GCSH9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      GCSH7000 IF NOT EQUAL
          MATCH     SP70,RCDTRELD
          GOTO      GCSH7000 IF NOT EQUAL   * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,GCSH7000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      GCSH7000 IF EQUAL
.
          ADD       RCDTAMNT,FORM12P2
          GOTO      GCSH7000
.
GCSH9999  RETURN
.
.------------------------------------------------------------
. Miscellaneous charge items Maintenance
.------------------------------------------------------------
PMSMTI00  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      PMSMTI40 IF EQUAL
.
          MATCH     "U",UPDTTYPE           * Update Formaction
          GOTO      PMSMTI20 IF EQUAL
.
          GOTO      PMSMTI93
.
.         ************ UPDATE FORMACTION **********
.
PMSMTI20  CALL      UPVMTI00                
          BRANCH    EXIT,PMSMTI99
.
          MOVE      ZERO,EXIT
          GOTO      PMSMTI99
.
.         ************ DISPLAY FORMACTION **********
.
PMSMTI40  MATCH     SP70,ADMISSNO
          GOTO      PMSMTI90 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          IF        OVRCD = 1
            CALL      CLPMSMTI        * Clear all the file variables
          ENDIF
.
          MOVE      "Miscellaneous charge items Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMSMTI99
PMSMTI50  CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PMSMTI99
.
PMSMTI90  MOVE      "Visit Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSMTI99
.
PMSMTI93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSMTI99
.
PMSMTI99  RETURN
.
.------------------------------------------------------------
. Updating Miscellaneou charge items Details
.------------------------------------------------------------
UPVMTI00  PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,UPVMTI98
.
          CALL      MOVMTI00        
.
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          BRANCH    OVRCD,UPVMTI98
.
          MOVE      ZERO,EXIT
          GOTO      UPVMTI99
.
UPVMTI98  MOVE      ONE,EXIT
UPVMTI99  RETURN
.
.------------------------------------------------------------
. Move Miscellaneou charge items
.------------------------------------------------------------
MOVMTI00  MATCH     Z70,MSCHG014
          IF        !@EQUAL
            MOVE      MSCHG014,PMMIACOI      * After care override indicator
          ENDIF
.
          MATCH     Z70,MSCHG015
          IF        !@EQUAL
            MOVE      MSCHG015,PMMIDSOV      * Duplicate Service Override
          ENDIF
.
          MATCH     Z70,MSCHG016
          IF        !@EQUAL
            PACK      PMMISTXT,MSCHG016,SP70  * Service Text
          ENDIF
.
          MATCH     Z70,MSCHG017
          IF        !@EQUAL
            PACK      PMMILSPN,MSCHG017,SP70  * LSPN
          ENDIF
.
          MATCH     Z70,MSCHG018
          IF        !@EQUAL
            MOVE      MSCHG018,PMMIMPOV      * Multi Procedure Override
          ENDIF
.
          MATCH     Z70,MSCHG019
          IF        !@EQUAL
            PACK      PMMINMPT,MSCHG019,SP70  * Number of Patients
          ENDIF
.
          MATCH     Z70,MSCHG020
          IF        !@EQUAL
            PACK      PMMISDCD,MSCHG020,SP70  * Self Deem Code (Cat Sd)
          ENDIF
.
          MATCH     Z70,MSCHG021
          IF        !@EQUAL
            PACK      PMMITDUR,MSCHG021,SP70  * Time Duration
          ENDIF
.
          MATCH     Z70,MSCHG022
          IF        !@EQUAL
            PACK      PMMIROVR,MSCHG022,SP70  * Restrictive Override code
          ENDIF
.
MOVMTI99  RETURN
+
.------------------------------------------------------------
. Eclipse DBS Bulk Billing Raise / Raise and Claim
.------------------------------------------------------------
EDBS0000  MATCH     "1",PTCNUEBB
          GOTO      EDBS9999 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,EDBS9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      EDBS9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      EDBS9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,EDBS9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,EDBS9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,EDBS9999
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      EDBS9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      EDBS9999 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI 
          GOTO      EDBS9999 IF NOT EQUAL
.
.
.
          CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      EDBS99999 IF EQUAL     * No item to claim
.
.         Write a record to Claim bulk billing file
.
          CALL      CLOUTECT
          MOVE      SP70,OTECHOSP          
.
          IF        IBCNMHOS=ONE
            PACK      KEY8,PINVADM,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,OTECHOSP
            ENDIF
          ENDIF
.
          MOVE      ZERO,OTECFLAG
          MOVE      "3",OTECMODL           * Priv Prac
          MOVE      PINVNO,OTECINVN
          MOVE      PINVUR,OTECURNO
          MOVE      PINVADM,OTECUNIQ
          MOVE      FORM12P2,OTECAMTC      * Amoutn claimed
       PACK      OTECOKEY,DOBAOUTN,OBADATE,OBASTRT,DOBASLOT,OBASITE,OBACLIN,SP70
          PACK      KEY30,OTECHOSP,OTECFLAG,OTECMODL,OTECUNIQ:
                          OTECINVN,OTECBATN,SP70
          CALL      WROTECT1
.
          MATCH     "1",RACLUEBB
          GOTO      EDBS9999 IF NOT EQUAL
.
          MATCH     SP70,PTCNEDBO                * eclipse outbound path set?
          GOTO      EDBS9999 IF EQUAL
.
          CALL      SEDBX000
.
EDBS9999  RETURN
+
.------------------------------------------------------------------------
.         Check if all procedures have a rebate reason
.------------------------------------------------------------------------
CPRC0000  MOVE      ZERO,FORM12P2
          PACK      KEY22,ADMISSNO,PINVNO,SP70
          CALL      RDSDTRO1
CPRC1000  CALL      RDKDTRO1
          BRANCH    OVRCD,CPRC9999
.
          MATCH     ADMISSNO,DOTNUMB
          GOTO      CPRC9999 IF NOT EQUAL
          MATCH     PINVNO,OTINVNO
          GOTO      CPRC9999 IF NOT EQUAL
.
          MATCH     "6",DOTRECTY
          GOTO      CPRC1000 IF NOT EQUAL     * Not a procedure record
.
.         MATCH     SP70,ATDTRBRS
.         GOTO      CPRC8000 IF EQUAL         * No rebate reason
.
          ADD       OTPATAMT,FORM12P2
          GOTO      CPRC1000
.
CPRC8000  MOVE      ZERO,FORM12P2          * found procedure with No reb.reason
.
CPRC9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SEDBX000                                   *
.*               Schedule Eclipse Extract (IBAOUT04)                      *
.--------------------------------------------------------------------------
SEDBX000  MOVE      "IBAOUT04",SCHDPGID
          MOVE      "Eclipse DBS Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAOUT04",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      OTECHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SEDBX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SEDBX600
.
SEDBX500  MOVE      TWO,F3
.
SEDBX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    OTECHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    OTECUNIQ,ECCLMARR
          APPEND    OTECINVN,ECCLMARR
          APPEND    OTECURNO,ECCLMARR
          APPEND    PINVDTE,ECCLMARR
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),OTECAMTC
          IF        IBCNUGST=2
            ADD       PTINGSTJ,OTECAMTC
          ENDIF
.
          APPEND    OTECAMTC,ECCLMARR
          APPEND    THREE,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    DOBAOUTN,ECCLMARR
          APPEND    OBADATE,ECCLMARR
          APPEND    OBASTRT,ECCLMARR
          APPEND    DOBASLOT,ECCLMARR
          APPEND    OBASITE,ECCLMARR
          APPEND    OBACLIN,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SEDBX999  RETURN
+
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse DBS
.------------------------------------------------------------
ECLDBS00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNUEBB
.         GOTO      ECLDBS90 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",PTCNBBSW
            GOTO      ECLDBS90 IF NOT EQUAL
          ENDIF
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,ECLDBS90
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      ECLDBS90 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      ECLDBS90 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ECLDBS90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,ECLDBS90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ECLDBS90
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      ECLDBS90 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      ECLDBS90 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      ECLDBS90 IF NOT EQUAL
.
ECLDBS80  MOVE      ONE,DIM1
.
ECLDBS90  WRITE     HTMLFILE;DIM1;
ECLDBS99  RETURN
+
.------------------------------------------------------------
. WebServices DBSW Bulk Billing Raise / Raise and Claim
.------------------------------------------------------------
BBSW0000  MATCH     "1",PTCNWSIN
          GOTO      BBSW9999 IF NOT EQUAL
.
          MATCH     "1",PTCNBBSW
          GOTO      BBSW9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBBBSA1,"webbbsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,BBSW9999
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,BBSW9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      BBSW9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      BBSW9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,BBSW9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,BBSW9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,BBSW9999
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      BBSW9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      BBSW9999 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      BBSW9999 IF NOT EQUAL
.
.
.
          CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      BBSW99999 IF EQUAL     * No item to claim
.
.         Write a record to Claim bulk billing file
.
          CALL      CLWEBBBS
          MOVE      SP70,WBBSHOSP
.
          IF        IBCNMHOS=ONE
            PACK      KEY8,PINVADM,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,WBBSHOSP
            ENDIF
          ENDIF
.
          MOVE      ZERO,WBBSFLAG
          MOVE      "3",WBBSMODL           * Outpatient
          MOVE      PINVNO,WBBSINVN
          MOVE      PINVUR,WBBSURNO
          MOVE      PINVADM,WBBSUNIQ
          MOVE      FORM12P2,WBBSAMTC      * Amoutn claimed
       PACK      WBBSOKEY,DOBAOUTN,OBADATE,OBASTRT,DOBASLOT,OBASITE,OBACLIN,SP70
          PACK      KEY30,WBBSHOSP,WBBSFLAG,WBBSMODL,WBBSUNIQ:
                          WBBSINVN,WBBSBATN,SP70

          CALL      IBACLOCK
          PACK      WBBSCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBBSCDAT
          MOVE      CTIMEIS,WBBSCTIM
          MOVE      USERID,WBBSCUID
          CALL      WRWBBBS1
.
          MATCH     "1",RACLUEBB
          GOTO      BBSW9999 IF NOT EQUAL
.
.         MATCH     SP70,PTCNEDBO                * eclipse outbound path set?
.         GOTO      BBSW9999 IF EQUAL
.
          CALL      SBBSX000
.
BBSW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SBBSX000                                   *
.*               Schedule Eclipse Extract (IBAWEB06)                      *
.--------------------------------------------------------------------------
SBBSX000  MOVE      "IBAWEB06",SCHDPGID
          MOVE      "WebServices DBSW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB06",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBBSHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SBBSX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SBBSX600
.
SBBSX500  MOVE      TWO,F3
.
SBBSX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBBSHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBBSUNIQ,ECCLMARR
          APPEND    WBBSINVN,ECCLMARR
          APPEND    WBBSURNO,ECCLMARR
          APPEND    PINVDTE,ECCLMARR
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),WBBSAMTC
          IF        IBCNUGST=2
            ADD       PTINGSTJ,WBBSAMTC
          ENDIF
.
          APPEND    WBBSAMTC,ECCLMARR
          APPEND    THREE,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    DOBAOUTN,ECCLMARR
          APPEND    OBADATE,ECCLMARR
          APPEND    OBASTRT,ECCLMARR
          APPEND    DOBASLOT,ECCLMARR
          APPEND    OBASITE,ECCLMARR
          APPEND    OBACLIN,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SBBSX999  RETURN
+
.------------------------------------------------------------------------------
.         Generating DB4W Form
.------------------------------------------------------------------------------
DB4W0000  MATCH     "1",PTCNWSIN
          GOTO      DB4W9999 IF NOT EQUAL   
.
          MATCH     "1",PTCNBBSW
          GOTO      DB4W9999 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,DB4W9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      DB4W9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      DB4W9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,DB4W9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,DB4W9999
.
          MATCH     SP70,OBACOMP
          GOTO      DB4W9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4W9999            * Invalid code
.
          MATCH     "P",TCINDC1
          GOTO      DB4W9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4W9999            * Invalid code
          MATCH     "P",TCINDC1
          GOTO      BULKBL99 IF NOT EQUAL
.
          MOVE      "IBAWEB16",SCHDPGID
          MOVE      "Generating WebServices DB4W Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
DB4W9999  RETURN
+
.------------------------------------------------------------
. WebServices DVAW Bulk Billing Raise / Raise and Claim
.------------------------------------------------------------
DVAW0000  MATCH     "1",PTCNWSIN
          GOTO      DVAW9999 IF NOT EQUAL
.
          MATCH     "1",PTCNDVAW
          GOTO      DVAW9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBDVWA1,"webdvwaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DVAW9999
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,DVAW9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      DVAW9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      DVAW9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,DVAW9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,DVAW9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,DVAW9999
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "V",TCINDC1
          GOTO      DVAW9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      DVAW9999 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      DVAW9999 IF NOT EQUAL
.
.
.
          CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      DVAW99999 IF EQUAL     * No item to claim
.
.         Write a record to Claim DVAW Eclipse file
.
          CALL      CLWEBDVW
          MOVE      SP70,WBDWHOSP
.
          IF        IBCNMHOS=ONE
            PACK      KEY8,PINVADM,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,WBDWHOSP
            ENDIF
          ENDIF
.
          MOVE      ZERO,WBDWFLAG
          MOVE      "3",WBDWMODL           * Outpatient
          MOVE      PINVNO,WBDWINVN
          MOVE      PINVUR,WBDWURNO
          MOVE      PINVADM,WBDWUNIQ
          MOVE      FORM12P2,WBDWAMTC      * Amoutn claimed
       PACK      WBDWOKEY,DOBAOUTN,OBADATE,OBASTRT,DOBASLOT,OBASITE,OBACLIN,SP70
          PACK      KEY30,WBDWHOSP,WBDWFLAG,WBDWMODL,WBDWUNIQ:
                          WBDWINVN,WBDWBATN,SP70

          CALL      IBACLOCK
          PACK      WBDWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBDWCDAT
          MOVE      CTIMEIS,WBDWCTIM
          MOVE      USERID,WBDWCUID
          CALL      WRWBDVW1
.
          MATCH     "1",RACLUDVA
          GOTO      DVAW9999 IF NOT EQUAL
.
          CALL      SDVSX000
.
DVAW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SDVSX000                                   *
.*               Schedule Eclipse Extract (IBAWEB08)                      *
.--------------------------------------------------------------------------
SDVSX000  MOVE      "IBAWEB08",SCHDPGID
          MOVE      "WebServices DVAW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB08",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBDWHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SBBSX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SBBSX600
.
SDVSX500  MOVE      TWO,F3
.
SDVSX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBDWHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBDWUNIQ,ECCLMARR
          APPEND    WBDWINVN,ECCLMARR
          APPEND    WBDWURNO,ECCLMARR
          APPEND    PINVDTE,ECCLMARR
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),WBDWAMTC
          IF        IBCNUGST=2
            ADD       PTINGSTJ,WBDWAMTC
          ENDIF
.
          APPEND    WBDWAMTC,ECCLMARR
          APPEND    THREE,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    DOBAOUTN,ECCLMARR
          APPEND    OBADATE,ECCLMARR
          APPEND    OBASTRT,ECCLMARR
          APPEND    DOBASLOT,ECCLMARR
          APPEND    OBASITE,ECCLMARR
          APPEND    OBACLIN,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SDVSX999  RETURN
+
.------------------------------------------------------------------------------
.         Generating D1217 Form
.------------------------------------------------------------------------------
D1217000  MATCH     "1",PTCNWSIN
          GOTO      D1217999 IF NOT EQUAL
.
          MATCH     "1",PTCNDVAW
          GOTO      D1217999 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,D1217999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      D1217999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      D1217999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,D1217999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,D1217999
.
          MATCH     SP70,OBACOMP
          GOTO      D1217999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1217999            * Invalid code
.
          MATCH     "V",TCINDC1
          GOTO      D1217999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1217999            * Invalid code
          MATCH     "P",TCINDC1
          GOTO      D1217999 IF NOT EQUAL
.
          MOVE      "IBAWEB17",SCHDPGID
          MOVE      "Generating WebServices D1217 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
D1217999  RETURN
+
.------------------------------------------------------------------------------
.         Generating D1216S Form
.------------------------------------------------------------------------------
D1216S00  MATCH     "1",PTCNWSIN
          GOTO      D1216S99 IF NOT EQUAL
.
          MATCH     "1",PTCNDVAW
          GOTO      D1216S99 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,D1216S99
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      D1216S99 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      D1216S99 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,D1216S99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,D1216S99
.
          MATCH     SP70,OBACOMP
          GOTO      D1216S99 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1216S99            * Invalid code
.
          MATCH     "V",TCINDC1
          GOTO      D1216S99 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1216S99            * Invalid code
          MATCH     "P",TCINDC1
          GOTO      D1216S99 IF NOT EQUAL
.
          MOVE      "IBAWEB18",SCHDPGID
          MOVE      "Generating WebServices D1216S Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
D1216S99  RETURN
+
.------------------------------------------------------------
. Set dvaw billing indicator
.------------------------------------------------------------
DVAWBL00  MOVE      SP1,DVAWBILL
          MATCH     "1",PTCNUEBB
          GOTO      DVAWBL99 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,DVAWBL99
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      DVAWBL99 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      DVAWBL99 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,DVAWBL99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,DVAWBL99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,DVAWBL99
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "V",TCINDC1
          GOTO      DVAWBL99 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      DVAWBL99 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      DVAWBL99 IF NOT EQUAL
.
          MOVE      "1",DVAWBILL
.
DVAWBL99  RETURN
.
.------------------------------------------------------------
. Indicator for Eclipse DVA
.------------------------------------------------------------
ECLDVA00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNDVAW
          GOTO      ECLDVA90 IF NOT EQUAL
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,ECLDVA90
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      ECLDVA90 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      ECLDVA90 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ECLDVA90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,ECLDVA90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ECLDVA90
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MATCH     "V",TCINDC1
          GOTO      ECLDVA90 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC1
          GOTO      ECLDVA90 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI
          GOTO      ECLDVA90 IF NOT EQUAL
.
ECLDVA80  MOVE      ONE,DIM1
.
ECLDVA90  WRITE     HTMLFILE;DIM1;
ECLDVA99  RETURN
+
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       IBAGSTKY
          INC       IBAGKIKY
          INC       OUTINVS
          INC       OUTCATBI
          INC       PATCATAI
          INC       PATCALFN
          INC       PRNTICDC
          INC       PRTIPROV
.
          INC       PMSADJIO/INC
          INC       PMSABFIO/INC
          INC       OUTPWOIO/INC
          INC       PATCFAIO/INC
          INC       PATINPIO/INC
          INC       PMSCIDIO/INC
          INC       PMSTLEIO/INC
          INC       OUTHTRIO/INC
.
          INC       IBATMDIO/INC
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       NZPFINIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRFNIO/INC
          INC       NZPRDTIO/INC
          INC       NZPSPRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       OUTMA1IO/INC       * Session Master file
          INC       OUTBOAIO/INC        * Bookings file A
          INC       OUTBB1IO/INC        * Bookings file B
          INC       OUTBOCIO/INC        * Bookings file C
          INC       OUTCLIIO/INC
          INC       OUTDTRIO/INC
          INC       OUTECTIO/INC
          INC       AAEDE1IO/INC
          INC       AAEDEBIO/INC
          INC       AAEDTRIO/INC
          INC       COMDEPIO/INC
          INC       VISPAYIO/INC
.
          INC       PATBFEIO/INC
          INC       PATCRAIO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATDRGIO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATFINIO/INC
          INC       PATFIGIO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATIPRIO/INC
          INC       PATIBLIO/INC
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
          INC       PATHLFIO/INC
          INC       PATHDFIO/INC
          INC       PATHSPIO/INC
          INC       PATAFEIO/INC
          INC       PATASDIO/INC
          INC       PATCMXIO/INC
          INC       PATMCHIO/INC
          INC       PATIRNIO/INC
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATREMIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PMSPRGIO/INC
          INC       PATALRIO/INC
          INC       PATTFEIO/INC
          INC       OUTSITIO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       PATRBLIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATITMIO/INC
          INC       PATICDIO/INC
          INC       PATDADIO/INC
          INC       PATDTRIO/INC
          INC       PATVADIO/INC
          INC       PATWVEIO/INC
          INC       PATWMAIO/INC
          INC       PATWC1IO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       PATEDTIO/INC
          INC       PATFX1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSCNOIO/INC
          INC       PMSFCIIO/INC
          INC       PMSEXTIO/INC
          INC       PMSEVTIO/INC
          INC       PMSMTIIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       RCPDTEIO/INC
          INC       RCPCRSIO/INC
          INC       MLTCFNIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       NZPCFNIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       VISMDTIO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       WEBBBSIO/INC
          INC       WEBDVWIO/INC
          INC       WEBB2BIO/INC
.
          INC       ABFOTDET
          INC       CHKCLDCP
          INC       CLPATDTR
          INC       CLPMSPX2
          INC       CLNHIMAS
          INC       CLOUTECT
          INC       CLWEBBBS
          INC       CLWEBDVW
          INC       PATMASTM
          INC       PATDOCTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCCD
          INC       PATGBCRN          * I-48227
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       CLPATMAS
          INC       CLPATINV
          INC       CLOUTDTR
          INC       HASCMNTS
          INC       GETALTID
          INC       TFILENAM
.
          INC       VISPAYTM
          INC       PATCMSTP
          INC       CHKCMXPT
          INC       PATINVHL
          INC       PATINVTL
          INC       PRTINVBD
          INC       PATITMRD
          INC       PMSOSDTM                * Outstanding Debt alert routine
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       PATRDEBT
.
          INC       CLPMSMTI
          INC       CLPMSABF
          INC       CLPATINP
.
          INC       RSHWEBCD
