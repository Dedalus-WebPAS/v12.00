.******************************************************************************
.* System         : Patient Management                                        *
.* Program        : IBAPMS99.PBL                                              *
.* Name           : DRG Grouper Interface                                     *
.******************************************************************************
.* NOTE: PMSDAT99,PATCHGRP & PMSPRG99 have been made obsolete from V10.03.13  *
.******************************************************************************
.* Date           : 02/11/1992                                                *
.* Author         : Justin Coates                                             *
.* Function       : To Create a data file to be passed to the grouper and to  *
.*                  Process the data returned from the grouper.               *
.* Modifications  :                                                           *
.*                                                                            *
.******************************************************************************
.*       V12.00.02  03/06/2025  Ebon Clements  TSK 0955096                    *
.*                  Replace FORM8 with DIM8VISN                               *
.*       V12.00.01  16/05/2025  Ebon Clements  TSK 0955096                    *
.*                  Alphanueric visit number changes                          *
.*       V11.05.08  17/04/2025  Ebon Clements  TSK 0950532                    *
.*                  Added diagnosis cluster id functionality                  *
.*       V11.05.07  14/04/2025  Davin          TSK 0951723                    *
.*                  Recompiled for WEBGROUP - send 'I' procedures to grouper  *
.*       V11.05.06  27/03/2025  Davin          TSK 0956210                    *
.*                  Added PTCNE120/PTCN120C, routine G12GP000 and label       *
.*                  UNX120DR for DRG Version 12.0                             *
.*       V11.05.05  20/03/2025  Davin          TSK 0956210                    *
.*                  Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86) *
.*       V11.05.04  07/03/2025  Ebon Clements  TSK 0944729                    *
.*                  Recompiled for WEBGROUP - Load Codefinder QLD             *
.*       V11.05.03  06/02/2025  Ebon Clements  TSK 0956930                    *
.*                  Recompiled for WEBGROUP - Clear grouper vars              *
.*       V11.05.02  04/02/2025  Ebon Clements  TSK 0951861                    *
.*                  Recompiled for WEBGROUP - Added OPRTSMFD                  *
.*       V11.05.01  15/11/2024  Davin          TSK 0950787                    *
.*                  Recompiled for WEBGROUP - Send CTYPE Tag to Codefinder    *
.*       V11.04.06  18/10/2024  Davin          TSK 0922271                    *
.*                  Recompiled for WEBGROUP - allow grouping of 100 codes     *
.*       V11.04.05  13/08/2024  Ebon Clements  TSK 0945933                    *
.*                  Set ADMISSNO in P41T2000                                  *
.*       V11.04.04  05/07/2024  Ebon Clements  TSK 0948817                    *
.*                  Recompiled for WEBGROUP - CGS/Codefinder Separation mode  *
.*       V11.04.03  17/06/2024  PJ Le Febour   TSK 0937495                    *
.*                  Recompiled for WEBGROUP - get DCLs from new positions     *
.*                  in grouper v11                                            *
.*       V11.04.02  22/02/2024  Ebon Clements  TSK 0943354                    *
.*                  Recompiled for WEBGROUP - TG export separation mode       *
.*       V11.04.01  25/01/2024  Davin          TSK 0928468                    *
.*                  Recompiled for WEBGROUP - Added AMHCC Grouper             *
.*       V11.03.09  26/09/2023  Ebon Clements  TSK 0934837                    *
.*                  Recompiled for WEBGROUP - Load Codefinder default         *
.*                  clinician                                                 *
.*       V11.03.08  04/09/2023  Ebon Clements  TSK 0936661                    *
.*                  Recompiled for WEBGROUP - TurboGrouper QLD condition      *
.*                  onset type                                                *
.*       V11.03.07  21/08/2023  Davin          TSK 0935074                    *
.*                  Recompiled for WEBGROUP - loading op codes from codefinder*
.*       V11.03.06  17/08/2023  Davin         TSK 0936495                     *
.*                  Mods to not use ptcndgpv when determining which drg       *
.*                  version to report (G11GP000/G10GP000)                     *
.*       V11.03.05  02/08/2023  Ebon Clements  TSK 0935857                    *
.*                  Fixed load of DRG 11 at A41D2500 - G11GP000               *
.*       V11.03.04  05/07/2023  Ebon Clements  TSK 0934723                    *
.*                  Recompiled for WEBGROUP - DRG 11 - 2 character separation *
.*                  mode if discharged post DRG 11 go live                    *
.*       V11.03.03  26/06/2023  Ebon Clements  TSK 0932535                    *
.*                  Recompiled for WEBGROUP - DRG 11 - 2 character separation *
.*                  mode                                                      *
.*       V11.03.02  14/03/2023  Ebon Clements TSK 0929641                     *
.*                  Added year 9999 test to indicate not using ICD10 ED 2     *
.*                  PTCNGDV2                                                  *
.*       V11.03.01  23/12/2022  Davin         TSK 0926029                     *
.*                  Recompiled for WEBGROUP - Use pateco code/desc            *
.*       V11.02.07  25/08/2022  Ebon Clements TSK 0923827                     *
.*                  Added open of patmmbsf and set ICD10 date to discharge    *
.*                  date - ICDRDDTE - PRTB0000                                *
.*       V11.02.06  14/06/2022  Ebon Clements TSK 0906596                     *
.*                  Recompiled for WEBGROUP - Charlson score                  *
.*       V11.02.05  02/06/2022 Ebon Clements  TSK 0902519                     *
.*                  Recompiled for WEBGROUP - Aboriginality to use cat VA     *
.*                  indicator 4                                               *
.*       V11.02.04  21/04/2022  Davin         TSK 0917793                     *
.*                  Added PTCNE110/PTCN110C, routine G11GP000 and label       *
.*                  UNX110DR for DRG Version 11.0                             *
.*       V11.02.03  30/03/2022  Davin         TSK 0917793                     *
.*                  Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)*
.*       V11.02.02  11/02/2022  Ebon Clements TSK 0915238                     *
.*                  Recompiled for WEBGROUP - TG export/import operation times*
.*       V11.02.01  08/02/2022  Ebon Clements TSK 0915238                     *
.*                  Recompiled for WEBGROUP - TG operation times              *
.*       V11.01.16  22/12/2021  Ebon Clements TSK 0914724                     *
.*                  Set episode number to one so GTCOD000 will extract all    *
.*                  diagnosis and procedure codes.  EPSCD001                  *
.*                  Removed redundat call to COD41000 replace by GTCOD000     *
.*       V11.01.15  19/11/2021  Ebon Clements TSK 0911383                     *
.*                  Recompiled for WEBGROUP - CGS Condition onset flag NWAU   *
.*       V11.01.14  18/11/2021  Ebon Clements TSK 0911851                     *
.*                  Recompiled for WEBGROUP - Codefinder/CGS - ICU NICU hrs   *
.*       V11.01.13  17/11/2021  Ebon Clements TSK 0911414                     *
.*                  Recompiled for WEBGROUP - Export additional fields to TG  *
.*       V11.01.12  15/09/2021  Ebon Clements  TSK 0902389                    *
.*                  Recompiled for WEBGROUP - Urgency of Admission            *
.*       V11.01.11  14/09/2021  Ebon Clements  TSK 0897701                    *
.*                  Recompiled for WEBGROUP - Gender                          *
.*       V11.01.10  20/08/2021  Ebon Clements  TSK 0909624                    *
.*                  Recompiled for WEBGROUP - LOS                             *
.*       V11.01.09  13/07/2021  Ebon Clements  TSK 0902615                    *
.*                  Recompiled for WEBGROUP - Not using NWAU test             *
.*       V11.01.08  07/07/2021  Ebon Clements  TSK 0908708                    *
.*                  Recompiled for WEBGROUP - ICU Hours                       *
.*       V11.01.07  06/07/2021  Ebon Clements  TSK 0908709                    *
.*                  Recompiled for WEBGROUP - Use cat S admission mode        *
.*       V11.01.06  30/06/2021  Ebon Clements  TSK 0902615                    *
.*                  Recompiled for WEBGROUP - Export Care Type to TG          *
.*       V11.01.05  30/06/2021  Ebon Clements  TSK 0902615                    *
.*                  Recompiled for WEBGROUP - Don't restrict codes for NWAU   *
.*       V11.01.04  29/06/2021  Ebon Clements  TSK 0902615                    *
.*                  Recompiled for WEBGROUP - NWAU unix grouper changes       *
.*       V11.01.03  22/06/2021  Ebon Clements  TSK 0907810                    *
.*                  Recompiled for WEBGROUP - Contract care type flag         *
.*       V11.01.02  18/06/2021  Ebon Clements  TSK 0902615                    *
.*                  Recompiled for WEBGROUP - NWAU unix grouper changes       *
.*       V11.01.01  05/05/2021  Ebon Clements  TSK 0902615                    *
.*                  Added read of NWAU parameters MRCNUNWA and MRCNENWA       *
.******************************************************************************
.*       V11.00.15  08/10/2020  Ebon Clements  TSK 0892694                    *
.*                  Recompiled for WEBGROUP - Export 6.2 DRG as 6.0x to       *
.*                  TurboGrouper                                              *
.*       V11.00.14  08/10/2020  Ebon Clements  TSK 0892694                    *
.*                  Added TurboGrouper vars XTRB0115 to XTRB0119              *
.*                  Recompiled for WEBGROUP - Send health fund defails to TG  *
.*       V11.00.13  08/10/2020  Ebon Clements  TSK 0893634                    *
.*                  Recompiled for WIESCALC - WIES27 Aboriginal and Torres    *
.*                  Strait Islander loading                                   *
.*       V11.00.12  30/09/2020  Jill Parkinson Task 0897242                   *
.*                  Corrected read of MRCNRDSG                                *
.*       V11.00.11  23/09/2020  Ebon Clements  TSK 0893634                    *
.*                  Recompiled for WIESCALC - Added WIES27 for 2020/2021      *
.*       V11.00.10  17/09/2020  Jill Parkinson Task 0897242                   *
.*                  Added read of MRCNRDSG                                    *
.*       V11.00.09  12/08/2020  Ebon Clements  TSK 0895835                    *
.*                  Fixed TurboGrouper report print of admission number       *
.*                  Added Delete of TurboGroupe input temp file TURBOFL2      *
.*                  Added print of TurboGroupe output not found error         *
.*       V11.00.08  10/07/2020  Ebon Clements  TSK 0894249                    *
.*                  Populate ENCENDAT for DRG date test LDTB1000              *
.*       V11.00.07  10/07/2020  Ebon Clements  TSK 0894249                    *
.*                  Recompiled for WEBGROUP - TurboGrouper load DRG version 10*
.*                  Added RTIODAYS include instead of dummy label             *
.*       V11.00.06  09/07/2020  Ebon Clements  TSK 0894249                    *
.*                  Fixed TBLDRG00 exit branch                                *
.*       V11.00.05  08/07/2020  Ebon Clements  TSK 0894249                    *
.*                  Only load TurboGrouper DRG versions according to          *
.*                  the DRG go live dates - TBLDRG00                          *
.*       V11.00.04  28/05/2020  Ebon Clements  TSK 0892095                    *
.*                  Added TurboGrouper update of diagnosis DCL - WRTDG000     *
.*       V11.00.03  25/05/2020  Davin          TSK 0890603                    *
.*                  Recompiled for WEBGROUP/WIESCALC - WIES for private facil *
.*       V11.00.02  15/05/2020  Ebon Clements  TSK 0891590                    *
.*                  Recompiled for WEBGROUP - TurboGrouper DRG version 6.2    *
.*       V11.00.01  17/03/2020  Ebon Clements  TSK 0889552                    *
.*                  Fixed print of full DRG for TurboGrouper - PTLN0000       *
.*                  10/03/2020  Jill Parkinson Task 0879163                    *
.*                  Added SEXDSCIO include                                    *
.*       V10.15.04  17/02/2020  Davin          TSK 0881493                    *
.*                  Recompiled for WEBGROUP - restrict diag codes to grouper  *
.*       V10.15.03  19/12/2019  Ebon Clements  TSK 0886086                    *
.*                  Changed TurbGrouper import to use mrtweb02.us7 instead of *
.*                  mrtweb02.us6 as batch grouping needs a longer timeout     *
.*       V10.15.02  12/11/2019  Nicole Torrisi TSK 0881409                    *
.*                  Recompiled for WEBGROUP - Added HMV                       * 
.*       V10.15.01  09/10/2019  Ebon Clements  TSK 0877429                    *
.*                  Added channel and job to TurbGrouper import/export file   * 
.*                  names                                                     *
.*       V10.14.14  03/10/2019  Thanh T        TSK 0882260                    * 
.*                  Recompiled for WEBGRPVA - DRG Version 11.0                *
.*       V10.14.13  02/10/2019  Ebon Clements  TSK 0877430                    *
.*                  Populate TurboGrouper coded by user date and time         *
.*       V10.14.12  30/09/2019  Ebon Clements  TSK 0877428                    *
.*                  Populate TurboGrouper campus code                         *
.*       V10.14.11  26/08/2019  Davin          TSK 0880255                    *
.*                  Recompiled for WIESCALC - Added WIES26 for 2019/2020      *
.*       V10.14.10  04/06/2019  Ebon Clements  TSK 0875790                    *
.*                  Recompiled for WEBGROUP - TurboGrouper operation prefix   *
.*       V10.14.09  31/05/2019  Ebon Clements  TSK 0875696                    *
.*                  Recompiled for WEBGROUP - TurboGrouper coder id           *
.*       V10.14.08  21/05/2019  Davin          TSK 0870480                    *
.*                  Recompiled for WEBGROUP - Changed eccsraw codefinder tag  *
.*       V10.14.07  14/05/2019  Ebon Clements  TSK 0874778                    *
.*                  Recompiled for WEBGROUP - TurboGrouper diagnosis codes    *
.*       V10.14.06  02/05/2019  Ebon Clements  TSK 0874135                    *
.*                  Recompiled for WEBGROUP - TurboGrouper theatre date/times *
.*       V10.14.05  30/04/2019  Ebon Clements  TSK 00873995                   *
.*                  Added TURBOSAV to retain previous operation date/times    *
.*       V10.14.04  08/04/2019  Ebon Clements  TSK 0872901                    *
.*                  Recompiled for WEBGROUP -  Auto Coding user id            *
.*       V10.14.03  27/03/2019  Ebon Clements  TSK 0872200                    *
.*                  Recompiled for WEBGROUP -  Export leave days              *
.*       V10.14.02  14/03/2019  Don Nguyen     TSK 0869412                    *
.*                  Added read of ICD10 Ed.11 Go-live Date parameter (PTCNGDX1)
.*                  04/03/2019  Ebon Clements  TSK 0870711                    *
.*                  Recompiled for WEBGROUP - TurboGrouper                    *
.*                  27/02/2019  Richa Phogat   TSK 0870439                    *
.*                  Added PTCNE100/PTCN100C, routine G10GP000 and label       *
.*                  UNX90DRG for DRG 13rsion 10.0                             *
.*       V10.14.01  25/02/2019  Ebon Clements  TSK 0870711                    *
.*                  Recompiled for WEBGROUP - TurboGrouper                    *
.******************************************************************************
.*       V10.13.07  31/01/2019  Davin          TSK 0868369                    *
.*                  Fixed report to display all admissions that are grouped   *
.*       V10.13.06  24/01/2019  Ebon Clements  TSK 0869592                    *
.*                  Recompiled for WEBGROUP - TurboGrouper                    *
.*       V10.13.05  08/01/2019  Davin          TSK 0868369                    *
.*                  Increased OPENFLG to TEN1 for DRG9.0 (A41D2000)           *
.*                  Don't use state deflt (ptcndgpv) if ptcndged=1 (A41D0000) *
.*       V10.13.04  20/12/2018  Don Nguyen     TSK 0837732                    *
.*                  Recompiled for WEBGROUP - Modified GODTM000 to get the    *
.*                  first matching MBS Item time values.                      *
.*       V10.13.03  01/11/2018  Davin            TSK 0852820                  *
.*                  Recompiled for WEBGROUP - Use "TOTWT:" tag for nz wies    *
.*       V10.13.02  06/09/2018  Richa Phogat   TSK 0862786                    *
.*                  Recompiled for WEBGROUP - Removed bypass Morphology       *
.*       V10.13.01  21/08/2018  Davin            TSK 0860935                  *
.*                  Recompiled for WIESCALC - Added WIES25 for 2018/2019      *
.*       V10.12.04  05/06/2018  Ebon Clements    TSK 0845772                  *
.*                  Recompiled for WEBGROUP - TurboGrouper diagnosis          *
.*       V10.12.03  04/05/2018  Ebon Clements    TSK 0845772                  *
.*                  Recompiled for WEBGROUP - TurboGrouper                    *
.*       V10.12.02  23/03/2018  Tracey Nguyen    TSK 0852793                  *
.*                  Added PTCNED90/PTCNC90C, routine G90GP000 and label       *
.*                  UNX90DRG for DRG Version 9.0                              *
.*       V10.12.01  29/01/2018  Ania P           TSK 0851398                  *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.11.05  27/12/2017  Steve Armstrong  TSK 0850165                  *
.*                  Recompiled for changes to DGCLICAC.                       *
.*       V10.11.04  15/12/2017  Peter Vela       TSK 0847747                  *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.11.03  11/12/2017  Don Nguyen       TSK 0848767                  *
.*                  Recompiled for WEBGROUP - Modified GDSPX300 to include ACT*
.*       V10.11.02  27/09/2017  Davin            TSK 0845070                  *
.*                  Recompiled for WEBGROUP - fixed codefinder tag BWIES      *
.*       V10.11.01  15/08/2017  Davin            TSK 0842626                  *
.*                  Recompiled for WIESCALC - Added WIES24 for 2017/2018      *
.******************************************************************************
.*       V10.10.06 21/06/2017  Davin          TSK 0836775                     *
.*                  Recompiled for WEBGROUP - mental health legal status      *
.*       V10.10.05  13/06/2017  J.Tan          TSK 0839991                    *
.*                  Recompiled for PATDBTYP (PATGNFEE)                        *
.*       V10.10.04  07/06/2017  Jill Parkinson TSK 0832750                    *
.*                  Recompiled for WIESCALC - R64Z issues                     *
.*       V10.10.03  01/06/2017  Don Nguyen       TSK 0838360                  *
.*                  Recompiled for WEBGROUP - Fixed RLTAGS00                  *
.*                  01/06/2017  Don Nguyen       TSK 0838196                  *
.*                  Added WCFINPFN & WCFOUTFN. Recompiled for WEBGROUP.       *
.*       V10.10.02  25/05/2017  Jill Parkinson   TSK 0832750                  *
.*                  Recompiled for wiescalc - use drg code position 2-3 to    *
.*                  decide if surgical                                        *
.*       V10.10.01  17/03/2017  Davin          TSK 0833093     HDP 2017/2018  *
.*                  Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85) *
.*       V10.09.03  18/01/2017  Jill Parkinson TSK 0831665
.*                  Recompiled for WEBGROUP
.*       V10.09.02  09/01/2017  Jill Parkinson TSK 0831665
.*                  Recompiled for WEBGROUP
.*       V10.09.01  13/12/2016  Jill Parkinson TSK 0817492
.*                  Recompiled for WIESCALC - Added check for surgical procs
.*       V10.08.10  24/11/2016  Jill Parkinson TSK 0817492
.*                  Recompiled for WIESCALC - Added check for surgical procs
.*       V10.08.09  08/11/2016  Don Nguyen       TSK 0828544                  *
.*                  Recompiled for WEBGROUP - Modified RLTAGS00               *
.*       V10.08.08  05/10/2016  Davin            TSK 0826104                  *
.*                  Recompiled for WEBGROUP - importing codefinder proc date  *
.*       V10.08.07  02/09/2016  Davin            TSK 0825157                  *
.*                  Recompiled for WIESCALC                                   *
.*       V10.08.06  30/08/2016  Don Nguyen       TSK 0814947                  *
.*                  Recompiled for WEBGROUP - Modified COPRS000               *
.*       V10.08.05  26/08/2016  Don Nguyen       TSK 0312570                  *
.*                  Recompiled for WEBGROUP - Added check for PTCNDGED=1      *
.*       V10.08.04  19/07/2016  Davin            TSK 0822753                  *
.*                  Recompiled for WIESCALC - Added WIES23 for 2016/2017      *
.*       V10.08.03  27/04/2016  Don Nguyen       TSK 0815007                  *
.*                  Recompiled for WEBGROUP - Modified RDUNIX1 & RDCME1       *
.*       V10.08.02  13/04/2016  Don Nguyen       TSK 0321353                  *
.*                  Recompiled for WEBGROUP - Modified WRENC000 to use GETDRG *
.*       V10.08.01  12/04/2016  Don Nguyen       TSK 0815007                  *
.*                  Recompiled for WEBGROUP - process "I10ECCSRAW:" & "HNIV:" *
.******************************************************************************
.*       V10.07.01  20/10/2015  Davin            CAR 316612                   *
.*                  Added UCCA0000. Exit if Using CCA Interface (mrcngrup=2)  *
.******************************************************************************
.*       V10.06.09  30/07/2015  Don Nguyen       CAR 318792                   *
.*                  Recompiled for WEBGROUP - Modified RLTAGS00 to use KEY200 *
.*       V10.06.08  29/07/2015 Jill Parkinson    CAR 319099                   *
.*                  Mods to always use drginpXX not dinp09 or dinp10          *
.*                  (was checking ICD10 V2 parameter which some sites have now*
.*                  turned off)                                               *
.*       V10.06.07  18/06/2015  Don Nguyen       CAR 314792                   *
.*                  Recompiled for WEBGROUP - Modified ENCDT000               *
.*       V10.06.06  11/06/2015  Patrick Adair    CAR 313223                   *
.*                  Recompiled for WEBGROUP - admission weight check          *
.*       V10.06.05  29/05/2015  Ebon Clements    CAR 317094                   *
.*                  Added PTCNED80 and PTCNC80C for DRG Ver 8.0               *
.*                  Added routine G80GP000 for DRG Ver 8.0                    *
.*       V10.06.04  10/04/2015  J.Tan            CAR 304813                   *
.*                  Added WIESCALC                                            *
.*       V10.06.03  24/03/2015  Don Nguyen       CAR 314100                   *
.*                  Recompiled for WEBGROUP - modified output for             *
.*                  mrtweb02.us1/us2.                                         *
.*       V10.06.02  17/03/2015  Davin            CAR 311669                   *
.*                  Add ICD10 Ed.9 - Go-live Date PTCNGDV9 (Sect.110 Pos.77)  *
.*       V10.06.01  12/03/2015  Steve Armstrong  CAR 314108                   *
.*                  Removed definition of PTCGDATE as PATCGPFD is no longer   *
.*                  in use.                                                   *
.******************************************************************************
.*       V10.05.01  09/09/2014  Davin            CAR 296980                   *
.*                  Recompiled for WEBGROUP - added WIES21                    *
.******************************************************************************
.*       V10.04.02  03/07/2014  Ebon Clements    CAR 302036                   *
.*                  Recompiled for WEBGROUP - Urgency of admission tag        *
.*       V10.04.01  13/03/2014  Don Nguyen       CAR 294888                   *
.*                  Recompiled for changes to WEBGROUP                        *
.******************************************************************************
.*       V10.03.22  14/10/2013  Don Nguyen       CAR 282453                   *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.03.21  09/10/2013  Peter Vela       CAR 292070                   *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.03.20  04/10/2013  Peter Vela       CAR 284261                   *
.*                  Recompiled for PATWIS19 PATWIS20                          *
.*       V10.03.19  02/10/2013  Ania P           CAR 292081                   *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.03.18  09/09/2013  Ania P           CAR 290324                   *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.03.17  10/09/2013  Steve Armstrong  CAR 291089                   *
.*                  Recompiled for changes to PMSQVIIO                        *
.*       V10.03.16  29/08/2013  Ania P           CAR 290324                   *
.*                  Recompiled for WEBGROUP                                   *
.*                  02/09/2013  Davin            CAR 290919                   *
.*                  Recompiled for PATWIS18/19/20                             *
.*       V10.03.15  07/08/2013  Davin            CAR 289848                   *
.*                  Fix to only display default grouper version in report     *
.*                  07/08/2013  Davin            CAR 284960                   *
.*                  Recompiled for WEBGROUP - added WIES20                    *
.*       V10.03.14  18/05/2013  Steve Armstrong  CAR 268961                   *
.*                  Recompiled for changes to PMSQVIFD                        *
.*       V10.03.13  03/05/2013  Davin            CAR 284669 HDP 2013 DRG 7.0  *
.*                  Added PTCNED70 and PTCNC70C for DRG Ver 7.0               *
.*                  Added effective dates for previous grouper versions       *
.*                  Added routine G70GP000 for DRG Ver 7.0                    *
.*                  Removed check for default grouper (dfltvflg)              *
.*       V10.03.12  23/04/2013  Davin            CAR 284420                   *
.*                  Recompiled for PMSPRG99 - add ICD10 Ed.8 PTCNGDV8         *
.*       V10.03.11  25/02/2013  Ania P           CAR 281021                   *
.*                  RECOMPILED for WEBGROUP                                   *
.*       V10.03.10  18/12/2012  Ebon Clements    CAR 277488                   *
.*                  Fixed position of include CLPATCHC to fix U * U           *
.*       V10.03.09  19/11/2012  Mike Laming      CAR 272003                   *
.*                  Recompiled for PMSPRG99 - set FORM2 to ZERO               *
.*       V10.03.08  16/10/2012  Mike Laming      CAR 271756                   *
.*                  Recompiled for PATCHDRG & WEBGROUP - now use STDRG000     *
.*       V10.03.07  20/09/2012  Davin            CAR 273279                   *
.*                  Recompiled for PATWIS19                                   *
.*       V10.03.06  23/08/2012  Davin            CAR 271916                   *
.*                  Recompiled for WEBGROUP                                   *
.*       V10.03.05  07/08/2012  Davin          CAR 270114                     *
.*                  Recompiled for WEBGROUP - added WIES19                    *
.*       V10.03.04  28/06/2012  Mike Laming   CAR 267797 HDP 2012 DRG 6.2     *
.*                  Recompiled for PATCHGRP, WEBGROUP & WEBGRPVA.INC          *
.*       V10.03.03  18/06/2012  Don Nguyen     CAR 261697                     *
.*                  Recompiled for WEBGROUP - Added relevant includes and     *
.*                  defined necessary variables for WEBGROUP routines.        *
.*       V10.03.02  07/05/2012  Mike Laming    CAR 251748                     *
.*                  Recompiled for PMSPRG99 - vars for ADATE/DDATE in WEBGROUP*
.*       V10.03.01  02/12/2011  Davin          CAR 251748                     *
.*                  Recompiled for changes to PATWIS18                        *
.*       V10.02.04  31/10/2011  Mike Laming    CAR 250267                     *
.*                  Recompiled for PMSPRG99 - change of length of PTICUMEC    *
.*       V10.02.03  08/08/2011  Davin S       CAR 238236                      *
.*                  Recompiled for WEBGROUP - added WIES18                    *
.*       V10.02.02  01/09/2011  Steve Armstrong  CAR 248500                   *
.*                  Recompiled for changes to WEBGROUP, PMSDAT99 & PMSPRG99.  *
.*       V10.02.01  28/03/2011  Mike Laming  CAR 240107                       *
.*                  Recompiled for PMSPRG99 - Key changes to PATECDaf/PATECOaf*
.******************************************************************************
.*       V10.00.03  18/10/2010  Mike Laming  CAR 230778                       *
.*                  Recompiled for PMSPRG99 - extend wait time for Grouper    *
.*       V10.00.02  10/08/2010  Davin        CAR 227937                       *
.*                  Recompiled for changes to PATWIS17                        *
.*       V10.00.01  06/04/2010  Mike Laming   CAR 219246                      *
.*                  Recompiled for PMSPRG99 - add ICD10 Ed.7 PTCNGDV7         *
.*       .........  24/03/2010  Davin S       CAR 216505                      *
.*                  Recompiled for WEBGROUP - added WIES17                    *
.*        V9.12.03  24/11/2009  Davin         CAR 210721                      *
.*                  Recompiled for CHKCMXPT - I*C on patcmxaf file            *
.*        V9.12.02  01/07/2009  Davin S       CAR 199724                      *
.*                  Recompiled for WEBGROUP - added WIES16                    *
.*        V9.12.01  19/06/2009  Mike Laming   CAR 197814 HDP 2009 DRG 6.0     *
.*                  Recompiled for PATCHGRP, WEBGROUP & WEBGRPVA.INC          *
.*        V9.11.01  06/03/2009  Mike Laming   CAR 190768                      *
.*                  Recompiled for PATCHGRP, WEBGROUP & WEBGRPVA.INC          *
.*                  (Updated replacements for PAT41GRP & VAR41GRP.INC)        *
.*        V9.10.02  25/09/1008  Davin            CAR 178428                   *
.*                  Recompiled for PATWIS15 - radiotherapy drg modification   *
.*        V9.10.01  17/07/2008  Davin            CAR 163993                   *
.*                  Recompiled for changes to PMSDAT99, PMSPRG99 & PAT41GRP   *
.******************************************************************************
.*        V9.09.05  20/03/2008  Mike Laming   CAR 163918      HDP 2008        *
.*                  Re-compile for PMSPRG99 - add PTCNGDV6 for ICD10 Ed.6     *
.*        V9.09.04  04/03/2008  Jill Habasque    CAR 74205                    *
.*                  Recompiled for changes to PMSPRG99 - added unix grouper   * 
.*        V9.09.03  28/07/2007  Steve Armstrong  CAR 148718                   *
.*                  Recompiled for changes to PAT41GRP.                       * 
.*        V9.09.02  02/08/2007  Steve Armstrong  CAR 145161                   *
.*                  Recompiled for changes to PMSDAT99, PMSPRG99 & PAT41GRP   *
.*        V9.09.01  17/07/2007  Steve Armstrong  CAR 145161                   *
.*                  Recompiled for changes to PMSDAT99, PMSPRG99 & PAT41GRP   *
.******************************************************************************
.*        V9.08.05  12/04/2007  Mike Laming      CAR 137125 HDP 2007 DRG 5.2  *
.*                  Recompiled for PMSDAT99 & PMSPRG99 for DRG 5.2            *
.*        V9.08.04  19/02/2007 Peter Vela     CAR 135241                      *
.*                  Recompiled for WEBDINVS - St. John of God invoice layout  *
.*        V9.08.03  27/02/2007  Mike Laming   CAR 125801                      *
.*                  Recompiled for PMSPRG99 - added WIES8 to WIES13 logic     *
.*        V9.08.02  31/01/2007  Peter Vela    CAR 127930                      *
.*                  Recompled for MRTCONFD                                    *
.*        V9.08.01  25/10/2006  Davin S       CAR 121542                      *
.*                  Recompiled for PMSPRG99                                   *
.******************************************************************************
.*        V9.07.04  11/08/2006 Sandra Barcham     114031                      *
.*                  Fixed regrouping for drg 5.1                              *
.*        V9.07.03  11/07/2006  Davin S       CAR 111764                      *
.*                  Recompiled for PAT41GRP - added WIES13                    *
.*        V9.07.02  10/07/2006  Peter Vela    CAR 111913                      *
.*                  Recompiled for PAT41GRP                                   *
.*        V9.07.01  10/07/2006  Peter Vela    CAR 111913                      *
.*                  Recompiled for PAT41GRP                                   *
.*        V9.06.01  16/05/2006  Mike Laming   CAR 105244         2006 HDP     *
.*                  Re-compile for PMSPRG99                                   *
.*        V9.05.B01 07/02/2006  Peter Vela    CAR 92244                       *
.*                  Recompiled for PAT41GRP                                   *
.*        V9.04.05  26/07/2005  Peter Vela    CAR 66960                       *
.*                  Added 2005/2006 WIES12 file (patw12bf)                    *
.*                  23/05/2005  Mike Laming   CAR 61562                       *
.*                  July 2005 mods for DRG 5.1 - Re-compile for PMSPRG99      *
.*        V9.04.04  29/04/2005  Peter Vela       CAR 55214                    *
.*                  Recompiled for MRTCONFD                                   *
.*        V9.04.03  13/12/2004  Henry Son        CAR 55406                    *
.*                  Change CME to read new output format.                     *
.*                  Re-compile PAT41GRP.                                      *
.*        V9.04.02  09/12/2004 Henry Son         CAR 54882                    *
.*                  Populate operation times from patmmbsf.                   *
.*                  Add PATMMBFD for PAT41GRP Compile.                        *
.*        V9.04.01  01/09/2004  Henry son        CAR 53126                    *
.*                  Further changes for WIES12.                               *
.*                  Diagnosis or procedure incompatible with SEX code.        *
.*                  Recompile for changes in PATWIS12.                        *
.******************************************************************************
.*        V9.03.02  26/07/2004  Henry Son        CAR 51504                    *
.*                  Add WIES12 (2004/2005 changes)                            *
.*        V9.03.01  27/05/2004  Henry Son        CAR 50344                    *
.*                  Group using 3M CME                                        *
.******************************************************************************
.*        V5.11.02  04/05/2004  Mike Laming   CAR 41584                       *
.*                  Add MRTCONFD used for reading MRCNSOMV in PMSPRG99        *
.*        V5.11.01  18/08/2003  CAR 42039   Henry Son                         *
.*                  Recompiled for WIES11 changes (2003/2004)                 *
.******************************************************************************
.*        V5.10.01  25/07/2002  Davin                                         *
.*                  Recompiled for WIES10 changes (2002/2003)                 *
.*        V5.09.05  31/05/2002  Davin  SRF 18236                              *
.*                  Recompiled for PATWIES9 - mv copayment change             *
.*        V5.09.04  23/05/2002  Davin  ICD10 v3                               *
.*                  Recompiled for PAT41GRP & PMSPRG99                        *
.*        V5.09.03  05/12/2001  Davin                                         *
.*                  Recompiled for PATWIES9 - mod to mech. vent. copayment    *
.*        V5.09.02  19/09/2001  Davin SRF 6206                                *
.*                  Recompiled for ENCODER - increased no. of codes displayed *
.*        V5.09.01  11/09/2001  Davin  4.2 grouper mods                       *
.*                  Recompiled for PMSPRG99                                   *
.*        V5.09.B02 27/03/2001  Steve Downing  SRF 9018                       *
.*                  Recompiled for PAT41GRP & ENCODER - delete tempfiles      *
.*        V5.09.B01 09/01/2001  Davin  SRF 7226                               *
.*                  Recompiled for PATWIES8                                   *
.*        V5.08.12  04/09/2000  Davin                                         *
.*                  Recompiled for PMSPRG99                                   *
.*        V5.08.11  04/09/2000  Davin                                         *
.*                  Recompiled for PMSPRG99                                   *
.*        V5.08.10  25/08/2000  Davin                                         *
.*                  Recompiled for PAT41GRP - changes for WIES8               *
.*        V5.08.09  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.08  14/08/2000  Greg Horvat      SRF 647116                   *
.*                  Changed to work with the latest 3.1 grouper               *
.*        V5.08.07  11/08/2000  Caleb Sharman  SRF 5035                       *
.*                  Recompiled for PMSPRG99                                   *
.*        V5.08.06  31/07/2000  Steve Downing  SRF 4299                       *
.*                  Recompiled for PAT41GRP                                   *
.*        V5.08.05  12/07/2000  Greg Horvat                                   *
.*                  Recompiled for PAT41GRP - Fixed I*C on PATTRAN2           *
.*        V5.08.04  07/07/2000  Greg Horvat                                   *
.*                  Recompiled for PATWIES7 - Fixed the reads on the episode  *
.*                  disease file                                              *
.*        V5.08.03  27/06/2000  Greg Horvat                                   *
.*                  Changed for ICD10 version 2 codes                         *
.*        V5.08.02  29/05/2000  Greg Horvat                                   *
.*                  Recompiled for PATWIES7                                   *
.*        V5.08.01  01/05/2000  Greg Horvat                                   *
.*                  Fixed a bug extracting ICD9 operation codes               *
.*        V5.08.B03 15/03/2000  Greg Horvat                                   *
.*                  Changed to get the coding from the episode coding files   *
.*        V5.08.B02 09/02/2000  Greg Horvat                                   *
.*                  Changed to write the DRG to the patient grouper file      *
.*        V5.08.B01 18/01/2000  Greg Horvat                                   *
.*                  Copied from release 6.06, version V6.06.06                *
.*                                                                            *
.******************************************************************************
+
          INC       STD001FD
.
          INC       PATCHCFD/INC
          INC       PATCODFD/INC
.
          INC       PATCALAG/INC            * CALCAGE variables
          INC       PATDHEAD/INC            * Standard header variables
          INC       WEBGRPVA/INC            * Variables for PATCHGRP & WEBGROUP
          INC       VARWISCM/INC            * Common variables for WIES
          INC       VARWIS11/INC            * Variables for PATWIS11
          INC       VARWIS12/INC            * Variables for PATWIS12
          INC       VARWIS13/INC            * Variables for PATWIS13
          INC       VARWIS14/INC            * Variables for PATWIS14
          INC       VARWIS15/INC            * Variables for PATWIS15
          INC       VARWIS16/INC            * Variables for PATWIS16
          INC       VARWIS17/INC            * Variables for PATWIS17
          INC       VARWIS18/INC            * Variables for PATWIS18
          INC       VARWIS19/INC            * Variables for PATWIS19
          INC       VARWIS20/INC            * Variables for PATWIS20
          INC       VARWIS21/INC            * Variables for PATWIS21
.
          INC       IBACONFD/INC
          INC       MEHDLSFD/INC
          INC       MEHHONFD/INC
          INC       MEHLERFD/INC
          INC       NHIMASFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
          INC       OPRTSMFD/INC
          INC       PAT3MIFD/INC            * 3M DRG mapping file
          INC       PATAFEFD/INC            * Additional fee for overnight
          INC       PATASDFD/INC            * Additional fee for same day
          INC       PATASFFD/INC            * Admission special funding file
          INC       PATBFEFD/INC            * Bed fee file
          INC       PATCDEFD/INC            * Casemix data extract file
          INC       PATCMPFD/INC            * Complex mapping file
          INC       PATCMXFD/INC            * Casemix funding file
          INC       PATCONFD/INC            * Control file
          INC       PATDGWFD/INC            * DRG desc/weight file
          INC       PATDSCFD/INC            * Disch file
          INC       PATECDFD/INC            * Episode disease coding file
          INC       PATECMFD/INC            * Episode Morbidity Changes
          INC       PATECOFD/INC            * Episode operation coding file
          INC       PATFN1FD/INC            * Health fund file
          INC       PATHDFFD/INC            * Daily fee for inliers
          INC       PATHLFFD/INC            * Lumpsum for overnight
          INC       PATHSPFD/INC            *
          INC       PATICDFD/INC            * ICD9 disease file
          INC       PATICOFD/INC            * ICD9 operation file
          INC       PATICUFD/INC            * ICU file
          INC       PATLDFFD/INC            * Daily fee for low outliers
          INC       PATLSDFD/INC            * Lumpsum for same day
          INC       PATMA1FD/INC            * Master file
          INC       PATMI1FD/INC            * Admin file
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATWR1FD/INC
          INC       PMSBRQFD/INC
          INC       PMSEDGFD/INC            * Effective DRG Dates
          INC       PMSHCPFD/INC
          INC       PMSVX1FD/INC            * Visit extension file
          INC       PATPGRFD/INC            * Patient grouper file
          INC       PATTRNFD/INC            * Transfer file
          INC       PATW11FD/INC            * Victorian cost weights (03/04)
          INC       PATW12FD/INC            * Victorian cost weights (04/05)
          INC       PTW12BFD/INC            * Victorian cost weights (05/06)
          INC       PATW13FD/INC            * Victorian cost weights (06/07)
          INC       PATW14FD/INC            * Victorian cost weights (07/08)
          INC       PATW15FD/INC            * Victorian cost weights (08/09)
          INC       PATW16FD/INC            * Victorian cost weights (09/10)
          INC       PATW17FD/INC            * Victorian cost weights (10/11)
          INC       PATW18FD/INC            * Victorian cost weights (11/12)
          INC       PATW19FD/INC            * Victorian cost weights (12/13)
          INC       PATW20FD/INC            * Victorian cost weights (13/14)
          INC       PATW21FD/INC            * Victorian cost weights (14/15)
          INC       PATWIEFD/INC            * Victorian cost weights (15/16)
          INC       PATRDCFD/INC
          INC       PATCFAFD/INC
          INC       PATFX1FD/INC
          INC       PATONLFD/INC
          INC       PMSCIDFD/INC            * Contract ID
.
          INC       MRTCONFD/INC
          INC       PATMMBFD/INC
          INC       VISXDCFD/INC
          INC       WEBSECFD/INC
.
.         Web includes
.
          INC       WEBDINVS/INC
          INC       PMSPX2FD/INC 
.
. ----- Program Tempfiles -----
.
TEMPA     IFILE     SQL, FIXED=65, KEY="U1-8"
KEYA      INIT      " 65 U1-8"
PRFIXA    INIT      "pms99a"
.
.Name     Type   Length  Phys.  Start  Description
.-------  -----  ------  -----  -----  ---------------------------------
XAADMN    DIM       8       8      1    Admission Number
XNAME40   DIM       40     40      9    Patients Name
XADATE8   DIM       8       8     49    Admission date ccyymmdd
XDDATE8   DIM       8       8     57    Discharge date ccyymmdd
.
.End of Record                    65
.
.INPUT FILE LAYOUT FOR THE AUSTRALIAN GROUPER 
.--------------------------------------------
INPFILE   FILE      ASCII, FIXED=200
.
.Name     Type   Length  Start  Description
.-------  -----  ------  -----  --------------------------------------
DRGADMN   DIM       8       1   Admission number
DRGADAT   DIM      10       9   Admission date (dd/mm/ccyy)
DRGATIM   DIM       2      19   Admission time (hh)
DRGDDAT   DIM      10      21   Discharge date (dd/mm/ccyy)
DRGDTIM   DIM       2      31   Discharge time (hh)
DRGBDAT   DIM      10      33   Birth date (dd/mm/ccyy)
DRGAGEY   DIM       3      43   Age in years (if > 364 days)
DRGAGED   DIM       3      46   Age in days (if <= 364 days)
DRGSEX    DIM       1      49   Sex
DRGSEP    DIM       2      50   Separation mode
DRGAWHT   DIM       4      52   Admission weight
DRGILOS   DIM       1      56   Intended los
.                                 0 = not entered
.                                 1 = same day
.                                 2 = overnight
DRGHMV    DIM       4      57   Hours on mechanical ventiliation
DRGALOS   DIM       4      61   Acute los
DRGDIAG   DIM       5      65   Primary diagnoses
DRGSD01   DIM       5      70   Secondary diagnosis 1
DRGSD02   DIM       5      75   Secondary diagnosis 2
DRGSD03   DIM       5      80   Secondary diagnosis 3
DRGSD04   DIM       5      85   Secondary diagnosis 4
DRGSD05   DIM       5      90   Secondary diagnosis 5
DRGSD06   DIM       5      95   Secondary diagnosis 6
DRGSD07   DIM       5     100   Secondary diagnosis 7
DRGSD08   DIM       5     105   Secondary diagnosis 8
DRGSD09   DIM       5     110   Secondary diagnosis 9
DRGSD10   DIM       5     115   Secondary diagnosis 10
DRGSD11   DIM       5     120   Secondary diagnosis 11
DRGSD12   DIM       5     125   Secondary diagnosis 12
DRGSD13   DIM       5     130   Secondary diagnosis 13
DRGSD14   DIM       5     135   Secondary diagnosis 14
DRGOPER   DIM       4     140   Primary operation
DRGSO01   DIM       4     144   Secondary operation code 1
DRGSO02   DIM       4     148   Secondary operation code 2
DRGSO03   DIM       4     152   Secondary operation code 3
DRGSO04   DIM       4     156   Secondary operation code 4
DRGSO05   DIM       4     160   Secondary operation code 5
DRGSO06   DIM       4     164   Secondary operation code 6
DRGSO07   DIM       4     168   Secondary operation code 7
DRGSO08   DIM       4     172   Secondary operation code 8
DRGSO09   DIM       4     176   Secondary operation code 9
DRGSO10   DIM       4     180   Secondary operation code 10
DRGSO11   DIM       4     184   Secondary operation code 11
DRGSO12   DIM       4     188   Secondary operation code 12
DRGSO13   DIM       4     192   Secondary operation code 13
DRGSO14   DIM       4     196   Secondary operation code 14
.
.End of Record            200
.
. UPLOAD FILE LAYOUT FOR THE AUSTRALIAN GROUPER 
. ---------------------------------------------
OUTFILE   FILE      ASCII, FIXED=130
.
.Name     Type   Length  Start  Description
.-------  -----  ------  -----  ------------------------------------
.DRGADMN  DIM       8       1   Admission number
DRGDRG    DIM       3       9   Diagnostic Related Group (DRG)
DRGDRGD   DIM       50     12   DRG description
DRGMDC    DIM       3      62   Major Diagnostic Category (MDC)
DRGMDCD   DIM       50     65   MDC description
DRGCCL    DIM       1     115   CC class level
DRGNATWT  DIM       9     116   DRG national weight
DRGGRP    DIM       3     125   Grouper version used
DRGRET    DIM       2     128   Grouper Return Code
.
.End of Record            130
.
. ----- Program Variables -----
.
.******************************************** moved to WEBGRPVA
...DRGO41FN  DIM       12      * DRG 4.1 Batch file name
...DRGO42FN  DIM       12      * DRG 4.2 Batch file name
...DRGO50FN  DIM       12      * DRG 5.0 Batch file name
...DRGO51FN  DIM       12      * DRG 5.1 Batch file name
...DRGO52FN  DIM       12      * DRG 5.2 Batch file name
.
...DRG041    INIT      "041"
...DRG042    INIT      "042"
...DRG050    INIT      "050"
...DRG051    INIT      "051"
...DRG052    INIT      "052"
.******************************************** moved to WEBGRPVA
.
TAGCODE   DIM       4       * Tag Code
MDCCODE   DIM       3       * MDC code
DRGCODE   DIM       3       * DRG code
.
ADMISS01  DIM       8
ADMISS02  DIM       8
ADMISS03  DIM       8
ADMISS04  DIM       8
ADMISS05  DIM       8
ADMISS06  DIM       8
ADMISS07  DIM       8
ADMISS08  DIM       8
ADMISS09  DIM       8
ADMISS10  DIM       8
ADMISS11  DIM       8
ADMISS12  DIM       8
ADMISS13  DIM       8
ADMISS14  DIM       8
ADMISS15  DIM       8
ADMISS16  DIM       8
ADMISS17  DIM       8
ADMISS18  DIM       8
ADMISS19  DIM       8
.
CODEFLG   FORM      1
CMDLINE   DIM       227
CMPCNT    FORM      1
COD1CNT   FORM      3
COD9CNT   FORM      2
CALDAYS   FORM      6
CALLPOSN  FORM      1
CFNAMEA   DIM       8
CHECKDRG  DIM       2
CHKTYPE   DIM       1                       * Disease to check for
CNTADMN   FORM      2                       * Number of admin for batch entry
CNTERRS   FORM      5                       * Number of errors
CNTRECS   FORM      5                       * Number of records
CURRDATE  DIM       8                       * Current Date
.
DATE10A   DIM       10
DATE10B   DIM       10
DIM3      DIM       3
DIM4      DIM       4
DRGERR    DIM       37
DIM18     DIM       18
DIM18A    DIM       18
DIM20A    DIM       20
DIM30     DIM       30
DAYCOL    FORM      4
.
ESC       INIT      27
.
FORM5     FORM      5
FORM8     FORM      8
FRDATE8   DIM       8
.
NMPNUMB   DIM       20
.
SAVKEY10  DIM       10
UPDTTYPE  DIM       1       * Update Type
WAHPDATE  FORM      1         * WA Health procedure date test
WDATE1    DIM       8
WDATE2    DIM       8
.
INTVER    FORM      1
MAPFILE   FORM      1                       * Mapping file flag, 0 - doesn't
.                                                  1 - exists
OPTION2   FORM      1                       * Which extract option
.
RTDAYS    FORM      4
.
TODATE8   DIM       8
TODAY     DIM       8                       * Current date
.
VMDILIST  DIM       4                       * Valid types for medical diseases
WCFINPFN  DIM       22       * Web Codefinder input filename
WCFOUTFN  DIM       22       * Web Codefinder output filename
.
. ----- Program Constants -----
.
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODED     INIT      "D "
CODEDD    INIT      "DD"
CODEP     INIT      "P "
.
ISERASE   INIT      "iserase "
INVCODE   INIT      "Invalid Return Code : "   
.
.----- 3.1 errors -----
.
RET01     INIT      "01 Diag code cant be used as pri diag"
RET02     INIT      "02 Doesnt meet criteria for any DRG  "
RET03     INIT      "03 Invalid age admin birth disch date"
RET04     INIT      "04 Invalid gender                    "
RET05     INIT      "05 Invalid separation mode           "
RET06     INIT      "06 Invalid admission weight          "
RET07     INIT      "07 Invalid age in days at discharge  "
RET08     INIT      "08 Invalid or missing principal diag "
RET09     INIT      "09 Invalid length of stay            "
RET10     INIT      "10 Invalid hours on mechanical vent  "
.
.----- 4.1 errors -----
.
XRET01    INIT      "01 Invalid or missing principal diag "
XRET02    INIT      "02 Diag code cant be used as pri diag"
XRET03    INIT      "03 Doesnt meet criteria for any DRG  "
XRET04    INIT      "04 Invalid age admin birth disch date"
XRET05    INIT      "05 Invalid gender                    "
XRET06    INIT      "06 Invalid separation mode           "
XRET07    INIT      "07 Invalid admission weight          "
XRET08    INIT      "08 Invalid length of stay            "
XRET09    INIT      "09 Invalid same-day or intended LOS  "
.
+
.
. ----- For Character to Web Migration variables ---
.
PROCCODE  DIM       7
DISECODE  DIM       5
DSSCODE   DIM       9       * Disease/operation code
ICDCODE   DIM       9       * Disease/operation code
..ICDCDESC  DIM      100      * Code description (now in WEBGRPVA.INC)
DISTYPE   DIM       1       * Disease type
OPERCLIN  DIM       10
OPERTYPE  DIM       1       * Operation type
OPERDATE  DIM       8       * Operation date (CCYYMMDD)
OPERSTME  DIM       5       * Operation start time
OPERETME  DIM       5       * Operation finish time
OPRCODE   DIM       9       * Operation code
DOCTCODE  DIM       6       * Doctor Code
EPSCD001  FORM      2       * Episode No
FILENAM1  DIM       8
FILENAM2  DIM       8
FILENAM3  DIM       8
FILENAM4  DIM       8
ENCFILEF  FILE      ASCII,FIXED=256
ENCOUTAF  FILE      ASCII,FIXED=256
ENCODERF  DIM       1
COUNTFL   FORM      1
DRGOUTFN  DIM       12
ENCOUTFN  DIM       12
LASTDIAG  FORM      3       * Last Item of Diagnosis array
LASTPROC  FORM      3       * Last Item of Procedure array
COUNTER   FORM      3
DRGINP    INIT      "drginp"
ENCINP    INIT      "encinp"
ENCDSP    DIM       2
NOOFCODE  FORM      2
DISCOUNT  FORM      2       * Diagnosis Code Counter
LOADNAME  DIM       8
LOADFILE  FILE      ASCII,FIXED=200
LOADCNT   FORM      3
SVEOCLIN  DIM       10
...CODELINE  DIM       13   * (now in WEBGRPVA.INC)
ENCERR01  INIT      "Backup at Key Word Prompt               "
ENCERR02  INIT      "Abort at Key Word Prompt                "
ENCERR03  INIT      "No Entry at Key Word Prompt             "
ENCERR04  INIT      "Next at Key Word Prompt                 "
ENCERR05  INIT      "Invalid File Format                     "
ENCERR06  INIT      "Bad Command or Command Unauthorised     "
ENCERR07  INIT      "Error Opening Interface Input File      "
ENCERR08  INIT      "Error Opening Interface Output File     "
ENCERR09  INIT      "Output File Already Exists              "
ENCERR10  INIT      "Invalid DRG / Fiscal Year               "
ENCERR12  INIT      "Invalid Codes Passed to Application     "
ENCERR34  INIT      "Not Authorised                          "
ENCERR37  INIT      "Invalid or No Age in Input File         "
ENCERR38  INIT      "Invalid or No Gender in Input File      "
ENCERR39  INIT      "Invalid or Not Integrated in Input File "
ENCERR40  INIT      "Invalid or No State in Input File       "
ENCERR41  INIT      "Invalid or No Payor in Input File       "
ENCERR42  INIT      "Invalid Discharge Date in Input File    "
CODETYPE  DIM       1       * Type of code, O - operation
.                                           D - disease
TYPOFCOD  DIM       2
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATVI     INIT      "VI"
.
ADMISSNO  DIM       8
BJDAY     FORM      3
CJDAY     FORM      3
CDYSTDTE  DIM       8
CDYSDAYS  FORM      8
CDYSYEAR  FORM      8
CDYSFDTE  DIM       8
DAYCOUNT  FORM      8
HTMLFILE  FIFO      ASCII, FIXED=250
LENGTH    FORM      3
LOOPS     FORM      3
PATFNAME  DIM       50
URNUMBER  DIM       8
USERID    DIM       10
VAR       DIM       127
WEBTITLE  DIM       80
.
MTHNAM3   DIM       3
JAN       INIT      "January"
FEB       INIT      "February"
MAR       INIT      "March"
APR       INIT      "April"
MAY       INIT      "May"
JUN       INIT      "June"
JUL       INIT      "July"
AUG       INIT      "August"
SEP       INIT      "September"
OCT       INIT      "October"
NOV       INIT      "November"
DEC       INIT      "December"
CBB       INIT      ")"
OBB       INIT      "("
.
.---------------------------------------------------------------------
PRGID     INIT      "IBAPMS99"
PRGNAM    INIT      "DRG Grouper Interface"
VERSION   INIT      "V12.00.02"
.---------------------------------------------------------------------
.
+
.*********************************************************************
.                   MAINLINE
.         Mainline Code / Controlling Logic
.*********************************************************************
ML0000    CALL      INIT0000
          BRANCH    EXIT,ML9999
.
.
ML1000    CALL      OPTN0000
          BRANCH    COPTION,ML2000,ML4000
          GOTO      ML9999
.
ML2000    MOVE      ONE,FILRFGRP            * File returned from grouper flag
          CALL      EXTR0000                * extract the data
          BRANCH    FILRFGRP,ML1000         * No file returned from grouper
.
ML4000    CALL      ALLC0000                * allocate DRG's
          GOTO      ML1000
.
ML9999    CALL      CLICD1                  * Close ICD files 
          CHAIN     PGM
+
.*********************************************************************
.         initilization
.*********************************************************************
INIT0000  CALL      DISPHEAD
.
          DISPLAY   *P50:24,"Opening patasfaf";
          OPEN      PATASFA1,"patasfaf"
.
          DISPLAY   *P58:24,"websecaf";
          OPEN      WEBSECA1,"websecaf"
.
          DISPLAY   *P58:24,"patcdeaf";
          OPEN      PATCDEA3,"patcdeaf"
.
          DISPLAY   *P58:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P58:24,"patdschf"
          OPEN      PATDSCH1,"patdschf"
.
          DISPLAY   *P58:24,"patecdaf"
          OPEN      PATECDA1,"patecdaf"
.
          DISPLAY   *P58:24,"patecmaf"
          OPEN      PATECMA1,"patecmaf"
.
          DISPLAY   *P58:24,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
.
          DISPLAY   *P58:24,"patecdaf"
          OPEN      PATECDA3,"patecdaf"
.
          DISPLAY   *P58:24,"patecdaf"
          OPEN      PATECDA5,"patecdaf"
.
          DISPLAY   *P58:24,"patecoaf"
          OPEN      PATECOA1,"patecoaf"
.
          DISPLAY   *P58:24,"patecoaf"
          OPEN      PATECOA2,"patecoaf"
.
          DISPLAY   *P58:24,"patecoaf"
          OPEN      PATECOA3,"patecoaf"
.
          DISPLAY   *P58:24,"patmmbsf"
          OPEN      PATMMBS1,"patmmbsf"
.
          DISPLAY   *P58:24,"pathspaf"
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P58:24,"pati10df"
          OPEN      PATI10D1,"pati10df"
.
          DISPLAY   *P58:24,"pati10of"
          OPEN      PATI10O1,"pati10of"
.
          DISPLAY   *P58:24,"paticddf"
          OPEN      PATICDD1,"paticddf"
.
          DISPLAY   *P58:24,"paticdof"
          OPEN      PATICDO1,"paticdof"
.
          DISPLAY   *P58:24,"paticuaf"
          OPEN      PATICUA1,"paticuaf"
.
          DISPLAY   *P58:24,"patma1af"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P58:24,"patmi1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A4,"patmi1af"
.
          DISPLAY   *P58:24,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P58:24,"pmshcpaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P58:24,"pmsvx1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P58:24,"patpgraf"
          OPEN      PATPGRA1,"patpgraf"
.
          DISPLAY   *P58:24,"patrdcaf"
          OPEN      PATRDCA1,"patrdcaf"
.
          DISPLAY   *P56:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P56:24,"pmsedgaf";
          OPEN      PMSEDGA1,"pmsedgaf"     * Effective DRG
          OPEN      PMSEDGA2,"pmsedgaf"     * Effective DRG
.
          DISPLAY   *P56:24,"patfn1af";
          OPEN      PATFN1A1,"patfn1af"
.
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRTSMA1,"oprtsmaf"
.
...       DISPLAY   *P56:24,"patvw7af";                                *D-51504
...       OPEN      PATVW7A1,"patvw7af"                                *D-51504
.
          DISPLAY   *P58:24,"controlf"
          OPEN      CONTROLF,"controlf"
.
.         *  Call to get program variables not available in WEB
.
          CALL      IBACLOCK           * get TODAY                     *C-50344
          CALL      OPICD1             * open ICD10 Desease            *C-50344
          CALL      OPICO1             * open ICD10 Operations         *C-50344
          CLOCK     PORT,PORT          * get PORT                      *C-50344
.
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          PACK      CFNAMEA,PRFIXA,PORT
          REP       " 0",CFNAMEA
          READ      CONTROLF,TEN;*37,CMOPRT,*105,PTCNU50G:             *C-50344
                                 *132,PTCNU60G:                       *I-197814
                                 *140,PTCNU51G,*144,PTCNU52G:         *I-137125
                                 *152,PTCNU62G:                       *I-267797
                                 *235,CMDISP,*236,CMDISS,*237,CMDISC:
                                 *238,CMDISA
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM
          READ      CONTROLF,SIXTY;*133,MRCNEPSC,*248,MRCN3MCD,*249,MRCN3MCG
          READ      CONTROLF,SIXTY1;*240,MRCNUNWA,*241,MRCNENWA
          READ      CONTROLF,EIGHTY;*243,PTCNODRG,*250,PTCNHDPS
          READ      CONTROLF,SEVENTY7;*220,PTCNEDRG
          READ      CONTROLF,SEVENTY9;*82,PTCNDSCI
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*241,PTCNCSTA,*242,PNSWRACE
          READ      CONTROLF,NINTY7;*145,MRCNGRUP,*174,MRCNCLIN,*245,MRCNDFPR:
                                    *248,MRCNEACA,*251,MRCNSCTC
          READ      CONTROLF,NINTY7;*244,MRCNRDSG
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND05;*147,CMDISM,*158,PTCNDGPV:
                                    *161,PTCNU31G,*162,PTCNU41G:
                                    *163,PTCNU42G
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND05;*217,PTCNGDV4,*227,PTCNGDV5       *C-105244
          READ      CONTROLF,HUND12;*239,PTCNGDV6                     *I-163918
          READ      CONTROLF,HUND10;*61,PTCNGDV7,*69,PTCNGDV8:        *I-284420
                                    *77,PTCNGDV9,*85,PTCNGDVX         *I-0833093
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,HUND19;*183,PTCNED41,*191,PTCNED42,*199,PTCNED50:
                                    *207,PTCNED51,*215,PTCNED52,*223,PTCNED60:
                                    *231,PTCNED62,*239,PTCNED70       *I-284669
          READ      CONTROLF,HUND20;*232,PTCNED80,*240,PTCNC80C
          READ      CONTROLF,HUND23;*232,PTCNED90,*240,PTCNC90C       *0852793
          READ      CONTROLF,HUND24;*121,PTCNDGED,*224,PTCNE100,*232,PTCN100C
          READ      CONTROLF,HUND28;*231,PTCNGDX2                     *I-0917793
          READ      CONTROLF,HUND28;*239,PTCNE110,*247,PTCN110C
          READ      CONTROLF,HUND30;*86,PTCNGDX3                      *I-0956210
          READ      CONTROLF,HUND30;*94,PTCNE120,*102,PTCN120C        *I-0956210
          READ      CONTROLF,HUND31;*1,MRCNDCID
.
          COMPARE   TWO,MRCNGRUP
          GOTO      INIT9500 IF EQUAL       * using CCA interface?
.
          PACK      VMDILIST,CMDISP,CMDISS,CMDISC,CMDISA
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PAT3MIA1,"pat3miaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,MAPFILE          * 3M mapping file does not exist
          ELSE
            MOVE      ONE,MAPFILE           * 3M mapping file does exist
          ENDIF
.
          CALL      DISPHEAD
          DISPLAY   *P1:3,*EF:
                    *P1:10,"Enter User Id. : "
.
          KEYIN     *P18:10,*V2LON,USERID
          PACK      KEY10,USERID,SP70
          MOVE      USERID,KEY10
          CALL      RDWBSE1
.
INIT9000  MOVE      ZERO,EXIT
          GOTO      INIT9999
.
INIT9500  CALL      UCCA0000
          MOVE      ONE,EXIT                * using CCA interface so exit
.
INIT9999  RETURN
+
.----------------------------------------------------------------
. Using CCA Interface for coding/grouping so exit program
.----------------------------------------------------------------
UCCA0000  MOVE      ZERO,CLNO
          MOVE      ZERO,CPAGENO
          CALL      HEAD132
.
          PRINT     *N
          PRINT     "** Interface is set to use CCA, this report option is not available **"
          PRINT     *N
.
          CALL      UND132
          PRINT     *55,"***** END OF REPORT *****"
.
UCCA9999  RETURN
+
.*********************************************************************
.         enter program option
.*********************************************************************
OPTN0000  CALL      DISPHEAD
.
          MATCH     "031",PTCNDGPV
          GOTO      OPTN2000 IF NOT EQUAL
.
          DISPLAY   *P1:3,*EL:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Extract Patients to be Grouped":
                    *P1:6,*V2LON,"2",*HOFF," = Allocate DRG's":
                    *P1:8,"Select option : "
.
.
OPTN1000  KEYIN     *P17:8,*DV,UNDLN1,*P17:8,*V2LON,COPTION;
.
          COMPARE   ZERO,COPTION
          GOTO      OPTN9500 IF EQUAL
.
          BRANCH    COPTION,OPTN9000,OPTN9000
.
          BEEP
          GOTO      OPTN1000
.
OPTN2000  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Extract Patients to be Grouped":
                    *P1:7,"Select option : "
.
OPTN3000  KEYIN     *P17:7,*DV,UNDLN1,*P17:7,*V2LON,COPTION;
.
          COMPARE   ZERO,COPTION
          GOTO      OPTN9500 IF EQUAL
.
          BRANCH    COPTION,OPTN9000
.
          BEEP
          GOTO      OPTN3000
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
OPTN9999  RETURN
+
.*********************************************************************
.                   EXTR0000                                       
.         extract the patients to be grouped
.*********************************************************************
EXTR0000  MOVE      ZERO,OPTION2
          DISPLAY   *P50:2,*V2LON," - Extract Patients ":
                    *P1:9,*EF:
                    *P1:10,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:11,*V2LON,ONE,*HOFF," = Range of Discharge Dates":
                    *P1:12,*V2LON,TWO,*HOFF," = Range of Coding Completion ":
                    "Dates":
                    *P1:13,*V2LON,THREE,*HOFF," = Selected Patients":
                    *P1:15,"Select option : "
.
EXTR1000  KEYIN     *P17:15,*DV,UNDLN1:
                    *P17:15,*V2LON,OPTION2
          BRANCH    OPTION2,EXTR2000,EXTR2000,EXTR2000
.
          COMPARE   ZERO,OPTION2
          GOTO      EXTR9000 IF EQUAL
.
          BEEP
          GOTO      EXTR1000
.
EXTR2000  CALL      KCOD0000                * Coded patients only
.
          CALL      CTPA0000                * create temp file A
          IF        OPTION2=3
            CALL      EBAN0000              * enter batch of admissions
            BRANCH    EXIT,EXTR5000         * exit
.
            GOTO      EXTR4000
          ENDIF
.
          CALL      KDAT0000                * enter date range
          BRANCH    EXIT,EXTR5000           * cancel selected
.
          CALL      CONTQST
          BRANCH    CEXIT,EXTR3000,EXTR5000,EXTR9000
.                         Yes      No       Cancel
.
EXTR3000  DISPLAY   *P1:24,*EL,"Extracting patients ... ";
          PERFORM   OPTION2,EXTA0000,EXTB0000    * do the extraction
.
. ----- Start The Extraction -----
.
EXTR4000  IF        MRCNGRUP=3
            CALL      PRTB0000              * Create TurboGrouper input file
            CALL      DPTL0000              * Display totals
            BRANCH    EXIT,EXTR5000
.
            CALL      RTBG0000              * Call TurboGrouper
            GOTO      EXTR9000
          ENDIF 
.
          MATCH     "031",PTCNDGPV
          IF        @EQUAL
            PREP      INPFILE,"drginp"
            CALL      PRCA0000              * process input temp file
            CALL      DPTL0000              * Display totals
            BRANCH    EXIT,EXTR5000
.
            CALL      RGRP0000              * Run KEA term script
            GOTO      EXTR9000
          ENDIF  
.
          CALL      INP41000                * all other Grouper versions
.
EXTR4400  CALL      P41T0000                * Process the tempfile
          CALL      DPTL0000                * Display totals
          BRANCH    EXIT,EXTR5000
.
.         * check to see if we must Call PC or UNIX Grouper
.
EXTR4500  COMPARE   ONE,MRCNGRUP            * "0"= Unix Grouper "1"= PC Grouper
          IF        @EQUAL
            MOVE      "G",UPDTTYPE
            CALL      RUNPCG00              * Run PC Grouper
          ELSE
            CALL      UNIXGR00              * Run Unix Grouper
          ENDIF
          GOTO      EXTR9000
.
.
EXTR5000  IF        OPTION2=2
            CALL      DTOP0000              * Display the top of the screen
          ENDIF
          GOTO      EXTR0000
.
EXTR9000  CALL      DTPA0000                * delete temp file
EXTR9999  RETURN
+
.*********************************************************************
.                   UNIXGR00
.             Call unix Grouper
.*********************************************************************
UNIXGR00  CLOSE     INPFIL41
.
          MOVE      "drginp",KEY6
          PACK      FILENAM1,KEY6,PORT,SP70
          REP       " 0",FILENAM1
.
          CALL      CHKPR000       * Check the grouper parameters
          BRANCH    EXIT,UNX41999
.
          MOVE      ONE,FILRFGRP       * No file returned
.
.  ***** Run Unix grouper with 12.0 DRG Version *****
UNX120DR  MATCH     PTCNE120,TODATE8      * disc.date > DRG 12.0 effect.date?
          GOTO      UNX110DR IF LESS      * not using 12.0 grouper
.
          MOVE      "dout12",KEY6        * Set up 12.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      "120",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 12.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 12.0 ... Complete. ";
.
.  ***** Run Unix grouper with 11.0 DRG Version *****
UNX110DR  MATCH     PTCNE110,TODATE8      * disc.date > DRG 11.0 effect.date?
          GOTO      UNX100DR IF LESS      * not using 11.0 grouper
.
          MOVE      "dout11",KEY6        * Set up 11.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      "110",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 11.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 11.0 ... Complete. ";
.
.  ***** Run Unix grouper with 10.0 DRG Version *****
UNX100DR  MATCH     PTCNE100,TODATE8      * disc.date > DRG 10.0 effect.date?
          GOTO      UNX90DRG IF LESS      * not using 10.0 grouper
.
          MOVE      "dout10",KEY6        * Set up 10.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      "100",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 10.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 10.0 ... Complete. ";
.
.******************************************** start of addition       *I-284669
UNX90DRG  MATCH     PTCNED90,TODATE8      * disc.date > DRG 9.0 effect.date?
          GOTO      UNX80DRG IF LESS      * not using 9.0 grouper
.
          MOVE      "dout90",KEY6        * Set up 9.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 90",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 9.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 9.0 ... Complete. ";
.
.******************************************** start of addition       *I-284669
UNX80DRG  MATCH     PTCNED80,TODATE8      * disc.date > DRG 8.0 effect.date?
          GOTO      UNX70DRG IF LESS      * not using 8.0 grouper
.
          MOVE      "dout80",KEY6        * Set up 8.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 80",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 8.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 8.0 ... Complete. ";
.  ***** Run Unix grouper with 7.0 DRG Version *****
.
UNX70DRG  MATCH     PTCNED70,TODATE8      * disc.date > DRG 7.0 effect.date?
          GOTO      UNX62DRG IF LESS      * not using 7.0 grouper
.
          MOVE      "dout70",KEY6        * Set up 7.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 70",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 7.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 7.0 ... Complete. ";
.********************************************   end of addition       *I-284669
.
.******************************************** start of addition       *I-267797
.  ***** Run Unix grouper with 6.2 DRG Version *****
.
UNX62DRG  MATCH     PTCNED62,TODATE8      * disc.date > DRG 6.2 effect.date?
          GOTO      UNX60DRG IF LESS      * not using 6.2 grouper
.
          MOVE      "dout62",KEY6        * Set up 6.2 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 62",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 6.2 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 6.2 ... Complete. ";
.********************************************   end of addition       *I-267797
.
.******************************************** start of addition       *I-197814
.  ***** Run Unix grouper with 6.0 DRG Version *****
.
UNX60DRG  MATCH     PTCNED60,TODATE8      * disc.date > DRG 6.0 effect.date?
          GOTO      UNX52DRG IF LESS      * not using 6.0 grouper
.
          MOVE      "dout60",KEY6        * Set up 6.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 60",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 6.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 6.0 ... Complete. ";
.********************************************   end of addition       *I-197814
.
.******************************************** start of addition       *I-137125
.  ***** Run Unix grouper with 5.2 DRG Version *****
.
UNX52DRG  MATCH     PTCNED52,TODATE8      * disc.date > DRG 5.2 effect.date?
          GOTO      UNX51DRG IF LESS      * not using 5.2 grouper
.
          MOVE      "dout52",KEY6        * Set up 5.2 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 52",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 5.2 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 5.2 ... Complete. ";
.********************************************   end of addition       *I-137125
.
.******************************************** start of addition        *I-61562
.  ***** Run Unix grouper with 5.1 DRG Version *****
.
UNX51DRG  MATCH     PTCNED51,TODATE8      * disc.date > DRG 5.1 effect.date?
          GOTO      UNX50DRG IF LESS      * not using 5.1 grouper
.
          MOVE      "dout51",KEY6        * Set up 5.1 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 51",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 5.1 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 5.1 ... Complete. ";
.********************************************   end of addition        *I-61562
.
.  ***** Run Unix grouper with 5.0 DRG Version *****                   *I-50344
.
UNX50DRG  MATCH     PTCNED50,TODATE8      * disc.date > DRG 5.0 effect.date?
          GOTO      UNX41031 IF LESS      * not using 5.0 grouper
.
          MOVE      "dout50",KEY6        * Set up 5.0 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      " 50",XDRGGRP    * Set DRG Version
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 5.0 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 5.0 ... Complete. ";
.

.  ***** Run Unix grouper with 4.2 DRG Version *****
.
UNX41031  MATCH     PTCNED42,TODATE8      * disc.date > DRG 4.2 effect.date?
          GOTO      UNX41032 IF LESS      * not using 4.2 grouper
.
          MOVE      "dout42",KEY6        * Set up 4.2 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      "042",XDRGGRP    * Set DRG Version
          REP       "0 ",XDRGGRP     * Set from "0NN" to " NN"
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 4.2 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 4.2 ... Complete. ";
.
.  ***** Run Unix grouper with 4.1 DRG Version *****
.
UNX41032  MATCH     PTCNED41,TODATE8      * disc.date > DRG 4.1 effect.date?
          GOTO      UNX41033 IF LESS      * not using 4.1 grouper
.
          MOVE      "dout41",KEY6        * Set up 4.1 output file
          PACK      FILENAM2,KEY6,PORT,SP70
          REP       " 0",FILENAM2
.
          MOVE      "041",XDRGGRP    * Set DRG Version
          REP       "0 ",XDRGGRP     * Set from "0NN" to " NN"
.
          DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP DRG 4.1 ... "
.
          CALL      EXECUT00         * Execute the UNIX Grouper  (in WEBGROUP)
.
          REP       " 0",XDRGGRP     * Set from " NN" to "0NN"
.
          CALL      UXCHK000         * check to see if anything returned
.
          DISPLAY   *P1:24,*EL,"Grouping QUICKGROUP DRG 4.1 ... Complete. ";
.
UNX41033  DISPLAY   *P1:24,*EL,"Grouping Using QUICKGROUP ... Complete. ";
          CALL      HITENTER
.
UNX41999  RETURN
+
.------------------------------------------------------------
. Check DRG UNIX Grouper Results
.------------------------------------------------------------
UXCHK000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTFILE2,FILENAM2
          TRAPCLR   IO
          BRANCH    OVRCD,UXCHK999
.
          CALL      RDUNIX1                 * Read UNIX Grouper output file
          BRANCH    OVRCD,UXCHK999
.
          MOVE      ZERO,FILRFGRP           * File OK
          CLOSE     OUTFILE2
.
UXCHK999  RETURN
.
+
.*********************************************************************
.*                  KDAT0000                                         *
.*        Enter the date ranges                                      *
.*        Returns : EXIT = 1      exit chosen                        * 
.*********************************************************************
KDAT0000  DISPLAY   *P1:17,"Starting date : ",*EL:
                    *P1:19,"Ending   date : ",*EL;
          MOVE      ONE,CCANLDTE            * blank cancel default
          MOVE      ZERO,CDEFDTE            * enter once for default
          MOVE      ZERO,CHIGHLT            * use highlight
.
.         enter starting date
.
KDAT1000  MOVE      "17",CVERT              * row
          MOVE      "17",CCOL               * column
          UNPACK    SP6,CYEAR,CMON,CDAY     * no defaults
          MOVE      CCC,CCENT
.
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT9000          * nothing entered
          BRANCH    CQUEST,KDAT1000
.
          PACK      FRDATE8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",FRDATE8
          CALL      PACDATE
          MOVE      CPCDATE,DATE10A
          MOVE      FRDATE8,GRPDTE
          MOVE      TODAY,GRPDTE
.
          MATCH     FRDATE8,TODAY
          GOTO      KDAT2000 IF NOT LESS    * date is <= current date
.
          DISPLAY   *P1:24,*B,"Date must not be after current date.  ",*EL;
          CALL      HITENTER 
          GOTO      KDAT1000
.
.         enter ending date (default to starting date)
.
KDAT2000  MOVE      "19",CVERT              * row
          MOVE      "17",CCOL               * column
          UNPACK    FRDATE8,CCENT,CYEAR,CMON,CDAY
.
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT1000          * nothing entered
          BRANCH    CQUEST,KDAT2000
.
          PACK      TODATE8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TODATE8
          CALL      PACDATE
          MOVE      CPCDATE,DATE10B
.
          MATCH     FRDATE8,TODATE8
          GOTO      KDAT3000 IF NOT LESS    * date is <= start date
.
          DISPLAY   *P1:24,*B,"Ending date must be after Starting date.  ",*EL;
          CALL      HITENTER 
          GOTO      KDAT2000
.
.         check end date is before current date
.
KDAT3000  MATCH     TODATE8,TODAY
          GOTO      KDAT8000 IF NOT LESS    * date is <= current date
.
          DISPLAY   *P1:24,*B,"Date must not be after current date.  ",*EL;
          CALL      HITENTER 
          GOTO      KDAT2000
.
KDAT8000  MOVE      ZERO,EXIT               * valid dates
          GOTO      KDAT9999
.
KDAT9000  MOVE      ONE,EXIT                * exit selected
.
KDAT9999  RETURN
+
.*********************************************************************
.*        Coded patients only option
.*********************************************************************
KCOD0000  MOVE      ZERO,CODEFLG
          DISPLAY   *P1:21,*EL,"Coded patients only (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,") ? ";
KCOD1000  MOVE      ANSY,ANS
          KEYIN     *P29:21,*V2LON,*RV,ANS;
          REP       UPPLOW,ANS
          CMATCH    ANSY,ANS
          GOTO      KCOD2000 IF EQUAL
.
          CMATCH    ANSN,ANS
          GOTO      KCOD9999 IF EQUAL
.
          BEEP
          GOTO      KCOD1000
.
KCOD2000  MOVE      ONE,CODEFLG             * Coded patients only
KCOD9999  RETURN
+
.*********************************************************************
.*        Create temp file A
.*********************************************************************
CTPA0000  CALL      DTPA0000                * delete temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISBUILD,CFNAMEA,KEYA,SP30      * set command
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * build the temp file
          OPEN      TEMPA,CFNAMEA           * open the temp file
CTPA9999  RETURN
+
.*********************************************************************
.*        Delete temp file A
.*********************************************************************
DTPA0000  CLOSE     TEMPA                   * close temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISERASE,CFNAMEA * set command line for erase
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * delete the temp file
DTPA9999  RETURN
+
.*********************************************************************
.         get all discharged patients in the date range
.*********************************************************************
EXTA0000  OPEN      PATDSCH2,"patdschf"
          UNPACK    SP70,XNAME40,XADATE8,XDDATE8
          PACK      KEY16,FRDATE8,SP20
          CALL      RDSDSCH2
EXTA1000  CALL      RDKDSCH2
          BRANCH    OVRCD,EXTA9995          * end of file
.
          MATCH     DDATE,TODATE8
          GOTO      EXTA9995 IF LESS        * after end date
.
          PACK      KEY8,DADMNO
          CALL      RDMISS1
          BRANCH    OVRCD,EXTA1000
.
          MATCH     SP3,ATYPE
          GOTO      EXTA1000 IF EQUAL
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the patients code file
          BRANCH    OVRCD,EXTA1000
.
          MATCH     ANSX,TCINDC5
          GOTO      EXTA1000 IF EQUAL       * Exclude from extract
.
          MATCH     ANSB,TCINDC3
          GOTO      EXTA1000 IF EQUAL       * Ignore boarder & unqual patients
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,EXTA1000
.
          IF        CODEFLG = 1
            CALL      CCOD0000              * Check if coded
            BRANCH    EXIT,EXTA1000
          ENDIF
.
          MOVE      ADATE,XADATE8
.
          MOVE      DDATE,XDDATE8
          REP       " 0",XDDATE8
.
          MOVE      DADMNO,KEY8
          READ      TEMPA,KEY8;XAADMN
          GOTO      EXTA1000 IF NOT OVER    * already on file
.
          WRITE     TEMPA,KEY8;KEY8,XNAME40,XADATE8,XDDATE8
          GOTO      EXTA1000
.
EXTA9995  CLOSE     PATDSCH2
EXTA9999  RETURN
+
.*********************************************************************
.         get all discharged patients in the date range who have a
.         coding completed date
.*********************************************************************
EXTB0000  UNPACK    SP70,XNAME40,XADATE8,XDDATE8
          PACK      KEY16,FRDATE8,SP20
          CALL      RDSMISS4
EXTB1000  CALL      RDKMISS4
          BRANCH    OVRCD,EXTB9995          * end of file
.
          MATCH     ACODDTE,TODATE8
          GOTO      EXTB9995 IF LESS        * after end date
.
          COMPARE   THREE,ASTAT
          GOTO      EXTB1000 IF NOT EQUAL   * not discharged
.
          MOVE      AADMNO,KEY8
          READ      TEMPA,KEY8;ANS
          GOTO      EXTB1000 IF NOT OVER    * already on file
.
          WRITE     TEMPA,KEY8;KEY8,XNAME40,XADATE8,XDDATE8
          GOTO      EXTB1000
.
EXTB9995  
EXTB9999  RETURN
+
.*********************************************************************
.         CCOD0000 - Check if patient coded
.*********************************************************************
CCOD0000  MOVE      ZERO,EXIT
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECD2
CCOD1000  CALL      RKPTECD2
          BRANCH    OVRCD,CCOD9000
.
          MATCH     AADMNO,PTEDADMN
          GOTO      CCOD9999 IF EQUAL
.
CCOD9000  MOVE      ONE,EXIT
CCOD9999  RETURN
+
.*********************************************************************
.         enter batch of admission numbers
.*********************************************************************
EBAN0000  DISPLAY   *P1:3,*EF,*V2LON,*ULON:
                    *P1:4,"Cnt",*P6:4,"Visit No":
                    *P16:4,"Name                                    ":
                    *P58:4," Admitted ",*P70:4,"Discharge "
.
          MOVE      "99999999",GRPDTE
          MOVE      ONE,CNTADMN             * clear count
          MOVE      FIVE,CVERT
.
EBAN1000  CALL      KVIS0000                * enter visit numbers
.
EBAN2000  CALL      RTPA0000
          BRANCH    EXIT,EBAN9500,EBAN4000
.                        Cancel   Add

          MOVE      SP8,KEY8
          READ      TEMPA,KEY8;;
EBAN3000  READKS    TEMPA;XAADMN,XNAME40,XADATE8,XDDATE8
          GOTO      EBAN9000 IF OVER
.
          MATCH     GRPDTE,XDDATE8
          IF        @LESS
            MOVE      XDDATE8,GRPDTE
          ENDIF
          GOTO      EBAN3000
.
EBAN4000  MOVE      ONE,CNTADMN             * set for a new page
          MOVE      "23",CVERT
          GOTO      EBAN1000
.
EBAN9000  MOVE      ZERO,EXIT
          GOTO      EBAN9999
.
EBAN9500  MOVE      ONE,EXIT
EBAN9999  RETURN
+
.******************************************************************************
.*                                 RGRP0000                                   *
.*                            Run KEA term script                             *
.******************************************************************************
RGRP0000  COMPARE   ONE,PTCNODRG
          GOTO      RGRP9000 IF NOT EQUAL
.
RGRP1000  KEYIN     *P1:24,*EL,"Are you running the DRG grouper on this PC (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
          REP       "yYnN",ANS
.
          MATCH     ANSN,ANS
          GOTO      RGRP9000 IF EQUAL       * Don't run grouper
.
          MATCH     ANSY,ANS
          GOTO      RGRP2000 IF EQUAL       * Run grouper
.
          BEEP
          GOTO      RGRP1000
.
. ----- Esc sequence to check if KEA term connection is established -----
.
RGRP2000  MOVE      SP2,CHECKDRG
          DISPLAY   *P1:24,*EL,"Grouping ... ",*RAWON,ESC,"[4;01.z"
.
. If connection is established, "OK" will be returned in the value CHECKDRG.
. Otherwise spaces will be in CHECKDRG, and no connection to KEA term & the
. DRG grouper will be established.
.
          KEYIN     *P14:24,*EOFF,*T2,CHECKDRG,*EON
          MATCH     "OK",CHECKDRG
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*B,"DRG grouper is not set up on this ":
                      "connection.   ";
            CALL      HITENTER
            GOTO      RGRP9000
          ENDIF
.
          MOVE      "0",HLEF
          CALL      GETSCR00
.
          DISPLAY   *P1:24,*EL,"Grouping ... ",*RAWON,ESC,"[4;03.z"
          MOVE      "kermit -x > /dev/null",CMDLINE
          PACK      CMDLINE,CMDLINE,SP30,SP30
          EXECUTE   CMDLINE,TASKID
.
RGRP4000  CALL      PUTSCR00
.
RGRP9000  MOVE      ZERO,EXIT
RGRP9999  RETURN
+
.*********************************************************************
.         enter the visit number
.*********************************************************************
KVIS0000  COMPARE   "23",CVERT
          GOTO      KVIS0100 IF LESS        * continue 
.
          MOVE      FIVE,CVERT
          DISPLAY   *P1:CVERT,*EF;
.
KVIS0100  DISPLAY   *P1:CVERT,*V2LON,CNTADMN,*HOFF,"."
.
KVIS1000  MOVE      SP70,DIM8VISN
          KEYIN     *P6:CVERT,*DV,UNDLN8:
                    *P6:CVERT,*V2LON,DIM8VISN:
                    *P6:CVERT,*DV,DIM8VISN
          MATCH     SP70,DIM8VISN
          GOTO      KVIS9999 IF EQUAL       * exit
.
          MOVE      DIM8VISN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,KVIS9000          * invalid visit number
.
          CALL      RDDSCH1
          BRANCH    OVRCD,KVIS9100          * invalid visit number
.
          MOVE      SP25,PGNAME
          MOVE      SP20,PSNAME
          MOVE      SP4,PTITL
          MOVE      AURNO,KEY8              * r5.01
          CALL      RDMAST1
          BRANCH    OVRCD,KVIS9200          * invalid UR
.
          IF        CODEFLG = 1
            CALL      CCOD0000              * Check if coded
            BRANCH    EXIT,KVIS9400
          ENDIF
.
          MOVE      AADMNO,KEY8
          READ      TEMPA,KEY8;ANS
          GOTO      KVIS9300 IF NOT OVER    * number exists
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,XNAME40        * shorten name
.
          MOVE      ADATE,XADATE8
          MOVE      DDATE,XDDATE8
.
          UNPACK    XADATE8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P16:CVERT,XNAME40,*P58:CVERT,CPCDATE;
.
          UNPACK    XDDATE8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P70:CVERT,CPCDATE
.
          WRITE     TEMPA,KEY8;KEY8,XNAME40,XADATE8,XDDATE8
          ADD       ONE,CVERT
          ADD       ONE,CNTADMN
          GOTO      KVIS0000
.
KVIS9000  DISPLAY   *P1:24,*B,"Invalid Visit Number.  ",*EL;
          CALL      HITENTER
          GOTO      KVIS1000
KVIS9100  DISPLAY   *P1:24,*B,"Patient is not discharged.  ",*EL;
          CALL      HITENTER
          GOTO      KVIS1000
KVIS9200  DISPLAY   *P1:24,*B,"Invalid U/R Number.  ",*EL;
          CALL      HITENTER
          GOTO      KVIS1000
KVIS9300  DISPLAY   *P1:24,*B,"Visit Number already entered.  ",*EL;
          CALL      HITENTER
          GOTO      KVIS1000
KVIS9400  DISPLAY   *P1:24,*B,"Visit Number NOT coded.  ",*EL;
          CALL      HITENTER
          GOTO      KVIS1000
.
KVIS9999  RETURN
+
.*********************************************************************
.         clear the storage array
.*********************************************************************
CLRA0000  MOVE      ZERO,FORM2
CLRA1000  ADD       ONE,FORM2
          COMPARE   TEN9,FORM2
          GOTO      CLRA9999 IF NOT LESS
          STORE     ZERO,FORM2,ADMISS01,ADMISS02,ADMISS03,ADMISS04,ADMISS05:
                               ADMISS06,ADMISS07,ADMISS08,ADMISS09,ADMISS10:
                               ADMISS11,ADMISS12,ADMISS13,ADMISS14,ADMISS15:
                               ADMISS16,ADMISS17,ADMISS18,ADMISS19
          GOTO      CLRA1000
CLRA9999  RETURN
+
.*********************************************************************
.         redisplay visit numbers entered from temp file
.*********************************************************************
RTPA0000  DISPLAY   *P1:5,*EF;
          MOVE      ZERO,CNTADMN
          MOVE      FOUR,CVERT
          MOVE      ONE,CPAGENO
          MOVE      SP8,KEY8
          READ      TEMPA,KEY8;;
. 
RTPA1000  READKS    TEMPA;XAADMN,XNAME40,XADATE8,XDDATE8
          GOTO      RTPA5000 IF OVER
.
          ADD       ONE,CVERT
          COMPARE   TWENTY3,CVERT
          GOTO      RTPA4000 IF NOT LESS    * need a new page
          ADD       ONE,CNTADMN
.
RTPA3000  UNPACK    XADATE8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DIM10
          UNPACK    XDDATE8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          DISPLAY   *P1:CVERT,*V2LON,CNTADMN,*HOFF,".  ":
                    XAADMN,SP2,XNAME40,SP2,DIM10,SP2,CPCDATE
          STORE     XAADMN,CNTADMN,ADMISS01,ADMISS02,ADMISS03,ADMISS04,ADMISS05:
                                  ADMISS06,ADMISS07,ADMISS08,ADMISS09,ADMISS10:
                                  ADMISS11,ADMISS12,ADMISS13,ADMISS14,ADMISS15:
                                  ADMISS16,ADMISS17,ADMISS18,ADMISS19
          GOTO      RTPA1000
.
. ******* need a new page *******
.
RTPA4000  BRANCH    CPAGENO,RTPA4500        * on first page
RTPA4100  MOVE      ONE,CALLPOSN            * Next & Prev
          CALL      KEYA0000
          BRANCH    EXIT,RTPA9999,RTPA7000,RTPA0000,RTPA6000,RTPA9200
.                        Cancel   Next     First    Delete   Add
          GOTO      RTPA9999               * Post
.
RTPA4500  MOVE      TWO,CALLPOSN            * Next
          CALL      KEYA0000
          BRANCH    EXIT,RTPA9999,RTPA7000,RTPA5900,RTPA6000,RTPA9200
.                        Cancel   Next     First    Delete   Add
          GOTO      RTPA9999               * Post
.
. ******* no more data to display *******
.
RTPA5000  BRANCH    CPAGENO,RTPA5500        * on first page
RTPA5100  MOVE      THREE,CALLPOSN          * Prev
          CALL      KEYA0000
          bRANCH    EXIT,RTPA9999,RTPA5900,RTPA0000,RTPA6000,RTPA9200
.                        Cancel   Next     First    Delete   Add
          GOTO      RTPA9999               * Post
.
RTPA5500  MOVE      FOUR,CALLPOSN           * no paging
          CALL      KEYA0000
          BRANCH    EXIT,RTPA9999,RTPA5900,RTPA5900,RTPA6000,RTPA9200
.                        Cancel   Next     First    Delete   Add
          GOTO      RTPA9999               * Post
.
RTPA5900  BEEP
RTPA5910  BRANCH    CALLPOSN,RTPA4100,RTPA4500,RTPA5100,RTPA5500
.
. ******* delete an item *******
.
RTPA6000  DISPLAY   *P1:24,*EL,"Enter the item to delete : ",*EL;
          KEYIN     *P28:24,*DV,UNDLN2:
                    *P28:24,*V2LON,FORM2:
                    *P28:24,*DV,FORM2
          COMPARE   ZERO,FORM2
          GOTO      RTPA5910 IF EQUAL       * exit
          GOTO      RTPA6100 IF LESS        * negative
.
          COMPARE   TEN9,FORM2
          GOTO      RTPA6100 IF NOT LESS    * too high
.
          LOAD      DIM8VISN,FORM2,ADMISS01,ADMISS02,ADMISS03,ADMISS04,ADMISS05:
                                ADMISS06,ADMISS07,ADMISS08,ADMISS09,ADMISS10:
                                ADMISS11,ADMISS12,ADMISS13,ADMISS14,ADMISS15:
                                ADMISS16,ADMISS17,ADMISS18,ADMISS19
          MOVE      DIM8VISN,KEY8
          READ      TEMPA,KEY8;KEY8
          GOTO      RTPA6100 IF OVER        * invalid
.
          DELETE    TEMPA,KEY8;
          GOTO      RTPA0000
.
RTPA6100  BEEP
          GOTO      RTPA6000
.
. ******* set up for next screen *******
.
RTPA7000  CALL      CLRA0000
          ADD       ONE,CPAGENO
          MOVE      ONE,CNTADMN
          MOVE      FIVE,CVERT
          DISPLAY   *P1:CVERT,*EF;
          GOTO      RTPA3000
.
RTPA9200  MOVE      TWO,EXIT                * add
.
RTPA9999  RETURN
+
.*********************************************************************
.         keyin for line 24 for admission number input
.*********************************************************************
KEYA0000  DISPLAY   *P1:24,*EL,"(":
                    *V2LON,ANSP,*HOFF,")ost, (":
                    *V2LON,ANSC,*HOFF,")ancel, (":
                    *V2LON,ANSD,*HOFF,")elete, (":
                    *V2LON,ANSA,*HOFF,")dd";
          MOVE      "33",CCOL
.
          BRANCH    CALLPOSN,KEYA0100,KEYA0200,KEYA0300,KEYA0400
KEYA0100  DISPLAY   ", (",*V2LON,ANSN,*HOFF,")ext, (":
                    *V2LON,ANSF,*HOFF,")irst";
          ADD       "17",CCOL
          GOTO      KEYA0400
.
KEYA0200  DISPLAY   ", (",*V2LON,ANSN,*HOFF,")ext";
          ADD       EIGHT,CCOL
          GOTO      KEYA0400
.
KEYA0300  DISPLAY   ", (",*V2LON,ANSF,*HOFF,")irst";
          ADD       NINE,CCOL
.
KEYA0400  DISPLAY   " ? ";
          ADD       FOUR,CCOL
.
KEYA1000  KEYIN     *PCCOL:24,*DV,UNDLN2:
                    *PCCOL:24,*V2LON,*JR,DIM2:
                    *PCCOL:24,*DV,DIM2
          TYPE      DIM2
          GOTO      KEYA1500 IF EQUAL       * number entered
.
          UNPACK    DIM2,ANS,ANS
          REP       UPPLOW,ANS
          MOVE      ZERO,EXIT
          MATCH     ANSP,ANS
          GOTO      KEYA9999 IF EQUAL       * post
          REP       "C1N2F3D4A5",ANS
          MOVE      ANS,EXIT                * set exit flag
          TYPE      ANS
          GOTO      KEYA9999 IF EQUAL
.
KEYA1500  BEEP
          GOTO      KEYA1000
.
KEYA9999  RETURN
+
.*********************************************************************
.         Display the top of the screen
.*********************************************************************
DTOP0000  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Extract Patients to be Grouped":
...                 *P1:6,*V2LON,TWO,*HOFF," = Allocate DRG's":
                    *P1:7,"Select option : ",*V2LON,COPTION
DTOP9999  RETURN
+
.*********************************************************************
.         process the temp file
.*********************************************************************
PRCA0000  DISPLAY   *P1:24,*EL,"Adding to DRG file - ":
                    *V2LON,*BLINKON,"Please wait"
          MOVE      ZERO,CNTRECS            * clear counter
          MOVE      SP8,KEY8
          READ      TEMPA,KEY8;;
. 
PRCA1000  READKS    TEMPA;XAADMN,XNAME40,XADATE8,XDDATE8
          GOTO      PRCA9000 IF OVER
.
          ADD       ONE,CNTRECS
          MOVE      XAADMN,DIM8VISN
          CALL      GAUS0000                * Extract info for 3.1 grouper
          CALL      WAUS0000                * Write to file
          GOTO      PRCA1000
.
PRCA9000  MOVE      ZERO,EXIT
PRCA9999  RETURN
+
.*********************************************************************
.                   ALLC0000                                      
.         allocate DRG's
.*********************************************************************
ALLC0000  HLINE     *G37,2,50,80
          DISPLAY   *P50:2,*V2LON," - Allocate DRG's "
          MOVE      "1",CLNO                * set line number
          MOVE      ZERO,CPAGENO
          CALL      IBACLOCK
          MOVE      ZERO,CNTRECS            * clear total counter
          MOVE      ZERO,CNTERRS            * clear error counter
.
          CALL      HEAD0000                * print page header
.
          IF        MRCNGRUP=3
            CALL      LDTB0000              * Load TurboGrouper data
            GOTO      ALLC9000
          ENDIF
.
          MATCH     "031",PTCNDGPV
          IF        @EQUAL
            CALL      PRCB0000              * loop over the file (3.1)
          ELSE
            CALL      A41D0000              * Allocate 4.1/4.2 DRG details
          ENDIF
.
ALLC9000  CALL      TAIL0000                * Print the report tail
.
ALLC9999  RETURN
+
.*********************************************************************
.         format some of the data for a patient
.*********************************************************************
FTPD0000  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DRGADAT         * admission date
          MOVE      ATIME,DRGATIM           * hour of admission time
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DRGDDAT         * discharge date
          MOVE      DTIME,DRGDTIM           * hour of discharge time
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * format patient name
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DRGBDAT         * date of birth
          REP       " 0",DRGBDAT
          MOVE      PSEX,DRGSEX             * sex
.
FTPD9999  RETURN
+
.*********************************************************************
.         print a page header
.*********************************************************************
HEAD0000  CALL      HEAD132
          CALL      UND132
          PRINT     *1,"|U/R No",*10,"|Admin No",*19,"|Patients Name":
                    *44,"|Admitted",*55,"|Disch'd",*66,"|DRG":
                    *71,"|MDC",*75,"|DSI",*79,"|Nat DRG Wt":
                    *90,"|VGU",*94,"|Comments",*132,"|"
          CALL      UND132
          ADD       "3",CLNO
HEAD9999  RETURN
+
.*********************************************************************
.         print a line of the report
.*********************************************************************
PLIN0000  MOVE      PACFNAME,KEY24
          PRINT     *1,"|",AURNO,*10,"|",DRGADMN,*19,"|",KEY24:
                    *44,"|",DRGADAT,*55,"|",DRGDDAT,*66,"|",DRGDRG:
                    *71,"|",DRGMDC,*75,"| ",DRGCCL,*79,"| ",DRGNATWT:
                    *90,"|",DRGGRP,*94,"|",DRGERR,*132,"|"
          ADD       ONE,CNTRECS
          ADD       ONE,CLNO
          IF        CLNO>=FIFTY5
            CALL      HEAD0000
          ENDIF
PLIN9999  RETURN
+
.*********************************************************************
. GAUS0000 : get the info for the AUSTRALIAN extract file
. Para's   : DIM8VISN      the visit number
.            CNTADMN       counter of items written to file
.*********************************************************************
GAUS0000  CALL      CAUS0000                * clear variables
.
          MOVE      DIM8VISN,KEY8
          CALL      RDMISS1
          CALL      RDDSCH1
          MOVE      SP25,PGNAME
          MOVE      SP20,PSNAME
          MOVE      SP4,PTITL
          MOVE      AURNO,KEY8
          CALL      RDMAST1
.
          MOVE      AADMNO,DRGADMN          * admission number
.
          CALL      FTPD0000                * get some details formatted
.
          PACK      AGEDATE,ADATE
          CALL      CALCAGE                 * Calculate patients age
          IF        PSAGEDAY>364
            MOVE      PSAGEYRS,DRGAGEY
          ELSE
            MOVE      PSAGEDAY,FORM3
            MOVE      FORM3,DRGAGED
          ENDIF
.
          MOVE      SP1,TCINDC5
          IF        PTCNDRSM=1
            PACK      KEY5,CODED,DSTAT
          ELSE
            PACK      KEY5,CODEDD,DDEST
          ENDIF
          CALL      RDCODE1
.
          PACK      DRGSEP,ZERO,TCINDC5     * separation mode
          IF        PSAGEDAY<=364
            MOVE      ZERO,FORM4
            UNPACK    ABWGHT,DIM2,DIM4
            MOVE      DIM4,FORM4
            MOVE      FORM4,DRGAWHT         * admission weight
            IF        FORM4>9000
              MOVE      "9000",DRGAWHT      * admission weight
            ENDIF
          ENDIF
.
          CALL      PATGILOS                * Get intended LOS
          MOVE      KEY1,DRGILOS
.
GAUS0800  MOVE      AADMNO,KEY8
          CALL      RDPTICU1                * Read the patient ICU file
          IF        OVRCD<>1
            MOVE      PTICUMEC,FORM4        * (form 5 to form 4)      *C-250267
            MOVE      FORM4,DRGHMV                                    *C-250267
          ENDIF
          CALL      ALOS0000                * Get acute LOS
.
. ----- Get The Disease Codes -----
.
          MOVE      ZERO,COD9CNT
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECD2                * Position on & read a patient
GAUS1000  CALL      RKPTECD2                  episode disease file record
          BRANCH    OVRCD,GAUS4000
.
          MATCH     AADMNO,PTEDADMN
          GOTO      GAUS4000 IF NOT EQUAL   * Different admin no
.
          RESET     VMDILIST
          SCAN      PTEDTYPE,VMDILIST
          GOTO      GAUS1000 IF NOT EQUAL   * Not a valid type sec dis type
.
          MOVE      ZERO,CMPCNT             * Complex map counter - no
          MATCH     PTCNI10D,PTEDDTCD
          IF        !@LESS
            MOVE      PTEDCODE,PTCPCOD
            CALL      PATM10T9              * Map ICD10 to ICD9 codes
            MOVE      PTCP1MCD,PTEDCODE
            MOVE      ONE,CMPCNT            * Complex map counter - yes
          ENDIF
.
GAUS2000  PACK      KEY9,PTEDCODE
          CALL      RD10T9D1                * Read an ICD9 disease file record
          BRANCH    OVRCD,GAUS3000
.
          IF        MAPFILE=1
            PACK      KEY10,ANSD,PTEDCODE
            CALL      RDPA3MI1              * Read the 3M grouper mapping file
            IF        OVRCD<>1
              MOVE      PT3MMAP,PTEDCODE    * Replace ICD9 code with mapped code
            ENDIF
          ENDIF
.
          MATCH     ANSM,PTEDCODE
          GOTO      GAUS3000 IF EQUAL       * Morphology code
.
          ADD       ONE,COD9CNT
          REP       ". / - ",PTEDCODE
          SQUEEZE   PTEDCODE
          PACK      PTEDCODE,PTEDCODE,SP10
          STORE     PTEDCODE,COD9CNT,DRGDIAG,DRGSD01,DRGSD02,DRGSD03,DRGSD04:
                                     DRGSD05,DRGSD06,DRGSD07,DRGSD08,DRGSD09:
                                     DRGSD10,DRGSD11,DRGSD12,DRGSD13,DRGSD14
.
          COMPARE   "15",COD9CNT
          GOTO      GAUS4000 IF NOT LESS    * Counter >= 15
.
GAUS3000  COMPARE   ZERO,CMPCNT
          GOTO      GAUS1000 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      GAUS1000 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,PTEDCODE
          LOAD      PTEDCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,PTEDCODE
          GOTO      GAUS1000 IF EQUAL       * Blank code
          GOTO      GAUS2000
.
. ----- Get The Operation Codes -----
.
GAUS4000  MOVE      ZERO,COD9CNT
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECO2                * Position on & read a patient
GAUS5000  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,GAUS9000
.
          MATCH     AADMNO,PTEOADMN
          GOTO      GAUS9000 IF NOT EQUAL   * Different admin no
.
          MATCH     CMOPRT,PTEOTYPE
          GOTO      GAUS5000 IF NOT EQUAL   * Not an operation within the hosp
.
          MATCH     PTCNEDRG,PTEOCODE
          GOTO      GAUS5000 IF EQUAL       * Exclude dummy code
.
          MOVE      ZERO,CMPCNT             * Complex map counter - no
          MATCH     PTCNI10D,PTEODTCD
          IF        !@LESS
            MOVE      PTEOCODE,PTCPCOD
            CALL      PATM10T9              * Map ICD10 to ICD9 codes
            MOVE      PTCP1MCD,PTEOCODE
            MOVE      ONE,CMPCNT            * Complex map counter - yes
          ENDIF
.
GAUS6000  PACK      KEY9,PTEOCODE
          CALL      RD10T9O1                * Read an ICD9 operation file record
          BRANCH    OVRCD,GAUS7000
.
          IF        MAPFILE=1
            PACK      KEY10,ANSO,PTEOCODE
            CALL      RDPA3MI1              * Read the 3M grouper mapping file
            IF        OVRCD<>1
              MOVE      PT3MMAP,PTEOCODE    * Replace ICD9 code with mapped code
            ENDIF
          ENDIF
.
          ADD       ONE,COD9CNT
          REP       ". / - ",PTEOCODE
          SQUEEZE   PTEOCODE
          PACK      PTEOCODE,PTEOCODE,SP10
          STORE     PTEOCODE,COD9CNT,DRGOPER,DRGSO01,DRGSO02,DRGSO03,DRGSO04:
                                     DRGSO05,DRGSO06,DRGSO07,DRGSO08,DRGSO09:
                                     DRGSO10,DRGSO11,DRGSO12,DRGSO13,DRGSO14
.
          COMPARE   "15",COD9CNT
          GOTO      GAUS9000 IF NOT LESS    * Counter >= 15
.
GAUS7000  COMPARE   ZERO,CMPCNT
          GOTO      GAUS5000 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      GAUS5000 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,PTEOCODE
          LOAD      PTEOCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,PTEOCODE
          GOTO      GAUS5000 IF EQUAL       * Blank code
          GOTO      GAUS6000
GAUS9000  MOVE      ZERO,EXIT
GAUS9999  RETURN
+
.*********************************************************************
. CAUS0000 : Clear data for AUST grouper
.*********************************************************************
CAUS0000  UNPACK    SP70,DRGADMN,DRGADAT,DRGATIM,DRGDDAT,DRGDTIM:
                         DRGBDAT,DRGAGEY,DRGAGED,DRGSEX,DRGSEP,DRGAWHT:
                         DRGILOS,DRGHMV,DRGALOS
          UNPACK    SP10,DRGDIAG,DRGOPER
          UNPACK    SP70,DRGSD01,DRGSD02,DRGSD03,DRGSD04,DRGSD05:
                         DRGSD06,DRGSD07,DRGSD08,DRGSD09,DRGSD10:
                         DRGSD11,DRGSD12,DRGSD13,DRGSD14
          UNPACK    SP70,DRGSO01,DRGSO02,DRGSO03,DRGSO04,DRGSO05:
                         DRGSO06,DRGSO07,DRGSO08,DRGSO09,DRGSO10:
                         DRGSO11,DRGSO12,DRGSO13,DRGSO14
.
CAUS9999  RETURN
+
.******************************************************************************
.*                                 ALOS0000                                   *
.*                       Get The Acute Length Of Stay                         *
.******************************************************************************
ALOS0000  MOVE      ZERO,FORM2                                        *I-272003
          MOVE      DRGSEP,FORM2
          IF        PSAGEDAY<=28 & (FORM2=1 | FORM2=8)
            PACK      CDYSFDTE,ADATE
            REP       " 0",CDYSFDTE
            PACK      CDYSTDTE,DDATE
            REP       " 0",CDYSTDTE
            CALL      CALCDAYS              * Calculate number of hospital days
            MOVE      CDYSDAYS,FORM4
            MOVE      FORM4,DRGALOS
          ENDIF
ALOS9999  RETURN
+
.*********************************************************************
. read the drgout.txt file (Australian Grouper)
.*********************************************************************
RAUS0000  MOVE      ZERO,OVRCD
          READ      OUTFILE,SEQ;DRGADMN,DRGDRG,DRGDRGD,DRGMDC,DRGMDCD:
                                DRGCCL,DRGNATWT,DRGGRP,DRGRET
          GOTO      OVERCOND IF OVER
          RETURN
+
.*********************************************************************
. loop over the drgout.txt file (Australian Grouper)
.*********************************************************************
PRCB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTFILE,"drgout"
          TRAPCLR   IO
          IF        OVRCD=1
            DISPLAY   *P1:24,*EL,*B,"The DRG output file not found.  ";
            CALL      HITENTER
            GOTO      PRCB9000
          ENDIF
.
PRCB1000  DISPLAY   *P1:24,*EL,"Processing : ";
.
PRCB2000  CALL      RAUS0000                * Read the Australian grouper
          BRANCH    OVRCD,PRCB9000
.
          CALL      VAUS0000                * Validate visit number for AUS
          BRANCH    EXIT,PRCB2000
.
          IF        CNTRECS%10=0
            DISPLAY   *P14:24,*V2LON,AADMNO;
          ENDIF
.
. ----- Write/update the patient grouper file -----
.
          SQUEEZE   DRGGRP
          PACK      DRGGRP,DRGGRP,SP3
          UNPACK    DRGGRP,KEY2,KEY1
          MATCH     SP1,KEY1
          IF        @EQUAL
            PACK      DRGGRP,ZERO,KEY2,SP3  * Format (0xx)
          ENDIF
.
          PACK      KEY13,AADMNO,SP1,ONE,DRGGRP
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,PRCB3000
.
          CALL      SPGV0000                * Setup 3.1 patient grouper vars
          CALL      UPPTPGR1                * Update a patient grouper file rec
          GOTO      PRCB4000
.
PRCB3000  MOVE      AADMNO,PTPGADMN
          MOVE      ONE,PTPGEPNO
          MOVE      DRGGRP,PTPGGPVR
.
          CALL      SPGV0000                * Setup 3.1 patient grouper vars
          CALL      WRPTPGR1                * Write a patient grouper file rec
.
. ----- Update the discharge file -----
.
PRCB4000  PACK      PTDSDMDC,DRGMDC,SP4     * Set MDC code
          PACK      PTDSDDRG,DRGDRG,SP4     * Set DRG code
          MOVE      DRGCCL,PTDSSIDX         * Set the DRG severity index
          MOVE      DRGGRP,PTDSVOGU         * Set the version of the grouper
.                                             used to group with
          CALL      UPDSCH1                 * Update the discharge file
.
          MOVE      ZERO,FORM2                                        *I-272003
          MOVE      SP70,DRGERR
          MOVE      DRGRET,FORM2
          IF        FORM2<>0
            LOAD      DRGERR,FORM2,RET01,RET02,RET03,RET04,RET05,RET06,RET07:
                                   RET08,RET09,RET10
            ADD       ONE,CNTERRS
          ENDIF
.
          PACK      DRGERR,DRGERR,SP70
          CALL      PLIN0000                * Print line of report
.
          COMPARE   ZERO,AINVPRT
          CALL      PATGNFEE IF EQUAL       * Update rates if no invoice printed
          GOTO      PRCB2000
.
PRCB9000  MOVE      ZERO,EXIT
PRCB9999  RETURN
+
.******************************************************************************
.*                                  SPGV0000                                  *
.*                     Setup 3.1 Patient Grouper Variables                    *
.******************************************************************************
SPGV0000  SQUEEZE   DRGDRG
          PACK      DRGDRG,DRGDRG,SP3
.
          SQUEEZE   DRGMDC
          PACK      DRGMDC,DRGMDC,SP3
          UNPACK    DRGMDC,KEY2,KEY1
          TYPE      KEY1
          IF        @EQUAL
            UNPACK    DRGMDC,KEY1,KEY2
          ENDIF
          REP       " 0",KEY2
          PACK      DRGMDC,KEY2,SP3         * Format (xx )
.
          PACK      PTPGNDRG,DRGDRG,SP4
          PACK      PTPGNMDC,DRGMDC,SP4
          MOVE      ZERO,PTPGNWGT
          MOVE      ZERO,PTPGNALS
.
          PACK      PTPGSDRG,DRGDRG,SP4
          PACK      PTPGSMDC,DRGMDC,SP4
          MOVE      ZERO,PTPGSWGT
          MOVE      ZERO,PTPGSALS
.
          PACK      PTPGLDRG,DRGDRG,SP4
          PACK      PTPGLMDC,DRGMDC,SP4
          MOVE      ZERO,PTPGLWGT
          MOVE      ZERO,PTPGLALS
.
          MOVE      DRGCCL,PTPGPCCL
          MOVE      ZERO,PTPGWFIX
          MOVE      ZERO,PTPGWVAR
          MOVE      ZERO,PTPGWTOL
          MOVE      ZERO,PTPGWWTU
          MOVE      SP20,PTPGWWTD
          MOVE      SP70,PTPGSPAR
.
          CALL      WIESCALC            * Calculate WIES values
.
SPGV9999  RETURN
+
.*********************************************************************
. TAIL0000 :  Print the report tail.
.*********************************************************************
TAIL0000  CALL      UND132
.
          IF        MRCNGRUP=3
            PRINT     *N,*1,"Number of records processed : ",CNTRECS:
                      *N,*N,*1,"*** End of Report ***",*N
            GOTO     TAIL9999
          ENDIF
.
          PRINT     *N,*1,"DSI - DRG Severity Index / Complication-":
                          "Comorbidity class level":
                    *N,*1,"Nat DRG Wgt - National DRG weighting as returned ":
                          "by the grouper.":
                    *N,*1,"VGU - Version of the Grouper Used for Grouping":
                    *N,*N,*1,"Number of records processed : ",CNTRECS:
                    *N,*1,"Number of errors found      : ",CNTERRS:
                    *N,*N,*1,"*** End of Report ***",*N
TAIL9999  RETURN
+
.*********************************************************************
. VAUS0000 :  validate the visit number supplied for AUST.
. Para's   :  a line from the DRG output file
.*********************************************************************
VAUS0000  MOVE      DRGADMN,AADMNO
          PACK      KEY8,AADMNO
          CALL      RDMISS1
          BRANCH    OVRCD,VAUS9100          * invalid admission number
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,VAUS9200          * invalid UR
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * format patient name
.
          PACK      KEY8,AADMNO
          CALL      RDDSCH1
          BRANCH    OVRCD,VAUS9300          * not discharged
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin date
          MOVE      CPCDATE,DRGADAT
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch date
          MOVE      CPCDATE,DRGDDAT
.
          MOVE      ZERO,EXIT
          GOTO      VAUS9999
.
. have an error somewhere
.
VAUS9100  MOVE      AADMNO,FORM6
          CLEAR     DRGERR
          APPEND    "Invalid Admission Number : ",DRGERR
          APPEND    FORM6,DRGERR
          RESET     DRGERR
          UNPACK    SP20,DRGADAT,DRGDDAT
          GOTO      VAUS9900
.
VAUS9200  CLEAR     DRGERR
          APPEND    "Invalid U/R Number : ",DRGERR
          APPEND    AURNO,DRGERR
          RESET     DRGERR
          GOTO      VAUS9900
.
VAUS9300  MOVE      AADMNO,FORM6
          CLEAR     DRGERR
          APPEND    "Patient isn't Discharged : ",DRGERR
          APPEND    FORM6,DRGERR
          RESET     DRGERR
          UNPACK    SP20,DRGDDAT,DRGDDAT
.
VAUS9900  ADD       ONE,CNTERRS             * add to error count
          MOVE      SP70,PACFNAME
          CALL      PLIN0000                * print line of report
          MOVE      ONE,EXIT
.
VAUS9999  RETURN
+
.*********************************************************************
.         write the data to the inpatient file - drginp
.         (Australian Grouper)
.*********************************************************************
WAUS0000  WRITE     INPFILE,SEQ;DRGADMN,DRGADAT,DRGATIM,DRGDDAT,DRGDTIM:
                                DRGBDAT,DRGAGEY,DRGAGED,DRGSEX,DRGSEP,DRGAWHT:
                                DRGILOS,DRGHMV,DRGDIAG,DRGSD01,DRGSD02:
                                DRGSD03,DRGSD04,DRGSD05,DRGSD06,DRGSD07:
                                DRGSD08,DRGSD09,DRGSD10,DRGSD11,DRGSD12:
                                DRGSD13,DRGSD14,DRGOPER,DRGSO01,DRGSO02:
                                DRGSO03,DRGSO04,DRGSO05,DRGSO06,DRGSO07:
                                DRGSO08,DRGSO09,DRGSO10,DRGSO11,DRGSO12:
                                DRGSO13,DRGSO14
WAUS9999  RETURN
+
.******************************************************************************
.*                                   P41T0000                                 *
.*                             Process The Tempfile                           *
.******************************************************************************
P41T0000  MOVE      ZERO,CNTRECS            * Clear counter
          MOVE      SP8,KEY8
          READ      TEMPA,KEY8;;
P41T1000  READKS    TEMPA;XAADMN,XNAME40,XADATE8,XDDATE8
          GOTO      P41T9000 IF OVER
.
          PACK      KEY8,XAADMN
          CALL      RDMISS1                 * Read an admission file record
          BRANCH    OVRCD,P41T1000
.
          PACK      KEY8,AURNO
          CALL      RDMAST1                 * Read a master file record
          BRANCH    OVRCD,P41T1000
.
          PACK      KEY8,AADMNO
          CALL      RDDSCH1                 * Read a discharge file record
          BRANCH    OVRCD,P41T1000
.
...       * GRPDTE not set so that we always use ICD10 and not 9       *C-50344
P41T2000  MOVE      DDATE,ICDRDDTE     * Use Discharge Date to read ICD files.
.
.                                                                     *I-262698
          MOVE      AADMNO,ADMISSNO
          MOVE      ADATE,ENCSTDAT       * Start & End dates for Grouper -
          MOVE      ATIME,ENCSTTIM       * (needed for Episode coding)
          MOVE      DDATE,ENCENDAT
          MOVE      DTIME,ENCENTIM
          MOVE      ONE,EPSCD001         * Set Episode Number to one
.
P41T3000  CALL      CLR41000                * Clear grouper variables
          CALL      EXT41000                * Extract grouper info
          CALL      GTCOD000                * Get grouper codes
.
          COMPARE   ONE,MRCNGRUP
          IF        @EQUAL
            CALL      WRCME1                * Write grouper codes
          ELSE
            CALL      WRUNIX1               * Write Unix file
          ENDIF
.
          ADD       ONE,CNTRECS             * Increment the record counter
          GOTO      P41T1000
.
P41T9000  MOVE      ZERO,EXIT
P41T9999  RETURN
+
.******************************************************************************
.*                                   DPTL0000                                 *
.*                                Display Totals                              *
.******************************************************************************
DPTL0000  DISPLAY   *P1:24,*EL,"There were ",*V2LON,CNTRECS,*HOFF," records ":
                    "written.  ";
          CALL      HITENTER
          COMPARE   ZERO,CNTRECS
          GOTO      DPTL9500 IF EQUAL       * No records written
.
DPTL9000  MOVE      ZERO,EXIT
          GOTO      DPTL9999
.
DPTL9500  MOVE      ONE,EXIT
DPTL9999  RETURN
+
.******************************************************************************
.*                                  A41D0000                                  *
.*                          Allocate 4.1 DRG Details                          *
.******************************************************************************
A41D0000  MOVE      ONE,OPENFLG             * open first version
          MOVE      ZERO,DFLTVFLG           * initialise version default
.
A41D1900  MOVE      ZERO,CNTRECS            * Clear counter
          DISPLAY   *P1:24,*EL,"Writing : ";
.
A41D2000  COMPARE   TEN4,OPENFLG                                      *C-0956210
          GOTO      A41D9000 IF NOT LESS    * finished the "n-1" versions
.
A41D2500  CLOSE     OUTFILE2
          PERFORM   OPENFLG,G12GP000:       * open 12.0 file
                            G11GP000:       * open 11.0 file
                            G10GP000:       * open 10.0 file
                            G90GP000:       * open 9.0 file
                            G80GP000:       * open 8.0 file
                            G70GP000:       * open 7.0 file           *I-284669
                            G62GP000:       * open 6.2 file           *I-267797
                            G60GP000:       * open 6.0 file           *I-197814
                            G52GP000:       * open 5.2 file           *I-137125
                            G51GP000:       * open 5.1 file            *I-50344
                            G50GP000:       * open 5.0 file            *I-50344
                            G42GP000:       * open 4.2 file
                            G41GP000        * open 4.1 file
          BRANCH    EXIT,A41D5000
.
A41D4000  COMPARE   ONE,MRCNGRUP
          IF        @EQUAL
            CALL      RDCME1                  * Read PC output
            BRANCH    OVRCD,A41D5000
          ELSE
            CALL      RDUNIX1                 * Read Unix output
            BRANCH    OVRCD,A41D5000
            MOVE      XDRGMEDN,XDRGADMN       * Admis no. for UNX grp
          ENDIF
.
          IF        CNTRECS%10=0
            DISPLAY   *P11:24,*V2LON,XDRGADMN;
          ENDIF
.
          MOVE      SP70,DRGERR
          CALL      CLPATMAS                * Clear master file variables
          PACK      KEY8,XDRGADMN
          CALL      RDMISS1                 * Read an admission file record
          IF        OVRCD=1
            MOVE      "Invalid admission number             ",DRGERR
            GOTO      A41D6000
          ENDIF
.
          PACK      KEY8,AURNO
          CALL      RDMAST1                 * Read a master file record
          IF        OVRCD=1
            MOVE      "Invalid U/R number for admission     ",DRGERR
            GOTO      A41D6000
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDDSCH1                 * Read a discharge file record
          IF        OVRCD=1
            MOVE      "Admission not discharged             ",DRGERR
            GOTO      A41D6000
          ENDIF
.
A41D4050  CALL      PST41000                * Post DRG & MDC codes
          COMPARE   ONE,DFLTVFLG
          GOTO      A41D4000 IF NOT EQUAL   * Not writing this DRG version
.
          MOVE      ZERO,FORM2                                        *I-272003
          MOVE      XDRGGSC,FORM2
          IF        FORM2<>0
            LOAD      DRGERR,FORM2,XRET01,XRET02,XRET03,XRET04,XRET05:
                                   XRET06,XRET07,XRET08,XRET09
            ADD       ONE,CNTERRS
          ENDIF
          CALL      P41D0000                * Print a patients DRG details
          GOTO      A41D4000
.
A41D5000  ADD       ONE,OPENFLG             * get next version output
          COMPARE   ONE,DFLTVFLG
          IF        @EQUAL
            MOVE      TWO,DFLTVFLG          * default version already written
          ENDIF
          GOTO      A41D2000
.
A41D6000  COMPARE   ONE,DFLTVFLG
          GOTO      A41D4000 IF NOT EQUAL   * Not writing this DRG version
.
          CALL      P41D0000                * Print a patients DRG details
          ADD       ONE,CNTERRS
          GOTO      A41D4000
.
A41D9000  MOVE      ZERO,EXIT
A41D9999  RETURN
+
.*******************************************************************************
.*                                  P41D0000                                  *
.*                        Print A Patients DRG Details                        *
.******************************************************************************
P41D0000  MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * Format patients name
          MOVE      PACFNAME,KEY24
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin date
          MOVE      CPCDATE,XDRGADAT
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch date
          MOVE      CPCDATE,XDRGDDAT
.
          PRINT     *1,"|",AURNO,*10,"|",XDRGADMN,*19,"|",KEY24:
                    *44,"|",XDRGADAT,*55,"|",XDRGDDAT,*66,"|",XDRGDRG:
                    *71,"|",XDRGMDC,*75,"| ",XDRGCCL,*79,"| ",XDRGNWT:
                    *90,"|",XDRGGRP,*94,"|",DRGERR,*132,"|"
          ADD       ONE,CNTRECS
          ADD       ONE,CLNO
          IF        CLNO>=FIFTY5
            CALL      HEAD0000
          ENDIF
.
P41D9000  MOVE      ZERO,EXIT
P41D9999  RETURN
+
.*******************************************************************************
.         Get the default charging claim code for multi hospital
.                        Routine required for PATGNFEE
.*******************************************************************************
DCLM0000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
          MATCH     SP70,PTCNDCLM
          IF        @EQUAL
            MOVE      "0  ",PTCNDCLM          * Use zero claim code
          ENDIF
DCLM9999  RETURN
.*******************************************************************************
.  ******************** RUN PC GROUPER/ENCODER *********************
.
RUNPCG00  PACK      FILENAM1,DRGINP,PORT,SP70
          REP       " 0",FILENAM1
.
.
.    The following will execute mrtweb02.us1 unix script which will
.    FTP the client PC.
.    Parameters passed in are : FILENAM1, FILENAM2, USERID, KEY3(ICD10 version)
.    Parameters passed in are : Grouper File, Encoder File, Web User ID &
.                               ICD10 Version
.
.    Set the ICD10 Version to use in script mrtweb02.us1
.
          MATCH     PTCNGDV3,DDATE
          IF        @LESS
            MOVE      " v2",KEY3    * Discharge date < ICD10v3 golive date
          ELSE
            MOVE      " v3",KEY3    * Discharge date > ICD10v3 golive date
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    "mrtweb02.us1 ",CMDLINE
          APPEND    FILENAM1,CMDLINE
          APPEND    ".txt ",CMDLINE
          APPEND    FILENAM2,CMDLINE
          APPEND    ".txt ",CMDLINE
          APPEND    USERID,CMDLINE
          APPEND    KEY3,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          MOVE      ZERO,ENCODERF
          DISPLAY   *W10
.
.
.    The following will execute mrtweb02.us2 unix script which will
.    FTP the drg & encoder output files from the client PC.
.    Parameters passed in are : Userid & PORT
.
RUNPCG20  CLEAR     CMDLINE
          APPEND    "mrtweb02.us2 ",CMDLINE
          APPEND    USERID,CMDLINE
          APPEND    SP1,CMDLINE
          MOVE      PORT,KEY2
          REP       " 0",KEY2
          APPEND    KEY2,CMDLINE
          APPEND    SP1,CMDLINE
          RESET     CMDLINE
.
          MOVE      SP20,TASKID
          MOVE      ONE,LOOPS
RUNPCG30  EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:22,CMDLINE:
                    *P1:23,"Task Id = ",TASKID,"."

          MATCH     "0",TASKID                                        *I-230778
          IF        !@EQUAL
            ADD       ONE,LOOPS
            IF        LOOPS < 16
              DISPLAY   *W10
              GOTO      RUNPCG30            * try again in 10 seconds
            ENDIF
          ENDIF                                                 * end *I-230778
.
          CALL      SETPTH00                * Set up output File Names
          MOVE      ZERO,FILRFGRP
.         MATCH     "1",ENCODERF
.         IF        @EQUAL
.           CALL      LODENC00
.         ELSE
.           DISPLAY   "Loading Grouper";
.           CALL      HITENTER
.           CALL      LODGRP00
.         ENDIF
.         GOTO      RUNPCG99
.
RUNPCG99  RETURN
+
.******************************************************************************
.*                                  INP41000                                  *
.*                          Open Grouper Input Files                          *
.******************************************************************************
INP41000  
...MATCH     PTCNGDV2,GRPDTE
...       GOTO      INP41100 IF LESS        * Grouper date < ICD10v2 golive date
.
          MOVE      "drginp",KEY6
          PACK      KEY8,KEY6,PORT
          PREP      INPFIL41,KEY8
          GOTO      INP41900
.
...INP41100  MOVE      "dinp09",KEY6
...          PACK      KEY8,KEY6,PORT
...          PREP      INPFIL9,KEY8
.
...          MOVE      "dinp10",KEY6
...          PACK      KEY8,KEY6,PORT
...          PREP      INPFIL41,KEY8
.
INP41900  MOVE      ZERO,EXIT
INP41999  RETURN
+
.******************************************************************************
.*                                  COD41000                                  *
.*                              Get Grouper Codes                             *
.******************************************************************************
COD41000  MOVE      ZERO,COD9CNT
          MOVE      ZERO,COD1CNT
          PACK      KEY16,AADMNO,SP20                                 *C-240107
          CALL      RSPTECD2                * Position on & read a patient
COD41100  CALL      RKPTECD2                  episode disease file record
          BRANCH    OVRCD,COD41400
.
          MATCH     AADMNO,PTEDADMN
          GOTO      COD41400 IF NOT EQUAL   * Different admin no
.
. ----- Get ICD10 disease codes -----
.
          MOVE      PTEDCODE,DPCODE
          PACK      KEY9,DPCODE
          CALL      RDPTICD1                * Read ICD disease file
          BRANCH    OVRCD,COD41100
.
          COMPARE   ONE,ICDRDVER            * ICD9?
          IF        @EQUAL
            MOVE      DICD10CD,DPCODE       * Mapped ICD10 disease code
            PACK      KEY9,DPCODE
            CALL      RDPT10D1              * Read an ICD10 disease file record
            BRANCH    OVRCD,COD41100
          ENDIF
.
          MATCH     "4",PT0DACRQ
          GOTO      COD41100 IF EQUAL       * Ignore morphology codes
.
          MOVE      DPCODE,KEY9
          REP       ". / - ",KEY9
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP10
          ADD       ONE,COD1CNT
          STORE     KEY9,COD1CNT,XDRGDS01,XDRGDS02,XDRGDS03,XDRGDS04,XDRGDS05:
                                 XDRGDS06,XDRGDS07,XDRGDS08,XDRGDS09,XDRGDS10:
                                 XDRGDS11,XDRGDS12,XDRGDS13,XDRGDS14,XDRGDS15:
                                 XDRGDS16,XDRGDS17,XDRGDS18,XDRGDS19,XDRGDS20:
                                 XDRGDS21
          COMPARE   "21",COD1CNT
          GOTO      COD41400 IF NOT LESS    * ICD10 counter >= 21
.
          MATCH     PTCNGDV2,GRPDTE
          GOTO      COD41100 IF NOT LESS    * Grouper date >= ICD10v2 golive dte
.
          COMPARE   "21",COD9CNT
          GOTO      COD41100 IF NOT LESS    * ICD9 counter >= 21
.
. ----- Get ICD9 disease codes -----
.
          MOVE      ZERO,CMPCNT             * Complex map counter - no
          MOVE      PTEDCODE,DPCODE
          MATCH     PTCNI10D,DDATE
          IF        !@LESS
            MOVE      DPCODE,PTCPCOD
            CALL      PATM10T9              * Map ICD10 to ICD9 codes
            MOVE      PTCP1MCD,DPCODE
            MOVE      ONE,CMPCNT            * Complex map counter - yes
          ENDIF
.
COD41200  PACK      KEY9,DPCODE
          CALL      RD10T9D1                * Read an ICD9 disease file record
          BRANCH    OVRCD,COD41300
.
          MATCH     ANSM,DPCODE
          GOTO      COD41300 IF EQUAL       * Ignore morphology codes
.
          MOVE      DPCODE,KEY9             * ICD9 disease code
          REP       ". / - ",KEY9
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP10
          ADD       ONE,COD9CNT
          STORE     KEY9,COD9CNT,XDRGD901,XDRGD902,XDRGD903,XDRGD904,XDRGD905:
                                 XDRGD906,XDRGD907,XDRGD908,XDRGD909,XDRGD910:
                                 XDRGD911,XDRGD912,XDRGD913,XDRGD914,XDRGD915:
                                 XDRGD916,XDRGD917,XDRGD918,XDRGD919,XDRGD920:
                                 XDRGD921
          COMPARE   "21",COD9CNT
          GOTO      COD41100 IF NOT LESS    * ICD9 counter >= 21
.
COD41300  COMPARE   ZERO,CMPCNT
          GOTO      COD41100 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      COD41100 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,DPCODE
          LOAD      DPCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,DPCODE
          GOTO      COD41100 IF EQUAL       * Blank code
          GOTO      COD41200
.
. ----- Get operation codes -----
.
COD41400  MOVE      ZERO,COD9CNT
          MOVE      ZERO,COD1CNT
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECO2                * Position on & read a patient
COD41500  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,COD41900
.
          MATCH     AADMNO,PTEOADMN
          GOTO      COD41900 IF NOT EQUAL   * Different admin no
.
          MATCH     CMOPRT,PTEOTYPE
          GOTO      COD41500 IF NOT EQUAL   * Not an in hospital operation
.
          MATCH     PTCNEDRG,PTEOCODE
          GOTO      COD41500 IF EQUAL       * Exclude dummy code
.
. ----- Get ICD10 operation codes -----
.
          MOVE      PTEOCODE,OPCODE
          PACK      KEY9,OPCODE
          CALL      RDPTICO1                    * Read ICD operation file
          BRANCH    OVRCD,COD41500
.
          COMPARE   ONE,ICDRDVER                * ICD9?
          IF        @EQUAL
            MOVE      OICD10CD,OPCODE           * Mapped ICD10 operation code
            PACK      KEY9,OPCODE
            CALL      RDPT10O1                  * Read an ICD10 operation rec
            BRANCH    OVRCD,COD41500
          ENDIF
.
          MOVE      OPCODE,KEY9
          REP       ". / - ",KEY9
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP10
          ADD       ONE,COD1CNT
          STORE     KEY9,COD1CNT,XDRGOP01,XDRGOP02,XDRGOP03,XDRGOP04,XDRGOP05:
                                 XDRGOP06,XDRGOP07,XDRGOP08,XDRGOP09,XDRGOP10:
                                 XDRGOP11,XDRGOP12,XDRGOP13,XDRGOP14,XDRGOP15:
                                 XDRGOP16,XDRGOP17,XDRGOP18,XDRGOP19,XDRGOP20:
                                 XDRGOP21
          COMPARE   "21",COD1CNT
          GOTO      COD41900 IF NOT LESS    * ICD10 counter >= 21
.
          MATCH     PTCNGDV2,GRPDTE
          GOTO      COD41500 IF NOT LESS    * Grouper date >= ICD10v2 golive dte
.
          COMPARE   "21",COD9CNT
          GOTO      COD41500 IF NOT LESS    * ICD9 counter >= 21
.
. ----- Get ICD9 operation codes -----
.
          MOVE      ZERO,CMPCNT             * Complex map counter - no
          MOVE      PTEOCODE,OPCODE
          MATCH     PTCNI10D,DDATE
          IF        !@LESS
            MOVE      OPCODE,PTCPCOD
            CALL      PATM10T9              * Map ICD10 to ICD9 codes
            MOVE      PTCP1MCD,OPCODE
            MOVE      ONE,CMPCNT            * Complex map counter - yes
          ENDIF
.
COD41600  PACK      KEY9,OPCODE
          CALL      RD10T9O1                * Read an ICD9 operation file record
          BRANCH    OVRCD,COD41700
.
          MOVE      OPCODE,KEY9             * ICD9 operation code
          REP       ". / - ",KEY9
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP10
          ADD       ONE,COD9CNT
          STORE     KEY9,COD9CNT,XDRGO901,XDRGO902,XDRGO903,XDRGO904,XDRGO905:
                                 XDRGO906,XDRGO907,XDRGO908,XDRGO909,XDRGO910:
                                 XDRGO911,XDRGO912,XDRGO913,XDRGO914,XDRGO915:
                                 XDRGO916,XDRGO917,XDRGO918,XDRGO919,XDRGO920:
                                 XDRGO921
          COMPARE   "21",COD9CNT
          GOTO      COD41500 IF NOT LESS    * ICD9 counter >= 21
.
COD41700  COMPARE   ZERO,CMPCNT
          GOTO      COD41500 IF EQUAL       * Not using complex mapping
.
          ADD       ONE,CMPCNT
          COMPARE   FOUR,CMPCNT
          GOTO      COD41500 IF NOT LESS    * Complex map counter >=4
.
          MOVE      SP9,OPCODE
          LOAD      OPCODE,CMPCNT,PTCP1MCD,PTCP2MCD,PTCP3MCD
          MATCH     SP9,OPCODE
          GOTO      COD41500 IF EQUAL       * Blank code
          GOTO      COD41600
.
COD41900  MOVE      ZERO,EXIT
COD41999  RETURN
+
.******************************************************************************
.*                                  G42GP000                                  *
.*                           Get version 4.2 output                           *
.******************************************************************************
G42GP000  MATCH     PTCNED42,TODATE8      * disc.date > DRG 4.2 effect.date?
          GOTO      G42GP950 IF LESS      * not using 4.2 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G42GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G42GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG042,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G42GP500  MOVE      "4.2",KEY3
          MOVE      "dout42",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg42o",KEY6
          ENDIF
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G42GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP                                      *I-?????
          IF        @EQUAL
            MOVE    DRG042,XDRGGRP           * DRG Version
          ENDIF
.         
G42GP900  MOVE      ZERO,EXIT
          GOTO      G42GP999
.
G42GP950  MOVE      ONE,EXIT
G42GP999  RETURN
+
.******************************************************************************
.*                                  G41GP000                                  *
.*                           Get version 4.1 output                           *
.******************************************************************************
G41GP000  MATCH     PTCNED41,TODATE8      * disc.date > DRG 4.1 effect.date?
          GOTO      G41GP950 IF LESS      * not using 4.1 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G41GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G41GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG041,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G41GP500  MOVE      "4.1",KEY3
          MOVE      "dout41",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg41o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout10",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G41GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP                                      *I-?????
          IF        @EQUAL
            MOVE    DRG041,XDRGGRP           * DRG Version
          ENDIF
.         
G41GP900  MOVE      ZERO,EXIT
          GOTO      G41GP999
.
G41GP950  MOVE      ONE,EXIT
G41GP999  RETURN
+
.******************************************************************************
.*                                  G50GP000                                  *
.*                           Get version 5.0 output                           *
.******************************************************************************
G50GP000  MATCH     PTCNED50,TODATE8      * disc.date > DRG 5.0 effect.date?
          GOTO      G50GP950 IF LESS      * not using 5.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G50GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G50GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG050,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G50GP500  MOVE      "5.0",KEY3
          MOVE      "dout50",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg50o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G50GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP                                      *I-?????
          IF        @EQUAL
            MOVE    DRG050,XDRGGRP           * DRG Version
          ENDIF
.         
G50GP900  MOVE      ZERO,EXIT
          GOTO      G50GP999
.
G50GP950  MOVE      ONE,EXIT
G50GP999  RETURN
+
.******************************************** start of addition        *I-61562
.******************************************************************************
.*                                  G51GP000                                  *
.*                           Get version 5.1 output                           *
.******************************************************************************
G51GP000  MATCH     PTCNED51,TODATE8      * disc.date > DRG 5.1 effect.date?
          GOTO      G51GP950 IF LESS      * not using 5.1 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G51GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G51GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG051,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G51GP500  MOVE      "5.1",KEY3
          MOVE      "dout51",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg51o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G51GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG051,XDRGGRP           * DRG Version
          ENDIF
.
G51GP900  MOVE      ZERO,EXIT
          GOTO      G51GP999
.
G51GP950  MOVE      ONE,EXIT
G51GP999  RETURN
+
.********************************************   end of addition        *I-61562
+
.******************************************** start of addition       *I-137125
.******************************************************************************
.*                                  G52GP000                                  *
.*                           Get version 5.2 output                           *
.******************************************************************************
G52GP000  MATCH     PTCNED52,TODATE8      * disc.date > DRG 5.2 effect.date?
          GOTO      G52GP950 IF LESS      * not using 5.2 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G52GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G52GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG052,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G52GP500  MOVE      "5.2",KEY3
          MOVE      "dout52",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg52o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G52GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG052,XDRGGRP           * DRG Version
          ENDIF
.
G52GP900  MOVE      ZERO,EXIT
          GOTO      G52GP999
.
G52GP950  MOVE      ONE,EXIT
G52GP999  RETURN
.********************************************   end of addition       *I-137125
+
.******************************************** start of addition       *I-197814
.******************************************************************************
.*                                  G60GP000                                  *
.*                           Get version 6.0 output                           *
.******************************************************************************
G60GP000  MATCH     PTCNED60,TODATE8      * disc.date > DRG 6.0 effect.date?
          GOTO      G60GP950 IF LESS      * not using 6.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G60GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G60GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG060,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G60GP500  MOVE      "6.0",KEY3
          MOVE      "dout60",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg60o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G60GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG060,XDRGGRP           * DRG Version
          ENDIF
.
G60GP900  MOVE      ZERO,EXIT
          GOTO      G60GP999
.
G60GP950  MOVE      ONE,EXIT
G60GP999  RETURN
.********************************************   end of addition       *I-197814
+
.******************************************************************************
.*                                  G62GP000                        *I-267797 *
.*                           Get version 6.2 output                           *
.******************************************************************************
G62GP000  MATCH     PTCNED62,TODATE8      * disc.date > DRG 6.2 effect.date?
          GOTO      G62GP950 IF LESS      * not using 6.2 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G62GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G62GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG062,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G62GP500  MOVE      "6.2",KEY3
          MOVE      "dout62",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg62o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G62GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG062,XDRGGRP           * DRG Version
          ENDIF
.
G62GP900  MOVE      ZERO,EXIT
          GOTO      G62GP999
.
G62GP950  MOVE      ONE,EXIT
G62GP999  RETURN
.********************************************   end of addition       *I-267797
+
.******************************************************************************
.*                                  G70GP000                        *I-284669 *
.*                           Get version 7.0 output                           *
.******************************************************************************
G70GP000  MATCH     PTCNED70,TODATE8      * disc.date > DRG 7.0 effect.date?
          GOTO      G70GP950 IF LESS      * not using 7.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G70GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G70GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG070,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G70GP500  MOVE      "7.0",KEY3
          MOVE      "dout70",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg70o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G70GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG070,XDRGGRP           * DRG Version
          ENDIF
.
G70GP900  MOVE      ZERO,EXIT
          GOTO      G70GP999
.
G70GP950  MOVE      ONE,EXIT
G70GP999  RETURN
.********************************************   end of addition       *I-284669
.
+
.******************************************************************************
.*                                  G80GP000                                  *
.*                           Get version 8.0 output                           *
.******************************************************************************
G80GP000  MATCH     PTCNED80,TODATE8      * disc.date > DRG 8.0 effect.date?
          GOTO      G80GP950 IF LESS      * not using 8.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G80GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G80GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG080,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * this version is the default
          ENDIF
.
G80GP500  MOVE      "8.0",KEY3
          MOVE      "dout80",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg80o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G80GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG080,XDRGGRP           * DRG Version
          ENDIF
.
G80GP900  MOVE      ZERO,EXIT
          GOTO      G80GP999
.
G80GP950  MOVE      ONE,EXIT
G80GP999  RETURN
+

.******************************************************************************
.*                                  G90GP000                                  *
.*                           Get version 9.0 output                           *
.******************************************************************************
G90GP000  MATCH     PTCNED90,TODATE8      * disc.date > DRG 9.0 effect.date?
          GOTO      G90GP950 IF LESS      * not using 9.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G90GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G90GP500
          ENDIF
          MOVE      ZERO,DFLTVFLG
          MATCH     DRG090,PTCNDGPV
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * use ptcndgpv for the default
          ENDIF
.
G90GP500  MOVE      "9.0",KEY3
          MOVE      "dout90",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg90o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G90GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG090,XDRGGRP           * DRG Version
          ENDIF
.
G90GP900  MOVE      ZERO,EXIT
          GOTO      G90GP999
.
G90GP950  MOVE      ONE,EXIT
G90GP999  RETURN
+
.******************************************************************************
.*                                  G10GP000                                  *
.*                           Get version 10.0 output                          *
.******************************************************************************
G10GP000  MATCH     PTCNE100,TODATE8      * disc.date > DRG 10.0 effect.date?
          GOTO      G10GP950 IF LESS      * not using 10.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G10GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G10GP500
          ENDIF
.0936495  MOVE      ZERO,DFLTVFLG
.0936495  MATCH     DRG100,PTCNDGPV
.0936495  IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * use ptcndgpv for the default
.0936495  ENDIF
.
G10GP500  MOVE      "100",KEY3
          MOVE      "dout10",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg10o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G10GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG100,XDRGGRP           * DRG Version
          ENDIF
.
G10GP900  MOVE      ZERO,EXIT
          GOTO      G10GP999
.
G10GP950  MOVE      ONE,EXIT
G10GP999  RETURN
+
.******************************************************************************
.*                                  G11GP000                                  *
.*                           Get version 11.0 output                          *
.******************************************************************************
G11GP000  MATCH     PTCNE110,TODATE8      * disc.date > DRG 11.0 effect.date?
          GOTO      G11GP950 IF LESS      * not using 11.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G11GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G11GP500
          ENDIF
.0936495  MOVE      ZERO,DFLTVFLG
.0936495  MATCH     DRG110,PTCNDGPV
.0936495  IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * use ptcndgpv for the default
.0936495  ENDIF
.
G11GP500  MOVE      "110",KEY3
          MOVE      "dout11",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg11o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G11GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG110,XDRGGRP           * DRG Version
          ENDIF
.
G11GP900  MOVE      ZERO,EXIT
          GOTO      G11GP999
.
G11GP950  MOVE      ONE,EXIT
G11GP999  RETURN
+
.******************************************************************************
.*                                  G12GP000                                  *
.*                           Get version 12.0 output                          *
.******************************************************************************
G12GP000  MATCH     PTCNE120,TODATE8      * disc.date > DRG 12.0 effect.date?
          GOTO      G12GP950 IF LESS      * not using 12.0 grouper
.
          COMPARE   TWO,DFLTVFLG
          GOTO      G12GP500 IF EQUAL       * default already written
.
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * using DRG effective dates
            GOTO      G12GP500
          ENDIF
.0936495  MOVE      ZERO,DFLTVFLG
.0936495  MATCH     DRG120,PTCNDGPV
.0936495  IF        @EQUAL
            MOVE      ONE,DFLTVFLG          * use ptcndgpv for the default
.0936495  ENDIF
.
G12GP500  MOVE      "120",KEY3
          MOVE      "dout12",KEY6
          IF        MRCNGRUP=1
            MOVE      "drg12o",KEY6
          ENDIF
.
          MATCH     "9999",PTCNGDV2
          IF        !@EQUAL
            MATCH     PTCNGDV2,GRPDTE
            IF        @LESS
              MOVE      "dout09",KEY6
            ENDIF
          ENDIF
.
          CALL      OUT41000                * Open the output file
          BRANCH    EXIT,G12GP950
.
.         * For UNIX Grouper we don't have version returned.
.
          COMPARE   ZERO,MRCNGRUP
          IF        @EQUAL
            MOVE    DRG120,XDRGGRP           * DRG Version
          ENDIF
.
G12GP900  MOVE      ZERO,EXIT
          GOTO      G12GP999
.
G12GP950  MOVE      ONE,EXIT
G12GP999  RETURN
+
.******************************************************************************
.*                                  PST41000                                  *
.*                            Post DRG & MDC Codes                            *
.******************************************************************************
PST41000  PACK      KEY13,AADMNO,SP1,ONE,XDRGGRP
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,PST41100
.
....      CALL      SGV41000                * Setup patient grouper variables
          CALL      STDRG000                * Setup patient grouper variables
          CALL      UPPTPGR1                * Update a patient grouper file rec
          GOTO      PST41200
.
PST41100  MOVE      AADMNO,PTPGADMN
          MOVE      ONE,PTPGEPNO
          MOVE      XDRGGRP,PTPGGPVR
.
....      CALL      SGV41000                * Setup patient grouper variables
          CALL      STDRG000                * Setup patient grouper variables
.
          PACK      KEY13,PTPGADMN,PTPGEPNO,PTPGGPVR,SP70
          CALL      RAPTPGR1                * Read a patient grouper file record
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPTPGR1              * Write a patient grouper file rec
            TRAPCLR   IO
            BRANCH    OVRCD,PST41999
          ENDIF
.
PST41200  COMPARE   ONE,DFLTVFLG
          GOTO      PST41900 IF NOT EQUAL   * Not writing this DRG version
.
          PACK      PTDSDMDC,XDRGMDC,SP4    * MDC code
          PACK      PTDSDDRG,XDRGDRG,SP4    * DRG code
          MOVE      XDRGCCL,PTDSSIDX        * DRG severity index
          MOVE      XDRGGRP,PTDSVOGU        * Version of the grouper used
.
          CALL      UPDSCH1                 * Update a discharge file record
.
          MATCH     "031",PTCNDGPV
          GOTO      PST41900 IF NOT EQUAL   * Not writing the 3.1 DRG's
.
          COMPARE   ZERO,AINVPRT
          CALL      PATGNFEE IF EQUAL       * Update rates if no invoice printed
.
PST41900  MOVE      ZERO,EXIT
PST41999  RETURN
+
.******************************************************************************
.*                                  OUT41000                                  *
.*                           Open The Output Files                            *
.******************************************************************************
OUT41000  CLOSE     OUTFILE2
          PACK      KEY8,KEY6,PORT
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTFILE2,KEY8
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      OUT41900 IF NOT EQUAL   * File found
.
          MOVE      PORT,KEY2
          REP       "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",KEY2
          PACK      KEY8,KEY6,KEY2
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTFILE2,KEY8
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      OUT41900 IF NOT EQUAL   * File found
.
          DISPLAY   *P1:24,*EL,*B,"The ",KEY3," DRG output file not found.  ";
          CALL      HITENTER
          GOTO      OUT41950
.
OUT41900  MOVE      ZERO,EXIT
          GOTO      OUT41999
.
OUT41950  MOVE      ONE,EXIT
OUT41999  RETURN
.
+
.*********************************************************************
.         process the temp file
.*********************************************************************
PRTB0000  DISPLAY   *P1:24,*EL,"Adding to TurboGrouper input file - ":
                    *V2LON,*BLINKON,"Please wait"
          MOVE      ZERO,CNTRECS            * clear counter
.

          PACK      FILENAM3,ANST,ANSU,ANSR,ANSE,ANSX,ANSP,PORT,SP70
          REP       " 0",FILENAM3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TURBOFL1,FILENAM3       * open the TurboGrouper file
          TRAPCLR   IO
          IF        OVRCD<>1
            CLOSE     TURBOFL1,DELETE       * Delete old temp file
          ENDIF
.
          PREP      TURBOFL1,FILENAM3       * Create file "TUREXPXX.txt"
.
          MOVE      SP8,KEY8
          READ      TEMPA,KEY8;;
.
PRTB1000  READKS    TEMPA;XAADMN,XNAME40,XADATE8,XDDATE8
          GOTO      PRTB9000 IF OVER
.
          MOVE      XAADMN,ADMISSNO
.
          PACK      KEY8,ADMISSNO,SP70  * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PRTB1000
.
          PACK      KEY8,ADMISSNO,SP70  * Read Admission extension File
          CALL      RDPMVX11
          BRANCH    OVRCD,PRTB1000
.
          MOVE      AURNO,URNUMBER
.
          PACK      KEY8,URNUMBER,SP70  * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PRTB1000
.
          CALL      RDPMPX21            * Read PMI Extension File 2
          BRANCH    OVRCD,PRTB1000
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Date
          CALL      RDDSCH1
          BRANCH    OVRCD,PRTB1000
.
          MOVE      DDATE,ICDRDDTE      * Use Discharge Date to read ICD files.
          MOVE      DDATE,ENCENDAT      * Initialise end date

          MOVE      ZERO,TURBOSAV      * Don't save previous details
          CALL      CLRTB000           * Clear TurboGrouper variables
.
          MOVE      ONE,TURBOCMD       * TurboGrouper Command (auto send)
          MOVE      ONE,TURBOCMD       * PAS Command (auto import)
          MOVE      ONE,EPSCD001
.
          READ      CONTROLF,SIXTY1;*230,MRCNTUSR
          MOVE      MRCNTUSR,USERID
.
          CALL      POPTB000           * Populate TurboGrouper vars
          CALL      WTBGRP00           * Write TurboGrouper codes
.
          ADD       ONE,CNTRECS
          GOTO      PRTB1000
.
PRTB9000  MOVE      ZERO,EXIT
          CLOSE     TURBOFL1
.
PRTB9999  RETURN
+
.*********************************************************************
. Load and process the TurboGrouper output file
.*********************************************************************
LDTB0000  MOVE      ONE,TURBOCMD       * TurboGrouper Command (auto send)
          MOVE      ONE,TURBOCMD       * PAS Command (auto import)
.
LDTB1000  MOVE      ZERO,TURBOSAV      * Don't save previous details
          CALL      CLRTB000                * Clear TurboGrouper variables
.
          READ      TURBOFL2,SEQ;XTRB0001,XTRB0002,XTRB0003,XTRB0005:
                                 XTRB0006,XTRB0004,XTRB0007,XTRB0008:
                                 XTRB0009,XTRB0010,XTRB0011,XTRB0012:
                                 XTRB0013,XTRB0014,XTRB0015,XTRB0016:
                                 XTRB0017,XTRB0018,XTRB0019,XTRB0020:
                                 XTRB0021,XTRB0022,XTRB0023,XTRB0024:
                                 XTRB0025,XTRB0026,XTRB0027,XTRB0028:
                                 XTRB0029,XTRB0030,XTRB0031,XTRB0032:
                                 XTRB0033,XTRB0034,XTRB0035,XTRB0036:
                                 XTRB0037,XTRB0038,XTRB0039,XTRB0040:
                                 XTRB0041,XTRB0042,XTRB0043,XTRB0044:
                                 XTRB0045,XTRB46AA,XTRB47AA,XTRB48AA:
                                 XTRB0049,XTRB50AA,XTRB51AA,XTRB0052:
                                 XTRB0053,XTRB0054,XTRB0055,XTRB0056:
                                 XTRB0057,XTRB0058,XTRB0059,XTRB0060:
                                 XTRB0061,XTRB0062,XTRB0063,XTRB0064:
                                 XTRB0065,XTRB0066,XTRB0067,XTRB68AA:
                                 XTRB69AA,XTRB0070,XTRB0071,XTRB0072:
                                 XTRB0073,XTRB0074,XTRB0075,XTRB0076:
                                 XTRB0077,XTRB0078,XTRB0079,XTRB0080:
                                 XTRB0081,XTRB0082,XTRB0083,XTRB0084:
                                 XTRB0085,XTRB0086,XTRB0087,XTRB0088:
                                 XTRB0089,XTRB0090,XTRB0091,XTRB0092:
                                 XTRB0093,XTRB0094,XTRB0095,XTRB0096:
                                 XTRB0097,XTRB0098,XTRB0099,XTRB0100:
                                 XTRB0101,XTRB0102,XTRB0103,XTRB104A:
                                 XTRB105A,XTRB0106,XTRB0107,XTRB0108:
                                 XTRB109A,XTRB110A,XTRB111A,XTRB112A:
                                 XTRB113A,XTRB114A,XTRB0115,XTRB0116:
                                 XTRB0117,XTRB0118,XTRB0119,XTRB0120:
                                 XTRB0121,XTRB0122,XTRB0123,XTRB0124:
                                 XTRB0125,XTRB0126,XTRB0127,XTRB0128:
                                 XTRB0129,XTRB0130,XTRB0131,XTRB0132:
                                 XTRB0133,XTRB0134,XTRB0135,XTRB0136:
                                 XTRB0137,XTRB0138,XTRB0139,XTRB0140:
                                 XTRB0141,XTRB0142,XTRB0143,XTRB0144:
                                 XTRB0145,XTRB0146,XTRB0147,XTRB0148:
                                 XTRB0149,XTRB0150,XTRB0151,XTRB0152:
                                 XTRB0153,XTRB154A,XTRB0155
          GOTO      LDTB9000 IF OVER
.
          RJUSTIFY  XTRB0004
          MOVE      XTRB0004,ADMISSNO       * Episode ID
.
          RJUSTIFY  XTRB0014
          MOVE      XTRB0014,URNUMBER       * Patient ID
.
          MATCH     TURBOCMD,XTRB0005       * TurboGrouper Command
          GOTO      LDTB9000 IF NOT EQUAL
.
          MATCH     TURBOCMD,XTRB0006       * PAS Command
          GOTO      LDTB9000 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70      * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,LDTB1000
.
          PACK      KEY8,ADMISSNO,SP70      * Read Admission extension File
          CALL      RDPMVX11
          BRANCH    OVRCD,LDTB1000
.
          MOVE      AURNO,URNUMBER
.
          PACK      KEY8,URNUMBER,SP70      * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,LDTB1000
.
          CALL      RDPMPX21                * Read PMI Extension File 2
          BRANCH    OVRCD,LDTB1000
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Discharge Date
          CALL      RDDSCH1
          BRANCH    OVRCD,LDTB1000
.
          MOVE      DDATE,ICDRDDTE      * Use Discharge Date to read ICD files.
          MOVE      DDATE,ENCENDAT      * Initialise end date
.
          CALL      LODDG000                * diags/morph codes (X 29)
          CALL      LODCF000                * COF (X 30)
          CALL      LODDD000                * Diagnosis dates (X 30)
          CALL      LODGX000                * GDX (X 30)
          CALL      LODDC000                * diagnosis coded by (X 200)
          CALL      LODDA000                * diagnosis coded date (X 200)
.
          CALL      LODIC000                * ACHI Intervention Codes (X 30)
          CALL      LODID000                * Intervention dates (X 30)
          CALL      LODGS000                * GSRG (X 30)
          CALL      LODIP000                * Intervention flags (X 200)
          CALL      LODIE000                * Intervention end dates (X 200)
          CALL      LODIU000                * Intervention coded by (X 200)
          CALL      LODIA000                * Intervention coded date (X 200)
.
          CALL      LODOD000                * Load current diagnosis/operations
.
          MOVE      ONE,EPSCD001
.
          CALL      TBLDRG00                * Load TurbGrouper DRG version ?
          BRANCH    EXIT,LDTB1000
.
          CALL      WRTDG000                * Write patecdaf
          CALL      WRTOP000                * Write patecoaf
          CALL      WRPGR000                * Write patpgraf/patmi1af/patdschf
          CALL      WRECM000                * write to patecmaf
          CALL      WRTIC000                * Write to paticuaf
.
          CALL      FTPD0000                * * get some details formatted
          MOVE      ADMISSNO,DRGADMN
          MOVE      SP70,DRGERR
          MOVE      PTDSDMDC,DRGMDC
          MOVE      PTDSDDRG,XDRGDRG
          MOVE      PTDSSIDX,DRGCCL
          MOVE      PTDSVOGU,DRGGRP
          MOVE      SP70,DRGNATWT
.
          CALL      PTLN0000                * print TG line of report
.
          GOTO      LDTB1000
.
LDTB9000  CLOSE     TURBOFL2,DELETE
.
LDTB9999  RETURN
+
.*********************************************************************
.         print a line of the report for TurboGrouper
.*********************************************************************
PTLN0000  MOVE      PACFNAME,KEY24
          PRINT     *1,"|",AURNO,*10,"|",DRGADMN,*19,"|",KEY24:
                    *44,"|",DRGADAT,*55,"|",DRGDDAT,*66,"|",XDRGDRG:
                    *71,"|",DRGMDC,*75,"| ",DRGCCL,*79,"| ",DRGNATWT:
                    *90,"|",DRGGRP,*94,"|",DRGERR,*132,"|"
.
          ADD       ONE,CNTRECS
          ADD       ONE,CLNO
          IF        CLNO>=FIFTY5
            CALL      HEAD0000
          ENDIF
.
PTLN9999  RETURN
+
.*********************************************************************
. Export and Load TurboGrouper files
.*********************************************************************
RTBG0000    READ      CONTROLF,SIXTY1;*230,MRCNTUSR
            MOVE      MRCNTUSR,USERID
.
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1               * TurboGrouper Remote User ID
            BRANCH    OVRCD,RTBG9999
.
            MOVE      ONE,TURBOCMD       * TurboGrouper Command (auto send)
            MOVE      ONE,TURBOCMD       * PAS Command (auto import)
            CLOCK     FULLTIME,TURBFTIM  * TurboGrouper file time  hhmmssuu
            REP       ": ",TURBFTIM
            REP       ". ",TURBFTIM
            SQUEEZE   TURBFTIM
.
            CLEAR     CMDLINE
            APPEND    "mrtweb02.us5 ",CMDLINE
            APPEND    FILENAM3,CMDLINE
            APPEND    ".txt ",CMDLINE
            APPEND    WBSEUID,CMDLINE          * User id
            APPEND    SP1,CMDLINE
            APPEND    WBSELOGN,CMDLINE        * Long Login Name
            APPEND    SP1,CMDLINE
            APPEND    TURBOCMD,CMDLINE
            APPEND    SP1,CMDLINE
            APPEND    TURBFTIM,CMDLINE
            RESET     CMDLINE
            EXECUTE   CMDLINE,TASKID
.
            PACK      FILENAM3,ANST,ANSU,ANSR,ANSI,ANSM,ANSP,PORT,SP70
            REP       " 0",FILENAM3
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      TURBOFL2,FILENAM3         * open the TurboGrouper file
            TRAPCLR   IO
            IF        OVRCD<>1
              CLOSE     TURBOFL2,DELETE         * Delete old temp file
            ENDIF
.
            CLEAR     CMDLINE
            APPEND    "mrtweb02.us7 ",CMDLINE
            APPEND    WBSEUID,CMDLINE
            APPEND    SP1,CMDLINE
            MOVE      PORT,KEY2
            REP       " 0",KEY2
            APPEND    KEY2,CMDLINE
            APPEND    SP1,CMDLINE
            APPEND    WBSELOGN,CMDLINE        * Long Login Name
            APPEND    SP1,CMDLINE
            APPEND    TURBOCMD,CMDLINE
            APPEND    SP1,CMDLINE
            APPEND    TURBFTIM,CMDLINE
            RESET     CMDLINE
            EXECUTE   CMDLINE,TASKID
.
            MOVE      ZERO,CNTRECS            * clear counter
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      TURBOFL2,FILENAM3       * open the TurboGrouper file
            TRAPCLR   IO
            IF        OVRCD<>1
              MOVE      ZERO,FILRFGRP           * File OK
            ELSE
              MOVE      ZERO,CPAGENO
              CALL      IBACLOCK
              CALL      HEAD132
              CALL      UND132
              PRINT     *N,*1,"Error: Output from TurboGrouper not found."
            ENDIF
.
RTBG9999  RETURN
.
          INC       CLPATCHC                * Code for WEBGROUP
          INC       CLPATICU
          INC       PATCHCIO/INC
          INC       PATMMBIO/INC
+
.
.******************************************************************************
.* Return for Web Conversion Labels
.******************************************************************************
CLOSHTML
OPENHTML
PROSQE00
DISSQE00
DELECO00
DELECD00
PATNAA00
CLPATDSC
WEBERR00   RETURN
+
          INC       STD001IO
          INC       CALCAGE                 * Calculate patients age
          INC       CALCDAYS                * Calculate number of days
          INC       CLPATMAS                * Clear master file variables
          INC       DGCLICAC
          INC       NHOSPDAY                * Calculate bed days in hospital
          INC       RHIHDAYS                * Calculate Hosp in Home Days   
.davvy    INC       PATCHGRP                * Replacement for PAT41GRP
          INC       PMIGTNID
          INC       WEBGROUP                * Web Grouper routines
          INC       PATGILOS                * Get intended LOS
          INC       PATGNFEE                * Generate rates
          INC       PATM10T9                * Map ICD10 to ICD9 codes
          INC       PATWIS11                * Calculate WIES11 values  *I-42039
          INC       PATWIS12                * Calculate WIES12 values  *I-51504
          INC       PATWIS13                * Calculate WIES13 values
          INC       PATWIS14                * Calculate WIES14 values
          INC       PATWIS15                * Calculate WIES15 values
          INC       PATWIS16                * Calculate WIES16 values
          INC       PATWIS17                * Calculate WIES17 values
          INC       PATWIS18                * Calculate WIES18 values
          INC       PATWIS19                * Calculate WIES19 values
          INC       PATWIS20                * Calculate WIES20 values
          INC       PATWIS21                * Calculate WIES21 values
          INC       RTIODAYS
          INC       WIESCALC                * Calculate WIES values
          INC       VALCONTR
          INC       GETCNEFF
          INC       VALCMXFN
.
          INC       MEHDLSIO/INC
          INC       MEHHONIO/INC
          INC       NHIMASIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       OPRTSMIO/INC
          INC       PATAFEIO/INC            * Additional fee for overnight
          INC       PATASDIO/INC            * Additional fee for daycase
          INC       PATBFEIO/INC            * Bed fee file
          INC       PATCMXIO/INC            * Casemix funding file
          INC       PATHDFIO/INC            * Daily fee for inliers
          INC       PATHLFIO/INC            * Lumpsum for overnight
          INC       PATHSPIO/INC            * 
          INC       PATLDFIO/INC            * Daily fee for low outliers
          INC       PATLSDIO/INC            * Lumpsum for same day
          INC       PATFN1IO/INC            * Health fund file
          INC       PATTRNIO/INC            * Tranfer file
.
          INC       PAT3MIIO/INC            * 3M DRG mapping file
          INC       PATASFIO/INC            * Admin special funding arrange file
          INC       PATCDEIO/INC            * Casemix data extract file
          INC       PATCMPIO/INC            * Complex mapping file
          INC       PATCODIO/INC            * Codes file
          INC       PATDSCIO/INC            * Discharge file
          INC       PATECDIO/INC            * Episode disease coding file
          INC       PATECMIO/INC            * Episode Morbidity Changes
          INC       PATECOIO/INC            * Episode operation coding file
          INC       PATICDIO/INC            * ICD disease file
          INC       PATICOIO/INC            * ICD operation file
          INC       PATICUIO/INC            * ICU file
          INC       PATMA1IO/INC            * Master file
          INC       PMSEDGIO/INC            * Effective DRG Dates
          INC       PMSPX2IO/INC            * Master file
          INC       PATMI1IO/INC            * Admission file
          INC       PATNIDIO/INC
          INC       PMSVX1IO/INC            * Admission file
          INC       PATPGRIO/INC            * Patient grouper file
          INC       PATW11IO/INC            * Victorian cost weights file
          INC       PATW12IO/INC            * Victorian cost weights fl *I-51504
          INC       PTW12BIO/INC            * Victorian cost weights file
          INC       PATW13IO/INC            * Victorian cost weights flle
          INC       PATW14IO/INC            * Victorian cost weights flle
          INC       PATW15IO/INC            * Victorian cost weights flle
          INC       PATW16IO/INC            * Victorian cost weights flle
          INC       PATW17IO/INC            * Victorian cost weights flle
          INC       PATW18IO/INC            * Victorian cost weights flle
          INC       PATW19IO/INC            * Victorian cost weights flle
          INC       PATW20IO/INC            * Victorian cost weights flle
          INC       PATW21IO/INC            * Victorian cost weights flle
          INC       PATWIEIO/INC            * Victorian cost weights flle
          INC       PATRDCIO/INC
          INC       WEBSECIO/INC
          INC       PATCFAIO/INC
          INC       PATFX1IO/INC
          INC       PMSCIDIO/INC            * Contract ID
          INC       PMSHCPIO/INC
          INC       SEXDSCIO
          INC       GETEFDRG           * Get Effective DRG Version
          INC       PATADTYP
+
