.**************************************************************************
.*  DGADTACH  :  Change an Admission from a Datagate request              *
.*               ~~~~~~~~~~~~~~~~~~~                                      *
.*                                                                        *
.*  Author    :  Mike Laming  (16/04/2002)                                *
.*                                                                        *
.*  Mods      :                                                           *
.*  V12.00.01   14/05/2025  Davin          TSK 0955096                    *
.*              Changed for Alphanumeric Visit Numbers                    *
.*  V11.00.01 01/04/2020  J.Tan             TSK 0868813                   *
.*              Changed PKNAME to DIM80                                   *
.*  V10.06.01 : 12/05/2015  Steve Armstrong  CAR 314108                   *
.*              Replaced PTCGDATE with KEY8 as PTCGDATE is no longer used *
.**************************************************************************
.*   V9.02.01 : 22/04/2002  Mike Laming                                   *
.*              Replace PMEDI with Composite variable PMEDIXX (which      *
.*              contains PMEDI+PTMXMCCD) Add call (SPLTPMED)to split these*
.*                                                                        *
.*                                                                        *
.**************************************************************************
          DEFPROC   DGADTACH
 IFGE     $$VER,7
.
.
+
.*************************************************************************
.*  DGACH000  :  Process datagate Admission message                      *
.*************************************************************************
DGACH000  MOVE      "ACH",RPLYHEAD
          CALL      ADOPE000                      * open some files
          CALL      CLEAR000                      * clear some fields
.
          MOVE      ZERO,OVRCD
          READ      DGATEOUT;*SB,PURNO;
.
          CALL      VALID000                      * read pat. details & validate
          BRANCH    EXIT,DGACH900                 * Error!  Patient not valid
.
.
. *SB will suppress blank fill, *SP will turn off suppress blank fill
.
          MOVE      ZERO,OVRCD
          READ      DGATEOUT;*SB,CSALIAS,KEY8,PTITL,PHOSP,PLDAYS:
                            PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2:
                            PSUBRB,PADD4,PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                            PBDATE,PCONT,PREG,PTYPE,POCCUP,PLDDATE,PMEDIXX:
                            PPENNO,PPNDTE,PREPAT,PSMOK,PMICRO,PCEASE:
                            PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3,PLOCDOC:
                            PFUNDH,PFNDTB,PFNDMM,PUSR1,PUSR2,PUSR3:
                            PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                            PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                            PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                            PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                            PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE:
                            PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS:
                            PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3:
                            PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4:
                            PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM:
                            PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC:
                            PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD:
                            PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR:
                            PMPXRHC1,PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT:
                            PTNINMPI,NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3:
                            NHMAPREI,NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4:
                            NHMAADD5,NHMADOB,NHMADDTH,NHMADOMC,NHMARES:
                            NHMAETH,NHMASEX,NHMADAT,NHMATIM,NHMAETH2:
                            NHMAETH3,PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1:
                            PTMXADD2,PTMXADD3,PTMXADD4,PTMXPOST,AADMNO:
                            ADATE,ATIME,AINVPRT,ALACDTE,ACANCEL,ADOCTR:
                            ADOCTL,ASRCE,ACLSS,ACARE,AFUNDH,AFNDTB:
                            AFNDMM,AELIG,AVISIT,AALERG,AILLN,ADIAG1:
                            ADIAG2,ADISC,ADOCTT,AALLOW,AMBS,ACLAIM:
                            ADIET,APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO:
                            ACOMM1,ACOMM2,APLUR,APURGE,AUSR1,AUSR2:
                            AUSR3,AUSR4,AUSR5,AUSR6,AUSR7,ADSCHI:
                            ARDRNAM,AFNDYY,AFNDCG,AOCCDTE,ACODDTE:
                            ARETDTE,AMUMADM,PTMIPVIS,ABWGHT,PMVXRHC1:
                            PMVXRH1G,PTMSFHAN,PTMSECRA,PTMSMGIN,PTMIDDIG:
                            PMVXRH1C,PTMIDOFR,PTMIREFD,PTMIDFCN,PTMIPHPU:
                            PTMIAGNC,PTMIESSF,PTMIUSR8,PTMIUSR9,PTMIUSR0:
                            PTMIPDRG,PTMIOPER,PTMIXWRD,PTMIADOC,PTMIREGS:
                            PTMIUYN1,PTMIUYN2,TWARD,TBED,TRATEF,TRATEG:
                            TDISC,TALLW,TATYPE,TADOCT,TRATEH,TEXTRA:
                            TRBTYP,TRBEND,TDEPT,PTTRLTYP,PTTREPNO,DSNAME:
                            DGNAME,PMPXINTR,PMPXLNG1,PMPXLNG2,PMPXLNG3:
                            PMPXPEML,PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP:
                            PMPXKMOB,PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML:
                            PMPXRCRP,PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER:
                            PMPXPHEI,PMPXPWEI,PMPXDREC,PMPXDVAC,PMPXPNSD:
                            PMPXUYN4,PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI:
                            PMPXCRIN,PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3:
                            PMPXUSR7,PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA:
                            PMPXMTLE,PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4:
                            PMPXMPOS,PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML:
                            PMPXMCNT,PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA:
                            PMPXFGNA,PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3:
                            PMPXFAD4,PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO:
                            PMPXFEML,PMPXFCNT,PMPXFCRP,PMPXFLAB,PMPXFREL:
                            PMVXVLOC,PMVXCFSG,PMVXINGP,PMVXCPTH,PMVXHCP1:
                            PMVXHCP2,PMVXHCP3,PMVXHCP4,PMVXRHC1,PMVXRHC2:
                            PMVXRHC3,PMVXRHC4,PMVXCADM,PMVXIRAD,PMVXIDUS:
                            PMVXCRAV,PMVXRCCT,PMVXAPWD,PMVXAPBD,PMVXPOWD:
                            PMVXPOBD,PMVXPSTY,PMVXVALW,PMVXPALW,PMVXINDC:
                            PMVXMDAV,PMVXFRMS,PMVXEDC1,PMVXEDC2,PMVXEDC3:
                            PMVXUDF1,PMVXUDF2,PMVXUDF3,PMVXUDF4,PMVXUDT1:
                            PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6:
                            DATETIME
.
          CALL      SPLTPMED                * Split PMEDIXX into PMEDI, PTMXMCCD
.
          MOVE      AADMNO,ADMISSNO         * get ready for call to CHGADM00
          MOVE      ADATE,PTMIS001          * save Admission date
          MOVE      ATIME,PTMIS002          * save Admission time
          MOVE      ACARE,TRNACARE          * save care class
          CALL      CHGADM00
          BRANCH    EXIT,DGACH900           * errors detected
.
.
. send reply message as successful
.
          MOVE      "00000",RPLYCODE              * successful message
          MOVE      SP50,RPLYDESC                 * clear error description
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC:
                            DGMISC1,DGMISC2,DGMISC3
.
          ADD       ONE,SUCCPROC                  * increm # success transactns
          GOTO      DGACH999
.
. --- send back an Error response ---
.
DGACH900  MOVE      WEBTITLE,RPLYDESC
.                                                 * RPLYCODE set up in PATCHADT
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC:
                            DGMISC1,DGMISC2,DGMISC3
          ADD       ONE,ERRRPROC                  * increm # error transactions
.
DGACH999  CALL      CLOS0000
          GOTO      ENDPROC1
+
.*************************************************************************
.*                      Internal routines                                *
.*************************************************************************
.
.***************************************************************************
.*  VALID000  :  read patients details & make sure we have a valid patient *
.*               Returns:  EXIT=0 --> Valid patient,   EXIT=1 --> ERROR    *
.***************************************************************************
VALID000  MOVE      ZERO,OVRCD
.
. get master file details
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1                       * U/R on file ?
          IF        OVRCD = 1
            GOTO    VALID800
          ENDIF
          CALL      RDPMPX21
.
.**       CALL      AMSV1000                      * save old address vars
.
VALID700  MOVE      ZERO,EXIT                     * we have a valid patient
          GOTO      VALID999
.
.
VALID800  MOVE      "Patient Master details not found",WEBTITLE
          MOVE      "02106",RPLYCODE
          GOTO      VALID990
.
.
VALID990  MOVE      ONE,EXIT
.
VALID999  RETURN
.
.***************************************************************************
.*  ADOPE000  :  open a few files                                          *
.***************************************************************************
ADOPE000  MOVE      ZERO,OVRCD
.
          IF        MHCNUSE = 1
            OPEN      MEHCJRA1,"mehcjraf"
            OPEN      MEHDIAA1,"mehdiaaf"
            OPEN      MEHLEGA1,"mehlegaf"
          ENDIF
.
          OPEN      PATCHCO1,"patchcof"       * Patient Code Changes
          OPEN      PATNUMW1,"patnumwr"       * Ward Usage
          OPEN      PATRATE1,"patratef"       * Rates Table
          OPEN      PATUNAA1,"patunaaf"       * Adm & Dsch Date Change Audit
          OPEN      PATWR1A4,"patwr1af"       * Ward/Bed Details
.
.
ADOPE9999 RETURN
.
.***************************************************************************
.*  CLEAR000  :  clear fields                                              *
.***************************************************************************
CLEAR000  CALL      CLPATMAS                      * clear master file vars
          CALL      CLPMSPX2                      * Clear Master Extn.2 
          CALL      CLPATMIS                      * clear admission vars
          MOVE      ZEROVISN,AADMNO
.
. clear PRA details
.
          PACK      PKNAME,SP70,SP10
          MOVE      SP50,PKADD1
          MOVE      SP50,PKADD2
          MOVE      SP50,PKSUBR
          MOVE      SP50,PKADD4
          MOVE      SP50,PKPOST
          MOVE      SP50,PKTELEP
          MOVE      SP50,PKTELEB
          MOVE      SP50,PKRELP
          MOVE      ZEROVISN,PKADMN
.
CLEAR999  RETURN
.
.***************************************************************************
.*  CLOS0000  :  close files                                               *
.***************************************************************************
CLOS0000  MOVE      ZERO,OVRCD
.
          CLOSE     MEHCJRA1
          CLOSE     MEHDIAA1
          CLOSE     MEHLEGA1
          CLOSE     PATCHCO1
          CLOSE     PATNUMW1
          CLOSE     PATRATE1
          CLOSE     PATUNAA1
          CLOSE     PATWR1A4
.
.
CLOS99999 RETURN
.
.***************************************************************************
.*                            End of DGADTACA ModulE                       *
.***************************************************************************
.
ENDPROC1  ENDPROC
+
