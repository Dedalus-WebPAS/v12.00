.******************************************************************************
.*                                                                            *
.* Include Name  : DGHLCOMN.PBL                                               *
.*                                                                            *
.* Function      : Subroutine Include for                                     *
.*                 Datagate HL7 interface routines                            *
.*                                                                            *
.* Subroutines   : DGMESSID : Get next message ID                             *
.*                 DGHLSEND : Send HL7 message                                *
.*                                                                            *
.* Modifications :                                                            *
.*        17/06/2004  Ebon Clements    CAR 50769                              *
.*                    Fixed transaction date and time in DGHLSEND             *
.*        05/02/2004  Steve Armstrong  CAR 47245                              *
.*                    Mods to populate HLBMPGID                               *
.*        09/01/2002  Steve Armstrong                                         *
.*                    Mods for sector locking when getting message id         *
.******************************************************************************
.
.******************************************************************************
.*                                 DGMESSID                                   *
.*                      Get next message ID & date/time                       *
.******************************************************************************
.
DGMESSID  MOVE      "  0",PRXCODE                 * System Lock Sector 0
          CALL      GETSLK00                      * Get System Lock-Sector 0
          READ      CONTROLF,ZERO;*87,IBCNMESI    * next message id
          MOVE      IBCNMESI,HLBMMESG
          ADD       ONE,IBCNMESI
          WRITAB    CONTROLF,ZERO;*87,IBCNMESI
          CALL      RELSLK00                      * Release System Lock-Sector 0
.
          CALL      IBACLOCK
          UNPACK    CTIMEIS,CHOUR,DIM1,CMIN,DIM1,KEY2
          PACK      HLBMDATE,CCC,CYY,CMM,CDD
          REP       " 0",HLBMDATE
          PACK      HLBMTIME,CHOUR,CMIN,KEY2
          REP       " 0",HLBMTIME
.
DGMESS99  RETURN
+
.******************************************************************************
.*                                 DGHLSEND                                   *
.*                      Send DG message to HL7BMTA1                           *
.******************************************************************************
.
DGHLSEND  MOVE      ZERO,OVRCD                               
          PACK      KEY35,HLBMSTAT,HLBMDATE,HLBMTIME,HLBMMESG
          CALL      RAHLBMT1                * check for existing key
          IF        OVRCD=0
            CALL      IBACLOCK
            UNPACK    CTIMEIS,CHOUR,DIM1,CMIN,DIM1,KEY2
            PACK      HLBMDATE,CCC,CYY,CMM,CDD
            REP       " 0",HLBMDATE
            PACK      HLBMTIME,CHOUR,CMIN,KEY2
            REP       " 0",HLBMTIME
            GOTO      DGHLSEND
          ENDIF
.
          MOVE      PRGID,HLBMPGID
          CALL      WRHLBMT1
.
DGHLSE99  RETURN
