.
. Global Parameters   : UPDATETY - Update Type 1=New Discharge
.                                              2=Update Discharge
.                       Discharge Record (PATDSCFD)
.
          DEFPROC   PATDAYAA
.
          INC       PATDAYFD/INC
.
FORM4     FORM      4
THISYEAR  DIM       4
TYEARR    DIM       4
.*************************************************************************
.*                               PATD0000                                *
.*              Update the patdayaf files if neccessary                  *
.*************************************************************************
PATD0000  READ      CONTROLF,FIFTY9;*174,PTCNNDAT,*209,PTCNDAYF
. 
          COMPARE   ZERO,PTCNDAYF           * skip if not using patdayaf
          GOTO      PATD9999 IF EQUAL         file for statistics
.
          MATCH     SP8,PTCNNDAT            * Don't update patdayaf files if
          GOTO      PATD9999 IF EQUAL         the update has not been run
.                                             before
          MATCH     "00000000",PTCNNDAT
          GOTO      PATD9999 IF EQUAL
.
          BRANCH    UPDATETY,PATD2000,PATD2000,PATD2000,PATD5000,PATD9999
.
.------ Update the patdayaf files for a discharged patient ------
.
PATD2000  PACK      STRTDATE,DDATE
          REP       " 0",STRTDATE
.
          MATCH     PTCNNDAT,STRTDATE    * don't process if discharge date is >
          GOTO      PATD9999 IF NOT LESS   or = date for next update
.
.------ we need to update from the day after the discharge date ------
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON              * convert to a julian date
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON    
.
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
.------ we need to update up until the day before the next update ------
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
          CALL      SUBD0000            * subtract a day from PTCNNDAT
.
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
.
          MATCH     STRTDATE,ENDDATE    * for the case when there is no
          GOTO      PATD9999 IF LESS      days between the discharge date and
.                                         the day for the next update
          MOVE      AADMNO,ADMISNO
          CALL      PATDAYDL            * delete records from patdayaf files
          GOTO      PATD9999
.
.------ Update the patdayaf files for a change in discharge date ------
.
PATD5000  MATCH     SDDATE,DDATE        * match new date to old discharge date
          GOTO      PATD5500 IF LESS
.
          PACK      STRTDATE,SDDATE
          REP       " 0",STRTDATE
.
.------ we need to update from the day after the old discharge date ------
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON              * convert to a julian date
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * convert back to CC,YY,MM,DD format
.
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
          PACK      ENDDATE,DDATE
          REP       " 0",ENDDATE
.
          MATCH     PTCNNDAT,ENDDATE    * match if new discharge date is less
          GOTO      PATD5100 IF LESS      than date for next update
.
.------ we need to update up until the day before the next update ------
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000            * subtract a day from PTCNNDAT
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
.
PATD5100  MOVE      AADMNO,ADMISNO
          CALL      PATDAYAD            * add records to the patdayaf files
          GOTO      PATD9999
.
.------ new discharge date is less than the old date ------
.
PATD5500  PACK      STRTDATE,DDATE
          REP       " 0",STRTDATE
.
.------ we need to update from the day after the new discharge date ------
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON              * convert to a julian date
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * convert back to CC,YY,MM,DD format
.
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
          PACK      ENDDATE,SDDATE
          REP       " 0",ENDDATE
.
          MATCH     PTCNNDAT,ENDDATE    * match if old discharge date is less
          GOTO      PATD5600 IF LESS      than date for next update
.
.------ we need to update up until the day before the next update ------
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000            * subtract a day from PTCNNDAT
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
.
PATD5600  MOVE      AADMNO,ADMISNO
          CALL      PATDAYDL            * delete records from patdayaf files
.
PATD9999  GOTO      PATDAYZZ
+
.*************************************************************************
.*                               SUBD0000                                *
.*              Routine to subtract one from a given date                *
.* Requires : CCENT, CYEAR, CMON, CDAY                                   *
.* Returns  : CC,YY, MM, DD                                              *
.*************************************************************************
SUBD0000  MOVE      CYEAR,YY
          MOVE      CCENT,CC
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON           * convert to julian date
.
          SUB       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * convert back to DD,MM,CC,YY format
.
SUBD9999  RETURN
+
          INC       PATDAYUP
          INC       PATDAYIO/INC
          INC       IBAOVRIO/INC
.
PATDAYZZ  ENDPROC
