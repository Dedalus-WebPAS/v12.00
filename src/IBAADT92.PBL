.******************************************************************************
.* System         :  Patient Billing                                          *
.* Program        :  IBAADT92                                                 *
.* Description    :  Upload Casemix Contract                                  *
.******************************************************************************
.* Date           :  06/11/2008                                               *
.* Author         :  J.Tan                                                    *
.* Function       :  Upload Casamix Contract from ASCII file                  *
.*----------------------------------------------------------------------------*
.* Modifications  :                                                           *
.*----------------------------------------------------------------------------*
.* V12.00.04 09/09/2025  J.Tan         TSK 0964591                            *
.*           Added Updating Casemix code keyword table                        *
.* V12.00.03 02/09/2025  J.Tan         TSK 0965845                            *
.*           Fixed deleting Header Matrix file (full read for default blank HF*
.* V12.00.02 19/06/2025  J.Tan         TSK 0962236                            *
.*           Mod Autofill blank Max/Min DaysStay                              *
.* V12.00.01 11/05/2025  J.Tan         TSK 0956953                            *
.*           Mod to validate Max/Min DaysStay only when both fields NOT zero  *
.* V11.05.02 13/02/2025  Bella Turco   TSK 0956953                            *
.*           Fixed validation of Max & Min Days Stay                          *
.* V11.05.01 06/02/2025  Bella Turco   TSK 0956910                            *
.*           Fixed validation of Bed Type code where only blank codes were    *
.*           being validated                                                  *
.* V11.04.03 05/07/2024  J.Tan         TSK 0942678                            *
.*           Mod checking if each Casemix code contract has rule              *
.* V11.04.02 26/02/2024  J.Tan         TSK 0910994                            *
.*           Added Attending Doctor,Concession and Discharge UDF fields       *
.* V11.04.01 21/12/2023  Thanh T       TSK 0910994                            *
.*           Removed IMTX0000. This is replaced with CLPMSCMT function in     *
.*           CLPMSCMT.PBL                                                     *
.*----------------------------------------------------------------------------*
.* V11.03.02 20/06/2023 J.Tan            TSK 0932182                          *
.*           Mod to delete UCPAYTXT tempfile after processing                 *
.* V11.03.01 17/04/2023 Don Nguyen       TSK 0919244                          *
.*           Added validations for ICD Diagnosis/Procedure codes              *
.*           with Primary, Secondary and Tertiary values.                     *
.* V11.02.02 01/09/2022 Alina Bhari      TSK 0921913                          *
.*           Corrected typo Casemic to Casemix                                *
.*           -ML3000,KOPT0000,PRHD0000,VCLD1000                               *
.* V11.02.01 30/08/2022 Alina Bhari      TSK 0921913                          *
.*           Added new option to upload Casemix Contract program              *
.*           to update the Exp.Lenfth of stay field.                          *
.*           -UDCC0000,VLCD0000,ML3000                                        *
.* V11.01.03 07/10/2021 J.Tan            TSK 0901515                          *
.*           Added for Primary ICD Procedures/Operation                       *
.* V11.01.02 07/04/2021  Tracey Nguyen   TSK 0901515                          *
.*           PMSCMTFD changes - Initialized new fields in IMTX0000            *
.*           a) 1 File type for ICD procedure (PMCCIPF)                       *
.*           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)            *
.*           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)            *
.*           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)            *
.* V11.01.01 09/03/2021  Tracey Nguyen   TSK 0901515                          *
.*           PMSCMTFD changes - Initialized Primary ICD Procedure 1-5         *
.*           (PMCCICP1-5) - IMTX0000                                          *
.*----------------------------------------------------------------------------*
.* V10.11.01  20/07/2017 Peter Vela                              TSK 0835226  *
.*                       Added Health Care Provider (Eclipse)                 *
.* V10.10.03  06/06/2017 J.Tan                                   TSK 0839835  *
.*                       Fixed I*C on tempfile for multiple matrix rules      *
.* V10.10.02  06/05/2017 J.Tan                                   TSK 0828182  *
.*                       Mod to check Version number of Spreadheet            *
.* V10.10.01  21/03/2017 J.Tan                                   TSK 0315207  *
.*                       Added Target LOS to patcmxaf file                    *
.* V10.08.01  27/04/2016 J.Tan                                   CAR  0290448 *
.*                       Fixed updating patafeaf-Non-Accum.,FI grp,Npday      *
.* V10.07.02  02/03/2016 J.Tan                                   CAR  0290448 *
.*                       Added new fields for patafeaf-Non-Accum.,FI grp,Npday*
.* V10.07.01  23/11/2015 J.Tan                                     CAR 323997 *
.*                       Increased the amount fields from 5.2 to 7.2          *
.* V10.06.01  15/07/2015 J.Tan                                     CAR 319342 *
.*                       Changed Matrix Disc.UDF to Care Class                *
.* V10.03.08  11/12/2013 J.Tan                                     CAR 293857 *
.*                       Mods to print 'Upload Successfully Completed'        *
.* V10.03.07  13/11/2013 J.Tan                                     CAR 293745 *
.*                       Added Eclipse Equivalent & Type of Service           *
.* V10.03.06  12/08/2013 J.Tan                                     CAR 289527 *
.*                       Mods checking for inactive Health fund               *
.* V10.03.05  10/05/2013 J.Tan                                     CAR 282824 *
.*                       Added Transfer Trim Point                            *
.* V10.03.04  19/12/2012 Patrick Adair                             CAR 261630 *
.*                       Removed port number from temp file name              *
.*                   V10.03.03 21/09/2012 J.Tan           CAR 271474          *
.*                   Mods to write to Matrix Header file (patcmtaf)           *
.*                   V10.03.02 15/03/2012 J.Tan           CAR 261889          *
.*                   Mods validating Discharge Status                         *
.*                   V10.03.01 29/11/2011 J.Tan           CAR 256436          *
.*                   Fixed deleting Casemix Matrix table                      *
.*                   V10.02.03 08/04/2011 J.Tan           CAR 233160          *
.*                   Fixed option for removing contract                       *
.*                   V10.01.02 30/03/2011 J.Tan           CAR 233160          *
.*                   Removed Health fund table code                           *
.*                   V10.01.01 24/03/2011 J.Tan           CAR 233160          *
.*                   Mods to include multiple rules                           *
.*                   V10.00.02 22/07/2010 Jill Parkinson  CAR 226456          *
.*                   Changed FNAMEI and PATHNAME fro 150 to 500 characters    *
.*                   V10.00.01 02/06/2010 J.Tan    CAR 216918                 *
.*                   Remove casemix matrix rules if no other details for the  *
.*                   Contract ID (patcmxaf)                                   *
.*                   V9.12.05 11/03/2010 J.Tan    CAR 217896                  *
.*                   Mods checking for existing Casemix funding file for same *
.*                   Contract only                                            *
.*                   V9.12.04 04/01/2010 J.Tan    CAR 212998                  *
.*                   Added an option to remove contract from new files        *
.*                   V9.12.03 17/12/2009 J.Tan    CAR 212919                  *
.*                   Removed writing Low outlier record to pathdfaf file      *
.*                   V9.12.02 28/09/2009 J.Tan    CAR 181327                  *
.*                   Mods to check for spaces of key before deleting record   *
.*                   V9.12.01 03/09/2009 J.Tan    CAR 205303                  *
.*                   Added Contract ID                                        *
.*                   V9.11.02 28/04/2009 J.Tan    CAR 195689                  *
.*                   Fixed option by health fund group                        *
.*                   V9.11.01 04/03/2009 J.Tan                                *
.*                   Fixed copy New to Current for patldfaf and patafeaf file *
.******************************************************************************
.
          INC       STD001FD
.
          INC       IBASEQFD/INC            * Sequential Numbers File
          INC       PATCODFD/INC            * Codes file
          INC       PATDO1FD/INC            * Doctor File
          INC       PMSCIDFD/INC            * Contract ID file
          INC       PATCMCFD/INC            * Casemix code file
          INC       PATCFAFD/INC            * Claim code file
          INC       PATFN1FD/INC            * Health fund file
          INC       PATFX1FD/INC            * Health fund file
          INC       PATHGPFD/INC            * Health fund group
          INC       PATCMXFD/INC            * Casmix funding
          INC       PATLSDFD/INC            * Lumpsum for sameday
          INC       PATASDFD/INC            * Additional charges for sameday
          INC       PATHLFFD/INC            * Lumpsum for overnight
          INC       PATLDFFD/INC            * Daily fee for low outlier
          INC       PATHDFFD/INC            * Daily fee for Inlier/High outlier
          INC       PATAFEFD/INC            * Additional fee for overnight
          INC       PMSCMTFD/INC            * Matrix
          INC       PATCMTFD/INC            * Matrix
          INC       PMSDCAFD/INC            * Audit file
          INC       TFILEVAR/INC            * Generate Temp File Name
          INC       WEBERRFD/INC            * Web Server Error Logging
.
          INC       PATCONFD/INC            * Inpatient CONTROL File
          INC       PATICDFD/INC            * ICD Diagnosis (Diseases)
          INC       PATICOFD/INC            * ICD Procedures (Operations)
          INC       PATKCMFD/INC            * Casemix Codes Key Words
.
.         Temporary file for Casemix contract records which
.         are loaded from the upload file provided by the customer (PROC0000)
.
.         Casemix Contract Upload file
.
UCPAYTXT  FILE       HL7, FIXED=1000        * Upload file for Case payment
.
.Name     Type     Size     Start
.----     ----     ----     -----
XCNTID    DIM         6     Contract ID
XCLMCD    DIM         3     Claim Code
XHFCOD    DIM         6     Health Fund code
XHFTYP    DIM         3     Health Fund Type code (Catg HT)
XCASCD    DIM         9     Casemix Code
XSTTYP    DIM         1     Start Type
XEFDAT    DIM         8     Effective Start date
XEDATE    DIM         8     End Date
XCSTYP    DIM         1     Type of Casemix
XEXLOS    FORM        3     Expected LOS/Inlier Cut off day
. <PATLSDFD>
XDLUMD    DIM         30    Daycase Lumpsum Description
XDREBP    FORM        7.2   Daycase Rebate Lumpsum amount
XDPATP    FORM        7.2   Daycase Patient Lumpsum amount
. <PATHLFFD>
XOLUMD    DIM         30    Overnight Lumpsum Description
XOREBP    FORM        7.2   Overnight Rebate Lumpsum amount
XOPATP    FORM        7.2   Overnight Patient Lumpsum amount
. <PATLDFFD>
XLCOFF    FORM        3     Low outlier cut off
XLDESC    DIM         30    Low outlier fees description
XLREBP    FORM        7.2   Low outlier rebate portion
XLPATP    FORM        7.2   Low outlier patient portion
. <PATHDFFD> - pthddtyp=1  cut off is the Exp.LOS
XOIND1    DIM         30    Overnight Inlier Description
XOINP1    FORM        7.2   Overnight Inlier patient portion
XOINR1    FORM        7.2   Overnight Inlier rebate portion
. <PATHDFFD> - pthddtyp=2  
XOIND2    DIM         30    Overnight Inlier Description
XOINP2    FORM        7.2   Overnight Inlier patient portion
XOINR2    FORM        7.2   Overnight Inlier rebate portion
. <PATHDFFD> - pthddtyp=2  
XOCOF3    FORM        4     Intermediate cut off day
XOIND3    DIM         30    Overnight Inlier Description
XOINP3    FORM        7.2   Overnight Inlier patient portion
XOINR3    FORM        7.2   Overnight Inlier rebate portion
. <PATHDFFD> - pthddtyp=2  cut off is 9999
XOCOF4    FORM        4     Intermediate cut off day
XOIND4    DIM         30    Overnight Inlier Description
XOINP4    FORM        7.2   Overnight Inlier patient portion
XOINR4    FORM        7.2   Overnight Inlier rebate portion
.
. overnight PATAFEFD
XAEDAY    FORM        4     Ending day
XABTYP    DIM         3     Bed type
XADESC    DIM         30    Description for additional 
XAREBP    FORM        7.2   Rebate portion
XAPATP    FORM        7.2   Patient portion
XAACIN    DIM         1     Non-Accumulative Inliers
XAFIGR    DIM         3     Fees Invoiced Group (Cat FI)
XANPDY    DIM         1     Charge on No Pay Day
.
. <PMSCMTFD>
.PMCCPODY FORM        4     Pre Op Cut off day
.PMCCNPDY FORM        4     No pay days
.PMCCMIND FORM        4     Min day
.PMCCHBPT FORM        4     Max day/High boundary point
.PMCCCCDY FORM        4     Critical care cut off
.
.PMCCCNTR FORM        6     Rule Number
.PMCCFTDG DIM         1     DRG based casemix (Y/N)
.PMCCDDRG DIM         4     DRG Casemix code
.
.PMCCFTCM FORM        1     Mandatory for Primary MBS (if XMDRGF<>Y) (Y/N)
.PMCCPCMF DIM         9     Start MBS item in range
.PMCCPCMT DIM         9     End MBS item in range
.
.PMCCFTSC FORM        1     Mandatory for Secondary MBS (if XMDRGF<>Y) (Y/N)
.PMCCSCMF DIM         9     Start MBS item in range
.PMCCSCMT DIM         9     End MBS item in range

.PMCCFTTC FORM        1     Mandatory for Tertiary  MBS (if XMDRGF<>Y) (Y/N)
.PMCCFTMF DIM         9     Start MBS item in range
.PMCCFTMT DIM         9     End MBS item in range
.
.PMCCFTDS FORM        1     Field type for discharge destination
.PMCCDSTA DIM         3     Discharge status 1
.PMCCDST2 DIM         3     Discharge status 2
.PMCCDST3 DIM         3     Discharge status 3
.PMCCDST4 DIM         3     Discharge status 4
.PMCCDST5 DIM         3     Discharge status 5
.
.PMCCFTDD FORM        1     Field type for discharge destination
.PMCCDDES DIM         3     Discharge destination 1
.PMCCDDE2 DIM         3     Discharge destination 2
.PMCCDDE3 DIM         3     Discharge destination 3
.PMCCDDE4 DIM         3     Discharge destination 4
.PMCCDDE5 DIM         3     Discharge destination 5
.
.PMCCFTAS FORM        1     Field type for discharge Admission source
.PMCCASRC DIM         3     Discharge Admission source 1
.PMCCASR2 DIM         3     Discharge Admission source 2
.PMCCASR3 DIM         3     Discharge Admission source 3
.PMCCASR4 DIM         3     Discharge Admission source 4
.PMCCSAR5 DIM         3     Discharge Admission source 5
.
.PMCCFT1C FORM        1     Field type for Primary ICD Disease
.PMCCPICD DIM         3     Primary ICD Disease 1
.PMCCPIC2 DIM         3     Primary ICD Disease 2
.PMCCPIC3 DIM         3     Primary ICD Disease 3
.PMCCPIC4 DIM         3     Primary ICD Disease 4
.PMCCPIC5 DIM         3     Primary ICD Disease 5
.
.PMCCFTAT FORM        1     Field type Admission type
.PMCCATYP DIM         3     Admission Type 1
.PMCCATY2 DIM         3     Admission Type 2
.PMCCATY3 DIM         3     Admission Type 3
.PMCCATY4 DIM         3     Admission Type 4
.PMCCATY5 DIM         3     Admission Type 5
.
.PMCCFTAU FORM        1     Field type Admission UDF
.PMCCAUDF DIM         3     Admission UDF 1
.PMCCAUD2 DIM         3     Admission UDF 2
.PMCCAUD3 DIM         3     Admission UDF 3
.PMCCAUD4 DIM         3     Admission UDF 4
.PMCCAUD5 DIM         3     Admission UDF 5
.
.PMCCFTDU FORM        1     Field type Care Class
.PMCCDUDF DIM         3     Care Class 1
.PMCCDUD2 DIM         3     Care Class 2
.PMCCDUD3 DIM         3     Care Class 3
.PMCCDUD4 DIM         3     Care Class 4
.PMCCDUD5 DIM         3     Care Class 5
.
XTRPOINT  FORM        3     Transfer Trim Point
XECLECEQ  DIM         11    Eclipse Equivalent
XECLECTS  DIM         2     Eclipse Type of Service
XTARGLOS  DIM         4     Target LOS
XECLEHCP  DIM         2     Health Care Provider (Eclipse)
.
.PMCCICPF FORM        1     Field type for Primary ICD Procedure
.PMCCICP1 DIM         3     Primary ICD Procedure 1
.PMCCICP2 DIM         3     Primary ICD Procedure 2
.PMCCICP3 DIM         3     Primary ICD Procedure 3
.PMCCICP4 DIM         3     Primary ICD Procedure 4
.PMCCICP5 DIM         3     Primary ICD Procedure 5
.
.PMCCFTS4 FORM        1     Mandatory for 4th MBS (if XMDRGF<>Y) (Y/N)
.PMCCPC4F DIM         9     Start MBS item in range
.PMCCPC4T DIM         9     End MBS item in range
.
.PMCCFT5C FORM        1     Mandatory for 5th MBS (if XMDRGF<>Y) (Y/N)
.PMCCSC5F DIM         9     Start MBS item in range
.PMCCSC5T DIM         9     End MBS item in range

.PMCCFT6C FORM        1     Mandatory for 6th MBS (if XMDRGF<>Y) (Y/N)
.PMCCTC6F DIM         9     Start MBS item in range
.PMCCTC6T DIM         9     End MBS item in range
.
.PMCCFTAD FORM        1     Field Type for Attending Dr
.PMCCADOC DIM         10    Attending Doctor (patmi1af.adocta)
.
.PMCCFTCC FORM        1     Field Type for Concession Card Type
.PMCCCCT1 DIM         3     Concession Card Type 1 (cat ct)
.PMCCCCT2 DIM         3     Concession Card Type 2 (cat ct)
.PMCCCCT3 DIM         3     Concession Card Type 3 (cat ct)
.PMCCCCT4 DIM         3     Concession Card Type 4 (cat ct)
.PMCCCCT5 DIM         3     Concession Card Type 5 (cat ct)
.
.PMCCFDDU FORM        1     Field Type for Discharge UDF
.PMCCUDF1 DIM         3     Discharge UDF 1 (cat D1)
.PMCCUDF2 DIM         3     Discharge UDF 2 (cat D2)
.PMCCUDF3 DIM         3     Discharge UDF 3 (cat D3)
.PMCCUDF4 DIM         3     Discharge UDF 4 (cat D4)
.PMCCUDF5 DIM         3     Discharge UDF 5 (cat D5)

.End of Record
.
. ----- Program Variables -----
.
CONTRCID  DIM       6
CMDLINE   DIM       100
DIM3      DIM       3
ERRFLAG   FORM      1
ENDDATE   DIM       8
ERRCOUNT  FORM      8
ERRORMSG  DIM       30
CLERROR   FORM      1
HFERROR   FORM      1
HEADFLAG  FORM      1
FNAMEI    DIM       500
FNAME1    DIM       8
.
AUSR1     INIT      "U1"
AUSR2     INIT      "U2"
AUSR3     INIT      "U3"
AUSR4     INIT      "U4"
AUSR5     INIT      "U5"
AUSR6     INIT      "U6"
AUSR7     INIT      "U7"
PTMIUSR8  INIT      "U8"
PTMIUSR9  INIT      "U9"
PTMIUSR0  INIT      "U0"
.
DUSD1     INIT      "D1"
DUSD2     INIT      "D2"
DUSD3     INIT      "D3"
DUSD4     INIT      "D4"
DUSD5     INIT      "D5"
.
KYCLAIM   DIM       3
KYHFGRP   DIM       6
KYHFUND   DIM       6
KYHFTYP   FORM      1
KYREMRC   FORM      1
.
TEMPFILE  IFILE     SQL, FIXED=4, KEY="uc1-3"
.
LINECNTR  FORM      8
MODE      DIM       1
NEWRECD   FORM      1
PATHNAME  DIM       500
SAVKEY20  DIM       20
SKEY25    DIM       25
SKEY24    DIM       24
SAVCLAIM  DIM       3
SAVHFUND  DIM       6
SPMCPODY  FORM      12.2
SPMCNPDY  FORM      12.2
SPMCMIND  FORM      12.2
SPMCHBPT  FORM      12.2
SPMCCCDY  FORM      12.2
USERID    DIM       10
VALDFLAG  FORM      1
ZERO8     INIT      "0000    "
MINSTAY   FORM      4
MAXSTAY   FORM      4
.
XFLD0001  DIM       30
XFLD0002  DIM       30
XFLD0003  DIM       30
XFLD0004  DIM       30
XFLD0005  DIM       30
XFLD0006  DIM       30
XFLD0007  DIM       30
XFLD0008  DIM       30
XFLD0009  DIM       30
XFLD0010  DIM       30
XFLD0011  DIM       30
XFLD0012  DIM       30
XFLD0013  DIM       30
XFLD0014  DIM       30
XFLD0015  DIM       30
XFLD0016  DIM       30
XFLD0017  DIM       30
XFLD0018  DIM       30
XFLD0019  DIM       30
XFLD0020  DIM       30
XFLD0021  DIM       30
XFLD0022  DIM       30
XFLD0023  DIM       30
XFLD0024  DIM       30
XFLD0025  DIM       30
XFLD0026  DIM       30
XFLD0027  DIM       30
XFLD0028  DIM       30
XFLD0029  DIM       30
XFLD0030  DIM       30
XFLD0031  DIM       30
XFLD0032  DIM       30
XFLD0033  DIM       30
XFLD0034  DIM       30
XFLD0035  DIM       30
XFLD0036  DIM       30
XFLD0037  DIM       30
XFLD0038  DIM       30
XFLD0039  DIM       30
XFLD0040  DIM       30
XFLD0041  DIM       30
XFLD0042  DIM       30
XFLD0043  DIM       30
XFLD0044  DIM       30
XFLD0045  DIM       30
XFLD0046  DIM       30
XFLD0047  DIM       30
XFLD0048  DIM       30
XFLD0049  DIM       30
XFLD0050  DIM       30
XFLD0051  DIM       30
XFLD0052  DIM       30
XFLD0053  DIM       30
XFLD0054  DIM       30
XFLD0055  DIM       30
XFLD0056  DIM       30
XFLD0057  DIM       30
XFLD0058  DIM       30
XFLD0059  DIM       30
XFLD0060  DIM       30
XFLD0061  DIM       30
XFLD0062  DIM       30
XFLD0063  DIM       30
XFLD0064  DIM       30
XFLD0065  DIM       30
XFLD0066  DIM       30
XFLD0067  DIM       30
XFLD0068  DIM       30
XFLD0069  DIM       30
XFLD0070  DIM       30
XFLD0071  DIM       30
XFLD0072  DIM       30
XFLD0073  DIM       30
XFLD0074  DIM       30
XFLD0075  DIM       30
XFLD0076  DIM       30
XFLD0077  DIM       30
XFLD0078  DIM       30
XFLD0079  DIM       30
XFLD0080  DIM       30
XFLD0081  DIM       30
XFLD0082  DIM       30
XFLD0083  DIM       30
XFLD0084  DIM       30
XFLD0085  DIM       30
XFLD0086  DIM       30
XFLD0087  DIM       30
XFLD0088  DIM       30
XFLD0089  DIM       30
XFLD0090  DIM       30
XFLD0091  DIM       30
XFLD0092  DIM       30
XFLD0093  DIM       30
XFLD0094  DIM       30
XFLD0095  DIM       30
XFLD0096  DIM       30
XFLD0097  DIM       30
XFLD0098  DIM       30
XFLD0099  DIM       30
XFLD0100  DIM       30
XFLD0101  DIM       30
XFLD0102  DIM       30
XFLD0103  DIM       30
XFLD0104  DIM       30
XFLD0105  DIM       30
XFLD0106  DIM       30
.
XFLD0107  DIM       30
XFLD0108  DIM       30
XFLD0109  DIM       30
XFLD0110  DIM       30
XFLD0111  DIM       30
XFLD0112  DIM       30
.
XFLD0113  DIM       30
XFLD0114  DIM       30
XFLD0115  DIM       30
XFLD0116  DIM       30
XFLD0117  DIM       30
XFLD0118  DIM       30
XFLD0119  DIM       30
XFLD0120  DIM       30
XFLD0121  DIM       30
.
XFLD0122  DIM       30
XFLD0123  DIM       30
.
XFLD0124  DIM       30
XFLD0125  DIM       30
XFLD0126  DIM       30
XFLD0127  DIM       30
XFLD0128  DIM       30
XFLD0129  DIM       30

XFLD0130  DIM       30
XFLD0131  DIM       30
XFLD0132  DIM       30
XFLD0133  DIM       30
XFLD0134  DIM       30
XFLD0135  DIM       30
.
PRGID     INIT      "IBAADT92"
PRGNAM    INIT      "Upload Casemix Contract"
VERSION   INIT      "V12.00.04"
+
.******************************************************************************
.*                                  ML0000                                    *
.*                                Main Module                                 *
.******************************************************************************
ML0000    CALL      INIT0000                * Initailize variables & open files
          CALL      KOPT0000                * Keyin Upload or Update option
          BRANCH    EXIT,ML9999
.
          BRANCH    COPTION,ML1000,ML2000,ML3000
          GOTO      ML9999
.
ML1000    CALL      KASC0000                * Keyin ascii file
          BRANCH    EXIT,ML9900,ML9900
.
          CALL      OPTN0000                * Choose options
          BRANCH    EXIT,ML9999
.
ML1100    CALL      SCRD0000                * Display screen
.
          CALL      KFLD0000                * Keyin fields
          BRANCH    EXIT,ML0000
.
          CALL      KUSR0000              * Keyin user id
          BRANCH    EXIT,ML0000
.
          CALL      KPTH0000              * Keyin pathname
          BRANCH    EXIT,ML0000
.
          CALL      SFLD0000
          BRANCH    EXIT,ML1100
.
          CALL      PRHD0000              * Print header
.
          MOVE      ONE,VALDFLAG          * Validation
          CALL      GFND0000
          BRANCH    EXIT,ML9000
.
          IF        ERRCOUNT=0
            MOVE      ONE,CLERROR
            MOVE      ONE,HFERROR
            MOVE      ZERO,VALDFLAG
            CALL      POST0000            * Updating file
          ENDIF
.
          GOTO      ML9000
.
.         Remove Contract
.
ML2000    CALL      OPTN0000                * Choose options
          BRANCH    EXIT,ML9999
.
          CALL      SCRR0000                * Display screen
          CALL      KCNT0000                * Keyin Contract ID
          BRANCH    EXIT,ML0000
          CALL      KCLM0000                * Keyin claim code
          BRANCH    EXIT,ML9999
.
          IF        OPTION<>3
            CALL      KFND0000              * Keyin HF code/ HF Group
            BRANCH    EXIT,ML9999
          ENDIF
          CALL      KUSR0000                * Keyin user id
.
          CALL      PRHD0000                * Print header
          CALL      RMCN0000                * Remove Contract
          GOTO      ML9999
.
.         Upload Contract
.
.         Upload Exp. Length of Stay to Casemix Codes
ML3000    CALL      KASC0000                * Keyin ascii file
          BRANCH    EXIT,ML9900,ML9900
.
          CALL      SCRL0000                * Display screen
          CALL      KUSR0000                * Keyin user id
.
          CALL      KPTH0000                * Keyin pathname
          BRANCH    EXIT,ML0000
.
          CALL      PRHD0000                * Print header
.
          CALL      VCLD0000                * Validate the casemix code 
.
          IF        ERRCOUNT=0
            CALL      UDCC0000              * Update Casemix Code
          ENDIF           
.
ML9000    CLOSE     UCPAYTXT
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      UCPAYTXT,FNAMEI
          TRAPCLR   IO
          IF        OVRCD=0
            CLOSE     UCPAYTXT,DELETE
          ENDIF
.
          GOTO      ML9999
.
ML9900    CALL      HEAD132
          PRINT     *N,"Failed to open upload file. "
          IF        EXIT=2
            PRINT     *N,"Check Version of the Spreadsheet. "
          ENDIF
.
ML9999    CHAIN     PGM
+
.******************************************************************************
.*                                 INIT0000                                   *
.*                     Initialize Variables & Open Files                      *
.******************************************************************************
INIT0000  CALL      DISPHEAD                * Display screen heading
.
          CALL      IBACLOCK
.
          DISPLAY   *P56:24,"Opening patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patfn1af"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFN1A3,"patfn1af"
          OPEN      PATFX1A1,"patfx1af"
.
          DISPLAY   *P64:24,"pmscidaf"
          OPEN      PMSCIDA1,"pmscidaf"
.
          DISPLAY   *P64:24,"pathgrpf"
          OPEN      PATHGRP1,"pathgrpf"
.
          DISPLAY   *P64:24,"patcfaaf"
          OPEN      PATCFAA1,"patcfaaf"
.
          DISPLAY   *P64:24,"patcmxaf"
          OPEN      PATCMXA1,"patcmxaf"
          OPEN      PATCMXA2,"patcmxaf"
.
          DISPLAY   *P64:24,"patlsdaf"
          OPEN      PATLSDA1,"patlsdaf"
.
          DISPLAY   *P64:24,"patasdaf"
          OPEN      PATASDA1,"patasdaf"
.
          DISPLAY   *P64:24,"pathlfaf"
          OPEN      PATHLFA1,"pathlfaf"
.
          DISPLAY   *P64:24,"patldfaf"
          OPEN      PATLDFA1,"patldfaf"
.
          DISPLAY   *P64:24,"pathdfaf"
          OPEN      PATHDFA1,"pathdfaf"
.
          DISPLAY   *P64:24,"patafeaf"
          OPEN      PATAFEA1,"patafeaf"
.
          DISPLAY   *P64:24,"pmscmtaf"
          OPEN      PMSCMTA1,"pmscmtaf"
          OPEN      PMSCMTA2,"pmscmtaf"
.
          OPEN      PATCMTA1,"patcmtaf"
          OPEN      PATCMTA2,"patcmtaf"
.
          DISPLAY   *P64:24,"patcmcaf"
          OPEN      PATCMCA1,"patcmcaf"
.
          DISPLAY   *P64:24,"pmsdcaaf"
          OPEN      PMSDCAA1,"pmsdcaaf"
.
          DISPLAY   *P64:24,"patdo1af"
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND05;*71,PTCNCMAU,*73,PTCNCMDU
.
          CALL      OPICD1                  * Open ICD Disease files
          CALL      OPICO1                  * Open ICD Operation files
.
          MOVE      ZERO,ERRFLAG
          MOVE      ONE,CLERROR
          MOVE      ONE,HFERROR
          MOVE      ZERO,ERRCOUNT
INIT9999  RETURN
+
.******************************************************************************
.*                                 KOPT0000                                   *
.*                            Choose Upload or Update files                   *
.******************************************************************************
KOPT0000  MOVE      ZERO,EXIT
          MOVE      ZERO,COPTION
          DISPLAY   *P1:6,*EF:
                    *P1:6,*V2LON,"0",*HOFF," = Exit":
                    *P1:7,*V2LON,"1",*HOFF," = Upload Casemix Contract":
                    *P1:9,*V2LON,"2",*HOFF," = Remove Contract":
                    *P1:11,*V2LON,"3",*HOFF," = Upload Exp. Length of Stay to":
                                                " Casemix Codes";
          DISPLAY   *P1:13,"Select Option : ";
.
KOPT1000  KEYIN     *P17:13,*V2LON,COPTION;
          BRANCH    COPTION,KOPT9999,KOPT9999,KOPT9999
.
          COMPARE   ZERO,COPTION
          GOTO      KOPT9000 IF EQUAL
          BEEP
          GOTO      KOPT1000
.
KOPT9000  MOVE      ONE,EXIT
KOPT9999  RETURN
+
.******************************************************************************
.*                                 OPTN0000                                   *
.*                            Choose HF group or HF code                      *
.******************************************************************************
OPTN0000  MOVE      ZERO,EXIT
          MOVE      ZERO,OPTION
          DISPLAY   *P1:6,*EF:
                    *P1:6,*V2LON,"0",*HOFF," = Exit":
                    *P1:7,*V2LON,"1",*HOFF," = By Health fund Group":
                    *P1:8,*V2LON,"2",*HOFF," = By Health fund":
                    *P1:9,*V2LON,"3",*HOFF," = Default Health fund/table";
          DISPLAY   *P1:10,"Select Option : ";
.
OPTN1000  KEYIN     *P17:10,*V2LON,OPTION;
          BRANCH    OPTION,OPTN9999,OPTN9999,OPTN9999
.
          COMPARE   ZERO,OPTION
          GOTO      OPTN9000 IF EQUAL
          BEEP
          GOTO      OPTN1000
.
OPTN9000  MOVE      ONE,EXIT
OPTN9999  RETURN
+
.******************************************************************************
.*                                 KASC0000                                   *
.*                            Keyin ASCI file                                 *
.******************************************************************************
KASC0000  MOVE      ZERO,EXIT
          PACK      FNAMEI WITH SP70,SP70,SP70
.
          DISPLAY   *P19:13,*EF,"Casemix Contract Load File";
.
          KEYIN     *P1:14,*EL,"Keyin Path & File Name : ",*V2LON,FNAMEI
.
          PACK      FNAMEI,FNAMEI,SP70,SP70,SP70
.
          MATCH     SP70,FNAMEI
          GOTO      KASC9000 IF EQUAL
.
          SCAN      ".txt",FNAMEI
          IF        !@EQUAL
            SQUEEZE   FNAMEI
            ENDSET    FNAMEI
            APPEND    ".txt",FNAMEI      * add ".txt" if there is a path
            APPEND    SP70,FNAMEI
            RESET     FNAMEI
          ENDIF
          RESET     FNAMEI
.
          DISPLAY   *P26:14,*V2LON,*EL,FNAMEI;
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      UCPAYTXT,FNAMEI
          TRAPCLR   IO
          BRANCH    OVRCD,KASC8000
.
KASC1000  READ      UCPAYTXT,SEQ;XFLD0001,XFLD0002
          GOTO      KASC8200 IF OVER         * file is empty
.
          SCAN      "Description",XFLD0001
          GOTO      KASC1000 IF NOT EQUAL
.
          SCAN      "V001",XFLD0001
          GOTO      KASC8400 IF NOT EQUAL
.
          CALL      EXCUS000
          MOVE      ZERO,EXIT
          GOTO      KASC9999
.
KASC8000  DISPLAY   *P1:24,*EL,*B,"File not found.  ";
          CALL      HITENTER
          GOTO      KASC9000
.
KASC8200  DISPLAY   *P1:24,*EL,*B,"File is empty.  ";
          CALL      HITENTER
          GOTO      KASC9000
.
KASC8400  DISPLAY   *P1:24,*EL,*B,"Check Version of the Spreadsheet.";
          CALL      HITENTER
          MOVE      TWO,EXIT
          GOTO      KASC9999
.
KASC9000  MOVE      ONE,EXIT
.
KASC9999  RETURN
+
.******************************************************************************
.*                                 KCNT0000                                   *
.*                            Keyin Contract ID                               *
.******************************************************************************
KCNT0000  KEYIN     *P26:11,*EL,*V2LON,CONTRCID;
          ENDSET     CONTRCID
          APPEND     SP70,CONTRCID
          RESET      CONTRCID
.
          MATCH      SP70,CONTRCID
          GOTO       KCNT9000 IF EQUAL
.
          MOVE       ZERO,EXIT
          GOTO       KCNT9999
.
KCNT9000  MOVE       ONE,EXIT
KCNT9999  RETURN
+
.******************************************************************************
.*                                 KFLD0000                                   *
.*                            Keyin Fields                                    *
.******************************************************************************
KFLD0000  CALL      IVAR0000                * Initialise variables
.
          CALL      KCNT0000                * Keyin Contract ID
          BRANCH    EXIT,KFLD9999
.
          CALL      KCLM0000                * Keyin claim code
          BRANCH    EXIT,KFLD9999
.
          COMPARE   THREE,OPTION
          GOTO      KFLD2000 IF EQUAL       * default hf/table
.
          CALL      KFND0000                * Keyin HF code/ HF Group
          BRANCH    EXIT,KFLD9999
.
          CALL      KTAB0000                * Keyin health fund table type
          BRANCH    EXIT,KFLD9999           * exit
.
KFLD2000  CALL      KREM0000                * Keyin to remove records
          BRANCH    EXIT,KFLD9999           * exit
.
          MOVE      ZERO,EXIT
KFLD9999  RETURN
+
.******************************************************************************
.*                                 IVAR0000                                   *
.*                            Initialise variable                             *
.******************************************************************************
IVAR0000  MOVE      SP70,KYCLAIM
          MOVE      SP70,KYHFGRP
          MOVE      SP70,KYHFUND
          MOVE      ZERO,KYHFTYP
          MOVE      ZERO,KYREMRC
          MOVE      SP70,CONTRCID
IVAR9999  RETURN
+
.******************************************************************************
.*                                 SCRD0000                                   *
.*                            Screen display                                  *
.******************************************************************************
SCRD0000  DISPLAY   *P1:11,*EF:
                    *P1:11," 1. Contract ID        :":
                    *P1:12," 2. Claim Code         :";
          COMPARE   THREE,OPTION
          GOTO      SCRD3000 IF NOT EQUAL
.
          DISPLAY   *P1:15," 3. Remove Existing Rec:":
                    *P1:16," 4. Keyin User id      :":
                    *P1:17," 5. Keyin Path name    :";
          GOTO      SCRD9999
.
SCRD3000  IF        OPTION=1
            DISPLAY   *P1:13," 3. Health Fund Group  :";
          ELSE
            DISPLAY   *P1:13," 3. Health Fund Code   :";
          ENDIF
.
          DISPLAY   *P1:14," 4. Health Fund Table  :":
                    *P1:15," 5. Remove Existing Rec:":
                    *P1:16," 6. Keyin User id      :":
                    *P1:17," 7. Keyin Path name    :";
SCRD9999  RETURN
+
.******************************************************************************
.*                                 SCRR0000                                   *
.*                            Screen display                                  *
.******************************************************************************
SCRR0000  DISPLAY   *P1:11,*EF:
                    *P1:11," 1. Contract ID        :":
                    *P1:12," 2. Claim Code         :";
          COMPARE   THREE,OPTION
          GOTO      SCRR3000 IF NOT EQUAL
.
          DISPLAY   *P1:16," 3. Keyin User id      :"
          GOTO      SCRR9999
.
SCRR3000  IF        OPTION=1
            DISPLAY   *P1:13," 3. Health Fund Group  :";
          ELSE
            DISPLAY   *P1:13," 3. Health Fund Code   :";
          ENDIF
.
          DISPLAY   *P1:16," 4. Keyin User id      :"
SCRR9999  RETURN
+
.******************************************************************************
.*                                 SCRL0000                                   *
.*                            Screen display                                  *
.******************************************************************************
SCRL0000  DISPLAY   *P1:11,*EF:
                    *P1:16," 4. Keyin User id      :":
                    *P1:17," 7. Keyin Path name    :";
SCRL9999  RETURN
+
.******************************************************************************
.*                                 KCLM0000                                   *
.*                            Keyin Claim code                                *
.******************************************************************************
KCLM0000  MOVE      SP10,KYCLAIM
          MOVE      ZERO,EXIT
          KEYIN     *P26:12,*EL,*V2LON,KYCLAIM;
          ENDSET    KYCLAIM
          APPEND    SP3,KYCLAIM
          RESET     KYCLAIM
.
          MATCH     SP3,KYCLAIM
          GOTO      KCLM9000 IF EQUAL
.
          MOVE      "CL",TCODE
          PACK      KEY5,TCODE,KYCLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,KCLM2000
.
          DISPLAY   *P26:12,*V2LON,KYCLAIM,*P30:12,TDESC;
          MOVE      ZERO,EXIT
          GOTO      KCLM9999
.
KCLM2000  DISPLAY   *P1:24,*EL,*B,*V2LON,"Invalid Claim code.  ";
          CALL      HITENTER
          GOTO      KCLM0000
.
KCLM9000  MOVE      ONE,EXIT
KCLM9999  RETURN
+
.******************************************************************************
.*                                 KFGR0000                                   *
.*                            Keyin Health fund group                         *
.******************************************************************************
KFGR0000  MOVE      SP10,KYHFGRP
          MOVE      ZERO,EXIT
          KEYIN     *P26:13,*EL,*V2LON,KYHFGRP;
          ENDSET    KYHFGRP
          APPEND    SP3,KYHFGRP
          RESET     KYHFGRP
.
          MATCH     SP3,KYHFGRP
          GOTO      KFGR9000 IF EQUAL
.
          PACK      KEY6,KYHFGRP
          CALL      RDPAHGP1
          BRANCH    OVRCD,KFGR2000
.
          DISPLAY   *P26:13,*V2LON,KYHFGRP,*P30:13,PTHGDESC;
          GOTO      KFGR8000
.
KFGR2000  DISPLAY   *P1:24,*EL,*B,*V2LON,"Invalid Health fund Group code.  ";
          CALL      HITENTER
          GOTO      KFGR0000
.
KFGR8000  MOVE      ZERO,EXIT
          GOTO      KFGR9999
.
KFGR9000  MOVE      ONE,EXIT
KFGR9999  RETURN
+
.******************************************************************************
.*                                 KHFN0000                                   *
.*                            Keyin Health fund code                          *
.******************************************************************************
KHFN0000  MOVE      SP10,KYHFUND
          MOVE      ZERO,EXIT
.
          KEYIN     *P26:13,*EL,*EL,*V2LON,KYHFUND;
          RESET     KYHFUND
          GOTO      KHFN9999 IF EOS
.
          ENDSET    KYHFUND
          APPEND    SP6,KYHFUND
          RESET     KYHFUND
.
          CMATCH    EXITCHAR,KYHFUND
          GOTO      KHFN9000 IF EQUAL
.
          MATCH     SP6,KYHFUND
          GOTO      KHFN9200 IF EQUAL
.
          PACK      KEY14,KYHFUND,ZERO8
          CALL      RDFUND1
          BRANCH    OVRCD,KHFN2000
.
          DISPLAY   *P26:13,*V2LON,KYHFUND,*P30:13,HFNAME;
          GOTO      KHFN9999
.
KHFN2000  DISPLAY   *P1:24,*EL,*B,*V2LON,"Invalid Health Fund code.  "
          CALL      HITENTER
          GOTO      KHFN0000        
.
KHFN9000  MOVE      ONE,EXIT        * exit char. entered
          GOTO      KHFN9999
.
KHFN9200  MOVE      TWO,EXIT        * spaces entered
          GOTO      KHFN9999
.
KHFN9999  RETURN
+
.******************************************************************************
.*                                 KTAB0000                                   *
.*                            Keyin HF Table type                             *
.******************************************************************************
KTAB0000  MOVE      ZERO,KYHFTYP
          MOVE      ZERO,EXIT
          DISPLAY   *P1:24,*EL,"1 = All, 2 = As per Upload";
          KEYIN     *P26:14,*EL,*V2LON,KYHFTYP;
          BRANCH    KYHFTYP,KTAB1000,KTAB1000
          DISPLAY   *P1:24,*EL,*B,*V2LON,"Must be one or two.  ";
          CALL      HITENTER
          GOTO      KTAB0000
.
KTAB1000  IF        KYHFTYP=1
            MOVE      "All                ",TDESC
          ELSE
            MOVE      "As Per Upload      ",TDESC
          ENDIF
          DISPLAY   *P26:14,*V2LON,KYHFTYP,*P36:14,TDESC;
          DISPLAY   *P1:24,*EL;
          MOVE      ZERO,EXIT
          GOTO      KTAB9999
.
KTAB9000  MOVE      ONE,EXIT
KTAB9999  RETURN
+
.******************************************************************************
.*                                  KRPI0000                                  *
.*                     Remove Existing records                                *
.******************************************************************************
KREM0000  MOVE      KYREMRC,DIM1
          KEYIN     *P26:15,*EL,*V2LON,*RV,DIM1;
.
          REP       UPPLOW,DIM1
          MATCH     "Y",DIM1
          GOTO      KREM1000 IF EQUAL
.         
          MATCH     "N",DIM1
          GOTO      KREM1000 IF EQUAL
.
          DISPLAY   *P1:24,*EL,"Must be Y or N";
          BEEP
          GOTO      KREM0000
.
KREM1000  REP       "Y1N2",DIM1
          MOVE      DIM1,FORM1
          MOVE      FORM1,KYREMRC
.
          MOVE      DNO,DIM3
          LOAD      DIM3,FORM1,DYES,DNO
          DISPLAY   *P26:15,*EL,*V2LON,DIM3;
          DISPLAY   *P1:24,*EL;
.
KREM9999  RETURN
+
.******************************************************************************
.*                                  KUSR0000                                  *
.*                     Keyin user id                                          *
.******************************************************************************
KUSR0000  KEYIN     *P26:16,*EL,*V2LON,USERID;
          PACK      USERID,USERID,SP70
          MATCH     SP70,USERID
          GOTO      KUSR9500 IF EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      KUSR9999
.
KUSR9500  MOVE      ONE,EXIT
KUSR9999  RETURN
+
.******************************************************************************
.*                                  KPTH0000                                  *
.*                     Keyin path name                                        *
.******************************************************************************
KPTH0000  PACK      PATHNAME,SP70,SP70,SP70
          KEYIN     *P26:17,*EL,*V2LON,PATHNAME;
          ENDSET    PATHNAME
          APPEND    SP70,PATHNAME
          APPEND    SP70,PATHNAME
          APPEND    SP70,PATHNAME
          RESET     PATHNAME
.
.         PACK      PATHNAME,PATHNAME,SP70,SP70,SP70
          MATCH     SP70,PATHNAME
          GOTO      KPTH9500 IF EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      KPTH9999
.
KPTH9500  MOVE      ONE,EXIT
KPTH9999  RETURN
+
.******************************************************************************
.*                                  SFLD0000                                  *
.*                        Select Field                                        *
.******************************************************************************
SFLD0000  CALL      MAINQST                 * Select Item, (P)ost, (C)ancel ?
.
          COMPARE   ZERO,CCITEM
          GOTO      SFLD9999 IF EQUAL
          GOTO      SFLD1000 IF LESS
.
          MOVE      ZERO,EXIT
          IF        OPTION=3
            PERFORM   CCITEM,KCNT0000:             * Keyin Contract ID
                             KCLM0000:             * Keyin claim code
                             KREM0000:             * Keyin Remove existing rec.?
                             KUSR0000:             * Keyin user id
                             KPTH0000              * Keyin pathname
          ELSE
            PERFORM   CCITEM,KCNT0000:             * Keyin Contract ID
                             KCLM0000:             * Keyin claim code
                             KFND0000:             * Keyin Health fund
                             KTAB0000:             * Keyin health fund table typ
                             KREM0000:             * Keyin Remove existing rec.?
                             KUSR0000:             * Keyin user id
                             KPTH0000              * Keyin pathname
          ENDIF
          BRANCH    EXIT,SFLD9999
          GOTO      SFLD0000
.
SFLD1000  MOVE      ONE,EXIT
SFLD9999  RETURN
+
.******************************************************************************
.         Keyin health fund group or health fund code
.******************************************************************************
KFND0000  IF        OPTION=1
            CALL      KFGR0000                * Keyin health fund group code
          ELSE
            CALL      KHFN0000                * Keyin health fund code
          ENDIF
KFND9999  RETURN
+
.******************************************************************************
.*                                  POST0000                                  *
.*                        Post record                                         *
.******************************************************************************
POST0000  CALL      OPEN0000            * Open tempfile
          BRANCH    OPTION,POST2000     * by health fund group
.
          IF        OPTION=3
            MOVE      SP70,KYHFUND      * blank health fund
          ENDIF
          IF        KYREMRC=1
            CALL      DREC0000          * Deleting existing records
          ENDIF
          CALL      GFND0000            * Generate fees for the health fund
          GOTO      POST9000
.
.         Get health funds for the HF group
.
POST2000  MOVE      SP70,SAVKEY20
          PACK      KEY20,KYHFGRP,SP70
          CALL      RDSFUND3
POST4000  CALL      RDKFUND3
          BRANCH    OVRCD,POST9000
          MATCH     KYHFGRP,PTHFHGRP    * Same group?
          GOTO      POST9000 IF NOT EQUAL
          MATCH     "0000    ",HFTABL
          GOTO      POST4000 IF NOT EQUAL
.
          BRANCH    PHFTACT,POST4000    * Inactive
.
          MOVE      HCODE,KYHFUND
          PACK      SAVKEY20,PTHFHGRP,HCODE,HFTABL,SP70
.
          IF        KYREMRC=1
            CALL      DREC0000          * Deleting existing records
          ENDIF
          CALL      GFND0000            * Generate fees for the health fund
.
          MOVE      SAVKEY20,KEY20
          CALL      RDFUND3             * Reposition
.
          GOTO      POST4000
.
POST9000  CALL      IBACLOCK
          PRINT     *N,"Upload Successfully Completed at ":
                    CDATE," Time: ",CTIMEIS
.
          CALL      KILL0000            * Delete the tempfile
POST9999  RETURN
+
.******************************************************************************
.*                                  PRHD0000                                  *
.*                        Print the selection details                         *
.******************************************************************************
PRHD0000  CALL      HEAD132
.
          IF        COPTION = 1
            PRINT     *N,"Upload Casemix Contract"
          ELSE
            IF        COPTION = 2
              PRINT     *N,"Remove Contract ID"
            ENDIF
          ENDIF
.
          IF        COPTION = 3
            PRINT     *N,"Upload Exp. Length of Stay for Casemix Codes"
          ENDIF
.
          PRINT     *N,"Date     : ",CDATE:
                    *N,"Time     : ",CTIMEIS:
                    *N,"User ID  : ",USERID
.
          BRANCH    COPTION,PRHD1000,PRHD2000,PRHD9999
          GOTO      PRHD9999
.
PRHD1000  PRINT     *N,"Contract ID: ",CONTRCID:
                    *N,"Claim Code : ",KYCLAIM
.
          IF        OPTION=1
            PRINT     *N,"By Health Fund Group : ",KYHFGRP
          ELSE
            IF        OPTION=2
              PRINT     *N,"By Health Fund  : ",KYHFUND
            ELSE
              PRINT     *N,"Default Health Fund/table"
            ENDIF
          ENDIF
.
          IF        KYHFTYP=1
            MOVE      "All          ",KEY15
          ELSE
            MOVE      "As Per Upload",KEY15
          ENDIF
          MOVE      "No",KEY3
          IF        KYREMRC=1
            MOVE      "Yes",KEY3
          ENDIF
          PRINT     *N,"Health Fund Table          : ",KEY15:
                    *N,"Remove Existing Records    : ",KEY3:
                    *N,"Casemix Contract Load file : ":
                    *N,"     ",PATHNAME
          GOTO      PRHD9999
.
PRHD2000  PRINT     *N,"Contract ID: ",CONTRCID:
                    *N,"Claim Code : ",KYCLAIM
.
          IF        OPTION=1
            PRINT     *N,"By Health Fund Group : ",KYHFGRP
          ELSE
            IF        OPTION=2
              PRINT     *N,"By Health Fund  : ",KYHFUND
            ELSE
              PRINT     *N,"Default Health Fund/table"
            ENDIF
          ENDIF
.
PRHD9999  RETURN
+
.******************************************************************************
.*                                  GFND0000                                  *
.*                        Generate Fees of a health fund                      *
.******************************************************************************
GFND0000  MOVE      SP70,SAVHFUND
          MOVE      SP70,SAVCLAIM
          MOVE      ONE,HFERROR
          MOVE      ZERO,LINECNTR
          MOVE      ONE,HEADFLAG
          MOVE      ONE,PMCCCNTR
          MOVE      ZERO,SPMCPODY
          MOVE      ZERO,SPMCNPDY
          MOVE      ZERO,SPMCMIND
          MOVE      ZERO,SPMCHBPT
          MOVE      ZERO,SPMCCCDY
          OPEN      UCPAYTXT,FNAMEI
GFND1000  READ      UCPAYTXT,SEQ;XFLD0001,XFLD0002,XFLD0003,XFLD0004,XFLD0005:
                                 XFLD0006,XFLD0007,XFLD0008,XFLD0009,XFLD0010:
                                 XFLD0011,XFLD0012,XFLD0013,XFLD0014,XFLD0015:
                                 XFLD0016,XFLD0017,XFLD0018,XFLD0019,XFLD0020:
                                 XFLD0021,XFLD0022,XFLD0023,XFLD0024,XFLD0025:
                                 XFLD0026,XFLD0027,XFLD0028,XFLD0029,XFLD0030:
                                 XFLD0031,XFLD0032,XFLD0033,XFLD0034,XFLD0035:
                                 XFLD0036,XFLD0037,XFLD0038,XFLD0039,XFLD0040:
                                 XFLD0041,XFLD0042,XFLD0043,XFLD0044,XFLD0045:
                                 XFLD0046,XFLD0047,XFLD0048,XFLD0049,XFLD0050:
                                 XFLD0051,XFLD0052,XFLD0053,XFLD0054,XFLD0055:
                                 XFLD0056,XFLD0057,XFLD0058,XFLD0059,XFLD0060:
                                 XFLD0061,XFLD0062,XFLD0063,XFLD0064,XFLD0065:
                                 XFLD0066,XFLD0067,XFLD0068,XFLD0069,XFLD0070:
                                 XFLD0071,XFLD0072,XFLD0073,XFLD0074,XFLD0075:
                                 XFLD0076,XFLD0077,XFLD0078,XFLD0079,XFLD0080:
                                 XFLD0081,XFLD0082,XFLD0083,XFLD0084,XFLD0085:
                                 XFLD0086,XFLD0087,XFLD0088,XFLD0089,XFLD0090:
                                 XFLD0091,XFLD0092,XFLD0093,XFLD0094,XFLD0095:
                                 XFLD0096,XFLD0097,XFLD0098,XFLD0099,XFLD0100:
                                 XFLD0101,XFLD0102,XFLD0103,XFLD0104,XFLD0105:
                                 XFLD0106,XFLD0107,XFLD0108,XFLD0109,XFLD0110:
                                 XFLD0111,XFLD0112,XFLD0113,XFLD0114,XFLD0115:
                                 XFLD0116,XFLD0117,XFLD0118,XFLD0119,XFLD0120:
                                 XFLD0121,XFLD0122,XFLD0123,XFLD0124,XFLD0125:
                                 XFLD0126,XFLD0127,XFLD0128,XFLD0129,XFLD0130:
                                 XFLD0131,XFLD0132,XFLD0133,XFLD0134,XFLD0135
          GOTO      GFND9000 IF OVER
.
.
.         If Contract id, Claim code, health fund table/type and Casemix code, 
.         are blank, then it must the subsequence multiple rules record
.
          CLEAR     KEY35
          APPEND    XFLD0001,KEY35
          APPEND    XFLD0002,KEY35
          APPEND    XFLD0003,KEY35
          APPEND    XFLD0004,KEY35
          APPEND    XFLD0005,KEY35
          APPEND    SP70,KEY35
          RESET     KEY35
.
          MATCH     SP70,KEY35
          GOTO      GFND1200 IF NOT EQUAL
.
          PACK      XFLD0048,XFLD0048,SP70
          MATCH     SP70,XFLD0048
          GOTO      GFND1000 IF EQUAL     * no rule number
.
          IF        LINECNTR<>0
            MOVE      ZERO,HEADFLAG       * flag for multiple rules
          ENDIF
          GOTO      GFND2000
.
GFND1200  MOVE      ONE,HEADFLAG
          MOVE      ONE,PMCCCNTR
.
GFND2000  ADD       ONE,LINECNTR            * Text file line counter for error
.
          IF        VALDFLAG=1
            CALL      CRUL0000              * Checking if there is a rule
            CALL      VALD0000              * Validating fields
            COMPARE   ONE,HEADFLAG
            GOTO      GFND1000 IF NOT EQUAL   * multiple rules
          ELSE
            COMPARE   ONE,HEADFLAG
            GOTO      GFND3600 IF NOT EQUAL   * multiple rules
          ENDIF
.
          PACK      XCNTID,XFLD0001,SP70
          MATCH     XCNTID,CONTRCID
          IF        !@EQUAL
            IF        VALDFLAG=1
              MOVE      "Contract ID Mismatch",ERRORMSG
              CALL      PERR0000
            ENDIF
          ENDIF
.
          PACK      XCLMCD,XFLD0002,SP70
          PACK      XHFCOD,XFLD0003,SP70
          MOVE      XCLMCD,SAVCLAIM
          MOVE      XHFCOD,SAVHFUND
.
          MATCH     XCLMCD,KYCLAIM
          IF        !@EQUAL
            IF        VALDFLAG=1
              MOVE      "Claim Code Mismatch",ERRORMSG
              CALL      PERR0000
            ENDIF
          ENDIF
.
          MOVE      ZERO,CLERROR           * Found record for the selected claim
.
          BRANCH    OPTION,GFND2100,GFND2200,GFND2400
          GOTO      GFND1000
.
GFND2100  PACK      XHFTYP,XFLD0004,SP70
          PACK      XHFCOD,KYHFUND,SP70
.
          MOVE      ZERO,HFERROR         * Found record for the selected HF
          GOTO      GFND3000
.
GFND2200  PACK      XHFTYP,XFLD0004,SP70
.
          MATCH     XHFCOD,KYHFUND
          IF        !@EQUAL
            IF        VALDFLAG=1
              MOVE      "Health Fund Mismatch",ERRORMSG
              CALL      PERR0000
            ENDIF
          ENDIF
.
          MOVE      ZERO,HFERROR         * Found record for the selected HF
          GOTO      GFND3000
.
GFND2400  MOVE      SP70,XHFCOD
          MOVE      SP70,XHFTYP
          MOVE      ZERO,HFERROR
.
GFND3000  BRANCH    VALDFLAG,GFND1000         * validating only
.
          PACK      XCASCD,XFLD0005,SP70
          PACK      XSTTYP,XFLD0006,SP70
.
          PACK      XEFDAT,XFLD0007,SP70
          PACK      XEDATE,XFLD0008,SP70
.
.         Record type/Casemix type must be D(Daycase),O(Overnight) or E(either)
.
          PACK      XCSTYP,XFLD0009,SP70
          MOVE      XCSTYP,KEY1
          MATCH     SP70,KEY1
          IF        @EQUAL
            MOVE      "E",KEY1               * default to Either
          ENDIF
          MOVE      KEY1,PMCCTYPE            * record type
.
          MOVE      XCASCD,KEY9
          CALL      RDPTCMC1
          IF        OVRCD=1
            MOVE      XCASCD,PTCACODE
            UNPACK    SP70,PTCADES1,PTCADES2
            PACK      PTCADES1,PTCACODE,SP70
            MOVE      ZERO,PTCAELOS
            MOVE      ONE,PTCAACTV            * Active
            MOVE      SP70,PTCSPARE
            CALL      WRPTCMC1
            PROC      PATKCMUP                * Updating Keyword search
            PRINT     *1,"Casemix Code: ",KEY9:
                      " had been added to Casemix Code Table."
          ENDIF
.
          MOVE      ZERO,XEXLOS
          MOVE      XFLD0010,XEXLOS
          MOVE      ZERO,XTRPOINT
          MOVE      XFLD0102,XTRPOINT
          PACK      XECLECEQ,XFLD0103,SP70
.
          PACK      XECLECTS,SP70
          MOVE      ZERO,FORM2
          SQUEEZE   XFLD0104
          MOVE      XFLD0104,FORM2
          IF        FORM2<>0
            MOVE      FORM2,XECLECTS
          ENDIF
.
          PACK      XTARGLOS,SP70
          MOVE      ZERO,FORM4
          SQUEEZE   XFLD0105
          MOVE      XFLD0105,FORM4
          IF        FORM4<>0
            MOVE      FORM4,XTARGLOS
          ENDIF
.
          MOVE      XFLD0106,XECLEHCP
.
.         The following fields are for patls1af file
.
          PACK      XDLUMD,XFLD0011,SP70
          MOVE      ZERO,XDREBP
          MOVE      ZERO,XDPATP
          MOVE      XFLD0012,XDREBP
          MOVE      XFLD0013,XDPATP
.
.         The following fields are for pathl1af file
.
          PACK      XOLUMD,XFLD0014,SP70
          MOVE      ZERO,XOREBP
          MOVE      ZERO,XOPATP
          MOVE      XFLD0015,XOREBP
          MOVE      XFLD0016,XOPATP
.
.         The following fields are for patld1af file
.
          MOVE      ZERO,XLCOFF
          MOVE      XFLD0017,XLCOFF
          PACK      XLDESC,XFLD0018,SP70
          MOVE      ZERO,XLREBP
          MOVE      ZERO,XLPATP
          MOVE      XFLD0019,XLREBP
          MOVE      XFLD0020,XLPATP
.
.         The following fields are for pathd1af file - dtyp=1
.
          PACK      XOIND1,XFLD0021,SP70
          MOVE      ZERO,XOINP1
          MOVE      ZERO,XOINR1
          MOVE      XFLD0022,XOINP1
          MOVE      XFLD0023,XOINR1
.
.         The following fields are for patld1af file - dtyp=2
.
          PACK      XOIND2,XFLD0024,SP70
          MOVE      ZERO,XOINP2
          MOVE      ZERO,XOINR2
          MOVE      XFLD0025,XOINP2
          MOVE      XFLD0026,XOINR2
.
.         The following fields are for patld1af file - dtyp=2
.
          MOVE      ZERO,XOCOF3
          MOVE      XFLD0027,XOCOF3
          PACK      XOIND3,XFLD0028,SP70
          MOVE      ZERO,XOINP3
          MOVE      ZERO,XOINR3
          MOVE      XFLD0029,XOINP3
          MOVE      XFLD0030,XOINR3
.
.         The following fields are for patld1af file - dtyp=2
.
          MOVE      ZERO,XOCOF4
          MOVE      XFLD0031,XOCOF4
          PACK      XOIND4,XFLD0032,SP70
          MOVE      ZERO,XOINP4
          MOVE      ZERO,XOINR4
          MOVE      XFLD0033,XOINP4
          MOVE      XFLD0034,XOINR4
.
.         The following fields are for pataf1af file 
.
          MOVE      XFLD0035,XAEDAY
          PACK      XABTYP,XFLD0036,SP70
          PACK      XADESC,XFLD0037,SP70
          MOVE      ZERO,XAREBP
          MOVE      ZERO,XAPATP
          MOVE      XFLD0038,XAREBP
          MOVE      XFLD0039,XAPATP
          MOVE      XFLD0040,XAACIN
          MOVE      XFLD0041,XAFIGR
          MOVE      XFLD0042,XANPDY
.
GFND3600  COMPARE   THREE,OPTION
          GOTO      GFND3800 IF EQUAL       * Default blank HF/table
.
          BRANCH    KYHFTYP,GFND4000        * All Health fund type
.
.         as per Upload file
.
GFND3800  CALL      LOAD0000
          GOTO      GFND1000
.
.         All health fund type of the health fund
.
GFND4000  PACK      KEY14,KYHFUND,SP70
          CALL      RDSFUND1
GFND5000  CALL      RDKFUND1
          BRANCH    OVRCD,GFND6000
          MATCH     KYHFUND,HCODE
          GOTO      GFND6000 IF NOT EQUAL
.
          MATCH     "0000    ",HFTABL
          GOTO      GFND5000 IF EQUAL  
.
          MATCH     SP70,PTHFBCAT
          GOTO      GFND5000 IF EQUAL
.
          BRANCH    PHFTACT,GFND5000    * Inactive
.
          CALL      CHKFND00            * Check if HF type had been processed
          BRANCH    EXIT,GFND5000
.
          MOVE      PTHFBCAT,XHFTYP     * Health fund type
          CALL      LOAD0000
          GOTO      GFND5000            * get next record
.
GFND6000  CALL      DTMP0000            * clear tempfile
          GOTO      GFND1000
.
GFND9000  CLOSE     UCPAYTXT
.
          MOVE      ZERO,EXIT
          IF        ERRCOUNT<>0
            CALL      UND132
          ENDIF
.
          COMPARE   THREE,OPTION
          GOTO      GFND9999 IF EQUAL       * Option for default claim/hf
.
          IF        CLERROR=1 & ERRFLAG=0
            PRINT     *N,*1,"Nothing Loaded. Possibly Mismatch with ":
                      "Contract ID/Claim between above the Keyin and ":
                      "Upload Spreadsheet."
            MOVE      ONE,ERRFLAG
            MATCH    SP70,SAVCLAIM
            IF       !@EQUAL
              PRINT    *1,"Claim Code in Spreadsheet: ",SAVCLAIM
            ENDIF
            MOVE     ONE,EXIT
          ENDIF
.
          COMPARE   TWO,OPTION
          GOTO      GFND9999 IF NOT EQUAL   * not By health fund
.
          IF        HFERROR=1
            PRINT     *N,*1,"Nothing Loaded. Possibly Mismatch with ":
                      "Fund between above the Keyin and ":
                      "Upload Spreadsheet."
.
            MATCH    SP70,SAVHFUND
            IF       !@EQUAL
              PRINT    *1,"Health Fund in Spreadsheet: ",SAVHFUND
            ENDIF
            MOVE     ONE,EXIT
          ENDIF
.
GFND9999  RETURN
+
.******************************************************************************
.*                                  CRUL0000                                  *
.*                        Check if Casemix code has a rule                    *
.******************************************************************************
CRUL0000  PACK      XFLD0048,XFLD0048,SP70
          MATCH     SP70,XFLD0048
          GOTO      CRUL9999 IF NOT EQUAL
.
          PACK      XCASCD,XFLD0005,SP70
          CLEAR     ERRORMSG
          APPEND    "Casemix Code No Rule:",ERRORMSG
          APPEND    XCASCD,ERRORMSG
          APPEND    SP70,ERRORMSG
          RESET     ERRORMSG
          CALL      PERR0000
          MOVE      ONE,EXIT
.
CRUL9999  RETURN
+
.******************************************************************************
.*                                  VCLD0000                                  *
.*                        Validate Casemix code                               *
.******************************************************************************
VCLD0000  MOVE      ZERO,LINECNTR
          OPEN      UCPAYTXT,FNAMEI
          PRINT     *N
VCLD1000  READ      UCPAYTXT,SEQ;XFLD0001,XFLD0002,XFLD0003,XFLD0004,XFLD0005:
                                 XFLD0006,XFLD0007,XFLD0008,XFLD0009,XFLD0010:
                                 XFLD0011,XFLD0012,XFLD0013,XFLD0014,XFLD0015;
          GOTO      VCLD9000 IF OVER
.
          CLEAR     KEY9
          ADD       ONE,LINECNTR            * Text file line counter for error
          PACK      XCASCD,XFLD0001,SP70
          MATCH     SP70,XFLD0001
          IF        !@EQUAL
            PACK    KEY9,XFLD0001,SP70
            CALL    RDPTCMC1
            IF      OVRCD=1
              ADD       ONE,ERRCOUNT
              PRINT     "Casemix code: ",XCASCD," is not a valid Casemix code."
              MOVE      ONE,EXIT   
            ENDIF
          ELSE
            ADD       ONE,ERRCOUNT
            PRINT     "Casemix code: ",XCASCD," is not a valid Casemix code."
            MOVE      ONE,EXIT
          ENDIF
.
          GOTO     VCLD1000
.
VCLD9000  CLOSE     UCPAYTXT
          IF        ERRCOUNT<>0
            CALL      IBACLOCK
            PRINT     *N,"Upload Failed at ":
                      CDATE," Time: ",CTIMEIS
          ENDIF
.
VCLD9999  RETURN
+
.******************************************************************************
.*                                  UDCC0000                                  *
.*                        Update Casemix Code                                 *
.******************************************************************************
UDCC0000  CALL      OPEN0000            * Open tempfile
          MOVE      ZERO,LINECNTR
          OPEN      UCPAYTXT,FNAMEI
UDCC1000  READ      UCPAYTXT,SEQ;XFLD0001,XFLD0002,XFLD0003,XFLD0004,XFLD0005:
                                 XFLD0006,XFLD0007,XFLD0008,XFLD0009,XFLD0010:
                                 XFLD0011,XFLD0012,XFLD0013,XFLD0014,XFLD0015;
          GOTO      UDCC9000 IF OVER
.
          CLEAR     KEY9
          PACK      KEY9,XFLD0001,SP70
          MATCH     SP70,XFLD0002
          IF        @EQUAL | @EOS
             MOVE     "0",XFLD0002
          ENDIF
          CALL      RDPTCMC1
          BRANCH    OVRCD,UDCC1000
.
          MOVE      XFLD0002,PTCAELOS
          CALL      UPPTCMC1
          PROC      PATKCMUP                * Updating Keyword search
          GOTO      UDCC1000
.          
UDCC9000  CLOSE     UCPAYTXT
          CALL      IBACLOCK
          PRINT     *N,"Upload Successfully Completed at ":
                    CDATE," Time: ",CTIMEIS
          CALL      KILL0000            * Delete the tempfile
          MOVE      ONE,EXIT
.
UDCC9999  RETURN
+
.******************************************************************************
.         Validating fields
.******************************************************************************
VALD0000  MOVE      ZERO,EXIT
          COMPARE   ONE,HEADFLAG
          GOTO      VALD8000 IF NOT EQUAL     * Not a header record
.
.         Validating the following fields for header record only
.
          PACK      XCNTID,XFLD0001,SP70
          MATCH     SP70,XFLD0001
          IF        !@EQUAL
            PACK      KEY6,XFLD0001,SP70
            CALL      RDPMCID1
            IF        OVRCD=1
              CLEAR     ERRORMSG
              APPEND    "Invalid Contract Id: ",ERRORMSG
              APPEND    XCNTID,ERRORMSG
              APPEND    SP70,ERRORMSG
              RESET     ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ELSE
              PACK      XEFDAT,XFLD0007,SP70
              MATCH     PMCIFDAT,XFLD0007
              IF        !@EQUAL
                CLEAR     ERRORMSG
                APPEND    "Invalid Eff.From Date-",ERRORMSG
                APPEND    XEFDAT,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
              PACK      XEDATE,XFLD0008,SP70
              PACK      XFLD0008,XFLD0008,SP70
              MATCH     PMCITDAT,XFLD0008
              IF        !@EQUAL
                CLEAR     ERRORMSG
                APPEND    "Invalid Eff.To Date-",ERRORMSG
                APPEND    XEDATE,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
          ENDIF
.
          PACK      XCLMCD,XFLD0002,SP70
          MATCH     SP70,XFLD0002
          IF        !@EQUAL
            PACK      XCLMCD,XFLD0002,SP70
            PACK      KEY5,ANSC,ANSL,XFLD0002,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,VALD1000
            MOVE      XCLMCD,KEY3
            CALL      RDPTCFA1
            BRANCH    OVRCD,VALD1000
            GOTO      VALD2000
          ENDIF
.
VALD1000  CLEAR     ERRORMSG
          APPEND    "Invalid Claim Code: ",ERRORMSG
          APPEND    XCLMCD,ERRORMSG
          APPEND    SP70,ERRORMSG
          RESET     ERRORMSG
          CALL      PERR0000
          MOVE      ONE,EXIT
.
VALD2000  PACK      XHFCOD,XFLD0003,SP70
          MATCH     SP70,XHFCOD
          IF        !@EQUAL
            PACK      KEY6,XFLD0003,SP70
            PACK      KEY14,KEY6,ZERO8,SP70
            CALL      RDFUND1
            IF        OVRCD=1
              CLEAR     ERRORMSG
              APPEND    "Invalid HF: ",ERRORMSG
              APPEND    KEY6,ERRORMSG
              APPEND    SP70,ERRORMSG
              RESET     ERRORMSG
              CALL      PERR0000
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
          PACK      XHFTYP,XFLD0004,SP70
          MATCH     SP70,XFLD0004
          IF        !@EQUAL
            PACK      KEY5,ANSH,ANST,XFLD0004,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     ERRORMSG
              APPEND    "Invalid HF Type: ",ERRORMSG
              APPEND    XHFTYP,ERRORMSG
              APPEND    SP70,ERRORMSG
              RESET     ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
          PACK      XSTTYP,XFLD0006,SP70
          MATCH     SP70,XFLD0006
          IF        !@EQUAL
            MOVE      SP70,KEY1
            PACK      KEY1,XFLD0006
            REP       "1020",KEY1
            MATCH     "0",KEY1
            IF        !@EQUAL
              MOVE      "Start Type must be 0,1 or 2",ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
          MATCH     SP70,XHFCOD
          IF        !@EQUAL
            PACK      KEY14,XHFCOD,ZERO8,SP70
            CALL      RDPTFX11
            IF        OVRCD=0
              MATCH     PTFXCEFR,XSTTYP
              IF        !@EQUAL
                MOVE      "Invalid Start Type for HF  ",ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
          ELSE
            MOVE      XCLMCD,KEY3
            CALL      RDPTCFA1
            IF        OVRCD=0
              MATCH     PTCFCEFR,XSTTYP
              IF        !@EQUAL
                MOVE      "Invalid Start Type for Claim",ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
          ENDIF
.
.         Record type/Casemix type must be D(Daycase),O(Overnight) or E(either)
.
          PACK      KEY1,XFLD0009,SP70
          MATCH     SP70,KEY1
          IF        @EQUAL
            MOVE      "E",KEY1               * default to Either
          ENDIF
.
          REP       "O1D1E1",KEY1
          MATCH     "1",KEY1
          IF        !@EQUAL
            MOVE      "Invalid Record Type (must be O/D/E) ",ERRORMSG
            CALL      PERR0000
          ENDIF
.
          MATCH     SP70,XFLD0036
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANST,XFLD0036,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      "Invalid Bed Type ",ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
          MOVE      ZERO,FORM4
          PACK      XFLD0105,XFLD0105,SP70
          PACK      KEY4,XFLD0105,SP70
          MATCH     SP70,KEY4
          IF        !@EQUAL
            SQUEEZE   KEY4
            TYPE      KEY4
            IF        !@EQUAL
              MOVE      "Invalid Target LOS ",ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ELSE
              MOVE      KEY4,FORM4
              IF        FORM4<0
                MOVE      "Target LOS can not be negative ",ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
          ENDIF
.
          PACK      XFLD0106,XFLD0106,SP70
          MATCH     SP70,XFLD0106
          IF       !@EQUAL
            LJUSTIFY  XFLD0106
            UNPACK    XFLD0106,KEY1,KEY29
            MATCH     SP70,KEY29
            IF        @EQUAL
              MOVE      "Health Care Provider (Eclipse), must be length of 2. ",ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
.         Checking Minimum and Maximum stay
.
          MOVE      ZERO,MINSTAY
          MOVE      ZERO,MAXSTAY
          PACK      XFLD0045,XFLD0045,SP70
          PACK      XFLD0046,XFLD0046,SP70
.
          MATCH     SP70,XFLD0045
          IF        @EQUAL
            MATCH     SP70,XFLD0046
            GOTO      VALD8000 IF EQUAL            * min/max stay is blank
          ENDIF
.
          MATCH     SP70,XFLD0045
          IF        @EQUAL
            MOVE      "0",KEY1                   * auto fill 0
            PACK      XFLD0045,KEY1,SP70
          ENDIF
.
          MATCH     SP70,XFLD0046
          IF        @EQUAL
            MOVE      "9999",KEY4                * auto fill 9999
            PACK      XFLD0046,KEY4,SP70
          ENDIF
.
          SQUEEZE   XFLD0045
          TYPE      XFLD0045
          IF         !@EQUAL | @EOS
            MOVE      "Min Days Stay must be numeric",ERRORMSG
            CALL      PERR0000
            MOVE      ONE,EXIT
          ENDIF
          MOVE       XFLD0045,MINSTAY            * set Min stay
.
          SQUEEZE   XFLD0046
          TYPE      XFLD0046
          IF         !@EQUAL | @EOS
            MOVE      "Max Days Stay must be numeric",ERRORMSG
            CALL      PERR0000
            MOVE      ONE,EXIT
          ENDIF
          MOVE       XFLD0046,MAXSTAY
.
          IF         MINSTAY<>0 & MAXSTAY<>0
            COMPARE    MINSTAY,MAXSTAY
            IF         @LESS
              MOVE      "Max DaysStay less than MinDays",ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
.
.         Validating fields matrix rules
.
VALD8000  CALL      VDST0000          * Validating discharge status codes
          CALL      VDES0000          * Validating discharge destination
          CALL      VASR0000          * Validating admission source
          CALL      VATY0000          * Validating admission type
          CALL      VCCL0000          * Validating care class
          CALL      VICDD000          * Validating ICD Diagnosis (Diseases)
          CALL      VICDP000          * Validating ICD Procedures (Operations)
.
          CALL      VAUD0000          * Validating Adm.UDF codes
          CALL      VATD0000          * Validating Attending Doctor
          CALL      VCCD0000          * Validating Concession cards
          CALL      VDUD0000          * Validating Disc.UDF codes
.
VALD9999  RETURN
+
.******************************************************************************
.         Validating Admission UDF
.******************************************************************************
VAUD0000  LOAD      KEY2,PTCNCMAU,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                             AUSR7,PTMIUSR8,PTMIUSR9,PTMIUSR0
          MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0091,XFLD0092,XFLD0093,XFLD0094,XFLD0095
            PACK      KEY3,KEY3,SP70
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,KEY2,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Adm.UDF : ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VAUD9999  RETURN
+
.******************************************************************************
.         Validating Attending Doctor
.******************************************************************************
VATD0000  PACK      XFLD0123,XFLD0123,SP70
          MATCH     SP70,XFLD0123
          IF        !@EQUAL
            PACK      KEY6,XFLD0123,SP70
            CALL      RDDOCT1
            IF        OVRCD=1
              CLEAR     ERRORMSG
              APPEND    "Invalid Attending Doctor: ",ERRORMSG
              APPEND    KEY9,ERRORMSG
              APPEND    SP70,ERRORMSG
              RESET     ERRORMSG
              CALL      PERR0000
              MOVE      ONE,EXIT
            ENDIF
          ENDIF
VATD9999  RETURN
+
.******************************************************************************
.         Validating Concession Cards
.******************************************************************************
VCCD0000  MOVE      "ct",KEY2
          MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0125,XFLD0126,XFLD0127,XFLD0128,XFLD0129
            PACK      KEY3,KEY3,SP70
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,KEY2,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Concession Cards: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VCCD9999  RETURN
+
.******************************************************************************
.         Validating UDF Discharge 
.******************************************************************************
VDUD0000  LOAD      KEY2,PTCNCMDU,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
          MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0131,XFLD0132,XFLD0133,XFLD0134,XFLD0135
            PACK      KEY3,KEY3,SP70
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,KEY2,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Disc.UDF : ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VDUD9999  RETURN
+
.******************************************************************************
.         Validating Discharge status
.******************************************************************************
VDST0000  MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0061,XFLD0062,XFLD0063,XFLD0064,XFLD0065
            PACK      KEY3,KEY3,SP70
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSD,SP1,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Disc.Status: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VDST9999  RETURN
+
.******************************************************************************
.         Validating Discharge Destination
.******************************************************************************
VDES0000  MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0067,XFLD0068,XFLD0069,XFLD0070,XFLD0071
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSD,ANSD,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Disc.Dest.: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VDES9999  RETURN
+
.******************************************************************************
.         Validating Admission source
.******************************************************************************
VASR0000  MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0073,XFLD0074,XFLD0075,XFLD0076,XFLD0077
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSS,SP1,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Adm.Status: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VASR9999  RETURN
+
.******************************************************************************
.         Validating admission type
.******************************************************************************
VATY0000  MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0085,XFLD0086,XFLD0087,XFLD0088,XFLD0089
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSA,SP1,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Adm.Type: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VATY9999  RETURN
+
.******************************************************************************
.         Validating Care Class
.******************************************************************************
VCCL0000  MOVE      ONE,F1
          MOVE      SP70,KEY3
          WHILE     F1 < 6
            LOAD      KEY3,F1,XFLD0094,XFLD0098,XFLD0099,XFLD0100,XFLD0101
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSC,ANSC,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid Care Class: ",ERRORMSG
                APPEND    KEY3,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VCCL9999  RETURN
+
.******************************************************************************
.         Validating ICD Diagnosis (Diseases)
.******************************************************************************
VICDD000  MOVE      ONE,F1
.
          WHILE     F1 < 6
            MOVE      SP70,KEY9
            LOAD      KEY9,F1,XFLD0079,XFLD0080,XFLD0081,XFLD0082,XFLD0083
.
            MATCH     SP70,KEY9
            IF        !@EQUAL & !@EOS
              CALL      RDPTICD1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid ICD Diagnosis: ",ERRORMSG
                APPEND    KEY9,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VICDD999  RETURN
+
.******************************************************************************
.         Validating ICD Procedures (Operations)
.******************************************************************************
VICDP000  MOVE      ONE,F1
.
          WHILE     F1 < 6
            MOVE      SP70,KEY9
            LOAD      KEY9,F1,XFLD0108,XFLD0109,XFLD0110,XFLD0111,XFLD0112
.
            MATCH     SP70,KEY9
            IF        !@EQUAL & !@EOS
              CALL      RDPTICO1
              IF        OVRCD=1
                CLEAR     ERRORMSG
                APPEND    "Invalid ICD Procedure: ",ERRORMSG
                APPEND    KEY9,ERRORMSG
                APPEND    SP70,ERRORMSG
                RESET     ERRORMSG
                CALL      PERR0000
                MOVE      ONE,EXIT
              ENDIF
            ENDIF
            ADD        ONE,F1
          DO
VICDP999  RETURN
+
.******************************************************************************
.         Print error header
.******************************************************************************
PERH0000  CALL      HEAD132
          CALL      UND132
          PRINT     *1,"| Line No.",*12,"|Error Messages",*44,"|Contract ID":
                    *60," |Claim Code",*75," |Health Fund",*132,"|"
          CALL      UND132
PERH9999  RETURN
+
.******************************************************************************
.         Print error line
.******************************************************************************
PERR0000  COMPARE   ZERO,ERRCOUNT
          CALL      PERH0000 IF EQUAL
.
          PACK      XCNTID,XFLD0001,SP70
          PACK      XCLMCD,XFLD0002,SP70
          PACK      XHFCOD,XFLD0003,SP70
          ADD       ONE,ERRCOUNT
.
          UNPACK    ERRORMSG,KEY31
          PRINT     *1,"|",LINECNTR,*12,"|",KEY31,*44,"|":
                    XCNTID,*60," | ",XCLMCD,*75," | ",XHFCOD,*132,"|"
.
PERR9999  RETURN
+
.******************************************************************************
.*                Deleting tempfile                                           *
.******************************************************************************
DTMP0000  MOVE      SP70,KEY3
          CALL      RSTEMP1
          CALL      RKTEMP1
          BRANCH    OVRCD,DTMP9999
.
          PACK      KEY3,DIM3,SP70
          CALL      DETEMP1
          GOTO      DTMP0000
DTMP9999  RETURN
+
.******************************************************************************
.*                                  CHKFND00                                  *
.*                        Check if this HF type has been processed            *
.******************************************************************************
CHKFND00  MOVE      PTHFBCAT,KEY3
          CALL      RATEMP1
          COMPARE   ZERO,OVRCD
          GOTO      CHKFND90 IF EQUAL      * has been processed
.
          CALL      WRTEMP1
          MOVE      ZERO,EXIT
          GOTO      CHKFND99
.
CHKFND90  MOVE      ONE,EXIT
CHKFND99  RETURN
+
.******************************************************************************
.*                                  LOAD0000                                  *
.*                             Load records for a health fund type            *
.******************************************************************************
LOAD0000  BRANCH    VALDFLAG,LOAD9999   * Validating only
.
          COMPARE   ONE,HEADFLAG
          GOTO      LOAD9000 IF NOT EQUAL   * only write rules details
.
          CALL      WRCF0000            * Write Casemix funding
          BRANCH    EXIT,LOAD9999       * Blank casemix code
.
          CALL      WRLS0000            * Write Sameday lumpsum
          CALL      WRHL0000            * Write Overnight lumpsum
          CALL      WRLD0000            * Write Daily fee for low outlier
.
          CALL      W1HD0000            * Write Daily fee Outlier outlier
          BRANCH    EXIT,LOAD8000
          CALL      W2HD0000            * Write Daily fee Outlier outlier
          BRANCH    EXIT,LOAD8000
          CALL      W3HD0000            * Write Daily fee Outlier outlier
          BRANCH    EXIT,LOAD8000
          CALL      W4HD0000            * Write Daily fee Outlier outlier
.
LOAD8000  CALL      WRAF0000            * Write Additional fee for overnight
.
LOAD9000  CALL      WMXT0000            * Write Matrix
.
LOAD9999  RETURN
+
.******************************************************************************
.*                                  WRCF0000                                  *
.*                             Write Casemix funding record                   *
.******************************************************************************
WRCF0000  UNPACK    SP70,PTCMCLMN,PTCMHFND,PTCMCASM
.
          MATCH     SP70,XCASCD
          GOTO      WRCF9000 IF EQUAL
.
          PACK      KEY24,XCLMCD,XHFCOD,XCASCD,CONTRCID,SP70
          CALL      RDPTCMX1
          IF        OVRCD=1
            UNPACK    KEY24,PTCMCLMN,PTCMHFND,PTCMCASM,PTCMCNID
            MOVE      XEXLOS,PTCMXLOS
            MOVE      ZERO,PTCMDIFG
            MOVE      SP70,PTCMTRPT
            MOVE      XTRPOINT,PTCMTRPT      * Trim Point
            UNPACK    SP70,PTCMECEQ,PTCMECTS
            MOVE      XECLECEQ,PTCMECEQ      * Eclipse Equivalent
            MOVE      XECLECTS,PTCMECTS      * Eclipse Type of Service
            MOVE      XTARGLOS,PTCMTLOS      * Target LOS
            MOVE      XECLEHCP,PTCMEHCP      * Health Care Provider (Eclipse)
            MOVE      SP70,PTCMSPAR
            CALL      WRPTCMX1
          ELSE
            MOVE      XEXLOS,PTCMXLOS
            MOVE      SP70,PTCMTRPT
            MOVE      XTRPOINT,PTCMTRPT      * Trim Point
            MOVE      XECLECEQ,PTCMECEQ      * Eclipse Equivalent
            MOVE      XECLECTS,PTCMECTS      * Eclipse Type of Service
            MOVE      XTARGLOS,PTCMTLOS      * Target LOS
            MOVE      XECLEHCP,PTCMEHCP      * Health Care Provider (Eclipse)
            CALL      UPPTCMX1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      WRCF9999
.
WRCF9000  MOVE      ONE,EXIT
WRCF9999  RETURN
+
.******************************************************************************
.*                                  WRLS0000                                  *
.*                             Write Sameday lumpsum record                   *
.******************************************************************************
WRLS0000  UNPACK    SP70,PTLSCNID,PTLSCLMN,PTLSHFND,PTLSTABT,PTLSCASM
          MATCH     SP70,XDLUMD
          GOTO      WRLS9000 IF EQUAL
.
          PACK      KEY27,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,SP70
          CALL      RDPTLSD1
          IF        OVRCD=1
            UNPACK    KEY27,PTLSCNID,PTLSCLMN,PTLSHFND,PTLSTABT,PTLSCASM
            UNPACK    SP70,PTLSDES1,PTLSDES2
            MOVE      XDLUMD,PTLSDES1
            MOVE      XDREBP,PTLSLREB
            MOVE      XDPATP,PTLSLPAT
            MOVE      ZERO,PTLSINVR
            MOVE      ZERO,PTLSINVI
            MOVE      ZERO,PTLSNINV
            MOVE      SP70,PTLSSPAR
            CALL      WRPTLSD1
          ELSE
            MOVE      XDLUMD,PTLSDES1
            MOVE      XDREBP,PTLSLREB
            MOVE      XDPATP,PTLSLPAT
            CALL      UPPTLSD1
          ENDIF
          MOVE       ZERO,EXIT
          GOTO       WRLS9999
.
WRLS9000  MOVE       ONE,EXIT
WRLS9999  RETURN
+
.******************************************************************************
.*                                  WRHL0000                                  *
.*                             Write Overnight lumpsum record                 *
.******************************************************************************
WRHL0000  UNPACK    SP70,PTHLCNID,PTHLCLMN,PTHLHFND,PTHLTABT,PTHLCASM
          MATCH     SP70,XOLUMD
          GOTO      WRHL9000 IF EQUAL
.
          PACK      KEY27,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,SP70
          CALL      RDPTHLF1
          IF        OVRCD=1
            UNPACK    KEY27,PTHLCNID,PTHLCLMN,PTHLHFND,PTHLTABT,PTHLCASM
            UNPACK    SP70,PTHLDES1,PTHLDES2
            MOVE      XOLUMD,PTHLDES1
            MOVE      XOREBP,PTHLLREB
            MOVE      XOPATP,PTHLLPAT
            MOVE      XLCOFF,PTHLCOFF
            MOVE      ZERO,PTHLINVB
            MOVE      ZERO,PTHLINVI
            MOVE      ZERO,PTHLNINV
            MOVE      SP70,PTHLSPAR
            CALL      WRPTHLF1
          ELSE
            MOVE      XOLUMD,PTHLDES1
            MOVE      XOREBP,PTHLLREB
            MOVE      XOPATP,PTHLLPAT
            MOVE      XLCOFF,PTHLCOFF
            CALL      UPPTHLF1
          ENDIF
          MOVE       ZERO,EXIT
          GOTO       WRHL9999
.
WRHL9000  MOVE       ONE,EXIT
WRHL9999  RETURN
+
.******************************************************************************
.*                                  WRLD0000                                  *
.*                       Write Daily fee for Low outlier record               *
.******************************************************************************
WRLD0000  UNPACK    SP70,PTLDCNID,PTLDCLMN,PTLDHFND,PTLDTABT,PTLDCASM
          MATCH     SP70,XLDESC
          GOTO      WRLD9000 IF EQUAL
.
          MOVE      XLCOFF,FORM4
          SUB       ONE,FORM4
          COMPARE   ZERO,FORM4
          GOTO      WRLD9000 IF EQUAL
.
          MOVE      FORM4,KEY4
          PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
          CALL      RDPTLDF1
          IF        OVRCD=1
            UNPACK    KEY31,PTLDCNID,PTLDCLMN,PTLDHFND,PTLDTABT,PTLDCASM,KEY4
            MOVE      KEY4,PTLDEDAY
            UNPACK    SP70,PTLDDES1,PTLDDES2
            MOVE      XLDESC,PTLDDES1
            MOVE      XLREBP,PTLDDREB
            MOVE      XLPATP,PTLDDPAT
            MOVE      SP70,PTLDSPAR
            CALL      WRPTLDF1
          ELSE
            MOVE      XLDESC,PTLDDES1
            MOVE      XLREBP,PTLDDREB
            MOVE      XLPATP,PTLDDPAT
            CALL      UPPTLDF1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      WRLD9999
.
WRLD9000  MOVE      ONE,EXIT
WRLD9999  RETURN
+
.******************************************************************************
.*                                  W1HD0000                                  *
.*                       Write Daily fee for Inlier record                    *
.******************************************************************************
W1HD0000  UNPACK    SP70,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM
          MATCH     SP70,XOIND1
          GOTO      W1HD9000 IF EQUAL          * blank description
.
          MOVE      ZERO,F1
.         MOVE      XLCOFF,FORM4
.
.         COMPARE   ZERO,FORM4
.         GOTO      W1HD2000 IF EQUAL
.
.         Write zero amount for Low outlier record
.
.         MOVE      FORM4,KEY4
.         PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
.         CALL      RDPTHDF1
.         IF        OVRCD=1
.           UNPACK    KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM,KEY4
.           MOVE      KEY4,PTHDEDAY
.           MOVE      TWO,PTHDDTYP            * Outlier
.           UNPACK    SP70,PTHDDES1,PTHDDES2
.           MOVE      XLDESC,PTHDDES1
.           MOVE      ZERO,PTHDDREB
.           MOVE      ZERO,PTHDDPAT
.           MOVE      SP70,PTHDSPAR
.           CALL      WRPTHDF1
.         ELSE
.           MOVE      XLDESC,PTHDDES1
.           MOVE      ZERO,PTHDDREB
.           MOVE      ZERO,PTHDDPAT
.           CALL      UPPTHDF1
.         ENDIF
.
W1HD2000  MOVE      XEXLOS,FORM4
          COMPARE   ZERO,FORM4
          GOTO      W1HD4000 IF NOT EQUAL
.
W1HD3000  MOVE      "9999",FORM4
          MOVE      ONE,F1
.
W1HD4000  MOVE      FORM4,KEY4
          PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
          CALL      RDPTHDF1
          IF        OVRCD=1
            UNPACK    KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM,KEY4
            MOVE      KEY4,PTHDEDAY
            MOVE      ONE,PTHDDTYP              * Inlier
            IF        F1=1
              MOVE      TWO,PTHDDTYP            * Outlier
            ENDIF
            UNPACK    SP70,PTHDDES1,PTHDDES2
            MOVE      XOIND1,PTHDDES1
            MOVE      XOINP1,PTHDDREB
            MOVE      XOINR1,PTHDDPAT
            MOVE      SP70,PTHDSPAR
            CALL      WRPTHDF1
          ELSE
            MOVE      XOIND1,PTHDDES1
            MOVE      XOINP1,PTHDDREB
            MOVE      XOINR1,PTHDDPAT
            CALL      UPPTHDF1
          ENDIF
          MOVE       ZERO,EXIT
          BRANCH     F1,W1HD9000
          GOTO       W1HD9999
.
W1HD9000  MOVE       ONE,EXIT
W1HD9999  RETURN
+
.******************************************************************************
.*                                  W2HD0000                                  *
.*                       Write Daily fee for High outlier record              *
.******************************************************************************
W2HD0000  UNPACK    SP70,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM
          MOVE      ZERO,EXIT
          MATCH     SP70,XOIND2
          GOTO      W2HD9000 IF EQUAL           * blank description
.
          MOVE      XOCOF3,FORM4
          SUB       ONE,FORM4
          IF        FORM4<0
            MOVE      "9999",FORM4
            MOVE      ONE,EXIT
          ENDIF
          MOVE      FORM4,KEY4
          PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
          CALL      RDPTHDF1
          IF        OVRCD=1
            UNPACK    KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM,KEY4
            MOVE      KEY4,PTHDEDAY
            MOVE      TWO,PTHDDTYP              * Outlier
            UNPACK    SP70,PTHDDES1,PTHDDES2
            MOVE      XOIND2,PTHDDES1
            MOVE      XOINP2,PTHDDREB
            MOVE      XOINR2,PTHDDPAT
            MOVE      SP70,PTHDSPAR
            CALL      WRPTHDF1
          ELSE
            MOVE      XOIND2,PTHDDES1
            MOVE      XOINP2,PTHDDREB
            MOVE      XOINR2,PTHDDPAT
            CALL      UPPTHDF1
          ENDIF
          GOTO      W2HD9999
.
W2HD9000  MOVE      ONE,EXIT
W2HD9999  RETURN
+
.******************************************************************************
.*                                  W3HD0000                                  *
.*                       Write Daily fee for High outlier record              *
.******************************************************************************
W3HD0000  UNPACK    SP70,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM
          MOVE      ZERO,EXIT
          MATCH     SP70,XOIND3
          GOTO      W3HD9000 IF EQUAL          * Blank description
.
          MOVE      XOCOF4,FORM4
          SUB       ONE,FORM4
          IF        FORM4<0
            MOVE      "9999",FORM4
            MOVE      ONE,EXIT
          ENDIF
.
          MOVE      FORM4,KEY4
          PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
          CALL      RDPTHDF1
          IF        OVRCD=1
            UNPACK    KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM,KEY4
            MOVE      KEY4,PTHDEDAY
            MOVE      TWO,PTHDDTYP              * Outlier
            UNPACK    SP70,PTHDDES1,PTHDDES2
            MOVE      XOIND3,PTHDDES1
            MOVE      XOINP3,PTHDDREB
            MOVE      XOINR3,PTHDDPAT
            MOVE      SP70,PTHDSPAR
            CALL      WRPTHDF1
          ELSE
            MOVE      XOIND3,PTHDDES1
            MOVE      XOINP3,PTHDDREB
            MOVE      XOINR3,PTHDDPAT
            CALL      UPPTHDF1
          ENDIF
          GOTO       W3HD9999
.
W3HD9000  MOVE       ONE,EXIT
W3HD9999  RETURN
+
.******************************************************************************
.*                                  W4HD0000                                  *
.*                       Write Daily fee for High outlier record              *
.******************************************************************************
W4HD0000  UNPACK    SP70,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM
          MATCH     SP70,XOIND4
          GOTO      W4HD9999 IF EQUAL
.
          MOVE      "9999",FORM4
          MOVE      FORM4,KEY4
          PACK      KEY31,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,KEY4,SP70
          CALL      RDPTHDF1
          IF        OVRCD=1
            UNPACK    KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM,KEY4
            MOVE      KEY4,PTHDEDAY
            MOVE      TWO,PTHDDTYP              * Outlier
	    UNPACK    SP70,PTHDDES1,PTHDDES2
	    MOVE      XOIND4,PTHDDES1
            MOVE      XOINP4,PTHDDREB
            MOVE      XOINR4,PTHDDPAT
            MOVE      SP70,PTHDSPAR
            CALL      WRPTHDF1
          ELSE
            MOVE      XOIND4,PTHDDES1
            MOVE      XOINP4,PTHDDREB
            MOVE      XOINR4,PTHDDPAT
            CALL      UPPTHDF1
          ENDIF
W4HD9999  RETURN
+
.******************************************************************************
.*                                  WRAF0000                                  *
.*                  Write additional fee for Overnight record                 *
.******************************************************************************
WRAF0000  UNPACK    SP70,PTFECNID,PTFECLMN,PTFEHFND,PTFETABT,PTFECASM,PTFEBTYP
          MATCH     SP70,XADESC
          GOTO      WRAF9999 IF EQUAL        * blank description
.
          MOVE      XAEDAY,FORM4
          MOVE      FORM4,KEY4
          PACK      KEY34,CONTRCID,XCLMCD,XHFCOD,XHFTYP,XCASCD,XABTYP,KEY4,SP70
          CALL      RDPTAFE1
          IF        OVRCD=1
            UNPACK    KEY34,PTFECNID,PTFECLMN,PTFEHFND,PTFETABT,PTFECASM:
                            PTFEBTYP,KEY4
            UNPACK    SP70,PTFEACIN,PTFEFIGR,PTFENPDY
            MOVE      XAACIN,PTFEACIN
            MOVE      XAFIGR,PTFEFIGR
            MOVE      XANPDY,PTFENPDY
.
            MOVE      KEY4,PTFEEDAY
            UNPACK    SP70,PTFEDES1,PTFEDES2
            MOVE      XADESC,PTFEDES1
            MOVE      XAREBP,PTFEDREB
            MOVE      XAPATP,PTFEDPAT
            MOVE      SP70,PTFESPAR
            CALL      WRPTAFE1
          ELSE
            MOVE      XAACIN,PTFEACIN
            MOVE      XAFIGR,PTFEFIGR
            MOVE      XANPDY,PTFENPDY
            MOVE      XADESC,PTFEDES1
            MOVE      XAREBP,PTFEDREB
            MOVE      XAPATP,PTFEDPAT
            CALL      UPPTAFE1
          ENDIF
WRAF9999  RETURN
+
.******************************************************************************
.*                                  WMXT0000                                  *
.*                    Write Matrix records                                    *
.******************************************************************************
WMXT0000  BRANCH    HEADFLAG,WMXT1000       * Header record
.
          ADD       ONE,PMCCCNTR
          GOTO      WMXT2000
.
.         Write a header record
.
WMXT1000  MOVE      ZERO,PMCCCNTR
          MOVE      PMCCCNTR,DPMCCCNT
          PACK      KEY34,XCLMCD,CONTRCID,XHFCOD,XHFTYP,PMCCTYPE:
                          XCASCD,DPMCCCNT,SP70
          CALL      RDPMCMT1
          IF        OVRCD=1
            CALL     CLPMSCMT  
            UNPACK   KEY34,PMCCCCOD,PMCCCONT,PMCCHFUN,PMCCHFTY:
                           PMCCTYPE,PMCCCMCD,DPMCCCNT
.            CALL     IMTX0000             * clear other variables
            MOVE     XFLD0043,PMCCPODY
            MOVE     XFLD0044,PMCCNPDY
            MOVE     XFLD0045,PMCCMIND
            MOVE     XFLD0046,PMCCHBPT
            MOVE     XFLD0047,PMCCCCDY
            CALL     WRPMCMT1
            CALL     WCMT0000               * Write to Matrix header file
          ELSE
            MOVE     XFLD0043,PMCCPODY
            MOVE     XFLD0044,PMCCNPDY
            MOVE     XFLD0045,PMCCMIND
            MOVE     XFLD0046,PMCCHBPT
            MOVE     XFLD0047,PMCCCCDY
            CALL     UPPMCMT1
          ENDIF
          MOVE      PMCCPODY,SPMCPODY
          MOVE      PMCCMIND,SPMCMIND
          MOVE      PMCCNPDY,SPMCNPDY
          MOVE      PMCCHBPT,SPMCHBPT
          MOVE      PMCCCCDY,SPMCCCDY
          MOVE      ONE,PMCCCNTR
.
.         Write a rule record
.
WMXT2000  MOVE      PMCCCNTR,DPMCCCNT
          PACK      KEY34,XCLMCD,CONTRCID,XHFCOD,XHFTYP,PMCCTYPE:
                          XCASCD,DPMCCCNT,SP70
          CALL      RDPMCMT1
          MOVE      OVRCD,F1
.
          CALL     CLPMSCMT  
          UNPACK   KEY34,PMCCCCOD,PMCCCONT,PMCCHFUN,PMCCHFTY,PMCCTYPE:
                         PMCCCMCD,DPMCCCNT
.          CALL     IMTX0000             * clear other variables
          MOVE     SPMCPODY,PMCCPODY
          MOVE     SPMCNPDY,PMCCNPDY
          MOVE     SPMCMIND,PMCCMIND
          MOVE     SPMCHBPT,PMCCHBPT
          MOVE     SPMCCCDY,PMCCCCDY
.
          MOVE      "0",PMCCFTDG            * default to ignore
          PACK      KEY1,XFLD0049,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0049,PMCCFTDG
          ENDIF
          PACK      PMCCDDRG,XFLD0050,SP70
.
          MOVE      "0",PMCCFTCM            * default to ignore
          PACK      KEY1,XFLD0051,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0051,PMCCFTCM
          ENDIF
          PACK      PMCCPCMF,XFLD0052,SP70
          PACK      PMCCPCMT,XFLD0053,SP70
.
          MOVE      "0",PMCCFTSC            * default to ignore
          PACK      KEY1,XFLD0054,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0054,PMCCFTSC
          ENDIF
          PACK      PMCCSCMF,XFLD0055,SP70
          PACK      PMCCSCMT,XFLD0056,SP70
.
          MOVE      "0",PMCCFTTC            * default to ignore
          PACK      KEY1,XFLD0057,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0057,PMCCFTTC
          ENDIF
          PACK      PMCCTCMF,XFLD0058,SP70
          PACK      PMCCTCMT,XFLD0059,SP70
.
          MOVE      "0",PMCCFTS4            * default to ignore
          PACK      KEY1,XFLD0113,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0113,PMCCFTS4
          ENDIF
          PACK      PMCCPC4F,XFLD0114,SP70
          PACK      PMCCPC4T,XFLD0115,SP70
.
          MOVE      "0",PMCCFT5C            * default to ignore
          PACK      KEY1,XFLD0116,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0116,PMCCFT5C
          ENDIF
          PACK      PMCCSC5F,XFLD0117,SP70
          PACK      PMCCSC5T,XFLD0118,SP70
.
          MOVE      "0",PMCCFT6C            * default to ignore
          PACK      KEY1,XFLD0119,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0119,PMCCFT6C
          ENDIF
          PACK      PMCCTC6F,XFLD0120,SP70
          PACK      PMCCTC6T,XFLD0121,SP70
.
.
          CALL      SMTX0000                 * Set all other matrix fields
.
          IF        F1=0
            CALL      UPPMCMT1
          ELSE
            CALL      WRPMCMT1
            CALL      WCMT0000               * Write to Matrix header file
          ENDIF
.
WMXT9999  RETURN
+
.******************************************************************************
.*                          SMTX0000                                          *
.*                    Write Matrix records                                    *
.******************************************************************************
SMTX0000  MOVE      XFLD0060,PMCCFTDS
          PACK      PMCCDSTA,XFLD0061,SP70
          PACK      PMCCDST2,XFLD0062,SP70
          PACK      PMCCDST3,XFLD0063,SP70
          PACK      PMCCDST4,XFLD0064,SP70
          PACK      PMCCDST5,XFLD0065,SP70
.
          MOVE      XFLD0066,PMCCFTDD
          PACK      PMCCDDES,XFLD0067,SP70
          PACK      PMCCDDE2,XFLD0068,SP70
          PACK      PMCCDDE3,XFLD0069,SP70
          PACK      PMCCDDE4,XFLD0070,SP70
          PACK      PMCCDDE5,XFLD0071,SP70
.
          MOVE      XFLD0072,PMCCFTAS
          PACK      PMCCASRC,XFLD0073,SP70
          PACK      PMCCASR2,XFLD0074,SP70
          PACK      PMCCASR3,XFLD0075,SP70
          PACK      PMCCASR4,XFLD0076,SP70
          PACK      PMCCASR5,XFLD0077,SP70
.
          MOVE      XFLD0078,PMCCFT1C
          PACK      PMCCPICD,XFLD0079,SP70
          PACK      PMCCPIC2,XFLD0080,SP70
          PACK      PMCCPIC3,XFLD0081,SP70
          PACK      PMCCPIC4,XFLD0082,SP70
          PACK      PMCCPIC5,XFLD0083,SP70
.
          MOVE      XFLD0084,PMCCFTAT
          PACK      PMCCATYP,XFLD0085,SP70
          PACK      PMCCATY2,XFLD0086,SP70
          PACK      PMCCATY3,XFLD0087,SP70
          PACK      PMCCATY4,XFLD0088,SP70
          PACK      PMCCATY5,XFLD0089,SP70
.
          MOVE      XFLD0090,PMCCFTAU
          PACK      PMCCAUDF,XFLD0091,SP70
          PACK      PMCCAUD2,XFLD0092,SP70
          PACK      PMCCAUD3,XFLD0093,SP70
          PACK      PMCCAUD4,XFLD0094,SP70
          PACK      PMCCAUD5,XFLD0095,SP70
.
          MOVE      XFLD0096,PMCCFTDU
          PACK      PMCCDUDF,XFLD0097,SP70
          PACK      PMCCDUD2,XFLD0098,SP70
          PACK      PMCCDUD3,XFLD0099,SP70
          PACK      PMCCDUD4,XFLD0100,SP70
          PACK      PMCCDUD5,XFLD0101,SP70
.
          MOVE      XFLD0107,PMCCICPF
          PACK      PMCCICP1,XFLD0108,SP70
          PACK      PMCCICP2,XFLD0109,SP70
          PACK      PMCCICP3,XFLD0110,SP70
          PACK      PMCCICP4,XFLD0111,SP70
          PACK      PMCCICP5,XFLD0112,SP70
.
          MOVE      "0",PMCCFTAD            * default to ignore
          PACK      KEY1,XFLD0122,SP70
          REP       "1X2X3X",KEY1
          MATCH     "X",KEY1
          IF        @EQUAL
            MOVE      XFLD0122,PMCCFTAD     * Attending Doctor
          ENDIF
          PACK      PMCCADOC,XFLD0123,SP70
.
          MOVE      XFLD0124,PMCCFTCC       * Concession Card Type
          PACK      PMCCCCT1,XFLD0125,SP70
          PACK      PMCCCCT2,XFLD0126,SP70
          PACK      PMCCCCT3,XFLD0127,SP70
          PACK      PMCCCCT4,XFLD0128,SP70
          PACK      PMCCCCT5,XFLD0129,SP70
.
          MOVE      XFLD0130,PMCCFDDU       * Discharge UDF
          PACK      PMCCUDF1,XFLD0131,SP70
          PACK      PMCCUDF2,XFLD0132,SP70
          PACK      PMCCUDF3,XFLD0133,SP70
          PACK      PMCCUDF4,XFLD0134,SP70
          PACK      PMCCUDF5,XFLD0135,SP70
.
SMTX9999  RETURN
+
.******************************************************************************
.*                                  DREC0000                                  *
.*                             Deleting existing records                      *
.******************************************************************************
DREC0000  CALL      DECM0000            * Delete Casmix funding
          CALL      DELS0000            * Delete Sameday lumpsum
          CALL      DEHL0000            * Delete Lumpsum for Overnight
          CALL      DELD0000            * Delete Daily fee for low outlier
          CALL      DEHD0000            * Delete Daily fee Inlier/High outlier
          CALL      DEAF0000            * Delete Additional fee for overnight
          CALL      DMTX0000            * Delete Matrix
          CALL      DHMT0000            * Delete Header Matrix
DREC9999  RETURN
+
.******************************************************************************
.         Deleting Casemix funding    
.******************************************************************************
DECM0000  PACK      KEY24,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTCMX2
          CALL      RKPTCMX2
          BRANCH    OVRCD,DECM9999
          MATCH     CONTRCID,PTCMCNID            * Same Contract ID
          GOTO      DELS9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTCMCLMN
          GOTO      DELS9999 IF NOT EQUAL
          MATCH     KYHFUND,PTCMHFND
          GOTO      DELS9999 IF NOT EQUAL
.
          PACK      KEY24,PTCMCNID,PTCMCLMN,PTCMHFND,PTCMCASM,SP70
          MATCH     SP70,KEY24
          GOTO      DELS9999 IF EQUAL
          CALL      DEPTCMX2
          CALL      ACMX0000                 * Write delete audit
          GOTO      DECM0000
.
DECM9999  RETURN
+
.******************************************************************************
.         Deleting Lumpsum for sameday
.******************************************************************************
DELS0000  PACK      KEY27,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTLSD1
          CALL      RKPTLSD1
          BRANCH    OVRCD,DELS9999
          MATCH     CONTRCID,PTLSCNID
          GOTO      DELS9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTLSCLMN
          GOTO      DELS9999 IF NOT EQUAL
          MATCH     KYHFUND,PTLSHFND
          GOTO      DELS9999 IF NOT EQUAL
.
          PACK      KEY27,PTLSCNID,PTLSCLMN,PTLSHFND,PTLSTABT,PTLSCASM,SP70
          MATCH     SP70,KEY27
          GOTO      DELS9999 IF EQUAL
          CALL      DEPTLSD1
          CALL      ALSD0000                 * Write delete audit
          GOTO      DELS0000
.
DELS9999  RETURN
+
.******************************************************************************
.         Deleting Lumpsum for Overnight
.******************************************************************************
DEHL0000  PACK      KEY27,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTHLF1
          CALL      RKPTHLF1
          BRANCH    OVRCD,DEHL9999
          MATCH     CONTRCID,PTHLCNID
          GOTO      DEHL9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTHLCLMN
          GOTO      DEHL9999 IF NOT EQUAL
          MATCH     KYHFUND,PTHLHFND
          GOTO      DEHL9999 IF NOT EQUAL
.
          PACK      KEY27,PTHLCNID,PTHLCLMN,PTHLHFND,PTHLTABT,PTHLCASM,SP70
          MATCH     SP70,KEY27
          GOTO      DEHL9999 IF EQUAL
          CALL      DEPTHLF1
          CALL      AHLF0000                 * Write delete audit
          GOTO      DEHL0000
.
DEHL9999  RETURN
+
.******************************************************************************
.         Deleting Daily fee for low outlier
.******************************************************************************
DELD0000  PACK      KEY31,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTLDF1
          CALL      RKPTLDF1
          BRANCH    OVRCD,DELD9999
          MATCH     CONTRCID,PTLDCNID
          GOTO      DELD9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTLDCLMN
          GOTO      DELD9999 IF NOT EQUAL
          MATCH     KYHFUND,PTLDHFND
          GOTO      DELD9999 IF NOT EQUAL
.
          PACK      KEY31,PTLDCNID,PTLDCLMN,PTLDHFND,PTLDTABT,PTLDCASM:
                          PTLDEDAY,SP70
          MATCH     SP70,KEY31
          GOTO      DELD9999 IF EQUAL
          CALL      DEPTLDF1
          CALL      ALDF0000                 * Write delete audit
          GOTO      DELD0000
.
DELD9999  RETURN
+
.******************************************************************************
.         Deleting Daily fee for Inlier/High outlier
.******************************************************************************
DEHD0000  PACK      KEY31,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTHDF1
          CALL      RKPTHDF1
          BRANCH    OVRCD,DEHD9999
          MATCH     CONTRCID,PTHDCNID
          GOTO      DEHD9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTHDCLMN
          GOTO      DEHD9999 IF NOT EQUAL
          MATCH     KYHFUND,PTHDHFND
          GOTO      DEHD9999 IF NOT EQUAL
.
          PACK      KEY31,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM:
                          PTHDEDAY,SP70
          MATCH     SP70,KEY31
          GOTO      DEHD9999 IF EQUAL
          CALL      DEPTHDF1
          CALL      AHDF0000                 * Write delete audit
          GOTO      DEHD0000
.
DEHD9999  RETURN
+
.******************************************************************************
.         Deleting Additional fee for overnight
.******************************************************************************
DEAF0000  PACK      KEY34,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPTAFE1
          CALL      RKPTAFE1
          BRANCH    OVRCD,DEAF9999
          MATCH     CONTRCID,PTFECNID
          GOTO      DEAF9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTFECLMN
          GOTO      DEAF9999 IF NOT EQUAL
          MATCH     KYHFUND,PTFEHFND
          GOTO      DEAF9999 IF NOT EQUAL
.
          PACK      KEY34,PTFECNID,PTFECLMN,PTFEHFND,PTFETABT:
                          PTFECASM,PTFEBTYP,PTFEEDAY,SP70
          MATCH     SP70,KEY34
          GOTO      DEAF9999 IF EQUAL
          CALL      DEPTAFE1
          CALL      AAFE0000             * Write to audit file
          GOTO      DEAF0000
.
DEAF9999  RETURN
+
.******************************************************************************
.         Deleting Matrix
.******************************************************************************
DMTX0000  PACK      KEY34,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RSPMCMT2
          CALL      RKPMCMT2
          BRANCH    OVRCD,DMTX9999
.
          MATCH     CONTRCID,PMCCCONT
          GOTO      DMTX9999 IF NOT EQUAL
          MATCH     KYCLAIM,PMCCCCOD
          GOTO      DMTX9999 IF NOT EQUAL
          MATCH     KYHFUND,PMCCHFUN
          GOTO      DMTX9999 IF NOT EQUAL
.
          PACK      KEY34,PMCCCONT,PMCCCCOD,PMCCHFUN,PMCCHFTY:
                          PMCCTYPE,PMCCCMCD,DPMCCCNT,SP70
          MATCH     SP70,KEY34
          GOTO      DMTX9999 IF EQUAL
          CALL      DEPMCMT2
          CALL      ACMT0000                * write to audit file
          GOTO      DMTX0000
.
DMTX9999  RETURN
+
.******************************************************************************
.         Deleting Header Matrix file
.******************************************************************************
DHMT0000  PACK      KEY18,CONTRCID,KYCLAIM,KYHFUND,SP70
          CALL      RDPTCMT2
          COMPARE   ZERO,OVRCD
          GOTO      DHMT2000 IF EQUAL
.
          CALL      RSPTCMT2
          CALL      RKPTCMT2
          BRANCH    OVRCD,DHMT9999
.
          MATCH     CONTRCID,PTCMCNTR
          GOTO      DHMT9999 IF NOT EQUAL
          MATCH     KYCLAIM,PTCMCCOD
          GOTO      DHMT9999 IF NOT EQUAL
          MATCH     KYHFUND,PTCMHFUN
          GOTO      DHMT9999 IF NOT EQUAL
.
DHMT2000  PACK      KEY18,PTCMCNTR,PTCMCCOD,PTCMHFUN,PTCMHFTY,SP70
          MATCH     SP70,KEY18
          GOTO      DHMT9999 IF EQUAL
          CALL      DEPTCMT2
          GOTO      DHMT0000
.
DHMT9999  RETURN
+
.******************************************************************************
.         Remove Contract
.******************************************************************************
RMCN0000  BRANCH    OPTION,RMCN2000         * by health fund group
          IF        OPTION=3
            MOVE      SP70,KYHFUND          * blank health fund
          ENDIF
          CALL      DREC0000                * Deleting existing records
          GOTO      RMCN9999
.
.         Get health funds for the HF group
.
RMCN2000  MOVE      SP70,SAVKEY20
          PACK      KEY20,KYHFGRP,SP70
          CALL      RDSFUND3
RMCN4000  CALL      RDKFUND3
          BRANCH    OVRCD,RMCN9999
          MATCH     KYHFGRP,PTHFHGRP    * Same group?
          GOTO      RMCN9999 IF NOT EQUAL
          MATCH     "0000    ",HFTABL
          GOTO      RMCN4000 IF NOT EQUAL
.
          MOVE      HCODE,KYHFUND
          PACK      SAVKEY20,PTHFHGRP,HCODE,HFTABL,SP70
.
          CALL      DREC0000                * Deleting existing records
.
          MOVE      SAVKEY20,KEY20
          CALL      RDFUND3                 * Reposition
          GOTO      RMCN4000
.
RMCN9999  RETURN
+
.------------------------------------------------------------
. Write audit for deletion of patcmxaf record
.------------------------------------------------------------
ACMX0000  MOVE      "patcmxaf",PMDCFILE
          MOVE      PTCMCNID,PMDCCONT
          PACK      PMDCRKEY,PTCMCLMN,PTCMHFND,PTCMCASM,PTCMCNID,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
ACMX1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      ACMX1000
          ENDIF
.
ACMX9999  RETURN
.------------------------------------------------------------
. Write audit for deletion of patlsdaf record
.------------------------------------------------------------
ALSD0000  MOVE      "patlsdaf",PMDCFILE
          MOVE      PTLSCNID,PMDCCONT
          PACK      PMDCRKEY,PTLSCNID,PTLSCLMN,PTLSHFND,PTLSTABT,PTLSCASM,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
ALSD1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      ALSD1000
          ENDIF
.
ALSD9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of patasdaf record
.------------------------------------------------------------
AASD0000  MOVE      "patasdaf",PMDCFILE
          MOVE      PTADCNID,PMDCCONT
          PACK      PMDCRKEY,PTADCNID,PTADCLMN,PTADHFND,PTADTABT,PTADCASM:
                             PTADBTYP,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
AASD1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      AASD1000
          ENDIF
.
AASD9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of pathlfaf record
.------------------------------------------------------------
AHLF0000  MOVE      "pathlfaf",PMDCFILE
          MOVE      PTHLCNID,PMDCCONT
          PACK      PMDCRKEY,PTHLCNID,PTHLCLMN,PTHLHFND,PTHLTABT,PTHLCASM,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
AHLF1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      AHLF1000
          ENDIF
.
AHLF9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of patldfaf record
.------------------------------------------------------------
ALDF0000  MOVE      "patldfaf",PMDCFILE
          MOVE      PTLDCNID,PMDCCONT
          PACK      PMDCRKEY,PTLDCNID,PTLDCLMN,PTLDHFND,PTLDTABT,PTLDCASM:
                             PTLDEDAY,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
ALDF1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      ALDF1000
          ENDIF
.
ALDF9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of pathdfaf record
.------------------------------------------------------------
AHDF0000  MOVE      "pathdfaf",PMDCFILE
          MOVE      PTHDCNID,PMDCCONT
          PACK      PMDCRKEY,PTHDCNID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM:
                             PTHDEDAY,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
AHDF1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      AHDF1000
          ENDIF
.
AHDF9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of patafeaf record
.------------------------------------------------------------
AAFE0000  MOVE      "patafeaf",PMDCFILE
          MOVE      PTFECNID,PMDCCONT
          PACK      PMDCRKEY,PTFECNID,PTFECLMN,PTFEHFND,PTFETABT,PTFECASM:
                             PTFEBTYP,PTFEEDAY,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
AAFE1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      AAFE1000
          ENDIF
.
AAFE9999  RETURN
.
.------------------------------------------------------------
. Write audit for deletion of pmscmtaf record
.------------------------------------------------------------
ACMT0000  MOVE      "pmscmtaf",PMDCFILE
          MOVE      PMCCCONT,PMDCCONT
          PACK      PMDCRKEY,PMCCCCOD,PMCCCONT,PMCCHFUN,PMCCHFTY,PMCCTYPE:
                             PMCCCMCD,PMCCCNTR,SP70
.
          MOVE      USERID,PMDCDUID
          PACK      PMDCDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDCDDAT
          CLOCK     TIME,PMDCDTIM
          MOVE      SP70,PMDCSPAR
.
          MOVE      ZERO,F3
.
ACMT1000  ADD       ONE,F3
          MOVE      F3,PMDCUNIQ
.
          PACK      KEY27,PMDCFILE,PMDCDDAT,PMDCDTIM,PMDCUNIQ,SP70
          CALL      RAPMDCA1
          IF        OVRCD=1
            CALL      WRPMDCA1
          ELSE
            GOTO      ACMT1000
          ENDIF
.
ACMT9999  RETURN
.
.--------------------------------------------------------------------------
.         Write to Matrix Header file
.--------------------------------------------------------------------------
WCMT0000  PACK      KEY18,PMCCCCOD,PMCCHFUN,PMCCHFTY,PMCCCONT,SP70
          CALL      RDPTCMT1
          IF        OVRCD=1
            UNPACK    KEY18,PTCMCCOD,PTCMHFUN,PTCMHFTY,PTCMCNTR
            MOVE      SP70,PTCMSPRE
            CALL      WRPTCMT1
          ENDIF
WCMT9999  RETURN
+
.******************************************************************************
.*                                  OPEN0000              Called by: INCL000  *
.*                              Open The Tempfile         RSENT000 & RREJT000 *
.******************************************************************************
OPEN0000  CALL      TFILENAM                     * Generate temporary file name
          MOVE      TFILNAME,FNAME1
.
          CALL      KILL0000                * Delete the tempfile
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAME1,CMDLINE
          APPEND    " 4 U1-3",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID          * isbuild the temp file
          OPEN      TEMPFILE,FNAME1
.
OPEN9000  MOVE      ZERO,EXIT
OPEN9999  RETURN
.
.******************************************************************************
.*                                 KILL0000               Called by: ML0000   *
.*                            Delete The Tempfile                  & OPEN0000 *
.******************************************************************************
KILL0000  CLOSE     TEMPFILE
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAME1,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID          * iserase the temp file
.
KILL9000  MOVE      ZERO,EXIT
KILL9999  RETURN
+
.******************************************************************************
.         Execute us1 command before processing
.******************************************************************************
EXCUS000  CLEAR     CMDLINE
          APPEND    "ibaadt92.us1 ",CMDLINE
          APPEND    FNAMEI,CMDLINE
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
EXCUS999  RETURN
+
.******************************************************************************
RATEMP1   MOVE      ZERO,OVRCD
          RESET     KEY3
          READ      TEMPFILE,KEY3;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   RESET     KEY3
          WRITE     TEMPFILE,KEY3;KEY3
          RETURN
.
RSTEMP1  RESET     KEY3
         READ      TEMPFILE,KEY3;;
         RETURN
.
RKTEMP1  MOVE      ZERO,OVRCD
         READKS    TEMPFILE;DIM3
         GOTO      OVERCOND IF OVER
         RETURN
.
DETEMP1  MOVE      ZERO,OVRCD
         RESET     KEY3
         DELETE    TEMPFILE,KEY3
         RETURN
.
.******************************************************************************
          INC       STD001IO
          INC       TFILENAM                * Generate Temp File Name
          INC       CLPMSCMT
          INC       PATKCMPR
.
          INC       IBASEQIO/INC            * Sequential Numbers File
          INC       PATCODIO/INC
          INC       PATCMCIO/INC            * Casemix code file
          INC       PATFN1IO/INC            * Health fund file
          INC       PATFX1IO/INC            * Health fund file
          INC       PATHGPIO/INC            * Health fund group
          INC       PATICDIO/INC            * ICD Diagnosis (Diseases)
          INC       PATICOIO/INC            * ICD Procedures (Operations)
          INC       PATKCMIO/INC            * Casemix Codes Key Words
.
          INC       PATDO1IO/INC            * Doctor File
          INC       PMSCIDIO/INC            * Contract ID file
          INC       PATCMXIO/INC            * Casemix funding
          INC       PATCFAIO/INC            * Claim code file
          INC       PATLSDIO/INC            * Lumpsum for sameday
          INC       PATASDIO/INC            * Additional charges for sameday
          INC       PATHLFIO/INC            * Lumpsum for overnight
          INC       PATLDFIO/INC            * Daily fee for low outlier
          INC       PATHDFIO/INC            * Daily fee for Inlier/High outlier
          INC       PATAFEIO/INC            * Additional fee for overnight
          INC       PMSCMTIO/INC            * Matrix
          INC       PATCMTIO/INC            * Matrix
          INC       PMSDCAIO/INC            * Audit file
          INC       WEBERRIO/INC            * Web Server Error Logging
.
.
.
.
.
