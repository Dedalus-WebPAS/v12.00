.----------------------------------------------------------------------
. Program       : WATTRETM
.
. Function      : Waiting List Information Server
.
. Modifications  :
.----------------------------------------------------------------------
. V12.00.01 14/05/2025 Thanh T         TSK 0955096
.           Changed for alphanumeric visit number
.----------------------------------------------------------------------
. V11.04.03 10.09.2024  DA Sarkies       TSK 0951076
.           Changed WATHIS30 WTHIBSCD=29 to read cat WB value from WTHIRDT3
. V11.04.02 28/02/2024  Ebon Clements    TSK 0916740
.           Save priority decrease so we can check for the next
.           priority increase - GTPC0000 - RFS days
. V11.04.01 17/11/2023  Alina Bhari      TSK 0925540
.           When adding a proposed admission date to a WL that has had a
.           booking removed, displayed Sch Adm Date as change - WATHIS20
.----------------------------------------------------------------------
. V11.02.02 24.03.2022  DA Sarkies       TSK 0889899                       
.           Added CGI variables WATTR060 and WATTR061 and DB calls to display
.           contents of the variables
. V11.02.01 09/02/2022  Thanh T          TSK 0889899                       
.           Added WMDESC2 - Procedure Description 2                        
.                 WMDESC3 - Procedure Description 3                       
.----------------------------------------------------------------------
. V11.00.03 29/04/2020  Jill Parkinson Task 0890757
.           Added check for P in wtre1100 - covid 19
. V11.00.02 24/03/2020  Thanh T        TSK 0888687
.           Added WTRB0100
. V11.00.01 23/03/2020  Peter Vela     TSK 0889143
.           Fixed WATLET IO calls
. V10.13.02 31/12/2018  Thanh T        TSK 0863964
.           Added WTRB0090 
. V10.13.01 21/11/2018  Jill Parkinson Tsk 0866897
.           Changed GTPC0000 to ignore changes to deferred stats for nsw only
. V10.12.04 18/06/2018  Richa Phogat   TSK 0854035
.           Updated WATHIS20 to display 'Undischarged' status when WTHIBSCD=20,
.           added new condition for WTHIBSCD=37
. V10.12.03 18/04/2018  Jill Parkinson TSK 0841670
.           Added use of WTWMSRCR if parameter set to 0 in WTRE8700 
. V10.12.02 07/03/2017  Ebon Clements  TSK 0850348
.           Added display of record type Change/Delete for wahealth
.           WL history - WATHIS00 
. V10.12.01 09/01/2018  Richa Phogat   TSK 0845727
.           Added code WTRB0080 to display details on Warning pop up screen
.----------------------------------------------------------------------
. V10.10.02 29/05/2017  Thanh T.       TSK 0838766
.           Fixed to prevent the medical booking data to be enterred when
.           the theatre booking details already existed and vice versa.
. V10.10.01 22/05/2017  Thanh T.       TSK 0825240
.           Added Days Not Ready for surgery for Patient and Clinical
. V10.08.04 08/12/2016  Jill Parkinson TSK 0830073
.           Changed GTPC0000 to ignore the category TP from code - if
.           this was changed twice on the same day it should be ignored
. V10.08.03 29/08/2016  Ebon Clements  TSK 0294154
.           Don't show update letter history icon for SMS - WATLHI00
. V10.08.02 14/07/2016  Jill Parkinson TSK 0822417
.           Added WTEEPTWT - Previous days waiting to DRFCUR00 calculation
. V10.08.01 25/04/2016  Jill Parkinson TSK 0813956
.           Added KEYDAY00 - Total days on list from date keyed
. V10.05.03 19/02/2015  Ebon Clements  CAR 313149
.           Removed SFORMAT on HTMLLINK as it can't be used on vars longer
.           than DIM 127 - WATLNK00
. V10.05.02 26/09/2014 Steve Armstrong  CAR 306586
.           Added comment to add new variables to CLWATTR1.PBL
. V10.05.01 29/08/2014  Don Nguyen    CAR 303881
.           Added WTRE4830 - Hospital selection list output without default
. V10.04.01 07/05/2014  Peter Vela     CAR 279020
.           Added WAHealth indicator for WATHIS00
. V10.03.14 26/03/2013  Sandra Barcham CAR 294185
.           Esis 2014 Changes
. V10.03.13 19/08/2013  Don Nguyen    CAR 178866
.           Added validation on WTHIBSCD (Booking Status code);
.           Use cat "SC" if status is "06" (rebooked).
. V10.03.12 08/08/2013  Don Nguyen    CAR 289889
.           Added WTWMPDSC to CLWATDET to clear Proc Desc Comments
. V10.03.11 28/03/2013  Patrick Adair CAR 281132
.           Strip spaces from WTWMPDSC and WMDESC - new requirement
. V10.03.10 20/03/2013  Patrick Adair CAR 281132
.           Added new field WTRB0030 - Procedure Description Comment
. V10.03.09 05/12/2012 Jill Parkinson CAR 277119
.           Mods to go to LSTDAY99 if no admission record
. V10.03.08 16/08/2012  Don Nguyen    CAR 270629
.           Removed unnecessary extension field (WTRB0030)
. V10.03.07 15/08/2012  Don Nguyen    CAR 270629
.           Changed output for field WTRB0030 
. V10.03.06 15/08/2012  Don Nguyen    CAR 270629
.           Added new extension field WTRB0030 (Source of Referral)
. V10.03.05 29/06/2012 Jill Parkinson CAR 268050
.           Mods to set WTSUTDAT and FDAT to WMKEYDT
. V10.03.04 02/12/2011 Ebon Clements  CAR 250989
.           Added allowahs cgi to change intended hospital list - WATLNK00
. V10.03.03 14/11/2011  Mike Laming       CAR 233064
.           Added "Actual Procedure Event Number" WTWMACPR (WATTR057)
. V10.02.02 09/08/2011 Jill Parkinson CAR 248708
.           Made WTRE9300 output blank if no value in WTWMCSST
. V10.02.01 19/08/2011 Ebon Clements  CAR 234855
.           Populate created by field on intra episode record - WRED0000
. V10.01.01 04/11/2010 Davin          CAR 210842
.           Default Change column to 'W/L Updated' in history table (wathis20)
. V10.00.01 10/08/2010 Jill Parkinson CAR 227858 
.           Removed changing value of WTTXPLST in NRCDAY000         
. V9.12.03  09/12/2009  Peter McMullen CAR 210130
.           convert dr name format routine to DOCNM000        
. V9.12.02  26/11/2009  Saroeun Soeur  CAR 164870
.           XXXXXXXX.XX.X98 - added tag WTRE9800 - WTWMBSCD
. V9.12.01  09/09/2009  Jill Parkinson CAR 205541
.           Mods to differentiate between nrfc in the future and finishing today
.           in NRCDAY00
. V9.11.01  11/03/2009  Jill Habasque CAR 179959
.           Added "Provisional Adm Date Changed" to WATHIS00
. V9.10.01  22/07/2008  Jill Habasque CAR 174359
.           Added clear of WTWMASSR in CLWATDET
. V9.09.03  27/02/2008  Jill Habasque CAR 142726
.           Added use of WTCNERFC - ESIS RFC calculation
. V9.09.02  12/12/2007  Jill Habasque CAR 56032
.           Changed to display WTHIDBFT
. V9.09.01  06/12/2007  Ebon Clements CAR 152329
.           Added tag for WMUDEF4
. V9.07.01  19/09/2006  Mike Laming   CAR 111288
.           Add routine CLWATDET - moved from WATWEB01
. V9.04.12  26/10/2005 Mike Laming   CAR 52354
.           Add message "Invalid IBA Tag" at WTRE0000
. V9.04.11  24/10/2005 Jill Habasque CAR 80660
.           Mods to read patmi1af if wmstat=4 or 5 in LSTDAY00
. V9.04.10  11/10/2005 Jill Habasque CAR 76509
.           Removed update of wttxplst in NRCDAY00 (watweb05 does this)
. V9.04.09  28/09/2005 Mike Laming   CAR 65745
.           Add WTWMCSDT (Consent Changed Date), add Consent disply to WATHIS00
. V9.04.08  06/09/2005 Jill Habasque CAR 75059
.           Changed tag 58 to use Category S (not W1)
. V9.04.07  08/06/2005 Jill Habasque CAR 60165
.           Changed key to watesnaf
. V9.04.06  31/05/2005 Jill Habasque CAR 62408
.           Added output of wpdesc for procedure code 2 and 3
. V9.04.05  02/05/2005 Jill Habasque CAR 46826
.           Added nrfc days in OVRDT000 routine
. V9.04.04  01/04/2005 Jill Habasque CAR 55601
.           Added CRTDAY00
. V9.04.03  31/03/2005 Ebon Clements CAR 55603
.           Added WTWMUNIQ and WTWMBOOK to WATSUM00
. V9.04.02  24/02/2005 Jill Habasque CAR 58443
.           Added re-read of bokrc1af after calculating postponements
. V9.04.01  09/12/2004 Jill Habasque CAR 54731
.           Added WRED0000
. V9.03.05  26/06/2004 Jill Habasque CAR 50428
.           Mods to reread category TP after DRNRFC00
. V9.03.04  03/06/2004 Jill Habasque CAR 50428
.           Added clear of NRCDAY in OVRDT000
. V9.03.03  26/03/2004 Guomin Fu         CAR 44438
.           Added in WTRE1100 to display Schedule Admission Date when Removal
.           Reason ind03 = "S"
.           19/03/2004 Peter Vela        CAR 13038
.           Implemented DOCNM00 from PATDOCCD to use doctor name format
.           parameter for sort lists.
.         V9.03.02  04/03/2004 Henry Son         CAR 39528
.                   Show RFC Suspension to date on summary.
. V9.03.01  02/06/2003 Jill Habasque SRF 23744
.           Changed calculation in OVRDT000 to be the same as COVER000
. V9.02.37  08/05/2003 Jill Habasque SRF 38849
.           Mods to display priority changes in wathis00
. V9.02.36  29/11/2002 Jill Habasque SRF 23437
.           Changed WATHIS00 to display WTHIBCAN
. V9.02.35  14/11/2002 Jill Habasque SRF 23985
.           Fixed display of RFC status (added use of indicator 1 instead of   
.           hard coded to move in R)
. V9.02.34  29/10/2002 Jill Habasque SRF 23744
.           Added output of date of last clinical urgency increase
. V9.02.33  23/10/2002 Jill Habasque SRF 23063
.           Changed to use tcindc3 instead of the hdp in wtre1100 
. V9.02.32  05/10/2002 Jill Habasque SRF 20533
.           Changed WATSUM00 to display 0 if no urgency change    
. V9.02.31  27.09.2002 Ebon Clements SRF 22614
.           Fixed display of the unit in the waiting list history 
. V9.02.30  18.09.2002 Jill Habasque SRF 20534
.           Added new tag for days ready for care following last 
.           urgency increase
. V9.02.29  24.08.2002 Jill Habasque SRF 20795
.           Mods to display WMDATE3 if admitted to other hospital    
. V9.02.28  21.08.2002 Jill Habasque SRF 20301
.           Changed URGDAY00 to be zero if no changes have been made
.           SRF 19057 - added call to LSTDAY00 and NRCDAY00 in  WATSUM00
. V9.02.27  02.07.2002 Jill Habasque 
.           Added 32 for Unremove in history screen
. V9.02.26  28/06/2002 Ebon Clements  SRF 17676 17694 17700
.           Fixed display of waiting list history WATHIS00            
. V9.02.25  27/06/2002 Jill Habasque  SRF 19066
.           Added WTTRTDES - Transfer destination                     
. V9.02.24  04/06/2002 Jill Habasque  SRF 18156
.           Added exit in NRCDF000 if NRFC indefinitely               
. V9.02.23  03/06/2002 Jill Habasque  SRF 18156
.           Mods to calculate days on list up to removal date         
.           New routine - NRCDF000 - Not ready for care including future - used
.           to calculate overdue date
. V9.02.22  20/05/2002 Jill Habasque  SRF 17618
.           Fixed NRCDAY00 for suspension records not in date order
. V9.02.21  26/04/2002 Jill Habasque  SV 88295
.           Added UUWTTX11 to be at NRCDAY99 (not NRCDAY90)
. V9.02.20  19/04/2002 Pat Dirito 
.           Added checking of active codes at label NRCDAY60
. V9.02.19  17/04/2002 Jill Habasque  3564
.           Added save of wtsuauto in NRCDAY00    
. V9.02.18  09/03/2002 Ashwin
.           Display Rebooked status on W/L History
. V9.02.17  05/03/2002 Jill Habasque 3348
.           Commented out add of one to LSTDAYS in lstday00
. V9.02.16  02/02/2002 Ebon Clements 
.           Mods to WATHIS00 - waiting list history display function  
. V9.02.15  31/01/2002 Ebon Clements 
.           Fixed display of reason for change in procedure history
. V9.02.14  15/01/2002 Ebon Clements 
.           Removed review date from waiting list history display WATHIS00
. V9.02.13  24/12/2001 Ebon Clements 
.           Activated noted out code in WATLHI00 to clear KEY12 when the
.           WTLHREPR date is blank.
. V9.02.12  03/12/2001 Ebon Clements 
.           Fixed calculation of NRFC days.                   
. V9.02.11  22/11/2001 Sai 
.           Waiting Letter flag checked in WATLHI00 for interpreter requirement
. V9.02.10  16/11/2001  B.G.Ackland
.           Waiting Letter Audit Date
. V9.02.09  15/11/2001  B.G.Ackland
.           Waiting List Defects
. V9.02.08  15/11/2001  Ashwin
.           Change Procedure to display everything except Removed patient
.           procedure
. V9.02.07  14/11/2001  Raghunandan Surve - HPS
.           Changed to display referring hospital 
.           Do not display Proposed Adm. Date for "Removed" status
. V9.02.06  30/10/2001  Ashwin
.           Display Status Changed/Unit Changed on History
. V9.02.05  08/10/2001  Ashwin - HPS
.           Fixed overdue date to pick control file variables for calculation
.           instead of associate number
. V9.02.04  02/10/2001  Ashwin - HPS
.           Fixed for the NRFC and RFC calculation and Changed the Sch Adm Date
.           Status to display Booked and proper display of Overdue date
. V9.02.03  24/09/2001  Rahul Gupta
.           Check for 01 Booking code Added.
. V9.02.02  21/09/2001  Rahul Gupta
.           Reading Booking file for Reason for Cancellation 
. V9.02.01  13/09/2001  Rahul Gupta
.           Check for correct Booking code Variable
. V9.00.00  08/09/2001  Rahul Gupta
.           Changed Category from S to W1
.
.----------------------------------------------------------------------
.     Clear all the Waiting List Procedure
.     (Key vars WMURNO WMCNT and WTWMUNIQ are not Initialised here)
.     Note - any changes to these variables also required in WATDETTM.PBL
.            and CLWATTR1.PBL
.----------------------------------------------------------------------
CLWATDET  MOVE      ZERO,WMTIME
          MOVE      SP70,WMCODE
          MOVE      SP70,WMDESC
          MOVE      SP70,WMREASON
          MOVE      ZERO,WMSTAT
          MOVE      SP70,WMDATE1
          MOVE      SP70,WMDATE2
          MOVE      SP70,WMDATE3
          MOVE      SP70,WMDATE4
          MOVE      SP70,WMREMOVE
          MOVE      SP70,WMUNIT
          MOVE      SP70,WMDOCTOR
          MOVE      ZERO,WMSTAY
          MOVE      SP70,WMPTY
          MOVE      SP70,WMNOTICE
          MOVE      SP70,WMPTYPE
          MOVE      SP70,WMPCAT
          MOVE      SP70,WMUDEF1
          MOVE      SP70,WMUDEF2
          MOVE      SP70,WMUDEF3
          MOVE      SP70,WMUDEF4
          MOVE      ZEROVISN,WMBOOK
          MOVE      SP70,WMKEYDT
          MOVE      SP70,WTWMPORT
          MOVE      SP70,WTWMREAD
          MOVE      SP70,WTWMDEDA
          MOVE      ZERO,WTWMSENT
          MOVE      SP70,WTWMCLSS
          MOVE      SP70,WTWMDTAD
          MOVE      SP70,WTWMACAT
          MOVE      SP70,WTWMGADD
          MOVE      SP70,WTWMDABD
          MOVE      SP70,WTWMEATY
          MOVE      SP70,WTWMADMC
          MOVE      SP70,WTWMECRA
          MOVE      SP70,WTWMGPFA
          MOVE      SP70,WTWMRFGP
          MOVE      SP70,WTWMGPPC
          MOVE      SP70,WTWMNAFR
          MOVE      SP70,WTWMNATO
          MOVE      SP70,WTWMGPPT
          MOVE      SP70,WTWMDOFR
          MOVE      SP70,WTWMOPER
          MOVE      SP70,WTWMIHSP
          MOVE      SP70,WTWMVLSF
          MOVE      SP70,WTWMPRO2
          MOVE      SP70,WTWMPRO3
          MOVE      SP70,WTWMTRPA
          MOVE      SP70,WMUDEF5
          MOVE      SP70,WMUDEF6
          MOVE      SP70,WMUDEF7
          MOVE      SP70,WMUDEF8
          MOVE      "     0",WTWMRANK
          MOVE      SP70,WTWMSRCR
          MOVE      SP70,WTWMDRSA
          MOVE      SP70,WTWMDOSA
          MOVE      SP70,WTWMPHSP
          MOVE      SP70,WTWMBSCD
          MOVE      SP70,WTWMRSFL
          MOVE      SP70,WTWMECNT
          MOVE      SP70,WTWMCSST
          MOVE      SP70,WTWMCSDT
          MOVE      SP70,WTWMASSR
          MOVE      SP70,WTWMACPR
          PACK      WTWMPDSC,SP70,SP70
          MOVE      SP70,WTWMRADT
          PACK      WMDESC2,SP70,SP70
          PACK      WMDESC3,SP70,SP70
          MOVE      SP70,WTWMSPAR
.
          RETURN
.------------------------------------------------------------
. Add Field
.------------------------------------------------------------
WTRE0000  BRANCH    FLDITMNO,WTRE0100,WTRE0200,WTRE0300,WTRE0400,WTRE0500:
                             WTRE0600,WTRE0700,WTRE0800,WTRE0900,WTRE1000:
                             WTRE1100,WTRE1200,WTRE1300,WTRE1400,WTRE1500:
                             WTRE1600,WTRE1700,WTRE1800,WTRE1900,WTRE2000:
                             WTRE2100,WTRE2200,WTRE2300,WTRE2400,WTRE2500:
                             WTRE2600,WTRE2700,WTRE2800,WTRE2900,WTRE3000:
                             WTRE3100,WTRE3200,WTRE3300,WTRE3400,WTRE3500:
                             WTRE3600,WTRE3700,WTRE3800,WTRE3900,WTRE4000:
                             WTRE4100,WTRE4200,WTRE4300,WTRE4400,WTRE4500:
                             WTRE4600,WTRE4700,WTRE4800,WTRE4900,WTRE5000:
                             WTRE5100,WTRE5200,WTRE5300,WTRE5400,WTRE5500:
                             WTRE5600,WTRE5700,WTRE5800,WTRE5900,WTRE6000:
                             WTRE6100,WTRE6200,WTRE6300,WTRE6400,WTRE6500:
                             WTRE6600,WTRE6700,WTRE6800,WTRE6900,WTRE7000:
                             WTRE7100,WTRE7200,WTRE7300,WTRE7400,WTRE7500:
                             WTRE7600,WTRE7700,WTRE7800,WTRE7900,WTRE8000:
                             WTRE8100,WTRE8200,WTRE8300,WTRE8400,WTRE8500:
                             WTRE8600,WTRE8700,WTRE8800,WTRE8900,WTRE9000:
                             WTRE9100,WTRE9200,WTRE9300,WTRE9400,WTRE9500:
                             WTRE9600,WTRE9700,WTRE9800,WTRE9900
.
.
          WRITE     HTMLFILE;"Invalid IBA Tag WATTRETM";
          GOTO      WTRE9999
.
WTRE0100  PACK      KEY19,WMURNO,WMCODE,WMCNT
          WRITE     HTMLFILE;KEY19;
          GOTO      WTRE9999
.
WTRE0200  WRITE     HTMLFILE;WMURNO;
          GOTO      WTRE9999
.
WTRE0300  WRITE     HTMLFILE;WMCODE;
          GOTO      WTRE9999
.
WTRE0400  WRITE     HTMLFILE;WMCNT;
          GOTO      WTRE9999
.
WTRE0500  MOVE      WMTIME,D6
          MATCH     SP70,D6
          IF        !@EQUAL
            MOVE      "mins",KEY4
            PACK      KEY11,WMTIME,SP1,KEY4,SP70           
          ENDIF
          WRITE     HTMLFILE;KEY11;
          GOTO      WTRE9999
.
WTRE0600  MATCH     SP70,WMDESC
          GOTO      WTRE9999 IF EQUAL
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   VAR,F3
          MOVE      WMDESC,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
          GOTO      WTRE9999
.
WTRE0700  MATCH     SP70,WMREASON
          GOTO      WTRE9999 IF EQUAL
          STRIP     WMREASON
          MOVELPTR  WMREASON,F3
          SFORMAT   VAR,F3
          MOVE      WMREASON,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
          GOTO      WTRE9999
.
WTRE0800  
..          MOVE      WMBOOK,KEY8
..          CALL      RDBKREC1
..          IF        OVRCD=0
..           IF        BKRESTAT=2
..              WRITE      HTMLFILE;"Cancelled Adm.";
..              GOTO      WTRE9999
..            ENDIF
..          ENDIF
..
          BRANCH    WMSTAT,WTRE0810,WTRE0820,WTRE0830,WTRE0840,WTRE0850:
                           WTRE0860,WTRE0870,WTRE0880,WTRE0890
.
WTRE0810  WRITE     HTMLFILE;"Unscheduled";
          GOTO      WTRE9999
WTRE0820  WRITE     HTMLFILE;"Scheduled";
          GOTO      WTRE9999
WTRE0830  WRITE     HTMLFILE;"Pre-Admitted";
          GOTO      WTRE9999
WTRE0840  WRITE     HTMLFILE;"Admitted";
          GOTO      WTRE9999
WTRE0850  WRITE     HTMLFILE;"Discharged";
          GOTO      WTRE9999
WTRE0860  WRITE     HTMLFILE;"Removed from Waiting List";
          GOTO      WTRE9999
WTRE0870  WRITE     HTMLFILE;"Performed";
          GOTO      WTRE9999
WTRE0880  WRITE     HTMLFILE;"Not Performed";
          GOTO      WTRE9999
WTRE0890  WRITE     HTMLFILE;"Cancelled Booking";
          GOTO      WTRE9999
.
WTRE0900  MATCH     SP70,WMDATE1
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE1000  MATCH     SP70,WMDATE2
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WMDATE2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE1100  IF        WMSTAT=6
            MATCH     SP70,WMREMOVE
            GOTO      WTRE9999 IF EQUAL
.
            PACK      KEY5,ANSW,ANSR,WMREMOVE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,WTRE9999
.
            MATCH     ANSX,TCINDC3
            GOTO      WTRE1150 IF EQUAL
            MATCH     ANSP,TCINDC3
            GOTO      WTRE1150 IF EQUAL
            MATCH     ANSK,TCINDC3
            GOTO      WTRE1150 IF EQUAL
            MATCH     ANSS,TCINDC3
            GOTO      WTRE9999 IF NOT EQUAL
          ENDIF
WTRE1150  MATCH     SP70,WMDATE3
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WMDATE3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE1200  MATCH     SP70,WMDATE4
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WMDATE4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE1300  MOVE      "WR",CATEGORY
          MOVE      WMREMOVE,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE1400  MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE1500  MOVE      WMDOCTOR,DOCTCODE
          CALL      DOCDET00
          GOTO      WTRE9999
.
WTRE1600  MOVE      WMSTAY,D5
          SQUEEZE   D5
          WRITE     HTMLFILE;D5;
          GOTO      WTRE9999
.
WTRE1700  MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE1800  MOVE      "WS",CATEGORY
          MOVE      WMNOTICE,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE1900  MOVE      "T ",CATEGORY
          MOVE      WMPTYPE,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2000  MOVE      "A ",CATEGORY
          MOVE      WMPCAT,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2100  MOVE      "W1",CATEGORY
          MOVE      WMUDEF1,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2200  MOVE      "W2",CATEGORY
          MOVE      WMUDEF2,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2300  MOVE      "W3",CATEGORY
          MOVE      WMUDEF3,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2400  MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE2500  WRITE     HTMLFILE;WMBOOK;
          GOTO      WTRE9999
.
WTRE2600  MATCH     SP70,WMKEYDT
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WMKEYDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE2700  MATCH     SP70,WTWMREAD
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMREAD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE2800  MATCH     SP70,WTWMDEDA
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMDEDA,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE2900  WRITE     HTMLFILE;WTWMUNIQ;
          GOTO      WTRE9999
.
WTRE3000  WRITE     HTMLFILE;WTWMSENT;
          GOTO      WTRE9999
.
WTRE3100  MOVE      "P ",CATEGORY
          MOVE      WTWMCLSS,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE3200  MATCH     SP70,WTWMDTAD
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMDTAD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE3300  MOVE      "CL",CATEGORY
          MOVE      WTWMACAT,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE3400  MATCH     SP70,WTWMGADD
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMGADD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE3500  MATCH     SP70,WTWMDABD
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE3600  MOVE      "CC",CATEGORY
          MOVE      WTWMEATY,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE3700  MOVE      "WA",CATEGORY
          MOVE      WTWMADMC,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE3800  WRITE     HTMLFILE;WTWMECRA;
          GOTO      WTRE9999
.
WTRE3900  WRITE     HTMLFILE;WTWMGPFA;
          GOTO      WTRE9999
.
WTRE4000  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTRE4010
          PACK      GENPCODE,WTWMRFGP,SP70
          CALL      HCPDET00
          GOTO      WTRE9999
.
WTRE4010  WRITE     HTMLFILE;WTWMRFGP;
          GOTO      WTRE9999
.
WTRE4100  WRITE     HTMLFILE;WTWMGPPC;
          GOTO      WTRE9999
.
WTRE4200  WRITE     HTMLFILE;WTWMGPPC;
          GOTO      WTRE9999
.
WTRE4300  MATCH     SP70,WTWMNAFR
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMNAFR,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE4400  MATCH     SP70,WTWMNATO
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMNATO,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE4500  WRITE     HTMLFILE;WTWMGPPT;
          GOTO      WTRE9999
.
WTRE4600  MOVE      "DA",CATEGORY
          MOVE      WTWMDOFR,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE4700  MOVE      WTWMOPER,KEY4
          CALL      RDPASS1
          IF        OVRCD=0
            WRITE     HTMLFILE;SECUSER;
          ENDIF
          GOTO      WTRE9999
.
WTRE4800  PACK      D3,WTWMIHSP,SP70
          UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTRE4810,WTRE4820,WTRE4830
.
          WRITE     HTMLFILE;WTWMIHSP;
          GOTO      WTRE9999
.
WTRE4810  PACK      KEY3,WTWMIHSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            WRITE     HTMLFILE;PTHSNAME;
          ENDIF
          GOTO      WTRE9999
.
WTRE4820  MATCH     SP70,D3
          IF        @EQUAL
            PACK      D3,WBSEHOSP,SP70
          ENDIF
          CALL      HOSSEL00
          GOTO      WTRE9999
.
WTRE4830  CALL      HOSSEL00
          GOTO      WTRE9999
.
WTRE4900  WRITE     HTMLFILE;WTWMVLSF;
          GOTO      WTRE9999
.
WTRE5000  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTRE5010
          WRITE     HTMLFILE;WTWMPRO2;
          GOTO      WTRE9999
.
WTRE5010  PACK      KEY9,WTWMPRO2,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WTRE9999
          WRITE     HTMLFILE;WPDESC;
          GOTO      WTRE9999
.
WTRE5100  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTRE5110
          WRITE     HTMLFILE;WTWMPRO3;
          GOTO      WTRE9999
.
WTRE5110  PACK      KEY9,WTWMPRO3,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WTRE9999
          WRITE     HTMLFILE;WPDESC;
          GOTO      WTRE9999
.
WTRE5200  MATCH     SP70,WTWMTRPA
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMTRPA,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE5300  MOVE      "X5",CATEGORY
          MOVE      WMUDEF5,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE5400  MOVE      "X6",CATEGORY
          MOVE      WMUDEF6,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE5500  MOVE      "X7",CATEGORY
          MOVE      WMUDEF7,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE5600  MOVE      "X8",CATEGORY
          MOVE      WMUDEF8,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE5700  WRITE     HTMLFILE;WTWMRANK;
          GOTO      WTRE9999
.
WTRE5800  MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE5900  CALL      WATLHI00
          GOTO      WTRE9999
.
WTRE6000  MOVE      ZERO,LINK2PRT      * No link to parent 
          MOVE      ZERO,SHOWHIDD      * don't show hidden records
          MOVE      ZERO,SHOCNSNT      * don't show Consent
          MOVE      ZERO,WAHEAIND      * WAHealth indicator
          CALL      WATHIS00
          GOTO      WTRE9999
.
WTRE6100  CALL      WATCOM00
          GOTO      WTRE9999
.
WTRE6200  CALL      LSTDAY00
          WRITE     HTMLFILE;LSTDAYS;
          GOTO      WTRE9999
.
WTRE6300  CALL      NRCDAY00
          COMPARE   ZERO,NRCDAYS
          IF        !@EQUAL
            WRITE     HTMLFILE;NRCDAYS;
          ELSE
            WRITE     HTMLFILE;ZERO;
          ENDIF
          GOTO      WTRE9999
.
WTRE6400  CALL      URGDAY00
          WRITE     HTMLFILE;URGDAYS;
          GOTO      WTRE9999
.
WTRE6500  MOVE      ZERO,ALLWFLAG
          CALL      WATSUM00
          GOTO      WTRE9999
.
WTRE6600  MOVE      ZERO,HOSPOST   * Hospital Postponed Bookings
          CALL      WATHPT00
          WRITE     HTMLFILE;HOSPOST;
          GOTO      WTRE9999
.
WTRE6700  ASSIGN    ZERO,RFCDAYS 
          CALL      NRCDAY00
          CALL      LSTDAY00
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS >= 1
            WRITE     HTMLFILE;RFCDAYS;
          ELSE
            WRITE     HTMLFILE;"0";
          ENDIF
          GOTO      WTRE9999
.
WTRE6800  CALL      WATCMN00
          GOTO      WTRE9999
.
WTRE6900  CALL      WTNRFC00 
          GOTO      WTRE9999
.
WTRE7000  MOVE      ZERO,UNITPOST   * Hospital Postponed Bookings
          CALL      WATUNT00
          WRITE     HTMLFILE;UNITPOST;
          GOTO      WTRE9999
.
WTRE7100  MOVE      ZERO,PATPOST   * Hospital Postponed Bookings
          CALL      WATPAT00
          WRITE     HTMLFILE;PATPOST;
          GOTO      WTRE9999
.
WTRE7200  CALL      WTPCOM00
          GOTO      WTRE9999
.
WTRE7300  CALL      WATAUD00 
          GOTO      WTRE9999
.
WTRE7400  CALL      WTLAUD00
          GOTO      WTRE9999
.
WTRE7500  WRITE     HTMLFILE;WMSTAT;
          GOTO      WTRE9999
.
WTRE7600  MATCH     SP70,WMPTY
          GOTO      WTRE9999 IF EQUAL
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          CALL      OVRDT000
          GOTO      WTRE9999
.
WTRE7700  MATCH     SP70,WTTXPLST
          GOTO      WTRE9999 IF EQUAL
.
          PACK      KEY5,ANSV,ANSL,WTTXPLST,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WTRE9999
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            CALL      WTNRFC00 
          ELSE
            WRITE     HTMLFILE;SP1;
          ENDIF
          GOTO      WTRE9999
.
WTRE7800  CALL      WATUSH00   * Unscheduled Procedure List
          GOTO      WTRE9999
.
WTRE7900  WRITE     HTMLFILE;WTRTREFR;   * Referring Hospital
          GOTO      WTRE9999
.
WTRE8000  MOVE      WTRTREFR,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,WTRE9999
          WRITE     HTMLFILE;PTVADESC;
          GOTO      WTRE9999
.
WTRE8100  MATCH     ZEROVISN,WMBOOK
          GOTO      WTRE9999 IF EQUAL
          MOVE      WMBOOK,KEY8             * Pre Admitted/Admitted/Discharged
          CALL      RDMISS1
          BRANCH    OVRCD,WTRE9999
.
          COMPARE   "1",ASTAT               * Pre Admitted Only
          GOTO      WTRE9999 IF EQUAL
.
          COMPARE   "5",ASTAT               * Cancelled
          GOTO       WTRE9999 IF EQUAL
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE8200  MOVE      ONE,LINK2PRT      * link to parent 
          MOVE      ONE,SHOWHIDD      * show hidden records
          MOVE      ZERO,SHOCNSNT     * don't show Consent
          MOVE      ZERO,WAHEAIND     * WAHealth indicator
          CALL      WATHIS00
          GOTO      WTRE9999
.
WTRE8300  WRITE     HTMLFILE;WTRTTDES;   * Transferred to Hospital
          GOTO      WTRE9999
.
WTRE8400  MOVE      WTRTTDES,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,WTRE9999
          WRITE     HTMLFILE;PTVADESC;
          GOTO      WTRE9999
.
WTRE8500  CALL      DRFCUR00    * days RFC following last urgency reassignment
.
          WRITE     HTMLFILE;URRFCDAY;
          GOTO      WTRE9999
.
WTRE8600  CALL      DRFCUR00    * days RFC following last urgency reassignment
.
          MATCH     CLURCTDT,WMDATE1
          GOTO      WTRE9999 IF EQUAL
.
          READ      CONTROLF,HUND11;*11,WTCNERFC
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MATCH     CLURCTDT,WMKEYDT
            GOTO      WTRE9999 IF EQUAL
          ENDIF
.
          UNPACK    CLURCTDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE8700  READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      BRSRCAT,WTCNBRSR,CATW1,CATW2,CATW3,CATW4,CATX5:
                                     CATX6,CATX7,CATX8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      BRSRCAT,ANSS,SP70
          ENDIF
          MOVE      BRSRCAT,CATEGORY
          LOAD      CODE,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      CODE,WTWMSRCR,SP70
          ENDIF
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE8800  MATCH     SP70,WTWMDRSA
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMDRSA,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE8900  MATCH     SP70,WTWMDOSA
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMDOSA,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE9000  MOVE      "HP",CATEGORY
          MOVE      WTWMPHSP,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE9100  WRITE     HTMLFILE;WTWMECNT;
          GOTO      WTRE9999
.
WTRE9200  CALL      CRTDAY00
          WRITE     HTMLFILE;CRTDAYS;
          GOTO      WTRE9999
.
WTRE9300  MOVE      SP70,DIM3
          MATCH     "N",WTWMCSST
          IF        @EQUAL
            MOVE      "No ",DIM3
          ENDIF
          MATCH     "Y",WTWMCSST
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
          WRITE     HTMLFILE;DIM3;
          GOTO      WTRE9999
.
WTRE9400  MATCH     SP70,WTWMCSDT
          GOTO      WTRE9999 IF EQUAL
          UNPACK    WTWMCSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRE9500  MOVE      ZERO,LINK2PRT      * No link to parent 
          MOVE      ZERO,SHOWHIDD      * don't show hidden records
          MOVE      ONE,SHOCNSNT       * show Consent info
          MOVE      ZERO,WAHEAIND      * WAHealth indicator
          CALL      WATHIS00
          GOTO      WTRE9999
.
WTRE9600  MOVE      "W4",CATEGORY
          MOVE      WMUDEF4,CODE
          CALL      CODITM00
          GOTO      WTRE9999
.
WTRE9700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,WTRE9710
          PACK      KEY10,WTWMASSR,SP30
          CALL      RDPMHCP1
          BRANCH    OVRCD,WTRE9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      WTRE9999
.
WTRE9710  WRITE     HTMLFILE;WTWMASSR;
          GOTO      WTRE9999
.
WTRE9800  WRITE     HTMLFILE;WTWMBSCD;
          GOTO      WTRE9999
.
. Extension of wattretm
.
WTRE9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      WTRB0000
          GOTO      WTRE9999
.
WTRE9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HOSSEL00  PACK      KEY3,SP70
          CALL      RSPTHSP1
HOSSEL10  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSSEL99
.
          MATCH     D3,PTHSHOSP             * display hospital if current value
          GOTO      HOSSEL20 IF EQUAL
.
          PACK      KEY13,WBSEUID,SP70
          CALL      RSMLSEC1
          CALL      RKMLSEC1
          BRANCH    OVRCD,HOSSEL20
.
          MATCH     WBSEUID,MLSCUSID
          GOTO      HOSSEL20 IF NOT EQUAL
.
          PACK      KEY13,WBSEUID,PTHSHOSP,SP70
          CALL      RDMLSEC1
          IF        OVRCD=1
            GOTO      HOSSEL10
          ENDIF
.
HOSSEL20  MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     D3,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HOSSEL10
.
HOSSEL99  RETURN
+
.------------------------------------------------------------
. Get Number of Hospital Postponements
.------------------------------------------------------------
WATHPT00  PACK      KEY16,WMURNO,SP20
          CALL      RSBKREC6                * Position on & read a booking
WATHPT10  CALL      RKBKREC6                  file record
          BRANCH    OVRCD,WATHPT99
          MATCH     WMURNO,BKREURNO
          GOTO      WATHPT99 IF NOT EQUAL   * Different U/R no
          MATCH     WMCODE,BKREPROC
          GOTO      WATHPT10 IF NOT EQUAL   * Different procedure code
          COMPARE   WMCNT,BKRECNT
          GOTO      WATHPT10 IF NOT EQUAL   * Different procedure count
.
          MATCH     "THE",BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSC,BKRECANC
            CALL      RDCODE1                 * Read a codes file record
            BRANCH    OVRCD,WATHPT10
            MATCH     ANSH,TCINDC2
            GOTO      WATHPT10 IF NOT EQUAL
            ADD       ONE,HOSPOST
            GOTO      WATHPT10
          ENDIF
.
          MOVE      BKREBOOK,KEY8
          PACK      KEY31,KEY8,THREE,WMDATE1,SP30
          CALL      RSOPDEA2                * Position on & read a operation
WATHPT20  CALL      RKOPDEA2                  detail file record
          BRANCH    OVRCD,WATHPT10
          MATCH     KEY8,OPDAADMN
          GOTO      WATHPT10 IF NOT EQUAL   * Different booking no, exit
          MATCH     SP3,OPDACANC
          GOTO      WATHPT20 IF EQUAL       * Blank cancellation code, get next
.
          PACK      KEY5,ANSS,ANSC,OPDACANC
          CALL      RDCODE1                 * Read a codes file record
          BRANCH    OVRCD,WATHPT20
          MATCH     ANSH,TCINDC2
          GOTO      WATHPT20 IF NOT EQUAL
          ADD       ONE,HOSPOST
          GOTO      WATHPT20
.
WATHPT99  PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL      CLBOKREC
          ENDIF
          RETURN
.------------------------------------------------------------
. Get Number of Unit Postponements
.------------------------------------------------------------
WATUNT00  PACK      KEY16,WMURNO,SP20
          CALL      RSBKREC6                * Position on & read a booking
WATUNT10  CALL      RKBKREC6                  file record
          BRANCH    OVRCD,WATUNT99
          MATCH     WMURNO,BKREURNO
          GOTO      WATUNT99 IF NOT EQUAL   * Different U/R no
          MATCH     WMCODE,BKREPROC
          GOTO      WATUNT10 IF NOT EQUAL   * Different procedure code
          COMPARE   WMCNT,BKRECNT
          GOTO      WATUNT10 IF NOT EQUAL   * Different procedure count
.
          MATCH     "THE",BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSC,BKRECANC
            CALL      RDCODE1                 * Read a codes file record
            BRANCH    OVRCD,WATUNT10
            MATCH     ANSU,TCINDC2
            GOTO      WATUNT10 IF NOT EQUAL
            ADD       ONE,UNITPOST
            GOTO      WATUNT10
          ENDIF
.
          MOVE      BKREBOOK,KEY8
          PACK      KEY31,KEY8,THREE,WMDATE1,SP30
          CALL      RSOPDEA2                * Position on & read a operation
WATUNT20  CALL      RKOPDEA2                  detail file record
          BRANCH    OVRCD,WATUNT10
          MATCH     KEY8,OPDAADMN
          GOTO      WATUNT10 IF NOT EQUAL   * Different booking no, exit
          MATCH     SP3,OPDACANC
          GOTO      WATUNT20 IF EQUAL       * Blank cancellation code, get next
.
          PACK      KEY5,ANSS,ANSC,OPDACANC
          CALL      RDCODE1                 * Read a codes file record
          BRANCH    OVRCD,WATUNT20
          MATCH     ANSU,TCINDC2
          GOTO      WATUNT20 IF NOT EQUAL
          ADD       ONE,UNITPOST
          GOTO      WATUNT20
.
WATUNT99  PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL      CLBOKREC
          ENDIF
          RETURN
.------------------------------------------------------------
. Get Number of Patient Postponements
.------------------------------------------------------------
WATPAT00  PACK      KEY16,WMURNO,SP20
          CALL      RSBKREC6                * Position on & read a booking
WATPAT10  CALL      RKBKREC6                  file record
          BRANCH    OVRCD,WATPAT99
          MATCH     WMURNO,BKREURNO
          GOTO      WATPAT99 IF NOT EQUAL   * Different U/R no
          MATCH     WMCODE,BKREPROC
          GOTO      WATPAT10 IF NOT EQUAL   * Different procedure code
          COMPARE   WMCNT,BKRECNT
          GOTO      WATPAT10 IF NOT EQUAL   * Different procedure count
.
          MATCH     "THE",BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSC,BKRECANC
            CALL      RDCODE1                 * Read a codes file record
            BRANCH    OVRCD,WATPAT10
            MATCH     ANSP,TCINDC2
            GOTO      WATPAT10 IF NOT EQUAL
            ADD       ONE,PATPOST
            GOTO      WATPAT10
          ENDIF
.
          MOVE      BKREBOOK,KEY8
          PACK      KEY31,KEY8,THREE,WMDATE1,SP30
          CALL      RSOPDEA2                * Position on & read a operation
WATPAT20  CALL      RKOPDEA2                  detail file record
          BRANCH    OVRCD,WATPAT10
          MATCH     KEY8,OPDAADMN
          GOTO      WATPAT10 IF NOT EQUAL   * Different booking no, exit
          MATCH     SP3,OPDACANC
          GOTO      WATPAT20 IF EQUAL       * Blank cancellation code, get next
.
          PACK      KEY5,ANSS,ANSC,OPDACANC
          CALL      RDCODE1                 * Read a codes file record
          BRANCH    OVRCD,WATPAT20
          MATCH     ANSP,TCINDC2
          GOTO      WATPAT20 IF NOT EQUAL
          ADD       ONE,PATPOST
          GOTO      WATPAT20
.
WATPAT99  PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL      CLBOKREC
          ENDIF
          RETURN
.------------------------------------------------------------
. Calculate Days on List
.------------------------------------------------------------
LSTDAY00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          IF        WMSTAT>3 & WMSTAT<6
            MATCH     SP70,WMDATE3
            IF        !@EQUAL
              MOVE      WMDATE3,KEY8         * admitted or discharged
            ENDIF
          ENDIF
.
          IF        WMSTAT=6
            MATCH     SP70,WMDATE4
            IF        !@EQUAL
              MOVE      WMDATE4,KEY8         * removed
            ENDIF
          ENDIF
.
          IF        WMSTAT=4|WMSTAT=5
            PACK      KEY8,WMBOOK
            CALL      RDMISS1
            IF        OVRCD<>1
              PACK      KEY8,ADATE
            ELSE
              GOTO      LSTDAY99
            ENDIF
          ENDIF
.
          DAYSEP    WMDATE1,KEY8,LSTDAYS
..        ADD       ONE,LSTDAYS
LSTDAY99  RETURN
.
.------------------------------------------------------------
. Calculate Days on List - from date keyed
.------------------------------------------------------------
KEYDAY00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          IF        WMSTAT>3 & WMSTAT<6
            MATCH     SP70,WMDATE3
            IF        !@EQUAL
              MOVE      WMDATE3,KEY8         * admitted or discharged
            ENDIF
          ENDIF
.
          IF        WMSTAT=6
            MATCH     SP70,WMDATE4
            IF        !@EQUAL
              MOVE      WMDATE4,KEY8         * removed
            ENDIF
          ENDIF
.
          IF        WMSTAT=4|WMSTAT=5
            PACK      KEY8,WMBOOK
            CALL      RDMISS1
            IF        OVRCD<>1
              PACK      KEY8,ADATE
            ELSE
              GOTO      KEYDAY99
            ENDIF
          ENDIF
.
          DAYSEP    WMKEYDT,KEY8,LSTDAYS
KEYDAY99  RETURN
+
.------------------------------------------------------------
. Calculate Days since certainty given
.------------------------------------------------------------
CRTDAY00  MOVE      ZERO,CRTDAYS
          MATCH     SP70,WTWMDTAD
          GOTO      CRTDAY99 IF EQUAL
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          IF        WMSTAT>3 & WMSTAT<6
            MATCH     SP70,WMDATE3
            IF        !@EQUAL
              MOVE      WMDATE3,KEY8         * admitted or discharged
            ENDIF
          ENDIF
.
          IF        WMSTAT=6
            MATCH     SP70,WMDATE4
            IF        !@EQUAL
              MOVE      WMDATE4,KEY8         * removed
            ENDIF
          ENDIF
.
          MATCH     WTWMDTAD,KEY8
          GOTO      CRTDAY99 IF LESS
.
          DAYSEP    WTWMDTAD,KEY8,CRTDAYS
.
CRTDAY99  RETURN
.------------------------------------------------------------
. Calculate Days on Since Last Urgency Change
.------------------------------------------------------------
URGDAY00  MOVE      ZERO,URGDAYS
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MOVE      "TP",KEY2
          PACK      KEY21,WMURNO,WMCODE,WMCNT,KEY2,SP70
          PACK      KEY29,WMURNO,WMCODE,WMCNT,KEY2,Z70
          CALL      RSWTCAT2
          CALL      RPWTCAT2
          BRANCH    OVRCD,URGDAY99
          PACK      KEY29,WTCAURNO,WTCAPROC,WTCAPCNT,WTCACATF,SP70
          MATCH     KEY21,KEY29
          GOTO      URGDAY99 IF NOT EQUAL
          MATCH     WTCAEDAT,WMDATE1
          GOTO      URGDAY99 IF EQUAL
          DAYSEP    WTCAEDAT,TODAY,URGDAYS
          ADD       ONE,URGDAYS
          GOTO      URGDAY99
.        
URGDAY99  RETURN
.------------------------------------------------------------
. Calculate Days on List Not Ready for Care
.------------------------------------------------------------
NRCDAY00  READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      ZERO,F1
          MOVE      ZERO,D1
          MOVE      ZERO,KEY1
          PACK      TODAY,CCC,CYY,CMM,CDD
          MOVE      ZERO,NRDYCARE         * Current State - Ready For Care
          MOVE      SP70,NRDYCODE         * Current Not Ready For Care Code
          REP       " 0",TODAY
          MOVE      ZERO,NRCDAYS
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MOVE      WMKEYDT,KEY8
          ELSE
            MOVE      WMDATE1,KEY8
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,NRCDAY99
          PACK      SAVLIST,WTTXPLST
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
NRCDAY10  CALL      RKWTSUS1
          BRANCH    OVRCD,NRCDAY50
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      NRCDAY50 IF NOT EQUAL
.
          MOVE      WTSUAUTO,KEY1
          PACK      KEY5,ANSV,ANSL,WTSULSTS
          CALL      RDCODE1
          BRANCH    OVRCD,NRCDAY10
.
          MATCH     "R",TCINDC1
          GOTO      NRCDAY10 IF EQUAL
.
.-----------hps---To handle the situation of todate being blank------------
.
          MATCH     WTSUFDAT,TODAY
          GOTO      NRCDAY10 IF LESS
.
... Added for CAR 268050
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MATCH     WMKEYDT,WTSUFDAT
            IF        @LESS
              PACK      WTSUFDAT,WMKEYDT
            ENDIF
            MATCH     SP70,WTSUTDAT
            IF        !@EQUAL
              MATCH     WMKEYDT,WTSUTDAT
              IF        @LESS
                PACK      WTSUTDAT,WMKEYDT
              ENDIF
            ENDIF
          ENDIF
... End of code Added for CAR 268050
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      TODAY,WTSUTDAT
            MOVE      "1",D1
          ELSE
            MATCH     WTSUTDAT,TODAY
            GOTO      NRCDAY40 IF NOT LESS
            MOVE      TODAY,WTSUTDAT
          ENDIF
.
NRCDAY40  DAYSEP    WTSUFDAT,WTSUTDAT,F4
          MATCH     WTSUTDAT,TODAY
          IF        @LESS
            MOVE      ONE,NRDYCARE          * Current State - Not Ready For Care
          ENDIF
          MATCH     "1",D1
          IF        @EQUAL
            MOVE      ONE,NRDYCARE          * Current State - Not Ready For Care
          ENDIF
          MOVE      WTSULSTS,NRDYCODE     * Current Not Ready For Care Code
          ASSIGN    F4+NRCDAYS,NRCDAYS    * Do not add extra day to NRFC days
          GOTO      NRCDAY10
.
NRCDAY50  PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RLWTTX11
          BRANCH    OVRCD,NRCDAY99,NRCDAY99
          IF        NRDYCARE=1
......      MOVE      NRDYCODE,WTTXPLST
            GOTO      NRCDAY80
          ENDIF
.
          MOVE      "VL",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
NRCDAY60  CALL      RDKCODE1
          BRANCH    OVRCD,NRCDAY99
.
          MATCH     "VL",TCODE
          GOTO      NRCDAY99 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV           * Only want active codes
          GOTO      NRCDAY60 IF NOT EQUAL
.
          MATCH     "R",TCINDC1            * Must have indicator 1 = "R"
          GOTO      NRCDAY60 IF NOT EQUAL
.
......    MOVE      ACODE,WTTXPLST
.
NRCDAY80  MATCH     "1",KEY1
          GOTO      NRCDAY90 IF EQUAL
          GOTO      NRCDAY99
.
NRCDAY90  
.....CALL      UPWTTX11
.....     MATCH     WTTXPLST,SAVLIST
.....     IF        !@EQUAL
.....       PACK      WTENEVDT,WTSUTDAT
.....       CALL      WRED0000
.....     ENDIF
.
NRCDAY99  CALL      UUWTTX11
          RETURN
+
.-------------------------------------------------------------
. Calculate Days on List Not Ready for Care - Patient/Clinical
.-------------------------------------------------------------
NRCDYT00  READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      ZERO,F1
          MOVE      ZERO,D1
          MOVE      ZERO,KEY1
          PACK      TODAY,CCC,CYY,CMM,CDD
          MOVE      ZERO,NRDYCARE         * Current State - Ready For Care
          MOVE      SP70,NRDYCODE         * Current Not Ready For Care Code
          REP       " 0",TODAY
          MOVE      ZERO,NRCDAYS
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MOVE      WMKEYDT,KEY8
          ELSE
            MOVE      WMDATE1,KEY8
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,NRCDYT99
          PACK      SAVLIST,WTTXPLST
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
NRCDYT10  CALL      RKWTSUS1
          BRANCH    OVRCD,NRCDYT50
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      NRCDYT50 IF NOT EQUAL
.
          MOVE      WTSUAUTO,KEY1
          PACK      KEY5,ANSV,ANSL,WTSULSTS
          CALL      RDCODE1
          BRANCH    OVRCD,NRCDYT10
.
          MATCH     "R",TCINDC1
          GOTO      NRCDYT10 IF EQUAL
.
          PACK      KEY5,ANSW,ANSN,WTSUREAS
          CALL      RDCODE1
          BRANCH    OVRCD,NRCDYT10
.
          MATCH     WLTYCODE,TCINDC3
          GOTO      NRCDYT10 IF NOT EQUAL
.
.
.-----------hps---To handle the situation of todate being blank------------
.
          MATCH     WTSUFDAT,TODAY
          GOTO      NRCDYT10 IF LESS
.
... Added for CAR 268050
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MATCH     WMKEYDT,WTSUFDAT
            IF        @LESS
              PACK      WTSUFDAT,WMKEYDT
            ENDIF
            MATCH     SP70,WTSUTDAT
            IF        !@EQUAL
              MATCH     WMKEYDT,WTSUTDAT
              IF        @LESS
                PACK      WTSUTDAT,WMKEYDT
              ENDIF
            ENDIF
          ENDIF
... End of code Added for CAR 268050
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      TODAY,WTSUTDAT
            MOVE      "1",D1
          ELSE
            MATCH     WTSUTDAT,TODAY
            GOTO      NRCDYT40 IF NOT LESS
            MOVE      TODAY,WTSUTDAT
          ENDIF
.
NRCDYT40  DAYSEP    WTSUFDAT,WTSUTDAT,F4
          MATCH     WTSUTDAT,TODAY
          IF        @LESS
            MOVE      ONE,NRDYCARE          * Current State - Not Ready For Care
          ENDIF
          MATCH     "1",D1
          IF        @EQUAL
            MOVE      ONE,NRDYCARE          * Current State - Not Ready For Care
          ENDIF
          MOVE      WTSULSTS,NRDYCODE     * Current Not Ready For Care Code
          ASSIGN    F4+NRCDAYS,NRCDAYS    * Do not add extra day to NRFC days
          GOTO      NRCDYT10
.
NRCDYT50  PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,NRCDYT99,NRCDYT99
          IF        NRDYCARE=1
            GOTO      NRCDYT80
          ENDIF
.
          MOVE      "VL",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
NRCDYT60  CALL      RDKCODE1
          BRANCH    OVRCD,NRCDYT99
.
          MATCH     "VL",TCODE
          GOTO      NRCDYT99 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV           * Only want active codes
          GOTO      NRCDYT60 IF NOT EQUAL
.
          MATCH     "R",TCINDC1            * Must have indicator 1 = "R"
          GOTO      NRCDYT60 IF NOT EQUAL
.
NRCDYT80  MATCH     "1",KEY1
          GOTO      NRCDYT90 IF EQUAL
          GOTO      NRCDYT99
.
NRCDYT90
.
NRCDYT99  RETURN
.------------------------------------------------------------
. Calculate Days on List Not Ready for Care - including future dates
. Exit=1 - Indefinitely NR
.------------------------------------------------------------
NRCDF000  READ      CONTROLF,HUND11;*11,WTCNERFC
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MOVE      ZERO,EXIT
          MOVE      ZERO,NRCDAYS
          MOVE      WMDATE1,KEY8
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MOVE      WMKEYDT,KEY8
          ENDIF
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
NRCDF010  CALL      RKWTSUS1
          BRANCH    OVRCD,NRCDF999
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      NRCDF999 IF NOT EQUAL
.
          PACK      KEY5,ANSV,ANSL,WTSULSTS
          CALL      RDCODE1
          BRANCH    OVRCD,NRCDF010
.
          MATCH     "R",TCINDC1
          GOTO      NRCDF010 IF EQUAL
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      ONE,EXIT
            GOTO      NRCDF999
          ENDIF
.
NRCDF040  DAYSEP    WTSUFDAT,WTSUTDAT,F4
          ASSIGN    F4+NRCDAYS,NRCDAYS    * Do not add extra day to NRFC days
          GOTO      NRCDF010
.
NRCDF999  RETURN
.------------------------------------------------------------
. Display Comments
.------------------------------------------------------------
WATCOM00  PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WATCOM10  CALL      RDKMESA1
          BRANCH    OVRCD,WATCOM99
          MATCH     WMURNO,WAURNO
          GOTO      WATCOM99 IF NOT EQUAL
          MATCH     WMCODE,WAPROC
          GOTO      WATCOM99 IF NOT EQUAL
          COMPARE   WMCNT,WACNT
          GOTO      WATCOM99 IF NOT EQUAL
          STRIP     WATEXT
          MOVELPTR  WATEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WATEXT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WATCOM10
WATCOM99  RETURN
.------------------------------------------------------------
. Display Letter History Table
. Waiting List Letters
.------------------------------------------------------------
WATLHI00  PACK      KEY30,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTLHI1
WATLHI10  CALL      RPWTLHI1
          BRANCH    OVRCD,WATLHI99
          MATCH     WMURNO,WTLHURNO
          GOTO      WATLHI99 IF NOT EQUAL
          MATCH     WMCODE,WTLHCODE
          GOTO      WATLHI99 IF NOT EQUAL
          COMPARE   WMCNT,WTLHCONT
          GOTO      WATLHI99 IF NOT EQUAL
          MOVE      SP70,KEY12
          MATCH     SP70,WTLHREPR
          IF        !@EQUAL
            UNPACK    WTLHREPR,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          UNPACK    WTLHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      WTLHLNUM,KEY3
          MOVE      ZERO,F3
          PACK      KEY6,KEY3,F3
          CALL      RDLET1
.
          PACK      HISTKEYS,WTLHURNO,WTLHCODE,WTLHCONT,WTLHDATE,WTLHLNUM,SP70
          WRITE     HTMLFILE;"<tr><td>";
.
          MATCH     "1",WLETCOMM
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src=../images/spacer.gif ":
                               "border=0 align=absmiddle hspace=12>";
          ELSE
            WRITE     HTMLFILE;"<a ":
                       "href='javascript:UpdateLetter(#"",HISTKEYS,"#");'>":
                       "<img src=../images/DocumentIcon.gif ":
                       "border=0 align=absmiddle hspace=4></a>";
          ENDIF
.
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",WLTEXT,"&nbsp;</td>";
.
          MOVE      "WB",CATEGORY
          MOVE      WTLHRPLY,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;<br>",KEY12,"</td>";
.                                       * Display Name From Uid Code
          PACK      KEY10,WTLHUSER
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.                                       * End Of Name Display Code
          MOVE      "WC",CATEGORY
          MOVE      WTLHACTN,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
          MOVE      KEY52,DIM1
          MATCH     "I",DIM1
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDBKRX11                * Read booking extn file
            UNPACK    BKRXCNDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WBSENAM,"</td>";
.
          PACK      KEY10,USERID
          CALL      RDWBSE1
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDTREA1  

          MOVE      SP70,DOCFNAME
          MATCH     SP70,WMDOCTOR
          IF        !@EQUAL
            MOVE      WMDOCTOR,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      WMDOCTOR,DOCTCODE
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
.         WRITE     HTMLFILE;"<td>",WMDOCTOR,"&nbsp; </td></tr>";
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp; </td>";

          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td></tr>";
.
          GOTO      WATLHI10
.
WATLHI99  RETURN
.------------------------------------------------------------
. Display History Table
. History Summary
.------------------------------------------------------------
WATHIS00  PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70 
          CALL      RDTREA1
          MOVE      ZERO,FIRSTREC
          PACK      KEY31,WMURNO,WMCODE,WMCNT,SP70
.
          CALL      RSWTHIS1
WATHIS10  CALL      RKWTHIS1
          BRANCH    OVRCD,WATHIS99
          MATCH     WMURNO,WTHIURNO
          GOTO      WATHIS99 IF NOT EQUAL
          MATCH     WMCODE,WTHIPROC
          GOTO      WATHIS99 IF NOT EQUAL
          COMPARE   WMCNT,WTHIPCNT
          GOTO      WATHIS99 IF NOT EQUAL
. 
          COMPARE   ZERO,FIRSTREC
          GOTO      WATHIS15 IF EQUAL
.
.....     MATCH     ANSC,WTHIRTYP
.....     IF        @EQUAL
            MATCH     WTHIPRIO,SAVEPRIO
            IF        !@EQUAL
              MOVE      SP70,WTHIBSCD
            ENDIF
.....     ENDIF
          MATCH     WTHIDAT3,SAVEDAT3
          IF        !@EQUAL
            MATCH     "20",WTHIBSCD
            IF        @EQUAL
              MATCH     "6",WTHISTAT
              IF        !@EQUAL 
                MOVE      SP70,WTHIBSCD
              ENDIF
            ENDIF
          ENDIF
.
WATHIS15  COMPARE   ZERO,SHOWHIDD 
          IF        @EQUAL
            MATCH     "1",WTHIHIDE
            IF        @EQUAL
              MOVE      ONE,FIRSTREC
              GOTO      WATHIS10 
            ENDIF
          ENDIF
.
          UNPACK    WTHIEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.   
.                                          Effective Date
          IF        LINK2PRT = 1
           PACK      PHISTKEY,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP70
           WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:UpdateHist":
                              "(#"",PHISTKEY,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                                CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"&nbsp;</td>";
.
          ELSE
            WRITE     HTMLFILE;"<tr><td>":
               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
.
.                                             * Name From Userid Codes
          PACK      KEY10,WTHIWEBI,SP70     
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSENAM
          ENDIF
          WRITE     HTMLFILE;"<td>":
                    WBSENAM,"&nbsp;</td>";
.                                             * Name From Userid Codes Ends
.
          BRANCH    FIRSTREC,WATHIS20         *
          MOVE      ONE,FIRSTREC
          WRITE     HTMLFILE;"<td>Added</td>";
          GOTO      WATHIS30
.
WATHIS20  MOVE      "21",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MATCH     "1",WTHISTAT
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>Removed Booking</td>";
            ELSE
              WRITE     HTMLFILE;"<td>Status Changed</td>";
            ENDIF
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "22",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Unit Changed</td>";
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "06",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Rebooked</td>";
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "20",D2
.         MATCH     D2,WTWMBSCD
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MATCH     "5",WTHISTAT
            IF        @EQUAL
              MATCH     ANSD,WTHIRTYP
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>Undischarged";
              ELSE
                WRITE     HTMLFILE;"<td>Discharged";
                IF        WAHEAIND=1
                  CALL      WATHRT00          *Record type change, delete
                ENDIF
              ENDIF
              WRITE     HTMLFILE;"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>Removed</td>";
            ENDIF
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "01",D2
.         MATCH     D2,WTWMBSCD

          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MATCH     "3",WTHISTAT
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>Admitted";
              IF        WAHEAIND=1
                CALL      WATHRT00          *Record type change, delete
              ENDIF
              WRITE     HTMLFILE;"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>Booked";
              IF        WAHEAIND=1
                CALL      WATHRT00          *Record type change, delete
              ENDIF
              WRITE     HTMLFILE;"</td>";
            ENDIF
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "05",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MATCH     WTHIDAT3,SP30
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td>Sch Adm Date</td>";
              GOTO      WATHIS30
            ENDIF
            WRITE     HTMLFILE;"<td>Removed Booking</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "30",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Cancelled Booking</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "31",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Consultant Change</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "32",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Unremoved</td>";
            GOTO      WATHIS30
          ENDIF
.
          COMPARE   WTHIRANK,SAVHRANK
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Rank</td>";
            GOTO      WATHIS30
          ENDIF
          MATCH     WTHIDAT2,SAVEDAT2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Review Date</td>";
            GOTO      WATHIS30
          ENDIF
.
          MOVE      "33",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Admitted";
            IF        WAHEAIND=1
              CALL      WATHRT00          *Record type change, delete
            ENDIF
            WRITE     HTMLFILE;"</td>";
            GOTO      WATHIS30
          ENDIF 
.
          MOVE      "34",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Changed PPP</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     WTHIPRIO,SAVEPRIO
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Priority</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     WTHIDAT3,SAVEDAT3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Sch Adm Date</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "35",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Consent Changed</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "36",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Provisional Adm Date Changed</td>";
            GOTO      WATHIS30
          ENDIF
.
          MATCH     "37",WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Unadmitted</td>";
            GOTO      WATHIS30
          ENDIF
.
          WRITE     HTMLFILE;"<td>W/L&nbsp;Updated</td>";
.         
WATHIS30  MOVE      WTHIDAT2,SAVEDAT2
          MOVE      WTHIDAT3,SAVEDAT3
          MOVE      WTHIPRIO,SAVEPRIO
          MOVE      WTHIRANK,SAVHRANK
          
          MOVE      "TP",CATEGORY
          MOVE      WTHIPRIO,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",CODE,"&nbsp;</td>";    * Category
.          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
...                                               * Review Date
..        MATCH     SP70,WTHIDAT2
..        IF        @EQUAL
..          WRITE     HTMLFILE;"<td>&nbsp;</td>";
..        ELSE
..          UNPACK    WTHIDAT2,CCENT,CYEAR,CMON,CDAY
..          MOVE      CMON,F2
..          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
..          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
..        ENDIF
.
.                                                * Sch Admn Date
          MATCH     SP70,WTHIDAT3
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            UNPACK    WTHIDAT3,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
.                                             * Reason for Change
          MOVE      "20",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MOVE      "WR",CATEGORY
            MOVE      WMREMOVE,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
            GOTO      WATHIS40
          ENDIF
.
          MATCH     "30",WTHIBSCD
          IF        @EQUAL
            MOVE      "BE",CATEGORY
            MOVE      WTHIBOKC,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
            GOTO      WATHIS40
          ENDIF
.
          MOVE      "34",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MOVE      "WP",CATEGORY
            MOVE      WTHIPCHG,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
            GOTO      WATHIS40
          ENDIF
.
          MOVE      "05",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MOVE      "BC",CATEGORY
            MOVE      WTHIBCAN,CODE 
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
            GOTO      WATHIS40
          ENDIF
.           
          MOVE      "21",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MATCH     "1",WTHISTAT
            IF        @EQUAL
              MOVE      "WD",CATEGORY
              MOVE      WTHIRDT3,CODE 
              CALL      GETCOD00
              WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
              GOTO      WATHIS40
            ENDIF
          ENDIF
.
          MOVE      "34",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MOVE      "WP",CATEGORY
            MOVE      WTHIPCHG,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
            GOTO      WATHIS40
          ENDIF
.
          MOVE      "06",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            MOVE      "SC",CATEGORY
.
            COMPARE   ONE,WAHEAIND
            IF        @EQUAL
              MOVE      "WD",CATEGORY
            ENDIF          
          ELSE
            MOVE      "WD",CATEGORY
          ENDIF
          MOVE      WTHIRDT3,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
          GOTO      WATHIS40
.
WATHIS39  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.                                               * Alteration Date
WATHIS40  MATCH     SP70,WTHIADTE 
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            UNPACK    WTHIADTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
          MATCH     SP70,WTHIUNIT                * Unit
          IF        @EQUAL
            MOVE      WMUNIT,CODE
          ELSE
            MOVE      WTHIUNIT,CODE
          ENDIF
         
          MOVE      "WU",CATEGORY
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
.                                                * Booked Date
          MOVE      "34",D2
          MATCH     D2,WTHIBSCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Old PPP ",WTHIOLDP,"<br>&nbsp":
                               WTHIBOOK,"</td>";
            GOTO      WATHIS43
          ENDIF
.
          IF        WAHEAIND=ONE
.
            MATCH     SP70,BKREADAT
            IF        @EQUAL | @EOS
              GOTO      WATHIS42
            ELSE
              UNPACK    BKREADAT,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "<br>&nbsp;",WTHIBOOK,"</td>";
            ENDIF
.
          ELSE

WATHIS42    MATCH     SP70,WTHIDBFT 
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;","<br>&nbsp;",WTHIBOOK,"</td>";
            ELSE
              UNPACK    WTHIDBFT,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "<br>&nbsp;",WTHIBOOK,"</td>";
            ENDIF
.
          ENDIF
.
.
WATHIS43  MOVE      ZERO,EXIT
          IF        SHOCNSNT = 1
.                                               * Consent status
            MOVE      "No ",DIM3
            MATCH     "Y",WTHICSST
            IF        @EQUAL
              MOVE      "Yes",DIM3
            ENDIF
            MATCH     SP70,WTHICSDT 
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>",DIM3,"&nbsp;<br>&nbsp;</td>";
            ELSE
              UNPACK    WTHICSDT,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                   SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;"<td>",DIM3,"&nbsp;<br>":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
            ENDIF
          ENDIF
.
.                                               * Consultant
          MOVE      SP70,DOCFNAME
          MATCH     SP70,WTHIDOCT               * If history doctor is blank
          GOTO      WATHIS45 IF EQUAL           * use the waiting list doctor
.
          MOVE      WTHIDOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      WTHIDOCT,DOCTCODE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
          GOTO      WATHIS50
.
WATHIS45  MATCH     SP70,WMDOCTOR
          IF        !@EQUAL
            MOVE      WMDOCTOR,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      WMDOCTOR,DOCTCODE
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
.         WRITE     HTMLFILE;"<td>",WMDOCTOR,"&nbsp; </td></tr>";
WATHIS50  WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp; </td>";
          COMPARE   ZERO,SHOWHIDD
          IF        @EQUAL
            WRITE     HTMLFILE;"</tr>";
            GOTO      WATHIS10
          ENDIF
.
          MATCH     "1",WTHIHIDE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",ANSH,"</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td></tr>";
          ENDIF
.
          GOTO      WATHIS10
.
WATHIS99  RETURN
.
.------------------------------------------------------------
. Disply record type - Update, Delete
.------------------------------------------------------------
WATHRT00  MATCH     ANSC,WTHIRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;" (Change)";
          ENDIF
.
          MATCH     ANSD,WTHIRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;" (Delete)";
          ENDIF
.
WATHRT99  RETURN
.------------------------------------------------------------
. Output Table of Waiting List Details
.------------------------------------------------------------
WATSUM00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          IF        ALLWFLAG=1
            PACK      STATCODE,ONE,SP70
          ENDIF
          CALL      IBACLOCK
          PACK      KEY27,URNUMBER,Z70
          CALL      RDSTREA4
WATSUM10  CALL      RDPTREA4
          BRANCH    OVRCD,WATSUM90
          MATCH     URNUMBER,WMURNO
          GOTO      WATSUM90 IF NOT EQUAL
.
          MATCH     SP70,STATCODE             * Check Status Filter
          IF        !@EQUAL
            MOVE      STATCODE,F1
            COMPARE   F1,WMSTAT
            GOTO      WATSUM10 IF NOT EQUAL   * Check status
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,WATSUM10
.
          MOVE      SP70,PTHSNAME
          MATCH     SP70,WTWMIHSP
          IF        !@EQUAL
            IF        IBCNMHOS=1
              IF        ALLWFLAG<>1
..              MATCH     WTWMIHSP,WBSEHOSP
..              GOTO      WATSUM10 IF NOT EQUAL
               ENDIF
            ENDIF
            PACK      KEY3,WTWMIHSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      SP70,PTHSNAME;
            ENDIF
          ENDIF
.
          MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      GETCOD00
          MOVE      TDESC,SRCRDESC
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC

          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
          MOVE      WTTXPLST,RFCSTAT
          MATCH     Z70,RFCSTAT
          IF        @EQUAL
            MOVE      SP70,RFCSTAT
          ENDIF

          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
          CALL      COVER000
.
          CALL      WATLNK00
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02,WAITST03,WAITST04:
                                    WAITST05,WAITST06,WAITST07,WAITST08:
                                    WAITST09
   
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD=0
..            IF        BKRESTAT=2
..              MOVE      "Cancelled Adm.",STATDESC
..           ENDIF
          ENDIF
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
          ASSIGN    ZERO,RFCDAYS
.
          CALL      LSTDAY00
          CALL      NRCDAY00
.
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS < 1
            ASSIGN    ZERO,RFCDAYS
          ENDIF
.
.         Load date from waiting list status     
.
          CALL      GETDSP00
          CALL      GTPC0000
.
          CALL      DRFCUR00
          IF        CATCHGFL=0
            MOVE      ZERO,URGDAYS
          ELSE
            MOVE      URRFCDAY,URGDAYS
          ENDIF
.
WATSUM80  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WMDATE1,"#",":
                             "#"",WMDATE2,"#",":
                             "#"",WMDATE3,"#",":
                             "#"",WMCODE,"#",";
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":
                             "#"",WTWMRANK,"#",":
                             "#"",WMSTAY,"#",":
                             "#"",WMDOCTOR,"#",":
                             "#"",DOCFNAME,"#",":        * I CAR 13038
                             "#"",SRCRDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",PRIODESC,"#",":
                             "#"",PRIOOVER,"#",":
                             "#"",OVERSTAT,"#",":
                             "#"",PRIOSTAT,"#",":
                             "#"",STATDESC,"#",":
                             "#"",LSTDAYS,"#",":
                             "#"",NRCDAYS,"#",":
                             "#"",URGDAYS,"#",":
                             "#"",WMPTY,"#",":
                             "#"",RFCSTAT,"#",":
                             "#"",RFCDAYS,"#",":
                             "#"",DSPDATE,"#",":
                             "#"",WMSTAT,"#",":
                             "#"",CATASSGN,"#",":
                             "#"",URRFCDAY,"#",":
                             "#"",WMBOOK,"#",":
                             "#"",WTWMECNT,"#",":
                             "#"",PTHSNAME,"#");"
          GOTO      WATSUM10
.
WATSUM90
.
WATSUM99  RETURN
.------------------------------------------------------------
. Load date from waiting list status     
.------------------------------------------------------------
GETDSP00  BRANCH    WMSTAT,GETDSP40,GETDSP50,GETDSP60,GETDSP60,GETDSP60:
                           GETDSP70
.
GETDSP40  MOVE      SP70,DSPDATE            * Unscheduled
.                                           * check to see if suspended*I-39528
          PACK      KEY21,WMURNO,WMCODE,WMCNT,Z70   * Display for RFC  *I-39528
          PACK      KEY19,WMURNO,WMCODE,WMCNT,Z70   * Display future   *I-39528
          CALL      RSWTSUS1                                           *I-39528
GETDSP45  CALL      RPWTSUS1                                           *I-39528
          BRANCH    OVRCD,GETDSP99                                     *I-39528
.                                                                      *I-39528
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70               *I-39528
          MATCH     KEY19,KEY21                                        *I-39528
          GOTO      GETDSP99 IF NOT EQUAL                              *I-39528
.                                                                      *I-39528
          MATCH     SP70,WTSUTDAT                                      *I-39528
          GOTO      GETDSP99 IF EQUAL                                  *I-39528
.                                                                      *I-39528
.                   * Don't display date if Suspend to date is         *I-39528
.                   * less than today's date or                        *I-39528
.                   * if todays date is less than Suspend from date.   *I-39528
.                                                                      *I-39528
          CALL      IBACLOCK                                           *I-39528
          PACK      TODAYDTE,CCC,CYY,CMM,CDD                           *I-39528
          REP       " 0",TODAYDTE                                      *I-39528
          MATCH     TODAYDTE,WTSUTDAT                                  *I-39528
          GOTO      GETDSP99 IF LESS                                   *I-39528
.                                                                      *I-39528
          MATCH     WTSUFDAT,TODAYDTE                                  *I-39528
          GOTO      GETDSP99 IF LESS                                   *I-39528
.                                                                      *I-39528
          MOVE      WTSUTDAT,DSPDATE                                   *I-39528
          GOTO      GETDSP99                                           *I-39528
.
GETDSP50  MOVE      WMDATE3,DSPDATE         * Scheduled
          GOTO      GETDSP99
.
GETDSP60  MOVE      SP70,DSPDATE
          MOVE      WMBOOK,KEY8             * Pre Admitted/Admitted/Discharged
          CALL      RDMISS1
          BRANCH    OVRCD,GETDSP99
          MOVE      ADATE,DSPDATE
          GOTO      GETDSP99
.
GETDSP70  MOVE      WMDATE4,DSPDATE        * Removed    
          GOTO      GETDSP99

GETDSP99  RETURN
.----------------------------------------------------------------------
. Get Link to Waiting List Case
.----------------------------------------------------------------------
WATLNK00  PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          REP       " +",KEY19
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    KEY19,HTMLLINK
.
          IF        ALLWFLAG=1
            APPEND    "&allowahs=1",HTMLLINK
          ENDIF
.
          APPEND    SP70,HTMLLINK
          RESET     HTMLLINK
          RETURN
.------------------------------------------------------------------------
.-      Added by HPS ODC                                                -
.-      Comments Indicator  Outputs 1 if Comments is Present Else 0     -
.-      Files Read - watmesaf                                           - 
.------------------------------------------------------------------------
WATCMN00  PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WATCMN10  CALL      RDKMESA1
          BRANCH    OVRCD,WATCMN99
          MATCH     WMURNO,WAURNO
          GOTO      WATCMN99 IF NOT EQUAL
          MATCH     WMCODE,WAPROC
          GOTO      WATCMN99 IF NOT EQUAL
          COMPARE   WMCNT,WACNT
          GOTO      WATCMN99 IF NOT EQUAL
          MATCH     SP70,WATEXT
          IF        @EQUAL
            WRITE     HTMLFILE;ZERO;
          ELSE
            WRITE     HTMLFILE;ONE;
            GOTO      WATCMN99
          ENDIF
.
          GOTO      WATCMN10
.
WATCMN99  RETURN
.--------------------------------------------------------------------
.- Hps ODC
.- Not Ready For Care To Date
.- Files Read -watsusaf
.--------------------------------------------------------------------
WTNRFC00  PACK      D8,CCC,CYY,CMM,CDD
          REP       " 0",D8
          MOVE      D8,DATE3
          MOVE      SP70,KEY8
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
WTNRFC10  CALL      RKWTSUS1
          BRANCH    OVRCD,WTNRFC99
          MATCH     WMURNO,WTSUURNO
          GOTO      WTNRFC90 IF NOT EQUAL
          MATCH     WMCODE,WTSUCODE
          GOTO      WTNRFC90 IF NOT EQUAL
          COMPARE   WMCNT,WTSUCNT
          GOTO      WTNRFC90 IF NOT EQUAL
.
          MOVE      WTSUFDAT,DATE1
          MOVE      WTSUTDAT,DATE2
          IF        (DATE1<DATE3&DATE3<DATE2)|(DATE3=DATE1|DATE3=DATE2)        
             MOVE     DATE2,KEY8
          ELSE
             MOVE     SP70,KEY8
          ENDIF
.         
          GOTO      WTNRFC10  
. 
WTNRFC90  MATCH     SP70,KEY8
          IF        !@EQUAL
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                      NOV,DEC 
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;SP1;
          ENDIF
.
WTNRFC99  RETURN  
.------------------------------------------------------------
. Display Preadmission Comments
.------------------------------------------------------------
WTPCOM00  PACK      KEY21,WMURNO,WMCODE,SP70
          CALL      RSWTPAC1
WTPCOM10  CALL      RKWTPAC1
          BRANCH    OVRCD,WTPCOM99
          MATCH     WMURNO,WTPCURNO
          GOTO      WTPCOM99 IF NOT EQUAL
          MATCH     WMCODE,WTPCPCOD
          GOTO      WTPCOM99 IF NOT EQUAL
          MOVE      WMCNT,D2
          MATCH     D2,WTPCPCNT
.         COMPARE   WMCNT,WTPCPCNT
          GOTO      WTPCOM10 IF NOT EQUAL
          STRIP     WTPCCOMM
          MOVELPTR  WTPCCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WTPCCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WTPCOM10
.
WTPCOM99  RETURN
.------------------------------------------------------------------
. Audit Date
.------------------------------------------------------------------
WATAUD00  PACK      KEY30,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTLHI1
WATAUD10  CALL      RPWTLHI1
          BRANCH    OVRCD,WATAUD99
          MATCH     WMURNO,WTLHURNO
          GOTO      WATAUD99 IF NOT EQUAL
          MATCH     WMCODE,WTLHCODE
          GOTO      WATAUD99 IF NOT EQUAL
          COMPARE   WMCNT,WTLHCONT
          GOTO      WATAUD99 IF NOT EQUAL
.
          PACK      KEY6,WTLHLNUM,SP1,SP1,ZERO
          CALL      RDLET1
          BRANCH    OVRCD,WATAUD10
.
          MATCH     ANSA,WLETAUDL
          GOTO      WATAUD10 IF NOT EQUAL
          MATCH     SP70,WTLHDATE 
          GOTO      WATAUD10 IF EQUAL
          MATCH     SP70,WTLHREPR 
          GOTO      WATAUD99 IF NOT EQUAL
.
          UNPACK    WTLHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                    OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR             
          WRITE     HTMLFILE;KEY11;
.
WATAUD99  RETURN
.----------------------------------------------------------------------
. Last Audit Date
.----------------------------------------------------------------------
WTLAUD00  PACK      KEY30,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTLHI1
WTLAUD10  CALL      RPWTLHI1
          BRANCH    OVRCD,WTLAUD99
          MATCH     WMURNO,WTLHURNO
          GOTO      WTLAUD99 IF NOT EQUAL
          MATCH     WMCODE,WTLHCODE
          GOTO      WTLAUD99 IF NOT EQUAL
          COMPARE   WMCNT,WTLHCONT
          GOTO      WTLAUD99 IF NOT EQUAL
.
          PACK      KEY6,WTLHLNUM,SP1,SP1,ZERO
          CALL      RDLET1
          BRANCH    OVRCD,WTLAUD10
.
          MATCH     ANSA,WLETAUDL
          GOTO      WTLAUD10 IF NOT EQUAL
          MATCH     SP70,WTLHREPR
          GOTO      WTLAUD10 IF EQUAL
.
          UNPACK    WTLHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                               OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
.
WTLAUD99  RETURN
.
.----------------------------------------------------------------------
. Get OverDue Date 
.  - Codes File should have been read for Cat TP
.  - Waiting List Record WATTR1AF should have been Read
.----------------------------------------------------------------------
OVRDT000  MOVE      SP70,PRIOOVER
          MOVE      ZERO,NRCDAYS
..        CALL      URGDAY00
..        CALL      LSTDAY00
          CALL      DRFCUR00
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          UNPACK    CLURCTDT,CCENT,CYEAR,CMON,CDAY  * set up parameters
          MOVE      CCENT,CC
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
.
          CALL      DMYCON                   * convert to Julian date
.
. HPS Code Starts Here
.         ADD       TCFORM6,JULDAY
          READ      CONTROLF,THIRTY7;*173,WTCNURDY,*177,WTCNSUDY:
                                     *181,WTCNRODY
          MATCH     "U",TCINDC1
          IF        @EQUAL
            ADD       WTCNURDY,JULDAY
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            ADD       WTCNSUDY,JULDAY
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            ADD       WTCNRODY,JULDAY
          ENDIF
. HPS Code Ends Here
.
..        CALL      NRCDF000
..        IF        EXIT<>1
            ADD       LSNRFCRE,JULDAY
...         ADD       NRCDAYS,JULDAY
.
            MOVE      JULDAY,JWKDAY            * set up parameters
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON                   * convert to DDMMYYCC
.
            PACK      PRIOOVER,CC,YY,MM,DD
            REP       " 0",PRIOOVER
..        ENDIF
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      "0",OVERSTAT
          MATCH     KEY8,PRIOOVER
          IF        @LESS
            MOVE      "1",OVERSTAT
          ENDIF
.
          MATCH     PRIOOVER,SP70
          GOTO      OVRDT999 IF EQUAL
          UNPACK    PRIOOVER,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
OVRDT999  RETURN
.------------------------------------------------------------
. Output Table of Waiting List Details
.------------------------------------------------------------
WATUSH00  PACK      KEY19,URNUMBER,Z70
          CALL      RDSTREA1
WATUSH10  CALL      RDPTREA1
          BRANCH    OVRCD,WATUSH99
          MATCH     URNUMBER,WMURNO
          GOTO      WATUSH99 IF NOT EQUAL
.
          COMPARE   SIX,WMSTAT
          GOTO      WATUSH10 IF EQUAL
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
.
          CALL      GETDSP00
          MOVE      SP70,KEY12
          MATCH     SP70,DSPDATE
          IF        !@EQUAL
            UNPACK    DSPDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02,WAITST03,WAITST04:
                                    WAITST05,WAITST06,WAITST07,WAITST08:
                                    WAITST09
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD=0
..            IF        BKRESTAT=2
..              MOVE      "Cancelled Adm.",STATDESC
..            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/DocumentIcon.gif ":
                             "class=ListIcon onclick='UpdateParent(#"":
                             CASEKEYS,"#",#"",WMDESC,"#");'>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",UNITDESC,"</td>":
                             "<td>",DSNAME,COMMA,ANS,"</td>":
                             "<td>",WMDESC,"</td>":
                             "<td>",KEY12,"</td>":
                             "<td>",STATDESC,"</td></tr>"
          GOTO      WATUSH10
WATUSH99  RETURN
.
+
.******************************************************************************
.*                                  DRFCUR00                                  *
.*                           Get Category TP Changes                          *
.******************************************************************************
DRFCUR00  READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      ZERO,URRFCDAY
          CALL      GTPC0000               * get days RFC following increase
.
          MOVE      CATASSGN,URRFCDAY
          IF        CATCHGFL=0
            MATCH     CLURCTDT,ENDDTE
            IF        @EQUAL
              DAYSEP    WMDATE1,ENDDTE,URRFCDAY
              MATCH     "1",WTCNERFC
              IF        @EQUAL
                MATCH     WMKEYDT,ENDDTE
                IF        !@LESS
                  DAYSEP    WMKEYDT,ENDDTE,URRFCDAY
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          IF        CATCHGFL=0
            MOVE      WMDATE1,CLURCTDT
            MATCH     "1",WTCNERFC
            IF        @EQUAL
              MOVE      WMKEYDT,CLURCTDT
            ENDIF
          ENDIF
          CALL      URNR0000      * calculate NRFC days
.
          ASSIGN    (URRFCDAY-LSNRFCRE),URRFCDAY
.
. *** for Victoria 1 July 2016 - add on previous days waiting at other hosp
          IF        PTCNHDPS<>3
            GOTO      DRFCUR99
          ENDIF
.
          READ      CONTROLF,HUND11;*11,WTCNERFC
          MATCH     "1",WTCNERFC
          GOTO      DRFCUR99 IF NOT EQUAL
.
          PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          BRANCH    OVRCD,DRFCUR85
.
. ** new record that has not been sent found **
          GOTO      DRFCUR90
.
DRFCUR85  PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,DRFCUR99
.
          MATCH     WTWMECNT,WTEEUNIQ
          GOTO      DRFCUR99 IF NOT EQUAL
.
DRFCUR90  MOVE      ZERO,FORM4
          SQUEEZE   WTEEPTWT
          MOVE      WTEEPTWT,FORM4
          ASSIGN    (URRFCDAY+FORM4),URRFCDAY
          ASSIGN    (LSTDAYS+FORM4),LSTDAYS
.
DRFCUR99  RETURN
+
.******************************************************************************
.*                                  GTPC0000                                  *
.*                    Get Days RFC following urgency increase                 *
.******************************************************************************
GTPC0000  MOVE      ZERO,RECCNT
          MOVE      ZERO,CATASSGN
          CALL      IBACLOCK
          MOVE      ZERO,CATCHGFL
          MOVE      SP1,SAVINDC3
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,ENDDTE
          PACK      CLURCTDT,ENDDTE
.
          IF        WMSTAT<4 | WMSTAT>6
            GOTO      GTPC0500
          ENDIF
.
          IF        WMSTAT=6
            MOVE      WMDATE4,ENDDTE
            MOVE      ENDDTE,CLURCTDT
            GOTO      GTPC0500
          ENDIF
.
          PACK      KEY8,WMBOOK
          CALL      RDMISS1
          BRANCH    OVRCD,GTPC0500
.
          PACK      ENDDTE,ADATE
          PACK      CLURCTDT,ENDDTE
.
GTPC0500  PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,SP20
          CALL      RSWTCAT2                * Position on & read code changes
GTPC1000  CALL      RKWTCAT2                  file record
          BRANCH    OVRCD,GTPC3000
.
          MATCH     WMURNO,WTCAURNO
          GOTO      GTPC3000 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTCAPROC
          GOTO      GTPC3000 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTCAPCNT
          GOTO      GTPC3000 IF NOT EQUAL   * Different procedure count
.
          MATCH     "TP",WTCACATF
          GOTO      GTPC3000 IF NOT EQUAL   * Different category
.
          MOVE      SP1,TCINDC3
          MATCH     SP3,WTCACODF
          IF        !@EQUAL
.....       PACK      KEY5,ANST,ANSP,WTCACODF
.....       CALL      RDCODE1               * Read a codes file record
          ENDIF
.
.         MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
.
          MOVE      SP1,TCINDC3
          MATCH     SP3,WTCACODT
          IF        !@EQUAL
            PACK      KEY5,ANST,ANSP,WTCACODT
            CALL      RDCODE1               * Read a codes file record
          ENDIF
.
GTPC2000  ADD       ONE,RECCNT
          IF        RECCNT=1
            MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
            GOTO      GTPC1000
          ENDIF
.
                    * for nsw - ignore a priority change to deferred - 0866897
          IF        PTCNHDPS=2
            MATCH     ANSD,TCINDC3
            GOTO      GTPC1000 IF EQUAL
          ENDIF
.
          MATCH     TCINDC3,SAVINDC3
          GOTO      GTPC1000 IF EQUAL
          IF        @LESS
            MOVE      TCINDC3,SAVINDC3      * Save priority decrease so we can
            GOTO      GTPC1000              * check for the next increase
          ENDIF
.
          MATCH     WTCAEDAT,WMDATE1
          IF        @EQUAL
            MOVE      SP8,WTCAEDAT
            GOTO      GTPC1000
          ENDIF
.
          MATCH     SP8,WTCAEDAT
          GOTO      GTPC1000 IF EQUAL
.
          MOVE      WTCAEDAT,CLURCTDT
          REP       " 0",CLURCTDT     * Clinical urgency cat last date
          MOVE      ONE,CATCHGFL
.
          MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
          GOTO      GTPC1000
.
GTPC3000  DAYSEP    CLURCTDT,ENDDTE,CATASSGN
.
GTPC9000  MOVE      ZERO,EXIT
GTPC9999  RETURN
+
.******************************************************************************
.*                                  URNR0000              Called by: GTRE0000 *
.*      Calculate the number of days NRFC since last urgency reassignment     *
.******************************************************************************
URNR0000  MOVE      ZERO,NRFCDAYS
.
          MATCH     CLURCTDT,SP70
          IF        @EQUAL
            MOVE      ZERO,LSNRFCRE
            GOTO      URNR9000
          ENDIF
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
URNR1000  CALL      RKWTSUS1
          BRANCH    OVRCD,URNR3000
.
          MATCH     WMURNO,WTSUURNO
          GOTO      URNR3000 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTSUCODE
          GOTO      URNR3000 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      URNR3000 IF NOT EQUAL
.
          MATCH     WTSUFDAT,ENDDTE
          GOTO      URNR1000 IF LESS        * End date < suspension start
.
          MATCH     SP70,WTSUTDAT
          GOTO      URNR1500 IF EQUAL
.
          MATCH     CLURCTDT,WTSUTDAT
          GOTO      URNR1000 IF LESS        * End date < suspension start
.
URNR1500  PACK      TCINDC1,SP2
          MATCH     SP3,WTSULSTS
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSL,WTSULSTS
            CALL      RDCODE1               * Read a codes file record
          ENDIF
.
          MATCH     "C",TCINDC1             * not ready for care
          GOTO      URNR2000 IF EQUAL
.
          MATCH     "D",TCINDC1
          GOTO      URNR2000 IF EQUAL
.
          MATCH     "S",TCINDC1
          GOTO      URNR1000 IF NOT EQUAL
.
URNR2000  MOVE      WTSUFDAT,CDYSFDTE
          MOVE      WTSUTDAT,CDYSTDTE
.
          MATCH     CLURCTDT,WTSUFDAT
          IF        @LESS
            MOVE      CLURCTDT,CDYSFDTE
          ENDIF
.
          MATCH     SP8,WTSUTDAT
          IF        @EQUAL
            MOVE      ENDDTE,CDYSTDTE
          ELSE
            MATCH     ENDDTE,WTSUTDAT
            IF        !@LESS
              MOVE      ENDDTE,CDYSTDTE
            ENDIF
          ENDIF
.
          CALL      CALCDAYS              * Calculate diff between dates
          SUB       ONE,CDYSDAYS
          ADD       CDYSDAYS,NRFCDAYS     * Incre the days not ready for care
.
.         MATCH     SP70,WTSUTDAT
.         IF        @EQUAL
.           ADD       ONE,NRFCDAYS        * still NRFC at end date, so add 1
.         ELSE
.           MATCH     TODAYDTE,WTSUTDAT
.           IF        !@LESS
.             ADD       ONE,NRFCDAYS      * still NRFC at end date, so add 1
.           ENDIF
.         ENDIF
.
          GOTO      URNR1000
.
URNR3000  MOVE      NRFCDAYS,LSNRFCRE
.
URNR9000  MOVE      ZERO,EXIT
URNR9999  RETURN
+
WRED0000  COMPARE   THREE,PTCNHDPS
          GOTO      WRED9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
          PACK      WTENEVAL,WTTXPLST
.....     PACK      WTENEVDT,TODAY    * now set before calling
          REP       " 0",WTENEVDT
          PACK      WTENWEBC,USERID,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          PACK      WTENSADI,SP70
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            CALL      UPWTESN1
          ENDIF
.
WRED9999  RETURN
+
.------------------------------------------------------------
. Add Extension Field
.------------------------------------------------------------
WTRB0000  BRANCH    FLDITMNO,WTRB0010,WTRB0020,WTRB0030,WTRB0040,WTRB0050:
                             WTRB0060,WTRB0070,WTRB0080,WTRB0090,WTRB0100:
                             WTRB0110,WTRB0120
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WTRB9999
.
WTRB0010  MOVE      ONE,ALLWFLAG
          CALL      WATSUM00
          GOTO      WTRB9999
.                            
WTRB0020  WRITE     HTMLFILE;WTWMACPR;
          GOTO      WTRB9999
.                            
WTRB0030  WRITE     HTMLFILE;WTWMPDSC;
          GOTO      WTRB9999
.
WTRB0040  MOVE      ZERO,LINK2PRT      * No link to parent
          MOVE      ZERO,SHOWHIDD      * don't show hidden records
          MOVE      ZERO,SHOCNSNT      * don't show Consent
          MOVE      ONE,WAHEAIND       * WAHealth indicator
          CALL      WATHIS00
          GOTO      WTRB9999
.
WTRB0050  CALL      KEYDAY00
          WRITE     HTMLFILE;LSTDAYS;
          GOTO      WTRB9999
.
WTRB0060  UNPACK    DIM127,D1,WLTYCODE,DIM127
          CALL      NRCDYT00
          COMPARE   ZERO,NRCDAYS
          IF        !@EQUAL
            WRITE     HTMLFILE;NRCDAYS;
          ELSE
            WRITE     HTMLFILE;ZERO;
          ENDIF
          GOTO      WTRB9999
.
WTRB0070  MOVE      SP70,THCSCOD
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            GOTO      WTRB0071
          ENDIF

          MATCH     SP3,BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSK,BKRETYPE
            CALL      RDCODE1               
          ENDIF
.
WTRB0071  WRITE     HTMLFILE;THCSCOD;
          GOTO      WTRB9999
.
WTRB0080  MOVE      CASEKEYS,KEY19
          PACK      KEY21,KEY19,Z70   
          CALL      RSWTSUS1
          CALL      RPWTSUS1
          BRANCH    OVRCD,WTRB9999
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      WTRB9999 IF NOT EQUAL
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,WTRB0081,WTRB0082,WTRB0083,WTRB0084
          GOTO      WTRB9999
.
WTRB0081  MOVE      SP70,CMON
          UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          MOVE      SP70,MTHNAM3
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRB99999
.
WTRB0082  MOVE      SP70,CMON
          UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          MOVE      SP70,MTHNAM3
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRB99999
.
WTRB0083  MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;
          GOTO      WTRB99999
.
WTRB0084  MOVE      "WN",CATEGORY
          MOVE      WTSUREAS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;
          GOTO      WTRB99999
.                            
WTRB0090  CALL      WTPACN00
          GOTO      WTRB9999
.
WTRB0100  MATCH     SP70,WTWMRADT
          GOTO      WTRB9999 IF EQUAL
          UNPACK    WTWMRADT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTRE9999
.
WTRB0110  MATCH     SP70,WMDESC2     
          GOTO      WTRB9999 IF EQUAL
          STRIP     WMDESC2
          MOVELPTR  WMDESC2,F3
          SFORMAT   VAR,F3
          MOVE      WMDESC2,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
          GOTO      WTRB9999
.
WTRB0120  MATCH     SP70,WMDESC3     
          GOTO      WTRB9999 IF EQUAL
          STRIP     WMDESC3
          MOVELPTR  WMDESC3,F3
          SFORMAT   VAR,F3
          MOVE      WMDESC3,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
          GOTO      WTRB9999
.
WTRB9999  RETURN
.
.------------------------------------------------------------
. Display Preadmission Notes
.------------------------------------------------------------
WTPACN00  PACK      KEY21,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RSWTPAC1
WTPACN10  CALL      RKWTPAC1
          BRANCH    OVRCD,WTPACN99
          MATCH     WMURNO,WTPCURNO
          GOTO      WTPACN99 IF NOT EQUAL
          MATCH     WMCODE,WTPCPCOD
          GOTO      WTPACN99 IF NOT EQUAL
          MATCH     DWMCNT,WTPCPCNT
          GOTO      WTPACN10 IF NOT EQUAL
          STRIP     WTPCCOMM
          MOVELPTR  WTPCCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WTPCCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WTPACN10
.
WTPACN99  RETURN
.
