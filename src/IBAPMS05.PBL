.******************************************************************************
.* System   :  Patient                                                        *
.* Program  :  IBAPMS05                                                       *
.* Desc     :  Auto Merge UR 2                                                *
.******************************************************************************
.* Date     :  27/09/89                                                       *
.* Author   :  S O'Gorman                                                     *
.* Modifications  :                                                           *
.******************************************************************************
.* V12.00.02 25/06/2025  J.Tan             TSK 0961696                        *
.*           Added Patient Debt type (PTDETYPE)=4 for Payment Plan admission  *
.* V12.00.01 23/05/2025  Bella Turco      TSK 0955096                         *
.*           Alphanumeric changes                                             *
.* V11.05.01 18/12/2024  Ebon Clements    TSK 0947161                         *
.*           Moved call to URNC0000 to be for each visit - FVIS2000           *
.* V11.04.01 27/03/2024  Ebon Clements    TSK 0944691                         *
.*           Treat alerts with a future end date as active - CHKALR00         *
.* V11.02.01 10/02/2022  Thanh T          TSK 0889899                         *
.*           Recompiled as WATTR1FD changes                                   *
.* V11.01.02 19/08/2021  Ebon Clements   TSK 0905444                          *
.*           Added hic claims file - hicclmaf - HICCLM00                      *
.* V11.01.01 30/03/2021  Tracey Nguyen   TSK 0904417                          *
.*           Recompiled for MEHPATFD - added MHPTFAMW Family/Whanau Involvement*
.******************************************************************************
.* V11.00.02 24/11/2020  Thanh T         TSK 0878747                          *
.*           Added patient attribute file. PATATRFD - PATATR00                *
.* V11.00.01 30/09/2020  Ebon Clements   TSK 0889499                          *
.*           Added outpatient booking items file. OUTBITFD - OUTBIT00         *
.******************************************************************************
.* V10.15.01 04/12/2019  Ebon Clements   TSK 0861123                          *
.*           Update theatre booking U/R when wait list updates the booking    *
.*           Called FIXDET00 from WTRE0000                                    *
.* V10.14.03 12/07/2019  Richa Phogat    TSK 0864951                          *
.*           Recompiled for WEBCHGUR                                          *
.* V10.14.02 10/07/2019  Richa Phogat    TSK 0864951                          *
.*           Recompiled for WEBCHGUR                                          *
.* V10.14.01 20/03/2019  J.Tan            TSK 0857392                         *
.*           Changed RCP Transaction count from DIM3 to DIM5                  *
.******************************************************************************
.* V10.13.02 19/09/2018  Ebon Clements    TSK 0860401                         *
.*           Added OTAR0000 appointment requests                              *
.* V10.13.01 14/08/2018  J.Tan          TSK 0848506                           *
.*           Recompiled for MRGURPRI -Changed PP Doc.from DIM6 to DIM10       *
.* V10.11.01 14/12/2017  Ania P           TSK 0849648                         *
.*           Recompiled for MRGURPRI                                          *
.* V10.11.03 27/11/2017  Thanh Tieu       TSK 0821710                         *
.*           Recompiled as PATMASTD changed                                   *
.* V10.11.02 21/09/2017  Thanh T.         TSK 0821710                         *
.*           Audit Amission/outpatient visit comments                         *
.* V10.11.01 15/09/2017  Thanh T.         TSK 0821710                         *
.*           Audit Amission/outpatient visit comments                         *
.******************************************************************************
.*        V10.08.06 18/08/2016  Ebon Clements    TSK 0260691                  *
.*                  Added A/H equipment loan merge - FIXLON and FLCM0000      *
.*        V10.08.05 08/08/2016  Davin            TSK 0321234                  *
.*                  Added Chronic Condition Alert (PMPXSN11/SAVESN11)         *
.*        V10.08.04 18/05/2016  Jill Parkinson   TSK 0817063                  *
.*           Mods to increase MHSCCOUN when moving mehscraf records to new UR *
.*        V10.08.03 29/04/2016  Jill Parkinson   TSK 0817063                  *
.*                  Added in mehscraf                                         *
.*        V10.08.02 18/04/2016  Peter Vela       TSK 0294177                  *
.*                  Recompiled for MRGURPRI                                   *
.*        V10.08.01 01/04/2016  Steve Armstrong  TSK 0324703                  *
.*                  Recompiled for changes to PATURCFD.                       *
.*                  Code changes for altered index on PATURCFD                *
.******************************************************************************
.*        V10.07.01 05/11/2015  Steve Armstrong  CAR 303363                   *
.*                  Recompiled for changes to RESHEAFD                        *
.******************************************************************************
.*        V10.06.05 30/09/2015  Ania P           CAR 321333                   *
.*                  Recompiled for changes to WEBCHGUR                        *
.*        V10.06.04 29/07/2015  Don Nguyen       CAR 319786                   *
.*                  Fixed ALRT0000 & CHKALR00 to use the correct KEY16        *
.*        V10.06.03 06/07/2015  Peter Vela       CAR 316928                   *
.*                  Recompiled for MRGURWEB                                   *
.*        V10.06.02 15/05/2015  Jill Parkinson   CAR 299898                   *
.*                  Modified rcpdteaf loop to use index 5 not index 1         *
.*        V10.06.01 12/03/2015  Steve Armstrong  CAR 314108                   *
.*                  Removed reference to PATCGPFD (No Longer in use)          *
.******************************************************************************
.*        V10.05.03 25/11/2014  Don Nguyen       CAR 299898                   *
.*                  Modified PATM0000 to fix I*C errors;                      *
.*                  open patient alert files as needed                        *
.*        V10.05.02 14/10/2014  Peter Vela       CAR 301518                   *
.*                  Recompiled for MRGURWEB                                   *
.*        V10.05.01 03/09/2014  J.Tan            CAR 298984                   *
.*                  Recompiled for PATDETFD                                   *
.******************************************************************************
.*        V10.04.01 05/03/2014  J.Tan            CAR 295681                   *
.*                  Added SYSTEM to patdetaf file                             *
.******************************************************************************
.*        V10.03.08 27/08/2013  Ebon Clements    CAR 275205                   *
.*                  Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS*
.*        V10.03.07 09/07/2013 Sandra Barcham    CAR 288188                   *
.*                  Recompiled for changes to WEBCHGUR                        *
.*        V10.03.06 28/06/2013  Patrick Adair    CAR 286757                   *
.*                  Recompiled for changes to MRGURWEB (in WEBCHGUR)          *
.*        V10.03.05 02/11/2012  Saroeun Soeur    CAR 275430                   *
.*                  REcompiled for changed WEBCHGUR                           *
.*        V10.03.04 31/08/2012  J.Tan            CAR 270090                   *
.*                  Mods to call FLAGDEBT after updating invoice file         *
.*        V10.03.03 13/01/2012  Mike Laming      CAR 236586                   *
.*                  Remove table locks in FVIS0000 & ALLI0000. Added ALPCT000 *
.*                  Changed all Locks in DETT0000 EMRV0000 INPP0000 BOOK0000  *
.*        V10.03.02 02/12/2011  Jill Parkinson  CAR 249362                    *
.*                  Copied FIXALR from WEBCHGUR                               *
.*        V10.03.01 29/11/2011  Steve Armstrong  CAR 253264                   *
.*                  Added WPAC0000 routine for watpacaf.                      *
.******************************************************************************
.*        V10.02.04 26/07/2011 Steve Armstrong    CAR 240684                  *
.*                  Mods to cater for changes to LEGALTFD.                    *
.*        V10.02.03 25/06/2011 Steve Armstrong    CAR 240722                  *
.*                  Mods to cater for changes to PATLOCFD.                    *
.*                       - LSNAME & LGNAME extended to 40 chars.              *
.*                       - PTLCGNM2 added.                                    *
.*                  Mods to cater for changes to PMSCURFD:                    *
.*                       - PMCUSURN & PMCUGNAM extended to 40 chars.          *
.*                       - PMCUGNM2 added.                                    *
.*        V10.02.02 09/05/2011  Davin         CAR 239539                      *
.*                  Changed to allow 3 alert indicators to be saved (CHKALR00)*
.*        V10.02.01 21/04/2011  Mike Laming   CAR 233229                      *
.*                  Added patdetaf (Debt Registration) & Pat.Ind's in ODEBT000*
.******************************************************************************
.*        V10.01.01 03/02/2011 Jill Parkinson CAR 233088                      *
.*                  Added pmsvx1af                                            *
.******************************************************************************
.*        V10.00.04 23/08/2010  J.Tan           CAR 228752                    *
.*                  Recompiled for MRGURPRI - Private Practice Credit notes   * 
.*        V10.00.03 18/08/2010 J.Tan            CAR 222031                    *
.*                  Mods to set PMMIDUPD and PMMITUPD                         *
.*        V10.00.02 02/07/2010  Ebon Clements CAR 218982                      *
.*                  Added WATCHAFD                                            *
.*        V10.00.01 19/04/2010  J.Tan        CAR 219670                       *
.*                  Mods to set date/time updated to rcpdteaf file            *
.******************************************************************************
.*        V9.12.01  13/05/2009  Jill Habasque     CAR 189842                  *
.*                  Mods to update patmx1af.ptmxsin5 if a record in legaltaf  *
.******************************************************************************
.*        V9.11.03  20/01/2009  Jill Habasque     CAR 184957                  *
.*                  Mods to update nzprdtaf and legacy visit tables           *
.*        V9.11.02  23/12/2008  Steve Armstrong   CAR 187648                  *
.*                  Mods to remove reference to PATDELFD (no longer used)     *
.*        V9.11.01  18/12/2008  Steve Armstrong   CAR 186081                  *
.*                  Mods to not close PATALRT1 until after CHKALR00 has been  *
.*                  executed.                                                 *
.******************************************************************************
.*        V9.10.04  14/08/2008  J.Tan         CAR 166690                      *
.*                  Mods to set date/time/userid record updated for mehdlsaf  *
.*                  mehhlsaf                                                  *
.*        V9.10.03  15/07/2008  Ebon Clements CAR 160213                      *
.*                  Recompiled for update fee estimate functionality changes  *
.*        V9.10.02  01/07/2008  Jill Habasque CAR 162660                      *
.*                  Added CHKALR00 for new alert indicator values             *
.*        V9.10.01  23/05/2008 J.Tan      CAR 169149                          *
.*                  Added Date and Time invoice created/updated               *
.*        V9.09.02  28/02/2008  Ebon Clements  CAR 162564                     *
.*                  Added related provider invoice files                      *
.*        V9.09.01  04/01/2008  J.Tan          CAR 135498                     *
.*                  Mods for NZ MHINC Extract                                 *
.*        V9.08.03  10/04/2007  Jill Habasque  CAR 137207                     *
.*                  Added update of mehdlsaf,mehhlsaf,mehmdtaf and mehmtxaf   *
.*        V9.08.02  04/04/2007  Jill Habasque  CAR 137207                     *
.*                  Added update of mehvi1af                                  *
.*        V9.08.01  25/01/2007  Peter Vela     CAR 127930                     *
.*                  Added MRMADTCR MRMATMCR before WRTMAS1                    *
.*        V9.07.03  19/09/2006  Ebon Clements     CAR 107243                  *
.*                  Added deleted alert functionality                         *
.*        V9.07.02  29/08/2006  Jill Habasque     CAR 117160                  *
.*                  Recompiled for MRGURRES                                   *
.*        V9.07.01  18/07/2006  Jill Habasque     CAR 112134                  *
.*                  Added patwc1af and patwmabf                               *
.*        V9.05.B02 20/02/2006  Ebon Clements     CAR 76341                   *
.*                  Added referral file audit                                 *
.*        V9.05.B01 21/12/2005  Steve Armstrong   CAR 89329                   *
.*                  Recompiled for changes to MRGURRES                        *
.******************************************************************************
.*        V9.04.01  18/03/2005  Ebon Clements     CAR 58443                   *
.*                  Added security alerts to set PTMXSIN1 to 2 if security    *
.*                  alerts exist  TCINDC4 = S                                 *
.*        V9.03.14  14/07/2004  Steve Armstrong   CAR 51769                   *
.*                  Removed reference to PATHCSUC.                            *
.*        V9.03.13  05/07/2004  Lina Vo  CAR 50811                            *
.*                  Recompiled for MRGURPRI                                   *
.*        V9.03.12  02/07/2004  CAR 51382   Jill Habasque                     *
.*                  Recompiled for MRGURRES                                   *
.*        V9.03.11  22/06/2004  Lina Vo  CAR 50811                            *
.*                  Removed use of RCPDEPFD & IO - now obselete.              *
.*        V9.03.10  13/04/2004  CAR 43614   Jill Habasque                     *
.*                  Fixed update of emrvisaf                                  *
.*        V9.03.09  16/02/2004  Peter Vela  CAR 38290                         *
.*                  Added variables that are used in MRGURRES                 *
.*        V9.03.08  23/01/2004  CAR 45774   Mike Laming                       *
.*                  Add KEY23 check between "eocref" and "eoclnk" in ELNK0000 *
.*        V9.03.07  12/12/2003  CAR 45774   Mike Laming                       *
.*                  Correct changing of "eoclnkaf" records - these MUST be    *
.*                  done as part of "eocrefaf" changes in EREF0000            *
.*        V9.03.06  04/12/2003  CAR 44198   Mike Laming                       *
.*                  Fix re-positioning on re-reads in EREF0000 & ELNK0000     *
.*        V9.03.05  03/12/2003  Davin  CAR 44095                              *
.*                  Removed reference to receipting trans file                *
.*        V9.03.04  03/11/2003  CAR 44198   Mike Laming                       *
.*                  Correct I*A & I*C on "eocrefaf" & "eoclnkaf" in EREF0000  *
.*        V9.03.03  21/10/2003 J.Tan   CAR 44172                              *
.*                  Mods for Misc.theatre item file                           *
.*        V9.03.02  24/07/2003  CAR 37193   Mike Laming                       *
.*                  Modify "eocrefaf" merge to retain link with "eoclnkaf" in *
.*                  EREF0000 (to fix I*Us)                                    *
.*        V9.03.01  15/07/2003  CAR 37193   Mike Laming                       *
.*                  Port V5.10 changes for PMS05 -                            *
.*                  Recompiled for MRGURWEB - mods at label OBSPCO30          *
.*        V9.02.04  24/01/2003  Tonii  CAR 37193                              *
.*                  Ported 5.10 changes :                                     *
.*                  Remove CLOSE for OUTUATA1 (only opened once) in OUTT1000  *
.*                  Change "outbb1af" to "outbokaf" as OUTBB1A1 is not used   *
.*        V9.02.03  27/02/2003  Jill Habasque SRF 34660                       *
.*                  Removed reference to watnbraf                             *
.*        V9.02.02  13/02/2003  Dean Cramer  CAR 22238                        *
.*                  Recompiled for RCPTRNFD                                   *
.*                  10/02/2003  Lina Vo SRF22709                              *
.*                  Opened outbokaf and outuataf in INIT0000 with "out" site. *
.*                  Opened outhisaf with site prefix.                         *
.*        V9.02.01  24/01/2003  Tonii  srf                                    *
.*                  Ported 5.10 changes: Added a new include to handle all    *
.*                  clinical result tables MRGURRES. All code related to      *
.*                  result merge are removed from here                        *
.*        V9.02.00  12/12/2002  Lina Vo                                       *
.*                  Added Extra merge routines for V9.                        *
.*        V5.10.02  06/11/2002  Tonii SRF 20251 / 34127                       *
.*                  Mods to have new URnumber saved to RELNLKY instead of     *
.*                  RELNPID in CRLT0000                                       *
.*                  25/09/2002  Tonii SRF 20251 (Rebound)                     *
.*                  Removed any references to resmasaf, changed to loop thru  *
.*                  resluraf in RESU0000 instead as resmasaf is never populated
.*                  19/09/2002  Tonii SRF 20251 (rebound)                     *
.*                  Recompiled for MRGURWEB, fixed I * U                      *
.*        V5.10.01  24/08/2002  Tonii SRF 20251                               *
.*                  Mods to make merge the files redaXXXX,redbXXXX,redcXXXX,  *
.*                  rehaXXXX,rehbXXXX and rehcXXXX and not resdeaaf & resheaaf*
.*                  17/09/2002  Tonii SRF 20251                               *
.*                  Recompiled for MRGURWEB, fixed I * U                      *
.******************************************************************************
.*        V5.09.02  24/05/2002  Mike Laming  SRF 15999                        *
.*                  Recompiled for OUTRF1IO.INC                               *
.*        V5.09.01  07/05/2002  Harvinder Kumar SRF 13719                     *
.*                  Major changes done for urnumber merging (refer transheet) *
.*        V5.09.B02 12/02/2001  Sandra Barcham                                *
.*                  Recompiled for CHANGEUR - MRGURCCS                        *
.******************************************************************************
.*        V5.08.03  01/11/2000  J.Tan                                         *
.*                  Added MRGURWEB                                            *
.*        V5.08.02  28/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.B07 20/04/2000  Jill Habasque                                 *
.*                  Commented out references to RUS files                     *
.*        V5.08.B06 03/03/2000  Steve Armstrong                               *
.*                  Fixed routine updating O/P cancellation file to use       *
.*                  KEY24 instead of KEY16.                                   *
.*        V5.08.B05 16/02/2000  J.Tan                                         *
.*                  Recompiled for MRGURNFM                                   *
.*        V5.08.B04 14/02/2000  Steve Armstrong                               *
.*                  Removed redundant code (OBOK0000 & OCAN0000)              *
.*        V5.08.B03 09/02/2000  Steve Armstrong                               *
.*                  Recompiled for MRGURCCI                                   *
.*        V5.08.B02 07/02/2000  Steve Armstrong                               *
.*                  Recompiled for MRGURCCS                                   *
.*        V5.08.B01 07/02/2000  J.Tan                                         *
.*                  Recompiled for CHANGEUR - Nursing home                    *
.******************************************************************************
.*        V5.07.01  14/09/1999  Jill Habasque SRF 645173                      *
.*                  Recompiled for MRGUREOC                                   *
.                   09/11/1998  Glenn Berry      5.07 changes
.******************************************************************************
.*        V5.05.02  23/02/1998  Steve Armstrong                               *
.*                  Included EMR in update                                    *
.*        V5.05.01  08/01/1998  Steve Armstrong    SRF 643927                 *
.*                  Fixed WERR0000 to set OVRCD to 1 otherwise program will   *
.*                  loop infinitely.                                          *
.******************************************************************************
.*        V5.04.06  14/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.*        V5.04.05  23/05/1997  Steve Armstrong      WHL Mods                 *
.*                  Recompile for file length change in cciutlaf              *
.*        V5.04.04  09/04/1997  Howellsy     HWK         
.*                  Trap for IO errors                 
.*        V5.04.03  02/01/1997  Howellsy          CMH                         *
.*                  Recompiled for MRGURCMH                                   *
.*        V5.04.02  20/12/1996  Howellsy          EOC & ACC                   *
.*                  Recompiled for OUTRF1FD                                   *
.*        V5.04.01  04/10/1996  Steve Armstrong   SRF 642082                  *
.*                  Removed redundant code for PRI, CON and RHB.              *
.*        V5.03.09  03/04/1996  Whirlpool        srf 614630                   *
.*                  actually read the srf next time junior you spastic        *
.*                  fixed I*U in MRGURCCI if the new UR already exists with   *
.*                  the same key - add the quantity and delet the old record  *
.*        V5.03.08  22/03/1996  Greg Horvat      SRF 614630                   *
.*                  - Recompiled CCIBTRFD & CCIBTRIO - Added 3rd index        *
.*                  - Recomplied CHANGEUR - Changed the ccibtraf update to use*
.*                    the 3rd index                                           *
.*        V5.03.07  04/01/96 J.Tan                                            *
.*                  Fixed Updating Radiology Bulk Billing Pending File        *
.*        V5.03.06  17/11/1995  Max White                                     *
.*                  Added MRGURLRG for Loans Register Files.                  *
.*        V5.03.05  11/10/1995  Steve Armstrong    SRF 611544                 *
.*                  Recompiled for changes to MRGURCCI (for ccierraf).        *
.*                  Added update ruserraf, outlhiaf, concgwaf, watcataf,      *
.*                  watlhiaf, watpnpaf & watsusaf.                            *
.*                  Fixed update of wattr1af to be same as CHANGEUR.  For     *
.*                  some unknown reason it was looking at CMERGEUR even though*
.*                  the parameter was never actually read in.                 *
.*                  Mods to update of outrf1af to be processed as U/R update  *
.*                  instead of as part of visit update.                       *
.*        V5.03.04  03/10/1995    Whirlpool     srf 611786                    *
.*                  Added code to merge the patcrgaf file                     *
.*        V5.03.03  16/08/1995    Steve O'Gorman                              *
.*                  Fix the TRAP for CCI files that Lofty Stuffed Up.         *
.*                  In MRGURCCI include CCIV0000 check for cci system at start* 
.*        V5.03.02  20/07/1995    Justin Coates                               *
.*                  in the VIST0000 routine, for each visit, call the CCIVIS00*
.*                  proc to see if to change for cciutlaf for a visit number  *
.*        V5.03.01  12/07/1995    Justin Coates                               *
.*                  if get a CMH visit, write details to text file cmhmerge   *
.*                  put system code into the MRGUR... includes for this and   *
.*                  changeur to use.                                          *
.*        V5.03.B2  05/06/1995  Steve Armstrong                               *
.*                  Mods to use PRI instead of PPP                            *
.*                  Also added RCP (rcpdepaf & arsgliaf)                      *
.*        V5.03.B1  03/05/1995  Gabrielle       SRF 136052                    *
.*                  Merge U/R numbers on rehab files                          *
.******************************************************************************
.* Mods     :  V5.01.02  17/11/89  Steve O'Gorman                             *
.*          :            Recopile for 1/2 Bee's change to PPP files           *
.*          :  V5.01.03  01/02/90  J.Tan                                      *
.*          :            Fixed Merging multiple patients for a U/R no.        *
.*          :  V5.01.04  21/03/90  Steve O'Gorman                             *
.*          :            Removed Tracking from the Merge SRF 104201           *
.*          :  V5.01.05  30/03/90  Steve O'Gorman                             *
.*          :            Remove Port Number from Temp File Name               *
.*          :  V5.01.06  15/05/90  Steve O'Gorman  SRF 1049803                *
.*          :            Recompilled for change to OUTCANFD                   *
.*          :  V5.01.07  11/07/90 Paul Duncan                                 *
.*          :            recompiled for OUTBOA & OUTBOB audits                *
.*          :  V5.01.08  25/07/90 Paul Duncan                                 *
.*          :            implemented second surname file                      *
.*          :  V5.01.09  16/08/90 Glen Hobby                                  *
.*          :            Added write to paturcaf if system paramter is set    *
.*          :  V5.01.121 19/12/90 D.Di.Paola    SRF 107397                    *
.*          :            Recompile for PATURAFD                               *
.*          :  V5.01.122 22/01/91 Peter Eddey                                 *
.*          :            Changed to use BOKRC1FD instead of BOKMASFD          *
.*          :  V5.01.123 02/05/91 Wayne from St Albans  (Dude)  SRF 108530    *
.*          :            Fix I*A on waiting list treatment file. Added read   *
.*          :            before update....                                    *
.*          :  V5.01.124 18/06/91 Wayne from St Albans  (Dude)  SRF 109011    *
.*          :            Fix data corruption to transfer file caused by merge *
.*          :            u/r using incorrect std001fd. Should use STD002FD    *
.*          :            and SETX0000 routine to set up common variables...   *
.*          :  V5.01.125 28/02/92 Steve O'Gorman                              *
.*          :            Added code to allow for the outpatient referral      *
.*          :            letter file. Used IBAKEYS                            *
.*          :  V5.01.126 13/04/92 J.Tan    SRF 113780                         *
.*          :            Mods to update the new U/R to RUS file               *
.*          :  V5.01.127 04/05/92 Graeme WIlliams           SRF 113780        *
.*          :            Corrected previous modification                      *
.*             V5.01.128 12/05/92 ROD                       SRF 114098        *
.*                       Allow for changed key on PPPJRNFD (KEY24-->KEY32)    *
.*        V5.01.129 12/06/92  Graeme Williams               SRF 114865        *
.*                  Changes for 9 character misc items                        *
.*        V5.01.130 19/01/1993  Graeme Williams             SRF 120098        *
.*                  Fixed I*C on PATAZ1FD if audit file does not exist        *
.*        V5.01.131 21/01/93 J.Tan    SRF 120068                              *
.*                  Recompiled for OUTIOBOA (lock and read record)            *
.*        V5.01.132 05/02/1993    Justin Coates  (District Nursing)           *
.*                  Check district nursing files for the patient              *
.*        V5.01.133 12/02/1993    Justin Coates  (DUDLEY 3.4)                 *
.*                  Check watsusaf and add new open commands                  *
.*        V5.01.134 04/03/1993    Justin Coates  (DUDLEY)                     *
.*                  update maternity files                                    *
.*        V5.01.135 05/04/1993  Graeme Williams                               *
.*                  Update U/R number in contracting files if needed          *
.*        V5.01.136 21/04/1993  Graeme Williams                               *
.*                  Update U/R number in contracting CONRUWFD file            *
.*        V5.01.137 17/05/1993  Robert Sumsion                                *
.*                  Converted vars and includes to mrt in standard form.      *
.*        V5.01.138 16/03/94  Whirlpool Quote 7671                            *
.*                  Recompiled for changes to rusutlaf                        *
.*        V5.01.139 15/08/1994  Rob Leonard                                   *
.*                  Fixed I*C on paturcaf                                     *
.*        V5.02.01  02/08/1995  Whirlpool                                     *
.*                  Fixed pack of key34 in RUTL before reposition.            *
.*                  added check of keys before delete in RUTL                 *
.*        V5.02.02  08/02/1995  Paul Howells    SRF134866                     *
.*                  Merge U/R numbers on CCIUTLFD, CCIBAUFD & CCIBTR          *
.******************************************************************************
.
          INC       STD002FD
          INC       AAEDE1FD/INC
          INC       ALLEDTFD/INC
          INC       ALLETXFD/INC
          INC       ALLCONFD/INC
          INC       ALLLONFD/INC
          INC       ALLREFFD/INC
          INC       ALLPCTFD/INC 
          INC       BOKRC1FD/INC
          INC       OPRDEAFD/INC
          INC       EMRVISFD/INC
          INC       HICCLMFD/INC  
          INC       MAMTESFD/INC
          INC       OUTBOAFD/INC
          INC       OUTARTFD/INC
          INC       OUTCANFD/INC
          INC       OUTRF1FD/INC
          INC       OUTSITFD/INC
          INC       OUTBITFD/INC
          INC       LEGALTFD/INC       * Alternate Legacy file
          INC       LEGBOAFD/INC
          INC       LEGDEAFD/INC
          INC       LEGDSCFD/INC
          INC       LEGINVFD/INC
          INC       LEGMISFD/INC
          INC       LEGTRNFD/INC
          INC       LEGVISFD/INC
          INC       PATAZ1FD/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       NZPRDTFD/INC
          INC       PATINVFD/INC
          INC       PATLOCFD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PATDETFD/INC
          INC       MEHVI1FD/INC
          INC       MEHMDTFD/INC
          INC       MEHHLSFD/INC
          INC       MEHDLSFD/INC
          INC       MEHMTXFD/INC
          INC       MEHSCRFD/INC
          INC       MEHPATFD/INC
          INC       MEHPRDFD/INC
          INC       MEHPCNFD/INC
          INC       MEHPCSFD/INC
          INC       MEHPLSFD/INC
          INC       MEHPCOFD/INC
          INC       MEHPOIFD/INC
          INC       PATMI1FD/INC
          INC       PMSVX1FD/INC
          INC       PATPA1FD/INC
          INC       PATPR1FD/INC
          INC       PATGSRFD/INC
          INC       PATTRNFD/INC
          INC       PATURAFD/INC
          INC       PATURCFD/INC             * U/R no. change audit file
          INC       PATVISFD/INC
          INC       RCPDTEFD/INC
          INC       MRTMASFD/INC
          INC       WATCATFD/INC
          INC       WATLHIFD/INC
          INC       WATMESFD/INC
          INC       WATPACFD/INC
          INC       WATPNPFD/INC
          INC       WATSUSFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       EOCLNKFD/INC            * EOC Link Table
          INC       EOCREFFD/INC            * EOC Referral File
          INC       OUTHISFD/INC            * Outpatient History File
          INC       OPRHISFD/INC            * Theatre History File
          INC       OUTUATFD/INC            * Outpatient Un-Attendance File
          INC       PATALRFD/INC            * Patient Alerts File
          INC       PMSUCHFD/INC            * Patient U/R Comments
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCSLFD/INC            * Patient Record Location
          INC       PATKWCFD/INC            * Kiwicard Details
          INC       PATVCHFD/INC            * Visit Count Change Audit
          INC       PATLUEFD/INC            * Last U/R Entered
          INC       PATIMMFD/INC            * Immunisation Details 
          INC       PATDNRFD/INC            * Donor Information
          INC       PATNADFD/INC            * Need Assessment Details
          INC       PMSMTIFD/INC            * Misc.theatre item file
          INC       PMSALNFD/INC            * Alert Notes file
          INC       PMSCURFD/INC            * Alert Notes file
          INC       PMSFEDFD/INC            * Fees Estimation Details
          INC       PMSFESFD/INC            * Fees Estimation Table
          INC       PMSPRBFD/INC            * Patient Problem Master Table
          INC       PATATRFD/INC            * Patient Attribute Details 
          INC       PATATRTD/INC             
          INC       WATCHAFD/INC            * Data integrity audit
          INC       WATHISFD/INC            * Waiting list history file
          INC       WATRTDFD/INC            * Referral & Transfer Dest.
          INC       RESCLNFD/INC
          INC       RESDEAFD/INC            * Clinical Results Details
          INC       RESLURFD/INC            * Link Results by U/R
          INC       RESHEAFD/INC            * Clinical Results Header Table
          INC       RESLNKFD/INC            * Clinical Results Linking Table
          INC       RESPHRFD/INC            * CR PIT Format Results Header
.
+
.**********************************************************************
.*                           CONSTANTS                                *
.**********************************************************************
SEC1      FORM      "00001"
.
TEMP1     FILE      ASCII, FIXED=17
.
TEMP3     FILE      ASCII, FIXED=107
.Name     Type      Length    Start
.-------  ----      ------    -----
.OLDURNO   DIM       8        1
.NEWURNO   DIM       8        9
.CHOSPNUM  FORM      2        17
XXFILE     DIM       8        19
XXDESC     DIM       80       27
.     End of Record           107
DIM4       DIM       4
DIM8       DIM       8
DIM16      DIM      16
DIM19A     DIM      19
.CHOSPNUM   FORM      2   * duplicate in PATCONFD
NCCURNO    DIM       8
OCCURNO    DIM       8
SEQ1       FORM      "-3"
LOGERR     FORM      "1"
.
FIVE9     FORM      "59"
.
TILDA21   INIT      "~~~~~~~~~~~~~~~~~~~~~"
.
.**********************************************************************
.*                       GLOBAL VARIABLES                             *
.**********************************************************************
.CHCS      FORM      1   * duplicate in PATCONFD
.CHCSDTE   DIM       8   * duplicate in PATCONFD
.CMEDSERV  FORM      1   * duplicate in PATCONFD
.CURCHG    FORM      1   * duplicate in PATCONFD   * Audit File Indicator
.
DIM4A     DIM       4
DIM5      DIM       5                                                  *I-90302
NEWEPNO   DIM       5                                                  *I-45774
.
FNAMER    DIM       8
FNAMEA    DIM       8
.
FORM5     FORM      5                                                  *I-90302
FORM8     FORM      8
.
KWCFIL    INIT      "patkwc"
.
FNAMEI    DIM       8
FORM3     FORM      3
.
HUNDRED9  FORM      "109"           * I CAR 38290
.
LEGCFLAG  FORM      1
LOKCOUNT  FORM      2
.
NEWCNT    FORM      2
NEWKEY19  DIM       19
NEWURNO   DIM       8
NOAAE     FORM      1                  * Accident & Emergency
NOMAM     FORM      1                  * Mamography
NOOUT     FORM      1                  * Outpatients
NOPHA     FORM      1                  * Pharmacy
NORCP     FORM      1                  * Receipting
NORUS     FORM      1                  * RUS
NOTRK     FORM      1                  * Tracking
NOWAT     FORM      1                  * Waiting Lists
.
OLDKEY13  DIM       13                                                 *I-45774
OLDKEY19  DIM       19
OLDKEY31  DIM       31                                                 *I-90303
OLDURNO   DIM       8
OTCNULET  FORM      1                  * Using Outpatient Referral Letters
.
NMBIRACT  DIM       1
OMBIRACT  DIM       1
MBIRACT   DIM       1
.
PRCNGLIN  FORM      1                 * Priv. Prac. G.L. Interface
.PTCNRGNS  FORM      1   *duplicate in PATCONFD
PTCNSNDX  FORM      1
.PTCNUURC  FORM      1   *duplicate in PATCONFD 
SAVESIN1  DIM       1
SAVESIN7  DIM       1
SAVESIN8  DIM       1
SAVESIN9  DIM       1
SAVESN11  DIM       1
SAVKEY10  DIM       10
SAVKEY11  DIM       11
SAVKEY16  DIM       16
SAVKEY21  DIM       21
SAVKEY23  DIM       23                                                 *I-45774
SAVKEY25  DIM       25
SAVKEY27  DIM       27
SAVKEY28  DIM       28
SAVKEY30  DIM       30
SAVKEY32  DIM       32
SAVKEY34  DIM       34
SAVKEY35  DIM       35
SAVKEY46  DIM       46
SAVPROC   DIM       9
SAVPRCNT  FORM      2
SAVQNTY   FORM      8
SAVWMCNT  FORM      2
SPTKWDAY  FORM      3
SPTKWVIS  FORM      3
SVSN12    DIM       1
SVSN13    DIM       1
SVSN14    DIM       1
SVSN15    DIM       1
.
CURRDATE  DIM       8
CURRYEAR  FORM      4
RESLNKFL  DIM       8         * File name var for reslnk CAR 38290
RESULTYR  FORM      4
RESFNAME  DIM       8
.
SAVKEY17  DIM       17
SAVKEY20  DIM       20
MAXNOTEN  FORM      6
COMTFLAG  FORM      1
.
USERID    INIT      "          "
WBSEUID   INIT      "          "
.
PREHEB    INIT      "rehb"
PREHEC    INIT      "rehc"
PREHED    INIT      "rehd"
PREDEB    INIT      "redb"
PREDEC    INIT      "redc"
.
.
.-----------------------------------------------------------------------
PRGID     INIT      "IBAPMS05"
PRGNAM    INIT      "Auto Merge U/R 2"
VERSION   INIT      "V12.00.02"
.-----------------------------------------------------------------------
+
.**********************************************************************
.*                           MAINLINE                                 *
.**********************************************************************
ML0000    CALL      INIT0000           * initialization
.
          CALL      OPEN0000           * Get to top of temp file
          BRANCH    OVRCD,ML9999
.
ML1000    CALL      READ0000           * Get next available record
          BRANCH    EXIT,ML9999
.
. -----  Fix all file which cannot be accessed via the visit number  -----
. -----  in the visit file                                           -----
.
          CALL      WAIT0000                * Waiting Lists Files
.         PROC      MRGURNSM                * Nursing Station Management
          MOVE      OLDURNO,OCCURNO
          MOVE      NEWURNO,NCCURNO
          PROC      MRGURPRI                * Change U/R for Private practice
          PROC      MRGURCCS                * Clinical Costing Interface
          PROC      MRGURCCI                * Clinical Costing Interface
          PROC      MRGURWEB                * WEB
.         PROC      RUSERR00                * RUS error record file
.
. -----   Tracking System Removed and is to be replaced by manual system  -----
.#######
.#######  CALL      TRCK0000           * Medical Records Tracking Files
.#######
          CALL      EOCA0000           * Episode of Care Files
          CALL      OPRH0000           * Theatre History File
          CALL      PATM0000           * InPatient Files
          CALL      MRGURRES           * Clinical Results
          CALL      MAMM0000           * Mammography Files
          CALL      RCPD0000           * Receipting details file
          CALL      OUTT0000           * Outpatient Files
          PROC      ORLET000           * O/P Referral Letter File
          CALL      WAUD0000           * Write a record to change UR number file
          PROC      FIXWC1             * Fix workers comp
          PROC      FIXWMA             * Fix TAC
          PROC      FIXAID             * Fix Alternate ID
          CALL      FIXALLEG              * Change U/R for legaltaf (Alt Legacy)
          CALL      FIXLGVIS              * Change U/R for legvisaf
.
. -----  Loop thru the visit file and fix all records which are  -----
. -----  visit number dependent                                  -----
.
          CALL      VIST0000           * Visit File
          CALL      ODEBT000           * Update outstanding debt indicators
          CALL      FIXLON             * Change U/R for alllonaf
          GOTO      ML1000
.
ML9999    SHUTDOWN  " "
+
.**********************************************************************
.*                           INIT0000                                 *
.**********************************************************************
INIT0000  CALL      DISPHEAD
          CALL      SETX0000                   * set up common variables...
.
. -----   Clear System Indicators   -----
.
          CLOCK     PORT,PORT
.
          MOVE      ZERO,NOAAE
          MOVE      ZERO,NOMAM
          MOVE      ZERO,NOOUT
          MOVE      ZERO,NOPHA
          MOVE      ZERO,NORCP
          MOVE      ZERO,NORUS
          MOVE      ZERO,NOTRK
          MOVE      ZERO,NOWAT
.
          CALL      IBACLOCK
          PACK      DIM4A,CCC,CYY
          REP       " 0",DIM4A
          MOVE      DIM4A,CURRYEAR
.
          CLEAR     FNAMER                  * SET UP A PORT DEPENDANT TEMP FILE
          APPEND    "mergeurs",FNAMER
          RESET     FNAMER
          REPLACE   " 0",FNAMER
.
          CLEAR     FNAMEA
          APPEND    "mergelog",FNAMEA
          RESET     FNAMEA
          REPLACE   " 0",FNAMEA
          OPEN      TEMP3,FNAMEA
          READ      TEMP3,SEQ1;OLDURNO,NEWURNO,CHOSPNUM,XXFILE,XXDESC
.
          DISPLAY   *P56:24,"Opening patma1af";
          OPEN      PATMA1A1,"patma1af"
          OPEN      PMSPX2A1,"pmspx2af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P64:24,"patgsrnf"
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
          DISPLAY   *P64:24,"patpraxf";
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"patpa1af";
          OPEN      PATPA1A1,"patpa1af"
.
          DISPLAY   *P64:24,"paturadf";
          OPEN      PATURAD1,"paturadf"
          OPEN      PATURAD2,"paturadf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"pmsmtiaf";
          OPEN      PMSMTIA1,"pmsmtiaf"
.
          MOVE      "out",OSTFILE
          PACK      CFNAME,OSTFILE,FILUATA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTUATA1,CFNAME
          
.
.         Open Receipting files if they exist
.
INIT2500  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"rcpdteaf"
          TRAP      OVERCOND IF IO
          OPEN      RCPDTEA5,"rcpdteaf"
          TRAPCLR   IO
          MOVE      OVRCD,NORCP
.
          BRANCH    NORCP,INIT3000
.
          CLOSE     RCPDTEA5
.
.         Open A + E files if they exist
.
INIT3000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"aaede1af"
          TRAP      OVERCOND IF IO
          OPEN      AAEDE1A1,"aaede1af"
          TRAPCLR   IO
          MOVE      OVRCD,NOAAE
          BRANCH    NOAAE OF INIT4000
          CLOSE     AAEDE1A1
.
.         Open Outpatient files if they exist
.
INIT4000  MOVE      ZERO,OVRCD
          MOVE      "out",OSTFILE
          PACK      CFNAME,OSTFILE,FILBOKA1
          DISPLAY   *P64:24,CFNAME
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA1,CFNAME
          TRAPCLR   IO
          MOVE      OVRCD,NOOUT
          BRANCH    NOOUT OF INIT5000
          CLOSE     OUTBOKA1
.
.         Open Waiting List files if they exist
.
INIT5000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"wattr1af"
          TRAP      OVERCOND IF IO
          OPEN      WATTR1A1,"wattr1af"
          TRAPCLR   IO
          MOVE      OVRCD,NOWAT
.
          BRANCH    NOWAT OF INIT6000
          CLOSE     WATTR1A1
.
.         Open medical records tracking if they exist
.
INIT6000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"mrtmasaf"
          TRAP      OVERCOND IF IO
          OPEN      MRTMASA1,"mrtmasaf"
          TRAPCLR   IO
          MOVE      OVRCD,NOTRK
          BRANCH    NOTRK OF INIT7500
          CLOSE     MRTMASA1
.
.         Open RUS if they exist
.
INIT7500  MOVE      ZERO,OVRCD
.          DISPLAY   *P64:24,"rusutlaf"
.          TRAP      OVERCOND IF IO
.          OPEN      RUSUTLL1,"rusutlaf"
.          TRAPCLR   IO
.          MOVE      OVRCD,NORUS
.          BRANCH    NORUS OF INIT8000
.          CLOSE     RUSUTLL1
.
.         Open mammography
.
INIT8000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"mamtestf"
          TRAP      OVERCOND IF IO
          OPEN      MAMTEST1,"mamtestf"
          TRAPCLR   IO
          MOVE      OVRCD,NOMAM
.
          BRANCH    NOMAM OF INIT8500
.
          CLOSE     MAMTEST1
.
INIT8500  
          DISPLAY   *P64:24,"ihapassf";
          CALL       OPPASS1
.
.
. ****************************************** Start of Deletion          D-90301
...       CLEAR     FNAMEI
...       APPEND    "patauz",FNAMEI
...       APPEND    PORT,FNAMEI
...       RESET     FNAMEI
...       REP       " 0",FNAMEI
....
...       DISPLAY   *P64:24,FNAMEI;
...       CALL      OPPTAUZ1
. ****************************************** End of Deletion            D-90301
.
INIT9100
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*132,IBCNUMCI
          READ      CONTROLF,TEN;*160,CMEDSERV
          READ      CONTROLF,TEN3;*244,CHCS
          READ      CONTROLF,TEN4;*249,CURCHG
          READ      CONTROLF,EIGHTY8;*116,CHCSDTE
          READ      CONTROLF,FIVE9;*225,PTCNUURC
          READ      CONTROLF,THIRTY1;*174,OTCNULET
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,TWENTY;*186,PTCNUCSL
          READ      CONTROLF,HUNDRED9;*204,PTCNRSYR        * I CAR 38290
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD
          READ      CONTROLF,TEN;*250,CAUDA1
.
.         Open U/R No. changes audit file if CURCHG (HOS93) is set     *I-90301
.
          COMPARE   ONE,CURCHG              * 0=No 1=Yes               *I-90301
          IF        @EQUAL
            CALL      OPPTAUZ1                                         *I-90301
          ENDIF                                                        *I-90301
.
          MATCH     "1",ALCNRAUD            
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
.
.         Open U/R No. changes audit file if the system parameter is set
.
          COMPARE   ZERO,PTCNUURC
          GOTO      INIT9999 IF EQUAL
.
          DISPLAY   *P64:24,"paturcaf";
          OPEN      PATURCA1,"paturcaf";
.
          DISPLAY   *P1:24,*EL;
.
INIT9999 RETURN
+
.**********************************************************************
.*                            WERR0000                                *
.*                  Write the Details of the IO error to log          *
.**********************************************************************
WERR0000  PACK      XXDESC,XXDESC,SP30,SP30,SP30
          WRITE     TEMP3,SEQ;OLDURNO,NEWURNO,CHOSPNUM,XXFILE,XXDESC
          MOVE      ONE,OVRCD             * srf 643927
.
WERR9999  RETURN 
.
.**********************************************************************
.*                            OPEN0000                                *
.*                  Open Temp Merge List Temp File                    *
.**********************************************************************
.
OPEN0000  MOVE      FALSE,OVRCD
          CLOSE     TEMP1                   * Position at Top of File
          TRAP      OVERCOND IF IO
          OPEN      TEMP1,FNAMER
          TRAPCLR   IO
OPEN9999  RETURN
+
.**********************************************************************
.*                            READ0000                                *
.*                 Read Next Temp Merge List Record                   *
.**********************************************************************
.
READ0000  READ      TEMP1,SEQ;OLDURNO,NEWURNO
          GOTO      READ9000 IF OVER
          MOVE      FALSE,EXIT
          GOTO      READ9999
READ9000  MOVE      TRUE,EXIT
READ9999  RETURN
+
.**********************************************************************
.*                            VIST0000                                *
.*                    Update Visit Files Details                      *
.**********************************************************************
.
VIST0000  MOVE      "patvisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
VIST0100  CALL      RDKVISA2
          BRANCH    OVRCD,VIST9999
.
          MATCH     OLDURNO,PVIURNO
          GOTO      VIST9999 IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,*P30:24,"Admission : ",*V2LON,PVIBILL;
.
.         Check the system for this visit
.
.         CALL      RUSS0000                * do RUS for all visits
          PROC      CCIVIS00                * do CCI for all visits
          BRANCH    PVITYPE,VIST1000,VIST2000,VIST3000:
                            VIST1000,VIST4000,VIST6000:
                            VIST0500,VIST0500,VIST7000
.
VIST0500  CALL      FVIS0000                * must fix visit to stop loop
          GOTO      VIST0000
.
.         A+E Visit
.
VIST1000  CALL      AAEE0000
          CALL      FVIS0000
          GOTO      VIST0000
.
.         Outpatient Visit - all outpatients were done earlier
.
VIST2000  OPEN      PATINVR3,"patinvrf"
          CALL      INVV0000
          CLOSE     PATINVR3
          CALL      FVIS0000
          GOTO      VIST0000
.
.         Inpatient Visit
.
VIST3000  CALL      INPP0000
          CALL      FVIS0000
          GOTO      VIST0000
.
.         Day Visit        
.
VIST4000  CALL      FVIS0000
          GOTO      VIST0000
.
.         Community Health Visit
.
VIST6000  PROC      MRGURCMH
          CALL      FVIS0000
          GOTO      VIST0000
.
.         Allied Health referral
.
VIST7000  CALL      FVIS0000
          MATCH     " 2",PVISYST            * A/Health Referrals
          GOTO      VIST0000 IF NOT EQUAL
.
          CALL      ALLI0000
          CALL      ALPCT000                                          *I-236586
          CALL      OTAR0000
.
          GOTO      VIST0000
VIST9999  RETURN
+
.**********************************************************************
.*                            FVIS0000                                *
.*                  Update UR Number in Visit File                    *
.**********************************************************************
.
FVIS0000  MOVE      "patvisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      ZERO,LOKCOUNT
FVIS1000
          MOVE      PVIBILL,KEY8
          CALL      RDPTVIS1                                          *C-236586
.
          BRANCH    OVRCD OF FVIS6000,FVIS5000
.
.         Write the new U/R number
.
FVIS2000  MOVE      NEWURNO,PVIURNO
          CALL      UPVISA1
.
          CALL      URNC0000           * U/R No. change file
.
          DISPLAY   *P30:24,*EL,"Visit : ",*V2LON,PVIBILL;
.
          GOTO      FVIS9999
.
.         Visit file locked
.
FVIS5000  DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** Visit ",PVIBILL," locked on Port ",PVILOCK:
                    *W,*P1:24,*EL;
.
          ADD       ONE,LOKCOUNT
.
          COMPARE   THIRTY,LOKCOUNT
          GOTO      FVIS2000 IF NOT LESS
.
          GOTO      FVIS1000
FVIS6000  PRINT     "Error : Visit ",PVIBILL," has disappeared. Contact IBA ":
                    "Immediately **";
FVIS9999  RETURN
+
.**********************************************************************
.*                            AAEE0000                                *
.*                     Update A&E Files Details                       *
.**********************************************************************
.
AAEE0000  BRANCH    NOAAE,AAEE9999
.
.       Do the actual work for fixing up the admission
.
          OPEN      PATINVR3,"patinvrf"
          CALL      INVV0000           * Invoice file
          CLOSE     PATINVR3
.
.       Fix up the A + E visit
.
          CALL      DETT0000          * A + E details
          CALL      EMRV0000          * EMR visit
.
          DISPLAY   *P30:24,*EL,"A + E : ",*V2LON,PVIBILL:
                    *HOFF," Completed";
AAEE9999  RETURN
+
.**********************************************************************
.*                            DETT0000                                *
.*                 Update A&E Details Files Details                   *
.**********************************************************************
.
DETT0000  DISPLAY   *P30:24,*EL,"A + E : ",*V2LON,PVIBILL;
          OPEN      AAEDE1A1,"aaede1af"
.
          MOVE      "aaede1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      ZERO,LOKCOUNT
DETT1000  MOVE      PVIBILL,KEY8
....      CALL      RLAEDEA1
          CALL      RDDETA1                                           *C-236586
          BRANCH    OVRCD OF DETT2000,DETT4000
DETT1500  MOVE      NEWURNO,ADAURNO
          CALL      UPDETA1
DETT2000  CLOSE     AAEDE1A1
          GOTO      DETT9999
DETT4000  DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** A + E ",PVIBILL," locked on Port ",ADALOCK,*W:
                    *P1:24,*EL;
.
          ADD       ONE,LOKCOUNT
          COMPARE   THIRTY,LOKCOUNT         * Update Anywat After 30 Secs.
          GOTO      DETT1500 IF NOT LESS
.
          GOTO      DETT1000
DETT9999  RETURN
+
.**********************************************************************
.*                            EMRV0000                                *
.*                 Update EMR Details Files Details                   *
.**********************************************************************
.
EMRV0000  DISPLAY   *P30:24,*EL,"EMR   : ",*V2LON,PVIBILL;
          TRAP      OVERCOND IF IO
          OPEN      EMRVISA1,"emrvisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,EMRV9999
.
          MOVE      "emrvisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      ZERO,LOKCOUNT
EMRV1000  MOVE      PVIBILL,KEY8
....      CALL      RLEMVIS1
          CALL      RDEMVIS1                                          *C-236586
          BRANCH    OVRCD,EMRV2000:         * record not on file
                          EMRV4000          * record locked
.
EMRV1500  MOVE      NEWURNO,EMVIURNO
          CALL      UPEMVIS1                * update record
          CALL      ULEMVIS1                * unlock reocrd
.
EMRV2000  CLOSE     EMRVISA1
          GOTO      EMRV9999
.
EMRV4000  DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** EMR   ",PVIBILL," visit locked.  ",*W:
                    *P1:24,*EL;
.
          ADD       ONE,LOKCOUNT
          COMPARE   THIRTY,LOKCOUNT         * Update Anyway After 30 Secs.
          GOTO      EMRV1500 IF NOT LESS
.
          GOTO      EMRV1000
EMRV9999  RETURN
+
.**********************************************************************
.*                            INPP0000                                *
.*                  Update Inpatient Files Details                    *
.**********************************************************************
.
INPP0000
.
.       Lock the admission record
.
          MOVE      ZERO,LOKCOUNT
.
INPP0500  MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
.
          MOVE      "patmi1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
....      CALL      RLPTMIS1
          CALL      RDPTMIS1                                          *C-236586
          BRANCH    OVRCD OF INPP9999,INPP3000
.
.       Do the actual work for fixing up the admission
.
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATDTRA1,"patdtraf"
          CALL      INVV0000          * Invoice file
          CLOSE     PATINVR3
          CLOSE     PATDTRA1
.
.       If we are using medical services, fix up their invoice file
.
          COMPARE   ONE,CMEDSERV
          GOTO      INPP1000 IF NOT EQUAL
.
          OPEN      PATINVR3,"medinvrf"
          OPEN      PATDTRA1,"meddtraf"
          CALL      INVV0000          * Medical Service Invoice file
          CLOSE     PATINVR3
          CLOSE     PATDTRA1
.
INPP1000  CALL      DSCH0000          * Discharge file
          CALL      TRNN0000          * Transfer file
          CALL      LOCT0000          * Location file
          PROC      FIXCRG            * Cancer registration file
          CALL      MISS0000          * Admission file
          CALL      MHVS0000          * Mental Health file
          PROC      FIXREL            * Related Provider Invoices
.
          DISPLAY   *P30:24,*EL,"Admission : ",*V2LON,AADMNO:
                    *HOFF," Completed",*W;
.
          GOTO      INPP9999
INPP3000
          DISPLAY   "*** Patient Admission ",*V2LON,AADMNO,*HOFF:
                    " Busy on Terminal ":
                    *V2LON,APORT,*HOFF," ***":
                    *BLINKON," Please Wait",*W:
                    *P1:24,*EL;
.
          ADD       ONE,LOKCOUNT
          COMPARE   THIRTY,LOKCOUNT
          GOTO      INPP1000 IF NOT LESS
.
          GOTO      INPP0500
INPP9999
          RETURN
+
.**********************************************************************
.*                            ALLI0000                                *
.*      Subroutine to change U/R number in the A/Health referral file *
.**********************************************************************
ALLI0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLREFA1,"allrefaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ALLI9999
.
          MOVE      PVIBILL,KEY8
          CALL      RDALREF1                                          *C-236586
          BRANCH    OVRCD,ALLI9000
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
.       Write the new U/R number to the referral
.
          CALL      ARMHI000             * Set MHINC indicator
          MOVE      NEWURNO,ALREURNO
          CALL      UPALREF1
          CALL      UUALREF1
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
ALLI9000  CLOSE     ALLREFA1
.
ALLI9999  RETURN
.
.**************************************************************************
.*                            ALPCT000                          *I-236586 *
.*      Subroutine to change U/R number in the A/Health Patient Care Team *
.**************************************************************************
ALPCT000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLPCTA1,"allpctaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ALPCT999
.
          MOVE      PVIBILL,KEY8
          CALL      RDALPCT1
          BRANCH    OVRCD,ALPCT900
.
.       Write the new U/R number to the case team
.
          MOVE      NEWURNO,ALPCURNO
          CALL      UPALPCT1
.
ALPCT900  CLOSE     ALLPCTA1
.
ALPCT999  RETURN
.
.******************************************************************************
.  Change U/R number in the outpatient Appointment Request Table
.******************************************************************************
OTAR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTARTA1,"outartaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OTAR9999
.
OTAR1000  PACK      KEY32,OLDURNO,PVIBILL,SP70
          CALL      RSOTART1
          CALL      RKOTART1
          BRANCH    OVRCD,OTAR9500
.
          MATCH     OTARURNO,OLDURNO
          GOTO      OTAR9500 IF NOT EQUAL
.
          MOVE      PVIBILL,D8
          MATCH     OTARREFN,D8
          GOTO      OTAR9500 IF NOT EQUAL
.
          MOVE      NEWURNO,OTARURNO
          CALL      UPOTART1
          GOTO      OTAR1000
.
OTAR9500  CLOSE     OUTARTA1
.
OTAR9999  RETURN
.
.******************************************************************************
.         MHINC - MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.**********************************************************************
.*                            INVV0000                                *
.*                       Update Invoice File                          *
.**********************************************************************
.
INVV0000  MOVE      PVIBILL,AADMNO
.
          MOVE      "patinvrf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          PACK      KEY16 WITH AADMNO,SP20
          CALL      RDSINV3
INVV1000  CALL      RDKINV3
          BRANCH    OVRCD OF INVV9999
.
          MATCH     AADMNO,PINVADM
          GOTO      INVV9999 IF NOT EQUAL
.
          DISPLAY   *P30:24,*EL,"Invoice : ",*V2LON,PINVNO;
.
.       Update the invoice record
.
          MOVE      NEWURNO,PINVUR
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      PASSCODE,PTINUUID         * web user id
          CALL      UPINV3
.
          PROC      FLAGDEBT
.
.       Fix up the Dtran records for this invoice if it is an inpatient invoice
.
          COMPARE   THREE,PINVSYS
          CALL      DTRN0000 IF EQUAL
.
          CALL      MTIR0000          * change U/R for misc.theatre item charges
.
          GOTO      INVV1000
INVV9999  RETURN
+
.**********************************************************************
.*                            DTRN0000                                *
.*                Update Debtors Transaction File                     *
.**********************************************************************
.
DTRN0000  PACK      KEY22 WITH PINVADM,SP20
          OPEN      PATDTRA1,"patdtraf"
.
          MOVE      "patdtraf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      RDSDTRN1
DTRN1000  CALL      RDKDTRN1
          BRANCH    OVRCD OF DTRN9999
.
          MATCH     TADMNO,AADMNO
          GOTO      DTRN9999 IF NOT EQUAL
.
          MATCH     "H",TTYPEDEB
          GOTO      DTRN1000 IF EQUAL
.
          MATCH     "I",TTYPEDEB
          GOTO      DTRN1000 IF EQUAL
.
          DISPLAY   *P30:24,*EL,"Transaction : ",*V2LON,TTRANSN1;
.
          MOVE      NEWURNO,TDCODE
          CALL      UPDTRN1
          GOTO      DTRN1000
DTRN9999  CALL      NTRN0000
          RETURN
+
.**********************************************************************
.*                            DTRN0000                                *
.*                Update NZ Private Debtors Transaction File          *
.**********************************************************************
.
NTRN0000  PACK      KEY22 WITH PINVADM,SP20
          OPEN      NZPRDTA1,"nzprdtaf"
.
          MOVE      "nzprdtaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      RSNZRDT1
NTRN1000  CALL      RKNZRDT1
          BRANCH    OVRCD OF NTRN9999
.
          MATCH     TADMNO,AADMNO
          GOTO      NTRN9999 IF NOT EQUAL
.
          MATCH     "H",TTYPEDEB
          GOTO      NTRN1000 IF EQUAL
.
          MATCH     "I",TTYPEDEB
          GOTO      NTRN1000 IF EQUAL
.
          DISPLAY   *P30:24,*EL,"Transaction : ",*V2LON,TTRANSN1;
.
          MOVE      NEWURNO,TDCODE
          CALL      UPNZRDT1
          GOTO      NTRN1000
.
NTRN9999  RETURN
+
.**********************************************************************
.*                            MTIR0000                                *
.*                Update Misc.theatre item   File                     *
.**********************************************************************
.
MTIR0000  PACK      KEY14 WITH PINVADM,SP20
.
          MOVE      "pmsmtiaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      RSPMMTI1
MTIR1000  CALL      RKPMMTI1
          BRANCH    OVRCD OF MTIR9999
.
          MOVE      PINVADM,KEY8
          MATCH     PMMIVISN,KEY8
          GOTO      MTIR9999 IF NOT EQUAL
.
          DISPLAY   *P30:24,*EL,"Transaction : ",*V2LON,PMMITRAN;
.
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          PACK      PMMIWUSR,PASSCODE,SP70
          MOVE      NEWURNO,PMMIURNO
          CALL      UPPMMTI1
          GOTO      MTIR1000
MTIR9999  RETURN
+
.**********************************************************************
.*                            DSCH0000                                *
.*                     Update Discharge File                          *
.**********************************************************************
.
DSCH0000  OPEN      PATDSCH1,"patdschf"
.
          MOVE      "patdschf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD OF DSCH9999
.
          DISPLAY   *P30:24,*EL,"Discharge : ",*V2LON,DADMNO;
          MOVE      NEWURNO,DURNO
          CALL      UPDSCH1
DSCH9999  CLOSE     PATDSCH1
          RETURN
+
.**********************************************************************
.*                            MHVS0000                                *
.*                     Update Mental Health Visit File                *
.**********************************************************************
.
MHVS0000  OPEN      MEHVI1A1,"mehvi1af"
.
          MOVE      "mehvi1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MHVS9999
.
          DISPLAY   *P30:24,*EL,"Mental Health: ",*V2LON,AADMNO;
          MOVE      NEWURNO,MHVIURNO
          CALL      UPMHVIS1
MHVS9999  RETURN
+
.**********************************************************************
.*                            FIXCRG                                  *
.*               Procedure to update the patcrgaf file                *
.**********************************************************************
.
          DEFPROC   FIXCRG    
.
          INC       PATCRGFD/INC
.
          TRAP      OVERCOND IF IO
          OPEN      PATCRGA1,"patcrgaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXCRG999
.
          MOVE      "patcrgaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FXCRG000  PACK      KEY8,AADMNO          
          CALL      RDPTCRG1
          BRANCH    OVRCD,FXCRG999
.
          MOVE      NEWURNO,PTCRURNO
          CALL      UPPTCRG1
          GOTO      FXCRG999
.
          INC       IBAOVRIO/INC
          INC       PATCRGIO/INC

FXCRG999  CLOSE     PATCRGA1
          ENDPROC
+
.**********************************************************************
.*                            TRNN0000                                *
.*                    Update Visit Files Details                      *
.**********************************************************************
.
TRNN0000  OPEN      PATTRAN2,"pattranf"
.
          MOVE      "pattranf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      PVIBILL,AADMNO
          PACK      KEY30 WITH AADMNO,SP20,SP20
          CALL      RDSTRAN2
TRNN1000  CALL      RDKTRAN2
          BRANCH    OVRCD OF TRNN9999
.
          MATCH     TADMN,AADMNO
          GOTO      TRNN9999 IF NOT EQUAL
.
          DISPLAY   *P30:24,*EL,"Transfer : ",*V2LON,TWARD,"/",TBED;
.
          MOVE      NEWURNO,TURNO
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      TRNN1000
TRNN9999  CLOSE     PATTRAN2
          RETURN
+
.**********************************************************************
.*                            LOCT0000                                *
.*                     Update Location Details                        *
.**********************************************************************
.
LOCT0000  OPEN      PATLOCA1,"patlocaf"
.
          MOVE      "patlocaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LOCT9999
.
          MOVE      PVIURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,LOCT9999
.
          MOVE      PVIBILL,AADMNO
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          BRANCH    OVRCD,LOCT9999
.
          DISPLAY   *P30:24,*EL,"Location : ",*V2LON,LADMNO;
.
          MOVE      NEWURNO,LURNO
          CALL      UPLOCA1
          CLOSE     PATLOCA1
LOCT9999  RETURN
+
.**********************************************************************
.*                            MISS0000                                *
.*                    Update Admission Details                        *
.**********************************************************************
.
MISS0000  MOVE      PVIBILL,KEY8
.
          MOVE      "patmi1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      RDMISS1
          COMPARE   ZERO,OVRCD
          GOTO      MISS1000 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Error Changing Addmission Number ",PVIBILL;
          GOTO      MISS9999
MISS1000  MOVE      NEWURNO,AURNO
          CALL      UPMISS1
.
MISS9999  RETURN
+
.**********************************************************************
.*                            OUTT0000                                *
.*                  Update Outpatient Files Details                   *
.**********************************************************************
.
OUTT0000  BRANCH    NOOUT OF OUTT9999
.
          CALL      HICCLM00                  * HIC claim
.
.       Loop over all sites to get all possible outpatient file names
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      SP6,KEY6
          CALL      RDSSITA1
.
OUTT1000  MOVE      "outsitaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      RDKSITA1
          BRANCH    OVRCD,OUTT2000
.
          MOVE      ZERO,OVRCD                * Initialise test flag
          TRAP      OVERCOND IF IO            * Trap IO errors
          PACK      CFNAME,OSTFILE,FILBOKA1
          OPEN      OUTBOKA1,CFNAME
          TRAPCLR   IO                        * Clear IO trap
          BRANCH    OVRCD,OUTT1000            * Ignore site if IO error.
.
          PACK      CFNAME,OSTFILE,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
.
.....     MOVE      "outbb1af",XXFILE                 D-90204
          MOVE      "outbokaf",XXFILE               * I-90204
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
.       Fix up the outpatient visit
.
          CALL      BOOK0000
.
          CLOSE     OUTBOKA1
          CLOSE     OUTBOKA3
.....     CLOSE     OUTUATA1            * Outpatient Un-Attendane file D-90204
.
.       Fix up any cancelled bookings
.
          PACK      CFNAME,OSTFILE,FILCANA1
          OPEN      OUTCANA1,CFNAME
.
          PACK      CFNAME,OSTFILE,FILCANA2
          OPEN      OUTCANA2,CFNAME
.
          MOVE      "outcanaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      CANN0000
.
          CLOSE     OUTCANA1
          CLOSE     OUTCANA2
.
.        Fix up any letter history records
.
          PROC      OLHIS000
.
.
.       Update Outpatient History File         
.
          CALL      OHIS0000
.
          GOTO      OUTT1000
.
.       Finished looking at all sites
.
OUTT2000  CLOSE     OUTSITA1
.
          DISPLAY   *P30:24,*EL,"Outpatient : ",*V2LON,OLDURNO:
                    *HOFF," Completed",*W;
OUTT9999  RETURN
+
.****************************************************************************
.*                             OLHIS000                                     *
.*                  Update O/P Letter History File                          *
.****************************************************************************
.
          DEFPROC   OLHIS000
.
          INC       OUTLHIFD/INC
.
SAVKEY27  DIM       27
.
          PACK      CFNAME,OSTFILE,FILLHIA1
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTLHIA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OLHIS999               * file not found
.
          MOVE      "outlhiaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          DISPLAY   *P30:24,*EL,"O/P Letter History for : ",*V2LON,OLDURNO;
.
          MOVE      OLDURNO,PVIURNO
OLHIS100  PACK      KEY27,PVIURNO,SP30
          CALL      RSOTLHI1                     * position in file
          CALL      RKOTLHI1                     * read next record
          BRANCH    OVRCD,OLHIS900               * eof - finished
.
          MATCH     PVIURNO,OTLHURNO             * same U/R number ?
          GOTO      OLHIS900 IF NOT EQUAL        * no - finished
.
          PACK      SAVKEY27,OTLHURNO,OTLHDATE,OTLHLNUM,OTLHOUTN
          PACK      KEY27,NEWURNO,OTLHDATE,OTLHLNUM,OTLHOUTN
          CALL      RAOTLHI1                     * record on file already ?
          BRANCH    OVRCD,OLHIS500               * no - update
.
          MOVE      SAVKEY27,KEY27               * yes - delete original record
          CALL      DEOTLHI1
          GOTO      OLHIS100
.
OLHIS500  MOVE      SAVKEY27,KEY27
          CALL      RDOTLHI1                     * reposition on record
          MOVE      NEWURNO,OTLHURNO             * update U/R number
          CALL      UPOTLHI1
          GOTO      OLHIS100                     * get next record
.
OLHIS900  CLOSE     OUTLHIA1
          GOTO      OLHIS999
.
          INC       IBAOVRIO/INC
          INC       OUTLHIIO/INC
.
OLHIS999  ENDPROC
+
.**********************************************************************
.*             OutPatient History Update                              * 
.**********************************************************************
OHIS0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          PACK      CFNAME,OSTFILE,FILHISA1
          OPEN      OUTHISA1,CFNAME    
          TRAPCLR   IO
          BRANCH    OVRCD,OHIS9999
.
          MOVE      CFNAME,XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY28 WITH PVIURNO,SP30
          CALL      RSOTHIS1
OHIS1000  CALL      RKOTHIS1
          BRANCH    OVRCD OF OHIS9000
.
          MATCH     PVIURNO,OTHIURNO
          GOTO      OHIS9000 IF NOT EQUAL
.
          MOVE      NEWURNO,OTHIURNO
          CALL      UPOTHIS1
          GOTO      OHIS1000
.
OHIS9000  CLOSE     OUTHISA1
.
OHIS9999  RETURN
+
.**********************************************************************
.*             OutPatient Un-Attendance Update                        * 
.**********************************************************************
OUAT0000  PACK      KEY19 WITH DOBAOUTN,SP30
          CALL      RSOPUAT1
OUAT1000  CALL      RKOPUAT1
          BRANCH    OVRCD OF OUAT9999
.
          MATCH     OLDURNO,OPUAURNO
          GOTO      OUAT9999 IF NOT EQUAL
.
          MOVE      NEWURNO,OPUAURNO
          CALL      UPOPUAT1
          GOTO      OUAT1000
.
OUAT9999  RETURN
+
.*********************************************************************
.        fix up the outpatient booking items file                    *
.*********************************************************************
OUTBIT00  MATCH     "1",IBCNUMCI
          GOTO      OUTBIT99 IF NOT EQUAL      * not using med claims
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          PACK      CFNAME,OSTFILE,FILBITA1
          OPEN      OUTBITA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OUTBIT99
.
.        Loop thru Outpatient Booking items File
.
          PACK      KEY10,DOBAOUTN,SP30
          CALL      RSOTBIT1
OUTBIT20  CALL      RKOTBIT1
          BRANCH    OVRCD,OUTBIT95
.
          MATCH     OTBIVISN,DOBAOUTN       * Correct Visit Number
          GOTO      OUTBIT95 IF NOT EQUAL
.
          MATCH     OTBIURNO,OLDURNO        * Correct Old U/R
          GOTO      OUTBIT95 IF NOT EQUAL
.
          MOVE      NEWURNO,OTBIURNO        * Set New U/R and Update
          CALL      UPOTBIT1
          GOTO      OUTBIT20
.
OUTBIT95  CLOSE     OUTBITA1
.
OUTBIT99  RETURN
+
.**********************************************************************
.*             Theatre History Update                                 * 
.**********************************************************************
OPRH0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPRHISA1,"oprhisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OPRH9999
.
          MOVE      "oprhisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY38 WITH PVIURNO,SP30
          CALL      RSOPHIS1
OPRH1000  CALL      RKOPHIS1
          BRANCH    OVRCD OF OPRH9000
.
          MATCH     PVIURNO,OPHIURNO
          GOTO      OPRH9000 IF NOT EQUAL
.
          MOVE      NEWURNO,OPHIURNO
          CALL      UPOPHIS1
          GOTO      OPRH1000
.
OPRH9000  CLOSE     OPRHISA1
.
OPRH9999  RETURN
+
.**********************************************************************
.*             Patient Alerts Update                                  * 
.**********************************************************************
PATM0000  
..          CALL      ALRT0000                * Patient Alerts   
..          CALL      CHKALR00                * Check master file alert
..          CALL      ALRN0000                * Alert Notes
          OPEN      PATALRT1,"patalrtf"
          OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
          PROC      FIXALR
          CALL      BOKC0000                * Booking files
          CALL      PCUR0000                * Current Patient file
          CALL      PATCOM00                * Patient U/R Comments
          CALL      PATATR00                * Patient Attribute
          CALL      RECL0000                * Patient Record Location
          CALL      DONR0000                * Patient Donor Information
          CALL      IDET0000                * Patient Immunisation Details
          CALL      KIWI0000                * Kiwicard Details
          CALL      LAUR0000                * Last U/R Entered
          CALL      MEDW0000                * Medical Warnings
          CALL      ADET0000                * Need Assessment Details
          CALL      FEST0000                * Fees Estimation Details
          CALL      PROB0000                * Patient Problem Master Table
          CALL      MHDL0000                * MH Legal status detail
          CALL      MHAD0000                * MH Legal status detail audit
          CALL      MHAH0000                * MH Legal status header audit
          CALL      MHHL0000                * MH Legal status header
          CALL      MHMD0000                * MH Notes
          CALL      MHMT0000                * MH Free text notes
          CALL      MHSC0000                * MH Supp Consumer Records
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS       * NZ only (PRIMHD)
          IF        PTCNHDPS = 1
            CALL      MHPRD000              * RD, AT, CN, CO, OI Tables
            CALL      MHPLS000              * LS Table
          ENDIF
.
PATM9999  RETURN
.**********************************************************************
.*             Patient Alerts Update                                  * 
.**********************************************************************
ALRT0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATALRT1,"patalrtf"
          TRAPCLR   IO
          BRANCH    OVRCD,ALRT9999
.
          MOVE      "patalrtf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY16 WITH PVIURNO,SP30
          CALL      RSPTALR1
ALRT1000  CALL      RKPTALR1
          BRANCH    OVRCD OF ALRT9000
.
          MATCH     PVIURNO,PTALURNO
          GOTO      ALRT9000 IF NOT EQUAL
.
.         Check if new key already exists
.
          PACK      KEY16,NEWURNO,PTALCATG,PTALCODE
          CALL      RDPTALR1
          BRANCH    OVRCD,ALRT2000
.
.         Delete current record
.
          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE
          CALL      DEPTALR1
.
.         Change U/R number for this record
.
ALRT2000  PACK      KEY16,PVIURNO,PTALCATG,PTALCODE
          CALL      RDPTALR1
          BRANCH    OVRCD,ALRT9000
.
          MOVE      NEWURNO,PTALURNO
          CALL      UPPTALR1
.
          GOTO      ALRT1000
.
ALRT9000  BRANCH    CAUDA1,ALRT9500         * Using alert audits
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATAUDA2,"pataudal"
          TRAPCLR   IO
          BRANCH    OVRCD,ALRT9500
.
ALRT9100  PACK      KEY27,OLDURNO,SP70
          CALL      ASPTALR2
          CALL      AKPTALR2
          BRANCH    OVRCD,ALRT9300
.
          MATCH     OLDURNO,PTALURNO 
          GOTO      ALRT9300 IF NOT EQUAL
.
          MOVE      NEWURNO,PTALURNO
          CALL      AUPTALR2
          GOTO      ALRT9100
.
ALRT9300  PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALRT9500
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21                * check for wahealth alerts
          BRANCH    OVRCD,ALRT9350
.
          MATCH     "1",PMPXSIN7
          GOTO      ALRT9500 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN8
          GOTO      ALRT9500 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN9
          GOTO      ALRT9500 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSN11
          GOTO      ALRT9500 IF EQUAL       * current alert exists
.
ALRT9350  MATCH     "0",PTMXSIN1              * Any current alerts
          IF        !@EQUAL
            MATCH     " ",PTMXSIN1            * Any current alerts
            GOTO      ALRT9500 IF NOT EQUAL
          ENDIF
.
          PACK      KEY27,NEWURNO,SP70
          CALL      ASPTALR2
ALRT9400  CALL      AKPTALR2
          BRANCH    OVRCD,ALRT9500
.
          MATCH     NEWURNO,PTALURNO
          GOTO      ALRT9500 IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR           * Delete
          GOTO      ALRT9400 IF NOT EQUAL
.
          MOVE      "3",PTMXSIN1            * Yes there are deleted alerts
.
          CALL      UPMAST1
.
ALRT9500  CLOSE     PATAUDA2
.
ALRT9999  RETURN
+
.**************************************************************************
.*                               CHKALR00              Called by: PROC0000*
.*                                                                        *
.**************************************************************************
CHKALR00  MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKALR99
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PTMXSIN1,SAVESIN1
          MOVE      PMPXSIN7,SAVESIN7
          MOVE      PMPXSIN8,SAVESIN8
          MOVE      PMPXSIN9,SAVESIN9
          MOVE      PMPXSN11,SAVESN11
          UNPACK    SP70,PTMXSIN1,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN11
.
          CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,NEWURNO,SP70
          CALL      RSPTALR1
CHKALR10  CALL      RKPTALR1
          BRANCH    OVRCD,CHKALR90
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CHKALR90 IF NOT EQUAL
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MATCH     PTALEDAT,CURRDATE           * future end date
            GOTO      CHKALR20 IF LESS
.
            GOTO      CHKALR10                     * show alert as inactive
          ENDIF
.
CHKALR20  PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKALR10
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN7               * wahealth medical alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN8               * wahealth micro alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN9               * wahealth risk alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSN11               * wahealth chronic alert
            GOTO      CHKALR10
          ENDIF
.
.         Standard alert functionality
.
          REP       "S2 1",TCINDC4
.
          MATCH     "2",TCINDC4        * check for security alert, if yes stop
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
            GOTO      CHKALR90
          ENDIF
.
          MATCH     PTMXSIN1,TCINDC4
          IF        @LESS
            PACK      PTMXSIN1,TCINDC4
          ENDIF
          MATCH     SP70,PTMXSIN1
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
          ENDIF
.
          GOTO      CHKALR10
.
CHKALR90  MATCH     PTMXSIN1,SAVESIN1
          IF        !@EQUAL
            CALL      UPMAST1
          ENDIF
.
          MATCH     PMPXSIN7,SAVESIN7
          IF        @EQUAL
            MATCH     PMPXSIN8,SAVESIN8
            IF        @EQUAL
              MATCH     PMPXSIN9,SAVESIN9
              IF        @EQUAL
                MATCH     PMPXSN11,SAVESN11
                IF        @EQUAL
                  GOTO      CHKALR99        * no wahealth indicators changed
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      UPPMPX21                * update for wahealth alerts (indc5)
.
CHKALR99  CLOSE     PATALRT1
          RETURN
+
.**********************************************************************
.*             Alert Notes file Changes                               *
.**********************************************************************
ALRN0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSALNA1,"pmsalnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ALRN9999
.
          MOVE      "pmsalnaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
ALRN1000  PACK      KEY16 WITH OLDURNO,SP20
          CALL      RSPMALN1
          CALL      RKPMALN1
          BRANCH    OVRCD OF ALRN8000
.
          MATCH     OLDURNO,PMANURNO
          GOTO      ALRN8000 IF NOT EQUAL
.
          PACK      KEY16,NEWURNO,PMANACAT,PMANACOD,PMANLNNO
          CALL      RAPMALN1                    * read into ans;
          BRANCH    OVRCD,ALRN3000              * new u/r not on file, go update
          CALL      DEPMALN1                    * delete new u/r no.
.
ALRN3000  PACK      KEY16,OLDURNO,PMANACAT,PMANACOD,PMANLNNO * read old record
          CALL      RDPMALN1                          * full read
          MOVE      NEWURNO,PMANURNO                  * move new u/r to old u/r
          CALL      UPPMALN1                          * update record
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALRN1000
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALRN1000
.
          PACK      KEY5,PMANACAT,PMANACOD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALRN6000
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN7               * wahealth medical alert
            GOTO      ALRN7000
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN8               * wahealth micro alert
            GOTO      ALRN7000
          ENDIF
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN9               * wahealth risk alert
            GOTO      ALRN7000
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSN11               * wahealth chronic alert
            GOTO      ALRN7000
          ENDIF
.
          MATCH     ANSS,TCINDC4
          IF        @EQUAL
            MOVE      TWO,PTMXSIN1
          ENDIF
.
ALRN6000  MATCH     "2",PTMXSIN1
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN1               * Set alert present flag
          ENDIF
          CALL      UPMAST1
          CALL      UUPTMAS1
          GOTO      ALRN1000
.
ALRN7000  CALL      UPPMPX21                * update for wahealth alerts (indc5)
          GOTO      ALRN1000
.
ALRN8000  BRANCH    CAUDA1,ALRT9000         * Using alert audits
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSAUDA2,"pmsaudan"
          TRAPCLR   IO
          BRANCH    OVRCD,ALRN9000
.         
ALRN8100  PACK      KEY27,OLDURNO,SP70
          CALL      ASPMALN2
          CALL      AKPMALN2
          BRANCH    OVRCD,ALRN9000
.         
          MATCH     OLDURNO,PMANURNO
          GOTO      ALRN9000 IF NOT EQUAL
.         
          MOVE      NEWURNO,PMANURNO
          CALL      AUPMALN2
          GOTO      ALRN8100
.
ALRN9000  CLOSE     PMSALNA1
          CLOSE     PMSAUDA2
ALRN9999  RETURN
+
.        ===================================
.        Procedure to fix up the Alert file
.        ===================================
.
          DEFPROC   FIXALR
.
          INC       PATALRFD/INC
          INC       PMSALNFD/INC
.
F3A       FORM      3
ALERT001  DIM       2
ALERT002  DIM       3
ALERT013  DIM       3
SAVKEY16  DIM       16
SAVKEY19  DIM       19
NEWKEY16  DIM       16
.
          OPEN      PATALRT1,"patalrtf"
          OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
RADALR    PACK      KEY16,OLDURNO,SP10
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,AUDALR
.
          MATCH     OLDURNO,PTALURNO
          GOTO      AUDALR IF NOT EQUAL
.
          PACK      SAVKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
.
          MOVE      PTALCNTR,ALERT013
.
          PACK      KEY16,NEWURNO,PTALCATG,PTALCODE,PTALCNTR
          CALL      RAPTALR1                    * read into ans;
          BRANCH    OVRCD,UPDALR                * new u/r not on file, go update
.
          MOVE      PTALCATG,ALERT001
          MOVE      PTALCODE,ALERT002
          CALL      CONA0000                      * Calculate contact counter
.
UPDALR    PACK      KEY16,SAVKEY16     * read old record
          CALL      RDPTALR1                          * full read
          BRANCH    OVRCD,RADALR
.
          MOVE      NEWURNO,PTALURNO                  * move new u/r to old u/r
          MOVE      ALERT013,PTALCNTR                 * move new u/r to old u/r
          PACK      NEWKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          CALL      UPPTALR1                          * update record
.
          CALL      FIXALN00
          GOTO      RADALR
.
AUDALR    CALL      CHKALR00                          * update alert indicator
          BRANCH    CAUDA1,ENDALR                     * Using Audits
.
RSDALR    PACK      KEY27,OLDURNO,SP70
          CALL      ASPTALR2
          CALL      AKPTALR2
          BRANCH    OVRCD,DELALR
.
          MATCH     OLDURNO,PTALURNO
          GOTO      DELALR IF NOT EQUAL
.
          MOVE      NEWURNO,PTALURNO
          CALL      AUPTALR2
          GOTO      RSDALR
.
DELALR    PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ENDALR
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21                * check for wahealth alerts
          BRANCH    OVRCD,DELALR10
.
          MATCH     "1",PMPXSIN7
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN8
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN9
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSN11
          GOTO      ENDALR IF EQUAL       * current alert exists
.
DELALR10  MATCH     "0",PTMXSIN1            * Any current alerts
          IF        !@EQUAL
            MATCH     " ",PTMXSIN1          * Any current alerts
            GOTO      ENDALR IF NOT EQUAL
          ENDIF
.
          PACK      KEY27,NEWURNO,SP70
          CALL      ASPTALR2
ADLALR    CALL      AKPTALR2
          BRANCH    OVRCD,ENDALR
.
          MATCH     NEWURNO,PTALURNO
          GOTO      ENDALR IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR           * Delete
          GOTO      ADLALR IF NOT EQUAL
.
          MOVE      "3",PTMXSIN1            * Yes there are deleted alerts
.
          CALL      UPMAST1
          GOTO      ENDALR
.
.------------------------------------------------------------
. Calculate the counter number for this U/R and alert
.------------------------------------------------------------
CONA0000  MOVE      ZERO,F3                       * Set counter
          READ      CONTROLF,TEN;*250,CAUDA1
.
          PACK      KEY16,NEWURNO,ALERT001,ALERT002,Z70
          CALL      RSPTALR1
          CALL      RPPTALR1
          BRANCH    OVRCD,CONA2000
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CONA2000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONA2000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONA2000 IF NOT EQUAL
.
          MOVE      PTALCNTR,F3
.
CONA2000  BRANCH    CAUDA1,CONA9000              * Check if using audit file
.
          PACK      KEY27,NEWURNO,Z70
          CALL      ASPTALR2
          CALL      APPTALR2
          BRANCH    OVRCD,CONA9000
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CONA9000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONA9000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONA9000 IF NOT EQUAL
.
          MOVE      ZERO,F3A                    * Use audit file counter if
          MOVE      PTALCNTR,F3A                * higher
          IF        F3A>F3
            MOVE      F3A,F3
          ENDIF
.
CONA9000  ADD       ONE,F3
          MOVE      F3,ALERT013
.
CONA9999  RETURN
.
FIXALN00  OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
FIXALN10  PACK      KEY19,SAVKEY16,SP20
          CALL      RSPMALN1
          CALL      RKPMALN1
          BRANCH    OVRCD,FIXALN50
.
          UNPACK    SAVKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          PACK      SAVKEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO
.
          MATCH     PTALURNO,PMANURNO
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      FIXALN50 IF NOT EQUAL
.
          UNPACK    NEWKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          PACK      KEY19,NEWURNO,PTALCATG,PTALCODE,PTALCNTR,PMANLNNO
          CALL      RAPMALN1                    * read into ans;
          BRANCH    OVRCD,FIXALN20              * new u/r not on file, go update
          CALL      DEPMALN1                    * delete new u/r no.
.
FIXALN20  PACK      KEY19,SAVKEY19,SP70         * read old record
          CALL      RDPMALN1                          * full read
          MOVE      NEWURNO,PMANURNO                  * move new u/r to old u/r
          MOVE      PTALCNTR,PMANCNTR                 * move new u/r to old u/r
          CALL      UPPMALN1                          * update record
.
          GOTO      FIXALN10
.
FIXALN50  BRANCH    CAUDA1,FIXALN99                   * Using Audits
.
FIXALN60  PACK      KEY27,OLDURNO,SP70
          CALL      ASPMALN2
          CALL      AKPMALN2
          BRANCH    OVRCD,FIXALN99
.
          MATCH     OLDURNO,PMANURNO
          GOTO      FIXALN99 IF NOT EQUAL
.
          MOVE      NEWURNO,PMANURNO
          CALL      AUPMALN2
          GOTO      FIXALN60
.
FIXALN99  CLOSE     PMSALNA1
          RETURN
+
          INC       IBAOVRIO/INC
          INC       PATALRIO/INC
          INC       PMSALNIO/INC
.
ENDALR    CLOSE     PATALRT1
          CLOSE     PMSAUDA2
          ENDPROC
.

.**********************************************************************
.*             Fix Booking file Changes                               *
.**********************************************************************
BOKC0000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"bokrc1af"
          TRAP      OVERCOND IF IO
          OPEN      BOKRC1A6,"bokrc1af"
          TRAPCLR   IO
          BRANCH    OVRCD,BOKC9999
.
          DISPLAY   *P1:24,*EL,"Fixing Booking File";
          OPEN      BOKRC1A1,"bokrc1af"
.
BOKC1000  PACK      KEY16,OLDURNO,SP70
          CALL      RSBKREC6
          CALL      RKBKREC6
          BRANCH    OVRCD,BOKC9999
.
.         Update booking file with new UR
.
          MATCH     BKREURNO,OLDURNO
          GOTO      BOKC9999 IF NOT EQUAL
.
          MOVE      NEWURNO,BKREURNO
          CALL      UPBKREC6
.
          CALL      FIXDET00
          GOTO      BOKC1000           * Loop back to correct file position
.                                      * after key has been updated
BOKC9999  RETURN
+
.*********************************************************************
.         Subroutine to update the oprdetaf file
.*********************************************************************
FIXDET00  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"oprdetaf"
          TRAP      OVERCOND IF IO
          OPEN      OPRDETA2,"oprdetaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXDET99
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
FIXDET10  CALL      RKOPDEA2
          BRANCH    OVRCD,FIXDET99
.
.         Update oprdetaf file with new UR
.
          MATCH     DBKREBOO,OPDAADMN
          GOTO      FIXDET99 IF NOT EQUAL
.
          MOVE      NEWURNO,OPDAURNO
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
.
          CALL      UPOPDEA2
.
          GOTO      FIXDET10
.
FIXDET99  RETURN
.
.**********************************************************************
.*             Current patient Changes                                *
.**********************************************************************
PCUR0000  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmscuraf"
          TRAP      OVERCOND IF IO
          OPEN      PMSCURA3,"pmscuraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PCUR9999
.
          DISPLAY   *P1:24,*EL,"Fixing current patient file";
.
PCUR1000  PACK      KEY16,OLDURNO,SP70
          CALL      RSPMCUR3
          CALL      RKPMCUR3
          BRANCH    OVRCD,PCUR9999
.
.         Update file with new UR
.
          MATCH     PMCUURNO,OLDURNO
          GOTO      PCUR9999 IF NOT EQUAL
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PCUR9999
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,PCUR9999
.
          MOVE      NEWURNO,PMCUURNO
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          CALL      UPPMCUR3
.
          GOTO      PCUR1000           * Loop back to correct file position
.                                      * after key has been updated
PCUR9999  RETURN
+
.**********************************************************************
.*             Patient U/R Comments                                   *
.**********************************************************************
PATCOM00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSUCHA1,"pmsuchaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATCOM99           * file not found
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSUCDA1,"pmsucdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATCOM99           * file not found
.
          MOVE      "pmsuchaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          CALL      PATCOM10
          GOTO      PATCOM99
.
          INC       PATCOM10
.
PATCOM99  RETURN
.
.**********************************************************************
.*             Patient Attribute Changes                              *
.**********************************************************************
PATATR00  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"patatraf"
          TRAP      OVERCOND IF IO
          OPEN      PATATRA3,"patatraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATATR99
          OPEN      PATATRA1,"patatraf"
.
          DISPLAY   *P1:24,*EL,"Fixing patient attribute file";
.
          MOVE      "0",OMBIRACT   
          MOVE      "0",NMBIRACT   
          PACK      DIM8,SP7,ZERO
.
. determine if there is multiple birth active row for new UR
.
PATATR10  PACK      KEY35,NEWURNO,DIM8,ATYPE022,Z70
          CALL      RSPTATR3
PATATR12  CALL      RPPTATR3
          BRANCH    OVRCD,PATATR30
.
          MATCH     NEWURNO,PTARURNO
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     DIM8,PTARVISN
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR12 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      PATATR12 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      PATATR12 IF NOT EQUAL
.
          MOVE      "1",NMBIRACT
.
. determine if there is multiple birth active row for old UR
. 
PATATR30  PACK      KEY35,OLDURNO,DIM8,ATYPE022,Z70
PATATR31  CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,PATATR80
.
          MOVE      "0",MBIRACT 
.
          MATCH     OLDURNO,PTARURNO
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     DIM8,PTARVISN
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR40 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      PATATR40 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      PATATR40 IF NOT EQUAL
.
          MOVE      "1",MBIRACT
.
. Update file with new UR
.
PATATR40  PACK      SAVKEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          PACK      KEY35,NEWURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70 
          CALL      RDPTATR1
          BRANCH    OVRCD,PATATR45
.
. key with new ur already exists, no update will be done
.
          MOVE      SAVKEY35,KEY35                       
          GOTO      PATATR31               * Loop back to next row
.
PATATR45  MATCH     "1",MBIRACT
          IF        @EQUAL
            MOVE      MBIRACT,OMBIRACT
          ENDIF
. 
          MATCH     "1",NMBIRACT
          IF        @EQUAL
            MOVE      "1",PTARDELR
          ENDIF  
          MOVE      NEWURNO,PTARURNO
          CALL      UPPTATR3 
.
          MOVE      SAVKEY35,KEY35
          GOTO      PATATR31               * Loop back to next row
.
PATATR80  MATCH     "1",NMBIRACT          * Do nothing if new ur is active   
          GOTO      PATATR99 IF EQUAL
.
          MATCH     "1",OMBIRACT          * Do nothing if old ur not active   
          GOTO      PATATR99 IF NOT EQUAL 
.
. Update pmpxsn20 = "1"
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,PATATR99
.
          MOVE      "1",PMPXSN20
          CALL      UPPMPX21          * update the record
. 
PATATR99  RETURN
+
.**********************************************************************
.*             Patient Record Location                                *
.**********************************************************************
RECL0000  COMPARE   ONE,PTCNUCSL                  * using case notes loc file?
          GOTO      RECL9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATCSLA1,"patcslaf"
          TRAPCLR   IO
          BRANCH    OVRCD,RECL9999
.
          MOVE      "patcslaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY11 WITH PVIURNO,SP30
          CALL      RSPTCSL1
RECL1000  CALL      RKPTCSL1
          BRANCH    OVRCD OF RECL9000
.
          MATCH     PVIURNO,PTCLURNO
          GOTO      RECL9000 IF NOT EQUAL
.
. check if new U/R already exists
.
          PACK      KEY11,NEWURNO,PTCLUNIQ
          CALL      RAPTCSL1
          BRANCH    OVRCD,RECL3000
.
          PACK      KEY11,OLDURNO,PTCLUNIQ
          CALL      DEPTCSL1
          GOTO      RECL1000
.
. update the record with the new U/R No.
.
RECL3000  PACK      KEY11,OLDURNO,PTCLUNIQ
          CALL      RDPTCSL1
.
          MOVE      NEWURNO,PTCLURNO
          CALL      UPPTCSL1
          GOTO      RECL1000
.
RECL9000  CLOSE     PATCSLA1
.
RECL9999  RETURN
+
.**********************************************************************
.*             Patient Donor Information                              *
.**********************************************************************
DONR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATDNRA1,"patdnraf"
          TRAPCLR   IO
          BRANCH    OVRCD,DONR9999
.
          MOVE      "patdnraf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY10 WITH PVIURNO,SP30
          CALL      RSPTDNR1
DONR1000  CALL      RKPTDNR1
          BRANCH    OVRCD OF DONR9000
.
          MATCH     PVIURNO,PTDNURNO
          GOTO      DONR9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTDNURNO
          CALL      UPPTDNR1
          GOTO      DONR1000
.
DONR9000  CLOSE     PATDNRA1
.
DONR9999  RETURN
+
.**********************************************************************
.*             Patient Immunisation Details                           *
.**********************************************************************
IDET0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATIMMA1,"patimmaf"
          TRAPCLR   IO
          BRANCH    OVRCD,IDET9999
.
          MOVE      "patimmaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY19 WITH PVIURNO,SP30
          CALL      RSPTIMM1
IDET1000  CALL      RKPTIMM1
          BRANCH    OVRCD OF IDET9000
.
          MATCH     PVIURNO,PTIMURNO
          GOTO      IDET9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTIMURNO
          CALL      UPPTIMM1
          GOTO      IDET1000
.
IDET9000  CLOSE     PATIMMA1
.
IDET9999  RETURN
+
.**********************************************************************
.*             Patient Kiwicard Details                               *
.**********************************************************************
KIWI0000  OPEN      PATVCHA1,"patvchaf"
          MOVE      "99",FORM2
KIWI1000  PACK      CFNAME,KWCFIL,FORM2
          REP       " 0",CFNAME
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATKWCA1,CFNAME
          BRANCH    OVRCD,KIWI9000
          TRAPCLR   IO
.
          OPEN      PATKWCA2,CFNAME
.
          MOVE      CFNAME,XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          PACK      KEY28,OLDURNO,SP30
          CALL      RDPTKWC2
          COMPARE   ONE,OVRCD
          GOTO      KIWI3000 IF NOT EQUAL
.
KIWI2000  CALL      RKPTKWC2
          BRANCH    OVRCD,KIWI9000
.
          MATCH     OLDURNO,PTKWURNO
          GOTO      KIWI9000 IF NOT EQUAL
.
KIWI3000  PACK      KEY28,PTKWCARD,NEWURNO
          CALL      RAPTKWC1
          IF        OVRCD=1
            PACK      KEY28,PTKWCARD,OLDURNO
            CALL      RDPTKWC1
            BRANCH    OVRCD,KIWI2000
.
            MOVE      NEWURNO,PTKWURNO
            CALL      UPPTKWC1
          ELSE
            MOVE      PTKWDAYS,SPTKWDAY
            MOVE      PTKWVISI,SPTKWVIS
.
            PACK      KEY28,PTKWCARD,OLDURNO
            CALL      DEPTKWC1
.
            PACK      KEY28,PTKWCARD,NEWURNO
            CALL      RDPTKWC1
            BRANCH    OVRCD,KIWI2000
.
            MOVE      SPTKWDAY,PTKWDAYS
            MOVE      SPTKWVIS,PTKWVISI
            CALL      UPPTKWC1
          ENDIF
.
          CALL      VCCA0000                * Visit Count Change Audit
          GOTO      KIWI2000
.
KIWI9000  COMPARE   "00",FORM2
          GOTO      KIWI9100 IF EQUAL
          GOTO      KIWI9100 IF LESS 
.
          SUB       ONE,FORM2                * go to the next year
          GOTO      KIWI1000
.
KIWI9100  CLOSE     PATKWCA1
          CLOSE     PATKWCA2
          CLOSE     PATVCHA1
.
KIWI9999  RETURN
+
.**********************************************************************
.*             Visit Count Change Audit                               *
.**********************************************************************
VCCA0000  PACK      KEY48 WITH PTKWCARD,PTKWURNO,SP30
          CALL      RSPTVCH1
VCCA1000  CALL      RKPTVCH1
          BRANCH    OVRCD OF VCCA9999
.
          MATCH     OLDURNO,PTVCURNO
          GOTO      VCCA9999 IF NOT EQUAL
.
          MOVE      NEWURNO,PTVCURNO
          CALL      UPPTVCH1
.
VCCA9999  RETURN
+
.**********************************************************************
.*             Patient Last U/R Entered                               *
.**********************************************************************
LAUR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATLUEA1,"patlueaf"
          TRAPCLR   IO
          BRANCH    OVRCD,IDET9999
.
          MOVE      "patlueaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          PACK      KEY4 WITH PASSCODE
LAUR1000  CALL      RDPTLUE1
          BRANCH    OVRCD OF LAUR9000
.
          MATCH     OLDURNO,PTLUURNO
          GOTO      LAUR9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTLUURNO
          CALL      UPPTLUE1
.
LAUR9000  CLOSE     PATLUEA1
.
LAUR9999  RETURN
+
.**********************************************************************
.*             Patient Medical Warnings                               *
.**********************************************************************
MEDW0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATMWSA1,"patmwsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MEDW9999
.
          MOVE      "patmwsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY14 WITH PVIURNO,SP30
          CALL      RSPTMWS1
MEDW1000  CALL      RKPTMWS1
          BRANCH    OVRCD OF MEDW9000
.
          MATCH     PVIURNO,PTMWURNO
          GOTO      MEDW9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTMWURNO
          CALL      UPPTMWS1
          GOTO      MEDW1000
.
MEDW9000  CLOSE     PATMWSA1
.
MEDW9999  RETURN
+
.**********************************************************************
.*             Patient Medical Warnings                               *
.**********************************************************************
ADET0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATNADA1,"patnadaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ADET9999
.
          MOVE      "patnadaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY16 WITH PVIURNO,SP30
          CALL      RSPTNAD1
ADET1000  CALL      RKPTNAD1
          BRANCH    OVRCD OF ADET9000
.
          MATCH     PVIURNO,PTNDURNO
          GOTO      ADET9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTNDURNO
          CALL      UPPTNAD1
          GOTO      ADET1000
.
ADET9000  CLOSE     PATNADA1
.
ADET9999  RETURN
+
.**********************************************************************
.*             Fees Estimation Details                                *
.**********************************************************************
FEST0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSFEDA2,"pmsfedaf"
          TRAPCLR   IO                                                 *I-90301
          BRANCH    OVRCD,FEST9999                                     *I-90301
.
          TRAP      OVERCOND IF IO                                     *I-90301
          OPEN      PMSFESA1,"pmsfesaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FEST9999
.
          MOVE      "pmsfedaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
FEST1000  PACK      KEY20 WITH PVIURNO,SP30
          CALL      RSPMFED2
          CALL      RKPMFED2
          BRANCH    OVRCD OF FEST9000
.
          MATCH     PVIURNO,PMFDURNO
          GOTO      FEST9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMFDURNO
          CALL      UPPMFED2
.
          PACK      KEY17,PMFDQUOT,SP30
          CALL      RSPMFES1
FEST2000  CALL      RKPMFES1
          BRANCH    OVRCD OF FEST1000
.
          MATCH     PMFSQUOT,PMFDQUOT
          GOTO      FEST1000 IF NOT EQUAL
.
          MATCH     PVIURNO,PMFSURNO
          GOTO      FEST2000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMFSURNO
          CALL      UPPMFES1
          GOTO      FEST2000 
.
FEST9000  CLOSE     PMSFEDA2
          CLOSE     PMSFESA1
.
FEST9999  RETURN
+
.**********************************************************************
.*             Patient Problem Master Table                           *
.**********************************************************************
PROB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPRBA1,"pmsprbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PROB9999
.
          MOVE      "pmsprbaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY13 WITH PVIURNO,SP30
          CALL      RSPMPRB1
PROB1000  CALL      RKPMPRB1
          BRANCH    OVRCD OF PROB9000
.
          MATCH     PVIURNO,PMPBURNO
          GOTO      PROB9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMPBURNO
          CALL      UPPMPRB1
          GOTO      PROB1000
.
PROB9000  CLOSE     PMSPRBA1
.
PROB9999  RETURN
+
.**********************************************************************
.*             MH Legal status detail                                 *
.**********************************************************************
MHDL0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHDLSA1,"mehdlsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHDL9999
.
          MOVE      "mehdlsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHDL1000  PACK      KEY32,PVIURNO,SP30
          CALL      RSMHDLS1
          CALL      RKMHDLS1
          BRANCH    OVRCD,MHDL9999
.
          MATCH     PVIURNO,MHDLURNO
          GOTO      MHDL9999 IF NOT EQUAL
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
.
          MOVE      NEWURNO,MHDLURNO
          CALL      UPMHDLS1
          GOTO      MHDL1000
.
MHDL9999  RETURN
+
.**********************************************************************
.*             MH Legal status detail                                 *
.**********************************************************************
MHAD0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHAUDDA,"mehaudda"
          TRAPCLR   IO
          BRANCH    OVRCD,MHAD9999
.
          MOVE      "mehaudda",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHAD1000  PACK      KEY32,PVIURNO,SP30
          CALL      ASMHDL
          CALL      APMHDL
          BRANCH    OVRCD,MHAD9999
.
          MATCH     PVIURNO,MHDLURNO
          GOTO      MHAD9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHDLURNO
          CALL      AUMHDL
          GOTO      MHAD1000
.
MHAD9999  RETURN
+
.**********************************************************************
.*             MH Header audit                                        *
.**********************************************************************
MHAH0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHAUDHA,"mehaudha"
          TRAPCLR   IO
          BRANCH    OVRCD,MHAH9999
.
          MOVE      "mehaudha",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHAH1000  PACK      KEY32,PVIURNO,SP30
          CALL      ASMHHL
          CALL      APMHHL
          BRANCH    OVRCD,MHAH9999
.
          MATCH     PVIURNO,MHHLURNO
          GOTO      MHAH9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHHLURNO
          CALL      AUMHHL
          GOTO      MHAH1000
.
MHAH9999  RETURN
+
.**********************************************************************
.*             MH Legal status header                                 *
.**********************************************************************
MHHL0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHHLSA1,"mehhlsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHHL9999
.
          MOVE      "mehhlsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHHL1000  PACK      KEY16,PVIURNO,SP30
          CALL      RSMHHLS1
          CALL      RKMHHLS1
          BRANCH    OVRCD,MHHL9999
.
          MATCH     PVIURNO,MHHLURNO
          GOTO      MHHL9999 IF NOT EQUAL
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLUDAT             * date updated
          CLOCK     TIME,MHHLUTIM             * time updated
          MOVE      USERID,MHHLUUID           * web user id
.
          MOVE      NEWURNO,MHHLURNO
          CALL      UPMHHLS1
          GOTO      MHHL1000
.
MHHL9999  RETURN
+
.**********************************************************************
.*             MH Notes                                               *
.**********************************************************************
MHMD0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHMDTA1,"mehmdtaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHMD9999
.
          MOVE      "mehmdtaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHMD1000  PACK      KEY17,PVIURNO,SP30
          CALL      RSMHMDT1
          CALL      RKMHMDT1
          BRANCH    OVRCD,MHMD9999
.
          MATCH     PVIURNO,MHMDURNO
          GOTO      MHMD9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHMDURNO
          CALL      UPMHMDT1
          GOTO      MHMD1000
.
MHMD9999  RETURN
+
.**********************************************************************
.*             MH Free Text Notes                                     *
.**********************************************************************
MHMT0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHMTXA1,"mehmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHMT9999
.
          MOVE      "mehmtxaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHMT1000  PACK      KEY20,PVIURNO,SP30
          CALL      RSMHMTX1
          CALL      RKMHMTX1
          BRANCH    OVRCD,MHMT9999
.
          MATCH     PVIURNO,MHMTURNO
          GOTO      MHMT9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHMTURNO
          CALL      UPMHMTX1
          GOTO      MHMT1000
.
MHMT9999  RETURN
+
.**********************************************************************
.*             MH Supplementary Consumer Record                       *
.**********************************************************************
MHSC0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHSCRA1,"mehscraf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHSC9999
.
          MOVE      "mehscraf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
.
.  find the highest counter for the ur to keep
.
          MOVE      ZERO,F5
          PACK      KEY16,NEWURNO,SP70
          CALL      RSMHSCR1
MHSC0200  CALL      RKMHSCR1
          BRANCH    OVRCD,MHSC0500
.
          MATCH     NEWURNO,MHSCURNO
          GOTO      MHSC0500 IF NOT EQUAL
.
          ADD       ONE,F5
.
MHSC0500  MOVE      OLDURNO,PVIURNO
MHSC1000  PACK      KEY16,PVIURNO,SP30
          CALL      RSMHSCR1
          CALL      RKMHSCR1
          BRANCH    OVRCD,MHSC9999
.
          MATCH     PVIURNO,MHSCURNO
          GOTO      MHSC9999 IF NOT EQUAL
.
          PACK      KEY16,NEWURNO,MHSCSDAT,SP70
          CALL      RAMHSCR1
          IF        OVRCD=1
            PACK      KEY16,OLDURNO,MHSCSDAT,SP70
            CALL      RDMHSCR1
            IF        OVRCD=0
              MOVE      NEWURNO,MHSCURNO
              ADD       ONE,F5
              MOVE      F5,MHSCCOUN
              CALL      UPMHSCR1
            ENDIF
          ELSE
            PACK      KEY16,OLDURNO,MHSCSDAT,SP70
            CALL      DEMHSCR1
          ENDIF
          GOTO      MHSC1000
.
MHSC9999  RETURN
+
.**********************************************************************
.*             MH PRIMHD Transmission RD Record                       *
.**********************************************************************
MHPRD000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPRDA3,"mehprdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPRD999
.
          MOVE      "mehprdaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPRD100  PACK      KEY27,SP30
          CALL      RSMHPRD3
          CALL      RKMHPRD3
          BRANCH    OVRCD,MHPRD999
.
          MATCH     PVIURNO,MHPDURNO
          GOTO      MHPRD999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPDURNO
          CALL      UPMHPRD3
.
.                                           * convert "child" Tables
          PACK      KEY27,MHPDXDAT,MHPDXNUM,MHPDVISN,PVIURNO,SP30
          CALL      MHPAT000                * "AT" records
          CALL      MHPCN000                * "CN"
          CALL      MHPCO000                * "CO"
          CALL      MHPOI000                * "OT/OI"
          CALL      MHPSC000                * "SC"
.
          GOTO      MHPRD100
.
MHPRD999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission AT Record                       *
.**********************************************************************
MHPAT000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPATA1,"mehpataf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPAT999
.
          MOVE      "mehpataf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPAT100  PACK      KEY32,KEY27,SP30
          CALL      RSMHPAT1
MHPAT200  CALL      RKMHPAT1
          BRANCH    OVRCD,MHPAT999
.
          PACK      DIM19A,MHPTXDAT,MHPTXNUM,MHPTVISN,SP30
          MATCH     DIM19A,KEY32
          GOTO      MHPAT999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPTURNO
          GOTO      MHPAT200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPTURNO
          CALL      UPMHPAT1
          GOTO      MHPAT100
.
MHPAT999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission CN Record                       *
.**********************************************************************
MHPCN000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCNA1,"mehpcnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPCN999
.
          MOVE      "mehpcnaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPCN100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCN1
MHPCN200  CALL      RKMHPCN1
          BRANCH    OVRCD,MHPCN999
.
          PACK      DIM19A,MHPNXDAT,MHPNXNUM,MHPNVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPCN999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPNURNO
          GOTO      MHPCN200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPNURNO
          CALL      UPMHPCN1
          GOTO      MHPCN100
.
MHPCN999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission SC Record                       *
.**********************************************************************
MHPSC000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCSA1,"mehpcsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPSC999
.
          MOVE      "mehpcsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPSC100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCS1
MHPSC200  CALL      RKMHPCS1
          BRANCH    OVRCD,MHPSC999
.
          PACK      DIM19A,MHPCXDAT,MHPCXNUM,MHPCVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPSC999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPCURNO
          GOTO      MHPSC200 IF NOT EQUAL
.
.
.         check if changing UR will create a duplicate key before updating
.
          PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,NEWURNO,MHPCOCUR,SP70
          CALL      RAMHPCS1
          IF        OVRCD=1
            PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,OLDURNO,MHPCOCUR,SP70
            CALL      RDMHPCS1
            IF        OVRCD=0
              MOVE      NEWURNO,MHPCURNO
              CALL      UPMHPCS1
            ENDIF
          ELSE
            PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,OLDURNO,MHPCOCUR,SP70
            CALL      DEMHPCS1
          ENDIF
          GOTO      MHPSC100
.
MHPSC999  RETURN
.
..**********************************************************************
.*             MH PRIMHD Transmission CO Record                       *
.**********************************************************************
MHPCO000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCOA1,"mehpcoaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPCO999
.
          MOVE      "mehpcoaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPCO100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCO1
MHPCO200  CALL      RKMHPCO1
          BRANCH    OVRCD,MHPCO999
.
          PACK      DIM19A,MHPOXDAT,MHPOXNUM,MHPOVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPCO999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPOURNO
          GOTO      MHPCO200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPOURNO
          CALL      UPMHPCO1
          GOTO      MHPCO100
.
MHPCO999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission OI Record                       *
.**********************************************************************
MHPOI000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPOIA1,"mehpoiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPOI999
.
          MOVE      "mehpoiaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPOI100  PACK      KEY36,KEY27,SP30
          CALL      RSMHPOI1
MHPOI200  CALL      RKMHPOI1
          BRANCH    OVRCD,MHPOI999
.
          PACK      DIM19A,MHPIXDAT,MHPIXNUM,MHPIVISN,SP30
          MATCH     DIM19A,KEY36
          GOTO      MHPOI999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPIURNO
          GOTO      MHPOI200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPIURNO
          CALL      UPMHPOI1
          GOTO      MHPOI100
.
MHPOI999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission LS Record                       *
.**********************************************************************
MHPLS000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPLSA3,"mehplsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPLS999
.
          MOVE      "mehplsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPLS100  PACK      KEY30,PVIURNO,SP30
          CALL      RSMHPLS3
          CALL      RKMHPLS3
          BRANCH    OVRCD,MHPLS999
.
          MATCH     PVIURNO,MHPSURNO
          GOTO      MHPLS999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPSURNO
          CALL      UPMHPLS3
          GOTO      MHPLS100
.
MHPLS999  RETURN
+
.****************************************************************************
.*                             ORLET000                                     *
.*                  Update O/P Referral Letter File                         *
.****************************************************************************
.
          DEFPROC   ORLET000
.
          INC       OUTRF1FD/INC
.
SAVKEY24  DIM       24
.
          COMPARE   ZERO,OTCNULET                * Using O/P Referral Letters ?
          GOTO      ORLET999 IF EQUAL            * no - finish
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTRF1A2,"outrf1af"
          TRAPCLR   IO
          BRANCH    OVRCD,ORLET999               * file not found
.
          MOVE      "outrf1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          DISPLAY   *P30:24,*EL,"Referral Letters for : ",*V2LON,OLDURNO;
.
          MOVE      OLDURNO,PVIURNO
ORLET100  PACK      KEY24,PVIURNO,SP30
          CALL      RSOTRFL2                     * position in file
          CALL      RKOTRFL2                     * read next record
          BRANCH    OVRCD,ORLET900               * eof - finished
.
          MATCH     PVIURNO,OTRLURNO             * same U/R number ?
          GOTO      ORLET900 IF NOT EQUAL        * no - finished
.
          PACK      SAVKEY24,OTRLURNO,OTRLDATE,OTRLOUTN
          PACK      KEY24,NEWURNO,OTRLDATE,OTRLOUTN
          CALL      RAOTRFL2                     * record on file already ?
          BRANCH    OVRCD,ORLET500               * no - update
.
          MOVE      SAVKEY24,KEY24               * yes - delete original record
          CALL      DEOTRFL2
          GOTO      ORLET100
.
ORLET500  MOVE      SAVKEY24,KEY24
          CALL      RDOTRFL2                     * reposition on record
          MOVE      NEWURNO,OTRLURNO             * update U/R number
          CALL      UPOTRFL2
          GOTO      ORLET100                     * get next record
.
ORLET900  CLOSE     OUTRF1A2
          GOTO      ORLET999
.
          INC       IBAOVRIO/INC
          INC       OUTRF1IO/INC
.
ORLET999  ENDPROC
+
.**********************************************************************
.*                            BOOK0000                                *
.*                      Update Bookings File                          *
.**********************************************************************
.
BOOK0000  DISPLAY   *P30:24,*EL,"Outpatient : ",*V2LON,OLDURNO;
.
.        Loop over this U/R, locking booking records as we go
.
          MOVE      ZERO,LOKCOUNT
.
          MOVE      OLDURNO,PVIURNO
BOOK1000  PACK      KEY36 WITH PVIURNO,SP30
          CALL      RDSBOKA3
          CALL      RDKBOKA3
          BRANCH    OVRCD OF BOOK9999
.
          MATCH     OBAURNO,PVIURNO
          GOTO      BOOK9999 IF NOT EQUAL
.
.        Lock this record if possible
.
BOOK2000  PACK      KEY28 WITH OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
....      CALL      RDLBOKA1
          CALL      RDBOKA1                                           *C-236586
          BRANCH    OVRCD OF BOOK4000,BOOK3000
BOOK2500  MOVE      NEWURNO,OBAURNO
          CALL      UPBOKA1
.
          DISPLAY   *P30:24,*EL,"Outpatient Booking : ",*V2LON,OBAOUTNO;
.
          CALL      OUAT0000                * Outpatient Un-attendance          
          CALL      OUTBIT00                * outpatient booking items

          GOTO      BOOK1000
.
BOOK3000  DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** Outpatient ",OBAOUTNO," locked on Port ",OBALOCK:
                    ". Please wait **",*W,*P1:24,*EL;
.
          ADD       ONE,LOKCOUNT
          COMPARE   THIRTY,LOKCOUNT         * Update Anyway After 30 Secs
          GOTO      BOOK2500 IF NOT LESS
.
          GOTO      BOOK2000
.
BOOK4000  PRINT     "** Error : Outpatient ",OBAOUTNO," has disappeared. ";
BOOK9999  RETURN
.
+
.*********************************************************************
.        fix up the HIC claim file
.*********************************************************************
HICCLM00  MATCH     "1",IBCNUMCI
          GOTO      HICCLM99 IF NOT EQUAL      * not using med claim
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      HICCLMA3,"hicclmaf"
          TRAPCLR   IO
          BRANCH    OVRCD,HICCLM99
.
          OPEN      HICCLMA3,"hicclmaf"
.
.        Loop thru HIC claims File
.
HICCLM10  PACK      KEY16,OLDURNO,SP30
          CALL      RSHCCLM3
          CALL      RKHCCLM3
          BRANCH    OVRCD,HICCLM95
.
          MATCH     HCCLURNO,OLDURNO
          GOTO      HICCLM95 IF NOT EQUAL
.
          MOVE      NEWURNO,HCCLURNO
          CALL      UPHCCLM3
          GOTO      HICCLM10
.
HICCLM95  CLOSE     HICCLMA3
HICCLM99  RETURN
.
.**********************************************************************
.*                            CANN0000                                *
.*                    Update Cancellation File                        *
.**********************************************************************
.
CANN0000  DISPLAY   *P30:24,*EL,"Outpatient : ",*V2LON,OLDURNO;
.
.        Loop over this U/R
.
          MOVE      OLDURNO,PVIURNO
CANN1000  PACK      KEY24,PVIURNO,SP30
          CALL      RSOTCAN2
          CALL      RKOTCAN2
          BRANCH    OVRCD,CANN9999
.
          MATCH     OPCNURNO,PVIURNO
          GOTO      CANN9999 IF NOT EQUAL
.
          PACK      KEY8,OPCNOUTN
          CALL      RDOTCAN1
          BRANCH    OVRCD,CANN9000
.
          MOVE      NEWURNO,OPCNURNO
          CALL      UPOTCAN1
.
          DISPLAY   *P30:24,*EL,"Outpatient Booking : ",*V2LON,OPCNOUTN;
          GOTO      CANN1000
.
CANN9000  PRINT     "** Error : O/P Cancellation ":
                    OPCNOUTN," has disappeared. ":
                    "Contact IBA Immediately **";
CANN9999  RETURN
.
.**********************************************************************
.*                            WAIT0000                                *
.*                    Update Waiting Lists Files                      *
.**********************************************************************
.
WAIT0000  BRANCH    NOWAT,WAIT9999
.
          DISPLAY   *P1:24,*EL,*P30:24,"Fixing Waiting List Files";
          CALL      WTRE0000
.
WAIT9999  RETURN
+
.**********************************************************************
.*                            WTRE0000                                *
.*               Update Waiting Lists Treatment File                  *
.**********************************************************************
.
WTRE0000  OPEN      WATTR1A1,"wattr1af"
          OPEN      BOKRC1A1,"bokrc1af"
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"wattx1af"
          TRAP      OVERCOND IF IO
          OPEN      WATTX1A1,"wattx1af"
          TRAPCLR   IO
          BRANCH    OVRCD,WTRE9000
.
          MOVE      OLDURNO,PVIURNO
.
WTRE1000  MOVE      "wattr1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          PACK      KEY19,PVIURNO,SP20
          CALL      RDSTREA1                     * position in file for old U/R
          CALL      RDKTREA1                     * read next record
          BRANCH    OVRCD,WTRE9000               * eof - finished
.
          MATCH     WMURNO,PVIURNO               * same U/R number still ?
          GOTO      WTRE9000 IF NOT EQUAL        * no - finished
.
          MOVE      WMCNT,SAVWMCNT               * save the old count
.
          DISPLAY   *P30:24,*EL,"Procedure : ",*V2LON,WMCODE,WMCNT;
.
.         Loop over the treatment file for NEW U/R until we get a unique
.         count for procedure code
.
WTRE2000  PACK      KEY19,NEWURNO,WMCODE,WMCNT
          CALL      RDATREA1                     * proc/count already on file ?
          BRANCH    OVRCD,WTRE3000               * no - count ok
.
          ADD       ONE,WMCNT                    * yes - increment count
          COMPARE   "99",WMCNT                   * maximum count reached ?
          GOTO      WTRE9000 IF EQUAL            * yes - finished
          GOTO      WTRE2000                     * read next count record
.
WTRE3000  MOVE      WMCNT,NEWCNT                 * save the new count
          PACK      KEY19,OLDURNO,WMCODE,SAVWMCNT
          CALL      RDTREA1                      * reposition on old record
          MOVE      NEWURNO,WMURNO               * load new U/R number
          MOVE      NEWCNT,WMCNT                 * load new count
          CALL      UPTREA1                      * update record
.
.         Update Extn File with new urnumber
.
          PACK      KEY19,OLDURNO,WMCODE,SAVWMCNT
          CALL      RDWTTX11
          IF        OVRCD = 0
            MOVE      NEWURNO,WTTXURNO           * update U/R number
            MOVE      NEWCNT,WTTXPCNT            * update count
            CALL      UPWTTX11                   * update record
          ENDIF
.
.         Update booking file with new count and U/R if needed
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1                     * booking record on file ?
          IF        OVRCD = 0
            MOVE      NEWURNO,BKREURNO           * load new U/R number
            MOVE      NEWCNT,BKRECNT             * load new count
            CALL      UPBKREC1                   * update record
.
            CALL      FIXDET00
          ENDIF
.
          PACK      OLDKEY19,OLDURNO,WMCODE,SAVWMCNT
          PACK      NEWKEY19,NEWURNO,WMCODE,NEWCNT
          MOVE      WMBOOK,BKREBOOK
.
          CALL      WCAT0000                     * update category change file
          CALL      WLHI0000                     * update letter history file
          CALL      WHIS0000                     * Waiting list history file
          CALL      WPAC0000                     * W/L Pre-admission comments
          CALL      RTDT0000                     * Referral & Transfer Dest.
          CALL      WPNP0000                     * update proc. not performed
          CALL      WSUS0000                     * update proc. suspension file
          CALL      WCMN0000                     * update message file
          CALL      WLCH0000                     * data integrity audit file
          GOTO      WTRE1000
.
WTRE9000  CLOSE     WATTR1A1
.
WTRE9999  RETURN
+
.**********************************************************************
.*                            WCMN0000                                *
.*               Update Waiting Lists Comments File                   *
.**********************************************************************
.
WCMN0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMESA1,"watmesaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WCMN9999
.
          MOVE      "watmesaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WCMN1000  PACK      KEY21,OLDKEY19,SP30
          CALL      RDSMESA1
          CALL      RDKMESA1
          BRANCH    OVRCD,WCMN9000
.
          PACK      KEY19,WAURNO,WAPROC,WACNT
          MATCH     KEY19,OLDKEY19
          GOTO      WCMN9000 IF NOT EQUAL
.
          UNPACK    NEWKEY19,WAURNO,WAPROC,KEY2
          MOVE      KEY2,WACNT
          CALL      UPMESA1
          GOTO      WCMN1000
.
WCMN9000  CLOSE     WATMESA1
.
WCMN9999  RETURN
+
.****************************************************************************
.*                              WCAT0000                                    *
.*                 Update category change file (watcataf)                   *
.****************************************************************************
.
WCAT0000  MOVE      ZERO,OVRCD
          MOVE      ZERO,EXIT
          TRAP      OVERCOND IF IO
          OPEN      WATCATA2,"watcataf"
          TRAPCLR   IO
          BRANCH    OVRCD,WCAT9999
.
          MOVE      "watcataf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WCAT0500  PACK      KEY29,OLDKEY19,SP30
          CALL      RSWTCAT2                     * position in file
          CALL      RKWTCAT2                     * read next record
          BRANCH    OVRCD,WCAT9000               * eof - finished
.
          PACK      KEY19,WTCAURNO,WTCAPROC,WTCAPCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WCAT9000 IF NOT EQUAL        * no - finished
.
          UNPACK    NEWKEY19,WTCAURNO,WTCAPROC,KEY2
          MOVE      KEY2,WTCAPCNT
          CALL      UPWTCAT2
          GOTO      WCAT0500
.
WCAT9000  CLOSE     WATCATA2
          MOVE      ZERO,EXIT
.
WCAT9999  RETURN
+
.****************************************************************************
.*                              WLHI0000                                    *
.*                 Update letter history file (watlhiaf)                    *
.****************************************************************************
.
WLHI0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATLHIA1,"watlhiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLHI9999
.
          MOVE      "watlhiaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WLHI0500  PACK      KEY30,OLDKEY19,SP30
          CALL      RSWTLHI1                     * position in file
          CALL      RKWTLHI1                     * read next record
          BRANCH    OVRCD,WLHI9000               * eof - finished
.
          PACK      KEY19,WTLHURNO,WTLHCODE,WTLHCONT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WLHI9000 IF NOT EQUAL        * no - finished
.
          UNPACK    NEWKEY19,WTLHURNO,WTLHCODE,KEY2
          MOVE      KEY2,WTLHCONT
          CALL      UPWTLHI1
          GOTO      WLHI0500                     * get next record
.
WLHI9000  CLOSE     WATLHIA1
.
WLHI9999  RETURN
+
.****************************************************************************
.*                              WLCH0000                                    *
.*                 Update data integrity audit file (watchaaf)              *
.****************************************************************************
.
WLCH0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATCHAA1,"watchaaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLCH9999
.
          MOVE      "watchaaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WLCH0500  PACK      KEY35,OLDKEY19,SP30
          CALL      RSWTCHA1                     * position in file
          CALL      RKWTCHA1                     * read next record
          BRANCH    OVRCD,WLCH9000               * eof - finished
.
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WLCH9000 IF NOT EQUAL        * no - finished
.
          UNPACK    NEWKEY19,WTCHURNO,WTCHPROC,WTCHPCNT
          CALL      UPWTCHA1
          GOTO      WLCH0500                     * get next record
.
WLCH9000  CLOSE     WATCHAA1
.
WLCH9999  RETURN
+
.*****************************************************************************
.*                                  WPAC0000                                 *
.*                 Fix watpacaf - W/L Pre-admission comments                 *
.*****************************************************************************
.
WPAC0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPACA1,"watpacaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WPAC9999
.
          MOVE      "watpacaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
.         Get the last comment line number on file for the new key
.
          MOVE      ZERO,FORM2                   * initialise line number
          PACK      KEY21,NEWKEY19,TILDA21
          CALL      RSWTPAC1                     * position after new U/R
          CALL      RPWTPAC1                     * read previous record
          BRANCH    OVRCD,WPAC1000               * eof
.
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     NEWKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WPAC1000 IF NOT EQUAL        * no
.
          MOVE      WTPCLINE,FORM2               * yes - set line number
.
WPAC1000  PACK      KEY21,OLDKEY19,SP30
          CALL      RSWTPAC1                     * position in file
          CALL      RKWTPAC1                     * read next record
          BRANCH    OVRCD,WPAC9000               * eof - finished
.
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WPAC9000 IF NOT EQUAL        * no - finished
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          UNPACK    NEWKEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          ADD       ONE,FORM2
          MOVE      FORM2,WTPCLINE
.
          CALL      UPWTPAC1                     * update record
          GOTO      WPAC1000                     * get next record
.
WPAC9000  CLOSE     WATPACA1
.
WPAC9999  RETURN
+
.****************************************************************************
.*                              WLHI0000                                    *
.*                 Waiting List  history file (wathisaf)                    *
.****************************************************************************
.
WHIS0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATHISA1,"wathisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WHIS9999
.
          MOVE      "wathisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WHIS1000  PACK      KEY31,OLDKEY19,SP30                                *C-90303
          CALL      RSWTHIS1                     * position in file
          CALL      RKWTHIS1                     * read next record
          BRANCH    OVRCD,WHIS9000               * eof - finished
.
          PACK      KEY19,WTHIURNO,WTHIPROC,DWTHIPCN
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WHIS9000 IF NOT EQUAL        * no - finished
.
. ******************************************* Start of Additional code *I-90303
          PACK      OLDKEY31,OLDKEY19,WTHIEDAT,DWTHIUCN   * save Old key
          MOVE      DWTHIUCN,FORM2               * save Old Unique Count
.
.                                                * see if New UR History exists
WHIS2000  PACK      KEY31,NEWKEY19,WTHIEDAT,DWTHIUCN
          CALL      RDWTHIS1
          BRANCH    OVRCD,WHIS3000               * No - go to delete/write routn
.
.                                                * history already exists
          ADD       ONE,FORM2                    * Create a new Unique Count
          MOVE      FORM2,DWTHIUCN
          GOTO      WHIS2000                     * try again
.
WHIS3000  MOVE      OLDKEY31,KEY31               * re-read Old UR record
          CALL      RDWTHIS1
          CALL      DEWTHIS1                     * delete the old history recd
.
.                                                * modify recd with New UR info
          UNPACK    NEWKEY19,WTHIURNO,WTHIPROC,KEY2
          MOVE      KEY2,DWTHIPCN
          MOVE      FORM2,DWTHIUCN               * insert new Unique Count
.
          PACK      KEY31,NEWKEY19,WTHIEDAT,DWTHIUCN   * reload Key
          CALL      WRWTHIS1                     * write New UR history recd
. ******************************************* End of Additional code   *I-90303
.
          GOTO      WHIS1000                     * get next record
.
WHIS9000  CLOSE     WATHISA1
.
WHIS9999  RETURN
+
.****************************************************************************
.*                              RTDT0000                                    *
.*                 Referral & Transfer Destination (watrtdaf)               *
.****************************************************************************
.
RTDT0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATRTDA1,"watrtdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,RTDT9999
.
          MOVE      "watrtdaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
RTDT0500  PACK      KEY19,OLDKEY19
          CALL      RDWTRTD1
          BRANCH    OVRCD,RTDT9000               * eof - finished
.
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      RTDT9000 IF NOT EQUAL        * no - finished
.
          UNPACK    NEWKEY19,WTRTURNO,WTRTPROC,KEY2
          MOVE      KEY2,WTRTPCNT
          CALL      UPWTRTD1
.
RTDT9000  CLOSE     WATRTDA1
.
RTDT9999  RETURN
+
.****************************************************************************
.*                              WPNP0000                                    *
.*                 Update W.L. Not Performed file (watpnpaf)                *
.****************************************************************************
.
WPNP0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPNPA1,"watpnpaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WPNP9999
.
          MOVE      "watpnpaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WPNP0500  MOVE      BKREBOOK,KEY8
          CALL      RDWTPNP1                     * record on file
          IF        OVRCD = 0
            UNPACK    NEWKEY19,WTNPURNO,WTNPCODE,KEY2
            MOVE      KEY2,WTNPCNT
            CALL      UPWTPNP1                   * yes - update record
          ENDIF
.
          CLOSE     WATPNPA1
.
WPNP9999  RETURN
+
.****************************************************************************
.*                              WSUS0000                                    *
.*                 Update procedure suspension file (watsusaf)              *
.****************************************************************************
.
WSUS0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATSUSA1,"watsusaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WSUS9999
.
          MOVE      "watsusaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
WSUS0500  PACK      KEY21,OLDKEY19,SP30
          CALL      RSWTSUS1                     * position in file
          CALL      RKWTSUS1                     * read next record
          BRANCH    OVRCD,WSUS9000               * eof - finished
.
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      WSUS9000 IF NOT EQUAL        * no - finished
.
          UNPACK    NEWKEY19,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          CALL      UPWTSUS1
          GOTO      WSUS0500
.
WSUS9000  CLOSE     WATSUSA1
.
WSUS9999  RETURN
+
.====================================================================== 
. PROC RUSERR00 : Change U/R for RUSERRFD
.====================================================================== 
.
.          DEFPROC   RUSERR00
.
.          INC       RUSERRFD/INC
.
.SAVKEY23  DIM       23
.
.          MOVE      ZERO,OVRCD
.          TRAP      OVERCOND IF IO
.          OPEN      RUSERRA1,"ruserraf"
.          TRAPCLR   IO
.          BRANCH    OVRCD,RUSERR99           * file not found
..
.          MOVE      "ruserraf",XXFILE
.          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
..
.          DISPLAY   *P30:24,*EL,"RUS Error for : ",*V2LON,OLDURNO;
.
..          PACK      KEY23,SP20,SP10
.RUSERR15  CALL      RSRSERR1
.RUSERR20  CALL      RKRSERR1
.          BRANCH    OVRCD,RUSERR90
.          MATCH     OLDURNO,RSERURNO
.          GOTO      RUSERR20 IF NOT EQUAL    * no index on U/R so loop over
..                                              all records
..
.          PACK      SAVKEY23,RSERDATE,RSERDEPT,RSERURNO,RSERPTYP
.          MOVE      NEWURNO,RSERURNO
.          CALL      UPRSERR1
.          MOVE      SAVKEY23,KEY23
.          GOTO      RUSERR15
..
.RUSERR90  CLOSE     RUSERRA1
.          GOTO      RUSERR99
.
.          INC       IBAOVRIO/INC
.          INC       RUSERRIO/INC
..
.RUSERR99  ENDPROC
+
.**********************************************************************
.*                            TRCK0000                                *
.*              Update Medical Records Tracking File                  *
.**********************************************************************
.
TRCK0000  BRANCH    NOTRK,TRCK9999
          DISPLAY   *P1:24,*EL,*P30:24,"Fixing Medical Records Tracking";
          MOVE      OLDURNO,PVIURNO
.
.       Update the tracking master file
.
          CALL      TMAS0000
TRCK9999  RETURN
+
.**********************************************************************
.*                            TMAS0000                                *
.*            Update Medical Records Tracking Master File             *
.**********************************************************************
.
TMAS0000  OPEN      MRTMASA1,"mrtmasaf"
.
TMAS1000  PACK      KEY17 WITH PVIURNO,SP10
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD OF TMAS9999
.
          MATCH     MRMAURNO,PVIURNO
          GOTO      TMAS9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MRMAURNO
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          CALL      UPMRMAS1
.
          GOTO      TMAS1000
TMAS9999  CLOSE     MRTMASA1
          RETURN
+
.**********************************************************************
.*                            MAMM0000                                *
.*                    Update Mammography Files                        *
.**********************************************************************
.
MAMM0000  BRANCH    NOMAM,MAMM9999
          DISPLAY   *P1:24,*EL,*P30:24,"Fixing Mammography";
          MOVE      OLDURNO,PVIURNO
.
.       Update the Mammography file
.
          CALL      MTES0000
.
MAMM9999  RETURN
+
.**********************************************************************
.*                            MTES0000                                *
.*              Update Mammography Test Results File                  *
.**********************************************************************
.
MTES0000  OPEN      MAMTEST1,"mamtestf"
          MOVE      "mamtestf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
MTES1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY18 WITH PVIURNO,SP30
          CALL      RDSTES1
          CALL      RDKTES1
          BRANCH    OVRCD OF MTES9999
.
          MATCH     PVIURNO,MMURNO
          GOTO      MTES9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MMURNO
          CALL      UPTES1
          GOTO      MTES1000
MTES9999  CLOSE     MAMTEST1
          RETURN
+
.**********************************************************************
.*                            RUSS0000                                *
.*                       Update RUS Files                             *
.**********************************************************************
.
.RUSS0000  BRANCH    NORUS,RUSS9999
.
.          DISPLAY   *P1:24,*EL,*P30:24,"Fixing RUS Files";
.          MOVE      OLDURNO,PVIURNO
.
.       Update the RUS files
.
.          CALL      RUTL0000
.
.RUSS9999  RETURN
+
.**********************************************************************
.*                            RUTL0000                                *
.*                Update RUS patient details File                     *
.**********************************************************************
.
.RUTL0000  OPEN      RUSUTLL1,"rusutlaf"
.          OPEN      RUSUTLL3,"rusutlaf"
.
.          MOVE      "rusutlaf",XXFILE
.          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
.          PACK      KEY34,PVIBILL,SP30
.          CALL      RSRSUTL3
.RUTL1000  CALL      RKRSUTL3
.          BRANCH    OVRCD,RUTL9999
.
.          MATCH     RSUTEVNT,PVIBILL
.          GOTO      RUTL9999 IF NOT EQUAL
.
.          MOVE      RSUTQUNT,SAVQNTY
.          PACK      SAVKEY34,RSUTDATE,RSUTDEPT,RSUTEVNT,RSUTPROC,RSUTURNO
.          PACK      KEY34,RSUTDATE,RSUTDEPT,RSUTEVNT,RSUTPROC,NEWURNO
.          CALL      RDRSUTL1
.          IF        OVRCD = 1
.
..           Change U/R number on old record
.
.            MOVE      SAVKEY34,KEY34
.            CALL      RDRSUTL1
.            BRANCH    OVRCD,RUTL1000
.            MOVE      NEWURNO,RSUTURNO
.            CALL      UPRSUTL1
.          ELSE
..
..           Add quantites for the two records
..
.            ADD       SAVQNTY,RSUTQUNT
.            CALL      UPRSUTL1
.            MATCH     KEY34,SAVKEY34
.            IF        !@EQUAL
.              MOVE      SAVKEY34,KEY34
.              CALL      DERSUTL1
.            ENDIF
.          ENDIF
.          PACK      KEY34,RSUTEVNT,RSUTDATE,RSUTDEPT,OLDURNO,RSUTPROC
.          CALL      RSRSUTL3
.          GOTO      RUTL1000
.
.RUTL9999  CLOSE     RUSUTLL1
.          CLOSE     RUSUTLL3
.          RETURN
+
.**********************************************************************
.*                            RCPD0000                                *
.*                  Update Receipting Details File                    *
.**********************************************************************
.
RCPD0000  BRANCH    NORCP,RCPD9999
.
          OPEN      RCPDTEA5,"rcpdteaf"
.
          MOVE      "rcpdteaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          PACK      KEY25,OLDURNO,SP20
          CALL      RSRCDTE5                * position in file
RCPD1000  CALL      RKRCDTE5                * read next record
          BRANCH    OVRCD,RCPD9999          * end of file
.
          MATCH     RCDTURNO,OLDURNO        * same number ?
          GOTO      RCPD9999 IF NOT EQUAL   * no - ignore
.
          MATCH     " 1",RCDTSFLG           * PMI U/R number ?
          GOTO      RCPD1000 IF NOT EQUAL   * no - ignore
.
          DISPLAY   *P30:24,*EL,"Receipt : ",*V2LON,RCDTRECN,RCDTTCNT;
.
          MOVE      NEWURNO,RCDTURNO        * load new U/R number
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE5                * update record
          GOTO      RCPD1000                * get next record
.
RCPD9999  CLOSE     RCPDTEA5
          RETURN
+
.**********************************************************************
.*                            WAUD0000                                *
.*            Write a Record to UR Number Change Audit File           *
.**********************************************************************
.
WAUD0000  COMPARE   ONE,CURCHG
          RETURN    IF NOT EQUAL
.
          MOVE      "pataz1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,AZURNO
          MOVE      PURNO,AZURNN
          MOVE      PTITL,AZTITL
          MOVE      PSNAME,AZSNAM
          MOVE      PGNAME,AZGNAM
          MOVE      PADD1,AZADD1
          MOVE      PADD2,AZADD2
          MOVE      PSUBRB,AZSUBR
          MOVE      PPOST,AZPOST
          MOVE      PMEDI,AZMEDI
          MOVE      PTELEP,AZTELP
          MOVE      PSEX,AZSEX
          PACK      AZBDAT,PBDATE
          PACK      AZDATE,CCC,CYY,CMM,CDD
          REP       " 0",AZDATE
          CLOCK     TIME,AZTIME
          MOVE      PASSCODE,AZOPID
          MOVE      SECUSER,AZOPER
          CALL      UPAUDZ
          RETURN
+
.*****************************************************************************
.*                            URNC0000                                       *
.*  Write to the U/R Number Change Audit file if the system parameter is set *
.*****************************************************************************
URNC0000  COMPARE   ZERO,PTCNUURC
          GOTO      URNC9999 IF EQUAL        * System parameter not set
          OPEN      PATURCA1,"paturcaf"
.
          MOVE      "paturcaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      PVIBILL,PTURADMN         * Admission number affected
          CALL      IBACLOCK
          PACK      PTURDATE,CCC,CYY,CMM,CDD * Date of alteration
          REP       " 0",PTURDATE            * Zero fill
          MOVE      CTIMEIS,PTURTIME         * Time of alteration
          REP       " 0",PTURTIME            * Zero fill
.
          MOVE      OLDURNO,PTUROURN         * Old U/R number
.
          PACK      KEY24,PTURADMN,PTURDATE,PTURTIME
          CALL      RDAURCA1
          BRANCH    OVRCD,URNC1000
.
          CALL      RDSURCA1
          MOVE      OLDURNO,PTUROURN         * Old U/R number
          CALL      UPURCA1
          GOTO      URNC2000
.
URNC1000  CALL      WRURCA1
.
URNC2000  CLOSE     PATURCA1
.
URNC9999  RETURN
+
.**********************************************************************
.*             Episode of Care File Updation                          * 
.**********************************************************************
EOCA0000  CALL      EREF0000                * EOC Referral Details 
.
EOCA9999  RETURN
+
.**********************************************************************
.*             Episode of Care Referral File Updation                 * 
.**********************************************************************
EREF0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EOCREFA1,"eocrefaf"
          OPEN      EOCLNKA1,"eoclnkaf"                                *I-90303
          TRAPCLR   IO
          BRANCH    OVRCD,EREF9999
.
          MOVE      "eocrefaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
EREF1000  MOVE      OLDURNO,PVIURNO                        * add label *C-90306
          PACK      KEY13,PVIURNO,SP30
          CALL      RSECREF1
EREF1500  CALL      RKECREF1                            * was EREF1000 *C-90306
          BRANCH    OVRCD,EREF9000          * end-of-file
.
          MATCH     PVIURNO,ECRFURNO
          GOTO      EREF9000 IF NOT EQUAL   * end-of-URno
.
          PACK      OLDKEY13,ECRFURNO,DECRFEPN,SP30                    *C-90303
.                                           * see if New UR eocref exists
          PACK      KEY13,NEWURNO,DECRFEPN,SP30                        *C-90303
          CALL      RDECREF1
          BRANCH    OVRCD,EREF5000          * not a duplicate - update Old UR
.
.
. ***************** EOC Reference records needing new "Episode of Care" number
.                                           * duplicate will occur - find a new
.                                           * unique ECRFURNO/DECRFEPN combo
          MOVE      ECRFEPNO,FORM5
EREF2000  ADD       ONE,FORM5
          MOVE      FORM5,NEWEPNO                                      *C-45774
          PACK      KEY13,NEWURNO,NEWEPNO,SP30                         *C-45774
          CALL      RDECREF1
          BRANCH    OVRCD,EREF3000          * found a unique DECRFEPN
.
          GOTO      EREF2000                * try next Episode No (EPNO)
.
EREF3000  MOVE      OLDKEY13,KEY13          * re-read Old UR eocref
          CALL      RDECREF1
.
.....     MOVE      FORM5,NEWEPNO           * store new DECRFEPN for LNK (Done)
          CALL      ELNK0000                * process matching "eolnkaf" recds.
.
EREF4000  MOVE      NEWURNO,ECRFURNO
          MOVE      NEWEPNO,ECRFEPNO        * insert unique ECRFEPNO   *I-90303
          CALL      UPECREF1                * re-write the "eocrefaf"
          GOTO      EREF1000
.
.
. ***************** EOC Reference records with no change of "Episode of Care"
.
EREF5000  MOVE      OLDKEY13,KEY13          * restore Old UR key
          CALL      RDECREF1                * re-read Old UR eocref
          BRANCH    OVRCD,EREF1000
.
          MOVE      DECRFEPN,NEWEPNO        * store old DECRFEPN as new*I-45774
          CALL      ELNK0000                * process "eolnkaf" recds. *I-45774
.
          MOVE      NEWURNO,ECRFURNO        * insert new UR number
          CALL      UPECREF1                * update "eocrefaf"
.
          GOTO      EREF1000
.
EREF9000  CLOSE     EOCREFA1
          CLOSE     EOCLNKA1                                           *I-45774
.
EREF9999  RETURN
+
.**********************************************************************
.*             Episode of Care Link Table Updation                    * 
.**********************************************************************
ELNK0000  MOVE      ZERO,OVRCD
          MOVE      "eoclnkaf",XXFILE                                  *I-45774
.
.                                           * Old UR "eocrefaf" record is in IOA
ELNK1000  PACK      KEY23,ECRFURNO,DECRFEPN,DECRFHOS,SP30
          CALL      RSECLNK1
ELNK1500  CALL      RKECLNK1
          BRANCH    OVRCD,ELNK9000
.
          PACK      SAVKEY23,ECLNURNO,DECLNEPN,DECLNHOS,SP30           *I-45774
          MATCH     KEY23,SAVKEY23                                     *I-45774
          GOTO      ELNK9000 IF NOT EQUAL                              *I-45774
.
          MOVE      NEWURNO,ECLNURNO        * insert new UR
          MOVE      NEWEPNO,ECLNEPNO        * insert new "Episode No"  *I-45774
          MOVE      NEWEPNO,DECLNEPN                                   *I-45774
          CALL      UPECLNK1
          GOTO      ELNK1000
.
ELNK9000  MOVE      "eocrefaf",XXFILE                                  *I-45774
.
ELNK9999  RETURN
.**********************************************************************
.*             Fix patwc1af                                           *
.**********************************************************************
          DEFPROC   FIXWC1
.         
          INC       PATWC1FD/INC
.         
FIXC0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATWC1A2,"patwc1af"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDWC1
.
          MOVE      "patwc1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXC1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY16,PVIURNO,SP30
          CALL      RDSWCOM2
          CALL      RDKWCOM2
          BRANCH    OVRCD,FIXC9000
.
          MATCH     PVIURNO,PTWCURNO
          GOTO      FIXC9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTWCURNO
          CALL      UPWCOM2
          GOTO      FIXC1000
.
FIXC9000  CLOSE     PATWC1A2
          GOTO      ENDWC1
.
          INC       IBAOVRIO/INC
          INC       PATWC1IO/INC
.
ENDWC1    ENDPROC
+
.**********************************************************************
.*             Fix patwmabf                                           *
.**********************************************************************
          DEFPROC   FIXWMA
.
          INC       PATWMAFD/INC
.
FIXM0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATWMAB2,"patwmabf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDWMA
.
          MOVE      "patwmabf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXM1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY16,PVIURNO,SP30
          CALL      RDSWMAB2
          CALL      RDKWMAB2
          BRANCH    OVRCD,FIXM9000
.
          MATCH     PVIURNO,PTWMURNO
          GOTO      FIXM9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTWMURNO
          CALL      UPWMAB2
          GOTO      FIXM1000
.
FIXM9000  CLOSE     PATWMAB2
          GOTO      ENDWMA
.
          INC       IBAOVRIO/INC
          INC       PATWMAIO/INC
.
ENDWMA    ENDPROC
.
.        ================================================
.        Procedure to fix up the NZ related provider
.        invoice files
.        ================================================
.
          DEFPROC   FIXREL
.
          INC       NZPPICFD/INC
          INC       NZPRPIFD/INC
          INC       NZPAPIFD/INC
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NZPPICA1,"nzppicaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          TRAP      OVERCOND IF IO
          OPEN      NZPRPIA1,"nzprpiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          TRAP      OVERCOND IF IO
          OPEN      NZPAPIA1,"nzpapiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          PACK      KEY22,DPVIBILL,SP70
          CALL      RSNZPIC1
FXREL100  CALL      RKNZPIC1
          BRANCH    OVRCD,FXREL500
.
          MATCH     DPVIBILL,NZPIADMN
          GOTO      FXREL500 IF NOT EQUAL
.
          MOVE      NEWURNO,NZPIURNO
.
          CALL      UPNZPIC1
          GOTO      FXREL100
.
FXREL500  PACK      KEY36,DPVIBILL,SP70
          CALL      RSNZRPI1
FXREL550  CALL      RKNZRPI1
          BRANCH    OVRCD,FXREL999
.
          MATCH     DPVIBILL,NZRPADMN
          GOTO      FXREL999 IF NOT EQUAL
.
          PACK      KEY8,NZRPRPIS,SP70
          CALL      RDNZAPI1
          IF        OVRCD=0
            MOVE      NEWURNO,NZAPURNO
            CALL      UPNZAPI1
          ENDIF
.
          GOTO      FXREL550
.
          INC       IBAOVRIO/INC
          INC       NZPPICIO/INC
          INC       NZPRPIIO/INC
          INC       NZPAPIIO/INC

FXREL999  CLOSE     NZPPICA1
          CLOSE     NZPRPIA1
          CLOSE     NZPAPIA1
          ENDPROC
+
.       =================================================================
.       Subroutine to change U/R number in the Alternate Legacy File
.       =================================================================
.
FIXALLEG  MOVE      ZERO,OVRCD
          MOVE      ZERO,F1
          TRAP      OVERCOND IF IO
          OPEN      LEGALTA1,"legaltaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDALLEG
.
NXTALLEG  PACK      KEY32,OLDURNO,SP70
          CALL      RSLGALT1
          CALL      RKLGALT1
          BRANCH    OVRCD,CLSALLEG
.
          MATCH     OLDURNO,LGATURNO
          GOTO      CLSALLEG IF NOT EQUAL
          MOVE      ONE,F1
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LGATURNO
          CALL      UPLGALT1
          GOTO      NXTALLEG
.
CLSALLEG  CLOSE     LEGALTA1
.
.         Make sure that the legacy visit flag (patmx1af.ptmxsin5) is set
.         for the new U/R
.
          IF        F1=0
            GOTO     ENDALLEG
          ENDIF
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ENDLGVIS
.
          MATCH     "1",PTMXSIN5
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN5
            CALL      UPMAST1
          ENDIF
.
.
ENDALLEG  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Visit File
.       =================================================================
.
FIXLGVIS  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGVISA2,"legvisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGVIS
.
.         Initialise legacy visit record flag for no records found for U/R
.
          MOVE      ONE,LEGCFLAG
.
NXTLGVIS  PACK      KEY24,OLDURNO,SP70
          CALL      RSLGVIS2
          CALL      RKLGVIS2
          BRANCH    OVRCD,CLSLGVIS
.
          MATCH     OLDURNO,LVIURNO
          GOTO      CLSLGVIS IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LVIURNO
          CALL      UPLGVIS2
          MOVE      ZERO,LEGCFLAG                * legacy visit records found
          GOTO      NXTLGVIS
.
CLSLGVIS  CLOSE     LEGVISA2
.
          BRANCH    LEGCFLAG,ENDLGVIS            * no legacy visit records
.
.         Fix all the other related legacy tables
.
          CALL      FIXLGBOA                     * Change U/R for legbokaf
          CALL      FIXLGDEA                     * Change U/R for legdetaf
          CALL      FIXLGDSC                     * Change U/R for legdschf
          CALL      FIXLGINV                     * Change U/R for leginvrf
          CALL      FIXLGMIS                     * Change U/R for legmissf
          CALL      FIXLGTRN                     * Change U/R for legtranf
.
.         Make sure that the legacy visit flag (patmx1af.ptmxsin5) is set
.         for the new U/R
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ENDLGVIS
.
          MATCH     "1",PTMXSIN5
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN5
            CALL      UPMAST1
          ENDIF
.
ENDLGVIS  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy O/P Booking A File
.       =================================================================
.
FIXLGBOA  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGBOKA3,"legbokaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGBOA
.
NXTLGBOA  PACK      KEY36,OLDURNO,SP70
          CALL      RSLGBOA3
          CALL      RKLGBOA3
          BRANCH    OVRCD,CLSLGBOA
.
          MATCH     OLDURNO,DLOBAURN
          GOTO      CLSLGBOA IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LOBAURNO
          CALL      UPLGBOA3
          GOTO      NXTLGBOA
.
CLSLGBOA  CLOSE     LEGBOKA3
.
ENDLGBOA  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy A&E Detail File
.       =================================================================
.
FIXLGDEA  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGDETA2,"legdetaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGDEA
.
NXTLGDEA  PACK      KEY16,OLDURNO,SP70
          CALL      RSLGDEA2
          CALL      RKLGDEA2
          BRANCH    OVRCD,CLSLGDEA
.
          MATCH     OLDURNO,DLADAURN
          GOTO      CLSLGDEA IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LADAURNO
          CALL      UPLGDEA2
          GOTO      NXTLGDEA
.
CLSLGDEA  CLOSE     LEGDETA2
.
ENDLGDEA  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Discharge File
.       =================================================================
.
FIXLGDSC  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGDSCH3,"legdschf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGDSC
.
NXTLGDSC  PACK      KEY16,OLDURNO,SP70
          CALL      RSLGDSC3
          CALL      RKLGDSC3
          BRANCH    OVRCD,CLSLGDSC
.
          MATCH     OLDURNO,LDDURNO
          GOTO      CLSLGDSC IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LDURNO
          CALL      UPLGDSC3
          GOTO      NXTLGDSC
.
CLSLGDSC  CLOSE     LEGDSCH3
.
ENDLGDSC  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Invoice File
.       =================================================================
.
FIXLGINV  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGINVR5,"leginvrf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGINV
.
NXTLGINV  PACK      KEY32,OLDURNO,SP70
          CALL      RSLGINV5
          CALL      RKLGINV5
          BRANCH    OVRCD,CLSLGINV
.
          MATCH     OLDURNO,LDPINVUR
          GOTO      CLSLGINV IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LPINVUR
          CALL      UPLGINV5
          GOTO      NXTLGINV
.
CLSLGINV  CLOSE     LEGINVR5
.
ENDLGINV  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Admission File
.       =================================================================
.
FIXLGMIS  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGMISS6,"legmissf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGMIS
.
NXTLGMIS  PACK      KEY16,OLDURNO,SP70
          CALL      RSLGMIS6
          CALL      RKLGMIS6
          BRANCH    OVRCD,CLSLGMIS
.
          MATCH     OLDURNO,LAURNO
          GOTO      CLSLGMIS IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LAURNO
          CALL      UPLGMIS6
          GOTO      NXTLGMIS
.
CLSLGMIS  CLOSE     LEGMISS6
.
ENDLGMIS  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Transfer File
.       =================================================================
.
FIXLGTRN  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGTRAN5,"legtranf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGTRN
.
NXTLGTRN  PACK      KEY38,OLDURNO,SP70
          CALL      RSLGTRN5
          CALL      RKLGTRN5
          BRANCH    OVRCD,CLSLGTRN
.
          MATCH     OLDURNO,LDTURNO
          GOTO      CLSLGTRN IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LTURNO
          CALL      UPLGTRN5
          GOTO      NXTLGTRN
.
CLSLGTRN  CLOSE     LEGTRAN5
.
ENDLGTRN  RETURN
+
.        =========================================
.        Procedure to fix up the alternate ID file
.        =========================================
.
          DEFPROC   FIXAID
.
          INC       PMSAIDFD/INC
.
          OPEN      PMSAIDA1,"pmsaidaf"
.
RADAID    PACK      KEY31,OLDURNO,SP10
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,ENDAID
.
          MATCH     OLDURNO,PMAIURNO
          GOTO      ENDAID IF NOT EQUAL
.
          PACK      KEY31,NEWURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1                    * read into ans;
          BRANCH    OVRCD,UPDAID                * new u/r not on file, go update
          CALL      DEPMAID1                    * delete new u/r no.
.
UPDAID    PACK      KEY31,OLDURNO,PMAITYPE,PMAIALID     * read old record
          CALL      RDPMAID1                          * full read
          MOVE      NEWURNO,PMAIURNO                  * move new u/r to old u/r
          MOVE      USERID,PMAIUPUD
          CALL      IBACLOCK
          PACK      PMAIUPDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIUPDT
          MOVE      CTIMEIS,PMAIUPTM
          CALL      UPPMAID1                          * update record
.
          GOTO      RADAID
.
          INC       IBAOVRIO/INC
          INC       PMSAIDIO/INC
.
ENDAID    CLOSE     PMSAIDA1
          ENDPROC
.
.        =========================================
.        Update outstanding debt indicators as required
.        =========================================
.         Make sure that the outstanding debts are set for the new U/R -
.         (pmspx2af.pmpxsn12, pmpxsn13, pmpxsn14 & pmpxsn15 and "patdetaf")
.
ODEBT000  MOVE      ZERO,OVRCD
          UNPACK    SP70,SVSN12,SVSN13,SVSN14,SVSN15
          DISPLAY   *P64:24,"patdetaf"
          OPEN      PATDETA2,"patdetaf"
.         
ODEBT100  PACK      KEY17,OLDURNO,SP70
          CALL      RSPTDET2
ODEBT200  CALL      RKPTDET2
          BRANCH    OVRCD,ODEBT400
.
          MATCH     OLDURNO,PTDEURNO
          GOTO      ODEBT400 IF NOT EQUAL
.
          MOVE      PTDETYPE,FORM1
          MATCH     SP8,PTDEDTCL            * is debt still active ?
          IF        @EQUAL
            STORE     "1",FORM1,SVSN12,SVSN13,SVSN14,SVSN13   * debt active
          ENDIF
.
          MOVE      NEWURNO,PTDEURNO
          CALL      UPPTDET2
          GOTO      ODEBT100
.
.
ODEBT400  PACK      KEY8,OLDURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ODEBT999
.
          MOVE      PMPXSN15,SVSN15         * save BAD DEBT indicator
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ODEBT999
.
          MOVE      "0",KEY1
          MATCH     "1",SVSN12
          IF        @EQUAL
            MOVE      "1",PMPXSN12
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN13
          IF        @EQUAL
            MOVE      "1",PMPXSN13
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN14
          IF        @EQUAL
            MOVE      "1",PMPXSN14
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN15
          IF        @EQUAL
            MOVE      "1",PMPXSN15
            MOVE      "1",KEY1
          ENDIF
.
          MATCH     "1",KEY1
          IF        @EQUAL
            CALL      UPPMPX21
          ENDIF
.
ODEBT999  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the A/Health Loan Details File
.       =================================================================
.
FIXLON    MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLLONA1,"alllonaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLON
.
NXTLON    PACK      KEY16,OLDURNO,SP70
          CALL      RSALLON1                    * check old U/R for loans
          CALL      RKALLON1
          BRANCH    OVRCD,CLSLON
.
          MATCH     OLDURNO,ALLOURNO              * correct U/R
          GOTO      CLSLON IF NOT EQUAL
.
          PACK      SAVKEY16,ALLOURNO,ALLOLOAN,SP70   * save original loan key
          MOVE      ONE,FORM8
          MOVE      ALLOLOAN,FORM8              * save loan number
.
RDDLON    PACK      KEY16,NEWURNO,FORM8,SP70
          CALL      RAALLON1                    * read into ans;
          BRANCH    OVRCD,UPDLON                * new u/r not on file, go update
.
          ADD       ONE,FORM8                   * Add one to loan number
          GOTO      RDDLON
.
UPDLON    PACK      KEY16,SAVKEY16,SP70
          CALL      RDALLON1                    * full read of original
          BRANCH    OVRCD,CLSLON                * record
.
          MOVE      NEWURNO,ALLOURNO            * update u/r
          MOVE      FORM8,ALLOLOAN              * updale loan number
.
          CALL      UPALLON1                    * update record
.
          CALL      FLCM0000                    * Move loan comments
.
          GOTO      NXTLON
.
CLSLON    CLOSE     ALLLONA1
.
ENDLON    RETURN
+
.       =================================================================
.       Change U/R number in the A/H Equipment Loan Comments File
.       Required SAVKEY16 = Old U/R and Old Loan Number
.       =================================================================
.
FLCM0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLEDTA1,"alledtaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FLCM9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLETXA1,"alletxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FLCM9999
.
FLCM1000  PACK      KEY25,SAVKEY16,SP70          * check for notes on the
          CALL      RSALEDT1                     * original loan number
          CALL      RKALEDT1
          BRANCH    OVRCD,FLCM9000
.
          PACK      DIM16,ALEDURNO,ALEDLOAN,SP70
          MATCH     DIM16,SAVKEY16               * are comment from the original
          GOTO      FLCM9000 IF NOT EQUAL        * loan number
.
          PACK      SAVKEY25,ALEDURNO,ALEDLOAN,ALEDTYPE,ALEDNOTE,SP70
.
          PACK      KEY25,ALLOURNO,ALLOLOAN,ALEDTYPE,ALEDNOTE,SP70
          CALL      RAALEDT1                     * does new record exits
          COMPARE   ONE,OVRCD
          GOTO      FLCM9000 IF NOT EQUAL
.
          PACK      KEY25,SAVKEY25,SP70
          CALL      RDALEDT1                     * re Read original record
          BRANCH    OVRCD,FLCM9000
.
          MOVE      ALLOURNO,ALEDURNO            * update U/R
          MOVE      ALLOLOAN,ALEDLOAN            * update loan number
.
          CALL      UPALEDT1
.
FLCM5000  PACK      KEY28,SAVKEY16,ALEDTYPE,SP70 * check for notes lines on the
          CALL      RSALETX1                     * original loan number and
          CALL      RKALETX1                     * note type
          BRANCH    OVRCD,FLCM1000
.
          PACK      DIM16,ALETURNO,ALETLOAN,SP70
          MATCH     DIM16,SAVKEY16               * are comment from the original
          GOTO      FLCM1000 IF NOT EQUAL        * loan number
.
          MATCH     ALEDTYPE,ALETTYPE            * correct note type
          GOTO      FLCM1000 IF NOT EQUAL
.
          MATCH     ALEDNOTE,ALETNOTE            * correct note number
          GOTO      FLCM1000 IF NOT EQUAL
.
          PACK      SAVKEY28,ALETURNO,ALETLOAN:
                             ALETTYPE,ALETNOTE,ALETUNIQ,SP70
.
          PACK      KEY28,ALEDURNO,ALEDLOAN:
                          ALETTYPE,ALETNOTE,ALETUNIQ,SP70
          CALL      RAALETX1                     * does new record exits
          COMPARE   ONE,OVRCD
          GOTO      FLCM1000 IF NOT EQUAL
.
          PACK      KEY28,SAVKEY28,SP70
          CALL      RDALETX1                     * re Read original record
          BRANCH    OVRCD,FLCM1000
.
          MOVE      ALEDURNO,ALETURNO            * update U/R
          MOVE      ALEDLOAN,ALETLOAN            * update loan number
.
          CALL      UPALETX1
.
          GOTO      FLCM5000
.
FLCM9000  CLOSE     ALLEDTA1
          CLOSE     ALLETXA1
.
FLCM9999  RETURN
+	
.**********************************************************************
.*              I/O INCLUDES FOR FILES AND GENERAL ROUTINES           *
.**********************************************************************
          INC       STD002IO
          INC       AAEDE1IO/INC
          INC       ALLEDTIO/INC
          INC       ALLETXIO/INC
          INC       ALLLONIO/INC
          INC       ALLREFIO/INC
          INC       ALLPCTIO/INC                                      *I-236586
          INC       BOKRC1IO/INC
          INC       OPRDEAIO/INC
          INC       EMRVISIO/INC
          INC       LEGALTIO/INC       * Alternate Legacy file
          INC       LEGBOAIO/INC
          INC       LEGDEAIO/INC
          INC       LEGDSCIO/INC
          INC       LEGINVIO/INC
          INC       LEGMISIO/INC
          INC       LEGTRNIO/INC
          INC       LEGVISIO/INC
          INC       MAMTESIO/INC
.         INC       MRGURNSM
          INC       MRGURCCS                * Clinical Costing Interface
          INC       MRGURCCI                * Clinical Costing Interface
          INC       MRGURCMH                * Community Health
          INC       MRGURPRI                * Change U/R for Private Practice
          INC       MRGURWEB                * WEB 
          INC       MRGURRES
          INC       PMSOSDTM
          INC       HICCLMIO/INC
          INC       MRTMASIO/INC
          INC       OUTCANIO/INC
          INC       OUTBOAIO/INC
          INC       OUTSITIO/INC
          INC       OUTRF1IO/INC
          INC       PATAZ1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       NZPRDTIO/INC
          INC       PATINVIO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATDETIO/INC
          INC       MEHVI1IO/INC
          INC       MEHMDTIO/INC
          INC       MEHHLSIO/INC
          INC       MEHDLSIO/INC
          INC       MEHMTXIO/INC
          INC       MEHSCRIO/INC
          INC       MEHPCSIO/INC
          INC       MEHPLSIO/INC
          INC       MEHPATIO/INC
          INC       MEHPCOIO/INC
          INC       MEHPCNIO/INC
          INC       MEHPRDIO/INC
          INC       MEHPOIIO/INC
          INC       PATMI1IO/INC
          INC       PMSVX1IO/INC
          INC       PATPA1IO/INC
          INC       PATPR1IO/INC
          INC       PATGSRIO/INC
          INC       PATTRNIO/INC
          INC       PATURAIO/INC
          INC       PATVISIO/INC
          INC       PATURCIO/INC             * U/R No. change audit file
          INC       RCPDTEIO/INC
.          INC       RUSUTLIO/INC
          INC       WATCATIO/INC
          INC       WATCHAIO/INC
          INC       WATLHIIO/INC
          INC       WATMESIO/INC
          INC       WATPACIO/INC
          INC       WATPNPIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATSUSIO/INC
          INC       EOCLNKIO/INC            * EOC Link Table
          INC       EOCREFIO/INC            * EOC Referral File
          INC       OUTHISIO/INC            * Outpatient History File
          INC       OPRHISIO/INC            * Theatre History File
          INC       OUTARTIO/INC
          INC       OUTBITIO/INC
          INC       OUTUATIO/INC            * Outpatient Un-Attendance File
          INC       PATALRIO/INC            * Patient Alerts File
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCSLIO/INC            * Patient Record Location
          INC       PATKWCIO/INC            * Kiwicard Details
          INC       PATVCHIO/INC            * Visit Count Change Audit
          INC       PATLUEIO/INC            * Last U/R Entered
          INC       PATIMMIO/INC            * Immunisation Details 
          INC       PATDNRIO/INC            * Donor Information
          INC       PATNADIO/INC            * Need Assessment Details
          INC       PMSMTIIO/INC            * Misc.theatre item file
          INC       PMSALNIO/INC
          INC       PMSCURIO/INC
          INC       PMSFEDIO/INC            * Fees Estimation Details
          INC       PMSFESIO/INC            * Fees Estimation Table
          INC       PMSPRBIO/INC            * Patient Problem Master Table
          INC       PATATRIO/INC            * Patient Attribute Details
          INC       WATHISIO/INC            * Waiting list history file
          INC       WATRTDIO/INC            * Referral & Transfer Dest.
          INC       RESCLNIO/INC
          INC       RESDEAIO/INC            * Clinical Results Details
          INC       RESLURIO/INC            * Link Results by U/R
          INC       RESHEAIO/INC            * Clinical Results Header Table
          INC       RESLNKIO/INC            * Clinical Results Linking Table
          INC       RESPHRIO/INC            * CR PIT Format Results Header
          INC       PATCODIO/INC            
          INC       CLPMSPX2

..........................................................................
