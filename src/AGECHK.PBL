.
.           RE-CALCULATES PATIENTS AGE...(VAR INC IS PATAGE)
.
.Mods:
.                              06/10/1998  Glenn Berry      5.07 changes
.                    V5.08.B01 10/01/2000  Steve Downing    SRF 636966
.                              Set PSAGE to 999 if age >=1000 error occurs
.                    V5.08.02  07/06/2001  Steve Armstrong
.                              Changed use of CCC/CYY to CC/YY as deceased
.                              patients would always use current date instead
.                              of DOD to calculate age (at SUBYRS)
.
.
AGECHK  MOVE            ZERO,PSAGE
.
.        CALCULATE THE JULIAN BIRTH DAY
.
        MOVE            ZERO TO OVRCD
        MOVE            IDAY TO DD  * SET UP BIRTH DATE
        MOVE            IMON TO MM  * AS INPUT 
        MOVE            IYEAR TO YY  * TO 'DMYCON'.
        MOVE            ICENT TO CC  
        CALL            DMYCON
.
        MOVE            JULDAY TO BJDAY   * SAVE JULIAN BIRTH DAY
.
.       CALCULATE TODAYS TODAYS JULIAN DAY
. ----- or the date of death if the patient has died ------------------------
.
        IF          PCEASE=1
          UNPACK      PDECDTE,CCENT,CYEAR,CMON,CDAY    
          MOVE        CDAY,DD
          MOVE        CMON,MM
          MOVE        CYEAR,YY
          MOVE        CCENT,CC
        ELSE
          MOVE        CDD TO DD  * SET UP CURRENT DATE
          MOVE        CMM TO MM  * AS INPUT 
          MOVE        CYY TO YY  * TO 'DMYCON'.
          MOVE        CCC TO CC
        ENDIF
        MOVE            ZERO TO OVRCD
        CALL            DMYCON
.
        MOVE            JULDAY TO CJDAY   * SAVE TODAYS JULIAN DAY
.
        COMPARE         BJDAY,CJDAY
        GOTO            SUBYRS IF NOT LESS
.
.       CURRENT DAY IS LESS THAN BIRTH DAY
.         THERFORE WE MUST SUB 1 FROM PSAGE
.        (IE ADD 1 IYEAR WHICH THEN GETS SUBTRACTED AWAY)
.
        COMPARE         "99",IYEAR
        GOTO            SUBYRS IF EQUAL
.
        ADD             "1",IYEAR
.
.       Calculate correct century first
.
SUBYRS  MOVE            CC,PSAGE
        UNPACK          PBDATE,CCENT,CYEAR,CMON,CDAY
        MOVE            CCENT,FORM2
        SUB             FORM2,PSAGE
        MULT            "100",PSAGE
.
        GOTO            CENTERR IF OVER  * Wrong century entered eg 0998 not
.                                         1998 Normally OK but if combined with
.                                         other errors can result in invalid age
        ADD             YY,PSAGE
        SUB             IYEAR,PSAGE
        GOTO            CENTOK
.
CENTERR MOVE            "999",PSAGE       * Put in 999 for age if this occurs
.
CENTOK  COMPARE         ZERO,PSAGE
        GOTO            DATEND IF EQUAL
        GOTO            DATEND IF NOT LESS
.
.      NEGATIVE YEARS MEANS LAST CENTURY
.
        ADD             "100",PSAGE
.
DATEND  MOVE            ONE,CHG
.
.        DISPLAY         *P1:24,*EL,*B,"BJDAY IS ",BJDAY,"* CJDAY IS ",CJDAY:
.                        "* BYEAR IS ",IYEAR,"* CYY IS ",CYY:
.                        "* PATIENTS AGE IS ",PSAGE,*W9
.
         RETURN
