.----------------------------------------------------------------------
. Program       : WATWEB04
.
. Function      : Waiting List History/NBRS server/ESIS 
.
. Modifications : 
.
.----------------------------------------------------------------------
. V12.00.02 07/07/2025  Don Nguyen     TSK 0961623
.           Replaced CLRWTESE with CLWATESE (new include) to fix a bug with the
.           'Add Episode' screen loading the previous record's value for
.           'Referred From'.
. V12.00.01 23/05/2025  Ebon Clements   TSK 0955096
.           Alphanumeric visit number changes
. V11.05.04 06.03.2025 DA Sarkies      TSK 0955909
.           Recomplied for watespaf
. V11.05.03 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.02 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.01 25/11/2024  Ebon Clements  TSK 0953786
.           Added identifying gender to ESIS patient details watespaf WATESP00
. V11.04.01 22/07/2024  Ebon Clements    TSK 0949093
.           Added WATEE016 date referral accepted cgi
. V11.03.02 10/08/2023  Nikitha B        TSK 0935669
.           Added WTEEPTWT,WTEESGID and WTEERADT at CLRWTESE
. V11.03.01 03.04.2023  DA Sarkies       TSK 0928366
.           Added Treating Campus field   
.----------------------------------------------------------------------
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.00.02 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 19/03/2020  Peter Vela     Task 0889143
.           Recompiled for WATLETFD
. V10.13.01 11/01/2019  Thanh Tieu     TSK 0863964
.           Recompiled as WATTRETM changed
.----------------------------------------------------------------------
. V10.11.04 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.03 03/10/2017  Jill Parkinson TSK 0845907
.           Stopped setting of wteemanu on update
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.03 27/06/2017  Ebon Clements  TSK 0819303
.           Added WL history unique count to TABROW00
. V10.10.02 30/05/2017  Thanh T.          TSK 0838766
.           recompiled for WATTRETM
. V10.10.01 22/05/2017  Thanh T.          TSK 0825240
.           Added Days Not Ready for surgery for Patient and Clinical
. V10.09.02 27/02/2017  Jill Parkinson    TSK 0321194
.           Changed to use opdadate of first procedure as Date of Exit
. V10.09.01 14/12/2016  Jill Parkinson    TSK 0830360
.           Added check for procedure codes over 500 to display red on ESIS
.           Episode list
. V10.08.03 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.02 14/04/2016  Don Nguyen     TSK 0303887
.           Modified UPWNBD00 to match Booking Status Code against WTHIBSCD.
.           Also skip check on BS Code/Date if record type not 'A'.
. V10.08.01 23/03/2016  Don Nguyen     TSK 0303887
.           Recompiled for changes to WATNBDFD - Changed indexes
.----------------------------------------------------------------------
. V10.07.03 08/03/2016  Don Nguyen     TSK 0303887
.           Modified UPWNBD00 to update all records with matching WL Book ID
. V10.07.02 02/03/2016  Don Nguyen     TSK 0303887
.           Moved update code for 'watnbdaf' in NBHIS000 to UPWNBD00
. V10.07.01 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
.----------------------------------------------------------------------
. V10.06.01 11/06/2015  Don Nguyen   CAR 303887
.           Modified NBHIS000 to also update corresponding 'watnbdaf' record
.           with User ID & date/time of update.
.----------------------------------------------------------------------
. V10.04.05 07.05.2014  Peter Vela   CAR 279020
.           Recompiled for WATTRETM
. V10.04.04 07.04.2014  Peter Vela   CAR 286158
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 26/03/2014 Sandra Barcham  CAR 294185
.           Recompiled for changes to WATTRETM
. V10.04.01 31/12/2013  Don Nguyen     CAR 294389
.           Recompiled for changes to WATLETFD & WATLETIO
.----------------------------------------------------------------------
. V10.03.09 19/08/2013  Don Nguyen     CAR 178866
.           Recompiled for changes to WATTRETM
. V10.03.08 08/08/2013  Don Nguyen     CAR 289889
.           Recompiled for changes to WATTRETM - Added WTWMPDSC to CLWATDET
. V10.03.07 28/03/2013  Patrick Adair  CAR 281132
.           Recompiled for WATTRETM new requirements
. V10.03.06 22/03/2013  Patrick Adair  CAR 281132
.           Recompiled for WATTRETM 
. V10.03.05 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.04 16/08/2012  Don Nguyen     CAR 270629
.           Recompiled for WATTRETM - Removed unnecessary field WTRB0030
. V10.03.03 15/08/2012  Don Nguyen     CAR 270629
.           Recompiled for WATTRETM - Changed output for field WTRB0030
. V10.03.02 15/08/2012  Don Nguyen     CAR 270629
.           Recompiled for WATTRETM - Added new extension field WTRB0030
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.01.02 21/07/2011 Jill Parkinson  CAR 243296
.           Added mltsecaf
. V10.01.01 04/11/2010 Davin           CAR 210842
.           Recompiled for WATTRETM - Default Change column to 'W/L Updated'
. V10.00.02 05/07/2010  Jill Parkinson CAR 225333
.           Mods to output bkreadat as Booking status date in TABROW00
. V10.00.01 23/03/2010  Jill Parkinson CAR 216781
.           Mods to output bkreadat as exit date (instead of ddate)
. V9.12.02  09/12/2009  Peter McMullen CAR 210130
.           Recompiled for WATTRETM
. V9.12.01  26/08/2009  Peter McMullen CAR 171901
.                       remove MAPCAT00 call
. V9.10.02  01/05/2008  Jill Habasque  CAR 166097
.           Added wthiassr
. V9.10.01  30/04/2008  Jill Habasque  CAR 165994
.           Added output of estimated date of birth
. V9.09.01  20/06/2007  Jill Habasque  CAR 143145
.           Removed check IF EQUAL from VALSKY and VALSUS valdate to wtsutdat
. V9.08.03  15/05/2007  Ebon Clements  CAR 140232
.           Added view esis episode and intra episode functionality
. V9.08.02  09/05/2007  Jill Habasque  CAR 139862
.           Added 23 Hour Stay
. V9.08.01  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.05.03  15/03/2006  Jill Habasque CAR 77026
.           Added VALSUS00 and VALSKY00 remote scripts
. V9.05.02  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.01  07/03/2006 Peter Vela    CAR 94221
.           Display PPP code as red if mapped ESIS code = 200 WATESE00
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.21  06/12/2005 Ebon Clements CAR 87553
.           Changed tag for WTEESREF to use parameter WTCNBRSR
.           Fixed tag for WTEEPLOS
. V9.04.20  29/11/2005 Ebon Clements CAR 86062
.           Added report 5 episode maintenance
. V9.04.19  28/11/2005 Jill Habasque CAR 86409
.           Mods to default WTEERREM to W only if blank        
. V9.04.18  11/11/2005 Jill Habasque CAR 83249
.           Changed to pack exit category with 1 instead of 0
. V9.04.17  03/10/2005  Mike Laming   CAR 52354
.           Add SHOCNSNT for WATTRETM (Show Consent data in WATWIS00)
. V9.04.16  21/09/2005  Jill Habasque CAR 76910
.           Changed WATES008 to a DIM10 to allow DELETE
. V9.04.15  15/09/2005  Ebon Clements CAR 76051
.           Added report 4 intra episode maintenance
. V9.04.14  08/09/2005  Jill Habasque CAR 75514
.           Fixed output of DELETE for set SAD records
. V9.04.13  08/09/2005  Jill Habasque CAR 75514
.           Fixed output of DELETE for set SAD records
. V9.04.12  07/09/2005  Jill Habasque CAR 71547
.           Fixed output of watesnaf records in list
. V9.04.11  19/07/2005  Jill Habasque CAR 67889
.           Added DELETE for removal reason E    
. V9.04.10  04/07/2005  Jill Habasque CAR 60914
.           Recompiled for PATCODTM              
. V9.04.09  17/06/2005  Jill Habasque CAR 61761
.           Fixed display of reason SAD changed
. V9.04.08  15/06/2005  Jill Habasque CAR 61761
.           Added output of medicare suffix
. V9.04.07  07/06/2005  Jill Habasque CAR 60165
.           Added WTEPABRG output
.           11/05/2005  Jill Habasque CAR 60914
.           Recompiled for PATCODTM - HDP selection list
. V9.04.06  01/04/2005  Jill Habasque CAR 55601
.           Added CRTDAYS 
. V9.04.05  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.04  28/02/2005 Jill Habasque CAR 58689
.           Fixed output of CPAC Tool
. V9.04.03  09/12/2004 Jill Habasque CAR 54731
.           Changed value field to display discriptions on ESIS Intra
.           Episode list
. V9.04.02  09/12/2004 Jill Habasque CAR 54731
.           Add report option 3
. V9.04.01  20/08/2004 Jill Habasque CAR 52690
.           Add output of TMPSTAT in TABROW00 and new status values
. V9.03.08  26/07/2004 Guomin Fu  CAR 51721
.         - Added ANOSEL00 to display Associate No. of Cat "WR" as Exit Category
.         - Changed MISC0300 to display either a dropdown selection list  or
.           a read-only field depends on Booking Status code is "20" or not
. V9.03.07  07/06/2004 Peter Vela     CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.06  01/04/2004  Jill Habasque CAR 48705
.           Added write of Erase and Delete records to wathisaf   
. V9.03.05  26/03/2004 Guomin Fu     CAR 44438
.           Recompiled for WATTRETM 
.           19/03/2004 Peter Vela    CAR 13038
.           Recompiled for WATTRETM
.         V9.03.04  04/03/2004 Henry Son         CAR 39528
.                   Show RFC Suspension to date on summary.
.                   Re-compile WATTRETM.
. V9.03.03  23/02/2004 Jill Habasque CAR 43319
.           Added output of WPRHAT  
. V9.03.02  11/12/2003 Peter Vela    CAR 40355
.           Recompiled for PATNAMCD
. V9.03.01  02/07/2003 Jill Habasque CAR 40660
.           Removed PATDSCTM
. V9.02.01  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
.           13/03/2003 Jill Habasque SRF 36771
.           Recompiled for WATHISTM - added Hide Record field
. V9.02.00  28/01/2003  Jill Habasque
.           Created Web Server
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       BOKRC1FD/INC
          INC       BOKDIAFD/INC
          INC       BOKRX1FD/INC
          INC       PATDO1FD/INC   * Doctor File
          INC       PATMI1FD/INC
          INC       PATHSPFD/INC
          INC       MLTSECFD/INC
          INC       PATMA1FD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       OUTSITFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATPR1FD/INC
          INC       PMSPX2FD/INC
          INC       PATFN1FD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OPRDEAFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATDSCFD/INC
          INC       WATCATFD/INC
          INC       WATHISFD/INC
          INC       WATHISTD/INC
          INC       WATLETFD/INC
          INC       WATLHIFD/INC
          INC       WATMESFD/INC
          INC       WATPACFD/INC
          INC       WATPROFD/INC
          INC       WATRTDFD/INC
          INC       WATSUSFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATESPFD/INC
          INC       WATESEFD/INC
          INC       WATESNFD/INC
          INC       WATCONFD/INC
          INC       WATNBDFD/INC       * NBRS Extract Records

.----------------------------------------------------------------------
ABRGDESC  DIM       20
ALLWFLAG  FORM      1
BATCHNUM  DIM       5        * NBRS Batch Number
BKSTDATE  DIM       8
BRSRCAT   DIM       2
CATASSGN  FORM      5
CATCHGFL  FORM      1
CLURCTDT  DIM       8
CURRDATE  DIM       8       * Current Date
CASEKEYS  DIM       19
CRTDAYS   FORM      5
DATE1     FORM      8
DATE2     FORM      8
DATE3     FORM      8
DATEFROM  DIM       12
DATETO    DIM       12
DIM3      DIM       3
DIM6      DIM       6
DISEDATE  DIM       11
DISETYPE  DIM       20
DISPBDAT  DIM       11
DISPRDAT  DIM       11
DISPREGD  DIM       11
DISPVAR1  DIM       127
DISPVAR2  DIM       127
DOCTCODE  DIM       8
DSPDATE   DIM       8
ENDDTE    DIM       8
ESTDOB    DIM       3
EXITDATE  DIM       8
FIRSTREC  FORM      1
FORM3     FORM      3 
FORM6     FORM      6
FORM8     FORM      8 
GENDDESC  DIM       20
HEALTHSP  DIM       30
HISTKEYS  DIM       30
HOSPOST   FORM      2
JULDAYST  FORM      4
JULYRST   FORM      2
JULCCST   FORM      2
LINK2PRT  FORM      1
LSNRFCRE  FORM      5
LSTDAYS   FORM      5
MBSDESC   DIM       70
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NRCDAYS   FORM      5
NRDYCODE  DIM       3
NRDYCARE  FORM      1
NRFCDAYS  FORM      5
OVERSTAT  DIM       1
PATPOST   FORM      2  
PHISTKEY  DIM       31
PRIODESC  DIM       25
PRIOSTAT  DIM       25
PRIOOVER  DIM       8
PSAGECON  DIM       3
PSAGETYP  DIM       3
RANK      FORM      6
RECCNT    FORM      3
RECORDKY  DIM       12
REMREAS   DIM       6
RESIDESC  DIM       20
RFCDAYS   FORM      5
RFCSTAT   DIM       3 
SAVLIST   DIM       3
SAVINDC3  DIM       1
SAVHRANK  FORM      6
SHOWHIDD  FORM      1
SHOCNSNT  FORM      1
SRCRDESC  DIM       25
STARTKEY  DIM       10      * Starting Key
STATCODE  DIM       1
STATDESC  DIM       20
STATUS    DIM       22
TESTDATE  DIM       8
TODAYDTE  DIM       8                                                  *I-39528
UNITPOST  FORM      2  
UNITDESC  DIM       25
UPDATETY  DIM       1
URGDAYS   FORM      5
TMPEXTCD  DIM       2
TMPSTAT   DIM       1
TODAY     DIM       8
UPDTTYPE  DIM       1       * Update Type
URRFCDAY  FORM      5
VALDDATE  DIM       8
VALDUNIQ  DIM       10
VALDWTKY  DIM       19
WATTR010  DIM       3       * Removal Reason (Category WR/BC)
WLTYCODE  DIM       1
XMEDSUF   DIM       3
XMEDNUM   DIM       11
XVALUE    DIM       25
XPREV     DIM       13
.
WATES001  DIM       9       * Unique key
WATES002  DIM       8       * Sent Date
WATES003  DIM       1       * Event Type
WATES004  DIM       8       * Event Date
WATES005  DIM       70      * Event Value
WATES006  DIM       10      * SAD Identifier
WATES007  DIM       8       * Value Date
WATES008  DIM       10      * Value Cat Code or DELETE
.
WATEE001  DIM       8       * Admission Date (CCYYMMDD)
WATEE002  DIM       4       * Destination
WATEE003  DIM       3       * Insurance Declaration (Cat CL)
WATEE004  DIM       3       * Cat XB or WMSTAY
WATEE005  DIM       9       * Principal Procedure
WATEE006  DIM       50      * PPP Description
WATEE007  DIM       3       * Reason for removal (Cat WR)
WATEE008  DIM       8       * Registration Date
WATEE009  DIM       8       * Removal Date
WATEE010  DIM       3       * Source of Referral (Cat S)
WATEE011  DIM       3       * Surgical Specialty (Cat WU)
WATEE012  DIM       9       * Previous Identifier
WATEE013  DIM       4       * Referred From
WATEE014  DIM       8       * Date Keyed
WATEE015  DIM       4       * Treating Campus
WATEE016  DIM       8       * Date referral accepted
.
WAHEAIND  FORM      1       * WAHealth indicator for WATHIS00
.
CATW1     INIT      "W1"
CATW2     INIT      "W2"
CATW3     INIT      "W3"
CATW4     INIT      "W4"
CATX5     INIT      "X5"
CATX6     INIT      "X6"
CATX7     INIT      "X7"
CATX8     INIT      "X8"
DELETE    INIT      "DELETE"
INTRAKEY  DIM        36
EPISOKEY  DIM        17
MAPT      INIT      "MAPT"
URGENCY   INIT      "Urgency"
READINS   INIT      "Readiness"
SETSAD    INIT      "Set SAD"
CHGSAD    INIT      "Reason SAD Changed"
TRANSFER  INIT      "Transferred"
SENT      INIT      "Sent  "
UNSENT    INIT      "Unsent"
ACCEPT    INIT      "Accepted"
PART      INIT      "Part of Rejected Group"
REJECTED  INIT      "Rejected"
STOPSUB   INIT      "Stopped Submission"
HR23      INIT      "23 Hour Stay"
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
WAITST09  INIT      "Cancelled Booking"
.
.----------------------------------------------------------------------
PRGID     INIT      "WATWEB04"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "WL history/NBRS Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      NBHIS000        * NBRS History List
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      DELERS00        * Add delete or erase record
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      ESIS0000
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      INTR0000        * Intra Episode Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      EPIS0000        * Episode Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      VALSUS00        * Remote script for sus error (Theatre KEY)
          GOTO      MAIN1000
.
MAIN1700  CALL      VALSKY00        * Remote script for sus error (WL Key)
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATVADA1,"patvadaf"
          OPEN      WATCATA1,"watcataf"
          OPEN      WATHISA1,"wathisaf"
          OPEN      WATLETR1,"watletrf"
          OPEN      WATLHIA1,"watlhiaf"
          OPEN      WATMESA1,"watmesaf"
          OPEN      WATPACA1,"watpacaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      WATSUSA2,"watsusaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATRTDA1,"watrtdaf"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATESPA1,"watespaf"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATESNA4,"watesnaf"
          OPEN      WATNBDA1,"watnbdaf"     * NMDS Extract Records
          OPEN      WATNBDA4,"watnbdaf"     * NMDS Extract Records
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN5;*189,CTHETR
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR,*242,WTCNUSXB
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDATETY
          MOVE      SP70,CASEKEYS
          MOVE      SP70,RECORDKY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,VALDDATE
          MOVE      Z70,VALDUNIQ
          MOVE      Z70,VALDWTKY
.... I CAR 51721
          MOVE      Z70,WATTR010
....
          CALL      CPWTHI00
.
          MOVE      Z70,WATES001
          MOVE      Z70,WATES002
          MOVE      Z70,WATES003
          MOVE      Z70,WATES004
          MOVE      Z70,WATES005
          MOVE      Z70,WATES006
          MOVE      Z70,WATES007
          MOVE      Z70,WATES008
          MOVE      Z70,INTRAKEY
          MOVE      Z70,EPISOKEY
.
          MOVE      Z70,WATEE001
          MOVE      Z70,WATEE002
          MOVE      Z70,WATEE003
          MOVE      Z70,WATEE004
          MOVE      Z70,WATEE005
          MOVE      Z70,WATEE006
          MOVE      Z70,WATEE007
          MOVE      Z70,WATEE008
          MOVE      Z70,WATEE009
          MOVE      Z70,WATEE010
          MOVE      Z70,WATEE011
          MOVE      Z70,WATEE012
          MOVE      Z70,WATEE013
          MOVE      Z70,WATEE014
          MOVE      Z70,WATEE015
          MOVE      Z70,WATEE016
.
          MOVE      SP70,BATCHNUM
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recordky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECORDKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi",QRYNAME
          IF        @EQUAL
            CALL      SPWTH000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valduniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDUNIQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdwtky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDWTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
.... I CAR 51721
          MATCH     "wattr010=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,WATTR010
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "wates",QRYNAME
          IF        @EQUAL
            CALL     SPWTS000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "intrakey=",QRYNAME
          IF        @EQUAL
            PACK     INTRAKEY,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "episokey=",QRYNAME
          IF        @EQUAL
            PACK     EPISOKEY,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "watee",QRYNAME
          IF        @EQUAL
            CALL     SPWTE000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            PACK     BATCHNUM,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. NBRS History List
.------------------------------------------------------------
NBHIS000  MOVE      ZERO,EXIT
          MOVE      SP70,EXITDATE
          MOVE      SP70,TMPEXTCD
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,NBHIS991
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      SP70,DDATE
            MOVE      SP70,DSTAT
          ENDIF
.
          MOVE      WMURNO,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,NBHIS992
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,RECORDKY
          GOTO      NBHIS900 IF EQUAL
.
          PACK      KEY31,CASEKEYS,RECORDKY,SP70
          CALL      RDWTHIS1
          BRANCH    OVRCD,NBHIS993
.
          IF        WMSTAT = 5
            CALL      GEXD0000            * get exit details
          ENDIF
.
          IF        WMSTAT = 6
            CALL      REXD0000            * exit details for removed patients
          ENDIF
.
          MATCH     ANSU,UPDATETY
          GOTO      NBHIS900 IF NOT EQUAL
.
.--- Update ---
.
.... I CAR 51721
          MATCH     Z70,WATTR010
          IF        !@EQUAL
            MATCH     SP70,WATTR010
            IF        !@EQUAL
              MOVE      WATTR010,WMREMOVE
            ENDIF
          ENDIF
          MOVE      CASEKEYS,KEY19
          CALL      UPTREA1
..... END
          CALL      MVWTHI00
          PACK      KEY31,WTHIURNO,WTHIPROC,DWTHIPCN,WTHIEDAT,DWTHIUCN,SP70 
          CALL      RAWTHIS1
          BRANCH    OVRCD,NBHIS999
          CALL      UPWTHIS1
.
          CALL      UPWNBD00      * Update record in 'watnbdaf'
          GOTO      NBHIS999
.
NBHIS900  CLEAR     WEBTITLE
          MOVE      "NBRS History",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,NBHIS999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS990  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS991  MOVE      "Invalid Case. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS992  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS993  MOVE      "Invalid history record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS994  MOVE      "Invalid NBRS record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NBHIS999
.
NBHIS999  RETURN
+
.------------------------------------------------------------------------------
.         Update corresponding record in watnbdaf; using WL procedure details
.------------------------------------------------------------------------------
UPWNBD00  PACK      KEY31,BATCHNUM,SP70
          CALL      RSWTNBD4
UPWNBD10  CALL      RKWTNBD4
          BRANCH    OVRCD,UPWNBD99
.
          MATCH     BATCHNUM,WTNDBTCH       * Batch Number
          GOTO      UPWNBD99 IF NOT EQUAL
.
          MATCH     WMURNO,WTNDPNHI         * Patient NHI number
          GOTO      UPWNBD10 IF NOT EQUAL
.
          MATCH     WTWMECNT,WTNDLBID       * WL Booking ID
          GOTO      UPWNBD10 IF NOT EQUAL
.
          MATCH     SP70,WTNDRDET
          GOTO      UPWNBD11 IF EQUAL
.
          BUMP      WTNDRDET,THREE          * Move logical pointer to rcrd type
          MATCH     "A",WTNDRDET            * Record type 'A'?
          GOTO      UPWNBD12 IF NOT EQUAL   * No; skip BS Code/Date match
.
UPWNBD11  MATCH     WTHIBSCD,WTNDBSCD       * Booking Status Code
          GOTO      UPWNBD10 IF NOT EQUAL
.
          MATCH     WTHIEDAT,WTNDBSDT       * Booking Status Date
          GOTO      UPWNBD10 IF NOT EQUAL
.
UPWNBD12  MOVE      FOUR,WTNDSTAT           * update status to 'Corrected'
          MOVE      WBSEUID,WTNDUSRS
          RESET     WTNDRDET
          CALL      IBACLOCK
          PACK      WTNDUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTNDUDAT
          CLOCK     TIME,WTNDUTIM
.
          CALL      UPWTNBD4
          GOTO      UPWNBD10
.
UPWNBD99  RETURN
+
.------------------------------------------------------------
. Delete / Erase Records
.------------------------------------------------------------
DELERS00  MOVE      ZERO,EXIT
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,DELERS91
.
          MATCH     ANSD,UPDTTYPE
          GOTO      DELERS10 IF EQUAL
.
          MATCH     ANSE,UPDTTYPE
          GOTO      DELERS15 IF EQUAL
.
          GOTO      DELERS90
.
DELERS10  PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          IF        OVRCD=1
            GOTO      DELERS92
          ENDIF
.
          MATCH     WMURNO,WTHIURNO
          GOTO      DELERS92 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      DELERS92 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      DELERS92 IF NOT EQUAL
.
          GOTO      DELERS20
.
DELERS15  CALL      CLRWTHIS
          MOVE      WMURNO,WTHIURNO
          MOVE      WMCODE,WTHIPROC
          MOVE      WMCNT,WTHIPCNT
          MOVE      "99",WTHIBSCD
          MOVE      WMPTY,WTHIPRIO
          MOVE      WTWMRANK,WTHIRANK
          MOVE      ONE,WTHIUCNT
.
DELERS20  PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",WTHIEDAT
          CLOCK     TIME,WTHIETIM
          MOVE      WTWMUNIQ,WTHIBOOK
          MOVE      ANSN,WTHIRECS
          MOVE      UPDTTYPE,WTHIRTYP
.
DELERS25  PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT
.
          CALL      RAWTHIS1
          IF        OVRCD<>1
            ADD       ONE,WTHIUCNT
            GOTO      DELERS25
          ELSE
            CALL      WRWTHIS1
          ENDIF
.
          CALL      UPWNBD00      * Update record in 'watnbdaf'
          GOTO      DELERS99
.
DELERS90  MOVE      "Invalid update type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELERS99
.
DELERS91  MOVE      "Invalid Case. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELERS99
.
DELERS92  MOVE      "No previous record ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELERS99
.
DELERS99  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40,PROFLD50
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      WTRE0000    * Waiting list fields
          GOTO      PROFLD99
.
PROFLD13  CALL      LIST0000    * List screens
          GOTO      PROFLD99
.
PROFLD14  CALL      WTHI0000    * History fields
          GOTO      PROFLD99
.
PROFLD15  CALL      MISC0000    * Miscellaneous fields
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD32  CALL      WTRE0000    * Waiting list fields
          GOTO      PROFLD99
.
PROFLD33  CALL      LIST0000    * Lists
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD42  CALL      WTRE0000    * Waiting list fields
          GOTO      PROFLD99
.
PROFLD43  CALL      WTEN0000    * Intra Episode
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD52  CALL      WTRE0000    * Waiting list fields
          GOTO      PROFLD99
.
PROFLD53  CALL      WTEE0000    * Episode
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. List views
.------------------------------------------------------------
LIST0000  BRANCH    FLDITMNO,LIST0100,LIST0200,LIST0300,LIST0400:
                             LIST0500
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      LIST9999
.
LIST0100  CALL      HIS0000      * NBRS list
          GOTO      LIST9999
.
LIST0200  CALL      WATESP00     * ESIS Patient List
          GOTO      LIST9999
.
LIST0300  CALL      WATESE00     * ESIS Episode List
          GOTO      LIST9999
.
LIST0400  CALL      WATESN00     * ESIS Intra Episode List
          GOTO      LIST9999
.
LIST0500  CALL      WATMAP00     * ESIS MAPT List
          GOTO      LIST9999
.
LIST9999  RETURN
+
.------------------------------------------------------------
. Miscellaneous fields
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      MISC9999
.
MISC0100  READ      CONTROLF,THIRTY7;*244,WTCNCSID
          MOVE      SP70,KEY4
          IF        WTCNCSID = 1
            PACK      KEY9,WMCODE,SP8
            CALL      RDPROA1
            IF        OVRCD<>1
              MOVE      ZERO,FORM4
              MOVE      WPRHAT,FORM4
              MOVE      FORM4,KEY4           * CPAC scoring ID
              REP       " 0",KEY4
            ENDIF
          ELSE
            IF        WTCNCSID = 2
              PACK      KEY5,ANSA,SP1,WMPCAT,SP8
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TCFORM6,FORM4
                MOVE      FORM4,KEY4
                REP       " 0",KEY4
              ENDIF       
            ELSE
              IF        WTCNCSID = 3
                PACK      KEY5,ANSW,ANSU,WMUNIT,SP8 
                CALL      RDCODE1
                IF        OVRCD<>1
                  MOVE      TCFORM6,FORM4
                  MOVE      FORM4,KEY4
                  REP       " 0",KEY4
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;KEY4;
          GOTO      MISC9999
.
MISC0200  MATCH     SP70,EXITDATE
          GOTO      MISC9999 IF EQUAL
          UNPACK    EXITDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC0300  
.... C CAR 51721
....      MATCH     SP70,TMPEXTCD
....      GOTO      MISC9999 IF EQUAL
.
          MOVE      "WR",CATEGORY
          MOVE      WMREMOVE,CODE
          CALL      ANOSEL00
....      WRITE     HTMLFILE;TMPEXTCD;
          GOTO      MISC9999
.... End C CAR 51721
.
MISC0400  WRITE     HTMLFILE;BATCHNUM;
          GOTO      MISC9999
.
MISC9999  RETURN
+
.------------------------------------------------------------
. Selection List with Category "WR" Code and Associate No.Displayed
.------------------------------------------------------------
ANOSEL00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE1
ANOSEL10  CALL      RDKCODE1
          BRANCH    OVRCD,ANOSEL99
          MATCH     CATEGORY,TCODE
          GOTO      ANOSEL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      ANOSEL10 IF EQUAL
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          MOVE      TCFORM6,DIM6
          SQUEEZE   DIM6
          IF        TCFORM6<10
            PACK      TMPEXTCD,ZERO,DIM6
          ELSE
            PACK      TMPEXTCD,DIM6
          ENDIF
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               "(",TMPEXTCD,") ",TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      ANOSEL10 IF EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30,">":
                               "(",TMPEXTCD,") ",TDESC,"</option>"
          ENDIF
          GOTO      ANOSEL10
.
ANOSEL99  RETURN
+
.------------------------------------------------------------
.                             HIS0000                                
.              Loop through wathisaf and write to tempfile
.------------------------------------------------------------
HIS0000   MOVE      ONE,FORM4
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,HIS9999
. 
          PACK      KEY31,CASEKEYS,SP70
          CALL      RSWTHIS1
HIS1000   CALL      RKWTHIS1
          BRANCH    OVRCD,HIS9999          * end of file?
.
          MATCH     WTHIURNO,WMURNO
          GOTO      HIS9999 IF NOT EQUAL
.
          MATCH     WTHIPROC,WMCODE
          GOTO      HIS1000 IF NOT EQUAL
.
          COMPARE   WTHIPCNT,WMCNT
          GOTO      HIS1000 IF NOT EQUAL
.
          MATCH     SP70,WTHIRTYP          * only include add records
          GOTO      HIS1000 IF EQUAL
.
          COMPARE   ZERO,WTHIRANK
          IF        !@EQUAL
            MOVE      WTHIRANK,RANK
            GOTO      HIS2000
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WTHIPRIO   * using priority, not rank
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TCFORM6,FORM6
            MOVE      FORM6,RANK
          ENDIF
.
HIS2000   MOVE      SP70,EXITDATE
          MOVE      SP70,TMPEXTCD
          CALL      WATTR000               * Get wattr1af details
          BRANCH    EXIT,HIS1000
.
          MOVE      WTHIRECS,TMPSTAT
.
          CALL      TABROW00               * output row
.
          GOTO      HIS1000
.
HIS9999   RETURN
.
.*****************************************************************************
.                            WATTR000
.         Get values for fields from wattr1af
.*****************************************************************************
WATTR000  MOVE      ZERO,EXIT
.
          MATCH     SP8,WMUNIT
          GOTO      WATTR050 IF EQUAL
.
          PACK      KEY5,ANSW,ANSU,WMUNIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WATTR050
          MATCH     ANSN,TCINDC2
          IF        @EQUAL
            MOVE      ONE,EXIT
            GOTO      WATTR999
          ENDIF
.
WATTR050  IF        WMSTAT<>5
             GOTO     WATTR100
          ENDIF
.
          PACK      KEY8,WMBOOK,SP8
          CALL      RDMISS1
          BRANCH    OVRCD,WATTR100
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                * Position after last pat record
          CALL      RDPTRAN2                * read pat previous record
          BRANCH    OVRCD,WATTR100
.
          MATCH     AADMNO,TADMN
          GOTO      WATTR100 IF NOT EQUAL

          PACK      KEY6,TWARD,SP10         * Multiple hospitals.
          CALL      RDWARD1                 * Get hospital number from
          BRANCH    OVRCD,WATTR100
.                                             ward file.
          PACK      KEY3,PTWDHOSN
          CALL      RDPTHSP1                * Get HDP equiv. for hospital
          BRANCH    OVRCD,WATTR100
.
WATTR100  IF        WMSTAT = 5
            CALL      GEXD0000            * get exit details
          ENDIF
.
          IF        WMSTAT = 6
            CALL      REXD0000            * exit details for removed patients
          ENDIF
.
WATTR999  RETURN
+
.*****************************************************************************
.                            GEXD0000                     Called by: WATTR100
. Get the exit details for discharged patients
.*****************************************************************************
GEXD0000  PACK      KEY8,WMBOOK
          CALL      RDDSCH1
          BRANCH    OVRCD,GEXD9000
.
          MATCH     "20",WTHIBSCD
          GOTO      GEXD9000 IF NOT EQUAL
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            MOVE      BKREADAT,EXITDATE     * Date of exit
          ELSE
            MOVE      DDATE,EXITDATE     * Date of exit
          ENDIF
.
.
.  Task 0321194 - changed to use first theatre date as Date of exit
.  in case of multiple procedures
          PACK      KEY31,WMBOOK,FOUR,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,GEXD1000
          MOVE      WMBOOK,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      GEXD1000 IF NOT EQUAL
.
          COMPARE   "4",OPDASTAT
          GOTO      GEXD1000 IF NOT EQUAL
.
          PACK      EXITDATE,OPDADATE,SP70 * Date of exit
.
GEXD1000  PACK      KEY5,ANSD,SP1,DSTAT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TMPEXTCD,ANSX,ANSX
            GOTO      GEXD9000
          ENDIF
.
          MATCH     "0",TCINDC8
          IF        @EQUAL
            PACK      TMPEXTCD,ONE,TCINDC8
          ELSE
            MATCH     SP1,TCINDC8
            IF        !@EQUAL
              PACK      TMPEXTCD,ONE,TCINDC8
            ELSE
              PACK      TMPEXTCD,ANSX,ANSX
            ENDIF
          ENDIF
.
GEXD9000
GEXD9999  RETURN
+
.*****************************************************************************
.                            REXD0000                     Called by: WATTR100
. Get the exit details for patients removed from the waiting list
.*****************************************************************************
REXD0000  MATCH     "20",WTHIBSCD
          GOTO      REXD9999 IF NOT EQUAL
.
          MOVE      WMDATE4,EXITDATE     * Date of exit
          PACK      KEY5,ANSW,ANSR,WMREMOVE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,REXD2000
.
REXD1000  MOVE      TCFORM6,DIM6
          SQUEEZE   DIM6
          IF        TCFORM6<10
            PACK      TMPEXTCD,ZERO,DIM6
          ELSE
            PACK      TMPEXTCD,DIM6
          ENDIF
          GOTO      REXD9999
.
REXD2000  PACK      KEY5,ANSB,ANSC,WMREMOVE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TMPEXTCD,ANSX,ANSX
          ELSE
            GOTO      REXD1000
          ENDIF
.
REXD9999  RETURN
+
.---------------------------------------------------------------------------
. Output row
.---------------------------------------------------------------------------
TABROW00  PACK      STATUS,TMPSTAT,SP70
          MATCH     ANSY,TMPSTAT
          IF        @EQUAL
            MOVE      SENT,STATUS
          ENDIF
.
          MATCH     ANSN,TMPSTAT
          IF        @EQUAL
            MOVE      UNSENT,STATUS
          ENDIF
.
          MATCH     ANSA,TMPSTAT
          IF        @EQUAL
            MOVE      ACCEPT,STATUS
          ENDIF
.
          MATCH     ANSP,TMPSTAT
          IF        @EQUAL
            MOVE      PART,STATUS
          ENDIF
.
          MATCH     ANSR,TMPSTAT
          IF        @EQUAL
            MOVE      REJECTED,STATUS
          ENDIF
.
          MATCH     ANSS,TMPSTAT
          IF        @EQUAL
            MOVE      STOPSUB,STATUS
          ENDIF
.
          MOVE      SP70,HEALTHSP
          MATCH     SP70,WTHIPCHS
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,WTHIPCHS,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,HEALTHSP
            ENDIF
          ENDIF
.
          MOVE      SP70,BKSTDATE
          PACK      BKSTDATE,WTHIEDAT
          COMPARE   FIVE,WMSTAT
          IF        @EQUAL
            MATCH     "20",WTHIBSCD
            IF        @EQUAL
              PACK      KEY8,WMBOOK
              CALL      RDDSCH1
              BRANCH    OVRCD,GEXD9000
.
              PACK      KEY8,WMBOOK,SP70
              CALL      RDBKREC1
              IF        OVRCD<>1
                MOVE      BKREADAT,BKSTDATE
              ELSE
                MOVE      DDATE,BKSTDATE
              ENDIF
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateRecord('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    WTHIEDAT,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    DWTHIUCN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WTHIEDAT,WTHIETIM,"#",":
                             "#"",WTHIBSCD,"#",":
                             "#"",RANK,"#",":
                             "#"",WTHIDBFT,"#",":
                             "#"",HEALTHSP,"#",":
                             "#"",EXITDATE,"#",":
                             "#"",TMPEXTCD,"#",":
                             "#"",STATUS,"#",":
                             "#"",WTHIRTYP,"#",":
                             "#"",TMPSTAT,"#",":
                             "#"",BKSTDATE,"#",":
                             "#"",WTHIEDAT,WTHIETIM,WTHIUCNT,"#");"
.
TABROW99  RETURN
+
.----------------------------------------------------------------------
. Get OverDue Date & List Status
.  - Codes File should have been read for Cat TP
.  - Waiting List Record WATTR1AF should have been Read
.----------------------------------------------------------------------
COVER000  MOVE      SP70,PRIOOVER 
          MOVE      ZERO,OVERSTAT
..        CALL      URGDAY00
..        CALL      LSTDAY00
          CALL      DRFCUR00
          UNPACK    CLURCTDT,CCENT,CYEAR,CMON,CDAY  * set up parameters
          MOVE      CCENT,CC
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
.         
          CALL      DMYCON                   * convert to Julian date
.
          MOVE      JULDAY,JULDAYST          * For Status
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          ADD       TCFORM6,JULDAYST
.
          READ      CONTROLF,THIRTY7;*173,WTCNURDY,*177,WTCNSUDY:
                                     *181,WTCNRODY
          MATCH     "U",TCINDC1
          IF        @EQUAL
            ADD       WTCNURDY,JULDAY
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            ADD       WTCNSUDY,JULDAY
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            ADD       WTCNRODY,JULDAY
          ENDIF
.
.         CALL      NRCDF000
.         BRANCH    EXIT,COVER999
.
          ADD       NRCDAYS,JULDAY
          ADD       NRCDAYS,JULDAYST
.
          MOVE      JULDAY,JWKDAY            * set up parameters
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          MOVE      JULYR,JULYRST
          MOVE      JULCC,JULCCST
          CALL      JULCON                   * convert to DDMMYYCC
.
          PACK      PRIOOVER,CC,YY,MM,DD
          REP       " 0",PRIOOVER
.
          MOVE      JULDAYST,JULDAY
          MOVE      JULDAY,JWKDAY            * set up parameters
          MOVE      JULYRST,JWKYER
          MOVE      JULCCST,JWKCC
          CALL      JULCON                   * convert to DDMMYYCC
          PACK      TESTDATE,CC,YY,MM,DD
          REP       " 0",TESTDATE
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      "0",OVERSTAT
          MATCH     KEY8,TESTDATE
          IF        @LESS
            MOVE      "1",OVERSTAT
          ENDIF
.
          MATCH     KEY8,TESTDATE
          IF        @EQUAL
            MOVE      "1",OVERSTAT
          ENDIF
.
          IF         WMSTAT>1 & WMSTAT <9
            MOVE       TWO,OVERSTAT
.           MOVE       SP70,PRIOOVER          * As per Jill
          ENDIF
.
          MOVE      "VL",CATEGORY             * If not ready for care
          MOVE      WTTXPLST,CODE             * overdue date should be blank
          CALL      GETCOD00
.
          MATCH     "C",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
          ENDIF
.
          MATCH     "D",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
          ENDIF
.
COVER999  RETURN
.---------------------------------------------------------------------------
. Clear wattx1 Variables
.---------------------------------------------------------------------------
CLWTX000  MOVE      SP70,WTTXURNO   * U/R Number
          MOVE      SP70,WTTXPCOD   * Procedure Code (watproaf)
          MOVE      SP70,WTTXPCNT   * Procedure Count
          MOVE      SP70,WTTXPLST   * Patient List. Status (PRS/2) Cat VL
          MOVE      SP70,WTTXPOWD   * Post-Op Ward (patwr1af)
          MOVE      SP70,WTTXADMW   * Admitting Ward (patwr1af)
          MOVE      SP70,WTTXPSTY   * Parent Staying (0=NO,1=YES)
          MOVE      SP70,WTTXIDYC   * Intended Day Case (Cat XB)
          MOVE      SP70,WTTXADMF   * Admission Forms (Cat XA)
          MOVE      SP70,WTTXEQR1   * Equipment Required 1 (Cat XE)
          MOVE      SP70,WTTXEQR2   * Equipment Required 2 (Cat XE)
          MOVE      SP70,WTTXEQR3   * Equipment Required 2 (Cat XE)
          MOVE      SP70,WTTXPAST   * Pre-Admission Status (Cat XG)
          MOVE      SP70,WTTXCNSN   * Consent? (0=NO,1=YES)
          MOVE      SP70,WTTXNTGP   * Notify Registered GP (0=NO,1=YES)
          MOVE      SP70,WTTXPATM   * Proposed Admission Time (hh:mm:ss)
          MOVE      SP70,WTTXUIDR   * User Id who  rmvd procd. (websecaf)
          MOVE      SP70,WTTXLEQR   * Loan Equipment Required (Cat XO)
          MOVE      SP70,WTTXDPRC   * Duplicate Procedure Code (watproaf)
          MOVE      SP70,WTTXDPCN   * Duplicate Count
          MOVE      SP70,WTTXCDTE   * Date Record Created (ccyymmdd)
          MOVE      SP70,WTTXCTIM   * Time Record Created (hh:mm:ss)
          MOVE      SP70,WTTXWEBC   * WEB User Id rec creator (websecaf)
          MOVE      SP70,WTTXLUPD   * Last Update Date (ccyymmdd)
          MOVE      SP70,WTTXLUPT   * Last Update Time (hh:mm:ss)
          MOVE      SP70,WTTXWEBU   * WEB User Id rec. updater (websecaf)
          MOVE      SP70,WTTXCTYP   * Claim Type (Cat CL)
          MOVE      SP70,WTTXSPAR   * Spare Variable
.
CLWTX999  RETURN
.------------------------------------------------------------
. ESIS Details 
.------------------------------------------------------------
ESIS0000  MOVE      ZERO,EXIT
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,ESIS9000
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MOVE      WMURNO,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ESIS9200
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "ESIS Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ESIS9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ESIS9999
.
ESIS9000  MOVE      "Invalid Case ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ESIS9999
.
ESIS9200  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ESIS9999
.
ESIS9999  RETURN
.---------------------------------------------------------------------------
. Clear wathis Variables
.---------------------------------------------------------------------------
CLRWTHIS  MOVE      SP70,WTHIURNO
          MOVE      SP70,WTHIPROC
          MOVE      SP70,DWTHIPCN
          MOVE      SP70,WTHIEDAT
          MOVE      SP70,DWTHIUCN
          MOVE      SP70,WTHIPRIO
          MOVE      ZERO,WTHIRANK
          MOVE      SP70,WTHIDAT2
          MOVE      SP70,WTHIDAT3
          MOVE      SP70,WTHIRDT3
          MOVE      SP70,WTHIBSCD
          MOVE      SP70,WTHIDCGV
          MOVE      SP70,WTHIDBFT
          MOVE      SP70,WTHIRECS
          MOVE      SP70,WTHIRTYP
          MOVE      SP70,WTHIRCDT
          MOVE      SP70,WTHIBMDT
          MOVE      SP70,WTHIETIM
          MOVE      SP70,WTHIADTE
          MOVE      SP70,WTHIATIM
          MOVE      SP70,WTHIWEBI
          MOVE      SP70,WTHIBCAN
          MOVE      SP70,WTHIBOOK
          MOVE      SP70,WTHIDOCT
          MOVE      SP70,WTHIBOKC
          MOVE      SP70,WTHIUNIT
          MOVE      SP70,WTHIPLST
          MOVE      SP70,WTHISTAT
          MOVE      SP70,WTHIDAT1
          MOVE      SP70,WTHIDTAD
          MOVE      SP70,WTHIPODT
          MOVE      SP70,WTHICODT
          MOVE      SP70,WTHIDRSA
          MOVE      SP70,WTHIDOSA
          MOVE      SP70,WTHIPHSP
          MOVE      SP70,WTHITRAG
          MOVE      SP70,WTHIPCHS
          MOVE      SP70,WTHIBPRO
          MOVE      SP70,WTHIDTEC
          MOVE      SP70,WTHISPFL
          MOVE      SP70,WTHIBRSR
          MOVE      SP70,WTHIHIDE
.
          RETURN
.
.------------------------------------------------------------
. Display ESIS Patient Detail Table
.------------------------------------------------------------
WATESP00  PACK      KEY16,WMURNO,SP70
          CALL      RDWTESP1
          BRANCH    OVRCD,WATESP10
.
          MOVE      ONE,FIRSTREC
          GOTO      WATESP30
.
WATESP10  MOVE      ZERO,FIRSTREC
.
          PACK      KEY16,WMURNO,Z70
          CALL      RSWTESP1
WATESP20  CALL      RPWTESP1
          BRANCH    OVRCD,WATESP99
.
          MATCH     WMURNO,WTEPURNO
          GOTO      WATESP99 IF NOT EQUAL
.
          MATCH     SP70,WTEPEDAT
          GOTO      WATESP99 IF EQUAL
.
WATESP30  PACK      DISEDATE,SP70
          PACK      DISPBDAT,SP70
.
          MATCH     SP70,WTEPEDAT
          IF        !@EQUAL
            UNPACK    WTEPEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISEDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTEPPDOB
          IF        !@EQUAL
            UNPACK    WTEPPDOB,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,RESIDESC
          MATCH     SP70,WTEPRESI
          IF        !@EQUAL
            MOVE      "T ",CATEGORY
            MOVE      WTEPRESI,CODE
            CALL      GETCOD00
            MOVE      TDESC,RESIDESC
          ENDIF
.                             
          MOVE      SP70,ABRGDESC
          MATCH     SP70,WTEPABRG
          IF        !@EQUAL
            MOVE      "VA",CATEGORY
            MOVE      WTEPABRG,CODE
            CALL      GETCOD00
            MOVE      TDESC,ABRGDESC
          ENDIF
.
          MOVE      SP70,GENDDESC
          MATCH     SP70,WTEPPGEN
          IF        !@EQUAL
            MOVE      "Gi",CATEGORY
            MOVE      WTEPPGEN,CODE
            CALL      GETCOD00
            MOVE      TDESC,GENDDESC
          ENDIF
.
          PACK      ESTDOB,DNO,SP70
          MATCH     "1",WTEPEDOB
          IF        @EQUAL
            PACK      ESTDOB,DYES,SP70
          ENDIF
.
          PACK      XMEDNUM,WTEPMEDI,WTEPMREF
          CALL      MSFX0000         * work out medicare suffix
.
          WRITE     HTMLFILE;"<tr><td>",DISEDATE,"&nbsp;</td>":
                             "<td>",DISPBDAT,"&nbsp;</td>":
                             "<td>",ESTDOB,"&nbsp;</td>":
                             "<td>",WTEPPSEX,"&nbsp;</td>":
                             "<td>",GENDDESC,"&nbsp;</td>":
                             "<td>",XMEDNUM,"&nbsp;</td>":
                             "<td>",XMEDSUF,"&nbsp;</td>":
                             "<td>",RESIDESC,"&nbsp;</td>":
                             "<td>",WTEPPOST,"&nbsp;</td>":
                             "<td>",WTEPSUBR,"&nbsp;</td>":
                             "<td>",ABRGDESC,"&nbsp;</td>"
.
          BRANCH    FIRSTREC,WATESP10
.
          GOTO      WATESP20
.
WATESP99  RETURN
.******************************************************************************
.*                                  MSFX0000                                  *
.*                              Get Medicare Suffix                           *
.******************************************************************************
MSFX0000  MOVE      SP70,XMEDSUF
          MATCH     SP10,WTEPMEDI
          GOTO      MSFX2100 IF NOT EQUAL
.
          PACK      KEY5,ANST,SP1,WTEPRESI,SP70
          CALL      RDCODE1                 * read PATCODFD record
.
          MATCH     SP1,TCINDC1             * blank 1st Indicator ?
          GOTO      MSFX1000 IF EQUAL       * yes

          TYPE      TCINDC1                 * is 1st Indicator numeric ?
          GOTO      MSFX1000 IF NOT EQUAL   * no
          MOVE      TCINDC1,FORM1           * yes
.
          BRANCH    FORM1,MSFX1000,MSFX1100,MSFX1200
          GOTO      MSFX2000                * invalid 1st Indicator
.
. ------  1st Indicator = "1"  ------
.
MSFX1000  MOVE      "C-U",XMEDSUF
          GOTO      MSFX1300
.
. ------  1st Indicator = "2"  ------
.
MSFX1100  MOVE      "N-E",XMEDSUF
          GOTO      MSFX1300
.
. ------  1st Indicator = "3"  ------
.
MSFX1200  MOVE      "P-N",XMEDSUF
.
. ------  when Suffix is C-U, N-E or P-N, Medicare Number is set to blank  -----
.
MSFX1300  MOVE      SP70,XMEDNUM
          GOTO      MSFX9999
.
. ------  invalid 1st Indicator  ------
.
MSFX2000  MATCH     SP10,WTEPMEDI
          GOTO      MSFX9999 IF EQUAL
.
. ------  valid Medicare Number  ------
.
MSFX2100  MOVE      PGNAME,KEY25
          REP       UPPLOW,KEY25
          SCAN      "SON OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          SCAN      "DAUGHTER OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          SCAN      "BABY OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          RESET     KEY25,3
          LENSET    KEY25
          RESET     KEY25
          MOVE      KEY25,XMEDSUF
          GOTO      MSFX9999
.
MSFX2200  MOVE      "BAB",XMEDSUF
          GOTO      MSFX9999
.
MSFX9999  RETURN
+
.------------------------------------------------------------
. Display ESIS Episode Detail Table
.------------------------------------------------------------
WATESE00 PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          BRANCH    OVRCD,WATESE10
.
          MOVE      ONE,FIRSTREC
          GOTO      WATESE30
.
WATESE10  MOVE      ZERO,FIRSTREC
.
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
WATESE20  CALL      RPWTESE1
          BRANCH    OVRCD,WATESE99
.
          MATCH     WTWMECNT,WTEEUNIQ
          GOTO      WATESE99 IF NOT EQUAL
.
          MATCH     SP70,WTEEEDAT
          GOTO      WATESE99 IF EQUAL
.
WATESE30  PACK      DISEDATE,SP70
          PACK      DISPBDAT,SP70
          PACK      DISPRDAT,SP70
          PACK      DISPREGD,SP70
.
          MATCH     SP70,WTEEEDAT
          IF        !@EQUAL
            UNPACK    WTEEEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISEDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTEEADAT
          IF        !@EQUAL
            UNPACK    WTEEADAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MATCH     SP70,WTEERREM
            IF        @EQUAL
              PACK      WTEERREM,ANSW,SP70
            ENDIF
          ENDIF
.
          PACK      REMREAS,WTEERREM,SP70
          PACK      KEY5,ANSW,ANSR,WTEERREM,SP70
          CALL      RDCODE1               * Read a codes file record
          IF        OVRCD<>1
            MATCH      ANSE,TCINDC3
            IF         @EQUAL
              MOVE       DELETE,REMREAS
            ENDIF
          ENDIF
.
          MATCH     SP70,WTEEREMD
          IF        !@EQUAL
            UNPACK    WTEEREMD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPRDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTEERDAT
          IF        !@EQUAL
            UNPACK    WTEERDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPREGD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,XPREV
          MATCH     SP70,WTEEPREV
          IF        !@EQUAL
            RJUSTIFY  WTEEPREV
            PACK      XPREV,WTEEREFR,WTEEPREV,SP70
            REP       " 0",XPREV
          ENDIF
.
          PACK      KEY9,WTEEPROC,SP70
          CALL      RDPROA1
          IF        OVRCD=1
            MOVE      SP70,WTWPHDPE
          ENDIF
.
          MATCH     SP70,DISEDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td>":
                          "<a href='javascript:UpdateEpisode(#"":
                          WTEEUNIQ,WTEEEDAT,"#",#"":
                          CASEKEYS,"#");'>":
                          "<img src=../images/MaintenanceIcon.gif border=0>":
                          "</a>",DISEDATE,"&nbsp;</td>"
.
          ELSE
            WRITE     HTMLFILE;"<tr><td>":
                          "<a href='javascript:ViewEpisode(#"":
                          WTEEUNIQ,WTEEEDAT,"#",#"":
                          CASEKEYS,"#");'>":
                          "<img src=../images/MaintenanceIcon.gif border=0>":
                          "</a>&nbsp;",DISEDATE,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WTEEURNO,"&nbsp;</td>":
                             "<td>",DISPBDAT,"&nbsp;</td>":
                             "<td>",WTEEDEST,"&nbsp;</td>":
                             "<td>",WTEETCMP,"&nbsp;</td>":
                             "<td>",WTEEINSD,"&nbsp;</td>";
          MATCH     ANSA,WTEEPLOS
          IF        @EQUAL
            IF        WTCNUSXB=0
              WRITE     HTMLFILE;"<td>",HR23,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WTEEPLOS,"&nbsp;</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>",WTEEPLOS,"&nbsp;</td>";
          ENDIF
.
          MOVE      ZERO,F5
          SQUEEZE   WTWPHDPE
          MOVE      WTWPHDPE,F5
          IF        F5=200|F5>499
         WRITE     HTMLFILE;"<td><font color=red>",WTEEPROC,"&nbsp;</font></td>"
          ELSE
            WRITE     HTMLFILE;"<td>",WTEEPROC,"&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WTEEPDES,"&nbsp;</td>":
                             "<td>",REMREAS,"&nbsp;</td>":
                             "<td>",DISPREGD,"&nbsp;</td>":
                             "<td>",DISPRDAT,"&nbsp;</td>":
                             "<td>",WTEESREF,"&nbsp;</td>":
                             "<td>",WTEESSPC,"&nbsp;</td>":
                             "<td>",XPREV,"&nbsp;</td>"
.
          BRANCH    FIRSTREC,WATESE10
.
          GOTO      WATESE20
.
WATESE99  RETURN
.------------------------------------------------------------
. Display ESIS Intra Episode Detail Table
.------------------------------------------------------------
WATESN00  PACK      KEY36,WTWMECNT,SP8,Z70
          CALL      RSWTESN4
WATESN05  CALL      RPWTESN4
          BRANCH    OVRCD,WATESN10
.
          MATCH     SP70,WTENEDAT
          GOTO      WATESN10 IF NOT EQUAL
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      WATESN10 IF NOT EQUAL
.
          MOVE      ONE,FIRSTREC
          GOTO      WATESN30
.
WATESN10  MOVE      ZERO,FIRSTREC
.
          PACK      KEY36,WTWMECNT,Z70
          CALL      RSWTESN4
WATESN20  CALL      RPWTESN4
          BRANCH    OVRCD,WATESN99
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      WATESN99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      WATESN99 IF EQUAL
.
WATESN30  PACK      DISEDATE,SP70
          PACK      DISPBDAT,SP70
.
          MATCH     SP70,WTENEDAT
          IF        !@EQUAL
            UNPACK    WTENEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISEDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTENEVDT
          IF        !@EQUAL
            UNPACK    WTENEVDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DISETYPE
          PACK      XVALUE,WTENEVAL,SP70
          MATCH     ANSM,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,MAPT
          ENDIF
.
          MATCH     ANSU,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,URGENCY
            PACK      KEY5,ANST,ANSP,WTENEVAL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          MATCH     ANSR,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,READINS
            PACK      KEY5,ANSV,ANSL,WTENEVAL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          MATCH     ANSS,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,SETSAD
            MATCH     DELETE,WTENEVAL
            IF        @EQUAL
              PACK      XVALUE,DELETE,SP70
            ELSE
              UNPACK    WTENEVAL,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      XVALUE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
          ENDIF
.
          MATCH     ANSP,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,CHGSAD
            IF        CTHETR=1
              PACK      KEY5,ANSS,ANSC,WTENEVAL,SP70
            ELSE
              PACK      KEY5,ANSB,ANSC,WTENEVAL,SP70
            ENDIF
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          MATCH     ANST,WTENETYP
          IF        @EQUAL
            PACK      DISETYPE,TRANSFER
          ENDIF
.
          MATCH     SP70,DISEDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td>":
                          "<a href='javascript:UpdateIntra(#"":
                          WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,"#",#"":
                          CASEKEYS,"#");'>":
                          "<img src=../images/MaintenanceIcon.gif border=0>":
                          "</a>",DISEDATE,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td>":
                          "<a href='javascript:ViewIntra(#"":
                          WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,"#",#"":
                          CASEKEYS,"#");'>":
                          "<img src=../images/MaintenanceIcon.gif border=0>":
                          "</a>&nbsp;",DISEDATE,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DISETYPE,"&nbsp;</td>":
                             "<td>",DISPBDAT,"&nbsp;</td>":
                             "<td>",XVALUE,"&nbsp;</td>":
                             "<td>",WTENSADI,"&nbsp;</td>"
.
          BRANCH    FIRSTREC,WATESN05
.
          GOTO      WATESN20
.
WATESN99  RETURN
.------------------------------------------------------------
. Display ESIS MAPT Intra Episode Detail Table
.------------------------------------------------------------
WATMAP00  PACK      KEY36,WTWMECNT,SP8,Z70
          CALL      RSWTESN4
WATMAP05  CALL      RPWTESN4
          BRANCH    OVRCD,WATMAP10
.
          MATCH     SP70,WTENEDAT
          GOTO      WATMAP10 IF NOT EQUAL
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      WATMAP10 IF NOT EQUAL
.
          MOVE      ONE,FIRSTREC
          GOTO      WATMAP30
.
WATMAP10  MOVE      ZERO,FIRSTREC
.
          PACK      KEY36,WTWMECNT,Z70
          CALL      RSWTESN4
WATMAP20  CALL      RPWTESN4
          BRANCH    OVRCD,WATMAP99
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      WATMAP99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      WATMAP99 IF EQUAL
.
WATMAP30  PACK      DISEDATE,SP70
          PACK      DISPBDAT,SP70
.
          MATCH     SP70,WTENEDAT
          IF        !@EQUAL
            UNPACK    WTENEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISEDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTENEVDT
          IF        !@EQUAL
            UNPACK    WTENEVDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DISETYPE
          PACK      XVALUE,WTENEVAL,SP70
          MATCH     ANSM,WTENETYP
          IF        !@EQUAL
            BRANCH    FIRSTREC,WATMAP05
            GOTO      WATMAP20
          ENDIF
.
          PACK      DISETYPE,MAPT
.
          MATCH     SP70,DISEDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td>":
                          "<a href='javascript:UpdateIntra(#"":
                          WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,"#",#"":
                          CASEKEYS,"#");'>":
                          "<img src=../images/MaintenanceIcon.gif border=0>":
                          "</a>",DISEDATE,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td>",DISEDATE,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DISPBDAT,"&nbsp;</td>":
                             "<td>",WTENEVAL,"&nbsp;</td>"
.
          BRANCH    FIRSTREC,WATMAP05
.
          GOTO      WATMAP20
.
WATMAP99  RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBOKREC  MOVE      SP70,BKRESNAM  *       Surname
          MOVE      SP70,BKRELOCK  *        Lock variable
          MOVE      SP70,BKREADOC  *        Attending Doctor
          MOVE      SP70,BKRESDOC  *        Referring Doctor
          MOVE      SP70,BKREEDAT  *        Expected due date (CCYYMMDD)
          MOVE      SP70,BKREATIM  *        Expected assessment time
          MOVE      SP70,BKREPDAT  *        Pre-assessment date
          MOVE      SP70,BKREPTIM  *        Pre-assessment time
          MOVE      SP70,BKREADAT  *        Date booking was made CCYYMMDD
          MOVE      SP70,BKRETYPE  *        Booking type (Cat "BK")
          MOVE      SP70,BKRECANC  *        Cancellation reason (Cat "BC")
          MOVE      SP70,BKRESTAT  *        Booking status
          MOVE      SP70,BKREOMEM  *        Benefit fund member (Y/N/U)
          MOVE      SP70,BKREPREV  *        Previous inpatient (Y/N/U)
          MOVE      SP70,BKREACCM  *        Preferred accommodation (Cat BP)
          MOVE      SP70,BKREPROC  *        Waiting list procedure code
          MOVE      SP70,DBKRECNT  *        Waiting list procedure count
          MOVE      SP70,BKREWARD  *        Expected ward
          MOVE      ZEROVISN,BKREADMN  *        Maternity admission number
          MOVE      SP70,BKREPREA  *        Deposit paid (Y/N) Matern only
          MOVE      SP70,BKREEBED  *        Expected bed
          MOVE      SP70,BKRECLSS  *        Patient Cat./Adm Class. (Cat P)
          MOVE      SP70,BKREATYP  *        Adm Type/Pat. Class (Cat A)
          MOVE      SP70,BKREDEPT  *        Department (Cat AC)
          MOVE      SP70,BKRETDOC  *        Associated Doctor
          MOVE      SP70,BKRECLMT  *        Claim type (Cat CL)
          MOVE      SP70,BKRERFGP  *        Referring GP
          MOVE      SP70,BKREGPPC  *        GP Practice code
          MOVE      SP70,BKREGPFA  *       GPFH Approval Number
          MOVE      SP70,BKRERESI  *        Resident Status (Cat T)
          MOVE      SP70,BKREEATY  *        Elective Admission Type  (Cat CC)
          MOVE      SP70,BKREECRA  *       ECR Approval Number
          MOVE      SP70,BKREGPPT  *        GP Practice count
          MOVE      SP70,BKREDOFR  *        District of Residence (Cat DA)
          MOVE      SP70,BKREOPER  *        Operator who made I/P Booking
          MOVE      SP70,DBKREELO  *        Expected Length of Stay (Days)
          MOVE      SP70,BKREBKDT  *        Booking date (ccyymmdd)
          MOVE      SP70,BKRESPAR  *        Spare
          MOVE      SP70,BKDICODE
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDICOMM
          MOVE      SP70,BKDISPAR
          MOVE      SP70,BKREINDC
          RETURN
.
.------------------------------------------------------------
. Intra Episode Details
.------------------------------------------------------------
INTR0000  MATCH     SP70,UPDTTYPE
          GOTO      INTR8000 IF EQUAL
.
          MATCH     ANSA,UPDTTYPE
          GOTO      INTR1000 IF EQUAL
.
          MATCH     ANSD,UPDTTYPE
          GOTO      INTR3000 IF EQUAL
.
          GOTO      INTR9300
.
INTR1000  PACK      KEY36,WATES001,WATES003,WATES004,WATES002,WATES006,SP70
          CALL      RDWTESN1
          COMPARE   ZERO,OVRCD
          GOTO      INTR9400 IF EQUAL
.
          CALL      MVWTES00   
.
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBC,WBSEUID
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          PACK      WTENWEBU,SP70
          MOVE      ONE,WTENMANU
.
          CALL      WRWTESN1
.
          MOVE      ZERO,EXIT
          GOTO      INTR9999
.
INTR3000  PACK      KEY36,INTRAKEY,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,INTR9000
.
          CALL      DEWTESN1
.
          MOVE      ZERO,EXIT
          GOTO      INTR9999
.
INTR8000  MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,INTR9000
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MOVE      WMURNO,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,INTR9200
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY36,INTRAKEY,SP70
          CALL      RDWTESN1
          IF        OVRCD=1
            CALL      CLWTES00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "ESIS Intra Episode Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,INTR9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INTR9999
.
INTR9000  MOVE      "Invalid Case/Episode Details ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTR9999
.
INTR9200  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTR9999
.
INTR9300  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTR9999
.
INTR9400  MOVE      "Intra Episode Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTR9999
.
INTR9999  RETURN
.
.------------------------------------------------------------
.   Set parameters for intra episode table
.------------------------------------------------------------
SPWTS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPWTS001,SPWTS002,SPWTS003,SPWTS004,SPWTS005:
                       SPWTS006,SPWTS007,SPWTS008
.
          MOVE      ONE,EXIT
          GOTO      SPWTS999
.
SPWTS001  PACK      WATES001,QRYDATA,SP70
          GOTO      SPWTS999

SPWTS002  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATES002,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTS999
.
SPWTS003  PACK      WATES003,QRYDATA,SP70
          GOTO      SPWTS999
.
SPWTS004  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATES004,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTS999
.
SPWTS005  PACK      WATES005,QRYDATA,SP70
          GOTO      SPWTS999
.
SPWTS006  PACK      WATES006,QRYDATA,SP70
          GOTO      SPWTS999
.
SPWTS007  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATES007,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTS999
.
SPWTS008  PACK      WATES008,QRYDATA,SP70
          GOTO      SPWTS999
.
SPWTS999  RETURN
.
.------------------------------------------------------------
.  Move cgi vars to file vars for intra episode table
.------------------------------------------------------------
MVWTES00  MATCH     WATES001,Z70
          IF        !@EQUAL
            MOVE      WATES001,WTENUNIQ
          ENDIF
.
          MATCH     WATES002,Z70
          IF        !@EQUAL
            MOVE      WATES002,WTENEDAT
          ENDIF
.
          MATCH     WATES003,Z70
          IF        !@EQUAL
            MOVE      WATES003,WTENETYP
          ENDIF
.
          MATCH     WATES004,Z70
          IF        !@EQUAL
            MOVE      WATES004,WTENEVDT
          ENDIF
.
          MATCH     WATES005,Z70
          IF        !@EQUAL
            MOVE      WATES005,WTENEVAL     * Event value word
          ENDIF
.
          MATCH     WATES007,Z70
          IF        !@EQUAL
            MOVE      WATES007,WTENEVAL     * Event value date
          ENDIF
.
          MATCH     WATES008,Z70
          IF        !@EQUAL
            MOVE      WATES008,WTENEVAL     * Event value code 
          ENDIF
.
          MATCH     WATES006,Z70
          IF        !@EQUAL
            MOVE      WATES006,WTENSADI
          ENDIF
.
.
MVWTES99  RETURN
.
.------------------------------------------------------------
. Intra Episode details
.------------------------------------------------------------
WTEN0000  BRANCH    FLDITMNO,WTEN0100,WTEN0200,WTEN0300,WTEN0400,WTEN0500:
                             WTEN0600,WTEN0700,WTEN0800,WTEN0900,WTEN1000:
                             WTEN1100,WTEN1200,WTEN1300,WTEN1400
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WTEN9999
.
WTEN0100  WRITE     HTMLFILE;WTENUNIQ;
          GOTO      WTEN9999
.
WTEN0200  MATCH     WTENEDAT,SP70
          GOTO      WTEN9999 IF EQUAL
.
          UNPACK    WTENEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEN9999
.
WTEN0300  WRITE     HTMLFILE;WTENETYP;
          GOTO      WTEN9999
.
WTEN0400  MATCH     WTENEVDT,SP70
          GOTO      WTEN9999 IF EQUAL
.
          UNPACK    WTENEVDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEN9999
.
WTEN0500  PACK      XVALUE,WTENEVAL,SP70
          MATCH     ANSU,WTENETYP
          IF        @EQUAL
            PACK      KEY5,ANST,ANSP,WTENEVAL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          MATCH     ANSR,WTENETYP
          IF        @EQUAL
            PACK      KEY5,ANSV,ANSL,WTENEVAL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          MATCH     ANSS,WTENETYP
          IF        @EQUAL
            MATCH     DELETE,WTENEVAL
            IF        @EQUAL
              PACK      XVALUE,DELETE,SP70
            ELSE
              UNPACK    WTENEVAL,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      XVALUE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
          ENDIF
.
          MATCH     ANSP,WTENETYP
          IF        @EQUAL
            IF        CTHETR=1
              PACK      KEY5,ANSS,ANSC,WTENEVAL,SP70
            ELSE
              PACK      KEY5,ANSB,ANSC,WTENEVAL,SP70
            ENDIF
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TDESC,SP70
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;XVALUE;
.
          GOTO      WTEN9999
.
WTEN0600  WRITE     HTMLFILE;WTENSADI;
          GOTO      WTEN9999
.
WTEN0700  WRITE     HTMLFILE;INTRAKEY;
          GOTO      WTEN9999
.
WTEN0800  MATCH     SP70,WTENWEBC
          GOTO      WTEN9999 IF EQUAL
.
          PACK      KEY10,WTENWEBC,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      WTENWEBC,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      WTEN9999
.
WTEN0900  MATCH     WTENCDAT,SP70
          GOTO      WTEN9999 IF EQUAL
.
          UNPACK    WTENCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEN9999
.
WTEN1000  MATCH     SP70,WTENCTIM
          GOTO      WTEN9999 IF EQUAL
.
          WRITE     HTMLFILE;WTENCTIM;
          GOTO      WTEN9999
.
WTEN1100  MATCH     SP70,WTENWEBU
          GOTO      WTEN9999 IF EQUAL
.           
          PACK      KEY10,WTENWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      WTENWEBU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      WTEN9999
.
WTEN1200  MATCH     WTENUDAT,SP70
          GOTO      WTEN9999 IF EQUAL
.
          UNPACK    WTENUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEN9999
.
WTEN1300  MATCH     SP70,WTENUTIM
          GOTO      WTEN9999 IF EQUAL
.
          WRITE     HTMLFILE;WTENUTIM;
          GOTO      WTEN9999
.
WTEN1400  WRITE     HTMLFILE;WTENMANU;
          GOTO      WTEN9999
.
WTEN9999  RETURN
.
.------------------------------------------------------------
. Clear Intra Episode details
.------------------------------------------------------------
CLWTES00  MOVE      SP70,WTENUNIQ
          MOVE      SP70,WTENEDAT
          MOVE      SP70,WTENETYP
          MOVE      SP70,WTENEVDT
          MOVE      SP70,WTENEVAL
          MOVE      SP70,WTENWEBC
          MOVE      SP70,WTENCDAT
          MOVE      SP70,WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
          MOVE      SP70,WTENSADI
          MOVE      SP70,WTENMANU
          MOVE      SP70,WTENSPAR
.
CLWTES99  RETURN
.
.------------------------------------------------------------
. Episode Details
.------------------------------------------------------------
EPIS0000  MATCH     SP70,UPDTTYPE
          GOTO      EPIS8000 IF EQUAL
.
          MATCH     ANSA,UPDTTYPE           * Add
          GOTO      EPIS1000 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE           * Update
          GOTO      EPIS2000 IF EQUAL
.
          MATCH     ANSD,UPDTTYPE           * Delete
          GOTO      EPIS3000 IF EQUAL
.
          GOTO      EPIS9300
.
EPIS1000  MOVE      CASEKEYS,KEY19          * Add       
          CALL      RDTREA1
          BRANCH    OVRCD,EPIS9000
.
          CALL      CLWATESE                * Clear file vars  
.   
          PACK      WTEEUNIQ,WTWMECNT,SP70
          PACK      WTEEEDAT,SP70
          PACK      WTEEURNO,WMURNO,SP70
.
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          COMPARE   ZERO,OVRCD
          GOTO      EPIS9400 IF EQUAL
.
          CALL      MVWTEE00                * Move cgi to file vars
.
          PACK      WTEEWEBC,WBSEUID,SP70
          CALL      IBACLOCK
          PACK      WTEECDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTEECDAT
          CLOCK     TIME,WTEECTIM
          REP       " 0",WTEECTIM
.
          MOVE      ONE,WTEEMANU       
.
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      WRWTESE1
.
          MOVE      ZERO,EXIT
          GOTO      EPIS9999
.
EPIS2000  PACK      KEY17,EPISOKEY,SP70     * Update
          CALL      RDWTESE1
          BRANCH    OVRCD,INTR9000
.
          CALL      MVWTEE00                * Move cgi to file vars
.
          PACK      WTEEWEBU,WBSEUID,SP70
          CALL      IBACLOCK
          PACK      WTEEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTEEUDAT
          CLOCK     TIME,WTEEUTIM
          REP       " 0",WTEEUTIM
.
          CALL      UPWTESE1
.
          MOVE      ZERO,EXIT
          GOTO      EPIS9999
.
EPIS3000  PACK      KEY17,EPISOKEY,SP70     * Delete
          CALL      RDWTESE1
          BRANCH    OVRCD,INTR9000
.
          MATCH     SP70,WTEEEDAT           * Extract details sent
          GOTO      EPIS9500 IF NOT EQUAL
.
          CALL      DEWTESE1
.
          MOVE      ZERO,EXIT
          GOTO      EPIS9999
.
EPIS8000  MOVE      CASEKEYS,KEY19          * Display
          CALL      RDTREA1
          BRANCH    OVRCD,EPIS9000
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MOVE      WMURNO,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,EPIS9200
.
          MATCH     Z70,EPISOKEY    
          GOTO      EPIS8500 IF NOT EQUAL
.
          PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          COMPARE   ZERO,OVRCD
          GOTO      EPIS9400 IF EQUAL
.
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          IF        OVRCD=1
            CALL      CLWATESE              * Clear wateseaf
            GOTO      EPIS8600
          ENDIF
.
          MATCH     WTWMECNT,WTEEUNIQ       * Default previous records detail
          GOTO      EPIS8600 IF EQUAL       * on add screen
.
          CALL      CLWATESE                * Clear wateseaf
.
          GOTO      EPIS8600
.
EPIS8500  PACK      KEY17,EPISOKEY,SP70
          CALL      RDWTESE1
          BRANCH    OVRCD,EPIS9000
.
EPIS8600  CLEAR     WEBTITLE
          MOVE      "ESIS Episode Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EPIS9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9000  MOVE      "Invalid Case/Episode Details ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9200  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9300  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9400  MOVE      "Episode Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9500  MOVE      "Episode Details have already been sent",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EPIS9999
.
EPIS9999  RETURN
.
.------------------------------------------------------------
. Clear Episode File Vars
.------------------------------------------------------------
CLRWTESE  PACK      WTEEUNIQ,SP70
          PACK      WTEEURNO,SP70
          PACK      WTEEADAT,SP70
          PACK      WTEEDEST,SP70
          PACK      WTEEINSD,SP70
          PACK      WTEEPLOS,SP70
          PACK      WTEEPROC,SP70
          PACK      WTEEPDES,SP70
          PACK      WTEERREM,SP70
          PACK      WTEERDAT,SP70
          PACK      WTEEREMD,SP70
          PACK      WTEESREF,SP70
          PACK      WTEESSPC,SP70
          PACK      WTEEWEBC,SP70
          PACK      WTEECDAT,SP70
          PACK      WTEECTIM,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          PACK      WTEEARDT,SP70
          PACK      WTEEMANU,ZERO
          PACK      WTEETCMP,SP70
          PACK      WTEPSPAR,SP70
          PACK      WTEEPTWT,SP70
          PACK      WTEESGID,SP70
          PACK      WTEERADT,SP70
.
          RETURN
.
.------------------------------------------------------------
. Episode details
.------------------------------------------------------------
WTEE0000  BRANCH    FLDITMNO,WTEE0100,WTEE0200,WTEE0300,WTEE0400,WTEE0500:
                             WTEE0600,WTEE0700,WTEE0800,WTEE0900,WTEE1000:
                             WTEE1100,WTEE1200,WTEE1300,WTEE1400,WTEE1500:
                             WTEE1600,WTEE1700,WTEE1800,WTEE1900,WTEE2000:
                             WTEE2100,WTEE2200,WTEE2300,WTEE2400
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WTEE9999
.
WTEE0100  WRITE     HTMLFILE;EPISOKEY;
          GOTO      WTEE9999
.
WTEE0200  MATCH     WTEEADAT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEEADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE0300  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTEE0310,WTEE0320,WTEE0330
.
          MOVE      WTEEDEST,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,WTEE9999
          WRITE     HTMLFILE;PTVADESC;
          GOTO      WTEE9999
.
WTEE0310  WRITE     HTMLFILE;WTEEDEST;
          GOTO      WTEE9999
.
WTEE0320  MOVE      WTEETCMP,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,WTEE9999
          WRITE     HTMLFILE;PTVADESC;
          GOTO      WTEE9999
.
WTEE0330  WRITE     HTMLFILE;WTEETCMP;
          GOTO      WTEE9999
.
WTEE0400  MOVE      "CL",CATEGORY
          MOVE      WTEEINSD,CODE
          CALL      CODITM00
          GOTO      WTEE9999
.
WTEE0500  COMPARE   ZERO,WTCNUSXB
          GOTO      WTEE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;WTEEPLOS;
          GOTO      WTEE9999
.
WTEE0600  WRITE     HTMLFILE;WTEEPROC;
          GOTO      WTEE9999
.
WTEE0700  WRITE     HTMLFILE;WTEEPDES;
          GOTO      WTEE9999
.
WTEE0800  MOVE      "WR",CATEGORY
          MOVE      WTEERREM,CODE
          CALL      CODITM00
          GOTO      WTEE9999
.
WTEE0900  MATCH     WTEERDAT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE1000  MATCH     WTEEREMD,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEEREMD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE1100  LOAD      CATEGORY,WTCNBRSR,CATW1,CATW2,CATW3,CATW4,CATX5:
                                     CATX6,CATX7,CATX8
          MOVE      WTEESREF,CODE
          CALL      CODITM00
          GOTO      WTEE9999
.
WTEE1200  MOVE      "WU",CATEGORY
          MOVE      WTEESSPC,CODE
          CALL      CODITM00
          GOTO      WTEE9999
.
WTEE1300  WRITE     HTMLFILE;WTEEPREV;
          GOTO      WTEE9999
.
WTEE1400  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,WTEE1410
.
          MOVE      WTEEREFR,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,WTEE9999
          WRITE     HTMLFILE;PTVADESC;
          GOTO      WTEE9999
.
WTEE1410  WRITE     HTMLFILE;WTEEREFR;
          GOTO      WTEE9999
.
WTEE1500  MATCH     WTEEARDT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEEARDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE1600  COMPARE   ONE,WTCNUSXB
          GOTO      WTEE9999 IF NOT EQUAL
.
          MOVE      "XB",CATEGORY
          MOVE      WTEEPLOS,CODE
          CALL      CODITM00
          GOTO      WTEE9999
.
WTEE1700  MATCH     SP70,WTEEWEBC
          GOTO      WTEE9999 IF EQUAL
.
          PACK      KEY10,WTEEWEBC,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      WTEEWEBC,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      WTEE9999
.
WTEE1800  MATCH     WTEECDAT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE1900  MATCH     SP70,WTEECTIM
          GOTO      WTEE9999 IF EQUAL
.
          WRITE     HTMLFILE;WTEECTIM;
          GOTO      WTEE9999
.      
WTEE2000  MATCH     SP70,WTEEWEBU
          GOTO      WTEE9999 IF EQUAL
.
          PACK      KEY10,WTEEWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      WTEEWEBU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      WTEE9999
.
WTEE2100  MATCH     WTEEUDAT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEEUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE2200  MATCH     SP70,WTEEUTIM
          GOTO      WTEE9999 IF EQUAL
.
          WRITE     HTMLFILE;WTEEUTIM;
          GOTO      WTEE9999
.
WTEE2300  WRITE     HTMLFILE;WTEEMANU;
          GOTO      WTEE9999
.
WTEE2400  MATCH     WTEERADT,SP70
          GOTO      WTEE9999 IF EQUAL
.
          UNPACK    WTEERADT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WTEE9999
.
WTEE9999  RETURN
.
.------------------------------------------------------------
.   Set parameters for episode table
.------------------------------------------------------------
SPWTE000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPWTE001,SPWTE002,SPWTE003,SPWTE004,SPWTE005:
                       SPWTE006,SPWTE007,SPWTE008,SPWTE009,SPWTE010:
                       SPWTE011,SPWTE012,SPWTE013,SPWTE014,SPWTE015:
                       SPWTE016
.
          MOVE      ONE,EXIT
          GOTO      SPWTE999
.
SPWTE001  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATEE001,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTE999
.
SPWTE002  MOVE      QRYDATA,WATEE002
          GOTO      SPWTE999
.
SPWTE003  MOVE      QRYDATA,WATEE003
          GOTO      SPWTE999
.
SPWTE004  MOVE      QRYDATA,WATEE004
          GOTO      SPWTE999
.
SPWTE005  MOVE      QRYDATA,WATEE005
          GOTO      SPWTE999
.
SPWTE006  MOVE      QRYDATA,WATEE006
          GOTO      SPWTE999
.
SPWTE007  MOVE      QRYDATA,WATEE007
          GOTO      SPWTE999
.
SPWTE008  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATEE008,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTE999
.
SPWTE009  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATEE009,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTE999
.
SPWTE010  MOVE      QRYDATA,WATEE010
          GOTO      SPWTE999
.
SPWTE011  MOVE      QRYDATA,WATEE011
          GOTO      SPWTE999
.
SPWTE012  MOVE      QRYDATA,WATEE012
          GOTO      SPWTE999
.
SPWTE013  MOVE      QRYDATA,WATEE013
          GOTO      SPWTE999
.
SPWTE014  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATEE014,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTE999
.
SPWTE015  MOVE      QRYDATA,WATEE015
          GOTO      SPWTE999
.
SPWTE016  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      WATEE016,CCENT,CYEAR,CMON,CDAY,SP70
          GOTO      SPWTE999
.
SPWTE999  RETURN
.
.------------------------------------------------------------
.  Move cgi vars to file vars for episode table
.------------------------------------------------------------
MVWTEE00  MATCH     WATEE001,Z70
          IF        !@EQUAL
            MOVE      WATEE001,WTEEADAT
          ENDIF
.
          MATCH     WATEE002,Z70
          IF        !@EQUAL
            MOVE      WATEE002,WTEEDEST
          ENDIF
.
          MATCH     WATEE003,Z70
          IF        !@EQUAL
            MOVE      WATEE003,WTEEINSD
          ENDIF
.
          MATCH     WATEE004,Z70
          IF        !@EQUAL
            MOVE      WATEE004,WTEEPLOS
          ENDIF
.
          MATCH     WATEE005,Z70
          IF        !@EQUAL
            MOVE      WATEE005,WTEEPROC
          ENDIF
.
          MATCH     WATEE006,Z70
          IF        !@EQUAL
            MOVE      WATEE006,WTEEPDES
          ENDIF
.
          MATCH     WATEE007,Z70
          IF        !@EQUAL
            MOVE      WATEE007,WTEERREM
          ENDIF
.
          MATCH     WATEE008,Z70
          IF        !@EQUAL
            MOVE      WATEE008,WTEERDAT
          ENDIF
.
          MATCH     WATEE009,Z70
          IF        !@EQUAL
            MOVE      WATEE009,WTEEREMD
          ENDIF
.
          MATCH     WATEE010,Z70
          IF        !@EQUAL
            MOVE      WATEE010,WTEESREF
          ENDIF
.
          MATCH     WATEE011,Z70
          IF        !@EQUAL
            MOVE      WATEE011,WTEESSPC
          ENDIF
.
          MATCH     WATEE012,Z70
          IF        !@EQUAL
            MOVE      WATEE012,WTEEPREV
          ENDIF
.
          MATCH     WATEE013,Z70
          IF        !@EQUAL
            MOVE      WATEE013,WTEEREFR
          ENDIF
.
          MATCH     WATEE014,Z70
          IF        !@EQUAL
            MOVE      WATEE014,WTEEARDT
          ENDIF
.
          MATCH     WATEE015,Z70
          IF        !@EQUAL
            MOVE      WATEE015,WTEETCMP
          ENDIF
.
          MATCH     WATEE016,Z70
          IF        !@EQUAL
            MOVE      WATEE016,WTEERADT
          ENDIF
.
MVWTEE99  RETURN
.
.------------------------------------------------------------
. Validate Suspension dates
.------------------------------------------------------------
VALSUS00  MOVE      SP70,DATEFROM
          MOVE      SP70,DATETO
          CALL      XMLHED00
          BRANCH    EXIT,VALSUS99
.
VALSUS05  PACK      KEY10,VALDUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,VALSUS90
.
          MATCH     SP70,OPDAPROC
          GOTO      VALSUS90 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,VALSUS90
.
VALSUS10  PACK      KEY29,WMURNO,WMCODE,DWMCNT,VALDDATE,Z70
          CALL      RSWTSUS2           * Read suspension table
          CALL      RPWTSUS2
          BRANCH    OVRCD,VALSUS90
.
          MATCH     WMURNO,WTSUURNO
          GOTO      VALSUS90 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      VALSUS90 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      VALSUS90 IF NOT EQUAL
.
          MATCH     WTSUFDAT,VALDDATE
          GOTO      VALSUS90 IF LESS
.
          MATCH     SP70,WTSUTDAT
          GOTO      VALSUS95 IF EQUAL
.
          MATCH     WTSUTDAT,VALDDATE
          GOTO      VALSUS95 IF LESS
.
VALSUS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,SP70:
                             "</RETURN_VALUE>"
          GOTO      VALSUS98
.
VALSUS95  UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEFROM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DATETO,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      SP70,DATETO
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DATEFROM,"|",DATETO,"</RETURN_VALUE>"
          GOTO      VALSUS98
.
VALSUS98  CALL      XMLEND00
VALSUS99  RETURN
+
.------------------------------------------------------------
. Validate Suspension dates - using WL key
.------------------------------------------------------------
VALSKY00  MOVE      SP70,DATEFROM
          MOVE      SP70,DATETO
          CALL      XMLHED00
          BRANCH    EXIT,VALSKY99
.
VALSKY05  PACK      KEY19,VALDWTKEY,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,VALSKY90
.
VALSKY10  PACK      KEY29,WMURNO,WMCODE,DWMCNT,VALDDATE,Z70
          CALL      RSWTSUS2           * Read suspension table
          CALL      RPWTSUS2
          BRANCH    OVRCD,VALSKY90
.
          MATCH     WMURNO,WTSUURNO
          GOTO      VALSKY90 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      VALSKY90 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      VALSKY90 IF NOT EQUAL
.
          MATCH     WTSUFDAT,VALDDATE
          GOTO      VALSKY90 IF LESS
.
          MATCH     SP70,WTSUTDAT
          GOTO      VALSKY95 IF EQUAL
.
          MATCH     WTSUTDAT,VALDDATE
          GOTO      VALSKY95 IF LESS
.
VALSKY90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,SP70:
                             "</RETURN_VALUE>"
          GOTO      VALSKY98
.
VALSKY95  UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEFROM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DATETO,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      SP70,DATETO
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DATEFROM,"|",DATETO,"</RETURN_VALUE>"
          GOTO      VALSKY98
.
VALSKY98  CALL      XMLEND00
VALSKY99  RETURN
+
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
.
          INC       BOKDIAIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATMI1IO/INC
          INC       PATHSPIO/INC
          INC       MLTSECIO/INC
          INC       PATMA1IO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATALRIO/INC
          INC       OUTSITIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       OPRDEAIO/INC
          INC       PATIN1IO/INC
          INC       PATDSCIO/INC
          INC       PATTRNIO/INC
          INC       WATCATIO/INC
          INC       WATHISIO/INC
          INC       WATLETIO/INC
          INC       WATLHIIO/INC
          INC       WATMESIO/INC
          INC       WATPACIO/INC
          INC       WATPROIO/INC
          INC       WATRTDIO/INC
          INC       WATSUSIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATESPIO/INC
          INC       WATESEIO/INC
          INC       WATESNIO/INC
          INC       WATNBDIO/INC       * NBRS Extract Records
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPMSPX2
          INC       CLWATESE
          INC       PATMASTM
          INC       PATNAMCD
          INC       PATDOCTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       WATHISTM
          INC       WATTRETM

