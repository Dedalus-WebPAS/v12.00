. *----------------------------------------------------------------------
. * Include Name  :   OPRREQTM.PBL
. *
. * Function      :   CGI variable functions for OPRREQFD - oprreqaf.dat
. *
. * Modifications :
. *
.------------------------------------------------------------------------
. V11.04.01 05/03/2024  Thanh T            TSK 0923560
.           Added Hospital ID
. V11.03.01 31/01/2023  Thanh T.           TSK 0919770                  
.           Changed OREQ0530, OREQ0510 to cater for adding Hospital field
.------------------------------------------------------------------------
. V10.15.01 28/11/2019 Peter Vela               Task 0871644
.           Added OPRQCHRG
. V9.04.00  03/03/2005 Lina Vo                  CAR 56404
.           Created include
.------------------------------------------------------------------------
.   Clear parameters for the item details file
.------------------------------------------------------------------------
CPOREQ00  MOVE      Z70,OPREQ001
          MOVE      Z70,OPREQ002
          MOVE      Z70,OPREQ003
          MOVE      Z70,OPREQ004
          MOVE      Z70,OPREQ005
          MOVE      Z70,OPREQ006
          MOVE      Z70,OPREQ007
          MOVE      Z70,OPREQ008
.
CPOREQ99  RETURN
.
.------------------------------------------------------------
. item details file standard tags
.------------------------------------------------------------
OREQ0000  BRANCH    FLDITMNO,OREQ0100,OREQ0200,OREQ0300,OREQ0400,OREQ0500:
                             OREQ0600,OREQ0700,OREQ0800
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      OREQ9999
.
OREQ0100  WRITE     HTMLFILE;OPRQUNIQ;  
          GOTO      OREQ9999
.
OREQ0200  WRITE     HTMLFILE;OPRQTEAM;  
          GOTO      OREQ9999
.
OREQ0300  MOVE      OPRQCLSS,CODE           
          MOVE      "OG",CATEGORY
          CALL      CODITM00
          GOTO      OREQ9999
.
OREQ0400  WRITE     HTMLFILE;OPRQTYPE;
          GOTO      OREQ9999
.
OREQ0500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,OREQ0510
.
          WRITE     HTMLFILE;OPRQITEM;
          GOTO      OREQ9999
.
OREQ0510  MOVE      ZERO,F1
          MOVE      OPRQTYPE,F1
          BRANCH    F1,OREQ0520,OREQ0530
.
          PACK      KEY18,OPRQITEM,HOSPCODE,SP70
          CALL      RDOPTRA1
          IF        OVRCD=1
            MOVE      "Invalid Tray",OPTHDESC
          ENDIF
          WRITE     HTMLFILE;OPTHDESC;
          GOTO      OREQ9999
.
OREQ0520  MATCH     "1",OPCNPTMC
          IF        @EQUAL
.
            IF        CFEETYP=FIVE
.
              PACK      KEY37,OPRQITEM,SP70
              CALL      RSNZMCH3
OREQ0521      CALL      RKNZMCH3
              BRANCH    OVRCD,OREQ0527
.
              MOVE      OPRQITEM,DIM9
.
              MATCH     DIM9,NZMCMCHG
              GOTO      OREQ0527 IF NOT EQUAL
.
              MATCH     "1",NZMCACFL
              GOTO      OREQ0521 IF EQUAL
.
              WRITE     HTMLFILE;NZMCDESC;
              GOTO      OREQ9999
.
            ELSE
.
              PACK      KEY9,OPRQITEM,SP70
              IF        IBCNMHOS=1
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                BRANCH    OVRCD,OREQ0525
                PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
              ELSE
OREQ0525        PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,CURRDATE,SP10
              ENDIF
              CALL      PATMCHRD
.
              IF        EXIT=ZERO
                WRITE     HTMLFILE;MDESC;
                GOTO      OREQ9999
              ENDIF
.
              GOTO      OREQ0527
.
            ENDIF 
.
          ELSE
OREQ0527    PACK      KEY15,OPRQITEM,SP70
            CALL      RDOPITE1
            IF        OVRCD=1
              MOVE      "Invalid Item",OPITDESC
            ENDIF
.
          ENDIF
OREQ0528  WRITE     HTMLFILE;OPITDESC;
          GOTO      OREQ9999
.
OREQ0530  PACK      KEY18,OPRQITEM,HOSPCODE,SP70  
          CALL      RDOPEQP1
          IF        OVRCD=1
            MOVE      "Invalid Equipment",OPEQDESC
          ENDIF
          WRITE     HTMLFILE;OPEQDESC;
          GOTO      OREQ9999
.
OREQ0600  WRITE     HTMLFILE;OPRQAMNT;
          GOTO      OREQ9999
.
OREQ0700  IF        OPCNCLSU=1
            MOVE      OPRQDCOD,DOCTCODE  * Using Doc & OPRWEB05
            CALL      DOCDET00
          ELSE
            MOVE      OPRQDCOD,KEY6      * Using Clinic File for Session
            CALL      RDOPCLI1
            MOVE      OPCLDOCT,DOCTCODE  * Using Clinic Code & OPRWEB05
            CALL      DOCDET00
          ENDIF
          GOTO      OREQ9999
.
OREQ0800  WRITE     HTMLFILE;OPRQCHRG;
          GOTO      OREQ9999
.
OREQ9999  RETURN
.------------------------------------------------------------
.   Set Parameters for the item details file
.------------------------------------------------------------
SPREQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPREQ010,SPREQ020,SPREQ030,SPREQ040,SPREQ050:
                       SPREQ060,SPREQ070,SPREQ080
.
          MOVE      ONE,EXIT
          GOTO      SPREQ999
.
SPREQ010  MOVE      QRYDATA,OPREQ001
          GOTO      SPREQ999
.
SPREQ020  MOVE      QRYDATA,OPREQ002
          GOTO      SPREQ999
.
SPREQ030  MOVE      QRYDATA,OPREQ003
          GOTO      SPREQ999
.
SPREQ040  MOVE      QRYDATA,OPREQ004
          GOTO      SPREQ999
.
SPREQ050  MOVE      QRYDATA,OPREQ005
          GOTO      SPREQ999
.
SPREQ060  MOVE      QRYDATA,OPREQ006
          GOTO      SPREQ999
.
SPREQ070  MOVE      QRYDATA,OPREQ007
          GOTO      SPREQ999
.
SPREQ080  MOVE      QRYDATA,OPREQ008
          GOTO      SPREQ999
.
SPREQ999  RETURN
.
.------------------------------------------------------------
.  Update item details file
.------------------------------------------------------------
MVOREQ00  MATCH     OPREQ001,Z70
          IF        !@EQUAL
            MOVE      OPREQ001,OPRQUNIQ
          ENDIF
.
          MATCH     OPREQ002,Z70
          IF        !@EQUAL
            MOVE      OPREQ002,OPRQTEAM
          ENDIF
.
          MATCH     OPREQ003,Z70
          IF        !@EQUAL
            MOVE      OPREQ003,OPRQCLSS
          ENDIF
.
          MATCH     OPREQ004,Z70
          IF        !@EQUAL
            MOVE      OPREQ004,OPRQTYPE
          ENDIF
.
          MATCH     OPREQ005,Z70
          IF        !@EQUAL
            MOVE      OPREQ005,OPRQITEM
          ENDIF
.
          MATCH     OPREQ006,Z70
          IF        !@EQUAL
            MOVE      OPREQ006,OPRQAMNT
          ENDIF
.
          MATCH     OPREQ007,Z70
          IF        !@EQUAL
            MOVE      OPREQ007,OPRQDCOD
          ENDIF
.
          MATCH     OPREQ008,Z70
          IF        !@EQUAL
            MOVE      OPREQ008,OPRQCHRG
          ENDIF
.
MVOREQ99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLOREQ00  MOVE      SP70,OPRQUNIQ  * Unique id
          MOVE      SP70,OPRQTEAM  * Team Number
          MOVE      SP70,OPRQCLSS  * Class       
          MOVE      SP70,OPRQTYPE  * Item Type   
          MOVE      SP70,OPRQITEM  * Item Code   
          MOVE      ZERO,OPRQAMNT  * Quantity
          MOVE      SP70,OPRQDCOD  * Doctor Code      
          MOVE      SP70,OPRQCHRG  * Charges 0 = No, 1 = Yes
.
CLOREQ99  RETURN
