.---------------------------------------------------------------------- 
. Program       : PATWEB95
.
. Function      : Ward Bed Scan Server
.
. Modifications : 
.
.---------------------------------------------------------------------- 
. V12.00.04 01.09.2025  DA Sarkies     TSK 0966037
.           Added line to set DISNUMB to 0 in CLRPAR00
. V12.00.03 20/08/2025  Zumin Yu       TSK 0965668
.           Updated House Keeping to Housekeeping in ALLHED00 OPNHED00 CLSHED00
. V12.00.02 24/07/2025  Zumin Yu       TSK 0964351
.           Added WBSC1500 to WBSC0000. Fixed the “Bed Wards Only” checkbox
.           becomes unticked after the search completes.
. V12.00.01 19/05/2025  J.Tan          TSK 0955096
.           Added alpanumeric visit number generation
. V11.05.06 01.09.2025  DA Sarkies     TSK 0966037
.           Added line to set DISNUMB to 0 in CLRPAR00
. V11.05.05 20/08/2025  Zumin Yu       TSK 0965668
.           Updated House Keeping to Housekeeping in ALLHED00 OPNHED00 CLSHED00
. V11.05.04 24/07/2025  Zumin Yu       TSK 0964351
.           Added WBSC1500 to WBSC0000. Fixed the "Bed Wards Only" checkbox
.           becomes unticked after the search completes.
. V11.05.03 24/03/2025  Ebon Clements  TSK 0957232
.           Fixed KEY length for no bed file read - KWRD3500
.           Validate beds/nobeds when changing ward type - CKWT0000
. V11.05.02 28/01/2025  Nikitha B      TSK 0949135  
.           Modified height=30 to 15px for Bed/Ward search routines.
. V11.05.01 19/12/2024  Nikitha B      TSK 0949135  
.           Added NOMORE00. Called NOMORE00 at TABC9000 to display "No more 
.           records" with red line at the end of  list.
. V11.03.04 11/09/2023  Alina Bhari    TSK 0937459
.           Checked for the multihospital and displayed only active category BV
.           -DSPHKS10                                       
. V11.03.03 04.07.2023  Peter Vela     TSK 0927262
.           Added Location include  FHRLOCIN functionality
. V11.03.02 20.06.2023  DA Sarkies     TSK 0927738
.           Moved the counter for the wards into the fhir check
.           Commented out the counter for the fhir function that builds
.           a list of beds
. V11.03.01 28/04/2023  Thanh T.       TSK 0929220
.           Changed OUTLIR00 to fix issue with outler is not calculated
.           corretly
. V11.02.06 09/11/2022  Ebon Clements  TSK 0925910
.           Changed bed request in and out functions to only read yesterday
.           today and tomorrows bed requests.  BDRQIN00 and BDRQOU00
. V11.02.05 27/10/2022  Thanh T        TSK 0920995
.           Changed CFTENT30 to calculate the Confirmed count only when
.           expected discharge date is equal to today's date  
. V11.02.04 17/06/2022  Thanh T        TSK 0920832
.           Changed CALCB700 for admission count calculation and
.           BDRQIN00 for bed request count calculation  
. V11.02.03 19/05/2022  Thanh T        TSK 0918727
.           Replaced CONFDC00, TENTDC00 with CFTENT00
. V11.02.02 18/05/2022  Thanh T        TSK 0918727
.           Changed CONFDC00, TENTDC00 to fix issue with incorrect
.           tentative and confirmed count
. V11.02.01 17/03/2022  Alina Bhari    TSK 0915366
.           Calculated patient on leave for each ward - CALOLV00
.---------------------------------------------------------------------- 
. V11.01.07 24/11/2021  Thanh T        TSK 0903847
.           Changed OUTLIR00 to fix issue with incorrect outliers count
. V11.01.06 23/11/2021  Thanh T        TSK 0903847
.           Changed OUTLIR00 to fix issue with incorrect outliers count
. V11.01.05 23/11/2021  Thanh T        TSK 0903847
.           Changed OUTLIR00 to fix issue with incorrect outliers count
. V11.01.04 13/10/2021  Thanh T        TSK 0903847
.           Added various sections for bed management changes. 
.           WSELA000, WSTB0000, CALCB000, CONFDC00, TENTDC00, OUTLIR00,
.           BDRQIN00, BDRQOU00, UNALL000
. V11.01.03 25/06/2021  Ebon Clements  Task 0907533
.           Added menu switch noexpect=1 - Don't show expected column on
.           the hospital ward list - CALCP400
. V11.01.02 30/04/2021  Ebon Clements  Task 0905411
.           Don't read booking extn file if status is not booked - CALCP500
. V11.01.01 16/04/2021  Ebon Clements  Task 0904815
.           Cross Browser quotes -
. V10.14.03 01/10/2019  Jill Parkinson Task 0882126
.           Added write of ward history for bed type of bed for charging changes
. V10.14.02 13/09/2019  Jill Parkinson Task 0881407
.           Added write of ward history for bed description changes
. V10.14.01 15/08/2019  Jill Parkinson Task 0878505
.           Added write of ward history for Room Type for Charging changes
. V10.11.03 22.09/2018  Ebon Clements  TSK 0843369 
.           Added HERO id to ward/bed maintenance
. V10.11.02 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.01 17.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Include physcialType in Location Resource for 
.           ClinicalAide
.---------------------------------------------------------------------- 
. V10.10.11 11.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Testing for ClinicalAide
. V10.10.10 20/06/2017  Nicole Torrisi TSK 0840384 
.           Fixed CALCO000 Open Bed where PTWDBDST is blank
. V10.10.09 10.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issu
. V10.10.08 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
. V10.10.07 01/05/2017  Jill Parkinson TSK 0837634
.           Corrected emptyonly output
. V10.10.06 12/04/2017  Richa Phogat   TSK 0834391
.           Updated BDWR0000 to ignore further processing if Bed is not empty  
. V10.10.05 11/04/2017  Richa Phogat   TSK 0834391
.           Added condition to display 'Allocated'/'Requested' Ward/Bed request
.           on the basis of PTCNBREQ Parameter value
. V10.10.04 21/01/2017  B.G.Ackland    TSK 0835482 
.           FHIR request for Ward/Bed Lists
. V10.10.03 14/03/2017  Jill Parkinson TSK 0815244
.           Fixed UR display for bed requests in ward bed search
. V10.10.02 14/03/2017  Jill Parkinson TSK 0814008
.           Added move of one to exit after calling WEBWAR00 in open/close beds
. V10.10.02 14/03/2017  Jill Parkinson TSK 0814008
.           Added move of one to exit after calling WEBWAR00 in open/close beds
. V10.10.01 07/03/2017  Jill Parkinson TSK 0834391
.           Mods to read patvisaf instead of patmi1af for bed request patients
. V10.09.03 15/12/2016  J.Tan         TSK 0815244
.           Checked Allocated Ward/Bed Request for 'Empty Beds Only' option
. V10.09.02 13/12/2016  Ania P        TSK 830268
.           Fixed Open Bed Calculations
. V10.09.01 13/12/2016  J.Tan         TSK 0815244
.           Added Ward/Bed Request to Ward/Bed scan
.---------------------------------------------------------------------- 
. V10.08.04 10/08/2016  Peter Vela    TSK 0312498
.           Added current date validation in BEDCLS20
. V10.08.03 26/07/2016  Don Nguyen    TSK 0823278
.           Removed ward code read from MAIN1100
. V10.08.02 25/07/2016  Don Nguyen    TSK 0299187
.           Called SELV0000 for WBSC1300 instead of SELP0000
. V10.08.01 11/07/2016  Don Nguyen    TSK 0299187
.           Added REMPER00 and WBSC1300-WBSC1400
.---------------------------------------------------------------------- 
. V10.05.01 28.01.2015  Peter Vela    CAR 310589
.           Re read PMSBDC with SAVKEY22 in BEDCLS00
.---------------------------------------------------------------------- 
. V10.04.01 31.03.2014  B.G.Ackland   CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.---------------------------------------------------------------------- 
. V10.03.10 18/09/2013 Ania P         CAR 287795
.           Added code for new table PATWBAAF.
. V10.03.09 22.08.2013 Peter Vela     CAR 288358
.           Changed bed validation to closed in BLST0000
. V10.03.08 30.04.2013 B.G.Ackland    CAR 284507 
.           Performance Tune for Bookings and Preadmission in Hospital Summary
. V10.03.07 09/10/2012 Mike Laming    CAR 272642 
.           Added read of "patwbhaf" (Ward History) for "Effective Date", plus
.           mods to WRDT1400 for Ward History Effective Dates
. V10.03.06 26/09/2012 Ebon Clements  CAR 272606 
.           Fixed mrt location hospital test and key - MRTLC000
. V10.03.05 10/07/2012 Brian Ackland & David Carson   CAR 269028 
.           Empty Bed List by Hospital Fixed to Show Expected Discharges and i
.           Bed Requests Allocated
. V10.03.04 26/06/2012 Empty Bed List CAR 268127 
.           New Empty Bed List by Hospital
. V10.03.03 01/03/2012 Davin          CAR 261106
.           Added new ward seln list tag (wrdt1300) to show inactive wards
. V10.03.02 25/11/2011 Ebon Clements  CAR 255738
.           List ward bed search in short description order -  BDWR0000
. V10.03.01 22/11/2011 Ebon Clements  CAR 255738
.           List modify available beds in short description order - BLST0000
. V10.02.05 12/07/2011 Peter McMullen CAR 246389
.           Increase size of ward telephone (extension) number         
. V10.02.05 12/07/2011 Peter McMullen CAR 246389
.           Increase size of ward telephone (extension) number         
. V10.02.04 10/05/2011 Peter McMullen CAR 240706
.           Update ward/bed name handling to include short name option 
. V10.02.03 10/05/2011 Peter McMullen CAR 240706
.           Build selection list in name, not code, order        
. V10.02.02 10/05/2011 Peter McMullen CAR 240706
.           Restrict ward list (WRTAB000) to current hospital 
. V10.02.01 21/04/2011 Peter McMullen CAR 240725
.           Added cgi for PTWDSDED (short ward decription)
. V10.01.03 13/01/2011 Jill Parkinson CAR 233088
.           Added pmsvx1af
. V10.01.02 10/11/2010  Ebon Clements  CAR 233260
.           Added bed type description to ward/bed scan - TABC0000
. V10.01.01 08/11/2010  Jill Parkinson CAR 231816
.           Added superflg
. V10.00.02 22/10/2010  Davin         CAR 231481 
.           Added cgi for Ward Provider Number (ptwrd041/ptwdgldg)
. V10.00.01 22/09/2010 Jill Parkinson CAR 222489 
.           Added recurring modify available beds functionality
. V9.12.01  17/12/2009  Peter McMullen CAR 210130
.           Convert to newer Dr name format routine DOCNM000
. V9.12.01  26/11/2009  Davin          CAR 206615
.           Changed to use wbsehosp instead of mltsecaf for 
.           ward selection list filter (in WRDSEL00)
. V9.11.06  23/02/2009  Ebon Clements  CAR 185571
.           Added multi hospital security test to WRDSEL00
. V9.11.05  24/12/2008  Ebon Clements  CAR 174085
.           Added multi hospital speciality view
. V9.11.04  11/12/2008  Ebon Clements  CAR 174080
.           Fixed ward/bed plus ward only desc
. V9.11.03  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.02  14/10/2008  Ebon Clements  CAR 174077
.           Added holding for doctor to bed closure 
. V9.11.01  07/10/2008  Ebon Clements  CAR 174076
.           Added free format reason for bed closure   
. V9.10.02  10/07/2008  Ebon Clements  CAR 172440
.           Fixed ward bed search <a> blank href issue
. V9.10.01  09/07/2008  Ebon Clements  CAR 171906
.            Fixed DISPNUMB count for standby patients STBY0000
.                V9.09.05  22/12/2007  Mike Laming    CAR 156741
.                          Added 'Visitor Allowed' & 'Phone Calls Allowed' to 
.                          Ward & Ward/Bed Maintenance routines
.                V9.09.04  22/01/2008  Jill Habasque  CAR 159760
.                          Added move of PATFNAME to FORMATNM in PATD0000
.                V9.09.03  13/12/2007  Mike Laming    CAR 156741
.                          Added PTWDDFVS & PTEDDFPH (Visitor & Phone defaults)
.                V9.09.02  10/12/2007  Peter McMullen CAR 150192
.                          Suppress updateParent() link for %PATWEB95.01.011
.                V9.09.01  12/10/2007  Davin         CAR 151896
.                          Display ward/bed description (based on parameter)
.                V9.08.01  09/02/2007  Jill Habasque CAR 129224
.                          Added output of WARDCODE and EMPTONLY
.                V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                          Mods for PATCODTM - Hospital specific category codes
.                V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.                          Mods for REDIRECT length change.
.                          Recompiled for IBAWEBDF
.                V9.04.08  30/09/2005 Ebon Clements  CAR 60374
.                          Added CWRDSCN to ward/bed search
.                V9.04.07  22.09/2005 Jill Habasque  CAR 76518
.                          Fixed error message when changing a ward to be active
.                V9.04.06  04.01.2005 Lina Vo        CAR 52155
.                          Changed Modify Available Beds List(BLST000) to 
.                          display Bed Closure Maintenace icon.
.                V9.04.05  07.12.2004 Ebon Clements     55750  
.                          Added ward bed comments 
.                V9.04.04  26.10.2004 Jill Habasque     54412  
.                          Added expected occupancy list
.                V9.04.03  19.10.2004 Ebon Clements CAR 54412  
.                          Added sex to ward bed maintenance. Added sex and bed
.                          type filters to ward bed search
.                V9.04.02  10.09.2004 Lina Vo       CAR 53252  
.                          Added multi hospital indicator tag         
.                          30.08.2004 Jill Habasque CAR 53046 
.                          Added check for multi hospital in WSTA0000
.                V9.04.01  26.08.2004 Jill Habasque CAR 52930 
.                          Added check for multi hospital in TABC0000
.                V9.03.08  23.06.2004 Sylvek Litewka CAR 50946
.                          Modified procedures DSPALL00 and DSPOPN00 to add
.                          a call to 'chkClosurePeriod()' javascript function
.                          in the outputed HTML code.
.                V9.03.07  11/06/2004  Mike Laming  CAR 49016  July 2004 PRS/2 
.                          Add Sex Description routine SEXDSC00 with Code "R" - 
.                          "Intersex" added.                               
.                V9.03.06  10.11.2003 Sylvek Litewka CAR 43834
.                          Modified procedure VALBCL00 to check for backdating
.                          beyond last effective date when closing a bed.
.                V9.03.05  22.10.2003 Ebon Clements CAR 44497
.                          Added update of PTWDHOSN in all beds when a ward
.                          record is updated
.                V9.03.04  01.10.2003 Sylvek Litewka  CAR 43834
.                          Added procedure DLBCLS00 to delete all Bed Closure
.                          records for a given bed.
.                V9.03.03  22.08.2003 Sylvek Litewka  CAR 41826
.                          Added report number 5 - "Modify Available Beds".
.                          Added report number 6 - "Bed Closure Maintenance".
.                          Modified procedure BDWR0000 to display 'Closed' beds
.                          on Hospital Ward/Bed scan. Other mods related to 
.                          additional fields on patwr1af and patwbhaf.
.                V9.03.02  21.08.2003 Sylvek Litewka  CAR 41826
.                          Added processing for new fields on patwr1af
.                V9.03.01  03.07.2003 Jill Habasque CAR 40981
.                          Added output of wbedtype
. -----------------------------------------------------------------------------
.                V9.02.20  02.12.2002 Peter Vela    SRF 33360
.                          Fixed Expects column not incrementing for theatre
.                          bookings. 
.                V9.02.19  12.10.2002 Peter Vela    SRF 22631
.                          Mods to The Hospital Ward List (patweb9502001)
.                          - Expects: (EXPECTS) Combined Bookings and Pre Admis
.                            into one new column.
.                          - Beds on Ward: (WOCCBED) Renamed the column header
.                            from "Beds" to "Beds on Ward". No changes made to 
.                            the functionality of this column.
.                          - Open: (OPENBEDS) Created new column displaying the 
.                            number of beds currently active for a ward.     
.                          - Patients: (PATCOUNT) No changes made to the 
.                            functionality of this column
.                          - Empty: (F8) Renamed the column header from
.                            "Avail." to "Empty". Displays the number of open
.                            beds that have no patients.
.                          - Percent: (PERCENT) Displays the percentage of open
.                            beds occupied by patients. 
.                          - Status: (KEY2) Displays the above percentage as a
.                            a graph.
.                V9.02.18  09.10.2002 Peter Vela    SRF 17693
.                          Recompiled for PATMISTM - Admitting Point
.                V9.02.17  20.08.2002 Jill Habasque SRF 20715
.                          Added KWRD0000- check before changing active status 
.                V9.02.16  09.04.2002 Pat Dirito 
.                          Cleared Bed & Bed Status in EBFW0000                
.                V9.02.15  24.02.2002 B.G.Ackland
.                          Fixed Performance of calculation PREADMIS & BOOKINGS
.                          Mods to update ward bed history file if already exist
.                V9.02.14  07.02.2002 Jill Habasque
.                          Fixed calculation of PREADMIS & BOOKINGS
.                V9.02.13  01.02.2002 Ashwin
.                          Add DOSA Ward indicator
.                V9.02.12  14.01.2002 Jill Habasque
.                          Fixed onleave key to use key14                  
.                V9.02.11  24.12.2001 Jill Habasque
.                          Fixed saving of wadmno when updating ward/bed details
.                V9.02.10  07.12.2001 B.G.Ackland
.                          Correct calculation of patients to include patients
.                V9.02.09  29.11.2001 Glenn Saunders
.                          Correct calculation of patients to include patients
.                          who are not allocated a specific bed.        
.                V9.02.08  30.10.2001 Ebon Clements 
.                          Changed ward bed scan to display any beds that
.                          are set up for a ward/bed and ward only ward
.                          30.10.2001 Broko Sosic
.                          Added MRT Location selection list for ward  
.                V9.02.07  12.10.2001 Ebon Clements 
.                          Added option to delete a bed     
.                V9.02.06  03.10.2001 Jill Habasque
.                          Commented out replace ' with spaces in PATNAM00      
.                V9.02.05  27.09.2001 Jill Habasque
.                          Mods to display all active wards                     
.                V9.02.04  10.09.2001 G.Saunders
.                          Fixed up ward bed scan to pass 'bedsonly' for paging.
.                V9.02.03  28.08.2001 J.Tan
.                          Fixed up ward bed history
.                V9.02.02  21.08.2001 Ebon Clements
.                          Set bed number up when writing to ward bed history
.                V9.02.01  20.08.2001 J.Tan
.                          Added Nursing Station Number to ward file
.                V9.01.02  16.08.2001 J.Tan
.                          Recompiled for PATMASTM
.                V9.01.01  14.08.2001 J.Tan
.                          Recompiled for PATMASTM
.                V9.00.01  10/08/2001 Jill Habasque
.                          Added move of BEDSONLY from cgi parameter
.                V9.00.B01 09/05/2001 Ebon Clements
.                          Added ward type 3 ward bed and ward only
.                          WINPUT can now be 0,1 or 2
.                V5.10.B01 22/02/2001 Bronko Sosic
.                          Added PATNAMCD and changed all displays of
.                          Patient name to FORMATNM
.                          Fixed adding a bed to a ward
.----------------------------------------------------------------------
.                V5.09.B03 20/02/2001 J.Tan
.                          Mods to display bed type code           
.                 V5.09.02 15/01/2001 Bronko Sosic
.                          Recomplied For PATMASTM                 
.                 V5.08.09 27/11/2000 Katie Nelson
.                          Ported new ward bed scan code from 5.08
.
.                 V5.08.07 KATIE - Needs to have the THL changes added!!!!!!
.
.                 V5.08.05 13/09/2000  Tonii
.                          Fixed the sex from appearing always as 'unknown'.
.                 V5.08.04 05/09/2000  Tonii
.                          Mods to accept Unknown and Indeterminate as valid
.                          patient sex description
.                 V5.08.03  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.02 08/06/2000 Brian Ackland / Katie Nelson
.                          Fixed Ward/Bed search when searching 'all wards'
.                 V5.07.09 18/02/2000 Pat Dirito    
.                          Changed ShowDetail name to include report no 
.                 V5.07.08 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.07 18.01.2000 B.G.Ackland       
.                          Removed formatting of ward description so it 
.                          displays as WBDESC.
.                 V5.07.06 30/11/1999 Pat Dirito        
.                          Added Ward/Bed Maintenance        
.                 V5.07.05 03/11/1999 Katie Nelson      
.                          Recompiled for WEBDATCD/DAYOFWEK
.                 V5.07.04 26/10/1999 Katie Nelson      
.                          Fixed number of rows displaying and added invalid 
.                          record display. 
.                          Added Tag which excludes the display of expected 
.                          discharge.   
.                 V5.07.03 11/10/1999 Katie Nelson      
.                          Added option for a selection list to display bed 
.                          wards only.
.                 V5.07.02 07/10/1999 Katie Nelson      
.                          Removed formatting of ward description so it 
.                          displays as WBDESC.
.                 V5.07.01 29/09/1999 Nicole Harrington
.                          Changed to use HTML classes
.                 V5.07.00 28/06/1999 Nicole Harrington
.                          Ported from 6.06 - 5.07
.----------------------------------------------------------------------
.                 V6.05.03 15.02.1999 B.G.Ackland
.                          Enable TableSort.js to be used on Bed Status Report
.                 V6.05.02 15.02.1999 B.G.Ackland
.                          Includes Standby in Total. Ignore 0 Bed 0 Patient 
.                          Wards
.                 V6.05.01 16.01.1999 B.G.Ackland
.                          Added Total to Bed Status Page  
.                 V6.04.00 11.02.1998 B.G.Ackland
.                          Created Skeleton Server Program
.                 V6.04.00 08.04.1998 K.C.Nelson
.                          Changed Skeleton to Ward Bed Server Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
          INC       PATADWFD/INC        * Ward Audit File
          INC       PATCONFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       MLTSECFD/INC
          INC       MRTLOCFD/INC
          INC       PATMA1FD/INC
.          INC       HL7BMTFD/INC
          INC       PATMI1FD/INC
          INC       PMSVX1FD/INC
          INC       PATATRFD/INC
          INC       PATTRNFD/INC
          INC       PATNOBFD/INC
          INC       PATNURFD/INC
          INC       PATDO1FD/INC
          INC       PATVISFD/INC
.          INC       PATCURFD/INC
          INC       PATWR1FD/INC        * Patient Ward/Bed File   
          INC       PMSMSWFD/INC        * Multiple Specialty Wards
          INC       PATWBHFD/INC        * Ward Bed History File
          INC       PATONLFD/INC
          INC       PATCALAG/INC
          INC       PATHSPFD/INC        * Hospital File
          INC       PATPR1FD/INC
          INC       PMSBRQFD/INC
          INC       PMSBDCFD/INC        * Patient Bed Closure Details file
          INC       PMSBDCTD/INC        * CGI Params for Pat Bed Closure file
          INC       PMSHCPFD/INC
          INC       PMSEPBFD/INC        * Expected Patient in Bed Board
          INC       PMSBBDFD/INC        * Expected Patient in Bed Board
          INC       PMSUHLFD/INC        * HERO location 
          INC       PATVADFD/INC
          INC       PMSWORFD/INC        * Expected Discharge
          INC       PMSWORTD/INC
          INC       PATWBAFD/INC        * Ward Bed Attributes
          INC       OPRDEAFD/INC
.
.----------------------------------------------------------------------
.
.  CGI Parameters
.
BEDCOUNT  FORM      2
BEDAVAIL  DIM       1      * Bed Availability, 1 = All, 2 = Open, 3 = Closed
BEDREQST  FORM      1
EMPBEDFL  DIM       1      * Empty Beds Only flag, 1 = Empty Beds Only
THISWARD  DIM       3
THISBED   DIM       3
TOTLBEDS  FORM      5
TOTLEMPT  FORM      5
TOTLEXPE  FORM      5
TOTLOPEN  FORM      5
TOTLPERC  FORM      4.1
TOTLPATS  FORM      5
.
TOTLSPEC  FORM      5[50]
.
ATRTYPE   DIM       3
PSPCIND1  DIM       1
WOUTIND1  DIM       1
ENDNOW    FORM      1
BEDSONLY  FORM      1
NOBEDWRD  FORM      1
EMPTONLY  FORM      1               
OUTLFLAG  FORM      1               
ENDCLOSE  DIM       8
FILTRSEX  DIM       1
FILTHOSP  DIM       3
FILTBTYP  DIM       3
FHIRBUND  FORM      1
FHRLOCIN  FORM      1      * _include=Location:partOf
EFCTDATE  DIM       8      * Expected Date
FORMACTN  DIM       5               
NEXTPAGE  DIM       1      * Nextpage parameter CGI parameter
SAVESTDT  DIM       8
SELECTDY  FORM      1
SPECCODE  DIM       3[50]
SPECCNTR  FORM      2
SPECIALT  DIM       3
STARTKEY  DIM       25     * Starting Key
REDIREC1  DIM       227    * Redirect1 URL
REMOTENO  FORM      2
UPDTTYPE  DIM       1      * Update Type
UPDTBEDS  DIM       1      * Update Beds for Ward/Bed changes
LINKBTY   DIM       1
.
CLSFRDTE  DIM       8      * Close From Date
CLSFRTME  DIM       8      * Close From Time
CLSTODTE  DIM       8      * Close To Date
CLSTOTME  DIM       8      * Close To Time
CLREASON  DIM       3      * Reason for Bed Closure
CLREASFR  DIM       50     * Reason for Bed Closure Free Format 
CLDOCTOR  DIM       10     * Holding for doctor
COLNUMBR  FORM      2      * Speciality column number
.
BEDCODES  DIM       3[99]  * Array of Bed Codes
BEDSOPEN  DIM       1[99]  * Array of Beds to be Open
BEDSCLSE  DIM       1[99]  * Array of Beds to be Closed
BEDSHKST  DIM       3[99]  * Array of Beds House Keeping Status
.
PTWRD001  DIM       3      * Ward Number       
PTWRD002  DIM       3      * Ward Bed Number
PTWRD003  DIM       20     * Ward Bed Description
PTWRD004  DIM       8      * Current Patient Admission No.
PTWRD005  DIM       20     * Extension No. 
PTWRD006  FORM      2      * No Lines B/WN Beds (WRD ONLY) 
PTWRD007  DIM       3      * Room Type (Cat RT) (Beds Only)
PTWRD008  DIM       3      * E.F.R (Cat BT) (Beds Only)
PTWRD009  FORM      3      * No. of Beds in Ward (Ward Only)
PTWRD010  FORM      3      * HCS Ward Subscript (Ward Only)
PTWRD011  DIM       3      * Ward Service Code (Ward Only)
PTWRD012  FORM      1      * Plurality No.
PTWRD013  FORM      1      * Ward Only Input (WRD INDICATOR)
PTWRD014  FORM      3      * No. of Beds in Ward (OCC STATS)
PTWRD015  DIM       3      * Ward Classification (Cat CG)
PTWRD016  DIM       8      * Current standby Admission No.
PTWRD017  FORM      1      * Active Indicator 0=active 1=Inactive
PTWRD018  DIM       3      * Hospital/Unit Number
PTWRD019  FORM      1      * Day/Night Indicator 0=Day Only 1=Day & Night 
.                                                2=Night Only 
PTWRD020  DIM       3      * Intended Age Group (Cat IA)
PTWRD021  DIM       3      * Intended Care Intensity (Cat IC)
PTWRD022  DIM       1      * Intended Sex of Patient M/F/E
PTWRD023  DIM       4      * Medical Record Location Code
PTWRD024  DIM       14     * G/L and Cost Centre Code  
PTWRD025  DIM       3      * Nursing station number
PTWRD026  DIM       1      * DOSA Ward Indicator
PTWRD027  DIM       1      * Five Day Ward Indicator
PTWRD028  DIM       1      * Bed Status, 0 = Open, 1 = Closed
PTWRD029  DIM       3      * Reason for Change in Bed Status (Cat BU)
PTWRD030  DIM       3      * House Keeping Status (Cat BV)
PTWRD031  DIM       3      * Infection Status (Cat BW)
PTWRD032  DIM       8      * Date Record Created
PTWRD033  DIM       8      * Time Record Created
PTWRD034  DIM       10     * User ID - Creator
PTWRD035  DIM       8      * Date Record Updated
PTWRD036  DIM       8      * Time Record Updated
PTWRD037  DIM       10     * User ID - Last Update
PTWRD038  DIM       30     * Ward / Bed Comments
PTWRD039  DIM       1      * Default Visitors    
PTWRD040  DIM       1      * Default Phone Calls 
PTWRD041  DIM       14     * Ward Provider Number
PTWRD042  DIM       10     * Ward Short Description    
.
PTWBA001  DIM       3      * Ward
PTWBA002  DIM       3      * Bed
PTWBA003  DIM       3      * Bed Attribute
PTWBA004  DIM       3      * Hospital
PTWBA005  DIM       8      * Dae Created
PTWBA006  DIM       8      * Time Created
PTWBA007  DIM       10     * UserID Created
PTWBA008  DIM       8      * Date Updated
PTWBA009  DIM       8      * Time Updated
PTWBA010  DIM       10     * UserID Updated
.
.  Variable Declarations
.
MONCLSED  DIM       1
TUECLSED  DIM       1
WEDCLSED  DIM       1
THUCLSED  DIM       1
FRICLSED  DIM       1
SATCLSED  DIM       1
SUNCLSED  DIM       1
RECCURNG  DIM       1
DATEWORK  DATE      8
DISPBED   FORM      1
.
ACTION    DIM       1      * These Variables are declared in PATADWFD, 
ADD       DIM       2      * however are edited out!!  
AMM       DIM       2      * Once the transition is made from old software to
AYY       DIM       2      * WEB it will probably be a good idea to delete  
ACC       DIM       2      * theses declerations and allow them to be declared
OPERCODE  DIM       4      * in PATADWFD!!
DIM3      DIM       8
DIM8      DIM       8
DIM16     DIM       16
DIM3A     DIM       3
DIM3B     DIM       3
DIM20     DIM       20
.
.
CODERT    INIT      "RT"
EXPDISCH  FORM      1
EXPCTDSC  DIM       8
HEROLOCI  DIM       20
HEROTYPE  DIM       1
HEROWARD  DIM       3
HEROBEDD  DIM       3
HIDELINK  FORM      1
WARDLINK  DIM       70
CURRDATE  DIM       8
NOTFOUND  FORM      1
.
TOTALPAT  FORM      8
TOTALPRE  FORM      8
TOTALBOK  FORM      8
TOTALPBK  FORM      8
TOTALBED  FORM      8
TOTALEXP  FORM      8
TOTALOPN  FORM      8
TOTALOLV  FORM      8
.
TOTALOUT  FORM      8
TOTALEPO  FORM      8
TOTALEBQ  FORM      8
TOTALCDC  FORM      8
TOTALTDC  FORM      8
TOTALBRO  FORM      8
.
FLAG      FORM      1
SAVKEY6   DIM       6
SAVEKEY6  DIM       6
SAVKEY22  DIM       22
LASTWARD  DIM       3 
LOCNCODE  DIM       4
PSAGECON  DIM       3
PSAGETYP  DIM       3
WARDCODE  DIM       3
WARDNAME  DIM       20
WBEDDESC  FORM      1
RECCOUNT  FORM      4
DISPNUMB  FORM      4
ADMNOD8   DIM       8               
GENDER    DIM       8                                         * was 6  *C-49016
GTOTLBED  FORM      5
GTOTLEMP  FORM      5
GTOTLEXP  FORM      5
GTOTLOPN  FORM      5
GTOTLPER  FORM      4.1
GTOTLPAT  FORM      5
.
GTOTLSPE  FORM      5[50]
.
DOCTCODE  DIM       6
DOCGNAME  DIM       25
DOCSNAME  DIM       20              
DOCTITLE  DIM       9              
PDIAGNOS  DIM       50
EFTDATE   FORM      8
HISFLAG   FORM      1
PWARD     DIM       3 
PBED      DIM       3 
BEDSTAT   FORM      1
REQSTAT   DIM       1
FEMALE    INIT      "F"
MALE      INIT      "M"               
INDETER   INIT      "I"
SAVEWARD  DIM       3
SAVEBED   DIM       3
PATCOUNT  FORM      8
EXPDSCNT  FORM      8
PREADMIS  FORM      8
BOOKINGS  FORM      8
PREBOOKS  FORM      8
EXPECTS   FORM      8
OPENBEDS  FORM      8
UNALLOC   FORM      8
UNALDSC   DIM       25
.
OUTLIERS  FORM      8
EXPPOSOP  FORM      8
EXPDBREQ  FORM      8
CONFRMDC  FORM      8
TENTATDC  FORM      8
BEDRQOUT  FORM      8
PATONLEV  FORM      8
. 
SAVEWSEX  DIM       1
SAVEBEDT  DIM       3
SBYCOUNT  FORM      8
TODAY     FORM      8
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
PERCENT   FORM      4.1
WRDONWRD  FORM      1
.
SEC1      FORM      "00001"
SHOWINAC  FORM      "0"
SACTIVE   FORM      1       * Initialise active indicator
SNOBEDS   FORM      3       * Initialise number of beds
SUPERFLG  DIM       1
SWBTYPE   DIM       3       * Initialise ward class/room type
SWBIFST   DIM       3       * Infection Status Save variable
.
ONLYDESC  DIM       6
ACTVDESC  DIM       3
ROOMDESC  DIM       25
BEDTDESC  DIM       25
UPDATBED  FORM      1       * Update all beds flag
.
AT        INIT      "@"
CATat     INIT      "at"
CATAC     INIT      "AC"
CATBU     INIT      "BU"
CATBV     INIT      "BV"
CATBW     INIT      "BW"
CATRT     INIT      "RT"
CATCG     INIT      "CG"
COUNTER   FORM      3
DFLTWARD  DIM       3        * ward to mark pre-selected on ward selection lists 
DIM5      DIM       5
DIM10     DIM       10
FRSTLINE  FORM      1
REASDESC  DIM       20       * Reason Description
ROOMTYPE  DIM       20       * Room Type Description
CURBSTAT  DIM       6        * Current Bed Status - Description
LASTUPDT  DIM       18       * Date and Time of last update
EFFECTTO  DIM       18       * Effective to Date and Time
NEXTCLSR  DIM       18       * Next Bed Closure Date and Time
NOEXPECT  FORM      1        * Don't show expects column on hospital ward list
FROMLIST  DIM       1        * where the parent come form
CURRTIME  DIM       8        * Current Time
CELLTYPE  DIM       40
NUMNOBED  FORM      5        * Num of patients in a ward without bed allocation
BEDINDEX  FORM      2        * Array index to access bed details
CURCLOSE  DIM       1        * Current Bed Closure Flag (0=Future, 1=Current)
INVLDCLS  DIM       1        * Invalid Bed Closure Flag (0=Valid, 1=Invalid)
WARCOUNT  FORM      3        * Warnings Counter
WEBWARNG  DIM       80[99]   * Array of Warnings
WARNMESG  DIM       80       * Temp variable for Building Warning Message.
IFSTDESC  DIM       25       * Infection Status Description
HTMLCLSR  DIM       100 
UPDFIELD  DIM       150
CLSFRPRD  DIM       20       * Closure From Period (Date and Time)
CLSTOPRD  DIM       20       * Closure To Period (Date and Time)
STRTCLDT  DATE      8
FROMDATE  DIM       8
FROMTIME  DIM       8
UPDREASN  DIM       1        * Update Bed Closure Reason flag
STBYFLAG  FORM      1
ONLVFLAG  FORM      1
FIRSTROW  FORM      1
EXPTFLAG  FORM      1
EXPTDATE  DIM       8
EXPTTIME  DIM       5
EXDCDATE  DIM       8
EXDCTIME  DIM       5
ROOMCODE  DIM       3
ALLHOSAC  FORM      1
.
YESTDATE  DATE      8        * Yesterday
TOMODATE  DATE      8        * Tomorrow
CALCDATE  DIM       8
DATESRCH  DIM       1
REMOTLST  FORM      1        * Remote script list output
HOSPCODE  DIM       3
.
.---------------------------------------------------------------------------
PRGID     INIT      "PATWEB95"
VERSION   INIT      "V12.00.04"
PRGNAM    INIT      "Ward/Bed Server"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     SP70,LASTDATE
          IF        @EQUAL | @EOS
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
          ENDIF
.
          CALL      CURPER00           * Determine Current Period
          CALL      CALCDT00           * Calc Next and Last Periods
.
          MOVE      "Hospital Ward/Bed Scan",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      MAIN1000
.
MAIN1200  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CALL      CURPER00
          CALL      CALCDT00
          MOVE      "Hospital Ward List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      MAIN1000
.
MAIN1300  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CALL      WRDENQ00
          GOTO      MAIN1000
.
MAIN1400  CALL      PATWRD00   * Ward Bed Details Maintenance
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      MODAVB00   * Modify Available Beds 
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      BEDCLS00   * Bed Closure Maintenance 
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      MWBA0000
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      REMPER00      * Remote script call for Period Date select
          GOTO      MAIN1000
.
MAIN1900  CALL      REMOTE00      * Remote scripts
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATVISA1,"patvisaf"
          OPEN      PMSEPBA8,"pmsepbaf"
          OPEN      PMSBBDA1,"pmsbbdaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSWORA2,"pmsworaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA3,"patatraf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      MLTSECA1,"mltsecaf"
.
          OPEN      PATMA1A1,"patma1af"  
          OPEN      PATMI1A2,"patmi1af"  
          OPEN      PATMI1A3,"patmi1af"  
          OPEN      PATMI1A6,"patmi1af"  
          OPEN      PATWR1A1,"patwr1af"  
          OPEN      PATWR1A2,"patwr1af"  
          OPEN      PATWR1A3,"patwr1af"  
          OPEN      PATWR1A7,"patwr1af"  
          OPEN      PATWR1A8,"patwr1af"  
          OPEN      PMSMSWA1,"pmsmswaf"
          OPEN      PATDO1A1,"patdo1af"  
          OPEN      BOKRC1A4,"bokrc1af"  
          OPEN      BOKRC1A7,"bokrc1af"  
          OPEN      BOKRX1A1,"bokrx1af"  
.
          OPEN      PATHSPA1,"pathspaf"   * Hospital File
          OPEN      PATWBHA1,"patwbhaf"  
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATNOBE1,"patnobef"
          OPEN      PATNURS1,"patnursm"
          OPEN      PATWAUD,"patwaud"
          OPEN      PMSBDCA1,"pmsbdcaf"
          OPEN      PMSBRQA2,"pmsbrqaf"
          OPEN      PMSBRQA3,"pmsbrqaf"
          OPEN      PMSBRQA4,"pmsbrqaf"
          OPEN      PMSUHLA1,"pmsuhlaf"
          OPEN      PMSUHLA2,"pmsuhlaf"
          OPEN      OPRDETA2,"oprdetaf"
.
          OPEN      PATWBAA1,"patwbaaf"
.
          READ      CONTROLF,TEN;*223,CAUDW
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN9;*214,CWRDSCN
          READ      CONTROLF,HUND12;*104,PTCNWBDS
          READ      CONTROLF,HUND24;*145,PTCNBREQ
          MOVE      PTCNWBDS,WBEDDESC            * CAR 151896
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      ZERO,STARTNUM
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,HOSPCODE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          PACK      REDIREC1,SP70,SP70,SP70,SP70
          MOVE      SP70,WARDCODE
          MOVE      SP70,FORMACTN
          MOVE      ZERO,NORECORD
          MOVE      ZERO,EMPTONLY
          MOVE      ZERO,BEDSONLY
          MOVE      TRUE,EXPDISCH
          MOVE      SP70,EFCTDATE
          MOVE      FALSE,HIDELINK
          MOVE      SP70,STARTKEY
          MOVE      SP70,BEDAVAIL
          MOVE      SP70,EMPBEDFL
          MOVE      Z70,CLSFRDTE
          MOVE      Z70,CLSFRTME
          MOVE      Z70,CLSTODTE
          MOVE      Z70,CLSTOTME
          MOVE      SP70,CLREASON
          MOVE      SP70,CLREASFR
          MOVE      SP70,CLDOCTOR
          MOVE      ZERO,BEDINDEX
          MOVE      SP70,FROMDATE
          MOVE      SP70,FROMTIME
          MOVE      SP70,UPDTBEDS
          MOVE      Z70,MONCLSED
          MOVE      Z70,TUECLSED
          MOVE      Z70,WEDCLSED
          MOVE      Z70,THUCLSED
          MOVE      Z70,FRICLSED
          MOVE      Z70,SATCLSED
          MOVE      Z70,SUNCLSED
          MOVE      Z70,RECCURNG
          MOVE      ZERO,REMOTENO
.
          MOVE      SP70,SUPERFLG 
          MOVE      SP70,PTWRD001 
          MOVE      SP70,PTWRD002 
          MOVE      SP70,PTWRD003 
          MOVE      SP70,PTWRD004 
          MOVE      SP70,PTWRD005 
          MOVE      ZERO,PTWRD006 
          MOVE      SP70,PTWRD007 
          MOVE      SP70,PTWRD008 
          MOVE      ZERO,PTWRD009 
          MOVE      ZERO,PTWRD010 
          MOVE      SP70,PTWRD011 
          MOVE      ZERO,PTWRD012
          MOVE      ZERO,PTWRD013
          MOVE      ZERO,PTWRD014
          MOVE      SP70,PTWRD015
          MOVE      SP70,PTWRD016
          MOVE      ZERO,PTWRD017
          MOVE      SP70,PTWRD018
          MOVE      ZERO,PTWRD019 
          MOVE      SP70,PTWRD020 
          MOVE      SP70,PTWRD021 
          MOVE      SP70,PTWRD022 
          MOVE      SP70,PTWRD023 
          MOVE      SP70,PTWRD024 
          MOVE      SP70,PTWRD025 
          MOVE      SP70,PTWRD026 
          MOVE      Z70,PTWRD027
          MOVE      Z70,PTWRD028
          MOVE      Z70,PTWRD029
          MOVE      Z70,PTWRD030
          MOVE      Z70,PTWRD031
          MOVE      Z70,PTWRD032
          MOVE      Z70,PTWRD033
          MOVE      Z70,PTWRD034
          MOVE      Z70,PTWRD035
          MOVE      Z70,PTWRD036
          MOVE      Z70,PTWRD037
          MOVE      Z70,PTWRD038
          MOVE      Z70,PTWRD039
          MOVE      Z70,PTWRD040
          MOVE      Z70,PTWRD041
          MOVE      Z70,PTWRD042
          MOVE      ZERO,LINKBTY 
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,FILTRSEX
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTBTYP
          MOVE      SP70,VYEARMTH
          MOVE      SP70,PTWBA001
          MOVE      SP70,PTWBA002
          MOVE      SP70,PTWBA003
          MOVE      SP70,PTWBA004
          MOVE      SP70,PTWBA005
          MOVE      SP70,PTWBA006
          MOVE      SP70,PTWBA007
          MOVE      SP70,PTWBA008
          MOVE      SP70,PTWBA009
          MOVE      SP70,PTWBA010
.
          MOVE      ONE,COUNTER             * Initialize Arrays
          WHILE     COUNTER <= 99
            MOVE      SP70,BEDCODES[COUNTER]
            MOVE      ZERO,BEDSOPEN[COUNTER]
            MOVE      ZERO,BEDSCLSE[COUNTER]
            MOVE      SP70,BEDSHKST[COUNTER]
            PACK      WEBWARNG[COUNTER],SP70,SP70
            ADD       ONE,COUNTER
          DO
.
          CALL      CPPMBC00
.
          MOVE      SP70,CALCDATE
          MOVE      ZERO,DATESRCH
          MOVE      ZERO,REMOTLST
          MOVE      ZERO,BEDREQST
          MOVE      Z70,HEROLOCI
          MOVE      Z70,HEROTYPE
          MOVE      Z70,HEROWARD
          MOVE      Z70,HEROBEDD
          MOVE      ZERO,NOEXPECT
          MOVE      SP70,FROMLIST
.
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHIRBUND
          MOVE      ZERO,DISNUMB
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIREC1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,admissno
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPERFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "efctdate=",QRYNAME
          IF        @EQUAL
            RESET     QRYDATA 
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      EFCTDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",EFCTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            PACK      WARDCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emptonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMPTONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedsonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDSONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedavail=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDAVAIL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "empbedfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMPBEDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reccurng=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECCURNG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "monclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MONCLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tueclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TUECLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wedclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WEDCLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thuclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THUCLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "friclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRICLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "satclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SATCLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sunclsed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUNCLSED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clsfrdte=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      CLSFRDTE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CLSFRDTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clsfrtme=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLSFRTME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clstodte=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      CLSTODTE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CLSTODTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clstotme=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLSTOTME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clreason=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLREASON
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clreasfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLREASFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cldoctor=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLDOCTOR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formactn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMACTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedindex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDINDEX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fromdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FROMDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fromtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FROMTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptwrd",QRYNAME
          IF        @EQUAL
            CALL      STWRD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsbc",QRYNAME
          IF        @EQUAL
            CALL      SPMBC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedcde",QRYNAME
          IF        @EQUAL
            CALL      STBCD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "openbd",QRYNAME
          IF        @EQUAL
            CALL      STOPB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clsebd",QRYNAME
          IF        @EQUAL
            CALL      STCLB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hkstat",QRYNAME
          IF        @EQUAL
            CALL      STBHK000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHOSP
            PACK      FILTHOSP,FILTHOSP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtrsex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTRSEX
            PACK      FILTRSEX,FILTRSEX,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtbtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTBTYP
            PACK      FILTBTYP,FILTBTYP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updtbeds=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTBEDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptwba",QRYNAME
          IF        @EQUAL
            CALL      STWBA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "datesrch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DATESRCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "calcdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CALCDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heroloci=",QRYNAME
          IF        @EQUAL
            PACK      HEROLOCI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "herotype=",QRYNAME
          IF        @EQUAL
            PACK      HEROTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heroward=",QRYNAME
          IF        @EQUAL
            PACK      HEROWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "herobedd=",QRYNAME
          IF        @EQUAL
            PACK      HEROBEDD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "noexpect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOEXPECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fromlist=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FROMLIST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirbund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRBUND
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Bed Codes array
.----------------------------------------------------------------
STBCD000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      BEDCODES[F2],QRYDATA,SP70
.
STBCD999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Array of Beds to be Open
.----------------------------------------------------------------
STOPB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      BEDSOPEN[F2],QRYDATA,SP70
.
STOPB999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Array of Beds to be Closed
.----------------------------------------------------------------
STCLB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      BEDSCLSE[F2],QRYDATA,SP70
.
STCLB999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Bed House Keeping Status array
.----------------------------------------------------------------
STBHK000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      BEDSHKST[F2],QRYDATA,SP70
.
STBHK999  RETURN
.
.-------------------------------------------------------------------------------
.   Set Parameters for Option 4 - Ward Bed Details
.-------------------------------------------------------------------------------
STWRD000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STWRD001,STWRD002,STWRD003,STWRD004,STWRD005,STWRD006:
                       STWRD007,STWRD008,STWRD009,STWRD010,STWRD011,STWRD012:
                       STWRD013,STWRD014,STWRD015,STWRD016,STWRD017,STWRD018:
                       STWRD019,STWRD020,STWRD021,STWRD022,STWRD023,STWRD024:
                       STWRD025,STWRD026,STWRD027,STWRD028,STWRD029,STWRD030:
                       STWRD031,STWRD032,STWRD033,STWRD034,STWRD035,STWRD036:
                       STWRD037,STWRD038,STWRD039,STWRD040,STWRD041,STWRD042
.
          GOTO      STWRD999
.
STWRD001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PTWRD001
          PACK      PTWRD001,PTWRD001,SP70       
          GOTO      STWRD999
STWRD002  SQUEEZE   QRYDATA 
          MOVE      QRYDATA,PTWRD002
          PACK      PTWRD002,PTWRD002,SP70       
          GOTO      STWRD999
STWRD003  MOVE      QRYDATA,PTWRD003
          PACK      PTWRD003,PTWRD003,SP70
          GOTO      STWRD999
STWRD004  MOVE      QRYDATA,PTWRD004
          GOTO      STWRD999
STWRD005  MOVE      QRYDATA,PTWRD005
          GOTO      STWRD999
STWRD006  MOVE      QRYDATA,PTWRD006
          GOTO      STWRD999
STWRD007  MOVE      QRYDATA,PTWRD007
          GOTO      STWRD999
STWRD008  MOVE      QRYDATA,PTWRD008
          GOTO      STWRD999
STWRD009  MOVE      QRYDATA,PTWRD009
          GOTO      STWRD999
STWRD010  MOVE      QRYDATA,PTWRD010
          GOTO      STWRD999
STWRD011  MOVE      QRYDATA,PTWRD011
          GOTO      STWRD999
STWRD012  MOVE      QRYDATA,PTWRD012
          GOTO      STWRD999
STWRD013  MOVE      QRYDATA,PTWRD013
          GOTO      STWRD999
STWRD014  MOVE      QRYDATA,PTWRD014
          GOTO      STWRD999
STWRD015  MOVE      QRYDATA,PTWRD015
          GOTO      STWRD999
STWRD016  MOVE      QRYDATA,PTWRD016
          GOTO      STWRD999
STWRD017  MOVE      QRYDATA,PTWRD017
          GOTO      STWRD999
STWRD018  MOVE      QRYDATA,PTWRD018
          GOTO      STWRD999
STWRD019  MOVE      QRYDATA,PTWRD019
          GOTO      STWRD999
STWRD020  MOVE      QRYDATA,PTWRD020
          GOTO      STWRD999
STWRD021  MOVE      QRYDATA,PTWRD021
          GOTO      STWRD999
STWRD022  MOVE      QRYDATA,PTWRD022
          GOTO      STWRD999
STWRD023  MOVE      QRYDATA,PTWRD023
          GOTO      STWRD999
STWRD024  MOVE      QRYDATA,PTWRD024
          GOTO      STWRD999
STWRD025  MOVE      QRYDATA,PTWRD025
          GOTO      STWRD999
STWRD026  MOVE      QRYDATA,PTWRD026
          GOTO      STWRD999
.
STWRD027  MOVE      QRYDATA,PTWRD027
          GOTO      STWRD999
.
STWRD028  MOVE      QRYDATA,PTWRD028
          GOTO      STWRD999
.
STWRD029  MOVE      QRYDATA,PTWRD029
          GOTO      STWRD999
.
STWRD030  MOVE      QRYDATA,PTWRD030
          GOTO      STWRD999
.
STWRD031  MOVE      QRYDATA,PTWRD031
          GOTO      STWRD999
.
STWRD032  PACK      QRYDATA,QRYDATA,SP70
          MATCH     SP70,QRYDATA
          GOTO      STWRD999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTWRD032,CCENT,CYEAR,CMON,CDAY
          GOTO      STWRD999
.
STWRD033  MOVE      QRYDATA,PTWRD033
          GOTO      STWRD999
.
STWRD034  MOVE      QRYDATA,PTWRD034
          GOTO      STWRD999
.
STWRD035  PACK      QRYDATA,QRYDATA,SP70
          MATCH     SP70,QRYDATA
          GOTO      STWRD999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTWRD035,CCENT,CYEAR,CMON,CDAY
          GOTO      STWRD999
.
STWRD036  MOVE      QRYDATA,PTWRD036
          GOTO      STWRD999
.
STWRD037  MOVE      QRYDATA,PTWRD037
          GOTO      STWRD999
.
STWRD038  MOVE      QRYDATA,PTWRD038
          GOTO      STWRD999
.
STWRD039  MOVE      QRYDATA,PTWRD039
          GOTO      STWRD999
.
STWRD040  MOVE      QRYDATA,PTWRD040
          GOTO      STWRD999
.
STWRD041  MOVE      QRYDATA,PTWRD041
          GOTO      STWRD999
.
STWRD042  MOVE      QRYDATA,PTWRD042
          GOTO      STWRD999
.
STWRD999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 7 - Ward Bed Attributes
.-------------------------------------------------------------------------------
STWBA000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STWBA001,STWBA002,STWBA003,STWBA004,STWBA005:
                       STWBA006,STWBA007,STWBA008,STWBA009,STWBA010
.
          GOTO      STWBA999
.
STWBA001  MOVE      QRYDATA,PTWBA001
          GOTO      STWRD999
.
STWBA002  MOVE      QRYDATA,PTWBA002
          GOTO      STWRD999
.
STWBA003  MOVE      QRYDATA,PTWBA003
          GOTO      STWRD999
.
STWBA004  MOVE      QRYDATA,PTWBA004
          GOTO      STWRD999
.
STWBA005  MOVE      QRYDATA,PTWBA005
          GOTO      STWRD999
.
STWBA006  MOVE      QRYDATA,PTWBA006
          GOTO      STWRD999
.
STWBA007  MOVE      QRYDATA,PTWBA007
          GOTO      STWRD999
.
STWBA008  MOVE      QRYDATA,PTWBA008
          GOTO      STWRD999
.
STWBA009  MOVE      QRYDATA,PTWBA009
          GOTO      STWRD999
.
STWBA010  MOVE      QRYDATA,PTWBA010
          GOTO      STWRD999
.
STWBA999  RETURN
.------------------------------------------------------------
.   Ward: Display,Add,Update,Delete
.------------------------------------------------------------
PATWRD00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PATWRD50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PATWRD10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PATWRD20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete ward formaction
          GOTO      PATWRD30 IF EQUAL
.
          MATCH     "B",UPDTTYPE    * Delete bed formaction
          GOTO      PATWRD40 IF EQUAL
.
          GOTO      PATWRD93
.
.         ************ ADD FORMACTION ***********
.
PATWRD10  CALL      CHKWRD00      * Checks mandatory fields
          BRANCH    EXIT,PATWRD99
.
          PACK      KEY6,PTWRD001,PTWRD002,SP70
          CALL      RDWARD1
          COMPARE   ZERO,OVRCD
          GOTO      PATWRD92 IF EQUAL
.
          MOVE      PTWRD007,WBHRTYP * Room Type (Category RT)
          MOVE      ONE,WACTIVE      * Default to not active
          IF        PTWRD017=2
            MOVE      ZERO,WACTIVE   * active
          ENDIF
          MOVE      PTWRD014,WBHNOCC * No. of beds for occup stats
          MOVE      PTWRD015,WBHCLAS * Ward Classification (Category CG)
          CALL      WRDHIS00         * Write Ward History Record           
          BRANCH    EXIT,PATWRD99
.
          CALL      SAVWRD00         * Moves input variables to file variables
          MOVE      ZEROVISN,WADMNO
          PACK      PTWDCRDT,CCC,CYY,CMM,CDD * set create date
          REP       " 0",PTWDCRDT
          MOVE      CTIMEIS,PTWDCRTM         * set create time
          MOVE      WBSEUID,PTWDCRID         * set create user id
          PACK      KEY6,PTWRD001,SP70
          CALL      WRWARD1          * Writes away the data
.
          MOVE      "A",KEY1         * Set Action Parameter For Audit          
          CALL      WRDAUD00         * Write Audit file if needed  
.
          CALL      HERA0000         * Add Hero location record
.
          MOVE      ZERO,EXIT
          GOTO      PATWRD99
.
.         ************ UPDATE FORMACTION **********
.
PATWRD20  MOVE      ZERO,UPDATBED                 * Set update beds to no
          PACK      KEY6,PTWRD001,PTWRD002,SP70   * Update Formaction
          CALL      RDWARD1
          BRANCH    OVRCD,PATWRD91
.
          CALL      CHKFLD00      * Checks mandatory fields
          BRANCH    EXIT,PATWRD99
.
          MOVE      "B",KEY1      * Set Action Parameter For Audit          
          CALL      WRDAUD00      * Write Audit file if needed  
.
          PACK      KEY6,PTWRD001,PTWRD002,SP70 
          CALL      RLWARD1       * Read Lock Record      
.
          IF        HISFLAG=1
            CALL      WRDHIS00       * Write Ward History Record           
            BRANCH    EXIT,PATWRD99
          ENDIF
.
          MATCH     SP70,PTWRD002     * Only check bed update on ward master
          GOTO      PATWRD25 IF NOT EQUAL
.
          MATCH     "1",UPDTBEDS
          IF        @EQUAL
            MOVE      ONE,UPDATBED
          ENDIF
.
          MATCH     PTWRD018,PTWDHOSN * Has the hospital code changed
          GOTO      PATWRD25 IF EQUAL
.
          MOVE      ONE,UPDATBED      * Yes update hospital code on all beds
.
PATWRD25  CALL      SAVWRD00      * Moves input variables to file variables
          CALL      UPWARD1       * Writes away the data
          CALL      ULWARD1       * Unlocks IO
.
          MOVE      "C",KEY1      * Set Action Parameter For Audit          
          CALL      WRDAUD00      * Write Audit file if needed  
.
          IF        UPDATBED=1
            CALL      UPDB0000    * Update hospital code in all beds
          ENDIF
.
          CALL      HERU0000      * Update Hero location record
.
          MOVE      ZERO,EXIT
          GOTO      PATWRD99
.
.         ************ DELETE WARD FORMACTION **********
.
PATWRD30  PACK      KEY6,PTWRD001,SP70   * Delete Formaction
          CALL      RDWARD1
          BRANCH    OVRCD,PATWRD91
.
          CALL      RDSWARD1
PATWRD31  CALL      RDKWARD1             * Can't delete a ward if there are beds
          BRANCH    OVRCD,PATWRD32       
.
          MATCH     PTWRD001,WWARD
          GOTO      PATWRD32 IF NOT EQUAL
.
          GOTO      PATWRD96
.
PATWRD32  PACK      KEY6,PTWRD001,SP70   * Deletes Ward     
          CALL      DEWARD1
.
          CALL      DELHIS00      * Delete Ward History
.
          PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
          CALL      DEPMUHL1      * Delete HERO location id
.
          MOVE      "D",KEY1      * Set Action Parameter For Audit          
          CALL      WRDAUD00      * Write Audit file if needed  
.
          MOVE      ZERO,EXIT
          GOTO      PATWRD99
.
.         ************ DELETE BED FORMACTION **********
.
PATWRD40  PACK      KEY6,PTWRD001,PTWRD002,SP70   * Delete Bed Formaction
          CALL      RDWARD1
          BRANCH    OVRCD,PATWRD94
.
          MATCH     ZEROVISN,WADMNO
          GOTO      PATWRD95 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70
          CALL      DEWARD1       * Delete Bed
.
          CALL      DLBHIS00      * Delete Bed History records
          CALL      DLBCLS00      * Delete Bed Closure records
.
          PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
          CALL      DEPMUHL1      * Delete HERO location id
.
          MOVE      "D",KEY1      * Set Action Parameter For Audit
          CALL      WRDAUD00      * Write Audit file if needed
.
          MOVE      ZERO,EXIT
          GOTO      PATWRD99
.
.         ************ DISPLAY FORMACTION **********
.
PATWRD50  PACK      KEY6,PTWRD001,PTWRD002,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            MATCH     SP70,PTWRD001
            IF        !@EQUAL
              BRANCH    FHIRTYPE,PATWRD91
            ENDIF
            CALL      CLRWRD00    * Clear all the file variables
          ENDIF
.
          PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
          CALL      RDPMUHL1
          IF        OVRCD=1
            UNPACK    SP70,PMULTYPE,PMULWDCD,PMULBDCD,PMULUHID
          ENDIF
.
          PACK      KEY14,PTWRD001,SP70     * Read Ward History for Effective Dt
          CALL      RSPTWBH1
          CALL      RKPTWBH1
          IF        OVRCD <> 1
            MATCH     PTWRD001,WBHWARD
            IF        @EQUAL
              MATCH     SP3,WBHBED          * Ward record has blank Bed code
              GOTO      PATWRD55 IF EQUAL
            ENDIF
          ENDIF
.
          UNPACK    SP70,WBHWARD,WBHBED,WBHDATE
.
PATWRD55  CLEAR     WEBTITLE
          MOVE      "Ward/Bed Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATWRD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD91  MOVE      "Ward does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD92  MOVE      "Ward record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD94  MOVE      "Bed record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD95  MOVE      "Can not delete an occupied bed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD96  MOVE      "Can not delete bed records exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATWRD99
.
PATWRD99  RETURN
.
.------------------------------------------------------------------------------
. Add HERO location id record for ward/bed to PMSUHLFD
.------------------------------------------------------------------------------
HERA0000  MATCH     Z70,HEROLOCI
          GOTO      HERA9999 IF EQUAL
.
          MATCH     SP70,HEROLOCI
          GOTO      HERA9999 IF EQUAL
.
          PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
          CALL      RDPMUHL1
          IF        OVRCD=1
            MOVE      ONE,PMULTYPE
            PACK      PMULWDCD,PTWRD001,SP70
            PACK      PMULBDCD,PTWRD002,SP70
            PACK      PMULUHID,HEROLOCI,SP70
            PACK      PMULSPAR,SP70
            CALL      WRPMUHL1
          ENDIF
.
HERA9999  RETURN
.
.------------------------------------------------------------------------------
. Update HERO location id record for ward/bed to PMSUHLFD
.------------------------------------------------------------------------------
HERU0000  MATCH     Z70,HEROLOCI
          GOTO      HERU9999 IF EQUAL
.
          MATCH     SP70,HEROLOCI
          IF        @EQUAL
            PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
            CALL      DEPMUHL1
            GOTO      HERU9999
          ENDIF
.
          PACK      KEY7,ONE,PTWRD001,PTWRD002,SP70
          CALL      RDPMUHL1
          IF        OVRCD=1
            MOVE      ONE,PMULTYPE
            PACK      PMULWDCD,PTWRD001,SP70
            PACK      PMULBDCD,PTWRD002,SP70
            PACK      PMULUHID,HEROLOCI,SP70
            PACK      PMULSPAR,SP70
            CALL      WRPMUHL1
          ELSE
            PACK      PMULUHID,HEROLOCI,SP70
            CALL      UPPMUHL1
          ENDIF
.
HERU9999  RETURN
.
.------------------------------------------------------------------------------
.                         Modify Available Beds
.------------------------------------------------------------------------------
MODAVB00  STRIP     REDIRECT           * Construct Redirect string using 
          ENDSET    REDIRECT           * REDIRECT and REDIREC1 variables
          APPEND    REDIREC1,REDIRECT  * This is required as overall length
          RESET     REDIRECT           * of REDIRECT is greater than 127 chars.
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MODAVB40 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Update (Open and Close) Beds
          GOTO      MODAVB10 IF EQUAL
.
          MATCH     "O",UPDTTYPE       * Open Beds 
          GOTO      MODAVB20 IF EQUAL
.
          MATCH     "C",UPDTTYPE       * Close Beds 
          GOTO      MODAVB30 IF EQUAL
.
          GOTO      MODAVB91
.
.-----------------------------------------------------------------------------
.                  Update (Open and Close) Beds
.-----------------------------------------------------------------------------
MODAVB10  MOVE      ZERO,WARCOUNT      * Initialize Warning Counter
          CALL      CHKOPN00           * Open Specified Beds
          CALL      CLSTYP00           * Check Closure Type (Curr/Future)
          CALL      CHKCLS00           * Close Specified Beds
          CALL      CHKHKS00           * Check (Update) House Keeping Status
.
          IF        WARCOUNT>ZERO
            CALL      WEBWAR00              * Display Warnings
            MOVE      ONE,EXIT
            GOTO      MODAVB99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MODAVB99
.
.------------------------------------------------------------------------------
.                             Open Beds
.------------------------------------------------------------------------------
MODAVB20  MOVE      ZERO,WARCOUNT      * Reset Warning Counter
          CALL      CHKOPN00           * Open Specified Beds
          CALL      CHKHKS00           * Check (Update) House Keeping Status
.
          IF        WARCOUNT>ZERO
            CALL      WEBWAR00         * Display Warnings
            MOVE      ONE,EXIT
            GOTO      MODAVB99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MODAVB99
.
.------------------------------------------------------------------------------
.                             Close Beds
.------------------------------------------------------------------------------
MODAVB30  MOVE      ZERO,WARCOUNT      * Reset Warning Counter
          CALL      CLSTYP00           * Check Closure Type (Curr/Future)
          CALL      CHKCLS00           * Close Specified Beds
          CALL      CHKHKS00           * Check (Update) House Keeping Status
.
          IF        WARCOUNT>ZERO
            CALL      WEBWAR00         * Display Warnings
            MOVE      ONE,EXIT
            GOTO      MODAVB99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MODAVB99
.
.------------------------------------------------------------------------------
.                 Display Modify Available Beds Page
.------------------------------------------------------------------------------
MODAVB40  MATCH     SP70,WARDCODE           * Is selected Ward blank?
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE      * Yes, Default from user
          ENDIF
.
          MATCH     SP70,BEDAVAIL           * Is search criteria blank?
          GOTO      MODAVB45 IF EQUAL       * Yes, continue display
.
          PACK      KEY6,WARDCODE,SP70      * Read Ward selected to check
          CALL      RDWARD1                 * for Ward-Only wards.
          BRANCH    OVRCD,MODAVB92
.    
          COMPARE   ONE,WINPUT              * Is this a Ward-Only ward?
          GOTO      MODAVB93 IF EQUAL       * Yes, can't modify beds, exit.  
.
MODAVB45  CALL      WARDET00                * Ward details (Un-Alloc patients)
.
          CLEAR     WEBTITLE
          MOVE      "Ward/Bed Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MODAVB99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MODAVB99
.
MODAVB91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MODAVB99
.
MODAVB92  MOVE      "Ward Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MODAVB99
.
MODAVB93  MOVE      "Ward-Only Ward. Can not Modify Available Beds.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MODAVB99
.
MODAVB99  RETURN
.
.------------------------------------------------------------------------------
.                         Bed Closure Maintenance
.------------------------------------------------------------------------------
BEDCLS00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      BEDCLS40 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update Bed Closure Record
          GOTO      BEDCLS10 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete Bed Closure Record
          GOTO      BEDCLS20 IF EQUAL
.
          GOTO      BEDCLS91
.
.-----------------------------------------------------------------------------
.                    Update Bed Closure Record
.-----------------------------------------------------------------------------
BEDCLS10  PACK      KEY22,PMSBC001,PMSBC002,PMSBC003,PMSBC004,SP70
          CALL      RDPMBDC1           * Read record to be updated
          BRANCH    OVRCD,BEDCLS92
.
          MATCH     "1",SUPERFLG
          IF        @EQUAL
            MOVE      "1",PMBCTOPR       * Set 'Closure To' not processed
          ELSE
            MATCH     "1",PMBCTOPR       * Is 'Closure To' processed?
            GOTO      BEDCLS93 IF EQUAL  * Yes, can not Update.
          ENDIF
.
          MOVE      KEY22,SAVKEY22
.
          CALL      CHKNXT00           * Check against next closure record
          BRANCH    EXIT,BEDCLS95      * Overlapping Closure period, error.
.
          MOVE      SAVKEY22,KEY22
          CALL      RDPMBDC1
.
          MOVE      ZERO,UPDREASN      * Reset 'Update Closure Reason' flag
          MATCH     PMBCREAS,PMSBC007  * Is 'Closure Reason' field the same?
          IF        !@EQUAL
            MOVE      ONE,UPDREASN     * No, set 'Update Closure Reason' flag
          ENDIF
.
          PACK      KEY22,PMSBC001,PMSBC002,PMSBC003,PMSBC004,SP70
          CALL      RDPMBDC1
          BRANCH    OVRCD,BEDCLS92
.
          MOVE      PMSBC005,PMBCTODT       * Set new Closed To Date
          MOVE      PMSBC006,PMBCTOTM       * Set new Closed To Time
          MOVE      PMSBC007,PMBCREAS       * Set new Reason for closure
.
          MATCH     Z70,PMSBC014
          IF        !@EQUAL
            MOVE      PMSBC014,PMBCFTRC       * Set new Reason for closure
          ENDIF
.
          MATCH     Z70,PMSBC015
          IF        !@EQUAL
            MOVE      PMSBC015,PMBCDOCT       * Hold for doctor
          ENDIF
.
          PACK      PMBCUPDT,CCC,CYY,CMM,CDD
          REP       " 0",PMBCUPDT           * Set update date (current date)
          MOVE      CTIMEIS,PMBCUPTM        * Set update time (current time)
          MOVE      WBSEUID,PMBCUPID        * Set update user id
.
          CALL      UPPMBDC1                * Update Bed Closure record
.
          MATCH     "1",UPDREASN            * Is 'Update Cls Reason' flag set?
          GOTO      BEDCLS15 IF NOT EQUAL   * No, Update completed, exit
.
.         Update Bed CLosure Reason on the Ward/Bed file.
.
          PACK      KEY6,PMSBC001,PMSBC002,SP70
          CALL      RDWARD1                 * Read Ward/Bed file
          BRANCH    OVRCD,BEDCLS96
.
          MATCH     "1",PTWDBDST            * Is this Bed closed?
          GOTO      BEDCLS15 IF NOT EQUAL   * No, do not update, exit.
.
          MOVE      PMSBC007,PTWDRBSC       * Set new reason for bed closure
          CALL      UPWARD1                 * Update Ward/Bed file
.
BEDCLS15  MOVE      ZERO,EXIT
          GOTO      BEDCLS99
.
.-----------------------------------------------------------------------------
.                     Delete Bed Closure Record
.-----------------------------------------------------------------------------
BEDCLS20  PACK      KEY22,PMSBC001,PMSBC002,PMSBC003,PMSBC004,SP70
          CALL      RDPMBDC1
          BRANCH    OVRCD,BEDCLS92
.
          MATCH     "1",SUPERFLG
          IF        @EQUAL
            CALL      FIXWRD00
            GOTO      BEDCLS22
          ENDIF
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     PMBCFRDT,DIM8
          GOTO      BEDCLS22 IF LESS   
.
          MATCH     DIM8,PMBCTODT
          GOTO      BEDCLS22 IF LESS
.
          MATCH     "1",PMBCFRPR       * Is Closure From processed?
          GOTO      BEDCLS94 IF EQUAL  * Yes, can not delete.
          MATCH     "1",PMBCTOPR       * Is Closure To processed?
          GOTO      BEDCLS94 IF EQUAL  * Yes, can not delete.
.
BEDCLS22  CALL      DEPMBDC1           * Delete Bed Closure record         
          MOVE      ZERO,EXIT
          GOTO      BEDCLS99
.
.-----------------------------------------------------------------------------
.         Display Bed Closure Record
.-----------------------------------------------------------------------------
BEDCLS40  PACK      KEY22,PMSBC001,PMSBC002,FROMDATE,FROMTIME,SP70
          CALL      RDPMBDC1
          IF        OVRCD=1
            CALL      CLPMBC00         * Clear file variables
          ENDIF 
.
          MATCH     "1",SUPERFLG
          IF        !@EQUAL
            MATCH     "1",PMBCTOPR       * Is this record fully processed?
            GOTO      BEDCLS93 IF EQUAL  * Yes, can not display for maintenance
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Bed Closure Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MODAVB99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS92  MOVE      "Bed Closure record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS93  MOVE      "Processed Closure record can not be updated.",WEBTITLE
          CALL      BEDERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS94  MOVE      "Processed Closure record can not be deleted.",WEBTITLE
          CALL      BEDERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS95  MOVE      "Overlapping Closure periods - record not updated.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS96  MOVE      "Ward/Bed not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BEDCLS99
.
BEDCLS99  RETURN
.
.------------------------------------------------------------------------------
.        Fix existing ward record if closed and deleting bed closure
.------------------------------------------------------------------------------
FIXWRD00  PACK      KEY6,PMBCWARD,PMBCBED,SP70 
          CALL      RDWARD1
          BRANCH    OVRCD,FIXWRD99
.
          MATCH     "1",PTWDBDST                 * Is this bed closed?
          GOTO      FIXWRD99 IF NOT EQUAL        * No, go to exit.
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Set current date
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME             * Set current time
.
          MATCH     PMBCFRDT,CURRDATE
          GOTO      FIXWRD99 IF LESS
.
          MATCH     PMBCFRTM,CURRTIME
          GOTO      FIXWRD99 IF LESS
.
          MATCH     CURRDATE,PMBCTODT
          GOTO      FIXWRD99 IF LESS
.
          MATCH     CURRTIME,PMBCTOTM
          GOTO      FIXWRD99 IF LESS
.
          MOVE      ZERO,PTWDBDST                * Set Bed Status to Open
          MOVE      SP70,PTWDRBSC                * Clear reason for bed closure
          MOVE      CURRDATE,PTWDUPDT            * Set update date
          MOVE      CURRTIME,PTWDUPTM            * Set update time
          MOVE      WBSEUID,PTWDUPID             * Set update user id
.
          CALL      UPWARD1                      * Update Bed details

.
FIXWRD99  RETURN
+
.------------------------------------------------------------------------------
.                    Check Next Closure Record
. This procedure is called when updateing the Bed Closure record to check
. whether a new 'Closure To' date and time are not overlapping with the next
. closure scheduled for given Ward/Bed.
.
. RETURN VALUES: EXIT = 0  -  Allow update
.                EXIT = 1  -  Overlapping period (Update Invalid)
.------------------------------------------------------------------------------
CHKNXT00  MOVE      ZERO,EXIT
          PACK      KEY22,PMSBC001,PMSBC002,PMSBC003,PMSBC004,SP70
          CALL      RSPMBDC1
          CALL      RKPMBDC1                     * Read next closure record
          BRANCH    OVRCD,CHKNXT99               * Record not found, exit.
          MATCH     PMBCWARD,PMSBC001            * Same Ward?
          GOTO      CHKNXT99 IF NOT EQUAL        * No, exit.
          MATCH     PMBCBED,PMSBC002             * Same Bed?
          GOTO      CHKNXT99 IF NOT EQUAL        * No, exit.
.
          MATCH     PMSBC005,PMBCFRDT            * Is PMBCFRDT < new Cls To Dte?
          GOTO      CHKNXT90 IF LESS             * Overlapping period, invalid
          IF        @EQUAL
            MATCH     PMSBC006,PMBCFRTM          * Same date, do times overlap?
            GOTO      CHKNXT90 IF LESS           * Overlapping period, invalid
          ENDIF
.
          GOTO      CHKNXT99                     * Valid Update, go to exit.
.
CHKNXT90  MOVE      ONE,EXIT                     * Set 'Invalid Update'. 
          GOTO      CHKNXT99
.
CHKNXT99  RETURN
.
.------------------------------------------------------------------------------
.                                WBAM0000                   Called By PROFLD71
.                      Ward Bed Attributes Display
.------------------------------------------------------------------------------
WBAM0000  BRANCH    FLDITMNO,WBAM0100,WBAM0200,WBAM0300,WBAM0400,WBAM0500:
                             WBAM0600,WBAM0700,WBAM0800,WBAM0900,WBAM1000:
                             WBAM1100,WBAM1200
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WBAM9999
.
WBAM0100  WRITE     HTMLFILE;PTWAWARD;                   * Ward
          GOTO      WBAM9999                             * %PATWEB95.07.001
.
WBAM0200  WRITE     HTMLFILE;PTWABED;                    * Bed
          GOTO      WBAM9999                             * %PATWEB95.07.002
.
WBAM0300  UNPACK    DIM127,D1,KEY1,DIM127                * Attribute
          MATCH     "0",KEY1                             * %PATWEB95.07.003
          IF        @EQUAL
            WRITE     HTMLFILE;PTWABATR;                 * .0=code .1=desc
          ELSE
            PACK      KEY5,CATat,PTWABATR,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;TDESC
            ELSE
              WRITE     HTMLFILE;PTWABATR
            ENDIF
          ENDIF
          GOTO      WBAM9999
.
WBAM0400  WRITE     HTMLFILE;PTWAHOSP;                   * Hospital
          GOTO      WBAM9999                             * %PATWEB95.07.004
.
WBAM0500  UNPACK    PTWADTCR,CCENT,CYEAR,CMON,CDAY       * Date Created
          MOVE      CMON,F2                              * %PATWEB95.07.005
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WBAM9999
.
WBAM0600  WRITE     HTMLFILE;PTWATMCR;                   * Time Created
          GOTO      WBAM9999                             * %PATWEB95.07.006
.
WBAM0700  PACK      KEY10,PTWAIDCR,SP70
          CALL      RDWBSE1                              * %PATWEB95.07.007
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM;
          ELSE
            WRITE     HTMLFILE;PTWAIDCR;
          ENDIF
          GOTO      WBAM9999
.
WBAM0800  UNPACK    PTWADTUP,CCENT,CYEAR,CMON,CDAY       * Date Updated
          MOVE      CMON,F2                              * %PATWEB95.07.008
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WBAM9999
.
WBAM0900  WRITE     HTMLFILE;PTWATMUP;                   * Time Updated
          GOTO      WBAM9999                             * %PATWEB95.07.009
.
WBAM1000  PACK      KEY10,PTWAIDUP,SP70                  * Updated By
          CALL      RDWBSE1                              * %PATWEB95.07.010
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM;
          ELSE
            WRITE     HTMLFILE;PTWAIDUP;
          ENDIF
          GOTO      WBAM9999
.
WBAM1100  PACK      KEY9,PTWBA001,SP70                   * Ward has attribute?
          REP       "+ ",KEY9                            * %PATWEB95.07.011
          CALL      RSPTWBA1
          CALL      RKPTWBA1
          IF        OVRCD=1
            WRITE     HTMLFILE;"0";
            GOTO        WBAM9999
          ENDIF
.
          MATCH     PTWBA001,PTWAWARD
          IF        @EQUAL
            WRITE     HTMLFILE;"1";                      * 1+ Attribute Exists
          ELSE
            WRITE     HTMLFILE;"0";                      * No attributes
          ENDIF
.
          GOTO        WBAM9999
.
.*******  List Ward Attributes *********************
.
WBAM1200  PACK      KEY9,PTWBA001,SP70
          REP       "+ ",KEY9
          CALL      RSPTWBA1
WBAM1201  CALL      RKPTWBA1
          BRANCH    OVRCD,WBAM9999
.
          MATCH     PTWBA001,PTWAWARD
          GOTO      WBAM9999 IF NOT EQUAL 
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;&nbsp;&nbsp;":
                             "<a href='javascript:UpdateAttribute(":
                             "#"patweb95.pbl?reportno=07&template=003":
                             "&ptwba001=",PTWBA001,"&ptwba003=",PTWABATR:
                             "#")'>":
                             "<img src=../images/MaintenanceIcon.gif ":
                             "hspace=4 border=0 align=absmiddle></a>";
.
          PACK      KEY5,CATat,PTWABATR,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            WRITE     HTMLFILE;PTWABATR,"</td></tr>"
          ELSE
            WRITE     HTMLFILE;TDESC,"</td></tr>"
          ENDIF
.
          GOTO      WBAM1201
.
WBAM9999  RETURN
.------------------------------------------------------------------------------
.                                MWBA0000                   Called By MAIN1700
.                     Ward Bed Attributes Maintenance
.------------------------------------------------------------------------------
MWBA0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MWBA0040 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Add Ward/Bed Attributes
          GOTO      MWBA0010 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update Ward/Bed Attributes
          GOTO      MWBA0020 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete Ward/Bed Attributes
          GOTO      MWBA0030 IF EQUAL
.
          GOTO      MWBA0090
.
MWBA0010  PACK      KEY9,PTWBA001,PTWBA002,PTWBA003,SP70
          CALL      RDPTWBA1
          IF        OVRCD=0
            GOTO      MWBA0091
          ELSE
            CALL      IBACLOCK
            PACK      PTWAWARD,PTWBA001,SP70
            PACK      PTWABED,PTWBA002,SP70
            PACK      PTWABATR,PTWBA003,SP70
            PACK      PTWAHOSP,PTWDHOSN,SP70
            PACK      PTWADTCR,CCC,CYY,CMM,CDD
            REP       " 0",PTWADTCR
            PACK      PTWATMCR,CTIMEIS
            PACK      PTWAIDCR,USERID,SP70
            CLEAR     PTWADTUP
            CLEAR     PTWATMUP
            CLEAR     PTWAIDUP
            CALL      WRPTWBA1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MWBA9999
.
MWBA0020  PACK      KEY9,PTWBA001,PTWBA002,PTWBA003,SP70
          CALL      RDPTWBA1
          IF        OVRCD=1
            GOTO      MWBA0092
          ELSE
            CALL      IBACLOCK
            PACK      PTWAWARD,PTWBA001,SP70
            PACK      PTWABED,PTWBA002,SP70
            PACK      PTWABATR,PTWBA003,SP70
            PACK      PTWAHOSP,PTWDHOSN,SP70
            PACK      PTWADTUP,CCC,CYY,CMM,CDD
            REP       " 0",PTWADTUP
            PACK      PTWATMUP,CTIMEIS
            PACK      PTWAIDUP,USERID,SP70
            CALL      UPPTWBA1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MWBA9999
.
MWBA0030  PACK      KEY9,PTWBA001,SP3,PTWBA003,SP70
          CALL      RDPTWBA1
          IF        OVRCD=1
            GOTO      MWBA0093
          ELSE
            CALL      DEPTWBA1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MWBA9999
.
.         ********* DISPLAY FORMACTION ***************
.
MWBA0040  PACK      KEY6,PTWBA001,SP70
          CALL      RDWARD1 
          IF        OVRCD=1
            GOTO      MWBA0094
          ENDIF
.
          PACK      KEY9,PTWBA001,SP3,PTWBA003
          CALL      RDPTWBA1
          IF        OVRCD=1
            CALL      CLPTWA00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Ward/Bed Attribute Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MWBA9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
.         ********* ERROR MESSAGES *******************
.
MWBA0090  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
MWBA0091  MOVE      "Attribute already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
MWBA0092  MOVE      "Attribute does not exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
MWBA0093  MOVE      "Attribute does not exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
MWBA0094  MOVE      "Error Reading Ward.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWBA9999
.
MWBA9999
.
.------------------------------------------------------------
. Clear File Variables - Ward Bed Attributes
.------------------------------------------------------------
CLPTWA00  MOVE      SP70,PTWAWARD
          MOVE      SP70,PTWABED
          MOVE      SP70,PTWABATR
          MOVE      SP70,PTWAHOSP
          MOVE      SP70,PTWADTCR
          MOVE      SP70,PTWATMCR
          MOVE      SP70,PTWAIDCR
          MOVE      SP70,PTWADTUP
          MOVE      SP70,PTWATMUP
          MOVE      SP70,PTWAIDUP
          MOVE      SP70,PTWASPAR
.
CLPTWA99  RETURN
.------------------------------------------------------------------------------
. Output HTML Error File
.------------------------------------------------------------------------------
BEDERR00  CALL      OPENHTML
          BRANCH    EXIT,BEDERR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
           " var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                    "  alert(#"",WEBTITLE,"#");":
                    "  if (window.name.substr(0,4)=='Hide') {":
                    "    self.close();} else {":
                    "  if (PopUpScreen) {":
                    "    reloadParentFrame(); } else {":
                    "    history.go(-1) } }":
                    "</script>",012
.
          CALL      CLOSHTML     * End of Document
          GOTO      BEDERR99
.
BEDERR95  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
BEDERR99  RETURN
.
.------------------------------------------------------------------------------
.                             Ward Details
.       This procedure calculates the number of Unallocated patients.
.------------------------------------------------------------------------------
WARDET00  MOVE      ZERO,NUMNOBED
          PACK      KEY13,WARDCODE,SP70
          CALL      RDSNOBE1
WARDET10  CALL      RDKNOBE1
          BRANCH    OVRCD,WARDET99
          MATCH     WARDCODE,NBWARD
          GOTO      WARDET99 IF NOT EQUAL
.
          ADD       ONE,NUMNOBED
          GOTO      WARDET10
.
WARDET99  RETURN
.
.------------------------------------------------------------------------------
.                Check House Keeping Status For All Beds
.------------------------------------------------------------------------------
CHKHKS00  MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      COUNTER,BEDINDEX
            CALL      UPDHKS00
            ADD       ONE,COUNTER
          DO
.
CHKHKS99  RETURN
.
.------------------------------------------------------------------------------
.                Update House Keeping Status For a Bed
.
. INPUT : BEDINDEX - Index to the BEDCODES array at which the Bedcode for bed 
.                    to be updated is stored.
.------------------------------------------------------------------------------
UPDHKS00  PACK      KEY6,WARDCODE,BEDCODES[BEDINDEX],SP70
          CALL      RDWARD1
          BRANCH    OVRCD,UPDHKS99
.
          MATCH     BEDSHKST[BEDINDEX],PTWDHKST  * Same House Keeping Status?
          GOTO      UPDHKS99 IF EQUAL            * Yes, do not update
.
          MOVE      BEDSHKST[BEDINDEX],PTWDHKST  * Set House Keeping Status
          PACK      PTWDUPDT,CCC,CYY,CMM,CDD     * Set Update Date
          REP       " 0",PTWDUPDT
          MOVE      CTIMEIS,PTWDUPTM             * Set Update Time
          MOVE      WBSEUID,PTWDUPID             * Set Update User Id
.
          CALL      UPWARD1
.
UPDHKS99  RETURN
.
.------------------------------------------------------------------------------
.                    Check for Beds to be Opened 
.------------------------------------------------------------------------------
CHKOPN00  MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      COUNTER,BEDINDEX
            MATCH     "1",BEDSOPEN[BEDINDEX]     * Is Bed marked for opening?
            IF        @EQUAL
              CALL      OPNBED00                 * Yes, open this bed
            ENDIF
            ADD       ONE,COUNTER
          DO
.
CHKOPN99  RETURN
.------------------------------------------------------------------------------
.                           Open Bed
. This procedure 'opens' the specified bed. It updates Ward/Bed file to change
. the bed status to open and the Bed Closures file to finalise the closure
. record.
.
. INPUT : BEDINDEX - Index to the BEDCODES array at which the Bedcode for bed 
.                    to be opened is stored.
.------------------------------------------------------------------------------
OPNBED00  PACK      KEY6,WARDCODE,BEDCODES[BEDINDEX],SP70
          CALL      RDWARD1
          BRANCH    OVRCD,OPNBED99               * Ward/Bed not found, exit.
.
          MATCH     "1",PTWDBDST                 * Is this bed closed?
          GOTO      OPNBED99 IF NOT EQUAL        * No, go to exit.
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Set current date
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME             * Set current time
.
          MOVE      BEDSHKST[BEDINDEX],PTWDHKST  * Set House Keeping Status
          MOVE      ZERO,PTWDBDST                * Set Bed Status to Open
          MOVE      SP70,PTWDRBSC                * Clear reason for bed closure
          MOVE      CURRDATE,PTWDUPDT            * Set update date
          MOVE      CURRTIME,PTWDUPTM            * Set update time
          MOVE      WBSEUID,PTWDUPID             * Set update user id
.
          CALL      UPWARD1                      * Update Bed details
.
.         Read Patient Bed Closure Details file to find the record
.         corresponding to the current bed closure. Once this record is found
.         the 'Closure To' date and time are set to current date and time.
.
          PACK      KEY22,WARDCODE,BEDCODES[BEDINDEX],CURRDATE,CURRTIME,SP70
          CALL      RDPMBDC1
          IF        OVRCD=0 
            GOTO      OPNBED20    * Found exact match - process this record
          ENDIF
.
          CALL      RPPMBDC1      * Read previous to get current closure record
          BRANCH    OVRCD,OPNBED99
          MATCH     PMBCWARD,WARDCODE            * Same ward?
          GOTO      OPNBED99 IF NOT EQUAL        * Closure row not found - exit
          MATCH     PMBCBED,BEDCODES[BEDINDEX]   * Same bed?
          GOTO      OPNBED99 IF NOT EQUAL        * Closure row not found - exit
          MATCH     PMBCTODT,CURRDATE            * Is Curr Date < Close To Date?
          GOTO      OPNBED20 IF LESS             * Yes, found curr closure row
          IF        @EQUAL
            MATCH     PMBCTOTM,CURRTIME          * Is Curr Time < Close To Time?
            GOTO      OPNBED20 IF LESS           * Yes, found curr closure row
            MATCH     "1",PMBCTOPR               * Past row, is it processed?
            GOTO      OPNBED20 IF NOT EQUAL      * No, process this row.
          ENDIF
.
          GOTO      OPNBED99                     * Closure row not found - exit
.
OPNBED20  MOVE      ONE,PMBCFRPR                 * Set processed flag (From)
          MOVE      CURRDATE,PMBCTODT            * Set closure to date
          MOVE      CURRTIME,PMBCTOTM            * Set closure to time
          MOVE      ONE,PMBCTOPR                 * Set processed flag (To)
          MOVE      CURRDATE,PMBCUPDT            * Set update date
          MOVE      CURRTIME,PMBCUPTM            * Set update time
          MOVE      WBSEUID,PMBCUPID             * set update user id
.
          CALL      UPPMBDC1                     * Update Closure record
.
OPNBED99  RETURN
.
.------------------------------------------------------------------------------
.                     Check for Beds to be Closed            
.------------------------------------------------------------------------------
CHKCLS00  MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      COUNTER,BEDINDEX
            MATCH     "1",BEDSCLSE[BEDINDEX]     * Is bed marked for closing?
            IF        @EQUAL
              MATCH     "1",RECCURNG
              IF        @EQUAL
                CALL      RECCLS00
              ELSE
                CALL      CLSBED00                 * Yes, close this bed.
              ENDIF
            ENDIF
            ADD       ONE,COUNTER
          DO
.
CHKCLS99  RETURN
.
.------------------------------------------------------------------------------
.                           Close Bed
. This procedure 'closes' the specified bed. It first validates whether 
. the given closure period is valid (i.e. it does not overlap with already 
. specified closures for this bed). If the closure is vaid, and it is a current
. closure, the Ward/Bed file is updated to change the bed status to Closed.
. If the given closure is a future closure then update of Ward/Bed file is not
. performed. The record is then written to the Bed Closure file for the given
. bed closure with the 'Processed From' flag (PMBCFRPR) being set for current
. closure only.
.
. INPUT : BEDINDEX - Index to the BEDCODES array at which the Bedcode for bed 
.                    to be opened is stored.
.------------------------------------------------------------------------------
CLSBED00  CALL      VALBCL00                     * Validate Bed Closure
          MATCH     "1",INVLDCLS                 * Is closure invalid?
          GOTO      CLSBED99 IF EQUAL            * Yes, closure invalid, exit.
.
          MATCH     "1",CURCLOSE                 * Current Closure?
          GOTO      CLSBED20 IF NOT EQUAL        * No, skip update of patwr1af.
.
          PACK      KEY6,WARDCODE,BEDCODES[BEDINDEX],SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CLSBED99               * Ward/Bed not found, exit.
.
          MATCH     ZEROVISN,WADMNO              * Is Bed Available (Empty)?
          GOTO      CLSBED90 IF NOT EQUAL        * No, Bed can not be Closed
. 
          MOVE      BEDSHKST[BEDINDEX],PTWDHKST  * Set House Keeping Status
          MOVE      ONE,PTWDBDST                 * Set Bed Status to Closed
          MOVE      CLREASON,PTWDRBSC            * Set Reason for bed closure
          MOVE      CURRDATE,PTWDUPDT            * Set update date
          MOVE      CURRTIME,PTWDUPTM            * Set update time
          MOVE      WBSEUID,PTWDUPID             * Set update user id

          CALL      UPWARD1                      * Update Bed details
.
CLSBED20  PACK      KEY22,WARDCODE,BEDCODES[BEDINDEX],CLSFRDTE,CLSFRTME,SP70
          CALL      RDPMBDC1
          IF        OVRCD=0
            GOTO      CLSBED99
          ENDIF
.
.         Insert Bed Closure Record
.
          MOVE      WARDCODE,PMBCWARD            * Ward Code
          MOVE      BEDCODES[BEDINDEX],PMBCBED   * Bed Code
          MOVE      CLSFRDTE,PMBCFRDT            * Close From Date
          MOVE      CLSFRTME,PMBCFRTM            * Close From Time
          MOVE      CLREASFR,PMBCFTRC            * Reason for bed closure Free
          MOVE      CLDOCTOR,PMBCDOCT            * Hold for HCP
.
          MATCH     "1",CURCLOSE            * Current Closure?
          IF        @EQUAL
            MOVE      ONE,PMBCFRPR          * Yes, write closure as processed
          ELSE
            MOVE      ZERO,PMBCFRPR         * No, mark for future processing
          ENDIF
.
          MOVE      CLSTODTE,PMBCTODT       * Close To Date
          MOVE      CLSTOTME,PMBCTOTM       * Close to Time
          MOVE      ZERO,PMBCTOPR           * Closure To processed flag
          MOVE      CLREASON,PMBCREAS       * Reason for closure
          MOVE      CURRDATE,PMBCCRDT       * Date record created
          MOVE      CURRTIME,PMBCCRTM       * Time record created
          MOVE      WBSEUID,PMBCCRID        * User ID - creator
          MOVE      CURRDATE,PMBCUPDT       * Date record updated
          MOVE      CURRTIME,PMBCUPTM       * Time record updated
          MOVE      WBSEUID,PMBCUPID        * User ID - update
          MOVE      SP70,PMBCSPAR
.
          CALL      WRPMBDC1
          GOTO      CLSBED99
.
CLSBED90  ADD       ONE,WARCOUNT
          IF        WARCOUNT >= 99
            MOVE      "99",WARCOUNT
            GOTO      CLSBED99         * Reached maximum num of warnings.
          ENDIF
          PACK      WARNMESG,SP70,SP70
          STRIP     WARNMESG
          ENDSET    WARNMESG
          APPEND    "Bed occupied by a patient. ",WARNMESG
          APPEND    "Closure not performed for bed ",WARNMESG
          APPEND    BEDCODES[BEDINDEX],WARNMESG
          RESET     WARNMESG
          MOVE      WARNMESG,WEBWARNG[WARCOUNT]
          GOTO      CLSBED99
. 
CLSBED99  RETURN
.
.------------------------------------------------------------------------------
. Recurring CLSBED00 routine
.------------------------------------------------------------------------------
RECCLS00  PACK      STRTCLDT,CLSFRDTE,SP70
          PACK      SAVESTDT,CLSFRDTE,SP70
          PACK      ENDCLOSE,CLSTODTE,SP70
RECCLS10  PACK      CLSTODTE,CLSFRDTE,SP70
.
          MOVE      ZERO,SELECTDY
          MOVE      ZERO,F1
          UNPACK    CLSTODTE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD    SELECTDY,WEEKDAY,MONCLSED,TUECLSED,WEDCLSED,THUCLSED,FRICLSED:
                                SATCLSED,SUNCLSED
          IF        SELECTDY=1
            CALL      CLSBED00
          ENDIF
.
          ADD       ONE,STRTCLDT
          MATCH     STRTCLDT,ENDCLOSE
          IF        @LESS
            GOTO      RECCLS99
          ENDIF
          PACK      CLSFRDTE,STRTCLDT,SP70
          GOTO      RECCLS10
.
RECCLS99  PACK      CLSTODTE,ENDCLOSE,SP70
          PACK      CLSFRDTE,SAVESTDT,SP70
          RETURN
.
.------------------------------------------------------------------------------
.                   Check Closure Type (Current or Future)
. This procedure determines whether a given closure is a 'current' or 'future'
. closure.
.
. INPUTS:  CLSFRDTE - Specified Close From Date
.          CLSFRTME - Specified Close Form Time
.
. OUTPUTS: CURCLOSE - 1 = Current Closure, 0 = Future Closure
.------------------------------------------------------------------------------
CLSTYP00  MOVE      ZERO,CURCLOSE           * Initialize Current Closure Flag
          PACK      CURRDATE,CCC,CYY,CMM,CDD     
          REP       " 0",CURRDATE           * Set current date
          MOVE      CTIMEIS,CURRTIME        * Set current time
.
          MATCH     CLSFRDTE,CURRDATE       * Is CURRDATE < CLSFRDTE (future)?
          GOTO      CLSTYP99 IF LESS        * Yes, future closure, go to exit. 
          IF        @EQUAL
            MATCH     CLSFRTME,CURRTIME     * Same date, close time in future?
            GOTO      CLSTYP99 IF LESS      * Yes, future closure, go to exit.
          ENDIF
.
          MOVE      ONE,CURCLOSE
.
CLSTYP99  RETURN
.
.------------------------------------------------------------------------------
.                       Validate Bed Closure
. This procedure checks whether a given closure is valid (i.e. it does not 
. overlap with closures already specified for this bed).
. 
. OUTPUTS: INVLDCLS - 0 = Valid closure, 1 = Invalid Closure
.------------------------------------------------------------------------------
VALBCL00  MOVE      ZERO,INVLDCLS           * Reset Invalid Closure Flag
.
          PACK      KEY6,WARDCODE,BEDCODES[BEDINDEX],SP70
          CALL      RDWARD1
          BRANCH    OVRCD,VALBCL91          * Ward/Bed not found, set invalid.
.
          PACK      KEY22,WARDCODE,BEDCODES[BEDINDEX],CLSFRDTE,CLSFRTME
          CALL      RDPMBDC1                
          IF        OVRCD=0 
            GOTO      VALBCL90              * Overlapping period, set invalid
          ENDIF
.
.         Read next closure record and check 'Processed' indicators and also  
.         also 'Closed From' date/time against new 'Closed To' date/time. 
.         If existing (next) closure record has been already processed or it 
.         overlaps with new 'Closed To' date/time then new closure is invalid.
.
          PACK      KEY22,WARDCODE,BEDCODES[BEDINDEX],CLSFRDTE,CLSFRTME
          CALL      RSPMBDC1
          CALL      RKPMBDC1
          BRANCH    OVRCD,VALBCL20               * Record not found, check prev
          MATCH     PMBCWARD,WARDCODE            * Same Ward?
          GOTO      VALBCL20 IF NOT EQUAL        * No next record, check prev
          MATCH     PMBCBED,BEDCODES[BEDINDEX]   * Same Bed?
          GOTO      VALBCL20 IF NOT EQUAL        * No next record, check prev 
.
          MATCH     "1",PMBCFRPR                 * Is 'Processed From' ind set?
          IF        @EQUAL
            GOTO      VALBCL92                   * Yes, invalid closure.
          ENDIF
.
          MATCH     "1",PMBCTOPR                 * Is 'Processed To' ind set?
          IF        @EQUAL
            GOTO      VALBCL92                   * Yes, invalid closure.
          ENDIF
.
          MATCH     CLSTODTE,PMBCFRDT            * Is PMBCFRDT < CLSTODTE?
          GOTO      VALBCL90 IF LESS             * Overlapping period, invalid
          IF        @EQUAL
            MATCH     CLSTOTME,PMBCFRTM          * Same date, do times overlap?
            GOTO      VALBCL90 IF LESS           * Overlapping period, invalid
          ENDIF
.
.         Read previous closure record and check last 'Closed To' date/time
.         against new 'Closed From' date/time. If existing closure record
.         overlaps with new 'Closed From' date/time then new closure is invalid.
.
VALBCL20  PACK      KEY22,WARDCODE,BEDCODES[BEDINDEX],CLSFRDTE,CLSFRTME
          CALL      RSPMBDC1
          CALL      RPPMBDC1
          BRANCH    OVRCD,VALBCL99
          MATCH     PMBCWARD,WARDCODE            * Same Ward?
          GOTO      VALBCL99 IF NOT EQUAL        * No prev record, exit
          MATCH     PMBCBED,BEDCODES[BEDINDEX]   * Same Bed?
          GOTO      VALBCL99 IF NOT EQUAL        * No prev record, exit
.
          MATCH     PMBCTODT,CLSFRDTE            * Is CLSFRDTE < PMBCTODT?
          GOTO      VALBCL90 IF LESS             * Overlapping period, invalid
          IF        @EQUAL
            MATCH     PMBCTOTM,CLSFRTME          * Same date, do times overlap?
            GOTO      VALBCL90 IF LESS           * Overlapping period, invalid
          ENDIF
.
          GOTO      VALBCL99                * Valid Bed Closure, go to exit.
.
VALBCL90  MOVE      ONE,INVLDCLS            * Set 'Invalid Closure' flag.
          ADD       ONE,WARCOUNT 
          IF        WARCOUNT >= 99
            MOVE      "99",WARCOUNT
            GOTO      VALBCL99         * Reached maximum num of warnings.
          ENDIF     
          PACK      WARNMESG,SP70,SP70
          STRIP     WARNMESG
          ENDSET    WARNMESG
          APPEND    "Overlapping Closure Period. ",WARNMESG
          APPEND    "Closure not performed for bed ",WARNMESG
          APPEND    BEDCODES[BEDINDEX],WARNMESG
          RESET     WARNMESG
          MOVE      WARNMESG,WEBWARNG[WARCOUNT]
          GOTO      VALBCL99
.
VALBCL91  MOVE      ONE,INVLDCLS            * Set 'Invalid Closure' flag.
          ADD       ONE,WARCOUNT 
          IF        WARCOUNT >= 99
            MOVE      "99",WARCOUNT
            GOTO      VALBCL99         * Reached maximum num of warnings.
          ENDIF     
          PACK      WARNMESG,SP70,SP70
          STRIP     WARNMESG
          ENDSET    WARNMESG
          APPEND    "Ward/Bed File - Could not find bed ",WARNMESG
          APPEND    BEDCODES[BEDINDEX],WARNMESG
          RESET     WARNMESG
          MOVE      WARNMESG,WEBWARNG[WARCOUNT]
          GOTO      VALBCL99
.
VALBCL92  MOVE      ONE,INVLDCLS            * Set 'Invalid Closure' flag.
          ADD       ONE,WARCOUNT
          IF        WARCOUNT >= 99
            MOVE     "99",WARCOUNT
            GOTO      VALBCL99         * Reached maximum num of warnings.
          ENDIF
          PACK      WARNMESG,SP70,SP70
          STRIP     WARNMESG
          ENDSET    WARNMESG
          APPEND    "Backdating beyond last effective date. ",WARNMESG
          APPEND    "Closure not performed for bed ",WARNMESG
          APPEND    BEDCODES[BEDINDEX],WARNMESG
          RESET     WARNMESG
          MOVE      WARNMESG,WEBWARNG[WARCOUNT]
          GOTO      VALBCL99
.
VALBCL99  RETURN
.
.------------------------------------------------------------------------------
.                           Display Warnings
.------------------------------------------------------------------------------
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
.
.---------------------------------------------------------------------------
.  Clears File Data             
.---------------------------------------------------------------------------
CLRWRD00  MOVE      SP70,WWARD      * WARD NUMBER
          MOVE      SP70,WBED       * WARD BED NUMBER
          MOVE      SP70,WBDESC     * WARD BED DESCRIPTION
          MOVE      SP70,DWADMNO    * CURRENT PATIENT ADMISSION NO.
          MOVE      SP70,WEXTN      * EXTENSION NUMBER
          MOVE      ZERO,WBLINE     * No LINES B/WN BEDS (WRD ONLY)
          MOVE      SP70,WRTYPE     * Room Type (BDS ONLY) (CAT RT)
          MOVE      SP70,WEFRBT     * E.F.R. (BEDS ONLY) (CAT BT)
          MOVE      ZERO,WNBEDS     * No OF BEDS IN WARD (WRD ONLY)
          MOVE      ZERO,WHCSSUB    * HCS WARD SUBSCRIPT (WRD ONLY)
          MOVE      SP70,WSERV      * WARD SERVICE CODE (WARD ONLY)
          MOVE      ZERO,WPLUR      * PLURALITY NUMBER
          MOVE      ZERO,WINPUT     * WARD ONLY INPUT (WRD INDIC) 0=NO, 1=YES
          MOVE      ZERO,WOCCBED    * NO.OF BEDS IN WARD(OCC STATS)
          MOVE      SP70,WCLASS     * WARD CLASSIFICATION (CAT CG)
          MOVE      SP70,DWSTBY     * CURRENT STBY ADMISS NUMBER
          MOVE      ZERO,WACTIVE    * ACTIVE INDICATOR 0=Active, 1=Not Active
          MOVE      SP70,PTWDHOSN   * Hospital/Unit Number
          MOVE      ZERO,PTWDDNIN   * Day/Night Indicator 0=Day Only
.                                   *                     1=Day & Night
.                                   *                     2=Night Only
          MOVE      SP70,PTWDIAGE   * Intended Age Group Cat IA
          MOVE      SP70,PTWDICRE   *      "   Care Intensity Cat IC
          MOVE      SP70,PTWDSEX    *      "   Sex of Patient M/F/E
          MOVE      SP70,PTWDLOCN   * Medical Record Location Code
          MOVE      SP70,PTWDGLDG   * G/L and Cost Centre code
          MOVE      SP70,PTWDNSTA   * Nursing station
          MOVE      SP70,PTWDDOSA
          MOVE      SP70,PTWDSPAR   * SPARE
          MOVE      ZERO,SWINPUT
          MOVE      SP70,PTWDCOMM   * Comments
          MOVE      SP70,PTWDDFVS   * Default Visits
          MOVE      SP70,PTWDDFPH   * Default Phone Calls
.
CLRWRD99  RETURN
.---------------------------------------------------------------------------
.  Saves CGI Parameters         
.---------------------------------------------------------------------------
SAVWRD00  MOVE      PTWRD001,WWARD     * WARD NUMBER
          MOVE      PTWRD002,WBED      * WARD BED NUMBER
          MOVE      PTWRD003,WBDESC    * WARD BED DESCRIPTION
.         MOVE      ZEROVISN,WADMNO    * CURRENT PATIENT ADMISSION NO.
          MOVE      PTWRD005,WEXTN     * EXTENSION NUMBER
          MOVE      PTWRD006,WBLINE    * No LINES B/WN BEDS (WRD ONLY)
          MOVE      PTWRD007,WRTYPE    * Room Type (BDS ONLY) (CAT RT)
          MOVE      PTWRD008,WEFRBT    * E.F.R. (BEDS ONLY) (CAT BT)
          MOVE      PTWRD009,WNBEDS    * No OF BEDS IN WARD (WRD ONLY)
          MOVE      PTWRD010,WHCSSUB   * HCS WARD SUBSCRIPT (WRD ONLY)
          MOVE      PTWRD011,WSERV     * WARD SERVICE CODE (WARD ONLY)
          MOVE      PTWRD012,WPLUR     * PLURALITY NUMBER
.
          MOVE      PTWRD013,WINPUT    * 0 = ward / bed
.                                      * 1 = ward only
.                                      * 2 = ward only + ward only
.
          MOVE      PTWRD014,WOCCBED   * NO.OF BEDS IN WARD(OCC STATS)
          MOVE      PTWRD015,WCLASS    * WARD CLASSIFICATION (CAT CG)
          MOVE      PTWRD016,DWSTBY    * CURRENT STBY ADMISS NUMBER
.
          COMPARE   PTWRD017,TWO
          IF        @EQUAL
            MOVE      ZERO,WACTIVE   * ACTIVE INDICATOR 0=Active,1=Not Active
          ELSE
            MOVE      ONE,WACTIVE
          ENDIF  
.
          MOVE      PTWRD018,PTWDHOSN  * Hospital/Unit Number
          MOVE      PTWRD019,PTWDDNIN  * Day/Night Indicator 0=Day Only
.                                      *                     1=Day & Night
.                                      *                     2=Night Only
          MOVE      PTWRD020,PTWDIAGE  * Intended Age Group Cat IA
          MOVE      PTWRD021,PTWDICRE  *      "   Care Intensity Cat IC
          MOVE      PTWRD022,PTWDSEX   *      "   Sex of Patient M/F/E
          MOVE      PTWRD023,PTWDLOCN  * Medical Record Location Code
          MOVE      PTWRD024,PTWDGLDG  * G/L and Cost Centre code
          MOVE      PTWRD025,PTWDNSTA  * Nursing station number
          MOVE      PTWRD026,PTWDDOSA
.
          MATCH     Z70,PTWRD027
          IF        !@EQUAL
            MOVE      PTWRD027,PTWDFVDW    * Five Day Ward Indicator
          ENDIF
.
          MATCH     Z70,PTWRD028
          IF        !@EQUAL
            MOVE      PTWRD028,PTWDBDST     * Bed Status - Open/Closed
          ENDIF
.
          MATCH     Z70,PTWRD029
          IF        !@EQUAL
            MOVE      PTWRD029,PTWDRBSC     * Reason Bed Status Changed
          ENDIF
.
          MATCH     Z70,PTWRD030
          IF        !@EQUAL
            MOVE      PTWRD030,PTWDHKST     * House Keeping Status
          ENDIF
.
          MATCH     Z70,PTWRD031
          IF        !@EQUAL
            MOVE      PTWRD031,PTWDIFST     * Infection Status
          ENDIF
.
          PACK      PTWDUPDT,CCC,CYY,CMM,CDD * set update date
          REP       " 0",PTWDUPDT
          MOVE      CTIMEIS,PTWDUPTM         * set update time
          MOVE      WBSEUID,PTWDUPID         * set update user id
.
          MATCH     Z70,PTWRD038
          IF        !@EQUAL
            MOVE      PTWRD038,PTWDCOMM      * Comments
          ENDIF
.
          MOVE      SP70,PTWDSPAR      * SPARE
.
          MATCH     Z70,PTWRD039
          IF        !@EQUAL
            MOVE      PTWRD039,PTWDDFVS     * Default Visitors
          ENDIF
.
          MATCH     Z70,PTWRD040
          IF        !@EQUAL
            MOVE      PTWRD040,PTWDDFPH     * Default Phone Calls
          ENDIF
.
          MATCH     Z70,PTWRD041
          IF        !@EQUAL
            MOVE      PTWRD041,PTWDGLDG     * Ward Provider Number
          ENDIF
.
          MATCH     Z70,PTWRD042
          IF        !@EQUAL
            MOVE      PTWRD042,PTWDSDES     * Ward Short Description 
          ENDIF
.
SAVWRD99  RETURN
.-------------------------------------------------------------------------
. * Checks mandatory fields - add screen
.-------------------------------------------------------------------------
CHKWRD00  RESET     PTWRD002
          MATCH     SP70,PTWRD002
          GOTO      CHKWRD98 IF NOT EQUAL
.
.         Ward maintenance screen
.
          COMPARE   ZERO,PTWRD013
          GOTO      CHKWRD98 IF EQUAL        * Ward/bed
.
.         Ward only - must have E.F.R. Bed type
.
          RESET     PTWRD008
          MATCH     SP3,PTWRD008             * Bed type
          GOTO      CHKWRD92 IF EQUAL
          GOTO      CHKWRD98
.
CHKWRD92  MOVE      "E.F.R. Bed type must be entered for Ward Only!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKWRD99
.
CHKWRD98  MOVE      ZERO,EXIT
CHKWRD99  RETURN
.-------------------------------------------------------------------------
. * Checks effective date - update screen
.-------------------------------------------------------------------------
CHKFLD00  MOVE      ZERO,EXIT
          RESET     PTWRD002
          MATCH     SP70,PTWRD002
          GOTO      CHKFLD20 IF NOT EQUAL
.
.         Ward maintenance screen.
.
          COMPARE   ZERO,PTWRD013
          GOTO      CHKFLD10 IF EQUAL        * Ward/bed
.
.         Ward only - must have E.F.R. Bed type
.
          RESET     PTWRD008
          MATCH     SP3,PTWRD008             * Bed type
          GOTO      CHKFLD94 IF EQUAL
.
CHKFLD10  MOVE      ONE,HISFLAG              * set history flag
          RESET     PTWRD008
          MATCH     WEFRBT,PTWRD008          * bed for charging
          GOTO      CHKFLD95 IF NOT EQUAL
.
          MOVE      ONE,FORM1                * Default to not active
          IF        PTWRD017=2
            MOVE      ZERO,FORM1             * active
          ELSE
            MOVE      ONE,FORM1
          ENDIF
.
          COMPARE   WACTIVE,FORM1
          IF        !@EQUAL
            CALL      KWRD0000
            BRANCH    EXIT,CHKFLD99
            GOTO      CHKFLD91
          ELSE
            COMPARE   PTWRD013,WINPUT       * Type of ward change?
            IF        !@EQUAL
              CALL      CKWT0000
              BRANCH    EXIT,CHKFLD99
            ENDIF
          ENDIF
.
          COMPARE   WOCCBED,PTWRD014          * number of beds
          GOTO      CHKFLD92 IF NOT EQUAL
          RESET     PTWRD015
          MATCH     WCLASS,PTWRD015           * ward class
          GOTO      CHKFLD93 IF NOT EQUAL
          MOVE      ZERO,HISFLAG
          GOTO      CHKFLD98
.
.         Bed maintenance screen
.
CHKFLD20  MOVE      ONE,HISFLAG              * set history flag
          RESET     PTWRD008
          MATCH     WEFRBT,PTWRD008          * bed for charging
          GOTO      CHKFLD95 IF NOT EQUAL
          MOVE      ONE,FORM1                * Default to not active
          IF        PTWRD017=2
            MOVE      ZERO,FORM1             * active
          ELSE
            MOVE      ONE,FORM1
          ENDIF
.
          COMPARE   WACTIVE,FORM1
          IF        !@EQUAL
            CALL      KWRD0000
            BRANCH    EXIT,CHKFLD99
            GOTO      CHKFLD91
          ENDIF
.
.
          RESET     PTWRD003
          MATCH     WBDESC,PTWRD003          * description changed
          GOTO      CHKFLD95 IF NOT EQUAL
.
          RESET     PTWRD007
          MATCH     WRTYPE,PTWRD007          * room type
          GOTO      CHKFLD95 IF NOT EQUAL
.
          RESET     PTWRD031
          MATCH     PTWDIFST,PTWRD031        * infection status
          GOTO      CHKFLD99 IF NOT EQUAL
.
          MOVE      ZERO,HISFLAG
          GOTO      CHKFLD98
.
.
CHKFLD91  MATCH     SP70,EFCTDATE    * Check if an Effective Date was entered? 
          GOTO      CHKFLD99 IF NOT EQUAL
.
          MOVE    "Bed status changed, Effective date must be entered!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD92  MATCH     SP70,EFCTDATE    * Check if an Effective Date was entered? 
          GOTO      CHKFLD99 IF NOT EQUAL
.
          MOVE    "No of Bed changed, Effective date must be entered!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD93  MATCH     SP70,EFCTDATE    * Check if an Effective Date was entered? 
          GOTO      CHKFLD99 IF NOT EQUAL
.
          MOVE    "Ward Class changed, Effective date must be entered!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD94  MOVE      "E.F.R Bed type must be entered for Ward Only!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD95  MATCH     SP70,EFCTDATE    * Check if an Effective Date was entered? 
          GOTO      CHKFLD99 IF NOT EQUAL
.
          MOVE    "Room type changed, Effective date must be entered!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKFLD99
.
CHKFLD98  MOVE      ZERO,EXIT
CHKFLD99  RETURN
+
.----------------------------------------------------------------------
.         (***Copied and Modified from IBAPAT13: WWBH0000 ***)  
.                            WRDHIS00     
.    Write a WARD/BED History record if applicable
.        Parameters :  EFCTDATE - Effective Date cgi parameter
.                                                  called by: PATWRD00  
.----------------------------------------------------------------------
WRDHIS00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8                * Current date
          MOVE      KEY8,TODAY               * Move to form field
          MOVE      EFCTDATE,EFTDATE         * Move to form field
          IF        EFTDATE <= TODAY
            GOTO      WRDHIS10    * Same as today ok & before today ok.
          ELSE
            GOTO      WRDHIS90    * Report Error
          ENDIF
.
WRDHIS10  UNPACK    EFCTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      CPRD0000                 * Calculate Previous Days Date
          PACK      WBHDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",WBHDATE
          MOVE      PTWRD001,WBHWARD     * Ward
          MOVE      PTWRD002,WBHBED      * Bed
          MOVE      WRTYPE,WBHRTYP       * Room Type (Category RT)
          MOVE      WACTIVE,WBHACTV      * Not active up to this date 
          MOVE      WOCCBED,WBHNOCC      * No. of beds for occup stats
          MOVE      WCLASS,WBHCLAS       * Ward Classification (Category CG)
          MOVE      TODAY,WBHDCHG        * Record posted today
          CLOCK     TIME,WBHTCHG         * Record posting time, now (HH:MM:SS)
          MOVE      SP70,WBHTIME         * Last Effective Time (HH:MM:SS) 
          MOVE      WBSEUID,WBHUPID      * Update User ID
          MOVE      PTWDIFST,WBHIFST     * Infection Status
          MOVE      SP70,WBHSPAR         * Spare .
          PACK      KEY14,WBHWARD,WBHBED,WBHDATE,SP70
          CALL      RAPTWBH1      * Check if record already exists?
          IF        OVRCD = 1                
            MOVE      TODAY,WBHCRDT      * Record created today
            MOVE      WBHTCHG,WBHCRTM    * Record created time (current time)
            MOVE      WBSEUID,WBHCRID    * Create User ID
            CALL      WRPTWBH1    * Record doesn't exist - ok write new record
          ELSE
            CALL      UPPTWBH1
.           GOTO      WRDHIS91    * Report Error
          ENDIF
          GOTO      WRDHIS98
.
WRDHIS90  MOVE      "Cannot Use A Future Date!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRDHIS99
.
WRDHIS91  MOVE      "History Record Exists Already!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRDHIS99
.
WRDHIS98  MOVE      ZERO,EXIT
WRDHIS99  RETURN
.------------------------------------------------------------------------------
.                             CPRD0000
.    Subroutine To CALCULATE The Previous Day.   (***Copied from IBAPAT13***)
.         Requires : CDAY, CMON, CYEAR, CCENT
.         Returns  : CDAY, CMON, CYEAR, CCENT
.                                                          called by: WRDHIS00
.------------------------------------------------------------------------------
CPRD0000  MOVE      CDAY,DD              * These variables are
          MOVE      CMON,MM              * used by DMYCON
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON               * Convert to Julian format
.
          SUB       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON               * Convert back to "normal" format
.
          MOVE      DD,CDAY
          MOVE      MM,CMON
          MOVE      YY,CYEAR
          MOVE      CC,CCENT
.
CPRD9999  RETURN
.
.------------------------------------------------------------------------
.          CNXT0000 - Calculate the next day
.------------------------------------------------------------------------
CNXT0000  MOVE      CDAY,DD              * These variables are
          MOVE      CMON,MM              * used by DMYCON
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON               * Convert to Julian format
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON               * Convert back to "normal" format
.
          MOVE      DD,CDAY
          MOVE      MM,CMON
          MOVE      YY,CYEAR
          MOVE      CC,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
.
CNXT9999  RETURN
+
.------------------------------------------------------------------------
.          DELHIS00 - Delete All Ward/Bed History Records
.                                                     called by: PATWRD00
.------------------------------------------------------------------------
DELHIS00  PACK      KEY14,PTWRD001,SP70
          CALL      RSPTWBH1
DELHIS10  CALL      RKPTWBH1
          BRANCH    OVRCD,DELHIS99
.
          MATCH     PTWRD001,WBHWARD
          GOTO      DELHIS99 IF NOT EQUAL
.
          PACK      KEY14,WBHWARD,WBHBED,WBHDATE
          CALL      DEPTWBH1
          GOTO      DELHIS10
.
DELHIS99  RETURN
+
.------------------------------------------------------------------------
.          DLBHIS00 - Delete Ward/Bed History Records
.                                                     called by: PATWRD00
.------------------------------------------------------------------------
DLBHIS00  PACK      KEY14,PTWRD001,PTWRD002,SP70
          CALL      RSPTWBH1
DLBHIS10  CALL      RKPTWBH1
          BRANCH    OVRCD,DLBHIS99
.
          MATCH     PTWRD001,WBHWARD
          GOTO      DLBHIS99 IF NOT EQUAL
.
          MATCH     PTWRD002,WBHBED
          GOTO      DLBHIS99 IF NOT EQUAL
.
          PACK      KEY14,WBHWARD,WBHBED,WBHDATE
          CALL      DEPTWBH1
          GOTO      DLBHIS00
.
DLBHIS99  RETURN
.
.------------------------------------------------------------------------
.          DLBCLS00 - Delete Bed Closure Records
.                                                     called by: PATWRD00
.------------------------------------------------------------------------
DLBCLS00  PACK      KEY22,PTWRD001,PTWRD002,SP70
          CALL      RSPMBDC1
DLBCLS10  CALL      RKPMBDC1
          BRANCH    OVRCD,DLBCLS99
.
          MATCH     PTWRD001,PMBCWARD       * Same Ward?
          GOTO      DLBCLS99 IF NOT EQUAL   * No, go to exit
.
          MATCH     PTWRD002,PMBCBED        * Same Bed?
          GOTO      DLBCLS99 IF NOT EQUAL   * No, go to exit
.
          PACK      KEY22,PMBCWARD,PMBCBED,PMBCFRDT,PMBCFRTM,SP70
          CALL      DEPMBDC1
          GOTO      DLBCLS00
.
DLBCLS99  RETURN
.---------------------------------------------------------------------
. Writes Ward/Wed Audit
.    Parameters :   KEY1 - Set Record Type
.---------------------------------------------------------------------
WRDAUD00  BRANCH    CAUDW,WRDAUD99  * Check if audit needs to be written
.
          CALL      IBACLOCK
          MOVE      CDD,ADD                 * Audit Day 
          MOVE      CMM,AMM                 * Audit Month
          MOVE      CYY,AYY                 * Audit Year
          REP       " 0",AYY
          MOVE      CCC,ACC                 * Audit Century  
          MOVE      CTIMEIS,TIMEIS          * Audit Time 
          MOVE      KEY1,ACTION             * Record Type
          MOVE      PASSCODE,OPERCODE       * Operator
.
.  Move File Variables To Audit Variables 
.
          PACK      KEY6,PTWRD001,SP70     * Read Correct Record(Just in case!) 
          CALL      RDWARD1
          BRANCH    OVRCD,WRDAUD99
.
          MOVE      WWARD,SWWARD
          MOVE      WBED,SWBED
          MOVE      WBDESC,SWBDESC
          MOVE      WADMNO,SWADMNO
          MOVE      WEXTN,SWEXTN
          MOVE      WBLINE,SWBLINE
          MOVE      WRTYPE,SWRTYPE
          MOVE      WEFRBT,SWEFRBT
          MOVE      WNBEDS,SWNBEDS
          MOVE      WHCSSUB,SWHCSSUB
          MOVE      WSERV,SWSERV
          MOVE      WPLUR,SWPLUR 
          MOVE      WINPUT,SWINPUT
          MOVE      WOCCBED,SWOCCBED
          MOVE      WCLASS,SWCLASS
          MOVE      DWSTBY,SDWSTBY
          MOVE      WACTIVE,SWACTIVE
          MOVE      PTWDHOSN,SPTWDHOS
          MOVE      PTWDDNIN,SPTWDDNI
          MOVE      PTWDIAGE,SPTWDIAG
          MOVE      PTWDICRE,SPTWDICR
          MOVE      PTWDSEX,SPTWDSEX
          MOVE      PTWDLOCN,SPTWDLOC
          MOVE      PTWDGLDG,SPTWDGLD
          MOVE      PTWDNSTA,SPTWDNST
. 
          CALL      WRWAUD     * Write Record
.
WRDAUD99  RETURN
.------------------------------------------------------------
. Ward Enquiry Page
.------------------------------------------------------------
WRDENQ00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WRDENQ90
          CLEAR     WEBTITLE
          APPEND    "Details of Ward ",WEBTITLE
          APPEND    WBDESC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,WRDENQ99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      WRDENQ99
.
WRDENQ90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
WRDENQ99  RETURN
.------------------------------------------------------------
. Called from WEBBOD00
.------------------------------------------------------------
PROFLD00  BRANCH  REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                           PROFLD60,PROFLD70
          GOTO    PROFLD99
.
PROFLD10  CALL    WBSC0000
          GOTO    PROFLD99
.
PROFLD20  CALL    WRDL0000
          GOTO    PROFLD99
.
PROFLD30  CALL    WRDF0000
          GOTO    PROFLD99
.
.    Ward Maintenance 
.
PROFLD40  BRANCH  FLDSETNO,PROFLD41,PROFLD42,PROFLD43  
          GOTO    PROFLD99
.
PROFLD41  CALL    WRDF0000        * Ward Details Maintenance
          GOTO    PROFLD99
.
PROFLD42  CALL    WRDT0000        * Ward Table Display 
          GOTO    PROFLD99
.
PROFLD43  MOVE    PTWRD001,PTWBA001
          CALL    WBAM0000        * Ward/Bed Attributes
          GOTO    PROFLD99
.
.    Modify Available Beds
.
PROFLD50  BRANCH  FLDSETNO,PROFLD51
          GOTO    PROFLD99
.
PROFLD51  CALL    MAVB0000        * Modify Available Bed 
          GOTO    PROFLD99
. 
.    Bed Closure Maintenance
.
PROFLD60  BRANCH  FLDSETNO,PROFLD61,PROFLD62
          GOTO    PROFLD99
. 
PROFLD61  CALL    PMBC0000        * Display Bed Closure fields
          GOTO    PROFLD99
.
PROFLD62  CALL    MISC0000
          GOTO    PROFLD99
.
PROFLD70  BRANCH  FLDSETNO,PROFLD71,PROFLD72
          GOTO    PROFLD99

PROFLD71  CALL    WBAM0000
          GOTO    PROFLD99
.
PROFLD72  CALL    WRDF0000
          GOTO    PROFLD99
.
PROFLD99  RETURN
.
.----------------------------------------------------------------------------
.                  Miscellaneous Outputs
.----------------------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100
          GOTO      MISC9999
.
MISC0100  WRITE     HTMLFILE;SUPERFLG;      * Supervisor Flag
          GOTO      MISC9999
.
MISC9999  RETURN
+
.----------------------------------------------------------------------------
.                  Modify Available Beds - Display
.----------------------------------------------------------------------------
MAVB0000  BRANCH    FLDITMNO,MAVB0100,MAVB0200,MAVB0300,MAVB0400,MAVB0500:
                             MAVB0600,MAVB0700,MAVB0800,MAVB0900,MAVB1000:
                             MAVB1100
          GOTO      MAVB9999
.
MAVB0100  MATCH     "1",FROMLIST
          IF        @EQUAL
            CALL      WSELA000              * Ward Selection without default 
          ELSE
            PACK      DFLTWARD,WARDCODE
            CALL      WSEL0000              * Ward Selection
          ENDIF 
          GOTO      MAVB9999
.
MAVB0200  WRITE     HTMLFILE;BEDAVAIL;      * Bed Availability
          GOTO      MAVB9999
.
MAVB0300  MATCH     Z70,CLSFRDTE            * Close From Date 
          IF        @EQUAL                       
            PACK      CLSFRDTE,CCC,CYY,CMM,CDD   * First entry to the page
            REP       " 0",CLSFRDTE              * Default current date
          ENDIF
.
          UNPACK    CLSFRDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MAVB9999
.
MAVB0400  MATCH     Z70,CLSFRTME
          IF        @EQUAL
            MOVE      CTIMEIS,CLSFRTME           * Default current time
          ENDIF
.
          WRITE     HTMLFILE;CLSFRTME;
          GOTO      MAVB9999
.
MAVB0500  MOVE      "BU",CATEGORY                * Reason for Bed Closure
          MOVE      CLREASON,CODE
          CALL      CODITM00
          GOTO      MAVB9999
.
MAVB0600  MATCH     SP70,CLSTODTE                * No Close To date specified
          GOTO      MAVB9999 IF EQUAL            * Return
.
          MATCH     Z70,CLSTODTE                 
          IF        @EQUAL                       
            PACK      CLSTODTE,CCC,CYY,CMM,CDD   * First entry to the page
            REP       " 0",CLSTODTE              * Default current date
          ENDIF
.
          UNPACK    CLSTODTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MAVB9999
.
MAVB0700  MATCH     Z70,CLSTOTME
          IF        @EQUAL
            MOVE      CTIMEIS,CLSTOTME           * Default current time
          ENDIF
.
          WRITE     HTMLFILE;CLSTOTME;
          GOTO      MAVB9999
.
MAVB0800  CALL      BEDLST00                     * Bed Lists
          GOTO      MAVB9999
.
MAVB0900  WRITE     HTMLFILE;NUMNOBED;           * Unallocated Patients
          GOTO      MAVB9999
.
MAVB1000  WRITE     HTMLFILE;EMPBEDFL;           * Empty Beds Only Flag
          GOTO      MAVB9999
.
MAVB1100  WRITE     HTMLFILE;SUPERFLG;           * Supervisor Flag
          GOTO      MAVB9999
.
MAVB9999  RETURN
.
.-----------------------------------------------------------------------------
.                             Bed Lists
.-----------------------------------------------------------------------------
BEDLST00  MATCH     SP70,BEDAVAIL
          GOTO      BEDLST99 IF EQUAL
.
          MATCH     "1",BEDAVAIL            * Display All Beds?
          IF        @EQUAL
            CALL      ALLHED00              * All Beds Heading
            GOTO      BEDLST50
          ENDIF
.
          MATCH     "2",BEDAVAIL            * Display Open Beds?
          IF        @EQUAL
            CALL      OPNHED00              * Open Beds Heading
            GOTO      BEDLST50
          ENDIF
.
          MATCH     "3",BEDAVAIL            * Display Closed Beds?
          IF        @EQUAL
            CALL      CLSHED00              * Closed Beds Heading
            GOTO      BEDLST50
          ENDIF
.
BEDLST50  CALL      BLST0000                * Build Bed List
          GOTO      BEDLST99
.
BEDLST99  RETURN
.
.------------------------------------------------------------------------------
.                      Heading for "All Beds" List
.------------------------------------------------------------------------------
ALLHED00  WRITE     HTMLFILE;"<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>Code</td>":
                             "<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Type of Room</td>":
                             "<td class=HeadingCell>Reason</td>":
                             "<td class=HeadingCell>Current Status</td>":
                             "<td class=HeadingCell>Open&nbsp":
                             "<input type=button value=#"All #"":
                             "class=SmallButton onclick=OpenAll();></td>":
                             "<td class=HeadingCell>Close&nbsp":
                             "<input type=button value=#"All #"":
                             "class=SmallButton onclick=CloseAll();></td>":
                             "<td class=HeadingCell>Housekeeping Status</td>":
                             "<td class=HeadingCell>Last Update</td>":
                             "<td class=HeadingCell>Next Closure</td>":
                             "</tr>";
ALLHED99  RETURN
.
.------------------------------------------------------------------------------
.                      Heading for "Open Beds" List
.------------------------------------------------------------------------------
OPNHED00  WRITE     HTMLFILE;"<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>Code</td>":
                             "<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Phone Ext</td>":
                             "<td class=HeadingCell>Type of Room</td>":
                             "<td class=HeadingCell>Close&nbsp":
                             "<input type=button value=#"All #"":
                             "class=SmallButton onclick=CloseAll();></td>":
                             "<td class=HeadingCell>Housekeeping Status</td>":
                             "<td class=HeadingCell>Last Update</td>":
                             "<td class=HeadingCell>User ID</td>":
                             "<td class=HeadingCell>Next Closure</td>":
                             "</tr>";
OPNHED99  RETURN
.
.------------------------------------------------------------------------------
.                      Heading for "Closed Beds" List
.------------------------------------------------------------------------------
CLSHED00  WRITE     HTMLFILE;"<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>Code</td>":
                             "<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Phone Ext</td>":
                             "<td class=HeadingCell>Type of Room</td>":
                             "<td class=HeadingCell>Reason</td>":
                             "<td class=HeadingCell>Open&nbsp":
                             "<input type=button value=#"All #"":
                             "class=SmallButton onclick=OpenAll();></td>":
                             "<td class=HeadingCell>Housekeeping Status</td>":
                             "<td class=HeadingCell>Effective To</td>":
                             "<td class=HeadingCell>Last Update</td>":
                             "<td class=HeadingCell>User ID</td>":
                             "</tr>";
CLSHED99  RETURN
.
.------------------------------------------------------------------------------
.                           Build Beds List
.------------------------------------------------------------------------------
BLST0000  MOVE      ZERO,COUNTER            * Initalize counter (record number)
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
BLST0100  CALL      RDKWARD8
          BRANCH    OVRCD,BLST9000
.
          MATCH     WARDCODE,WWARD
          GOTO      BLST9000 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      BLST0100 IF EQUAL
.
          COMPARE   ZERO,WACTIVE            * Is Bed Active?
          GOTO      BLST0100 IF NOT EQUAL   * No, get next record
.
.         MATCH     "0",PTWDBDST            * Is this Bed Open?
.         IF        @EQUAL
.           MOVE      "Open",CURBSTAT       * Set Current Bed Status Desc
.           MATCH     "3",BEDAVAIL          * Bed Open, is bed filter = CLOSED?
.           GOTO      BLST0100 IF EQUAL     * Yes, don't show, get next record
.         ELSE
.           MOVE      "Closed",CURBSTAT     * Set Current Bed Status Desc
.           MATCH     "2",BEDAVAIL          * Bed Closed, is bed filter = OPEN?
.           GOTO      BLST0100 IF EQUAL     * Yes, don't show, get next record
.         ENDIF
.
          MATCH     "1",PTWDBDST        
          IF        @EQUAL
            MOVE      "Closed",CURBSTAT
            MATCH     "2",BEDAVAIL
            GOTO      BLST0100 IF EQUAL
          ELSE
            MOVE      "Open",CURBSTAT
            MATCH     "3",BEDAVAIL
            GOTO      BLST0100 IF EQUAL
          ENDIF
.
          MOVE      SP70,CELLTYPE
          MATCH     ZEROVISN,WADMNO         * Is this bed empty?
          IF        @EQUAL
            MOVE      "class=AvailableCell",CELLTYPE
          ELSE
            MATCH     "1",EMPBEDFL          * Display Empty Beds Only?
            GOTO      BLST0100 IF EQUAL     * Yes, don't show, get next record
.
            MATCH     ZEROVISN,WSTBY        * Is there patient on Standby?
            IF        !@EQUAL
              MOVE      "class=StandbyCell",CELLTYPE
            ENDIF 
          ENDIF
.
          MOVE      SP70,ROOMTYPE           * Initialize Room Type
          PACK      KEY5,CATRT,WRTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=ZERO
            MOVE      TDESC,ROOMTYPE
          ENDIF
.
          MOVE      SP70,LASTUPDT           * Init last update date & time
          MATCH     PTWDUPDT,SP70           * Is Date Record Updated blank?
          GOTO      BLST0200 IF EQUAL       * Yes, don't set-up display date
          UNPACK    PTWDUPDT,CCENT,CYEAR,CMON,CDAY
          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PTWDUPTM,DIM5
          PACK      LASTUPDT,DIM10,SP1,AT,SP1,DIM5
.
BLST0200  MOVE      SP70,REASDESC           * Initialize Reason Description   
          MATCH     SP70,PTWDRBSC
          GOTO      BLST0300 IF EQUAL
.
          PACK      KEY5,CATBU,PTWDRBSC,SP70     * Get Reason Description
          CALL      RDCODE1
          BRANCH    OVRCD,BLST0300
          MOVE      TDESC,REASDESC          
.
BLST0300  ADD       ONE,COUNTER             * Increment counter
          IF        COUNTER > 99
            GOTO      BLST90000             * Display only first 99 records
          ENDIF
          MOVE      COUNTER,FORM2
          MOVE      FORM2,KEY2
          REP       " 0",KEY2
.
.         Read last Bed Closure Record
.
          MOVE      "&nbsp",UPDFIELD             * Initialize Update Field
          PACK      KEY22,WWARD,WBED,Z70 
          CALL      RSPMBDC1
BLST0320  CALL      RPPMBDC1
          BRANCH    OVRCD,BLST0350
          MATCH     PMBCWARD,WWARD               * Same Ward?
          GOTO      BLST0350 IF NOT EQUAL        * No, exit.
          MATCH     PMBCBED,WBED                 * Same Bed?
          GOTO      BLST0350 IF NOT EQUAL        * No, exit.
.
          MATCH     SP70,PMBCFRDT                * Is from date blank?
          GOTO      BLST0320 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCFRTM                * Is from time blank?
          GOTO      BLST0320 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCTODT                * Is to date blank?
          GOTO      BLST0320 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCTOTM                * Is to time blank?
          GOTO      BLST0320 IF EQUAL            * Yes, get next record.
.
          MATCH     "1",SUPERFLG
          GOTO      BLST0330 IF EQUAL
.
          MATCH     "1",PMBCTOPR                 * Is Closure To processed?
          GOTO      BLST0350 IF EQUAL
.
BLST0330  CLEAR     UPDFIELD
          APPEND    "&nbsp;&nbsp;<img alt=#"Update#" ",UPDFIELD
          APPEND    "src=#"../images/MaintenanceIcon.gif#" ",UPDFIELD
          APPEND    "align=absmiddle onclick=#"UpdateClosure('",UPDFIELD
          APPEND    PMBCWARD,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCBED,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCFRDT,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCFRTM,UPDFIELD
          APPEND    "');#">",UPDFIELD
          RESET     UPDFIELD
.
BLST0350  MATCH     "3",BEDAVAIL            * Is Bed filter = CLOSED?
          IF        @EQUAL 
            CALL      DSPCLS00              * Display Closed Beds
            GOTO      BLST0100              * Get next record
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Set up current date
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME             * Set up current time
.
          MOVE      SP70,NEXTCLSR
          PACK      KEY22,WWARD,WBED,CURRDATE,SP70 
          CALL      RSPMBDC1
BLST0400  CALL      RKPMBDC1
          BRANCH    OVRCD,BLST0500          * Bed Closure record not found
          MATCH     PMBCWARD,WWARD          * Same Ward?
          GOTO      BLST0500 IF NOT EQUAL   * No, valid record not found
          MATCH     PMBCBED,WBED            * Same Bed?
          GOTO      BLST0500 IF NOT EQUAL   * No, valid record not found
          MATCH     CURRDATE,PMBCFRDT       * Is Closed To Date = Current Date
          IF        @EQUAL
            MATCH     CURRTIME,PMBCFRTM     * Is Closed From Time < Current Time
            GOTO      BLST0400 IF LESS      * Yes, check next reocrd
          ENDIF
.
          UNPACK    PMBCFRDT,CCENT,CYEAR,CMON,CDAY
          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PMBCFRTM,DIM5
          PACK      NEXTCLSR,DIM10,SP1,AT,SP1,DIM5          
.
BLST0500  MATCH     "1",BEDAVAIL            * Is Bed filter = ALL?
          IF        @EQUAL
            CALL      DSPALL00              * Yes, Display All Beds
            GOTO      BLST0100              * Get next record
          ENDIF
.
          MATCH     "2",BEDAVAIL            * Is Bed filter = OPEN?
          IF        @EQUAL
            CALL      DSPOPN00              * Yes, Display Open Beds
            GOTO      BLST0100              * Get next record
          ENDIF
.
          GOTO      BLST0100
.
BLST9000  CALL      DSPEND00
          GOTO      BLST9999
.
BLST9999  RETURN
.
.-----------------------------------------------------------------------------
.                  Display Bed Row for 'All' Beds Search
.-----------------------------------------------------------------------------
DSPALL00  WRITE     HTMLFILE;"<tr><td ",CELLTYPE,">&nbsp;",WBED," ":
                             "<input type=hidden name=bedcde",KEY2," ":
                             "value=",WBED,"></td>":
                             "<td>&nbsp;",WBDESC,"</td>":
                             "<td>&nbsp;",ROOMTYPE,"</td>":
                             "<td>&nbsp;",REASDESC,"</td>":
                             "<td>&nbsp;",CURBSTAT,"</td>";
.
.         Display checkbox for opening a bed only if it is currently Closed.
.
          MATCH     "1",PTWDBDST            * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><input type=checkbox value=1 ":
                               "name=openbd",KEY2,"></td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td><input type=checkbox value=1 ":
                             "name=clsebd",KEY2," ":
                             "onclick='chkClosurePeriod();'></td>";
          WRITE     HTMLFILE;"<td>&nbsp;<select name=hkstat",KEY2,">";
          CALL      DSPHKS00           * Display House Keeping Status Options
          WRITE     HTMLFILE;"</select></td>":                   
                             "<td>&nbsp;",LASTUPDT,UPDFIELD,"</td>":
                             "<td>&nbsp;",NEXTCLSR,"</td>":
                             "</tr>";
.
DSPALL99  RETURN
.
.-----------------------------------------------------------------------------
.                  Display Bed Row for 'Open' Beds Search
.-----------------------------------------------------------------------------
DSPOPN00  WRITE     HTMLFILE;"<tr><td ",CELLTYPE,">&nbsp;",WBED," ":
                             "<input type=hidden name=bedcde",KEY2," ":
                             "value=",WBED,"></td>":
                             "<td>&nbsp;",WBDESC,"</td>":
                             "<td>&nbsp;",WEXTN,"</td>":
                             "<td>&nbsp;",ROOMTYPE,"</td>":
                             "<td><input type=checkbox value=1 ":
                             "name=clsebd",KEY2," ":
                             "onclick='chkClosurePeriod();'></td>";
          WRITE     HTMLFILE;"<td>&nbsp;<select name=hkstat",KEY2,">";
          CALL      DSPHKS00           * Display House Keeping Status Options
          WRITE     HTMLFILE;"</select></td>":
                             "<td>&nbsp;",LASTUPDT,"</td>":
                             "<td>&nbsp;",PTWDUPID,"</td>":
                             "<td>&nbsp;",NEXTCLSR,"</td>":
                             "</tr>";
.
DSPOPN99  RETURN
.
.-----------------------------------------------------------------------------
.                  Display Bed Row for 'Closed' Beds Search
.-----------------------------------------------------------------------------
DSPCLS00  MOVE      SP70,EFFECTTO           * Initialize Effective To variable
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
          PACK      KEY22,WWARD,WBED,CURRDATE,CURRTIME,SP70
          CALL      RDPMBDC1
          IF        OVRCD=0            
            GOTO      DSPCLS10         * Exact match found, Format date
          ENDIF
.
          PACK      KEY22,WWARD,WBED,CURRDATE,CURRTIME,Z70
          CALL      RSPMBDC1
          CALL      RPPMBDC1
          BRANCH    OVRCD,DSPCLS50          * Bed Closure record not found
          MATCH     PMBCWARD,WWARD          * Same Ward?
          GOTO      DSPCLS50 IF NOT EQUAL   * No, valid record not found
          MATCH     PMBCBED,WBED            * Same Bed?
          GOTO      DSPCLS50 IF NOT EQUAL   * No, valid record not found
          MATCH     CURRDATE,PMBCTODT       * Is Closed To Date < Current Date
          GOTO      DSPCLS50 IF LESS        * Yes, valid record not found
          IF        @EQUAL
            MATCH     CURRTIME,PMBCTOTM     * Is Closed To Time < Current Time
            GOTO      DSPCLS50 IF LESS      * Yes, valid record not found
          ENDIF
.
DSPCLS10  UNPACK    PMBCTODT,CCENT,CYEAR,CMON,CDAY
          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PMBCTOTM,DIM5
          PACK      EFFECTTO,DIM10,SP1,AT,SP1,DIM5
.
DSPCLS50  WRITE     HTMLFILE;"<tr><td ",CELLTYPE,">&nbsp;",WBED," ":
                             "<input type=hidden name=bedcde",KEY2," ":
                             "value=",WBED,"></td>":
                             "<td>&nbsp;",WBDESC,"</td>":
                             "<td>&nbsp;",WEXTN,"</td>":
                             "<td>&nbsp;",ROOMTYPE,"</td>":
                             "<td>&nbsp;",REASDESC,"</td>":
                             "<td><input type=checkbox value=1 ":
                             "name=openbd",KEY2,"></td>";
          WRITE     HTMLFILE;"<td>&nbsp;<select name=hkstat",KEY2,">";
          CALL      DSPHKS00           * Display House Keeping Status Options
          WRITE     HTMLFILE;"</select></td>":
                             "<td>&nbsp;",EFFECTTO,UPDFIELD,"</td>":
                             "<td>&nbsp;",LASTUPDT,"</td>":
                             "<td>&nbsp;",PTWDUPID,"</td>":
                             "</tr>";
.
DSPCLS99  RETURN
.
.------------------------------------------------------------------------------
.       Display selection list of House Keeping Status Code Descriptions
.------------------------------------------------------------------------------
DSPHKS00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
          PACK      KEY5,CATBV,SP70        
          CALL      RDSCODE1
DSPHKS10  CALL      RDKCODE1
          BRANCH    OVRCD,DSPHKS99
          MATCH     TCODE,CATBV
          GOTO      DSPHKS99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      DSPHKS10 IF EQUAL
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      DSPHKS10 IF EQUAL
.
          IF        IBCNMHOS=1                
            MATCH    "1",PTCDHOSS              * Check for the hospital
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,DSPHKS10
            ENDIF
          ENDIF
.
          MATCH     ACODE,PTWDHKST
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#" selected>":
                                 TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#">":
                                 TDESC,"</option>"
          ENDIF
.
          GOTO    DSPHKS10
.
DSPHKS99  RETURN
.
.-----------------------------------------------------------------------------
.                        Display End of Beds List
.-----------------------------------------------------------------------------
DSPEND00  COMPARE   ZERO,COUNTER    
          GOTO      DSPEND90 IF EQUAL
.
          WRITE     HTMLFILE;"</table>":
                             "<table border=0 align=center width=100%>":
                             "<tr align=center><td width=40%></td>":
                             "<td class=AvailableCell align=center width=10%>":
                             "Available Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient</td>":
                             "<td width=40%></td></tr>"
.
DSPEND90  WRITE     HTMLFILE;"</table>"
.
DSPEND99  RETURN
.
.----------------------------------------------------------------------------
.                        Bed Closures List 
.----------------------------------------------------------------------------
BCLLST00  MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          IF        NORECORD=0
            MOVE      TEN,NORECORD               * Default number of records
          ENDIF
.          
          PACK      KEY22,PMSBC001,PMSBC002,Z70
          CALL      RSPMBDC1
BCLLST10  CALL      RPPMBDC1
          BRANCH    OVRCD,BCLLST99
          MATCH     PMBCWARD,PMSBC001            * Same Ward?
          GOTO      BCLLST99 IF NOT EQUAL        * No, exit.
          MATCH     PMBCBED,PMSBC002             * Same Bed?
          GOTO      BCLLST99 IF NOT EQUAL        * No, exit.
.
          MATCH     SP70,PMBCFRDT                * Is from date blank?
          GOTO      BCLLST10 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCFRTM                * Is from time blank?
          GOTO      BCLLST10 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCTODT                * Is to date blank?
          GOTO      BCLLST10 IF EQUAL            * Yes, get next record.
          MATCH     SP70,PMBCTOTM                * Is to time blank?
          GOTO      BCLLST10 IF EQUAL            * Yes, get next record.
.
          ADD       ONE,RECNUMB
          IF        STARTNUM >= RECNUMB
            GOTO      BCLLST10
          ENDIF
.
          MOVE      SP70,CLSFRPRD                * Build Closed From Period
          UNPACK    PMBCFRDT,CCENT,CYEAR,CMON,CDAY
          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PMBCFRTM,DIM5
          PACK      CLSFRPRD,DIM10,SP1,AT,SP1,DIM5
.
          MOVE      SP70,CLSTOPRD                * Build Closed To Period
          UNPACK    PMBCTODT,CCENT,CYEAR,CMON,CDAY
          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PMBCTOTM,DIM5
          PACK      CLSTOPRD,DIM10,SP1,AT,SP1,DIM5
.
          MOVE      SP70,REASDESC                * Initialize Reason Desc
          MATCH     SP70,PMBCREAS
          GOTO      BCLLST20 IF EQUAL
.
          PACK      KEY5,CATBU,PMBCREAS,SP70     * Get Reason Description
          CALL      RDCODE1
          BRANCH    OVRCD,BCLLST20
          MOVE      TDESC,REASDESC
.
BCLLST20  MOVE      "&nbsp",UPDFIELD             * Initialize Update Field
          MATCH     "1",SUPERFLG
          IF        !@EQUAL
            MATCH     "1",PMBCTOPR                 * Is Closure To processed?
            GOTO      BCLLST30 IF EQUAL            * Yes, don't allow update.
          ENDIF
.
          CLEAR     UPDFIELD
          APPEND    "<img alt=#"Update#" ",UPDFIELD
          APPEND    "src=#"../images/MaintenanceIcon.gif#" ",UPDFIELD
          APPEND    "onclick=#"UpdateClosure('",UPDFIELD
          APPEND    PMBCWARD,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCBED,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCFRDT,UPDFIELD
          APPEND    "','",UPDFIELD
          APPEND    PMBCFRTM,UPDFIELD
          APPEND    "');#">",UPDFIELD
          RESET     UPDFIELD
.
BCLLST30  WRITE     HTMLFILE;"<tr height=25><td>&nbsp;",CLSFRPRD,"</td>":
                             "<td>&nbsp;",CLSTOPRD,"</td>";
.
          MATCH     SP70,PMBCFTRC
          IF        !@EQUAL 
            WRITE     HTMLFILE;"<td>&nbsp;",REASDESC,"<br>&nbsp;",PMBCFTRC:
                               "</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",REASDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",UPDFIELD,"</td>":
                             "</tr>";
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      BCLLST10 IF NOT EQUAL        * Get next closure record
.
BCLLST99  RETURN
.----------------------------------------------------------------------------
. Report No. 4 : Ward Table Display 
.----------------------------------------------------------------------------
WRDT0000  BRANCH    FLDITMNO,WRDT0100,WRDT0200,WRDT0300,WRDT0400,WRDT0500:
                             WRDT0600,WRDT0700,WRDT0800,WRDT0900,WRDT1000:
                             WRDT1100,WRDT1200,WRDT1300,WRDT1400,WRDT1500:
                             WRDT1600,WRDT1700,WRDT1800,WRDT1900,WRDT2000
          GOTO      WRDT9999
.
WRDT0100  CALL      WRDTB000     * Table of Wards                
          GOTO      WRDT9999
.
WRDT0200  CALL      PREVGR00     * Last Set of Wards 
          GOTO      WRDT9999
.
WRDT0300  CALL      NEXTGR00     * Next Set of Wards
          GOTO      WRDT9999
.
WRDT0400  CALL      WBDTB000     * List Beds in Ward
          GOTO      WRDT9999
.
WRDT0500  CALL      WRTAB000     * List of Wards - in Table Sort
          GOTO      WRDT9999
.
WRDT0600  CALL      WRHIS000     * Ward/Bed History 
          GOTO      WRDT9999
.
WRDT0700  WRITE     HTMLFILE;PTWRD001;                 
          GOTO      WRDT9999
.
WRDT0800  CALL      MRTLC000               * MRT Location Selection List
          GOTO      WRDT9999
.
WRDT0900  PACK      DFLTWARD,PTWRD001
          CALL      WSEL0000               * Ward Seletion List (All Wards)
.                                          * reset position on ward file 
          PACK      KEY6,PTWRD001,PTWRD002,SP70
          CALL      RDWARD1 
          GOTO      WRDT9999
.
WRDT1000  CALL      BCLLST00               * Bed Closures List
          GOTO      WRDT9999
.
WRDT1100  WRITE     HTMLFILE;IBCNMHOS;                 
          GOTO      WRDT9999
.
WRDT1200  WRITE     HTMLFILE;SUPERFLG;                 
          GOTO      WRDT9999
.
WRDT1300  PACK      DFLTWARD,PTWRD001
          MOVE      ONE,SHOWINAC           * show inactive wards
          CALL      WSEL0000               * Ward Seletion List (All Wards)
.                                          * reset position on ward file 
          PACK      KEY6,PTWRD001,PTWRD002,SP70
          CALL      RDWARD1 
          GOTO      WRDT9999
.
WRDT1400  MATCH     SP8,WBHDATE              * Ward Effective date
          IF        @EQUAL
            PACK      WBHDATE,CCC,CYY,CMM,CDD
            REP       " 0",WBHDATE           * Default Effective Date
          ELSE
            MOVE      WBHDATE,DATEWORK       * WBHDATE is 1 day behind - so
            ADD       ONE,DATEWORK           * add one day to Effective date
            MOVE      DATEWORK,WBHDATE
          ENDIF
.
          UNPACK    WBHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WRDT9999
.
WRDT1500  CALL      FHRBED00
          GOTO      WRDT9999
.
WRDT1600  REP       " -",WWARD
          WRITE     HTMLFILE;WWARD;
          GOTO      WRDT9999
.
WRDT1700  IF        FHIRBUND=0
            CALL      RESWRD00
          ELSE
            CLEAR     KEY16
            APPEND    "Ward-",KEY16
            APPEND    WWARD,KEY16
            APPEND    SP70,KEY16
            RESET     KEY16
            WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                  " #"resource#" : ";
.
            CALL      RESWRD00
.
            WRITE     HTMLFILE;*+," } "           
.
            IF       FHRLOCIN=1
.
              MATCH     SP70,PTWDHOSN
              IF        !@EQUAL & !@EOS 
.
                PACK      KEY3,PTWDHOSN,SP70
                CALL      RDPTHSP1               
                IF        OVRCD=0
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/Hospital-",PTWDHOSN,"#", ":
                                        " #"resource#" : ";
.
                  CALL      RESLOC00
.
                  WRITE     HTMLFILE;*+," } "
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
          GOTO      WRDT9999
.
WRDT1800  IF        FHIRBUND=0
            CALL      RESBED00
          ELSE
.
            CLEAR     KEY16
            APPEND    "Bed-",KEY16
            PACK      WWARD,WWARD,SP70
            APPEND    WWARD,KEY16
            APPEND    WBED,KEY16
            APPEND    SP70,KEY16
            RESET     KEY16
            STRIP     KEY16
            REP       " -",KEY16
            IF        DISNUMB>0
              WRITE     HTMLFILE;",";
            ENDIF
            WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                   " #"resource#" : ";
            CALL      RESBED00
            WRITE     HTMLFILE;*+," }"
.
            IF       FHRLOCIN=1
.
              MATCH    SP70,WWARD
              IF       !@EQUAL & !@EOS
.
                PACK      KEY6,WWARD,SP70
                CALL      RDWARD1
                IF        OVRCD=0
.
                  CLEAR     KEY16
                  APPEND    "Ward-",KEY16
                  APPEND    WWARD,KEY16
                  APPEND    SP70,KEY16
                  RESET     KEY16
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                        " #"resource#" : ";
.
                  CALL      RESWRD00
.    
                  WRITE     HTMLFILE;*+," } "
.
                ENDIF
.
              ENDIF             
.
            ENDIF
.
          ENDIF
          GOTO      WRDT9999
.
WRDT1900  WRITE     HTMLFILE;HEROLOCI;
          GOTO      WRDT9999
.
WRDT2000  WRITE     HTMLFILE;PMULUHID;
          GOTO      WRDT9999
.
WRDT9999  RETURN
.------------------------------------------------------------
. Table of MRT locations for the wards hospital id
.------------------------------------------------------------
MRTLC000  PACK      KEY7,PTWDHOSN,SP70
          CALL      RDMRLOC1
MRTLC010  CALL      RKMRLOC1
          BRANCH    OVRCD,MRTLC999
.
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      MRTLC010
          ENDIF
.
          MATCH     PTWDHOSN,MRLOHOSP       * Correct Hospital id
          GOTO      MRTLC999 IF NOT EQUAL
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,PTWDLOCN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      MRTLC010
.
MRTLC999  RETURN
.------------------------------------------------------------------
. Ward List Options for Ward Maintenance 
.------------------------------------------------------------------
WRDL0000  BRANCH    FLDITMNO,WRDL0100,WRDL0200,WRDL0300,WRDL0400,WRDL0500:
                             WRDL0600,WRDL0700,WRDL0800,WRDL0900,WRDL1000:
                             WRDL1100,WRDL1200,WRDL1300,WRDL1400,WRDL1500:
                             WRDL1600
          GOTO      WRDL9999
.
WRDL0100  PACK      DFLTWARD,SP70     * no default
          CALL      WSEL0000          * generate ward list 
          GOTO      WRDL9999
.
WRDL0200  CALL      WLST0000                
          GOTO      WRDL9999
.
WRDL0300  CALL      WSTA0000                
          GOTO      WRDL9999
.
WRDL0400  CALL      WLUPD000     * Ward List with Update Parent
          GOTO      WRDL9999
.
WRDL0500  CALL      NEXTGR00     * Next Set of Wards
          GOTO      WRDL9999
.
WRDL0600  CALL      PREVGR00     * Last Set of Wards 
          GOTO      WRDL9999
.
WRDL0700  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      WRDL9999
.
WRDL0800  CALL      WSFT0000
          GOTO      WRDL9999
.
WRDL0900  CALL      NEXT0000
          GOTO      WRDL9999
.
WRDL1000  CALL      PREV0000
          GOTO      WRDL9999
.
WRDL1100  CALL      SELV0000
          GOTO      WRDL9999
.
WRDL1200  CALL      EHED0000                * Enterprise occupancy heading
          GOTO      WRDL9999
.
WRDL1300  CALL      EROW0000                * Enterprise occupancy heading
          GOTO      WRDL9999
.
WRDL1400  WRITE     HTMLFILE;NOEXPECT;      * Don't show expects column on 
          GOTO      WRDL9999                * the hopital ward list
.
WRDL1500  CALL      WSTB0000                
          GOTO      WRDL9999
.
WRDL1600  WRITE     HTMLFILE;FROMLIST;
          GOTO      WRDL9999
.
WRDL9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"patweb95.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE;
PREV9999  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"patweb95.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE;
NEXT9999  RETURN
.------------------------------------------------------------
. Table of Wards (Maintenance) 
.------------------------------------------------------------
WRDTB000  IF        FHIRTYPE=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            CALL      WRDHD000   * Output Table Heading
            IF        NORECORD=0
              MOVE      "13",NORECORD       * Set Default No Records to Display
            ENDIF
          ENDIF
.

          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.          
          PACK      KEY6,STARTKEY,SP70
          CALL      RDSWARD1
          IF        OVRCD=0
            CALL      RDPWARD1
          ENDIF
WRDTB100  CALL      RDKWARD1
          BRANCH    OVRCD,WRDTB999
          MATCH     SP70,WBED
          GOTO      WRDTB100 IF NOT EQUAL
          MATCH     SP70,HOSPCODE
          IF        !@EQUAL
            MATCH     HOSPCODE,PTWDHOSN
            GOTO      WRDTB100 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      WRDTB100
          ENDIF
.
          CALL      WRDRW000       * Table Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      WRDTB100 IF NOT EQUAL
.
WRDTB999  RETURN
.---------------------------------------------------------------------
.   Ward Table Maintenance (TABLE HEADING) 
.---------------------------------------------------------------------
WRDHD000  WRITE     HTMLFILE;"<tr align=center>":
                               "<td class=HeadingCell>Ward</td>":
                               "<td class=HeadingCell>Description</td>":
                               "<td class=HeadingCell>Ward Only Input</td>":
                               "<td class=HeadingCell>Active</td>":
                             "</tr>"
WRDHD999  RETURN
.---------------------------------------------------------------------
.   Ward Table Maintenance (TABLE ROW)
.---------------------------------------------------------------------
WRDRW000  BRANCH    FHIRTYPE,WRDRW100
          COMPARE   ZERO,WINPUT
          IF        @EQUAL
            MOVE      "NO",KEY3
          ELSE
            MOVE      "YES",KEY3
          ENDIF 
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "YES",KEY4
          ELSE
            MOVE      "NO",KEY4
          ENDIF 
.
          WRITE     HTMLFILE;"<tr><td><A HREF='javascript:ShowDetail04":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&ptwrd001=",WWARD,"#")'>":
                               "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               WWARD,"</td>":
                               "<td>",WBDESC,"</td>":
                               "<td>",KEY3,"</td>":
                               "<td>",KEY4,"</td>":
                             "</tr>"
          GOTO      WRDRW999
.
WRDRW100  IF        DISNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                " #"resource#" : ";
.
          CALL      RESWRD00
.
          WRITE     HTMLFILE;*+," } "
.
          IF       FHRLOCIN=1
.
            MATCH     SP70,PTWDHOSN
            IF        !@EQUAL & !@EOS
.
              PACK      KEY3,PTWDHOSN,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/Hospital-",PTWDHOSN,"#", ":
                                      " #"resource#" : ";
.
                CALL      RESLOC00
.
                WRITE     HTMLFILE;*+," } "
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
WRDRW999  RETURN
+
.------------------------------------------------------------
. FHIR Location Resource for Ward.
.------------------------------------------------------------
RESWRD00  STRIP     WBDESC
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"wa#",":
                    "   #"display#": #"Ward#"  } ] },";
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "  #"reference#": #"Location/Hospital-",PTWDHOSN,"#"":
                    " } } ";
          RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  BRANCH    FHIRTYPE,NEXTGR10
          MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",PMSBC001
          REP       " +",PMSBC002
.
          WRITE     HTMLFILE;"patweb95.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&pmsbc001=",PMSBC001:
                                 "&pmsbc002=",PMSBC002:
                                 "&ptwrd001=",PMSBC001:
                                 "&ptwrd002=",PMSBC002:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
          REP       "+ ",PMSBC001
          REP       "+ ",PMSBC001
          GOTO      NEXTGR99
.
NEXTGR10  IF        DISNUMB=NORECORD
            ASSIGN    STARTNUM+NORECORD,F6
            MOVE      F6,KEY6
            SQUEEZE   KEY6
            WRITE     HTMLFILE;*+,"nextpage=&startnum=",KEY6
          ENDIF
.
NEXTGR99  RETURN
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  BRANCH    FHIRTYPE,PREVGR10
          MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",PMSBC001
          REP       " +",PMSBC002
.
          WRITE     HTMLFILE;"patweb95.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&pmsbc001=",PMSBC001:
                                 "&pmsbc002=",PMSBC002:
                                 "&ptwrd001=",PMSBC001:
                                 "&ptwrd002=",PMSBC002:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
          REP       "+ ",PMSBC001
          REP       "+ ",PMSBC001
          GOTO      PREVGR99
.
PREVGR10  ASSIGN    STARTNUM-NORECORD,F6
          IF        F6>=0
            MOVE      F6,KEY6
            SQUEEZE   KEY6
            WRITE     HTMLFILE;*+,"prevpage=&startnum=",KEY6
          ENDIF
.
PREVGR99  RETURN
.------------------------------------------------------------
. Ward Bed Scan
.------------------------------------------------------------
WBSC0000  BRANCH    FLDITMNO,WBSC0100,WBSC0200,WBSC0300,WBSC0400,WBSC0500:
                             WBSC0600,WBSC0700,WBSC0800,WBSC0900,WBSC1000:
                             WBSC1100,WBSC1200,WBSC1300,WBSC1400,WBSC1500
          GOTO      WBSC9999
.
WBSC0100  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
.
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",WARDCODE
          WRITE     HTMLFILE;"patweb95.pbl?reportno=1":
                                 "&template=",FLDPARA,"&":
                                 "startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&wardcode=",WARDCODE:
                                 "&emptonly=",EMPTONLY:
                                 "&bedsonly=",BEDSONLY:
                                 "&filtrsex=",FILTRSEX:
                                 "&filtbtyp=",FILTBTYP;
          GOTO      WBSC9999
.
WBSC0200  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",WARDCODE
          WRITE     HTMLFILE;"patweb95.pbl?reportno=1":
                                 "&template=",FLDPARA,"&":
                                 "startnum=",KEY3,"&":
                                 "norecord=",KEY2,"&":
                                 "wardcode=",WARDCODE:
                                 "&emptonly=",EMPTONLY:
                                 "&bedsonly=",BEDSONLY:
                                 "&filtrsex=",FILTRSEX:
                                 "&filtbtyp=",FILTBTYP;
          REP       "+ ",WARDCODE
          GOTO      WBSC9999
.
WBSC0300  MOVE      TRUE,EXPDISCH 
          CALL      TABC0000                * Displays expected discharge
          GOTO      WBSC9999
.
WBSC0400  MOVE      FALSE,EXPDISCH 
          CALL      TABC0000                * Does not have expected discharge
          GOTO      WBSC9999
.
WBSC0500  PACK      DFLTWARD,SP70           * no default 
          CALL      WSEL0000                * Ward Selection List (all wards) 
          GOTO      WBSC9999
.
WBSC0600  GOTO      WBSC9999                * tag PATWEB95.01.006 not used 
.
WBSC0700  WRITE     HTMLFILE;FILTRSEX;      * Ward search sex filter
          GOTO      WBSC9999
.
WBSC0800  MOVE      "BT",CATEGORY           * Ward search bed type filter
          MOVE      FILTBTYP,CODE
          CALL      CODITM00
          GOTO      WBSC9999
.
WBSC0900  WRITE     HTMLFILE;WARDCODE;      * Selected ward code
          GOTO      WBSC9999
.
WBSC1000  WRITE     HTMLFILE;EMPTONLY;      * Empty only
          GOTO      WBSC9999
.
WBSC1100  MOVE      FALSE,EXPDISCH
          MOVE      TRUE,HIDELINK
          CALL      TABC0000                * Does not have expected discharge
          MOVE      FALSE,HIDELINK
          GOTO      WBSC9999
.
WBSC1200  CALL      EMPTY000                * Empty Bed List
          GOTO      WBSC9999
.
WBSC1300  CALL      SELV0000                * Period Dates Selection List
          GOTO      WBSC9999
.
WBSC1400  WRITE     HTMLFILE;DATESRCH;      * Ward Date/Time Search checkbox
          GOTO      WBSC9999
.
WBSC1500  WRITE     HTMLFILE;BEDSONLY;      * Beds only
          GOTO      WBSC9999
.
WBSC9999  RETURN
+
.------------------------------------------------------------------------------
. Selects Day, Week or Month from Viewtype (does not post on select change)
.------------------------------------------------------------------------------
SELP0000  MATCH     "1",VIEWTYPE            * Week
          GOTO      SELP2000 IF EQUAL
          MATCH     "2",VIEWTYPE            * Month
          GOTO      SELP4000 IF EQUAL
          MATCH     "3",VIEWTYPE            * Weekly Mon - Fri
          GOTO      SELP2000 IF EQUAL
          MATCH     "4",VIEWTYPE
          IF        @EQUAL
            CALL      WEEK0000
            GOTO      SELP9999
          ENDIF
.
.Defaults to Daily Viewtype
.--------------------------
.
          IF        REMOTLST=0
            WRITE     HTMLFILE;"<select name=lastdate id=lastdate":
                               " class=DaySelect>";
          ENDIF
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "8",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-7",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
SELP1000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          BRANCH    REMOTLST,SELP1100
          GOTO      SELP1200
.
SELP1100  WRITE     HTMLFILE;STRTDATE,",":
                             DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"|";
          GOTO      SELP1300
.
SELP1200  MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                               DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                               DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</option>";
          ENDIF
.
SELP1300  MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP1000 IF NOT EQUAL
          GOTO      SELP9000
.
.Select Weekly Viewtype
.--------------------------
SELP2000  IF        REMOTLST=0
            WRITE     HTMLFILE;"<select name=lastdate id=lastdate":
                               " class=WeekSelect>";
          ENDIF
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.
SELP3000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          BRANCH    REMOTLST,SELP3100
          GOTO      SELP3200
.
SELP3100  MATCH     "3",VIEWTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"Mid Week of ",STRTDATE,",":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"|";
          ELSE
            WRITE     HTMLFILE;"Week of ",STRTDATE,",":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"|";
          ENDIF
          GOTO      SELP3300
.
SELP3200  MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            MATCH     "3",VIEWTYPE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                                 "Mid Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ENDIF
          ELSE
            MATCH     "3",VIEWTYPE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE,">Mid Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ENDIF
          ENDIF
.
SELP3300  MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP3000 IF NOT EQUAL
          GOTO      SELP9000
.
.
.Select Monthly Viewtype
.------------------------
.
SELP4000  IF        REMOTLST=0
            WRITE     HTMLFILE;"<select name=vyearmth id=vyearmth":
                               " class=MonthSelect>";
          ENDIF
          UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<1
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
SELP5000  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
.
          BRANCH    REMOTLST,SELP5100
          GOTO      SELP5200
.
SELP5100  WRITE     HTMLFILE;KEY6,",",MTHNAM,SP1,F4,"|";
          GOTO      SELP5300
.
SELP5200  MATCH     KEY6,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               MTHNAM,SP1,F4,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">":
                               MTHNAM,SP1,F4,"</option>";
          ENDIF
.
SELP5300  ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      SELP5000 IF NOT EQUAL
.
SELP9000  IF        REMOTLST=0
            WRITE     HTMLFILE;"</select>"
          ENDIF
SELP9999  RETURN
+
.------------------------------------------------------------------------------
.         Remote script to output Current Period selection option values
.------------------------------------------------------------------------------
REMPER00  CALL      XMLHED00
          BRANCH    EXIT,REMPER99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MOVE      CALCDATE,CURRDATE
          MOVE      CALCDATE,LASTDATE
          MOVE      ONE,REMOTLST       * Ouput list option (remote script)
.
          CALL      CURPER00           * Determine Current Period
          CALL      CALCDT00           * Calc Next and Last Periods
.
          CALL      SELP0000           * Output select list options
.
REMPER19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      REMPER98
.
REMPER98  CALL      XMLEND00
REMPER99  RETURN
+
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70 
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7 
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9000 
.
.                         if we have a bed number we have passed all the ward
.                         master records
.
          MATCH     SP70,WBED
          GOTO      WSEL9000 IF NOT EQUAL
.
          COMPARE   ONE,SHOWINAC
          GOTO      WSEL0500 IF EQUAL            * show all wards
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
WSEL0500  IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9000 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected"; 
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9000  MOVE      ZERO,SHOWINAC           * reset show inactive flag
WSEL9999  RETURN
+
.------------------------------------------------------------
. Ward selection without defaulted ward 
.------------------------------------------------------------
WSELA000  MOVE     ONE,FRSTLINE
          PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
.
          CALL      RDSWARD7
WSELA100  CALL      RDKWARD7
          BRANCH    OVRCD,WSELA900
.
. if we have a bed number we have passed all the ward master records
.
          MATCH     SP70,WBED
          GOTO      WSELA900 IF NOT EQUAL
.
          COMPARE   ONE,SHOWINAC
          GOTO      WSELA500 IF EQUAL            * show all wards
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSELA100 IF NOT EQUAL
.
WSELA500  IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSELA900 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        FRSTLINE = ONE
            MOVE      ZERO,FRSTLINE
            MOVE      SP70,DIM3
            MOVE      SP70,DIM20
            WRITE     HTMLFILE;"<option value=#"",DIM3,"#"";
            WRITE     HTMLFILE;">",DIM20;
            WRITE     HTMLFILE;"</option>"
          ENDIF

.
. write the select option
.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSELA100
.
WSELA900  MOVE      ZERO,SHOWINAC           * reset show inactive flag
WSELA999  RETURN
+
.------------------------------------------------------------
. Table C - Displays patient ward/bed details
.------------------------------------------------------------
TABC0000  MOVE      SP70,GENDER 
          MOVE      SP70,PATFNAME 
          MOVE      SP70,FORMATNM
          MOVE      SP70,DOCFNAME 
          MOVE      SP70,PDIAGNOS 
          MOVE      ZERO,RECCOUNT
          MOVE      ZERO,DISPNUMB
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        NORECORD=0
            GOTO      TABC9999
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell>Bed</td>"; 
          IF        WBEDDESC > 0
            WRITE     HTMLFILE;"<td class=HeadingCell>Description</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Bed Type</td>":
                             "<td class=HeadingCell>U/R</td>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Diagnoses</td>":
                             "<td class=HeadingCell>Att. Doct.</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td class=HeadingCell>Exp. Disch.</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
          MOVE      SP70,LASTWARD
          PACK      KEY6,SP3,WARDCODE,SP70
          CALL      RDWARD3
          IF        OVRCD=0
            CALL      RDPWARD3
          ENDIF
TABC0100  CALL      RDKWARD3
          BRANCH    OVRCD,TABC9000
          MATCH     SP70,WBED
          GOTO      TABC9000 IF NOT EQUAL
.
          IF        CWRDSCN=1
            MATCH     SP70,WARDCODE
            IF        !@EQUAL
              MATCH     WARDCODE,WWARD        * show only supplied ward in scan
              GOTO      TABC9000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          COMPARE   ONE,WACTIVE
          GOTO      TABC0100 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP
            GOTO      TABC0150 IF EQUAL
            MATCH     WBSEHOSP,PTWDHOSN
            GOTO      TABC0100 IF NOT EQUAL
          ENDIF
.
TABC0150  IF        BEDSONLY=1
            COMPARE   ONE,WINPUT
            GOTO      TABC0100 IF EQUAL
          ENDIF
.
          MOVE      PTWDSEX,SAVEWSEX        * Save master ward record sex and 
          MOVE      WEFRBT,SAVEBEDT         * bed type for no bed ward filters
.
          ADD       ONE,RECCOUNT
          IF        STARTNUM<RECCOUNT
            CALL      WRDROW10
          ENDIF
.
          MOVE      ZERO,ENDNOW       * End of Loop NO
.
          MOVE      WWARD,THISWARD
          IF        WINPUT=0
            CALL      BDWR0000        * Bed only ward
          ELSE
            IF        WINPUT=2
              CALL      BDWR0000      * Ward bed and ward only ward
              MOVE      THISWARD,WWARD
              MOVE      SP70,THISBED
              CALL      NOBW0000      * Ward only ward
              MATCH     "1",PTCNBREQ
              IF        !@EQUAL
                CALL      ALLC0000      * Check for Allocated ward bed
              ENDIF
            ELSE
              CALL      NOBW0000      * Ward only ward
              MOVE      SP70,THISBED
              MATCH     "1",PTCNBREQ
              IF        !@EQUAL
                CALL      ALLC0000      * Check for Allocated ward bed
              ENDIF
            ENDIF
          ENDIF
          BRANCH    ENDNOW,TABC9999   * End of Loop YES
          GOTO      TABC0100
.
TABC9000  CALL      NOMORE00          * Display No More Records Message
.
TABC9999  RETURN
.------------------------------------------------------------
. Process Bed Ward
.------------------------------------------------------------
BDWR0000  MOVE      ZERO,BEDCOUNT
          PACK      KEY16,THISWARD,SP70
          CALL      RDSWARD8
BDWR1000  CALL      RDKWARD8
          BRANCH    OVRCD,BDWR9999
.
          MATCH     WWARD,THISWARD
          GOTO      BDWR9999 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      BDWR1000 IF EQUAL
.
          MOVE      ZERO,DISPBED
          IF        EMPTONLY=1
            MATCH     WADMNO,ZEROVISN             * Check if bed is empty
            GOTO      BDWR1000 IF NOT EQUAL       * Not Empty so Ignore
.
.         'Empty beds only' is ticked, check if there is an allocated ward/bed
.
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              MATCH     "1",PTCNBREQ
              IF        !@EQUAL
                MOVE      WWARD,THISWARD
                MOVE      WBED,THISBED
                MOVE      ONE,DISPBED
                CALL      ALLC0000      * Check for Allocated ward bed
                GOTO      BDWR1000
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   WACTIVE,ONE                 *Check if bed is active
          GOTO      BDWR1000 IF EQUAL           *Do not display inactive bed
.
          MATCH     SP70,FILTRSEX
          IF        !@EQUAL
            MATCH     ANSE,FILTRSEX
            IF        !@EQUAL
              MATCH     FILTRSEX,PTWDSEX      * Filter by intended patient sex
              GOTO      BDWR1000 IF NOT EQUAL * if not either or sp70
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTBTYP
          IF        !@EQUAL
            MATCH     FILTBTYP,WEFRBT       * Filter by bed type
            GOTO      BDWR1000 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,BEDCOUNT
          IF        NORECORD=BEDCOUNT
            ADD       ONE,RECCOUNT
            MOVE      ZERO,BEDCOUNT
          ENDIF
.
          ADD       ONE,RECCOUNT
          IF        STARTNUM>=RECCOUNT
            GOTO      BDWR1000
          ENDIF
.
          MATCH     WWARD,LASTWARD
          CALL      WRDROW00 IF NOT EQUAL
.
          MOVE      ZERO,BEDSTAT                * Empty Bed
          MATCH     WADMNO,ZEROVISN             *Check if bed is empty
          GOTO      BDWR2000 IF EQUAL
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            MOVE      ONE,BEDSTAT    * Patient in Bed
            MATCH     ZEROVISN,WSTBY
            IF        !@EQUAL
              MOVE      TWO,BEDSTAT  * Has Patient on Standby
              CALL      STBY0000     * display standy patient
              MOVE      WADMNO,ADMNOD8
              CALL      PATD0000
            ELSE
              CALL      ONLV0000     * Check for on leave patient if no stby
            ENDIF
          ENDIF
.
          MOVE      WADMNO,ADMNOD8
          CALL      PATD0000
          BRANCH    EXIT,BDWR3000
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CALL      PATR0000           * Display patient row
          GOTO      BDWR3000
.
BDWR2000  MATCH     "1",PTWDBDST                 * Is this Bed Closed?
          IF        @EQUAL
            MOVE     "*** Closed ***",DIM16      * Yes, display bed as 'Closed'.
            GOTO     BDWR2100
          ENDIF
.
          CALL      ONLVRW00
          IF        EXIT=1
            MOVE     "*** On-leave ***",DIM16
          ELSE
            MOVE     "*** Empty ***   ",DIM16
          ENDIF
.
BDWR2100  WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center>";
          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WBED;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WBED,"</a>";
          ENDIF
.
          WRITE    HTMLFILE;"&nbsp;</td>";
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          WRITE    HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>",DIM16,"&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE    HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE    HTMLFILE;"</tr>";
.
          IF        EMPTONLY=0
            CALL      ONLV0000     * Check for on leave patient
          ENDIF
.
BDWR3000  MATCH     "1",PTCNBREQ
          IF        !@EQUAL
            MOVE      WBED,THISBED
            CALL      ALLC0000      * Check for Allocated ward bed
          ENDIF
.
          ADD       ONE,DISPNUMB
          IF        NORECORD>DISPNUMB
            GOTO      BDWR1000
          ENDIF
          MOVE      ONE,ENDNOW
.
BDWR9999  RETURN
+
.------------------------------------------------------------
.         Check for Allocated Ward Bed
.------------------------------------------------------------
ALLC0000  MOVE      "2",REQSTAT             * Allocated
          PACK      KEY39,THISWARD,THISBED,REQSTAT,SP70
          CALL      RSPMBRQ4
ALLC1000  CALL      RKPMBRQ4
          BRANCH    OVRCD,ALLC9999
          MATCH     PMBREWRD,THISWARD
          GOTO      ALLC9999 IF NOT EQUAL   * different ward
          MATCH     PMBREBED,THISBED
          GOTO      ALLC9999 IF NOT EQUAL   * different bed
          MATCH     REQSTAT,PMBRRSTA
          GOTO      ALLC9999 IF NOT EQUAL   * different status
.
          ADD       ONE,RECCOUNT
          IF        STARTNUM>=RECCOUNT
            GOTO      ALLC1000
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      PMBRVISN,ADMNOD8
          MOVE      ONE,BEDREQST
          CALL      PATD0000
          BRANCH    EXIT,ALLC2000
.
          CALL      DWBD0000              * Display Allocated Ward/Bed
ALLC2000  GOTO      ALLC1000
.
ALLC9999  RETURN
+
.------------------------------------------------------------
. Display Request/allocated Ward Bed
.------------------------------------------------------------
DWBD0000  MOVE      "Allocated",PDIAGNOS
.
          WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center height=15>";
.
          IF        DISPBED=1
            WRITE     HTMLFILE;WBED,"</a>";
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                             "<td align=center>",AURNO,"&nbsp;</td>":
                             "<td>",PATFNAME:
                             " (",GENDER,",",PSAGEYRS,")&nbsp;</td>":
                             "<td align=center><strong>",PDIAGNOS:
                             "&nbsp;</strong></td>":
                             "<td>",DOCFNAME,"&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td align=center>",CDAY," ",MTHNAM3:
                               " ",CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
DWBD9999  RETURN
+
.------------------------------------------------------------
. Ouput on row
.------------------------------------------------------------
ONLVRW00  MOVE      ZERO,EXIT
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
ONLVRW10  CALL      RDKONLV1
          BRANCH    OVRCD,ONLVRW99
          MATCH     OWARD,WWARD
          GOTO      ONLVRW99 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      ONLVRW99 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      ONLVRW99 IF EQUAL
.
          MOVE      ONE,EXIT
.
ONLVRW99  RETURN
.
.------------------------------------------------------------
. Output patient row
.------------------------------------------------------------
PATR0000  WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center height=15>";
          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WBED;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WBED,"</a>";
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          MOVE     ZERO,F1
          MATCH     "1",PTCNBREQ
          IF        !@EQUAL
            CALL     RQAL0000   * Check for Patient Request or Allocate Ward/Bed
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                             "<td align=center>",AURNO,"&nbsp;</td>":
                             "<td>",FORMATNM,"&nbsp;</td>";
.
          IF        F1=1 | F1=2
            WRITE     HTMLFILE;"<td align=center><strong>",PDIAGNOS:
                               "&nbsp;</strong></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",PDIAGNOS,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp;</td>";
.
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td align=center>",CDAY," ",MTHNAM3:
                               " ",CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
PATR9999  RETURN
.
.------------------------------------------------------------
.         Check for any request bed for the patient
.------------------------------------------------------------
RQAL0000  MOVE     AADMNO,KEY8
          PACK     KEY25,KEY8,SP70
          CALL     RSPMBRQ2
RQAL1000  CALL     RKPMBRQ2
          BRANCH   OVRCD,RQAL9999
.
          MATCH    PMBRVISN,KEY8
          GOTO     RQAL9999 IF NOT EQUAL    * different admission
.
          MOVE     PMBRRSTA,F1
          BRANCH   F1,RQAL2000,RQAL3000
          GOTO     RQAL9999
.
RQAL2000  MOVE     "Requested",PDIAGNOS
          GOTO     RQAL9999
.
RQAL3000  MATCH    AWARD,PMBREWRD
          GOTO     RQAL4000 IF NOT EQUAL    * Display Expected Ward/Bed
.
          MATCH    ABED,PMBREBED
          GOTO     RQAL9999 IF EQUAL        * ignore if same ward/bed
.
RQAL4000  PACK     PDIAGNOS,SP70
          CLEAR    PDIAGNOS
          APPEND   "Allocated (",PDIAGNOS
          APPEND   PMBREWRD,PDIAGNOS
.
          MATCH    SP70,PMBREBED
          IF       !@EQUAL
            APPEND   "/",PDIAGNOS
            APPEND   PMBREBED,PDIAGNOS
          ENDIF
          APPEND   ")",PDIAGNOS
          APPEND   SP70,PDIAGNOS
          RESET    PDIAGNOS
.
RQAL9999  RETURN
+
.------------------------------------------------------------
. Output no bed ward
.------------------------------------------------------------
NOBW0000  MATCH     SP70,FILTRSEX
          IF        !@EQUAL
            MATCH     ANSE,FILTRSEX
            IF        !@EQUAL
              MATCH     FILTRSEX,SAVEWSEX     * Filter by intended patient sex
              GOTO      BDWR1000 IF NOT EQUAL * if not either or sp70
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTBTYP
          IF        !@EQUAL
            MATCH     FILTBTYP,SAVEBEDT     * Filter by bed type
            GOTO      BDWR1000 IF NOT EQUAL
          ENDIF
.
          MOVE      ZERO,FLAG
          PACK      KEY13,WWARD,SP70
          CALL      RDSNOBE1
NOBW0100  CALL      RDKNOBE1
          BRANCH    OVRCD,NOBW9000
          MATCH     WWARD,NBWARD
          GOTO      NOBW9000 IF NOT EQUAL
.
          PACK      KEY6,WWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            PACK      WBDESC,SP70
          ENDIF 
          IF        EMPTONLY=1
            ADD       ONE,RECCOUNT
            IF        STARTNUM<RECCOUNT
              MATCH     NBWARD,LASTWARD
              CALL      WRDROW00 IF NOT EQUAL
              CALL      EBFW0000               *Display only empty bed for ward
              IF        NORECORD<=DISPNUMB
                MOVE      ONE,ENDNOW
              ENDIF
            ENDIF
            GOTO      NOBW9999
          ENDIF
.
.------  The following should be only called once ------
.
          IF        FLAG<>1
            ADD       ONE,RECCOUNT
            IF        STARTNUM<RECCOUNT
              MATCH     NBWARD,LASTWARD
              CALL      WRDROW00 IF NOT EQUAL
              CALL      EBFW0000               *Display only empty bed for ward
            ENDIF
            MOVE      ONE,FLAG
            MOVE      SP70,WBED
            CALL      ONLV0000                 *Check for patient on leave
          ENDIF
.
          MATCH     ZEROVISN,NBADMNO
          GOTO      NOBW0100 IF EQUAL
.
          MOVE      NBADMNO,ADMNOD8
          CALL      PATD0000
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY8,NBADMNO
          CALL      RDMISS1
          BRANCH    OVRCD,NOBW9999
.
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          ADD       ONE,RECCOUNT
          IF        STARTNUM>=RECCOUNT
            GOTO      NOBW0100
          ENDIF
.
          MATCH     NBWARD,LASTWARD
          CALL      WRDROW00 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr align=top>":
                             "<td height=15>&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     ZERO,F1
          MATCH     "1",PTCNBREQ
          IF        !@EQUAL
            CALL     RQAL0000   * Check for Patient Request or Allocate Ward/Bed
          ENDIF
.
          WRITE     HTMLFILE;"<td height=15>&nbsp;</td>":
                             "<td align=center>",AURNO,"&nbsp;</td>":
                             "<td>",PATFNAME:
                             " (",GENDER,",",PSAGEYRS,")&nbsp;</td>";
.
          IF        F1=1 | F1=2
            WRITE     HTMLFILE;"<td align=center><strong>",PDIAGNOS:
                               "&nbsp;</strong></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",PDIAGNOS,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td align=center>",CDAY," ",MTHNAM3:
                               " ",CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
          ADD       ONE,DISPNUMB
          IF        NORECORD>DISPNUMB
            GOTO      NOBW0100
          ENDIF
          MOVE      ONE,ENDNOW
          GOTO      NOBW9999
.
NOBW9000  COMPARE   ZERO,FLAG
          GOTO      NOBW9999 IF NOT EQUAL
          PACK      KEY6,WWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            PACK      WBDESC,SP70
          ENDIF
          ADD       ONE,RECCOUNT
          IF        STARTNUM>=RECCOUNT
            GOTO      NOBW9999
          ENDIF
..          CALL      WRDROW00
          CALL      EBFW0000                *Display empty bed to select
.
NOBW9999  RETURN
.------------------------------------------------------------
. Empty Bed for No Bed Ward
.------------------------------------------------------------
EBFW0000  MOVE      SP70,WBED      * Clear Bed just in case has crap init!!
          MOVE      SP70,BEDSTAT   * Clear Bed Stat just in case has crap init!!
.
          ADD       ONE,DISPNUMB
.
          WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center>";

          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WWARD;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WWARD,"</a>";
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>*** Empty ***</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
EBFW9999  RETURN
.------------------------------------------------------------
. Ouput on leave patient
.------------------------------------------------------------
ONLV0000  PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
ONLV1000  CALL      RDKONLV1
          BRANCH    OVRCD,ONLV9999
          MATCH     OWARD,WWARD
          GOTO      ONLV9999 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      ONLV9999 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      ONLV9999 IF EQUAL
.
          ADD       ONE,RECCOUNT
          IF        STARTNUM>=RECCOUNT
            GOTO      ONLV1000
          ENDIF
.
          MOVE      OADMNO,ADMNOD8
          CALL      PATD0000
          MOVE      "Patient on leave",PDIAGNOS
.
          WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center height=15>";
          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WBED;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WBED,"</a>";
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                             "<td align=center>",AURNO,"&nbsp;</td>":
                             "<td>",PATFNAME:
                             " (",GENDER,",",PSAGEYRS,")&nbsp;</td>":
                             "<td align=center><strong>",PDIAGNOS:
                             "&nbsp;</strong></td>":
                             "<td>",DOCFNAME,"&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td align=center>",CDAY," ",MTHNAM3:
                               " ",CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
          ADD       ONE,DISPNUMB
          IF        NORECORD>DISPNUMB
            GOTO      ONLV1000
          ENDIF
          MOVE      ONE,ENDNOW
.
ONLV9999  RETURN
.------------------------------------------------------------
. Output standby patient
.------------------------------------------------------------
STBY0000  MOVE      WSTBY,ADMNOD8
          CALL      PATD0000
          MOVE      "Standby Patient",PDIAGNOS
.
          IF        EXPDISCH=TRUE
            ADD       ONE,DISPNUMB
          ENDIF
.
          WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center height=15>";
          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WBED;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WBED,"</a>";
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF       WBEDDESC > 0
            IF       WBEDDESC = 2
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                             "<td align=center>",AURNO,"&nbsp;</td>":
                             "<td>",PATFNAME:
                             " (",GENDER,",",PSAGEYRS,")</td>":
                             "<td align=center><strong>",PDIAGNOS:
                             "&nbsp;</strong></td>":
                             "<td>",DOCFNAME,"&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td align=center>",CDAY," ",MTHNAM3:
                             " ",CCENT,CYEAR,"&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
STBY9999  RETURN
.------------------------------------------------------------
. Output Ward Heading
.------------------------------------------------------------
WRDROW00  ADD       ONE,RECCOUNT
WRDROW10  PACK      SAVKEY6,WWARD,WBED
          PACK      KEY6,WWARD,SP70
          CALL      RDWARD1
          REP       "' ",WBDESC
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell colspan=9 align=center>":
                             " Ward : </b>",WWARD," - ":
                             WBDESC,"    Extension </b> -",WEXTN:
                             "</td></tr>"
          ADD       ONE,DISPNUMB
          MOVE      WWARD,LASTWARD
          MOVE      WBDESC,WARDNAME
          MOVE      SAVKEY6,KEY6
          CALL      RDWARD1
          RETURN
.------------------------------------------------------------
. Patient Details from master file to display in table c
.------------------------------------------------------------
PATD0000  COMPARE   ONE,BEDREQST
          IF        @EQUAL
            PACK      KEY8,ADMNOD8
            CALL      RDVISA1
            BRANCH    OVRCD,PATD9900
            PACK      KEY8,ADMNOD8
            CALL      RDMISS1
            IF        OVRCD=1
              PACK      AURNO,PVIURNO
              PACK      ADOCTA,SP70
            ENDIF
            PACK      KEY8,PVIURNO
          ELSE
            PACK      KEY8,ADMNOD8
            CALL      RDMISS1
            BRANCH    OVRCD,PATD9900
            PACK      KEY8,AURNO
          ENDIF
          CALL      RDMAST1
          BRANCH    OVRCD,PATD9900
.
          CALL      PATNAM00
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,GENDER
.* ******************************************   End of Changes         *C-49016
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          MOVE      ADIAG1,PDIAGNOS
.
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          BRANCH    OVRCD,PATD9999
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          MOVE      ZERO,EXIT
          GOTO      PATD9999
.
PATD9900  CALL      INVAL000                * Display Invalid Record Row
          MOVE      ONE,EXIT
.
PATD9999  MOVE      ZERO,BEDREQST
          RETURN
.------------------------------------------------------------
. Display an Invalid Record Row
.------------------------------------------------------------
INVAL000  WRITE     HTMLFILE;"<tr align=top>":
                             "<td align=center>";
          IF        HIDELINK=TRUE
            WRITE     HTMLFILE;WBED;
          ELSE
            WRITE     HTMLFILE;"<a href=":
                               "'javascript:updateParent(#"",WWARD,"#",":
                                                     "#"",WARDNAME,"#",":
                                                     "#"",WBED,"#",":
                                                     "#"",BEDSTAT,"#");'>":
                                WBED,"</a>";
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2 
              WRITE     HTMLFILE;"<td>",PTWDSDES,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",WBDESC,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WEFRBT," - ",TDESC,"&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><strong>*** Invalid Record ***</strong></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        EXPDISCH=TRUE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
INVAL999  RETURN
.
.------------------------------------------------------------
. Ward List Table
.------------------------------------------------------------
WLST0000  WRITE     HTMLFILE;"<tr align=center>":
                               "<td class=HeadingCell>Ward</td>":
                               "<td class=HeadingCell align=right>Beds</td>":
                               "<td class=HeadingCell>Extension No</td>":
                               "<td class=HeadingCell>Classification</td>":
                             "</tr>"
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY6,SP70
          CALL      RDSWARD3
WLST0100  CALL      RDKWARD3
          BRANCH    OVRCD,WLST9999
          MATCH     SP70,WBED
          GOTO      WLST9999 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WLST0100 IF NOT EQUAL
.
          MOVE      "CG",CATEGORY
          MOVE      WCLASS,CODE
          CALL      GETCOD00
          PACK      KEY5,QUOTE,WWARD,QUOTE
          WRITE     HTMLFILE;"<tr valign=top>":
                              "<td><a href='",LINKPRG,".pbl?":
                               "&reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&wardcode=",WWARD,"'>":
                               WBDESC,"</a></td>":
                               "<td align=right>",WOCCBED,"&nbsp;</td>":
                               "<td>",WEXTN,"&nbsp;</td>":
                               "<td>",TDESC,"&nbsp;</td>":
                             "</tr>"
          GOTO      WLST0100
.
WLST9999  RETURN
.------------------------------------------------------------
. Ward List with Update Parent 
.------------------------------------------------------------
WLUPD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      WLHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "15",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY6,SP70
          CALL      RDSWARD3
WLUPD100  CALL      RDKWARD3
          BRANCH    OVRCD,WLST9999
.
          MATCH     SP70,WBED
          GOTO      WLUPD999 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WLUPD100 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      WLUPD100
          ENDIF
.
          CALL      WLROW000      * Display Ward List Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      WLUPD100 IF NOT EQUAL
.
WLUPD999  RETURN
.--------------------------------------------------------------
.  Ward List  (TABLE HEADING)
.--------------------------------------------------------------
WLHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>Ward</td>":
                               "<td class=HeadingCell>Description</td>":
                             "</tr>"
.
WLHED999  RETURN
.--------------------------------------------------------------
.  Ward List Update Parent (TABLE ROW)
.--------------------------------------------------------------
WLROW000  MOVE      "CG",CATEGORY
          MOVE      WCLASS,CODE
          CALL      GETCOD00
          REP       "' ",WBDESC 
.
          WRITE     HTMLFILE;"<tr><td><a href=":
                             "#"javascript:UpdateParent02('",WWARD,"','",WBDESC:
                              "')#">":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                              WWARD,"<td>",WBDESC,"</td>":
                              "</tr>"
.
WLROW999  RETURN
.------------------------------------------------------------
. Ward Status Table Listing
.------------------------------------------------------------
WSTA0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,LINKBTY,DIM127
          PACK      LINKBTY,LINKBTY,SP70
          REP       " 0",LINKBTY
          MOVE      ZERO,TOTALBOK
          MOVE      ZERO,TOTALPRE
          MOVE      ZERO,TOTALBED
          MOVE      ZERO,TOTALPAT
          MOVE      ZERO,TOTALEXP
          MOVE      ZERO,TOTALOPN
          PACK      KEY6,SP70
          CALL      RDSWARD3
WSTA0100  CALL      RDKWARD3
          BRANCH    OVRCD,WSTA9000
          MATCH     SP70,WBED
          GOTO      WSTA9000 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO              *List only active wards
          GOTO      WSTA0100 IF NOT EQUAL
.
          COMPARE   ONE,IBCNMHOS
          GOTO      WSTA0200 IF NOT EQUAL
.
          MATCH     SP70,WBSEHOSP
          GOTO      WSTA0200 IF EQUAL
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      WSTA0100 IF NOT EQUAL
.
WSTA0200  CALL      CALCP000                  * Calculate Number of Patients
          CALL      CALCO000                  * Calculate no of beds
.                                             * currently active
          MOVE      "CG",CATEGORY
          MOVE      WCLASS,CODE
          CALL      GETCOD00
.
          PACK      KEY5,QUOTE,WWARD,QUOTE
          ASSIGN    OPENBEDS-PATCOUNT,F8
          ADD       WOCCBED,TOTALBED
          ADD       PATCOUNT,TOTALPAT
          ADD       PREADMIS,TOTALPRE
          ADD       BOOKINGS,TOTALBOK
          ADD       EXPECTS,TOTALEXP
          ADD       OPENBEDS,TOTALOPN
          CALL      CALBAR00
          IF        OPENBEDS=0
            MOVE      ZERO,PERCENT
          ENDIF
.
          CLEAR     WARDLINK
          APPEND    LINKPRG,WARDLINK
          APPEND    ".pbl?",WARDLINK
          APPEND    "&reportno=",WARDLINK
          APPEND    LINKREP,WARDLINK
          APPEND    "&template=",WARDLINK
          APPEND    LINKTEM,WARDLINK
          APPEND    "&wardcode=",WARDLINK
          APPEND    WWARD,WARDLINK
          APPEND    "&wbedtype=",WARDLINK
          APPEND    LINKBTY,WARDLINK
          RESET     WARDLINK
.
          UNPACK   FILWIDTH,KEY6,KEY3
          WRITE    HTMLFILE;"t.addRow(",QUOTE,WARDLINK,QUOTE,COMMA:
                                         QUOTE,WBDESC,QUOTE,COMMA:
                                         QUOTE,WEXTN,QUOTE,COMMA:
                                         QUOTE,BOOKINGS,QUOTE,COMMA:
                                         QUOTE,PREADMIS,QUOTE,COMMA:
                                         QUOTE,WOCCBED,QUOTE,COMMA:
                                         QUOTE,PATCOUNT,QUOTE,COMMA:
                                         QUOTE,F8,QUOTE,COMMA:
                                         QUOTE,PERCENT,QUOTE,COMMA:
                                         QUOTE,KEY3,QUOTE,COMMA:
                                         QUOTE,EXPECTS,QUOTE,COMMA:
                                         QUOTE,OPENBEDS,QUOTE,");"
.
          GOTO      WSTA0100
.
WSTA9000  MOVE      TOTALBED,WOCCBED
          MOVE      TOTALPAT,PATCOUNT
          MOVE      TOTALBOK,BOOKINGS
          MOVE      TOTALPRE,PREADMIS
          MOVE      TOTALEXP,EXPECTS
          MOVE      TOTALOPN,OPENBEDS
          ASSIGN    OPENBEDS-PATCOUNT,F8
          CALL      CALBAR00
          UNPACK    FILWIDTH,KEY6,KEY3
          MOVE      "Total            ",KEY20
          WRITE     HTMLFILE;"t.addTotal(",QUOTE,QUOTE,COMMA:
                                           QUOTE,KEY20,QUOTE,COMMA:
                                           QUOTE,"&nbsp;",QUOTE,COMMA:
                                           QUOTE,BOOKINGS,QUOTE,COMMA:
                                           QUOTE,PREADMIS,QUOTE,COMMA:
                                           QUOTE,WOCCBED,QUOTE,COMMA:
                                           QUOTE,PATCOUNT,QUOTE,COMMA:
                                           QUOTE,F8,QUOTE,COMMA:
                                           QUOTE,PERCENT,QUOTE,COMMA:
                                           QUOTE,KEY3,QUOTE,COMMA:
                                           QUOTE,EXPECTS,QUOTE,COMMA:
                                           QUOTE,OPENBEDS,QUOTE,");"
.
WSTA9999  RETURN
.------------------------------------------------------------
. Calculate Number of Beds Currently Active
.------------------------------------------------------------
CALCO000  MOVE      WWARD,SAVEWARD
          MOVE      ZERO,OPENBEDS
          BRANCH    WACTIVE,CALCO999               * No open beds if ward 
          MOVE      WINPUT,WRDONWRD                * is inactive
          BRANCH    WRDONWRD,CALCO200
.
.         Bed ward (0) or Mixed Ward (2)
.
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
CALCO100  CALL      RDKWARD1
          BRANCH    OVRCD,CALCO999
.
          MATCH     SAVEWARD,WWARD
          GOTO      CALCO999 IF NOT EQUAL          * Check if same ward
.
          MATCH     SP70,WBED                      * Check if bed record
          GOTO      CALCO100 IF EQUAL
.
          BRANCH    WACTIVE,CALCO100               * Check if bed is active
.
          MATCH     "1",PTWDBDST
          IF        !@EQUAL
            ADD       ONE,OPENBEDS                 * Check if bed is closed
          ENDIF
.
          GOTO      CALCO100                       * Goto next bed file
.
. Ward Only Ward
.
CALCO200  MOVE      WOCCBED,OPENBEDS
.
CALCO999  PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
          RETURN
.------------------------------------------------------------
. Calculate Number of Patients in a Ward
.------------------------------------------------------------
CALCP000  MOVE      WWARD,SAVEWARD
          MOVE      ZERO,SBYCOUNT
          MOVE      ZERO,PATCOUNT
          MOVE      WINPUT,NOBEDWRD
          BRANCH    NOBEDWRD,CALCP200
.
.         Bed ward (0) or Mixed Ward (2)
.
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
CALCP100  CALL      RDKWARD1
          BRANCH    OVRCD,CALCP200
          MATCH     SAVEWARD,WWARD         * same ward?
          GOTO      CALCP200 IF NOT EQUAL  * check if mixed ward b4 go to P400
          BRANCH    WACTIVE,CALCP100       * only use active beds  v9.02.09
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
          ENDIF
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
            ADD       ONE,SBYCOUNT
          ENDIF
          GOTO      CALCP100
.
.
. Check No Bed Ward File
.
CALCP200  PACK      KEY13,SAVEWARD,SP20
          CALL      RDSNOBE1
CALCP300  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CALCP400
          MATCH     SAVEWARD,NBWARD         * same ward?
          GOTO      CALCP400 IF NOT EQUAL
          ADD       ONE,PATCOUNT
          GOTO      CALCP300
.
. Calculate Bookings for Ward for Today
.
CALCP400  MOVE      ZERO,EXPECTS            * I SRF 22631
          MOVE      ZERO,PREADMIS
          MOVE      ZERO,BOOKINGS
.
. Don't show expects column on hospital ward list
.
          BRANCH    NOEXPECT,CALCP900
.
          PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
CALCP500  CALL      RKBKREC4
          BRANCH    OVRCD,CALCP600
          MATCH     BKREEDAT,CURRDATE
          GOTO      CALCP600 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Booked only
          GOTO      CALCP500 IF NOT EQUAL
.
          PACK      KEY8,DBKREBOO
          CALL      RDBKRX11
          BRANCH    OVRCD,CALCP500
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      CALCP505 IF EQUAL            * then check expected ward
.
          MATCH     SAVEWARD,BKRXPOWD
          GOTO      CALCP500 IF NOT EQUAL
          GOTO      CALCP510
.
CALCP505  MATCH     SAVEWARD,BKREWARD            * Check Expected ward
          GOTO      CALCP500 IF NOT EQUAL
.
CALCP510  ADD       ONE,BOOKINGS
          GOTO      CALCP500
.
. Calculate Preadmissions for Ward for Today
.
CALCP600  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
CALCP700  CALL      RDKMISS3
          BRANCH    OVRCD,CALCP900
          MATCH     ADATE,CURRDATE
          GOTO      CALCP900 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      CALCP700 IF NOT EQUAL
          MATCH     SAVEWARD,PTMIXWRD
          GOTO      CALCP700 IF NOT EQUAL
          ADD       ONE,PREADMIS
          GOTO      CALCP700
.
CALCP900  ADD       BOOKINGS,EXPECTS             * I SRF 22631
          ADD       PREADMIS,EXPECTS             * I SRF 22631
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
.
CALCP999  RETURN
.------------------------------------------------------------
. Calculate Bar for Ward
.------------------------------------------------------------
CALBAR00  MOVE      "10",FILHIGH
.         ASSIGN    PATCOUNT/WOCCBED*150,F3            * D SRF 22631
.         ASSIGN    PATCOUNT/WOCCBED*100.0,PERCENT     * D SRF 22631
          ASSIGN    PATCOUNT/OPENBEDS*150,F3           * I SRF 22631
          ASSIGN    PATCOUNT/OPENBEDS*100.0,PERCENT    * I SRF 22631
          IF        F3>150
            MOVE      "150",F3
          ENDIF
          IF        F3=0
            MOVE      ONE,F3
            MOVE      "1",FILHIGH
          ENDIF
          MOVE      F3,KEY3
          SQUEEZE   KEY3
          CLEAR     FILWIDTH
          APPEND    "WIDTH=",FILWIDTH
          APPEND    KEY3,FILWIDTH
          RESET     FILWIDTH
.
          MOVE      FILHIGH,KEY3
          SQUEEZE   KEY3
          CLEAR     FILHIGHT
          APPEND    "HEIGHT=",FILHIGHT
          APPEND    KEY3,FILHIGHT
          RESET     FILHIGHT
.
CALBAR99  RETURN
.
.------------------------------------------------------------
. Calculate Number of Patient on leave
.------------------------------------------------------------
CALOLV00  MOVE      ZERO,TOTALOLV
          PACK      KEY14,WWARD,SP70
.
          CALL      RDSONLV1
CALOLV10  CALL      RDKONLV1
          BRANCH    OVRCD,CALOLV99
          MATCH     OWARD,WWARD
          GOTO      CALOLV99 IF NOT EQUAL
.
          ADD       ONE,TOTALOLV
          GOTO      CALOLV10
CALOLV99  RETURN
.
.------------------------------------------------------------
. Ward Status Table Listing
.------------------------------------------------------------
WSTB0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,LINKBTY,DIM127
          PACK      LINKBTY,LINKBTY,SP70
          REP       " 0",LINKBTY
.
          MOVE      ZERO,TOTALPAT
          MOVE      ZERO,TOTALOUT
          MOVE      ZERO,TOTALPRE
          MOVE      ZERO,TOTALBOK
          MOVE      ZERO,TOTALPBK
          MOVE      ZERO,TOTALEPO
          MOVE      ZERO,TOTALEBQ
          MOVE      ZERO,TOTALEXP
          MOVE      ZERO,TOTALCDC
          MOVE      ZERO,TOTALTDC
          MOVE      ZERO,TOTALBRO
          MOVE      ZERO,TOTALBED
          MOVE      ZERO,TOTALOPN
          MOVE      ZERO,TOTALOLV
          MOVE      ZERO,PATONLEV
.
          CALL      UNALL000
. 
          PACK      KEY6,SP70
          CALL      RDSWARD3
WSTB0100  CALL      RDKWARD3
          BRANCH    OVRCD,WSTB9000
          MATCH     SP70,WBED
          GOTO      WSTB9000 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO              *List only active wards
          GOTO      WSTB0100 IF NOT EQUAL
.
          COMPARE   ONE,IBCNMHOS
.
          GOTO      WSTB0200 IF NOT EQUAL
.
          MATCH     SP70,WBSEHOSP
          GOTO      WSTB0200 IF EQUAL
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      WSTB0100 IF NOT EQUAL
.
WSTB0200  MOVE      ZERO,SBYCOUNT
          MOVE      ZERO,PATCOUNT
          MOVE      ZERO,OUTLIERS
          MOVE      ZERO,PREADMIS
          MOVE      ZERO,BOOKINGS
          MOVE      ZERO,PREBOOKS
          MOVE      ZERO,EXPPOSOP
          MOVE      ZERO,EXPDBREQ
          MOVE      ZERO,EXPECTS
          MOVE      ZERO,CONFRMDC 
          MOVE      ZERO,TENTATDC 
          MOVE      ZERO,BEDRQOUT
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE           * Current date
.
          MOVE      CURRDATE,YESTDATE
          SUB       ONE,YESTDATE            * Yesterday

          MOVE      CURRDATE,TOMODATE
          ADD       ONE,TOMODATE            * Tomorrow
.
          MOVE      WWARD,SAVEWARD
          MOVE      WBED,SAVEBED  
.
WSTB0210  CALL      OUTLIR00
.
          PACK      KEY6,SAVEBED,SAVEWARD,SP70
          CALL      RDWARD3
.
          CALL      BDRQIN00
          CALL      BDRQOU00
          CALL      CFTENT00
.
          CALL      CALCB000                  * Calculate Number of Patients
          CALL      CALCO000                  * Calculate no of beds
.                                             * currently active
          MOVE      "CG",CATEGORY
          MOVE      WCLASS,CODE
          CALL      GETCOD00
.
          PACK      KEY5,QUOTE,WWARD,QUOTE
          ASSIGN    OPENBEDS-PATCOUNT,F8
          ADD       WOCCBED,TOTALBED
.
          ADD       PATCOUNT,TOTALPAT
          ADD       OUTLIERS,TOTALOUT
          ADD       PREADMIS,TOTALPRE
          ADD       BOOKINGS,TOTALBOK
          ADD       PREBOOKS,TOTALPBK
          ADD       EXPPOSOP,TOTALEPO
          ADD       EXPDBREQ,TOTALEBQ
          ADD       EXPECTS,TOTALEXP
          ADD       CONFRMDC,TOTALCDC
          ADD       TENTATDC,TOTALTDC
          ADD       BEDRQOUT,TOTALBRO
.
          ADD       OPENBEDS,TOTALOPN
          CALL      CALBAR00
          IF        OPENBEDS=0                      
            MOVE      ZERO,PERCENT
          ENDIF
.
          CALL      CALOLV00           * Calculate No of Patient on Leave
          ADD       TOTALOLV,PATONLEV  * Add total No of patient on Leave
.
          CLEAR     WARDLINK
          APPEND    LINKPRG,WARDLINK
          APPEND    ".pbl?",WARDLINK
          APPEND    "&reportno=",WARDLINK
          APPEND    LINKREP,WARDLINK
          APPEND    "&template=",WARDLINK
          APPEND    LINKTEM,WARDLINK
          APPEND    "&wardcode=",WARDLINK
          APPEND    WWARD,WARDLINK
          APPEND    "&wbedtype=",WARDLINK
          APPEND    LINKBTY,WARDLINK
          RESET     WARDLINK
.
          UNPACK   FILWIDTH,KEY6,KEY3
          WRITE    HTMLFILE;"t.addRow(",QUOTE,WARDLINK,QUOTE,COMMA:      * 0
                                         QUOTE,WBDESC,QUOTE,COMMA:       * 1
                                         QUOTE,WEXTN,QUOTE,COMMA:        * 2
                                         QUOTE,BOOKINGS,QUOTE,COMMA:     * 3
                                         QUOTE,PREADMIS,QUOTE,COMMA:     * 4
                                         QUOTE,WOCCBED,QUOTE,COMMA:      * 5
                                         QUOTE,PATCOUNT,QUOTE,COMMA:     * 6
                                         QUOTE,F8,QUOTE,COMMA:           * 7
                                         QUOTE,PERCENT,QUOTE,COMMA:      * 8
                                         QUOTE,KEY3,QUOTE,COMMA:         * 9
                                         QUOTE,EXPECTS,QUOTE,COMMA:      * 10
                                         QUOTE,OPENBEDS,QUOTE,COMMA:     * 11
                                         QUOTE,OUTLIERS,QUOTE,COMMA:     * 12
                                         QUOTE,PREBOOKS,QUOTE,COMMA:     * 13
                                         QUOTE,EXPPOSOP,QUOTE,COMMA:     * 14
                                         QUOTE,EXPDBREQ,QUOTE,COMMA:     * 15
                                         QUOTE,CONFRMDC,QUOTE,COMMA:     * 16
                                         QUOTE,TENTATDC,QUOTE,COMMA:     * 17
                                         QUOTE,BEDRQOUT,QUOTE,COMMA:     * 18
                                         QUOTE,TOTALOLV,QUOTE,");"       * 19

.
          GOTO      WSTB0100
.
WSTB9000  MOVE      TOTALBED,WOCCBED
          MOVE      TOTALPAT,PATCOUNT
          MOVE      TOTALOUT,OUTLIERS
          MOVE      TOTALPRE,PREADMIS
          MOVE      TOTALBOK,BOOKINGS
          MOVE      TOTALPBK,PREBOOKS
          MOVE      TOTALEPO,EXPPOSOP
          MOVE      TOTALEBQ,EXPDBREQ
          MOVE      TOTALEXP,EXPECTS
          MOVE      TOTALCDC,CONFRMDC
          MOVE      TOTALTDC,TENTATDC
          MOVE      TOTALBRO,BEDRQOUT
.
          MOVE      TOTALOPN,OPENBEDS
          ASSIGN    OPENBEDS-PATCOUNT,F8
          CALL      CALBAR00
          UNPACK    FILWIDTH,KEY6,KEY3
          MOVE      "Total            ",KEY20
          WRITE     HTMLFILE;"t.addTotal(",QUOTE,QUOTE,COMMA:              * 0
                                           QUOTE,KEY20,QUOTE,COMMA:        * 1
                                           QUOTE,"&nbsp;",QUOTE,COMMA:     * 2
                                           QUOTE,BOOKINGS,QUOTE,COMMA:     * 3
                                           QUOTE,PREADMIS,QUOTE,COMMA:     * 4
                                           QUOTE,WOCCBED,QUOTE,COMMA:      * 5
                                           QUOTE,PATCOUNT,QUOTE,COMMA:     * 6
                                           QUOTE,F8,QUOTE,COMMA:           * 7
                                           QUOTE,PERCENT,QUOTE,COMMA:      * 8
                                           QUOTE,KEY3,QUOTE,COMMA:         * 9
                                           QUOTE,EXPECTS,QUOTE,COMMA:      * 10
                                           QUOTE,OPENBEDS,QUOTE,COMMA:     * 11
                                           QUOTE,OUTLIERS,QUOTE,COMMA:     * 12
                                           QUOTE,PREBOOKS,QUOTE,COMMA:     * 13
                                           QUOTE,EXPPOSOP,QUOTE,COMMA:     * 14
                                           QUOTE,EXPDBREQ,QUOTE,COMMA:     * 15
                                           QUOTE,CONFRMDC,QUOTE,COMMA:     * 16
                                           QUOTE,TENTATDC,QUOTE,COMMA:     * 17
                                           QUOTE,BEDRQOUT,QUOTE,COMMA:     * 18
                                           QUOTE,PATONLEV,QUOTE,");"       * 19

.
WSTB9999  RETURN
.
.------------------------------------------------------------
. Calculate Number of Patients in a Ward
.------------------------------------------------------------
CALCB000  MOVE      WINPUT,NOBEDWRD
          BRANCH    NOBEDWRD,CALCB200
.
.         Bed ward (0) or Mixed Ward (2)
.
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
CALCB100  CALL      RDKWARD1
          BRANCH    OVRCD,CALCB200
          MATCH     SAVEWARD,WWARD         * same ward?
          GOTO      CALCB200 IF NOT EQUAL  * check if mixed ward b4 goto P200
          BRANCH    WACTIVE,CALCB100       * only use active beds 9
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
          ENDIF
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
            ADD       ONE,SBYCOUNT
          ENDIF
          GOTO      CALCB100
.
. Check No Bed Ward File
.
CALCB200  PACK      KEY13,SAVEWARD,SP20
          CALL      RDSNOBE1
CALCB300  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CALCB400
          MATCH     SAVEWARD,NBWARD         * same ward?
          GOTO      CALCB400 IF NOT EQUAL
          ADD       ONE,PATCOUNT
          GOTO      CALCB300
.
. Calculate Bookings for Ward for Today
.
CALCB400  PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
CALCB500  CALL      RKBKREC4
          BRANCH    OVRCD,CALCB600
.
          MATCH     BKREEDAT,CURRDATE
          GOTO      CALCB600 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Booked only
          GOTO      CALCB500 IF NOT EQUAL
.
CALCB510  PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,CALCB500
.
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      CALCB550 IF EQUAL            * then check expected ward
.
. Post Op ward is not empty
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CALCB540
.
          COMPARE   ONE,ASTAT
          GOTO      CALCB540 IF NOT EQUAL
.
          MATCH     SP70,PTMIXWRD
          GOTO      CALCB540 IF EQUAL
.
          MATCH     BKRXPOWD,PTMIXWRD
          IF        !@EQUAL
            ADD       ONE,EXPPOSOP
            GOTO      CALCB500
          ENDIF
.
CALCB540  MATCH     SAVEWARD,BKRXPOWD
          IF        @EQUAL
            ADD       ONE,BOOKINGS
          ENDIF
          GOTO      CALCB500
.
CALCB550  MATCH     SAVEWARD,BKREWARD            * Check Expected ward
          IF        @EQUAL
            ADD       ONE,BOOKINGS
          ENDIF
          GOTO      CALCB500
.
. Calculate Preadmissions/admission for Ward for Today
.
CALCB600  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
CALCB700  CALL      RDKMISS3
          BRANCH    OVRCD,CALCB900
.
          MATCH     ADATE,CURRDATE
          GOTO      CALCB900 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      CALCB710 IF EQUAL
.
          COMPARE   TWO,ASTAT
          GOTO      CALCB710 IF EQUAL
.
          GOTO      CALCB700
.
CALCB710  MATCH     SAVEWARD,PTMIXWRD
          GOTO      CALCB700 IF NOT EQUAL
.
. Check Post Op ward
.
CALCB720  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CALCB780
.
          MATCH     SP70,PMVXPOWD
          GOTO      CALCB780 IF EQUAL
.
          MATCH     PMVXPOWD,PTMIXWRD
          IF        !@EQUAL
            ADD       ONE,EXPPOSOP
            GOTO      CALCB700
          ENDIF
.
CALCB780  ADD       ONE,PREADMIS
          GOTO      CALCB700
.
CALCB900  ADD       BOOKINGS,EXPECTS             * I SRF 22631
          ADD       PREADMIS,EXPECTS             * I SRF 22631
          ADD       EXPPOSOP,EXPECTS
          ADD       BOOKINGS,PREBOOKS
          ADD       PREADMIS,PREBOOKS
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
.
CALCB999  RETURN
.
.--------------------------------------------------------------------
. Calculate confirm and tentative count
.--------------------------------------------------------------------
CFTENT00  MOVE      "2",DIM1
          PACK      KEY20,DIM1,SAVEWARD,SP70
          CALL      RDSMISS6
CFTENT20  CALL      RDKMISS6
          BRANCH    OVRCD,CFTENT99
.
          MATCH     DIM1,DASTAT
          GOTO      CFTENT99 IF NOT EQUAL
.
          MATCH     SAVEWARD,AWARD
          GOTO      CFTENT99 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER
          MOVE      DAADMNO,ADMISSNO
          MOVE      "023",ATRTYPE
          CALL      GPTATR00
          IF        NOTFOUND=1
            CALL      CLPATATR
            GOTO      CFTENT20
          ENDIF
.
          MATCH     "1",PTARCOD1
          GOTO      CFTENT60 IF NOT EQUAL
.
. Confirm DC
.
CFTENT30  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWOEDAT
          GOTO      CFTENT40 IF EQUAL
.
          MATCH     PMWOEDAT,CURRDATE
          IF        @EQUAL
            ADD     ONE,CONFRMDC                 * Confirmed count
          ENDIF
.
          GOTO      CFTENT20
.
CFTENT40  MOVE      ADATE,DATEWORK
          IF        ASTAY <> 0
            ADD       ASTAY,DATEWORK
          ENDIF
.
          MATCH     DATEWORK,CURRDATE
          IF        @EQUAL
            ADD       ONE,CONFRMDC               * Confirmed count
          ENDIF
.
          GOTO      CFTENT20
.
. Tentative DC
.
CFTENT60  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWOEDAT
          GOTO      CFTENT70 IF EQUAL
.
          MATCH     CURRDATE,PMWOEDAT
          IF        @EQUAL | @LESS
            ADD     ONE,TENTATDC                 * Tentative count
          ENDIF
.
          GOTO      CFTENT20
.
CFTENT70  MOVE      ADATE,DATEWORK
          IF        ASTAY <> 0
            ADD       ASTAY,DATEWORK
          ENDIF
.
          MATCH     CURRDATE,DATEWORK
          IF        @EQUAL | @LESS
            ADD       ONE,TENTATDC               * Tentative count
          ENDIF
.
          GOTO      CFTENT20
.
CFTENT99  RETURN
.
.---------------------------------------------------------------------------
. Get patatraf row for ur/admission/type
.---------------------------------------------------------------------------
GPTATR00  MOVE      ONE,NOTFOUND
          PACK      KEY35,URNUMBER,ADMISSNO,ATRTYPE,Z70
          CALL      RSPTATR3
GPTATR20  CALL      RPPTATR3
          BRANCH    OVRCD,GPTATR80
.
          MATCH     URNUMBER,PTARURNO
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      GPTATR20 IF EQUAL
.
          MOVE      ZERO,NOTFOUND
          GOTO      GPTATR99
.
GPTATR80  CALL      CLPATATR
.
GPTATR99  RETURN
.
.------------------------------------------------------------
. Get outliers count
.------------------------------------------------------------
OUTLIR00  PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,OUTLIR99
.
          MATCH     SP70,WCLASS
          GOTO      OUTLIR99 IF EQUAL
.
OUTLIR15  PACK      KEY5,CATCG,WCLASS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLIR99
.
          MATCH     SP70,TCINDC1
          GOTO      OUTLIR99 IF EQUAL
.
          MOVE      TCINDC1,WOUTIND1
.
          MOVE      "2",DIM1
          PACK      KEY20,DIM1,SAVEWARD,SP70
          CALL      RDSMISS6
OUTLIR20  CALL      RDKMISS6
          BRANCH    OVRCD,OUTLIR99
.
          MATCH     DIM1,DASTAT
          GOTO      OUTLIR99 IF NOT EQUAL
.
          MATCH     SAVEWARD,AWARD
          GOTO      OUTLIR99 IF NOT EQUAL
.
          CALL      COUTLI00
          IF        OUTLFLAG = ONE
            ADD       ONE,OUTLIERS
          ENDIF
.
          CALL      COUTLS00                        * Stand by outlier
. 
          GOTO      OUTLIR20                        * Next patient
.
OUTLIR99  RETURN
.
.---------------------------------------------------------------------
. Check if it is an admission is an outlier
.---------------------------------------------------------------------
COUTLI00  MOVE      ZERO,OUTLFLAG
.
          MATCH     SP70,ACLSSFT
          GOTO      COUTLI99 IF EQUAL
.
          PACK      KEY5,CATAC,ACLSSFT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,COUTLI99
.
          MATCH     PSPCIND1,WOUTIND1
          IF        @EQUAL
            GOTO      COUTLI99
          ENDIF
.
. Check multiple ward
.
COUTLI40  PACK      KEY12,PTWDHOSN,WWARD,WBED,SP70
          CALL      RSPMMSW1
COUTLI42  CALL      RKPMMSW1
          BRANCH    OVRCD,COUTLI80
.
          MATCH     PTWDHOSN,PMMWHOSP
          GOTO      COUTLI80 IF NOT EQUAL
.
          MATCH     WWARD,PMMWWARD
          GOTO      COUTLI80 IF NOT EQUAL
.
          MATCH     WBED,PMMWBEDC
          GOTO      COUTLI80 IF NOT EQUAL
.
          MATCH     SP70,PMMWWCLS
          GOTO      COUTLI42 IF EQUAL
.
          PACK      KEY5,CATCG,PMMWWCLS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,COUTLI42
.
          MATCH     PSPCIND1,TCINDC1
          GOTO      COUTLI99 IF EQUAL
.
          GOTO      COUTLI42
.
COUTLI80  MOVE      ONE,OUTLFLAG
.
COUTLI99  RETURN
.
.------------------------------------------------------------
. Count outlier for Patient on standby
.------------------------------------------------------------
COUTLS00  PACK      KEY14,DAADMNO,SAVEWARD,SP70
          CALL      RDSWARD2
          CALL      RDKWARD2
          BRANCH    OVRCD,COUTLS99
.
          MATCH     DAADMNO,DWADMNO
          GOTO      COUTLS99 IF NOT EQUAL
.
          MATCH     SAVEWARD,WWARD
          GOTO      COUTLS99 IF NOT EQUAL
.
          MATCH     SP70,DWSTBY
          GOTO      COUTLS99 IF EQUAL
.
          MOVE      DWSTBY,ADMISSNO 
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,COUTLS99
.
          MATCH     "2",DASTAT
          GOTO      COUTLS99 IF NOT EQUAL
.
          CALL      COUTLI00
          IF        OUTLFLAG = ONE
            ADD       ONE,OUTLIERS
          ENDIF
.
COUTLS99  RETURN
.
.---------------------------------------------------------------------
. Check for allocated bed requests for the current ward
. Request dates of yesterday, today and tomorrow
.---------------------------------------------------------------------
BDRQIN00  PACK      KEY24,YESTDATE,SP70          * Yesterday
          CALL      RSPMBRQ3              
BDRQIN20  CALL      RKPMBRQ3                     * Get bed requests
          BRANCH    OVRCD,BDRQIN99
.
          MATCH     PMBRREQD,TOMODATE            * Exit of after tomorrow
          GOTO      BDRQIN99 IF LESS
.
          MATCH     SAVEWARD,PMBREWRD            * Correct ward
          GOTO      BDRQIN20 IF NOT EQUAL
.
          MATCH     "2",PMBRRSTA                 * Allocated
          GOTO      BDRQIN20 IF NOT EQUAL
.
          ADD       ONE,EXPDBREQ
          ADD       ONE,EXPECTS
.
          GOTO      BDRQIN20
.
BDRQIN99  RETURN
.
.---------------------------------------------------------------------
. Check for pending bed request outs for patients in the current ward
. Request dates of yesterday, today and tomorrow
.---------------------------------------------------------------------
BDRQOU00  PACK      KEY24,YESTDATE,SP70          * Yesterday
          CALL      RSPMBRQ3
BDRQOU20  CALL      RKPMBRQ3                     * Get bed requests
          BRANCH    OVRCD,BDRQOU99
.
          MATCH     PMBRREQD,TOMODATE            * Exit of after tomorrow
          GOTO      BDRQOU99 IF LESS
.
          MATCH     "1",PMBRRSTA                 * Requested
          GOTO      BDRQOU20 IF NOT EQUAL
.
          PACK      KEY30,PMBRVISN,Z70
          CALL      RDSTRAN2                     * Get patients current ward
          CALL      RDPTRAN2                    
          BRANCH    OVRCD,BDRQOU20
.
          MATCH     DTADMN,PMBRVISN              * Correct admission
          GOTO      BDRQOU20 IF NOT EQUAL
.
          MATCH     TWARD,SAVEWARD               * Skip patient not in the 
          GOTO      BDRQOU20 IF NOT EQUAL        * current ward
.
          ADD       ONE,BEDRQOUT
.
          GOTO      BDRQOU20
.
BDRQOU99  RETURN
.
.------------------------------------------------------------
. Calculate Number of Patients not allocate bed
.------------------------------------------------------------
UNALL000  MOVE      ZERO,UNALLOC 
          MOVE      ZERO,EXPECTS
.
. Calculate Bookings for Ward for Today
.
UNALL400  PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
UNALL500  CALL      RKBKREC4
          BRANCH    OVRCD,UNALL600
.
          MATCH     BKREEDAT,CURRDATE
          GOTO      UNALL600 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Booked only
          GOTO      UNALL500 IF NOT EQUAL
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL  
            ADD       ONE,UNALLOC
          ENDIF
.
          GOTO      UNALL500
.
. Calculate Preadmissions for Ward for Today
.
UNALL600  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
UNALL700  CALL      RDKMISS3
          BRANCH    OVRCD,UNALL900
          MATCH     ADATE,CURRDATE
          GOTO      UNALL900 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      UNALL700 IF NOT EQUAL
.
          MATCH     SP70,PTMIXWRD
          IF        @EQUAL
            ADD       ONE,UNALLOC
          ENDIF
.
          GOTO      UNALL700
.
UNALL900  IF        UNALLOC = ZERO
            GOTO      UNALL999
          ENDIF
.
          ADD      UNALLOC,EXPECTS
          ADD      UNALLOC,TOTALPBK
          ADD      UNALLOC,TOTALEXP
          MOVE     SP70,KEY3
          MOVE     " Ward Not Allocated",UNALDSC 
          WRITE    HTMLFILE;"t.addRow(",QUOTE,QUOTE,COMMA:               * 0
                                         QUOTE,UNALDSC,QUOTE,COMMA:      * 1
                                         QUOTE,QUOTE,COMMA:              * 2
                                         QUOTE,"0",QUOTE,COMMA:          * 3
                                         QUOTE,"0",QUOTE,COMMA:          * 4
                                         QUOTE,"0",QUOTE,COMMA:          * 5
                                         QUOTE,"0",QUOTE,COMMA:          * 6
                                         QUOTE,"0",QUOTE,COMMA:          * 7
                                         QUOTE,".0",QUOTE,COMMA:         * 8
                                         QUOTE,QUOTE,COMMA:              * 9
                                         QUOTE,EXPECTS,QUOTE,COMMA:      * 10
                                         QUOTE,"0",QUOTE,COMMA:          * 11
                                         QUOTE,"0",QUOTE,COMMA:          * 12
                                         QUOTE,UNALLOC,QUOTE,COMMA:      * 13
                                         QUOTE,"0",QUOTE,COMMA:          * 14
                                         QUOTE,"0",QUOTE,COMMA:          * 15
                                         QUOTE,"0",QUOTE,COMMA:          * 16
                                         QUOTE,"0",QUOTE,COMMA:          * 17
                                         QUOTE,"0",QUOTE,");"            * 18
.
UNALL999  RETURN

.
.------------------------------------------------------------
. Ward/Bed History 
.------------------------------------------------------------
WRHIS000  PACK      KEY6,PTWRD001,PTWRD002   * read ward/bed file
          CALL      RDWARD1
          BRANCH    OVRCD,WRHIS999
.
          MOVE      ZERO,SACTIVE          * Initialise active indicator
          MOVE      ZERO,SNOBEDS          * Initialise number of beds
          MOVE      SP70,SWBTYPE          * Initialise ward class/room type
          MOVE      SP70,SWBIFST          * Initialise Infection Status
.
          MOVE      WACTIVE,SWACTIVE      * Save the current status
          MATCH     SP3,PTWRD002
          IF        !@EQUAL
            MOVE      WRTYPE,SWBTYPE      * Bed history, save room type
            MOVE      PTWDIFST,SWBIFST    * Bed history, save infection status
          ELSE
            MOVE      WCLASS,SWBTYPE      * Ward history, save ward class
            MOVE      WOCCBED,SNOBEDS     * Ward history, save no of beds
          ENDIF
.
          PACK      KEY14,PTWRD001,PTWRD002,Z70
          CALL      RSPTWBH1
WRHIS010  CALL      RPPTWBH1   
          BRANCH    OVRCD,WRHIS999
.
          MATCH     WBHWARD,PTWRD001
          GOTO      WRHIS999 IF NOT EQUAL
.
          MATCH     WBHBED,PTWRD002
          GOTO      WRHIS999 IF NOT EQUAL
.
          MATCH     SP8,WBHDATE
          GOTO      WRHIS999 IF EQUAL
.
          UNPACK    WBHDATE,CCENT,CYEAR,CMON,CDAY
          CALL      CNXT0000                 * Calculate the next Date
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          COMPARE   ONE,SWACTIVE
          IF        @EQUAL
            MOVE      "No",ACTVDESC
          ELSE
            MOVE      "Yes",ACTVDESC
          ENDIF
          MOVE      WBHACTV,SWACTIVE    * Save the active
.
.         Check if view history for Ward or Bed
.
          MOVE      SP70,TDESC
          MATCH     SP3,PTWRD002
          IF        !@EQUAL
            MOVE      SP70,IFSTDESC
            MATCH     SP3,SWBIFST
            IF        !@EQUAL
              PACK      KEY5,CATBW,SWBIFST
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,IFSTDESC
              ENDIF
            ENDIF
.
            MOVE      SP70,TDESC
            MATCH     SP3,SWBTYPE
            IF        !@EQUAL
              PACK      KEY5,CODERT,SWBTYPE
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      "Invalid Room Type",TDESC
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td><td>",ACTVDESC,"</td><td>",TDESC:
                               "</td><td>",IFSTDESC,"</td></tr>";
            MOVE      WBHRTYP,SWBTYPE          * save room type
            MOVE      WBHIFST,SWBIFST          * save infection status
          ELSE
            MATCH     SP3,SWBTYPE
            IF        !@EQUAL
              PACK      KEY5,ANSC,ANSG,SWBTYPE
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      "Invalid Ward Class",TDESC
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td><td>",ACTVDESC,"</td><td>",SNOBEDS:
                               "</td><td>",TDESC,"</td></tr>"
            MOVE      WBHCLAS,SWBTYPE          * save ward class
            MOVE      WBHNOCC,SNOBEDS          * save number of beds
          ENDIF
.
          GOTO      WRHIS010
.
WRHIS999  RETURN 
.------------------------------------------------------------
. Empty Bed List
.------------------------------------------------------------
EMPTY000  MOVE      ZERO,F8
          MOVE      ZERO,DISPNUMB
          MOVE      "99",NORECORD
          MOVE      F8,KEY8
          WRITE     HTMLFILE;"["
          MOVE      ONE,FIRSTROW
          PACK      KEY14,F8,SP70
          CALL      RDSWARD2
EMPTY100  CALL      RDKWARD2
          BRANCH    OVRCD,EMPTY500
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            GOTO      EMPTY500
          ENDIF
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP              * All hospital access
            GOTO      EMPTY110 IF EQUAL
            MATCH     WBSEHOSP,PTWDHOSN          * filter on id from pathsp
            GOTO      EMPTY100 IF NOT EQUAL
          ENDIF

EMPTY110  MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PTWDHOSN
            GOTO      EMPTY100 IF NOT EQUAL
          ENDIF
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,WWARD
            GOTO      EMPTY100 IF NOT EQUAL
          ENDIF
          MATCH     WBED,SP70
          IF        @EQUAL
            MOVE      WBDESC,WARDNAME
            GOTO      EMPTY100
          ENDIF
.
          COMPARE   WACTIVE,ONE                 *Check if bed is active
          GOTO      EMPTY100 IF EQUAL           *Do not display inactive bed
.
          MATCH     SP70,FILTRSEX
          IF        !@EQUAL
            MATCH     ANSE,FILTRSEX
            IF        !@EQUAL
              MATCH     FILTRSEX,PTWDSEX      * Filter by intended patient sex
              GOTO      EMPTY100 IF NOT EQUAL * if not either or sp70
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTBTYP
          IF        !@EQUAL
            MATCH     FILTBTYP,WEFRBT       * Filter by bed type
            GOTO      EMPTY100 IF NOT EQUAL
          ENDIF
.
          MOVE      ZERO,ONLVFLAG
          CALL      ONLVRW00
          IF        EXIT=1
            MOVE     ONE,ONLVFLAG
          ENDIF
.
          MOVE      SP70,PMWOADMN
          MOVE      SP70,EXDCDATE
          MOVE      SP70,EXDCTIME
          CALL      ADDJSN00
.
          ADD       ONE,DISPNUMB
          IF        NORECORD>DISPNUMB
            GOTO      EMPTY100
          ENDIF
          MOVE      ONE,ENDNOW
          GOTO      EMPTY999
.
. Check for Expected Discharges in the past 3 days
.
EMPTY500  UNPACK   CURRDATE,CCENT,CYEAR,CMON,CDAY
          PACK     LASTDATE,CCENT,CYEAR,CMON,CDAY,SP70
          MOVE     "-3",ADJDAYS
          CALL     ADJDAT00
          PACK     FRSTDATE,CCENT,CYEAR,CMON,CDAY,SP70
          PACK     KEY16,FRSTDATE,SP70
          CALL     RSPMWOR2
EMPTY600  CALL     RKPMWOR2
          BRANCH   OVRCD,EMPTY999
          MATCH    PMWOEDAT,LASTDATE
          GOTO     EMPTY999 IF LESS
.
          PACK     KEY8,PMWOADMN,SP70
          CALL     RDMISS1
          BRANCH   OVRCD,EMPTY600
          COMPARE  TWO,ASTAT
          GOTO     EMPTY600 IF NOT EQUAL
.
          MATCH    ABED,SP70
          GOTO     EMPTY600 IF EQUAL
.
          PACK     KEY6,AWARD,SP70
          CALL     RDWARD1
          BRANCH   OVRCD,EMPTY600
          MOVE     WBDESC,WARDNAME
.
          PACK     KEY6,AWARD,ABED,SP70
          CALL     RDWARD1
          BRANCH   OVRCD,EMPTY600
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP              * All hospital access
            GOTO      EMPTY610 IF EQUAL
            MATCH     WBSEHOSP,PTWDHOSN          * filter on id from pathsp
            GOTO      EMPTY600 IF NOT EQUAL
          ENDIF
.
EMPTY610  MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PTWDHOSN
            GOTO      EMPTY600 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,WWARD
            GOTO      EMPTY600 IF NOT EQUAL
          ENDIF
.
          MOVE     PMWOEDAT,EXDCDATE
          MOVE     PMWOEDTM,EXDCTIME
          CALL     ADDJSN00
.
          ADD      ONE,DISPNUMB
          IF       NORECORD>DISPNUMB
            GOTO     EMPTY600
          ENDIF
          MOVE     ONE,ENDNOW
          GOTO     EMPTY999
.
EMPTY999  WRITE    HTMLFILE;"]"
          RETURN
.
ADDJSN00  MOVE      ZERO,EXPTFLAG
          CALL      EXPTR000
          IF        EXIT=1
            MOVE     ONE,EXPTFLAG
          ENDIF
.
          MOVE      ZERO,STBYFLAG
          MATCH     ZEROVISN,WSTBY     
          IF        !@EQUAL
            MOVE      ONE,STBYFLAG
          ENDIF
.
          MOVE     SP70,TDESC
          MATCH    SP70,WEFRBT
          IF       !@EQUAL
            PACK     KEY5,ANSB,ANST,WEFRBT,SP70
            CALL     RDCODE1
            IF       OVRCD=1
              MOVE     "Invalid Bed Type",TDESC
            ENDIF
          ENDIF
.
          IF         FIRSTROW=1
            MOVE       ZERO,FIRSTROW
          ELSE
            WRITE      HTMLFILE;",";
          ENDIF
          WRITE      HTMLFILE;" {#"wardname#":#"",WARDNAME,"#",":
                                "#"wardcode#":#"",WWARD,"#",":
                                "#"bedname#":#"",WBDESC,"#",":
                                "#"bedcode#":#"",WBED,"#",":
                                "#"bedtypec#":#"",WEFRBT,"#",":
                                "#"bedtype#":#"",TDESC,"#",":
                                "#"extn#":#"",WEXTN,"#",":
                                "#"bedstatus#":#"",PTWDBDST,"#",":
                                "#"bedsex#":#"",PTWDSEX,"#",":
                                "#"standby#":#"",STBYFLAG,"#",":
                                "#"expect#":#"",EXPTFLAG,"#",":
                                "#"exptdate#":#"",EXPTDATE,EXPTTIME,"#",":
                                "#"exdiscdate#":#"",EXDCDATE,"#",":
                                "#"exdisctime#":#"",EXDCTIME,"#",":
                                "#"onleave#":#"",ONLVFLAG,"#"}";
          RETURN
.---------------------------------------------------------------------------
. Check for Patient Allocated from Bed Request via Expected Bed Board Table
.---------------------------------------------------------------------------
EXPTR000  MOVE      ZERO,EXIT
          MOVE      SP70,EXPTDATE
          MOVE      SP70,EXPTTIME
          PACK      KEY20,PTWDHOSN,WWARD,SP70
          CALL      RSPMBBD1
EXPTR010  CALL      RKPMBBD1            * Determine Room Code from Table for the Bed
          BRANCH    OVRCD,EXPTR999
          MATCH     PTWDHOSN,PMBDHOSP
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     WWARD,PMBDWARD
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     WBED,PMBDBEDD
          GOTO      EXPTR010 IF NOT EQUAL
.
          MOVE      PMBDROOM,ROOMCODE

          PACK      KEY36,PTWDHOSN,WWARD,ROOMCODE,WBED,CURRDATE,SP70
          CALL      RSPMEPB8
EXPTR100  CALL      RKPMEPB8
          BRANCH    OVRCD,EXPTR999
          MATCH     PTWDHOSN,PMEBHOSP
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     WWARD,PMEBWARD
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     ROOMCODE,PMEBROOM
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     WBED,PMEBBEDD
          GOTO      EXPTR999 IF NOT EQUAL
          MATCH     SP70,PMEBADMN
          GOTO      EXPTR100 IF EQUAL
          MOVE      PMEBEDAT,EXPTDATE
          MOVE      PMEBETIM,EXPTTIME
          MOVE      ONE,EXIT
.
EXPTR999  RETURN
.
.------------------------------------------------------------
. Table of Beds
.------------------------------------------------------------
FHRBED00  MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.         IF        NORECORD=0
.           MOVE      TEN,NORECORD               * Default number of records
.         ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDSWARD1
FHRBED10  CALL      RDKWARD1
          BRANCH    OVRCD,FHRBED99
          MATCH     SP70,WBED
          GOTO      FHRBED10 IF EQUAL
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WWARD,WARDCODE
            GOTO      FHRBED99 IF NOT EQUAL
          ENDIF
.
.         ADD       ONE,RECNUMB
.         IF        STARTNUM >= RECNUMB
.           GOTO      FHRBED10
.         ENDIF
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          IF        DISNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                 " #"resource#" : ";
          CALL      RESBED00
          WRITE     HTMLFILE;*+," }"
          ADD       ONE,DISNUMB
.
          IF       FHRLOCIN=1
.
            MATCH    SP70,WWARD
            IF       !@EQUAL & !@EOS
.
              PACK      SAVEKEY6,WWARD,WBED,SP70
.
              PACK      KEY6,WWARD,SP70
              CALL      RDWARD1
              IF        OVRCD=0
.
                CLEAR     KEY16
                APPEND    "Ward-",KEY16
                APPEND    WWARD,KEY16
                APPEND    SP70,KEY16
                RESET     KEY16
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",KEY16,"#", ":
                                      " #"resource#" : ";
.
                CALL      RESWRD00
.
                WRITE     HTMLFILE;*+," } "
.
              ENDIF
.
              MOVE      SAVEKEY6,KEY6
              CALL      RDWARD1
.
            ENDIF
.
          ENDIF
.
          GOTO      FHRBED10
.
FHRBED99  RETURN
.
RESBED00  MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "true",ACTVDESC
          ELSE
            MOVE      "false",ACTVDESC
          ENDIF
          STRIP     PTHSHOSP
          STRIP     WBTPFIL
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          STRIP     WWARD
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"bd#",":
                    "   #"display#": #"Bed#"  } ] },";
.
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "       #"reference#": #"Location/Ward-",WWARD,"#"":
                    " } } "
.
          RETURN
+
RESLOC00  STRIP     PTHSNAME
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Hospital-",KEY16
          APPEND    PTHSHOSP,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          MATCH     SP70,PTHSTELE
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",PTHSTELE,"#" }";
             MATCH    SP70,PTHSFAXN
             IF       @EQUAL
               WRITE    HTMLFILE;*+,"],";
             ELSE
               WRITE    HTMLFILE;*+,",";
             ENDIF
          ENDIF
          MATCH     SP70,PTHSFAXN
          IF        !@EQUAL
             MATCH     SP70,PTHSTELE
             IF        @EQUAL
               WRITE     HTMLFILE;*+," #"telecom#": [";
             ENDIF
             WRITE     HTMLFILE;*+,"{ #"system#": #"fax#",":
                       "  #"value#": #"",PTHSFAXN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"name#": #"",PTHSNAME,"#", ":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"si#",":
                    "   #"display#": #"Site#"  } ] }":
                    "  } ";
          RETURN
+
+
          INC       IBAWEBCD    
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       MLTSECIO/INC
          INC       MRTLOCIO/INC
          INC       PATONLIO/INC
          INC       PATMA1IO/INC    
          INC       PATMI1IO/INC    
          INC       PMSVX1IO/INC    
          INC       PATATRIO/INC    
          INC       PATTRNIO/INC    
          INC       PATVISIO/INC
          INC       PATDO1IO/INC
          INC       PATWR1IO/INC        * Ward Bed File
          INC       PMSMSWIO/INC        * Multiple Specialty Wards
          INC       PATWBHIO/INC        * Ward Bed History File
          INC       PATADWIO/INC        * Ward Audit File
          INC       PATNOBIO/INC
          INC       PATNURIO/INC
          INC       PATHSPIO/INC        * Hospital File
.
          INC       PATPR1IO/INC
          INC       PMSBDCIO/INC
          INC       PMSBRQIO/INC
          INC       PMSHCPIO/INC
          INC       PMSEPBIO/INC        * Expected Patient in Bed Board
          INC       PMSBBDIO/INC        * Expected Patient in Bed Board
          INC       PMSUHLIO/INC        * HERO location 
          INC       PMSWORIO/INC        * Expected Discharge
          INC       PATWBAIO/INC        * Ward Bed Attributes
          INC       OPRDEAIO/INC

.          
          INC       CLPATATR
          INC       PATDOCTM    
          INC       PATDOCCD
          INC       PATWRDTM
          INC       PMSBDCTM
          INC       CALCAGE    
          INC       NAMSTRCD    
          INC       WEBDATCD    
          INC       DAYOFWEK    
          INC       PMSWORTM
.------------------------------------------------------------
. Table of Beds
.------------------------------------------------------------
WBDTB000  PACK      KEY6,PTWRD001,SP70
          CALL      RDSWARD1
WBDTB100  CALL      RDKWARD1
          BRANCH    OVRCD,WBDTB999
          MATCH     PTWRD001,WWARD
          GOTO      WBDTB999 IF NOT EQUAL
          MATCH     SP70,WBED
          GOTO      WBDTB100 IF EQUAL
.
          MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateBed('",HTMLLINK
          APPEND    WWARD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    WBED,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLCLSR
          APPEND    "javascript:BedClosures('",HTMLCLSR
          APPEND    WWARD,HTMLCLSR
          APPEND    "','",HTMLCLSR
          APPEND    WBED,HTMLCLSR
          APPEND    "')",HTMLCLSR
          RESET     HTMLCLSR
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "Yes",ACTVDESC
          ELSE
            MOVE      "No",ACTVDESC
          ENDIF 
.
          MOVE      NO,DIM3A
          MATCH     "1",PTWDDFVS
          IF        @EQUAL
            MOVE      YES,DIM3A
          ENDIF
.
          MOVE      NO,DIM3B
          MATCH     "1",PTWDDFPH
          IF        @EQUAL
            MOVE      YES,DIM3B
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",ROOMDESC,"#",":
                             "#"",BEDTDESC,"#",":
                             "#"",ACTVDESC,"#",":
                             "#"",PTWDNSTA,"#",":
                             "#"",IFSTDESC,"#",":
                             "#"",HTMLCLSR,"#",":
                             "#"",PTWDSEX,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",DIM3A,"#",":
                             "#"",DIM3B,"#");"
          GOTO      WBDTB100
.
WBDTB999  RETURN
.------------------------------------------------------------
. Table of Wards : Table Sort  
.------------------------------------------------------------
WRTAB000  PACK      KEY6,SP70
          CALL      RDSWARD3
WRTAB100  CALL      RDKWARD3
          BRANCH    OVRCD,WRTAB999
          MATCH     SP70,WBED
          GOTO      WRTAB999 IF NOT EQUAL
.
          COMPARE   ONE,IBCNMHOS
          GOTO      WRTAB200 IF NOT EQUAL 
.
          MATCH     SP70,WBSEHOSP
          GOTO      WRTAB200 IF EQUAL 
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      WRTAB100 IF NOT EQUAL
. 
WRTAB200  CLEAR     HTMLLINK
          APPEND    "javascript:UpdateWard('",HTMLLINK
          APPEND    WWARD,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          COMPARE   ZERO,WINPUT
          IF        @EQUAL
            MOVE      "No",ONLYDESC
          ELSE
            COMPARE  ONE,WINPUT
            IF        @EQUAL
              MOVE      "Yes",ONLYDESC
            ELSE
              MOVE      "Yes(+)",ONLYDESC
            ENDIF
          ENDIF 
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "Yes",ACTVDESC
          ELSE
            MOVE      "No",ACTVDESC
          ENDIF 
.
          MOVE      "No",KEY3
          MATCH     "1",PTWDDOSA
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF 
.
          MOVE      SP3,DIM3A
          MATCH     "1",PTWDDFVS
          IF        @EQUAL
            MOVE      "Yes",DIM3A
          ENDIF 
.
          MOVE      SP3,DIM3B
          MATCH     "1",PTWDDFPH
          IF        @EQUAL
            MOVE      "Yes",DIM3B
          ENDIF 
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WWARD,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",ACTVDESC,"#",":
                             "#"",ONLYDESC,"#",":
                             "#"",PTWDNSTA,"#",":
                             "#"",KEY3,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",DIM3A,"#",":          * default visitors
                             "#"",DIM3B,"#");"          * default phone
          GOTO      WRTAB100
.
WRTAB999  RETURN
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>Title Given Names
.------------------------------------------------------------
PATNAM00  CLEAR     DISPNAME
...       REP       "' ",PSNAME
          REP       "#" ",PSNAME
...       REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<strong>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</strong>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
          PACK      FORMATNM,PATFNAME,SP70
          RETURN
.
.******************************************************************************
.
.         KWRD0000 - Change Active Flag
.
.------------------------------------------------------------------------------
.
KWRD0000  COMPARE   ONE,WACTIVE
          GOTO      KWRD5000 IF EQUAL        * changing to active
.
          COMPARE   ONE,PTWRD013
          GOTO      KWRD3000 IF EQUAL
.
.         Check if we are making inactive of a bed only
.
          MATCH     SP70,PTWRD002
          GOTO      KWRD1000 IF EQUAL
.
          PACK      KEY6,PTWRD001,PTWRD002,SP70
          CALL      RDWARD1
          BRANCH    OVRCD OF KWRD9000
.
          MATCH     ZEROVISN,WADMNO
          GOTO      KWRD9999 IF EQUAL
          GOTO      KWRD9100           * Bed is occupied
.
.         Make sure all beds in the ward are empty
.
KWRD1000  PACK      KEY6,PTWRD001,SP3
          CALL      RDSWARD1
KWRD2000  CALL      RDKWARD1
          BRANCH    OVRCD,KWRD3000
.
          MATCH     PTWRD001,WWARD
          GOTO      KWRD3000 IF NOT EQUAL
.
          MATCH     ZEROVISN,WADMNO
          GOTO      KWRD9100 IF NOT EQUAL    * Bed is occupied
.
          MATCH     SP3,WBED
          GOTO      KWRD2000 IF EQUAL
.
          BRANCH    WACTIVE,KWRD2000         * Bed is not active
          GOTO      KWRD9200                 * Bed is active
.
KWRD3000  IF        PTWRD013=0
            GOTO      KWRD9999
          ENDIF
.
          PACK      KEY13,PTWRD001,SP10
          CALL      RDSNOBE1
KWRD3500  CALL      RDKNOBE1
          BRANCH    OVRCD,KWRD9999
.
          MATCH     PTWRD001,NBWARD
          GOTO      KWRD9999 IF NOT EQUAL
.
          MATCH     ZEROVISN,NBADMNO
          GOTO      KWRD3500 IF EQUAL
          GOTO      KWRD9100
.
KWRD5000  * Change to be active
.
          BRANCH    PTWRD013,KWRD9999
.
.         If this ward/bed only, check if the ward is active
.
          MATCH     SP70,PTWRD002
          GOTO      KWRD9999 IF EQUAL
.
          PACK      KEY6,PTWRD001,SP3
          CALL      RDWARD1
          COMPARE   ZERO,WACTIVE
          GOTO      KWRD9300 IF NOT EQUAL    * Ward is not active
          GOTO      KWRD9999
.
KWRD9000  MOVE      "Invalid Ward/Bed Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      KWRD9999
.
KWRD9100  MOVE      "All Patients Must be Removed from Ward/bed ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Before made Inactive. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      KWRD9999
.
KWRD9200  MOVE      "All Beds must be Inactive Before Making a ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Ward Inactive",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      KWRD9999
.
KWRD9300  MOVE      "Ward must be Active before Making a Bed Active. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      KWRD9999
.
KWRD9999  RETURN
.
.------------------------------------------------------------
. If ward type changing check beds/nobeds are inactive/empty
.------------------------------------------------------------
CKWT0000  COMPARE   TWO,PTWRD013             * Changing to ward/bed plus
          GOTO      CKWT9999 IF EQUAL        * ward only no validation required
.
          COMPARE   ZERO,PTWRD013            * Changing to ward/bed
          GOTO      CKWT2000 IF EQUAL
.
          COMPARE   ONE,PTWRD013             * Changing to ward only
          GOTO      CKWT4000 IF EQUAL
.
          GOTO      CKWT9999
.
CKWT2000  PACK      KEY13,PTWRD001,SP10
          CALL      RDSNOBE1
CKWT2100  CALL      RDKNOBE1                 * Check no bed file for
          BRANCH    OVRCD,CKWT8000           * current admissions
.
          MATCH     PTWRD001,NBWARD
          GOTO      CKWT8000 IF NOT EQUAL
.
          MATCH     ZEROVISN,NBADMNO
          GOTO      CKWT2100 IF EQUAL
          GOTO      CKWT9100
.
CKWT4000  PACK      KEY6,PTWRD001,SP3
          CALL      RDSWARD1
CKWT4100  CALL      RDKWARD1                * Make sure beds are inactive
          BRANCH    OVRCD,CKWT8000          * and empty
.
          MATCH     PTWRD001,WWARD
          GOTO      CKWT8000 IF NOT EQUAL
.
          MATCH     ZEROVISN,WADMNO
          GOTO      CKWT9200 IF NOT EQUAL    * Bed is occupied
.
          MATCH     SP3,WBED
          GOTO      CKWT4100 IF EQUAL
.
          BRANCH    WACTIVE,CKWT4100         * Bed is not active
          GOTO      CKWT9200                 * Bed is active
.
CKWT8000  PACK      KEY6,PTWRD001,PTWRD002,SP70   * Restore correct ward/bed
          CALL      RDWARD1
          BRANCH    OVRCD,CKWT9000
.
          MOVE      ZERO,EXIT
          GOTO      CKWT9999
.
CKWT9000  MOVE      "Invalid Ward/Bed Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKWT9999
.
CKWT9100  MOVE      "All Patients Must be Removed from Ward ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Before Changing Ward Type. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKWT9999
.
CKWT9200  MOVE      "All Beds must be Inactive Before ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Changing Ward Type",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKWT9999
.
CKWT9999  RETURN
.
.------------------------------------------------------------
. Update the hospital code in all beds
.------------------------------------------------------------
UPDB0000  PACK      KEY6,PTWRD001,SP70
          CALL      RDSWARD1
UPDB1000  CALL      RDKWARD1
          BRANCH    OVRCD,UPDB9999
.
          MATCH     PTWRD001,WWARD          * Same ward
          GOTO      UPDB9999 IF NOT EQUAL
.
          MATCH     PTWRD018,PTWDHOSN       * Is the hospital code different
          GOTO      UPDB2000 IF NOT EQUAL
.
          MATCH     PTWRD039,PTWDDFVS       * Default Visitors
          GOTO      UPDB2000 IF NOT EQUAL
.
          MATCH     PTWRD040,PTWDDFPH       * Default Phone
          GOTO      UPDB2000 IF NOT EQUAL
          GOTO      UPDB1000
.
UPDB2000  MOVE      PTWRD018,PTWDHOSN       * Update hospital code from ward
.                                           * master cgi
          MOVE      PTWRD039,PTWDDFVS       * Default Visitors
          MOVE      PTWRD040,PTWDDFPH       * Default Phone
.
          CALL      UPWARD1
.
          GOTO      UPDB1000
.
UPDB9999  RETURN
+
.------------------------------------------------------------
. Ward Status Table Listing - Future
.------------------------------------------------------------
WSFT0000  MOVE      ZERO,TOTALBOK
          MOVE      ZERO,TOTALPRE
          MOVE      ZERO,TOTALBED
          MOVE      ZERO,TOTALPAT
          MOVE      ZERO,TOTALEXP
          MOVE      ZERO,TOTALOPN
          PACK      KEY6,SP70
          CALL      RDSWARD3
WSFT0100  CALL      RDKWARD3
          BRANCH    OVRCD,WSFT9999
          MATCH     SP70,WBED
          GOTO      WSFT9999 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO              *List only active wards
          GOTO      WSFT0100 IF NOT EQUAL
.
          COMPARE   ONE,IBCNMHOS
          GOTO      WSFT0200 IF NOT EQUAL
.
          MATCH     SP70,WBSEHOSP
          GOTO      WSFT0200 IF EQUAL
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      WSFT0100 IF NOT EQUAL
.
WSFT0200  CALL      CALFP000                  * Calculate Number of Patients
          CALL      CALCUR00                  * Calculate Current Patients
.
          WRITE    HTMLFILE;"t.addRow(",QUOTE,WBDESC,QUOTE,COMMA:
                                         QUOTE,BOOKINGS,QUOTE,COMMA:
                                         QUOTE,PREADMIS,QUOTE,COMMA:
                                         QUOTE,WOCCBED,QUOTE,COMMA:
                                         QUOTE,EXPECTS,QUOTE,COMMA:
                                         QUOTE,PATCOUNT,QUOTE,COMMA:
                                         QUOTE,EXPDSCNT,QUOTE,");"
.
          GOTO      WSFT0100
.
WSFT9999  RETURN
.------------------------------------------------------------
. Calculate Number of Expected Patients in a Ward
.------------------------------------------------------------
CALFP000  MOVE      WWARD,SAVEWARD
          MOVE      WINPUT,NOBEDWRD
.
. Calculate Bookings for Ward for date range
.
          MOVE      ZERO,EXPECTS
          MOVE      ZERO,PREADMIS
          MOVE      ZERO,BOOKINGS
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
CALFP500  CALL      RKBKREC4
          BRANCH    OVRCD,CALFP600
          MATCH     BKREEDAT,LASTDATE
          GOTO      CALFP600 IF LESS
.
          PACK      KEY8,DBKREBOO
          CALL      RDBKRX11
          BRANCH    OVRCD,CALFP500
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      CALFP505 IF EQUAL            * then check expected ward
.
          MATCH     SAVEWARD,BKRXPOWD
          GOTO      CALFP500 IF NOT EQUAL
          GOTO      CALFP510
.
CALFP505  MATCH     SAVEWARD,BKREWARD            * Check Expected ward
          GOTO      CALFP500 IF NOT EQUAL
.
CALFP510  IF        BKRESTAT=0
            ADD       ONE,BOOKINGS
          ENDIF
          GOTO      CALFP500
.
. Calculate Preadmissions for Ward for Today
.
CALFP600  PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
CALFP700  CALL      RDKMISS3
          BRANCH    OVRCD,CALFP900
          MATCH     ADATE,LASTDATE
          GOTO      CALFP900 IF LESS
.
          COMPARE   ONE,ASTAT
          GOTO      CALFP700 IF NOT EQUAL
          MATCH     SAVEWARD,PTMIXWRD
          GOTO      CALFP700 IF NOT EQUAL
          ADD       ONE,PREADMIS
          GOTO      CALFP700
.
CALFP900  ADD       BOOKINGS,EXPECTS
          ADD       PREADMIS,EXPECTS
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
.
CALFP999  RETURN
+
.------------------------------------------------------------
. Calculate Number of Current Patient and expected discharges
.------------------------------------------------------------
CALCUR00  MOVE      ZERO,PATCOUNT
          MOVE      ZERO,EXPDSCNT
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
CALCUR10  CALL      RDKMISS2
          BRANCH    OVRCD,CALCUR99
.
          COMPARE   TWO,ASTAT
          GOTO      CALCUR99 IF NOT EQUAL
.
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CALCUR10
.
          MATCH     DTADMN,DAADMNO
          GOTO      CALCUR10 IF NOT EQUAL
.
          MATCH     TWARD,SAVEWARD
          GOTO      CALCUR10 IF NOT EQUAL
.
          MOVE      SP70,EXPCTDSC
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          PACK      EXPCTDSC,CCENT,CYEAR,CMON,CDAY,SP70
.
          MATCH     FRSTDATE,EXPCTDSC
          GOTO      CALCUR10 IF LESS
.
          MATCH     EXPCTDSC,LASTDATE
          IF        @LESS
            ADD        ONE,PATCOUNT
          ELSE
            ADD        ONE,EXPDSCNT
          ENDIF
          GOTO      CALCUR10
.
CALCUR99  RETURN
+
.------------------------------------------------------------
. Print the table sort column details for the enterprise   
. occupancy view. Speciality columns start from col 8
. for a max of 50 columns
.------------------------------------------------------------
EHED0000  MOVE      SEVEN,COLNUMBR
          MOVE      ZERO,SPECCNTR
.
          PACK      KEY5,ANSA,ANSC,SP70
          CALL      RDSCODE1
EHED1000  CALL      RDKCODE1
          BRANCH    OVRCD,EHED9999
          MATCH     "AC",TCODE
          GOTO      EHED9999 IF NOT EQUAL
.
          MATCH     "M",TCINDC4
          GOTO      EHED1000 IF NOT EQUAL
.
          ADD       ONE,COLNUMBR
          ADD       ONE,SPECCNTR
          MOVE      ACODE,SPECCODE[SPECCNTR]
. 
          WRITE     HTMLFILE;"t.addColumn(#"",ACODE,"#",#"String#",":
                             COLNUMBR,",",COLNUMBR:
                             ",#"left#",#"#",#"#",30);"
.
          COMPARE   FIFTY,COLNUMBR
          GOTO      EHED1000 IF NOT EQUAL
.
EHED9999  RETURN
+
.------------------------------------------------------------
. Print the details for the enterprise occupancy view
.------------------------------------------------------------
EROW0000  MOVE      ZERO,GTOTLBED           * Grand Total Bed for Hospital 
          MOVE      ZERO,GTOTLEMP           * Grand Total Empty for Hospital
          MOVE      ZERO,GTOTLPER           * Grand Total Percent for Hospital
          MOVE      ZERO,GTOTLOPN           * Grand Total Open for Hospital
          MOVE      ZERO,GTOTLPAT           * Grand Total Patients for Hospital
          MOVE      ZERO,GTOTLEXP           * Grand Total Expected for Hospital
.
          MOVE      ONE,F2
          WHILE     F2 <= 50
            MOVE      ZERO,GTOTLSPE[F2]       * Speciality Grand Totals
            ADD       ONE,F2
          DO
.
          MOVE      ZERO,ALLHOSAC
          PACK      KEY13,USERID,SP70            * All hospital access
          CALL      RDMLSEC1
          MOVE      OVRCD,ALLHOSAC
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
EROW1000  CALL      RKPTHSP1
          BRANCH    OVRCD,EROW9000
.
          IF        ALLHOSAC=1
            PACK      KEY13,USERID,PTHSHOSP,SP70 * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,EROW1000
          ENDIF
.
          CLEAR     WARDLINK
          APPEND    "patweb12.pbl?",WARDLINK
          APPEND    "&reportno=3",WARDLINK
          APPEND    "&template=001",WARDLINK
          RESET     WARDLINK
.
          CALL      HWRD0000                     * Calculate ward statistics
.         
          UNPACK    FILWIDTH,KEY6,KEY3
          WRITE     HTMLFILE;"t.addRow(",QUOTE,WARDLINK,QUOTE,COMMA:
                                         QUOTE,PTHSNAME,QUOTE,COMMA:
                                         QUOTE,TOTLBEDS,QUOTE,COMMA:
                                         QUOTE,TOTLEMPT,QUOTE,COMMA:
                                         QUOTE,TOTLPERC,QUOTE,COMMA:
                                         QUOTE,TOTLOPEN,QUOTE,COMMA:
                                         QUOTE,TOTLPATS,QUOTE,COMMA:
                                         QUOTE,TOTLEXPE,QUOTE,COMMA;
.
          MOVE      ONE,F2
          WHILE     F2 <= 50
            WRITE     HTMLFILE;QUOTE,TOTLSPEC[F2],QUOTE,COMMA;
            ADD       ONE,F2
          DO
.
          WRITE     HTMLFILE;QUOTE,"#");"
.
          GOTO      EROW1000
.
EROW9000  MOVE      SP70,WARDLINK
          MOVE      "Total",PTHSNAME
          WRITE     HTMLFILE;"t.addTotal(",QUOTE,WARDLINK,QUOTE,COMMA:
                                         QUOTE,PTHSNAME,QUOTE,COMMA:
                                         QUOTE,GTOTLBED,QUOTE,COMMA:
                                         QUOTE,GTOTLEMP,QUOTE,COMMA:
                                         QUOTE,GTOTLPER,QUOTE,COMMA:
                                         QUOTE,GTOTLOPN,QUOTE,COMMA:
                                         QUOTE,GTOTLPAT,QUOTE,COMMA:
                                         QUOTE,GTOTLEXP,QUOTE,COMMA;
.
          MOVE      ONE,F2
          WHILE     F2 <= 50
            WRITE     HTMLFILE;QUOTE,GTOTLSPE[F2],QUOTE,COMMA;
            ADD       ONE,F2
          DO
.
          WRITE     HTMLFILE;QUOTE,"#");"
.
EROW9999  RETURN
+
.------------------------------------------------------------
. Calculate the ward statistics for a given hospital 
.------------------------------------------------------------
HWRD0000  MOVE      ZERO,TOTLBEDS           * Total Bed for Hospital        
          MOVE      ZERO,TOTLEMPT           * Total Empty for Hospital        
          MOVE      ZERO,TOTLPERC           * Total Occ % for Hospital        
          MOVE      ZERO,TOTLOPEN           * Total Open for Hospital        
          MOVE      ZERO,TOTLPATS           * Total Patients for Hospital
          MOVE      ZERO,TOTLEXPE           * Total Expected for Hospital
.
          MOVE      ONE,F2
          WHILE     F2 <= 50
            MOVE      ZERO,TOTLSPEC[F2]       * Speciality Totals
            ADD       ONE,F2
          DO
.
          MOVE      ONE,F2
          WHILE     F2 <= SPECCNTR
            PACK      KEY5,ANSA,ANSC,SPECCODE[F2],SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ZERO,TCFORM6
            ENDIF
            MOVE      TCFORM6,TOTLSPEC[F2]
            ADD       ONE,F2
          DO
.
          PACK      KEY6,SP70
          CALL      RDSWARD3
HWRD1000  CALL      RDKWARD3
          BRANCH    OVRCD,HWRD9000
.
          MATCH     SP70,WBED
          GOTO      HWRD9000 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO              *List only active wards
          GOTO      HWRD1000 IF NOT EQUAL
.
          MATCH     PTHSHOSP,PTWDHOSN
          GOTO      HWRD1000 IF NOT EQUAL
.
          ADD       WOCCBED,TOTLBEDS
.
          CALL      CALCO000                  * Calculate no of beds
          ADD       OPENBEDS,TOTLOPEN
.
          CALL      CALSP000                  * Calculate Number of Patients
          ASSIGN    OPENBEDS-PATCOUNT,F8
          ADD       F8,TOTLEMPT
          ADD       PATCOUNT,TOTLPATS
.
          ASSIGN    TOTLPATS/TOTLOPEN*100.0,TOTLPERC
.
          IF        TOTLOPEN=0
            MOVE      ZERO,TOTLPERC
          ENDIF
.
          GOTO      HWRD1000
.
HWRD9000  ADD       TOTLBEDS,GTOTLBED       
          ADD       TOTLOPEN,GTOTLOPN
          ADD       TOTLEMPT,GTOTLEMP
          ADD       TOTLPATS,GTOTLPAT
.
          CALL      CALPA000                  * Calculate Preadmissions
          ADD       PREADMIS,TOTLEXPE
          CALL      CALBK000                  * Calculate Bookings
          ADD       BOOKINGS,TOTLEXPE
.
          ADD       TOTLEXPE,GTOTLEXP
.
          ASSIGN    GTOTLPAT/GTOTLOPN*100.0,GTOTLPER
.
          MOVE      ONE,F2
          WHILE     F2 <= 50
            ADD       TOTLSPEC[F2],GTOTLSPE[F2]
            ADD       ONE,F2
          DO
.
HWRD9999  RETURN
.
.------------------------------------------------------------
. Calculate Number of Patients in a Ward and speciality
.------------------------------------------------------------
CALSP000  MOVE      WWARD,SAVEWARD
          MOVE      ZERO,SBYCOUNT
          MOVE      ZERO,PATCOUNT
          MOVE      WINPUT,NOBEDWRD
          BRANCH    NOBEDWRD,CALSP200
.
.         Bed ward (0) or Mixed Ward (2)
.
          PACK      KEY6,SAVEWARD,SP70
          CALL      RDWARD1
CALSP100  CALL      RDKWARD1
          BRANCH    OVRCD,CALSP200
          MATCH     SAVEWARD,WWARD         * same ward?
          GOTO      CALSP200 IF NOT EQUAL  * check if mixed ward b4 go to P400
          BRANCH    WACTIVE,CALSP100       * only use active beds  v9.02.09
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
            IF        SPECCNTR>0
              PACK      KEY8,WADMNO,SP70
              CALL      RDMISS1
              IF        OVRCD<>1
                MOVE      ACLSSFT,SPECIALT
                CALL      SPEC0000                * Update speciality totals
              ENDIF
            ENDIF
          ENDIF
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,PATCOUNT
            ADD       ONE,SBYCOUNT
            IF        SPECCNTR>0
              PACK      KEY8,WSTBY,SP70
              CALL      RDMISS1
              IF        OVRCD<>1
                MOVE      ACLSSFT,SPECIALT
                CALL      SPEC0000                * Update speciality totals
              ENDIF
            ENDIF
          ENDIF
          GOTO      CALSP100
.
.
. Check No Bed Ward File
.
CALSP200  PACK      KEY13,SAVEWARD,SP20
          CALL      RDSNOBE1
CALSP300  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CALSP999
          MATCH     SAVEWARD,NBWARD         * same ward?
          GOTO      CALSP999 IF NOT EQUAL
          ADD       ONE,PATCOUNT
.
          IF        SPECCNTR>0
            PACK      KEY8,NBADMNO,SP70
            CALL      RDMISS1
            IF        OVRCD<>1
              MOVE      ACLSSFT,SPECIALT
              CALL      SPEC0000                * Update speciality totals
            ENDIF
          ENDIF
.
          GOTO      CALSP300
.
CALSP999  RETURN
.------------------------------------------------------------
. Calculate Preadmissions for Hospital for Today
.------------------------------------------------------------
CALPA000  MOVE      ZERO,PREADMIS
          PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
CALPA100  CALL      RDKMISS3
          BRANCH    OVRCD,CALPA999
          MATCH     ADATE,CURRDATE
          GOTO      CALPA999 IF NOT EQUAL
          COMPARE   ONE,ASTAT
          GOTO      CALPA100 IF NOT EQUAL
.
          PACK      KEY6,PTMIXWRD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CALPA100
          MATCH     PTHSHOSP,PTWDHOSN
          GOTO      CALPA100 IF NOT EQUAL
.
          ADD       ONE,PREADMIS
          MOVE      ACLSSFT,SPECIALT
          CALL      SPEC0000                * Update speciality totals
.
          GOTO      CALPA100
.
CALPA999  RETURN
.------------------------------------------------------------
. Calculate Bookings for Hospital for Today
.------------------------------------------------------------
CALBK000  MOVE      ZERO,BOOKINGS
          PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
CALBK100  CALL      RKBKREC4
          BRANCH    OVRCD,CALBK999
          MATCH     BKREEDAT,CURRDATE
          GOTO      CALBK999 IF NOT EQUAL
          COMPARE   ZERO,BKRESTAT
          GOTO      CALBK100 IF NOT EQUAL
.
          PACK      KEY8,DBKREBOO
          CALL      RDBKRX11
          BRANCH    OVRCD,CALBK100
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      CALBK200 IF EQUAL            * then check expected ward
.
          PACK      KEY6,BKRXPOWD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CALBK100
          MATCH     PTHSHOSP,PTWDHOSN
          GOTO      CALBK100 IF NOT EQUAL
          GOTO      CALBK300
.
CALBK200  MATCH     SAVEWARD,BKREWARD            * Check Expected ward
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CALBK100
          MATCH     PTHSHOSP,PTWDHOSN
          GOTO      CALBK100 IF NOT EQUAL
.
CALBK300  ADD       ONE,BOOKINGS
          MOVE      BKREDEPT,SPECIALT
          CALL      SPEC0000                   * Update speciality totals
          GOTO      CALBK100
.
CALBK999  RETURN
.------------------------------------------------------------
. Update speciality totals
.------------------------------------------------------------
SPEC0000  MATCH     SP70,SPECIALT
          GOTO      SPEC9999 IF EQUAL
.
          MOVE      ONE,F2
          WHILE     F2 <= SPECCNTR
            MATCH     SPECIALT,SPECCODE[F2]
            IF        @EQUAL
              SUB       ONE,TOTLSPEC[F2]
              GOTO      SPEC9999
            ENDIF
            ADD       ONE,F2
          DO
.
SPEC9999  RETURN
.
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
REMOTE05  BRANCH    REMOTENO,REMOTE10
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE95
.
REMOTE10  CALL      VHER0000      * Check if HERO id alrady in use 
          GOTO      REMOTE95
.
REMOTE95  CALL      XMLEND00
.
REMOTE99  RETURN
.
.******************************************************************************
. Remote script to check if HERO id already in use
.******************************************************************************
VHER0000  PACK      KEY27,HEROLOCI,HEROTYPE,SP70      * Validate hero id
          CALL      RSPMUHL2
VHER1000  CALL      RKPMUHL2
          BRANCH    OVRCD,VHER8000
.
          MATCH     HEROLOCI,PMULUHID       * Same HERO ID
          GOTO      VHER8000 IF NOT EQUAL
.
          MATCH     HEROTYPE,PMULTYPE       * Same HERO type
          GOTO      VHER8000 IF NOT EQUAL
.
          MATCH     HEROWARD,PMULWDCD
          IF        @EQUAL
            MATCH     HEROBEDD,PMULBDCD     * Skip current record
            GOTO      VHER1000 IF EQUAL
          ENDIF
.
          MATCH     "1",PMULTYPE            * Ward warning
          GOTO      VHER9000 IF EQUAL
.
          MATCH     "2",PMULTYPE            * ED location warning
          GOTO      VHER9100 IF EQUAL
.
VHER8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      VHER9999
.
VHER9000  STRIP     HEROLOCI
          WRITE     HTMLFILE;*+,"<RETURN_VALUE TYPE=WARNING>":
                    "HERO location ID ",HEROLOCI," already in use in ";
          MATCH     SP70,PMULBDCD
          IF        @EQUAL
            WRITE     HTMLFILE;"Ward ",PMULWDCD
          ELSE
            WRITE     HTMLFILE;"Ward/Bed ",PMULWDCD,"/",PMULBDCD
          ENDIF
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VHER99999
.
VHER9100  STRIP     HEROLOCI
          WRITE     HTMLFILE;*+,"<RETURN_VALUE TYPE=WARNING>":
                    "HERO location ID ",HEROLOCI," already in use in ":
                    "ED Site/Location ",PMULBDCD,"/",PMULWDCD:
                    "</RETURN_VALUE>"
          GOTO      VHER99999
.
VHER9999  RETURN
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
