.***************************************************************************
.* System    :   Inpatients                                                *
.* Program   :   FIXPTIPE                                                  *
.* Desc      :   Program to fix up Invoice pending (patipenf)              *
.***************************************************************************
.* Date      :   30/01/2014                                                *
.* Author    :   J.Tan       CAR 265430                                    *
.* Function  :   This program will add record to patipenf file if still    *
.*               to be invoiced                                            *
.* Modification:                                                           *
.*                                                                         *
.*-------------------------------------------------------------------------*
.*    V11.05.01 24/02/2025  J.Tan            TSK 0946490                   *
.*              Recompiled for PATCATBI - Changes for MV CWO Payment Model *
.*    V11.04.03 14/03/2024  J.Tan          TSK 0910994                     *
.*              Recompiled for CMXMATRX                                    *
.*    V11.04.02 29/01/2024  Jacob Jackson  TSK 0919335                     *
.*              Add HF History includes                                    *
.*    V11.04.02 29/01/2024  Jacob Jackson  TSK 0919335                     *
.*              Add HF History includes                                    *
.*    V11.04.01 29/01/2024  Jacob Jackson  TSK 0919335                     *
.*              Add new local variable and recompile for GETTFEES          *
.*    V11.03.02 11/07/2023  J.Tan           TSK 0933893                    *
.*              Added option for Range of discharged date                  * 
.*    V11.03.01 05/04/2023  Bella Turco     TSK 0911166                    *
.*              Recompiled for PATIPERH - Hold Invoice Audit               * 
.*    V11.02.01 03/03/2022  J.Tan           TSK 0902652                    *
.*              Recompiled for OUTCATBI/AAECATBI - New Patient Invoice     * 
.*    V11.01.02 10/11/2021 J.Tan           TSK 0880410                     *
.*               Mod for System Health fund on hold invoice                *
.*    V11.01.01  13/04/2021  J.Tan           TSK 0863287                   *
.*               Recompiled for PATCATBI -Patient Invoice new functionality*
.*    V11.00.01  19/03/2020  J.Tan          TSK 0838262                    *
.*               Added PATITMRD                                            *
.*    V10.15.01  11/10/2019  Peter Vela       TSK 0882906                  *
.*               Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF        *
.*    V10.13.03  11/01/2019  Peter Vela     TSK 0867807                    *
.*               Recompiled for OUTCATBI                                   *
.*    V10.13.02  26/10/2018  Thanh T        TSK 0859743                    *
.*               Added BULKBILL for OUTCATBI changes                       *
.*    V10.13.01  25/10/2018  Thanh T        TSK 0859743                    *
.*               Added bulk billing functionality as OUTCATBI changes      *
.*-------------------------------------------------------------------------*
.*    V10.12.01 18/07/2018  J.Tan          TSK 0859911                     *
.*               Recompiled for PATCATBI - Fixed No Payday Add on charge   *
.*    V10.11.02  24/11/2017  J.Tan         TSK 0818097                     *
.*               Added Excluded newborn functionality - EXNB0000           *
.*    V10.11.01  07/09/2017  J.Tan         TSK 0837479                     *
.*               Recompiled for CMXMATRX - Consumption type items          *
.*    V10.10.01  23/03/2016  J.Tan          TSK 0310703                    *
.*               Mod Public hospital to check Claim code indicator 12      *
.*    V10.08.01  26/08/2016  Don Nguyen     TSK 0312570                    *
.*               Recompiled for CMXMATRX - Added check for PTCNDGED=1      *
.*               Added PMSEDGFD/IO and GETEFDRG                            *
.*    V10.07.02  18/11/2015  J.Tan          CAR 303942                     *
.*               Added new payment types                                   *
.*    V10.07.01  08/10/2015  J.Tan          CAR 322466                     *
.*               Added Keyin Discharge from date                           * 
.*               V10.06.04 14/07/2015  Peter Vela     CAR 318700           *
.*               Recompiled for PRBILCMN - Validate for deleted VISMDT     * 
.*               record                                                    *
.*               V10.06.03 22/06/2015 J.Tan        CAR 310703              *
.*               Mods to display Adm.number on screen                      *
.*               V10.06.02 18/05/2015 J.Tan        CAR 310703              *
.*               Added Start and End date/time processing                  *
.*               V10.06.01 06/05/2015 J.Tan          CAR 310703            *
.*               Removed checking disc.patient with zero invoice for Public*
.*               V10.05.02 19/02/2015 J.Tan          CAR 311352            *
.*               Fixed to check XOPTION before deleting invoice pending    *
.*               V10.05.01 20/01/2015 J.Tan          CAR 310703            *
.*               Mods to delete invoice pending for zero amt of next inv.  *
.*               V10.04.03 11/06/2014 Sandra Barcham CAR 301639            *
.*               Moved call to TFILENAM to INIT0000                        *
.*               V10.04.02 08/04/2013 J.Tan          CAR 261630            *
.*               Removed port number from temp file name                   *
.*               V10.04.01 31/01/2014 J.Tan        CAR 265430              *
.*               Removed checking bed days                                 *
.***************************************************************************
.
. FILE DESCRIPTION INCLUDES
. -------------------------
.
          INC       STD001FD
          INC       PATCOMM/INC
          INC       PABXVARS/INC
          INC       IBASEQFD/INC                 * Sequential Numbers File
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
.
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDTRFD/INC
          INC       IBASECFD/INC
          INC       IBAPASFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
          INC       IBACONFD/INC
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
          INC       NHIMASFD/INC
.
          INC       MLTCFNFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPCMTFD/INC
          INC       NZPEXTFD/INC
          INC       NZPRDTFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIBRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPPFEFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       NZPTFEFD/INC
          INC       NZPRVBFD/INC
          INC       NZPIVBFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
.
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       PATELGFD/INC
          INC       PATBFEFD/INC
          INC       PATCALAG/INC
          INC       PATCFAFD/INC
          INC       PATCODFD/INC
          INC       PMSCIDFD/INC
          INC       PMSCCDFD/INC
          INC       PATCONFD/INC
          INC       PATCTFFD/INC
          INC       PATDHEAD/INC
          INC       PATDINVS/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATONHFD/INC
          INC       PATECOFD/INC
          INC       PATFINFD/INC
          INC       PATFMOFD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATFN1FD/INC
          INC       PATFN2FD/INC
          INC       PATGTUFD/INC
          INC       PATHSPFD/INC
          INC       PATHTRFD/INC
          INC       EMRHTRFD/INC
          INC       OUTHTRFD/INC
          INC       PATIBLFD/INC
          INC       PATICUFD/INC
          INC       PATIN1FD/INC
          INC       PATINMFD/INC
          INC       PATINVFD/INC
          INC       PATIOVFD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATOVBFD/INC
          INC       PATPGRFD/INC
          INC       PATRE1FD/INC
          INC       PATRBLFD/INC
          INC       PATRATFD/INC
          INC       PATRCAUD/INC
          INC       PATRFNFD/INC
          INC       PATSELDT/INC
          INC       PATSRBFD/INC
          INC       PATTFEFD/INC
          INC       PATTRNFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSEVTFD/INC
          INC       PMSCNOFD/INC
          INC       PMSHATFD/INC
          INC       PMSHCPFD/INC
          INC       PMSSINFD/INC
          INC       PATCMTFD/INC
          INC       PMSCMTFD/INC
          INC       PMSSGAFD/INC
          INC       PMSMTIFD/INC
          INC       PMSMPRFD/INC
          INC       PMSVX1FD/INC
          INC       PRIITMFD/INC
.
          INC       PATCMXFD/INC
          INC       PATAFEFD/INC
          INC       PATASDFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
.
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       COMDEPFD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBDTFD/INC
          INC       RCPCONFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIDEFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATDDHFD/INC
.

. LOCAL VARIABLE DEFINITION
. -------------------------
COUNTER   FORM      8
.
ADAY      DIM       2
AMON      DIM       2
AYER      DIM       2
ACEN      DIM       2
ACCDTE    DIM       8     * accommodation date used in AAECATBI
AECNFTYP  FORM      1
AECNCHRS  FORM      1
.
CDYSDAYS  FORM      6                       * CALCDAYS number of days
CDYSFDTE  DIM       8                       * CALCDAYS from date
CDYSTDTE  DIM       8                       * CALCDAYS to date
CDYSYEAR  FORM      2                       * CALCDAYS year
BULKBILL  DIM       1
CODE      DIM       2
CODEPY    INIT      "Py"
CURRDATE  DIM       8
CMDLINE   DIM       80
CMDLIN1   DIM       70
CMDLIN2   DIM       16
CURSESS   DIM       18
CUTDAY    DIM       2
CUTMON    DIM       2
CUTYER    DIM       2
CUTCEN    DIM       2
CALDAYS   FORM      3
CATCR     INIT      "cr"
CODECL    INIT      "CL"
CODEDP    INIT      "DP"
CERTINDC  FORM      1
.
KEYNDATE  DIM       8
KEYTDATE  DIM       8
DB        INIT      "DB"
DDDAY     DIM       2
DDMON     DIM       2
DDYER     DIM       2
DDCEN     DIM       2
DIM1A     DIM       1
*DIM3      DIM       3
DIM4      DIM       4
DIM5A     DIM     5
DIM9      DIM       9
DIM11     DIM       11
DIM13     DIM       13
DIM14     DIM     14
DIM18     DIM       18
DIM18A    DIM       18
DIM24A    DIM       24
DIM30     DIM       30
DIRECT    INIT    "DIRECT DEBIT"
DOCTCODE  DIM       6
DOCFNAME  DIM       50
.
EMCNGINV  DIM       1
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
EFTDATE   DIM       8         * Effective date (ccyymmdd)
.
FORM3A    FORM      3
FIVE9     FORM      "59"
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FMTSNAME  DIM       35
.
HOSPCODE  DIM       3
HOLDFLAG  FORM      1        * Accounts on Hold option
HOLDTEXT  INIT      "HOLD-"
HOSPID    DIM       3
HOSPNAME  DIM       50
HINVDES   DIM       30
HESYST    FORM      1
HFHIFUND  FORM      2
.
JYEAR     FORM      2
.
KEY13A    DIM       13
KEYFLAG   FORM      1
.
MBSFLAG   FORM      1
MONEY1    INIT    "MONEY ORDER"
.
PASS      FORM      1
.
OPCNCONS  DIM       1
OPOCFLAG  FORM      1
OPNFLAG   FORM      "0"      * Used in stepdown
OPRDATE   DIM       8
OTCNCFEE  FORM      1
OTCNFTYP  FORM      1
.
RECNUMB   FORM      8
RECWRIT   FORM      8
RECDELE   FORM      8
SERVDOCT  DIM       10
SAVAMNT   FORM      12.2
SAVALLW   FORM      12.2
SAVBEND   FORM      3
SAVDISC   FORM      12.2
SAVEXTRA  FORM      12.2
SP12      INIT      "            "
SP14      INIT      "              "
SUROPT    FORM      1
.
TEMPFILE  DIM       8
TFEEIND   FORM      1
THCFLG    FORM      2
THREED    INIT      "3"
TTBILL    FORM      12.2
TTDAYS    FORM      8
TTNETT    FORM      12.2
UNKGST    FORM      1
WDATE1    DIM       8
WDATE2    DIM       8
WSTAT     FORM      1
WBSEUID   DIM       10
ZERO4     INIT      "0000"
ZEROINVC  DIM       1
.
DISCONLY  FORM      1     * discharged only 1=no 0=yes
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.         Web Variables (only the include files use these variables)
.
DAYFORMT  DIM       4
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
HTMLFILE  FIFO      ASCII, FIXED=250
MTHNAM3   DIM       3
MTHNAM3A  DIM       3
.
PRGID     INIT      "FIXPTIPE"
PRGNAM    INIT      "Fix Invoice Pending file"
VERSION   INIT      "V12.00.00"
+
.**************************************************************************
.*                              ML0000                                    *
.*                      Controlling Logic (Mainline code)                 *
.**************************************************************************
.
ML0000    CALL      INIT0000               * initialisation and open files
.
ML0100    CALL      OPTN0000               * select options
          BRANCH    EXIT,ML9999            * EXIT = 1 if 0 chosen in menu
.
ML1000    CALL      KHOS0000               * Keyin hospital id
          BRANCH    EXIT,ML0100
.
          CALL      KDATE000               * Keyin discharge fromdate
.
          IF        XOPTION=3 | XOPTION=4
            CALL      KTDAT000             * Keyin discharge todate
          ENDIF
.
          CALL      CONTQST                * Ok to continue ?
          BRANCH    CEXIT,ML2000:          * yes
                          ML0100:          * no
                          ML0100           * cancel
.
ML2000    CALL      PROC0000               * process
.
ML9999    CHAIN     PGM                    * chain back to program
+
.****************************************************************************
.*                                INIT0000             Called by: ML0000    *
.*                             initialisation                               *
.*  The initialisation routine is used to display headings and open files.  *
.****************************************************************************
.
INIT0000  CALL      DISPHEAD                  * display heading
.
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
          READ      CONTROLF,TEN;*104,PTCNMBSF:                        *C-47385
                                 *217,CAUDQ    * added for V5.01.14 - SRF 105195
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,TEN5;*247,CSTDOWN
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*164,PTRESDAY,*193,PTCNDCLM:
                                    *199,PTCNBCUT,*211,PTCNCNDY
          READ      CONTROLF,TWENTY1;*120,PTCNADDC
          READ      CONTROLF,THIRTY;*200,AECNFTYP
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,OTCNCFEE
          READ      CONTROLF,FIVE9;*1,CDLSTEP,*5,CREMINV:
                                   *66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY7;*214,PTCNBTNM
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,EIGHTY8;*162,PTCFEEOF
          READ      CONTROLF,HUND05;*99,PTCNNWCM
          READ      CONTROLF,HUND12;*102,PTCNHITC
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATCMXA1,"patcmxaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATITEM1,"patitemn"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDTRE1,"aaedtref"
          OPEN      OUTSITA1,"outsitaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      NZPBFEA1,"nzpbfeaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
          OPEN      NZPIBRA1,"nzpibraf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA2,"nzpmchaf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPPICA2,"nzppicaf"
          OPEN      NZPRBRA1,"nzprbraf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
          OPEN      NZPPFEA1,"nzppfeaf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
          OPEN      NZPTFEA1,"nzptfeaf"
          OPEN      NZPTFEA2,"nzptfeaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATGTUA1,"patgtuaf"
          OPEN      PATIPEN1,"patipenf"
.
...  used in PATCATBI CRMV0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEX
.
...  used in PATCATBI PTMP0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEZ
.
...  used in PATCATBI PT2P0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEY
.
...  used in PABXBILL
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAME
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAM2
.
INIT9999  RETURN
+
.****************************************************************************
.*                                OPTN0000             Called by: ML0000    *
.*                        get user options or exit                          *
.*                                                                          *
.*    Returns:  EXIT    = FALSE (0)  Run clean up                           *
.*                        TRUE  (1)  Exit option selected                   *
.****************************************************************************
.
OPTN0000  DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Run":
                    *P1:6,*V2LON,TWO,*HOFF,". Run and Update":
.
                    *P1:7,*V2LON,THREE,*HOFF,". Run (Disc.date Range)":
                    *P1:8,*V2LON,FOUR,*HOFF,". Run and Update (Disc.Date Range)"
.
OPTN0500  KEYIN     *P1:10,*EL,"Select Option : ",*DV,UNDLN1:
                    *P17:10,*V2LON,XOPTION
.
          COMPARE   ZERO,XOPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    XOPTION,OPTN9000,OPTN9000:   * run clean-up
                            OPTN9000,OPTN9000
.
          BEEP
          GOTO      OPTN0500
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.**************************************************************************
.*                               PROC0000              Called by: ML0000  *
.*                                                                        *
.**************************************************************************
.
PROC0000  MOVE      ZERO,COUNTER
          PRINT     *1,"Adm.No.",*12,"    Amount":
                    *30,"Reason for Hold",*48,"No of Inv.Printed",*N
.
          DISPLAY   *P1:24,*EL,*P24:24,*V2LON:
                    "** Processing Current Admission **",*HOFF;
.
          DISPLAY   *P1:17,*EL,"Record No. : ";
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:19,"Started  : ",CDATE,SP1,CTIMEIS
.
          DISPLAY   *P1:21,*EL,"Admiss.No: ";
.
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,RECWRIT
          MOVE      ZERO,RECDELE
          MOVE      TWO,WSTAT
          MOVE      SP8,DDATE
          MOVE      ONE,DISFLG
          CALL      LADM0000             * loop admission file
.
          DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing On Leave Admission **",*HOFF;
.
          MOVE      FOUR,WSTAT
          MOVE      SP8,DDATE
          MOVE      ONE,DISFLG
          CALL      LADM0000             * loop admission file
.
          DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing Discharge Admission **",*HOFF;
.
          MOVE      ZERO,DISFLG
          PACK      KEY16 WITH KEYNDATE,SP70
          CALL      RDSDSCH2
PROC1000  CALL      RDKDSCH2
          BRANCH    OVRCD OF PROC9000
.
          IF        XOPTION=3 | XOPTION=4
            MATCH     DDATE,KEYTDATE
            GOTO      PROC9000 IF LESS
          ENDIF
.
          MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF PROC1000
.
          COMPARE   FIVE,ASTAT
          GOTO      PROC1000 IF EQUAL
.
          CALL      EXNB0000                  * Excluded newborn
          BRANCH    EXIT,PROC1000
.
          PACK      KEY8,AADMNO,SP10
          CALL      RDPMVX11
          BRANCH    OVRCD,PROC1000
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL
              MATCH     PMVXMHOS,HOSPCODE
              GOTO      PROC1000 IF NOT EQUAL
            ENDIF
          ENDIF
          DISPLAY   *P12:21,*EF,AADMNO;
          CALL      CTBI0000                * Calculate to be invoiced
          GOTO      PROC1000
.
PROC9000  IF        XOPTION=2 | XOPTION=4
            PRINT     *N,*1,"No of Records: ",RECNUMB:
                         *N,*1," Written: ",RECWRIT:
                         *N,*1," Deleted: ",RECDELE
          ELSE
            PRINT     *N,*1,"No of Records: ",RECNUMB
          ENDIF
.
          DISPLAY   *P1:20,*EL,"No of Records: ",RECNUMB:
                    *P1:21,*EL," Write  : ",RECWRIT:
                    *P1:22,*EL," Delete : ",RECDELE
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:23,"Ended  : ",CDATE,SP1,CTIMEIS
          DISPLAY   *P1:24,*EL,"Finished processsing. ";
.
          CALL      HITENTER
.
PROC9999  RETURN
+
. =========================================================================
.         Loop through Admission file for the Status
. =========================================================================
LADM0000  PACK      KEY9 WITH WSTAT,SP6
          CALL      RDSMISS2
LADM1000  CALL      RDKMISS2
          BRANCH    OVRCD OF LADM9999
.
          COMPARE   WSTAT,ASTAT
          GOTO      LADM9999 IF NOT EQUAL
.
          CALL      EXNB0000                  * Excluded newborn
          BRANCH    EXIT,LADM1000
.
          PACK      KEY8,AADMNO,SP10
          CALL      RDPMVX11
          BRANCH    OVRCD,LADM1000
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL
              MATCH     PMVXMHOS,HOSPCODE
              GOTO      LADM1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          DISPLAY   *P12:21,*EF,AADMNO;
          CALL      CTBI0000                * Calculate to be invoiced
          GOTO      LADM1000
.
LADM9999  RETURN
+
. =========================================================================
.         Calculate to be invoiced
. =========================================================================
CTBI0000  MOVE      AADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF CTBI9999
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF CTBI9999
.
          ADD       ONE,COUNTER
          IF        (COUNTER%100) = 0
            DISPLAY   *P15:17,*V2LON,COUNTER
          ENDIF
.
          UNPACK    ADATE TO ACEN,AYER,AMON,ADAY
          UNPACK    DDATE TO DDCEN,DDYER,DDMON,DDDAY
.
          MOVE      ONE,PROGFLAG
          MOVE      ZERO,DISPROG
          MOVE      CPAGENO,FORM3A
          MOVE      ZERO,IBCNUGST         * set no GST for pending report
          CALL      CALCTBI
          MOVE      FORM3A,CPAGENO
.
.       If the invoice is for zero amount, and zero bed days, then ignore it
.
          COMPARE   ZERO,NETTOT
          GOTO      CTBI2000 IF NOT EQUAL
.
.         CHOSTYP=1 Public hospital - if no charge then check claim code
.
.         CHOSTYP=0 Private - if no charge and totdays =0 then delete pending
.                           - if no charge but totday <>0 then write pending
.
          IF        CHOSTYP=0
            COMPARE   ZERO,TOTDAYS
            GOTO      CTBI2000 IF NOT EQUAL
.
.         Invoice for Zero amount, Zero days - if patient is discharged, delete
.         record from the PATIPEFD file
.
            COMPARE   THREE,ASTAT
            GOTO      CTBI9999 IF NOT EQUAL
          ELSE
            CALL      CLMC0000     * Public hospital - zero invoice check claim
            BRANCH    EXIT,CTBI0200  * No charge - no pending
.
.           If patient is chargeable but discharged, should not have pending
.
            COMPARE   ZERO,TOTDAYS
            GOTO      CTBI2000 IF NOT EQUAL  * invoice has number of days
            COMPARE   THREE,ASTAT
            GOTO      CTBI2000 IF NOT EQUAL  * Not disc. write to pending
          ENDIF
.
.         Invoice for Zero amount, Zero days - delete record from the PATIPEFD
.
CTBI0200  MOVE      AADMNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,CTBI9999
.
          ADD       ONE,RECNUMB
.
          COMPARE   FOUR,XOPTION
          GOTO      CTBI0400 IF EQUAL
.
          COMPARE   TWO,XOPTION
          GOTO      CTBI1000 IF NOT EQUAL
.
CTBI0400  CALL      DEIPEN1
          ADD       ONE,RECDELE
.
CTBI1000  PRINT     *1,IPADMNO,*12,NETTOT,*30,PTIPRHLD,*48,AINVPRT:
                    *60," Delete"
          GOTO      CTBI9999
.
.         Still to be invoiced, or zero amount of invoice with bed days
.
CTBI2000  PACK      KEY8,AADMNO,SP70
          CALL      RDIPEN1
          COMPARE   ZERO,OVRCD
          GOTO      CTBI9999 IF EQUAL
.
          MOVE      AADMNO,IPADMNO
          MOVE      PVITYPE,IPSYSTM
          MOVE      PVISITE,IPSITE
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,PENDHOSP           * Hospital ID
          ENDIF
          MOVE      " 3",PENDSYST                 * Inpatient
.
          MOVE      SP70,PTIPRHLD
          MOVE      SP70,PTIPRDES
.
          MOVE      ADATE,PENDSDAT                * use Adm.date for As At date
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDSDAT            * use Disc.date for As At date
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND               * IP
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
.
          MOVE      FIVE,PTIPRSTA                 * Bed fee Update Record status
          MOVE      SP70,PTIPSVAR
          ADD       ONE,RECNUMB
.
          COMPARE   FOUR,XOPTION
          GOTO      CTBI2200 IF EQUAL
.
          COMPARE   TWO,XOPTION
          GOTO      CTBI8000 IF NOT EQUAL
.
CTBI2200  PACK      KEY8,IPADMNO,SP70
          CALL      WRIPEN1
          ADD       ONE,RECWRIT
.
CTBI8000  PRINT     *1,IPADMNO,*12,NETTOT,*30,PTIPRHLD,*48,AINVPRT:
                    *60," Add"
CTBI9999  RETURN
+
.------------------------------------------------------------
.         Check Claim code if it's chargeable
.------------------------------------------------------------
CLMC0000  PACK      ACLAIM,ACLAIM,SP70
          MATCH     SP70,ACLAIM
          GOTO      CLMC9000 IF EQUAL      * no charge
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CLMC8000
.
          MATCH     "P",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Public - no charge
          MATCH     "R",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Reciprocal - no charge
          MATCH     "J",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Prisoner - no charge
.
CLMC8000  MOVE      ZERO,EXIT              * chargeable
          GOTO      CLMC9999
.
CLMC9000  MOVE      ONE,EXIT               * no charge
CLMC9999  RETURN
+
.******************************************************************************
.*                                  KHOS0000              Called by: ML0000   *
.*                            Enter The hospital                              *
.******************************************************************************
KHOS0000  MOVE      SP70,HOSPCODE
          COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          DISPLAY   *P1:12,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      TEN2,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          MOVE      PTHSHOSP,HOSPCODE
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,HOSPCODE
          MOVE      ZERO,EXIT
.
KHOS3000  CLOSE     PATHSPA1
.
          DISPLAY   *P20:12,*V2LON,PTHSNAME;
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN
+
. =========================================================================
.         Keyin discharge fromdate
. =========================================================================
KDATE000  MOVE      "27",CCOL
          MOVE      "14",CVERT
          DISPLAY   *P1:CVERT,*EF,"Starting Discharge Date : ";
.
          MOVE      ONE,CCANLDTE            * Blank cancel default
          MOVE      ZERO,CHIGHLT            * Use highlight
          MOVE      SP70,KEYNDATE
          MOVE      SP70,KEYTDATE
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY
          CALL      KEYDATE
          BRANCH    OVRCD,KDATE900
.
          PACK      KEYNDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEYNDATE
          GOTO      KDATE999
.
KDATE900  MOVE      SP70,KEYNDATE
KDATE999  RETURN
+
. =========================================================================
.         Keyin discharge todate
. =========================================================================
KTDAT000  MOVE      "27",CCOL
          MOVE      "15",CVERT
          DISPLAY   *P1:CVERT,*EF,"      To Discharge Date : ";
.
          MOVE      ONE,CCANLDTE            * Blank cancel default
          MOVE      ZERO,CHIGHLT            * Use highlight
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY
          CALL      KEYDATE
          BRANCH    OVRCD,KTDAT900
.
          PACK      KEYTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEYTDATE
          GOTO      KTDAT999
.
KTDAT900  MOVE      SP70,KEYTDATE
KTDAT999  RETURN
+
. =========================================================================
.         I/O Includes
. =========================================================================
          INC       STD001IO
          INC       AAECATBI
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       CALCAGE
          INC       CLNZPPIC
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       IBAPASIO/INC
          INC       IBASECIO/INC
          INC       IBATMDIO/INC
          INC       NHIMASIO/INC
          INC       MLTCFNIO/INC

          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPCMTIO/INC
          INC       NZPEXTIO/INC
          INC       NZPRDTIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIBRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPSPRIO/INC
          INC       NZPTFEIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRVBIO/INC

          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       OUTCATBI
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTDTRIO/INC
          INC       OUTSITIO/INC
          INC       PATCATBI
          INC       PATCODDS
          INC       CHKCMXPT                * Check if casemix & get epis type
          INC       PATCMSTP
          INC       PATGNCMX
          INC       CMGETTHR
          INC       CMXMATRX
          INC       NHOSPDAY
          INC       CALCDAYS
          INC       PABXBILL
          INC       PATCOMN3
          INC       PATIVMES
          INC       CLPATDTR                * Clear DTR file variables
          INC       PATHSPKY
          INC       PRBILCMN
          INC       PATMCHRD
          INC       PATITMRD
          INC       GETCNEFF
          INC       GETBFEES
          INC       GETTFEES
          INC       EXCLNEWB
.
          INC       PATAFEIO/INC       * for casemix
          INC       PATASDIO/INC
          INC       PATCMXIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
.
          INC       PATELGIO/INC
          INC       PATBFEIO/INC
          INC       PATTFEIO/INC       *theatre fee
          INC       PATCODIO/INC
          INC       PMSCIDIO/INC
          INC       PMSCCDIO/INC
          INC       PATCFAIO/INC
          INC       PATCTFIO/INC
          INC       PATDGWIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATDRGIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATGTUIO/INC
          INC       PATRE1IO/INC
          INC       PATHSPIO/INC
          INC       PATHTRIO/INC
          INC       EMRHTRIO/INC
          INC       OUTHTRIO/INC
          INC       PATFINIO/INC
          INC       PATFMOIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATFN1IO/INC
          INC       PATFN2IO/INC
          INC       PATIBLIO/INC
          INC       PATICUIO/INC
          INC       PATIN1IO/INC
          INC       PATINMIO/INC
          INC       PATINVIO/INC
          INC       PATIOVIO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATONHIO/INC
          INC       PATOVBIO/INC
          INC       PATPGRIO/INC
          INC       PATRBLIO/INC
          INC       PATRCAIO/INC
          INC       PATRATIO/INC
          INC       PATSRBIO/INC
          INC       PATTRNIO/INC
          INC       PATVENIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PMSEVTIO/INC
          INC       PMSCNOIO/INC
          INC       PMSHATIO/INC
          INC       PMSHCPIO/INC
          INC       PMSSINIO/INC
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSSGAIO/INC
          INC       PMSMTIIO/INC
          INC       PMSMPRIO/INC
          INC       PMSVX1IO/INC
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       OPRARDIO/INC
          INC       PRIITMIO/INC
          INC       PATSELFN
          INC       PATIPERH
          INC       TFILENAM                     * Generate Temp File Name
.
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       WEBERRIO/INC                 * Web Server Error Logging
.
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       COMDEPIO/INC
          INC       RCPDTEIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIDEIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       PATDDHIO/INC
          INC       STEPDOWN
          INC       VALCMXFN
          INC       CLPMSIDE
          INC       GETEFDRG
.
WRITETRN
GETTHR
PATCALF
TAIL
INITIVAR
PRTEOL
PROCMISC
PRTCLMS
NXTTRAN1
WEBERR00
PRTINVTL
SINVT000
DOCNM000
ISUG0000
PEOL0000
PRLN0000
ENDPRT00
PROACC00
CKTL0000
PRTIPROV
ENDPRT    RETURN
.
