. *----------------------------------------------------------------------
. * Include Name  :   PMSBRQTM.PBL
. *
. * Function      :   CGI functions for PMSBRQFD - pmsbrqaf.dat
. *
. * Includes Needed :
. *
. *----------------------------------------------------------------------
.  Modifications Done :
.------------------------------------------------------------------------
.   V11.02.01  15/02/2022  Ebon Clements   TSK 0916005
.              Clear cancel bed request link if cancel not available
.              VTAB0000 - HTMLLNK3
.   V11.00.02  03/02/2021  Ebon Clements   TSK 0902257
.              Only re format the VEMD code with a full stop if it's longer
.              than 3 characters - PMBR0310
.   V11.00.01  09/06/2020  Thanh T         TSK 0892536
.              Changed PWSEL000 to show the correct wards for single
.              hospital
.   V10.15.02  15/01/2020  Thanh T         TSK 0856646
.              Changed PWSEL000 to show the correct wards based on the  
.              selected hospital
.   V10.15.01  09/10/2019  Thanh T         TSK 0856646
.              Added PMBRQ019 to PMBRQ032 for sjog-midland functionality  
.------------------------------------------------------------------------
.   V10.14.01  03/09/2019  Thanh T         TSK 0834846
.              Added PMBR0370/PMBR0380 to get diagnosis code/description 
.              for WAHEALTH     
.------------------------------------------------------------------------
.   V10.11.01  02/11/2017  J.Tan           TSK 0847165
.              Mod Ward/Bed request to display full Ward/Bed description
.   V10.09.01  30/11/2016  J.Tan           TSK 0814743
.              Added PMBRQ018 - Admitting Team
.   V10.05.02  30/09/2014  Don Nguyen      CAR 297774
.              Modified CPMBRQ00 to clear PMBRRDAT & PMBRRTIM
.   V10.05.01  11/08/2014  Don Nguyen      CAR 297774
.              Modified VTAB0000 to display PMBRRDAT & PMBRRTIM for allocated
.              Bed Requests.
.              Added PMBRQ016 & PMBRQ017.
.   V10.03.01  23/11/2011  Ebon Clements   CAR 255738
.              Show ward beds in short description order
.   V10.02.01  28/06/2011  Peter McMullen  CAR 240725
.              Change ward selection list to sort by name, not code 
.   V10.00.02  05/08/2010  Ebon Clements   CAR 220126
.              Added tag 33 - Default ED admitting doctor EMVIUR01
.   V10.00.01  16/06/2010  Peter Vela      CAR 216620
.              Added PMBRQ015
.   V9.12.02   08/02/2010  Ebon Clements   CAR 215599
.              Added ED diagnosis tag
.   V9.12.01   02/06/2009  Ebon Clements   CAR 197329
.              Added bed selection list tag
.   V9.11.03   12/01/2009  Ebon Clements   CAR 174080
.              Pack PMBRQ010 with SP70
.   V9.11.02   17/12/2008  Ebon Clements   CAR 174080
.              Added preferred hospital selection list
.   V9.11.01   23/09/2008  Ebon Clements   CAR 174047
.              Added PMBRQ012 to PMBRQ014
.   V9.09.01   20/12/2007  Ebon Clements  CAR 158014
.              Added ward/bed description to ward bed request list
.   V9.09.00   08/11/2007  Ebon Clements   CAR 151894
.              Created include
.------------------------------------------------------------------------
.   Clear Parameters for bed request file
.------------------------------------------------------------------------
CPPMBR00  MOVE      Z70,PMBRQ001
          MOVE      Z70,PMBRQ002
          MOVE      Z70,PMBRQ003
          MOVE      Z70,PMBRQ004
          MOVE      Z70,PMBRQ005
          MOVE      Z70,PMBRQ006
          MOVE      Z70,PMBRQ007
          MOVE      Z70,PMBRQ008
          MOVE      Z70,PMBRQ009
          MOVE      Z70,PMBRQ010
          MOVE      Z70,PMBRQ011
          MOVE      Z70,PMBRQ012
          MOVE      Z70,PMBRQ013
          MOVE      Z70,PMBRQ014
          MOVE      Z70,PMBRQ015
          MOVE      Z70,PMBRQ016
          MOVE      Z70,PMBRQ017
          MOVE      Z70,PMBRQ018
          MOVE      Z70,PMBRQ019
          MOVE      Z70,PMBRQ020
          MOVE      Z70,PMBRQ021
          MOVE      Z70,PMBRQ022
          MOVE      Z70,PMBRQ023
          MOVE      Z70,PMBRQ024
          MOVE      Z70,PMBRQ025
          MOVE      Z70,PMBRQ026
          MOVE      Z70,PMBRQ027
          MOVE      Z70,PMBRQ028
          MOVE      Z70,PMBRQ029
          MOVE      Z70,PMBRQ030
          MOVE      Z70,PMBRQ031
          MOVE      Z70,PMBRQ032
.
CPPMBR99  RETURN
.
.------------------------------------------------------------
. Tags for the bed request file
.------------------------------------------------------------
PMBR0000  BRANCH    FLDITMNO,PMBR0010,PMBR0020,PMBR0030,PMBR0040,PMBR0050:
                             PMBR0060,PMBR0070,PMBR0080,PMBR0090,PMBR0100:
                             PMBR0110,PMBR0120,PMBR0130,PMBR0140,PMBR0150:
                             PMBR0160,PMBR0170,PMBR0180,PMBR0190,PMBR0200:
                             PMBR0210,PMBR0220,PMBR0230,PMBR0240,PMBR0250:
                             PMBR0260,PMBR0270,PMBR0280,PMBR0290,PMBR0300:
                             PMBR0310,PMBR0320,PMBR0330,PMBR0340,PMBR0350:
                             PMBR0360,PMBR0370,PMBR0380,PMBR0390,PMBR0400:
                             PMBR0410,PMBR0420,PMBR0430,PMBR0440,PMBR0450:
                             PMBR0460,PMBR0470,PMBR0480,PMBR0490,PMBR0500:
                             PMBR0510,PMBR0520
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PMBR9999
.
PMBR0010  WRITE     HTMLFILE;PMBRVISN;
          GOTO      PMBR9999
.
PMBR0020  MATCH     PMBRREQD,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRREQD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0030  WRITE     HTMLFILE;PMBRREQT;
          GOTO      PMBR9999
.
PMBR0040  MOVE      "AC",CATEGORY
          MOVE      PMBRUNIT,CODE
          CALL      CODITM00
          GOTO      PMBR9999
.
PMBR0050  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0051
.
          PACK      KEY10,PMBRRHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,PMBR9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PMBR9999
.
PMBR0051  MATCH     SP70,PMBRRHCP
          GOTO      PMBR9999 IF EQUAL
.
          WRITE     HTMLFILE;PMBRRHCP;
          GOTO      PMBR9999
.
PMBR0060  MOVE      "RT",CATEGORY
          MOVE      PMBRTYPE,CODE
          CALL      CODITM00
          GOTO      PMBR9999
.
PMBR0070  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0071
.
          MATCH     "4",PMBRRSTA
          IF        @EQUAL
            WRITE     HTMLFILE;"Cancelled";
            GOTO      PMBR9999
          ENDIF
.
          MATCH     "3",PMBRRSTA
          IF        @EQUAL
            WRITE     HTMLFILE;"Completed";
            GOTO      PMBR9999
          ENDIF
.
          MATCH     "2",PMBRRSTA
          IF        @EQUAL
            WRITE     HTMLFILE;"Allocated";
            GOTO      PMBR9999
          ENDIF
.
          WRITE     HTMLFILE;"Requested";
          GOTO      PMBR9999
.
PMBR0071  WRITE     HTMLFILE;PMBRRSTA;
          GOTO      PMBR9999
.
PMBR0080  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0081
.
          MATCH     SP70,PMBRDIAG
          GOTO      PMBR9999 IF EQUAL
.
          MOVE      PMBRREQD,ICDRDDTE 
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDPTICD1
          BRANCH    OVRCD,PMBR9999
.
          WRITE     HTMLFILE;DDESC;
.
          GOTO      PMBR9999
.
PMBR0081  WRITE     HTMLFILE;PMBRDIAG;
          GOTO      PMBR9999
.
PMBR0090  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0091,PMBR0092
.
          PACK      KEY6,PMBREWRD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PMBR9999
.
          MATCH     SP70,WBDESC
          GOTO      PMBR9999 IF EQUAL
.
          WRITE     HTMLFILE;WBDESC;
          GOTO      PMBR9999

PMBR0091  WRITE     HTMLFILE;PMBREWRD;
          GOTO      PMBR9999
.
PMBR0092  MOVE      PMBREWRD,DFLTWARD
          CALL      WSEL0000
          GOTO      PMBR9999
.
PMBR0100  WRITE     HTMLFILE;PMBREBED;
          GOTO      PMBR9999
.
PMBR0110  MOVE      "cz",CATEGORY
          MOVE      PMBRCANR,CODE
          CALL      CODITM00
          GOTO      PMBR9999
.
PMBR0120  MATCH     PMBRADAT,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0130  WRITE     HTMLFILE;PMBRATIM;
          GOTO      PMBR9999
.
PMBR0140  MATCH     SP70,PMBRAUID
          GOTO      PMBR9999 IF EQUAL
.
          PACK      KEY10,PMBRAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMBRAUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMBR9999
.
PMBR0150  MATCH     PMBRCAND,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRCAND,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0160  WRITE     HTMLFILE;PMBRCANT;
          GOTO      PMBR9999
.
PMBR0170  MATCH     SP70,PMBRCANU
          GOTO      PMBR9999 IF EQUAL
.
          PACK      KEY10,PMBRCANU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMBRCANU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMBR9999
.
PMBR0180  MATCH     PMBRCDAT,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0190  WRITE     HTMLFILE;PMBRCTIM;
          GOTO      PMBR9999
.
PMBR0200  MATCH     SP70,PMBRCUID
          GOTO      PMBR9999 IF EQUAL
.
          PACK      KEY10,PMBRCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMBRCUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMBR9999
.
PMBR0210  MATCH     PMBRUDAT,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0220  WRITE     HTMLFILE;PMBRUTIM;
          GOTO      PMBR9999
.
PMBR0230  MATCH     SP70,PMBRUUID
          GOTO      PMBR9999 IF EQUAL
.
          PACK      KEY10,PMBRUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMBRUUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMBR9999
.
PMBR0240  MOVE      "009",KEY3
          PACK      KEY17,PMBRVISN,KEY3,SP70
          CALL      RSVSMDT1
PMBR0241  CALL      RKVSMDT1
          BRANCH    OVRCD,PMBR9999          * end of file
.
          MATCH     VSMDVISN,PMBRVISN       * same Admission Number?
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     VSMDDATE,PMBRREQD
          GOTO      PMBR0241 IF NOT EQUAL
.
          MATCH     VSMDTIME,PMBRREQT
          GOTO      PMBR0241 IF NOT EQUAL
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
PMBR0245  CALL      RKVSMTX1
          BRANCH    OVRCD,PMBR9999
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      PMBR9999 IF NOT EQUAL
.
          UNPACK    VSMTCMNT,DIM70,DIM30    * only use first 70 chars
          WRITE     HTMLFILE;DIM70
.
          GOTO      PMBR0245
.
PMBR0250  MOVE      ZERO,WAHLFLAG           * WAHEALTH FLAG
          CALL      VTAB0000                * Table of visit bed requests
          GOTO      PMBR9999
.
PMBR0260  MATCH     " 1",PTVITYPE
          IF        @EQUAL
            MOVE      EMVIDOCT,PMBRRHCP
          ENDIF
.
          MATCH     " 3",PTVITYPE
          IF        @EQUAL
            MOVE      ADOCTA,PMBRRHCP
          ENDIF
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0261
.
          PACK      KEY10,PMBRRHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,PMBR9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PMBR9999
.
PMBR0261  WRITE     HTMLFILE;PMBRRHCP;
          GOTO      PMBR9999
. 
PMBR0270  MOVE      PMBRRWRD,DFLTWARD
          CALL      WSEL0000
          GOTO      PMBR9999
. 
PMBR0280  MOVE      "CG",CATEGORY
          MOVE      PMBRSBED,CODE
          CALL      CODITM00
          GOTO      PMBR9999
. 
PMBR0290  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0291
.
          WRITE     HTMLFILE;PMBRHOSP;
          GOTO      PMBR9999
.
PMBR0291  CALL      RQHS0000
          GOTO      PMBR9999
. 
PMBR0300  MATCH     SP70,PMBREWRD
          GOTO      PMBR9999 IF EQUAL
.         
          PACK      KEY16,PMBREWRD,SP70
          CALL      RDSWARD8
PMBR0305  CALL      RDKWARD8
          BRANCH    OVRCD,PMBR9999
.         
          MATCH     PMBREWRD,WWARD
          GOTO      PMBR9999 IF NOT EQUAL
.         
          MATCH     SP70,WBED
          GOTO      PMBR0305 IF EQUAL
.
          PACK      KEY5,QUOTE,WBED,QUOTE
.
          MOVE      ZERO,F1
          MOVE      PTCNWBDS,F1
          IF        F1=2
            MOVE      PTWDSDES,KEY10
          ELSE
            MOVE      WBED,KEY10
          ENDIF
.
          MATCH     PMBREBED,WBED
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5,"selected>",KEY10:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY10:
                               "</option>";
          ENDIF
          GOTO      PMBR0305                      
. 
PMBR0310  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     " 1",PTVITYPE           * Default diagnosis if ED visit
          GOTO      PMBR9999 IF NOT EQUAL
 
          PACK      KEY14,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
PMBR0311  CALL      RKEMVCD1
          BRANCH    OVRCD,PMBR9999
.
          MATCH     ADMISSNO,EMVCVIST
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
          GOTO      PMBR9999 IF NOT EQUAL
.
          MATCH     "000",EMVCSEQU          * Primary diagnosis
          GOTO      PMBR0311 IF NOT EQUAL
.
          MOVE      EMVCMNCD,KEY9
          CALL      RDEMICD1                * Read EMR diagnosis file
          BRANCH    OVRCD,PMBR9999
.
          MATCH     SP70,EMICVEMD           * Use as ICD10 code
          GOTO      PMBR9999 IF EQUAL
.
          SCAN      ".",EMICVEMD
          IF        @EQUAL
            RESET     EMICVEMD
            MOVE      EMICVEMD,PMBRDIAG
          ELSE
            RESET     EMICVEMD
            UNPACK    EMICVEMD,KEY3,KEY8
.
            MATCH     SP70,KEY8
            IF        @EQUAL
              MOVE      EMICVEMD,PMBRDIAG       * < 3 chars to no .
            ELSE
              PACK      PMBRDIAG,KEY3,DOT,KEY8  * > 3 chars so insert .
            ENDIF
          ENDIF
.
          MOVE      EMVIDATE,ICDRDDTE
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDPTICD1
          BRANCH    OVRCD,PMBR9999
.
          BRANCH    F1,PMBR0315
.         
          WRITE     HTMLFILE;DDESC;
.
          GOTO      PMBR9999
.
PMBR0315  WRITE     HTMLFILE;PMBRDIAG;
          GOTO      PMBR9999
.
PMBR0320  WRITE     HTMLFILE;PMBRFTXT;
          GOTO      PMBR9999
.
PMBR0330  MATCH     " 1",PTVITYPE
          IF        @EQUAL
            MOVE      EMVIUR01,PMBRRHCP
          ENDIF
.
          MATCH     " 3",PTVITYPE
          IF        @EQUAL
            MOVE      ADOCTA,PMBRRHCP
          ENDIF
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0331
.
          PACK      KEY10,PMBRRHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,PMBR9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PMBR9999
.
PMBR0331  WRITE     HTMLFILE;PMBRRHCP;
          GOTO      PMBR9999
.
PMBR0340  MATCH     PMBRRDAT,SP70
          GOTO      PMBR9999 IF EQUAL
.
          UNPACK    PMBRRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMBR9999
.
PMBR0350  WRITE     HTMLFILE;PMBRRTIM;
          GOTO      PMBR9999
.
PMBR0360  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0361
.
          WRITE     HTMLFILE;PMBRTEAM;
          GOTO      PMBR9999
.
PMBR0361  PACK      KEY5,PMBRTEAM
          CALL      RDPMTEM1
          BRANCH    OVRCD,PMBR9999
.
          WRITE     HTMLFILE;PMTMDESC;
          GOTO      PMBR9999
.
PMBR0370  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0375
.
PMBR0372  MATCH     SP70,PMBRDIAG
          GOTO      PMBR9999 IF EQUAL
.
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDEMICD1
          BRANCH    OVRCD,PMBR9999
.
          WRITE     HTMLFILE;EMICDESC;
          GOTO      PMBR9999
.
PMBR0375  WRITE     HTMLFILE;PMBRDIAG;
          GOTO      PMBR9999
.
PMBR0380  MOVE      ONE,WAHLFLAG            * WAHEALTH FLAG
          CALL      VTAB0000                * Table of visit bed requests
          GOTO      PMBR9999
. 
PMBR0390  UNPACK    DIM127,D1,KEY1,DIM127   * Preferred Ward  
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMBR0391
.
          WRITE     HTMLFILE;PMBRPWRD;
          GOTO      PMBR9999
.
PMBR0391  CALL      PWSEL000                * Preferred Ward selection
          GOTO      PMBR9999
.
PMBR0400  WRITE     HTMLFILE;PMBRSFFR;      * Spec Feat - Falls Risk
          GOTO      PMBR9999
.
PMBR0410  WRITE     HTMLFILE;PMBRSFEP;      * Spec Feat - ExistPressure Inj 
          GOTO      PMBR9999
.
PMBR0420  WRITE     HTMLFILE;PMBRSFCI;      * Spec Feat - Cognitive Impairment
          GOTO      PMBR9999
.
PMBR0430  WRITE     HTMLFILE;PMBRSFCO;      * Spec Feat - Companion
          GOTO      PMBR9999
.
PMBR0440  WRITE     HTMLFILE;PMBRSFIS;      * Spec Feat - TBP (Isolation)
          GOTO      PMBR9999
.
PMBR0450  WRITE     HTMLFILE;PMBRSFTE;      * Spec Feat - Telemetry
          GOTO      PMBR9999
.
PMBR0460  WRITE     HTMLFILE;PMBRSFRC;      * Spec Feat - From Resident Care
          GOTO      PMBR9999
.
PMBR0470  WRITE     HTMLFILE;PMBRSFOT;      * Spec Feat - Other (see notes)
          GOTO      PMBR9999
.
PMBR0480  WRITE     HTMLFILE;PMBRSFNR;      * Spec Feat - None Required
          GOTO      PMBR9999
.
PMBR0490  WRITE     HTMLFILE;PMBRSFMA;      * Spec Feat - Mobility Assistance
          GOTO      PMBR9999
.
PMBR0500  MOVE      "m3",CATEGORY           * Mobility Assistance Score (m3)
          MOVE      PMBRMASC,CODE
          CALL      CODITM00
          GOTO      PMBR9999
.
PMBR0510  WRITE     HTMLFILE;PMBRWDTR;      * Suitable for Ward Transfer
          GOTO      PMBR9999
.
PMBR0520  WRITE     HTMLFILE;PMBRCORC;      * Companion Requirement Confirmed
          GOTO      PMBR9999
.
PMBR9999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for bed request file
.------------------------------------------------------------
SPBRQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPBRQ001,SPBRQ002,SPBRQ003,SPBRQ004,SPBRQ005:
                       SPBRQ006,SPBRQ007,SPBRQ008,SPBRQ009,SPBRQ010:
                       SPBRQ011,SPBRQ012,SPBRQ013,SPBRQ014,SPBRQ015:
                       SPBRQ016,SPBRQ017,SPBRQ018,SPBRQ019,SPBRQ020:
                       SPBRQ021,SPBRQ022,SPBRQ023,SPBRQ024,SPBRQ025:
                       SPBRQ026,SPBRQ027,SPBRQ028,SPBRQ029,SPBRQ030:
                       SPBRQ031,SPBRQ032
.
SPBRQ001  PACK      PMBRQ001,QRYDATA,SP70
          GOTO      SPBRQ999
.
SPBRQ002  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PMBRQ002,CCENT,CYEAR,CMON,CDAY
          GOTO      SPBRQ999
.
SPBRQ003  MOVE      QRYDATA,PMBRQ003
          GOTO      SPBRQ999
.
SPBRQ004  MOVE      QRYDATA,PMBRQ004
          GOTO      SPBRQ999
.
SPBRQ005  MOVE      QRYDATA,PMBRQ005
          GOTO      SPBRQ999
.
SPBRQ006  MOVE      QRYDATA,PMBRQ006
          GOTO      SPBRQ999
.
SPBRQ007  MOVE      QRYDATA,PMBRQ007
          GOTO      SPBRQ999
.
SPBRQ008  MOVE      QRYDATA,PMBRQ008
          GOTO      SPBRQ999
.
SPBRQ009  PACK      PMBRQ009,QRYDATA,SP70
          GOTO      SPBRQ999
.
SPBRQ010  PACK      PMBRQ010,QRYDATA,SP70
          GOTO      SPBRQ999
.
SPBRQ011  MOVE      QRYDATA,PMBRQ011
          GOTO      SPBRQ999
.
SPBRQ012  MOVE      QRYDATA,PMBRQ012
          GOTO      SPBRQ999
.
SPBRQ013  MOVE      QRYDATA,PMBRQ013
          GOTO      SPBRQ999
.
SPBRQ014  MOVE      QRYDATA,PMBRQ014
          GOTO      SPBRQ999
.
SPBRQ015  MOVE      QRYDATA,PMBRQ015
          GOTO      SPBRQ999
.
SPBRQ016  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PMBRQ016,CCENT,CYEAR,CMON,CDAY
          GOTO      SPBRQ999
.
SPBRQ017  MOVE      QRYDATA,PMBRQ017
          GOTO      SPBRQ999
.
SPBRQ018  MOVE      QRYDATA,PMBRQ018
          GOTO      SPBRQ999
.
SPBRQ019  MOVE      QRYDATA,PMBRQ019
          GOTO      SPBRQ999
.
SPBRQ020  MOVE      QRYDATA,PMBRQ020
          GOTO      SPBRQ999
.
SPBRQ021  MOVE      QRYDATA,PMBRQ021
          GOTO      SPBRQ999
.
SPBRQ022  MOVE      QRYDATA,PMBRQ022
          GOTO      SPBRQ999
.
SPBRQ023  MOVE      QRYDATA,PMBRQ023
          GOTO      SPBRQ999
.
SPBRQ024  MOVE      QRYDATA,PMBRQ024
          GOTO      SPBRQ999
.
SPBRQ025  MOVE      QRYDATA,PMBRQ025
          GOTO      SPBRQ999
.
SPBRQ026  MOVE      QRYDATA,PMBRQ026
          GOTO      SPBRQ999
.
SPBRQ027  MOVE      QRYDATA,PMBRQ027
          GOTO      SPBRQ999
.
SPBRQ028  MOVE      QRYDATA,PMBRQ028
          GOTO      SPBRQ999
.
SPBRQ029  MOVE      QRYDATA,PMBRQ029
          GOTO      SPBRQ999
.
SPBRQ030  MOVE      QRYDATA,PMBRQ030
          GOTO      SPBRQ999
.
SPBRQ031  MOVE      QRYDATA,PMBRQ031
          GOTO      SPBRQ999
.
SPBRQ032  MOVE      QRYDATA,PMBRQ032
          GOTO      SPBRQ999
.
SPBRQ999  RETURN
.
.------------------------------------------------------------
.  Update cgi to bed request file
.------------------------------------------------------------
MVPMBR00  MATCH     PMBRQ001,Z70
          IF        !@EQUAL
            MOVE      PMBRQ001,PMBRVISN
          ENDIF
.
          MATCH     PMBRQ002,Z70
          IF        !@EQUAL
            MOVE      PMBRQ002,PMBRREQD
          ENDIF
.
          MATCH     PMBRQ003,Z70
          IF        !@EQUAL
            MOVE      PMBRQ003,PMBRREQT
          ENDIF
.
          MATCH     PMBRQ004,Z70
          IF        !@EQUAL
            MOVE      PMBRQ004,PMBRUNIT
          ENDIF
.
          MATCH     PMBRQ005,Z70
          IF        !@EQUAL
            MOVE      PMBRQ005,PMBRRHCP
          ENDIF
.
          MATCH     PMBRQ006,Z70
          IF        !@EQUAL
            MOVE      PMBRQ006,PMBRTYPE
          ENDIF
.
          MATCH     PMBRQ007,Z70
          IF        !@EQUAL
            MOVE      PMBRQ007,PMBRRSTA
          ENDIF
.
          MATCH     PMBRQ008,Z70
          IF        !@EQUAL
            MOVE      PMBRQ008,PMBRDIAG
          ENDIF
.
          MATCH     PMBRQ009,Z70
          IF        !@EQUAL
            MOVE      PMBRQ009,PMBREWRD
          ENDIF
.
          MATCH     PMBRQ010,Z70
          IF        !@EQUAL
            MOVE      PMBRQ010,PMBREBED
          ENDIF
.
          MATCH     PMBRQ011,Z70
          IF        !@EQUAL
            MOVE      PMBRQ011,PMBRCANR
          ENDIF
.
          MATCH     PMBRQ012,Z70
          IF        !@EQUAL
            MOVE      PMBRQ012,PMBRRWRD
          ENDIF
.
          MATCH     PMBRQ013,Z70
          IF        !@EQUAL
            MOVE      PMBRQ013,PMBRSBED
          ENDIF
.
          MATCH     PMBRQ014,Z70
          IF        !@EQUAL
            MOVE      PMBRQ014,PMBRHOSP
          ENDIF
.
          MATCH     PMBRQ015,Z70
          IF        !@EQUAL
            MOVE      PMBRQ015,PMBRFTXT
          ENDIF
.
          MATCH     PMBRQ016,Z70
          IF        !@EQUAL
            MOVE      PMBRQ016,PMBRRDAT
          ENDIF
.
          MATCH     PMBRQ017,Z70
          IF        !@EQUAL
            MOVE      PMBRQ017,PMBRRTIM
          ENDIF
.
          MATCH     PMBRQ018,Z70
          IF        !@EQUAL
            MOVE      PMBRQ018,PMBRTEAM
          ENDIF
.
          MATCH     PMBRQ019,Z70
          IF        !@EQUAL
            MOVE      PMBRQ019,PMBRPWRD
          ENDIF
.
          MATCH     PMBRQ020,Z70
          IF        !@EQUAL
            MOVE      PMBRQ020,PMBRSFFR
          ENDIF
.
          MATCH     PMBRQ021,Z70
          IF        !@EQUAL
            MOVE      PMBRQ021,PMBRSFEP
          ENDIF
.
          MATCH     PMBRQ022,Z70
          IF        !@EQUAL
            MOVE      PMBRQ022,PMBRSFCI
          ENDIF
.
          MATCH     PMBRQ023,Z70
          IF        !@EQUAL
            MOVE      PMBRQ023,PMBRSFCO
          ENDIF
.
          MATCH     PMBRQ024,Z70
          IF        !@EQUAL
            MOVE      PMBRQ024,PMBRSFIS
          ENDIF
.
          MATCH     PMBRQ025,Z70
          IF        !@EQUAL
            MOVE      PMBRQ025,PMBRSFTE
          ENDIF
.
          MATCH     PMBRQ026,Z70
          IF        !@EQUAL
            MOVE      PMBRQ026,PMBRSFRC
          ENDIF
.
          MATCH     PMBRQ027,Z70
          IF        !@EQUAL
            MOVE      PMBRQ027,PMBRSFOT
          ENDIF
.
          MATCH     PMBRQ028,Z70
          IF        !@EQUAL
            MOVE      PMBRQ028,PMBRSFNR
          ENDIF
.
          MATCH     PMBRQ029,Z70
          IF        !@EQUAL
            MOVE      PMBRQ029,PMBRSFMA
          ENDIF
.
          MATCH     PMBRQ030,Z70
          IF        !@EQUAL
            MOVE      PMBRQ030,PMBRMASC
          ENDIF
.
          MATCH     "1",PMBRSFMA
          IF        !@EQUAL
            MOVE      SP70,PMBRMASC
          ENDIF
.
          MATCH     PMBRQ031,Z70
          IF        !@EQUAL
            MOVE      PMBRQ031,PMBRWDTR
          ENDIF
.
          MATCH     PMBRQ032,Z70
          IF        !@EQUAL
            MOVE      PMBRQ032,PMBRCORC
          ENDIF
.
MVPMBR99  RETURN
.
.------------------------------------------------------------
. Clear bed request file variables
.------------------------------------------------------------
CPMBRQ00  MOVE      SP70,PMBRVISN
          MOVE      SP70,PMBRREQD
          MOVE      SP70,PMBRREQT
          MOVE      SP70,PMBRUNIT
          MOVE      SP70,PMBRRHCP
          MOVE      SP70,PMBRTYPE
          MOVE      SP70,PMBRRSTA
          MOVE      SP70,PMBRDIAG
          MOVE      SP70,PMBREWRD
          MOVE      SP70,PMBREBED
          MOVE      SP70,PMBRADAT
          MOVE      SP70,PMBRATIM
          MOVE      SP70,PMBRAUID
          MOVE      SP70,PMBRCANR
          MOVE      SP70,PMBRCAND
          MOVE      SP70,PMBRCANT
          MOVE      SP70,PMBRCANU
          MOVE      SP70,PMBRCDAT
          MOVE      SP70,PMBRCTIM
          MOVE      SP70,PMBRCUID
          MOVE      SP70,PMBRUDAT
          MOVE      SP70,PMBRUTIM
          MOVE      SP70,PMBRUUID
          MOVE      SP70,PMBRRWRD
          MOVE      SP70,PMBRSBED
          MOVE      SP70,PMBRHOSP
          PACK      PMBRFTXT,SP70,SP70
          MOVE      SP70,PMBRRDAT
          MOVE      SP70,PMBRRTIM
          MOVE      SP70,PMBRTEAM
          MOVE      SP70,PMBRPWRD
          MOVE      SP70,PMBRSFFR
          MOVE      SP70,PMBRSFEP
          MOVE      SP70,PMBRSFCI
          MOVE      SP70,PMBRSFCO
          MOVE      SP70,PMBRSFIS
          MOVE      SP70,PMBRSFTE
          MOVE      SP70,PMBRSFRC
          MOVE      SP70,PMBRSFOT
          MOVE      SP70,PMBRSFNR
          MOVE      SP70,PMBRSFMA
          MOVE      SP70,PMBRMASC
          MOVE      SP70,PMBRWDTR
          MOVE      SP70,PMBRCORC
          MOVE      SP70,PMBRSPAR
.
CPMBRQ99  RETURN
.
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.------------------------------------------------------------
. Table of visit bed requests
.------------------------------------------------------------
VTAB0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMBRQ1
VTAB1000  CALL      RKPMBRQ1
          BRANCH    OVRCD,VTAB9999
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      VTAB9999 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,VTAB9999
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,PMBRUNIT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,PMBRUNIT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRUNIT,TDESC
            ENDIF
            MOVE    TDESC,UNITDESC
          ENDIF
.
          MOVE      SP70,CANSDESC
          MATCH     SP70,PMBRCANR
          IF        !@EQUAL
            PACK      KEY5,CATCZ,PMBRCANR,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRCANR,TDESC
            ENDIF
            MOVE    TDESC,CANSDESC
          ENDIF
.
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMBRRHCP
          IF        !@EQUAL
            PACK      KEY10,PMBRRHCP,SP70
            CALL      RDPMHCP1
            IF        OVRCD=1
              MOVE      PMBRRHCP,DOCFNAME
            ELSE
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF    
.
          MOVE      SP70,TYPEDESC
          MATCH     SP70,PMBRTYPE
          IF        !@EQUAL
            PACK      KEY5,ANSR,ANST,PMBRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRTYPE,TDESC
            ENDIF
            MOVE    TDESC,TYPEDESC
          ENDIF
.
          MOVE      "Requested",REQSTATS
          MOVE      ONE,CANCFLAG
.
          MATCH     "4",PMBRRSTA
          IF        @EQUAL
            MOVE      "Cancelled",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF     
.         
          MATCH     "3",PMBRRSTA
          IF        @EQUAL
            MOVE      "Completed",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF
.         
          MATCH     "2",PMBRRSTA
          IF        @EQUAL
            MOVE      "Allocated",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF     
.
          CALL      DIAGDS00
.           
          MOVE      SP70,WBSENAM
          MATCH     SP70,PMBRAUID
          IF        !@EQUAL
            PACK      KEY10,PMBRAUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PMBRAUID,WBSENAM
            ENDIF
          ENDIF
.
          MOVE      ZERO,NOTEFLAG
          MOVE      "009",KEY3
          PACK      KEY17,PMBRVISN,KEY3,SP70
          CALL      RSVSMDT1
VTAB1500  CALL      RKVSMDT1
          BRANCH    OVRCD,VTAB2000          * end of file
.         
          MATCH     VSMDVISN,PMBRVISN       * same Admission Number?
          GOTO      VTAB2000 IF NOT EQUAL   
.
          MATCH     KEY3,VSMDTYPE
          GOTO      VTAB2000 IF NOT EQUAL
.
          MATCH     VSMDDATE,PMBRREQD
          GOTO      VTAB1500 IF NOT EQUAL
.
          MATCH     VSMDTIME,PMBRREQT
          GOTO      VTAB1500 IF NOT EQUAL
.
          MOVE      ONE,NOTEFLAG
.         
VTAB2000  MOVE      SP70,DIM11
          MATCH     SP70,PMBRREQD
          IF        !@EQUAL
            UNPACK    PMBRREQD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          MOVE      SP70,WBDESC
          MOVE      SP70,KEY41
          MATCH     SP70,PMBREWRD
          IF        !@EQUAL
            PACK      KEY6,PMBREWRD,SP70              * Ward description
            CALL      RDWARD1
            IF        OVRCD=0
              MOVE      WBDESC,KEY20                  * save ward description
              PACK      KEY41,WBDESC,SP70
              MATCH     SP70,PMBREBED
              IF        !@EQUAL
                PACK      KEY41,WBDESC,SLASH,PMBREBED,SP70
                PACK      KEY6,PMBREWRD,PMBREBED,SP70  * Bed description
                CALL      RDWARD1
                IF        OVRCD=1
                  PACK      KEY41,KEY20,SLASH,PMBREBED,SP70
                ELSE
                  PACK      KEY41,KEY20,SLASH,WBDESC,SP70
                ENDIF
              ENDIF
            ELSE
              PACK      KEY41,PMBREWRD,SP70
            ENDIF
          ENDIF
.
          MOVE      KEY41,DIM100
          MATCH     "2",PMBRRSTA            * Allocated?
          IF        @EQUAL
             ENDSET    DIM100
.
             MATCH     SP70,PMBRRDAT
             IF        !@EQUAL
               APPEND    "<br>",DIM100
               APPEND    "<br>",DIM100
               UNPACK    PMBRRDAT,CCENT,CYEAR,CMON,CDAY
               MOVE      CMON,F2
               LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
               PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
               APPEND    DISPDATE,DIM100
.
               MATCH     SP70,PMBRRTIM
               IF        !@EQUAL
                 APPEND    "&nbsp;at&nbsp;",DIM100
                 APPEND    PMBRRTIM,DIM100
               ENDIF
             ENDIF
.
             RESET     DIM100
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateRequest('",HTMLLINK
          APPEND    PMBRVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DIM11,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMBRREQT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIURNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ViewNotes('",HTMLLNK2
          APPEND    PMBRVISN,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    DIM11,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    PMBRREQT,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    PVIURNO,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          IF        CANCFLAG=0
            MOVE     SP70,HTMLLNK3
          ELSE
            CLEAR     HTMLLNK3
            APPEND    "javascript:CancelRequest('",HTMLLNK3
            APPEND    PMBRVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    DIM11,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PMBRREQT,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PVIURNO,HTMLLNK3
            APPEND    "')",HTMLLNK3
            RESET     HTMLLNK3
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",PMBRREQD,PMBRREQT,"#",":           * 1
                             "#"",PMBRUNIT,"#",":                    * 2
                             "#"",UNITDESC,"#",":                    * 3
                             "#"",DOCFNAME,"#",":                    * 4
                             "#"",PMBRTYPE,"#",":                    * 5
                             "#"",TYPEDESC,"#",":                    * 6
                             "#"",REQSTATS,"#",":                    * 7 
                             "#"",PMBRDIAG,"#",":                    * 8 
                             "#"",DIAGDESC,"#",":                    * 9
                             "#"",CANSDESC,"#",":                    * 10
                             "#"",DIM100,"#",":                      * 11
                             "#"",CANCFLAG,"#",":                    * 12
                             "#"",PMBRADAT,PMBRATIM,"#",":           * 13
                             "#"",WBSENAM,"#",":                     * 14
                             "#"",NOTEFLAG,"#",":                    * 15
                             "#"",HTMLLNK2,"#",":                    * 16
                             "#"",HTMLLNK3,"#",";                    * 17
.
          MATCH     SP70,PMBREWRD
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",PMBREWRD,"/",PMBREBED,"#",";     * 18
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                       * 18
          ENDIF
.
          MOVE      SP70,PMTMDESC
          MATCH     SP70,PMBRTEAM
          IF        !@EQUAL
            PACK      KEY5,PMBRTEAM
            CALL      RDPMTEM1
          ENDIF
          WRITE     HTMLFILE;"#"",DOCFNAME,"/",UNITDESC,"/",PMTMDESC:
                             "#");";                                 * 19
.
          GOTO      VTAB1000
.
VTAB9999  RETURN
.
.----------------------------------------------------------------------
. Get Diagnosis description. If it is for WAHEALTH (WAHLFLAG=1) and
. ED visit, the description is from emrcdaf table. Otherwise, it gets
. description from RDPTICD1     
.----------------------------------------------------------------------
DIAGDS00  MOVE      SP70,DIAGDESC
          MATCH     SP70,PMBRDIAG
          GOTO      DIAGDS99 IF EQUAL
.
          COMPARE   ONE,WAHLFLAG
          GOTO      DIAGDS30 IF EQUAL
.
          GOTO      DIAGDS60
.
. WAHEALTH diagnosis description
.
DIAGDS30  COMPARE   ONE,PVITYPE
          GOTO      DIAGDS60 IF NOT EQUAL
.
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDEMICD1
          IF        OVRCD=1
            MOVE      PMBRDIAG,DIAGDESC
          ELSE
            MOVE      EMICDESC,DIAGDESC
          ENDIF
          GOTO      DIAGDS99
.
DIAGDS60  MOVE      PMBRREQD,ICDRDDTE
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDPTICD1
          IF        OVRCD=1
            MOVE      PMBRDIAG,DIAGDESC
          ELSE
            MOVE      DDESC,DIAGDESC
          ENDIF
          GOTO      DIAGDS99
.
DIAGDS99  RETURN
.
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
RQHS0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
RQHS0100  CALL      RKPTHSP1
          BRANCH    OVRCD,RQHS9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,RQHS0100
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",PTHSHOSP,"#"";
          MATCH     PMBRHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",PTHSNAME,"</option>"
          GOTO      RQHS0100
.
RQHS9999  RETURN
.
.------------------------------------------------------------
. Preferred Ward selection
.------------------------------------------------------------
PWSEL000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
PWSEL100  CALL      RDKWARD7
          BRANCH    OVRCD,PWSEL999
.
. if we have a bed number we have passed all the ward master records. so exit
.
          MATCH     SP70,WBED
          GOTO      PWSEL999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      PWSEL100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      PWSEL999 IF NOT EQUAL
            ENDIF
            PACK      KEY13,USERID,SP70                * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PTWDHOSN,SP70     * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,PWSEL100
            ENDIF
          ENDIF
.
. write the select option.
.
PWSEL500  WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     PMBRPWRD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          WRITE     HTMLFILE;"</option>"
          GOTO      PWSEL100
.
PWSEL999  RETURN
.
