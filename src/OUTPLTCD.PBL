.******************************************************************************
.*  Include Name : OUTPLTCD.PBL                                               *
.*                                                                            *
.*  Description  : Routines for adhoc letter printing                         *
.*  Author       : Gabrielle Cameron                                          *
.*                                                                            *
.*  Routines     : VBOA0000  move bokb details to tempfile variables          *
.*                                                                            *
.*               : GOTP0000  Got a patient - put in tempfile                  *
.*                                                                            *
.*               : SEVA0000  Set up the values for all the "%" variables      *
.*                           Returns CEXIT = 0 continue                       *
.*                                   CEXIT = 1 get next temp record           *
.*                                                                            *
.*               : CLRV0000  Set up the print variables to "*"                *
.*                                                                            *
.*               : PRIN0000  Set up and print letter one line at a time       *
.*                           Returns : EXIT = 0 ask if to print more letters  *
.*                                     EXIT = 1 select another letter to print*
.*                                     EXIT = 2 get next item on temp file    *
.*                                                                            *
.*               : SHSP0000 Set up hospital details for multi hospital        *
.*                                                                            *
.*               : SUSL0000 Set up standard Letter Number                     *
.*                                                                            *
.*               : SULD0000 set up some letter details                        *
.*                                                                            *
.*               : GRHSP000 Get Hospital for Reschedule Letters               *
.*                                                                            *
.*               : PAGE0000 Routine to paginate if a new page is required     *
.*                                                                            *
.*               : MOD0000  Modify a line to substitute "%" variable values   *
.*                                                                            *
.*               : COMX0000 Routine to compress trailing blanks in PRTSTRNG   *
.*                                                                            *
.*               : ISUM0000 Routine to print the invoice summary              *
.*                                                                            *
.*               : IPAG0000 Routine to paginate for the invoice summary       *
.*                                                                            *
.*  Modifications:                                                            *
.*                                                                            *
.******************************************************************************
.* V12.00.02 05/09/2025  Thanh T           TSK 0949457                        *
.*           Added LXPUSRAC-LXPUSRIL fields                                   *
.* V12.00.01 23/05/2025  Ebon Clements     TSK 0955096                        *
.*           Alphanueric visit number changes                                 *
.******************************************************************************
.*  V11.04.05 05/08/2024  Ebon Clements     TSK 0893817                       *
.*            Added test for blank op booking practice count - SEVA4000       *
.*  V11.04.04 22/07/2024  Thanh T           TSK 0939648                       *
.*            Added LXPXSN18-LXPXSN30 fields                                  *
.*  V11.04.03 15/04/2024  Sunny            TSK 0893817                        *
.*            Changed SEVA4000 - new business rules priority to practice      *
.*  V11.04.02 27/11/2023  Peter Vela     TSK 0935874                          *
.*            Added validation for PTCNUNET = 3                               *
.*  V11.04.01 14/11/2023  Sunny            TSK 0893817                        *
.*            Changed SEVA4000                                                *
.******************************************************************************
.*  V11.02.04 11/10/2022  Sunny            TSK 0924324                        *
.*            Commented out call to CASE0000 for %rggpad4 (RGGPADD4),         *
.*            %rfgrad4 (RFGPADD4), %rgprca4 (RGPRSAD4), %rfprca4 (RFPRSAD4)   *
.*  V11.02.03 13/09/2022  Sunny            TSK 0924324                        * 
.*            Commented out call to CASE0000 for %paddd (LXPADDD)             *
.*  V11.02.02 20/04/2022  Thanh T          TSK 090345                         *
.*            Changed MOD4500 to add variable 604 to 609 for Identifying      *
.*            gender/pronoun and free text fields                             *
.*  V11.02.01 01/04/2022  Sunny            TSK 0899125                        *
.*            Added %dayshort, %mthshort                                      *
.******************************************************************************
.*  V11.01.02 27/09/2021  Sunny            TSK 0893817                        *
.*            Added %ogpcdes (Letter GP Contact Method Description)           *
.*  V11.01.01 28/07/2021  Sunny            TSK 0893817                        *
.*            1) Added vars 577 - 599                                         *
.*            2) Added SEVA4000 - to populate the GP and Practice Letter var  *
.*            3) Added VBOC0000 - to move OTBCRDAT to letter var              *
.******************************************************************************
.*  V11.00.04 17/12/2020  Ebon Clements    TSK 0900728                        *
.*            Added %reshfday (576) - Rescheduled from appointment day        *
.*            SULD10000                                                       *
.*  V11.00.03 15/07/2020  Tracey Nguyen    TSK 0893621                        *
.*            Added %smsusrnm (LCCSMSUN/LXXSMSUN)                             *
.*  V11.00.02 08/04/2020  Thanh T            TSK 0879163                      * 
.*            Changed GOTP0100 for Sex category changes                       *
.*  V11.00.01 23/03/2020  Peter Vela         TSK 0889143                      *
.*            Fixed OUTLET IO calls                                           *
.******************************************************************************
.*  V10.15.03 05/12/2019  Thanh T.           TSK 0885188                      *
.*            Initialise LXNRNAM to 60 spaces                                 *
.*  V10.15.02 29/11/2019  Ebon Clements      TSK 0861253                      *
.*            Added PRNTLONG print long line functionality for telehealth     *
.*  V10.15.01 15/10/2019  Richa Phogat       TSK 0861253                      *
.*            Added OTHI0000: LXSTCODE, LXSTDESC, LXRESITE, LXRECODE, LXREADDR*
.*            LXWRMURL, LXRECPHN, LXALLNTS                                    *
.******************************************************************************
.*  V10.14.05 06/08/2019  Thanh T.           TSK 0867186                      *
.*            Changed PRIN0000 to fix the issue with LXSMSCOD not updating    *
.*            for the first send sms message                                  *
.*  V10.14.04 25/07/2019  Sunny              TSK 0877616                      *
.*            Recompiled for OTBBSRVD - Service delievery description         *
.*  V10.14.03 10/07/2019  Ebon Clements     TSK 0872962                       *
.*            Added trap around OP letter history write - PRIN9400            *
.*  V10.14.02 04/06/2019  Nicole Torrisi    TSK 0870873                       *
.*            Added Reason for Reschedule LXOPRSCH                            *
.*  V10.14.01 12/03/2019  Nicole Torrisi    TSK 0870242                       *
.*            Changed order of LXDRDFLT/LXDRSEEN (MOD4500)                    *
.*  V10.12.01 12/07/2018  Ania P            TSK 0842942                       *
.*            Added LXDRDFLT/LXDRSEEN                                         *
.*  V10.11.04 27/12/2017  Thanh T.          TSK 0849654                       *
.*            Added LXRESFTM                                                  * 
.*  V10.11.03 28/08/2017  Thanh T.          TSK 0821710                       *
.*            Audit Amission/outpatient visit comments                        * 
.*  V10.11.02 11/08/2017  Ania P            TSK 0843055                       *
.*            Removed buggy write of doctor to clinic description             *
.*  V10.11.01 17/07/2017  Ebon Clements     TSK 0817112                       *
.*            Added LXRGPGTL to LXRGPPPC linked referal GP and Practice       *
.******************************************************************************
.*  V10.10.02 25/05/2017  Richa Phogat      TSK 0830804                       *
.*            Added LXSRVDCD & LXSRVDDC - Service Delivery Mode letter fields *
.*  V10.10.01 23/03/2017  Thanh T.          TSK 0832066                       *
.*            Changed DVA Card Number and DVA Card colour to be collected     * 
.*            from PMCDCNUM.PMSCCDFD and PMCDDVAC.PMSPX2FD instead of         *
.*            PREPAT.PMIMA1FD and PMPXDVAC.PMIMA1FD                           *
.*  V10.08.05 20/09/2016  Ebon Clements     TSK 0294154                       *
.*            Modified PRIN0000 to check OTLTCOMM                             *
.*  V10.08.04 16/09/2016  Ebon Clements     TSK 0823657                       *
.*            Use slot template header hospital id - GCMA0000                 *
.*  V10.08.03 14/09/2016  Don Nguyen        TSK 0294154                       *
.*            Modified PRIN0000 to not print unnecessary blank lines (PAGE0000)
.*  V10.08.02 23/08/2016  Peter Vela        TSK 0822268                       *
.*            Fixed key pack in SULD1000 for RDCLIA1                          *
.*  V10.08.01 20/07/2016  Don Nguyen        TSK 0294154                       *
.*            Added PRSMSH00 & PRSMSF00 - print SMS metatags (XML)            *
.******************************************************************************
.*  V10.07.02 12/02/2016  Ebon Clements     TSK 0294154                       *
.*            Added %smsid, %smscode, %smskey, %smsurno, %smsuser,            *
.*            %smsphone                                                       *
.*  V10.07.01 23/12/2015 Peter Vela     CAR 0324687                           *
.*            Added PMI defaults for postal address if empty                  *
.*  V10.06.02 11/05/2015 Ebon Clements  CAR 298921                            *
.*            Changes to use OUTCLIFD index 1 instead of index 2              *
.*  V10.06.01 30/04/2015  Ebon Clements CAR 314829                            *
.*            Don't change case of clinic instructions and comments           *
.*  V10.05.01 13/10/2014  Ania P        CAR 303879                            *
.*            Added HP code output                                            *
.*  V10.04.01 21/02/2014  Don Nguyen    CAR 291879                            *
.*            Added field 543 (LXIHINUM) - IHI Number                         *
.*  V10.03.10 12/11/2013 Davin           CAR 292499                           *
.*            Added fields 533 - 542 (series booking day of week)             *
.*  V10.03.09 05/07/2013 Don Nguyen      CAR 287965                           *
.*            Added RDPMPX21 call after RDMAST1 at SEVA0070                   *
.*  V10.03.08 02/07/2013 Peter Vela      CAR 286022                           *
.*            Commented out call to CASE0000 for %title %sname %adda %addb    *
.*            %addc                                                           *
.*  V10.03.07 23/04/2013 Ebon Clements   CAR 277862                           *
.*            Fixed printing of location type variable                        *
.*  V10.03.06 20/03/2013 Ania P          CAR 281663                           *
.*            Added vars 531-541 inclusive.                                   *
.*  V10.03.05 03/12/2012 Peter Vela      CAR 262297                           *
.*            Added patient instructions viscmtaf 013                         *
.*  V10.03.04 05/09/2012 Peter Vela      CAR 271262                           *
.*            Added SP70 to PACK statement @ GOTP1200                         *
.*  V10.03.03 25/05/2012 Ebon Clements   CAR 236299                           *
.*            Added clinic indicator variable                                 *
.*  V10.03.02 30/01/2012 Davin           CAR 257512                           *
.*            Added field 525 - patient long surname                          *
.*  V10.03.01 10/11/2011  Ebon Clements  CAR 248529                           *
.*            Added multiple contacts of the same type functionality          *
.*  V10.02.06 20/09/2011  Davin          CAR 248749                           *
.*            Added tags 440 to 524                                           *
.*  V10.02.05 10/09/2011  Peter McMullen CAR 248749                           *
.*            Added tags 437 to 439                                           *
.*  V10.02.04 01/07/2011  Ebon Clements  CAR 242246                           *
.*            Added clinic phone number                                       *
.*  V10.02.03 08/06/2011  Ebon Clements  CAR 239530                           *
.*            Added print extra contact functionality                         *
.*  V10.02.02 30/05/2011  Ebon Clements  CAR 239554                           *
.*            Added printed by to OP letter history                           *
.*  V10.02.01 06/04/2011  Ebon Clements  CAR 233251                           *
.*            Remove 1 character of white space after %boldon & %ulineon      *
.*  V10.01.01 08/02/2011 Ebon Clements   CAR 233251                           *
.*            Added % bold and underline variables                            *
.*  V10.00.01 01/03/2010  Ebon Clements  CAR 226850                           *
.*            Read HCP file of no doctor record for OCADOCT                   * 
.*        V9.12.01  12/05/2009  Saroeun Soeur      CAR 196152                 *
.*                   fixed doctor title, gname and surname to use             * 
.*                  OCADOCT if exist                                          *
.******************************************************************************
.*        V9.11.02  11/11/2008  Steve Armstrong    CAR 179910                 *
.*                  Added SEVA2500 label to load practice variables if the    *
.*                  referring GP code is blank.                               *
.*        V9.11.01  31/10/2008  Sandra Barcham     CAR 178932                 *
.*                  Extend LXPCNAME from 20 to 60 characters                  *
.******************************************************************************
.*        V9.09.05  07/03/2008  Jill Habasque      CAR 163399                 *
.*                  Commented out move of TOPMARG to PHYSPAGE in PRIN9000     *
.*        V9.09.04  22/01/2008  Ebon Clements      CAR 157297                 *
.*                  Print reg gp practice details even if no reg gp SEVA0500  *
.*        V9.09.03  12/12/2007  Ebon Clements      CAR 157081                 *
.*                  Added patient e-mail address                              *
.*        V9.09.02  04/12/2007  Peter McMullen     CAR 137137                 *
.*                  Add TEMPCLDR for raw clinic description                   *
.*        V9.09.01  24/10/2007  Mike Laming        CAR 131844                 *
.*                  Correct all HCP Addresses and Practice Addresses, general *
.*                  clean up and remove code used for OUT33                   *
.******************************************************************************
.*        V9.08.02  19/10/2007  Mike Laming        CAR 152340                 *
.*                  Add code to populate TEMPSITE (Site Desc.) at             *
.*        V9.08.01  15/05/2007  Ebon Clements      CAR 131843                 *
.*                  Default referral letter referring GP practice address     *
.*                  variables with the hcp address                            *
.******************************************************************************
.*        V9.07.05  18/09/2006  Ebon Clements      CAR 89365                  *
.*                  Added rescheduled from clinic description                 *
.*        V9.07.04  01/09/2006  Peter Vela         CAR 114297                 *
.*                  Added DVA card Number                                     *
.*                  Added Pension Number                                      *
.*                  Added Patient mobile Number                               *
.*                  Added Patient Preferred Language                          *
.*        V9.07.03  25/07/2006  Ebon Clements      CAR 99899                  *
.*                  Added extra screen cat codes OTXSCO01 to OTXSCO20         *
.*        V9.07.02  20/06/2006  Peter Vela         CAR 108110                 *
.*                  Added Preferred Method of Contact for: PMPXRHC1           *
.*                  Added Preferred Method of Contact and Email Address for:  *
.*                  OBADOCT, OTBBRFGP, OTRLRFGP, OTRLRDOC, OTRLCONS, OTRLRHCP *
.*        V9.07.01  21/06/2006  Ebon Clements CAR 105627                      *
.*                  Mods to allow UNIX letters to trigger multiple vcq letters*
.******************************************************************************
.*        V9.06.04  31/05/2006  Peter Vela    CAR 106057                      *
.*                  Added Next of Kin Relationship Description                *
.*        V9.06.03  30/05/2006  Peter Vela    CAR 104807                      *
.*                  Added Clinic Type Code                                    *
.*                  Added Cancelled Visit Type                                *
.*                  Added Visit Type Code                                     *
.*                  Added Visit Type Description                              *
.*        V9.06.02  23/05/2006  Ebon Clements CAR 792776                      *
.*                  Print postal/pmi address on carer label if carer details  *
.*                  blank                                                     *
.*        V9.06.01  28/04/2006  Peter Vela         CAR 102166                 *
.*                  Changed title code to title description                   *
.******************************************************************************
.*        V9.05.02  29/03/2006  Peter Vela         CAR 85995                  *
.*                  Changed LXSBTM01-10 to initialise to length of 8          *
.*        V9.05.01  24/03/2006  Ebon Clements      CAR 79277                  *
.*                  Added carer contact letter variables                      *
.******************************************************************************
.*        V9.04.14  03/11/2005  Peter Vela         CAR 79842                  *
.*                  Added Emergency Contact Mobile number                     *
.*                  Added Emergency Contact Email Address                     *
.*                  Added Nearest Relative Mobile Number                      *
.*                  Added Nearest Relative Email Address                      *
.*        V9.04.13  19/10/2005  Peter Vela    CAR 80192                       *
.*                  Added Next of Kin emergency contact variables             *
.*        V9.04.12  07/10/2005  Peter Vela    CAR 79300                       *
.*                  Removed open of outcanaf and placed in OUTWEB03, IBAOUT71 *
.*                  and IBOUT33                                               *
.*        V9.04.11  30/08/2005  Peter Vela    CAR 62749                       *
.*                  Added variables from OUTCANFD Outpatient Booking          *
.*                  Cancellation                                              *
.*        V9.04.10  24/08/2005  Jill Habasque CAR 72777                       *
.*                  Add all %respxxxx variables - Responsible HCP             *
.*        V9.04.09  09/08/2005  Peter Vela   CAR 67204                        *
.*                  Add variable "%otgpprcd" Local GP Practice Code           *
.*                  Add variable "%rfprca5" Ref. GP Address Line 5            *
.*                  Add variable "%rfprca6" Ref. GP Address Line 6            *
.*                  Add variable "%rfgptel" Ref. GP Telephone Number          *
.*                  Add variable "%rfgpmob" Ref. GP Mobile Number             *
.*                  Add variable "%rfgppag" Ref. GP Pager Telephone Number    *
.*                  Add variable "%rfgppgn" Ref. GP Pager Number              *
.*                  Add variable "%rfgpprv" Ref. GP Provider Number           *
.*        V9.04.08  20/07/2005  Peter Vela   CAR 63023                        *
.*                  Add variable "pxfaxn" Local GP Practice Fax Number        *
.*                  Add variable "pxseml" Local GP Practice Email Address     *
.*        V9.04.07  14/06/2005  Peter Vela   CAR 58732                        *
.*                  Add variable "otpudf1" Presenting Complaint               *
.*                  Add variable "otdiacd1" Diagnosis Code 1                  *
.*                  Add variable "otdiads1" Diagnosis Desc 1                  *
.*                  Add variable "otdiacd2" Diagnosis Code 2                  *
.*                  Add variable "otdiads2" Diagnosis Desc 2                  *
.*                  Add variable "otdiacd3" Diagnosis Code 3                  *
.*                  Add variable "otdiads3" Diagnosis Desc 3                  *
.*                  Add variable "otdiacd4" Diagnosis Code 4                  *
.*                  Add variable "otdiads4" Diagnosis Desc 4                  *
.*                  09/06/2005  Peter Vela   CAR 62622                        *
.*                  Add variable "rflpdsc" Referral Let Priority Desc         *
.*        V9.04.06  27/04/2005  Peter Vela   CAR 57513                        *
.*                  Fixed %rflcldes                                           *
.*        V9.04.05  24/03/2005  Peter Vela   CAR 59546                        *
.*                  Add variable "ottacclm" Outpatient TAC Claim Number       *
.*                  Add variable "ottacdat" Outpatient TAC Date of Accident   *
.*                  Add variable "otwrkdat" Outpatient Work Cover Date of Acc *
.*                  Add variable "otcontyp" Outpatient Concession Card Type   *
.*                  Add variable "otcontyd" Outpatient Con Card Type Desc     *
.*                  Add variable "otconnum" Outpatient Concession Card Number *
.*                  Add variable "otcondat" Outpatient Concession Card Expiry *
.*        V9.04.04  18/03/2005  Peter Vela   CAR 59618                        *
.*                  Add variable "%rfhpra2" Referral Letter HCP Practice      *
.*                  Address Line 2                                            *
.*                  Add variable "%rfhpra3" Referral Letter HCP Practice      *
.*                  Address Line 3                                            *
.*                  Add variable "%rfhpra4" Referral Letter HCP Practice      *
.*                  Address Line 4                                            *
.*                  Add variable "%rfhpra5" Referral Letter HCP Practice      *
.*                  Address Line 5                                            *
.*                  Add variable "%rfhpra6" Referral Letter HCP Practice      *
.*                  Address Line 6                                            *
.*                  Add variable "%rfhprpc" Referral Letter HCP Practice      *
.*                  Post Code                                                 *
.*                  17/03/2005  Peter Vela   CAR 59277                        *
.*                  Modified CLGP0000 to have PACKs instead of MOVEs          *
.*                  09/03/2005  Peter Vela   CAR 57244                        *
.*                  Add variable "%otclmcd" Outpatient Claim Code             *
.*                  Add variable "%otclcdd" Outpatient Claim Code Desc        *
.*        V9.04.03  13/01/2005  Peter Vela   CAR 55313                        *
.*                  Add variable "%rfhprnm" HCP Practice Name Referral Letter *
.*                  Add variable "%rfhprph" HCP Practice Phone No Ref Letter  *
.*                  Add variable "%rfhprfx" HCP Practice Fax Number Ref Lett  *
.*        V9.04.02  23/09/2004  Peter Vela    CAR 53708                       *
.*                  Added GP Fax Number                                       *
.*        V9.04.01  31/08/2004  Guomin Fu     CAR 40390                       *
.*                  Add logic for new variables LXOZATTO and LXDODSCH         *
.******************************************************************************
.*        V9.03.10  30/06/2004  Mike Laming   CAR 40390                       *
.*                  Add logic for new variables LXBBTRAN and LXBBDNAR         *
.*        V9.03.09  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      *
.*                  - Add Sex Description routine SEXDSC00 with Code "R" -    *
.*                  "Intersex" added                                          *
.*        V9.03.08  13/05/2004 Ebon Clements      CAR 48720                   *
.*                  Added create form referral letter printing LETEXR00       *
.*        V9.03.07  12/05/2004 Ebon Clements      CAR 49743                   *
.*                  Visit comments are now in PATCMNFD not OUTXWPFD           *
.*        V9.03.06  15/03/2004  Guomin Fu       CAR 47288                     *
.*                  Fixed layout of outpatient letter printing                *
.*        V9.03.05  09/02/2004  Sylvek Litewka  CAR 47000                     *
.*                  Modified procedure SEVA0000 to cater for Outpatient       *
.*                  Referral related letters.                                 *
.*        V9.03.04  15/12/2003  Peter Vela    CAR 45249                       *
.*                  Modified to get age from current date instead of PSAGE    *
.*        V9.03.03  11/12/2003  Ebon Clements CAR 45549                       *
.*                  Mods for OUTRF1FD - change from doctors file to hcp file  *
.*        V9.03.02  25/09/2003  Ebon Clements CAR 41801                       *
.*                  Added new variable for series bookings                    *
.*        V9.03.01  26/06/2003  CAR 39819  Mike Laming                        *
.*                  Added new variable "%rflcldes" Referral Clinic Descrip'n  *
.*                  and code to read Clinic Type Table - for Referral Letters *
.******************************************************************************
.*        V9.02.07  09/04/2003  Ebon Clements CAR 38132                       *
.*                  Changes SFORMAT from 80 back to 127 to fix vcq reporting  *
.*                  New variable VARD127 to fix WEB and character conflict    *
.*        V9.02.06  20/11/2002  J.Tan                                         *
.*                  Fixed SFORMAT to 80 instead of 127                        *
.*        V9.02.05  21/03/2002  Ebon Clements                                 *
.*                  Added new variable Local GP format name                   *
.*        V9.02.04  15/02/2002  Bronko sosic                                  *
.*                  Removed IDDD from GOTP1200 and used variable SITE         *
.*        V9.02.03  17/01/2002  Ebon Clements                                 *
.*                  Removed IDDD from GOTP1200 and used variable SITE         *
.*        V9.02.02  11/01/2002  Ebon Clements                                 *
.*                  Added new variables from outpatient clinic master file    *
.*        V9.02.01  06/09/2001  Ebon Clements                                 *
.*                  Added new variables to letter printing                    *
.******************************************************************************
.*        V5.09.B02 13/07/2001  Sandra Barcham                                *
.*                  Replace GP with HCP                                       *
.*        V5.09.B01 15/12/2000  Dean Cramer                                   *
.*                  Mods to for use by OUT33 - referal letter production.     *
.*                  Accesses referal file for refering GP and GP practice     *
.*                  details in routine SEVA0000 and avoid access of booking   *
.*                  files.                                                    *
.******************************************************************************
.*        V5.08.01  01/09/2000  Tonii                                         *
.*                  Mods to accept Unknown and Indeterminate as valid patient *
.*                  sex description                                           *
.******************************************************************************
.*        V5.08.B02  16/03/2000  Steve Armstrong     5.08 Mods                *
.*                   Mods for changes to OUTCLIFD (effective date)            *
.*        V5.08.B01  02/03/2000  Tonii   SRF 637683                           *
.*                   Fixed missing zero in the year field                     *
.******************************************************************************
.*        V5.07.00  15/10/98 Jim Stathopoulos                                 *
.*                  507 Changes                                               *
.******************************************************************************
.*        V5.04.03  25/06/97 J.Tan                                            *
.*                  Mods slot time to a 12 clock with AM/PM                   *
.*        V5.04.02  15/05/97 J.Tan     SRF 620066                             *
.*                  Mods booking time to a 12 clock with AM/PM                *
.*        V5.04.01  25/03/1997  Greg Horvat      SRF 617348                   *
.*                  Added %xscdccd - xtra screen doctor 1 code                *
.*                  Added %xscdcpn - xtra screen doctor 1 provider no         *
.*                  Added %xscrfdt - xtra screen referral date 1              *
.*        V5.03.03  14/11/1995    Justin Coates  (SUHT mods)                  *
.*                  added new variables and allow for 2 types of standard     *
.*                  re-schedule letters                                       *
.*        V5.03.02  02/10/1995    Max White  SRF 441372                       *
.*                  Fix Appointment Date Variables when Referring GP Practice *
.*                  is invalid.                                               *
.*        V5.03.01  10/07/1995    Max White  SRF 441324 / Quote 440069        *
.*                  Added %day     - clinic day (Monday, Tuesday ..)          *
.*                        %cldate  - clinic date (1st, 2nd ...)               *
.*                        %month   - clinic month (January, February ..)      *
.*                        %year    - clinic century & year (1995 ...)         *
.*                        %loctype - clinic location type                     *
.*                        %locn    - clinic location                          *
.******************************************************************************
.*        V5.02.01  04/01/1995  Graeme Williams                               *
.*                  Always read in clinic master in SEVA0000, even if not     *
.*                  multi-hospital                                            *
.*        V5.02.02  31/01/1995  whirlpool                                     *
.*                  fixed endless loop in MOD0000                             *
.******************************************************************************
.*        V5.01.01  15/06/93    WHIRLPOOL   SRF 123130/440142                 *
.*                  Problem with Hospital details etc                         *
.*        V5.01.02  17/06/93  WHIRLPOOL        SRF 1440127                    *
.*                  changed key and set additional fields for OUTLHIFD        *
.*        V5.01.03  22/07/93  WHIRLPOOL                                       *
.*                  Cleared PTHSNAME and changed call to GRHSP000             *
.*        V5.01.04  27/09/1993 LOFTY SRF 440391                               *
.*                  remove check for no lines printed at PRIN9000             *
.*                  error message at PRIN9500 to print LETTFORM               *
.*                  SUSL0000 to ignore ZERO letters                           *
.*        V5.01.05  29/09/1993 LOFTY                                          *
.*                  change back to use old letter history file                *
.*        V5.01.06  01/10/1993 LOFTY                                          *
.*                  check for zero letter properly                            *
.*        V5.01.07  28/10/1993 ROD                                            *
.*                  change back to use New letter history file                *
.*        V5.01.08  15/12/1993 ROD                                            *
.*                  add GP Practice address vars                              *
.*        V5.01.09  10/01/1994    LOFTY                                       *
.*                  added changes DEON made on 22/09/93 which have been lost  *
.*                  due to multiple copies of include                         *
.*                  if certain PMI details are blank, dont put ****           *
.*                  also added the CLGP routine from OUT71                    *
.******************************************************************************

.************************************************************************
.*                          VBOA0000                                    *
.*            move bokb details to tempfile variables                   *
.************************************************************************
VBOA0000  MATCH     ZEROVISN,OBAOUTNO 
          IF        @EQUAL
            MOVE      OTLPBOOK,TEMPOUTN     * if there is no booking number
          ELSE
            MOVE      OBAOUTNO,TEMPOUTN     * get from outlpcaf
          ENDIF
.
          MATCH     "       0",OBAURNO
          IF        @EQUAL
            MOVE      OTLPURNO,TEMPURNO     * if there is no urno number
          ELSE
            MOVE      OBAURNO,TEMPURNO      * get from outlpcaf
          ENDIF
.
          MOVE      OBAATTN,TEMPATTD        * use desc var to pass code to
.                                           * common sub-routine to read codes
          MOVE      OBADATE,WORKDATE
          MOVE      OBADATE,TEMPDATE        * Clinic Date
          CALL      FDAT0000                * format attendence date
          MOVE      DATELINE,TEMPATDT       
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,TEMPATDS
.
          MOVE      OBATIME,WORKTIME
          CALL      TIME0000                * format attendence time
          MOVE      FRMTTIME,TEMPATTM 
.
          MOVE      OBACTYP,TEMPCTYP        * pass clinic type
          MOVE      OBACOMP,TEMPCOMP        * pass comp. eligib.
          MOVE      OBAINS,TEMPINSR         * pass insurance status
.
          MOVE      OBACAT,TEMPPCAT         * pass patient category
          MOVE      OBACLASS,TEMPCLSS       * pass patient classification
          MOVE      OBAPRTY,TEMPPRTY        * pass patient priority
          MOVE      OBASRCR,TEMPSREF        * pass source of referral 
.
.         update values of the extra values added from OUTBOAFD
.
          UNPACK    OBABKDTE,WORKDATE,TEMPBTIM  * booking date and time
          CALL      FDAT0000                * format booking date
          MOVE      DATELINE,TEMPBKDT       * set up formatted date
.
          MOVE      TEMPBTIM,WORKTIME
          CALL      TIME0000                * format booking time
          MOVE      FRMTTIME,TEMPBTIM 
.
          MOVE      OBASLOT,TEMPSLOT        * slot 
.
          MOVE      OBATIME,TEMPSTIM        * slot time
          MOVE      TEMPSTIM,WORKTIME
          CALL      TIME0000                * format booking time
          MOVE      FRMTTIME,TEMPSTIM 
.
          MOVE      OBACLIN,TEMPCLID        * clinic id
          MOVE      OBACTYP,TEMPCLTY        * Clinic type
          MOVE      OBASTRT,TEMPSTRT        * Start time
.
          MOVE      SP30,TEMPDGNM
          UNPACK    SP30,TEMPDSNM,TEMPDTIT
          PACK      LXDEMAD,SP70,SP70
.

          PACK      KEY20,OBASITE,OBACLIN,OBADATE
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     OBASITE,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ELSE
                MATCH     OBACLIN,OCACLIN
                IF        !@EQUAL
                  MOVE      ONE,OVRCD
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          IF        OVRCD = 1
            MOVE      "Unknown clinic",OCADESC
            PACK      OCADESC,OCADESC,SP30
            GOTO      VBOA1000
          ENDIF
. 
          MOVE      OCADESC,TEMPCLDR        * save raw clinic description
.
          MATCH     SP6,OCADOCT
          GOTO      VBOA1000 IF EQUAL       * no doctor code set up
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,VBOA0500          * invalid doctor code so check HCP
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,ANS      
          MOVE      ANS,PACGNAME
          MOVE      DTITL,PACTITLE
          MOVE      DTITL,TEMPDTIT          * doctors title
          MOVE      DSNAME,TEMPDSNM         * doctor surname
          MOVE      DGNAME,TEMPDGNM         * doctor given name
          MOVE      PTDOSEML,LXDEMAD        * doctor surgery email
.
          GOTO      VBOA1000
.
VBOA0500  PACK      KEY10,OCADOCT,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,VBOA1000          * invalid hcp code
.         
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,ANS              
          MOVE      ANS,PACGNAME
          MOVE      PMHCTITL,PACTITLE          
          MOVE      PMHCTITL,TEMPDTIT          * doctors title
          MOVE      PMHCSNAM,TEMPDSNM          * doctor surname
          MOVE      PMHCGNAM,TEMPDGNM          * doctor given name
          MOVE      PMHCSEML,LXDEMAD           * doctor surgery email
.
VBOA1000  MOVE      OCADESC,TEMPCLDX        * clinic description
.
.         set up doctors name and title 
.
          MOVE      OBADOCT,KEY6
          MOVE      OBADOCT,TEMPDOCT
          CALL      RDDOCT1
          BRANCH    OVRCD,VBOA9999          * invalid doctors code
.
          MOVE      DTITL,TEMPDTIT          * doctors title
          MOVE      DSNAME,TEMPDSNM         * doctor surname
          MOVE      DGNAME,TEMPDGNM         * doctor given name
          MOVE      PTDOSEML,LXDEMAD        * doctor surgery email
.
          MATCH     SP70,PTDOCOMT
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PTDOCOMT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXDPRMC
            ELSE
              MOVE      PTDOCOMT,LXDPRMC
            ENDIF
          ENDIF
.
VBOA9999  RETURN
+
.************************************************************************
.*                          VBOC0000 - Booking file C                   *
.************************************************************************
VBOC0000  MOVE      SP70,OTBCRDAT 
          MOVE      SP70,LXBCRDAT 
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTBOC1      
          BRANCH    OVRCD,VBOC9999
.
          UNPACK    OTBCRDAT,CCENT,CYEAR,CMON,CDAY
          PACK      LXBCRDAT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR 
          GOTO      VBOC9999
.
VBOC9999  RETURN
+
.************************************************************************
.*                         GOTP0000                                     *
.*           Got a patient - put in tempfile                            *
.************************************************************************
GOTP0000  MATCH     ZEROUR,TEMPURNO
          GOTO      GOTP0010 IF EQUAL
          MOVE      TEMPURNO,KEY8
          CALL      RDMAST1                * get master details
          BRANCH    OVRCD,GOTP1000
          GOTO      GOTP0040
.
GOTP0010  MOVE      TEMPOUTN,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,GOTP1000
.
GOTP0040  
.
.------ Check if to include deceased patients -------
.
          IF        PCEASE = 1
            IF        DCEASEFL = 0
              GOTO      GOTP9999
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
.
          MATCH     SP2,CCENT
          GOTO      GOTP0050 IF NOT EQUAL
          MOVE      CCC,CCENT
.
GOTP0050  PACK      WORKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000               * format patient birthdate
          MOVE      DATELINE,TEMPBDAT
.
          MOVE      AST30,TEMPCTRY
          PACK      KEY5,CODEC,PCONT     
          CALL      RDCODE1                * get country of birth desc
          BRANCH    OVRCD,GOTP0100
          MOVE      TDESC,TEMPCTRY
.
GOTP0100  PACK      WORKDATE,CCC,CYY,CMM,CDD
          CALL      FDAT0000               * format todays date
          MOVE      DATELINE,TEMPTDAY
.
          MOVE      PSNAME,PACSNAME        * set up pack name variables
          MOVE      PGNAME,PACGNAME
.         MOVE      PTITL,PACTITLE
.
          PACK      KEY4,PTITL,SP70
          CALL      RDPMTLE1                                                  
          IF        OVRCD=0 
            MOVE      PMTLDESC,LINE                                           
            CALL      CASE0000
            MOVE      LINE,PACTITLE                                           
          ELSE   
            MOVE      PTITL,PACTITLE                                          
          ENDIF
.
          MOVE      ONE,PACFRMT
          CALL      PACNAME                * format patients name
          MOVE      PACFNAME,TEMPNAME
          MOVE      TEMPNAME,LINE
          CALL      CASE0000               * convert to lower case
          MOVE      LINE,TEMPNAME
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00               
          MOVE      DSEXASC1,TEMPPSEX
.
GOTP1000  MATCH     SP20,TEMPATTD          * any attendence code
          GOTO      GOTP1100 IF EQUAL
.
          PACK      KEY5,CODECA,TEMPATTD   * I realize that tempattd is a dim20
.                                          * but the first three characters are
.                                          * the attendence code set up in vboa
.                                          * the same for the other following
.                                          * codes file things
          CALL      RDCODE1
          BRANCH    OVRCD,GOTP1100
          MOVE      TDESC,TEMPATTD
          GOTO      GOTP1200
.
GOTP1100  MOVE      AST30,TEMPATTD
.
GOTP1200  MATCH     SP20,TEMPCTYP          * any clinic type code
          GOTO      GOTP1300 IF EQUAL
.
          PACK      KEY12,SITE,TEMPCTYP,SP70   
          CALL      RDCTYA1                * get clinic type desc.
          BRANCH    OVRCD,GOTP1300
          MOVE      OCTDESC,TEMPCTYP
          GOTO      GOTP1400
.
GOTP1300  MOVE      AST30,TEMPCTYP
.
GOTP1400  
          MATCH     SP20,TEMPCOMP          * any comp. eligib. code
          GOTO      GOTP1500 IF EQUAL
.
          PACK      KEY5,CODECL,TEMPCOMP   
          CALL      RDCODE1                * get comp eligib
          BRANCH    OVRCD,GOTP1500
          MOVE      TDESC,TEMPCOMP
          GOTO      GOTP1600
.
GOTP1500  MOVE      AST30,TEMPCOMP
.
GOTP1600  
          MATCH     SP20,TEMPINSR          * any insurance status code
          GOTO      GOTP1700 IF EQUAL
.
          PACK      KEY5,CODEU1,TEMPINSR   
          CALL      RDCODE1                * get insurance status
          BRANCH    OVRCD,GOTP1700
          MOVE      TDESC,TEMPINSR
          GOTO      GOTP1800
.
GOTP1700  MOVE      AST30,TEMPINSR
.
GOTP1800  
          MATCH     SP20,TEMPPCAT          * any patient category
          GOTO      GOTP1900 IF EQUAL
.
          PACK      KEY5,CODEP,TEMPPCAT   
          CALL      RDCODE1                * get patient category
          BRANCH    OVRCD,GOTP1900
          MOVE      TDESC,TEMPPCAT
          GOTO      GOTP2000
.
GOTP1900  MOVE      AST30,TEMPPCAT
.
GOTP2000  MATCH     SP20,TEMPCLSS          * any patient classification
          GOTO      GOTP2100 IF EQUAL
.
          PACK      KEY5,CODEA,TEMPCLSS   
          CALL      RDCODE1                * get patient classification
          BRANCH    OVRCD,GOTP2100
          MOVE      TDESC,TEMPCLSS
          GOTO      GOTP2200
.
GOTP2100  MOVE      AST30,TEMPCLSS
.
GOTP2200  MATCH     SP20,TEMPPRTY          * any patient priority  
          GOTO      GOTP2300 IF EQUAL
.
          PACK      KEY5,CODEPR,TEMPPRTY   
          CALL      RDCODE1                * get patient priority  
          BRANCH    OVRCD,GOTP2300
          MOVE      TDESC,TEMPPRTY
          GOTO      GOTP2400
.
GOTP2300  MOVE      AST30,TEMPPRTY
.
GOTP2400  MATCH     SP20,TEMPSREF          * souce of referral
          GOTO      GOTP2500 IF EQUAL
.
          PACK      KEY5,OSTCATG,TEMPSREF   
          CALL      RDCODE1                * get source of referral
          BRANCH    OVRCD,GOTP2500
          MOVE      TDESC,TEMPSREF
          GOTO      GOTP3000
.
GOTP2500  MOVE      AST30,TEMPSREF
.
GOTP3000  ADD       ONE,PATCOUNT
..          DISPLAY   *V2LON,*P70:24,PATCOUNT
          MOVE      FALSE,EXIT
.
GOTP9999  RETURN
+
.**********************************************************************
.*                  SEVA0000                                          *
.*             Set up the values for all the "%" variables            *
.**********************************************************************
SEVA0000  MOVE      FALSE,CEXIT
.
          CALL      CLRV0000                * initialise var's
..          DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
.
          MATCH     "R",LTTYPIND            * Outpatient Referral letter?
          GOTO      SEVA0020 IF EQUAL
.
          CALL      GCMA0000
          MOVE      EXIT,CEXIT
.         BRANCH    EXIT,SEVA9999
.
SEVA0020  IF        IBCNMHOS = 1
            CALL      SHSP0000              * set up the hospital params
          ENDIF
.
.------ read files to get values of other % variables ------
.------   not already formatted -------
.
SEVA0050  ADD       ONE,COUNTER
.
SEVA0070  MATCH     ZEROUR,TEMPURNO
          GOTO      SEVA0080 IF EQUAL        * on pre-admiss file
.
          CALL      CLNK0000                * Clear Other Contact variables
.
          MOVE      TEMPURNO,KEY8
          CALL      RDMAST1                 * read master file
          BRANCH    OVRCD,SEVA0080
.
          MOVE      TEMPURNO,KEY8
          CALL      RDPMPX21                * read master extn file
          BRANCH    OVRCD,SEVA0080
.
          MOVE      PTMASNAM,LXPTLSNM       * Patient Long Surname
.
          CALL      PMAST000
.
          MOVE      "C",CONTTYPE            * Carer Details
          CALL      XCON0000                * Get extra contact details
          MOVE      PMCESNAM,PACSNAME       * Carer Details
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXPCNAME
          MOVE      PMCETITL,LXPCTITL
          MOVE      PMCESNAM,LXPCSNAM
          MOVE      PMCEGNAM,LXPCGNAM
          MOVE      PMCEGNM2,LXPCGNM2
          MOVE      PMCEADD1,LXPCADD1
          MOVE      PMCEADD2,LXPCADD2
          MOVE      PMCEADD3,LXPCADD3
          MOVE      PMCEADD4,LXPCADD4
          MOVE      PMCEPOST,LXPCPOST
          MOVE      PMCETELP,LXPCTELP
          MOVE      PMCETELB,LXPCTELB
          MOVE      PMCETELM,LXPCTELM
          MOVE      PMCERELP,LXPCRELP
          MOVE      PMCEEMAI,LXPCEMAI
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE     DYES,LXPCSLET
          ELSE
            MOVE     DNO,LXPCSLET
          ENDIF
.>>>>
          MOVE      "7",CONTTYPE            * Local Address Type
          CALL      XCON0000                * Get extra contact details
          MOVE      PMCESNAM,PACSNAME
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXPLNAME       * Local Address Details
          MOVE      PMCETITL,LXPLTITL
          MOVE      PMCESNAM,LXPLSNAM
          MOVE      PMCEGNAM,LXPLGNAM
          MOVE      PMCEGNM2,LXPLGNM2
          MOVE      PMCEADD1,LXPLADD1
          MOVE      PMCEADD2,LXPLADD2
          MOVE      PMCEADD3,LXPLADD3
          MOVE      PMCEADD4,LXPLADD4
          MOVE      PMCEPOST,LXPLPOST
          MOVE      PMCETELP,LXPLTELP
          MOVE      PMCETELB,LXPLTELB
          MOVE      PMCETELM,LXPLTELM
          MOVE      PMCERELP,LXPLRELP
          MOVE      PMCEEMAI,LXPLEMAI
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE     DYES,LXPLSLET
          ELSE
            MOVE     DNO,LXPLSLET
          ENDIF
.
          MOVE      "9",CONTTYPE            * Other Contact Type
          CALL      XCON0000                * Get extra contact details
          MOVE      PMCESNAM,PACSNAME
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXPONAME       * Other Contact Details
          MOVE      PMCETITL,LXPOTITL
          MOVE      PMCESNAM,LXPOSNAM
          MOVE      PMCEGNAM,LXPOGNAM
          MOVE      PMCEGNM2,LXPOGNM2
          MOVE      PMCEADD1,LXPOADD1
          MOVE      PMCEADD2,LXPOADD2
          MOVE      PMCEADD3,LXPOADD3
          MOVE      PMCEADD4,LXPOADD4
          MOVE      PMCEPOST,LXPOPOST
          MOVE      PMCETELP,LXPOTELP
          MOVE      PMCETELB,LXPOTELB
          MOVE      PMCETELM,LXPOTELM
          MOVE      PMCERELP,LXPORELP
          MOVE      PMCEEMAI,LXPOEMAI
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE     DYES,LXPOSLET
          ELSE
            MOVE     DNO,LXPOSLET
          ENDIF
.
          MOVE      "1",CONTTYPE            * NOK2 Contact Type
          CALL      NOK20000                * Get NOK2 contact details
          MOVE      PMCESNAM,PACSNAME
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXP2NAME       * NOK2 Contact Details
          MOVE      PMCETITL,LXP2TITL
          MOVE      PMCESNAM,LXP2SNAM
          MOVE      PMCEGNAM,LXP2GNAM
          MOVE      PMCEGNM2,LXP2GNM2
          MOVE      PMCEADD1,LXP2ADD1
          MOVE      PMCEADD2,LXP2ADD2
          MOVE      PMCEADD3,LXP2ADD3
          MOVE      PMCEADD4,LXP2ADD4
          MOVE      PMCEPOST,LXP2POST
          MOVE      PMCETELP,LXP2TELP
          MOVE      PMCETELB,LXP2TELB
          MOVE      PMCETELM,LXP2TELM
          MOVE      PMCERELP,LXP2RELP
          MOVE      PMCEEMAI,LXP2EMAI
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE     DYES,LXP2SLET
          ELSE
            MOVE     DNO,LXP2SLET
          ENDIF
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPNKNME
            MOVE      LXPNKNME,LINE
            CALL      CASE0000               * convert to lower case
            MOVE      LINE,LXPNKNME
            MOVE      PMCETITL,LXP1TITL     * title
            MOVE      PMCESNAM,LXP1SNAM     * surname
            MOVE      PMCEGNAM,LXP1GNAM     * given name 1
            MOVE      PMCEGNM2,LXP1GNM2     * given name 2
            MOVE      PMCEADD1,LXPNKAD1
            MOVE      PMCEADD2,LXPNKAD2
            MOVE      PMCEADD3,LXPNKSUB
            MOVE      PMCEADD4,LXPNKAD4
            MOVE      PMCEPOST,LXPNKPST
            MOVE      PMCERELP,LXPNKRLP
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP1SLET
            ELSE
              MOVE     DNO,LXP1SLET
            ENDIF
          ELSE
            MOVE      PNKNAME,LXPNKNME
            MOVE      LXPNKNME,LINE
            CALL      CASE0000               * convert to lower case
            MOVE      LINE,LXPNKNME
            MOVE      PNKADD1,LXPNKAD1
            MOVE      PNKADD2,LXPNKAD2
            MOVE      PNKSUBR,LXPNKSUB
            MOVE      PNKADD4,LXPNKAD4
            MOVE      PNKPOST,LXPNKPST
            MOVE      PNKRELP,LXPNKRLP
          ENDIF
.
          MOVE      TEMPURNO,PURNO
          MOVE      ONE,FORM2
          MOVE      THREE,DIM1                  * set for DVA card type
          CALL      GCCARD00                    * get DVA card details
          MOVE      PMCDCNUM,LXPXDVAN
          MOVE      PPENNO,LXPAPENN
          MOVE      PTMXCELL,LXPXPMBN
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
            MOVE      PMRLDESC,LXPNKRLD
          ELSE
            PACK      KEY10,PNKRELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PNKRELP,PMRLDESC
            ENDIF
            MOVE      PMRLDESC,LXPNKRLD
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,LXPNKTLP
            MOVE      PMCETELB,LXPNKTLB
          ELSE
            MOVE      PNKTELP,LXPNKTLP
            MOVE      PNKTELB,LXPNKTLB
          ENDIF
.
          MOVE      TEMPURNO,KEY8
          CALL      RDPMPX21                * read master extn file
          IF        OVRCD = 0
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "4",CONTTYPE          * Mother
              CALL      XCON0000              * Get extra contact details
              MOVE      PMCESNAM,PACSNAME              * Mothers Details
              MOVE      PMCEGNAM,PACGNAME
              MOVE      PMCETITL,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXPXMSNA
.
              MOVE      PMCEGNAM,LXPXMGNA
              MOVE      PMCETITL,LXPXMTLE
              MOVE      PMCEADD1,LXPXMAD1
              MOVE      PMCEADD2,LXPXMAD2
              MOVE      PMCEADD3,LXPXMAD3
              MOVE      PMCEADD4,LXPXMAD4
              MOVE      PMCEPOST,LXPXMPOS
              MOVE      PMCETELP,LXPXMPNO
              MOVE      PMCETELB,LXPXMBNO
              MOVE      PMCETELM,LXPXMMNO
              MOVE      PMCEEMAI,LXPXMEML
            ELSE
              MOVE      PMPXMSNA,PACSNAME              * Mothers Details
              MOVE      PMPXMGNA,PACGNAME
              MOVE      PMPXMTLE,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXPXMSNA
              MOVE      PMPXMGNA,LXPXMGNA
              MOVE      PMPXMTLE,LXPXMTLE
              MOVE      PMPXMAD1,LXPXMAD1
              MOVE      PMPXMAD2,LXPXMAD2
              MOVE      PMPXMAD3,LXPXMAD3
              MOVE      PMPXMAD4,LXPXMAD4
              MOVE      PMPXMPOS,LXPXMPOS
              MOVE      PMPXMPNO,LXPXMPNO
              MOVE      PMPXMBNO,LXPXMBNO
              MOVE      PMPXMMNO,LXPXMMNO
              MOVE      PMPXMEML,LXPXMEML
            ENDIF
.
            MOVE      PMPXUCC4,LXPXUCC4
            MOVE      PMPXATF1,LXPXATF1
            MOVE      PMPXUCC5,LXPXUCC5
            MOVE      PMPXATF2,LXPXATF2
.
            MOVE      PMPXSN18,LXPXSN18
            MOVE      PMPXSN19,LXPXSN19
            MOVE      PMPXSN20,LXPXSN20
            MOVE      PMPXSN21,LXPXSN21
            MOVE      PMPXSN22,LXPXSN22
            MOVE      PMPXSN23,LXPXSN23
            MOVE      PMPXSN24,LXPXSN24
            MOVE      PMPXSN25,LXPXSN25
            MOVE      PMPXSN26,LXPXSN26
            MOVE      PMPXSN27,LXPXSN27
            MOVE      PMPXSN28,LXPXSN28
            MOVE      PMPXSN29,LXPXSN29
            MOVE      PMPXSN30,LXPXSN30
.
            MOVE      PMPXUSR7,LXPUSRGC
            MOVE      SP70,LXPUSRGD
            MOVE      SP70,LXPUSRGL
.
            MATCH     SP70,PMPXUSR7
            IF        !@EQUAL
              PACK      KEY5,ANSP,SEVEN,PMPXUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD = 1
                MOVE      SP70,TDESC
                MOVE      SP70,PTCDLDES
              ENDIF
              MOVE      TDESC,LXPUSRGD
              MOVE      PTCDLDES,LXPUSRGL
            ENDIF
.
            MOVE      PMPXUSR8,LXPUSRHC
            MOVE      SP70,LXPUSRHD
            MOVE      SP70,LXPUSRHL
.
            MATCH     SP70,PMPXUSR8
            IF        !@EQUAL
              PACK      KEY5,ANSP,EIGHT,PMPXUSR8,SP70
              CALL      RDCODE1
              IF        OVRCD = 1
                MOVE      SP70,TDESC
                MOVE      SP70,PTCDLDES
              ENDIF
              MOVE      TDESC,LXPUSRHD
              MOVE      PTCDLDES,LXPUSRHL
            ENDIF
.
            MOVE      PMPXUSR9,LXPUSRIC
            MOVE      SP70,LXPUSRID
            MOVE      SP70,LXPUSRIL
.
            MATCH     SP70,PMPXUSR9
            IF        !@EQUAL
              PACK      KEY5,ANSP,NINE,PMPXUSR9,SP70
              CALL      RDCODE1
              IF        OVRCD = 1
                MOVE      SP70,TDESC
                MOVE      SP70,PTCDLDES
              ENDIF
              MOVE      TDESC,LXPUSRID
              MOVE      PTCDLDES,LXPUSRIL
            ENDIF
.
            MOVE      SP70,LXUCC4LD
            MATCH     SP70,PMPXUCC4
            IF        !@EQUAL
              MOVE      "Gi",DIM2
              PACK      KEY5,DIM2,PMPXUCC4,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      PTCDLDES,LXUCC4LD
              ENDIF
            ENDIF
.
            MOVE      SP70,LXUCC5LD
            MATCH     SP70,PMPXUCC5
            IF        !@EQUAL
              MOVE      "Gp",DIM2
              PACK      KEY5,DIM2,PMPXUCC5,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      PTCDLDES,LXUCC5LD
              ENDIF
            ENDIF
.
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "1",CONTTYPE          * Next of Kin
              CALL      XCON0000              * Get extra contact details
              MOVE      PMCETELM,LXPXKMOB
              MOVE      PMCEEMAI,LXPXKEML
            ELSE
              MOVE      PMPXKMOB,LXPXKMOB
              MOVE      PMPXKEML,LXPXKEML
            ENDIF
.
            MOVE      PMPXCMOB,LXPXCMOB
            MOVE      PMPXCEML,LXPXCEML
.
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "8",CONTTYPE          * Nearest Relative
              CALL      XCON0000              * Get extra contact details
              MOVE      PMCETELM,LXPXRMOB
              MOVE      PMCEEMAI,LXPXREML
            ELSE
              MOVE      PMPXRMOB,LXPXRMOB
              MOVE      PMPXREML,LXPXREML
            ENDIF
.
            MOVE      PMPXPEML,LXPXPEMX
.
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "4",CONTTYPE          * Mother
              CALL      XCON0000              * Get extra contact details
.
              MATCH     "1",PMCESLET
              IF        @EQUAL
                MOVE     DYES,LXPXMCRP
              ELSE
                MOVE     DNO,LXPXMCRP
              ENDIF
.
              PACK      KEY5,CODEC,PMCECONT
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE    TDESC,LXPXMCNT
              ELSE
                MOVE    SP30,LXPXMCNT
              ENDIF
.
              MOVE      PMCERELP,LXPXMREL
            ELSE
              PACK      KEY5,CODEC,PMPXMCNT
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE    TDESC,LXPXMCNT
              ELSE
                MOVE    SP30,LXPXMCNT
              ENDIF
.
              MATCH     "1",PMPXMCRP
              IF        @EQUAL
                MOVE     DYES,LXPXMCRP
              ELSE
                MOVE     DNO,LXPXMCRP
              ENDIF
.
              MATCH     "1",PMPXMLAB
              IF        @EQUAL
                MOVE     DYES,LXPXMLAB
              ELSE
                MOVE     DNO,LXPXMLAB
              ENDIF
.
              MOVE      PMPXMREL,LXPXMREL
            ENDIF
.
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "5",CONTTYPE          * Father 
              CALL      XCON0000              * Get extra contact details

              MOVE      PMCESNAM,PACSNAME              * Fathers Details
              MOVE      PMCEGNAM,PACGNAME
              MOVE      PMCETITL,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXPXFSNA
              MOVE      PMCEGNAM,LXPXFGNA
              MOVE      PMCETITL,LXPXFTLE
              MOVE      PMCEADD1,LXPXFAD1
              MOVE      PMCEADD2,LXPXFAD2
              MOVE      PMCEADD3,LXPXFAD3
              MOVE      PMCEADD4,LXPXFAD4
              MOVE      PMCEPOST,LXPXFPOS
              MOVE      PMCETELP,LXPXFPNO
              MOVE      PMCETELB,LXPXFBNO
              MOVE      PMCETELM,LXPXFMNO
              MOVE      PMCEEMAI,LXPXFEML
.
              MATCH     "1",PMCESLET
              IF        @EQUAL
                MOVE     DYES,LXPXFCRP
              ELSE
                MOVE     DNO,LXPXFCRP
              ENDIF
.
              PACK      KEY5,CODEC,PMCECONT
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE    TDESC,LXPXFCNT
              ELSE
                MOVE    SP30,LXPXFCNT
              ENDIF
.
              MOVE      PMCERELP,LXPXFREL                             *C-131844
            ELSE
              MOVE      PMPXFSNA,PACSNAME              * Fathers Details
              MOVE      PMPXFGNA,PACGNAME
              MOVE      PMPXFTLE,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXPXFSNA
              MOVE      PMPXFGNA,LXPXFGNA
              MOVE      PMPXFTLE,LXPXFTLE
              MOVE      PMPXFAD1,LXPXFAD1
              MOVE      PMPXFAD2,LXPXFAD2
              MOVE      PMPXFAD3,LXPXFAD3
              MOVE      PMPXFAD4,LXPXFAD4
              MOVE      PMPXFPOS,LXPXFPOS
              MOVE      PMPXFPNO,LXPXFPNO
              MOVE      PMPXFBNO,LXPXFBNO
              MOVE      PMPXFMNO,LXPXFMNO
              MOVE      PMPXFEML,LXPXFEML
.
              PACK      KEY5,CODEC,PMPXFCNT
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE    TDESC,LXPXFCNT
              ELSE
                MOVE    SP30,LXPXFCNT
              ENDIF
.
              MATCH     "1",PMPXFCRP
              IF        @EQUAL
                MOVE     DYES,LXPXFCRP
              ELSE
                MOVE     DNO,LXPXFCRP
              ENDIF
.
              MATCH     "1",PMPXFLAB
              IF        @EQUAL
                MOVE     DYES,LXPXFLAB
              ELSE
                MOVE     DNO,LXPXFLAB
              ENDIF
.
              MOVE      PMPXFREL,LXPXFREL                             *C-131844
            ENDIF
.
            MOVE      ONE,FORM2
            MOVE      THREE,DIM1
            CALL      GCCARD00
            MATCH     SP70,PMCDDVAC
            IF        !@EQUAL & !@EOS
              PACK      KEY5,CODEDX,PMCDDVAC,SP10   * DVA Card colour
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE      TDESC,LXPXDVAC
              ENDIF
            ENDIF
.
            PACK      KEY5,CODEVA,PMPXABRG         * Aboriginality
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXABRG
            ENDIF
.
            PACK      KEY5,CODEPV,PMPXPRVI         * Privacy
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXPRVI
            ENDIF
.
            MOVE      PMPXLNG1,LXPXPLC1
            PACK      KEY5,CODELA,PMPXLNG1,SP70    * Preferred Language 1
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXPLD1
            ENDIF   
.
            GOTO      SEVA0085
          ENDIF
.
SEVA0080  MOVE      TEMPOUTN,KEY8
          CALL      RDPRAM1                 * read pre-admiss file
.
SEVA0085  PACK      KEY8,TEMPOUTN
          CALL      RDPMVX11
          BRANCH    OVRCD,SEVA0087
.
          PACK      KEY5,CODEVA,PMVXABRG           * Aboriginality
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXABRG
          ENDIF
.
          PACK      KEY5,CODEVB,PMVXCADM           * Admission Criteria
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXCADM
          ENDIF
.
          PACK      KEY5,CODEVR,PMVXIRAD           * Intention to readmit
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXIRAD
          ENDIF
.
          PACK      KEY5,CODEVI,PMVXIDUS           * Intended stay duration
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXIDUS
          ENDIF
.
          PACK      KEY5,CODEVK,PMVXCRAV           * Carer Availability
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXCRAV
          ENDIF
.
          PACK      KEY5,CODEVJ,PMVXRCCT           * Crit care Xref
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXRCCT
          ENDIF
.
          PACK      KEY6,PMVXAPWD,PMVXAPBD
          CALL      RDWARD1
          IF        OVRCD = 0
            MOVE     WBDESC,LXVXAPWD
          ENDIF
          MOVE      PMVXAPBD,LXVXAPBD
.
          MOVE      PMVXUDF1,LXOTUDF1              * Presenting Comp   *I-58732
.
SEVA0087  MOVE      PMEDI,MEDNUM
          MATCH     SP10,MEDNUM
          GOTO      SEVA0090 IF NOT EQUAL
.
          MOVE      "**********",MEDNUM
.
.------------------ cancelled bookings dont have a bokb record
.
...A0090  MATCH     "IBAOUT33",PRGID
...       GOTO      SEVA0210 IF EQUAL
SEVA0090  MATCH     "R",LTTYPIND            * Outpatient Referral letter?
          GOTO      SEVA0210 IF EQUAL
.
          IF        FSTATUS <> THREE
            MOVE      TEMPOUTN,KEY8
            CALL      RDBOKB1
            IF        OVRCD = ONE
...           MOVE      TRUE,CEXIT
...           GOTO      SEVA2000
...           GOTO      SEVA9999
...
...           CLOSE     OUTCANA1
...           PACK      CFNAME,OSTFILE,FILCANA1 
...           OPEN      OUTCANA1,CFNAME
              MOVE      TEMPOUTN,KEY8
              CALL      RDOTCAN1
              IF        OVRCD=ONE
                MOVE      TRUE,CEXIT
                GOTO      SEVA2000
              ENDIF
            ENDIF
          ENDIF
.
          IF        OPTION = 2
            IF        SMFLAG = 1
.                                             don't have a letter numbe
              PACK      KEY28,SITE,TEMPCLID,TEMPDATE,TEMPSTRT,TEMPSLOT
              CALL      RDBOKA1
              IF        OVRCD = ONE
                MOVE      TRUE,CEXIT
                GOTO      SEVA2000
.               GOTO      SEVA9999
              ENDIF
.
              CALL      SUSL0000            * set up standard letter
              IF        EXIT = ONE
                MOVE      TRUE,CEXIT
                GOTO      SEVA2000
.               GOTO      SEVA9999
              ENDIF 
            ENDIF
          ENDIF
.
          IF        OPTION = 6
             CALL      SUSL0000            * set up standard letter
             IF        EXIT = ONE
                MOVE      TRUE,CEXIT
.               GOTO      SEVA9999
              ENDIF 
          ENDIF
.
.----------------  Update bokb to say don't send any more letters -----
.
          MOVE      TEMPOUTN,KEY8
          CALL      RDBOKB1
          IF        OVRCD = ONE
...         MOVE      TRUE,CEXIT
...         GOTO      SEVA2000
...         GOTO      SEVA9999
.
            MOVE      TEMPOUTN,KEY8
            CALL      RDOTCAN1
            IF        OVRCD=ONE
              MOVE      TRUE,CEXIT
              GOTO      SEVA2000
            ENDIF
            GOTO      SEVA0100
          ENDIF
.
          IF        OPTION=2 & SMFLAG=1
            MOVE      ANSN,OTBBSNDL
            CALL      UPBOKB1
          ENDIF
. 
SEVA0100  CALL      SULD0000                * set up more letter details
.
SEVA0210  COMPARE   ZERO,PSAGE
          GOTO      SEVA0300 IF NOT EQUAL
          MOVE      "000",PSAGE
.
SEVA0300  MOVE      OBASITE,KEY6
          MOVE      SP30,OSTDESC
          CALL      RDSITA1
          MOVE      OSTDESC,TEMPSITE                                  *I-152340
.
.>>>>>>>  MATCH     "                              ",OSTDESC
.>>>>>>>  GOTO      SEVA0400 IF NOT EQUAL
.>>>>>>>  MOVE      "******************************",OSTDESC
.
SEVA0400  CALL      CLGP0000                * Clear HCP details
...       MATCH     "IBAOUT33",PRGID
...       GOTO      SEVA0420 IF EQUAL
          MATCH     "R",LTTYPIND            * Outpatient Referral letter?
          GOTO      SEVA0420 IF EQUAL
.
          MATCH     SP8,OTBBRFGP
          GOTO      SEVA0420 IF EQUAL
.
          PACK      KEY10,OTBBRFGP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA0420
.
          MOVE      PMHCTITL,RFGPTITL
          MOVE      PMHCSNAM,RFGPSNAM
          MOVE      PMHCGNAM,RFGPGNAM
          MOVE      PMHCADR1,RFGPADD1
          MOVE      PMHCADR2,RFGPADD2
          MOVE      PMHCADR3,RFGPADD3
          MOVE      PMHCADR4,RFGPADD4
          MOVE      PMHCPOST,RFGPPOST
          MOVE      PMHCSTEL,RFGPTELP
          MOVE      PMHCFAXN,RFGPFAXN
          MOVE      PMHCSEML,RFGPEMAL
.                                           * load Practice Address with Surgery
          MOVE      PMHCADR1,RFPRSAD1
          MOVE      PMHCADR2,RFPRSAD2
          MOVE      PMHCADR3,RFPRSAD3
          MOVE      PMHCADR4,RFPRSAD4
          MOVE      PMHCPOST,RFPRSPCD
          MOVE      PMHCSTEL,RFPRTELE
          MOVE      PMHCFAXN,RFPRFAXN
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,RFGPPRMC
            ELSE
              MOVE      PMHCPRFC,RFGPPRMC
            ENDIF
          ENDIF
.
          MATCH     SP6,OTBBGPPC
          GOTO      SEVA0420 IF EQUAL
.
          PACK      KEY10,OTBBGPPC,SP70
          PACK      KEY12,KEY10,OTBBGPPT,SP70
          CALL      RDPMHCG1    
          BRANCH    OVRCD,SEVA0420
.
          MATCH     SP70,PMHGADD1
          IF        !@EQUAL
            MOVE      PMHGPNAM,RFPRSURG
            MOVE      PMHGADD1,RFPRSAD1
            MOVE      PMHGADD2,RFPRSAD2
            MOVE      PMHGADD3,RFPRSAD3
            MOVE      PMHGADD4,RFPRSAD4
            MOVE      PMHGPOST,RFPRSPCD
          ENDIF
          MATCH     SP70,PMHGPTEL
          IF        !@EQUAL
            MOVE      PMHGPTEL,RFPRTELE
          ENDIF
          MATCH     SP70,PMHGPFAX
          IF        !@EQUAL
            MOVE      PMHGPFAX,RFPRFAXN
          ENDIF
.
SEVA0420  MATCH     SP8,PMPXRHC1
          GOTO      SEVA0500 IF EQUAL
.
          PACK      KEY10,PMPXRHC1,SP70        * Default GP for all
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA0500
          MOVE      PMHCSNAM,RGGPSNAM
          MOVE      PMHCGNAM,RGGPGNAM
          MOVE      PMHCADR1,RGGPADD1
          MOVE      PMHCADR2,RGGPADD2
          MOVE      PMHCADR3,RGGPADD3
          MOVE      PMHCADR4,RGGPADD4
          MOVE      PMHCPOST,RGGPPOST
.
          MOVE      PMHCSEML,RGGPEMLA
          MOVE      PMHCSTEL,RGPRTELE
          MOVE      PMHCFAXN,RGPRFAXN
.                                           * load Practice Address with Surgery
          MOVE      PMHCADR1,RGPRSAD1
          MOVE      PMHCADR2,RGPRSAD2
          MOVE      PMHCADR3,RGPRSAD3
          MOVE      PMHCADR4,RGPRSAD4
          MOVE      PMHCPOST,RGPRSPCD
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,ANS
          MOVE      ANS,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,RGGPFNAM
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,RGGPPRMC
            ELSE
              MOVE      PMHCPRFC,RGGPPRMC
            ENDIF
          ENDIF
.
SEVA0500  MATCH     SP6,PMPXRH1G
          GOTO      SEVA0504 IF EQUAL
.
          PACK      KEY10,PMPXRH1G,SP70
          PACK      KEY12,KEY10,PMPXR1GC,SP70 * Default practice address for all
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA0504
          MOVE      PMHGPNAM,RGPRSURG
.                                           * replace Surgery data with Practice
          MATCH     SP70,PMHGADD1
          IF        !@EQUAL
            MOVE      PMHGADD1,RGPRSAD1
            MOVE      PMHGADD2,RGPRSAD2
            MOVE      PMHGADD3,RGPRSAD3
            MOVE      PMHGADD4,RGPRSAD4
            MOVE      PMHGPOST,RGPRSPCD
          ENDIF
          MATCH     SP70,PMHGPTEL
          IF        !@EQUAL
            MOVE      PMHGPTEL,RGPRTELE
          ENDIF
          MATCH     SP70,PMHGPFAX
          IF        !@EQUAL
            MOVE      PMHGPFAX,RGPRFAXN
          ENDIF
.
. Format the appointment date
.
SEVA0504  PACK      CLDAY,SP9
          PACK      CLDAYSRT,SP3
          PACK      CLDATE,SP4
          PACK      CLMONTH,SP9
          PACK      CLMTHSRT,SP3
          PACK      CLYR,SP4
.
          MOVE      ZERO,EXIT
          REP       " 0",TEMPDATE
          MATCH     "00000000",TEMPDATE
          IF        !@EQUAL
            UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DATECONV
            BRANCH    EXIT,SEVA0510
          ENDIF
.
          LOAD      CLDAY,WEEKDAY,DMON,DTUE,DWED,DTHU,DFRI,DSAT,DSUN
          MOVE      CLDAY,CLDAYSRT
.
          MOVE      CDAY,FORM2
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                    DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT1
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      SEVA0505 IF NOT EQUAL
          BUMP      CDAY
SEVA0505  PACK      CLDATE,CDAY,DEXT
.
          MOVE      CMON,FORM2
          LOAD      CLMONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                    MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
.
          MOVE      CLMONTH,CLMTHSRT 
.
          PACK      CLYR,CCENT,CYEAR
.
. get the clinic location details
.
SEVA0510  MOVE      OTMACLOC,CLCLOC
.
          PACK      CLLTYP,SP20,SP10
          MATCH     SP3,OTMALTYP
          GOTO      SEVA1000 IF EQUAL
          PACK      KEY5,ANSC,ANST,OTMALTYP
          CALL      RDCODE1
          BRANCH    OVRCD,SEVA1000
          MOVE      TDESC,CLLTYP
.
. ------- set emergency contact values -------
. 
SEVA1000  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
.
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXECNAM
            MOVE      PMCEADD1,LXECADA
            MOVE      PMCEADD2,LXECADB
            MOVE      PMCEADD3,LXECADC
            MOVE      PMCEADD4,LXECADD
            MOVE      PMCEPOST,LXECPCD
            MOVE      PMCETELM,LXPXCMOB
            MOVE      PMCEEMAI,LXPXCEML
            MOVE      PMCETITL,LXPETITL
            MOVE      PMCESNAM,LXPESNAM
            MOVE      PMCEGNAM,LXPEGNAM
            MOVE      PMCEGNM2,LXPEGNM2
            MOVE      PMCETELP,LXPETELP
            MOVE      PMCETELB,LXPETELB
            MOVE      PMCERELP,LXPERELP
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPESLET
            ELSE
              MOVE     DNO,LXPESLET
            ENDIF
          ELSE
            MOVE      PTMXECNM,LXECNAM
            MOVE      PTMXECA1,LXECADA
            MOVE      PTMXECA2,LXECADB
            MOVE      PTMXECA3,LXECADC
            MOVE      PTMXECA4,LXECADD
            MOVE      PTMXECPC,LXECPCD
          ENDIF
.
. ------- set nearest relative values -------
. 
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative  
            CALL      XCON0000              * Get extra contact details
.
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXNRNAM
            MOVE      PMCEADD1,LXNRADA
            MOVE      PMCEADD2,LXNRADB
            MOVE      PMCEADD3,LXNRADC
            MOVE      PMCEADD4,LXNRADD
            MOVE      PMCEPOST,LXNRPCD
            MOVE      PMCETITL,LXPRTITL
            MOVE      PMCESNAM,LXPRSNAM
            MOVE      PMCEGNAM,LXPRGNAM
            MOVE      PMCEGNM2,LXPRGNM2
            MOVE      PMCETELP,LXPRTELP
            MOVE      PMCETELB,LXPRTELB
            MOVE      PMCERELP,LXPRRELP
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPRSLET
            ELSE
              MOVE     DNO,LXPRSLET
            ENDIF
          ELSE
            MOVE      PTMXNRNM,LXNRNAM
            MOVE      PTMXNRA1,LXNRADA
            MOVE      PTMXNRA2,LXNRADB
            MOVE      PTMXNRA3,LXNRADC
            MOVE      PTMXNRA4,LXNRADD
            MOVE      PTMXNRPC,LXNRPCD
          ENDIF
.
. ------- set National ID -------
.
          READ      CONTROLF,FIFTY9;*234,PTCNNMPI
          MOVE      SP20,PTNINMPI
          IF        PTCNNMPI <> ZERO
            OPEN      PATNIDA1,"patnidaf"
            PACK      KEY10,CHOSINDX,PURNO
            CALL      RDPTNID1
          ENDIF
          MOVE      PTNINMPI,LXNATID
.
. ------- set the mailing name and address               -------
. ------- if the patient is a child - set to next of kin -------
.
          READ      CONTROLF,TEN;*94,CAGECOFF
          IF        PSAGE < CAGECOFF
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "1",CONTTYPE          * Next of Kin
              CALL      XCON0000              * Get extra contact details
.
              MOVE      PMCESNAM,PACSNAME
              MOVE      PMCEGNAM,PACGNAME
              MOVE      PMCETITL,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXNKNAME
              MOVE      PMCEADD1,LXNKADD1
              MOVE      PMCEADD2,LXNKADD2
              MOVE      PMCEADD3,LXNKADD3
              MOVE      PMCEADD4,LXNKADD4
              MOVE      PMCEPOST,LXNKPOST
              MATCH     SP20,PACFNAME
              IF        @EQUAL
                MOVE      "Parent/Gaurdian",LXNKNAME
              ENDIF
            ELSE
              MOVE      PNKNAME,LXNKNAME
              MOVE      PNKADD1,LXNKADD1
              MOVE      PNKADD2,LXNKADD2
              MOVE      PNKSUBR,LXNKADD3
              MOVE      PNKADD4,LXNKADD4
              MOVE      PNKPOST,LXNKPOST
              MATCH     SP20,PNKNAME
              IF        @EQUAL
                MOVE      "Parent/Gaurdian",LXNKNAME
              ENDIF
            ENDIF
          ELSE 
.
            MOVE      PSNAME,PACSNAME        * set up pack name variables
            MOVE      PGNAME,PACGNAME
.
            PACK      KEY4,PTITL,SP70
            CALL      RDPMTLE1
            IF        OVRCD=0
              MOVE      PMTLDESC,LINE
              CALL      CASE0000
              MOVE      LINE,PACTITLE
            ELSE
              MOVE      PTITL,PACTITLE
            ENDIF
.
            MOVE      ONE,PACFRMT
            CALL      PACNAME                * format patients name
            MOVE      PACFNAME,TEMPNAME
            MOVE      TEMPNAME,LINE
            CALL      CASE0000               * convert to lower case
            MOVE      LINE,TEMPNAME
            MOVE      TEMPNAME,LXNKNAME
.
            MOVE      PADD1,LXNKADD1
            MOVE      PADD2,LXNKADD2
            MOVE      PSUBRB,LXNKADD3
            MOVE      PADD4,LXNKADD4
            MOVE      PPOST,LXNKPOST
          ENDIF
.
          PACK      CFNAME,UID,FILXSCA1
          OPEN      OUTXSCA1,CFNAME
.
          PACK      KEY8,OBAOUTNO
          CALL      RDOTXSC1                * Read an xtra screen file record
          IF        OVRCD<>1
            PACK      KEY6,OTXSDOC1
            CALL      RDDOCT1               * Read a doctors file record
            IF        OVRCD<>1
              MOVE      OTXSDOC1,LXXSDCCD
              MOVE      DPROV,LXXSDCPN
            ENDIF
.
            UNPACK    OTXSDTE1,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
            REP       " 0",CPCDATE
            MOVE      CPCDATE,LXXSRFDT
          ENDIF
.
          MATCH     SP3,OBOUSR5
          IF        !@EQUAL
            PACK      KEY5,CODEO5,OBOUSR5
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF5
              MOVE      LXUDEF5,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF5
            ENDIF
          ENDIF
.
          MATCH     SP3,OBOUSR6
          IF        !@EQUAL
            PACK      KEY5,CODEO6,OBOUSR6
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF6
              MOVE      LXUDEF6,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF6
            ENDIF
          ENDIF
.
          MATCH     SP3,OBOUSR7
          IF        !@EQUAL
            PACK      KEY5,CODEO7,OBOUSR7
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF7
              MOVE      LXUDEF7,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF7
            ENDIF
          ENDIF
.
          MATCH     SP3,OBOUSR8
          IF        !@EQUAL
            PACK      KEY5,CODEO8,OBOUSR8
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF8
              MOVE      LXUDEF8,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF8
            ENDIF
          ENDIF
.
          MOVE      OTBBRANK,LXPRANK
.
          MOVE      OTMAINS1,LXMAINS1
          MOVE      OTMAINS2,LXMAINS2
          MOVE      OTMAINS3,LXMAINS3
.
          MOVE      OMACOM1,LXMACOM1
          MOVE      OMACOM2,LXMACOM2
.
          PACK      LXCLNIND,SP30         * Clinic Indicator (Cat CI)
          MATCH     SP3,OMACIND
          IF        !@EQUAL
            MOVE      "CI",KEY2
            PACK      KEY5,KEY2,OMACIND,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LINE
              CALL      CASE0000
              MOVE      LINE,LXCLNIND
            ENDIF
          ENDIF
.
. Retrieve the 1st 4 comment text lines of the lastest active visit comments
.
SEVA1100  MOVE      SP70,LXOTDES1
          MOVE      SP70,LXOTDES2
          MOVE      SP70,LXOTDES3
          MOVE      SP70,LXOTDES4
.
          MOVE      TEMPOUTN,KEY8       * Key for start of patients comment
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
SEVA1110  CALL      RPVSMDT1
          BRANCH    OVRCD,SEVA1150
.
          MATCH     KEY8,VSMDVISN
          GOTO      SEVA1150 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      SEVA1150 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      SEVA1110 IF EQUAL
.
. Retrieve the 1st comment text line
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP1,SP1,ONE,SP70
          CALL      RDVSMTX1
          BRANCH    OVRCD,SEVA1150
. 
          MOVE      VSMTCMNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXOTDES1       
.
. Retrieve the 2nd comment text line
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP1,SP1,TWO,SP70
          CALL      RDVSMTX1
          BRANCH    OVRCD,SEVA1150
. 
          MOVE      VSMTCMNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXOTDES2        
.
. Retrieve the 3rd comment text line
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP1,SP1,THREE,SP70
          CALL      RDVSMTX1
          BRANCH    OVRCD,SEVA1150
. 
          MOVE      VSMTCMNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXOTDES3        
.
. Retrieve the 4th comment text line
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP1,SP1,FOUR,SP70
          CALL      RDVSMTX1
          BRANCH    OVRCD,SEVA1150
. 
          MOVE      VSMTCMNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXOTDES4                             
.
          GOTO      SEVA1150
.
SEVA1150  PACK      KEY14,TEMPOUTN,ZERO,ONE,THREE,SP1,SP1,ONE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            PACK      LXPATIN1,VSCTDATA,SP70
          ELSE
            PACK      LXPATIN1,SP70,SP70
          ENDIF
.
          PACK      KEY14,TEMPOUTN,ZERO,ONE,THREE,SP1,SP1,TWO,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            PACK      LXPATIN2,VSCTDATA,SP70
          ELSE
            PACK      LXPATIN2,SP70,SP70
          ENDIF
.
          PACK      KEY14,TEMPOUTN,ZERO,ONE,THREE,SP1,SP1,THREE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            PACK      LXPATIN3,VSCTDATA,SP70
          ELSE
            PACK      LXPATIN3,SP70,SP70
          ENDIF
.
          PACK      KEY14,TEMPOUTN,ZERO,ONE,THREE,SP1,SP1,FOUR,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            PACK      LXPATIN4,VSCTDATA,SP70
          ELSE
            PACK      LXPATIN4,SP70,SP70
          ENDIF
.
          PACK      LXBBDNAR,SP30                                      *I-55313 
          PACK      LXOPRSCH,SP30
          PACK      LXBBTRAN,SP30                                      *I-55313
          MOVE      TEMPOUTN,KEY8
          CALL      RDBOKB1
          IF        OVRCD = 0
            PACK      KEY5,CODEO1,OBOUSR1
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXBOUSR1
              MOVE      LXBOUSR1,LINE
              CALL      CASE0000
              MOVE      LINE,LXBOUSR1
            ENDIF
.
            PACK      KEY5,CODESA,OTBBSPCA
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXBBSPCA
              MOVE      LXBBSPCA,LINE
              CALL      CASE0000
              MOVE      LINE,LXBBSPCA
              MATCH     OTBBSPCA,SP70    *checks to see if there is nothing    
              IF        @EQUAL
                MOVE      SP70,LXBBSPCA
              ENDIF
            ENDIF
.
            PACK      LXBBTRAN,SP30         * Transport
            MATCH     SP3,OTBBTRAN
            IF        !@EQUAL
              MOVE      "OB",KEY2
              PACK      KEY5,KEY2,OTBBTRAN
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
                CALL      CASE0000
                MOVE      LINE,LXBBTRAN
              ENDIF
            ENDIF
            PACK      LXBBDNAR,SP30         * Reason for non-attendance
            MATCH     SP3,OBAATTN
            IF        !@EQUAL
              MOVE      "CA",KEY2
              PACK      KEY5,KEY2,OBAATTN
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
                CALL      CASE0000
                MOVE      LINE,LXBBDNAR
              ENDIF
            ENDIF
.
            PACK      LXOPRSCH,SP30         * Reason for reschedule
            MATCH     SP3,OBARSCHD
            IF        !@EQUAL
              MOVE      "RR",KEY2
              PACK      KEY5,KEY2,OBARSCHD
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
                CALL      CASE0000
                MOVE      LINE,LXOPRSCH
              ENDIF
            ENDIF
.
            PACK      LXOZATTO,SP30         * Attendance Outcome(Cat OZ)
            MATCH     SP3,OTBBOUTC
            IF        !@EQUAL
              MOVE      "OZ",KEY2
              PACK      KEY5,KEY2,OTBBOUTC
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
                CALL      CASE0000
                MOVE      LINE,LXOZATTO
              ENDIF
            ENDIF
            PACK      LXDODSCH,SP30         * Discharge Status (Cat DO)
            MATCH     SP3,OBADISCH
            IF        !@EQUAL
              MOVE      "DO",KEY2
              PACK      KEY5,KEY2,OBADISCH
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
                CALL      CASE0000
                MOVE      LINE,LXDODSCH
              ENDIF
            ENDIF
.
            PACK      LXSRVDDC,SP30         * Service Delivery Mode (Cat sd)
            PACK      LXSRVDCD,SP70
            MATCH     SP3,OTBBSRVD 
            IF        !@EQUAL
              MOVE      "sd",KEY2
              PACK      KEY5,KEY2,OTBBSRVD
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LINE
.               CALL      CASE0000
                MOVE      LINE,LXSRVDDC
                PACK      LXSRVDCD,OTBBSRVD,SP70
              ENDIF
            ENDIF
          ENDIF
.
          PACK      RFGPFAX0,SP70                                    *I-55313
          PACK      RFGPADR5,SP70
          PACK      RFGPADR6,SP70
          PACK      RFGPPHON,SP70
          PACK      RFGPMOBN,SP70
          PACK      RFGPPPNO,SP70
          PACK      RFGPPAGN,SP70
          PACK      RFGPPROV,SP70
          PACK      RFGPSEML,SP70,SP70
          PACK      RFGPPRM0,SP70
          MOVE      TEMPOUTN,KEY8
          CALL      RDBOKB1
          IF        OVRCD = 0
            PACK      KEY10,OTBBRFGP,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCFAXN,RFGPFAX0
              MOVE      PMHCADR5,RFGPADR5
              MOVE      PMHCADR6,RFGPADR6
              MOVE      PMHCSTEL,RFGPPHON
              MOVE      PMHCMOBN,RFGPMOBN
              MOVE      PMHCPAGR,RFGPPPNO
              MOVE      PMHCPAGN,RFGPPAGN
              MOVE      PMHCPRV1,RFGPPROV
              MOVE      PMHCSEML,RFGPSEML
.
              MATCH     SP70,PMHCPRFC
              IF        !@EQUAL
                PACK      KEY5,CODECZ,PMHCPRFC,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  MOVE      TDESC,RFGPPRM0
                ELSE
                  MOVE      PMHCPRFC,RFGPPRM0
                ENDIF
              ENDIF
.
            ENDIF
          ENDIF
.
          PACK      RGPRPRCC,SP70
          PACK      KEY10,PMPXRH1G,SP70
          PACK      KEY12,KEY10,PMPXR1GC,SP70 * Default practice address for all
          CALL      RDPMHCG1
          IF        OVRCD = 0
            MOVE      PMHGPRAC,RGPRPRCC
          ENDIF
.                           
SEVA1500  PACK     LXOTCLCD,SP70
          MOVE     OBACOMP,LXOTCLCD
.
          PACK     LXOTCCDD,SP70
          MATCH    SP3,OBACOMP
          IF       !@EQUAL
            MOVE     "CL",KEY2
            PACK     KEY5,KEY2,OBACOMP
            CALL     RDCODE1
            IF       OVRCD=0
              MOVE     TDESC,LINE
              CALL     CASE0000
              MOVE     LINE,LXOTCCDD
            ENDIF
          ENDIF
.                                                               *end I-57244
          PACK     LXOTTCCL,SP70                                    *I-59546
          PACK     LXOTTCDT,SP70
          PACK     KEY8,TEMPOUTN,SP70
          CALL     RDWMAB1
          IF       OVRCD = 0
            MOVE     MREFNO,LXOTTCCL                            *TAC Claim Num
            UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
            MOVE      CPCDATE,LXOTTCDT    
          ENDIF
.
          PACK     LXOTWKDT,SP70
          PACK     KEY8,TEMPOUTN,SP70
          CALL     RDWCOM1
          IF       OVRCD = 0
            UNPACK   WCACDAT,CCENT,CYEAR,CMON,CDAY
            CALL     PACDATE
            MOVE     CPCDATE,LXOTWKDT
          ENDIF
.
          PACK     LXOCNTP1,SP70                                *Concession Card
          PACK     LXOCNTD1,SP70                                *details 12345
          PACK     LXOCNNM1,SP70
          PACK     LXOCNDT1,SP70
          PACK     LXOCNTP2,SP70
          PACK     LXOCNTD2,SP70
          PACK     LXOCNNM2,SP70
          PACK     LXOCNDT2,SP70
          PACK     LXOCNTP3,SP70
          PACK     LXOCNTD3,SP70
          PACK     LXOCNNM3,SP70
          PACK     LXOCNDT3,SP70
          PACK     LXOCNTP4,SP70
          PACK     LXOCNTD4,SP70
          PACK     LXOCNNM4,SP70
          PACK     LXOCNDT4,SP70
          PACK     LXOCNTP5,SP70
          PACK     LXOCNTD5,SP70
          PACK     LXOCNNM5,SP70
          PACK     LXOCNDT5,SP70
.
          MOVE     ZERO,FORM1
          PACK     KEY19,TEMPURNO,SP70
          CALL     RSPMCCD1
SEVA1600  CALL     RKPMCCD1
          BRANCH   OVRCD,SEVA1700  
.
          MATCH    TEMPURNO,PMCDURNO
          GOTO     SEVA1700 IF NOT EQUAL
.
          ADD      ONE,FORM1
          COMPARE  SIX,FORM1
          GOTO     SEVA1700 IF EQUAL
.
          STORE    PMCDCTYP,FORM1,LXOCNTP1,LXOCNTP2,LXOCNTP3,LXOCNTP4,LXOCNTP5
.
          MOVE     "ct",TCODE
          PACK     KEY5,TCODE,PMCDCTYP
          CALL     RDCODE1
          BRANCH   OVRCD,SEVA1650 
.
          STORE    TDESC,FORM1,LXOCNTD1,LXOCNTD2,LXOCNTD3,LXOCNTD4,LXOCNTD5
.
SEVA1650  STORE    PMCDCNUM,FORM1,LXOCNNM1,LXOCNNM2,LXOCNNM3,LXOCNNM4,LXOCNNM5
.
          UNPACK   PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          CALL     PACDATE
          STORE    CPCDATE,FORM1,LXOCNDT1,LXOCNDT2,LXOCNDT3,LXOCNDT4,LXOCNDT5
.
          GOTO     SEVA1600
.                                                               *end I-59546
SEVA1700  PACK     KEY4,PTITL,SP70
          CALL     RDPMTLE1
          IF       OVRCD=0
.            MOVE     PMTLDESC,LINE          
.            CALL     CASE0000
.            MOVE     LINE,LXTITLE
             MOVE     PMTLDESC,LXTITLE
          ELSE
.            MOVE     PTITL,LINE
.            CALL     CASE0000
.            MOVE     LINE,LXTITLE
             MOVE     PTITL,LXTITLE
          ENDIF
.
          MOVE      OBAVISIT,LXOTVTPC
          PACK      KEY5,CODECV,OBAVISIT
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXOTVTYP          * Visit Type of Booking
            MOVE    TCINDC1,LXVTYPI1          * Visit Type Indicator 1
          ENDIF
.
SEVA1800  MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,LXIHINUM     * IHI Number
          ELSE
            MATCH     "3",PTCNUNET
            IF        @EQUAL
              CALL      GTIHINUM                   * IHI Number
              LJUSTIFY  IHINUMBR
              UNPACK    IHINUMBR,DIM4,DIM4A,DIM4B,DIM4C
              PACK      LXIHINUM,DIM4,SP1,DIM4A,SP1,DIM4B,SP1,DIM4C
            ENDIF
          ENDIF
.
.------ move all names, addresses etc to LINE and convert to lower case ------
.
.         MOVE      PADD1,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD1
.         MOVE      PADD2,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD2
.         MOVE      PSUBRB,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSUBRB
          MOVE      PGNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PGNAME
.         MOVE      PSNAME,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSNAME
.         MOVE      PTITL,LINE
.         CALL      CASE0000
.         MOVE      LINE,PTITL
.
          MOVE      PNKNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PNKNAME
          MOVE      PNKADD1,LINE
          CALL      CASE0000
          MOVE      LINE,PNKADD1 
          MOVE      PNKADD2,LINE
          CALL      CASE0000
          MOVE      LINE,PNKADD2 
          MOVE      PNKADD4,LINE
          CALL      CASE0000
          MOVE      LINE,PNKADD4 
          CALL      CASE0000
          MOVE      PNKADD4,LINE
          MOVE      RGGPSNAM,LINE
          CALL      CASE0000
          MOVE      LINE,RGGPSNAM  
          MOVE      RGGPGNAM,LINE
          CALL      CASE0000
          MOVE      LINE,RGGPGNAM 
          MOVE      RGGPADD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGGPADD1
          MOVE      RGGPADD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGGPADD2  
          MOVE      RGGPADD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGGPADD3 
          MOVE      RGGPADD4,LINE
.         CALL      CASE0000
          MOVE      LINE,RGGPADD4
          MOVE      RFGPSNAM,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPSNAM  
          MOVE      RFGPGNAM,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPGNAM  
          MOVE      RFGPADD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPADD1 
          MOVE      RFGPADD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPADD2
          MOVE      RFGPADD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPADD3 
          MOVE      RFGPADD4,LINE
.         CALL      CASE0000
          MOVE      LINE,RFGPADD4
.
          MOVE      LCHSPNAM,LINE
          CALL      CASE0000
          MOVE      LINE,LCHSPNAM

          MOVE      LCHSPAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LCHSPAD1
          
          MOVE      LCHSPAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LCHSPAD2
         
          MOVE      LCHSPAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LCHSPAD3
        
          MOVE      LCHSPAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LCHSPAD4
.
          MOVE      RGPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSURG
          MOVE      RGPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD1
          MOVE      RGPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD2
          MOVE      RGPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD3
          MOVE      RGPRSAD4,LINE
.         CALL      CASE0000
          MOVE      LINE,RGPRSAD4
          MOVE      RGPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRTELE
.
          MOVE      RFPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSURG
          MOVE      RFPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD1
          MOVE      RFPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD2
          MOVE      RFPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD3
          MOVE      RFPRSAD4,LINE
.         CALL      CASE0000
          MOVE      LINE,RFPRSAD4
          MOVE      RFPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRTELE
.
          MOVE      LXECNAM,LINE
          CALL      CASE0000
          MOVE      LINE,LXECNAM
          MOVE      LXECADA,LINE
          CALL      CASE0000
          MOVE      LINE,LXECADA
          MOVE      LXECADB,LINE
          CALL      CASE0000
          MOVE      LINE,LXECADB
          MOVE      LXECADC,LINE
          CALL      CASE0000
          MOVE      LINE,LXECADC
          MOVE      LXECADD,LINE
          CALL      CASE0000
          MOVE      LINE,LXECADD
.
          MOVE      LXNRNAM,LINE
          CALL      CASE0000
          MOVE      LINE,LXNRNAM
          MOVE      LXNRADA,LINE
          CALL      CASE0000
          MOVE      LINE,LXNRADA
          MOVE      LXNRADB,LINE
          CALL      CASE0000
          MOVE      LINE,LXNRADB
          MOVE      LXNRADC,LINE
          CALL      CASE0000
          MOVE      LINE,LXNRADC
          MOVE      LXNRADD,LINE
          CALL      CASE0000
          MOVE      LINE,LXNRADD
.
          MOVE      PTMXCELL,LINE              * load cellular phone number
          CALL      CASE0000
          MOVE      LINE,LXCELL
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE               * Postal Address
            CALL      XCON0000                   * Get extra contact details
.
            MOVE      PMCEADD1,LINE              * load postal address line 1
            CALL      CASE0000
            MOVE      LINE,LXPADDA
            MOVE      PMCEADD2,LINE              * load postal address line 2
            CALL      CASE0000
            MOVE      LINE,LXPADDB
            MOVE      PMCEADD3,LINE              * load postal address line 3
            CALL      CASE0000
            MOVE      LINE,LXPADDC
            MOVE      PMCEADD4,LINE              * load postal address line 4
.           CALL      CASE0000
            MOVE      LINE,LXPADDD
            MOVE      PMCEPOST,LINE              * load postal Post Code
            CALL      CASE0000
            MOVE      LINE,LXPPOST
.
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPSNAME          * Postal Contact Details
            MOVE      PMCETITL,LXPSTITL
            MOVE      PMCESNAM,LXPSSNAM
            MOVE      PMCEGNAM,LXPSGNAM
            MOVE      PMCEGNM2,LXPSGNM2
            MOVE      PMCETELP,LXPSTELP
            MOVE      PMCETELB,LXPSTELB
            MOVE      PMCETELM,LXPSTELM
            MOVE      PMCERELP,LXPSRELP
            MOVE      PMCEEMAI,LXPSEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPSSLET
            ELSE
              MOVE     DNO,LXPSSLET
            ENDIF
          ELSE
            MATCH     SP70,PTMXADD1
            IF        @EQUAL
              MOVE      PADD1,LINE              * load pmi address line 1
              CALL      CASE0000
              MOVE      LINE,LXPADDA
              MOVE      PADD2,LINE              * load pmi address line 2
              CALL      CASE0000
              MOVE      LINE,LXPADDB
              MOVE      PSUBRB,LINE              * load pmi address line 3
              CALL      CASE0000
              MOVE      LINE,LXPADDC
              MOVE      PADD4,LINE              * load pmi address line 4
.             CALL      CASE0000
              MOVE      LINE,LXPADDD
              MOVE      PPOST,LINE              * load pmi Post Code
              CALL      CASE0000
              MOVE      LINE,LXPPOST

            ELSE
              MOVE      PTMXADD1,LINE              * load postal address line 1
              CALL      CASE0000
              MOVE      LINE,LXPADDA
              MOVE      PTMXADD2,LINE              * load postal address line 2
              CALL      CASE0000
              MOVE      LINE,LXPADDB
              MOVE      PTMXADD3,LINE              * load postal address line 3
              CALL      CASE0000
              MOVE      LINE,LXPADDC
              MOVE      PTMXADD4,LINE              * load postal address line 4
.             CALL      CASE0000
              MOVE      LINE,LXPADDD
              MOVE      PTMXPOST,LINE              * load postal Post Code
              CALL      CASE0000
              MOVE      LINE,LXPPOST
            ENDIF
          ENDIF
.
          MOVE      LXPXMSNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMSNA
.
          MOVE      LXPXMGNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMGNA
.
          MOVE      LXPXMTLE,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMTLE
.
          MOVE      LXPXMAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD1
.
          MOVE      LXPXMAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD1
.                                                           
          MOVE      LXPXMAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD3
.
          MOVE      LXPXMAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD4
.
          MOVE      LXPXMCNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMCNT
.
          MOVE      LXPXFSNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFSNA
.
          MOVE      LXPXMREL,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMREL
.
          MOVE      LXPXFGNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFGNA
.
          MOVE      LXPXFTLE,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFTLE
.
          MOVE      LXPXFAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD1
.
          MOVE      LXPXFAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD2
.
          MOVE      LXPXFAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD3
.
          MOVE      LXPXFAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD4
.
          MOVE      LXPXFCNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFCNT
.
          MOVE      LXPXFREL,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFREL
.
          MOVE      LXVXABRG,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXABRG
.
          MOVE      LXVXCADM,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXCADM
.
          MOVE      LXVXIRAD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXIRAD
.
          MOVE      LXVXIDUS,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXIDUS
.
          MOVE      LXVXCRAV,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXCRAV
.
          MOVE      LXVXRCCT,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXRCCT
.
          MOVE      LXVXAPWD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXAPWD
.
          MOVE      LXVXAPBD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXAPBD
.
          MOVE      LXPXDVAC,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXDVAC
.
          MOVE      LXPXABRG,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXABRG
.
          MOVE      LXPXPRVI,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXPRVI
.
          PACK      LXOTDIC1,SP70                                      *I-58732
          PACK      LXOTDID1,SP70
          PACK      LXOTDIC2,SP70
          PACK      LXOTDID2,SP70
          PACK      LXOTDIC3,SP70
          PACK      LXOTDID3,SP70
          PACK      LXOTDIC4,SP70
          PACK      LXOTDID4,SP70
.
          MOVE      TEMPOUTN,KEY8
          CALL      RDDIAG1 
          IF        OVRCD=0
            MOVE      OPDICODE,LXOTDIC1
            MOVE      OPDIDESC,LXOTDID1
            MOVE      OPDICOD2,LXOTDIC2
            MOVE      OPDIDES2,LXOTDID2
            MOVE      OPDICOD3,LXOTDIC3
            MOVE      OPDIDES3,LXOTDID3
            MOVE      OPDICOD4,LXOTDIC4
            MOVE      OPDIDES4,LXOTDID4
          ENDIF
.                                                                  *end I-58732
.         Get the referral letter file
.
SEVA2000  OPEN      OUTRF1A1,"outrf1af"
.
          PACK      KEY8,OBAOUTNO
          CALL      RDOTRFL1
          BRANCH    OVRCD,SEVA3000
.
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,LXLDTLET       * Letter Date
.
          PACK      LXLRFDRT,SP70                                      *I-55313 
          PACK      LXLRFDRS,SP70                                      *I-55313
          PACK      LXLRFDRG,SP70                                      *I-55313
          PACK      LXRFHPNM,SP70                                      *I-55313
          PACK      LXRFHPA2,SP70                                      *I-59618
          PACK      LXRFHPA3,SP70                                      *I-59618
          PACK      LXRFHPA4,SP70                                      *I-59618
          PACK      LXRFHPA5,SP70                                      *I-59618
          PACK      LXRFHPA6,SP70                                      *I-59618
          PACK      LXRFHPPC,SP70                                      *I-59618
          PACK      LXRFHPPH,SP70                                      *I-55313
          PACK      LXRFHPFX,SP70                                      *I-55313
          PACK      LXLRSEML,SP70,SP70
          PACK      LXLRPRMC,SP70
.
          MOVE      OTRLRDOC,LXLRFDRC       * Referral Doctor
          PACK      KEY10,OTRLRDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,LXLRFDRT
            MOVE      PMHCSNAM,LXLRFDRS
            MOVE      PMHCGNAM,LXLRFDRG
            MOVE      PMHCADR1,LXRFHPNM
            MOVE      PMHCADR2,LXRFHPA2
            MOVE      PMHCADR3,LXRFHPA3
            MOVE      PMHCADR4,LXRFHPA4
            MOVE      PMHCADR5,LXRFHPA5
            MOVE      PMHCADR6,LXRFHPA6
            MOVE      PMHCPOST,LXRFHPPC
            MOVE      PMHCSTEL,LXRFHPPH
            MOVE      PMHCFAXN,LXRFHPFX 
            MOVE      PMHCSEML,LXLRSEML
.
            MATCH     SP70,PMHCPRFC
            IF        !@EQUAL
              PACK      KEY5,CODECZ,PMHCPRFC,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LXLRPRMC
              ELSE
                MOVE      PMHCPRFC,LXLRPRMC
              ENDIF
            ENDIF
.
          ENDIF
.
          PACK      LXLCSEML,SP70,SP70
          PACK      LXLCPRMC,SP70
.
          MOVE      OTRLCONS,LXLHONSC       * Consultant
          PACK      KEY6,OTRLCONS,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,LXLCONST
            MOVE      DSNAME,LXLCONSS
            MOVE      DGNAME,LXLCONSG
            MOVE      PTDOSEML,LXLCSEML
.
            MATCH     SP70,PTDOCOMT
            IF        !@EQUAL
              PACK      KEY5,CODECZ,PTDOCOMT,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,LXLCPRMC
              ELSE
                MOVE      PTDOCOMT,LXLCPRMC
              ENDIF
            ENDIF
.
          ENDIF
          MOVE      OTRLDEPT,LXLDEPT        * Department
          MOVE      OTRLPRIO,LXLPRTY        * Priority 
.
          MOVE      SP70,LXRFPDSC                                      *I-62622
          MATCH     SP70,LXLPRTY
          IF        !@EQUAL
            PACK      KEY5,CODEPR,LXLPRTY
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXRFPDSC      * priority description
            ENDIF
          ENDIF
.                                                                  *end I-62622
          MOVE      OTRLDIAG,LXLDIAG1       * Diagnosis
          MOVE      OTRLUSD1,LXLUDF1        * User Defined Field 1
          MOVE      OTRLUSD2,LXLUDF2        * User Defined Field 2
          MOVE      OTRLUSD3,LXLUDF3        * User Defined Field 3
          MOVE      OTRLUSD4,LXLUDF4        * User Defined Field 4
          MOVE      OTRLRQST,LXLREQNO       * Request Number
.
          UNPACK    OTRLCDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,LXLRACDT       * Request for Appointment Canc. Date
.
          MOVE      OTRLREAS,LXLREQRE       * Reason for Request        "RQ"
          MOVE      OTRLSPFC,LXLSPFCD       * Specialty Function Code   "OF"
          MOVE      OTRLCAD1,LXLCADD1       * Correspondence Address Line 1
          MOVE      OTRLCAD2,LXLCADD2       * Correspondence Address Line 2
          MOVE      OTRLCAD3,LXLCADD3       * Correspondence Address Line 3
          MOVE      OTRLCAD4,LXLCADD4       * Correspondence Address Line 4
          MOVE      OTRLCPC,LXLCADPC        * Correspondence Post Code
          MOVE      OTRLECRN,LXLECRNO       * ECR Approval Number
          MOVE      OTRLGPFH,LXLGPFHN       * GPFH Approval Number
          MOVE      OTRLCTYP,LXLCLTYP       * Clinic Type of Referral
.                                           * Start of additional code *I-90301
          MOVE      SP30,OCTDESC
          PACK      KEY12,SITE,OTRLCTYP,SP20 * IDDD = current SITE     *C-57513
          CALL      RDCTYA1
          MOVE      OCTDESC,LXLCLDES        * Clinic Description of Referral
.                                           * End of additional code   *I-90301
.
          MOVE      OTRLSRCE,LXLRFSRC       * Source of referral
          MOVE      OTRLRHCP,LXLRHCPC       * Responsible HCP   
          MOVE      SP70,RESPFDRT
          MOVE      SP70,RESPFDRS
          MOVE      SP70,RESPFDRG
          MOVE      SP70,RESPHPNM 
          MOVE      SP70,RESPHPA2 
          MOVE      SP70,RESPHPA3 
          MOVE      SP70,RESPHPA4 
          MOVE      SP70,RESPHPA5 
          MOVE      SP70,RESPHPA6 
          MOVE      SP70,RESPHPPC 
          MOVE      SP70,RESPHPPH 
          MOVE      SP70,RESPHPFX 
          PACK      RESPSEML,SP70,SP70
          PACK      RESPPMOC,SP70
.
          PACK      KEY10,OTRLRHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,RESPFDRT
            MOVE      PMHCSNAM,RESPFDRS
            MOVE      PMHCGNAM,RESPFDRG
            MOVE      PMHCADR1,RESPHPNM
            MOVE      PMHCADR2,RESPHPA2
            MOVE      PMHCADR3,RESPHPA3
            MOVE      PMHCADR4,RESPHPA4
            MOVE      PMHCADR5,RESPHPA5
            MOVE      PMHCADR6,RESPHPA6
            MOVE      PMHCPOST,RESPHPPC
            MOVE      PMHCSTEL,RESPHPPH
            MOVE      PMHCFAXN,RESPHPFX
            MOVE      PMHCSEML,RESPSEML
.
            MATCH     SP70,PMHCPRFC
            IF        !@EQUAL
              PACK      KEY5,CODECZ,PMHCPRFC,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,RESPPMOC
              ELSE
                MOVE      PMHCPRFC,RESPPMOC
              ENDIF
            ENDIF
.
          ENDIF
          MOVE      OTRLDREC,LXLDTREC       * Date Referral Received
          MOVE      OTRLDPRI,LXLDTPTY       * Date of Priority         
          MOVE      OTRLPURC,LXLEXPUR       * Expected Purchaser       
          MOVE      OTRLRANK,LXLRANK        * Patient Rank
.
          MATCH     SP10,OTRLRFGP
          GOTO      SEVA2500 IF EQUAL
.
          PACK      KEY10,OTRLRFGP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA2500
.                                           * set up Surgery Address
          MOVE      PMHCTITL,RFGPTITL
          MOVE      PMHCSNAM,RFGPSNAM
          MOVE      PMHCGNAM,RFGPGNAM
          MOVE      PMHCADR1,RFGPADD1
          MOVE      PMHCADR2,RFGPADD2
          MOVE      PMHCADR3,RFGPADD3
          MOVE      PMHCADR4,RFGPADD4
          MOVE      PMHCPOST,RFGPPOST
.
          MOVE      PMHCSTEL,RFGPTELP
          MOVE      PMHCFAXN,RFGPFAXN
          MOVE      PMHCSEML,RFGPEMAL
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,RFGPPRMC
            ELSE
              MOVE      PMHCPRFC,RFGPPRMC
            ENDIF
          ENDIF
.
.                                           * load Practice from Surgery Address
          MOVE      PMHCADR1,RFPRSAD1
          MOVE      PMHCADR2,RFPRSAD2
          MOVE      PMHCADR3,RFPRSAD3
          MOVE      PMHCADR4,RFPRSAD4
          MOVE      PMHCPOST,RFPRSPCD
          MOVE      PMHCSTEL,RFPRTELE
          MOVE      PMHCFAXN,RFPRFAXN
.
SEVA2500  MATCH     SP10,OTRLGPPC
          GOTO      SEVA3000 IF EQUAL
.
          PACK      KEY10,OTRLGPPC,SP70
          PACK      KEY12,KEY10,OTRLGPPT,SP70 * Practice address
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA3000
.                                           * replace Surgery data with Practice
          MATCH     SP70,PMHGADD1
          IF        !@EQUAL
            MOVE      PMHGPNAM,RFPRSURG
            MOVE      PMHGADD1,RFPRSAD1
            MOVE      PMHGADD2,RFPRSAD2
            MOVE      PMHGADD3,RFPRSAD3
            MOVE      PMHGADD4,RFPRSAD4
            MOVE      PMHGPOST,RFPRSPCD
          ENDIF
          MATCH     SP70,PMHGPTEL
          IF        !@EQUAL
            MOVE      PMHGPTEL,RFPRTELE
          ENDIF
          MATCH     SP70,PMHGPFAX
          IF        !@EQUAL
            MOVE      PMHGPFAX,RFPRFAXN
          ENDIF
.
SEVA3000  MOVE      ONE,F2                  * Extra Scree Cat Code 1
          CALL      XCCD0000
          MOVE      TWO,F2                  * Extra Scree Cat Code 2
          CALL      XCCD0000
          MOVE      THREE,F2                * Extra Scree Cat Code 3
          CALL      XCCD0000
          MOVE      FOUR,F2                 * Extra Scree Cat Code 4
          CALL      XCCD0000
          MOVE      FIVE,F2                 * Extra Scree Cat Code 5
          CALL      XCCD0000
          MOVE      SIX,F2                  * Extra Scree Cat Code 6
          CALL      XCCD0000
          MOVE      SEVEN,F2                * Extra Scree Cat Code 7
          CALL      XCCD0000
          MOVE      EIGHT,F2                * Extra Scree Cat Code 8
          CALL      XCCD0000
          MOVE      NINE,F2                 * Extra Scree Cat Code 9
          CALL      XCCD0000
          MOVE      TEN,F2                  * Extra Scree Cat Code 10
          CALL      XCCD0000
          MOVE      TEN1,F2                 * Extra Scree Cat Code 11
          CALL      XCCD0000
          MOVE      TEN2,F2                 * Extra Scree Cat Code 12
          CALL      XCCD0000
          MOVE      TEN3,F2                 * Extra Scree Cat Code 13
          CALL      XCCD0000
          MOVE      TEN4,F2                 * Extra Scree Cat Code 14
          CALL      XCCD0000
          MOVE      TEN5,F2                 * Extra Scree Cat Code 15
          CALL      XCCD0000
          MOVE      TEN6,F2                 * Extra Scree Cat Code 16
          CALL      XCCD0000
          MOVE      TEN7,F2                 * Extra Scree Cat Code 17
          CALL      XCCD0000
          MOVE      TEN8,F2                 * Extra Scree Cat Code 18
          CALL      XCCD0000
          MOVE      TEN9,F2                 * Extra Scree Cat Code 19
          CALL      XCCD0000
          MOVE      TWENTY,F2               * Extra Scree Cat Code 20
          CALL      XCCD0000
.
          MOVE      OTBBPURC,LINE
          PACK      LXHPCODE,LINE,SP70
.
          PACK      KEY5,CATHP,OTBBPURC,SP70
          MOVE      SP70,TDESC
          CALL      RDCODE1
          MOVE      TDESC,LINE
          PACK      LXHPDESC,TDESC,SP70
.
          CALL      GSMSID00                 * Get SMS message id
          MOVE      IBSQNEXT,LXXSMSID        * SMS message id
.
          PACK      LXXSMSKY,SP1,TWO,TEMPOUTN,SP70    * SMS message key
          MOVE      LETTFORM,LXSMSCOD        * SMS Code (Letter Number)
          MOVE      PTMXCELL,LXXSMSPH        * SMS Phone Number
          MOVE      PURNO,LXXSMSUR           * SMS U/R
          MOVE      SP70,LXXSMSUS            * SMS User
          MOVE      SP70,LXXSMSUN            * SMS User Name
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD<>1
           MATCH      PASSCODE,WBSEPCD
           IF         @EQUAL
             MOVE      WBSEUID,LXXSMSUS      * SMS User
             MOVE      WBSENAM,LXXSMSUN      * SMS User Name
           ENDIF
          ENDIF
.
          PACK      KEY25,OTLPSITE,OTLPCLIN,OTLPSDAT,OTLPSTIM,SP70
          CALL      RDSESA1
          IF        OVRCD=0
            PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
            CALL      RDOTHED1
            IF        OVRCD=0
              PACK      KEY10,OTHEDEFD,SP70
              CALL      RDPMHCP1
              IF        OVRCD=0
                STRIP     PMHCTITL
                STRIP     PMHCGNAM
                STRIP     PMHCSNAM
                PACK      LXDRDFLT,PMHCTITL,SP1,PMHCGNAM,SP1,PMHCSNAM
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,TEMPOUTN,SP70
          CALL      RDBOKB1
          IF        OVRCD=0
            PACK      KEY10,OTBBADCS
            CALL      RDPMHCP1
            IF        OVRCD=0
              STRIP     PMHCTITL
              STRIP     PMHCGNAM
              STRIP     PMHCSNAM
              PACK      LXDRSEEN,PMHCTITL,SP1,PMHCGNAM,SP1,PMHCSNAM
            ENDIF
          ENDIF
.
          CALL      LAHR0000                 * Linked A/H referral fields
          CALL      OTHI0000                 * Outpatient Telehelath Information
.
SEVA4000  MOVE      SP70,WORKGP              * var to save Ref GP 
. 
          MOVE      OTLPUID,LXOLPUID
          MOVE      OTLPLOGN,LXOLPLGN
.
          MATCH     "1",OTCNGPSO             * Outpatient Letter GP & Practice 
          GOTO      SEVA4050 IF EQUAL      
.
.         0 (default) = Booking, then Referral, then PMI
.
.         Check Booking 
SEVA4010  MOVE      OTBBRFGP,WORKGP          * save GP  
.
          MATCH     SP10,OTBBGPPC            * check Practice
          IF        @EQUAL | @EOS
            GOTO      SEVA4020                
          ENDIF
.
          MATCH     SP10,OTBBGPPT            * check Practice count
          IF        @EQUAL | @EOS
            GOTO      SEVA4020                
          ENDIF
.
          PACK      KEY10,OTBBRFGP,SP70      * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4015
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4015  PACK      KEY10,OTBBGPPC,SP70        * Check Practice
          PACK      KEY12,KEY10,OTBBGPPT,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         Check Referral
SEVA4020  MATCH     SP70,WORKGP
          IF        @EQUAL
            MOVE      ALRERHCP,WORKGP
          ENDIF     
.                                                                       
          MATCH     SP10,ALRERHCR
          IF        @EQUAL | @EOS
            GOTO      SEVA4030           
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4025
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4025  PACK      KEY12,ALRERHCR,ALRERHCT,SP70  * Referring Practice
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         Check PMI
SEVA4030  MATCH     SP70,WORKGP
          IF        @EQUAL
            MOVE      PMPXRHC1,WORKGP
          ENDIF
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL | @EOS
            GOTO      SEVA4040             
          ENDIF
.
          PACK      KEY10,PMPXRHC1,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4035
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4035  PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         No Practice exists, then display first GP found
SEVA4040  MATCH     SP70,WORKGP
          GOTO      SEVA4099 IF EQUAL
.
          PACK      KEY10,WORKGP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF          
.
          GOTO      SEVA4099
.
. if OTCNGPSO = 1 - Booking, then PMI, then Referral          
.
.         Check Outpatient Booking
SEVA4050  MOVE      OTBBRFGP,WORKGP          * save GP
.
          MATCH     SP10,OTBBGPPC            * check Practice
          IF        @EQUAL | @EOS
            GOTO      SEVA4060
          ENDIF
.
          MATCH     SP10,OTBBGPPT            * check Practice count
          IF        @EQUAL | @EOS
            GOTO      SEVA4060
          ENDIF
.
          PACK      KEY10,OTBBRFGP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4055
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4055  PACK      KEY10,OTBBGPPC,SP70        * Referring Practice
          PACK      KEY12,KEY10,OTBBGPPT,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         Check PMI
SEVA4060  MATCH     SP70,WORKGP
          IF        @EQUAL
            MOVE      PMPXRHC1,WORKGP
          ENDIF
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL | @EOS
            GOTO      SEVA4070
          ENDIF
.
          PACK      KEY10,PMPXRHC1,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4065
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4065  PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70  * Referring Practice
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         Check Referral
SEVA4070  MATCH     SP70,WORKGP
          IF        @EQUAL
            MOVE      ALRERHCP,WORKGP
          ENDIF
.
          MATCH     SP10,ALRERHCR
          IF        @EQUAL | @EOS
            GOTO      SEVA4080
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4075
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
SEVA4075  PACK      KEY12,ALRERHCR,ALRERHCT,SP70  * Referring Practice
          CALL      RDPMHCG1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHGPRAC,LXOGPCDE
          MOVE      PMHGPNAM,LXOGPNME
          MOVE      PMHGADD1,LXOGPAL1
          MOVE      PMHGADD2,LXOGPAL2
          MOVE      PMHGADD3,LXOGPAL3
          MOVE      PMHGADD4,LXOGPAL4
          MOVE      PMHGPOST,LXOGPPST
          MOVE      PMHGPEML,LXOGPEML
          MOVE      PMHGPTEL,LXOGPTEL
          MOVE      PMHGPFAX,LXOGPFAX
          MOVE      PMHGSTTS,LXOGPATV
          GOTO      SEVA4099
.
.         No Practice exists, then display first GP found
SEVA4080  MATCH     SP70,WORKGP
          GOTO      SEVA4099 IF EQUAL
.
          PACK      KEY10,WORKGP,SP70     * Referring HCP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SEVA4099
.
          MOVE      PMHCHCPC,LXOGCODE
          MOVE      PMHCTITL,LXOGTITL
          MOVE      PMHCSNAM,LXOGSUNM
          MOVE      PMHCGNAM,LXOGGVNM
          MOVE      PMHCSEML,LXOGEMAL
          MOVE      PMHCSTTS,LXOGACTV
.
          MOVE      PMHCPRFC,LXOGCONT
.
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXOGCNTD
            ENDIF
          ENDIF
.
.
SEVA4099  GOTO      SEVA8000
.
SEVA8000  MOVE      FALSE,EXIT
          GOTO      SEVA9999
.
SEVA9000  MOVE      TRUE,EXIT
.
SEVA9999  RETURN
.
.-----------------------------------------------------------------------------
. Print patient master deails
.-----------------------------------------------------------------------------
PMAST000  MOVE      PUSR1,LXPUSRAC
          MOVE      SP70,LXPUSRAD
          MOVE      SP70,LXPUSRAL
.
          MATCH     SP70,PUSR1
          IF        !@EQUAL
            PACK      KEY5,ANSP,ONE,PUSR1,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRAD
            MOVE      PTCDLDES,LXPUSRAL
          ENDIF
.
          MOVE      PUSR2,LXPUSRBC
          MOVE      SP70,LXPUSRBD
          MOVE      SP70,LXPUSRBL
.
          MATCH     SP70,PUSR2
          IF        !@EQUAL
            PACK      KEY5,ANSP,TWO,PUSR2,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRBD
            MOVE      PTCDLDES,LXPUSRBL
          ENDIF
.
          MOVE      PUSR3,LXPUSRCC
          MOVE      SP70,LXPUSRCD
          MOVE      SP70,LXPUSRCL
.
          MATCH     SP70,PUSR3
          IF        !@EQUAL
            PACK      KEY5,ANSP,THREE,PUSR3,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRCD
            MOVE      PTCDLDES,LXPUSRCL
          ENDIF
.
          MOVE      PUSR4,LXPUSRDC
          MOVE      SP70,LXPUSRDD
          MOVE      SP70,LXPUSRDL
.
          MATCH     SP70,PUSR4
          IF        !@EQUAL
            PACK      KEY5,ANSP,FOUR,PUSR4,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRDD
            MOVE      PTCDLDES,LXPUSRDL
          ENDIF
.
          MOVE      PUSR5,LXPUSREC
          MOVE      SP70,LXPUSRED
          MOVE      SP70,LXPUSREL
.
          MATCH     SP70,PUSR5
          IF        !@EQUAL
            PACK      KEY5,ANSP,FIVE,PUSR5,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRED
            MOVE      PTCDLDES,LXPUSREL
          ENDIF
.
          MOVE      PUSR6,LXPUSRFC
          MOVE      SP70,LXPUSRFD
          MOVE      SP70,LXPUSRFL
.
          MATCH     SP70,PUSR6
          IF        !@EQUAL
            PACK      KEY5,ANSP,SIX,PUSR6,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRFD
            MOVE      PTCDLDES,LXPUSRFL
          ENDIF
.
PMAST999  RETURN
+
.*****************************************************************************
. Get linked allied health referral referring GP and practice fields         *
.*****************************************************************************
LAHR0000  MOVE      SP70,LXRGPGTL
          MOVE      SP70,LXRGPGNM
          MOVE      SP70,LXRGPSNM
          MOVE      SP70,LXRGPPNM
          MOVE      SP70,LXRGPPA1
          MOVE      SP70,LXRGPPA2
          MOVE      SP70,LXRGPPA3
          MOVE      SP70,LXRGPPA4
          MOVE      SP70,LXRGPPPC
.
          PACK      KEY16,TEMPOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,LAHR9999
.
          MOVE      TEMPOUTN,KEY8
          MATCH     KEY8,ALLNLNKV
          GOTO      LAHR9999 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LAHR9999
.
          MATCH     SP70,ALRERHCP
          GOTO      LAHR5000 IF EQUAL
.
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,LAHR5000
.
          MOVE      PMHCTITL,LXRGPGTL
          MOVE      PMHCGNAM,LXRGPGNM
          MOVE      PMHCSNAM,LXRGPSNM
          MOVE      SP70,LXRGPPNM
          MOVE      PMHCADR1,LXRGPPA1
          MOVE      PMHCADR2,LXRGPPA2
          MOVE      PMHCADR3,LXRGPPA3
          MOVE      PMHCADR4,LXRGPPA4
          MOVE      PMHCPOST,LXRGPPPC

LAHR5000  MATCH     SP70,ALRERHCR
          GOTO      LAHR8000 IF EQUAL
.
          PACK      KEY12,ALRERHCR,ALRERHCT,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,LAHR8000
.
          MOVE      PMHGPNAM,LXRGPPNM
.
          MATCH     SP70,PMHGADD1
          GOTO      LAHR8000 IF EQUAL
.
          MOVE      PMHGADD1,LXRGPPA1
          MOVE      PMHGADD2,LXRGPPA2
          MOVE      PMHGADD3,LXRGPPA3
          MOVE      PMHGADD4,LXRGPPA4
          MOVE      PMHGPOST,LXRGPPPC
.
LAHR8000  MOVE      LXRGPPNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPNM
.
          MOVE      LXRGPPA1,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPA1
.
          MOVE      LXRGPPA2,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPA2
.
          MOVE      LXRGPPA3,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPA3
.
          MOVE      LXRGPPA4,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPA4
.
          MOVE      LXRGPPPC,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPPPC
.
LAHR9999  RETURN
+
.*****************************************************************************
.  Get Outpatient Telehealth Info(OUTTHIFD) & Visits Record Based Comments   *
.*****************************************************************************
OTHI0000  PACK      LXSTCODE,SP70      
          PACK      LXSTDESC,SP70     
          PACK      LXRESITE,SP70,SP70,SP70,SP70
          PACK      LXRECODE,SP70    
          PACK      LXREADDR,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70 
          PACK      LXWRMURL,SP70,SP70,SP70,SP70 
          PACK      LXRECPHN,SP70   
          PACK      LXALLNTS,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70,SP70 
.
          PACK      KEY8,TEMPOUTN,SP70
          CALL      RDOTTHI1
          BRANCH    OVRCD,OTHI0010
.
          PACK      LXSTCODE,OTTHSTAT      * Telehealth Status (Category OM)
          PACK      LXRESITE,OTTHRSIT      * Telehealth Receiving SiteName
          PACK      LXRECODE,OTTHRCOD      * Telehealth Receiving Code
          PACK      LXREADDR,OTTHRADD      * Telehealth Receiving Address
          PACK      LXWRMURL,OTTHWURL      * Telehealth Waiting room URL
          PACK      LXRECPHN,OTTHE164      * Telehealth Receiving E164
          PACK      KEY5,CODEOM,LXSTCODE   * Status Code  
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXSTDESC        * Telehealth Status Description
          ENDIF
.
OTHI0010  CLEAR     LXALLNTS
          MOVE      "021",KEY3
          MOVE      ZERO,COUNT1
          MOVE      TEMPOUTN,KEY8
          PACK      KEY14,KEY8,KEY3,SP70
          CALL      RDVSCMT1
OTHI0020  CALL      RKVSCMT1
          BRANCH    OVRCD,OTHI9999         * end of file
          MATCH     VSCTVIST,KEY8          * same Admission Number
          GOTO      OTHI9999 IF NOT EQUAL 
          MATCH     VSCTTYPE,KEY3
          GOTO      OTHI9999 IF NOT EQUAL
.
          STRIP     VSCTDATA
          APPEND    VSCTDATA,LXALLNTS      * Telehealth Notes
          ADD       ONE,COUNT1
          IF        COUNT1>11
            GOTO      OTHI9999
          ELSE
            APPEND    SP1,LXALLNTS
            GOTO      OTHI0020
          ENDIF
.
OTHI9999  RESET     LXALLNTS
          RETURN
.*****************************************************************************
.*                             SHSP0000                                      *
.*               Set up hospital details for multi hospital                  *
.*****************************************************************************
.
SHSP0000  PACK      PTHSHOSP,SP30,SP30
          PACK      PTHSADD1,SP30,SP30
          PACK      PTHSADD2,SP30,SP30
          PACK      PTHSADD3,SP30,SP30
          PACK      PTHSADD4,SP30,SP30
          PACK      PTHSPCOD,SP30,SP30
          PACK      PTHSTELE,SP30,SP30
          PACK      PTHSNAME,SP30,SP30,SP10
.
          PACK      KEY3,OTMAHOSP
          CALL      RDPTHSP1
            
SHSP9999  RETURN
.****************************************************************************
.*                              GCMA0000                                    *
.*                      Get a clinic master record                          *
.****************************************************************************
.
GCMA0000  MOVE      ZERO,EXIT
.
          REP       " 0",TEMPDATE
          MATCH     "00000000",TEMPDATE
          IF        !@EQUAL
            UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DATECONV
            BRANCH    EXIT,GCMA9999
          ENDIF
.
          PACK      KEY18,SITE,TEMPCLID,WEEKDAY,TEMPSTRT
          CALL      RDMASA1
          IF        OVRCD = 1
            MOVE      ONE,EXIT
            GOTO      GCMA9999
          ENDIF
.
          MOVE      OTMAROOM,LXMAROOM
.
          PACK      KEY25,SITE,TEMPCLID,TEMPDATE,TEMPSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GCMA9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=0
            MOVE      OTHECOM1,OMACOM1
            MOVE      OTHECOM2,OMACOM2
            MOVE      OTHEINS1,OTMAINS1
            MOVE      OTHEINS2,OTMAINS2
            MOVE      OTHEINS3,OTMAINS3
            MOVE      OTHECTEL,LXHECTEL
            MOVE      OTHECIND,OMACIND
            MOVE      OTHELTYP,OTMALTYP
            MOVE      OTHELTYP,LXLTYPCD
            MOVE      OTHEHOSP,OTMAHOSP
.            
            PACK      KEY5,ANSC,ANST,LXLTYPCD
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,LXLTYPLD
            ENDIF
          ENDIF
.
GCMA9999  RETURN
+
.****************************************************************************
.*                              SUSL0000                                    *
.*                        Set up standard Letter Number                     *
.****************************************************************************
.
SUSL0000  MOVE      ZERO,EXIT
.
          IF        OPTION=6
            MOVE      OTMABKLT,LETTER         * Printing clinic master booking
            GOTO      SUSL8000                * letters from IBAOUT71 option 6
          ENDIF                               * only allows status booked
.
          MATCH     ANSR,TEMPRSHF
          IF        @EQUAL
            MOVE      OTMARSLT,LETTER
            CALL      CIHOP000                * check if hosp or pat re-sched.
          ELSE
            PACK      KEY5,CODECV,OBAVISIT
            CALL      RDCODE1
            BRANCH    OVRCD,SUSL9000
.
            MATCH     ANSN,TCINDC1
            IF        @EQUAL
              MOVE      OTMABKLT,LETTER
            ELSE
              MOVE      OTMARALT,LETTER
            ENDIF
          ENDIF
.
SUSL8000  MATCH     "  0",LETTER
          GOTO      SUSL9000 IF EQUAL       * ignore zero letters
          GOTO      SUSL9999
.
SUSL9000  MOVE      TRUE,EXIT
.
SUSL9999  RETURN
+
.*************************************************************************
.*                       SULD0000                                        *   
.*              set up some letter details                               *
.*************************************************************************
SULD0000  UNPACK    SP30,RESHFROM,RESHTO,CANDATE
          CALL      CLLXCN00
          MOVE      TEMPOUTN,KEY8
          CALL      RDOTCAN1
          BRANCH    OVRCD,SULD1000
          UNPACK    OPCNRDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,CANDATE         * date of cancellation
.
          MOVE      OPCNSITE,LXCNSITE       * site of cancelled booking
.
          MOVE      OPCNCLIN,LXCNCLIN       * clinic of cancelled booking    
.
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * date of cancelled booking
          MOVE      CPCDATE,LXCNDATE 
.
          MOVE      OPCNSTRT,WORKTIME
          CALL      TIME0000                * format cancelled sess start time
          MOVE      FRMTTIME,LXCNSTRT
.
          MOVE      OPCNSLOT,LXCNSLOT       * cancelled session slot number
.
          MOVE      OPCNTIME,WORKTIME
          CALL      TIME0000                * format cancelled sess slot time
          MOVE      FRMTTIME,LXCNTIME 
.
          MOVE      OPCNOUTN,LXCNNOUT       * Outpatient number cancelled
.
          MOVE      OPCNURNO,LXCNURNO       * U/R Number Cancelled
.
          PACK      KEY5,CODECB,OPCNREAS
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNREAS          * Reason for Cancellation
          ENDIF
.
          MOVE      OPCNRTIM,WORKTIME
          CALL      TIME0000                * format time of cancellation
          MOVE      FRMTTIME,LXCNRTIM
.
          PACK      KEY5,CODES,OPCNSRCR
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNSRCR          * Cancelled Src of Referral
          ENDIF
.
          PACK      KEY5,CODECL,OPCNCOMP
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNCOMP          * Cancelled Comp Code
          ENDIF
.
          PACK      KEY5,CODEA,OPCNCLAS
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNCLAS          * Cancelled Patient Class
          ENDIF
.
          PACK      KEY5,CODEU1,OPCNINS
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNINSU          * Cancelled Ins. Status
          ENDIF
.
          PACK      KEY5,CODEP,OPCNCAT
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNCATE          * Cancelled Patient Cat. 
          ENDIF
.
          PACK      KEY5,CODEPR,OPCNPRTY
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNPRTY          * Cancelled Priority Code
          ENDIF
.
          MOVE      OPCNOPER,LXCNOPER       * Operator ID.
.
          PACK      KEY5,CODEOB,OPCNTRAN
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNTRAN          * Cancelled Priority Code
          ENDIF 
.
          MOVE      OPCNVTYP,LXCNVTPC
          PACK      KEY5,CODECV,OPCNVTYP
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE    TDESC,LXCNVTYP          * Visit Type of Booking
          ENDIF
.
          MOVE      OPCNRLRR,LXCNRLRR       * Referral Letter - Referral Reason
.
.         check if rescheduled
.
SULD1000  PACK      CFNAME,OSTFILE,FILRSHA1
          OPEN      OUTRSHA1,CFNAME
          MOVE      SP3,OPRSREAS            * clear the reason
          PACK      KEY11,TEMPOUTN,Z10 
          CALL      RDSRSHA1
          CALL      RDPRSHA1
          CLOSE     OUTRSHA1
          BRANCH    OVRCD,SULD9999
          MATCH     TEMPOUTN,OPRSOUTN
          GOTO      SULD9999 IF NOT EQUAL
.
          MOVE      OPRSDATE,WORKDATE
          CALL      FDAT0000                * format resched. from date
          MOVE      DATELINE,RESHFROM       
.
          MOVE      OPRSTIME,WORKTIME       
          CALL      TIME0000                * format resched. from time
          MOVE      FRMTTIME,LXRESFTM
.
          MOVE      OPRSNDAT,WORKDATE
          CALL      FDAT0000                * format resched. to date
          MOVE      DATELINE,RESHTO
.
          MOVE      OPRSNTIM,WORKTIME
          CALL      TIME0000                * format attendence time
          MOVE      FRMTTIME,RESHTIME
.
.                                           * Rescheduled from day of week
.
          MATCH     SP70,OPRSDATE
          IF        !@EQUAL
            UNPACK    OPRSDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DATECONV
            BRANCH    EXIT,SULD2000
            LOAD      LXRESFRD,WEEKDAY,DMON,DTUE,DWED,DTHU,DFRI,DSAT,DSUN
          ENDIF
.
SULD2000  PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE * format rescheduled from clinic 
          CALL      RDCLIA1                 * description
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     OPRSSITE,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ELSE
                MATCH     OPRSCLIN,OCACLIN
                IF        !@EQUAL
                  MOVE      ONE,OVRCD
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          IF        OVRCD = 1
            MOVE      "Unknown clinic",OCADESC
            PACK      OCADESC,OCADESC,SP30
          ENDIF
          MOVE      OCADESC,LXRESCLN
.
          IF        FSTATUS = 2   
            PROC      GRHSP000
          ELSE
            MATCH     ANSR,TEMPRSHF
            IF        @EQUAL
              PROC      GRHSP000
            ENDIF
          ENDIF
.
SULD9999  RETURN
+
.***************************************************************************
.*                         GRHSP000                                        *
.*          Get Hospital for Reschedule Letters                            *
.***************************************************************************
.
          DEFPROC   GRHSP000
.
          INC       OUTMA1FD/INC
          INC       OUTSITFD/INC
.
. -----  get the site prefix  -----
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      OPRSSITE,KEY6
          CALL      RDSITA1
          CLOSE     OUTSITA1
          BRANCH    OVRCD,GRHSP999
.
. -----  get the hospital code from the clinic master for new clinic  -----
.
          REP       " 0",OPRSNDAT
          MATCH     "00000000",OPRSNDAT
          IF        !@EQUAL
            UNPACK    OPRSNDAT,CCENT,CYEAR,CMON,CDAY
            CALL      DATECONV
            BRANCH    EXIT,GRHSP999
          ENDIF
.
          PACK      CFNAME,OSTFILE,FILMA1A1
          CALL      OPOTMA11
          PACK      KEY18,OPRSSITE,OPRSNCLI,WEEKDAY,OPRSNSTR
          CALL      RDMASA1
          CLOSE     OUTMA1A1
          BRANCH    OVRCD,GRHSP999               * invalid clinic
.
. -----  read the hospital file for new hospital details  -----
.
          MOVE      OTMAHOSP,KEY3
          CALL      RDPTHSP1
          GOTO      GRHSP999
.
          INC       IBAOVRIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSITIO/INC
.
GRHSP999  ENDPROC
+
.**********************************************************************
.*                  PRIN0000                                          *
.*             Set up and print letter one line at a time             *
.*        Returns : EXIT = 0      ask if to print more letters        *
.*                  EXIT = 1      select another letter to print      *
.*                  EXIT = 2      get next item on temp file          *
.**********************************************************************
PRIN0000  MOVE      LETTER,LETTFORM
          CALL      LETEXE00
          COMPARE   ZERO,EXIT
          GOTO      PRIN9400 IF EQUAL
.
          MOVE      FALSE,EXIT
....      MOVE      ONE,COUNT               * line number to print
          MOVE      ZERO,COUNT              * I CAR 47288
          MOVE      LETTER,LETTFORM
.
          MOVE      ZERO,FORM3              * read letter file header
          PACK      KEY6,LETTFORM,FORM3     *    record
          CALL      RDOTLET1
          BRANCH    OVRCD,PRIN9500
.
          MOVE      OTLTPPAG,PHYSPAGE       * physical paper length
          MOVE      OTLTPTOP,TOPMARG        * top margin
          MOVE      OTLTPBOT,BOTTMARG       * bottom margin
          SUBTRACT  OTLTPBOT,OTLTPPAG       * where to print to at bottom
          MOVE      OTLTPPAG,MLETPLEN       * length to print to 
          MOVE      OTLTPTAB,LEFTMARG       * left margin
.
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      PRIN0500 IF NOT EQUAL
.
          MOVE      OTLTCOMM,LETRCOMM       * Store our Communication Method
          MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            MOVE      ONE,TOPMARG           * Default top margin to 1
            MOVE      ONE,BOTTMARG          * Default bottom margin to 1
            MOVE      ONE,LEFTMARG          * Default left margin to 1
            MOVE      LETTFORM,LXSMSCOD     * SMS Code (Letter Number)
            CALL      PRSMSH00              * Print SMS Message XML Header Tag
            GOTO      PRIN1000
          ENDIF
.
.
.------ print top margin ------
.
.... CAR 47288
PRIN0500  WHILE     COUNT<TOPMARG
            PRINT     *N;                     * print blank line
            ADD       ONE,COUNT
          DO
.....
.
. ------- print letter one line at a time ------
.
PRIN1000  CALL      RKOTLET1
          BRANCH    OVRCD,PRIN9000          * end of letter reached
.
          COMPARE   LETTFORM,OTLTLTNO
          GOTO      PRIN9000 IF NOT EQUAL   * different letter number
.
          BRANCH    OTLTLVAR,PRIN2000       * have a % var
.
.         printing when no % variables
.
          PRINT     *LEFTMARG,OTLTTEXT,*N;  * print text if no % vars
          ADD       ONE,COUNT
.
          MATCH     "1",LETRCOMM            * SMS Notification?
          GOTO      PRIN1000 IF EQUAL
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRIN1000
.
.         printing when have % variables
.
PRIN2000  CALL      MOD0000                 * substitute % var value
          IF        PRNTLONG=1
            PRINT     *+,*LEFTMARG,PRTSTRNG,*N;  * print text with % vars
          ELSE
            MOVE      PRTSTRNG,PRTSTR70
            PRINT     *LEFTMARG,PRTSTR70,*N;  * print text with % vars
          ENDIF
          ADD       ONE,COUNT
.
          MATCH     "1",LETRCOMM            * SMS Notification?
          GOTO      PRIN1000 IF EQUAL
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRIN1000
.
. ------- end of current letter reached -------
.
PRIN9000  MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRSMSF00              * Print SMS Message XML Footer Tag
          ENDIF
.
          MOVE      PHYSPAGE,TEMP3          * set up variables for paging
          SUBTRACT  COUNT,PHYSPAGE
          MOVE      ONE,COUNT
.
.------ paginate at end of each letter ------
.
PRIN9100  WHILE     COUNT<PHYSPAGE
            PRINT     *N;
            ADD       ONE,COUNT
          DO
.
PRIN9400  MOVE      TEMP3,PHYSPAGE          * restore physical page length
          MOVE      TWO,EXIT                * indicate to continue
.
          COMPARE   ONE,OTCNLHIA
          GOTO      PRIN9999 IF NOT EQUAL
          MOVE      TEMPURNO,OTLHURNO
          MOVE      TODAY,OTLHDATE
          MOVE      LETTER,OTLHLNUM
          MOVE      SITE,OTLHSITE
          MOVE      TEMPCLID,OTLHCLIN
          MOVE      TEMPDATE,OTLHCDAT
          MOVE      TEMPSTRT,OTLHCTIM
          MOVE      TEMPSLOT,OTLHSLOT
          MOVE      TEMPOUTN,OTLHOUTN
          MOVE      TEMPPUID,OTLHPUID
.
          PACK      KEY27,TEMPURNO,TODAY,OTLHLNUM,OTLHOUTN
          CALL      RDOTLHI1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WROTLHI1
            TRAPCLR   IO
          ENDIF
.
          GOTO      PRIN9999
.
.
.------ letter header is on file but nothing else ------
.
PRIN9500 
..            DISPLAY   *P1:24,*EL,*B,"Letter ",LETTFORM," not on file. ";
..            CALL      HITENTER
..            MOVE      TRUE,EXIT               * enter another letter code
PRIN9999  RETURN
+
.**********************************************************************
.*                              PAGE0000                              *
.*        Routine to paginate if a new page is required               *
.**********************************************************************
PAGE0000  MOVE      OTLTLTNO,FORM3
          MOVE      OTLTLINO,FORM3A
          CALL      RKOTLET1
          BRANCH    OVRCD,PAGE8000                * check to see that
          COMPARE   LETTFORM,OTLTLTNO               *  another line of the
          GOTO      PAGE8000 IF NOT EQUAL         *  letter exists
          MOVE      TOPMARG,TMPFORM2
          ADD       BOTTMARG,TOPMARG
          MOVE      ZERO,COUNT
.
.------ loop to paginate ------
.
PAGE1000  WHILE     COUNT<TOPMARG 
            PRINT     *N;
            ADD       ONE,COUNT
          DO
.
.------ no need to paginate ------
.
PAGE8000  PACK      KEY6,FORM3,FORM3A
          CALL      RDOTLET1
          GOTO      PAGE9999
.
.------ reset read to previous record to continue processing ------
.
PAGE9000  MOVE      TMPFORM2,COUNT
          MOVE      TMPFORM2,TOPMARG
          PACK      KEY6,FORM3,FORM3A
          CALL      RDOTLET1
.
PAGE9999  RETURN
+
.**********************************************************************
.*                  MOD0000                                           *
.*             Modify a line to substitute "%" variable values        *
.**********************************************************************
MOD0000   MOVE      OTLTTEXT,DIM70
          PACK      PRTSTRNG,SP70,SP70,SP70,SP70:    * initialise PRTSTRNG
                             SP70,SP70,SP70,SP70:
                             SP70,SP70,SP70,SP70:
                             SP70,SP70,SP70,SP70:
                             SP70,SP70
          RESET     PRTSTRNG,0                       *   and pointer positions
          MOVE      ONE,STARTSTR
          MOVE      ONE,ENDSTR
          MOVE      ZERO,PRNTLONG                    * Not a long print line
.
MOD2000   SCAN      SPECCHAR,DIM70                * Scan the Input Line for
          GOTO      MOD8000 IF NOT EQUAL          * a "%" sign
.
MOD3000   MOVEFPTR  DIM70,PERCPOS
          BUMP      DIM70,-1                     * Go to the character before
.                                                * the "%" sign
          GOTO      MOD3100 IF NOT EOS            * Test if the % sign is the
          RESET     DIM70,0                      * first character on the line
.                                                * set f.p. to 0 if it is
.
MOD3100   MOVEFPTR  DIM70,ENDSTR                  * store endtsr at position
          COMPARE   STARTSTR,ENDSTR               *   1 char before the % sign
          GOTO      MOD3200 IF NOT LESS           *   and ensure that end and
.                                                 *   start positions dont
.                                                 *   overlap
          RESET     DIM70,STARTSTR                * set pointer to next % sign
          GOTO      MOD9999 IF EOS                *   if end < start
          GOTO      MOD3300
.
MOD3200   RESET     DIM70,STARTSTR                * reset the pointers to
          SETLPTR   DIM70,ENDSTR                  *   extract text preceding
          APPEND    DIM70,PRTSTRNG                *   the % sign
.
MOD3300   SETLPTR   DIM70,70                      * set the pointers to start at
          RESET     DIM70,PERCPOS                 *    % and go to position 70
          MOVE      DIM70,TEMP70                  * delete preceding text from
          PACK      DIM70,SP30,SP30,SP30
          MOVE      TEMP70,DIM70                  *    the DIM70 string
.
MOD4000   CALL      GETV0000                      * extract the % var
          MOVEFPTR  DIM70,STARTSTR                * store finish pos. of var
          BRANCH    EXIT,MOD5000
          RESET     SRCHVAR
.
          MATCH     "%boldon",SRCHVAR
          IF        @EQUAL
            BUMP      DIM70
            ADD       ONE,STARTSTR
          ENDIF
.
          MATCH     "%ulineon",SRCHVAR
          IF        @EQUAL
            BUMP      DIM70
            ADD       ONE,STARTSTR
          ENDIF
.
.------ search for the % var in the list of constants ------
.
          SEARCH    SRCHVAR,LCPAGE,LCNOVARS,SRCHNUM
.
          BRANCH    SRCHNUM,MOD7000         * page break
          COMPARE   "27",SRCHNUM
          GOTO      MOD6000 IF EQUAL        * invoice summary
.
          IF        SRCHNUM=569 | SRCHNUM=571 | SRCHNUM=572 | SRCHNUM=574
            MOVE      ONE,PRNTLONG            * Set long print line to yes
          ENDIF
.
          COMPARE   ZERO,SRCHNUM                   * % var not found in list
          GOTO      MOD5000 IF EQUAL
.
.------ load DISPSTRN with the actual value of the % var ------
.
          CALL      IBACLOCK                * I CAR 45249
          PACK      AGEDATE,CC,YY,MM,DD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          MOVE      PSAGEYRS,DIMAGE         * end I CAR 45249
.         MOVE      PSAGE,DIMAGE
          MOVE      TEMPOUTN,DIMOUTN
.
MOD4500   LOAD      DISPSTRN,SRCHNUM,LXPAGE,PADD1,PADD2,PSUBRB,PADD4:
                            DIMAGE,TEMPATTD,TEMPATDT,TEMPATTM,TEMPBDAT:   *  10
                            TEMPBKDT,TEMPBTIM,TEMPCTRY,PTELEB,TEMPCLDX:
                            TEMPCLID,TEMPCTYP,TEMPCOMP,TEMPTDAY,TEMPDGNM: *  20
                            TEMPDSNM,TEMPDOCT,TEMPDTIT,TEMPNAME,PGNAME:
                            TEMPINSR,LXISUM,PLOCDOC,PMEDI,DIMOUTN:        *  30
                            TEMPPCAT,TEMPCLSS,PTELEP,TEMPPRTY,PPOST:
                            TEMPPSEX,TEMPSITE,TEMPSLOT,PSNAME,TEMPSREF:   *  40
                            TEMPSTIM,LXTITLE,TEMPURNO,LXNKNAME,LXNKADD1:
                            LXNKADD2,LXNKADD3,LXNKADD4,LXNKPOST,RGGPSNAM: *  50
                            RGGPGNAM,RGGPADD1,RGGPADD2,RGGPADD3,RGGPADD4:
                            RGGPPOST,RFGPSNAM,RFGPGNAM,RFGPADD1,RFGPADD2: *  60
                            RFGPADD3,RFGPADD4,RFGPPOST,PTHSNAME,PTHSADD1:
                            PTHSADD2,PTHSADD3,PTHSADD4,PTHSPCOD,PTHSTELE: *  70
                            RESHFROM,RESHTO,CANDATE,RESHTIME,RGPRSURG:
                            RGPRSAD1,RGPRSAD2,RGPRSAD3,RGPRSAD4,RGPRSPCD: *  80
                            RGPRTELE,RFPRSURG,RFPRSAD1,RFPRSAD2,RFPRSAD3:
                            RFPRSAD4,RFPRSPCD,RFPRTELE,CLDAY,CLDATE:      *  90
                            CLMONTH,CLYR,CLLTYP,CLCLOC,LXECNAM:
                            LXECADA,LXECADB,LXECADC,LXECADD,LXECPCD:      * 100
                            LXNRNAM,LXNRADA,LXNRADB,LXNRADC,LXNRADD:
                            LXNRPCD,LXNATID,LXCELL,LXPADDA,LXPADDB:       * 110
                            LXPADDC,LXPADDD,LXPPOST,LXXSDCCD,LXXSDCPN:
                            LXXSRFDT,LXUDEF5,LXUDEF6,LXUDEF7,LXUDEF8:     * 120
                            LXPRANK,LXLDTLET,LXLRFDRC,LXLRFDRT,LXLRFDRS:
                            LXLRFDRG,LXLHONSC,LXLCONST,LXLCONSS,LXLCONSG: * 130
                            LXLDEPT,LXLPRTY,LXLDIAG1,LXLUDF1,LXLUDF2:
                            LXLUDF3,LXLUDF4,LXLREQNO,LXLRACDT,LXLREQRE:   * 140
                            LXLSPFCD,LXLCADD1,LXLCADD2,LXLCADD3,LXLCADD4:
                            LXLCADPC,LXLECRNO,LXLGPFHN,LXLCLTYP,LXLCLDES: * 150
                            LXLRFSRC,LXLRHCPC,LXLRHCPT,LXLRHCPS,LXLRHCPG:
                            LXLDTREC,LXLDTPTY,LXLEXPUR,LXLRANK,LXPXMSNA:  * 160
                            LXPXMGNA,LXPXMTLE,LXPXMAD1,LXPXMAD2,LXPXMAD3:
                            LXPXMAD4,LXPXMPOS,LXPXMPNO,LXPXMBNO,LXPXMMNO: * 170
                            LXPXMEML,LXPXMCNT,LXPXMCRP,LXPXMLAB,LXPXMREL:
                            LXPXFSNA,LXPXFGNA,LXPXFTLE,LXPXFAD1,LXPXFAD2: * 180
                            LXPXFAD3,LXPXFAD4,LXPXFPOS,LXPXFPNO,LXPXFBNO:
                            LXPXFMNO,LXPXFEML,LXPXFCNT,LXPXFCRP,LXPXFLAB: * 190
                            LXPXFREL,LXPXDVAC,LXPXABRG,LXPXPRVI,LXVXABRG:
                            LXVXCADM,LXVXIRAD,LXVXIDUS,LXVXCRAV,LXVXRCCT: * 200
                            LXVXAPWD,LXVXAPBD,LXMAINS1,LXMAINS2,LXMAINS3:
                            LXBOUSR1,LXBBSPCA,LXMACOM1,LXMACOM2,LXOTDES1: * 210
                            LXOTDES2,LXOTDES3,RGGPFNAM,LXSCLN01,LXSCLN02:
                            LXSCLN03,LXSCLN04,LXSCLN05,LXSCLN06,LXSCLN07: * 220
                            LXSCLN08,LXSCLN09,LXSCLN10,LXSCDS01,LXSCDS02:
                            LXSCDS03,LXSCDS04,LXSCDS05,LXSCDS06,LXSCDS07: * 230
                            LXSCDS08,LXSCDS09,LXSCDS10,LXSBDT01,LXSBDT02:
                            LXSBDT03,LXSBDT04,LXSBDT05,LXSBDT06,LXSBDT07: * 240
                            LXSBDT08,LXSBDT09,LXSBDT10,LXSBTM01,LXSBTM02:
                            LXSBTM03,LXSBTM04,LXSBTM05,LXSBTM06,LXSBTM07: * 250
                            LXSBTM08,LXSBTM09,LXSBTM10,LXSBLN01,LXSBLN02:
                            LXSBLN03,LXSBLN04,LXSBLN05,LXSBLN06,LXSBLN07: * 260
                            LXSBLN08,LXSBLN09,LXSBLN10,LXBBTRAN,LXBBDNAR:
                            LXOZATTO,LXDODSCH,RFGPFAX0,LXRFHPNM,LXRFHPPH: * 270
                            LXRFHPFX,LXOTCLCD,LXOTCCDD,LXRFHPA2,LXRFHPA3:
                            LXRFHPA4,LXRFHPA5,LXRFHPA6,LXRFHPPC,LXOTTCCL: * 280
                            LXOTTCDT,LXOTWKDT,LXOCNTP1,LXOCNTD1,LXOCNNM1:
                            LXOCNDT1,LXOCNTP2,LXOCNTD2,LXOCNNM2,LXOCNDT2: * 290
                            LXOCNTP3,LXOCNTD3,LXOCNNM3,LXOCNDT3,LXOCNTP4:
                            LXOCNTD4,LXOCNNM4,LXOCNDT4,LXOCNTP5,LXOCNTD5: * 300
                            LXOCNNM5,LXOCNDT5,LXRFPDSC,LXOTUDF1,LXOTDIC1:
                            LXOTDID1,LXOTDIC2,LXOTDID2,LXOTDIC3,LXOTDID3: * 310
                            LXOTDIC4,LXOTDID4,RGPRFAXN,RGGPEMLA,RGPRPRCC:
                            RFGPADR5,RFGPADR6,RFGPPHON,RFGPMOBN,RFGPPPNO: * 320
                            RFGPPAGN,RFGPPROV,RESPFDRT,RESPFDRS,RESPFDRG:
                            RESPHPNM,RESPHPA2,RESPHPA3,RESPHPA4,RESPHPA5: * 330
                            RESPHPA6,RESPHPPC,RESPHPPH,RESPHPFX,LXCNSITE:
                            LXCNCLIN,LXCNDATE,LXCNSTRT,LXCNSLOT,LXCNTIME: * 340
                            LXCNNOUT,LXCNURNO,LXCNREAS,LXCNRTIM,LXCNSRCR:
                            LXCNCOMP,LXCNCLAS,LXCNINSU,LXCNCATE,LXCNPRTY: * 350
                            LXCNOPER,LXCNTRAN,LXCNVTYP,LXCNRLRR,LXPNKNME:
                            LXPNKAD1,LXPNKAD2,LXPNKSUB,LXPNKAD4,LXPNKPST: * 360
                            LXPNKRLP,LXPNKTLP,LXPNKTLB,LXPXKMOB,LXPXKEML:
                            LXPXCMOB,LXPXCEML,LXPXRMOB,LXPXREML,LXPCNAME: * 370
                            LXPCADD1,LXPCADD2,LXPCADD3,LXPCADD4,LXPCPOST:
                            LXPCTELP,LXPCTELB,LXPCTELM,LXPCRELP,LXPCEMAI: * 380
                            TEMPCLTY,LXCNVTPC,LXOTVTPC,LXOTVTYP,LXPNKRLD:
                            LXDEMAD,LXDPRMC,RGGPPRMC,RFGPSEML,RFGPPRM0:   * 390
                            LXLRSEML,LXLRPRMC,LXLCSEML,LXLCPRMC,RESPSEML:
                            RESPPMOC,LXXCOD01,LXXCOD02,LXXCOD03,LXXCOD04: * 400
                            LXXCOD05,LXXCOD06,LXXCOD07,LXXCOD08,LXXCOD09:
                            LXXCOD10,LXXCOD11,LXXCOD12,LXXCOD13,LXXCOD14: * 410
                            LXXCOD15,LXXCOD16,LXXCOD17,LXXCOD18,LXXCOD19:
                            LXXCOD20,LXPXDVAN,LXPAPENN,LXPXPMBN,LXPXPLC1: * 420
                            LXPXPLD1,LXRESCLN,RFGPTITL,RFGPTELP,RFGPFAXN:
                            RFGPEMAL,RFGPPRMC,RFPRFAXN,TEMPCLDR,LXPXPEMX: * 430
                            LXBOLDON,LXBOLDOF,LXUNDLON,LXUNDLOF,LXHECTEL:
                            LXMAROOM,LXOTDES4,PMPXFNAM,PMPXSNAM,LXPLTITL: * 440
                            LXPLSNAM,LXPLGNAM,LXPLGNM2,LXPLNAME,LXPLADD1:
                            LXPLADD2,LXPLADD3,LXPLADD4,LXPLPOST,LXPLTELP: * 450
                            LXPLTELB,LXPLTELM,LXPLRELP,LXPLEMAI,LXPLSLET:
                            LXPOTITL,LXPOSNAM,LXPOGNAM,LXPOGNM2,LXPONAME: * 460
                            LXPOADD1,LXPOADD2,LXPOADD3,LXPOADD4,LXPOPOST:
                            LXPOTELP,LXPOTELB,LXPOTELM,LXPORELP,LXPOEMAI: * 470
                            LXPOSLET,LXP2TITL,LXP2SNAM,LXP2GNAM,LXP2GNM2:
                            LXP2NAME,LXP2ADD1,LXP2ADD2,LXP2ADD3,LXP2ADD4: * 480
                            LXP2POST,LXP2TELP,LXP2TELB,LXP2TELM,LXP2RELP:
                            LXP2EMAI,LXP2SLET,LXPCTITL,LXPCSNAM,LXPCGNAM: * 490
                            LXPCGNM2,LXPCSLET,LXP1TITL,LXP1SNAM,LXP1GNAM:
                            LXP1GNM2,LXP1SLET,LXPSTITL,LXPSSNAM,LXPSGNAM: * 500
                            LXPSGNM2,LXPSNAME,LXPSTELP,LXPSTELB,LXPSTELM:
                            LXPSRELP,LXPSEMAI,LXPSSLET,LXPETITL,LXPESNAM: * 510
                            LXPEGNAM,LXPEGNM2,LXPETELP,LXPETELB,LXPERELP:
                            LXPESLET,LXPRTITL,LXPRSNAM,LXPRGNAM,LXPRGNM2: * 520
                            LXPRTELP,LXPRTELB,LXPRRELP,LXPRSLET,LXPTLSNM:
                            LXCLNIND,LXPATIN1,LXPATIN2,LXPATIN3,LXPATIN4: * 530
                            LXLTYPCD,LXLTYPLD,LXSBDY01,LXSBDY02,LXSBDY03: 
                            LXSBDY04,LXSBDY05,LXSBDY06,LXSBDY07,LXSBDY08: * 540
                            LXSBDY09,LXSBDY10,LXIHINUM,LXHPCODE,LXHPDESC:
                            LXXSMSID,LXXSMSKY,LXSMSCOD,LXXSMSPH,LXXSMSUR: * 550
                            LXXSMSUS,LXSRVDCD,LXSRVDDC,LXRGPGTL,LXRGPGNM:
                            LXRGPSNM,LXRGPPNM,LXRGPPA1,LXRGPPA2,LXRGPPA3: * 560
                            LXRGPPA4,LXRGPPPC,LXRESFTM,LXDRSEEN,LXDRDFLT:
                            LXOPRSCH,LXSTCODE,LXSTDESC,LXRESITE,LXRECODE: * 570
                            LXREADDR,LXWRMURL,LXRECPHN,LXALLNTS,LXXSMSUN:      
                            LXRESFRD,PTCNSTYP,LXOGCODE,LXOGTITL,LXOGGVNM: * 580
                            LXOGSUNM,LXOGEMAL,LXOGCONT,LXOGACTV,LXOGPCDE:
                            LXOGPNME,LXOGPAL1,LXOGPAL2,LXOGPAL3,LXOGPAL4: * 590
                            LXOGPPST,LXOGPEML,LXOGPTEL,LXOGPFAX,LXOGPATV:
                            LXBCRDAT,LXVTYPI1,LXOLPUID,LXOLPLGN,LXOGCNTD: * 600
                            CLDAYSRT,CLMTHSRT,TEMPATDS,LXPXUCC4,LXUCC4LD:
                            LXPXATF1,LXPXUCC5,LXUCC5LD,LXPXATF2,LXPXSN18: * 610
                            LXPXSN19,LXPXSN20,LXPXSN21,LXPXSN22,LXPXSN23:
                            LXPXSN24,LXPXSN25,LXPXSN26,LXPXSN27,LXPXSN28: * 620 
                            LXPXSN29,LXPXSN30,LXPUSRAC,LXPUSRAD,LXPUSRAL: 
                            LXPUSRBC,LXPUSRBD,LXPUSRBL,LXPUSRCC,LXPUSRCD: * 630
                            LXPUSRCL,LXPUSRDC,LXPUSRDD,LXPUSRDL,LXPUSREC:  
                            LXPUSRED,LXPUSREL,LXPUSRFC,LXPUSRFD,LXPUSRFL: * 640
                            LXPUSRGC,LXPUSRGD,LXPUSRGL,LXPUSRHC,LXPUSRHD: 
                            LXPUSRHL,LXPUSRIC,LXPUSRID,LXPUSRIL           * 650
.                                 
          APPEND    DISPSTRN,PRTSTRNG
          CALL      COMX0000                   * compress trailing blanks in
          GOTO      MOD2000                    *    PRTSTRNG
.
MOD5000   RESET     SRCHVAR                    * add the string starting with
          APPEND    SRCHVAR,PRTSTRNG           *    a % if not found in the
          GOTO      MOD8000 IF EOS             *    list of constants
          GOTO      MOD2000
.
MOD6000   CALL      ISUM0000                   * print the invoice summary
          GOTO      MOD9999
.
.------ %page variable found ------
.
MOD7000   MOVE      PHYSPAGE,TEMP3
          SUBTRACT  COUNT,PHYSPAGE
          MOVE      ONE,COUNT
          ADD       TOPMARG,PHYSPAGE
          SUBTRACT  ONE,PHYSPAGE
.
MOD7100   PRINT     *N;
          COMPARE   COUNT,PHYSPAGE
          GOTO      MOD7500 IF EQUAL
          ADD       ONE,COUNT
          GOTO      MOD7100
.
MOD7500   MOVE      TEMP3,PHYSPAGE
          MOVE      TOPMARG,COUNT
          SUBTRACT  ONE,COUNT
          PACK      PRTSTRNG,SP30,SP30,SP10
          GOTO      MOD9999
.
MOD8000   APPEND    DIM70,PRTSTRNG                    * add remaining text to
          RESET     PRTSTRNG                          *   PRTSTRNG if no %
.                                                     *   signs left
MOD9999   RETURN

.**********************************************************************
.*                              GETV0000                              *
.*           Extracts the "%" variable from the line                  *
.**********************************************************************
GETV0000  MOVE      FALSE,EXIT
          PACK      SRCHVAR,SP30,SP30,SP10
          RESET     SRCHVAR,0
          MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
          RESET     SRCHVAR,0
          BUMP      DIM70
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS                        * check to see if first
          MATCH     "0",ANS                           *   char after % is a
          GOTO      GETV9000 IF NOT EQUAL             *   lower case letter
          BUMP      DIM70,-1
          PACK      SRCHVAR,SP30,SP30,SP10            * initialise SRCHVAR
          RESET     SRCHVAR,0                         *   value and pointers
.
.------ append % var to SRCHVAR until anything but ------
.------ a lower case letter is found ------
.
GETV1000  MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
.
          BUMP      DIM70
          GOTO      GETV9999 IF EOS
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS
          MATCH     "0",ANS
          GOTO      GETV9999 IF NOT EQUAL
          GOTO      GETV1000
.
.------ string found is not a valid % var ------
.
GETV9000  MOVE      TRUE,EXIT
.
GETV9999  RETURN
+
.**********************************************************************
.*                              COMX0000                              *
.*         Routine to compress trailing blanks in PRTSTRNG            *
.**********************************************************************
COMX0000  ENDSET    PRTSTRNG
.
COMX1000  CMATCH    SP1,PRTSTRNG
          GOTO      COMX9999 IF NOT EQUAL
          BUMP      PRTSTRNG,-1
          GOTO      COMX9999 IF EOS
          GOTO      COMX1000
.
COMX9999  RETURN
+
.**********************************************************************
.*                              ISUM0000                              *
.*              Routine to print the invoice summary                  *
.**********************************************************************
ISUM0000  ADD       FOUR,COUNT
          MOVE      "11",FORM3
          ADD       LEFTMARG,FORM3
          COMPARE   COUNT,MLETPLEN
          GOTO      ISUM0050 IF LESS
          SUBTRACT  FOUR,COUNT
          PRINT     *N,*LEFTMARG,SUMHEAD:
                    *N,*LEFTMARG,SUMULINE;
          GOTO      ISUM0070
.
.------ paginate if cant fit first four lines of summary onto the page ------
.
ISUM0050  SUBTRACT  FOUR,COUNT
          CALL      IPAG0000
.
ISUM0070  MOVE      TEMPOUTN,PINVADM
          MOVE      PINVADM,KEY16
          CALL      RDSINV3                          * read invoice file to
          CALL      RDKINV3                          *   make sure some invoice
          BRANCH    OVRCD,ISUM9000                   *   details are available
          MATCH     TEMPOUTN,PINVADM
          GOTO      ISUM9000 IF NOT EQUAL
          ADD       TWO,COUNT
          GOTO      ISUM1050
.
ISUM1000  CALL      RDKINV3
          BRANCH    OVRCD,ISUM8000
          MATCH     TEMPOUTN,PINVADM
          GOTO      ISUM8000 IF NOT EQUAL
.
.------ set up and print summary details ------
.
ISUM1050  UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          PACK      INVDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      PINVJOUR,TEMPJOUR
          MULT      "-1",TEMPJOUR
          MOVE      PINVAMT,TEMPINV
          ADD       PINVPATA,PINVHFDA
          ADD       PINVHFDA,PINVOTHA
          ADD       PINVOTHA,SHRTPAID
          ADD       SHRTPAID,SHRTTOTL
          ADD       PINVJOUR,TOTLJOUR
          ADD       PINVAMT,TOTLINV2
          ADD       SHRTPAID,PINVJOUR
          ADD       PINVJOUR,PINVAMT
          ADD       PINVAMT,GRANTOTL
          MULT      "-1",SHRTPAID
          MULT      "-1",PINVJOUR
          PRINT     *N,*LEFTMARG,PINVNO,"   ",INVDATE," ",TEMPINV," ",SHRTPAID:
                    "  ",TEMPJOUR," ",PINVAMT;
          ADD       ONE,COUNT
          MOVE      ZERO,SHRTPAID
          COMPARE   COUNT,MLETPLEN
          CALL      IPAG0000 IF EQUAL                * paginate if required
          GOTO      ISUM1000
.
.------ test to see invoice totals will fit on page ------
.
ISUM8000  ADD       THREE,COUNT
          COMPARE   COUNT,MLETPLEN
          GOTO      ISUM8500 IF LESS
          SUBTRACT  ONE,COUNT
.
.------ set up and print invoice summary totals ------
.
ISUM8150  MULT      "-1",SHRTTOTL
          MULT      "-1",TOTLJOUR
          PRINT     *N,*LEFTMARG,SUMULIN3:
                    *N,*FORM3,"Totals : ",TOTLINV2," ",SHRTTOTL,"  ",TOTLJOUR:
                    " ",GRANTOTL;
          MOVE      SUMULIN2,PRTSTRNG
          MOVE      ZERO,TOTLINV2
          MOVE      ZERO,SHRTTOTL
          MOVE      ZERO,TOTLJOUR
          MOVE      ZERO,GRANTOTL
          GOTO      ISUM9999
.
ISUM8500  MOVE      TOPMARG,TMPFORM2
          MOVE      MLETPLEN,FORM2
          SUBTRACT  THREE,COUNT
          SUBTRACT  COUNT,MLETPLEN
          ADD       MLETPLEN,TOPMARG
          ADD       BOTTMARG,TOPMARG                 * set up margins etc
          MOVE      ONE,COUNT
.
.------ loop to paginate ------
.
ISUM8550  PRINT     *N;
          COMPARE   COUNT,TOPMARG
          GOTO      ISUM8570 IF EQUAL
          ADD       ONE,COUNT
          GOTO      ISUM8550
.
.------ go back and print invoice summary totals ------
.
ISUM8570  MOVE      TMPFORM2,COUNT
          MOVE      TMPFORM2,TOPMARG
          MOVE      FORM2,MLETPLEN
          ADD       TWO,COUNT
          GOTO      ISUM8150
.
.------ no invoice details for given patient ------
.
ISUM9000  MOVE      "No invoice summary details available",PRTSTRNG
          ADD       TWO,COUNT
          GOTO      ISUM9999
.
ISUM9999  RETURN
+
.**********************************************************************
.*                              IPAG0000                              *
.*             Routine to paginate for the invoice summary            *
.**********************************************************************
IPAG0000  MOVE      TOPMARG,TMPFORM2
          MOVE      MLETPLEN,FORM2
          SUBTRACT  COUNT,MLETPLEN
          ADD       MLETPLEN,TOPMARG
          ADD       BOTTMARG,TOPMARG
          MOVE      ONE,COUNT
.
.------ loop to paginate ------
.
IPAG1000  PRINT     *N;
          COMPARE   COUNT,TOPMARG
          GOTO      IPAG9000 IF EQUAL
          ADD       ONE,COUNT
          GOTO      IPAG1000
.
.------ reset variables and print summary header on new page ------
.
IPAG9000  MOVE      TMPFORM2,COUNT
          MOVE      TMPFORM2,TOPMARG
          MOVE      FORM2,MLETPLEN
          PRINT     *N,*LEFTMARG,SUMHEAD:
                    *N,*LEFTMARG,SUMULINE;
          ADD       TWO,COUNT
          GOTO      IPAG9999
.
IPAG9999  RETURN
+
.*********************************************************************
.                   CLGP0000
.         Clear Gp Details
.*********************************************************************
CLGP0000  PACK      RGGPSNAM,SP70                                      *I-59277
          PACK      RGGPGNAM,SP70
          PACK      RGGPADD1,SP70
          PACK      RGGPADD2,SP70
          PACK      RGGPADD3,SP70
          PACK      RGGPADD4,SP70
          PACK      RGGPPOST,SP70
          PACK      RFGPSNAM,SP70
          PACK      RFGPGNAM,SP70
          PACK      RFGPADD1,SP70
          PACK      RFGPADD2,SP70
          PACK      RFGPADD3,SP70
          PACK      RFGPADD4,SP70
          PACK      RFGPPOST,SP70
          PACK      RGGPFNAM,SP70
.
          PACK      RFGPTITL,SP70
          PACK      RFGPTELP,SP70
          PACK      RFGPFAXN,SP70
          PACK      RFGPEMAL,SP70
          PACK      RFGPPRMC,SP70
.
. Registered GP Practice address
.
          PACK      RGPRSURG,SP70
          PACK      RGPRSAD1,SP70
          PACK      RGPRSAD2,SP70
          PACK      RGPRSAD3,SP70
          PACK      RGPRSAD4,SP70
          PACK      RGPRSPCD,SP70
          PACK      RGPRTELE,SP70
          PACK      RGPRFAXN,SP70
.
. Referring GP Practice address
.
          PACK      RFPRSURG,SP70
          PACK      RFPRSAD1,SP70
          PACK      RFPRSAD2,SP70
          PACK      RFPRSAD3,SP70
          PACK      RFPRSAD4,SP70
          PACK      RFPRSPCD,SP70
          PACK      RFPRTELE,SP70
.
          PACK      RGPRFAXN,SP70
          PACK      RGGPEMLA,SP70,SP70
          PACK      RGGPPRMC,SP70
.
. Letter GP variables
.
          PACK      LXOGCODE,SP70          
          PACK      LXOGTITL,SP70   
          PACK      LXOGGVNM,SP70     
          PACK      LXOGSUNM,SP70   
          PACK      LXOGEMAL,SP70    
          PACK      LXOGCONT,SP70  
          PACK      LXOGACTV,SP70
          PACK      LXOGCNTD,SP70
          
.
. Letter Practice vars
.                     
          PACK      LXOGPCDE,SP70         
          PACK      LXOGPNME,SP70    
          PACK      LXOGPAL1,SP70         
          PACK      LXOGPAL2,SP70      
          PACK      LXOGPAL3,SP70      
          PACK      LXOGPAL4,SP70      
          PACK      LXOGPPST,SP70       
          PACK      LXOGPEML,SP70  
          PACK      LXOGPTEL,SP70       
          PACK      LXOGPFAX,SP70         
          PACK      LXOGPATV,SP70
.                                                                  *end I-59277
CLGP9999  RETURN
+
.**********************************************************************
.*                              CLRV0000                              *
.*      Routine to initialise all unformatted variables to "*"        *
.**********************************************************************
CLRV0000  MOVE      "***********************************",PADD1
          MOVE      "***********************************",PADD2
          MOVE      "***********************************",PSUBRB
          MOVE      "***********************************",PADD4
          MOVE      "*********",PPOST
          MOVE      "************",PTELEP
          MOVE      "000",PSAGE
          MOVE      "******",OBADOCT
          MOVE      "*************************",PGNAME
          MOVE      "******************************",PLOCDOC
          MOVE      "**********",PMEDI
          MOVE      "*",PSEX
.
... BA 20.12.2001 Removed Following So Site Code is Not Destroyed
...          MOVE      "******",OBASITE
.
          MOVE      "*************************",PSNAME
          MOVE      "*********",LXTITLE
          MOVE      "********",PURNO
          MOVE      STAR52,LXNKNAME
          MOVE      STAR52,LXNKADD1
          MOVE      STAR52,LXNKADD2
          MOVE      STAR52,LXNKADD3
          MOVE      STAR52,LXNKADD4
          MOVE      STAR52,LXNKPOST
          MOVE      STAR52,LXECNAM
          MOVE      STAR52,LXECADA
          MOVE      STAR52,LXECADB
          MOVE      STAR52,LXECADC
          MOVE      STAR52,LXECADD
          MOVE      STAR52,LXECPCD
          PACK      LXNRNAM,STAR30,STAR30
          MOVE      STAR52,LXNRADA
          MOVE      STAR52,LXNRADB
          MOVE      STAR52,LXNRADC
          MOVE      STAR52,LXNRADD
          MOVE      STAR52,LXNRPCD
          MOVE      STAR52,LXNATID
          MOVE      "********************",LXCELL
          MOVE      "***********************************",LXPADDA
          MOVE      "***********************************",LXPADDB
          MOVE      "***********************************",LXPADDC
          MOVE      "***********************************",LXPADDD
          MOVE      "********",LXPPOST
          MOVE      "*******",LXXSDCCD
          MOVE      "***********",LXXSDCPN
          MOVE      "***********",LXXSRFDT
          MOVE      "********************",LXUDEF5
          MOVE      "********************",LXUDEF6
          MOVE      "********************",LXUDEF7
          MOVE      "********************",LXUDEF8
          MOVE      "******",LXPRANK
          MOVE      "**********",LXLDTLET
          MOVE      "*******",LXLRFDRC
          MOVE      "*********",LXLRFDRT
          MOVE      "********************",LXLRFDRS
          MOVE      "*************************",LXLRFDRG
          MOVE      "******",LXLHONSC
          MOVE      "*********",LXLCONST
          MOVE      "********************",LXLCONSS
          MOVE      "*************************",LXLCONSG
          MOVE      "***",LXLDEPT
          MOVE      "***",LXLPRTY
          MOVE     "**************************************************",LXLDIAG1
          MOVE      "***",LXLUDF1
          MOVE      "***",LXLUDF2
          MOVE      "***",LXLUDF3
          MOVE      "***",LXLUDF4
          MOVE      "********************",LXLREQNO
          MOVE      "**********",LXLRACDT
          MOVE      "***",LXLREQRE
          MOVE      "***",LXLSPFCD
          MOVE      "***********************************",LXLCADD1
          MOVE      "***********************************",LXLCADD2
          MOVE      "***********************************",LXLCADD3
          MOVE      "***********************************",LXLCADD4
          MOVE      "********",LXLCADPC
          MOVE      "********************",LXLECRNO
          MOVE      "********************",LXLGPFHN
          MOVE      "******",LXLCLTYP
          MOVE      "******************************",LXLCLDES          *I-90301
          MOVE      "***",LXLRFSRC
          MOVE      "******",LXLRHCPC
          MOVE      "*********",LXLRHCPT
          MOVE      "********************",LXLRHCPS
          MOVE      "*************************",LXLRHCPG
          MOVE      "********",LXLDTREC
          MOVE      "********",LXLDTPTY
          MOVE      "***",LXLEXPUR
          MOVE      "******",LXLRANK
          MOVE      "********************",LXPXMSNA
          MOVE      "*************************",LXPXMGNA
          MOVE      "****",LXPXMTLE
          MOVE      "***********************************",LXPXMAD1
          MOVE      "***********************************",LXPXMAD2
          MOVE      "***********************************",LXPXMAD3
          MOVE      "***********************************",LXPXMAD4
          MOVE      "********",LXPXMPOS
          MOVE      "********************",LXPXMPNO             
          MOVE      "********************",LXPXMBNO
          MOVE      "********************",LXPXMMNO
          MOVE      "********************************************************************************",LXPXMEML
          MOVE      "********************",LXPXMCNT 
          MOVE      "***",LXPXMCRP
          MOVE      "***",LXPXMLAB 
          MOVE      "**********",LXPXMREL
          MOVE      "********************",LXPXFSNA
          MOVE      "*************************",LXPXFGNA 
          MOVE      "****",LXPXFTLE
          MOVE      "***********************************",LXPXFAD1
          MOVE      "***********************************",LXPXFAD2  
          MOVE      "***********************************",LXPXFAD3 
          MOVE      "***********************************",LXPXFAD4 
          MOVE      "********",LXPXFPOS 
          MOVE      "********************",LXPXFPNO
          MOVE      "********************",LXPXFBNO
          MOVE      "********************",LXPXFMNO
          MOVE      "********************************************************************************",LXPXFEML 
          MOVE      "********************",LXPXFCNT 
          MOVE      "***",LXPXFCRP
          MOVE      "***",LXPXFLAB
          MOVE      "********************",LXPXFREL
          MOVE      "********************",LXPXDVAC
          MOVE      "********************",LXPXABRG
          MOVE      "********************",LXPXPRVI
          MOVE      "********************",LXVXABRG
          MOVE      "********************",LXVXCADM
          MOVE      "********************",LXVXCADM 
          MOVE      "********************",LXVXIDUS
          MOVE      "********************",LXVXCRAV 
          MOVE      "********************",LXVXRCCT
          MOVE      "********************",LXVXAPWD 
          MOVE      "********************",LXVXAPBD
          MOVE      "****************************************",LXMAINS1
          MOVE      "****************************************",LXMAINS2
          MOVE      "****************************************",LXMAINS3
          MOVE      "****************************************",LXBOUSR1
          MOVE      "********************",LXBBSPCA 
          MOVE      "****************************************",LXMACOM1
          MOVE      "****************************************",LXMACOM2
          MOVE      "****************************************************",LXOTDES1
          MOVE      "****************************************************",LXOTDES2
          MOVE      "****************************************************",LXOTDES3
          MOVE      "****************************************************",LXOTDES4
          MOVE      "******",LXSCLN01
          MOVE      "******************************",LXSCDS01
          MOVE      "**********",LXSBDT01
          MOVE      "********",LXSBTM01
          MOVE      "********",LXSBTM02
          MOVE      "********",LXSBTM03
          MOVE      "********",LXSBTM04
          MOVE      "********",LXSBTM05
          MOVE      "********",LXSBTM06
          MOVE      "********",LXSBTM07
          MOVE      "********",LXSBTM08
          MOVE      "********",LXSBTM09
          MOVE      "********",LXSBTM10
          MOVE      "******************************",LXSBLN01
          MOVE      "********************",LXBBTRAN
          MOVE      "********************",LXBBDNAR
          MOVE      "********************",LXOZATTO
          MOVE      "********************",LXDODSCH
          PACK      RFGPFAX0,STAR52
          PACK      RFGPADR5,STAR52
          PACK      RFGPADR6,STAR52
          MOVE      "*************************",LXRFHPNM
          MOVE      "***************",LXRFHPPH
          MOVE      "********************",LXRFHPFX
          MOVE      "***",LXOTCLCD
          MOVE      "********************",LXOTCCDD
          MOVE      "********************",LXOTTCCL
          MOVE      "**********",LXOTTCDT
          MOVE      "**********",LXOTWKDT
          MOVE      "***",LXOCNTP1
          MOVE      "********************",LXOCNTD1
          MOVE      "********************",LXOCNNM1
          MOVE      "**********",LXOCNDT1
          MOVE      "***",LXOCNTP2
          MOVE      "********************",LXOCNTD2
          MOVE      "********************",LXOCNNM2
          MOVE      "**********",LXOCNDT2
          MOVE      "***",LXOCNTP3
          MOVE      "********************",LXOCNTD3
          MOVE      "********************",LXOCNNM3
          MOVE      "**********",LXOCNDT3
          MOVE      "***",LXOCNTP4
          MOVE      "********************",LXOCNTD4
          MOVE      "********************",LXOCNNM4
          MOVE      "**********",LXOCNDT4
          MOVE      "***",LXOCNTP5
          MOVE      "********************",LXOCNTD5
          MOVE      "********************",LXOCNNM5
          MOVE      "**********",LXOCNDT5
          MOVE      "********************",LXRFPDSC
         MOVE      "**************************************************",LXOTUDF1
          MOVE      "*********",LXOTDIC1
         MOVE      "**************************************************",LXOTDID1
          MOVE      "*********",LXOTDIC2
         MOVE      "**************************************************",LXOTDID2
          MOVE      "*********",LXOTDIC3
         MOVE      "**************************************************",LXOTDID3
          MOVE      "*********",LXOTDIC4
         MOVE      "**************************************************",LXOTDID4
          MOVE      STAR52,RFPRFAXN
          MOVE      STAR52,RGPRFAXN
          PACK      RGGPEMLA,STAR52,STAR52
          MOVE      "********************",LXPNKNME
          MOVE      "***********************************",LXPNKAD1
          MOVE      "***********************************",LXPNKAD2
          MOVE      "***********************************",LXPNKSUB
          MOVE      "***********************************",LXPNKAD4
          MOVE      "********",LXPNKPST
          MOVE      "**********",LXPNKRLP
          MOVE      "********************",LXPNKTLP
          MOVE      "********************",LXPNKTLB
          MOVE      "********************",LXPXKMOB
          MOVE      "********************************************************************************",LXPXKEML
          MOVE      "********************",LXPXCMOB
          MOVE      "********************************************************************************",LXPXCEML
          MOVE      "********************",LXPXRMOB
          MOVE      "********************************************************************************",LXPXREML
.
          MOVE      "************************************************************",LXPCNAME
          MOVE      "***********************************",LXPCADD1
          MOVE      "***********************************",LXPCADD2
          MOVE      "***********************************",LXPCADD3
          MOVE      "***********************************",LXPCADD4
          MOVE      "********",LXPCPOST
          MOVE      "********************",LXPCTELP
          MOVE      "********************",LXPCTELB
          MOVE      "********************",LXPCTELM
          MOVE      "**********",LXPCRELP
          MOVE      "********************************************************************************",LXPCEMAI
          MOVE      "******",LXCNVTPC
          MOVE      "***",LXOTVTPC
          MOVE      "********************",LXOTVTYP
          MOVE      "******************************",LXPNKRLD
          MOVE      "********************************************************************************",LXDEMAD
          MOVE      "********************",LXDPRMC
          MOVE      STAR52,RGGPPRMC
          PACK      RFGPSEML,STAR52,STAR52
          MOVE      STAR52,RFGPPRM0
          MOVE      "********************************************************************************",LXLRSEML
          MOVE      "********************",LXLRPRMC
          MOVE      "********************************************************************************",LXLCSEML
          MOVE      "********************",LXLCPRMC
          PACK      RESPSEML,STAR52,STAR52
          MOVE      STAR52,RESPPMOC
          MOVE      "********************",LXXCOD01
          MOVE      "********************",LXXCOD02
          MOVE      "********************",LXXCOD03
          MOVE      "********************",LXXCOD04
          MOVE      "********************",LXXCOD05
          MOVE      "********************",LXXCOD06
          MOVE      "********************",LXXCOD07
          MOVE      "********************",LXXCOD08
          MOVE      "********************",LXXCOD09
          MOVE      "********************",LXXCOD10
          MOVE      "********************",LXXCOD11
          MOVE      "********************",LXXCOD12
          MOVE      "********************",LXXCOD13
          MOVE      "********************",LXXCOD14
          MOVE      "********************",LXXCOD15
          MOVE      "********************",LXXCOD16
          MOVE      "********************",LXXCOD17
          MOVE      "********************",LXXCOD18
          MOVE      "********************",LXXCOD19
          MOVE      "********************",LXXCOD20
          MOVE      "**********",LXPXDVAN
          MOVE      "**********",LXPAPENN
          MOVE      "********************",LXPXPMBN
          MOVE      "***",LXPXPLC1
          MOVE      "********************",LXPXPLD1
          MOVE      "******************************",LXRESCLN
          MOVE      "********************",RFGPFAX0
...       MOVE      "**********",LXRFGTLE
...       MOVE      "********************",LXRFGTEL
...       MOVE      "********************************************************************************",LXRFGEML
...       MOVE      "********************",LXRFGPMC
          MOVE      "********************************************************************************",LXPXPEMX
.
          MOVE      "****",LXPLTITL
          MOVE      "****************************************",LXPLSNAM
          MOVE      "****************************************",LXPLGNAM
          MOVE      "****************************************",LXPLGNM2
          MOVE      "************************************************************",LXPLNAME
          MOVE      "***********************************",LXPLADD1
          MOVE      "***********************************",LXPLADD2
          MOVE      "***********************************",LXPLADD3
          MOVE      "***********************************",LXPLADD4
          MOVE      "********",LXPLPOST
          MOVE      "********************",LXPLTELP
          MOVE      "********************",LXPLTELB
          MOVE      "********************",LXPLTELM
          MOVE      "**********",LXPLRELP
          MOVE      "********************************************************************************",LXPLEMAI
          MOVE      "***",LXPLSLET
.
          MOVE      "****",LXPOTITL
          MOVE      "****************************************",LXPOSNAM
          MOVE      "****************************************",LXPOGNAM
          MOVE      "****************************************",LXPOGNM2
          MOVE      "************************************************************",LXPONAME
          MOVE      "***********************************",LXPOADD1
          MOVE      "***********************************",LXPOADD2
          MOVE      "***********************************",LXPOADD3
          MOVE      "***********************************",LXPOADD4
          MOVE      "********",LXPOPOST
          MOVE      "********************",LXPOTELP
          MOVE      "********************",LXPOTELB
          MOVE      "********************",LXPOTELM
          MOVE      "**********",LXPORELP
          MOVE      "********************************************************************************",LXPOEMAI
          MOVE      "***",LXPOSLET
.
          MOVE      "****",LXP2TITL
          MOVE      "****************************************",LXP2SNAM
          MOVE      "****************************************",LXP2GNAM
          MOVE      "****************************************",LXP2GNM2
          MOVE      "************************************************************",LXP2NAME
          MOVE      "***********************************",LXP2ADD1
          MOVE      "***********************************",LXP2ADD2
          MOVE      "***********************************",LXP2ADD3
          MOVE      "***********************************",LXP2ADD4
          MOVE      "********",LXP2POST
          MOVE      "********************",LXP2TELP
          MOVE      "********************",LXP2TELB
          MOVE      "********************",LXP2TELM
          MOVE      "**********",LXP2RELP
          MOVE      "********************************************************************************",LXP2EMAI
          MOVE      "***",LXP2SLET
.
          MOVE      "****",LXPSTITL
          MOVE      "****************************************",LXPSSNAM
          MOVE      "****************************************",LXPSGNAM
          MOVE      "****************************************",LXPSGNM2
          MOVE      "************************************************************",LXPSNAME
          MOVE      "********************",LXPSTELP
          MOVE      "********************",LXPSTELB
          MOVE      "********************",LXPSTELM
          MOVE      "**********",LXPSRELP
          MOVE      "********************************************************************************",LXPSEMAI
          MOVE      "***",LXPSSLET
.
          MOVE      "****",LXPETITL
          MOVE      "****************************************",LXPESNAM
          MOVE      "****************************************",LXPEGNAM
          MOVE      "****************************************",LXPEGNM2
          MOVE      "********************",LXPETELP
          MOVE      "********************",LXPETELB
          MOVE      "**********",LXPERELP
          MOVE      "***",LXPESLET
.
          MOVE      "****",LXPRTITL
          MOVE      "****************************************",LXPRSNAM
          MOVE      "****************************************",LXPRGNAM
          MOVE      "****************************************",LXPRGNM2
          MOVE      "********************",LXPRTELP
          MOVE      "********************",LXPRTELB
          MOVE      "**********",LXPRRELP
          MOVE      "***",LXPRSLET
.
          MOVE      "****************************************",LXPTLSNM
          MOVE      "********************",LXCLNIND
          MOVE      "************************************************************",LXPATIN1
          MOVE      "************************************************************",LXPATIN2
          MOVE      "************************************************************",LXPATIN3
          MOVE      "************************************************************",LXPATIN4
          MOVE      "***",LXLTYPCD
          MOVE      "**************************************************",LXLTYPLD       
          MOVE      "**********",LXSBDY01
          MOVE      "**********",LXSBDY02
          MOVE      "**********",LXSBDY03
          MOVE      "**********",LXSBDY04
          MOVE      "**********",LXSBDY05
          MOVE      "**********",LXSBDY06
          MOVE      "**********",LXSBDY07
          MOVE      "**********",LXSBDY08
          MOVE      "**********",LXSBDY09
          MOVE      "**********",LXSBDY10
          MOVE      "********************",LXIHINUM
          MOVE      "***",LXHPCODE
          MOVE      "********************",LXHPDESC
          MOVE      "****************",LXXSMSID
          MOVE      "******************************",LXXSMSKY
          MOVE      "***",LXSMSCOD
          MOVE      "********************",LXXSMSPH
          MOVE      "********",LXXSMSUR
          MOVE      "**********",LXXSMSUS
          MOVE      "******************************",LXXSMSUN
          MOVE      "***",LXSRVDCD
          MOVE      "********************",LXSRVDDC
          MOVE      "***********************************",LXRGPGTL
          MOVE      "***********************************",LXRGPGNM
          MOVE      "***********************************",LXRGPSNM
          MOVE      "************************************************************",LXRGPPNM
          MOVE      "************************************************************",LXRGPPA1
          MOVE      "************************************************************",LXRGPPA2
          MOVE      "************************************************************",LXRGPPA3
          MOVE      "************************************************************",LXRGPPA4
          MOVE      "********",LXRGPPPC
          MOVE      "********",LXRESFTM
          MOVE      "********",LXDRSEEN
          MOVE      "********",LXDRDFLT
          MOVE      "********************",LXOPRSCH
          MOVE      "***",LXSTCODE
          MOVE      "********************",LXSTDESC
          MOVE      "***************************************************************************************************************************************************************************************************************************************************************",LXRESITE
          MOVE      "**********",LXRECODE
          MOVE      "********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************",LXREADDR
          MOVE      "***************************************************************************************************************************************************************************************************************************************************************",LXWRMURL
          MOVE      "********************",LXRECPHN
          MOVE      "****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************",LXALLNTS
          MOVE      "***",LXPXUCC4
          MOVE      "**************************************************",LXUCC4LD
          MOVE      "********************************************************************************",LXPXATF1
          MOVE      "***",LXPXUCC5
          MOVE      "**************************************************",LXUCC5LD
          MOVE      "********************************************************************************",LXPXATF2
.
CLRV9999  RETURN
+
.*********************************************************************
.         check if a hospital or patient re-schedule letter
.*********************************************************************
CIHOP000  MOVE      "RR",TCODE
          PACK      KEY5,TCODE,OPRSREAS
          CALL      RDCODE1
          BRANCH    OVRCD,CIHOP999
.
          MATCH     ANSH,TCINDC1
          GOTO      CIHOP999 IF NOT EQUAL   * not a hospital re-schedule 
.
          MOVE      OTMASRLH,LETTER         * set the letter code
.
CIHOP999  RETURN
.------------------------------------------------------------
. Routine   : LETEXE00
.
. Funtion   : Execute a UNIX Shell Command to a Print Letter
.
. Inputs    : Valid Record Read from OUTBB1FD
.             Valid Record Read from OUTBOAFD
.             SPLFILE - Spool File Name
.
. Returns   : EXIT = 0 Letter Printed,  1 Letter Not Printed
.------------------------------------------------------------
LETEXE00  MOVE      ONE,FORM3              * Check for UNIX Shell Required
          MOVE      LETTER,LETTFORM
.
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXE90
.
          MATCH     "!sh",OTLTTEXT
          GOTO      LETEXE90 IF NOT EQUAL
.
          MOVE      TWO,FORM3              * Get UNIX Command
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXE99
.
          MATCH     SP70,OTLTTEXT
          GOTO      LETEXE90 IF EQUAL
.
          SFORMAT   VARD127,127
          CLEAR     VARD127
          STRIP     OTLTTEXT
          APPEND    OTLTTEXT,VARD127
          APPEND    SP1,VARD127
          APPEND    "$TBSPOOL/",VARD127      * Spool File Directory
          APPEND    SPLFILE,VARD127          * Spool File Name
          APPEND    ".prt ",VARD127
          APPEND    " '",VARD127
          APPEND    LETTFORM,VARD127         * Letter Number
          APPEND    "' '",VARD127
          APPEND    OBAURNO,VARD127          * U/R
          APPEND    "' '",VARD127
          APPEND    OBAOUTNO,VARD127         * Visit No
          APPEND    "' '",VARD127
          APPEND    OBASITE,VARD127          * Site
          APPEND    "' '",VARD127
          APPEND    OBACLIN,VARD127          * Clinic
          APPEND    "' '",VARD127
          APPEND    OBADATE,VARD127          * Date
          APPEND    "' '",VARD127
          APPEND    OBASTRT,VARD127          * Session Start Time
          APPEND    "' '",VARD127
          APPEND    OBASLOT,VARD127          * Slot
          APPEND    "'",VARD127
          RESET     VARD127
          EXECUTE   VARD127,TASKID           * Execute
.
          MOVE      THREE,FORM3              * Get UNIX Command form 2nd Letter
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXE80
.
          MATCH     "!sh",OTLTTEXT
          GOTO      LETEXE80 IF NOT EQUAL
.
          MOVE      FOUR,FORM3               * Get UNIX Command form 2nd Letter
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXE80
.
          MATCH     SP70,OTLTTEXT
          GOTO      LETEXE80 IF EQUAL
.
          SFORMAT   VARD127,127
          CLEAR     VARD127
          STRIP     OTLTTEXT
          APPEND    OTLTTEXT,VARD127
          APPEND    SP1,VARD127
          APPEND    "$TBSPOOL/",VARD127      * Spool File Directory
          APPEND    SPLFILE,VARD127          * Spool File Name
          APPEND    ".prt ",VARD127
          APPEND    " '",VARD127
          APPEND    LETTFORM,VARD127         * Letter Number
          APPEND    "' '",VARD127
          APPEND    OBAURNO,VARD127          * U/R
          APPEND    "' '",VARD127
          APPEND    OBAOUTNO,VARD127         * Visit No
          APPEND    "' '",VARD127
          APPEND    OBASITE,VARD127          * Site
          APPEND    "' '",VARD127
          APPEND    OBACLIN,VARD127          * Clinic
          APPEND    "' '",VARD127
          APPEND    OBADATE,VARD127          * Date
          APPEND    "' '",VARD127
          APPEND    OBASTRT,VARD127          * Session Start Time
          APPEND    "' '",VARD127
          APPEND    OBASLOT,VARD127          * Slot
          APPEND    "'",VARD127
          RESET     VARD127
          EXECUTE   VARD127,TASKID           * Execute
.
LETEXE80  MOVE      ZERO,EXIT                * Letter Executed
          GOTO      LETEXE99
.
LETEXE90  MOVE      ONE,EXIT                * No Letter Executed
.
LETEXE99  RETURN

.------------------------------------------------------------
. Routine   : LETEXR00
.
. Funtion   : Execute a UNIX Shell Command to a Print Referral Letter
.
. Inputs    : 
.             SPLFILE - Spool File Name
.
. Returns   : EXIT = 0 Letter Printed,  1 Letter Not Printed
.------------------------------------------------------------
LETEXR00  MOVE      ONE,FORM3              * Check for UNIX Shell Required
          MOVE      LETTER,LETTFORM
.
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXR90
.
          MATCH     "!sh",OTLTTEXT
          GOTO      LETEXR90 IF NOT EQUAL
.
          MOVE      TWO,FORM3              * Get UNIX Command
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXR99
.
          MATCH     SP70,OTLTTEXT
          GOTO      LETEXR90 IF EQUAL
.
          SFORMAT   VARD127,127
          CLEAR     VARD127
          STRIP     OTLTTEXT
          APPEND    OTLTTEXT,VARD127
          APPEND    SP1,VARD127
          APPEND    "$TBSPOOL/",VARD127      * Spool File Directory
          APPEND    SPLFILE,VARD127          * Spool File Name
          APPEND    ".prt ",VARD127
          APPEND    " '",VARD127
          APPEND    LETTFORM,VARD127         * Letter Number
          APPEND    "' '",VARD127
          APPEND    OTRLURNO,VARD127         * U/R
          APPEND    "' '",VARD127
          APPEND    OTRLOUTN,VARD127         * Visit No
          APPEND    "'",VARD127
          RESET     VARD127
          EXECUTE   VARD127,TASKID           * Execute
.
          MOVE      THREE,FORM3              * Get UNIX Command form 2nd Letter
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXR80
.
          MATCH     "!sh",OTLTTEXT
          GOTO      LETEXR80 IF NOT EQUAL
.
          MOVE      FOUR,FORM3               * Get UNIX Command form 2nd Letter
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,LETEXR80
.
          MATCH     SP70,OTLTTEXT
          GOTO      LETEXR80 IF EQUAL
.
          SFORMAT   VARD127,127
          CLEAR     VARD127
          STRIP     OTLTTEXT
          APPEND    OTLTTEXT,VARD127
          APPEND    SP1,VARD127
          APPEND    "$TBSPOOL/",VARD127      * Spool File Directory
          APPEND    SPLFILE,VARD127          * Spool File Name
          APPEND    ".prt ",VARD127          
          APPEND    " '",VARD127
          APPEND    LETTFORM,VARD127         * Letter Number
          APPEND    "' '",VARD127
          APPEND    OTRLURNO,VARD127         * U/R
          APPEND    "' '",VARD127
          APPEND    OTRLOUTN,VARD127         * Visit No
          APPEND    "'",VARD127
          RESET     VARD127
          EXECUTE   VARD127,TASKID              * Execute
.
LETEXR80  MOVE      ZERO,EXIT               * Letter Executed
          GOTO      LETEXR99
.
LETEXR90  MOVE      ONE,EXIT                * No Letter Executed
.
LETEXR99  RETURN
.
.**********************************************************************
.*                              CLLXCN00                              *
.*                 Routine to clear LXCNXXXX variables                *
.**********************************************************************
CLLXCN00  PACK      LXCNSITE,SP70
          PACK      LXCNCLIN,SP70
          PACK      LXCNDATE,SP70
          PACK      LXCNSTRT,SP70
          PACK      LXCNSLOT,SP70
          PACK      LXCNTIME,SP70
          PACK      LXCNNOUT,SP70
          PACK      LXCNURNO,SP70
          PACK      LXCNREAS,SP70
          PACK      LXCNRTIM,SP70
          PACK      LXCNSRCR,SP70
          PACK      LXCNCOMP,SP70
          PACK      LXCNCLAS,SP70
          PACK      LXCNINSU,SP70
          PACK      LXCNCATE,SP70
          PACK      LXCNPRTY,SP70
          PACK      LXCNOPER,SP70
          PACK      LXCNTRAN,SP70
          PACK      LXCNVTYP,SP70
          PACK      LXCNRLRR,SP70 
          PACK      LXCNVTPC,SP70
          PACK      LXOTVTPC,SP70
          PACK      LXOTVTYP,SP70
          PACK      LXRESCLN,SP70
          PACK      LXRESFRD,SP70
.
CLLXCN99  RETURN
.**********************************************************************
.*                              CLNK0000                              *
.*                 Routine to clear Other Contact Variables           *
.**********************************************************************
CLNK0000  PACK      LXPNKNME,SP70
          PACK      LXPNKAD1,SP70
          PACK      LXPNKAD2,SP70
          PACK      LXPNKSUB,SP70
          PACK      LXPNKAD4,SP70
          PACK      LXPNKPST,SP70
          PACK      LXPNKRLP,SP70
          PACK      LXPNKRLD,SP70
          PACK      LXPNKTLP,SP70
          PACK      LXPNKTLB,SP70
          PACK      LXPXKMOB,SP70
          PACK      LXPXKEML,SP70,SP70
.
          PACK      LXPXCMOB,SP70
          PACK      LXPXCEML,SP70,SP70
.
          PACK      LXPXRMOB,SP70
          PACK      LXPXREML,SP70,SP70 
.
          PACK      LXPXDVAN,SP70
          PACK      LXPAPENN,SP70
          PACK      LXPXPMBN,SP70
          PACK      LXPXPLC1,SP70
          PACK      LXPXPLD1,SP70
          PACK      LXPXPEMX,SP70,SP70 
.
CLNK9999  RETURN
+
.******************************************************************************
.*                                  XCOD0000                                  *
.*                       Get Xtra Screen Category Code description            *
.******************************************************************************
XCCD0000  PACK      KEY6,OBASITE,SP70
          CALL      RDOTSIP1           * Read Site Specific Category Codes
          BRANCH    OVRCD,XCCD9999
.
          PACK      KEY8,OBAOUTNO
          CALL      RDOTXSC1                * Read an xtra screen file record
          BRANCH    OVRCD,XCCD9999
.
          MOVE      SP70,CATEGORY
          LOAD      CATEGORY,F2,OTSPXC01,OTSPXC02,OTSPXC03,OTSPXC04,OTSPXC05:
                                OTSPXC06,OTSPXC07,OTSPXC08,OTSPXC09,OTSPXC10:
                                OTSPXC11,OTSPXC12,OTSPXC13,OTSPXC14,OTSPXC15:
                                OTSPXC16,OTSPXC17,OTSPXC18,OTSPXC19,OTSPXC20
          MOVE      SP70,CODE
          LOAD      CODE,F2,OTXSCO01,OTXSCO02,OTXSCO03,OTXSCO04,OTXSCO05:
                            OTXSCO06,OTXSCO07,OTXSCO08,OTXSCO09,OTXSCO10:
                            OTXSCO11,OTXSCO12,OTXSCO13,OTXSCO14,OTXSCO15:
                            OTXSCO16,OTXSCO17,OTXSCO18,OTXSCO19,OTXSCO20
.
          MATCH     SP70,CATEGORY
          GOTO      XCCD9999 IF EQUAL
.
          MATCH     SP70,CODE
          GOTO      XCCD9999 IF EQUAL
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            STORE     TDESC,F2,LXXCOD01,LXXCOD02,LXXCOD03,LXXCOD04,LXXCOD05:
                               LXXCOD06,LXXCOD07,LXXCOD08,LXXCOD09,LXXCOD10:
                               LXXCOD11,LXXCOD12,LXXCOD13,LXXCOD14,LXXCOD15:
                               LXXCOD16,LXXCOD17,LXXCOD18,LXXCOD19,LXXCOD20
          ENDIF
.
XCCD9999  RETURN
+
.******************************************************************************
.*                                  NOK20000                                  *
.*                         Get NOK2 Contact Details                           *
.******************************************************************************
NOK20000  PACK      KEY5,CATTC,SP70
          CALL      RDSCODE1
NOK21000  CALL      RDKCODE1
          BRANCH    OVRCD,NOK25000
.
          MATCH     CATTC,TCODE
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      NOK21000 IF EQUAL
.
          MATCH     CONTTYPE,TCINDC1
          IF        @EQUAL
            MATCH     "2",TCINDC3                * indc1=1 and indc3=2
            GOTO      NOK22000 IF EQUAL
          ENDIF
          GOTO      NOK21000
.
NOK22000  PACK      KEY14,PURNO,ACODE,SP70
          CALL      RSPMCEX1
NOK22100  CALL      RKPMCEX1
          BRANCH    OVRCD,NOK25000
.
          MATCH     PURNO,PMCEURNO          * Same U/R
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     ACODE,PMCETYPE          * Same Contact Type
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV            * Ignore if inactive
          GOTO      NOK22100 IF EQUAL
.
          GOTO      NOK29999
.
NOK25000  CALL      CLPMSCEX                * Clear extra contact file vars
.
NOK29999  RETURN
+
