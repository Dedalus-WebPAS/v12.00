.----------------------------------------------------------------------
. Program       : CLIWEB03
.
. Function      : Clinical Results List Server
.
. Modifications  : 
.----------------------------------------------------------------------
. V11.05.03 17/02/2024  Ebon Clements  TSK 0954547
.           Added showallf to report 5 NEXT000 and PREV0000
.           If result error not found in current year check
.           previous 5 years - ERTAB000 type 99
. V11.05.02 19.12.2024  DA Sarkies     TSK  0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.01 26.11.2024  Ebon Clements  Task 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.04.07 17/10/2024  Sunny        TSK 0939070
.           Fixed FHIR api ProcedureRequest dxc-hc-copyto Extension
. V11.04.06 12/09/2024  Peter Vela     Task 0941587
.           Made result yearly file opens consisten between RESDIR00
.           and RESPRQ00
. V11.04.05 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.04 11.07.2024  DA Sarkies     TSK 0948853
.           Removed the next and previous page sections for FHIR
. V11.04.03 18.06.2024  DA Sarkies     TSK 0941587
.           Added code to sort diagnosis results brought by FHIR
.           Sort by date from latest to earliest & earliest to latest
. V11.04.02 10.05.2024  DA Sarkies     TSK 0941587
.           Added code to filter by date and removed pagnation     
. V11.04.01 05/02/2024  Alina Bhari    TSK 0941780
.           Displayed next calendar year for all the future orders
.           - URTAA050 
.           Dispayed the next calendar year in the fileter of results
.           if current mon is december -RSLKY560
. V11.03.02 11/07/2023  Peter Vela    TSK 0927262
.           ClinicalAide FHIR api ProcedureRequest
.           Added Subject include FHRSUBIN functionality
.           Added Location include FHRLOCIN functionality
.           Added Participant include FHRPARIN functionality
. V11.03.01 14/06/2023  Peter Vela    TSK 0927262
.           ClinicalAide FHIR api DiagnosticReport
.           Added Subject include FHRSUBIN functionality
.           Added Location include FHRLOCIN functionality
. V11.02.02 08/04/2022  Alina Bhari   TSK 0913264
.           Displayed the laboratory description in lab column
.           on Clinical Results Template
. V11.02.01 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.01 20/07/2021  Jill Parkinson Task 0909273
.           Moved ADD ONE,ROWCOUNT to be inside TABROW00 so when records
.           are skipped they are not included in the row output count
. V11.00.02 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 19/11/2020  Don Nguyen     TSK 0898007 
.           Corrected code in PATNXT00 (Next Group for Patient) to cater for
.           null ADMISSNO values.
. V10.13.02 17.12.2018  B.G.Ackland    TSK 0835482 
.           FHIR Fix output of performer.actor 
. V10.13.01 03.08.2018  B.G.Ackland    TSK 0860957
.           Ignore change below for error row list
. V10.11.11 06/12/2017  Don Nguyen     TSK 0841849
.           Modified HL7ROW00 (HL7ROW80) to EXIT 1 if the Diagnostic Service
.           Sector ID has the IBA Code (Category "dg") where indicator 3=X.
. V10.11.10 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.09 24.11.2017  B.G.Ackland    TSK 0835482 
.           FHIR Fix DiagnosticReport for Effective Date Output
. V10.11.08 15.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Fix ProcedureRequest Ignore Cancelled Orders - REHARST=X
. V10.11.07 15.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Fix ProcedureRequest Resource to include Encounter Reference
. V10.11.06 06.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Fix ProcedureRequest Resource Output for Order
. V10.11.05 06.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Add ProcedureRequest Resource Output for Order
. V10.11.04 29.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Add Filter by Diagnostic Service into URTAA & URTAB
. V10.11.03 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.02 17.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Change Patient ID for Integration Purposes
. V10.11.01 03/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.----------------------------------------------------------------------
. V10.10.04 11.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Testing for ClinicalAide
. V10.10.03 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Added Image Link Extension
. V10.10.02 08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
. V10.10.01 07.04.2017  B.G.Ackland    TSK 0835482 
.           FHIR output of encounters
.           Removed Change Below
.-----------------------------------------------------------------------
. V10.08.04 08/07/2016  Ania P         CAR 820639
.           Commented out Corrected Results check in TABMK000
. V10.08.03 06/07/2016  Jill Parkinson TSK 0822222  
.           Commented out call to REDMAP00, if invalid UR message is triggered
. V10.08.02 24/06/2016  Jill Parkinson TSK 0821205  
.           Fixed check for deleted result in ERTAB000
. V10.08.01 30.05.2016  Ania P           CAR 303363
.           Changes to result tables read/write in DERES000
. V10.07.01 05.11.2015  Steve Armstrong  CAR 303363
.           Recompiled for changes to RESHEAFD
.----------------------------------------------------------------------
. V10.05.02 20.10.2014  Ebon Clements CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.05.01 13.08.2014  B.G.Ackland   CAR 
.           Filter Error Log by Company.
.           Table Sort Output of Error Log.
.----------------------------------------------------------------------
. V10.04.02 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.09 09.12.2013  B.G.Ackland    CAR 295072
.           Additional Error Log Filters
. V10.03.08 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.07 17.12.2012  B.G.Ackland   CAR 275970
.           Ensure Alignment Across Release 10.01/03
. V10.03.06 03.08.2012  SAroeun Soeur CAR 269373
.           commented out call to SETWEK00
. V10.03.05 10.03.2012  B.G.Ackland  CAR 265085
.           Mobility Suite JSON Reply New Tag USUM0900
. V10.03.04 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.03 09/01/2012  B.G.Ackland
.           Filter for Abnormal Results
.           Filter for Laboratory Code
.           Default Week View to Last 7 Days
.           Fix Week View running over end of Calendar Year
.           New Request parameters for NORMALFL All=blank, Normal=1, Abnormal=0
.           New Tag for Lab Code Select List xx.115                              
.           New Tag for Lab Code Selected List xx.116                              
.           New Tag for Normal Flag xx.117                              
. V10.03.02 21/12/2011  B.G.Ackland  
.           Pack key for Unread Result to include the start date for Performance
. V10.03.01 23/11/2011  Ebon Clements   CAR 255738
.           Show ward beds in short description order
. V10.02.01 29/06/2011  Peter McMullen   CAR 24725 
.           Change ward selection list to sort by name, not code  
. V10.01.01 24/01/2011  B.G.Ackland CAR 237136
.           move zero to ovrcd prior to open trap on reslnkaf x 3
. V9.12.06  07/12/2009  Peter McMullen CAR 210130
.           convert all calls to DOCNAM00 to DOCNM000 
. V9.12.05  04/11/2009  Jill Parkinson CAR 201400
.           Fixed current year default in URTAA043
. V9.12.04  23/10/2009  Jill Parkinson CAR 201400 and CAR 201086
.           Added check for startnum in PATROW20 and clear of labdesc in DOCROW0
. V9.12.03  01/09/2009  Saroeun Soeur  CAR 201216
.           RSLKY000 - default to parameter year selected
.           added URTAA040,URTAA041 and URTAA042 in URTAA000
. V9.12.02  26/08/2009  Peter McMullen CAR 171901
.           remove MAPCAT00 call
. V9.12.01  05/08/2009  Jill Habasque  CAR 145706
.           Mods to use WBSEGPCD instead of DOCTCODE if viewing results for GP
. V9.11.01  29/10/2008  Jill Habasque  CAR 181470
.           Added add one to RECNUMB in PATROW20
. V9.10.01  11/09/2008  Jill Habasque  CAR 177821
.           Added check for diagnostic group in DOCROW00
. V9.09.04  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.03  29/06/2007  Jill Habasque CAR 142358
.           Added move one to exit in PATROW00
. V9.09.02  28/06/2007  Jill Habasque CAR 142358
.           Moved check for startnum to be in PATROW00           
. V9.09.01  20/06/2007  Jill Habasque CAR 122473
.           Added output of diagtype in PATNXT00 and PATLST00
. V9.08.04  20/04/2007  Jill Habasque CAR 122473
.           Added output of lastrow flag
. V9.08.03  04/04/2007  Jill Habasque CAR 122473
.           Added option for multiple diagtype selections           
. V9.08.02  29/03/2007  Jill Habasque CAR 122473
.           Added "All Years" and also diagnostic type group filter
. V9.08.01  31/01/2007  Peter Vela    CAR 127930
.           Recompiled for EMRSITFD
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.02  07/10/2005 Jill Habasque CAR 43723
.           Added option 9 - delete of results
. V9.04.01  03/10/2005 Jill Habasque CAR 77472
.           Added clear of RESLNKYR and added to PATNXT00 and PATLST00
. V9.03.04  07/06/2004 Peter Vela    CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.03  26/03/2004 Peter Vela    CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
.           09/02/2004 Peter Vela    CAR 38290
.           Added functionality for result lists. reslnkaf has now been split
.           into yearly files (e.g. reln1999, reln2000, reln2001, etc...)
. V9.03.02  25/08/2003 Ebon Clements CAR 42813
.           Recompiled for EMRSITFD changes that were missing in V9 that        
.           had been made in 5.09 - EMSTDLOC
. V9.03.01  16/05/2003 Jill Habasque SRF 38916
.           Added option 8 - Results by EMR Site
. V9.02.07  02/05/2003 Jill Habasque SRF 38506
.           Commented out check for Final and Corrected in LNTAB00
. V9.02.06  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.05  10/01/2003 Jill Habasque            SRF 34657
.           Results SRF - Attending Doctor only and Reffering only links added
. V9.02.04  05/12/2002 Lina Vo                  SRF 22709
.           Added OPNOUT00 to open outpatient files  
. V9.02.03  09/10/2002 Peter Vela               SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.02  03/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.01  11.09.2001 Harvinder
.           Modified for zero urnumber display in emergency
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B02 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B01 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
.----------------------------------------------------------------------
.                 V5.09.B04 12/01/2001 Bronko Sosic
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.09.B03 08/01/2001 J Habasque 
.                           Fixed global recompile errors - Doctors Mods
.                 V5.09.B.02 15.12.2000 B.G.Ackland
.                          New Error List by Company & Date
.                 V5.08.09 15.11.2000 B.G.Ackland
.                          Added Result Error File
.                 V5.08.08 28/09/2000 B.G.Ackland
.                          Correspondance Links
.                 V5.08.07 28/09/2000 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.06 28.08.2000
.                          Added USC to Row Output in line with 507
.                 V5.08.05  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.04 27.07.2000 B.G.Ackland
.                          Multiple Hospital Common U/R Link
.                 V5.08.03 15.06.2000 Katie Nelson 
.                          Make Maximun Number of Results per Page 20
.                          13.06.2000 Katie Nelson 
.                          Recompiled for WEBDATCD changes
.                 V5.08.01 07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM
.----------------------------------------------------------------------
.                 V5.07.10 23.05.2000 Pat Dirito    
.                          Read on Index 2 of Out Clinics file now KEY14
.                 V5.07.09 27.03.2000 B.G.Ackland
.                          Fix Next and Previous Patient Options
.                 V5.07.08 01.02.2000 B.G.Ackland
.                          Change Mark as Read for U/R to Display
.                 V5.07.07 18.01.2000 B.G.Ackland
.                          U/R Column in Results List
.                 V5.07.06 29.12.1999 B.G.Ackland
.                          Upgrade to New Standards
.                          06.01.2000 K.C.Nelson 
.                          Recompiled for WEBDATCD Y2K date correction
.                          also for PATMASTM changes
.                 V5.07.05 05.11.1999 B.G.Ackland
.                          Make Maximun Number of Results per Page 50
.                          17.12.1999 K.C.Nelson 
.                          Recompile for IBAWEBDF/IBAWEBCD/PATWRDTM   
.                 V5.07.04 04.11.1999 B.G.Ackland
.                          Allow Selected Doctor
.                 V5.07.03 03.11.1999 K.C.Nelson 
.                          Recompiled for WEBDATCD/DAYOFWEK
.                 V5.07.02 11.10.1999 B.G.Ackland
.                          Fix Error & Linking      
.                 V5.07.01 23.09.1999 B.G.Ackland
.                          Short Status Description
.                 V5.07.00 23.07.1999 Nicole Harrington  
.                          Port 6.06 to 5.07
.
.----------------------------------------------------------------------
.                 V6.06.02 25.06.1999 B.G.Ackland
.                          Results by Collection Date
.
.                 V6.06.00 31.03.1999 K.C.Nelson 
.                          Port from 6.05 to 6.06
.
.                 V6.05.04 22.03.1999 B.G.Ackland
.                          Show Single Result Lines as Test Name
.
.                 V6.05.03 22.03.1999 B.G.Ackland
.                          Added Test Category to Lists
.
.                 V6.05.02 04.02.1999 F. Mannan
.                          Added Result Log Details 
.                          15.02.1999 Katie Nelson
.                          Added call to PATNAA00 instead of PATNAM00 to
.                          remove bold tags from WEBTITLE      
.
.                 V6.05.01 18.01.1999 B.G.Ackland
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
.
          INC       WEBDATDF
          INC       FHRDATDF
.
          INC       APSMASFD/INC
          INC       EMRSITFD/INC
          INC       HL7CODFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATALRFD/INC
          INC       PATHSPFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PATIN1FD/INC
          INC       PATNURFD/INC
          INC       PATPR1FD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       OBSPCTFD/INC       * Correspondence Storage Location Table
          INC       OBSPCOFD/INC
          INC       RESCLNFD/INC
          INC       RESERRFD/INC
          INC       RESLOGFD/INC
          INC       RESLABFD/INC
          INC       RESLURFD/INC
          INC       RESLNKFD/INC
          INC       RESPIDFD/INC
          INC       RESPHRFD/INC
          INC       RESPDSFD/INC
          INC       RESCTAFD/INC
          INC       RESHEAFD/INC
          INC       RESHEBFD/INC
          INC       RESHECFD/INC
          INC       RESHEDFD/INC
          INC       RESDEAFD/INC
          INC       RESDEBFD/INC
          INC       RESDECFD/INC
          INC       RESAUDFD/INC
          INC       PATCALAG/INC
          INC       PATDO1FD/INC
          INC       PATMI1FD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PMSCCDFD/INC       * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
.
          INC       MRTLOCFD/INC
          INC       SCRMASFD/INC
          INC       PATFN1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
RESABN    DIM       5
RESACK    DIM       5
AUDITKEY  DIM       40
FORMATTY  FORM      1
COUNT     FORM      3
DASH      INIT      "-"
DIAGTYPC  FORM      2
DIAGTYPE  DIM       3[99]
DIAGTCOD  DIM       14
DIAGTDES  DIM       25
FOUNDTYP  FORM      1
FORM4B    FORM      4
FORM8     FORM      8
FOUNDFLG  FORM      1
CFILEPRE  DIM       3
CLINICID  DIM       6
CURRYEAR  DIM       4
DIM13     DIM       13
DIM25     DIM       25
DELTVIEW  FORM      1
TXTLEN    FORM      3  
OUTVAR    DIM       127
TXT127    DIM       127
TESTCODE  DIM       32
TESTLINE  DIM       127
COLORSTR  DIM       12
HIGHCODE  DIM       4
LABDESC   DIM       40
LASTROW   FORM      1
COLLDATE  DIM       8
COLLTIME  DIM       5
TESTLIST  DIM       127
TESTFST   FORM      1
RESULTYR  DIM       4
YEARCNTR  FORM      1
YEAROPEN  DIM       4
REDAOPEN  DIM       4
RESFNAME  DIM       8
RETYER01  DIM       4               * I CAR 38290
ROWCOUNT  FORM      5
SUPERVIS  FORM      1
.
HUNDRED9  FORM      "109"           * I CAR 38290
.
PREAEA    INIT      "reau"
PREHEA    INIT      "reha"
PREHEB    INIT      "rehb"
PREHEC    INIT      "rehc"
PREHED    INIT      "rehd"
PREDEA    INIT      "reda"
PREDEB    INIT      "redb"
PREDEC    INIT      "redc"
PRELEN    INIT      "reln"          * I CAR 38290
.
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
.
LOCNCODE  DIM       4
.
RESTPRG   DIM       8
RESTREP   DIM       2
RESTTEM   DIM       3
CLINKTYP  DIM       2
LINKTYPE  DIM       2
LINKKEYF  DIM       10
RESULTKY  DIM       17
RESULTKS  DIM       127[100]
TESTSETS  DIM       100
INDEXLEN  FORM      3
GROUPBY   DIM       1
STARTKEY  DIM       127
STATIMG   DIM       20
RESTIMG   DIM       20
DELETERS  DIM       3                  * Reason for Delete CAT Rd
DIM3      DIM       3
DIM4      DIM       4
DIM8      DIM       8
DIM5      DIM       5
DIM16     DIM       16
DIM17     DIM       17
DIM20     DIM       20
KEY3A     DIM       3
KEY3B     DIM       3
DAYTIME   DIM       3
DATETIME  DIM       25
DOCTCODE  DIM       6
DOCTTYPE  DIM       2
ESITCODE  DIM       3
WARDCODE  DIM       3
TEAMCODE  DIM       3
EMRGFLAG  DIM       1
IMAGE     DIM       44
ICOIMAGE  DIM       30
COLDAT01  DIM       20
LABRCODE  DIM       3
NORMALFL  DIM       1
FILTRDSS  DIM       10
NEXTPAGE  FORM      1
RESLNKFL  DIM       8
RESLNKYR  DIM       4
RESLNKCT  FORM      4
UPDATETY  DIM       1
VAR1      INIT      "cmno"
VAR2      INIT      "ally"
SHOWALLF  FORM      1
CATRd     INIT      "Rd"
LINETHRU  INIT      "LineThrough"
.FHRPATID  DIM       8
.FHRENCID  DIM       16
FHRDIRID  DIM       17
FHROBSID  DIM       21
FHIRSUMM  FORM      1 
IMAGELNK  FORM      1
ACKBYDTM  DIM       25
ACKBYWHO  DIM       40
SAVEWUID  DIM       10
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
PROCREQT  FORM      1
SHOWERRR  FORM      1
SORTRSLT  FORM      1      * Sort diagnosis - 0 last to first 1 - opposite
SPRLDDES  DIM       40
.
CATTC     INIT      "tc"
.
FHRSUBIN  FORM      1      * _include=DiagnosticReport:subject
.                          * _include=ProcedureRequest:subject
FHRLOCIN  FORM      1      * _include=DiagnosticReport:location
.                          * _include=ProcedureRequest:location
FHRPARIN  FORM      1      * _include=DiagnosticReport:participant
.
.------------------------------------------------------------
PRGID     INIT      "CLIWEB03"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "Clinical Results List Server"
.------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      URNRES00      * Results by U/R
          GOTO      MAIN1000
.
MAIN1200  CALL      VISRES00      * Results by Visit Number
          GOTO      MAIN1000
.
MAIN1300  CALL      DOCRES00      * Results by Doctor
          GOTO      MAIN1000
.
MAIN1400  CALL      WRDRES00      * Results by Ward
          GOTO      MAIN1000
.
MAIN1500  CALL      HEADER00      * Result Log Details by Date
          GOTO      MAIN1000
.
MAIN1600  CALL      ERRRES00      * Error Results
          GOTO      MAIN1000
.
MAIN1700  CALL      CLIRES00      * Results by Clinic ID
          GOTO      MAIN1000
.
MAIN1800  CALL      EMRRES00      * Results by EMR Site
          GOTO      MAIN1000
.
MAIN1900  CALL      DERES000      * Delete results
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          CALL      GETTZ000  * Get Timezone
.
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
.
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      HL7CODA1,"hl7codaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      RESCLNA1,"resclnaf"
          OPEN      RESERRA1,"reserraf"
          OPEN      RESLOGA1,"reslogaf"
          OPEN      RESLOGA2,"reslogaf"
          OPEN      WEBSECA1,"websecaf"
.
          OPEN      RESLABA1,"reslabaf"
          OPEN      RESLURA1,"resluraf"
          OPEN      RESLURA2,"resluraf"
.         OPEN      RESLNKA1,"reslnkaf"           * D CAR 38290
.         OPEN      RESLNKA2,"reslnkaf"           * D CAR 38290
.         OPEN      RESLNKA3,"reslnkaf"           * D CAR 38290
          OPEN      RESPIDA1,"respidaf"
          OPEN      RESPHRA1,"resphraf"
          OPEN      RESPHRA2,"resphraf"
          OPEN      RESPDSA1,"respdsaf"
          OPEN      RESCTAA1,"resctaaf"
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC
          READ      CONTROLF,HUNDRED9;*204,PTCNRSYR        * I CAR 38290
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND12;*101,PTCNUFFR
          READ      CONTROLF,HUND14;*248,PTCNYRDF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      IBACLOCK
          PACK      YEAROPEN,CCC,CYY
          PACK      RESULTYR,CCC,CYY
          REP       " 0",YEAROPEN
          REP       " 0",RESULTYR
          CALL      RESOPN00
          IF        OVRCD=1
            MOVE      SP70,YEAROPEN
          ENDIF
          MOVE      ZERO,DELTVIEW
.
          RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE 
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.------------------------------------------------------------
. Open Result Tables
.------------------------------------------------------------
RESOPN00  CLOSE     RESHEAA1
          CLOSE     RESHEAA3
          CLOSE     RESHEBA1
          CLOSE     RESHECA1
          CLOSE     RESHEDA1
          CLOSE     RESDEAA1
          CLOSE     RESDEBA1
          CLOSE     RESDECA1
          CLOSE     RESLNKA1
          CLOSE     RESLNKA3
          CLOSE     RESAUDA1
.
          PACK      RESFNAME,PREHEA,RESULTYR
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESHEAA1,RESFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,RESOPN99
          OPEN      RESHEAA3,RESFNAME
.
          PACK      RESFNAME,PREHEB,RESULTYR
          OPEN      RESHEBA1,RESFNAME
          PACK      RESFNAME,PREHEC,RESULTYR
          OPEN      RESHECA1,RESFNAME
          PACK      RESFNAME,PREHED,RESULTYR
          OPEN      RESHEDA1,RESFNAME
          PACK      RESFNAME,PREDEA,RESULTYR
          OPEN      RESDEAA1,RESFNAME
          PACK      RESFNAME,PREDEB,RESULTYR
          OPEN      RESDEBA1,RESFNAME
          PACK      RESFNAME,PREDEC,RESULTYR
          OPEN      RESDECA1,RESFNAME
          PACK      RESFNAME,PRELEN,RESULTYR
          OPEN      RESLNKA1,RESFNAME
          PACK      RESFNAME,PRELEN,RESULTYR
          OPEN      RESLNKA3,RESFNAME
          PACK      RESFNAME,PREAEA,RESULTYR
          OPEN      RESAUDA1,RESFNAME
.
          MOVE      RESULTYR,YEAROPEN
.
RESOPN99  RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          OPEN      OUTCLIA1,CFNAME    
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,SHOWALLF
          MOVE      ZERO,PROCREQT
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,STARTNUM
          MOVE      SP70,RESULTKY
          MOVE      SP70,CLINKTYP
          MOVE      SP70,STARTKEY
          MOVE      SP70,DOCTCODE
          MOVE      SP70,DOCTTYPE
          MOVE      SP70,CLINICID
          MOVE      SP70,LINKKEYF
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,NORECORD
          MOVE      SP70,VYEARMTH
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,TEAMCODE
          MOVE      SP70,WARDCODE
          MOVE      SP70,ESITCODE
          MOVE      SP70,LABRCODE
          MOVE      SP70,NORMALFL
          MOVE      ZERO,FHIRSUMM
          MOVE      SP70,FILTRDSS
          MOVE      SP70,EMRGFLAG
          MOVE      SP70,RETYER01            * I CAR 38290
          MOVE      SP70,RESLNKYR
          MOVE      ZERO,SUPERVIS
          MOVE      SP70,UPDATETY
          MOVE      ZERO,NEXTPAGE
          MOVE      SP70,DELETERS
          PACK      REDIRECT,SP70,SP70,SP70,SP70
.
          MOVE      ZERO,DIAGTYPC
          MOVE      ONE,COUNT
          WHILE     COUNT <= 99
            MOVE      SP70,DIAGTYPE[COUNT]
            ADD       ONE,COUNT
          DO
          MOVE      ZERO,SHOWERRR
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,SORTRSLT
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labrcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABRCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procreqt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCREQT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showallf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWALLF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "normalfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORMALFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirsumm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRSUMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtrdss=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTRDSS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinicid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diagtype=",QRYNAME
          IF        @EQUAL
            ADD       ONE,DIAGTYPC
            PACK      DIAGTYPE[DIAGTYPC],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkkeyf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKKEYF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "resultky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESULTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            PACK      STARTKEY,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WARDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "esitcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ESITCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "teamcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEAMCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emrgflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMRGFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            SQUEEZE   REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reslnkyr=",QRYNAME            * I CAR 38290
          IF        @EQUAL
            MOVE      QRYDATA,RESLNKYR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retyer01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETYER01
            GOTO      SETPAR99
          ENDIF                                    * end I CAR 38290
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deleters=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DELETERS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sortrslt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SORTRSLT
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Results by U/R
.------------------------------------------------------------
URNRES00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,URNRES90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PATNAA00                * format name without bold tags
.
          CLEAR     WEBTITLE
          APPEND    "Clinical Results for ",WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,URNRES99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          GOTO      URNRES99
.
URNRES90  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MATCH     "Y",EMRGFLAG
          IF        @EQUAL
......      CALL      REDMAP00
          ENDIF
.
URNRES99  RETURN
.------------------------------------------------------------
. Results by Visit Number
.------------------------------------------------------------
VISRES00  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VISRES90
.
          MOVE      PVIURNO,URNUMBER
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VISRES90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PATNAA00                * format name without bold tags
.
          CLEAR     WEBTITLE
          APPEND    "Clinical Results for ",WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MAIN9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          GOTO      VISRES99
.
VISRES90  MOVE      "Invalid Patient Visit Number",WEBTITLE
          CALL      WEBERR00
.
VISRES99  RETURN
.-------------------------------------------------------------
. Doctor Results
.-------------------------------------------------------------
DOCRES00  MATCH     SP70,DOCTCODE
          IF        @EQUAL
            MOVE      WBSEDOC,DOCTCODE
          ENDIF
.
          MOVE      DOCTCODE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            CALL      CLRDOC00
          ENDIF
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000

.          MATCH     SP70,LASTDATE
.          IF        @EQUAL
.            MATCH     "1",VIEWTYPE
.            CALL      SETWEK00 IF EQUAL
.          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          APPEND    "Results for ",WEBTITLE
          APPEND    DOCFNAME,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DOCRES99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
          GOTO      DOCRES99
.
DOCRES90  MOVE      "INVALID DOCTOR CODE",WEBTITLE
          CALL      WEBERR00   * Output Error
.
DOCRES99  RETURN
.----------------------------------------------------------------------
. Clear Doctor Details if Code is invalid
.----------------------------------------------------------------------
CLRDOC00  MOVE       "~~~~~~",DOCTCODE
          MOVE       "~~~~~~",DCODE
          MOVE       SP70,DTITL
          MOVE       SP70,DGNAME
          MOVE       "Not Specified",DSNAME
          MOVE       SP70,DRTYPE
          MOVE       SP70,DRNAME
          MOVE       SP70,DSADD1
          MOVE       SP70,DSADD2
          MOVE       SP70,DSADD3
          MOVE       SP70,DSADD4
          MOVE       SP70,DSPOST
          MOVE       SP70,DTELES
          MOVE       SP70,DTELEP
          MOVE       ZERO,DPAGER 
          MOVE       SP70,DASSOC1   
          MOVE       SP70,DASSOC2
          MOVE       SP70,DPROV 
          MOVE       SP70,DTELEH
          MOVE       SP70,DHADD1
          MOVE       SP70,DHADD2
          MOVE       SP70,DHADD3
          MOVE       SP70,DHADD4
          MOVE       SP70,DHPOST
          MOVE       SP70,DAFIRST
          MOVE       SP70,DALAST 
          MOVE       ZERO,DAYEARS
          MOVE       SP70,DACCRED
          MOVE       SP70,DRTYPE2
          MOVE       SP70,DRTYPE3
          MOVE       SP70,DRTYPE4
          MOVE       SP70,DRTYPE5
          MOVE       ZERO,PTDONHSN 
          MOVE       SP70,DBIRTH
          MOVE       ZERO,DHCSCOD
          MOVE       SP70,DALEVEL
          MOVE       ZERO,DRSTAT
          MOVE       SP70,DASPARE
.
CLRDOC99  RETURN
.-------------------------------------------------------------
. Clinic ID Results
.-------------------------------------------------------------
CLIRES00  MATCH     SP70,WBSECLI
          IF        !@EQUAL
            MOVE      WBSECLI,CLINICID
          ENDIF
.
          PACK      KEY20,WBSESIT,CLINICID,Z70 * Read for Current Effective Date
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CLIRES90
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          APPEND    "Results for ",WEBTITLE
          APPEND    OCADESC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CLIRES99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
          GOTO      CLIRES99
.
CLIRES90  MOVE      "INVALID CLINIC ID",WEBTITLE
          CALL      WEBERR00   * Output Error
.
CLIRES99  RETURN
.------------------------------------------------------------
. Ward Results
.------------------------------------------------------------
WRDRES00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            CALL      CLRWRD00
          ENDIF
.
.          MATCH     SP70,LASTDATE
.          IF        @EQUAL
.            MATCH     "1",VIEWTYPE
.            CALL      SETWEK00 IF EQUAL
.          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00
.
          CLEAR     WEBTITLE
          APPEND    "Results for ",WEBTITLE
          APPEND    WBDESC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,WRDRES99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      WRDRES99
.
WRDRES90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
WRDRES99  RETURN
.------------------------------------------------------------
. Clear Ward File Variables
.------------------------------------------------------------
CLRWRD00  MOVE       "Unspecified Ward",WBDESC  
          MOVE       SP70,WWARD   
          MOVE       SP70,WBED    
          MOVE       SP70,DWADMNO 
          MOVE       SP70,WEXTN   
          MOVE       SP70,WRTYPE  
          MOVE       SP70,WEFRBT  
          MOVE       SP70,WSERV   
          MOVE       SP70,WCLASS  
          MOVE       SP70,DWSTBY  
          MOVE       SP70,PTWDHOSN
          MOVE       SP70,PTWDIAGE
          MOVE       SP70,PTWDICRE
          MOVE       SP70,PTWDSEX 
          MOVE       SP70,PTWDLOCN
          MOVE       SP70,PTWDGLDG
          MOVE       SP70,PTWDSPAR 
          MOVE       ZERO,WOCCBED
          MOVE       ZERO,WBLINE  
          MOVE       ZERO,WNBEDS   
          MOVE       ZERO,WHCSSUB    
          MOVE       ZERO,WPLUR  
          MOVE       ZERO,WINPUT   
          MOVE       ZERO,WACTIVE   
          MOVE       ZERO,PTWDDNIN   
CLRWRD99  RETURN
.------------------------------------------------------------
. EMR Site Results
.------------------------------------------------------------
EMRRES00  MATCH     SP70,ESITCODE
          IF        @EQUAL
            MOVE      WBSEESC,ESITCODE
          ENDIF
          PACK      KEY3,ESITCODE,SP70
          CALL      RDEMSIT1
          IF        OVRCD=1
            CALL      CLREMR00
          ENDIF
.
.          MATCH     SP70,LASTDATE
.          IF        @EQUAL
.            MATCH     "1",VIEWTYPE
.            CALL      SETWEK00 IF EQUAL
.          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00
.
          CLEAR     WEBTITLE
          APPEND    "Results for ",WEBTITLE
          APPEND    EMSTDESC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,EMRRES99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      EMRRES99
.
EMRRES90  MOVE      "INVALID EMR SITE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
EMRRES99  RETURN
.
SETWEK00  READ      CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
          CALL      IBACLOCK
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
.
          PACK      LASTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",LASTDATE
          MOVE      "-7",ADJDAYS
          CALL      ADJDAT00
          PACK      FRSTDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY45,FRSTDATE,SP1,LASTDATE,SP70
          RETURN
.
.------------------------------------------------------------
. Clear EMR Site Variables
.------------------------------------------------------------
CLREMR00  MOVE       "Unspecified Site",EMSTDESC
          MOVE       SP70,EMSTSCOD
          MOVE       SP70,EMSTHRPW
          MOVE       SP70,EMSTDPTY
          MOVE       SP70,EMSTSPCO
          MOVE       SP70,EMSTSPNO
          MOVE       SP70,EMSTHSNO
          MOVE       SP70,EMSTDLOC
          MOVE       SP70,EMSTDRLC
          MOVE       SP70,EMSTDRES
          MOVE       SP70,EMSTEDST
          MOVE       SP70,EMSTEDFP
          MOVE       ZERO,EMSTACTV
.
CLREMR99  RETURN
+
.------------------------------------------------------------
.Heading and Current Date for the Result Log Details
.------------------------------------------------------------
HEADER00  CALL      CURPER00
          CALL      CALCDT00
.
          MOVE      "Result Log Details",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,HEADER99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
HEADER99  RETURN
.------------------------------------------------------------
.         REDMAP00
.------------------------------------------------------------
REDMAP00  CALL      OPENHTML
          BRANCH    EXIT,REDMAP90
.
          MATCH     "1",PTCNUFFR
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#"> {":
                               "getTop().location.reload();":
                               "}":
                               "</script>"
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               "top.location.reload();":
                               "}":
                               "</script>"
          ENDIF
          CALL      CLOSHTML
          GOTO      REDMAP99
.
REDMAP90  DISPLAY   "*** Fifo Not Found ***"
.
REDMAP99  RETURN
.------------------------------------------------------------
. Error Results
.------------------------------------------------------------
ERRRES00  MATCH     SP70,LINKKEYF
          GOTO      ERRRES90 IF EQUAL
.
          MOVE      "Result Errors",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ERRRES99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      ERRRES99
.
ERRRES90  MOVE      "Invalid Link Key",WEBTITLE
          CALL      WEBERR00
.
ERRRES99  RETURN
.------------------------------------------------------------
. Process Templated Fields
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
. List Results by U/R No
.--------------------------
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000 
          GOTO      PROFLD99
.
PROFLD12  CALL      USUM0000 
          GOTO      PROFLD99
.
. List Results by Visit No
.--------------------------
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000 
          GOTO      PROFLD99
.
PROFLD22  CALL      VSUM0000 
          GOTO      PROFLD99
.
. List Results by Doctor by Date
.--------------------------------
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD31  CALL      DOCF0000 
          GOTO      PROFLD99
.
PROFLD32  CALL      DSUM0000 
          GOTO      PROFLD99
.
. List Results by Ward by Date
.--------------------------------
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD41  CALL      WRDF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      WSUM0000 
          GOTO      PROFLD99
.
.----------------------------------------------
.Result Log Details 
.----------------------------------------------
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD51  CALL      RLOG0000
          GOTO      PROFLD99
.
.----------------------------------------------------------
. List Result Errors
.----------------------------------------------------------
PROFLD60  CALL      ESUM0000 
          GOTO      PROFLD99
.
. List Results by Clinic ID by Date
.--------------------------------
PROFLD70  BRANCH    FLDSETNO,PROFLD71
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD71  CALL      CSUM0000 
          GOTO      PROFLD99
.
. List Results by EMR Site by Date
.--------------------------------
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PROFLD99
.
PROFLD81  CALL      EMST0000
          GOTO      PROFLD99
.
PROFLD82  CALL      SSUM0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-------------------------------------------------------------
.Result Log Details
.-------------------------------------------------------------
RLOG0000  BRANCH    FLDITMNO,RLOG0100,RLOG0200,RLOG0300,RLOG0400,RLOG0500:
                             RLOG0600,RLOG0700,RLOG0800,RLOG0900,RLOG1000:
                             RLOG1100,RLOG1200,RLOG1300,RLOG1400,RLOG1500:
                             RLOG1600
.
          GOTO      RLOG9999
.
RLOG0100  CALL      NEXT0000
          GOTO      RLOG9999
.
RLOG0200  CALL      PREV0000
          GOTO      RLOG9999
.
RLOG0300  CALL      CURSTD00
          GOTO      RLOG9999
.
RLOG0400  CALL      CUREND00
          GOTO      RLOG9999
.
RLOG0500  CALL      CURYR000
          GOTO      RLOG9999
.
RLOG0600  CALL      CURMON00
          GOTO      RLOG9999
.
RLOG0700  CALL      SELV0000
          GOTO      RLOG9999
.
RLOG0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      RLOG9999
.
RLOG0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      RLOG9999
.
RLOG1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      RLOG9999
.
RLOG1100  MOVE      ZERO,FORMATTY
          CALL      TORL0000
          GOTO      RLOG9999
.
RLOG1200  CALL      ERRL0000
          GOTO      RLOG9999
.
RLOG1300  CALL      LABLST00
          GOTO      RLOG9999
.
RLOG1400  WRITE     HTMLFILE;LABRCODE;
          GOTO      RLOG9999
.
RLOG1500  WRITE     HTMLFILE;"<option value=0>Show Errors Only</option>";
          IF        SHOWALLF=1
            WRITE     HTMLFILE;"<option value=1 selected>Show All</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=1>Show All</option>";
          ENDIF
          GOTO      RLOG9999
.
RLOG1600  MOVE      ONE,FORMATTY
          CALL      TORL0000
          GOTO      RLOG9999
.
RLOG9999  RETURN
.------------------------------------------------------------
. Lab selection
.------------------------------------------------------------
LABLST00  PACK      KEY3,SP70
          CALL      RSRELB1
LABLST10  CALL      RKRELB1
          BRANCH    OVRCD,LABLST99
.
          PACK      KEY5,QUOTE,RELBLCD,QUOTE
          MATCH     RELBLCD,LABRCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               RELBDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",RELBDES,"</option>"
          ENDIF
          GOTO      LABLST10
.
LABLST99  RETURN
.------------------------------------------------------------
. List Errors by Company by Date
.------------------------------------------------------------
ERRL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MATCH     SP70,LABRCODE
          GOTO      ERRL9999 IF EQUAL
.
          PACK      RESLNKFL,PRELEN,FRSTDATE          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA3,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      ERRL9999 IF EQUAL                 * end I CAR 38290
.
          PACK      KEY17,FRSTDATE,SP70
          CALL      RSREER1
ERRL1000  CALL      RKREER1
          BRANCH    OVRCD,ERRL9999
          MATCH     REERRDT,LASTDATE
          GOTO      ERRL9999  IF LESS
          MOVE      "99",LINKTYPE
          PACK      KEY29,REERRDT,REERRTM,REERRUN,LINKTYPE,SP70
          CALL      RSRELN3
          CALL      RKRELN3
          BRANCH    OVRCD,ERRL1000
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          MATCH     KEY17,KEY29
          GOTO      ERRL1000 IF NOT EQUAL
          MATCH     SP70,LABRCODE
          GOTO      ERRL1100 IF EQUAL
.
          MATCH     RELNLAB,LABRCODE
          GOTO      ERRL1000 IF NOT EQUAL
.
ERRL1100  CALL      ERRROW00
.
          GOTO      ERRL1000
.
ERRL9999  RETURN 
.----------------------------------------------
.Table of REsult Log Details
.----------------------------------------------
TORL0000  BRANCH    FORMATTY,TORL0100
          CALL      TABHED00
.
TORL0100  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY23,FRSTDATE,SP70
          CALL      RSRELG2
TORL1000  CALL      RKRELG2
          BRANCH    OVRCD,TORL9000
          MATCH     RELGDTE,LASTDATE
          GOTO      TORL9000  IF LESS
          MATCH     SP70,LABRCODE
          GOTO      TORL1010 IF EQUAL
          MATCH     RELGPCO,LABRCODE
          GOTO      TORL1000 IF NOT EQUAL
.       
TORL1010  PACK      LINKKEYF,RELGUID,SP70
          UNPACK    RELGDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      COLDAT01,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      RETYER01,CCENT,CYEAR    * I CAR 38290
          BRANCH    SHOWALLF,TORL1100
          COMPARE   ZERO,RELGERR
          GOTO      TORL1000 IF EQUAL
.
TORL1100  BRANCH    FORMATTY,TORL1200
          CALL      RLGTAB00                * output table row
          GOTO      TORL1000
.
TORL1200  CALL      RLGROW00                * output addRow table row
          GOTO      TORL1000
.
TORL9000
.
TORL9999  RETURN
.
.----------------------------------------------
.Table heading
.----------------------------------------------
TABHED00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center colspan=9>":
                             "<b>Results Error Log</b><br>":
                             "<b>";
          CALL      CURSTD00
          WRITE     HTMLFILE;" to ";
          CALL      CUREND00
          WRITE     HTMLFILE;"</b></td></tr>"
.
          WRITE     HTMLFILE;"<tr> ":
                             "<td class=HeadingCell>  &nbsp; </td>":
                             "<td class=HeadingCell>Date      </td>": 
                             "<td class=HeadingCell>Time</td>":
                             "<td class=HeadingCell>Company</td>":
                             "<td class=HeadingCell>File Name</td>":
                             "<td class=HeadingCell>Complete</td>":
                             "<td class=HeadingCell>Processed</td>":
                             "<td class=HeadingCell>Errors</td>":
                             "</tr>"
.
TABHED99  RETURN
.----------------------------------------------------------
.Result Log Table
.  RLGROW - as Table Sort Format
.  RLGTAB - as Table HTML Format
.----------------------------------------------------------
RLGROW00  REP       " +",LINKKEYF 
          MATCH     SP70,RELGMER
          IF        @EQUAL
            MOVE      SP70,KEY25
          ELSE
            MOVE      " - ",KEY3
            PACK      KEY25,KEY3,RELGMER
          ENDIF
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&linkkeyf=",LINKKEYF:
                             "&retyer01=",RETYER01,QUOTE,COMMA:
                             QUOTE,RELGDTE,RELGTME,QUOTE,COMMA:
                             QUOTE,RELGPCO,QUOTE,COMMA:
                             QUOTE,RELGINF,QUOTE,COMMA:
                             QUOTE,RELGCMP,QUOTE,COMMA:
                             QUOTE,RELGEXP,QUOTE,COMMA:
                             QUOTE,RELGRPR,QUOTE,COMMA:
                             QUOTE,RELGERR,QUOTE,COMMA:
                             QUOTE,KEY25,QUOTE,");"
          REP       "+ ",KEY17
          RETURN
.
RLGTAB00  REP       " +",LINKKEYF 
          MATCH     SP70,RELGMER
          IF        @EQUAL
            MOVE      SP70,KEY25
          ELSE
            MOVE      " - ",KEY3
            PACK      KEY25,KEY3,RELGMER
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&linkkeyf=",LINKKEYF:
                             "&retyer01=",RETYER01,">":      * I CAR 38290
                             "<img src=../images/cliweb08-001.gif ":
                             "align=absmiddle border=0 hspace=4></a>":
                             "<td nowrap align=center>",COLDAT01,"</td>": 
                             "<td nowrap align=center>",RELGTME,"</td>": 
                             "<td nowrap align=center>",RELGPCO,"</td>": 
                             "<td nowrap align=center>",RELGINF,"</td>": 
                             "<td nowrap align=center>",RELGCMP,"</td>": 
                             "<td nowrap align=center>",RELGRPR,"</td>": 
                             "<td nowrap align=center>",RELGERR,KEY25,"</td>":
                             "</tr>"
.
          REP       "+ ",LINKKEYF 
.
RLGTAB99  RETURN 
.------------------------------------------------------------
. List Results by U/R No
.------------------------------------------------------------
USUM0000  BRANCH    FLDITMNO,USUM0100,USUM0200,USUM0300,USUM0400,USUM0500:
                             USUM0600,USUM0700,USUM0800,USUM0900,USUM1000
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      USUM9999
.
USUM0100  CALL      PATNXT00
          GOTO      USUM9999
.
USUM0200  CALL      PATLST00
          GOTO      USUM9999 
.
USUM0300  MOVE      ZERO,DELTVIEW
          CALL      URTAA000 * Single Hospital UR Results
          GOTO      USUM9999
.
USUM0400  CALL      URCOL000 * PIT Results by UR by Collection Date
          GOTO      USUM9999
.
USUM0500  CALL      URTAB000 * Cross Hospitals UR Results
          GOTO      USUM9999
.
USUM0600  CALL      RSLKY000 * Results Year Selection List
          GOTO      USUM9999 * I CAR 38290
.
USUM0700  MOVE      ONE,SUPERVIS
          MOVE      ZERO,DELTVIEW
          CALL      URTAA000 * Single Hospital UR Results
          GOTO      USUM9999
.
USUM0800  MOVE      "dg",CATEGORY          * Get description
          COMPARE   ZERO,DIAGTYPC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"   #" selected>":
                              "All</option>"
            GOTO      USUM0810
          ENDIF
          COMPARE   ONE,DIAGTYPC
          IF        @EQUAL
            MATCH     SP70,DIAGTYPE[DIAGTYPC]
            IF        !@EQUAL
              WRITE     HTMLFILE;"<option value=#"   #">":
                                "All</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"   #" selected>":
                                "All</option>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<option value=#"   #">":
                              "All</option>"
          ENDIF
USUM0810  CALL      CODMUL00
          GOTO      USUM9999
.
USUM0900  CALL      URSUM000 * JSON Cross Hospitals UR Results
          GOTO      USUM9999
.
USUM1000  MOVE      ONE,DELTVIEW
          CALL      URTAA000 * Single Hospital UR Results
          GOTO      USUM9999
.
USUM9999  RETURN
.------------------------------------------------------------
. List Results by Visit/Admission No
.------------------------------------------------------------
VSUM0000  BRANCH    FLDITMNO,VSUM0100,VSUM0200,VSUM0300,VSUM0400
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      VSUM9999
.
VSUM0100  CALL      PATNXT00
          GOTO      VSUM9999
.
VSUM0200  CALL      PATLST00
          GOTO      VSUM9999 
.
VSUM0300  CALL      VITAB000
          GOTO      VSUM9999
.
VSUM0400  CALL      RSLKY000 * Results Year Selection List
          GOTO      USUM9999 * I CAR 38290
.
VSUM9999  RETURN
.------------------------------------------------------------
. Next Group for Patient
.------------------------------------------------------------
PATNXT00  BRANCH    FHIRTYPE,PATNXT50
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          IF        NORECORD=0
            MOVE      "50",NORECORD 
          ENDIF
          MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          REP       " +",URNUMBER
.
          MATCH     SP70,ADMISSNO
          IF        @EOS
            PACK      ADMISSNO,SP70
          ENDIF
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;LINKPRG,".pbl?reportno=",LINKREP:
                                 "&template=",LINKTEM:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&viewtype=1":            * I CAR 38290
                                 "&reslnkyr=",RESLNKYR;
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= DIAGTYPC
            MATCH     SP70,DIAGTYPE[COUNT]
            IF        !@EQUAL
              WRITE     HTMLFILE;"&diagtype=",DIAGTYPE[COUNT];
            ENDIF
            ADD       ONE,COUNT
          DO
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          GOTO      PATNXT99
.
PATNXT50  IF        DISNUMB=NORECORD
            IF        FHIRTYPE=0
              ASSIGN    STARTNUM+NORECORD,F6
              MOVE      F6,KEY6
              SQUEEZE   KEY6
              WRITE     HTMLFILE;*+,"nextpage=&startnum=",KEY6
            ENDIF
          ENDIF
.
PATNXT99  RETURN
.------------------------------------------------------------
. Last Group of Patient Results
.------------------------------------------------------------
PATLST00  BRANCH    FHIRTYPE,PATLST50
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          IF        NORECORD=0
            MOVE      "50",NORECORD 
          ENDIF
          MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          WRITE     HTMLFILE;LINKPRG,".pbl?reportno=",LINKREP:
                                 "&template=",LINKTEM:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&viewtype=1":            * I CAR 38290
                                 "&reslnkyr=",RESLNKYR;
          MOVE      ONE,COUNT
          WHILE     COUNT <= DIAGTYPC
            MATCH     SP70,DIAGTYPE[COUNT]
            IF        !@EQUAL
              WRITE     HTMLFILE;"&diagtype=",DIAGTYPE[COUNT];
            ENDIF
            ADD       ONE,COUNT
          DO
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          GOTO      PATLST99
.
PATLST50  ASSIGN    STARTNUM-NORECORD,F6
          IF        FHIRTYPE=0
            IF        F6>=0
              MOVE      F6,KEY6
              SQUEEZE   KEY6
              WRITE     HTMLFILE;*+,"prevpage=&startnum=",KEY6
            ENDIF
          ENDIF
.
PATLST99  RETURN
.
.------------------------------------------------------------
. List Results by Doctor by Date
.------------------------------------------------------------
DSUM0000  BRANCH    FLDITMNO,DSUM0100,DSUM0200,DSUM0300,DSUM0400:
                             DSUM0500,DSUM0600,DSUM0700,DSUM0800:
                             DSUM0900,DSUM1000,DSUM1100,DSUM1200:
                             DSUM1300,DSUM1400,DSUM1500,DSUM1600:
                             DSUM1700,DSUM1800
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      DSUM9999
.
DSUM0100  MOVE      DOCTCODE,KEY6
          REP       " +",KEY6
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          CALL      NEXT0000
          GOTO      DSUM9999
.
DSUM0200  MOVE      DOCTCODE,KEY6
          REP       " +",KEY6
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          CALL      PREV0000
          GOTO      DSUM9999
.
DSUM0300  CALL      CURSTD00
          GOTO      DSUM9999
.
DSUM0400  CALL      CUREND00
          GOTO      DSUM9999
.
DSUM0500  CALL      CURYR000
          GOTO      DSUM9999
.
DSUM0600  CALL      CURMON00
          GOTO      DSUM9999
.
DSUM0700  CALL      SELV0000
          GOTO      DSUM9999
.
DSUM0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      DSUM9999
.
DSUM0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      DSUM9999
.
DSUM1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      DSUM9999
.
DSUM1100  MOVE      "07",LINKTYPE
          PACK      LINKKEYF,DOCTCODE,SP70
          MATCH     SP70,DOCTTYPE
          IF        !@EQUAL
            MOVE      DOCTTYPE,LINKTYPE
          ENDIF
.
          MATCH     "05",LINKTYPE
          IF        @EQUAL
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      LINKKEYF,WBSEGPCD
            ENDIF
          ENDIF
.
          CALL      LNTAB000    * Link Table of Results
          GOTO      DSUM9999
.
DSUM1200  MOVE      "07",LINKTYPE
          PACK      LINKKEYF,DOCTCODE,SP70
          MATCH     SP70,DOCTTYPE
          IF        !@EQUAL
            MOVE      DOCTTYPE,LINKTYPE
          ENDIF
.
          CALL      TABMK000    * Link Table of Results
          GOTO      DSUM9999
.
DSUM1300  WRITE     HTMLFILE;DOCTTYPE;
          GOTO      DSUM9999
.
DSUM1400  MOVE      "07",LINKTYPE                * I CAR 38290
          PACK      LINKKEYF,DOCTCODE,SP70
          MATCH     SP70,DOCTTYPE
          IF        !@EQUAL
            MOVE      DOCTTYPE,LINKTYPE
          ENDIF
.
          CALL      TBMKA000                     * Link Table of Unread Results
          GOTO      DSUM9999                     * end I CAR 38290
.
DSUM1500  CALL      LABLST00
          GOTO      DSUM9999
.
DSUM1600  WRITE     HTMLFILE;LABRCODE;
          GOTO      DSUM9999
.
DSUM1700  WRITE     HTMLFILE;NORMALFL;
          GOTO      DSUM9999
.
DSUM1800  WRITE     HTMLFILE;FILTRDSS;
          GOTO      DSUM9999
.
DSUM9999  RETURN
.------------------------------------------------------------
. List Results by Clinic ID by Date
.------------------------------------------------------------
CSUM0000  BRANCH    FLDITMNO,CSUM0100,CSUM0200,CSUM0300,CSUM0400:
                             CSUM0500,CSUM0600,CSUM0700,CSUM0800:
                             CSUM0900,CSUM1000,CSUM1100,CSUM1200:
                             CSUM1300,CSUM1400,CSUM1500,CSUM1600:
                             CSUM1700,CSUM1800
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      CSUM9999
.
CSUM0100  MOVE      CLINICID,KEY6
          REP       " +",KEY6
          CALL      NEXT0000
          GOTO      CSUM9999
.
CSUM0200  MOVE      CLINICID,KEY6
          REP       " +",KEY6
          CALL      PREV0000
          GOTO      CSUM9999
.
CSUM0300  CALL      CURSTD00
          GOTO      CSUM9999
.
CSUM0400  CALL      CUREND00
          GOTO      CSUM9999
.
CSUM0500  CALL      CURYR000
          GOTO      CSUM9999
.
CSUM0600  CALL      CURMON00
          GOTO      CSUM9999
.
CSUM0700  CALL      SELV0000
          GOTO      CSUM9999
.
CSUM0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      CSUM9999
.
CSUM0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      CSUM9999
.
CSUM1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CSUM9999
.
CSUM1100  MOVE      "06",LINKTYPE
          PACK      LINKKEYF,CLINICID,SP70
          CALL      LNTAB000    * Link Table of Results
          GOTO      CSUM9999
.
CSUM1200  MOVE      "06",LINKTYPE
          PACK      LINKKEYF,CLINICID,SP70
          CALL      TABMK000    * Link Table of Results
          GOTO      CSUM9999
.
CSUM1300                        * Spare for Aligning Tags with DSUM,CSUM,SSUM and WSUM
          GOTO      CSUM9999
.
CSUM1400                        * Spare for Aligning Tags with DSUM,CSUM,SSUM and WSUM
          GOTO      CSUM9999
.
CSUM1500  CALL      LABLST00
          GOTO      CSUM9999
.
CSUM1600  WRITE     HTMLFILE;LABRCODE;
          GOTO      CSUM9999
.
CSUM1700  WRITE     HTMLFILE;NORMALFL;
          GOTO      CSUM9999
.
CSUM1800  CALL      DSSFLT00
          GOTO      CSUM9999
.
CSUM9999  RETURN
.
DSSFLT00  MOVE      "0074",KEY4
          MOVE      RELNDSS,HLCODES
          PACK      KEY14,KEY4,SP70,SP70
          CALL      RSHLCO1
DSSFLT10  CALL      RKHLCO1
          BRANCH    OVRCD,DSSFLT99
          MATCH     "0074",HLCOTID
          GOTO      DSSFLT99 IF NOT EQUAL
          MATCH     FILTRDSS,HLCOCOD
          IF        !@EQUAL
            WRITE     HTMLFILE;"<option value='",HLCOCOD,"'>",HLCODES,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",HLCOCOD,"' selected>",HLCODES,"</option>";
          ENDIF
          GOTO      DSSFLT10
DSSFLT99  RETURN
.------------------------------------------------------------
. List Results by Ward by Date
.------------------------------------------------------------
WSUM0000  BRANCH    FLDITMNO,WSUM0100,WSUM0200,WSUM0300,WSUM0400:
                             WSUM0500,WSUM0600,WSUM0700,WSUM0800:
                             WSUM0900,WSUM1000,WSUM1100,WSUM1200:
                             WSUM1300,WSUM1400,WSUM1500,WSUM1600:
                             WSUM1700,WSUM1800
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WSUM9999
.
WSUM0100  MOVE      WARDCODE,KEY3A
          REP       " +",KEY3A
          CALL      NEXT0000
          GOTO      WSUM9999
.
WSUM0200  MOVE      WARDCODE,KEY3A
          REP       " +",KEY3A
          CALL      PREV0000
          GOTO      WSUM9999
.
WSUM0300  CALL      CURSTD00
          GOTO      WSUM9999
.
WSUM0400  CALL      CUREND00
          GOTO      WSUM9999
.
WSUM0500  CALL      CURYR000
          GOTO      WSUM9999
.
WSUM0600  CALL      CURMON00
          GOTO      WSUM9999
.
WSUM0700  CALL      SELV0000
          GOTO      WSUM9999
.
WSUM0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      WSUM9999
.
WSUM0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      WSUM9999
.
WSUM1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      WSUM9999
.
WSUM1100  MOVE      "04",LINKTYPE
          PACK      LINKKEYF,WARDCODE,SP70
          CALL      LNTAB000    * Link Table of Results
          GOTO      WSUM9999
.
WSUM1200  MOVE      "04",LINKTYPE
          PACK      LINKKEYF,WARDCODE,SP70
          CALL      TABMK000    * Link Table of Results
          GOTO      WSUM9999
.
WSUM1300  CALL      WSEL0000
          GOTO      WSUM9999
.
WSUM1400                        * Spare for Aligning Tags with DSUM,CSUM,SSUM and WSUM
          GOTO      WSUM9999
.
WSUM1500  CALL      LABLST00
          GOTO      WSUM9999
.
WSUM1600  WRITE     HTMLFILE;LABRCODE;
          GOTO      WSUM9999
.
WSUM1700  WRITE     HTMLFILE;NORMALFL;
          GOTO      WSUM9999
.
WSUM1800  CALL      DSSFLT00
          GOTO      WSUM9999
.
WSUM9999  RETURN
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     WARDCODE,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
EMST0000  RETURN
.------------------------------------------------------------
. List Results by EMR Site by Date
.------------------------------------------------------------
SSUM0000  BRANCH    FLDITMNO,SSUM0100,SSUM0200,SSUM0300,SSUM0400:
                             SSUM0500,SSUM0600,SSUM0700,SSUM0800:
                             SSUM0900,SSUM1000,SSUM1100,SSUM1200:
                             SSUM1300,SSUM1400,SSUM1500,SSUM1600:
                             SSUM1700,SSUM1800
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      SSUM9999
.
SSUM0100  MOVE      ESITCODE,KEY3B
          REP       " +",KEY3B
          CALL      NEXT0000
          GOTO      SSUM9999
.
SSUM0200  MOVE      ESITCODE,KEY3B
          REP       " +",KEY3B
          CALL      PREV0000
          GOTO      SSUM9999
.
SSUM0300  CALL      CURSTD00
          GOTO      SSUM9999
.
SSUM0400  CALL      CUREND00
          GOTO      SSUM9999
.
SSUM0500  CALL      CURYR000
          GOTO      SSUM9999
.
SSUM0600  CALL      CURMON00
          GOTO      SSUM9999
.
SSUM0700  CALL      SELV0000
          GOTO      SSUM9999
.
SSUM0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      SSUM9999
.
SSUM0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      SSUM9999
.
SSUM1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      SSUM9999
.
SSUM1100  MOVE      "09",LINKTYPE
          PACK      LINKKEYF,ESITCODE,SP70
          CALL      LNTAB000    * Link Table of Results
          GOTO      SSUM9999
.
SSUM1200  MOVE      "09",LINKTYPE
          PACK      LINKKEYF,ESITCODE,SP70
          CALL      TABMK000    * Link Table of Results
          GOTO      SSUM9999
.
SSUM1300  CALL      SSEL0000
          GOTO      SSUM9999
.
SSUM1400                        * Spare for Aligning Tags with DSUM,CSUM,SSUM and WSUM
          GOTO      SSUM9999
.
SSUM1500  CALL      LABLST00
          GOTO      SSUM9999
.
SSUM1600  WRITE     HTMLFILE;LABRCODE;
          GOTO      SSUM9999
.
SSUM1700  WRITE     HTMLFILE;NORMALFL;
          GOTO      SSUM9999
.
SSUM1800  CALL      DSSFLT00
          GOTO      SSUM9999
.
SSUM9999  RETURN
.------------------------------------------------------------
. Site selection
.------------------------------------------------------------
SSEL0000  PACK      KEY3,SP70
          CALL      RSEMSIT1
SSEL0100  CALL      RKEMSIT1
          BRANCH    OVRCD,SSEL9000
.
          PACK      KEY5,QUOTE,EMSTSCOD,QUOTE
          MATCH     EMSTSCOD,ESITCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               EMSTDESC,"   </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",EMSTDESC:
                               "</option>"
          ENDIF
          GOTO      SSEL0100
.
SSEL9000  PACK      KEY3,ESITCODE,SP70
          CALL      RDEMSIT1
          IF        OVRCD=1
            CALL      CLREMR00
          ENDIF
.
SSEL9999  RETURN
.------------------------------------------------------------
. Date and Time Conversion
.------------------------------------------------------------
DATE0000  UNPACK    RELNRTM,DIM1,DIM4
          MATCH     "0",DIM1
          IF        @EQUAL
            REP       "0 ",DIM1
          ENDIF
          PACK      DIM5,DIM1,DIM4
          UNPACK    DIM5,DIM2,DIM3
          MOVE      DIM2,F2
          IF        F2<12
            MOVE      " am",DAYTIME
          ELSE
            MOVE      " pm",DAYTIME
            IF        F2<>12
              SUB       TEN2,F2
            ENDIF
          ENDIF
          MOVE      F2,DIM2
          PACK      DIM5,DIM2,DIM3
          MOVE      " at ",DIM4
.
          UNPACK    RELNRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      DATETIME,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,DIM4,DIM5,DAYTIME
.
DATE9999  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",LABRCODE
          REP       " +",NORMALFL
          REP       " +",FILTRDSS
.
          WRITE     HTMLFILE;"cliweb03.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&labrcode=",LABRCODE:
                                 "&normalfl=",NORMALFL:
                                 "&filtrdss=",FILTRDSS;
          REP       "+ ",LABRCODE
          REP       "+ ",NORMALFL
          REP       "+ ",FILTRDSS
.
          IF        REPORTNO=3
            WRITE     HTMLFILE;"&doctcode=",KEY6:
                               "&docttype=",DOCTTYPE;
          ENDIF
.
          IF        REPORTNO=4
            WRITE     HTMLFILE;"&wardcode=",KEY3A;
          ENDIF
.
          IF        REPORTNO=5
            WRITE     HTMLFILE;"&showallf=",SHOWALLF;
          ENDIF
.
          IF        REPORTNO=7
            WRITE     HTMLFILE;"&clinicid=",KEY6;
          ENDIF
.
          IF        REPORTNO=8
            WRITE     HTMLFILE;"&esitcode=",KEY3B;
          ENDIF
.
          WRITE     HTMLFILE;"&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE;
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",LABRCODE
          REP       " +",NORMALFL
          REP       " +",FILTRDSS
.
          WRITE     HTMLFILE;"cliweb03.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&labrcode=",LABRCODE:
                                 "&normalfl=",NORMALFL:
                                 "&filtrdss=",FILTRDSS;
          REP       "+ ",LABRCODE
          REP       "+ ",NORMALFL
          REP       "+ ",FILTRDSS
.
          IF        REPORTNO=3
            WRITE     HTMLFILE;"&doctcode=",KEY6:
                               "&docttype=",DOCTTYPE;
          ENDIF
.
          IF        REPORTNO=4                                                 
            WRITE     HTMLFILE;"&wardcode=",KEY3A;                           
          ENDIF                                             
.
          IF        REPORTNO=5
            WRITE     HTMLFILE;"&showallf=",SHOWALLF;
          ENDIF
.
          IF        REPORTNO=7
            WRITE     HTMLFILE;"&clinicid=",KEY6;
          ENDIF
.
          IF        REPORTNO=8
            WRITE     HTMLFILE;"&esitcode=",KEY3B;
          ENDIF
.
          IF        REPORTNO=5
            WRITE     HTMLFILE;"&teamcode=",KEY3A;
          ENDIF
.
          WRITE     HTMLFILE;"&frstdate=",PREFDATE:                             
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE;
.                                                           
PREV9999  RETURN
.------------------------------------------------------------
. Table Results by U/R No
.------------------------------------------------------------
URTAA000  MOVE      ZERO,LASTROW
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        FHIRTYPE=0
            IF        NORECORD=0
              MOVE      "50",NORECORD 
            ENDIF
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MATCH     "1",VIEWTYPE
          IF        !@EQUAL
            MOVE      PTCNYRDF,FORM1
            BRANCH    FORM1,URTAA041,URTAA042
          ENDIF
          GOTO      URTAA044
.
URTAA040  MOVE      "cmno",RESLNKYR
          GOTO      URTAA050

URTAA041  MOVE      "ally",RESLNKYR
          GOTO      URTAA050
.
URTAA042  CALL      IBACLOCK
          PACK      RESLNKYR,CCC,CYY
          PACK      RESLNKFL,PRELEN,CCC,CYY
          REP       " 0",RESLNKFL
          PACK      DIM4,CCC,CYY
          REP       " 0",DIM4
          MOVE      DIM4,FORM4
          SUB       ONE,FORM4
          MOVE      DIM4,FORM4A
.
          GOTO      URTAA051
.
                                              * I CAR 38290
URTAA043  MATCH     SP70,RESLNKYR
          IF        @EQUAL|@EOS
            MOVE      "cmno",RESLNKYR
          ENDIF
.
URTAA044  MATCH     "ally",RESLNKYR      * all years
          GOTO      URTAA050 IF EQUAL
.
          MATCH     "cmno",RESLNKYR
          GOTO      URTAA050 IF EQUAL
.
          PACK      RESLNKFL,PRELEN,RESLNKYR
          GOTO      URTAA051
.
URTAA050  CALL      IBACLOCK
          PACK      RESLNKFL,PRELEN,CCC,CYY
          REP       " 0",RESLNKFL
.
          PACK      DIM4,CCC,CYY
          REP       " 0",DIM4
          MOVE      DIM4,FORM4
.
          MATCH     "ally",RESLNKYR
          IF        @EQUAL
.                                               * sorts from latest
            IF        SORTRSLT=0       
              ADD       ONE,FORM4               * sets first year
              PACK      RESLNKFL,PRELEN,FORM4   * sets table year
              MOVE      FORM4,FORM4A
              MOVE      PTCNRSYR,FORM4B         * sets last year
.                                               * Sorts from earliest 
            ELSE                                
              MOVE      FORM4,FORM4B            * Sets final year
              ADD       ONE,FORM4B
              MOVE      PTCNRSYR,FORM4          
              PACK      RESLNKFL,PRELEN,FORM4   * sets table year
              MOVE      FORM4,FORM4A            * sets first year
            ENDIF
          ELSE
            SUB       ONE,FORM4
            MOVE      DIM4,FORM4A
          ENDIF
.
URTAA051  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      URTAA900 IF EQUAL
.                                              * end I CAR 38290
          MOVE      "01",LINKTYPE
.                                              * sets positioning based on sort
          IF        SORTRSLT=0                 
            PACK      KEY29,LINKTYPE,URNUMBER,SP2,Z70
          ELSE
            PACK      KEY29,LINKTYPE,URNUMBER,SP70
          ENDIF
.
          CALL      RSRELN1
.                                             * Moves through db based on sort 
URTAA100  IF        SORTRSLT=0                
            CALL      RPRELN1
          ELSE
            CALL      RKRELN1
          ENDIF
          BRANCH    OVRCD,URTAA900
          MATCH     LINKTYPE,RELNLTY
          GOTO      URTAA900 IF NOT EQUAL
          MATCH     URNUMBER,RELNLKY
          GOTO      URTAA900 IF NOT EQUAL
          MATCH     SP70,FRSTDATE
          IF        !@EQUAL
            MATCH     FRSTDATE,RELNRDT
            IF        @LESS
              GOTO      URTAA100
            ENDIF
          ENDIF
          MATCH     SP70,LASTDATE
          IF        !@EQUAL
            MATCH     RELNRDT,LASTDATE
            IF        @LESS
              GOTO      URTAA100
            ENDIF
          ENDIF
.
          MATCH     "ZZ",RELNRST        * Internal ZZ Code used to flag orders have results
          GOTO      URTAA100 IF EQUAL
          MATCH     "X ",RELNRST        * Dont Show Cancelled Orders
          GOTO      URTAA100 IF EQUAL
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              MATCH     "ZZ",RELNDSS             * DiagnosticReport Dont show orders
              GOTO      URTAA100 IF EQUAL
            ELSE
              MATCH     "ZZ",RELNDSS             * ProcedureRequest Only Show Orders
              GOTO      URTAA100 IF NOT  EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH     RELNDSS,FILTRDSS
            GOTO      URTAA100 IF NOT EQUAL
          ENDIF
.
          IF        DELTVIEW=1
            MATCH     "01",RELNLTY
            IF        @EQUAL
              MATCH     "D ",RELNRST
              GOTO      URTAA100 IF NOT EQUAL
            ENDIF
          ELSE
            MATCH     "D ",RELNRST
            GOTO      URTAA100 IF EQUAL
          ENDIF
.
          CALL      PATROW00   * Output Table Row
.
          IF        EXIT=0
            ADD       ONE,DISNUMB
          ENDIF
          COMPARE   NORECORD,DISNUMB
          GOTO      URTAA100 IF NOT EQUAL
          GOTO      URTAA980
.
URTAA900  MATCH     SP70,RESLNKYR
          GOTO      URTAA950 IF EQUAL
          GOTO      URTAA950 IF EOS
          MATCH     "cmno",RESLNKYR
          GOTO      URTAA950 IF EQUAL
          MATCH     "ally",RESLNKYR
          GOTO      URTAA950 IF EQUAL
          GOTO      URTAA999
.
URTAA950  COMPARE   FORM4A,FORM4B
          GOTO      URTAA999 IF EQUAL
.
          MATCH     "cmno",RESLNKYR
          IF        @EQUAL
            COMPARE   FORM4,FORM4A
            GOTO      URTAA999 IF EQUAL
          ENDIF
.                                      * Moves to next year based on sort
          IF        SORTRSLT=0             
            SUB       ONE,FORM4A
          ELSE
            ADD       ONE,FORM4A
          ENDIF
          MOVE      FORM4A,DIM4
          PACK      RESLNKFL,PRELEN,DIM4
          GOTO      URTAA051
.          
URTAA980  MOVE      ONE,LASTROW
          GOTO      URTAA999
.
URTAA999  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"lastrow=",LASTROW;
          ENDIF
          RETURN
.------------------------------------------------------------
. Table Results by U/R No
.------------------------------------------------------------
URTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        NORECORD=0
            MOVE      "50",NORECORD 
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY25,URNUMBER,Z70
          CALL      RSRELU1
URTAB100  CALL      RPRELU1
          BRANCH    OVRCD,URTAB999
          MATCH     URNUMBER,RELUURN
          GOTO      URTAB999 IF NOT EQUAL
.
          IF        DELTVIEW=1
            MATCH     "D ",RELURST
            GOTO      URTAB100 IF NOT EQUAL
          ENDIF
.
          MATCH     "ZZ",RELURST        * Internal ZZ Code used to flag orders have results
          GOTO      URTAB100 IF EQUAL
          MATCH     "X ",RELURST        * Dont show Cancelled Orders
          GOTO      URTAB100 IF EQUAL
          MATCH     "D ",RELURST
          GOTO      URTAB100 IF EQUAL
.
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH     RELUDSS,FILTRDSS
            GOTO      URTAA100 IF NOT EQUAL
          ENDIF
.
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      URTAB100
          ENDIF
.
          CALL      MURROW00   * Output Table Row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      URTAB100 IF NOT EQUAL
.          
URTAB999  RETURN
.
MURROW00  MOVE      "OBR04",KEY5
          MOVE      RELUUSC,RECTDES
          PACK      KEY32,RELULAB,KEY5,RELUUCS,RELUUSC
          CALL      RDRECT1
          MOVE      "0123",KEY4
          MOVE      RELURST,HLCODES
          PACK      KEY14,KEY4,RELURST,SP70
          CALL      RDHLCO1
.
          PACK      KEY17,RELURDT,RELURTM,RELURUN,SP70
          REP       " +",KEY17
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",KEY17,QUOTE,COMMA:
                             QUOTE,RELURDT,RELURTM,QUOTE,COMMA:
                             QUOTE,RECTDES,QUOTE,COMMA:
                             QUOTE,RELUNOR,QUOTE,COMMA:
                             QUOTE,HLCODES,QUOTE,COMMA:
                             QUOTE,RELUDSS,QUOTE,COMMA:
                             QUOTE,RELUUSC,QUOTE,COMMA:
                             QUOTE,RELUMSN,QUOTE,COMMA:
                             QUOTE,RELURTY,QUOTE,");"
          REP       "+ ",KEY17
          RETURN
.------------------------------------------------------------
. Results Year Selection List                   * I CAR 38290
.------------------------------------------------------------
RSLKY000  MOVE      ZERO,FORM4
          MATCH     "1",VIEWTYPE
          IF        !@EQUAL
            MOVE    PTCNYRDF,FORM1
            ADD     ONE,FORM1
            PACK    CURRYEAR,CCC,CYY
            REP     " 0",CURRYEAR
.
            LOAD    RESLNKYR,FORM1,VAR1:          * past year/current year
                                   VAR2:          * all year
                                   CURRYEAR       * current year
          ENDIF

.
          WRITE     HTMLFILE;"<select name=reslnkyr":
                             " onchange='this.form.submit()'>";
.
.         MATCH     SP70,RESLNKYR
.         GOTO      RSLKY500 IF NOT EQUAL
.         GOTO      RSLKY500 IF NOT EOS
.         PACK      RESLNKYR,CCC,CYY
.         REP       " 0",RESLNKYR
.
RSLKY500  MOVE      PTCNRSYR,FORM4A
          MOVE      RESLNKYR,FORM4
          PACK      CURRYEAR,CCC,CYY
          REP       " 0",CURRYEAR
          MOVE      CURRYEAR,RESLNKCT
.*******************************************************************
          COMPARE   FORM4A,RESLNKCT
          GOTO      RSLKY600 IF EQUAL
.
          MATCH     SP70,RESLNKYR
          GOTO      RSLKY510 IF NOT EQUAL
          SUB       ONE,RESLNKCT
          WRITE     HTMLFILE;"<option value=","cmno"," selected>":
                             CURRYEAR,"/",RESLNKCT,"</option>";
          ADD       ONE,RESLNKCT
          GOTO      RSLKY530
.
RSLKY510  MATCH     "cmno",RESLNKYR
          GOTO      RSLKY520 IF NOT EQUAL
.
          SUB       ONE,RESLNKCT
          WRITE     HTMLFILE;"<option value=","cmno"," selected>":
                             CURRYEAR,"/",RESLNKCT,"</option>";
          ADD       ONE,RESLNKCT
          GOTO      RSLKY530
.
RSLKY520  SUB       ONE,RESLNKCT
          WRITE     HTMLFILE;"<option value=","cmno",">":
                             CURRYEAR,"/",RESLNKCT,"</option>";
          ADD       ONE,RESLNKCT
.
RSLKY530  MATCH     "ally",RESLNKYR
          GOTO      RSLKY550 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=","ally"," selected>":
                             "All Years</option>";
          COMPARE   "12",CMM
          IF        @EQUAL
            GOTO      RSLKY560 
          ELSE
            GOTO      RSLKY600
          ENDIF 
.
RSLKY550  WRITE     HTMLFILE;"<option value=","ally",">":
                             "All Years</option>";
          COMPARE   "12",CMM
          IF        @EQUAL
            GOTO      RSLKY560 
          ELSE
            GOTO      RSLKY600
          ENDIF
.
RSLKY560  ADD       ONE,RESLNKCT
          COMPARE   FORM4,RESLNKCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",RESLNKCT," selected>":
                               RESLNKCT,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",RESLNKCT,">":
                               RESLNKCT,"</option>";
          ENDIF
          SUB       ONE,RESLNKCT
          GOTO      RSLKY600
.
.*******************************************************************
RSLKY600  COMPARE   FORM4,RESLNKCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",RESLNKCT," selected>":
                               RESLNKCT,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",RESLNKCT,">":
                               RESLNKCT,"</option>";
          ENDIF
.
          COMPARE   FORM4A,RESLNKCT
          GOTO      RSLKY900 IF EQUAL 
.
          SUB       ONE,RESLNKCT
          GOTO      RSLKY600
.
RSLKY900  WRITE     HTMLFILE;"</select>"
RSLKY999  RETURN
.------------------------------------------------------------
. Table Results by Visit Number
.------------------------------------------------------------
VITAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        NORECORD=0
            MOVE      "50",NORECORD 
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.                                              * I CAR 38290
          MATCH     SP70,RESLNKYR
          GOTO      VITAB050 IF EQUAL
          GOTO      VITAB050 IF EOS
.
          PACK      RESLNKFL,PRELEN,RESLNKYR
          GOTO      VITAB051
.
VITAB050  CALL      IBACLOCK
          PACK      RESLNKFL,PRELEN,CCC,CYY
          REP       " 0",RESLNKFL
VITAB051  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      VITAB999 IF EQUAL
.                                              * end I CAR 38290
          MOVE      "02",LINKTYPE
          PACK      KEY29,LINKTYPE,ADMISSNO,SP2,Z70
          CALL      RSRELN1
VITAB100  CALL      RPRELN1
          BRANCH    OVRCD,VITAB999
          MATCH     LINKTYPE,RELNLTY
          GOTO      VITAB999 IF NOT EQUAL
          MATCH     URNUMBER,RELNLKY
          GOTO      VITAB999 IF NOT EQUAL
.
          MATCH     "ZZ",RELNRST        * Internal ZZ Code used to flag orders have results
          GOTO      VITAB100 IF EQUAL
          MATCH     "X ",RELNRST        * Dont show cancelled orders
          GOTO      VITAB100 IF EQUAL
          MATCH     "D ",RELNRST
          GOTO      VITAB100 IF EQUAL
.
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              MATCH     "ZZ",RELNDSS             * DiagnosticReport Dont show orders
              GOTO      VITAB100 IF EQUAL
            ELSE
              MATCH     "ZZ",RELNDSS             * ProcedureRequest Only Show Orders
              GOTO      VITAB100 IF NOT  EQUAL
            ENDIF
          ENDIF

.
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      VITAB100
          ENDIF
.
          CALL      PATROW00   * Output Table Row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      VITAB100 IF NOT EQUAL
.          
VITAB999  RETURN
.------------------------------------------------------------
. Output UR Table Row
.------------------------------------------------------------
PATROW00  CLEAR     HTMLLINK 
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl",HTMLLINK
          APPEND    "?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&resultky=",HTMLLINK
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          APPEND    KEY17,HTMLLINK
          RESET     HTMLLINK 
.
          IF        SUPERVIS=1
            CLEAR     HTMLLINK
            APPEND    "javascript:deleteResult(#'",HTMLLINK
            PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
            APPEND    KEY17,HTMLLINK
            APPEND    "#')",HTMLLINK
            RESET     HTMLLINK
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      RELNRTY,F1
          BRANCH    F1,PATROW10,PATROW20
.
          CALL      HL7ROW00   * HL7 Format
          BRANCH    EXIT,PATROW99
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            MOVE      ONE,EXIT
            GOTO      PATROW99
          ENDIF
.
          GOTO      PATROW80
.
PATROW10  CALL      URPIT000   * PIT
          GOTO      PATROW80
.
PATROW20  CALL      DOCROW00    * Document
          BRANCH    EXIT,PATROW99
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            MOVE      ONE,EXIT
            GOTO      PATROW99
          ENDIF
.
          GOTO      PATROW80
.       
PATROW80  MOVE      HLCODES,KEY12
          MOVELPTR  HTMLLINK,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      HTMLLINK,OUTVAR
.
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              CALL      FHRDIR00
            ELSE
              CALL      FHRPRQ00
            ENDIF
            GOTO      PATROW90
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(",QUOTE,OUTVAR,QUOTE,COMMA:   * 0
                             QUOTE,RELNRDT,RELNRTM,QUOTE,COMMA:      * 1
                             QUOTE,TESTLINE,QUOTE,COMMA:             * 2
                             QUOTE,RELNNOR,QUOTE,COMMA:              * 3
                             QUOTE,REPHTCT,QUOTE,COMMA:              * 4
                             QUOTE,KEY12,QUOTE,COMMA:                * 5
                             QUOTE,RELNDSS,QUOTE,COMMA:              * 6
                             QUOTE,RELNUSC,QUOTE,COMMA;              * 7
          MOVE      ZERO,RELNMSN
          MOVE      "01",RELNLTY
          MOVE      RELNPID,RELNLKY
          PACK      KEY29,RELNLTY,RELNLKY,RELNRDT,RELNRTM,RELNRUN,SP70
          CALL      RDRELN1
          MATCH     SP70,RELNLAB
          IF        @EQUAL
            MOVE    SP70,SPRLDDES
          ELSE 
            RESET   KEY3
            PACK    KEY3,RELNLAB
            CALL    RDRELB1
            IF      OVRCD=0
              MOVE    RELBDES,SPRLDDES
            ENDIF
          ENDIF
          WRITE     HTMLFILE;QUOTE,RELNMSN,QUOTE,COMMA:              * 8
                             QUOTE,RELNRTY,QUOTE,COMMA:              * 9
                             QUOTE,SPRLDDES,QUOTE,COMMA:             * 10
                             QUOTE,DIAGTDES,QUOTE;                   * 11

          IF        DELTVIEW=1
            CLEAR     TDESC
            PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70
            CALL      RDREHA1
            PACK      KEY5,CATRd,REHARDE
            CALL      RDCODE1
            WRITE     HTMLFILE;COMMA,QUOTE,TDESC,QUOTE;              * 12
          ELSE
            WRITE     HTMLFILE;
          ENDIF
.
          WRITE     HTMLFILE;COMMA,QUOTE,LINETHRU,QUOTE,");"         * 13
.
PATROW90  REP       "+ ",KEY17
          SFORMAT   OUTVAR,127
PATROW99  RETURN
.------------------------------------------------------------
. PIT UR table row
.------------------------------------------------------------
URPIT000  PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          CALL      RDREPH1
          IF        OVRCD=1
            MOVE      "Invalid Result Record",REPHNAM
          ENDIF
          PACK      TESTLINE,REPHNAM
          MATCH     SP70,REPHSTK
          IF        !@EQUAL
            CALL      GETLIN00
          ENDIF
URPIT999  RETURN
.----------------------------------------------------------------------
.----------------------------------------------------------------------
GETLIN00  MOVE      REPHSTK,KEY20
          CALL      RDREPD1
          BRANCH    OVRCD,GETLIN99
          PACK      REPDTXT,REPDTXT,SP70
          SCAN      "~",REPDTXT
          IF        @EQUAL
            CALL      DECODE00
          ELSE
            MOVE      REPDTXT,TESTLINE
          ENDIF
GETLIN99  RETURN
.----------------------------------------------------------------------
. Table Results by Link by Date 
.       Req.  LINKTYPE  03 - Doctor, 04 - Ward, 99 - Error
.             LINKKEYF  Code for Link ie Doctor,Ward
.----------------------------------------------------------------------
LNTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,ROWCOUNT
.
          UNPACK    FRSTDATE,CCENT,CYEAR                 * I CAR 38290
          PACK      RESLNKFL,PRELEN,CCENT,CYEAR
LNTAB060  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      LNTAB900 IF EQUAL                    * end I CAR 38290
.
          MATCH     SP70,STARTKEY
          IF        @EQUAL
            PACK      KEY29,LINKTYPE,LINKKEYF,LASTDATE,Z70
          ELSE
            PACK      KEY29,STARTKEY
          ENDIF
          CALL      RSRELN1
LNTAB100  CALL      RPRELN1
          BRANCH    OVRCD,LNTAB900
          MATCH     LINKTYPE,RELNLTY
          GOTO      LNTAB900 IF NOT EQUAL
          MATCH     LINKKEYF,RELNLKY
          GOTO      LNTAB900 IF NOT EQUAL
          MATCH     FRSTDATE,RELNRDT
          GOTO      LNTAB900 IF LESS 
.
          MATCH     "ZZ",RELNRST        * Internal ZZ Code used to flag orders have results
          GOTO      LNTAB100 IF EQUAL
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              MATCH     "ZZ",RELNDSS             * DiagnosticReport Dont show orders
              GOTO      LNTAB100 IF EQUAL
            ELSE
              MATCH     "ZZ",RELNDSS             * ProcedureRequest Only Show Orders
              GOTO      LNTAB100 IF NOT  EQUAL
            ENDIF
          ENDIF
.
          MATCH     "D ",RELNRST        * Deleted ?
          GOTO      LNTAB100 IF EQUAL
.
          MATCH     SP70,LABRCODE
          IF        !@EQUAL
            MATCH     RELNLAB,LABRCODE
            GOTO      LNTAB100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH     RELNDSS,FILTRDSS
            GOTO      LNTAB100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,NORMALFL
          IF        !@EQUAL
            MATCH     RELNNOR,NORMALFL
            GOTO      LNTAB100 IF NOT EQUAL
          ENDIF
.
          COMPARE   THREE,REPORTNO              * Final only for doctor lists
          GOTO      LNTAB200 IF NOT EQUAL
.
...       MATCH     ANSF,RELNRST                * Final result
...       GOTO      LNTAB200 IF EQUAL
.
...       MATCH     ANSC,RELNRST                * Corrected result
...       GOTO      LNTAB100 IF NOT EQUAL
.
LNTAB200  CALL      TABROW00
          IF        ROWCOUNT<100
            GOTO      LNTAB100
          ENDIF
.
          WRITE     HTMLFILE;"MoreResults=true;"
          PACK      KEY29,RELNLTY,RELNLKY,RELNRDT,RELNRTM,RELNRUN,SP70
          WRITE     HTMLFILE;"MoreStartKey=#"",KEY29,"#";"
          GOTO      LNTAB999
.
LNTAB900  MATCH     "1",VIEWTYPE                * Over End of Year on Week View?
          IF        @EQUAL
            MOVE      FRSTDATE,KEY4
            PACK      KEY8,PRELEN,KEY4
            MATCH     KEY8,RESLNKFL
            IF        !@EQUAL
              MOVE      KEY8,RESLNKFL
              GOTO      LNTAB060
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"MoreResults=false;"
          WRITE     HTMLFILE;"MoreStartKey=#"#";"
.                                                           
LNTAB999  RETURN
.----------------------------------------------------------------------
. Table Results by Link for Unread Results
.       Req.  LINKTYPE  03 - Doctor, 04 - Ward, 99 - Error
.             LINKKEYF  Code for Link ie Doctor,Ward
.----------------------------------------------------------------------
TABMK000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY         * I CAR 38290
          MATCH     "0",VIEWTYPE
          IF        @EQUAL
            MOVE      "1",ADJDAYS
          ELSE
            MATCH     "1",VIEWTYPE
            IF        @EQUAL  
              MOVE      "7",ADJDAYS
            ELSE
              MATCH     "2",VIEWTYPE
              IF        @EQUAL
                UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                ADD       ONE,F2
                PACK      KEY4,CCENT,CYEAR
                REP       " 0",KEY4
                IF        F2>12
                  MOVE      "01",F2
                  MOVE      KEY4,F4
                  ADD       ONE,F4
                  MOVE      F4,KEY4
                ENDIF
                PACK      DIM8,KEY4,F2,ZERO,ONE
                REP       " 0",DIM8                  
                GOTO      TABMK050
              ENDIF
            ENDIF
          ENDIF
          CALL      ADJDAT00
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
TABMK050  UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,ROWCOUNT
          PACK      RESLNKFL,PRELEN,CCENT,CYEAR
.
TABMK060  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA2,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      TABMK900 IF EQUAL                    * end I CAR 38290
.
          MATCH     SP70,STARTKEY
          IF        @EQUAL
            PACK      KEY30,LINKTYPE,LINKKEYF,ZERO,FRSTDATE,SP70
          ELSE
            PACK      KEY30,STARTKEY
          ENDIF
          CALL      RSRELN2
TABMK100  CALL      RKRELN2
          BRANCH    OVRCD,TABMK900
          MATCH     LINKTYPE,RELNLTY
          GOTO      TABMK900 IF NOT EQUAL
          MATCH     LINKKEYF,RELNLKY
          GOTO      TABMK900 IF NOT EQUAL
          MATCH     "0",RELNMSN
          GOTO      TABMK900 IF NOT EQUAL 
.
          MATCH     FRSTDATE,RELNRDT            * I CAR 38290
          GOTO      TABMK100 IF LESS
          MATCH     DIM8,RELNRDT
          GOTO      TABMK900 IF NOT LESS
.
          MATCH     "ZZ",RELNRST        * Internal ZZ Code used to flag orders have results
          GOTO      TABMK100 IF EQUAL
          MATCH     "X ",RELNRST        * Dont show Cancelled 
          GOTO      TABMK100 IF EQUAL
          MATCH     "D ",RELNRST
          GOTO      TABMK100 IF EQUAL
.
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              MATCH     "ZZ",RELNDSS             * DiagnosticReport Dont show orders
              GOTO      TABMK100 IF EQUAL
            ELSE
              MATCH     "ZZ",RELNDSS             * ProcedureRequest Only Show Orders
              GOTO      TABMK100 IF NOT  EQUAL
            ENDIF
          ENDIF
.
.
          MATCH     SP70,LABRCODE
          IF        !@EQUAL
            MATCH     RELNLAB,LABRCODE
            GOTO      TABMK100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH     RELNDSS,FILTRDSS
            GOTO      TABMK100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,NORMALFL
          IF        !@EQUAL
            MATCH     RELNNOR,NORMALFL
            GOTO      TABMK100 IF NOT EQUAL
          ENDIF
.                                               * end I CAR 38290
          COMPARE   THREE,REPORTNO              * Final only for doctor lists
          GOTO      TABMK200 IF NOT EQUAL
.
          MATCH     ANSF,RELNRST                * Final result
          GOTO      TABMK200 IF EQUAL
.
          MATCH     ANSC,RELNRST                * Corrected result
          GOTO      TABMK100 IF NOT EQUAL
.
TABMK200  CALL      TABROW00
          IF        ROWCOUNT<20
            GOTO      TABMK100
          ENDIF
.
          WRITE     HTMLFILE;"MoreResults=true;"
          PACK      KEY30,RELNLTY,RELNLKY,RELNMSN,RELNRDT,RELNRTM,RELNRUN,SP70
          WRITE     HTMLFILE;"MoreStartKey=#"",KEY30,"#";"
          GOTO      TABMK999
.
TABMK900  MATCH     "1",VIEWTYPE                * Over End of Year on Week View?
          IF        @EQUAL
            MOVE      DIM8,KEY4
            PACK      KEY8,PRELEN,KEY4
            MATCH     KEY8,RESLNKFL
            IF        !@EQUAL
              MOVE      KEY8,RESLNKFL
              GOTO      TABMK060
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"MoreResults=false;"
          WRITE     HTMLFILE;"MoreStartKey=#"#";"
.                                                           
TABMK999  RETURN
.----------------------------------------------------------------------
. Table Results by Link for Unread Results for template cliweb0303005.html
. Only displays current and last year's unread results
.       Req.  LINKTYPE  03 - Doctor, 04 - Ward, 99 - Error
.             LINKKEYF  Code for Link ie Doctor,Ward
.----------------------------------------------------------------------
TBMKA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      DIM4,CCC,CYY                   * I CAR 38290
          REP       " 0",DIM4
          MOVE      DIM4,FORM4
          SUB       ONE,FORM4
.
TBMKA050  PACK      RESLNKFL,PRELEN,DIM4
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA2,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      TBMKA900 IF EQUAL
.                                                  * end I CAR 38290
          MOVE      ZERO,ROWCOUNT
          MATCH     SP70,STARTKEY
          IF        @EQUAL
            PACK      KEY30,LINKTYPE,LINKKEYF,ZERO,SP70
          ELSE
            PACK      KEY30,STARTKEY
          ENDIF
          CALL      RSRELN2
TBMKA100  CALL      RKRELN2
          BRANCH    OVRCD,TBMKA900
          MATCH     LINKTYPE,RELNLTY
          GOTO      TBMKA900 IF NOT EQUAL
          MATCH     LINKKEYF,RELNLKY
          GOTO      TBMKA900 IF NOT EQUAL
          MATCH     "0",RELNMSN
          GOTO      TBMKA900 IF NOT EQUAL
.
          MATCH     "ZZ",RELNRST        * Internal ZZ Code used to flag orders have results
          GOTO      TBMKA100 IF EQUAL
          MATCH     "X ",RELNRST        * Dont show Cancelled Orders
          GOTO      TBMKA100 IF EQUAL
          MATCH     "D ",RELNRST
          GOTO      TBMKA100 IF EQUAL
.
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              MATCH     "ZZ",RELNDSS             * DiagnosticReport Dont show orders
              GOTO      TBMKA100 IF EQUAL
            ELSE
              MATCH     "ZZ",RELNDSS             * ProcedureRequest Only Show Orders
              GOTO      TBMKA100 IF NOT  EQUAL
            ENDIF
          ENDIF
.
.
          MATCH     SP70,LABRCODE
          IF        !@EQUAL
            MATCH     RELNLAB,LABRCODE
            GOTO      TBMKA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH     RELNDSS,FILTRDSS
            GOTO      TBMKA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,NORMALFL
          IF        !@EQUAL
            MATCH     RELNNOR,NORMALFL
            GOTO      TBMKA100 IF NOT EQUAL
          ENDIF
.
          COMPARE   THREE,REPORTNO              * Final only for doctor lists
          GOTO      TBMKA200 IF NOT EQUAL
.
          MATCH     ANSF,RELNRST                * Final result
          GOTO      TBMKA200 IF EQUAL
.
          MATCH     ANSC,RELNRST                * Corrected result
          GOTO      TBMKA100 IF NOT EQUAL
.
TBMKA200  CALL      TABROW00
          IF        ROWCOUNT<20
            GOTO      TBMKA100
          ENDIF
.
          WRITE     HTMLFILE;"MoreResults=true;"
          PACK      KEY30,RELNLTY,RELNLKY,RELNMSN,RELNRDT,RELNRTM,RELNRUN,SP70
          WRITE     HTMLFILE;"MoreStartKey=#"",KEY30,"#";"
          GOTO      TBMKA999
.
TBMKA900  MOVE      DIM4,FORM4A                       * I CAR 38290
          COMPARE   FORM4,FORM4A
          IF        @EQUAL
            GOTO      TBMKA950
          ELSE
            SUB       ONE,FORM4A
            MOVE      FORM4A,DIM4
            MOVE      SP70,STARTKEY
            GOTO      TBMKA050                        * end I CAR 38290
          ENDIF
TBMKA950  WRITE     HTMLFILE;"MoreResults=false;"
          WRITE     HTMLFILE;"MoreStartKey=#"#";"
.
TBMKA999  RETURN
.------------------------------------------------------------
. Output Table Row
.------------------------------------------------------------
TABROW00  MOVE      ZERO,EXIT
          CLEAR     HTMLLINK 
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl",HTMLLINK
          APPEND    "?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&resultky=",HTMLLINK
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          APPEND    KEY17,HTMLLINK
          RESET     HTMLLINK 
.
          MOVE      ZERO,F1
          MOVE      RELNRTY,F1
          BRANCH    F1,TABROW10,TABROW20
.
          CALL      HL7ROW00   * HL7 Format
          BRANCH    EXIT,TABROW99
          GOTO      TABROW80
.
TABROW10  CALL      PITROW00   * PIT Format
          GOTO      TABROW80
.
TABROW20  CALL      DOCROW00   * Document Format
          GOTO      TABROW80
.
TABROW80  PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          MOVE      HLCODES,KEY12
          REP       ", ",PGNAME
          REP       ", ",PSNAME
          MOVELPTR  HTMLLINK,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      HTMLLINK,OUTVAR
          IF        FHIRTYPE=1
            IF        PROCREQT=0
              CALL      FHRDIR00
            ELSE
              CALL      FHRPRQ00
            ENDIF
            GOTO      TABROW90
          ENDIF
.
          ADD       ONE,ROWCOUNT
          WRITE     HTMLFILE;"t.addRow(",QUOTE,OUTVAR,QUOTE,COMMA:
                             QUOTE,RELNRDT,RELNRTM,QUOTE,COMMA:
                             QUOTE,PSNAME,COMMA,PGNAME,COMMA,PTITL,COMMA:
                                   " (",RELNPID,")",QUOTE,COMMA:
                             QUOTE,TESTLINE,QUOTE,COMMA:
                             QUOTE,RELNNOR,QUOTE,COMMA:
                             QUOTE,RELNMSN,QUOTE,COMMA:
                             QUOTE,REPHTCT,QUOTE,COMMA:
                             QUOTE,KEY12,QUOTE,COMMA:
                             QUOTE,RELNDSS,QUOTE,COMMA:
                             QUOTE,RELNUSC,QUOTE,COMMA:
                             QUOTE,RELNPID,QUOTE,COMMA:
                             QUOTE,RELNRTY,QUOTE:
                             ");"
TABROW90  REP       "+ ",KEY17
TABROW99  RETURN
+
.------------------------------------------------------------
. Get Pit Details
.------------------------------------------------------------
PITROW00  MOVE      RELNPID,KEY8
          CALL      RDMAST1
.
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          CALL      RDREPH1
          IF        OVRCD=1
            MOVE      "Invalid Result Record",REPHNAM
          ENDIF
.
          PACK      TESTLINE,REPHNAM
          MATCH     SP70,REPHSTK
          IF        !@EQUAL
            CALL      GETLIN00
          ENDIF
          MOVE      SP70,HLCODES
          RETURN
.------------------------------------------------------------
. Get Document Details
.------------------------------------------------------------
DOCROW00  MOVE      SP70,LABDESC
          MOVE      SP70,DIAGTDES
          MOVE      ZERO,EXIT
          MOVE      RELNPID,KEY8
          CALL      RDMAST1
          IF        OVRCD=1
            MOVE      "Invalid Patient ID",PSNAME
            MOVE      SP70,PGNAME
            MOVE      SP70,PTITL
          ENDIF
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70
          PACK      KEY20,RELNRDT,RELNRTM,RELNRUN,SP70
          CALL      RSRECL1
DOCROW10  CALL      RKRECL1
          BRANCH    OVRCD,DOCROW90
          PACK      KEY20,RECLRDT,RECLRTM,RECLRUN,SP70
          MATCH     KEY17,KEY20
          GOTO      DOCROW90 IF NOT EQUAL
.
          PACK      KEY20,RECLURN,RECLVIS,RECLCID,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,DOCROW90
.
          MOVE      "wi",CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          PACK      TESTLINE,TDESC,OBPCCOM1,SP70
          PACK      TESTCODE,CATEGORY,CODE,SP70
.
          MOVE      "0074",KEY4
          PACK      KEY14,KEY4,RELNDSS,SP70
          MOVE      KEY14,DIAGTCOD
          CALL      RDHLCO1
          IF        OVRCD<>1
            PACK      DIAGTDES,HLCODES,SP70
          ENDIF
.
          MOVE      "0074",KEY4
          MOVE      RELNDSS,HLCODES
          PACK      KEY14,KEY4,RELNDSS,SP70
          CALL      RDHLCO1
.
          MOVE      ZERO,FOUNDTYP
          MOVE      ONE,COUNT
          WHILE     COUNT <= DIAGTYPC
            MATCH     SP70,DIAGTYPE[COUNT]
            IF        !@EQUAL
              MATCH     DIAGTYPE[COUNT],HLCOICD
              IF        @EQUAL
                MOVE      ONE,FOUNDTYP
              ENDIF
            ENDIF
            ADD       ONE,COUNT
          DO
.
          COMPARE   ONE,FOUNDTYP
          IF        !@EQUAL
            MOVE      ONE,EXIT
          ENDIF
.
          COMPARE   ZERO,DIAGTYPC          * only one value selected
          IF        @EQUAL
            MOVE      ZERO,EXIT
          ENDIF
.
          COMPARE   ONE,DIAGTYPC          * only one value selected
          IF        @EQUAL
            MATCH     SP70,DIAGTYPE[1]    * if blank then "all"
            IF        @EQUAL
              MOVE      ZERO,EXIT
            ENDIF
          ENDIF
.
          MOVE      SP70,REPHTCT
          MOVE      "0123",KEY4 
          MOVE      RELNRST,HLCODES
          PACK      KEY14,KEY4,RELNRST,SP70
          CALL      RDHLCO1
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
.
.          STRIP     OBPTURLP
.          MATCH     "00000000",OBPCCVIS
.          IF        @EQUAL
.            MOVE      "UR",KEY2
.            PACK      HTMLLINK,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
.          ELSE
.            PACK      HTMLLINK,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
.          ENDIF
.          STRIP     HTMLLINK
.          REP       " 0",HTMLLINK
.
          GOTO      DOCROW99
DOCROW90  MOVE      "Document Link Not Found",TESTLINE
DOCROW99  RETURN
.------------------------------------------------------------
. Get HL7 Details
.------------------------------------------------------------
HL7ROW00  MOVE      SP70,LABDESC
          MOVE      SP70,DIAGTDES
          MOVE      ZERO,EXIT
          MATCH     "1",RELNFUR
          GOTO      HL7ROW50 IF EQUAL
.
          MOVE      RELNPID,KEY16
          CALL      RDREPI1
          BRANCH    OVRCD,HL7ROW60
          MOVE      REPISNM,PSNAME
          MOVE      REPIGNM,PGNAME
          MOVE      SP70,PTITL
          GOTO      HL7ROW80
.
HL7ROW50  MOVE      RELNPID,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,HL7ROW60
          GOTO      HL7ROW80
.
HL7ROW60  MOVE      "Invalid Patient ID",PSNAME
          MOVE      SP70,PGNAME
          MOVE      SP70,PTITL
          GOTO      HL7ROW80
.
HL7ROW80  MOVE      "OBR04",KEY5
          MOVE      RELNUSC,RECTDES
          PACK      KEY32,RELNLAB,KEY5,RELNUCS,RELNUSC
          CALL      RDRECT1
          MOVE      RECTDES,TESTLINE
          MOVE      KEY32,TESTCODE
          MOVE      SP70,REPHTCT
          PACK      KEY3,RECTLAB,SP70
          CALL      RDRELB1
          IF        OVRCD<>1
            PACK      LABDESC,RELBDES,SP70
          ENDIF
.
          MOVE      "0074",KEY4
          PACK      KEY14,KEY4,RELNDSS,SP70
          MOVE      KEY14,DIAGTCOD
          CALL      RDHLCO1
          IF        OVRCD<>1
            PACK      DIAGTDES,HLCODES,SP70
.
            PACK      KEY5,HLCOCAT,HLCOICD
            CALL      RDCODE1
            IF        OVRCD=0
              IF        SHOWERRR=0
                MATCH     "X",TCINDC3
                IF        @EQUAL
                  MOVE      ONE,EXIT          * Exit failure if Cat "dg" Code
                  GOTO      HL7ROW99          * has indicator 3=X
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "0074",KEY4
          MOVE      RELNDSS,HLCODES
          PACK      KEY14,KEY4,RELNDSS,SP70
          CALL      RDHLCO1
.
          MOVE      ZERO,FOUNDTYP
          MOVE      ONE,COUNT
          WHILE     COUNT <= DIAGTYPC
            MATCH     SP70,DIAGTYPE[COUNT]
            IF        !@EQUAL
              MATCH     DIAGTYPE[COUNT],HLCOICD
              IF        @EQUAL
                MOVE      ONE,FOUNDTYP
              ENDIF
            ENDIF
            ADD       ONE,COUNT
          DO
.
          COMPARE   ONE,FOUNDTYP
          IF        !@EQUAL
            MOVE      ONE,EXIT
          ENDIF
.
          COMPARE   ZERO,DIAGTYPC          * only one value selected
          IF        @EQUAL
            MOVE      ZERO,EXIT
          ENDIF
.
          COMPARE   ONE,DIAGTYPC          * only one value selected
          IF        @EQUAL
            MATCH     SP70,DIAGTYPE[1]    * if blank then "all"
            IF        @EQUAL
              MOVE      ZERO,EXIT
            ENDIF
          ENDIF
.
          MOVE      "0123",KEY4
          MOVE      RELNRST,HLCODES
          PACK      KEY14,KEY4,RELNRST,SP70
          CALL      RDHLCO1
.
HL7ROW99  RETURN
+
.------------------------------------------------------------
. List Results by Ward by Date
.------------------------------------------------------------
ESUM0000  BRANCH    FLDITMNO,ESUM0100
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      ESUM9999
.
ESUM0100  MOVE      "99",LINKTYPE
          CALL      ERTAB000    * Link Table of Results
          GOTO      ESUM9999
.
ESUM9999  RETURN
.----------------------------------------------------------------------
. Table Results by Link by Date 
.       Req.  LINKTYPE  03 - Doctor, 04 - Ward, 99 - Error
.             LINKKEYF  Code for Link ie Doctor,Ward
.----------------------------------------------------------------------
ERTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,YEARCNTR                     * Check year count
.
ERTAB050  MOVE      ZERO,FOUNDFLG                     * Record not found
.
          PACK      RESLNKFL,PRELEN,RETYER01          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      ERTAB999 IF EQUAL                 * end I CAR 38290
.
          PACK      KEY29,LINKTYPE,LINKKEYF,SP70
          CALL      RSRELN1
ERTAB100  CALL      RKRELN1
          BRANCH    OVRCD,ERTAB900
.
          MATCH     LINKTYPE,RELNLTY
          GOTO      ERTAB900 IF NOT EQUAL
.
          MATCH     LINKKEYF,RELNLKY
          GOTO      ERTAB900 IF NOT EQUAL
.
          MATCH     "D ",RELNRST
          GOTO      ERTAB100 IF EQUAL
.
          MOVE      ONE,FOUNDFLG                       * Record found
          CALL      ERRROW00
          GOTO      ERTAB100
.
ERTAB900  MATCH     "99",LINKTYPE                      * Errors only
          GOTO      ERTAB999 IF NOT EQUAL
.
          BRANCH    FOUNDFLG,ERTAB999                  * Record found exit
.
          ADD       ONE,YEARCNTR                       * Check year count
          IF        YEARCNTR < 6
            MOVE      RETYER01,F4                      * Subtract 1 year
            SUB       ONE,F4                           * and try again
            MOVE      F4,RETYER01                      * max 5 years
            GOTO      ERTAB050
          ENDIF
.
ERTAB999  RETURN
.------------------------------------------------------------
. Output Table Row
.------------------------------------------------------------
ERRROW00  MATCH     "0",RELNRTY
          GOTO      ERRROW50 IF EQUAL
.
. PIT Row
.
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          CALL      RDREPH1
          IF        OVRCD=1
            MOVE      "Invalid Result Record",REPHNAM
          ENDIF
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",KEY17,QUOTE,COMMA:
                             QUOTE,RELNRDT,RELNRTM,QUOTE,COMMA:
                             QUOTE,REPHNAM,QUOTE,COMMA:
                             QUOTE,REPHNOR,QUOTE,COMMA:
                             QUOTE,REPHTCT,QUOTE:
                             ");"
          REP       "+ ",KEY17
          GOTO      ERRROW99
.
. HL7 Row
.
ERRROW50  MOVE      ONE,SHOWERRR
          CALL      HL7ROW00 
          BRANCH    EXIT,ERRROW99
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          CALL      RDREER1
          IF        OVRCD=1
            MOVE      SP70,REERMSG
          ENDIF
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          MOVE      HLCODES,KEY12
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",KEY17,QUOTE,COMMA:
                             QUOTE,RELNRDT,RELNRTM,QUOTE,COMMA:
                             QUOTE,TESTLINE,QUOTE,COMMA:
                             QUOTE,RELNNOR,QUOTE,COMMA:
                             QUOTE,REPHTCT,QUOTE,COMMA:
                             QUOTE,KEY12,QUOTE,COMMA:
                             QUOTE,RELNDSS,QUOTE,COMMA:
                             QUOTE,REERMSG,QUOTE:
                             ");"
          REP       "+ ",KEY17
          GOTO      ERRROW99
.
ERRROW99  RETURN
+
.------------------------------------------------------------
. Table Results by U/R No
.------------------------------------------------------------
URCOL000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        NORECORD=0
            MOVE      "50",NORECORD 
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          CLEAR     TESTLIST
          MOVE      SP70,COLLDATE
          MOVE      SP70,COLLTIME
          MOVE      ONE,TESTFST
          PACK      KEY46,URNUMBER,Z70
          CALL      RSREPH2
URCOL100  CALL      RPREPH2
          BRANCH    OVRCD,URCOL900
          MATCH     URNUMBER,REPHPID
          GOTO      URCOL900 IF NOT EQUAL
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      URCOL100
          ENDIF
          MATCH     SP70,COLLDATE
          GOTO      URCOL300 IF EQUAL
          MATCH     REPHCDT,COLLDATE
          GOTO      URCOL200 IF NOT EQUAL
          MATCH     REPHCTM,COLLTIME
          GOTO      URCOL200 IF NOT EQUAL
.        
          APPEND    ",",TESTLIST
          MOVE      ZERO,TESTFST
          MOVE      REPHNAM,KEY15
          STRIP     KEY15
          APPEND    KEY15,TESTLIST
          GOTO      URCOL100
.
URCOL200  CALL      COLROW00   * Output Table Row
.
URCOL300  MOVE      REPHCDT,COLLDATE
          MOVE      REPHCTM,COLLTIME
          CLEAR     TESTLIST
          MOVE      REPHNAM,KEY15
          STRIP     KEY15
          APPEND    KEY15,TESTLIST
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      URCOL100 IF NOT EQUAL
          GOTO      URCOL999  
.          
URCOL900  IF        TESTFST=0
            CALL      COLROW00   * Output Table Row
          ENDIF
.
URCOL999  RETURN
.----------------------------------------------------------------------
. Output Row with Collection and Tests
.----------------------------------------------------------------------
COLROW00  PACK      KEY13,COLLDATE,COLLTIME
          REP       " +",KEY13
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&collectk=",KEY13,QUOTE,COMMA:
                             QUOTE,COLLDATE,COLLTIME,QUOTE,COMMA:
                             QUOTE,TESTLIST,QUOTE:
                             ");"
          REP       "+ ",URNUMBER
          REP       "+ ",KEY13
          RETURN
.--------------------------------------------------------------------
. Decode PIT Highlight Codes
.--------------------------------------------------------------------
DECODE00  ENDSET    REPDTXT
          RESET     REPDTXT
          PACK      TXT127,REPDTXT,SP70
          CLEAR     TESTLINE
.
DECODE10  SCAN      "~",TXT127
          GOTO      DECODE90 IF NOT EQUAL
          MOVEFPTR  TXT127,TXTLEN
          SUB       ONE,TXTLEN
          IF        TXTLEN>0
            RESET     TXT127
            SFORMAT   VAR,TXTLEN
            MOVE      TXT127,VAR
            APPEND    VAR,TESTLINE
            SFORMAT   VAR,127
            ADD       ONE,TXTLEN
            RESET     TXT127,TXTLEN
            SUB       ONE,TXTLEN
          ENDIF

          UNPACK    TXT127,KEY1,HIGHCODE,TXT127 * Get First Code
.
          CALL      PROHIG00                    * Process Highlight
  
DECODE20  MATCH     "~",TXT127                  * End ~  ?
          GOTO      DECODE30 IF EQUAL
.
          UNPACK    TXT127,HIGHCODE,TXT127      * Get Next Code
          CALL      PROHIG00                    * Process Highlight
          GOTO      DECODE20
.
DECODE30  UNPACK    TXT127,KEY1,TXT127 * Get First Code
          GOTO      DECODE10
.
DECODE90  STRIP     TXT127       * Output Remaining String
          MOVELPTR  TXT127,TXTLEN
          IF        TXTLEN>0
            SFORMAT   VAR,TXTLEN
            MOVE      TXT127,VAR
            APPEND    VAR,TESTLINE
            SFORMAT   VAR,127
          ELSE
            APPEND    SP1,TESTLINE
          ENDIF
.
DECODE99  APPEND    SP70,TESTLINE
          RESET     TESTLINE
          RETURN
.
PROHIG00  MATCH     "SBLD",HIGHCODE
          IF        @EQUAL
            APPEND    "<b>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "EBLD",HIGHCODE
          IF        @EQUAL
            APPEND    "</b>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "SUND",HIGHCODE
          IF        @EQUAL
            APPEND    "<u>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "EUND",HIGHCODE
          IF        @EQUAL
            APPEND    "</u>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "SBLK",HIGHCODE
          IF        @EQUAL
            APPEND    "<blink>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "EBLK",HIGHCODE
          IF        @EQUAL
            APPEND    "</blink>",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
          MATCH     "FG",HIGHCODE
          IF        @EQUAL
            CALL      SETCOL00
            APPEND    "<font color=",COLORSTR,">",TESTLINE
            GOTO      PROHIG99
          ENDIF
.         
PROHIG99  RETURN
.         
SETCOL00  UNPACK    HIGHCODE,KEY2,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,SETCOL01,SETCOL02,SETCOL03,SETCOL04,SETCOL05:
                       SETCOL06,SETCOL07,SETCOL08,SETCOL09,SETCOL10:
                       SETCOL11,SETCOL12,SETCOL13,SETCOL14,SETCOL15
          MOVE      "Black",COLORSTR
          GOTO      SETCOL99
SETCOL01  MOVE      "Blue        ",COLORSTR
          GOTO      SETCOL99
SETCOL02  MOVE      "Green       ",COLORSTR
          GOTO      SETCOL99
SETCOL03  MOVE      "Cyan        ",COLORSTR
          GOTO      SETCOL99
SETCOL04  MOVE      "Red         ",COLORSTR
          GOTO      SETCOL99
SETCOL05  MOVE      "Magenta     ",COLORSTR
          GOTO      SETCOL99
SETCOL06  MOVE      "Brown       ",COLORSTR
          GOTO      SETCOL99
SETCOL07  MOVE      "LightGrey   ",COLORSTR
          GOTO      SETCOL99
SETCOL08  MOVE      "DarkGrey    ",COLORSTR
          GOTO      SETCOL99
SETCOL09  MOVE      "LightBlue   ",COLORSTR
          GOTO      SETCOL99
SETCOL10  MOVE      "LightGreen  ",COLORSTR
          GOTO      SETCOL99
SETCOL11  MOVE      "LightCyan   ",COLORSTR
          GOTO      SETCOL99
SETCOL12  MOVE      "LightRed    ",COLORSTR
          GOTO      SETCOL99
SETCOL13  MOVE      "LightMagenta",COLORSTR
          GOTO      SETCOL99
SETCOL14  MOVE      "Yellow      ",COLORSTR
          GOTO      SETCOL99
SETCOL15  MOVE      "White       ",COLORSTR
          GOTO      SETCOL99
SETCOL99  RETURN
.
.------------------------------------------------------------
. Delete Result Records
.------------------------------------------------------------
DERES000  MATCH     ANSD,UPDATETY
          GOTO      DERES999 IF NOT EQUAL
.
          MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,DERES900
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
          BRANCH    OVRCD,DERES900
.
          MOVE      "D ",REHARST
          PACK      REHARDE,DELETERS,SP70
          CALL      UPREHA1
.
          CALL      RMDEA000  * Hide resdea results
          CALL      RMLNK000  * Hide reslnk results
          CALL      RMLUR000  * Hide reslur results
.
          CALL      RSAU0000
          CALL      NORE0000
          CALL      DECL0000
          GOTO      DERES999
.
DERES900  MOVE      "Invalid result key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DERES999
.
DERES999  RETURN
+
.------------------------------------------------------------
. Delete Record Links
.------------------------------------------------------------
RMLNK000  PACK      KEY29,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          PACK      KEY17,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          CALL      RSRELN3
RMLNK100  CALL      RKRELN3
          BRANCH    OVRCD,RMLNK999
          PACK      KEY29,RELNRDT,RELNRTM,RELNRUN,RELNLTY,RELNLKY,SP70
          MATCH     KEY17,KEY29
          GOTO      RMLNK999 IF NOT EQUAL
          MOVE      "D ",RELNRST
          CALL      UPRELN3
          GOTO      RMLNK100
.
RMLNK999  RETURN
.----------------------------------------------------------------------
. Delete A Details
.----------------------------------------------------------------------
RMDEA000  PACK      KEY21,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          PACK      KEY17,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          CALL      RSREDA1
RMDEA100  CALL      RKREDA1
          BRANCH    OVRCD,RMDEA999
          PACK      KEY21,REDARDT,REDARTM,REDARUN,REDASID,SP70   * Save Key
          MATCH     KEY17,KEY21
          GOTO      RMDEA999 IF NOT EQUAL
          MOVE      "D ",REDASTA
          PACK      REDAPER,USERID,SP70
          CALL      UPREDA1
          GOTO      RMDEA100
.
RMDEA999  RETURN
.
.----------------------------------------------------------------------
. Delete resluraf records
.----------------------------------------------------------------------
RMLUR000  PACK      DIM25,URNUMBER,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          PACK      KEY25,URNUMBER,REHARDT,REHARTM,REHARUN,SP70   * Save Key
          CALL      RDRELU1
          BRANCH    OVRCD,RMLUR999
.
          PACK      KEY25,RELUURN,RELURDT,RELURTM,RELURUN,SP70
          MATCH     KEY25,DIM25
          GOTO      RMLUR999 IF NOT EQUAL
.
          MOVE      "D ",RELURST
          CALL      UPRELU1
.
RMLUR999  RETURN
.
.-------------------------------------------------------------------------------
. Write Results' Audit Record
.-------------------------------------------------------------------------------
RSAU0000  MOVE      USERID,REAUUID
          PACK      KEY40,REHARDT,REHARTM,REHARUN,REAUSDT,REAUSTM,REAUUID,SP70
          UNPACK    KEY40,REAURDT,REAURTM,REAURUN,REAUSDT,REAUSTM,REAUUID
          MOVE      KEY40,AUDITKEY
          MOVE      "D ",REAURST
          MOVE      ZERO,REAUMRK
          MOVE      SP70,REAUACD
          MOVE      SP70,REAUACM
          MOVE      SP70,REAUSPA
.
          PACK      RESLNKFL,PREAEA,REAURDT
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESAUDA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      RSAU9999 IF EQUAL
.
          CALL      RDREAU1
          IF        OVRCD=1
            CALL      WRREAU1
          ELSE
            CALL      UPREAU1
          ENDIF
.
RSAU9999  RETURN
.-------------------------------------------------------------------------------
. NORE0000 - Update PATMX1AF if no more results exist for this patient
.-------------------------------------------------------------------------------
NORE0000  PACK      KEY57,URNUMBER,SP70
          CALL      RSREHA3
NORE1000  CALL      RKREHA3
          BRANCH    OVRCD,NORE8000
.
          PACK      DIM16,URNUMBER,SP70
          MATCH     DIM16,REHAPID
          GOTO      NORE8000 IF NOT EQUAL
.
          MATCH     "D ",REHARST
          GOTO      NORE9999 IF NOT EQUAL
.
          GOTO      NORE1000
.
NORE8000  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,NORE9999
.
          MOVE      ZERO,PTMXSIN2
          CALL      UPMAST1
.
NORE9999  RETURN
.-------------------------------------------------------------------------------
. DECL0000 - Update RESCLNAF
.-------------------------------------------------------------------------------
DECL0000  PACK      KEY20,RESULTKY,SP70
          CALL      RSRECL1
DECL1000  CALL      RKRECL1
          BRANCH    OVRCD,DECL9999
.
          PACK      DIM17,RECLRDT,RECLRTM,RECLRUN,SP70
.
          MATCH     RESULTKY,DIM17
          GOTO      DECL9999 IF NOT EQUAL
.
          MOVE      ONE,RECLDEL
          CALL      UPRECL1
.
          PACK      KEY20,RECLURN,RECLVIS,RECLCID,SP70
          CALL      RDOBPC1
          IF        OVRCD=0
            MOVE      ONE,OBPCMDEL
            CALL      UPOBPC1
          ENDIF
.
          GOTO      DECL1000
.
DECL9999  RETURN
.------------------------------------------------------------
.  Next Page
.------------------------------------------------------------
.
NXTPAG00  IF        NEXTPAGE=0 
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF
.
          IF        NEXTPAGE=1
            CALL      RDIREC00
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Add Selection Options to Form (code value)
.------------------------------------------------------------
CODMUL00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
CODMUL10  CALL      RDKCODE2
          BRANCH    OVRCD,CODMUL99
          MATCH     CATEGORY,TCODE
          GOTO      CODMUL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      CODMUL10 IF EQUAL
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
.
          MOVE      ZERO,FOUNDTYP
          MOVE      ONE,COUNT
          WHILE     COUNT <= DIAGTYPC
            MATCH     SP70,DIAGTYPE[COUNT]
            IF        !@EQUAL
              MATCH     DIAGTYPE[COUNT],ACODE
              IF        @EQUAL
                WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                                   TDESC,"</option>"
                MOVE      ONE,FOUNDTYP
              ENDIF
            ENDIF
            ADD       ONE,COUNT
          DO
.
          COMPARE   ONE,FOUNDTYP
          GOTO      CODMUL10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      CODMUL10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,CODMUL10
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          GOTO      CODMUL10
.
CODMUL99  RETURN
.------------------------------------------------------------
. Table Results by U/R No
.------------------------------------------------------------
URSUM000  UNPACK    DIM127,D1,GROUPBY,DIM127
          IF        NORECORD=0
            MOVE      "25",NORECORD
          ENDIF
          MOVE      ZERO,INDEXLEN
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          MOVE      SP70,RESULTKS[ONE]
          MOVE      YEAROPEN,REDAOPEN
.
          WRITE     HTMLFILE;"["
          PACK      KEY25,URNUMBER,Z70
          CALL      RSRELU1
URSUM100  CALL      RPRELU1
          BRANCH    OVRCD,URSUM999
          MATCH     URNUMBER,RELUURN
          GOTO      URSUM999 IF NOT EQUAL
          MATCH     SP70,FILTRDSS
          IF        !@EQUAL
            MATCH      RELUDSS,FILTRDSS
            GOTO       URSUM100 IF NOT EQUAL
          ENDIF
          MATCH     "ZZ",RELURST        * Internal ZZ Code used to flag orders have results
          GOTO      URSUM100 IF EQUAL
          MATCH     "X ",RELURST        * Dont show cancelled Orders
          GOTO      URSUM100 IF EQUAL
          MATCH     "D ",RELURST
          GOTO      URSUM100 IF EQUAL
.
. Scan for Tests Complete Line in Comments
. Open Result Year Details Table if not open
.
          MOVE      RELURDT,RESULTYR
          MATCH     REDAOPEN,RESULTYR
          IF        !@EQUAL
            PACK      RESFNAME,PREDEA,RESULTYR
            OPEN      RESDEAA1,RESFNAME
            MOVE      RESULTYR,REDAOPEN
          ENDIF
          MOVE      SP70,TESTSETS
          PACK      KEY21,RELURDT,RELURTM,RELURUN,SP70
          CALL      RSREDA1
URSUM200  CALL      RKREDA1
          BRANCH    OVRCD,URSUM300
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     KEY17,KEY21
          GOTO      URSUM300 IF NOT EQUAL
          MOVE      REDAVST,VAR
          REP       UPPLOW,VAR
          MATCH     "TESTS COMPLETE",VAR
          GOTO      URSUM200 IF NOT EQUAL
          UNPACK    REDAVST,KEY18,TESTSETS
URSUM300
          MATCH     "1",GROUPBY
          IF        @EQUAL
            CALL      CHKIDX00      * Group By
            BRANCH    EXIT,URSUM100
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      URSUM100
          ENDIF
.
          CALL      JSNSUM00   * Output JSON Row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      URSUM100 IF NOT EQUAL
.
URSUM999  WRITE     HTMLFILE;"]"
.
. Reopen Current Year Details Table
.
          MATCH     REDAOPEN,YEAROPEN
          IF        !@EQUAL
            PACK      RESFNAME,PREDEA,YEAROPEN
            OPEN      RESDEAA1,RESFNAME
          ENDIF
          RETURN
.
CHKIDX00  PACK      KEY127,RELULAB,RELUUCS,RELUUSC,TESTSETS,SP70
          MOVE      ZERO,EXIT
          MOVE      ONE,COUNT
          WHILE     COUNT <= INDEXLEN
            MATCH     KEY127,RESULTKS[COUNT]
            IF        @EQUAL
              MOVE      ONE,EXIT
              MOVE      INDEXLEN,COUNT
            ENDIF
            ADD       ONE,COUNT
          DO
          IF        EXIT=0
            ADD       ONE,INDEXLEN
            MOVE      KEY127,RESULTKS[INDEXLEN]
          ENDIF
          RETURN
.
JSNSUM00  MOVE      "OBR04",KEY5
          MOVE      RELUUSC,RECTDES
          PACK      KEY32,RELULAB,KEY5,RELUUCS,RELUUSC
          CALL      RDRECT1
          PACK      KEY3,RELULAB
          CALL      RDRELB1
.
          STRIP     TESTSETS
          PACK      KEY17,RELURDT,RELURTM,RELURUN,SP70
          REP       " +",KEY17
          WRITE     HTMLFILE;"{#"type#":#"",RELUDSS,"#",":
                              "#"code#":#"",RELUUSC,"#",":
                              "#"labcode#":#"",RELULAB,"#",":
                              "#"labname#":#"",RELBDES,"#",":
                              "#"description#":#"",RECTDES,"#",":
                              "#"datetime#":#"",RELURDT,RELURTM,"#",":
                              "#"abnormal#":#"",RELUNOR,"#",":
                              "#"status#":#"",RELURST,"#",":
                              "#"testsets#":#"",TESTSETS,"#",":
                              "#"resultkey#":#"",KEY17,"#"},";
          REP       "+ ",KEY17
          RETURN
+
.------------------------------------------------------------
. FHIR Diagnostic Report Bundle
.------------------------------------------------------------
FHRDIR00  PACK      FHRDIRID,RELNRDT,RELNRTM,RELNRUN,SP70
          REP       " -",FHRDIRID
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          WRITE     HTMLFILE;*+,"    {":
                                " #"fullUrl#": #"%BASEURL/DiagnosticReport/",FHRDIRID,"#",":
                                " #"resource#": ";
          CALL      RESDIR00
          WRITE     HTMLFILE;*+,"}";
.
          IF        FHRSUBIN=1
.
            WRITE     HTMLFILE;*+,",{":
                                  " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
            CALL      RESPAT00
.
            WRITE     HTMLFILE;*+,"}"
          ENDIF
.
          IF        FHRLOCIN=1
.
            MATCH     SP70,RECTLAB
            IF        !@EQUAL & !@EOS
.
              PACK      KEY3,RECTLAB,SP70
              CALL      RDRELB1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Location/Laboratory-",RECTLAB,"#",":
                                        " #"resource#": ";
                CALL      RESLOC00
.
                WRITE     HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          RETURN
+
.------------------------------------------------------------
. FHIR Diagnostic Report
.------------------------------------------------------------
RESDIR00  PACK      FHRPATID,URNUMBER,SP70
          PACK      FHRDIRID,RELNRDT,RELNRTM,RELNRUN,SP70
          PACK      FHROBSID,RELNRDT,RELNRTM,RELNRUN,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRDIRID
          REP       " -",FHROBSID
.
          PACK      LABDESC,SP70
          PACK      KEY3,RECTLAB,SP70
          CALL      RDRELB1
          IF        OVRCD<>1
            PACK      LABDESC,RELBDES,SP70
          ENDIF
.
          MOVE      "0123",KEY4 
          MOVE      RELNRST,HLCODES
          PACK      KEY14,KEY4,RELNRST,SP70
          CALL      RDHLCO1
.
          MOVE      "true",RESABN
          MATCH     "1",RELNNOR
          IF        @EQUAL
            MOVE      "false",RESABN
          ENDIF
          MOVE      "false",RESACK
          MATCH     "1",RELNMSN
          IF        @EQUAL
            MOVE      "true",RESACK
          ENDIF
.
          MOVE      SP70,REHAVIS
          MOVE      SP70,REHACID
          MOVE      SP70,REHAFOR
          IF        FHIRSUMM=0
            MOVE      RELNRDT,RESULTYR
            MOVE      ZERO,OVRCD
            MATCH     RESULTYR,YEAROPEN             * Determine which year 
            IF        !@EQUAL
              MOVE      RESULTYR,YEAROPEN
.              PACK      RESFNAME,PREHEA,RESULTYR
.              OPEN      RESHEAA1,RESFNAME           * Clinical Results Header
.              PACK      RESFNAME,PREDEA,RESULTYR
.              OPEN      RESDEAA1,RESFNAME           * Clinical Results Detail
              CLOSE     RESHEAA1
              CLOSE     RESHEBA1
              CLOSE     RESHECA1
              CLOSE     RESHEDA1
              CLOSE     RESAUDA1
              CLOSE     RESDEAA1
              PACK      RESFNAME,PREHEA,RESULTYR
              OPEN      RESHEAA1,RESFNAME
              PACK      RESFNAME,PREHEB,RESULTYR
              OPEN      RESHEBA1,RESFNAME
              PACK      RESFNAME,PREHEC,RESULTYR
              OPEN      RESHECA1,RESFNAME
              PACK      RESFNAME,PREHED,RESULTYR
              OPEN      RESHEDA1,RESFNAME
              PACK      RESFNAME,PREAEA,RESULTYR
              OPEN      RESAUDA1,RESFNAME
              PACK      RESFNAME,PREDEA,RESULTYR
              OPEN      RESDEAA1,RESFNAME
            ENDIF
            PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70
            CALL      RDREHA1
          ENDIF
.
          MOVE      ZERO,IMAGELNK
          MATCH     "RX",RELNDSS
          GOTO      RESDIR10 IF NOT EQUAL
.
          MATCH     SP70,REHACID
          GOTO      RESDIR10 IF EQUAL
          MATCH     SP70,REHAFOR
          GOTO      RESDIR10 IF EQUAL
.
          MOVE      ONE,IMAGELNK
.
RESDIR10  STRIP     WBTPFIL  *  Template
          MOVE      TESTCODE,KEY32
          STRIP     KEY32
          REP       " -",KEY32
          REP       "\ ",TESTLINE
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"DiagnosticReport#",":
                    " #"id#" : #"",FHRDIRID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " {#"url#" : #"%BASEURL/extension/dxc-hc-abnormal#",":
                    "  #"valueBoolean#" : ",RESABN," },":
                    " {#"url#" : #"%BASEURL/extension/dxc-hc-acknowledged#",":
                    "  #"valueBoolean#" : ",RESACK," },";
          MATCH     "false",RESACK
          IF        @EQUAL
            WRITE     HTMLFILE;*+," ":
                    " {#"url#" : #"%BASEURL/extension/dxc-hc-workflowstatus#",":
                    "  #"valueCodeableConcept#" : { #"coding#" : [ { ":
                    "      #"code#" : #"pending-acknowledgement#", ":
                    "      #"display#" : #"Pending Acknowledgement#" } ] } }";
          ELSE
            CALL      ACKBY000
            WRITE     HTMLFILE;*+," ":
                    "{#"url#" : #"%BASEURL/extension/dxc-hc-workflowstatus#",":
                    "  #"valueCodeableConcept#" : { #"coding#" : [ { ":
                    "      #"code#" : #"acknowledged#", ":
                    "      #"display#" : #"Acknowledged#" } ] } },":
                    " {#"url#" : #"%BASEURL/extension/dxc-hc-acknowledgeddttm#",":
                    " #"valueDateTime#" : #"",ACKBYDTM,"#" },":
                    " {#"url#" : #"%BASEURL/extension/dxc-hc-acknowledgedby#",":
                    "  #"valueString#" : #"",ACKBYWHO,"#" }";
          ENDIF
          UNPACK    RELNRDT,CCENT,CYEAR,CMON,CDAY
          WRITE     HTMLFILE;*+," ],":
                    " #"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#"}, ":
                    " #"status#" : #"",HLCODES,"#",":
                    " #"effectiveDateTime#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                        "T",RELNRTM,":00",TIMEZONE,"#",":
                    " #"category#" : {":
                    "  #"coding#" : [":
                    "   { #"code#"      : #"",DIAGTCOD,"#",":
                    "     #"display#"   : #"",DIAGTDES,"#" } ":
                    "  ] },":
                    " #"code#" : {":
                    "  #"coding#" : [":
                    "   { #"code#"      : #"",KEY32,"#",":
                    "     #"display#"   : #"",TESTLINE,"#" } ":
                    "  ] },":
                    " #"performer#" : [ {":
                    "  #"actor#" : ":
                    "   { #"reference#" : #"Location/Laboratory-",RECTLAB,"#",":
                    "     #"display#"   : #"",LABDESC,"#" } ":
                    "    } ]";
.
          IF        IMAGELNK=1
            STRIP     REHAFOR
            STRIP     REHACID
            STRIP     WBSEUID
            CLOCK     TIME,CTIMEIS
            WRITE     HTMLFILE;*+,",#"presentedForm#" : ":
                                  " { #"url#" : #"%BASEURL/php/PACSlink.php":
                                          "?username=",WBSEUID:
                                          "&patientId=",REHACID:
                                          "&accessionNumber=",REHAFOR:
                                          "&httprand=",CTIMEIS,"#" }";
          ENDIF
.
          IF       FHIRSUMM=0
            PACK      FHRENCID,URNUMBER,REHAVIS,SP70
            REP       " -",FHRENCID
            MATCH     "       0",REHAVIS
            IF        !@EQUAL
              MATCH     SP70,REHAVIS 
              IF        !@EQUAL
                 WRITE    HTMLFILE;*+,",  #"context#":  ":
                            "  { #"reference#" : #"Encounter/",FHRENCID,"#"} ";
              ENDIF
            ENDIF
            CALL     ADOBS000       *Add Observations
          ENDIF
.     
          WRITE    HTMLFILE;*+,"}" 
RESDIR99  RETURN
+
.----------------------------------------------------------------------
. Add Observations to The Result
.----------------------------------------------------------------------
ADOBS000  PACK      KEY21,RELNRDT,RELNRTM,RELNRUN,SP70   * Save Key
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN,SP70   * Save Key
          MOVE      ZERO,F3
          CALL      RSREDA1
ADOBS100  CALL      RKREDA1
          BRANCH    OVRCD,ADOBS999
          PACK      KEY21,REDARDT,REDARTM,REDARUN,REDASID,SP70   * Save Key
          MATCH     KEY17,KEY21
          GOTO      ADOBS999 IF NOT EQUAL
          PACK      FHROBSID,REDARDT,REDARTM,REDARUN,REDASID,SP70   * Save Key
          REP       " -",FHROBSID
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            WRITE     HTMLFILE;*+,", #"result#" : [ ";
          ENDIF
          ADD       ONE,F3
          WRITE     HTMLFILE;*+,"{ #"reference#" : #"Observation/",FHROBSID,"#" }";
          GOTO      ADOBS100
.
ADOBS999  IF        F3>0
            WRITE     HTMLFILE;*+," ] ";
          ENDIF
          RETURN
.-----------------------------------------------------------
. Get Last Acknowledge By from Audit
.-----------------------------------------------------------
ACKBY000  MOVE      "N/A",ACKBYWHO
          MOVE      "1900-01-01T12:00:00Z",ACKBYDTM
.
          PACK      RESLNKFL,PREAEA,RELNRDT
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESAUDA1,RESLNKFL
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      ACKBY999 IF EQUAL
.
          MOVE      WBSEUID,SAVEWUID
          PACK      RESULTKY,RELNRDT,RELNRTM,RELNRUN,SP70
          PACK      KEY40,RESULTKY,Z70
          CALL      RSREAU1
ACKBY100  CALL      RPREAU1
          BRANCH    OVRCD,ACKBY999
          PACK      KEY17,REAURDT,REAURTM,REAURUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      ACKBY999 IF NOT EQUAL
          MATCH     "1",REAUMRK
          GOTO      ACKBY100 IF NOT EQUAL

          UNPACK    REAUSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      ":00",KEY3
          PACK      ACKBYDTM,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,REAUSTM,KEY3,TIMEZONE
.
          MOVE      REAUUID,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      REAUUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,ACKBYWHO
.
          MOVE      SAVEWUID,KEY10
          CALL      RDWBSE1
.
ACKBY999  RETURN
.
.------------------------------------------------------------
. FHIR Procedure Request Bundle
.------------------------------------------------------------
FHRPRQ00  PACK      FHRDIRID,RELNRDT,RELNRTM,RELNRUN,SP70
          REP       " -",FHRDIRID
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          WRITE     HTMLFILE;*+,"    {":
                                " #"fullUrl#": #"%BASEURL/ProcedureRequest/",FHRDIRID,"#",":
                                " #"resource#": ";
          CALL      RESPRQ00
          WRITE     HTMLFILE;*+,"}";
.
          IF        FHRSUBIN=1
.
            WRITE     HTMLFILE;*+,",{":
                                  " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
            CALL      RESPAT00
.
            WRITE     HTMLFILE;*+,"}"
          ENDIF
.
          IF        FHRLOCIN=1
.
            MATCH     SP70,RECTLAB
            IF        !@EQUAL & !@EOS
.
              PACK      KEY3,RECTLAB,SP70
              CALL      RDRELB1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Location/Laboratory-",RECTLAB,"#",":
                                        " #"resource#": ";
                CALL      RESLOC00
.
                WRITE     HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          IF        FHRPARIN=1
.
            MATCH     SP70,REAUUID
            IF        !@EQUAL & !@EOS
.
              PACK      KEY10,REAUUID,SP70
              CALL      RDWBSE1             
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",REAUUID,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner Recorder
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
            MATCH     SP70,RESULTKY
            IF        !@EQUAL & !@EOS
. 
              PACK      KEY19,RESULTKY,SP70
              CALL      RSREHC1
FHRPRQ50      CALL      RKREHC1
              BRANCH    OVRCD,FHRPRQ99
.
              PACK      KEY17,REHCRDT,REHCRTM,REHCRUN,SP70
.
              MATCH     RESULTKY,KEY17
              GOTO      FHRPRQ99 IF NOT EQUAL
.
              MOVE      REHCCTO,KEY10
              PACK      KEY10,KEY10,SP70
.
              MATCH     SP70,KEY10
              IF        !@EQUAL & !@EOS
.
                PACK      KEY10,KEY10,SP70
                CALL      RDPMHCP1 
                IF        OVRCD=0
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/HCP-",KEY10,"#", ":
                            " #"resource#" : ";
                  CALL     RESASS00         * FHIR Resource Practitioner 
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
. 
              ENDIF
.
              GOTO      FHRPRQ50
.
            ENDIF
.UPTOHERE
          ENDIF
.
FHRPRQ99  RETURN
+
.------------------------------------------------------------
. FHIR Procedure Request
.------------------------------------------------------------
RESPRQ00  PACK      FHRPATID,URNUMBER,SP70
          PACK      FHRDIRID,RELNRDT,RELNRTM,RELNRUN,SP70
          PACK      RESULTKY,RELNRDT,RELNRTM,RELNRUN,SP70
          PACK      FHROBSID,RELNRDT,RELNRTM,RELNRUN,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRDIRID
          REP       " -",FHROBSID
.
          PACK      LABDESC,SP70
          PACK      KEY3,RECTLAB,SP70
          CALL      RDRELB1
          IF        OVRCD<>1
            PACK      LABDESC,RELBDES,SP70
          ENDIF
.
          MOVE      "0123",KEY4 
          MOVE      RELNRST,HLCODES
          PACK      KEY14,KEY4,RELNRST,SP70
          CALL      RDHLCO1
          UNPACK    RELNRDT,CCENT,CYEAR,CMON,CDAY
.
          MATCH     "S ",RELNRST
          IF        @EQUAL
            MOVE      "active",HLCODES
          ENDIF
.
          MATCH     "X ",RELNRST
          IF        @EQUAL
            MOVE      "cancelled",HLCODES
          ENDIF
.
          MATCH     "ZZ",RELNRST
          IF        @EQUAL
            MOVE      "completed",HLCODES
          ENDIF
.
          MOVE      SP70,REHAVIS
          MOVE      SP70,REHACID
          MOVE      SP70,REHAFOR
          MOVE      RELNRDT,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          IF        !@EQUAL
            MOVE      RESULTYR,YEAROPEN
            CLOSE     RESHEAA1
            CLOSE     RESHEBA1
            CLOSE     RESHECA1
            CLOSE     RESHEDA1
            CLOSE     RESAUDA1
            CLOSE     RESDEAA1
            PACK      RESFNAME,PREHEA,RESULTYR
            OPEN      RESHEAA1,RESFNAME
            PACK      RESFNAME,PREHEB,RESULTYR
            OPEN      RESHEBA1,RESFNAME
            PACK      RESFNAME,PREHEC,RESULTYR
            OPEN      RESHECA1,RESFNAME
            PACK      RESFNAME,PREHED,RESULTYR
            OPEN      RESHEDA1,RESFNAME
            PACK      RESFNAME,PREAEA,RESULTYR
            OPEN      RESAUDA1,RESFNAME
            PACK      RESFNAME,PREDEA,RESULTYR
            OPEN      RESDEAA1,RESFNAME
          ENDIF
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
.
          PACK      KEY40,RESULTKY,SP70
          CALL      RSREAU1
          CALL      RKREAU1
.
          STRIP     WBTPFIL  *  Template
          MOVE      TESTCODE,KEY32
          STRIP     KEY32
          REP       " -",KEY32
          REP       "\ ",TESTLINE
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"ProcedureRequest#",":
                    " #"id#" : #"",FHRDIRID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}";
.
          MOVE      REAUUID,KEY10
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;*+," ,{#"url#" : #"%BASEURL/extension/dxc-hc-createdby#",":
                      "  #"valueReference#" : { ":
                      "  #"reference#": #"Practitioner/User-",REAUUID,"#",":
                      "  #"display#": #"",WBSENAM,"#" }}";
          ENDIF
.
          PACK      KEY19,RESULTKY,SP70
          CALL      RSREHC1
RESPRQ10  CALL      RKREHC1
          BRANCH    OVRCD,RESPRQ20
          PACK      KEY17,REHCRDT,REHCRTM,REHCRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESPRQ20 IF NOT EQUAL
.
          MOVE      SP70,KEY6
          MOVE      REHCCTO,KEY10         * reference
          SCAN      "^",KEY10
          IF        @EQUAL
            RESET     KEY10
            MOVE      KEY10,KEY6
          ELSE
            RESET     KEY10
          ENDIF
.
          SCAN      "^",REHCCTO
          MOVEFPTR  REHCCTO,LENGTH
          ADD       ONE,LENGTH
          RESET     REHCCTO,LENGTH
          PACK      KEY50,REHCCTO,SP70    * display
.
          WRITE     HTMLFILE;*+," ,{#"url#" : #"%BASEURL/extension/dxc-hc-copyto#",":
                    "  #"valueReference#" : { ";
.
          MATCH     SP70,KEY6
          IF        @EQUAL
            WRITE     HTMLFILE;*+,"  #"reference#": #"Practitioner/HCP-",KEY10,"#",";
          ELSE
            WRITE     HTMLFILE;*+,"  #"reference#": #"Practitioner/HCP-",KEY6,"#",";
          ENDIF
.
          WRITE    HTMLFILE;*+,"  #"display#": #"",KEY50,"#" }}";
.
          GOTO      RESPRQ10
.
RESPRQ20  MOVE      REHAPOR,KEY7
          WRITE     HTMLFILE;*+," ],":
                    " #"requisition#":  { #"value#": #"",KEY7,"#" }, ":
                    " #"identifier#": [  ":
                    "  { #"type#": { ":
                    "     #"coding#": [ { ":
                    "      #"system#": #"http://hl7.org/fhir/identifier-type#", ":
                    "      #"code#": #"PLAC#" } ], ":
                    "    #"text#": #"Placer#" }, ":
                    "    #"value#": #"",REHAPOR,"#"":
                    "  }";
          MATCH     REHAPOR,REHAFOR  * Populated with same value until a response from the Lab
          IF        !@EQUAL
            WRITE     HTMLFILE;*+," ,{ #"type#": { ":
                      "     #"coding#": [ { ":
                      "      #"system#": #"http://hl7.org/fhir/identifier-type#", ":
                      "      #"code#": #"FILL#" } ], ":
                      "    #"text#": #"Filler#" }, ":
                      "    #"value#": #"",REHAFOR,"#"":
                      "  }";
          ENDIF
          MOVE      REHAPID,KEY8
          PACK      FHRENCID,KEY8,REHAVIS,SP70
          REP       " -",KEY8
          WRITE     HTMLFILE;*+," ],":
                    " #"context#":  { #"reference#" : #"Encounter/",FHRENCID,"#"}, ":
                    " #"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#"}, ":
                    " #"intent#" : #"order#",":
                    " #"status#" : #"",HLCODES,"#",":
                    " #"occurrenceDateTime#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                        "T",RELNRTM,":00",TIMEZONE,"#",":
                    " #"category#" : {":
                    "  #"coding#" : [":
                    "   { #"system#"  : #"http://snomed.info/sct#", ":
                    "     #"code#"    : #"103693007#",":
                    "     #"display#" : #"Diagnostic Procedure#" } ":
                    "  ] },":
                    " #"code#" : {":
                    "  #"coding#" : [":
                    "   { #"code#"      : #"",KEY32,"#",":
                    "     #"display#"   : #"",TESTLINE,"#" } ":
                    "  ] },":
                    " #"performer#" : [ {":
                    "  #"actor#" : [":
                    "   { #"reference#" : #"Location/Laboratory-",RECTLAB,"#",":
                    "     #"display#"   : #"",LABDESC,"#" } ":
                    "   ] } ],";
          STRIP     REHAOSN
          STRIP     REHAOGN
          UNPACK    REAUSDT,CCENT,CYEAR,CMON,CDAY
.
          WRITE     HTMLFILE;*+," #"authoredOn#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                    "T",REAUSTM,":00",TIMEZONE,"#",":
                    " #"requester#": { ":
                    "  #"agent#": { ":
                    "   #"reference#": #"Practitioner/HCP-",REHAOID,"#",":
                    "   #"display#": #"",REHAOSN,", ",REHAOGN,"#"":
                    "  } },":
                    " #"note#": [ { ":
                    "    #"text#": #"";
.
          MOVE      RESULTKY,KEY17
          CALL      RDREHD1    * Check Result on File
          IF        OVRCD=0
            WRITE     HTMLFILE;*+,REHDRCI,"\n";
          ENDIF
.
          MOVE      "routine",KEY15
          PACK      KEY20,RESULTKY,SP70
          CALL      RSREHB1
RESPRQ50  CALL      RKREHB1
          BRANCH    OVRCD,RESPRQ60
          PACK      KEY17,REHBRDT,REHBRTM,REHBRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESPRQ60 IF NOT EQUAL
          MATCH     "Priority: ",REHBTXT
          IF        @EQUAL
            UNPACK    REHBTXT,KEY10,KEY15
            GOTO      RESPRQ50
          ENDIF
          WRITE     HTMLFILE;*+,REHBTXT,"\n";
          GOTO      RESPRQ50
.
RESPRQ60  WRITE    HTMLFILE;*+,"#" }  ], ":
                    " #"priority#": #"",KEY15,"#" }";
          RETURN
+
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.---------------------------------
. FHIR Location Resource
.---------------------------------
RESLOC00  STRIP     RELBDES
          CLEAR     KEY16
          APPEND    "Laboratory-",KEY16
          APPEND    RELBLCD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": #"",RELBDES,"#"":
                    " } "
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Recorder
.------------------------------------------------------------------------------
RESPRA00  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            MOVE      SP70,DIM20
            MOVE      "w0",CATEGORY
            PACK      KEY5,CATEGORY,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          MATCH     SP70,WBSEDOC
          IF        !@EQUAL
            PACK      KEY10,WBSEDOC,SP70
          ELSE
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      KEY10,WBSEGPCD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            MOVE      SP70,TDESC
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCSPC1
              IF        !@EQUAL
                MOVE      "DT",KEY2
                PACK      KEY5,KEY2,PMHCSPC1,SP70
                CALL      RDCODE1
                IF        OVRCD=1
                  MOVE      SP70,TDESC
                ENDIF
              ENDIF
            ENDIF
            STRIP     KEY10
          ENDIF
.
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"User-",REAUUID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-role#"":
                        " ,#"valueString#":#"",DIM20,"#"}";
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{ #"url#": #"%BASEURL/extension/dxc-hc-hcp#"":
                                "  ,#"valueReference#" : #"Practitioner/HCP-",KEY10,"#"}";
          ENDIF
.
          MATCH     SP70,TDESC
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{#"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                                  ",#"valueString#" : #"",TDESC,"#"}";
          ENDIF
.
          WRITE     HTMLFILE;" ],":
                    " #"identifier#": {":
                    "   #"use#": #"official#",":
                    "   #"system#": #"%BASEURL#",":
                    "   #"value#": #"",WBSELOGN,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": [":
                    "{ #"use#": #"usual#",":
                    "  #"text#": #"",WBSENAM,"#",":
                    "  #"family#": #".#",":
                    "  #"given#": [#"",WBSENAM,"#"] ":
                    "} ]";
.
          MATCH     SP70,WBSEEMAI
          IF        !@EQUAL
             WRITE     HTMLFILE;*+,",";
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"email#",":
                       "  #"value#": #"",WBSEEMAI,"#" } ]";
          ENDIF
.
          WRITE     HTMLFILE;*+,"  } ";
.
RESPRA99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Practition Resource CopyTo
.------------------------------------------------------------------------------
RESASS00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAM00
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
RESASS99  RETURN
+
          INC       IBAWEBCD    
.
          INC       APSMASIO/INC
          INC       EMRSITIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATHSPIO/INC
          INC       OUTSITIO/INC
          INC       OUTCLIIO/INC
          INC       PATVISIO/INC
          INC       PATIN1IO/INC
          INC       PATNURIO/INC
          INC       PATPR1IO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PATMI1IO/INC
          INC       PATDO1IO/INC
          INC       PATWR1IO/INC
          INC       PATALRIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSCCDIO/INC       * Concession Card Details
          INC       PMSCEXIO/INC
          INC       PMSTLEIO/INC
          INC       PMSRELIO/INC
.
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       OBSPCTIO/INC       * Correspondence Storage Location Table
          INC       OBSPCOIO/INC
          INC       RESCLNIO/INC
          INC       RESERRIO/INC
          INC       RESLOGIO/INC
          INC       RESLABIO/INC
          INC       RESLURIO/INC
          INC       RESLNKIO/INC
          INC       RESPIDIO/INC
          INC       RESPHRIO/INC
          INC       RESPDSIO/INC
          INC       RESCTAIO/INC
          INC       RESHEAIO/INC
          INC       RESHEBIO/INC
          INC       RESHECIO/INC
          INC       RESHEDIO/INC
          INC       RESDEAIO/INC
          INC       RESDEBIO/INC
          INC       RESDECIO/INC
          INC       RESAUDIO/INC
          INC       PATFN1IO/INC
          INC       MRTMASIO/INC
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATWRDTM
          INC       DAYOFWEK
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       FHRDATCD
          INC       MRTLOCIO/INC
          INC       SCRMASIO/INC
          INC       HL7CODIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS 
.
