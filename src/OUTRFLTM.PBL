. *----------------------------------------------------------------------
. * Include Name  :   OUTRFLTM.PBL
. *
. * Function      :   Standard tags for OUTRF1FD - outrf1af
. *
. * Modifications :   
. *----------------------------------------------------------------------
. *   V11.05.02 20.12.2024 DA Sarkies      TSK 0954547
. *             Commented out <cat> tags to prevent browser incompatibility
. *   V11.05.01 26.11.2024  Ebon Clements  Task 0954547
. *             Added <cat-c> start and end tag to category=XX tag
. *   V10.12.01 19/04/2018  Thanh Tieu          Task 0851975
. *             Changed for triage status enhancement. Added codes to
. *             output the triage status description TRGSDESC to show on 
. *             various templates.
. *   V10.11.01 08/08/2017  Thanh T.             TSK 0821710
. *             Audit admission/outpatient/UR comments.
. *----------------------------------------------------------------------
. *   V10.06.02 11/08/2015  Ania P               CAR 319861
. *             Fixed multiple variables' output to trim spaces
. *   V10.06.01 20/04/2015  Ebon Clements        CAR 315691
. *             Fixed clinic id display on referral letter list - PATREF00
. *   V10.05.01 21/10/2014  Ebon Clements        CAR 268970
. *             Change to use OUTCLIFD index 1 instead of index 2
. *   V10.02.01 13/05/2011  Ebon Clements        CAR 240720
. *             Added requested appointment tags - OTAR0000
. *   V9.11.01  27/11/2008  Jill Habasque        CAR 167148
. *             Added PALREF00 - output allied health referrals
. *   V9.11.01  27/11/2008  Jill Habasque        CAR 167148
. *             Added PALREF00 - output allied health referrals
. *   V9.09.01  03/07/2007  Ebon Clements        CAR 14355
. *             Added FLTRRFGP - for referring gp filter
. *   V9.08.01  15/05/2007  Ebon Clements        CAR 131843
. *             Added referring gp and practice to PATREF00
. *   V9.05.B02 14/20/2006  Ebon Clements        CAR 71116
. *             Added tags for updated and created by
. *   V9.05.B01 11/01/2006  Peter Vela           CAR 89639
. *             Removed single quotes ' from OTRLDIAG and DOCFNAME in PATREF30
. *             Table of Referrals for a U/R 
. *    V9.04.03 31/03/2005  Jill Habasque        CAR 59996
. *             Added claim code
. *    V9.04.02 11/02/2005  Ebon Clements        CAR 56676
. *             Added option for allied health referral tags
. *    V9.04.01 12/01/2005  Ebon Clements        CAR 56397
. *             Added status filter for cancelled referrals
. *    V9.04.00 07/01/2005  Ebon Clements        CAR 54653
. *             Added date filter to referral letter list
. *    V9.03.09 23/04/2004  Peter Vela           CAR 48456
. *             Only display Outpatient letters in WRTREF00 (outweb0105001.html)
. *             Referral Letter List
. *    V9.03.08 14/04/2004  Sylvek Litewka       CAR 48981
. *             Modified procedure PATREF00 to use OTRLRDOC and OTRLDIAG fields
. *             for 'PassLetterToParent()' javascript function.
. *    V9.03.07 12/02/2004  Ebon Clements        CAR 47409
. *             Changed BSLCTY00 and ASLCTY00 to not display inactive
. *             clinic types
. *    V9.03.06 11/02/2004 Sylvek Litewka    CAR 47058
. *             Modified procedure PATREF00 to output 'Date Referral Received'
. *             field - OTRLDREC.
. *    V9.03.05 22/01/2004 Ebon Clements     CAR 46902
. *             Fixed GENPCODE allocation in ORFL2900
. *    V9.03.04 15/12/2003 Ebon Clements     CAR 45553
. *             Changed referral list to display a status of cancelled
. *             if there is a cancellation date
. *    V9.03.03 15/12/2003 Ebon Clements     CAR 45551
. *             Changed referral lists to display cancelled status
. *    V9.03.02 12/12/2003 Ebon Clements     CAR 45478
. *             Changed OTRLCONS and OTRLCTYP to be site specific OTRLSITE
. *    V9.03.01 11/12/2003 Ebon Clements     CAR 45549
. *             Changed OTRLRDOC to use the HCP file
. *----------------------------------------------------------------------
.------------------------------------------------------------
.  Epsiode of Care Referral Details
.------------------------------------------------------------
ORFL0000  BRANCH    FLDITMNO,ORFL0100,ORFL0200,ORFL0300,ORFL0400,ORFL0500:
                             ORFL0600,ORFL0700,ORFL0800,ORFL0900,ORFL1000:  
                             ORFL1100,ORFL1200,ORFL1300,ORFL1400,ORFL1500:  
                             ORFL1600,ORFL1700,ORFL1800,ORFL1900,ORFL2000:  
                             ORFL2100,ORFL2200,ORFL2300,ORFL2400,ORFL2500:  
                             ORFL2600,ORFL2700,ORFL2800,ORFL2900,ORFL3000:  
                             ORFL3100,ORFL3200,ORFL3300,ORFL3400,ORFL3500:
                             ORFL3600,ORFL3700,ORFL3800,ORFL3900,ORFL4000:
                             ORFL4100,ORFL4200,ORFL4300,ORFL4400,ORFL4500:
                             ORFL4600,ORFL4700,ORFL4800,ORFL4900,ORFL5000:
                             ORFL5100,ORFL5200,ORFL5300,ORFL5400,ORFL5500:
                             ORFL5600,ORFL5700,ORFL5800,ORFL5900,ORFL6000:
                             ORFL6100,ORFL6200,ORFL6300,ORFL6400,ORFL6500

          GOTO      ORFL9999
.
ORFL0100  MATCH     SP70,OTRLDATE
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;  * Date of Letter
          GOTO      ORFL9999
.
ORFL0200  PACK      GENPCODE,OTRLRDOC,SP70   * Referring HCP
          CALL      HCPDET00    
          GOTO      ORFL9999
.
ORFL0300  UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          BRANCH    F1,ORFL0310,ORFL0320
          PACK      KEY6,OTRLSITE,SP70  
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,ORFL9999
          WRITE     HTMLFILE;OSTDESC;        * Descprition 
          GOTO      ORFL9999
ORFL0310  WRITE     HTMLFILE;OTRLSITE;       * Code 
          GOTO      ORFL9999
ORFL0320  MOVE      OTRLSITE,SITECODE       
          CALL      SELSIT00                 * Options
          GOTO      ORFL9999
.
ORFL0400  UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
.
          MATCH     SP70,OTRLSITE            * No site so use standard file
          IF        @EQUAL
            MOVE      WBSESIT,OTRLSITE
            GOTO      ORFL0409
          ENDIF
.
          PACK      KEY6,OTRLSITE,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,ORFL0409
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME 
          ENDIF
.
ORFL0409  BRANCH    F1,ORFL0410,ORFL0420
          PACK      KEY20,OTRLSITE,OTRLCONS,Z70 * Read Referreal Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1    
          BRANCH    OVRCD,ORFL0450
.
          WRITE     HTMLFILE;OCADESC;        * Descprition 
          GOTO      ORFL0450
.
ORFL0410  WRITE     HTMLFILE;OTRLCONS;       * Code 
          GOTO      ORFL0450
.
ORFL0420  MOVE      OTRLCONS,CLNCID     
          CALL      ASLCLI00                 * Options
          GOTO      ORFL0450
.
ORFL0450  MATCH     SP70,WBSESIT
          IF        @EQUAL
            MOVE      "out",CFILEPRE
            GOTO      ORFL0460
          ENDIF
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read User Id Site Code File
          BRANCH    OVRCD,ORFL9999
.
ORFL0460  MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
          ENDIF
          GOTO      ORFL9999
.
ORFL0500  MOVE      "A ",CATEGORY       * Department
          MOVE      OTRLDEPT,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL0600  MATCH     SP70,OTRLDIAG
          GOTO      ORFL9999 IF EQUAL 
          STRIP     OTRLDIAG
          WRITE     HTMLFILE;*+,OTRLDIAG; * Diagnosis 
          GOTO      ORFL9999
.
ORFL0700  MOVE      "PR",CATEGORY       * Priority 
          MOVE      OTRLPRIO,CODE
          CALL      CODITM00 
          GOTO      ORFL9999
.
ORFL0800  MOVE      "L1",CATEGORY       * User Defined 1
          MOVE      OTRLUSD1,CODE 
          CALL      CODITM00 
          GOTO      ORFL9999
.
ORFL0900  MOVE      "L2",CATEGORY       * User Defined 2
          MOVE      OTRLUSD2,CODE
          CALL      CODITM00
          GOTO      ORFL9999 
.
ORFL1000  MOVE      "L3",CATEGORY       * User Defined 3
          MOVE      OTRLUSD3,CODE
          CALL      CODITM00
          GOTO      ORFL9999 
.
ORFL1100  MOVE      "L4",CATEGORY       * User Defined 4
          MOVE      OTRLUSD4,CODE
          CALL      CODITM00
          GOTO      ORFL9999 
.
ORFL1200  CALL      EPCOMT00            * Output Text Area Comment
          GOTO      ORFL9999
.
ORFL1300  PACK      GENPCODE,OTRLRFGP,SP70   * Referal HCP 
          CALL      HCPDET00            * Get HCP Details (PMSHCPTM)
          GOTO      ORFL9999
.
ORFL1400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ORFL1410 
.
          PACK      KEY12,OTRLGPPC,OTRLGPPT,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,ORFL9999
.
          WRITE     HTMLFILE;PMHGPNAM;  * Practice Name
          GOTO      ORFL9999        
.
ORFL1410  WRITE     HTMLFILE;OTRLGPPC;  * HCP Practice Code 
          GOTO      ORFL9999            
.
ORFL1500  MATCH     SP70,OTRLGPPT 
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLGPPT;  * HCP Practice Count 
          GOTO      ORFL9999
.
ORFL1600  MATCH     SP70,OTRLRQST 
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLRQST;  * Request Number 
          GOTO      ORFL9999
.
ORFL1700  MATCH     SP70,OTRLCDTE
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;  * Date of Letter
          GOTO      ORFL9999
.
ORFL1800  MOVE      "RQ",CATEGORY
          MOVE      OTRLREAS,CODE       * Reason for Request
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL1900  MOVE      "OF",CATEGORY       * Specialty Function Code
          MOVE      OTRLSPFC,CODE 
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL2000  MATCH     SP70,OTRLCAD1
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD1;  * Correspondance Address Line 1 
          GOTO      ORFL9999
.
ORFL2100  MATCH     SP70,OTRLCAD2
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD2;  * Correspondance Address Line 2 
          GOTO      ORFL9999
.
ORFL2200  MATCH     SP70,OTRLCAD3
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD3;  * Correspondance Address Line 3 
          GOTO      ORFL9999
.
ORFL2300  MATCH     SP70,OTRLCAD4
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCAD4;  * Correspondance Address Line 4 
          GOTO      ORFL9999
.
ORFL2400  MATCH     SP70,OTRLCPC 
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLCPC;   * Correspondance Post Code
          GOTO      ORFL9999
.
ORFL2500  MATCH     SP70,OTRLECRN
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLECRN;  * ECR Approval Number 
          GOTO      ORFL9999
.
ORFL2600  MATCH     SP70,OTRLGPFH
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLGPFH;  * GPFH Approval Number 
          GOTO      ORFL9999
.
ORFL2700  UNPACK    DIM127,D1,KEY1,DIM127    * Clinic Type of Referral
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,OTRLSITE            * No site so use standard file
          IF        @EQUAL
            MOVE      WBSESIT,OTRLSITE
            GOTO      ORFL2709
          ENDIF
.
          PACK      KEY6,OTRLSITE,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,ORFL2709
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
ORFL2709  BRANCH    F1,ORFL2710,ORFL2720
          PACK      KEY12,OTRLSITE,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
          BRANCH    OVRCD,ORFL2750
.
          WRITE     HTMLFILE;OCTDESC;        * Descprition
          GOTO      ORFL2750
.
ORFL2710  WRITE     HTMLFILE;OTRLCTYP;       * Code
          GOTO      ORFL2750 
.
ORFL2720  MOVE      OTRLCTYP,CLNCTYPE
          CALL      ASLCTY00
          GOTO      ORFL2750 
.
ORFL2750  MATCH     SP70,OTRLSITE
          GOTO      ORFL9999 IF EQUAL
.
          MATCH     SP70,WBSESIT
          IF        @EQUAL
            MOVE      "out",CFILEPRE
            GOTO      ORFL2760
          ENDIF
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read User Id Site Code File
          BRANCH    OVRCD,ORFL9999
.
ORFL2760  MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
          GOTO      ORFL9999
.
ORFL2800  MOVE      "S ",CATEGORY   * Source of Referral
          MOVE      OTRLSRCE,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL2900  PACK      GENPCODE,OTRLRHCP,SP70   * Responsible HCP
          CALL      HCPDET00                 * Get HCP Details
          GOTO      ORFL9999
.
ORFL3000  MATCH     SP70,OTRLDREC
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLDREC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;  * Date of Letter
          GOTO      ORFL9999
.
ORFL3100  MATCH     SP70,OTRLDPRI
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLDPRI,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;  * Date of Letter
          GOTO      ORFL9999
.
ORFL3200  MOVE      "HP",CATEGORY       * Expected Purchaser 
          MOVE      OTRLPURC,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL3300  MATCH     SP70,OTRLRANK
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLRANK;  * Patient Rank  
          GOTO      ORFL9999
.
ORFL3400  UNPACK    DIM127,D1,KEY1,DIM127  * Referral Type 0=Outpatient 1=Other
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ORFL3410
          IF        OTRLTREF = 0
            MOVE      "Outpatient",KEY10
          ELSE
            MOVE      "Other",KEY10
          ENDIF
          WRITE     HTMLFILE;KEY10;     * Desciption  
ORFL3410  WRITE     HTMLFILE;OTRLTREF;  * Code 
          GOTO      ORFL9999
.
ORFL3500  UNPACK    DIM127,D1,KEY1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      PATREF00            * Table of Referrals for a U/R
          GOTO      ORFL9999
.
ORFL3600  MATCH     SP70,OTRLOPER
          GOTO      ORFL9999 IF EQUAL
          PACK      KEY4,OTRLOPER,SP70
          CALL      RDPASS1
          BRANCH    OVRCD,ORFL9999
          WRITE     HTMLFILE;SECUSER;
          GOTO      ORFL9999
.
ORFL3700  UNPACK    DIM127,D1,KEY1,DIM127    * Booked Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ORFL3710,ORFL3720
          PACK      KEY6,OTRLBSIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,ORFL9999
          WRITE     HTMLFILE;OSTDESC;        * Descprition
          GOTO      ORFL9999
ORFL3710  WRITE     HTMLFILE;OTRLBSIT;       * Code
          GOTO      ORFL9999
ORFL3720  MOVE      OTRLBSIT,SITECODE
          CALL      SELSIT00                 * Options
          GOTO      ORFL9999
.
ORFL3800  UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,OTRLBSIT            * No site so use standard file
          IF        @EQUAL
            MOVE      WBSESIT,OTRLBSIT
            GOTO      ORFL3809
          ENDIF
.
          PACK      KEY6,OTRLBSIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,ORFL3809
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
          ENDIF
.
ORFL3809  BRANCH    F1,ORFL3810,ORFL3820
          PACK      KEY20,OTRLBSIT,OTRLBCLI,Z70  * Read Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1
          BRANCH    OVRCD,ORFL3850
.
          MATCH     OTRLBSIT,OCASITE         * Check same site   
          GOTO      ORFL3850 IF NOT EQUAL
.
          MATCH     OTRLBCLI,OCACLIN         * Check same clinic
          GOTO      ORFL3850 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;        * Descprition
          GOTO      ORFL3850
.
ORFL3810  WRITE     HTMLFILE;OTRLBCLI;       * Code
          GOTO      ORFL3850
.
ORFL3820  MOVE      OTRLBCLI,CLNCID
          CALL      BSLCLI00                 * Options
          GOTO      ORFL3850
.
ORFL3850  MATCH     SP70,WBSESIT
          IF        @EQUAL
            MOVE      "out",CFILEPRE
            GOTO      ORFL3860
          ENDIF
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read User Id Site Code File
          BRANCH    OVRCD,ORFL9999
.
ORFL3860  MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
          ENDIF
          GOTO      ORFL9999
.
ORFL3900  MATCH     SP70,OTRLBDTE
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLBDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      ORFL9999
.
ORFL4000  MATCH     SP70,OTRLBSTR
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLBSTR;
          GOTO      ORFL9999
.
ORFL4100  MATCH     SP70,OTRLBSLT
          GOTO      ORFL9999 IF EQUAL
          WRITE     HTMLFILE;OTRLBSLT;
          GOTO      ORFL9999
.
ORFL4200  MOVE      ZERO,CHECKDAT
          UNPACK    DIM127,D1,CHECKDAT,DIM127    * Outpatient Site
.
          PACK      FLTRCLID,FLTRCLID,SP70
          MATCH     SP70,FLTRCLID
          GOTO      ORFL4210 IF NOT EQUAL
.
          PACK      FLTRCTYP,FLTRCTYP,SP70
          MATCH     SP70,FLTRCTYP
          GOTO      ORFL4220 IF NOT EQUAL
.
          GOTO      ORFL9999
.
ORFL4210  MATCH     "1",CHECKDAT 
          IF        @EQUAL
            PACK      KEY22,FLTRCLID,FRSTDATE,SP70     * Search by Clinic Id
          ELSE
            PACK      KEY22,FLTRCLID,SP70     * Search by Clinic Id
          ENDIF
.
          CALL      RSOTRFL5
ORFL4211  CALL      RKOTRFL5
          BRANCH    OVRCD,ORFL9999          * Check for end of file
.
          MATCH     OTRLCONS,FLTRCLID       * Check if required Clinic Id
          GOTO      ORFL9999 IF NOT EQUAL
.
          MATCH     "1",CHECKDAT  
          IF        @EQUAL
            MATCH     OTRLDATE,LASTDATE       * Check referral date
            GOTO      ORFL9999 IF LESS
          ENDIF
.
          PACK      FLTRCTYP,FLTRCTYP,SP70
          MATCH     SP70,FLTRCTYP           * Filter by Clinic Type
          IF        !@EQUAL
            MATCH     OTRLCTYP,FLTRCTYP
            GOTO      ORFL4211 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRPRIO,FLTRPRIO,SP70
          MATCH     SP70,FLTRPRIO           * Filter by priority
          IF        !@EQUAL
            MATCH     OTRLPRIO,FLTRPRIO
            GOTO      ORFL4211 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRRFGP,FLTRRFGP,SP70
          MATCH     SP70,FLTRRFGP           * Filter by referring gp
          IF        !@EQUAL
            MATCH     OTRLRFGP,FLTRRFGP
            GOTO      ORFL4211 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRDCDE,FLTRDCDE,SP70
          MATCH     SP70,FLTRDCDE           * Filter by Doctor Code
          IF        !@EQUAL
            MATCH     OTRLRDOC,FLTRDCDE
            GOTO      ORFL4211 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRTRGS,FLTRTRGS,SP70
          MATCH     SP70,FLTRTRGS           * Filter by triage status
          IF        !@EQUAL
            MATCH     OTRLTRGS,FLTRTRGS
            GOTO      ORFL4211 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRSTAT,FLTRSTAT,SP1
          MATCH     SP70,FLTRSTAT           * Filter by status
          IF        !@EQUAL
            MATCH     "0",FLTRSTAT           
            GOTO      ORFL4212 IF EQUAL     * Process unbooked
            MATCH     "1",FLTRSTAT           
            GOTO      ORFL4213 IF EQUAL     * Process booked
            GOTO      ORFL4214              * Process cancelled
          ENDIF
.
          GOTO      ORFL4215                * Write record      
.
ORFL4212  MATCH     SP70,OTRLBSIT           * Checking for unbooked
          IF        @EQUAL
            MATCH     SP70,OTRLCDTE         * Skip cancelled
            GOTO      ORFL4211 IF NOT EQUAL
            GOTO      ORFL4215              * Record unbooked, write
          ENDIF
          GOTO      ORFL4211                * Record booked, get next record
.
ORFL4213  MATCH     SP70,OTRLBSIT           * Checking for booked
          GOTO      ORFL4215 IF NOT EQUAL   * Record booked, write
          GOTO      ORFL4211                * Record unbboked, get next record
.
ORFL4214  MATCH     SP70,OTRLCDTE           * Checking for cancelled
          GOTO      ORFL4215 IF NOT EQUAL   * Record cancelled, write
          GOTO      ORFL4211                * Record not canc get next record
.
ORFL4215  CALL      WRTREF00
          GOTO      ORFL4211
.
ORFL4220  MATCH     "1",CHECKDAT
          IF        @EQUAL
            PACK      KEY22,FLTRCTYP,FRSTDATE,SP70     * Search by Clinic Type
          ELSE
            PACK      KEY22,FLTRCTYP,SP70     * Search by Clinic Type
          ENDIF
.
          CALL      RSOTRFL7
ORFL4221  CALL      RKOTRFL7
          BRANCH    OVRCD,ORFL9999          * Check for end of file
.
          MATCH     OTRLCTYP,FLTRCTYP       * Check if required Clinic Type
          GOTO      ORFL9999 IF NOT EQUAL
.
          MATCH     "1",CHECKDAT
          IF        @EQUAL
            MATCH     OTRLDATE,LASTDATE       * Check referral date
            GOTO      ORFL9999 IF LESS
          ENDIF
.
          PACK      FLTRPRIO,FLTRPRIO,SP70
          MATCH     SP70,FLTRPRIO           * Filter by priority
          IF        !@EQUAL
            MATCH     OTRLPRIO,FLTRPRIO
            GOTO      ORFL4221 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRRFGP,FLTRRFGP,SP70
          MATCH     SP70,FLTRRFGP           * Filter by Referring gp
          IF        !@EQUAL
            MATCH     OTRLRFGP,FLTRRFGP
            GOTO      ORFL4221 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRDCDE,FLTRDCDE,SP70
          MATCH     SP70,FLTRDCDE           * Filter by Doctor Code
          IF        !@EQUAL
            MATCH     OTRLRDOC,FLTRDCDE
            GOTO      ORFL4221 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRTRGS,FLTRTRGS,SP70
          MATCH     SP70,FLTRTRGS           * Filter by triage status
          IF        !@EQUAL
            MATCH     OTRLTRGS,FLTRTRGS
            GOTO      ORFL4221 IF NOT EQUAL * No Match, get next record
          ENDIF
.
          PACK      FLTRSTAT,FLTRSTAT,SP1
          MATCH     SP70,FLTRSTAT           * Filter by status
          IF        !@EQUAL
            MATCH     "0",FLTRSTAT
            GOTO      ORFL4222 IF EQUAL     * Process unbooked
            MATCH     "1",FLTRSTAT
            GOTO      ORFL4223 IF EQUAL     * Process booked
            GOTO      ORFL4224              * Process cancelled
          ENDIF
.
          GOTO      ORFL4225                * Write record
.
ORFL4222  MATCH     SP70,OTRLBSIT           * Checking for unbooked
          IF        @EQUAL
            MATCH     SP70,OTRLCDTE         * Skip cancelled
            GOTO      ORFL4221 IF NOT EQUAL
            GOTO      ORFL4225              * Record unbooked, write
          ENDIF
          GOTO      ORFL4221                * Record booked, get next record
.
ORFL4223  MATCH     SP70,OTRLBSIT           * Checking for booked
          GOTO      ORFL4225 IF NOT EQUAL   * Record booked, write
          GOTO      ORFL4221                * Record unbboked, get next record
.
ORFL4224  MATCH     SP70,OTRLCDTE           * Checking for cancelled
          GOTO      ORFL4225 IF NOT EQUAL   * Record booked, write
          GOTO      ORFL4221                * Record not canc get next record
.
ORFL4225  CALL      WRTREF00
          GOTO      ORFL4221
.
ORFL4300  PACK      FLTRCTYP,FLTRCTYP,SP70
          UNPACK    DIM127,D1,KEY1,DIM127    * Clinic Type of Referral
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ORFL4310,ORFL4320
          PACK      KEY12,WBSESIT,FLTRCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
          BRANCH    OVRCD,ORFL9999
          WRITE     HTMLFILE;OCTDESC;        * Descprition
          GOTO      ORFL9999
ORFL4310  WRITE     HTMLFILE;FLTRCTYP;       * Code
          GOTO      ORFL9999
ORFL4320  MOVE      FLTRCTYP,CLNCTYPE
          CALL      BSLCTY00
          GOTO      ORFL9999
.
ORFL4400  PACK      FLTRCLID,FLTRCLID,SP70
          UNPACK    DIM127,D1,KEY1,DIM127    * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ORFL4410,ORFL4420
.
          PACK      KEY20,WBSESIT,FLTRCLID,Z70       * Read Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1
          BRANCH    OVRCD,ORFL9999
.
          MATCH     WBSESIT,OCASITE          * Check same site  
          GOTO      ORFL9999 IF NOT EQUAL
.
          MATCH     FLTRCLID,OCACLIN         * Check same clinic
          GOTO      ORFL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;        * Descprition
          GOTO      ORFL9999
.
ORFL4410  WRITE     HTMLFILE;FLTRCLID;       * Code
          GOTO      ORFL9999
.
ORFL4420  MOVE      FLTRCLID,CLNCID    
          CALL      CSLCLI00                 * Options
          GOTO      ORFL9999
.
ORFL4500  MOVE      "PR",CATEGORY
          MOVE      FLTRPRIO,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL4600  MOVE      FLTRDCDE,DOCTCODE  
          CALL      DOCDET00            * Get Doctor Details
          GOTO      ORFL9999
.
ORFL4700  MATCH     "0",FLTRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"","0","#" selected>":
                               "Unbooked","</option>"
          ELSE  
            WRITE     HTMLFILE;"<option value=#"","0","#">":
                               "Unbooked","</option>"
          ENDIF
.
          MATCH     "1",FLTRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"","1","#" selected>":
                               "Booked","</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"","1","#">":
                               "Booked","</option>"
          ENDIF
.
          MATCH     "2",FLTRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"","2","#" selected>":
                               "Cancelled","</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"","2","#">":
                               "Cancelled","</option>"
          ENDIF
.
          GOTO      ORFL9999
.
ORFL4800  CALL      OTHREF00            * Table of Other Referrals for a U/R
          GOTO      ORFL9999
.
ORFL4900  CALL      REFLNX00
          GOTO      ORFL9999
.
ORFL5000  CALL      REFLPR00
          GOTO      ORFL9999
.
ORFL5100  CALL      SELV0000
          GOTO      ORFL9999
.
ORFL5200  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ORFL9999
.
ORFL5300  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      ALRE0000                * Allied Health Referral File
          GOTO      ORFL9999
.
ORFL5400  MOVE      "CL",CATEGORY   * Claim code
          MOVE      OTRLCLAM,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL5500  MATCH     OTRLUDAT,SP70
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR; 
          GOTO      ORFL9999
.
ORFL5600  WRITE     HTMLFILE;OTRLUTIM;
          GOTO      ORFL9999
.
ORFL5700  MATCH     SP70,OTRLUUID
          GOTO      ORFL9999 IF EQUAL
          PACK      KEY10,OTRLUUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      OTRLUUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      ORFL9999
.
ORFL5800  MATCH     OTRLCDAT,SP70
          GOTO      ORFL9999 IF EQUAL
          UNPACK    OTRLCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ORFL9999
.
ORFL5900  WRITE     HTMLFILE;OTRLCTIM;
          GOTO      ORFL9999
.
ORFL6000  MATCH     SP70,OTRLCUID
          GOTO      ORFL9999 IF EQUAL
          PACK      KEY10,OTRLCUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      OTRLCUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      ORFL9999
.
ORFL6100  PACK      GENPCODE,FLTRRFGP,SP70   * Referring GP filter
          CALL      HCPDET00
          GOTO      ORFL9999
.
ORFL6200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OTAR0000                * Requested Appointment File  
          GOTO      ORFL9999
.
ORFL6300  MOVE      OTRLTRGS,CODE                * Triage status otpion
          CALL      TRGSEL0000                   * no code selected  
          GOTO      ORFL9999
.
ORFL6400  MOVE      "ts",CATEGORY
          MOVE      OTRLTRGS,CODE
          CALL      CODITM00
          GOTO      ORFL9999
.
ORFL6500  MOVE      FLTRTRGS,CODE                * Triage status filter
          CALL      TRGSEL0000
          GOTO      ORFL9999
.
ORFL9999  RETURN
.
.----------------------------------------------------------------------
. Selection options for triage status with active and indicator 2 = "O'
.----------------------------------------------------------------------
TRGSEL00  MOVE      SP70,TDESC
          MOVE      "ts",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
TRGSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,TRGSEL99
          MATCH     CATEGORY,TCODE
          GOTO      TRGSEL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      TRGSEL10 IF EQUAL
.
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV
.
          MATCH     CODE,ACODE
          IF        @EQUAL
            MATCH     ANSI,PTCOACTV               * Display active only
            GOTO      TRGSEL10 IF EQUAL
.
            MATCH     ANSO,TCINDC2                * Match indicator 2
            GOTO      TRGSEL10 IF NOT EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,KEY40,"#" selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     ANSI,PTCOACTV               * Display active only
            GOTO      TRGSEL10 IF EQUAL
.
            MATCH     ANSO,TCINDC2                * Match indicator 2
            GOTO      TRGSEL10 IF NOT EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,KEY40,"#">",TDESC:
                               "</option>"
          ENDIF
.
          GOTO      TRGSEL10
.
TRGSEL99  RETURN
.
.----------------------------------------------------------------------
. Show Patient Referral
.----------------------------------------------------------------------
PATREF00  PACK      KEY24,URNUMBER,SP70
          CALL      RSOTRFL2
PATREF10  CALL      RKOTRFL2
          BRANCH    OVRCD,PATREF90
          MATCH     OTRLURNO,URNUMBER
          GOTO      PATREF90 IF NOT EQUAL
          COMPARE   ZERO,OTRLTREF
          GOTO      PATREF10 IF NOT EQUAL
.
          MOVE      ZERO,BSTATUS
          MOVE      "Unbooked",BSTATDSC
.
          MATCH     SP70,OTRLCDTE           * Cancelled letters
          IF        !@EQUAL
            IF        LSTUNBFL=1
              GOTO      PATREF10            * List unbooked letters only
            ENDIF              
            MOVE      ZERO,BSTATUS
            MOVE      "Cancelled",BSTATDSC
            GOTO      PATREF12
          ENDIF
.
          MATCH     SP70,OTRLBSIT
          IF        !@EQUAL
            IF        LSTUNBFL=1
              GOTO      PATREF10            * List unbooked letters only
            ENDIF              
            MOVE      ONE,BSTATUS
            MOVE      "Booked",BSTATDSC
          ENDIF
.
PATREF12  MOVE      "PR",CATEGORY
          MOVE      OTRLPRIO,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MATCH     SP70,OTRLSITE
          IF        @EQUAL
            MOVE      WBSESIT,OTRLSITE
            GOTO      PATREF15 IF EQUAL
          ENDIF
.
          MATCH     SP70,OTRLSITE
          GOTO      PATREF15 IF EQUAL
.
          PACK      KEY6,OTRLSITE,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PATREF15
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.   
PATREF15  PACK      KEY20,OTRLSITE,OTRLCONS,Z70      * Read Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1
          IF        OVRCD<>1
            MATCH     OTRLSITE,OCASITE
            IF        @EQUAL
              MATCH     OTRLCONS,OCACLIN
              GOTO      PATREF17 IF EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,OCADESC
.         
PATREF17  MOVE      SP70,OCTDESC
          PACK      KEY12,OTRLSITE,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
.
          MATCH     SP70,OTRLSITE            * If site files changed
          GOTO      PATREF20 IF EQUAL        * restore the correct user files
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PATREF20
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
PATREF20  MOVE      SP70,KEY11
          MATCH     SP70,OTRLDREC
          GOTO      PATREF30 IF EQUAL
.
          UNPACK    OTRLDREC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PATREF30  MOVE      SP70,KEY60
          PACK      KEY10,OTRLRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY60
            STRIP     KEY60
          ENDIF
.
          MOVE      SP70,KEY80
          PACK      KEY12,OTRLGPPC,OTRLGPPT,SP70
          CALL      RDPMHCG1
          IF        OVRCD=0
            MOVE      PMHGPNAM,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY80
          ENDIF
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,OTRLRDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY50
            STRIP     KEY50
          ENDIF
.
          MOVE      OTRLDIAG,JAVSNAME
          CALL      JAVDES00
.
          CLEAR     REFLINK
          IF        LSTUNBFL=1
            APPEND    "javascript:PassLetterToParent('",REFLINK
            APPEND    OTRLOUTN,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLPRIO,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLRDOC,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY50,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY11,REFLINK
            APPEND    "','",REFLINK
            APPEND    JAVSNAME,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLCLAM,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLRFGP,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY60,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLGPPC,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY80,REFLINK
            APPEND    "','",REFLINK
            APPEND    OTRLGPPT,REFLINK
            APPEND    "');",REFLINK
          ELSE
            APPEND    "javascript:ReferralLink('",REFLINK
            APPEND    OTRLOUTN,REFLINK
            APPEND    "',",REFLINK
            APPEND    BSTATUS,REFLINK
            APPEND    ");",REFLINK
          ENDIF
          RESET     REFLINK
.
          MOVE      "ts",CATEGORY
          MOVE      OTRLTRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",REFLINK,"#",":
                             "#"",OTRLDATE,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",PRIODESC,"#",":
                             "#"",OTRLDIAG,"#",":
                             "#"",BSTATUS,"#",":
                             "#"",BSTATDSC,"#",":
                             "#"",KEY60,"#",":
                             "#"",KEY80,"#",":
                             "#"",TRGSDESC,"#");"
.
          GOTO      PATREF10
.
PATREF90  IF        F1=1
            CALL      PALREF00
          ENDIF
.
PATREF99  RETURN
.
PALREF00  PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
PALREF10  CALL      RPALREF2 
          BRANCH    OVRCD,PALREF99
.
          MATCH     ALREURNO,URNUMBER
          GOTO      PALREF99 IF NOT EQUAL
.
          MOVE      ZERO,BSTATUS
          MOVE      "Unbooked",BSTATDSC
.
          MATCH     "0",ALRESTAT
          GOTO      PALREF20 IF EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      PALREF20 IF EQUAL
          GOTO      PALREF10
.
PALREF12  MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MATCH     SP70,ALREPSIT
          IF        @EQUAL
            MOVE      WBSESIT,ALREPSIT
            GOTO      PALREF15
          ENDIF
.
          MATCH     SP70,ALREPSIT
          GOTO      PALREF15 IF EQUAL
.
          PACK      KEY6,ALREPSIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PALREF15
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
PALREF15  MOVE      SP70,OCADESC
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,PALREF18
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      PALREF18
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
PALREF18  MATCH     SP70,OTRLSITE            * If site files changed
          GOTO      PALREF20 IF EQUAL        * restore the correct user files
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PALREF20
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
PALREF20  MOVE      SP70,KEY11
          MATCH     SP70,ALREDREC
          GOTO      PALREF30 IF EQUAL
.
          UNPACK    ALREDREC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PALREF30  MOVE      SP70,KEY60
          PACK      KEY10,ALRERDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY60
            STRIP     KEY60
          ENDIF
.
          MOVE      SP70,KEY80
          PACK      KEY12,ALRERHCR,ALRERHCT,SP70
          CALL      RDPMHCG1
          IF        OVRCD=0
            MOVE      PMHGPNAM,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY80
          ENDIF
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY50
            STRIP     KEY50
          ENDIF
.
          MOVE      OTRLDIAG,JAVSNAME
          CALL      JAVDES00
.
          CLEAR     REFLINK
          IF        LSTUNBFL=1
            APPEND    "javascript:PassLetterToParent('",REFLINK
            APPEND    ALREVISN,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALREPRTY,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALRERDOC,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY50,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY11,REFLINK
            APPEND    "','",REFLINK
            APPEND    JAVSNAME,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALRECOMP,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALRERHCP,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY60,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALRERHCR,REFLINK
            APPEND    "','",REFLINK
            APPEND    KEY80,REFLINK
            APPEND    "','",REFLINK
            APPEND    ALRERHCT,REFLINK
            APPEND    "');",REFLINK
          ELSE
            APPEND    "javascript:ReferralLink('",REFLINK
            APPEND    ALREVISN,REFLINK
            APPEND    "',",REFLINK
            APPEND    BSTATUS,REFLINK
            APPEND    ");",REFLINK
          ENDIF
          RESET     REFLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",REFLINK,"#",":
                             "#"",ALREDACT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",PRIODESC,"#",":
                             "#"",ALREDIAT,"#",":
                             "#"",BSTATUS,"#",":
                             "#"",BSTATDSC,"#",":
                             "#"",KEY60,"#",":
                             "#"",KEY80,"#");"
.
          GOTO      PALREF10
.
PALREF99  RETURN
.----------------------------------------------------------------------
. Show Patient's Other Referrals
.----------------------------------------------------------------------
OTHREF00  PACK      KEY24,URNUMBER,SP70
          CALL      RSOTRFL2
OTHREF10  CALL      RKOTRFL2
          BRANCH    OVRCD,OTHREF99
          MATCH     OTRLURNO,URNUMBER
          GOTO      OTHREF99 IF NOT EQUAL
          COMPARE   ONE,OTRLTREF
          GOTO      OTHREF10 IF NOT EQUAL
.
          MOVE      "Other",BSTATDSC
.
          MOVE      "PR",CATEGORY
          MOVE      OTRLPRIO,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MATCH     SP70,OTRLSITE
          IF        @EQUAL
            MOVE      WBSESIT,OTRLSITE
            GOTO      OTHREF15
          ENDIF
.
          MATCH     SP70,OTRLSITE
          GOTO      OTHREF15 IF EQUAL
.
          PACK      KEY6,OTRLSITE,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,OTHREF15
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
OTHREF15  MOVE      SP70,OCADESC
          PACK      KEY20,OTRLSITE,OTRLCONS,Z70     * Read Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1
.
          MOVE      SP70,OCTDESC
          PACK      KEY12,OTRLSITE,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
.
          MATCH     SP70,OTRLSITE            * If site files changed
          GOTO      OTHREF19 IF EQUAL        * restore the correct user files
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,OTHREF19
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
OTHREF19  MOVE      SP70,DOCFNAME            * Get name of the Referring GP
          MATCH     SP70,OTRLRFGP
          GOTO      OTHREF20 IF EQUAL
          PACK      KEY10,OTRLRFGP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,OTHREF20
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
OTHREF20  CLEAR     REFLINK
          APPEND    "javascript:ReferralLink('",REFLINK
          APPEND    OTRLOUTN,REFLINK
          APPEND    "');",REFLINK
          RESET     REFLINK
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,OTRLRDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",REFLINK,"#",":
                             "#"",OTRLDATE,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",PRIODESC,"#",":
                             "#"",OTRLDIAG,"#",":
                             "#"",BSTATDSC,"#");"
.
          GOTO      OTHREF10
.
OTHREF99  RETURN
.----------------------------------------------------------------------
. Show Referral
.----------------------------------------------------------------------
WRTREF00  COMPARE   ZERO,OTRLTREF           * I-48456
          GOTO      WRTREF99 IF NOT EQUAL
.
          PACK      KEY8,OTRLURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      SP70,KEY60
          PACK      KEY10,OTRLRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,KEY60
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,DOCFNAME
          PACK      KEY10,OTRLRDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      ZERO,BSTATUS
          MOVE      "Unbooked",BSTATDSC
.
          MATCH     SP70,OTRLCDTE           * Cancelled letters
          IF        !@EQUAL
            MOVE      ZERO,BSTATUS
            MOVE      "Cancelled",BSTATDSC
            GOTO      WRTREF20
          ENDIF
.
          MATCH     SP70,OTRLBSIT
          IF        !@EQUAL
            MOVE      ONE,BSTATUS
            MOVE      "Booked",BSTATDSC
          ENDIF
.
WRTREF20  CLEAR     REFLINK
          APPEND    "javascript:ReferralLink('",REFLINK
          APPEND    OTRLURNO,REFLINK
          APPEND    "','",REFLINK
          APPEND    OTRLOUTN,REFLINK
          APPEND    "','",REFLINK
          APPEND    BSTATUS,REFLINK
          APPEND    "');",REFLINK
          RESET     REFLINK
.
          MOVE      "PR",CATEGORY
          MOVE      OTRLPRIO,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      SP70,OCADESC
          PACK      KEY20,WBSESIT,OTRLCONS,Z70       * Read Site Code File
          CALL      RDSCLIA1                 * Read for current Effective Date
          CALL      RDPCLIA1
.
          MOVE      SP70,OCTDESC
          PACK      KEY12,OTRLSITE,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
.
          MOVE      "ts",CATEGORY
          MOVE      OTRLTRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",REFLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",OTRLDATE,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",PRIODESC,"#",":
                             "#"",OTRLDIAG,"#",":
                             "#"",BSTATUS,"#",":
                             "#"",BSTATDSC,"#",":
                             "#"",KEY60,"#",":
                             "#"",TRGSDESC,"#");"
.
WRTREF99  RETURN
.------------------------------------------------------------
. Output Episode of Care Comment Text Area
.------------------------------------------------------------
EPCOMT00  PACK      KEY20,OTRLOUTN,VSCMTTYP,SP70
          CALL      RSVSMTX1
EPCOMT10  CALL      RKVSMTX1
          BRANCH    OVRCD,EPCOMT99
.
          MATCH     ADMISSNO,VSMTVISN
          GOTO      EPCOMT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMTTYPE
          GOTO      EPCOMT99 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,TXTLEN
.
          IF        TXTLEN >0
            SFORMAT   VAR,TXTLEN
          ELSE
            SFORMAT   VAR,ONE
          ENDIF
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR      * Line Details
          SFORMAT   VAR,70
.
          GOTO      EPCOMT10
.
EPCOMT99  RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
SELSIT00  PACK      KEY36,SP70
          CALL      RDSSITA2
SELSIT10  CALL      RDKSITA2
          BRANCH    OVRCD,SELSIT99
          MATCH     SITECODE,OSTSITE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OSTSITE,"#" selected>":
                               OSTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OSTSITE,"#">":
                               OSTDESC,"</option>"
          ENDIF
          GOTO      SELSIT10
.
SELSIT99  RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
ASLCLI00  PACK      KEY20,OTRLSITE,SP70
          CALL      RDSCLIA1
ASLCLI10  CALL      RDKCLIA1       
          BRANCH    OVRCD,ASLCLI99
.
          MATCH     OCASITE,OTRLSITE
          GOTO      ASLCLI99 IF NOT EQUAL
.
          MATCH     "1",OTCLIACT
          GOTO      ASLCLI10 IF EQUAL
          MATCH     CLNCID,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected>(":
                               OCACLIN,") ",OCADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#">(":
                               OCACLIN,") ",OCADESC,"</option>"
          ENDIF
          GOTO      ASLCLI10
.
ASLCLI99  PACK      KEY20,WBSESIT,CLINICID,Z70  * Get current Effective Clinic 
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
BSLCLI00  PACK      KEY20,OTRLBSIT,SP70
          CALL      RDSCLIA1
BSLCLI10  CALL      RDKCLIA1
          BRANCH    OVRCD,BSLCLI99
.
          MATCH     OCASITE,OTRLBSIT
          GOTO      BSLCLI99 IF NOT EQUAL
.
          MATCH     "1",OTCLIACT
          GOTO      BSLCLI10 IF EQUAL
          MATCH     CLNCID,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected>(":
                               OCACLIN,") ",OCADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#">(":
                               OCACLIN,") ",OCADESC,"</option>"
          ENDIF
          GOTO      BSLCLI10
.
BSLCLI99  PACK      KEY20,WBSESIT,CLINICID,Z70  * Get current Effective Clinic
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
CSLCLI00  PACK      KEY20,WBSESIT,SP70
          CALL      RDSCLIA1
CSLCLI10  CALL      RDKCLIA1
          BRANCH    OVRCD,CSLCLI99
.
          MATCH     OCASITE,WBSESIT
          GOTO      CSLCLI99 IF NOT EQUAL
.
          MATCH     "1",OTCLIACT
          GOTO      CSLCLI10 IF EQUAL
          MATCH     CLNCID,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected>(":
                               OCACLIN,") ",OCADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#">(":
                               OCACLIN,") ",OCADESC,"</option>"
          ENDIF
          GOTO      CSLCLI10
.
CSLCLI99  PACK      KEY20,WBSESIT,CLINICID,Z70  * Get current Effective Clinic
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          RETURN
.------------------------------------------------------------
. Clinic Type List
.------------------------------------------------------------
ASLCTY00  PACK      KEY42,OTRLSITE,SP70
          CALL      RDSCTYA2
ASLCTY10  CALL      RDKCTYA2
          BRANCH    OVRCD,ASLCTY99
          MATCH     OCTSITE,OTRLSITE
          GOTO      ASLCTY99 IF NOT EQUAL
.
          MATCH     CLNCTYPE,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>"
          ELSE
            MATCH     "1",OCTACT            * Do not display inactive records
            GOTO      ASLCTY10 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>"
          ENDIF
          GOTO      ASLCTY10
.
ASLCTY99  RETURN
.------------------------------------------------------------
. Clinic Type List
.------------------------------------------------------------
BSLCTY00  PACK      KEY42,WBSESIT,SP70
          CALL      RDSCTYA2
BSLCTY10  CALL      RDKCTYA2
          BRANCH    OVRCD,BSLCTY99
          MATCH     OCTSITE,WBSESIT  
          GOTO      BSLCTY99 IF NOT EQUAL
.
          MATCH     CLNCTYPE,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>"
          ELSE
            MATCH     "1",OCTACT            * Do not display inactive records
            GOTO      BSLCTY10 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>"
          ENDIF
          GOTO      BSLCTY10
.
BSLCTY99  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
REFLNX00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&fltrclid=",FLTRCLID:
                             "&fltrctyp=",FLTRCTYP:
                             "&fltrprio=",FLTRPRIO:
                             "&fltrtrgs=",FLTRTRGS:
                             "&fltrdcde=",FLTRDCDE:
                             "&fltrrfgp=",FLTRRFGP:
                             "&fltrstat=",FLTRSTAT;
.
REFLNX99  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
REFLPR00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&fltrclid=",FLTRCLID:
                             "&fltrctyp=",FLTRCTYP:
                             "&fltrprio=",FLTRPRIO:
                             "&fltrtrgs=",FLTRTRGS:
                             "&fltrrfgp=",FLTRRFGP:
                             "&fltrdcde=",FLTRDCDE:
                             "&fltrstat=",FLTRSTAT;
.
REFLPR99  RETURN
.------------------------------------------------------------
. Format Description/Name (for Javascript)
.*** format the surname and given name by changing any ' to %60
.---------------------------------------------------------------
JAVDES00  SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVDES99 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted string
.
JAVDES99  RETURN
