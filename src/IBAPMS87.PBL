.***************************************************************************
.* System    :   Patient                                                   *
.* Program   :   IBAPMS87                                                  *
.* Desc      :   Doctors Letters                                           *
.***************************************************************************
.* Date      :   16/10/2007                                                *
.* Author    :   Ebon Clements                                             *
.* Function  :   This program will select and print hcp letters            *
.***************************************************************************
.* Mods      :                                                             *
.*        V9.12.01  26/11/2009  Jill Parkinson CAR 211136                  *
.*                  Mods to not unpack into SP3                            *
.*               V9.11.01  04/05/2009  Saroeun Soeur  CAR 192418           *
.*                          Added DXCURDTN, current date no extension      *
.*               V9.09.00  16/10/2007  Ebon Clements  CAR 151931           *
.*           :             Created program                                 *
.***************************************************************************
.
          INC       STD001FD
.
. FILE DESCRIPTION INCLUDES
. -------------------------
          INC       IBACONFD/INC
          INC       MLTHCPFD/INC
          INC       NZPPTYFD/INC
          INC       PATCONFD/INC
          INC       PATCODFD/INC
          INC       PATDLTFD/INC
          INC       PMSDSLFD/INC
          INC       PMSDLTFD/INC
          INC       PMSHCPFD/INC
          INC       PATIN1FD/INC
.
. LOCAL VARIABLE DEFINITION
. -------------------------
.
BOTTMARG  FORM      3     * bottom margin
CATEGORY  DIM       2
CODE      DIM       3
COUNT     FORM      2
COUNTER   FORM      2
DATELINE  DIM       19
DEXT      DIM       3
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
DIM20     DIM       20
DIM55     DIM       55
DIM70     DIM       70
DISPSTRN  DIM       70
ENDSTR    FORM      2
FORM3     FORM      3
FORM3A    FORM      3
LEFTMARG  FORM      3             * left margin
LETTDATE  DIM       8         * letter date
LETTERCD  FORM      3
LINE      DIM       65
MLETPLEN  FORM      3             * length to print to
MONTH     DIM       9
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
PERCPOS   FORM      2
PHYSPAGE  FORM      3              * physical paper length
PRTSTRNG  DIM       70
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0"
TEMP2     FORM      2
TEMP3     FORM      3
TEMP55    DIM       55
TEMP70    DIM       70
TOPMARG   FORM      3             * top margin
SELECTID  DIM       4         * selection id
SPECCHAR  INIT      "%"
SRCHVAR   DIM       15
SRCHNUM   FORM      3
STARTSTR  FORM      2
WORKDATE  DIM       8
.
LCNOVARS  FORM      "99"
LCPAGE    INIT      "%page"     * 1 Page Break
LCHCHCPC  INIT      "%hcphcpc"  * 2 HCP Code
LCHCTITL  INIT      "%hcptitl"  * 3 HCP Title
LCHCGNAM  INIT      "%hcpgnam"  * 4 HCP Given Names
LCHCSNAM  INIT      "%hcpsnam"  * 5 HCP Surname
LCHCINIT  INIT      "%hcpinit"  * 6 HCP Initials
LCHCGNDR  INIT      "%hcpgndr"  * 7 HCP Gender (M,F,I,U)
LCHCDTOB  INIT      "%hcpdtob"  * 8 HCP Date of Birth (ccyymmdd)
LCHCSPC1  INIT      "%hcpspca"  * 9 HCP Speciality 1 (Cat DT)
LCHCSPD1  INIT      "%hcpspda"  * 10 HCP Speciality Date 1 (ccyymmdd)
LCHCSPC2  INIT      "%hcpspcb"  * 11 HCP Speciality 2 (Cat DT)
LCHCSPD2  INIT      "%hcpspdb"  * 12 HCP Speciality Date 2 (ccyymmdd)
LCHCSPC3  INIT      "%hcpspcc"  * 13 HCP Speciality 3 (Cat DT)
LCHCSPD3  INIT      "%hcpspdc"  * 14 HCP Speciality Date 3 (ccyymmdd)
LCHCSPC4  INIT      "%hcpspcd"  * 15 HCP Speciality 4 (Cat DT)
LCHCSPD4  INIT      "%hcpspdd"  * 16 HCP Speciality Date 4 (ccyymmdd)
LCHCSPC5  INIT      "%hcpspce"  * 17 HCP Speciality 5 (Cat DT)
LCHCSPD5  INIT      "%hcpspde"  * 18 HCP Speciality Date 5 (ccyymmdd)
LCHCRCPT  INIT      "%hcprcpt"  * 19 HCP Receptionist's Name
LCHCADR1  INIT      "%hcpadra"  * 20 HCP Surgery Address Line 1
LCHCADR2  INIT      "%hcpadrb"  * 21 HCP Surgery Address Line 2
LCHCADR3  INIT      "%hcpadrc"  * 22 HCP Surgery Address Line 3
LCHCADR4  INIT      "%hcpadrd"  * 23 HCP Surgery Address Line 4
LCHCADR5  INIT      "%hcpadre"  * 24 HCP Surgery Address Line 5
LCHCADR6  INIT      "%hcpadrf"  * 25 HCP Surgery Address Line 6
LCHCPOST  INIT      "%hcppost"  * 26 HCP Surgery PostCode
LCHCSTAT  INIT      "%hcpstat"  * 27 HCP State
LCHCSEML  INIT      "%hcpseml"  * 28 HCP Surgery Email Address
LCHCSTEL  INIT      "%hcpstel"  * 29 Surgery Telephone
LCHCPAGR  INIT      "%hcppagr"  * 30 HCP Pager Telephone
LCHCPAGN  INIT      "%hcppagn"  * 31 HCP Pager Number
LCHCAHP1  INIT      "%hcpahpa"  * 32 Associated HCP 1
LCHCAHP2  INIT      "%hcpahpb"  * 33 Associated HCP 2
LCHCAHP3  INIT      "%hcpahpc"  * 34 Associated HCP 3
LCHCAHP4  INIT      "%hcpahpd"  * 35 Associated HCP 4
LCHCAHP5  INIT      "%hcpahpe"  * 36 Associated HCP 5
LCHCPRV1  INIT      "%hcpprva"  * 37 Provider Number 1 - Reg. No. NZ
LCHCPRV2  INIT      "%hcpprvb"  * 38 Provider Number 2 - Prev Reg. No NZ
LCHCPRV3  INIT      "%hcpprvc"  * 39 Provider Number 3
LCHCPRV4  INIT      "%hcpprvd"  * 40 Provider Number 4
LCHCPRV5  INIT      "%hcpprve"  * 41 Provider Number 5
LCHCHTEL  INIT      "%hcphtel"  * 42 HCP Home Telephone
LCHCHAD1  INIT      "%hcphada"  * 43 HCP Home Address Line 1
LCHCHAD2  INIT      "%hcphadb"  * 44 HCP Home Address Line 2
LCHCHAD3  INIT      "%hcphadc"  * 45 HCP Home Address Line 3
LCHCHAD4  INIT      "%hcphadd"  * 46 HCP Home Address Line 4
LCHCHAD5  INIT      "%hcphade"  * 47 HCP Home Address Line 5
LCHCHAD6  INIT      "%hcphadf"  * 48 HCP Home Address Line 6
LCHCHPCD  INIT      "%hcphpcd"  * 49 HCP Home Post Code
LCHCHEML  INIT      "%hcpheml"  * 50 HCP Home Email Address
LCHCDFAC  INIT      "%hcpdfac"  * 51 Date of First Accred. (ccyymmdd)
LCHCDLAC  INIT      "%hcpdlac"  * 52 Date of Last Accred. (ccyymmdd)
LCHCYACC  INIT      "%hcpyacc"  * 53 Years Of Accreditation
LCHCATYP  INIT      "%hcpatyp"  * 54 Accreditation Type (Cat AT)
LCHCHHCP  INIT      "%hcphhcp"  * 55 H.C.S. HCP Code
LCHCOSLV  INIT      "%hcposlv"  * 56 Operating Supervision Level (cat DL
LCHCHCST  INIT      "%hcphcst"  * 57 HCP Status
LCHCHCSD  INIT      "%hcphcsd"  * 58 HCP Status Date (ccyymmdd)
LCHCFAXN  INIT      "%hcpfaxn"  * 59 HCP's Fax Number
LCHCHFXN  INIT      "%hcphfxn"  * 60 HCP's Home Fax Number
LCHCMOBN  INIT      "%hcpmobn"  * 61 HCP's Mobile Phone Number
LCHCCRDC  INIT      "%hcpcrdc"  * 62 Creditor Code (apsmasaf)
LCHCWAHC  INIT      "%hcpwahc"  * 63 WA HDP HCP Code
LCHCMRBN  INIT      "%hcpmrbn"  * 64 Medical Registration Board Number
LCHCNHSN  INIT      "%hcpnhsn"  * 65 N.H.S. Proscriber Number
LCHCUDF1  INIT      "%hcpudfa"  * 66 User Defined Field 1 (Cat R5)
LCHCUDF2  INIT      "%hcpudfb"  * 67 User Defined Field 2 (Cat R6)
LCHCUDF3  INIT      "%hcpudfc"  * 68 User Defined Field 3 (Cat R7)
LCHCUDF4  INIT      "%hcpudfd"  * 69 User Defined Field 4 (Cat R8)
LCHCUDF5  INIT      "%hcpudfe"  * 70 User Defined Field 5 (Cat R9)
LCHCUYN1  INIT      "%hcpuyna"  * 71 User def. Y/N field 1 (0=NO,1=YES)
LCHCUYN2  INIT      "%hcpuynb"  * 72 User def. Y/N field 2 (0=NO,1=YES)
LCHCUYN3  INIT      "%hcpuync"  * 73 User def. Y/N field 3 (0=NO,1=YES)
LCHCUYN4  INIT      "%hcpuynd"  * 74 User def. Y/N field 4 (0=NO,1=YES)
LCHCUYN5  INIT      "%hcpuyne"  * 75 User def. Y/N field 5 (0=NO,1=YES)
LCHCINSC  INIT      "%hcpinsc"  * 76 Insurance Code (patin1af)
LCHCIPLN  INIT      "%hcpipln"  * 77 Insurance Policy Number
LCHCIDTF  INIT      "%hcpidtf"  * 78 Insurance Date From (ccyymmdd)
LCHCIDTT  INIT      "%hcpidtt"  * 79 Insurance Date To (ccyymmdd)
LCHCMPGN  INIT      "%hcpmpgn"  * 80 MPG Certificate Number
LCHCAPCI  INIT      "%hcpapci"  * 81 APC (0=NO,1=YES) - NZ
LCHCREGT  INIT      "%hcpregt"  * 82 Registration Type (Cat HR) - NZ
LCHCRGDF  INIT      "%hcprgdf"  * 83 Reg. Date From - Gen Reg Date (NZ)
LCHCRGDT  INIT      "%hcprgdt"  * 84 Reg. Date To - Gen Reg Date (NZ)
LCHCPRDF  INIT      "%hcpprdf"  * 85 Probation. Reg. Date From ccyymmdd
LCHCPRDT  INIT      "%hcpprdt"  * 86 Probation. Reg. Date To ccyymmdd
LCHCTSDF  INIT      "%hcptsdf"  * 87 Temp. Start Date From (ccyymmdd)
LCHCTFDT  INIT      "%hcptfdt"  * 88 Temp. Finish Date To (ccyymmdd)
LCHCVISD  INIT      "%hcpvisd"  * 89 Visa Date (ccyymmdd)
LCHCPRFC  INIT      "%hcpprfc"  * 90 HCP's Preferd Communication (Cat CZ
LCHCPRFN  INIT      "%hcpprfn"  * 91 HCP's Preferred Name
LCHCABNN  INIT      "%hcpabnn"  * 92 ABN Number
LCHCSTTS  INIT      "%hcpstts"  * 93 HCP rec status (0=Active/1=Inactive
LCHCDLMI  INIT      "%hcpdlmi"  * 94 Date Last Made Inactive (ccyymmdd)
LCHCDLMA  INIT      "%hcpdlma"  * 95 Date Last Made Active (ccyymmdd)
LCHCPTYP  INIT      "%hcpptyp"  * 96 Provider Type (nzpptyaf)
LCCURDAT  INIT      "%curdate"  * 97 Current Date
LCFORTNM  INIT      "%hcpfnam"  * 98 Formatted HCP name
LCCURDTN  INIT      "%curdtn"   * 99 Current Date - no extension
.
DXPAGE    INIT      "  -----     Page Break             -----  " * 1 Page Break
DXHCHCPC  DIM       10          * 2 HCP Code
DXHCTITL  DIM       30          * 3 HCP Title
DXHCGNAM  DIM       35          * 4 HCP Given Names
DXHCSNAM  DIM       35          * 5 HCP Surname
DXHCINIT  DIM       5           * 6 HCP Initials
DXHCGNDR  DIM       1           * 7 HCP Gender (M,F,I,U)
DXHCDTOB  DIM       20          * 8 HCP Date of Birth (ccyymmdd)
DXHCSPC1  DIM       20          * 9 HCP Speciality 1 (Cat DT)
DXHCSPD1  DIM       20          * 10 HCP Speciality Date 1 (ccyymmdd)
DXHCSPC2  DIM       20          * 11 HCP Speciality 2 (Cat DT)
DXHCSPD2  DIM       20          * 12 HCP Speciality Date 2 (ccyymmdd)
DXHCSPC3  DIM       20          * 13 HCP Speciality 3 (Cat DT)
DXHCSPD3  DIM       20          * 14 HCP Speciality Date 3 (ccyymmdd)
DXHCSPC4  DIM       20          * 15 HCP Speciality 4 (Cat DT)
DXHCSPD4  DIM       20          * 16 HCP Speciality Date 4 (ccyymmdd)
DXHCSPC5  DIM       20          * 17 HCP Speciality 5 (Cat DT)
DXHCSPD5  DIM       20          * 18 HCP Speciality Date 5 (ccyymmdd)
DXHCRCPT  DIM       25          * 19 HCP Receptionist's Name
DXHCADR1  DIM       60          * 20 HCP Surgery Address Line 1
DXHCADR2  DIM       60          * 21 HCP Surgery Address Line 2
DXHCADR3  DIM       60          * 22 HCP Surgery Address Line 3
DXHCADR4  DIM       60          * 23 HCP Surgery Address Line 4
DXHCADR5  DIM       60          * 24 HCP Surgery Address Line 5
DXHCADR6  DIM       60          * 25 HCP Surgery Address Line 6
DXHCPOST  DIM       8           * 26 HCP Surgery PostCode
DXHCSTAT  DIM       4           * 27 HCP State
DXHCSEML  DIM       80          * 28 HCP Surgery Email Address
DXHCSTEL  DIM       20          * 29 Surgery Telephone
DXHCPAGR  DIM       20          * 30 HCP Pager Telephone
DXHCPAGN  DIM       20          * 31 HCP Pager Number
DXHCAHP1  DIM       25          * 32 Associated HCP 1
DXHCAHP2  DIM       25          * 33 Associated HCP 2
DXHCAHP3  DIM       25          * 34 Associated HCP 3
DXHCAHP4  DIM       25          * 35 Associated HCP 4
DXHCAHP5  DIM       25          * 36 Associated HCP 5
DXHCPRV1  DIM       10          * 37 Provider Number 1 - Reg. No. NZ
DXHCPRV2  DIM       10          * 38 Provider Number 2 - Prev Reg. No NZ
DXHCPRV3  DIM       10          * 39 Provider Number 3
DXHCPRV4  DIM       10          * 40 Provider Number 4
DXHCPRV5  DIM       10          * 41 Provider Number 5
DXHCHTEL  DIM       20          * 42 HCP Home Telephone
DXHCHAD1  DIM       60          * 43 HCP Home Address Line 1
DXHCHAD2  DIM       60          * 44 HCP Home Address Line 2
DXHCHAD3  DIM       60          * 45 HCP Home Address Line 3
DXHCHAD4  DIM       60          * 46 HCP Home Address Line 4
DXHCHAD5  DIM       60          * 47 HCP Home Address Line 5
DXHCHAD6  DIM       60          * 48 HCP Home Address Line 6
DXHCHPCD  DIM       8           * 49 HCP Home Post Code
DXHCHEML  DIM       4           * 50 HCP Home Email Address
DXHCDFAC  DIM       20          * 51 Date of First Accred. (ccyymmdd)
DXHCDLAC  DIM       20          * 52 Date of Last Accred. (ccyymmdd)
DXHCYACC  DIM       2           * 53 Years Of Accreditation
DXHCATYP  DIM       20          * 54 Accreditation Type (Cat AT)
DXHCHHCP  DIM       3           * 55 H.C.S. HCP Code
DXHCOSLV  DIM       20          * 56 Operating Supervision Level (cat DL
DXHCHCST  DIM       30          * 57 HCP Status
DXHCHCSD  DIM       20          * 58 HCP Status Date (ccyymmdd)
DXHCFAXN  DIM       20          * 59 HCP's Fax Number
DXHCHFXN  DIM       20          * 60 HCP's Home Fax Number
DXHCMOBN  DIM       20          * 61 HCP's Mobile Phone Number
DXHCCRDC  DIM       30          * 62 Creditor Code (apsmasaf)
DXHCWAHC  DIM       10          * 63 WA HDP HCP Code
DXHCMRBN  DIM       10          * 64 Medical Registration Board Number
DXHCNHSN  DIM       10          * 65 N.H.S. Proscriber Number
DXHCUDF1  DIM       20          * 66 User Defined Field 1 (Cat R5)
DXHCUDF2  DIM       20          * 67 User Defined Field 2 (Cat R6)
DXHCUDF3  DIM       20          * 68 User Defined Field 3 (Cat R7)
DXHCUDF4  DIM       20          * 69 User Defined Field 4 (Cat R8)
DXHCUDF5  DIM       20          * 70 User Defined Field 5 (Cat R9)
DXHCUYN1  DIM       3           * 71 User def. Y/N field 1 (0=NO,1=YES)
DXHCUYN2  DIM       3           * 72 User def. Y/N field 2 (0=NO,1=YES)
DXHCUYN3  DIM       3           * 73 User def. Y/N field 3 (0=NO,1=YES)
DXHCUYN4  DIM       3           * 74 User def. Y/N field 4 (0=NO,1=YES)
DXHCUYN5  DIM       3           * 75 User def. Y/N field 5 (0=NO,1=YES)
DXHCINSC  DIM       30          * 76 Insurance Code (patin1af)
DXHCIPLN  DIM       20          * 77 Insurance Policy Number
DXHCIDTF  DIM       20          * 78 Insurance Date From (ccyymmdd)
DXHCIDTT  DIM       20          * 79 Insurance Date To (ccyymmdd)
DXHCMPGN  DIM       20          * 80 MPG Certificate Number
DXHCAPCI  DIM       3           * 81 APC (0=NO,1=YES) - NZ
DXHCREGT  DIM       20          * 82 Registration Type (Cat HR) - NZ
DXHCRGDF  DIM       20          * 83 Reg. Date From - Gen Reg Date (NZ)
DXHCRGDT  DIM       20          * 84 Reg. Date To - Gen Reg Date (NZ)
DXHCPRDF  DIM       20          * 85 Probation. Reg. Date From ccyymmdd
DXHCPRDT  DIM       20          * 86 Probation. Reg. Date To ccyymmdd
DXHCTSDF  DIM       20          * 87 Temp. Start Date From (ccyymmdd)
DXHCTFDT  DIM       20          * 88 Temp. Finish Date To (ccyymmdd)
DXHCVISD  DIM       20          * 89 Visa Date (ccyymmdd)
DXHCPRFC  DIM       20          * 90 HCP's Preferd Communication (Cat CZ
DXHCPRFN  DIM       30          * 91 HCP's Preferred Name
DXHCABNN  DIM       11          * 92 ABN Number
DXHCSTTS  DIM       8           * 93 HCP rec status (0=Active/1=Inactive
DXHCDLMI  DIM       20          * 94 Date Last Made Inactive (ccyymmdd)
DXHCDLMA  DIM       20          * 95 Date Last Made Active (ccyymmdd)
DXHCPTYP  DIM       30          * 96 Provider Type (nzpptyaf)
DXCURDAT  DIM       20          * 97 Current Date
DXFORTNM  DIM       50          * 98 Formatted HCP name
DXCURDTN  DIM       20          * 99 Current Date - no extension
.
PRGID     INIT      "IBAPMS87"
PRGNAM    INIT      "Print Doctors Letters"
VERSION   INIT      "V12.00.00"
.
.**************************************************************************
.*                              ML0000                                    *
.*                      Controlling Logic (Mainline code)                 *
.**************************************************************************
.
MAIN0000  CALL      INIT0000               * initialisation and open files
.
MAIN0100  CALL      OPTN0000               * select options
          BRANCH    EXIT,MAIN9999            * EXIT = 1 if 0 chosen in menu
          BRANCH    COPTION,MAIN1000,MAIN2000  * proceed with clean up
.
          GOTO      MAIN9999
.
MAIN1000  CALL      SELO0000               * keyin extract id
          BRANCH    EXIT,MAIN0100
.
          CALL      DELH0000               * delete selected hcp codes
          CALL      EXTR0000               * extract hcp codes  
          GOTO      MAIN9999
.
MAIN2000  CALL      SELO0000               * keyin extract id 
          BRANCH    EXIT,MAIN0100
.
          CALL      LETT0000               * keyin letter to print
          BRANCH    EXIT,MAIN0100
.
          CALL      PHCP0000               * print letter for selected hcp codes
          GOTO      MAIN9999
.
MAIN9999  CHAIN     PGM                    * chain back to program
.
.****************************************************************************
.*                                INIT0000             Called by: ML0000    *
.*                             initialisation                               *
.*  The initialisation routine is used to display headings and open files.  *
.****************************************************************************
.
INIT0000  CALL      DISPHEAD                  * display heading
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PMSDLTA1,"pmsdltaf"
          OPEN      PATDLTA1,"patdltaf"
          OPEN      PMSDSLA1,"pmsdslaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      NZPPTYA1,"nzpptyaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        IBCNMHOS=1
            OPEN      MLTHCPA1,"mlthcpaf"
            OPEN      MLTHCPA2,"mlthcpaf"
          ENDIF
.
INIT9999  RETURN
.
.****************************************************************************
.*                                OPTN0000             Called by: ML0000    *
.*                        get user options or exit                          *
.*                                                                          *
.*    Returns:  EXIT    = FALSE (0)  Run clean up                           *
.*                        TRUE  (1)  Exit option selected                   *
.****************************************************************************
.
OPTN0000  DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Run HCP Selection":
                    *P1:6,*V2LON,TWO,*HOFF,". Print Letters"
.
OPTN0500  KEYIN     *P1:8,*EL,"Select Option : ",*DV,UNDLN1:
                    *P17:8,*V2LON,COPTION
.
          COMPARE   ZERO,COPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    COPTION,OPTN9000,OPTN9000    * run clean-up
.
          BEEP
          GOTO      OPTN0500
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
.
.**********************************************************************
.*                            SELO0000                                *
.*                      Main Option Screen                            *
.**********************************************************************
.
SELO0000  DISPLAY   *P1:10,*EF:
                    *P1:10,"Enter Selection ID :"
.
SELO1000  KEYIN     *P22:10,*DV,UNDLN1,*P22:10,*V2LON,SELECTID;
.
          MATCH     SP70,SELECTID
          GOTO      SELO9000 IF EQUAL
.
          PACK      KEY4,SELECTID,SP70
          CALL      RDPMDLT1
          IF        OVRCD = 0
            GOTO      SELO2000
          ENDIF
.
          BEEP
          GOTO      SELO1000
.
SELO2000  MOVE      ZERO,EXIT
          GOTO      SELO9999
.
SELO9000  MOVE      ONE,EXIT
.
SELO9999  RETURN
.
.
.**********************************************************************
.*                            LETT0000                                *
.*                      Main Option Screen                            *
.**********************************************************************
.
LETT0000  DISPLAY   *P1:11,*EF:
                    *P1:11,"Enter Letter ID :"
.
LETT1000  KEYIN     *P22:11,*DV,UNDLN1,*P22:11,*V2LON,LETTERCD;
.
          PACK      KEY6,LETTERCD,SP1,SP1,ZERO,SP70
          CALL      RDPTDLT1
          BRANCH    OVRCD,LETT9000
.
LETT2000  MOVE      ZERO,EXIT
          GOTO      LETT9999
.
LETT9000  MOVE      ONE,EXIT
.
LETT9999  RETURN
.
.-------------------------------------------------------------
. Delete hcp codes in extract
.-------------------------------------------------------------
DELH0000  PACK      KEY14,SELECTID,SP70
          CALL      RSPMDSL1
          CALL      RKPMDSL1
          BRANCH    OVRCD,DELH9999
.         
          MATCH     SELECTID,PMDLSELI
          GOTO      DELH9999 IF NOT EQUAL
.         
          PACK      KEY14,PMDLSELI,PMDLHCPC,SP70
          CALL      DEPMDSL1
.         
          GOTO      DELH0000
.
DELH9999  RETURN
.**********************************************************************
.* Extract hcp codes for selection id                                 *
.**********************************************************************
EXTR0000  PACK      KEY10,SP70
          CALL      RSPMHCP1
EXTR1000  CALL      RKPMHCP1
          BRANCH    OVRCD,EXTR9999
.
          MATCH     "1",PMHCEXML                 * exclude from mailing list
          GOTO      EXTR1000 IF EQUAL
.
          MATCH     SP70,PMDSHCPF                * HCP from
          IF        !@EQUAL
            MATCH     PMDSHCPF,PMHCHCPC 
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSHCPT                * HCP to
          IF        !@EQUAL
            MATCH     PMHCHCPC,PMDSHCPT
            GOTO      EXTR9999 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSPSFR                * primary spec from
          IF        !@EQUAL
            MATCH     PMDSPSFR,PMHCSPC1 
            GOTO      EXTR1000 IF LESS
          ENDIF
.         
          MATCH     SP70,PMDSPSTO                * primary spec to
          IF        !@EQUAL
            MATCH     PMHCSPC1,PMDSPSTO
            GOTO      EXTR1000 IF LESS
          ENDIF
. 
          MATCH     SP70,PMDSASFR                * add spec from
          IF        !@EQUAL
            MATCH     SP70,PMHCSPC2
            IF        !@EQUAL
              MATCH     PMDSASFR,PMHCSPC2
              GOTO      EXTR1100 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC3
            IF        !@EQUAL
              MATCH     PMDSASFR,PMHCSPC3
              GOTO      EXTR1100 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC4
            IF        !@EQUAL
              MATCH     PMDSASFR,PMHCSPC4
              GOTO      EXTR1100 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC5
            IF        !@EQUAL
              MATCH     PMDSASFR,PMHCSPC5
              GOTO      EXTR1100 IF NOT LESS
            ENDIF
            GOTO      EXTR1000
          ENDIF     
.
EXTR1100  MATCH     SP70,PMDSASTO                * add spec from
          IF        !@EQUAL
            MATCH     SP70,PMHCSPC2
            IF        !@EQUAL
              MATCH     PMHCSPC2,PMDSASTO
              GOTO      EXTR1200 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC3
            IF        !@EQUAL
              MATCH     PMHCSPC3,PMDSASTO
              GOTO      EXTR1200 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC4
            IF        !@EQUAL
              MATCH     PMHCSPC4,PMDSASTO
              GOTO      EXTR1200 IF NOT LESS
            ENDIF
            MATCH     SP70,PMHCSPC5
            IF        !@EQUAL
              MATCH     PMHCSPC5,PMDSASTO
              GOTO      EXTR1200 IF NOT LESS
            ENDIF
            GOTO      EXTR1000
          ENDIF
.
EXTR1200  MATCH     SP70,PMDSHOSP                * hospital
          IF        !@EQUAL
            PACK     KEY13,PMDSHOSP,PMHCHCPC,SP70
            CALL     RDMLHCP1
            BRANCH   OVRCD,EXTR1000
          ENDIF
.
          MATCH     SP70,PMDSPREF                * preferred comm
          IF        !@EQUAL
            MATCH     PMHCPRFC,PMDSPREF
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMDSFADF                * first accred date from
          IF        !@EQUAL
            MATCH     PMDSFADF,PMHCDFAC
            GOTO      EXTR1000 IF LESS
          ENDIF
.         
          MATCH     SP70,PMDSFADT                * first accred date to
          IF        !@EQUAL
            MATCH     PMHCDFAC,PMDSFADT
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSLADF                * last accred date from
          IF        !@EQUAL
            MATCH     PMDSLADF,PMHCDLAC
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSLADT                * last accred date to
          IF        !@EQUAL
            MATCH     PMHCDLAC,PMDSLADT
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSHCST                * HCP type
          IF        !@EQUAL
            MOVE      ZERO,F2
            MOVE      PMDSHCST,F2
            COMPARE   PMHCHCST,F2
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMDSATYP                * accred type
          IF        !@EQUAL
            MATCH     PMHCATYP,PMDSATYP
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMDSACTV                * active
          IF        !@EQUAL
            MATCH     PMHCSTTS,PMDSACTV
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMDSINSC                * insurance
          IF        !@EQUAL
            MATCH     PMHCINSC,PMDSINSC
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMDSIDFF                * ins date from from
          IF        !@EQUAL
            MATCH     PMDSIDFF,PMHCIDTF
            GOTO      EXTR1000 IF LESS
          ENDIF
.           
          MATCH     SP70,PMDSIDFT                * ins date from to
          IF        !@EQUAL
            MATCH     PMHCIDTF,PMDSIDFT          
            GOTO      EXTR1000 IF LESS
          ENDIF
. 
          MATCH     SP70,PMDSIDTF                * ins date to from
          IF        !@EQUAL
            MATCH     PMDSIDTF,PMHCIDTT
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MATCH     SP70,PMDSIDTT                * ins date to to
          IF        !@EQUAL
            MATCH     PMHCIDTT,PMDSIDTT
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          SQUEEZE   PMDSYACF
          MOVE      ZERO,F2
          MOVE      PMDSYACF,F2
          COMPARE   ZERO,F2                      * years of accred
          IF        !@EQUAL
            COMPARE   F2,PMHCYACC
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          SQUEEZE   PMDSYACT
          MOVE      ZERO,F2
          MOVE      PMDSYACT,F2
          COMPARE   ZERO,F2                      * years of accred to
          IF        !@EQUAL
            COMPARE   PMHCYACC,F2
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          MOVE      SELECTID,PMDLSELI
          MOVE      PMHCHCPC,PMDLHCPC
          MOVE      ZERO,PMDLDLST
          MOVE      SP70,PMDLSPAR
.
          PACK      KEY14,PMDLSELI,PMDLHCPC,SP70
          CALL      RAPMDSL1
          IF        OVRCD=1
            CALL     WRPMDSL1
          ENDIF
.
          GOTO      EXTR1000
.
EXTR9999  RETURN
.
.-------------------------------------------------------------
. Print a letter for the selected HCP codes
.-------------------------------------------------------------
PHCP0000  PACK      KEY14,SELECTID,SP70
          CALL      RSPMDSL1
PHCP1000  CALL      RKPMDSL1
          BRANCH    OVRCD,PHCP9999
.
          MATCH     SELECTID,PMDLSELI
          GOTO      PHCP9999 IF NOT EQUAL
.
          MATCH     "1",PMDLDLST                 * record status deleted
          GOTO      PHCP1000 IF EQUAL
.
          PACK      KEY10,PMDLHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,PHCP1000
.
          CALL      FRMT0000                     * format letter vars
          CALL      PRLT0000                     * print letter
.
          GOTO      PHCP1000
.
PHCP9999  RETURN
.
.-------------------------------------------------------------
. Format Letter vars
.-------------------------------------------------------------
FRMT0000  MOVE      PMHCHCPC,DXHCHCPC       * 2 HCP Code
          MOVE      PMHCTITL,DXHCTITL       * 3 HCP Title
          MOVE      PMHCGNAM,DXHCGNAM       * 4 HCP Given Names
          MOVE      PMHCSNAM,DXHCSNAM       * 5 HCP Surname
          MOVE      PMHCINIT,DXHCINIT       * 6 HCP Initials
          MOVE      PMHCGNDR,DXHCGNDR       * 7 HCP Gender (M,F,I,U)
.
          MOVE      SP70,DXHCDTOB           * 8 HCP Date of Birth 
          MATCH     SP70,PMHCDTOB
          IF        !@EQUAL
            MOVE      PMHCDTOB,WORKDATE
            CALL      FDAT0000 
            MOVE      DATELINE,DXHCDTOB
          ENDIF
.
          MOVE      "DT",CATEGORY 
          MOVE      PMHCSPC1,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCSPC1          * 9 HCP Speciality 1 (Cat DT)
.
          MOVE      SP70,DXHCSPD1           * 10 HCP Speciality Date 1
          MATCH     SP70,PMHCSPD1
          IF        !@EQUAL
            MOVE      PMHCSPD1,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCSPD1
          ENDIF
.
          MOVE      "DT",CATEGORY
          MOVE      PMHCSPC2,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCSPC2          * 11 HCP Speciality 2 (Cat DT)
.
          MOVE      SP70,DXHCSPD2           * 12 HCP Speciality Date 2
          MATCH     SP70,PMHCSPD2
          IF        !@EQUAL
            MOVE      PMHCSPD2,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCSPD2
          ENDIF
.
          MOVE      "DT",CATEGORY
          MOVE      PMHCSPC3,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCSPC3          * 13 HCP Speciality 3 (Cat DT)
.
          MOVE      SP70,DXHCSPD3           * 14 HCP Speciality Date 3
          MATCH     SP70,PMHCSPD3
          IF        !@EQUAL
            MOVE      PMHCSPD3,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCSPD3
          ENDIF
. 
          MOVE      "DT",CATEGORY
          MOVE      PMHCSPC4,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCSPC4          * 15 HCP Speciality 4 (Cat DT)
.
          MOVE      SP70,DXHCSPD4           * 16 HCP Speciality Date 4 
          MATCH     SP70,PMHCSPD4
          IF        !@EQUAL
            MOVE      PMHCSPD4,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCSPD4
          ENDIF
. 
          MOVE      "DT",CATEGORY
          MOVE      PMHCSPC5,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCSPC5          * 17 HCP Speciality 5 (Cat DT)
.
          MOVE      SP70,DXHCSPD5           * 18 HCP Speciality Date 5
          MATCH     SP70,PMHCSPD5
          IF        !@EQUAL
            MOVE      PMHCSPD5,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCSPD5
          ENDIF
. 
          MOVE      PMHCRCPT,DXHCRCPT       * 19 HCP Receptionist's Name
          MOVE      PMHCADR1,DXHCADR1       * 20 HCP Surgery Address Line 1
          MOVE      PMHCADR2,DXHCADR2       * 21 HCP Surgery Address Line 2
          MOVE      PMHCADR3,DXHCADR3       * 22 HCP Surgery Address Line 3
          MOVE      PMHCADR4,DXHCADR4       * 23 HCP Surgery Address Line 4
          MOVE      PMHCADR5,DXHCADR5       * 24 HCP Surgery Address Line 5
          MOVE      PMHCADR6,DXHCADR6       * 25 HCP Surgery Address Line 6
          MOVE      PMHCPOST,DXHCPOST       * 26 HCP Surgery PostCode
          MOVE      PMHCSTAT,DXHCSTAT       * 27 HCP State
          MOVE      PMHCSEML,DXHCSEML       * 28 HCP Surgery Email Address
          MOVE      PMHCSTEL,DXHCSTEL       * 29 Surgery Telephone
          MOVE      PMHCPAGR,DXHCPAGR       * 30 HCP Pager Telephone
          MOVE      PMHCPAGN,DXHCPAGN       * 31 HCP Pager Number
          MOVE      PMHCAHP1,DXHCAHP1       * 32 Associated HCP 1
          MOVE      PMHCAHP2,DXHCAHP2       * 33 Associated HCP 2
          MOVE      PMHCAHP3,DXHCAHP3       * 34 Associated HCP 3
          MOVE      PMHCAHP4,DXHCAHP4       * 35 Associated HCP 4
          MOVE      PMHCAHP5,DXHCAHP5       * 36 Associated HCP 5
          MOVE      PMHCPRV1,DXHCPRV1       * 37 Prov Numb 1 - Reg. No. NZ
          MOVE      PMHCPRV2,DXHCPRV2       * 38 Prov Numb 2-Prev Reg. No NZ
          MOVE      PMHCPRV3,DXHCPRV3       * 39 Provider Number 3
          MOVE      PMHCPRV4,DXHCPRV4       * 40 Provider Number 4
          MOVE      PMHCPRV5,DXHCPRV5       * 41 Provider Number 5
          MOVE      PMHCHTEL,DXHCHTEL       * 42 HCP Home Telephone
          MOVE      PMHCHAD1,DXHCHAD1       * 43 HCP Home Address Line 1
          MOVE      PMHCHAD2,DXHCHAD2       * 44 HCP Home Address Line 2
          MOVE      PMHCHAD3,DXHCHAD3       * 45 HCP Home Address Line 3
          MOVE      PMHCHAD4,DXHCHAD4       * 46 HCP Home Address Line 4
          MOVE      PMHCHAD5,DXHCHAD5       * 47 HCP Home Address Line 5
          MOVE      PMHCHAD6,DXHCHAD6       * 48 HCP Home Address Line 6
          MOVE      PMHCHPCD,DXHCHPCD       * 49 HCP Home Post Code
          MOVE      PMHCHEML,DXHCHEML       * 50 HCP Home Email Address
.
          MOVE      SP70,DXHCDFAC           * 51 Date of First Accred. 
          MATCH     SP70,PMHCDFAC
          IF        !@EQUAL
            MOVE      PMHCDFAC,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCDFAC
          ENDIF
.
          MOVE      SP70,DXHCDLAC           * 52 Date of Last Accred. 
          MATCH     SP70,PMHCDLAC
          IF        !@EQUAL
            MOVE      PMHCDLAC,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCDLAC
          ENDIF
.
          MOVE      PMHCYACC,DXHCYACC       * 53 Years Of Accreditation
.
          MOVE      "AT",CATEGORY
          MOVE      PMHCATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCATYP          * 54 Accreditation Type (Cat AT)
.
          MOVE      PMHCHHCP,DXHCHHCP       * 55 H.C.S. HCP Code
.
          MOVE      "DL",CATEGORY
          MOVE      PMHCOSLV,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCOSLV          * 56 Operating SuperLevel (cat DL
.
          MOVE      SP70,DXHCHCST           * 57 HCP Status
          IF        PMHCHCST = 0
            MOVE      "Attending",DXHCHCST
          ENDIF
          IF        PMHCHCST = 1
            MOVE      "Referring",DXHCHCST
          ENDIF
          IF        PMHCHCST = 2
            MOVE      "Attending & Referring",DXHCHCST
          ENDIF
          IF        PMHCHCST = 3
            MOVE      "GP",DXHCHCST
          ENDIF
          IF        PMHCHCST = 4
            MOVE      "Attending and GP",DXHCHCST
          ENDIF
          IF        PMHCHCST = 5
            MOVE      "Referring and GP",DXHCHCST
          ENDIF
          IF        PMHCHCST = 6
            MOVE      "Attending Referring and GP",DXHCHCST
          ENDIF
          IF        PMHCHCST = 7
            MOVE      "Other",DXHCHCST
          ENDIF
          IF        PMHCHCST = 8
            MOVE      "Other Attending",DXHCHCST
          ENDIF
          IF        PMHCHCST = 9
            MOVE      "Other Referring",DXHCHCST
          ENDIF
          IF        PMHCHCST = 10
            MOVE      "Other Attending & Referring",DXHCHCST
          ENDIF
.
          MOVE      SP70,DXHCHCSD           * 58 HCP Status Date (ccyymmdd)
          MATCH     SP70,PMHCHCSD           
          IF        !@EQUAL
            MOVE      PMHCHCSD,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCHCSD
          ENDIF
.
          MOVE      PMHCFAXN,DXHCFAXN       * 59 HCP's Fax Number
          MOVE      PMHCHFXN,DXHCHFXN       * 60 HCP's Home Fax Number
          MOVE      PMHCMOBN,DXHCMOBN       * 61 HCP's Mobile Phone Number
          MOVE      PMHCCRDC,DXHCCRDC       * 62 Creditor Code (apsmasaf)
          MOVE      PMHCWAHC,DXHCWAHC       * 63 WA HDP HCP Code
          MOVE      PMHCMRBN,DXHCMRBN       * 64 Medical Reg Board Number
          MOVE      PMHCNHSN,DXHCNHSN       * 65 N.H.S. Proscriber Number
.
          MOVE      "R5",CATEGORY
          MOVE      PMHCUDF1,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCUDF1          * 66 User Defined Field 1 (Cat R5)
.
          MOVE      "R6",CATEGORY
          MOVE      PMHCUDF2,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCUDF2          * 67 User Defined Field 2 (Cat R6)
.
          MOVE      "R7",CATEGORY
          MOVE      PMHCUDF3,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCUDF3          * 68 User Defined Field 3 (Cat R7)
.
          MOVE      "R8",CATEGORY
          MOVE      PMHCUDF4,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCUDF4          * 69 User Defined Field 4 (Cat R8)
.
          MOVE      "R9",CATEGORY
          MOVE      PMHCUDF5,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCUDF5          * 70 User Defined Field 5 (Cat R9)
.
          MOVE      DNO,DXHCUYN1            * 71 User def. Y/N  1 (0=NO,1=YES)
          MATCH     "1",PMHCUYN1
          IF        @EQUAL
            MOVE      DYES,DXHCUYN1
          ENDIF
.
          MOVE      DNO,DXHCUYN2            * 72 User def. Y/N  2 (0=NO,1=YES)
          MATCH     "1",PMHCUYN2
          IF        @EQUAL
            MOVE      DYES,DXHCUYN2
          ENDIF
.
          MOVE      DNO,DXHCUYN3            * 73 User def. Y/N  3 (0=NO,1=YES)
          MATCH     "1",PMHCUYN3
          IF        @EQUAL
            MOVE      DYES,DXHCUYN3
          ENDIF
.
          MOVE      DNO,DXHCUYN4            * 74 User def. Y/N  4 (0=NO,1=YES)
          MATCH     "1",PMHCUYN4
          IF        @EQUAL
            MOVE      DYES,DXHCUYN4
          ENDIF
.
          MOVE      DNO,DXHCUYN5            * 75 User def. Y/N  5 (0=NO,1=YES)
          MATCH     "1",PMHCUYN5
          IF        @EQUAL
            MOVE      DYES,DXHCUYN5
          ENDIF
.
          MOVE      SP70,DXHCINSC           * 76 Insurance Code (patin1af)
          PACK      KEY5,PMHCINSC,SP70
          CALL      RDINSR1
          IF        OVRCD=1
            MOVE      INAME,DXHCINSC
          ENDIF
.
          MOVE      PMHCIPLN,DXHCIPLN       * 77 Insurance Policy Number
.
          MOVE      SP70,DXHCIDTF           * 78 Insurance Date From (ccyymmdd)
          MATCH     SP70,PMHCIDTF
          IF        !@EQUAL
            MOVE      PMHCIDTF,WORKDATE      
            CALL      FDAT0000
            MOVE      DATELINE,DXHCIDTF
          ENDIF
.
          MOVE      SP70,DXHCIDTT           * 79 Insurance Date To (ccyymmdd)
          MATCH     SP70,PMHCIDTT
          IF        !@EQUAL
            MOVE      PMHCIDTT,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCIDTT
          ENDIF
.
          MOVE      PMHCMPGN,DXHCMPGN       * 80 MPG Certificate Number
.
          MOVE      DNO,DXHCAPCI            * 81 APC (0=NO,1=YES) - NZ
          MATCH     "1",PMHCAPCI
          IF        @EQUAL
            MOVE      DYES,DXHCAPCI
          ENDIF
.
          MOVE      "HR",CATEGORY
          MOVE      PMHCREGT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCREGT          * 82 Registration Type (Cat HR) - NZ
.
          MOVE      SP70,DXHCRGDF           * 83 Reg. Date From-Gen Reg Date(NZ)
          MATCH     SP70,PMHCRGDF
          IF        !@EQUAL
            MOVE      PMHCRGDF,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCRGDF
          ENDIF
.
          MOVE      SP70,DXHCRGDT           * 84 Reg. Date To-Gen Reg Date (NZ)
          MATCH     SP70,PMHCRGDT
          IF        !@EQUAL
            MOVE      PMHCRGDT,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCRGDT
          ENDIF
.
          MOVE      SP70,DXHCPRDF           * 85 Probation. Reg. Date From 
          MATCH     SP70,PMHCPRDF
          IF        !@EQUAL
            MOVE      PMHCPRDF,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCPRDF
          ENDIF
.
          MOVE      SP70,DXHCPRDT           * 86 Probation. Reg. Date To 
          MATCH     SP70,PMHCPRDT
          IF        !@EQUAL
            MOVE      PMHCPRDT,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCPRDT
          ENDIF
.
          MOVE      SP70,DXHCTSDF           * 87 Temp. Start Date From 
          MATCH     SP70,PMHCTSDF
          IF        !@EQUAL
            MOVE      PMHCTSDF,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCTSDF
          ENDIF
.
          MOVE      SP70,DXHCTFDT           * 88 Temp. Finish Date To (ccyymmdd)
          MATCH     SP70,PMHCTFDT
          IF        !@EQUAL
            MOVE      PMHCTFDT,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCTFDT
          ENDIF
.
          MOVE      SP70,DXHCVISD           * 89 Visa Date (ccyymmdd)
          MATCH     SP70,PMHCVISD
          IF        !@EQUAL
            MOVE      PMHCVISD,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCVISD
          ENDIF
.
          MOVE      "CZ",CATEGORY
          MOVE      PMHCREGT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DXHCPRFC          * 90 HCP's Preferd Comm (Cat CZ
.
          MOVE      PMHCPRFN,DXHCPRFN       * 91 HCP's Preferred Name
          MOVE      PMHCABNN,DXHCABNN       * 92 ABN Number
.
          MOVE      "Active",DXHCSTTS       * 93 HCP rec status
          MATCH     "1",PMHCSTTS
          IF        @EQUAL
            MOVE      "Inactive",DXHCSTTS
          ENDIF
.
          MOVE      SP70,DXHCDLMI           * 94 Date Last Made Inactive 
          MATCH     SP70,PMHCDLMI
          IF        !@EQUAL
            MOVE      PMHCDLMI,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCDLMI
          ENDIF
.
          MOVE      SP70,DXHCDLMA           * 95 Date Last Made Active 
          MATCH     SP70,PMHCDLMA
          IF        !@EQUAL
            MOVE      PMHCDLMA,WORKDATE
            CALL      FDAT0000
            MOVE      DATELINE,DXHCDLMA
          ENDIF
.
          MOVE      SP70,DXHCPTYP           * 96 Provider Type (nzpptyaf)
          PACK      KEY3,PMHCPTYP,SP70
          CALL      RDNZPTY1
          IF        OVRCD=0
            MOVE      NZPTDESC,DXHCPTYP
          ENDIF
.
          CALL      IBACLOCK
          PACK      WORKDATE,CCC,CYY,CMM,CDD * current date
          REP       " 0",WORKDATE
          CALL      FDAT0000
          MOVE      DATELINE,DXCURDAT       * 97 Current Date
          LJUSTIFY  DXCURDAT
          UNPACK    DATELINE,DIM2,KEY3,DIM20
          PACK      DXCURDTN,DIM2,SP1,DIM20
          LJUSTIFY  DXCURDTN 
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME   
          MOVE      PACFNAME,DXFORTNM        * 98 Formatted HCP name
.
FRMT9999  RETURN
.
.**********************************************************************
.*                           FDAT0000                                 *
.*                 Routine to format the date                         *
.**********************************************************************
FDAT0000  REP       " 0",WORKDATE
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT7000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT7000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                    DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                    MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          UNPACK    CDAY,DIM1,DIM2
          REP       "0 ",DIM1
          PACK      CDAY,DIM1,DIM2
.
.------ pack the formatted date ------
.
FDAT1000  REP       " 0",CYEAR
          PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
.          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT7000  MOVE      "99th December 1999",DATELINE
.
FDAT9999  RETURN
.
.**********************************************************************
.*                              COMP0000                              *
.*            routine to COMPress excessive blanks in LINE            *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL   * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                   * compress multiple blanks
          GOTO      COMP8000 IF EOS         *   from in-between words
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
.
.------------------------------------------------------------
. Get Code Description
.------------------------------------------------------------
GETCOD00  MOVE      SP70,TDESC
          MATCH     SP70,CODE
          GOTO      GETCOD99 IF EQUAL
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                           TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10
          ENDIF
.
GETCOD99  RETURN
.
.**********************************************************************
.*  Print letter                                                      *
.**********************************************************************
PRLT0000  MOVE      FALSE,EXIT
          MOVE      ONE,COUNT               * line number to print
.
          MOVE      ZERO,FORM3              * read letter file header
          PACK      KEY6,LETTERCD,FORM3     *    record
          CALL      RDPTDLT1
.
          MOVE      PTDLPPAG,PHYSPAGE       * physical paper length
          MOVE      PTDLPTOP,TOPMARG        * top margin
          MOVE      PTDLPBOT,BOTTMARG       * bottom margin
          SUB       PTDLPBOT,PTDLPPAG       * where to print to at bottom
          MOVE      PTDLPPAG,MLETPLEN       * length to print to
          MOVE      PTDLPTAB,LEFTMARG       * left margin
.
.------ print top margin ------
.
PRLT0050  PRINT     *N;                     * print blank line
          COMPARE   COUNT,TOPMARG
          GOTO      PRLT1000 IF EQUAL       * printed top margin
.
          ADD       ONE,COUNT
          GOTO      PRLT0050
.
. ------- print letter one line at a time ------
.
PRLT1000  CALL      RKPTDLT1
          BRANCH    OVRCD,PRLT9000          * end of letter reached
.
          COMPARE   LETTERCD,PTDLLTNO
          GOTO      PRLT9000 IF NOT EQUAL   * different letter number
.
          BRANCH    PTDLLVAR,PRLT2000       * have a % var
.
.         printing when no % variables
.
          PRINT     *N,*LEFTMARG,PTDLTEXT;  * print text if no % vars
          ADD       ONE,COUNT
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRLT1000
.
.         printing when have % variables
.
PRLT2000  CALL      MOD0000                 * substitute % var value
          PRINT     *N,*LEFTMARG,PRTSTRNG;  * print text with % vars
          ADD       ONE,COUNT
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRLT1000
.
. ------- end of current letter reached -------
.
PRLT9000  COMPARE   TOPMARG,COUNT
          GOTO      PRLT9500 IF EQUAL       * no lines of text printed
.
          DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
          MOVE      PHYSPAGE,TEMP3          * set up variables for
          SUBTRACT  COUNT,PHYSPAGE          *   paging
          MOVE      ONE,COUNT
.
.------ paginate at end of each letter ------
.
PRLT9100  PRINT     *N;
          COMPARE   COUNT,PHYSPAGE
          GOTO      PRLT9400 IF EQUAL       * printed bottom margin
.
          ADD       ONE,COUNT
          GOTO      PRLT9100
.
PRLT9400  MOVE      TEMP3,PHYSPAGE          * restore physical page length
          MOVE      TWO,EXIT                * indicate to continue
          GOTO      PRLT9999
.
.------ letter header is on file but nothing else ------
.
PRLT9500  DISPLAY   *P1:24,*EL,*B,"Letter has not been set up yet - Tap <":
                    *V2LON,"ENTER",*HOFF,">";
          KEYIN     ANS;
          MOVE      TRUE,EXIT               * enter another letter code
.
PRLT9999  RETURN
.
.**********************************************************************
.*                              PAGE0000                              *
.*        Routine to paginate if a new page is required               *
.**********************************************************************
PAGE0000  MOVE      PTDLLTNO,FORM3
          MOVE      PTDLLINO,FORM3A
          CALL      RKPTDLT1
          BRANCH    OVRCD,PAGE8000                * check to see that
.
          COMPARE   LETTERCD,PTDLLTNO             *  another line of the
          GOTO      PAGE8000 IF NOT EQUAL         *  letter exists
.
          MOVE      TOPMARG,TEMP2
          ADD       BOTTMARG,TOPMARG
          MOVE      ONE,COUNT
.
.------ loop to paginate ------
.
PAGE1000  PRINT     *N;
          COMPARE   COUNT,TOPMARG
          GOTO      PAGE9000 IF EQUAL
          ADD       ONE,COUNT
          GOTO      PAGE1000
.
.------ no need to paginate ------
.
PAGE8000  PACK      KEY6,FORM3,FORM3A
          CALL      RDPTDLT1
          GOTO      PAGE9999
.
.------ reset read to previous record to continue processing ------
.
PAGE9000  MOVE      TEMP2,COUNT
          MOVE      TEMP2,TOPMARG
          PACK      KEY6,FORM3,FORM3A
          CALL      RDPTDLT1
.
PAGE9999  RETURN
.
.**********************************************************************
.*                  MOD0000                     Called by : PRLT2000  *
.*             Modify a line to substitute "%" variable values        *
.**********************************************************************
MOD0000   MOVE      PTDLTEXT,DIM70
          PACK      PRTSTRNG,SP30,SP30,SP10          * initialise PRTSTRNG
          RESET     PRTSTRNG,0                       *   and pointer positions
          MOVE      ONE,STARTSTR
          MOVE      ONE,ENDSTR
.
MOD2000   SCAN      SPECCHAR,DIM70                * Scan the Input Line for
          GOTO      MOD8000 IF NOT EQUAL          * a "%" sign
.
MOD3000   MOVEFPTR  DIM70,PERCPOS
          BUMP      DIM70,-1                     * Go to the character before
.                                                * the "%" sign
          GOTO      MOD3100 IF NOT EOS            * Test if the % sign is the
          RESET     DIM70,0                      * first character on the line
.                                                * set f.p. to 0 if it is
.
MOD3100   MOVEFPTR  DIM70,ENDSTR                  * store endtsr at position
          COMPARE   STARTSTR,ENDSTR               *   1 char before the % sign
          GOTO      MOD3200 IF NOT LESS           *   and ensure that end and
.                                                *   start positions dont
.                                                *   overlap
          RESET     DIM70,STARTSTR                * set pointer to next % sign
          GOTO      MOD9999 IF EOS                *   if end < start
          GOTO      MOD3300
.
MOD3200   RESET     DIM70,STARTSTR                * reset the pointers to
          SETLPTR   DIM70,ENDSTR                  *   extract text preceding
          APPEND    DIM70,PRTSTRNG                *   the % sign
.
MOD3300   SETLPTR   DIM70,70                      * set the pointers to start at
          RESET     DIM70,PERCPOS                 *    % and go to position 70
.
.         SRF 642798
.
          MOVE      DIM70,TEMP70                  * delete preceding text from
          PACK      TEMP70,DIM70,SP30,SP30,SP30   *    the DIM70 string
.
MOD4000   CALL      GETV0000                      * extract the % var
          MOVEFPTR  DIM70,STARTSTR                * store finish pos. of var
          BRANCH    EXIT,MOD5000
          RESET     SRCHVAR
.
.------ search for the % var in the list of constants ------
.
          SEARCH    SRCHVAR,LCPAGE,LCNOVARS,SRCHNUM
.
          COMPARE   ONE,SRCHNUM
          GOTO      MOD7000 IF EQUAL        * Page Variable
.
MOD4500   COMPARE   ZERO,SRCHNUM                   * % var not found in list
          GOTO      MOD5000 IF EQUAL
.
.------ load DISPSTRN with the actual value of the % var ------
.
          LOAD    DISPSTRN,SRCHNUM,DXPAGE,DXHCHCPC,DXHCTITL,DXHCGNAM,DXHCSNAM:
                           DXHCINIT,DXHCGNDR,DXHCDTOB,DXHCSPC1,DXHCSPD1:
                           DXHCSPC2,DXHCSPD2,DXHCSPC3,DXHCSPD3,DXHCSPC4:
                           DXHCSPD4,DXHCSPC5,DXHCSPD5,DXHCRCPT,DXHCADR1:
                           DXHCADR2,DXHCADR3,DXHCADR4,DXHCADR5,DXHCADR6:
                           DXHCPOST,DXHCSTAT,DXHCSEML,DXHCSTEL,DXHCPAGR:
                           DXHCPAGN,DXHCAHP1,DXHCAHP2,DXHCAHP3,DXHCAHP4:
                           DXHCAHP5,DXHCPRV1,DXHCPRV2,DXHCPRV3,DXHCPRV4:
                           DXHCPRV5,DXHCHTEL,DXHCHAD1,DXHCHAD2,DXHCHAD3:
                           DXHCHAD4,DXHCHAD5,DXHCHAD6,DXHCHPCD,DXHCHEML:
                           DXHCDFAC,DXHCDLAC,DXHCYACC,DXHCATYP,DXHCHHCP:
                           DXHCOSLV,DXHCHCST,DXHCHCSD,DXHCFAXN,DXHCHFXN:
                           DXHCMOBN,DXHCCRDC,DXHCWAHC,DXHCMRBN,DXHCNHSN:
                           DXHCUDF1,DXHCUDF2,DXHCUDF3,DXHCUDF4,DXHCUDF5:
                           DXHCUYN1,DXHCUYN2,DXHCUYN3,DXHCUYN4,DXHCUYN5:
                           DXHCINSC,DXHCIPLN,DXHCIDTF,DXHCIDTT,DXHCMPGN:
                           DXHCAPCI,DXHCREGT,DXHCRGDF,DXHCRGDT,DXHCPRDF:
                           DXHCPRDT,DXHCTSDF,DXHCTFDT,DXHCVISD,DXHCPRFC:
                           DXHCPRFN,DXHCABNN,DXHCSTTS,DXHCDLMI,DXHCDLMA:
                           DXHCPTYP,DXCURDAT,DXFORTNM,DXCURDTN
.
          APPEND    DISPSTRN,PRTSTRNG
          CALL      COMX0000                   * compress trailing blanks in
          GOTO      MOD2000                    *    PRTSTRNG
.
MOD5000   RESET     SRCHVAR                    * add the string starting with
          APPEND    SRCHVAR,PRTSTRNG           *    a % if not found in the
          GOTO      MOD8000 IF EOS             *    list of constants
          GOTO      MOD2000
.
.------ %page variable found ------
.
MOD7000   MOVE      PHYSPAGE,TEMP3
          SUBTRACT  COUNT,PHYSPAGE
          MOVE      ONE,COUNT
          ADD       TOPMARG,PHYSPAGE
          SUBTRACT  ONE,PHYSPAGE
.
MOD7100   PRINT     *N;
          COMPARE   COUNT,PHYSPAGE
          GOTO      MOD7500 IF EQUAL
          ADD       ONE,COUNT
          GOTO      MOD7100
.
MOD7500   MOVE      TEMP3,PHYSPAGE
          MOVE      TOPMARG,COUNT
          SUBTRACT  ONE,COUNT
          PACK      PRTSTRNG,SP30,SP30,SP10
          GOTO      MOD9999
.
MOD8000   APPEND    DIM70,PRTSTRNG                    * add remaining text to
          RESET     PRTSTRNG                          *   PRTSTRNG if no %
.                                                     *   signs left
MOD9999   RETURN
.
.**********************************************************************
.*                              GETV0000                              *
.*           Extracts the "%" variable from the line                  *
.**********************************************************************
GETV0000  MOVE      FALSE,EXIT
          PACK      SRCHVAR,SP30,SP30,SP10
          RESET     SRCHVAR,0
          MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
          RESET     SRCHVAR,0
          BUMP      DIM70
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS                        * check to see if first
          MATCH     "0",ANS                           *   char after % is a
          GOTO      GETV9000 IF NOT EQUAL             *   lower case letter
          BUMP      DIM70,-1
          PACK      SRCHVAR,SP30,SP30,SP10            * initialise SRCHVAR
          RESET     SRCHVAR,0                         *   value and pointers
.
.------ append % var to SRCHVAR until anything but ------
.------ a lower case letter is found ------
.
GETV1000  MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
.
          BUMP      DIM70
          GOTO      GETV9999 IF EOS
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS
          MATCH     "0",ANS
          GOTO      GETV9999 IF NOT EQUAL
          GOTO      GETV1000
.
.------ string found is not a valid % var ------
.
GETV9000  MOVE      TRUE,EXIT
.
GETV9999  RETURN
.
.**********************************************************************
.* Routine to compress trailing blanks in PRTSTRNG            *
.**********************************************************************
COMX0000  ENDSET    PRTSTRNG
.
COMX1000  CMATCH    SP1,PRTSTRNG
          GOTO      COMX9999 IF NOT EQUAL
          BUMP      PRTSTRNG,-1
          GOTO      COMX9999 IF EOS
          GOTO      COMX1000
.
COMX9999  RETURN
.
. =========================================================================
.         I/O Includes
. =========================================================================
.
          INC       STD001IO
.
          INC       MLTHCPIO/INC
          INC       NZPPTYIO/INC
          INC       PATDLTIO/INC
          INC       PATCODIO/INC
          INC       PMSDSLIO/INC
          INC       PMSDLTIO/INC
          INC       PMSHCPIO/INC
          INC       PATIN1IO/INC
