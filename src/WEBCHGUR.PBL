.******************************************************************************
.* Include Name    : WEBCHGUR copy of CHANGEUR for web use only               *
.* Function        : Change a U/R Number (Update all files)                   *
.* Author          : Glenn Berry (Moved code from IBAPAT02 V5.01.166)         *
.* Date            : 17/01/1994                                               *
.* Requirements    :                                                          *
.*                   OURNO   : Old U/R Number                                 *
.*                   OLDURNO : Old U/R Number                                 *
.*                   NEWURNO : New U/R Number                                 *
.* Returns:          EXIT  0 = Ok to continue                                 *
.*                         1 = Error occurred                                 *
.*                         2 = Warning - Ok to continue                       *
.* Modifications   :                                                          *
.*                                                                            *
.******************************************************************************
.* V12.00.03 25/07/2025  Nikitha Bhaskar   TSK 0963585                        *
.*           Modified at CRMED000 to display right Created By ID.             *
.* V12.00.02 24/06/2025  J.Tan             TSK 0961696                        *
.*           Added Patient Debt type (PTDETYPE)=4 for Payment Plan admission  *
.* V12.00.01 23/05/2025  Ebon Clements    TSK 0955096                         *
.*           Alphanueric visit number changes                                 *
.* V11.04.01 27/03/2024  Ebon Clements    TSK 0944691                         *
.*           Treat alerts with a future end date as active - CHKALR00         *
.* V11.02.03 15.07.2022  DA Sarkies       TSK 0920112                         *
.*           Moved 0 into CVRCD prior to opening cancer registration table    *
.* V11.02.01 20/06/2022  Ebon Clements    TSK 0920670                         *
.*           Set U/R number before previous address write - PAURNO - UCPAD1   *
.* V11.00.04 29/12/2020  Thanh T          TSK 0878747                         *
.*           Added procedure PATATR00 for multiple birth details              * 
.* V11.00.03 09/09/2020  Peter Vela       TSK 0895969                         *
.*           Added WebServices OECW                                           *
.*           Added WebServices OPVW                                           *
.* V11.00.02 19/06/2020  Ebon Clements    TSK 0893481                         *
.*           Fixed infinite loop in FXDSPT00 - Disaster codes                 *
.* V11.00.01 20/04/2020  Ebon Clements    TSK 0889129                         *
.*           Fixed comment line count I * U - FIXLEG                          *
.* V10.14.04 17/07/2019  Ebon Clements    TSK 0877986                         *
.*           Added 20 zero test to PTCNNSSI using EDWARD                      *
.* V10.14.03 20/07/2019  Richa Phogat     TSK 0864951                         *
.*           Updated FIXCCAUD                                                 *
.* V10.14.02 10/07/2019  Richa Phogat     TSK 0864951                         *
.*           Added FIXCCAUD to copy old UR concession card history records    *
.*           to new UR history (PATCCHFD)                                     *
.* V10.14.01 20/03/2019  J.Tan            TSK 0857392                         *
.*           Changed RCP Transaction count from DIM3 to DIM5                  *
.* V10.12.04 25/06/2018  Ebon Clements     TSK 0845295                        *
.*           Added comerhaf eReferrals - FIXERF00 & COMERH                    *
.* V10.12.03 25/05/2018  Thanh T.          TSK 0856102                        *
.*           Added PMSEHB00 for pmsehbaf                                      *
.* V10.12.02 11/04/2018  Davin            TSK 0844685                         *
.*           Mods to FIXAID: Don't copy UPI records in pmsaidaf to newurno.   *
.*                           Update oldurno with merged date/time/userid.     *
.* V10.12.01 05/04/2018  Steve Armstrong  TSK 0844685                         *
.*           Added PMSMUPFD (Missing UPI file) - FIXMUP                       *
.******************************************************************************
.* V10.11.03 21/09/2017  Thanh T.          TSK 0821710                        *
.*           Audit Amission/outpatient visit comments                         *
.* V10.11.02 18/09/2017  Thanh T.          TSK 0821710                        *
.*           Audit Amission/outpatient visit comments                         *
.* V10.11.01 13/09/2017  Thanh T.          TSK 0821710                        *
.*           Audit Amission/outpatient visit comments                         *
.******************************************************************************
.* V10.10.01 12/04/2017  Peter Vela        TSK 0836016                        *
.*           Always keep bad debt in FIXMAS                                   *
.* V10.08.11 18/08/2016  Ebon Clements     TSK 0260691                        *
.*           Fixed A/H equipment loan merge - FIXLON and FLCM0000             *
.* V10.08.10 08/08/2016  Davin             TSK 0321234                        *
.*           Added chronic condition alert (pmpxsn11)                         *
.* V10.08.09 08/08/2016  Ebon Clements     TSK  0821167                       *
.*           Added update of a referrals mehvi1af record - RMHV0000           *
.* V10.08.08 04/08/2016  Jill Parkinson    TSK  0823534                       *
.*           Changed key32 to key35 for FIXATR                                *
.* V10.08.07 29/07/2016  Don Nguyen         TSK 0809271                       *
.*           Modified FXBKRES1 to also call UPESIS00 (converted to PROC)      *
.* V10.08.06 12/07/2016  Davin          TSK 0315393                           *
.*           Added code for retention details (based on saveretn)             *
.* V10.08.05 30/06/2016  Jill Parkinson TSK 0821774                           *
.*           Added CCC into PTURDATE                                          *
.*           Mods to code for obsmdt/mtx (FIXOBS11) and RSLGACM1 (MMRG0100)   *
.* V10.08.04 18/05/2016  Jill Parkinson TSK 0817063                           *
.*           Mods to increase MHSCCOUN when moving mehscraf records to new UR *
.* V10.08.03 13/05/2016  Don Nguyen         TSK 0319664                       *
.*           Added FIXOBSNT to CHANGEUR - Clinical Observations Notes         *
.* V10.08.02 28/04/2016  Jill Parkinson     TSK 0817063                       *
.*           Added mehscraf and mehpcsaf                                      *
.* V10.08.01 01/04/2016  Steve Armstrong   TSK 0324703                        *
.*           Mods to cater for new PATURCFD field and index change            *
.******************************************************************************
.* V10.07.04 04/02/2015  Peter Vela        CAR 0809659                        *
.*           Added validation for last discharge date for CMERGEUR = 2        *
.*           in FIXMAS                                                        *
.* V10.07.03 04/01/2016  Ebon Clements     TSK 0294154                        *
.*           Added opt out of SMS to prev address file write                  *
.* V10.07.02 27/11/2015  Ebon Clements     CAR 294154                         *
.*           Added FIXOOS - Opt out of SMS                                    *
.* V10.07.01 09/10/2015  Ebon Clements     CAR 316633                         *
.*           Added ALLWLNFD - WL links to referral                            *
.* V10.06.03 30/09/2015  Ania P            CAR 321333                         *
.*           Added DEFPROC FIXLEG                                             *
.* V10.06.02 03/07/2015  J.Tan             CAR 316441                         *
.*           Added FIXPMDAU to update pmsdauaf                                *
.* V10.06.01 10/06/2015  Steve Armstrong   CAR 313856                         *
.*           Mods to use CLVISINT instead of internal clear routine           *
.*           23/04/2015  Jill Parkinson                                       *
.*           Mods to always write to paturncf                                 *
.******************************************************************************
.* V10.05.01 26/08/2014  Ania P         CAR 303210                            *
.*           Added FIXMHHN for table mehhonaf                                 *
.******************************************************************************
.* V10.04.05 05/06/2014  Steve Armstrong  CAR 299293                          *
.*           Changed KEY70 to KEY115 for display on error of patgsrnf merge   *
.* V10.04.04 16/05/2014  Ebon Clements  CAR 300668                            *
.*           Fixed I * U on LEGALTFD - FIXALLEG                               *
.* V10.04.03 11/03/2014  Peter Vela     CAR 218689                            *
.*           Added Theatre Requests BOKRQ1FD                                  *
.* V10.04.02 05/03/2014  J.Tan          CAR 295681                            *
.*           Added SYSTEM to patdetaf file                                    *
.* V10.04.01 22/01/2014  Don Nguyen     CAR 295972                            *
.*           Changed KEY16 to KEY24 for IO calls on patpa1af                  * 
.* V10.03.29 90/12/2013  Peter Vela     CAR 286158                            *
.*           Added Patient Attributes PATATRFD                                * 
.* V10.03.28 08/10/2013  Ebon Clements  CAR 275205                            *
.*           Added EBS created U/R merge functionality. Set 9th character     *
.*           of PPSNAME to R when PSTAT=4                                     *
.* V10.03.27 25/09/2013  Ebon Clements  CAR 275205                            *
.*           Added Electronic booking files PMSAMNFD, PMSARQFD and PMSARVFD   *
.*           PMSAMN00, PMSARQ00 and PMSARV00                                  *
.* V10.03.28 22/08/2013  Ebon Clements  CAR 281169                            *
.*           Added health fund program files PMSUPGFD and PMSAPGFD - FIXPRG   *
.* V10.03.27 19/08/2013  Ebon Clements  CAR 290429                            *
.*           Removed close of BOKRC1A1 and WATTR1A1 from FXBKRES9             *
.* V10.03.26 09/07/2013  Jill Parkinson CAR 288188                            *
.*           Fixed GOTO in WLSGL800                                           *
.* V10.03.25 01/05/2013  Peter Vela       CAR 283938                          *
.*           Added FIXART00                                                   *
.* V10.03.24 12/04/2013  Steve Armstrong  CAR 283973                          *
.*           Added Re-read of new U/R details at FIXLOC90 to restore all      *
.*           PMI variables.                                                   *
.* V10.03.23 05/03/2013  Jill Parkinson   CAR 257831                          *
.*           Added WRUPD000 - demographics updated date/time                  *
.* V10.03.22 07/02/2013  Ebon Clements    CAR 272465                          *
.*           Added OVRCD test to read before update of care team - FIXPCT     *
.* V10.03.21 13/12/2012  Jill Parkinson CAR 278129                            *
.*           Fixed WRWATR00 to use PMVXMHOS not WBSEHOSP                      *
.* V10.03.20 10/12/2012  Steve Armstrong  CAR 275430                          *
.*           Mods to handle left justified unique identifiers in pmstspaf.    *
.*           Also changed to check if the new pmstspaf record already exists  *
.*           and if so, increment unique counter until the new record is      *
.*           unique.                                                          *
.* V10.03.19 16/11/2012  Jill Parkinson   CAR 276517                          *
.*           added updates of wathisaf,watpacaf,wattx1af,watmhdat,watmtxaf,   *
.*           watopaaf, watopsaf and watchaaf into FXBKRES1                    *
.* V10.03.18 01/11/2012  Saroeun Soeur    CAR 275430                          *
.*           added FIXTRNST, FXVT0000                                         *
.* V10.03.17 31/08/2012  Peter Vela       CAR 266428                          *
.*           Added VSINCHON before write to visintaf                          *
.* V10.03.16 31/08/2012  J.Tan            CAR 270090                          *
.*           Mods to call FLAGDEBT after updating invoice file                *
.* V10.03.15 13/08/2012  Steve Armstrong  CAR 256888                          *
.*           Mods to trigger CUA message (DGCLICUA) when an old U/R patgsrnf  *
.*           record is updated with the new U/R.                              *
.* V10.03.14 06/07/2012  Mike Laming       CAR 261603                         *
.*           Correct key for MEHPATaf Key 30 should be KEY32                  *
.* V10.03.13 02/07/2012  Jill Parkinson    CAR 268273                         *
.*           Mods to use PTCNMEMR                                             *
.* V10.03.12 31/05/2012  J.Tan             CAR 259554                         *
.*           Mods Event visit to update invoice file                          *
.* V10.03.11 23/05/2012  Ebon Clements     CAR 265676                         *
.*           Added FIXELF - PMSELFFD and FIXOVR - PMSOVRFD                    *
.* V10.03.10 16/05/2012  Ebon Clements    CAR 265176                          *
.*           Fixed SAVKEY33 length in extra contacts FIXCONT                  *
.* V10.03.09 11/04/2012  Steve Armstrong  CAR 263369                          *
.*           Removed CLOSE of EMRVISA1 in FIXEMR routine, to prevent I*C.     *
.* V10.03.08 04/04/2012  Steve Armstrong  CAR 262582                          *
.*           Fixed FIXLOC routine to restore read on new U/R where a location *
.*           record is not found.                                             *
.* V10.03.07 04/04/2012  Peter Vela     CAR 262395                            *
.*           Added check for emergency visits in VLDTE000                     *
.* V10.03.06 03/04/2012  Don Nguyen     CAR 262735                            *
.*           Added FIXWLC00 to fix waiting list comments merge                *
.* V10.03.05 13/03/2012  Jill Parkinson CAR 261568                            *
.*           Added write to pmswtraf - WA Triggers table                      *
.* V10.03.04 08/12/2011  Jill Parkinson CAR 253264                            *
.*           Removed read locks in FIXMAS                                     *
.* V10.03.03 02/12/2011  Jill Parkinson   CAR 249362                          *
.*           Added counter to alert keys                                      *
.* V10.03.02 29/11/2011  Steve Armstrong  CAR 253264                          *
.*           Added FIXPAC00 routine for watpacaf.                             *
.* V10.03.01 09/11/2011  Ebon Clements  CAR 248529                            *
.*           Added multiple contacts of the same type functionality           *
.******************************************************************************
.* V10.02.08 08/09/2011  Ebon Clements  CAR 250642                            *
.*           Removed close of discharge file - FIXDSC                         *
.* V10.02.07 06/09/2011  Jill Parkinson CAR 249997                            *
.*           Added dispataf and disptlaf                                      *
.* V10.02.07 29/08/2011  Ebon Clements     CAR 242014                         *
.*           Added OUTDEMFD, OUTDANFD and OUTDCOFD                            *
.* V10.02.06 26/07/2011  Steve Armstrong   CAR 240684                         *
.*           Mods to cater for changes to LEGALTFD.                           *
.* V10.02.05 13/07/2011  Steve Armstrong   CAR 240722                         *
.*           Further mods to cater for second given name as                   *
.*           part of PATGSRFD keys                                            *
.* V10.02.04 22/06/2011  Steve Armstrong   CAR 240722                         *
.*           Mods to cater for changes to PATLOCFD.                           *
.*                - LSNAME & LGNAME extended to 40 chars.                     *
.*                - PTLCGNM2 added.                                           *
.*           Mods to cater for changes to PATGSRFD:                           *
.*                - GSRSNAM & GSRGNAM extended to 30 chars.                   *
.*                - PTGSGNM2 added.                                           *
.*                - all indexes changed in length.                            *
.* V10.02.03 09/05/2011  Davin         CAR 239539                             *
.*           Changed to allow 3 alert indicators to be saved (CHKALR00)       *
.* V10.02.02 05/05/2011  Mike Laming   CAR 240720                             *
.*           Add OUTART00 (Appointment Requests "outartaf") - called in FIXOUT*
.* V10.02.01 21/04/2011  Mike Laming   CAR 233229                             *
.*           Added patdetaf (Debt Registration) & Pat.Ind's in ODEBT000       *
.******************************************************************************
.* V10.01.02 02/02/2011  Steve Armstrong   CAR 237520                         *
.*           Mods to remove Detente interface (PATDETNT)                      *
.* V10.01.01 17/01/2011  Ebon Clements    CAR 236087                          *
.*           Added defence force claim file - FIXEXT                          *
.******************************************************************************
.* V10.00.06 26/10/2010  Steve Armstrong  CAR 232111                          *
.*           Added routine for comdepaf.                                      *
.*           Fixed rcpdteaf routine to treat RCDTSFLG as a DIM 1 instead      *
.*           of a DIM 2.                                                      *
.* V10.00.05 18/08/2010 J.Tan            CAR 222031                           *
.*           Mods to set PMMIDUPD and PMMITUPD                                *
.* V10.00.04 28/07/2010  Jill Parkinson CAR 227087 224859                     *
.*           Moved call to URNC0000 to be for each visit                      *
.* V10.00.03 02/07/2010  Ebon Clements CAR 218982                             *
.*           Added WATCHAFD                                                   *
.* V10.00.02 19/04/2010  J.Tan        CAR 219670                              *
.*           Mods to set date/time updated to rcpdteaf file                   *
.* V10.00.01 19/03/2010  Steve Armstrong   CAR 135505                         *
.*           Added HL7TRGID & HL7INCLD setting for all broadcast messages     *
.******************************************************************************
.* V9.12.05  01/03/2009  Steve Armstrong  CAR 217090                          *
.*           Fixed update to paturacf so that it reads the record first with  *
.*           an RD instead of an RA.                                          *
.*           Also removed references to MRGURDIS (which is no longer used)    *
.* V9.12.04  09/10/2009  WeeLee Koo       CAR 181371                          *
.*           Changed from KEY1 to KEY3 for FIXPMPTD > NXTPMPTD                *
.* V9.12.03  27/08/2009  Ebon Clements CAR 202965                             *
.*           Added PMSCDNFD - CDM visit based details                         *
.* V9.12.02  13/05/2009  Jill Habasque CAR 189816                             *
.*           Added FIXNZDTR - fix nzprdtaf                                    *
.*           Added update of pmpxsn15 - bad debt indicator                    *
.* V9.12.01  06/05/2009  WeeLee Koo   CAR 189361                              *
.*           Added FIXEVT- merged events function                             *
.******************************************************************************
.* V9.11.06  02/04/2009  Mike Laming      CAR 166690                          *
.*           Added NZ PRIMHD Tables MEHPRDFD, MEHPLSFD etc. see "PROC FIXMEH" *
.* V9.11.05  19/02/2009  Steve Armstrong  CAR 190455                          *
.*           Mods to include Eclipse tables                                   *
.* V9.11.04  10/12/2008  Ebon Clements    CAR 174080                          *
.*           Added update of bed board files by admission number              *
.* V9.11.03  26/11/2008  Steve Armstrong  CAR 181373                          *
.*           Added check of PTCNTRPR.                                         *
.* V9.11.02  28/10/2008 Ebon Clemengts CAR 174077                             *
.*           Changed key on pmsepbad to key28                                 *
.* V9.11.01  08/10/2008 Ebon Clemengts CAR 174068                             *
.*           Added pmsbbdaf and pmsepbaf                                      *
.******************************************************************************
.* V9.10.03  03/09/2008 J.Tan          CAR 177376                             *
.*           Mods to fix pmsfedaf - Estimation fees file                      *
.* V9.10.02  04/07/2008 Jill Habasque  CAR 162660                             *
.*           Mods to call CHKALR00 to set alert indicator                     *
.* V9.10.01  23/05/2008 J.Tan      CAR 169149                                 *
.*           Added Date and Time invoice created/updated                      *
.******************************************************************************
.* V9.09.09  28/02/2008  Ebon Clements    CAR 162564                          *
.*           Added FIXREL - NZ related provider invoice files                 *
.* V9.09.08  12/02/2008  J.Tan            CAR 135498                          *
.*           Mods MHINC Extract                                               *
.* V9.09.07  30/01/2008  Peter Vela       CAR 155334                          *
.*           Mods to include pmsptdaf                                         *
.* V9.09.06  18/01/2008  Steve Armstrong  CAR 159429                          *
.*           Mods to include legvisaf, legbokaf, legdetaf, legdschf, leginvrf,*
.*           legmissf & legtranf.                                             *
.* V9.09.05  04/01/2008  J.Tan             CAR 135498                         *
.*           Mods for NZ MHINC Extract                                        *
.* V9.09.04  23/11/2007  Peter Vela        CAR 110404                         *
.*           New variables for Write and Update to pmsaidaf                   *
.* V9.09.03  01/10/2007  Sandra Barcham    CAR 151255                         *
.*           Added loop of alllonaf to stop I * U                             *
.* V9.09.02  28/09/2007  Sandra Barcham    CAR 151255                         *
.*           Added loop of allpctaf to stop I * U                             *
.* V9.09.01  07/08/2007  Mike Laming       CAR 146598                         *
.*           Added FIXALLEG (Alternate Legacy file)                           *
.******************************************************************************
.* V9.08.04  20/04/2007  Jill Habasque     CAR 130753                         *
.*           Added check for MRCNACRR in CRMED000                             *
.* V9.08.03  20/04/2007  Steve Armstrong   CAR 111005                         *
.*           Added FIXLON and FIXPCT                                          *
.* V9.08.02  25/01/2007  Peter Vela     CAR 127930                            *
.*           Added MRMADTCR MRMATMCR before WRTMAS1                           *
.* V9.08.01  13/10/2006  Peter Vela    CAR 120583                             *
.*           Defaulted MRMACOMM to SP70 in CRMED000                           *
.******************************************************************************
.* V9.07.03  18/09/2006  Ebon Clements CAR                                    *
.*           Added patient cdm file and alert audits                          *
.* V9.07.02  01/08/2006  Mike Laming   CAR 87846                              *
.*           Correct key data for Write to "warhisaf" at FIXHIS30             *
.* V9.07.01  07/07/2006  Ebon Clements CAR 103365                             *
.*           Added expected payor and extra contact files                     *
.******************************************************************************
.* V9.06.01  14/06/2006  Mike Laming   CAR 87846                              *
.*           Added Waiting List History routine FIXHIS00 and call to it - at  *
.*           FIXTRE60                                                         *
.******************************************************************************
.* V9.05.01  10/03/2006  Mike Laming   CAR 79281                              *
.*           Increase PATFACT3 to KEY27 & add FACODE to key string            *
.* V9.05.B01 21/02/2006  Ebon Clements CAR 76341                              *
.*           Added referral and encounter file audits                         *
.******************************************************************************
.* V9.04.14  01/12/2005  Ebon Clements CAR 86579                              *
.*           Added pack of KEY8 with new ur in FIXMAS when updating           *
.*           pmpsx2af to retain old ur details                                *
.* V9.04.13  25/11/2005  Jill Habasque CAR 82652                              *
.*           Added update of wateseaf                                         *
.* V9.04.12  29/04/2005  Mike Laming   CAR 60976                              *
.*           Added FIXINTR routine to "fix Intepreter Visit Details"          *
.* V9.04.11  02/08/2005  Davin         CAR 64087                              *
.*           Mods for PAS/CIS and proprietary interface changes -             *
.*           removed call to cisa34br                                         *
.* V9.04.10  12/08/2005  J.Tan         CAR 71924                              *
.*           Mods to read parameter to using HIC med claim                    *
.* V9.04.09  27/06/2005  J.Tan         CAR 56699                              *
.*           Mods for HIC files                                               *
.* V9.04.08  20/06/2005  Jill Habasque CAR 61859                              *
.*           Fixed rcpdteaf loop                                              *
.* V9.04.07  28/04/2005  Mike Laming   CAR 61101                              *
.*           Added code so if Old UR Address is to be used, write New UR      *
.*           Address to "patpa1af" Previous Address file - in DOFIRST, before *
.*           FIXMAS                                                           *
.* V9.04.06  04/04/2005  Jill Habasque CAR 59155                              *
.*           Added call to FIXDET00 in FIXTRE00                               *
.* V9.04.05  18/03/2005  Ebon Clements CAR 58443                              *
.*           Added security alerts to set PTMXSIN1 to 2 if security alerts    *
.*           exist TCINDC4 = S                                                *
.* V9.04.04  25/01/2005  Peter Vela    CAR 56906                              *
.*           Added write of old UR's address as a previous address of the new *
.*           UR during UR Merge.                                              *
.* V9.04.03  29/09/2004  Guomin Fu     CAR 19558                              *
.*           Added checking of SAVEDETL flag to override CMERGEUR in FIXMAS   *
.* V9.04.02  27/09/2004  Ebon Clements            CAR 53266                   *
.*           Multi hospital changes for CRMED000 - medical record link        *
.* V9.04.01  24/08/2004  Jill Habasque CAR 50355                              *
.*           Added exit of fixres if no start date is set                     *
.******************************************************************************
.* V9.03.13  02/08/2004  Davin         CAR 34707                              *
.*           Added update of pmsccdaf - concess card file                     *
.* V9.03.12  14/07/2004  Steve Armstrong   CAR 51769                          *
.*           Removed reference to PATHCSUC                                    *
.* V9.03.11  24/06/2004  Jill Habasque CAR 44641                              *
.*           Added update of pmsaidaf - alternate ID                          *
.* V9.03.10  09/06/2004  Sylvek Litewka  CAR 50371                            *
.*           Added procedure FIXPFA (Patient Future Actions).                 *
.*           09/06/2004  Steve Armstrong   PAS-CIS Product Integration        *
.*           Added call to cisa34br routine and mods for rollback on errors   *
.*           for PAS-CIS Interface  CAR  49679                                *
.* V9.03.09  05/04/2004  Jill Habasque CAR 43614                              *
.*           Added setting of CURRYEAR in FIXRES                              *
.* V9.03.08  16/03/2004  Steve Armstrong   HosClaims Phase 1 (48280)          *
.*           Added FIXEDI for patedsaf                                        *
.* V9.03.07  16/02/2004  Peter Vela CAR 38290                                 *
.*           Added variables that are used in MRGURRES                        *
.* V9.03.06  03/12/2003  Davin  CAR 44095                                     *
.*           Removed reference to receipting trans file                       *
.* V9.03.05  14/11/2003 Ebon Clements CAR 42756                               *
.*           Added oprdetaf merge to FIXBKR                                   *
.* V9.03.04  06/11/2003 Peter Vela  CAR 41829                                 *
.*           Added functionality to update the Date Created field when merging*
.*           UR numbers.                                                      *
.* V9.03.03  21/10/2003 J.Tan   CAR 44172                                     *
.*           Mods for Misc.theatre item file                                  *
.* V9.03.02  18.09.2003  Sandra Barcham    43475                              *
.*           Access patgsrnf with key70 not key61                             *
.* V9.03.01  22.05.2003  Ebon Clements CAR 39351                              *
.*           Added function FIXCDL for allied health linked documents         *
.******************************************************************************
.* V9.02.15  25.02.2003  J.Habasque                                           *
.*           Added goto after calling MRGURRES                                *
.* V9.02.14  05.02.2003  J.Tan                                                *
.*           Fixed I*D on paturcaf file                                       *
.*           04.02.2003  Tonii srf 20251                                      *
.*           Changed program to use MRGURRES in place of RESU0000, same       *
.*           as IBAPMS05 (changes ported from 5.09/5.10)                      *
.* V9.02.13  12.12.2002  Lina Vo                                              *
.*           Mods to make program work similar to IBANHI10 & IBAPMS05         *
.*           Added MRGURDIS, FIXOPR, FIXRES, FIXRCP.                          *
.* V9.02.12  06.11.2002  J.Tan                                                *
.*           Mods to change U/R for private practice                          *
.* V9.02.11  05.08.2002  Ebon Clements SRF 20482                              *
.*           Changed FIXLOC to read the location file with the old U/R'S      *
.*           name and update it with the new name and U/R                     *
.* V9.02.10  05.07.2002  Jill Habasque SRF 19273                              *
.*           Added current patient update (pmscuraf)                          *
.*           05.07.2002  Pat Dirito    SRF 17952                              *
.*           Added Current Status setting in routine CRMED000                 *
.* V9.02.09  04.07.2002  Ebon Clements SRF 18833                              *
.*           Corrected loop in FIXBOK00 so file position is not lost          *
.* V9.02.08  26.04.2002  Jll Habasque                                         *
.*           Added update of bokrc1af                                         *
.* V9.02.07  05.03.2002  Dean Cramer                                          *
.*           Added Alert Notes                                                *
.* V9.02.06  07.01.2002  EbonClements                                         *
.*           Added allied health to patient merge                             *
.* V9.02.05  11.12.2001  Jill Habasque                                        *
.*           Mods to save old UR if merging to a new UR                       *
.* V9.02.04  20.11.2001  B.G.Ackland                                          *
.*           Remove pi's from Program                                         *
.* V9.02.03  19/11/2001 Ebon Clements                                         *
.*           Added reads to pmspx2af when patma1af is read                    *
.* V9.02.02  08/11/2001  Mike Laming                                          *
.*           Rename DGCLIMRG to DGCLICMR                                      *
.* V9.02.01  19.10.2001  Ebon Clements                                        *
.*           Set alert present flag when merging a ur with alerts             *
.******************************************************************************
.* V9.01.01  08.09.2001  Sandra Barcham                                       *
.*           Added DOB & SEX to patgsrnf                                      *
.* V9.01.01  08.09.2001  Sandra Barcham                                       *
.*           Added DOB & SEX to patgsrnf                                      *
.******************************************************************************
.* V5.10.B01 17.04.2001  Glenn Saunders                                       *
.*           Remove access to PTCNSNDX and associated processing.             *
.*           Remove all references to PATSUR file (old surname file).         *
.* V5.10.B00 26.03.2001  Ebon Clements                                        *
.*           Created from a copy of CHANGEUR                                  *
.******************************************************************************
.
.********************************************************************** 
. CHGEUR00 : Mainline for Change U/R
.----  this is the old code from IBAPAT02. ( starting from POSTUCNT label )
.********************************************************************** 
.*        V5.10.B01 17.04.2001  Glenn Saunders 
.*                  Remove access to PTCNSNDX and associated processing.      *
.*                  Remove all references to PATSUR file (old surname file).  *
.*        V5.10.B00 26.03.2001  Ebon Clements  
.*                  Created from a copy of CHANGEUR
.******************************************************************************
.
CHANGEUR  CALL      VLDTE000              * Validate U/R's
          BRANCH    EXIT,CHGEUR91:        * new U/R locked by another user
                         CHGEUR92         * currrent admissions exist OR 
.                                             on-leave for both U/R's
          CALL      VLDEM000              * Validate U/R's
          BRANCH    EXIT,CHGEUR91:        * new U/R locked by another user
                         CHGEUR93         * currrent emergency visits  exist
.
          CALL      RDPARM00              * Read Control file parameters
.                                                                      *I-61101
          PROC      DOFIRST               * things needed BEFORE Master changed
.
          PROC      FIXMAS                * Fix Master file
          PROC      FIXPAD                * Change U/R for PADPADFD
          PROC      FIXNMP                * National Master Patient Index file
          PROC      FIXAXE                * Update pataxe with national id.
          CALL      CHKSUR00              * check patgsrnf aliases
          PROC      FIXSUR                * Surname Index file
          PROC      FIXURA                * U/R Changes Audit file
          PROC      FIXOUT                * Outpatient files
          PROC      FIXWAT                * Waiting List files
          PROC      FIXBKR                * Booking files
          PROC      FIXEDI                * EDI summary file
          PROC      FIXECL                * Eclipse claim file
          PROC      FIXCUR                * Fix current patient file
          PROC      FIXCSLF               * case notes location file
          PROC      FIXLNK                * Link File
FIXALRL   PROC      FIXALR                * Alerts File
          PROC      FIXAID                * Alternate ID File
.... moved to be in FIXALR PROC      FIXALN                * Alerts Notes File
          PROC      FIXCCD                * Concession Card File
          PROC      FIXCCAUD              * Concession Card Audit File
          PROC      FIXKWC                * kiwicard file
          PROC      FIXMAM                * Mammography file
.         PROC      FIXMRT                * Medical record tracking file
          PROC      WRAUDT                * Write a record to the Audit
          PROC      FIXPFA                * Patient Future Actions file
          PROC      FDNR0000              * Fix Donor file
.
          PROC      MRGUREOC              * EOC & ACC
.
          MOVE      OLDURNO,OCCURNO
          MOVE      NEWURNO,NCCURNO
          PROC      MRGURPRI              * Change U/R for Private practice
.         PROC      MRGURCCS              * Clinical Costing Interface
          PROC      MRGURCCI              * Clinical Costing Interface
          PROC      MRGURWEB              * WEB
.
          PROC      DELMRG00              * Delete or Merge U/R?
          CALL      VISITS00              * Change U/R for Visit details
          PROC      FIXWC1                * Change U/R for patwc1af
          PROC      FIXWMA                * Change U/R for patwmabf
          PROC      FIXOPR                * Change U/R for Theatre History
          PROC      FIXRES                * Change U/R for Clinical Results
          PROC      FIXRCP                * Change U/R for receipting details
          PROC      FIXINTR               * Change Interpreter details
          PROC      FIXCONT               * Change U/R for extra contacts
          PROC      FIXEPAY               * Change U/R for expected payor
          PROC      FIXCDM                * Change U/R for cdm 
          PROC      FIXCDME               * Change U/R for cdm visit level
          PROC      FIXMEH                * Change MEH details
          CALL      FIXLON                * Change U/R for alllonaf
          PROC      FIXFES                * Fees Estimation Details
          CALL      FIXPCT                * Change U/R for allpctaf
          PROC      FIXBED                * Change U/R for pmsbbdaf
          PROC      FIXEXP                * Change U/R for pmsepbaf
          CALL      FIXALLEG              * Change U/R for legaltaf (Alt Legacy)
          CALL      FIXLGVIS              * Change U/R for legvisaf
          CALL      FIXPMPTD              * Change U/R for pmsptdaf
          PROC      COMDEP00              * Change U/R for comdepaf
          PROC      FIXDIS00              * Change U/R for dispataf and disptlaf
.
FIXURCOM  PROC      PATCOM00              * Change U/R for PATCOMFD
.         PROC      RUSERR00              * Change U/R for RUSERRFD
          PROC      FIXEXT                * Change U/R for pmsextaf
          PROC      FIXELF                * Change U/R for pmselfaf
          PROC      FIXOVR                * Change U/R for pmsovraf
          PROC      FIXTRNST              * Change U/R for pmstspaf
          PROC      FIXPRG                * Change U/R for pmsupgaf and pmshphaf
          PROC      FIXEBS00              * Change U/R for electronic bookings
          PROC      FIXMHHN               * Change U/R for mehhonaf
          PROC      FIXLEG                * Change U/R for legacmaf
.
CHGEUR80  PROC      PATATR00              * Change U/R for multiple birth
          PROC      FIXATR

          PROC      FIXPMDAU              * Change U/R for pmsdauaf
          PROC      FIXRQ1
          PROC      FIXOOS                * Change U/R for pmsoosaf
          PROC      FIXOBSNT              * Change U/R for obsmdtaf & obsmtxaf
          PROC      FIXMUP                * Change U/R for pmsmupaf
          CALL      PMSEHB00              * Change U/R for pmsehbaf
          PROC      COMERH                * Change U/R for comerhaf
          PROC      FIWELF                * Change U/R for webelfaf 
          PROC      FIWOPV                * Change U/R for webopvaf
.
          CALL      ENDCHGUR              * Finished!
          BRANCH    EXIT,CHGEUR91         * error - rollback
.
          MOVE      ZERO,EXIT
          GOTO      CHGEUR99
.
CHGEUR91  MOVE      ONE,EXIT
          GOTO      CHGEUR99
.
CHGEUR92  MOVE      TWO,EXIT
          GOTO      CHGEUR99
.
CHGEUR93  MOVE      THREE,EXIT
          GOTO      CHGEUR99
.
CHGEUR99  RETURN
+
.***************************************************************************
. VLDTE000 : Validate U/R's
. returns  : EXIT = 1 : new U/R locked by another user
.                 = 2 : Current admissions exist OR on-leave for both U/R's
.***************************************************************************
VLDTE000  MOVE      ZERO,EXIT
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,EXISTFL
          BRANCH    OVRCD,VLDTE999,VLDTE100
          GOTO      VLDTE200
.
VLDTE100  DISPLAY   *P1:24,*EL,"Patient U/R No. ",*V2LON,PURNO,*HOFF:
                    " Busy on Terminal ",*V2LON,PPORT,*HOFF,".  ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      VLDTE999
.
.       We have two U/R numbers that both exist. If both have a current
.       admission or on-leave patient, then we cannot allow the change
.       as this would result in the patient being in hospital twice at
.       the same time. ie. In two seperate beds at the same time.
.
VLDTE200  OPEN      PATVISA2,"patvisaf"
          PACK      KEY24,PURNO,SP30
          CALL      RDSVISA2
VLDTE250  CALL      RDKVISA2
          BRANCH    OVRCD,VLDTE999
          MATCH     PURNO,PVIURNO
          GOTO      VLDTE999 IF NOT EQUAL
.
.         Only check inpatients
.
          COMPARE   THREE,PVITYPE
          GOTO      VLDTE250 IF NOT EQUAL
.
.         have found first admission number - ignore Pre-adms & Discharges
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VLDTE250
.
          BRANCH    ASTAT,VLDTE250,VLDTE400,VLDTE250,VLDTE400,VLDTE250
          GOTO      VLDTE250
.
. ------- NEW UR is in Hospital, now check the OLD U/R number -------
.
VLDTE400  PACK      KEY24,OURNO,SP30
          CALL      RDSVISA2
VLDTE450  CALL      RDKVISA2
          BRANCH    OVRCD,VLDTE999
          MATCH     OURNO,PVIURNO
          GOTO      VLDTE999 IF NOT EQUAL
.
.         We are only interested in inpatients
.
          COMPARE   THREE,PVITYPE
          GOTO      VLDTE450 IF NOT EQUAL
.
.         Read admission file
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VLDTE450
.
          BRANCH    ASTAT,VLDTE450,VLDTE500,VLDTE450,VLDTE500,VLDTE450
          GOTO      VLDTE450
.
.         We have current admissions or on-leave for both U/R's
.
VLDTE500  DISPLAY   *P1:23,*Ef,*B,"Both U/R Numbers have a ":
                    "Current Admission or On Leave patient.   ",*P1:24;
          CALL      HITENTER
.
. ------- Release U/R's -------
.
          MOVE      OURNO,KEY8
          CALL      UUPTMAS1                * Release old U/R
          MOVE      NEWURNO,KEY8
          CALL      UUPTMAS1                * Release the new U/R
          MOVE      TWO,EXIT
.
VLDTE999  RETURN
+
.***************************************************************************
. VLDEM000 : Validate U/R's for emergency visits
. returns  : EXIT = 1 : new U/R locked by another user
.                 = 2 : Current emergency visits exist
.***************************************************************************
VLDEM000  MOVE      ZERO,EXIT
.   *** if multiple current emr visits allowed, exit
.
          READ      CONTROLF,HUND18;*244,PTCNMEMR
          MATCH     "1",PTCNMEMR
          GOTO      VLDEM999 IF EQUAL
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,EXISTFL
          BRANCH    OVRCD,VLDEM999,VLDEM100
          GOTO      VLDEM200
.
VLDEM100  DISPLAY   *P1:24,*EL,"Patient U/R No. ",*V2LON,PURNO,*HOFF:
                    " Busy on Terminal ",*V2LON,PPORT,*HOFF,".  ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      VLDEM999
.
.       We have two U/R numbers that both exist. If both have a current
.       emergency visit , then we cannot allow the change
.       as this would result in the patient being in hospital twice at
.       the same time. 
.
VLDEM200  OPEN      PATVISA2,"patvisaf"
          PACK      KEY24,PURNO,SP30
          CALL      RDSVISA2
VLDEM250  CALL      RDKVISA2
          BRANCH    OVRCD,VLDEM999
          MATCH     PURNO,PVIURNO
          GOTO      VLDEM999 IF NOT EQUAL
.
.         Only check emergency visits
.
          COMPARE   ONE,PVITYPE
          GOTO      VLDEM250 IF NOT EQUAL
.
.         have found first emergency vis number 
.
          MOVE      PVIBILL,EMVIADMN
          MOVE      EMVIADMN,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,VLDEM250
.
          BRANCH    EMVISTAT,VLDEM400,VLDEM250,VLDEM250,VLDEM250
          GOTO      VLDEM250
.
. ------- NEW UR is in Hospital, now check the OLD U/R number -------
.
VLDEM400  PACK      KEY24,OURNO,SP30
          CALL      RDSVISA2
VLDEM450  CALL      RDKVISA2
          BRANCH    OVRCD,VLDEM999
          MATCH     OURNO,PVIURNO
          GOTO      VLDEM999 IF NOT EQUAL
.
.         We are only interested in emergency visits
.
          COMPARE   ONE,PVITYPE
          GOTO      VLDEM450 IF NOT EQUAL
.
.         Read emergency file
.
          MOVE      PVIBILL,EMVIADMN
          MOVE      EMVIADMN,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,VLDEM450
.
          BRANCH    EMVISTAT,VLDEM500,VLDEM450,VLDEM450,VLDEM450
          GOTO      VLDEM450
.
.         We have current emergency visits for both U/R's
.
VLDEM500  DISPLAY   *P1:23,*Ef,*B,"Both U/R Numbers have a ":
                    "Current emergency visit.   ",*P1:24;
          CALL      HITENTER
.
. ------- Release U/R's -------
.
          MOVE      OURNO,KEY8
          CALL      UUPTMAS1                * Release old U/R
          MOVE      NEWURNO,KEY8
          CALL      UUPTMAS1                * Release the new U/R
          MOVE      TWO,EXIT
.
VLDEM999  RETURN
+
.********************************************************************
. RDPARM00 - Read control file parameters
.********************************************************************
RDPARM00  OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,EIGHTY8;*116,CHCSDTE
.
          READ      CONTROLF,TEN;*60,CMEDSERV
          READ      CONTROLF,TEN3;*244,CHCS
          READ      CONTROLF,TEN4;*249,CURCHG
          READ      CONTROLF,TWENTY;*186,PTCNUCSL,*196,PTCNUCRD,PTCNUFML:
                    *225,PTCNNMDX
          READ      CONTROLF,THIRTY1;*174,OTCNULET
          READ      CONTROLF,FIFTY9;*78,CMERGURS,*84,CMERGEUR,*86,CDETENTE:
                                    *92,CDETPATH:
                                    *225,PTCNUURC,*234,PTCNNMPI
          READ      CONTROLF,TWENTY1;*138,PTCNNHII,PTCNNHID,PTCNDONR,PTCNMEDW:
                             PTCNUDNG,*178,PTCNMPTR,PTCNLNCD,PTCNLP01:
                             *189,PTCNUONL,PTCNPCON,PTCNNHIF
          READ      CONTROLF,SEVENTY7;*240,PTCNAXEU
          READ      CONTROLF,EIGHTY;*138,PTCNNZUR
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC,PTCNUACC
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,TEN;*250,CAUDA1
.
          STRIP     PTCNNMDX
.
RDPARM99  RETURN
+
.*****************************************************************************
.*                              CHKSUR00                                     *
.*         Loop through the patgsrnf records for the old U/R looking         *
.*         for alias records that will be "added" to the new U/R.  For each  *
.*         one found, trigger an "add" alias message (CUA).                  *
.*****************************************************************************
.
CHKSUR00  DISPLAY   *P1:24,"Checking : patgsrnf",*EL
.
.         Check all the surname index records for the old U/R number
.
          PACK      KEY115,OURNO,SP70,SP70
CHKSUR05  CALL      RSPTGSR1                     * position on old U/R
CHKSUR10  CALL      RKPTGSR1                     * read next record
          BRANCH    OVRCD,CHKSUR99               * eof - finished
.
          MATCH     GSRURNO,OURNO                * same U/R still ?
          GOTO      CHKSUR99 IF NOT EQUAL        * no - finished
.
.         Save the key to the current record
.
          PACK      SVKEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                             GSRSEX
.
.         Check if an equivalent record exists for the new U/R
.
          PACK      KEY115,NEWURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1
          BRANCH    OVRCD,CHKSUR30
.
.         Alias already exists for new U/R, so ignore record
.
          MOVE      SVKEY115,KEY115
          GOTO      CHKSUR05
.
.         Re-read the old U/R patgsrnf record and then trigger an "add"
.         alias CUA message using the new U/R
.
CHKSUR30  MOVE      SVKEY115,KEY115
          CALL      RDPTGSR1                * record on file ?
          BRANCH    OVRCD,CHKSUR10          * no - get next record
.
          MOVE      ONE,FORM1               * inserting alias flag
          MOVE      NEWURNO,GSRURNO
          MOVE      TWO,HL7TRGID
          MOVE      "WEBCHGUR",HL7INCLD
          PROC      DGCLICUA                * trigger alias message (CUA)
.
          GOTO      CHKSUR10                * get next record
.
CHKSUR99  RETURN
+
.**********************************************************************
.*             Theatre History Update                                 *
.**********************************************************************
          DEFPROC   FIXOPR    
.
          INC       OPRHISFD/INC
.
OPRH0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPRHISA1,"oprhisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOPR  
.
          MOVE      "oprhisaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
          PACK      KEY38 WITH PVIURNO,SP30
          CALL      RSOPHIS1
OPRH1000  CALL      RKOPHIS1
          BRANCH    OVRCD OF OPRH9000
.
          MATCH     PVIURNO,OPHIURNO
          GOTO      OPRH9000 IF NOT EQUAL
.
          MOVE      NEWURNO,OPHIURNO
          CALL      UPOPHIS1
          GOTO      OPRH1000
.
OPRH9000  CLOSE     OPRHISA1
          GOTO      ENDOPR   
.
          INC       IBAOVRIO/INC
          INC       OPRHISIO/INC
.
ENDOPR    ENDPROC
+
.**********************************************************************
.*             Clinical Results Master Table                          *
.**********************************************************************
          DEFPROC   FIXRES    
.
          INC       RESCLNFD/INC
          INC       RESDEAFD/INC
          INC       RESHEAFD/INC
          INC       RESLNKFD/INC
          INC       RESLURFD/INC
          INC       RESPHRFD/INC
.
CURRYEAR  FORM      4
DCURYEAR  DIM       4
DIM4      DIM       4                       * I CAR 38290
FORM4     FORM      4                       * I CAR 38290
FORM4A    FORM      4                       * I CAR 38290
HUNDRED9  FORM      "109"                   * I CAR 38290
RESLNKFL  DIM       8                       * I CAR 38290
PRELEN    INIT      "reln"                  * I CAR 38290
RESULTYR  FORM      4
RESFNAME  DIM       8
SAVKEY10  DIM       10
.
PREDEA    INIT      "reda"
PREHEA    INIT      "reha"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUNDRED9;*204,PTCNRSYR        * I CAR 38290
.
          MOVE      PTCNRSYR,FORM4
          IF        FORM4<1980
            GOTO      ENDRES
          ENDIF
.
          CALL      IBACLOCK
          PACK      DCURYEAR,CCC,CYY
          REP       " 0",DCURYEAR
          MOVE      DCURYEAR,CURRYEAR
.
          CALL      MRGURRES
          GOTO      ENDRES
.
          INC       MRGURRES
          INC       IBAOVRIO/INC
          INC       RESCLNIO/INC
          INC       RESDEAIO/INC
          INC       RESHEAIO/INC
          INC       RESLNKIO/INC
          INC       RESLURIO/INC
          INC       RESPHRIO/INC
.
ENDRES    ENDPROC
+
.**********************************************************************
.*                            COMDEP00                                *
.*                  Update Common Deposit File                        *
.**********************************************************************
          DEFPROC   COMDEP00
.
          INC       COMDEPFD/INC
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"comdepaf"
          TRAP      OVERCOND IF IO
          OPEN      COMDEPA3,"comdepaf"
          TRAPCLR   IO
.
          BRANCH    OVRCD,COMDEP99
.
          MOVE      "comdepaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
COMDEP10  PACK      KEY34,OLDURNO,SP30,SP10
          CALL      RSCMDEP3                * position in file
COMDEP11  CALL      RKCMDEP3                * read next record
          BRANCH    OVRCD,COMDEP99          * end of file
.
          MATCH     CMDEURNO,OLDURNO        * same number ?
          GOTO      COMDEP99 IF NOT EQUAL   * no - ignore
.
          MATCH     "1",CMDESFLG            * PMI U/R number ?
          GOTO      COMDEP11 IF NOT EQUAL   * no - ignore
.
          DISPLAY   *P30:24,*EL,"Deposit : ",*V2LON,CMDERECN,CMDETCNT;
.
          MOVE      NEWURNO,CMDEURNO        * load new U/R number
          PACK      CMDEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",CMDEUDAT           * date updated
          CLOCK     TIME,CMDEUTIM           * time updated
          MOVE      USERID,CMDEUUID         * web user id
          CALL      UPCMDEP3                * update record
          GOTO      COMDEP10                * get next record
.
COMDEP99  CLOSE     COMDEPA3
          GOTO      ENDCMDEP
.
          INC       IBAOVRIO/INC
          INC       COMDEPIO/INC
.
ENDCMDEP  ENDPROC
+
.**********************************************************************
.*                            RCPD0000                                *
.*                  Update Receipting Details File                    *
.**********************************************************************
          DEFPROC   FIXRCP    
.
          INC       RCPDTEFD/INC
.
NORCP     FORM      1                  * Receipting
.
          MOVE      ZERO,NORCP
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"rcpdteaf"
          TRAP      OVERCOND IF IO
          OPEN      RCPDTEA5,"rcpdteaf"
          TRAPCLR   IO
          MOVE      OVRCD,NORCP
.
RCPD0000  BRANCH    NORCP,RCPD9999
.
          OPEN      RCPDTEA1,"rcpdteaf"
.
          MOVE      "rcpdteaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
RCPD1000  PACK      KEY25,OLDURNO,SP20
          CALL      RSRCDTE5                * position in file
          CALL      RKRCDTE5                * read next record
          BRANCH    OVRCD,RCPD9999          * end of file
.
          MATCH     RCDTURNO,OLDURNO        * same number ?
          GOTO      RCPD9999 IF NOT EQUAL   * no - ignore
.
          MATCH     "1",RCDTSFLG            * PMI U/R number ?
          GOTO      RCPD1000 IF NOT EQUAL   * no - ignore
.
          DISPLAY   *P30:24,*EL,"Receipt : ",*V2LON,RCDTRECN,RCDTTCNT;
.
          MOVE      NEWURNO,RCDTURNO        * load new U/R number
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE5                * update record
          GOTO      RCPD1000                * get next record
.
RCPD9999  CLOSE     RCPDTEA5
          GOTO      ENDRCP
.
          INC       IBAOVRIO/INC
          INC       RCPDTEIO/INC
.
ENDRCP    ENDPROC
+
.******************************************** Start of addition        *I-61101
.********************************************************************
. PROC DOFIRST : anything that has to be done BEFORE the Master is changed
. parameters   : EXISTFL
.********************************************************************
          DEFPROC   DOFIRST
.
          INC       PATPA1FD/INC
.                                           * If "Keep Details" of Old UR,
.                                           * write New UR Current Address to
.                                           * "patpa1af" Prev. Address file
DOFI1000  IF        SAVEDETL=1
            OPEN      PATPA1A1,"patpa1af"   * Open file
            MOVE      NEWURNO,KEY8          * get the new Master
            CALL      RDMAST1
            PACK      PADATE,CCC,CYY,CMM,CDD
            REPLACE   " 0",PADATE
.
            MOVE      NEWURNO,PAURNO
            MOVE      PADD1,PAADD1
            MOVE      PADD2,PAADD2
            MOVE      PSUBRB,PASUBR
            MOVE      PADD4,PAADD4
            MOVE      PPOST,PAPOST
            MOVE      PTELEP,PATELEP
            MOVE      PTELEB,PATELEB
            MOVE      PTMXCELL,PTPAMOBL
            MOVE      PMPXPEML,PTPAEMAL
            MOVE      PTMXOSMS,PTPAOSMS
            CALL      IBACLOCK
            PACK      PTPALUPD,CCC,CYY,CMM,CDD
            REPLACE   " 0",PTPALUPD
            CLOCK     TIME,PTPALUPT
            MOVE      USERID,PTPAWEBU
            MOVE      SP70,PTPASPAR
            MOVE      PTPALUPT,PATIME
            PACK      KEY24,NEWURNO,PADATE,PATIME
            CALL      RDAPADD1
            IF        OVRCD = 1
              CALL      WRPADD1
            ENDIF
          ENDIF
.
          GOTO      DOFI9999
.
          INC       IBAOVRIO/INC
          INC       PATPA1IO/INC
.
DOFI9999  ENDPROC
.********************************************   End of addition        *I-61101
.
.********************************************************************
. PROC FIXMAS : Fix master file
. parameters  : EXISTFL
.********************************************************************
          DEFPROC   FIXMAS    
.
          INC       PATDETFD/INC
          INC       SAVPMIFD/INC
.
SVSN12    DIM       1
SVSN13    DIM       1
SVSN14    DIM       1
SVSN15    DIM       1
SVRPER    DIM       3
SVRDAT    DIM       8
.
.       Read in the master file data that was corrected on the screen
.
.   CMERGEUR = 1 - Save old U/R details to Correct U/R
.   CMERGEUR = 2 - Save new U/R details to Correct U/R
.
....  I- 19558
          IF        SAVEDETL=1
            ASSIGN    ONE,CMERGEUR
          ELSE
            ASSIGN    TWO,CMERGEUR
          ENDIF
....
          IF        EXISTFL = 1
            MOVE      OURNO,KEY8            * new ur does not exist so move old
            CALL      RDMAST1              * To new
            MOVE      NEWURNO,PURNO
            MOVE      NEWURNO,KEY8
            MOVE      ZERO,PSTAT
.                                         * I CAR 41829
            IF        MRGURDAT = 1
              MOVE      PTMXRDAT,MRGODDAT
              CLEAR     PTMXRDAT
              CALL      IBACLOCK
              PACK      PTMXRDAT,CCC,CYY,CMM,CDD
              RESET     PTMXRDAT
              REP       " 0",PTMXRDAT
              CALL      WRMAST1
              MOVE      MRGODDAT,PTMXRDAT
            ELSE
              CALL      WRMAST1
            ENDIF      
.                                         * end I CAR 41829
.           CALL      WRMAST1             * D CAR 41829
            CALL      CRMED000            * create medical record
.
            MOVE      OURNO,KEY8          * new ur does not exist so move old
            CALL      RDPMPX21            * To new
            MOVE      NEWURNO,PMPXURNO
            MOVE      NEWURNO,KEY8
            CALL      WRPMPX21
.
         ELSE                             
            IF        CMERGEUR = 1
              MOVE      OURNO,KEY8
              CALL      RDMAST1            * read in old
              CALL      SAVEPMI             * Save the details
              MOVE      NEWURNO,KEY8        * read in new
              CALL      RDMAST1
.
              IF        PBDEBT=ONE
                MOVE      ONE,SVRSBDBT
              ENDIF
.
              CALL      RESTPMI             * restore old details
              MOVE      NEWURNO,PURNO 
              MOVE      ZERO,PSTAT
              CALL      UPMAST1            * update the master
.
              MOVE      OURNO,KEY8
              CALL      RDPMPX21          * read in old
              CALL      SVPMSPX2          * save the old details
              MOVE      NEWURNO,PMPXURNO  * read in new
              MOVE      NEWURNO,KEY8      * read in new  
              CALL      RDPMPX21         
              CALL      RSPMSPX2          * restore values
              CALL      UPPMPX21          * update master exten file two
.
            ELSE
.
              MOVE      OURNO,KEY8
              CALL      RDMAST1             * read in old
.
              MOVE      PLDDATE,SVRSLDDT
              MOVE      PBDEBT,SVRSBDBT
.
              MOVE      NEWURNO,KEY8
              CALL      RDMAST1
.
              MOVE      ZERO,PSTAT          * make active
.
              MATCH     SVRSLDDT,PLDDATE
              IF        @LESS
                MOVE      SVRSLDDT,PLDDATE  save last dsc date if later
              ENDIF
.
              IF        PBDEBT<>ONE
                MOVE      SVRSBDBT,PBDEBT
              ENDIF
.
              CALL      UPMAST1            * update the master
.
              MOVE      NEWURNO,KEY8
              CALL      RDPMPX21            * read ext file details
            ENDIF
          ENDIF
.
          MOVE      NEWURNO,PURNO
          CALL      WRUPD000
.
.                            * Update outstanding debt indicators as required
          CALL      ODEBT000                * update Patient Debt Indicators
.
          IF        SAVERETN = 1
            PACK      KEY8,OLDURNO,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,FIXMAS99
.
            MOVE      PMPXRPER,SVRPER
            MOVE      PMPXRDAT,SVRDAT
.
            MOVE      NEWURNO,KEY8
            CALL      RDPMPX21
            BRANCH    OVRCD,FIXMAS99
.
            MOVE      SVRPER,PMPXRPER
            MOVE      SVRDAT,PMPXRDAT
            CALL      UPPMPX21
          ENDIF
.
          GOTO      FIXMAS99
.
.                                 * routines for FIXMAS ----------------------
.
.         Make sure that the outstanding debts are set for the new U/R -
.         (pmspx2af.pmpxsn12, pmpxsn13, pmpxsn14 & pmpxsn15 and "patdetaf")
.                               (also in IBAPMS05)
ODEBT000  MOVE      ZERO,OVRCD
          UNPACK    SP70,SVSN12,SVSN13,SVSN14,SVSN15
          DISPLAY   *P64:24,"patdetaf"
          OPEN      PATDETA2,"patdetaf"
.
ODEBT100  PACK      KEY18,OLDURNO,SP70
          CALL      RSPTDET2
ODEBT200  CALL      RKPTDET2
          BRANCH    OVRCD,ODEBT400
.
          MATCH     OLDURNO,PTDEURNO
          GOTO      ODEBT400 IF NOT EQUAL
.
          MOVE      PTDETYPE,FORM1
          MATCH     SP8,PTDEDTCL            * is debt still active ?
          IF        @EQUAL
            STORE     "1",FORM1,SVSN12,SVSN13,SVSN14,SVSN13   * debt active
          ENDIF
.
          MOVE      NEWURNO,PTDEURNO
          CALL      UPPTDET2
          GOTO      ODEBT100
.
.
ODEBT400  PACK      KEY8,OLDURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ODEBT999
.
          MOVE      PMPXSN15,SVSN15         * save BAD DEBT indicator
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ODEBT999
.
          MOVE      "0",KEY1
          MATCH     "1",SVSN12
          IF        @EQUAL
            MOVE      "1",PMPXSN12
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN13
          IF        @EQUAL
            MOVE      "1",PMPXSN13
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN14
          IF        @EQUAL
            MOVE      "1",PMPXSN14
            MOVE      "1",KEY1
          ENDIF
          MATCH     "1",SVSN15
          IF        @EQUAL
            MOVE      "1",PMPXSN15
            MOVE      "1",KEY1
          ENDIF
.
          MATCH     "1",KEY1
          IF        @EQUAL
            CALL      UPPMPX21
          ENDIF
.
ODEBT999  RETURN
.
OVERCOND MOVE      ONE,OVRCD
          RETURN
.
          INC       SVRSPMI
          INC       PATDETIO/INC
.
FIXMAS99  MOVE      NEWURNO,KEY8
          MOVE      OURNO,KEY8
          CALL      UUPTMAS1                * Release old U/R
          MOVE      NEWURNO,KEY8
          CALL      UUPTMAS1                * Release the new U/R
          ENDPROC
++
.
.       ==============================================
.       Procedure  to fix up the Previous Address file
.       ==============================================
.
          DEFPROC   FIXPAD    
.
          INC       PATPA1FD/INC
.
          OPEN      PATPA1A1,"patpa1af"                 * Open file
          DISPLAY   *P1:24,"Updating : ",*V2LON,"patpa1af",*EL
.
.         Change all the previous address records for this U/R number
.
PADDLP    PACK      KEY24,OURNO,SP20
          CALL      RDSPADD1
          CALL      RDKPADD1
          BRANCH    OVRCD,UCPADD                                       *C-56906
          MATCH     PAURNO,OURNO
          GOTO      UCPADD IF NOT EQUAL                                *C-56906
.
.       Check if new key already exists
.
          PACK      KEY24,NEWURNO,PADATE,PATIME
          CALL      RDAPADD1
          BRANCH    OVRCD,CPADDR
.
.       Delete current record
.
          PACK      KEY24,PAURNO,PADATE,PATIME
          CALL      DEPADD1
          GOTO      PADDLP
.
.       Change U/R number for this record
.
CPADDR    PACK      KEY24,OURNO,PADATE,PATIME
          CALL      RDPADD1
          BRANCH    OVRCD,CORRPAD
.
          MOVE      NEWURNO,PAURNO
          CALL      UPPADD1
          GOTO      PADDLP
.
CORRPAD   DISPLAY   *P1:24,*B,*EL,"Corrupt file : patpa1af.   Contact IBA.  ";
          CALL      HITENTER
          GOTO      ENDPAD
.
UCPADD    COMPARE   ONE,CMERGEUR                                       *I-56906
          GOTO      ENDPAD IF EQUAL
.
          PACK      KEY8,OURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ENDPAD
.
          PACK      PADATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",PADATE
          CLOCK     TIME,PATIME
          PACK      KEY24,NEWURNO,PADATE,PATIME
          CALL      RDAPADD1
          BRANCH    OVRCD,UCPAD1
.
          MOVE      NEWURNO,PAURNO
          MOVE      PADD1,PAADD1
          MOVE      PADD2,PAADD2
          MOVE      PSUBRB,PASUBR
          MOVE      PADD4,PAADD4
          MOVE      PPOST,PAPOST
          MOVE      PTELEP,PATELEP
          MOVE      PTELEB,PATELEB
          MOVE      PTMXCELL,PTPAMOBL
          MOVE      PMPXPEML,PTPAEMAL
          CALL      IBACLOCK
          PACK      PTPALUPD,CCC,CYY,CMM,CDD
          REPLACE   " 0",PTPALUPD
          CLOCK     TIME,PTPALUPT
          MOVE      USERID,PTPAWEBU
          MOVE      SP70,PTPASPAR
          CALL      UPPADD1
          GOTO      UCPAD2
.
UCPAD1    MOVE      NEWURNO,PAURNO
          MOVE      PADD1,PAADD1
          MOVE      PADD2,PAADD2
          MOVE      PSUBRB,PASUBR
          MOVE      PADD4,PAADD4
          MOVE      PPOST,PAPOST
          MOVE      PTELEB,PATELEB
          MOVE      PTMXCELL,PTPAMOBL
          MOVE      PMPXPEML,PTPAEMAL
          MOVE      PTMXOSMS,PTPAOSMS
          CALL      IBACLOCK
          PACK      PTPACDTE,CCC,CYY,CMM,CDD
          REPLACE   " 0",PTPACDTE
          CLOCK     TIME,PTPACTIM
          MOVE      USERID,PTPAWEBC
          MOVE      SP70,PTPALUPD
          MOVE      SP70,PTPALUPT
          MOVE      USERID,PTPAWEBU
          MOVE      SP70,PTPASPAR
          CALL      WRPADD1
.
UCPAD2    PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          GOTO      ENDPAD                                         *end I-56906
.
          INC       IBAOVRIO/INC
          INC       PATPA1IO/INC
.
ENDPAD    ENDPROC
++
.
.       ===========================================
.       Procedure  to fix up the Surname index file
.       ===========================================
.
          DEFPROC   FIXSUR    
.
          INC       PATGSRFD/INC      * Surname/Given names Index file
.
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          CALL      FXOTHSUR   * using other surname file
          GOTO      ENDSUR
.
. ------- fix PATGSRFD -------
.
FXOTHSUR  DISPLAY   *P1:24,"Updating : patgsrnf",*EL
.
.         Change all the surname index records for this U/R number
.
FXOTH100  MOVE      OURNO,GSRURNO
          PACK      KEY115,GSRURNO,SP70,SP70
          CALL      RSPTGSR1
          CALL      RKPTGSR1
          BRANCH    OVRCD,FXOTH999
.
          MATCH     GSRURNO,OURNO
          GOTO      FXOTH999 IF NOT EQUAL
.
.       Check if this name combo already exists
.
          PACK      KEY115,NEWURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX,SP70,SP70
          CALL      RAPTGSR1
          BRANCH    OVRCD,FXOTH300
.
.       New name already exists - just delete old record
.
FXOTH200  PACK      KEY115,OURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX,SP70,SP70
          CALL      DEPTGSR1
          GOTO      FXOTH100
.
.       Update this record with the new U/R number
.
FXOTH300  PACK      KEY115,OURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX,SP70,SP70
          CALL      RDPTGSR1
          BRANCH    OVRCD,FXOTH400
.
          MOVE      NEWURNO,GSRURNO
          CALL      UPPTGSR1
          GOTO      FXOTH100
.
FXOTH400  DISPLAY   *P1:23,*EL,*B,"Corrupt file : patgsrnf.  Contact IBA.  ";
          DISPLAY   *P1:24,*EL,"Key is : ",KEY115,".  ";
          CALL      HITENTER
.
FXOTH999  RETURN
.
          INC       IBAOVRIO/INC
          INC       PATGSRIO/INC
.
ENDSUR    ENDPROC
++
.
.       ==============================================
.       Procedure  to fix up the PMI change audit file
.       ==============================================
.
          DEFPROC   FIXURA    
.
          INC       PATURAFD/INC
.
          OPEN      PATURAD1,"paturadf"
          OPEN      PATURAD2,"paturadf"
.
          DISPLAY   *P1:24,"Updating : paturadf",*EL
.
.       Update the PMI Change Audit file
.       The problems here are that there should only be up to two records
.       in the file, one with URRTYPE="A" and one with URRTYPE="C"
.
URCHGLP   PACK      KEY17,OURNO,SP10
          CALL      RDSURAD2
          CALL      RDKURAD2
          BRANCH    OVRCD OF URCHGL2
.
          MATCH     OURNO,URURNO
          GOTO      URCHGL2 IF NOT EQUAL
.
.       Check if the new record exists already. If so, delete it.
.
          PACK      KEY17,URRTYPE,URDATE,PURNO
          CALL      RDAURAD1
          COMPARE   ZERO TO OVRCD
          CALL      DEURAD1 IF EQUAL
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      RDURAD1
          BRANCH    OVRCD OF CORRUR
.
          MOVE      PURNO,URURNO
          CALL      UPURAD1
          GOTO      URCHGLP
.
CORRUR    DISPLAY   *P1:24,*EL,*B,"Corrupt file : paturadf.  Contact IBA.  ";
          CALL      HITENTER
          GOTO      ENDURA
.
.       Second loop to get rid of the excess "A" and "C" records. We want the
.       First "A" record and the last "C" record
.
URCHGL2   PACK      KEY17,PURNO,SP10
          CALL      RDSURAD2
          CALL      RDKURAD2        * This will read the first "A" record
          CALL      RDKURAD2        * This will read the second record
          BRANCH    OVRCD,ENDURA    * Nothing left in file -> Okay
.
          MATCH     URURNO,PURNO    * Still the same U/R ?
          GOTO      ENDURA IF NOT EQUAL
.
.       If this is an "A" record then delete it. If it is a "C" record, then
.       loop until we find the last "C" record
.
          MATCH     ANSA,URRTYPE
          GOTO      URCHGL4 IF NOT EQUAL
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      DEURAD1         * Delete this excess "A" record
          GOTO      URCHGL2         * Check for anymore "A" records
.
.       Loop over the "C" records, and delete all but the last
.
URCHGL4   PACK      KEY17,URRTYPE,URDATE,URURNO
.
          CALL      RDKURAD2        * Get the next record
          BRANCH    OVRCD,ENDURA    * Nothing more in file -> okay
.
          MATCH     URURNO,PURNO    * Still the same U/R number
          GOTO      ENDURA IF NOT EQUAL
.
.       We have another record. Delete the old one
.
          CALL      DEURAD1         * Key saved above
          GOTO      URCHGL2         * Check for any more "C" records
.
          INC       IBAOVRIO/INC
          INC       PATURAIO/INC
.
ENDURA    ENDPROC
++
.
.====================================================================
.         Process the outpatient files
.====================================================================
.
          DEFPROC   FIXOUT   
.
          INC       OUTDEMFD/INC
          INC       OUTDANFD/INC
          INC       OUTDCOFD/INC
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTCANFD/INC
          INC       OUTLHIFD/INC
          INC       OUTRF1FD/INC
          INC       OUTBITFD/INC
          INC       OUTARTFD/INC
          INC       HICCLMFD/INC
          INC       PATVISFD/INC
.
.         Open Outpatient files if they exist
.
          CALL      OUTDIR00                * Outpatient Direct Files
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTSITA1,"outsitaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOUT
.
          CALL      HICCLM00                * HIC claim
.
.         Loop over all sites to get all possible outpatient file names
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      SP6,KEY6
          CALL      RDSSITA1
FIXOUT1   CALL      RDKSITA1
          BRANCH    OVRCD,FIXOUT9
.
. ------- Fix up the outpatient bookings -------
.
          MOVE      ZERO,OVRCD                * Initialise test flag
          TRAP      OVERCOND IF IO            * Trap IO errors
          PACK      CFNAME,OSTFILE,FILBOKA1
          OPEN      OUTBOKA1,CFNAME
          TRAPCLR   IO                        * Clear IO trap
          BRANCH    OVRCD,FIXOUT1             * Ignore site if IO error.
.
          PACK      CFNAME,OSTFILE,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
          CALL      FIXBOK
          CLOSE     OUTBOKA1
          CLOSE     OUTBOKA3
.      
. ------- Fix up any cancelled bookings -------
.      
          PACK      CFNAME,OSTFILE,FILCANA1
          OPEN      OUTCANA1,CFNAME
          PACK      CFNAME,OSTFILE,FILCANA2
          OPEN      OUTCANA2,CFNAME
          CALL      FIXCAN
          CLOSE     OUTCANA1
          CLOSE     OUTCANA2
.
          CALL      OUTLHI00                * letter history
          CALL      OUTRFL00                * referrals
          CALL      OUTBIT00                * Booking items
          GOTO      FIXOUT1
.
.         Finished looking at all sites
.
FIXOUT9   CLOSE     OUTSITA1
          DISPLAY   *P1:24,*EL,"Outpatient : ",*V2LON,OURNO:
                    *HOFF," Completed"
.
          CALL      OUTART00                * Appointment Request table
.
          GOTO      ENDOUT
.
.*********************************************************************
.        Subroutine to fix up the outpatient cancellations file
.*********************************************************************
FIXCAN    DISPLAY   *P1:24,*EL,"Outpatient : ",*V2LON,OURNO;
OCANLP    PACK      KEY24,OURNO,SP30
          CALL      RSOTCAN2
          CALL      RKOTCAN2
          BRANCH    OVRCD OF ENDOCAN
.
          MATCH     OURNO,OPCNURNO
          GOTO      ENDOCAN IF NOT EQUAL
.
          PACK      KEY8,OPCNOUTN
          CALL      RDOTCAN1
          BRANCH    OVRCD OF OCANERR
.
          MOVE      NEWURNO,OPCNURNO
          CALL      UPOTCAN1
          DISPLAY   *P1:24,*EL,"Outpatient Cancellation : ",*V2LON,OPCNOUTN;
          GOTO      OCANLP
.
OCANERR   DISPLAY   *P1:23,*EF,*B,"Error : O/P Cancellation ",*V2LON:
                    OPCNOUTN,*HOFF," has disappeared.  ":
                    *P1:24,"Contact IBA Immediately.  ";
          CALL      HITENTER
.
ENDOCAN   RETURN
+
.*********************************************************************
.        Subroutine to fix up the outpatient booking file
.*********************************************************************
FIXBOK    DISPLAY   *P1:24,*EL,"Outpatient : ",*V2LON,OURNO;
BOKLP     PACK      KEY36,OURNO,SP30
          CALL      RDSBOKA3
          CALL      RDKBOKA3
          BRANCH    OVRCD OF ENDBOK
.
          MATCH     OURNO,OBAURNO
          GOTO      ENDBOK IF NOT EQUAL
.
.        Lock this record if possible
.
LKBOK     PACK      KEY28 WITH OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          CALL      RDLBOKA1
          BRANCH    OVRCD OF BOKERR,BOKLCK
.
          MOVE      NEWURNO,OBAURNO
          CALL      UPBOKA1
.
          DISPLAY   *P1:24,*EL,"Outpatient Booking : ",*V2LON,OBAOUTNO;
          GOTO      BOKLP
.
BOKLCK    DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** Outpatient ",OBAOUTNO," locked on Port ",OBALOCK:
                    ". Please wait **",*W,*P1:24,*EL;
          GOTO      LKBOK
.
BOKERR    DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Error : Outpatient ",OBAOUTNO," has disappeared. ":
                    "Contact IBA Immediately **",*W4;
.
ENDBOK    RETURN
+
.*********************************************************************
.         fix the outpatient letter history file
.*********************************************************************
OUTLHI00  DISPLAY   *P1:24,*EL,"Outpatient : ",*V2LON,OURNO;
          PACK      CFNAME,OSTFILE,FILLHIA1
          OPEN      OUTLHIA1,CFNAME
          PACK      KEY27,OURNO,SP30
          CALL      RSOTLHI1
          CALL      RKOTLHI1
          BRANCH    OVRCD,OUTLHI95
          MATCH     OURNO,OTLHURNO
          GOTO      OUTLHI95 IF NOT EQUAL
.
          MOVE      NEWURNO,OTLHURNO
          CALL      UPOTLHI1
          GOTO      OUTLHI00
.
OUTLHI95  CLOSE     OUTLHIA1
OUTLHI99  RETURN
+
.*********************************************************************
.        fix up the outpatient referral letters
.*********************************************************************
OUTRFL00  COMPARE   ZERO,OTCNULET           * Using Outpatient Referral Letters
          GOTO      OUTRFL99 IF EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTRF1A1,"outrf1af"
          TRAPCLR   IO
          BRANCH    OVRCD,OUTRFL99
.
          OPEN      OUTRF1A2,"outrf1af"
          DISPLAY   *P1:24,*EL,"Referral Letters : ",*V2LON,OURNO;
.
.        Loop thru Outpatient Referral Letters File
.
OUTRFL10  PACK      KEY24,OURNO,SP30
          CALL      RSOTRFL2
          CALL      RKOTRFL2
          BRANCH    OVRCD,OUTRFL95
.
          MATCH     OTRLURNO,OURNO
          GOTO      OUTRFL95 IF NOT EQUAL
.
          MOVE      OTRLOUTN,KEY8
          CALL      RDOTRFL1
          MOVE      NEWURNO,OTRLURNO
          CALL      UPOTRFL1
          GOTO      OUTRFL10
.
OUTRFL95  CLOSE     OUTRF1A1
          CLOSE     OUTRF1A2
OUTRFL99  RETURN 
+
.*********************************************************************
.        fix up the outpatient booking items file
.*********************************************************************
OUTBIT00  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*132,IBCNUMCI
.
          MATCH     "1",IBCNUMCI
          GOTO      OUTBIT99 IF NOT EQUAL      * not using med claim
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          PACK      CFNAME,OSTFILE,FILBITA1
          OPEN      OUTBITA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,OUTBIT99
.
          OPEN      PATVISA2,"patvisaf"
          OPEN      OUTBITA1,CFNAME
          DISPLAY   *P1:24,*EL,"Booking Items : ",*V2LON,OURNO;
.
          PACK      KEY24,OURNO,SP70
          CALL      RSPTVIS2
OUTBIT02  CALL      RKPTVIS2
          BRANCH    OVRCD,OUTBIT99
.
          MATCH     OURNO,PVIURNO       * Same U/R
          GOTO      OUTBIT99 IF NOT EQUAL
          COMPARE   TWO,PVITYPE         * Outpatient visit?
          GOTO      OUTBIT02 IF NOT EQUAL
.
.        Loop thru Outpatient Booking items File
.
OUTBIT10  PACK      KEY10,PVIBILL,SP30
          CALL      RSOTBIT1
OUTBIT20  CALL      RKOTBIT1
          BRANCH    OVRCD,OUTBIT02
.
          MATCH     OTBIVISN,DPVIBILL
          GOTO      OUTBIT02 IF NOT EQUAL
.
          MATCH     OTBIURNO,PVIURNO
          GOTO      OUTBIT02 IF NOT EQUAL
.
          MOVE      NEWURNO,OTBIURNO
          CALL      UPOTBIT1
          GOTO      OUTBIT20
.
OUTBIT95  CLOSE     OUTBITA1
OUTBIT99  RETURN
+
.*********************************************************************
.        fix up the outpatient Appointment Request Table
.*********************************************************************
OUTART00  MOVE      ZERO,EXIT
.
          OPEN      OUTARTA1,"outartaf"
          DISPLAY   *P1:24,*EL,"Appointment Requests : ",*V2LON,OURNO;
.
.        Loop thru Outpatient Appointment Request Table
.
OUTART10  PACK      KEY32,OURNO,SP30
          CALL      RSOTART1
          CALL      RKOTART1
          BRANCH    OVRCD,OUTART95
.
          MATCH     OTARURNO,OURNO
          GOTO      OUTART95 IF NOT EQUAL
.
          MOVE      NEWURNO,OTARURNO
          CALL      UPOTART1
          GOTO      OUTART10
.
OUTART95  CLOSE     OUTARTA1
.
OUTART99  RETURN
+
.*********************************************************************
.        fix up the HIC claim file
.*********************************************************************
HICCLM00  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*132,IBCNUMCI
.
          MATCH     "1",IBCNUMCI
          GOTO      HICCLM99 IF NOT EQUAL      * not using med claim
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      HICCLMA3,"hicclmaf"
          TRAPCLR   IO
          BRANCH    OVRCD,HICCLM99
.
          OPEN      HICCLMA3,"hicclmaf"
          DISPLAY   *P1:24,*EL,"HIC Claim : ",*V2LON,OURNO;
.
.        Loop thru Outpatient Referral Letters File
.
HICCLM10  PACK      KEY16,OURNO,SP30
          CALL      RSHCCLM3
          CALL      RKHCCLM3
          BRANCH    OVRCD,HICCLM95
.
          MATCH     HCCLURNO,OURNO
          GOTO      HICCLM95 IF NOT EQUAL
.
          MOVE      NEWURNO,HCCLURNO
          CALL      UPHCCLM3
          GOTO      HICCLM10
.
HICCLM95  CLOSE     HICCLMA3
HICCLM99  RETURN
+
.*********************************************************************
.  fix U/R in outpatient direct files
.*********************************************************************
OUTDIR00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTDEMA1,"outdemaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OUTDIR99
.
          OPEN      OUTDEMA1,"outdemaf"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTDANA1,"outdanaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OUTDIR99
.
          OPEN      OUTDANA1,"outdanaf"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTDCOA1,"outdcoaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OUTDIR99
.
          OPEN      OUTDCOA1,"outdcoaf"
.
          DISPLAY   *P1:24,*EL,"OP Direct : ",*V2LON,OURNO;
.
OUTDIR10  PACK      KEY24,OURNO,SP30
          CALL      RSOTDEM1
          CALL      RKOTDEM1
          BRANCH    OVRCD,OUTDIR30
.
          MATCH     OTDMURNO,OURNO
          GOTO      OUTDIR30 IF NOT EQUAL
.
          MOVE      NEWURNO,OTDMURNO
          CALL      UPOTDEM1
          GOTO      OUTDIR10
.
OUTDIR30  PACK      KEY34,OURNO,SP30
          CALL      RSOTDAN1
          CALL      RKOTDAN1
          BRANCH    OVRCD,OUTDIR50
.
          MATCH     OTDNURNO,OURNO
          GOTO      OUTDIR50 IF NOT EQUAL
.
          MOVE      NEWURNO,OTDNURNO
          CALL      UPOTDAN1
          GOTO      OUTDIR30
.
OUTDIR50  PACK      KEY29,OURNO,SP30
          CALL      RSOTDCO1
          CALL      RKOTDCO1
          BRANCH    OVRCD,OUTDIR95
.
          MATCH     OTDOURNO,OURNO
          GOTO      OUTDIR95 IF NOT EQUAL
.
          MOVE      NEWURNO,OTDOURNO
          CALL      UPOTDCO1
          GOTO      OUTDIR95
.
OUTDIR95  CLOSE     OUTDEMA1
          CLOSE     OUTDANA1
          CLOSE     OUTDCOA1
.
OUTDIR99  RETURN
+
          INC       OUTDEMIO/INC
          INC       OUTDANIO/INC
          INC       OUTDCOIO/INC
          INC       IBAOVRIO/INC
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTCANIO/INC
          INC       OUTLHIIO/INC
          INC       OUTRF1IO/INC
          INC       OUTBITIO/INC
          INC       OUTARTIO/INC
          INC       HICCLMIO/INC
          INC       PATVISIO/INC
.
ENDOUT    ENDPROC
++
.
.=====================================================================
.         Procedure to fix up the National Master Patient Index file
.=====================================================================
          DEFPROC   FIXNMP    
.
SAVNMPI   DIM       20
.
          INC       PATNIDFD/INC
.
          COMPARE   PTCNNMPI,ZERO
          GOTO      ENDFXNMP IF EQUAL 
.
.  06/12/1994 Whirlpool 
.    Removed all reference to PATNMP file as this is no longer used.
.    They should not use PAT02 if the NZHIS link is switched on, every
.    one else with a national number facility will use PATNID.
.
          DISPLAY   *P1:24,"Updating : ",*+,PTCNNMDX,*EL
          CALL      FIXB0000
          GOTO      ENDFXNMP
.
.*********************************************************************
.                   FIXB0000
.         fix the patnidaf file
.*********************************************************************
FIXB0000  OPEN      PATNIDA1,"patnidaf"
.
.         Change the nmpi number record for this U/R number
.         We are merging if CMERGURS is true else changing u/r.
.
          MOVE      SP20,SAVNMPI
.
.         Check if new key already exists
.
          PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          IF        OVRCD=0
            GOTO      FIXB4000             * delete old nat id.
          ENDIF
.
          PACK      KEY10,CHOSINDX,OURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,FIXB9999
.
. if merging u/r - move old id to new u/r id.
.
          BRANCH    CMERGURS,FIXB3000
.
. Changing u/r - check if new purno is an existing patient or a new patient
.
          IF        EXISTFL=0
            GOTO      FIXB4000              * existing u/r
          ENDIF
.
FIXB3000
. move old u/r id to new u/r id. 
. 
          MOVE      PURNO,PTNILNUM
          CALL      UPPTNID1
.
          GOTO      FIXB9999
.
. Delete old u/r national id. 
.
FIXB4000  PACK      KEY10,CHOSINDX,OURNO      
          CALL      RDPTNID1
          BRANCH    OVRCD,FIXB9999
.
          CALL      DEPTNID1
.
          GOTO      FIXB9999
.
FIXB9999  CLOSE     PATNIDA1
          RETURN
+
.
          INC       IBAOVRIO/INC
          INC       PATNIDIO/INC
.
ENDFXNMP  ENDPROC
++
.
.*********************************************************************
.                   FIXAXE
.         Subroutine to update the pataxeaf file with national number 
.         (By U/R number)
.*********************************************************************
.
          DEFPROC   FIXAXE    
.
          INC       PATAXEFD/INC
          INC       PATVISFD/INC
.
          COMPARE   PTCNNMPI,ZERO
          GOTO      ENDAXE IF EQUAL 
.
          COMPARE   ONE,PTCNAXEU
          GOTO      ENDAXE IF NOT EQUAL
.
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATAXEA1,"pataxeaf"
.
.         Update the old national number from pataxe 
.
          OPEN      PATNIDA1,"patnidaf"
          PACK      KEY10,CHOSINDX,PURNO,SP10
          CALL      RDPTNID1     
          BRANCH    OVRCD,ENDAXE
.
          PACK      KEY24,OURNO,SP20,SP20
          CALL      RDSVISA2
FIXAXE1   CALL      RDKVISA2
          BRANCH    OVRCD,ENDAXE
. 
          MATCH     OURNO,PVIURNO
          GOTO      ENDAXE IF NOT EQUAL
.
          COMPARE   PVITYPE,THREE
          GOTO      FIXAXE1 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP10
          CALL      RDPTAXE1
          BRANCH    OVRCD,FIXAXE1
.    
          IF        PTAXDAMI < 9
            MOVE      PTNINMPI,PTAXNRIC
            IF        PTAXDAMI =7 | PTAXDAMI =8
              MOVE      "21",PTAXAI1C
            ENDIF
            CALL      UPPTAXE1
          ENDIF
.
          GOTO      FIXAXE1
.
          INC       IBAOVRIO/INC
          INC       PATAXEIO/INC
          INC       PATVISIO/INC
.            
ENDAXE    CLOSE     PATNIDA1
          ENDPROC
+
.**************************************************************************
.*  FDNR0000  :  Fix up Donor file                                        *
.**************************************************************************
          DEFPROC   FDNR0000  
.
          INC       PATDNRFD/INC
.
          COMPARE   ONE,PTCNDONR                  * using Donor details file?
          GOTO      FDNR9999 IF NOT EQUAL
.
          DISPLAY   *P1:24,"Updating : ",*V2LON,"patdnraf",*EL
.
          OPEN      PATDNRA1,"patdnraf"
.
.         Loop thru Donor details File
.
          MOVE      OURNO,PTDNURNO
.
FDNR1000  PACK      KEY10,OURNO,SP10
          CALL      RSPTDNR1
          CALL      RKPTDNR1
          BRANCH    OVRCD,FDNR9000
.
          MATCH     PTDNURNO,OURNO
          GOTO      FDNR9000 IF NOT EQUAL
.
          PACK      KEY10,OURNO,PTDNCNT
          CALL      DEPTDNR1                      * delete old U/R
.
          MOVE      PURNO,PTDNURNO
FDNR2000  PACK      KEY10,PTDNURNO,PTDNCNT
          CALL      RAPTDNR1
          IF        OVRCD=1
            CALL      WRPTDNR1                    * write New U/R
            GOTO      FDNR1000
          ELSE
            ADD       ONE,PTDNCNT
            GOTO      FDNR2000
          ENDIF
.
          GOTO      FDNR9999
.
          INC       IBAOVRIO/INC
          INC       PATDNRIO/INC
.
FDNR9000  CLOSE     PATDNRA1
.
FDNR9999  ENDPROC
++
.
.       ==============================================
.       Procedure  to fix the Case notes location file
.       ==============================================
.
          DEFPROC   FIXCSLF   
.
          INC       PATCSLFD/INC
.
          DISPLAY   *P1:24,*EL,"Fixing Case notes location files";     
.
.       Update the booking files
.
          CALL      UCSL0000
          GOTO      ENDCSL
.
.**********************************************************************
.*  UCSL0000  :  Update case notes location file                      *
.**********************************************************************
UCSL0000  COMPARE   ONE,PTCNUCSL                  * using case notes loc file?
          GOTO      UCSL9999 IF NOT EQUAL
.
          OPEN      PATCSLA1,"patcslaf"
.
UCSL1000  PACK      KEY11,OURNO,SP10
          CALL      RSPTCSL1
          CALL      RKPTCSL1
          BRANCH    OVRCD,UCSL9999
.
          MATCH     OURNO,PTCLURNO                * same U/R No.?
          GOTO      UCSL9999 IF NOT EQUAL
.
. check if new U/R already exists
.
          PACK      KEY11,NEWURNO,PTCLUNIQ
          CALL      RAPTCSL1
          BRANCH    OVRCD,UCSL3000
.
          PACK      KEY11,OURNO,PTCLUNIQ
          CALL      DEPTCSL1
          GOTO      UCSL1000
.
. update the record with the new U/R No.
.
UCSL3000  PACK      KEY11,OURNO,PTCLUNIQ
          CALL      RDPTCSL1
          MOVE      NEWURNO,PTCLURNO
          CALL      UPPTCSL1
          GOTO      UCSL1000
.
UCSL9999  CLOSE     PATCSLA1
          RETURN
.
          INC       IBAOVRIO/INC
          INC       PATCSLIO/INC
.
ENDCSL    ENDPROC
++
.
.       ===========================================
.       Procedure  to fix the Kiwicard details file
.       ===========================================
.
          DEFPROC   FIXKWC
.
          INC       PATKWCFD/INC
.
KWCFIL    INIT      "patkwc"
.
          DISPLAY   *P1:24,*EL,"Fixing Kiwicard files";     
.
.       Update the kiwicard files
.
          CALL      UKWC0000
          GOTO      ENDKWC
.
.**********************************************************************
.*  UKWC0000  :  Update kiwicard details file                         *
.**********************************************************************
UKWC0000  IF        PTCNUCRD <> 1 & PTCNUFML <> 1
            GOTO      UKWC9999
          ENDIF
.
.         We want to check the current year, and the previous year only
.
          MOVE      CYY,FORM2                * current year
          SUB       ONE,FORM2                * start with last year
.
.         Open the appropriate data file
.
UKWC1000  PACK      CFNAME,KWCFIL,FORM2
          REP       " 0",CFNAME
.
          MOVE      ZERO,OVRCD               * assume file exists
          TRAP      OVERCOND IF IO
          OPEN      PATKWCA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,UKWC8000           * error openning file
.
.         Check if the U/R number exists on this file
.
          PACK      KEY28,SP20,OURNO
          CALL      RDPTKWC1
          BRANCH    OVRCD,UKWC7000
.
.         Check if new U/R number is already on file
.
          PACK      KEY28,SP20,NEWURNO
          CALL      RAPTKWC1
          BRANCH    OVRCD,UKWC3000
.
.         Already exists. Update new U/R number with latest details
.
          MOVE      NEWURNO,PTKWURNO
          CALL      UPPTKWC1
.
          PACK      KEY28,SP20,OURNO
          CALL      DEPTKWC1                 * delete old U/R number
          GOTO      UKWC7000
.
.         New U/R number not on file yet
.
UKWC3000  PACK      KEY28,SP20,OURNO
          CALL      RDPTKWC1
          BRANCH    OVRCD,UKWC7000
.
          MOVE      NEWURNO,PTKWURNO
          CALL      UPPTKWC1
.
.         Finished update
.
UKWC7000  CLOSE     PATKWCA1
.
.         Check for the next year
.
UKWC8000  COMPARE   FORM2,CYY
          GOTO      UKWC9999 IF EQUAL
.
          ADD       ONE,FORM2                * go to the next year
          GOTO      UKWC1000
.
UKWC9999  RETURN
+
.
          INC       IBAOVRIO/INC
          INC       PATKWCIO/INC
.
ENDKWC    ENDPROC
++
.       =================================
.       Procedure  to fix the Mammography
.       =================================
.
          DEFPROC    FIXMAM  
.
          INC       MAMTESFD/INC
.
.         Open mammography
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"mamtestf"
          TRAP      OVERCOND IF IO
          OPEN      MAMTEST1,"mamtestf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDMAM
          CLOSE     MAMTEST1
.
          DISPLAY   *P1:24,*EL,"Fixing Mammography";
          MOVE      OURNO,PVIURNO
.
.       Update the Mammography file
.
          CALL      FIXMTES
          GOTO      ENDMAM
.
.        ================================================
.        Subroutine to fix up the Mammography Master file
.        ================================================
.
FIXMTES   OPEN      MAMTEST1,"mamtestf"
.
MAMMTES   PACK      KEY18 WITH PVIURNO,SP10
          CALL      RDSTES1
          CALL      RDKTES1
          BRANCH    OVRCD OF ENDMTES
.
          MATCH     PVIURNO,MMURNO
          GOTO      ENDMTES IF NOT EQUAL
.
          MOVE      NEWURNO,MMURNO
          CALL      UPTES1
          GOTO      MAMMTES
.
ENDMTES   CLOSE     MAMTEST1
          RETURN
+
.
          INC       IBAOVRIO/INC
          INC       MAMTESIO/INC
.
ENDMAM    ENDPROC
++
.
.*********************************************************************
.       Procedure to fix the waiting list files
.       this has been changed (15/05/1994) to follow the following theory...
.
.       loop over wattr1af for OLD ur number
.       for each record, loop over wattr1af for new ur and code to get 
.                        a new unique count - NEWCNT
.       when we have this new count, ALL records on ALL files for the 
.       OLD ur and count can be changed to the NEW ur and count
.       this will NOT cause any I*D's or I*U's as the NEWCNT has never existed
.       for the new U/R before.
.
.       this also does all the Waiting List related Contracting files
.
.       this will update the WATTR1FD and BOKRC1FD and then call the
.        procedure UPWTSGL to do the other files
.*********************************************************************
.
          DEFPROC   FIXWAT    
.
SAVWMCNT  FORM      2          * save var for old count
NEWCNT    FORM      2          * the new count
OLDKEY19  DIM       19                                                 *I-87846
NEWKEY19  DIM       19                                                 *I-87846
OLDKEY31  DIM       31                                                 *I-87846
OLDKEY28  DIM       28
.
          INC       COMERHFD/INC
          INC       WATCHAFD/INC
          INC       WATTR1FD/INC
          INC       WATHISFD/INC                                       *I-87846
          INC       WATPACFD/INC
          INC       OPRDEAFD/INC
          INC       WATMHDFD/INC
          INC       WATMTXFD/INC
          INC       WATOPAFD/INC
.
.
.         Open Waiting List files if they exist
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"wattr1af"
          TRAP      OVERCOND IF IO
          OPEN      WATTR1A1,"wattr1af"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWAT99
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"wattx1af"
          TRAP      OVERCOND IF IO
          OPEN      WATTX1A1,"wattx1af"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWAT99
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"oprdetaf"
          TRAP      OVERCOND IF IO
          OPEN      OPRDETA2,"oprdetaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWAT99
.
          MATCH     "1",PTCNEPIS
          IF        @EQUAL
            MOVE      ZERO,OVRCD
            DISPLAY   *P64:24,"comerhaf"
            TRAP      OVERCOND IF IO
            OPEN      COMERHA3,"comerhaf"
            TRAPCLR   IO
            BRANCH    OVRCD,FIXWAT99
          ENDIF
.
          DISPLAY   *P1:24,*EL,"Fixing Waiting List Files";
          CALL      FIXTRE00
          GOTO      FIXWAT99
.
.*********************************************************************
.         Subroutine to update the waiting list treatment file
.         and the booking file
.*********************************************************************
.
FIXTRE00  OPEN      WATTR1A1,"wattr1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
.
FIXTRE10  PACK      KEY19,OURNO,SP20
          CALL      RDSTREA1                     * position in file for U/R
          CALL      RDKTREA1                     * read next record
          BRANCH    OVRCD,FIXTRE90
.
          MATCH     OURNO,WMURNO                 * still same U/R ?
          GOTO      FIXTRE90 IF NOT EQUAL        * no - finished
.
          MOVE      WMCNT,SAVWMCNT               * save the OLD count
          DISPLAY   *P1:24,*EL,"Procedure : ",*V2LON,WMCODE,WMCNT;
.
.         Loop over treatment file for NEW UR until we get a unique count 
.         for procedure code
.
FIXTRE30  PACK      KEY19,NEWURNO,WMCODE,WMCNT
          CALL      RDTREA1                      * Proc/Count already on file ?
          BRANCH    OVRCD,FIXTRE50               * no - count ok
.
          ADD       ONE,WMCNT                    * yes - increment count
          COMPARE   "99",WMCNT                   * maximum reached ?
          GOTO      FIXTRE90 IF EQUAL            * yes - finished
          GOTO      FIXTRE30                     * get next count record
.
.         The next count for the procedure has been found for the new U/R
.
FIXTRE50  MOVE      WMCNT,NEWCNT                 * save the new count
          PACK      KEY19,OURNO,WMCODE,SAVWMCNT
          CALL      RDTREA1                      * reposition on old record
          MOVE      NEWURNO,WMURNO               * update U/R number
          MOVE      NEWCNT,WMCNT                 * update count
          CALL      UPTREA1                      * update record
.
.         Update Extn File with new urnumber
.
          PACK      KEY19,OURNO,WMCODE,SAVWMCNT
          CALL      RDWTTX11
          IF        OVRCD = 0
            MOVE      NEWURNUM,WTTXURNO          * update U/R number
            MOVE      NEWCNT,WTTXPCNT            * update count
            CALL      UPWTTX11                   * update record
          ENDIF
.
.         Update Waiting List History with new urnumber                *I-87846
.
FIXTRE60  CALL      FIXHIS00                                           *I-87846
.
          CALL      FIXPAC00                     * W/L Pre-admission comments

          CALL      FIXWLC00                     * W/L comments
          CALL      FIXERF00                     * Fix eReferral
.
.         Update booking file with new count and UR if needed
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD = ZERO
            MOVE      NEWURNO,BKREURNO
            MOVE      NEWCNT,BKRECNT
            CALL      UPBKREC1
            CALL      FIXDET00
          ENDIF
.
.         Update all other files, set OLD and NEW codes
.
          PROC      UPESIS00                * update ESIS Episode record
          CALL      UPWCHA00                * Data integrity audit
          PACK      KEY38,OURNO,WMCODE,SAVWMCNT,NEWURNO,WMCODE,NEWCNT
          MOVE      WMBOOK,BKREBOOK
          PROC      UPWTSGL                 * update the single procedure
          GOTO      FIXTRE10
.
FIXTRE90  CLOSE     WATTR1A1
.
FIXTRE99  RETURN
.
.*****************************************************************************
.* Fix eReferral U/R and Procedure Count
.*****************************************************************************
FIXERF00  MATCH     "1",PTCNEPIS            * Using Episoft interface
          GOTO      FIXERF99 IF NOT EQUAL
.
          PACK      KEY38,OURNO,SP70
          CALL      RSCMERH3
FIXERF10  CALL      RKCMERH3
          BRANCH    OVRCD,FIXERF99
.
          MATCH     OURNO,CMRHURNO
          GOTO      FIXERF99 IF NOT EQUAL
.
          MATCH     WMCODE,CMRHPCOD
          GOTO      FIXERF10 IF NOT EQUAL
.
          MOVE      ZERO,F2
          MOVE      CMRHPCNT,F2
          COMPARE   SAVWMCNT,F2
          GOTO      FIXERF10 IF NOT EQUAL
.
          MOVE      NEWURNO,CMRHURNO        * Update U/R
          MOVE      NEWCNT,CMRHPCNT         * Update procedure count
.
          CALL      UPCMERH3
.
FIXERF99  RETURN
.
.*****************************************************************************
.*                                  FIXPAC00                                 *
.*                 Fix watpacaf - W/L Pre-admission comments                 *
.*****************************************************************************
.
FIXPAC00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPACA1,"watpacaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXPAC99
.
          PACK      OLDKEY19,OURNO,WMCODE,SAVWMCNT  * save old & new keys
          PACK      NEWKEY19,NEWURNO,WMCODE,NEWCNT
.
.         Get the last comment line number on file for the new key
.
          MOVE      ZERO,FORM2                   * initialise line number
          PACK      KEY21,NEWKEY19,TILDA35
          CALL      RSWTPAC1                     * position after new U/R
          CALL      RPWTPAC1                     * read previous record
          BRANCH    OVRCD,FIXPAC10               * eof
.
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     NEWKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      FIXPAC10 IF NOT EQUAL        * no
.
          MOVE      WTPCLINE,FORM2               * yes - set line number
.
FIXPAC10  PACK      KEY21,OLDKEY19,SP30
          CALL      RSWTPAC1                     * position in file
          CALL      RKWTPAC1                     * read next record
          BRANCH    OVRCD,FIXPAC90               * eof - finished
.
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      FIXPAC90 IF NOT EQUAL        * no - finished
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          UNPACK    NEWKEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          ADD       ONE,FORM2
          MOVE      FORM2,WTPCLINE
.
          CALL      UPWTPAC1                     * update record
          GOTO      FIXPAC10                     * get next record
.
FIXPAC90  CLOSE     WATPACA1
.
FIXPAC99  RETURN
+
.*****************************************************************************
.*                                  FIXWLC00                                 *
.*                  Fix watmhdaf & watmtxaf - W/L header & comments          *
.*****************************************************************************
FIXWLC00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMHDA1,"watmhdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWLC99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMTXA1,"watmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWLC99
.
.         Fix the W/L header file first...
.
FIXWLC10  PACK      KEY28,OURNO,SP30
          CALL      RSWTMHD1
          CALL      RKWTMHD1
          BRANCH    OVRCD,FIXWLC50
.
          MATCH     OURNO,WTMHURNO                * same U/R?
          GOTO      FIXWLC50 IF NOT EQUAL         * no - process the comments
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          PACK      OLDKEY28,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE
.
.         See if new key already exists...
.
          PACK      KEY28,NEWURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE
          CALL      RAWTMHD1                      * duplicate key?
          COMPARE   OVRCD,ZERO
          GOTO      FIXWLC50 IF EQUAL             * yes - do comments
.
          PACK      KEY28,OLDKEY28                * re-read to get cursor
          CALL      RDWTMHD1
          BRANCH    OVRCD,FIXWLC10                * get next partial U/R match
.
          MOVE      NEWURNO,WTMHURNO              * update the U/R
.
          CALL      UPWTMHD1                      * update record
          GOTO      FIXWLC10                      * get next record
.
.         Now for the W/L comments file...
.
FIXWLC50  PACK      KEY31,OURNO,SP70
          CALL      RSWTMTX1
          CALL      RKWTMTX1
          BRANCH    OVRCD,FIXWLC90                * no such U/R
.
          MATCH     OURNO,WTMTURNO                * same U/R?
          GOTO      FIXWLC90 IF NOT EQUAL         * no - finish
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          PACK      OLDKEY31,WTMTURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                             WTMTUNIQ
.
.         See if new key already exists...
.
          PACK      KEY31,NEWURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                          WTMTUNIQ
.
          CALL      RAWTMTX1                      * duplicate key?
          COMPARE   OVRCD,ZERO
          GOTO      FIXWLC90 IF EQUAL             * yes - bail
.
          PACK      KEY31,OLDKEY31
          CALL      RDWTMTX1
          BRANCH    OVRCD,FIXWLC50                * get next partial U/R match
.
          MOVE      NEWURNO,WTMTURNO              * update the U/R
.
          CALL      UPWTMTX1                      * update record
          GOTO      FIXWLC50
.
FIXWLC90  CLOSE     WATMHDA1
          CLOSE     WATMTXA1
.
FIXWLC99  RETURN
.
.*********************************************************************
.         Subroutine to update the oprdetaf file
.*********************************************************************
FIXDET00  PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
FIXDET10  CALL      RKOPDEA2
          BRANCH    OVRCD,FIXDET99
.
.         Update oprdetaf file with new UR
.
          MATCH     DBKREBOO,OPDAADMN
          GOTO      FIXDET99 IF NOT EQUAL
.
          MOVE      NEWURNO,OPDAURNO
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA2
.
          GOTO      FIXDET10
.
FIXDET99  RETURN
.
.******************************************** start of addition        *I-87846
.****************************************************************************
.*                              FIXHIS00                                    *
.*                 Waiting List  history file (wathisaf)                    *
.*           (Copied from IBAPMS05 WHIS0000 - NZ Auto UR Merge)             *
.****************************************************************************
.
FIXHIS00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATHISA1,"wathisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXHIS99
.
          PACK      OLDKEY19,OURNO,WMCODE,SAVWMCNT  * save keys for wathisaf
          PACK      NEWKEY19,NEWURNO,WMCODE,NEWCNT
.
.
FIXHIS10  PACK      KEY31,OLDKEY19,SP30
          CALL      RSWTHIS1                     * position in file
          CALL      RKWTHIS1                     * read next record
          BRANCH    OVRCD,FIXHIS90               * eof - finished
.
          PACK      KEY19,WTHIURNO,WTHIPROC,DWTHIPCN
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      FIXHIS90 IF NOT EQUAL        * no - finished
.
          PACK      OLDKEY31,OLDKEY19,WTHIEDAT,DWTHIUCN   * save Old key
          MOVE      DWTHIUCN,FORM2               * save Old Unique Count
.
.                                                * see if New UR History exists
FIXHIS20  PACK      KEY31,NEWKEY19,WTHIEDAT,DWTHIUCN
          CALL      RDWTHIS1
          BRANCH    OVRCD,FIXHIS30               * No - go to delete/write routn
.
.                                                * history already exists
          ADD       ONE,FORM2                    * Create a new Unique Count
          MOVE      FORM2,DWTHIUCN
          GOTO      FIXHIS20                     * try again
.
FIXHIS30  MOVE      OLDKEY31,KEY31               * re-read Old UR record
          CALL      RDWTHIS1
          CALL      DEWTHIS1                     * delete the old history recd
.
.                                                * modify recd with New UR info
          UNPACK    NEWKEY19,WTHIURNO,WTHIPROC,KEY2
          MOVE      KEY2,WTHIPCNT                                      *C-87846
          MOVE      FORM2,WTHIUCNT               * insert Unique Count *C-87846
.
          PACK      KEY31,NEWKEY19,WTHIEDAT,WTHIUCNT  * reload Key     *C-87846
          CALL      WRWTHIS1                     * write New UR history recd
.
          GOTO      FIXHIS10                     * get next record
.
FIXHIS90  CLOSE     WATHISA1
.
FIXHIS99  RETURN
.
.****************************************************************************
.*                              UPWCHA00                                    *
.*                 Waiting List data integrity audit file  watchhaf         *
.****************************************************************************
UPWCHA00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATCHAA1,"watchaaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UPWCHA99
.
          PACK      OLDKEY19,OURNO,WMCODE,SAVWMCNT  
.
UPWCHA10  PACK      KEY35,OLDKEY19,SP30
          CALL      RSWTCHA1
          CALL      RKWTCHA1                     * read next record
          BRANCH    OVRCD,UPWCHA90               * eof - finished
.
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT
.
          MATCH     OLDKEY19,KEY19               * same U/R/proc/count still ?
          GOTO      UPWCHA90 IF NOT EQUAL        * no - finished
.
          MOVE      NEWURNO,WTCHURNO             * update U/R number
          MOVE      NEWCNT,WTCHPCNT              * update count
          CALL      UPWTCHA1
.
          GOTO      UPWCHA10                     * get next record
.
UPWCHA90  CLOSE     WATCHAA1
.
UPWCHA99  RETURN
.********************************************   end of addition        *I-87846
+
          INC       COMERHIO/INC
          INC       IBAOVRIO/INC
          INC       WATCHAIO/INC
          INC       WATTR1IO/INC
          INC       WATHISIO/INC                                       *I-87846
          INC       WATPACIO/INC
          INC       OPRDEAIO/INC
          INC       WATMHDIO/INC
          INC       WATMTXIO/INC
.
FIXWAT99  ENDPROC
++
.*******************************************************************************
.         Update ESIS Episode record with new UR for corresponding W/L Proc
.*******************************************************************************
          DEFPROC   UPESIS00  
.
          INC       WATESEFD/INC
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATESEA1,"wateseaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UPESIS99
.
WLESIS00  READ      CONTROLF,EIGHTY;*250,PTCNHDPS 
          COMPARE   THREE,PTCNHDPS
          GOTO      WLESIS99 IF NOT EQUAL
.
          PACK      KEY17,WTWMECNT,SP30
          CALL      RDWTESE1
          BRANCH    OVRCD,WLESIS30
          GOTO      WLESIS60
.
WLESIS30  CALL      RSWTESE1
WLESIS50  CALL      RKWTESE1
          BRANCH    OVRCD,WLESIS99
.
          MATCH     WTWMECNT,WTEEUNIQ
          GOTO      WLESIS99 IF NOT EQUAL
.         
WLESIS60  MOVE      WMURNO,WTEEURNO
          CALL      UPWTESE1
          GOTO      WLESIS50
.
WLESIS99  
          GOTO      UPESIS99
.
          INC       IBAOVRIO/INC
          INC       WATESEIO/INC
.
UPESIS99  ENDPROC
+
.*********************************************************************
.       Procedure to fix the booking file
.*********************************************************************
.
          DEFPROC   FIXBKR
.
.
          INC       BOKRC1FD/INC
          INC       OPRDEAFD/INC
.
.         Open booking files if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"bokrc1af"
          TRAP      OVERCOND IF IO
          OPEN      BOKRC1A6,"bokrc1af"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXBKR99
.
.         Open theatre files if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"oprdetaf"
          TRAP      OVERCOND IF IO
          OPEN      OPRDETA2,"oprdetaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXBKR99
.
          DISPLAY   *P1:24,*EL,"Fixing Booking File";
          CALL      FIXBOK00
          GOTO      FIXBKR99
.*********************************************************************
.         Subroutine to update the booking file 
.*********************************************************************
FIXBOK00  OPEN      BOKRC1A1,"bokrc1af"
.
FIXBOK10  PACK      KEY16,OURNO,SP70
          CALL      RSBKREC6
          CALL      RKBKREC6
          BRANCH    OVRCD,FIXBOK99
.
.         Update booking file with new UR
.
          MATCH     BKREURNO,OURNO
          GOTO      FIXBOK99 IF NOT EQUAL
.
          MOVE      NEWURNO,BKREURNO
          CALL      UPBKREC6
.
          CALL      FIXDET00           * Fix oprdetaf record for this admission
.
          GOTO      FIXBOK10           * Loop back to correct file position
.                                      * after key has been updated
FIXBOK99  RETURN
.
.*********************************************************************
.         Subroutine to update the oprdetaf file
.*********************************************************************
FIXDET00  PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
FIXDET10  CALL      RKOPDEA2
          BRANCH    OVRCD,FIXDET99
.
.         Update oprdetaf file with new UR
.
          MATCH     DBKREBOO,OPDAADMN
          GOTO      FIXDET99 IF NOT EQUAL
.
          MOVE      NEWURNO,OPDAURNO
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA2
.
          GOTO      FIXDET10
. 
FIXDET99  RETURN
+
          INC       IBAOVRIO/INC
          INC       BOKRC1IO/INC
          INC       OPRDEAIO/INC
.
FIXBKR99  ENDPROC
++
.*==========================================================================*
.*      Procedure to fix all records for the U/R in the Patient EDI Summary *
.*      Table                                                               *
.*==========================================================================*
          DEFPROC   FIXEDI
.
          INC       PATEDSFD/INC
.
.         See if EDI parameter is turned on
.
FIXEDI    OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*115,PTCNUEDI
          COMPARE   ONE,PTCNUEDI                 * EDI Module on?
          GOTO      FIXEDI99 IF NOT EQUAL        * No, then exit
.
.         Open EDI Summary file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"patedsaf"
          TRAP      OVERCOND IF IO
          OPEN      PATEDSA5,"patedsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXEDI99
.
          OPEN      PATEDSA1,"patedsaf"
.
          CALL      FIXEDS00
          GOTO      FIXEDI99
.
FIXEDS00  PACK      KEY32,OURNO,SP30,SP2
          CALL      RSPTEDS5                     * Position at start of Old U/R
          CALL      RKPTEDS5                     * Read next record
          BRANCH    OVRCD,FIXEDS99               * Exit at end of file
.
          MOVE      OURNO,DIM8
          MATCH     DIM8,PTESURNO                * Old U/R already exists?
          GOTO      FIXEDS99 IF NOT EQUAL        * No, then exit
.
          PACK      SAVKEY32,PTESFLAG,PTESHFND,PTESADMN,PTESINVN,PTESBATN
.
          PACK      KEY32,NEWURNO,PTESADMN,PTESINVN,PTESBATN
          CALL      RAPTEDS5                     * New U/R already exists?
          BRANCH    OVRCD,FIXEDS20               * No, update with new U/R
.
          MOVE      SAVKEY32,KEY32
          CALL      DEPTEDS1                     * Yes, delete old U/R
.         GOTO      FIXEDS00                     * Loop back to read next rec

FIXEDS20  MOVE      SAVKEY32,KEY32
          CALL      RDPTEDS1                     * position to index1 for update
          IF        OVRCD = 1
            DISPLAY   *P45:24,*V2LON,"Old UR - ",OURNO," Not Found on PATEDSAF";
            CALL      HITENTER
            GOTO      FIXEDS99
          ENDIF
.
          MOVE      NEWURNO,PTESURNO             * Update with new U/R
          CALL      UPPTEDS1
.
          GOTO      FIXEDS00                     * Loop back to read next rec
.
FIXEDS99  RETURN
.
          INC       IBAOVRIO/INC
          INC       PATEDSIO/INC
.
FIXEDI99  ENDPROC
+
.*==========================================================================*
.*      Procedure to fix all records for the admission in the Patient EDI   *
.*      Summary Table                                                       *
.*==========================================================================*
          DEFPROC   FIXEDIA
.
          INC       PATEDSFD/INC
.
.         See if EDI parameter is turned on
.
FIXEDIA   OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*115,PTCNUEDI
          COMPARE   ONE,PTCNUEDI                 * EDI Module on?
          GOTO      FXEDIA99 IF NOT EQUAL        * No, then exit
.
.         Open EDI Summary file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"patedsaf"
          TRAP      OVERCOND IF IO
          OPEN      PATEDSA5,"patedsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXEDIA99
.
          OPEN      PATEDSA1,"patedsaf"
.
          CALL      FXEDSA00
          GOTO      FXEDIA99
.
FXEDSA00  PACK      KEY32,OURNO,AADMNO,SP30,SP2
          CALL      RSPTEDS5                     * Position at start of Old U/R
          CALL      RKPTEDS5                     * Read next record
          BRANCH    OVRCD,FXEDSA99               * Exit at end of file
.
          MOVE      OURNO,DIM8
          MATCH     DIM8,PTESURNO                * Same U/R still?
          GOTO      FXEDSA99 IF NOT EQUAL        * No, then exit
.
          MOVE      AADMNO,DIM8
          MATCH     DIM8,PTESADMN                * same admission still ?
          GOTO      FXEDSA99 IF NOT EQUAL        * No, then exit
.
          PACK      SAVKEY32,PTESFLAG,PTESHFND,PTESADMN,PTESINVN,PTESBATN
.
          PACK      KEY32,NEWURNO,PTESADMN,PTESINVN,PTESBATN
          CALL      RAPTEDS5                     * New U/R already exists?
          BRANCH    OVRCD,FXEDSA20               * No, update with new U/R
.
          MOVE      SAVKEY32,KEY32
          CALL      DEPTEDS1                     * Yes, delete old U/R
.         GOTO      FXEDSA00                     * Loop back to read next rec

FXEDSA20  MOVE      SAVKEY32,KEY32
          CALL      RDPTEDS1                     * position to index1 for update
          IF        OVRCD = 1
            DISPLAY   *P45:24,*V2LON,"Old UR - ",OURNO," Not Found on PATEDSAF";
            CALL      HITENTER
            GOTO      FXEDSA99
          ENDIF
.
          MOVE      NEWURNO,PTESURNO             * Update with new U/R
          CALL      UPPTEDS1
.
          GOTO      FXEDSA00                     * Loop back to read next rec
.
FXEDSA99  RETURN
.
          INC       IBAOVRIO/INC
          INC       PATEDSIO/INC
.
FXEDIA99  ENDPROC
+
.*==========================================================================*
.*      Subroutine to fix the Patient Eclipse Claim Table using             *
.*      the U/R number.                                                     *
.*==========================================================================*
.         
          DEFPROC   FIXECL
.
          INC       PMSECTFD/INC
.
FIXECL    OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*115,PTCNUEDI
.
          COMPARE   ONE,PTCNUEDI                 * EDI Module on?
          GOTO      FIXECL99 IF NOT EQUAL        * No, then exit
.         
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSECTA1,"pmsectaf"
          OPEN      PMSECTA5,"pmsectaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXECL99
.                   
.         Fix the eclipse claim summary table (pmsectaf)
.         
          MOVE      SP3,SAVEHOSP
          PACK      KEY35,SP3,OURNO,SP30,SP5
FIXECL00  CALL      RSPMECT5                     * Position at start of Old U/R
          CALL      RKPMECT5                     * Read next record
          BRANCH    OVRCD,FIXECL99               * Exit at end of file
.
          MATCH     SAVEHOSP,PMECHOSP            * same hospital still ?
          IF        !@EQUAL
            MOVE      PMECHOSP,SAVEHOSP          * no - position for next hosp.
            PACK      KEY35,PMECHOSP,OURNO,SP30,SP5
            GOTO      FIXECL00
          ENDIF
.
          MATCH     OURNO,PMECURNO               * same old u/r still ?
          IF        !@EQUAL
            PACK      KEY35,SAVEHOSP,TILDA35
            GOTO      FIXECL00
          ENDIF
.
          PACK      SAVKEY35,PMECHOSP,PMECFLAG,PMECHFND,PMECADMN,PMECINVN:
                             PMECBATN
          PACK      ALTKEY35,PMECHOSP,PMECURNO,PMECADMN,PMECINVN,PMECBATN
.
          PACK      KEY35,PMECHOSP,NEWURNO,PMECADMN,PMECINVN,PMECBATN
          CALL      RAPMECT5                     * New U/R already exists?
          BRANCH    OVRCD,FIXECL20               * No, update with new U/R
.
          MOVE      SAVKEY35,KEY35
          CALL      DEPMECT1                     * Yes, delete old U/R
.         GOTO      FIXECL50                     * Loop back to read next rec

FIXECL20  MOVE      SAVKEY35,KEY35
          CALL      RDPMECT1                     * position to index1 for update
          BRANCH    OVRCD,FIXECL99
.         
          MOVE      NEWURNO,PMECURNO             * Update with new U/R 
          CALL      UPPMECT1                     
.
FIXECL50  MOVE      ALTKEY35,KEY35
          GOTO      FIXECL00                     * Loop back to read next rec
.
          INC       IBAOVRIO/INC
          INC       PMSECTIO/INC
.
FIXECL99  ENDPROC
+
.*==========================================================================*
.*      Subroutine to fix the Patient Eclipse Claim Table using Admission   *
.*==========================================================================*
          DEFPROC   FIXECLA
.
          INC       PMSECTFD/INC
.
.         See if EDI parameter is turned on
.
FIXECLA   OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*115,PTCNUEDI
.
          COMPARE   ONE,PTCNUEDI                 * Using EDI ?
          GOTO      FXECLA99 IF NOT EQUAL        * no - finished
.
.         Open eclipse claim file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsectaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSECTA1,"pmsectaf"
          OPEN      PMSECTA5,"pmsectaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXECLA99
.                   
.         Fix the eclipse claim summary table (pmsectaf)
.         
          MOVE      SP3,SAVEHOSP
          PACK      KEY35,SP3,OURNO,AADMNO,SP30,SP5
FXECLA00  CALL      RSPMECT5                     * Position at start of Old U/R
          CALL      RKPMECT5                     * Read next record
          BRANCH    OVRCD,FXECLA99               * Exit at end of file
.
          MATCH     SAVEHOSP,PMECHOSP            * same hospital still ?
          IF        !@EQUAL
            MOVE      PMECHOSP,SAVEHOSP          * no - position for next hosp.
            PACK      KEY35,PMECHOSP,OURNO,AADMNO,SP30,SP5
            GOTO      FXECLA00
          ENDIF
.
          MATCH     OURNO,PMECURNO               * same old u/r still ?
          IF        !@EQUAL
            PACK      KEY35,SAVEHOSP,TILDA35     * no
            GOTO      FXECLA00
          ENDIF
.
          MOVE      AADMNO,DIM8
          MATCH     DIM8,PMECADMN                * same admission still ?
          IF        !@EQUAL
            PACK      KEY35,SAVEHOSP,TILDA35     * no
            GOTO      FXECLA00
          ENDIF
.
          PACK      SAVKEY35,PMECHOSP,PMECFLAG,PMECHFND,PMECADMN,PMECINVN:
                             PMECBATN
          PACK      ALTKEY35,PMECHOSP,PMECURNO,PMECADMN,PMECINVN,PMECBATN
.
          PACK      KEY35,PMECHOSP,NEWURNO,PMECADMN,PMECINVN,PMECBATN
          CALL      RAPMECT5                     * New U/R already exists?
          BRANCH    OVRCD,FXECLA20               * No, update with new U/R
.
          MOVE      SAVKEY35,KEY35
          CALL      DEPMECT1                     * Yes, delete old U/R
.         GOTO      FXECLA50                     * Loop back to read next rec

FXECLA20  MOVE      SAVKEY35,KEY35
          CALL      RDPMECT1                     * position to index1 for update
          BRANCH    OVRCD,FXECLA99
.         
          MOVE      NEWURNO,PMECURNO             * Update with new U/R 
          CALL      UPPMECT1                     
.
FXECLA50  MOVE      ALTKEY35,KEY35
          GOTO      FXECLA00                     * Loop back to read next rec
.
          INC       IBAOVRIO/INC
          INC       PMSECTIO/INC
.
FXECLA99  ENDPROC
+
.*********************************************************************
.       Procedure to fix the current patient file
.*********************************************************************
.
          DEFPROC   FIXCUR
.
.
          INC       PMSCURFD/INC
.
.         Open current patient file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmscuraf"
          TRAP      OVERCOND IF IO
          OPEN      PMSCURA3,"pmscuraf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXCUR99
.
          DISPLAY   *P1:24,*EL,"Fixing current patient file";
          CALL      FIXCR000
          GOTO      FIXCUR99
.*********************************************************************
.         Subroutine to update the current patient file
.*********************************************************************
FIXCR000  OPEN      PMSCURA3,"pmscuraf"
.
FIXCR010  PACK      KEY16,OURNO,SP70
          CALL      RSPMCUR3
          CALL      RKPMCUR3
          BRANCH    OVRCD,FIXCR099
.
.         Update file with new UR
.
          MATCH     PMCUURNO,OURNO
          GOTO      FIXCR099 IF NOT EQUAL
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,FIXCR099
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,FIXCR099
.
          MOVE      NEWURNO,PMCUURNO
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          CALL      UPPMCUR3
.
          GOTO      FIXCR010           * Loop back to correct file position
.                                      * after key has been updated
FIXCR099  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSCURIO/INC
.
FIXCUR99  ENDPROC
++
.
.       ==============================================
.       Procedure  to fix the Medical records tracking
.       ================================================
.       25/09/90 D.Di.Paola.
.       N.B. - Problem occurs when both u/r's have the same
.              combination of medical records....
.              Therefore user input is required to determine
.              which record is kept to stop duplicates occuring....
.       NOTE : Refer to similar probelm in waiting lists 
.       ==============================================
.
          DEFPROC   FIXMRT    
.
          INC       MRTMASFD/INC
          INC       MRTLOCFD/INC
.
. Vars For MRTLOCDS
.
MRCNHMTY  DIM       3
LOCATION  DIM       30
DIM30     DIM       30
COUNT     FORM      2
LOCATNS   FORM      1
HOMEONLY  FORM      "1"
DISPARRY  DIM       4[36]
CODELT    INIT      "LT"
CODETY    INIT      "TY"
.
DOCTYPE   DIM       3
HOMLOCAT  DIM       4
VOLUMNUM  FORM      2
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"mrtmasaf"
          TRAP      OVERCOND IF IO
          OPEN      MRTMASA1,"mrtmasaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDMRT
          CLOSE     MRTMASA1
.
          DISPLAY   *P1:24,*EL,"Fixing Medical Records Tracking";
          MOVE      OURNO,PVIURNO
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,SIXTY;*105,MRCNHMTY
.
.       Update the tracking master file
.
          CALL      MRT0000              * fix tracking masterfile
          GOTO      ENDMRT
.
.********************************************************************** 
.*                            MRT0000                                 *
.*               Fix Medical Records Tracking Records                 *
.********************************************************************** 
.
MRT0000   OPEN      MRTMASA1,"mrtmasaf"            * open trk masterfile
          OPEN      MRTLOCA1,"mrtlocaf"            * open trk location file
          OPEN      MRTLOCA2,"mrtlocaf"            * open trk location file
.
MRT0100   PACK      KEY17,PVIURNO,SP20
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,MRT9999
.
          MATCH     MRMAURNO,PVIURNO
          GOTO      MRT9999 IF NOT EQUAL
.
          DISPLAY   *P1:3,*EF:
                    *P1:4,"U/R Number       : ":
                    *P20:4,*V2LON,PVIURNO,*HOFF:
                    *P41:4,"U/R Number       : ":
                    *P60:4,*V2LON,*BLINKON,NEWURNO,*HOFF:
                    *P1:5,"Record           : ":
                    *P20:5,*V2LON,MRMAURNO,*HOFF:
                    *P28:5,SLASH:
                    *P29:5,*V2LON,MRMAHLOC,*HOFF:
                    *P33:5,SLASH:
                    *P34:5,*V2LON,MRMADOTY,*HOFF:
                    *P37:5,SLASH:
                    *P38:5,*V2LON,MRMAVOLN,*HOFF:
                    *P1:7,"Home Location    : ":
                    *P20:7,*V2LON,MRMAHLOC,*HOFF:
                    *P1:9,"Type of Document : ":
                    *P20:9,*V2LON,MRMADOTY,*HOFF:
                    *P1:11,"Volume Number    : ":
                    *P20:11,*V2LON,MRMAVOLN;
.
MRT0200   MOVE      NEWURNO,MRMAURNO
          MOVE      MRMAHLOC,HOMLOCAT
          MOVE      MRMAVOLN,VOLUMNUM
          MOVE      MRMADOTY,DOCTYPE
          CALL      DISN0000                     * Display New Med. Record
.
MRT0300   CALL      SEL0000                      * Select Field to Change
.
          CALL      UPDT0000                     * Update Tracking Master File
          BRANCH    EXIT,MRT0300                 * Medical Reord Already Exists
          GOTO      MRT0100
.
MRT9999   CLOSE     MRTMASA1                    * close tracking masterfile
          CLOSE     MRTLOCA1                    * close tracking location file
          CLOSE     MRTLOCA2
          RETURN
+
.
.********************************************************************** 
.*                           DISN0000                                 *
.*                    Display New Medical Record                      *
.********************************************************************** 
DISN0000  DISPLAY   *P41:5,"Record           : ":
                    *P60:5,*V2LON,NEWURNO,*HOFF:
                    *P68:5,SLASH:
                    *P69:5,*V2LON,HOMLOCAT,*HOFF:
                    *P73:5,SLASH:
                    *P74:5,*V2LON,DOCTYPE,*HOFF:
                    *P77:5,SLASH:
                    *P78:5,*V2LON,VOLUMNUM,*HOFF:
                    *P41:7,"Home Location    : ":
                    *P60:7,*V2LON,HOMLOCAT,*HOFF:
                    *P41:9,"Type of Document : ":
                    *P60:9,*V2LON,DOCTYPE,*HOFF:
                    *P41:11,"Volume Number    : ":
                    *P60:11,*V2LON,VOLUMNUM;
          RETURN
+
.
.********************************************************************** 
.*                           UPDT0000                                 *
.*                  Update New Details in mrtmasaf                    *
.********************************************************************** 
.
UPDT0000  PACK      KEY17,NEWURNO,HOMLOCAT,DOCTYPE,VOLUMNUM
          CALL      RAMRMAS1
          BRANCH    OVRCD,UPDT1000
.
          DISPLAY   *P1:24,*EL,*B,"Medical Record Already on File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
.
          MOVE      TRUE,EXIT
          GOTO      UPDT9999
.
UPDT1000  PACK      KEY17,PVIURNO,MRMAHLOC,MRMADOTY,MRMAVOLN
          CALL      RDMRMAS1
.
          MOVE      NEWURNO,MRMAURNO
          MOVE      HOMLOCAT,MRMAHLOC
          MOVE      DOCTYPE,MRMADOTY
          MOVE      VOLUMNUM,MRMAVOLN
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
.
          PACK      KEY17,MRMAURNO,MRMAHLOC,MRMADOTY,MRMAVOLN
          CALL      UPMRMAS1
          MOVE      FALSE,EXIT
.
UPDT9999  RETURN
+
.
.********************************************************************** 
.*                            SEL0000                                 *
.*                  Select Item, (P)ost ? _                           *
.********************************************************************** 
.
SEL0000   MOVE      FALSE,EXIT
.
          DISPLAY   *P38:7,*V2LON,ONE,DOT:
                    *P38:9,TWO,DOT:
                    *P38:11,THREE,DOT;
.
SEL0100
          CALL      MAINQSTC              * Select Item, Post
.
          COMPARE   ZERO,CCITEM
          GOTO      SEL9999 IF EQUAL
.
          BRANCH    CCITEM,SEL1000,SEL2000,SEL3000
.
          BEEP
          GOTO      SEL0100
.
SEL1000
          CALL      HLOC0000                     * Get new Home Location
          GOTO      SEL0000
SEL2000
          CALL      TDOC0000                     * Get new Document Type
          GOTO      SEL0000
SEL3000
          CALL      VOLM0000                     * Get new Volume
          GOTO      SEL0000
SEL9999   RETURN
+
.********************************************************************** 
.*                            HLOC0000                                *
.*                   Keyin New Home Location Code                     *
.********************************************************************** 
.
HLOC0000
          DISPLAY   *P60:7,*EL,UNDLN4
.
          KEYIN     *P60:7,*V2LON,HOMLOCAT;
.
          ENDSET    HOMLOCAT
          APPEND    SP4,HOMLOCAT
          RESET     HOMLOCAT
.
          DISPLAY   *P60:7,*V2LON,HOMLOCAT;
.
          MATCH     SP3,HOMLOCAT
          GOTO      HLOC0100 IF NOT EQUAL
.
          BEEP
          GOTO      HLOC0000
HLOC0100
          MATCH     QUEST,HOMLOCAT
          GOTO      HLOC1000 IF NOT EQUAL
.
. ----    Question Mark Routine for the Home Location Code   -----
.
          MOVE      SP4,HOMLOCAT
.
          MOVE      ONE,CNEWDS
          CALL      MRTLOCDS
HLOC0190
          DISPLAY   *P1:24,"Home Location : ",UNDLN4;
HLOC0200
          KEYIN     *P17:24,*V2LON,*EL,HOMLOCAT;
.
          ENDSET    HOMLOCAT
          APPEND    SP4,HOMLOCAT
          RESET     HOMLOCAT
.
          MATCH     SP3,HOMLOCAT
          GOTO      HLOC0200 IF EQUAL
.
          MOVE      HOMLOCAT,KEY4
          CALL      RDMRLOC1
.
          COMPARE   ZERO,OVRCD
          GOTO      HLOC0300 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Location Not On File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
.
          GOTO      HLOC0190
HLOC0300
          PACK      KEY5,CODELT,MRLOTYPE
          CALL      RDCODE1
.
          COMPARE   ZERO,OVRCD
          GOTO      HLOC0400 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Location Type Not on Codes File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
          
          CALL      RDIS0000
.
          GOTO      HLOC0190
HLOC0400
          CALL      RDIS0000
.
HLOC1000
          MOVE      HOMLOCAT,KEY4
          CALL      RDMRLOC1
.
          COMPARE   ZERO,OVRCD
          GOTO      HLOC1100 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Location Not On File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
.
          GOTO      HLOC0000
HLOC1100
          PACK      KEY5,CODELT,MRLOTYPE
          CALL      RDCODE1
          COMPARE   ZERO,OVRCD
          GOTO      HLOC1200 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Location Type Not on File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
          GOTO      HLOC0000
HLOC1200
          DISPLAY   *P69:5,*V2LON,HOMLOCAT,*HOFF;
.
          RETURN
+
.
.********************************************************************** 
.*                            TDOC0000                                *
.*                   Keyin Type of Document Code                      *
.********************************************************************** 
.
TDOC0000
          DISPLAY   *P60:9,*EL,UNDLN3
.
          KEYIN     *P60:9,*V2LON,DOCTYPE;
.
          ENDSET    DOCTYPE
          APPEND    SP3,DOCTYPE
          RESET     DOCTYPE
.
          DISPLAY   *P60:9,*V2LON,DOCTYPE;
.
          MATCH     SP3,DOCTYPE
          GOTO      TDOC0100 IF NOT EQUAL
.
          BEEP
          GOTO      TDOC0000
TDOC0100
          MATCH     QUEST,DOCTYPE
          GOTO      TDOC1000 IF NOT EQUAL
.
. ----    Question Mark Routine for the Home Location Code   -----
.
          MOVE      SP3,DOCTYPE
.
          MOVE      ONE,CNEWDS
          MOVE      CODETY,CODE
          CALL      PATCODDS
TDOC0190
          DISPLAY   *P1:24,"Document Type : ",UNDLN3;
TDOC0200
          KEYIN     *P17:24,*V2LON,*EL,DOCTYPE;
.
          ENDSET    DOCTYPE
          APPEND    SP4,DOCTYPE
          RESET     DOCTYPE
.
          MATCH     SP3,DOCTYPE
          GOTO      TDOC0200 IF EQUAL
.
          PACK      KEY5,CODETY,DOCTYPE
          CALL      RDCODE1
.
          COMPARE   ZERO,OVRCD
          GOTO      TDOC0300 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Document Type Not On File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
.
          GOTO      TDOC0190
TDOC0300
          CALL      RDIS0000
TDOC1000
          PACK      KEY5,CODETY,DOCTYPE
          CALL      RDCODE1
.
          COMPARE   ZERO,OVRCD
          GOTO      TDOC1100 IF EQUAL
.
          DISPLAY   *P1:24,*EL,*B,"Document Type Not On File - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
.
          GOTO      TDOC0000
TDOC1100
          DISPLAY   *P74:5,*V2LON,DOCTYPE,*HOFF;
.
          RETURN
+
.
.********************************************************************** 
.*                            VOLM0000                                *
.*                       Keyin Record Volume                          *
.********************************************************************** 
.
VOLM0000  DISPLAY   *P60:11,*EL,UNDLN2
.
          KEYIN     *P60:11,*V2LON,VOLUMNUM;
.
          DISPLAY   *P60:11,*V2LON,VOLUMNUM;
.
          COMPARE   ZERO,VOLUMNUM
          GOTO      VOLM0100 IF NOT EQUAL
.
          BEEP
          GOTO      VOLM0000
VOLM0100
          DISPLAY   *P78:5,*V2LON,VOLUMNUM;
.
          RETURN
+
.***************************************************************************
.*                           RDIS0000                                      *
.*                     redisplay tracking details                          *
.***************************************************************************
RDIS0000  
          DISPLAY   *P1:3,*EF:
                    *P1:4,"U/R Number       : ":
                    *P20:4,*V2LON,PVIURNO,*HOFF:
                    *P41:4,"U/R Number       : ":
                    *P60:4,*V2LON,*BLINKON,NEWURNO,*HOFF:
                    *P1:5,"Record           : ":
                    *P20:5,*V2LON,PVIURNO,*HOFF:
                    *P28:5,SLASH:
                    *P29:5,*V2LON,MRMAHLOC,*HOFF:
                    *P33:5,SLASH:
                    *P34:5,*V2LON,MRMADOTY,*HOFF:
                    *P37:5,SLASH:
                    *P38:5,*V2LON,MRMAVOLN,*HOFF:
                    *P1:7,"Home Location    : ":
                    *P20:7,*V2LON,MRMAHLOC,*HOFF:
                    *P1:9,"Type of Document : ":
                    *P20:9,*V2LON,MRMADOTY,*HOFF:
                    *P1:11,"Volume Number    : ":
                    *P20:11,*V2LON,MRMAVOLN;
.
          CALL      DISN0000               * redisplay new record 
          RETURN   
+
          INC       IBAOVRIO/INC
          INC       MRTLOCDS
          INC       MRTMASIO/INC
          INC       MRTLOCIO/INC
.
ENDMRT    ENDPROC
++
.
.       ===========================================================
.       Procedure to write a record to the U/R Number Change Audit
.       ===========================================================
.
          DEFPROC   WRAUDT    
.
          INC       PATAZ1FD/INC
          INC       IBAPASFD/INC  
.
          COMPARE   ONE,CURCHG
          GOTO      ENDAUZ IF NOT EQUAL
.
          CALL      OPPTAUZ1
.
          MOVE      OURNO,AZURNO
          MOVE      PURNO,AZURNN
          MOVE      PTITL,AZTITL
          MOVE      PSNAME,AZSNAM
          MOVE      PGNAME,AZGNAM
          MOVE      PADD1,AZADD1
          MOVE      PADD2,AZADD2
          MOVE      PSUBRB,AZSUBR
          MOVE      PPOST,AZPOST
          MOVE      PMEDI,AZMEDI
          MOVE      PTELEP,AZTELP
          MOVE      PSEX,AZSEX
          PACK      AZBDAT WITH PBDATE
          PACK      AZDATE WITH CCC,CYY,CMM,CDD
          REP       " 0",AZDATE
          CLOCK     TIME,AZTIME
          MOVE      PASSCODE,AZOPID
.
          CALL      OPPASS1
          MOVE      "Invalid user code",SECUSER
          MOVE      PASSCODE,KEY4
          CALL      RDPASS1
          CALL      CLPASS1
          MOVE      SECUSER,AZOPER
.
          CALL      UPAUDZ
          GOTO      ENDAUZ
.
          INC       PATAZ1IO/INC
          INC       IBAPASIO/INC
          INC       IBAOVRIO/INC
.
ENDAUZ    ENDPROC
+
.       =======================
.       Process one A + E visit
.       =======================
.
.         Open A + E files if they exist
.
FIXAAE    MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"aaede1af"
          TRAP      OVERCOND IF IO
          OPEN      AAEDE1A1,"aaede1af"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDAAE
          CLOSE     AAEDE1A1
.
.
.       Do the actual work for fixing up the admission
.
          MOVE      ONE,FORM1                * using pat files in fixinv
          PROC      FIXINV            * Invoice file
.
.       Fix up the A + E visit
.
          CALL      FIXDET            * A + E details
          CALL      FIXEMR            * EMR details
          CALL      FIXVIS            * Visit file
.
          DISPLAY   *P1:24,*EL,"A + E : ",*V2LON,PVIBILL:
                    *HOFF," Completed";
.
ENDAAE    RETURN
+
.
.       ===========================
.       Process one inpatient visit
.       ===========================
.
.       Lock the admission record
.
FIXINP    MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1
          BRANCH    OVRCD,ENDINP,LCKINP
.
.       Do the actual work for fixing up the admission
.
          MOVE      ONE,FORM1         * Using pat files in fixinv
          PROC      FIXINV            * Invoice file
.
.       If we are using medical services, fix up their invoice file
.
          COMPARE   ONE,CMEDSERV
          GOTO      CNTFIX IF NOT EQUAL
.
          MOVE      TWO,FORM1         * using med files in fixinv
          PROC      FIXINV            * Medical Service Invoice file
.
CNTFIX    CALL      FIXDSC            * Discharge file
          CALL      FIXTRN            * Transfer file
          PROC      FIXLOC            * Location file
          CALL      FIXVIS            * Visit file
          CALL      FIXMIS            * Admission file
          CALL      MHVS0000          * MH Visit file
          CALL      FXBKRES1          * Booking file
          PROC      FIXCRG            * Cancer Registration file
          PROC      FIXEDIA           * EDI summary file
          PROC      FIXECLA           * ECL claim file
          PROC      FIXREL            * Related Provider Invoices
          PROC      FIXVBED           * Change pmsbbdaf
          PROC      FIXVEXP           * Change pmsepbaf
.
...          COMPARE   ZERO,PTCNNMPI
...          GOTO      CNTFX1 IF EQUAL
.
.
CNTFX1    DISPLAY   *P1:24,*EL,"Admission : ",*V2LON,AADMNO:
                    *HOFF," Completed";
ENDINP    RETURN
.
LCKINP    DISPLAY   *P1:24,*EL,"Patient Admission ",*V2LON,AADMNO,*HOFF:
                    " Busy on Terminal ",*V2LON,APORT,*HOFF,".  ";
          CALL      HITENTER
          GOTO      FIXINP
+
.       =======================================
.       Subroutine to fix up the discharge file
.       =======================================
.
FIXDSC    OPEN      PATDSCH1,"patdschf"
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,ENDDSC
.
          DISPLAY   *P1:24,*EL,"Discharge : ",*V2LON,DADMNO;
          MOVE      NEWURNO,DURNO
          CALL      UPDSCH1
.
ENDDSC    RETURN
+
.*********************************************************************=
.         Subroutine to fix up the booking file for a single admission
.*********************************************************************=
FXBKRES1  OPEN      BOKRC1A1,"bokrc1af"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTX1A1,"wattx1af"
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,FXBKRES9
.
          DISPLAY   *P1:24,*EL,"Booking   : ",*V2LON,DADMNO;
          MOVE      NEWURNO,BKREURNO
          CALL      UPBKREC1
.
. see if this is a W/L booking record
.
          PACK      KEY19,OURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,FXBKRES9          * no W/L procedure
.
          MOVE      BKRECNT,FORM2           * set the count
.
FXBKRES3  PACK      KEY19,NEWURNO,BKREPROC,FORM2
          CALL      RDTREA1
          BRANCH    OVRCD,FXBKRES5
.
          ADD       ONE,FORM2               * add to the count
          GOTO      FXBKRES3
.
. update W/L treatment file and booking file
.
FXBKRES5  PACK      KEY19,OURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          MOVE      NEWURNO,WMURNO
          MOVE      FORM2,WMCNT
          CALL      UPTREA1                 * update W/L treatement file
.
          PACK      KEY19,OURNO,WMCODE,BKRECNT
          CALL      RDWTTX11
          IF        OVRCD = 0
            MOVE      NEWURNO,WTTXURNO          * update U/R number
            MOVE      WMCNT,WTTXPCNT            * update count
            CALL      UPWTTX11                  * update record
          ENDIF
.
          MOVE      FORM2,BKRECNT           * set the new count 
          CALL      UPBKREC1                * update booking file
.
          PROC      UPESIS00                * update ESIS Episode record
.
          PACK      KEY38,KEY19,NEWURNO,BKREPROC,WMCNT
          PROC      UPWTSGL                 * update rest of W/L files
.
FXBKRES9  RETURN
+
.
.       ====================================================================
.       Procedure  to fix up the Invoice file, Dtran file (Inpatient's only)
.       parameters : FORM1 - 1 = using pat files
.                         else = using med files
.       ====================================================================
.
          DEFPROC   FIXINV    
.
          INC       PATINVFD/INC
          INC       PATDTRFD/INC
          INC       NZPRDTFD/INC
          INC       PMSMTIFD/INC
.
          IF        FORM1=1
            OPEN      PATINVR3,"patinvrf"
            OPEN      PATDTRA1,"patdtraf"
            OPEN      NZPRDTA1,"nzprdtaf"
            OPEN      PMSMTIA1,"pmsmtiaf"
          ELSE
            OPEN      PATINVR3,"medinvrf"
            OPEN      PATDTRA1,"meddtraf"
            OPEN      PMSMTIA1,"pmsmtiaf"
          ENDIF
.
          MOVE      PVIBILL,AADMNO
          PACK      KEY16 WITH AADMNO,SP20
          CALL      RDSINV3
NEXTINV   CALL      RDKINV3
          BRANCH    OVRCD OF ENDINV
.
          MATCH     AADMNO,PINVADM
          GOTO      ENDINV IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,"Invoice : ",*V2LON,PINVNO;
.
.       Update the invoice record
.
          MOVE      NEWURNO,PINVUR
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV3
.
          PROC      FLAGDEBT
.
.       Fix up the Dtran records for this invoice if it is an inpatient invoice
.
          COMPARE   THREE,PINVSYS
          CALL      FIXDTR IF EQUAL
          GOTO      NEXTINV
+
.       =======================================================
.       Subroutine to fix up the Dtran records for this invoice
.       =======================================================
.
FIXDTR    PACK      KEY22 WITH PINVADM,SP20
          CALL      RDSDTRN1
NEXTDTR   CALL      RDKDTRN1
          BRANCH    OVRCD OF NEXTMT1
.
          MATCH     TADMNO,AADMNO
          GOTO      NEXTMT1 IF NOT EQUAL
.
          MATCH     "H",TTYPEDEB
          GOTO      NEXTDTR IF EQUAL
.
          MATCH     "I",TTYPEDEB
          GOTO      NEXTDTR IF EQUAL
.
          DISPLAY   *P1:24,*EL,"Transaction : ",*V2LON,TTRANSN1;
.
          MOVE      NEWURNO,TDCODE
          CALL      UPDTRN1
          GOTO      NEXTDTR
.
NEXTMT1   PACK      KEY14,DPINVADM,SP20
          CALL      RSPMMTI1
NEXTMT2   CALL      RKPMMTI1
          BRANCH    OVRCD,ENDDTR
.
          MATCH     PMMIVISN,DPINVADM
          GOTO      ENDDTR IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,"Transaction : ",*V2LON,PMMITRAN;
.
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          MOVE      NEWURNO,PMMIURNO
          CALL      UPPMMTI1
          GOTO      NEXTMT2
.
ENDDTR    CALL      FIXNZDTR
          RETURN
+
.       =======================================================
.       Subroutine to fix up the NZP Dtran records for this invoice
.       =======================================================
.
FIXNZDTR  PACK      KEY22 WITH PINVADM,SP20
          CALL      RSNZRDT1
NXTNZDTR  CALL      RKNZRDT1
          BRANCH    OVRCD,ENDNZDTR
.
          MATCH     TADMNO,AADMNO
          GOTO      ENDNZDTR IF NOT EQUAL
.
          MATCH     "H",TTYPEDEB
          GOTO      NXTNZDTR IF EQUAL
.
          MATCH     "I",TTYPEDEB
          GOTO      NXTNZDTR IF EQUAL
.
          DISPLAY   *P1:24,*EL,"Transaction : ",*V2LON,TTRANSN1;
.
          MOVE      NEWURNO,TDCODE
          CALL      UPNZRDT1
          GOTO      NXTNZDTR
.
ENDNZDTR  RETURN
+
          INC       IBAOVRIO/INC
          INC       PATINVIO/INC
          INC       PATDTRIO/INC
          INC       NZPRDTIO/INC
          INC       PMSMTIIO/INC
.
ENDINV    CLOSE     PATINVR3
          CLOSE     PATDTRA1
          CLOSE     PMSMTIA1
          ENDPROC
++
.
.       ================================
.       Fix up the transfer file records
.       ================================
.
FIXTRN    OPEN      PATTRAN2,"pattranf"
          MOVE      PVIBILL,AADMNO
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
.
NEXTTRN   CALL      RDKTRAN2
          BRANCH    OVRCD OF ENDTRN
.
          MATCH     TADMN,AADMNO
          GOTO      ENDTRN IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,"Transfer : ",*V2LON,TWARD,"/",TBED;
.
          MOVE      NEWURNO,TURNO
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      NEXTTRN
.
ENDTRN    CLOSE     PATTRAN2
          RETURN
.
.       ================================================================
.       Subroutine to update the In-patient location record if it exists
.       ================================================================
.
          DEFPROC   FIXLOC    
.
          INC       PATLOCFD/INC
.
          OPEN      PATLOCA1,"patlocaf"
.
          PACK      KEY8,OURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,FIXLOC90
.
          PACK      KEY8,OURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,FIXLOC90
.
          MOVE      PVIBILL,AADMNO
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO,SP70,SP70
          CALL      RDLOCA1
          BRANCH    OVRCD,FIXLOC90
.
          DISPLAY   *P1:24,*EL,"Location : ",*V2LON,LADMNO;
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ENDLOC
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ENDLOC
.
          MOVE      NEWURNO,LURNO
          MOVE      PTMASNAM,LSNAME
          MOVE      PMPXFNAM,LGNAME
          MOVE      PMPXSNAM,PTLCGNM2
          CALL      UPLOCA1
          GOTO      ENDLOC
.
.         Re-read the PMI tables for the new U/R to restore all variables
.
FIXLOC90  MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          GOTO      ENDLOC
.
          INC       IBAOVRIO/INC
          INC       PATLOCIO/INC
.
ENDLOC    CLOSE     PATLOCA1
          ENDPROC
++
.
.       =================================================================
.       Subroutine to change the old U/R number in the patient visit file
.       =================================================================
.
FIXVIS    MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1
          BRANCH    OVRCD,NOVISA,LCKEDV
.
.       Write the new U/R number
.
          MOVE      NEWURNO,PVIURNO
          CALL      UPVISA1
          CALL      UUPTVIS1
          CALL      URNC0000
          DISPLAY   *P1:24,*EL,"Visit : ",*V2LON,PVIBILL;
          GOTO      ENDVIS
.
.       Visit file locked
.
LCKEDV    DISPLAY   *P1:24,*EL,*P20:24,*V2LON:
                    "** Visit ",PVIBILL," locked on Port ",PVILOCK:
                    ". Please wait **",*W,*P1:24,*EL;
          GOTO      FIXVIS
.
NOVISA    DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Error : Visit ",PVIBILL," has disappeared. Contact IBA ":
                    "Immediately **",*W4;
.
ENDVIS    RETURN
.
.       =========================================================
.       Subroutine to update the U/R number in the Admission file
.       =========================================================
.
FIXMIS    MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            MOVE      NEWURNO,AURNO
            CALL      UPMISS1
            CALL      UUPTMIS1
          ELSE
            DISPLAY   *P1:24,*EL,*B,*V2LON:
                      "** Error Changing Admission Record U/R Number, ":
                      "Contact IBA Immediately **",*W4;
          ENDIF
.
          PROC      WRWATR00
          RETURN
.
.**********************************************************************
.*                            MHVS0000                                *
.*                     Update Mental Health Visit File                *
.**********************************************************************
.
MHVS0000  OPEN      MEHVI1A1,"mehvi1af"
.
          MOVE      "mehvi1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MHVS9999
.
          DISPLAY   *P30:24,*EL,"Mental Health: ",*V2LON,AADMNO;
          MOVE      NEWURNO,MHVIURNO
          CALL      UPMHVIS1
MHVS9999  RETURN
+
.        ===================================
.        Procedure to fix up the Alert file
.        ===================================
.
          DEFPROC   FIXALR    
.
          INC       PATALRFD/INC
          INC       PMSALNFD/INC
.
ALERT001  DIM       2
ALERT002  DIM       3
ALERT013  DIM       3
SAVKEY16  DIM       16
SAVKEY19  DIM       19
NEWKEY16  DIM       16
.
          OPEN      PATALRT1,"patalrtf"
          OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
RADALR    PACK      KEY16,OURNO,SP10
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,AUDALR 
.
          MATCH     OURNO,PTALURNO
          GOTO      AUDALR IF NOT EQUAL
. 
          PACK      SAVKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
.
          MOVE      PTALCNTR,ALERT013
.
          PACK      KEY16,NEWURNO,PTALCATG,PTALCODE,PTALCNTR
          CALL      RAPTALR1                    * read into ans;
          BRANCH    OVRCD,UPDALR                * new u/r not on file, go update
.
          MOVE      PTALCATG,ALERT001
          MOVE      PTALCODE,ALERT002
          CALL      CONA0000                      * Calculate contact counter
.
UPDALR    PACK      KEY16,SAVKEY16     * read old record
          CALL      RDPTALR1                          * full read
          BRANCH    OVRCD,RADALR
.
          MOVE      NEWURNO,PTALURNO                  * move new u/r to old u/r
          MOVE      ALERT013,PTALCNTR                 * move new u/r to old u/r
          PACK      NEWKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          CALL      UPPTALR1                          * update record
.
          CALL      FIXALN00
          GOTO      RADALR 
.
AUDALR    CALL      CHKALR00                          * update alert indicator
          BRANCH    CAUDA1,ENDALR                     * Using Audits
.
RSDALR    PACK      KEY27,OURNO,SP70
          CALL      ASPTALR2
          CALL      AKPTALR2
          BRANCH    OVRCD,DELALR
.
          MATCH     OURNO,PTALURNO
          GOTO      DELALR IF NOT EQUAL
.
          MOVE      NEWURNO,PTALURNO
          CALL      AUPTALR2
          GOTO      RSDALR
.
DELALR    PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ENDALR
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21                * check for wahealth alerts
          BRANCH    OVRCD,DELALR10
.
          MATCH     "1",PMPXSIN7
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN8
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN9
          GOTO      ENDALR IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSN11
          GOTO      ENDALR IF EQUAL       * current alert exists
.
DELALR10  MATCH     "0",PTMXSIN1            * Any current alerts
          IF        !@EQUAL
            MATCH     " ",PTMXSIN1          * Any current alerts
            GOTO      ENDALR IF NOT EQUAL
          ENDIF
. 
          PACK      KEY27,NEWURNO,SP70
          CALL      ASPTALR2
ADLALR    CALL      AKPTALR2
          BRANCH    OVRCD,ENDALR
.
          MATCH     NEWURNO,PTALURNO
          GOTO      ENDALR IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR           * Delete
          GOTO      ADLALR IF NOT EQUAL
.
          MOVE      "3",PTMXSIN1            * Yes there are deleted alerts
.
          CALL      UPMAST1
          GOTO      ENDALR
.
.------------------------------------------------------------
. Calculate the counter number for this U/R and alert
.------------------------------------------------------------
CONA0000  MOVE      ZERO,F3                       * Set counter
          READ      CONTROLF,TEN;*250,CAUDA1
.
          PACK      KEY16,NEWURNO,ALERT001,ALERT002,Z70
          CALL      RSPTALR1
          CALL      RPPTALR1
          BRANCH    OVRCD,CONA2000
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CONA2000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONA2000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONA2000 IF NOT EQUAL
.
          MOVE      PTALCNTR,F3
.
CONA2000  BRANCH    CAUDA1,CONA9000              * Check if using audit file
.
          PACK      KEY27,NEWURNO,Z70
          CALL      ASPTALR2
          CALL      APPTALR2
          BRANCH    OVRCD,CONA9000
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CONA9000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONA9000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONA9000 IF NOT EQUAL
.
          MOVE      ZERO,F3A                    * Use audit file counter if
          MOVE      PTALCNTR,F3A                * higher
          IF        F3A>F3
            MOVE      F3A,F3
          ENDIF
.
CONA9000  ADD       ONE,F3
          MOVE      F3,ALERT013
.
CONA9999  RETURN
.
FIXALN00  OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
FIXALN10  PACK      KEY19,SAVKEY16,SP20
          CALL      RSPMALN1
          CALL      RKPMALN1
          BRANCH    OVRCD,FIXALN50
.
          UNPACK    SAVKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          PACK      SAVKEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO
.
          MATCH     PTALURNO,PMANURNO
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      FIXALN50 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      FIXALN50 IF NOT EQUAL
.
          UNPACK    NEWKEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          PACK      KEY19,NEWURNO,PTALCATG,PTALCODE,PTALCNTR,PMANLNNO
          CALL      RAPMALN1                    * read into ans;
          BRANCH    OVRCD,FIXALN20              * new u/r not on file, go update
          CALL      DEPMALN1                    * delete new u/r no.
.
FIXALN20  PACK      KEY19,SAVKEY19,SP70         * read old record
          CALL      RDPMALN1                          * full read
          MOVE      NEWURNO,PMANURNO                  * move new u/r to old u/r
          MOVE      PTALCNTR,PMANCNTR                 * move new u/r to old u/r
          CALL      UPPMALN1                          * update record
.
          GOTO      FIXALN10
.
FIXALN50  BRANCH    CAUDA1,FIXALN99                   * Using Audits
.
FIXALN60  PACK      KEY27,OURNO,SP70
          CALL      ASPMALN2
          CALL      AKPMALN2
          BRANCH    OVRCD,FIXALN99
.
          MATCH     OURNO,PMANURNO
          GOTO      FIXALN99 IF NOT EQUAL
.
          MOVE      NEWURNO,PMANURNO
          CALL      AUPMALN2
          GOTO      FIXALN60
.
FIXALN99  CLOSE     PMSALNA1
          RETURN
+
          INC       IBAOVRIO/INC
          INC       PATALRIO/INC
          INC       PMSALNIO/INC
.
ENDALR    CLOSE     PATALRT1
          CLOSE     PMSAUDA2
          ENDPROC
.
.        ========================================
.        Procedure to fix up the Alert Notes file
.        ========================================
.
          DEFPROC   FIXALN    
.
          INC       PMSALNFD/INC
.
          OPEN      PMSALNA1,"pmsalnaf"
          IF        CAUDA1<>1
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
RADALN    PACK      KEY19,OURNO,SP20
          CALL      RSPMALN1
          CALL      RKPMALN1
          BRANCH    OVRCD,AUDALN 
.
          MATCH     OURNO,PMANURNO
          GOTO      AUDALN IF NOT EQUAL
.
          PACK      KEY19,NEWURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO
          CALL      RAPMALN1                    * read into ans;
          BRANCH    OVRCD,UPDALN                * new u/r not on file, go update
          CALL      DEPMALN1                    * delete new u/r no.
.
UPDALN    PACK      KEY19,OURNO,PMANACAT,PMANACOD,PMANLNNO * read old record
          CALL      RDPMALN1                          * full read
          MOVE      NEWURNO,PMANURNO                  * move new u/r to old u/r
          CALL      UPPMALN1                          * update record
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,RADALN
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,RADALN
.
          PACK      KEY5,PMANACAT,PMANACOD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UPDALN10
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN7               * wahealth medical alert
            GOTO      UPDALN20
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN8               * wahealth micro alert
            GOTO      UPDALN20
          ENDIF
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN9               * wahealth risk alert
            GOTO      UPDALN20
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSN11               * wahealth chronic alert
            GOTO      UPDALN20
          ENDIF
.
          MATCH     ANSS,TCINDC4
          IF        @EQUAL
            MOVE      TWO,PTMXSIN1
          ENDIF
.
UPDALN10  MATCH     "2",PTMXSIN1
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN1               * Set alert present flag  
          ENDIF
          CALL      UPMAST1
          GOTO      RADALN 
.
UPDALN20  CALL      UPPMPX21                * update for wahealth alerts (indc5)
          GOTO      RADALN 
.
AUDALN    BRANCH    CAUDA1,ENDALN                     * Using Audits
.
RSDALN    PACK      KEY27,OURNO,SP70
          CALL      ASPMALN2 
          CALL      AKPMALN2
          BRANCH    OVRCD,ENDALN
.         
          MATCH     OURNO,PMANURNO
          GOTO      ENDALN IF NOT EQUAL     
.         
          MOVE      NEWURNO,PMANURNO
          CALL      AUPMALN2
          GOTO      RSDALN
.
          INC       IBAOVRIO/INC
          INC       PMSALNIO/INC
.
ENDALN    CLOSE     PMSALNA1
          ENDPROC
+
.**************************************************************************
.*                               CHKALR00              Called by: PROC0000*
.*                                                                        *
.**************************************************************************
CHKALR00  MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKALR99
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PTMXSIN1,DIM1
          MOVE      PMPXSIN7,SAVESIN7
          MOVE      PMPXSIN8,SAVESIN8
          MOVE      PMPXSIN9,SAVESIN9
          MOVE      PMPXSN11,SAVESN11
          UNPACK    SP70,PTMXSIN1,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN11
.
          CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,NEWURNO,SP70
          CALL      RSPTALR1
CHKALR10  CALL      RKPTALR1
          BRANCH    OVRCD,CHKALR90
.
          MATCH     NEWURNO,PTALURNO
          GOTO      CHKALR90 IF NOT EQUAL
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MATCH     PTALEDAT,CURRDATE            * future end date
            GOTO      CHKALR20 IF LESS
.
            GOTO      CHKALR10                     * show alert as inactive
          ENDIF
.
CHKALR20  PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKALR10
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN7               * wahealth medical alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN8               * wahealth micro alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN9               * wahealth risk alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSN11               * wahealth chronic alert
            GOTO      CHKALR10
          ENDIF
.
.         Standard alert functionality
.
          REP       "S2 1",TCINDC4
.
          MATCH     "2",TCINDC4        * check for security alert, if yes stop
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
            GOTO      CHKALR90
          ENDIF
.
          MATCH     PTMXSIN1,TCINDC4
          IF        @LESS
            PACK      PTMXSIN1,TCINDC4
          ENDIF
          MATCH     SP70,PTMXSIN1
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
          ENDIF
.
          GOTO      CHKALR10
.
CHKALR90  MATCH     PTMXSIN1,DIM1
          IF        !@EQUAL
            CALL      UPMAST1
          ENDIF
.
          MATCH     PMPXSIN7,SAVESIN7
          IF        @EQUAL
            MATCH     PMPXSIN8,SAVESIN8
            IF        @EQUAL
              MATCH     PMPXSIN9,SAVESIN9
              IF        @EQUAL
                MATCH     PMPXSN11,SAVESN11
                IF        @EQUAL
                  GOTO      CHKALR99        * no wahealth indicators changed
                ENDIF   
              ENDIF   
            ENDIF
          ENDIF     
          CALL      UPPMPX21                * update for wahealth alerts (indc5)
.
CHKALR99  RETURN
+
.**********************************************************************
.*                            FIXLNK                                  *
.*                  Merge Linked UR Number File                       *
.**********************************************************************
.
          DEFPROC   FIXLNK
.
          INC       PATLINFD/INC
.
          OPEN      PATLINK1,"patlinkf"
.
FLINK000  PACK      KEY16,OURNO,SP10
          CALL      RDSLINK1
          CALL      RDKLINK1
          BRANCH    OVRCD,FLINK999
.
          MATCH     OURNO,LINKFUR
          GOTO      FLINK999 IF NOT EQUAL
.
          MOVE      LINKTUR,SAVEURNO
          PACK      KEY16,LINKFUR,LINKTUR
          CALL      DELINK1
.
          MOVE      NEWURNO,LINKFUR
.
          MATCH     LINKFUR,SAVEURNO
          GOTO      FLINK000 IF EQUAL
.
          PACK      KEY16,SAVEURNO,LINKFUR
          CALL      RDALINK1
          COMPARE   ZERO,OVRCD
          GOTO      FLINK000 IF EQUAL
.
          PACK      KEY16,LINKFUR,SAVEURNO
          CALL      RDALINK1
          COMPARE   ZERO,OVRCD
          GOTO      FLINK000 IF EQUAL
.
          PACK      KEY16,SAVEURNO,LINKFUR
          CALL      RDALINK1
          IF        OVRCD=0
            CALL      DELINK1
          ENDIF
.
          PACK      KEY16,LINKFUR,SAVEURNO
          CALL      WRLINK1
.
          GOTO      FLINK000
.
          INC       IBAOVRIO/INC
          INC       PATLINIO/INC
.
FLINK999  CLOSE     PATLINK1
          ENDPROC
+
.        ================================================
.        Procedure to fix up the Cancer Registration File
.        ================================================
.
          DEFPROC   FIXCRG    
.
          INC       PATCRGFD/INC
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATCRGA1,"patcrgaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXCRG999
          MOVE      PVIBILL,AADMNO
.
FXCRG000  PACK      KEY8,AADMNO          
          CALL      RDPTCRG1
          BRANCH    OVRCD,FXCRG999
.
          MOVE      NEWURNO,PTCRURNO
          CALL      UPPTCRG1
          GOTO      FXCRG999
.
          INC       IBAOVRIO/INC
          INC       PATCRGIO/INC

FXCRG999  CLOSE     PATCRGA1
          ENDPROC
.
.*********************************************************************
.                   UPDAXE
.         Subroutine to update the pataxeaf file with national number 
.         (Change U/R for an admission number option) 
.*********************************************************************
UPDAXE
          COMPARE   ONE,PTCNAXEU
          GOTO      UAXE99 IF NOT EQUAL
.
.         Update the old national number on pataxe 
.
          OPEN      PATNIDA1,"patnidaf"
          PACK      KEY10,CHOSINDX,PURNO,SP10
          CALL      RDPTNID1     
          BRANCH    OVRCD,UAXE99
.
          PACK      KEY8,PVIBILL,SP10
          CALL      RDPTAXE1
          BRANCH    OVRCD,UAXE99
.    
          IF        PTAXDAMI < 9
            MOVE      PTNINMPI,PTAXNRIC
            IF        PTAXDAMI =7 | PTAXDAMI =8
              MOVE      "21",PTAXAI1C
            ENDIF
            CALL      UPPTAXE1
          ENDIF
.
UAXE99    RETURN
.
.       ======================================
.       Subroutine to update the A + E details
.       ======================================
.
FIXDET    DISPLAY   *P1:24,*EL,"A + E : ",*V2LON,PVIBILL;
          OPEN      AAEDE1A1,"aaede1af"
.
DETLP     MOVE      PVIBILL,KEY8
          CALL      RLAEDEA1
          BRANCH    OVRCD OF CLSDET,DETLCK
.
          MOVE      NEWURNO,ADAURNO
          CALL      UPDETA1
          CALL      UUAEDEA1
.
CLSDET    CLOSE     AAEDE1A1
          RETURN
.
DETLCK    DISPLAY   *P1:24,*EL,"A + E ",*V2LON,PVIBILL,*HOFF," locked on Port ":
                    *V2LON,ADALOCK,*HOFF,".  ";
          CALL      HITENTER
          GOTO      DETLP
+
.       ======================================
.       Subroutine to update the EMR details
.       ======================================
.
FIXEMR    DISPLAY   *P1:24,*EL,"EMR   : ",*V2LON,PVIBILL;
          TRAP      OVERCOND IF IO
          OPEN      EMRVISA1,"emrvisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,EMRDET9
.
EMRLP     MOVE      PVIBILL,KEY8
          CALL      RLEMVIS1
          BRANCH    OVRCD,EMRDET9:               * record not found
                          EMRLCK                 * record locked
.
          MOVE      NEWURNO,EMVIURNO
          CALL      UPEMVIS1
          CALL      ULEMVIS1
.
EMRDET9   RETURN
.
EMRLCK    DISPLAY   *P1:24,*EL,"EMR   ",*V2LON,PVIBILL,*HOFF," visit locked.  ";
          CALL      HITENTER
          GOTO      EMRLP
+
.********************************************************************
. DELMRG00 : Delete or Merge?
.********************************************************************
          DEFPROC   DELMRG00
.
          INC       OUTCLIFD/INC
          INC       PATDO1FD/INC
          INC       PATALRFD/INC
.
CMDLINE   DIM       80
FORM3     FORM      3
+
.
.       Delete or Merge the old U/R details
.
DELMAS    IF        CMERGURS=1
            CALL      MERGUR00
          ELSE
            CALL      DELEUR00
          ENDIF
          GOTO      ENDMRG
.
.-------------------------------------------------
.       Merge the old U/R with the new U/R number
.-------------------------------------------------
MERGUR00
.
MRGURS    MOVE      OURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MRGEUR99       * Should never occur
.
          IF        PSTAT=4
            PACK      PPSNAME,NEWURNO,ANSR,SP20 * Tell them the new U/R number
          ELSE                                  * 9th char = R - EBS created U/R
            PACK      PPSNAME,NEWURNO,SP20 * Tell them the new U/R number
          ENDIF
.
          MOVE      ONE,PSTAT            * Label as associated
          CALL      UPMAST1              * Update & unlock old U/R
          CALL      UUPTMAS1
.
          MOVE      OURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,MRGEUR99       * Should never occur
.
          MOVE      NEWURNO,PTMRNWUR
          MOVE      OURNO,PTMROLUR
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1              * Read in the new U/R details
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21             * Read in the new U/R ext details
.
MRGEUR99  RETURN
+
.-------------------------------------------------
.       Delete the old details
.-------------------------------------------------
DELEUR00  MOVE      OURNO,KEY8
          CALL      DEMAST1      *** delete old no matter what
.
          MOVE      OURNO,KEY8
          CALL      DEPMPX21     *** delete old extn file two
.
          MOVE      NEWURNO,PTMRNWUR
          MOVE      OURNO,PTMROLUR
.
DELEUR99  RETURN
+
          INC       IBAOVRIO/INC
.
ENDMRG    ENDPROC
++
.
.********************************************************************
. VISITS00 : Check through the visit file for any other changes that
.            need to be done depending on visit type
.********************************************************************
VISITS00  OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA1,"patvisaf"
VISITS03  MOVE      OURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP30
          CALL      RDSVISA2
VISITS05  CALL      RDKVISA2
          BRANCH    OVRCD,VISITS99
.
          MATCH     OURNO,PVIURNO
          GOTO      VISITS99 IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,"Admission : ",*V2LON,PVIBILL;
.
.       Check the system for this visit
.
.         PROC      FIXRUS                  * do RUS for all visits
          PROC      CCIVIS00                * do CCI for all visits
          BRANCH    PVITYPE,AAEVIS,OUTVIS,INPVIS,OUTVIS,DAYVIS,CMHVIS:
                            VISITS06,VISITS06,ALLVIS
.
VISITS06  CALL      FIXVIS               * call this to stop possible loop
          GOTO      VISITS03
.
.         A+E Visit
.
AAEVIS    CALL      FIXAAE
          GOTO      VISITS03
.
.         Outpatient Visit - all outpatients were done earlier
.
OUTVIS    CALL      FIXVIS
          MOVE      ONE,FORM1                * using pat files in fixinv
          PROC      FIXINV
          GOTO      VISITS03
.
.         Inpatient Visit
.
INPVIS    CALL      FIXINP
          GOTO      VISITS03
.
.         Day Visit
.
DAYVIS    CALL      FIXVIS
          GOTO      VISITS03
.
.         Community Health Visit
.
CMHVIS    PROC      MRGURCMH
          CALL      FIXVIS   
          GOTO      VISITS03
.
.         Allied Health Visit
.
ALLVIS    CALL      FIXVIS
          MOVE      ONE,FORM1                * using pat files in fixinv
          PROC      FIXINV
.
          MATCH     " 2",PVISYST            * A/Health Referrals 
          GOTO      VISITS03 IF NOT EQUAL
.
          CALL      FIXALL
          CALL      FIXCDL
.
          GOTO      VISITS03
.
VISITS99  RETURN
+
.******************************************** Start of addition        *I-60976
.*********************************************************************
. FIXINTR - fix the Interpreter Visit Details file
.*********************************************************************
          DEFPROC   FIXINTR
.
          INC       BOKRC1FD/INC
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       VISINTFD/INC
.
DIM3      DIM       3
TODAYDAT  DIM       8
.
FXINT100  PACK      KEY8,NEWURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,FXINT999
          MATCH     "1",PMPXINTR            * is "Interpreter Required"?
          GOTO      FXINT999 IF NOT EQUAL
.
          OPEN      VISINTA2,"visintaf"
          PACK      TODAYDAT,CCC,CYY,CMM,CDD
          REP       " 0",TODAYDAT
.                                           * Open booking file if it exists
FXINT200  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      BOKRC1A6,"bokrc1af"
          TRAPCLR   IO
          BRANCH    OVRCD,FXINT300
.
          PACK      KEY16,NEWURNO,SP70
          CALL      RSBKREC6
FXINT210  CALL      RKBKREC6                * read booking file
          BRANCH    OVRCD,FXINT300
.
          MATCH     BKREURNO,NEWURNO
          GOTO      FXINT300 IF NOT EQUAL
.
          MATCH     TODAYDAT,BKREEDAT
          GOTO      FXINT210 IF LESS
.
          PACK      KEY24,BKREEDAT,BKREATIM,DBKREBOO
          CALL      RDVSINT2
          COMPARE   ZERO,OVRCD
          GOTO      FXINT210 IF EQUAL
.
.                                           * write a "visintaf" record
          CALL      CLVISINT
          MOVE      BKREBOOK,VSINVISN
          MOVE      BKREEDAT,VSINDATE
          MOVE      BKREATIM,VSINTIME
          MOVE      "3",VSINTYPE
          MOVE      SP70,VSINSUBK
          MOVE      USERID,VSINWUID
          PACK      KEY24,BKREEDAT,BKREATIM,DBKREBOO
          CALL      WRVSINT2
          GOTO      FXINT210
.
.                                           * Open outpat. site file if exists
FXINT300  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTSITA1,"outsitaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXINT500
.
.         Loop over all sites to get all possible outpatient file names
.
          MOVE      SP6,KEY6
          CALL      RDSSITA1
FXINT310  CALL      RDKSITA1
          BRANCH    OVRCD,FXINT500
.                                           Open Outpatient files if they exist
          MOVE      ZERO,OVRCD                * Initialise test flag
          TRAP      OVERCOND IF IO            * Trap IO errors
          PACK      CFNAME,OSTFILE,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
          TRAPCLR   IO                        * Clear IO trap
          BRANCH    OVRCD,FXINT310            * Ignore site if IO error.
.
FXINT400  PACK      KEY36,NEWURNO,SP30
          CALL      RDSBOKA3
FXINT410  CALL      RDKBOKA3
          BRANCH    OVRCD OF FXINT500
.
          MATCH     OBAURNO,NEWURNO
          GOTO      FXINT500 IF NOT EQUAL
.
          MATCH     TODAYDAT,OBADATE
          GOTO      FXINT410 IF LESS
.
          MOVE      ":00",DIM3
          PACK      KEY24,OBADATE,OBATIME,DIM3,DOBAOUTN
          CALL      RDVSINT2
          COMPARE   ZERO,OVRCD
          GOTO      FXINT410 IF EQUAL
.
.                                           * write a "visintaf" record
          CALL      CLVISINT
          MOVE      OBAOUTNO,VSINVISN
          MOVE      OBADATE,VSINDATE
          PACK      VSINTIME,OBATIME,DIM3
          MOVE      "2",VSINTYPE
          PACK      VSINSUBK,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      USERID,VSINWUID
          PACK      KEY24,OBADATE,OBATIME,DIM3,DOBAOUTN
          CALL      WRVSINT2
          GOTO      FXINT410
.
.                                           * Open Inpatient Visit file
FXINT500  OPEN      PATVISA2,"patvisaf"
          PACK      KEY24,NEWURNO,SP30
          CALL      RDSVISA2
FXINT510  CALL      RDKVISA2
          BRANCH    OVRCD,FXINT900
.
          MATCH     PVIURNO,NEWURNO
          GOTO      FXINT900 IF NOT EQUAL
.
          MATCH     TODAYDAT,PVIDATE
          GOTO      FXINT510 IF LESS
.
          COMPARE   THREE,PVITYPE
          GOTO      FXINT510 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,FXINT510
.
          BRANCH    ASTAT,FXINT520,FXINT520
          GOTO      FXINT510
.
FXINT520  PACK      KEY24,ADATE,ATIME,AADMNO
          CALL      RDVSINT2
          COMPARE   ZERO,OVRCD
          GOTO      FXINT510 IF EQUAL
.
.                                           * write a "visintaf" record
          CALL      CLVISINT
          MOVE      DAADMNO,VSINVISN
          MOVE      ADATE,VSINDATE
          MOVE      ATIME,VSINTIME
          MOVE      "3",VSINTYPE
          MOVE      SP70,VSINSUBK
          MOVE      USERID,VSINWUID
.
          PACK      KEY24,ADATE,ATIME,AADMNO
          CALL      WRVSINT2
          GOTO      FXINT510
.
.                                           * close files
FXINT900  CLOSE     BOKRC1A6
          CLOSE     VISINTA2
          CLOSE     OUTSITA1
          CLOSE     OUTBOKA3
....      CLOSE     PATVISA2
          GOTO      FXINT999
.
.                   *********************
.
          INC       CLVISINT
.
          INC       IBAOVRIO/INC
          INC       BOKRC1IO/INC
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       VISINTIO/INC
.
FXINT999  ENDPROC
.********************************************   End of addition        *I-60976
.
.
.       =========================
.       Procedure  to fix the RUS
.       =========================
.
.         DEFPROC   FIXRUS    
.
.         INC       RUSUTLFD/INC
.
.SAVKEY34  DIM       34
.SAVQNTY   FORM      8 
.
.         Open rus if the exist
.
.          MOVE      ZERO,OVRCD
.          DISPLAY   *P64:24,"rusutlaf"
.          TRAP      OVERCOND IF IO
.          OPEN      RUSUTLL1,"rusutlaf"
.          TRAPCLR   IO
.          BRANCH    OVRCD,ENDRUS
.          CLOSE     RUSUTLL1
..
.          DISPLAY   *P1:24,*EL,"Fixing RUS";
.          MOVE      OURNO,PVIURNO
..
.       Update the RUS files
.
.          CALL      FIXRUTL
.          GOTO      ENDRUS 
..
.        ================================================
.        Subroutine to fix up the RUS patient detail file
.        ================================================
.
.FIXRUTL   OPEN      RUSUTLL1,"rusutlaf"
.          OPEN      RUSUTLL3,"rusutlaf"
.          PACK      KEY34,PVIBILL,SP30
.          CALL      RSRSUTL3
.RUSRUTL   CALL      RKRSUTL3
.          BRANCH    OVRCD,ENDRUTL
..
.          MATCH     RSUTEVNT,PVIBILL
.          GOTO      ENDRUTL IF NOT EQUAL
..
.          MOVE      RSUTQUNT,SAVQNTY
.          PACK      SAVKEY34,RSUTDATE,RSUTDEPT,RSUTEVNT,RSUTPROC,RSUTURNO
.          PACK      KEY34,RSUTDATE,RSUTDEPT,RSUTEVNT,RSUTPROC,NEWURNO
.          CALL      RDRSUTL1
.          IF        OVRCD = 1
.
.           Change U/R number on old record
.
.            MOVE      SAVKEY34,KEY34
.            CALL      RDRSUTL1
.            BRANCH    OVRCD,RUSRUTL
.            MOVE      NEWURNO,RSUTURNO
.            CALL      UPRSUTL1
.          ELSE
.
.           Add quantites for the two records
.
.            ADD       SAVQNTY,RSUTQUNT
.            CALL      UPRSUTL1
.            MATCH     SAVKEY34,KEY34
.            IF        !@EQUAL
.              MOVE      SAVKEY34,KEY34
.              CALL      DERSUTL1
.            ENDIF
.          ENDIF
.          PACK      KEY34,RSUTEVNT,RSUTDATE,RSUTDEPT,RSUTEVNT,OURNO,RSUTPROC
.          CALL      RSRSUTL3
.
.          GOTO      RUSRUTL
.
.ENDRUTL   CLOSE     RUSUTLL1
.          CLOSE     RUSUTLL3
.          RETURN
+
.          INC       IBAOVRIO/INC
.          INC       RUSUTLIO/INC
.
.ENDRUS    ENDPROC
++
.
.********************************************************************** 
. ENDCHGUR - We have finished changing the U/R number.
. Returns:   EXIT - 0 = Ok to continue
.                   1 = Error occurred
.********************************************************************** 
ENDCHGUR  MATCH     "PATWEB83",PRGID
          IF        !@EQUAL
            DISPLAY   *P1:24,*EL,*V2LON,"U/R number successfully changed. ";
            CALL      HITENTER
          ENDIF
.
          MOVE      NEWURNO,KEY8
          CALL      UUPTMAS1                * Release the new U/R
          IF        CMERGURS = 1 & EXISTFL = 0
            MOVE      OURNO,KEY8
            CALL      UUPTMAS1
          ENDIF
.
.         Re-read the new U/R record before broadcasting any messages
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      OURNO,OLDURNO
          MOVE      ONE,HL7TRGID
          MOVE      "WEBCHGUR",HL7INCLD
          PROC      DGCLICMR                * send merge details to DG *c-90202
.
.         Write to the U/R Number Change Audit file if the system parameter is
.         set
.
.....     CALL      URNC0000    * moved for CAR 227087
.
          MOVE      ZERO,EXIT
          GOTO      ENDCHG99
.
ENDCHG91  MOVE      ONE,EXIT
.
ENDCHG99  RETURN
.
.*****************************************************************************
.*                            URNC0000                                       *
.*  Write to the U/R Number Change Audit file if the system parameter is set *
.*****************************************************************************
URNC0000  OPEN      PATURCA1,"paturcaf";
.
          CALL      IBACLOCK
          PACK      PTURDATE,CCC,CYY,CMM,CDD * Load Date of alteration
          REP       " 0",PTURDATE            * Zero fill
          MOVE      CTIMEIS,PTURTIME         * load time of alteration
          REP       " 0",PTURTIME            * Zero fill
.
          PACK      KEY24,PVIBILL,PTURDATE,PTURTIME
          CALL      RDURCA1
          IF        OVRCD = 1
            MOVE      PVIBILL,PTURADMN         * Admission number affected
            MOVE      OURNO,PTUROURN           * Old U/R number
            MOVE      SP20,PTURSPAR
            CALL      WRURCA1
          ELSE
            MOVE      OURNO,PTUROURN           * Old U/R number
            CALL      UPURCA1
          ENDIF
.
          CLOSE     PATURCA1
.
URNC9999  RETURN
+
.====================================================================== 
. PROC PATCOM00 : Change U/R for PATCOMFD
.====================================================================== 
          DEFPROC   PATCOM00
.
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
.
SAVKEY17  DIM       17
SAVKEY20  DIM       20
MAXNOTEN  FORM      6
COMTFLAG  FORM      1
OLDURNO   DIM       8
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSUCHA1,"pmsuchaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATCOM99           * file not found
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSUCDA1,"pmsucdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATCOM99           * file not found
.
          DISPLAY   *P1:24,"Updating : ",*V2LON,"pmsuchaf",*EL;
.
          MOVE      OURNO,OLDURNO
          CALL      PATCOM10
          GOTO      PATCOM99  
.          
          INC       PATCOM10
          INC       IBAOVRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
.
PATCOM99  ENDPROC
+
.====================================================================== 
. PROC RUSERR00 : Change U/R for RUSERRFD
.====================================================================== 
.          DEFPROC   RUSERR00
.
.          INC       RUSERRFD/INC
.
.SAVKEY23  DIM       23
.
.          MOVE      ZERO,OVRCD
.          TRAP      OVERCOND IF IO
.          OPEN      RUSERRA1,"ruserraf"
.          TRAPCLR   IO
.          BRANCH    OVRCD,RUSERR99           * file not found
.
.          DISPLAY   *P1:24,"Updating : ",*V2LON,"ruserraf",*EL;
..
.          PACK      KEY23,SP20,SP10
.RUSERR15  CALL      RSRSERR1
.RUSERR20  CALL      RKRSERR1
.          BRANCH    OVRCD,RUSERR90
.          MATCH     OURNO,RSERURNO
.          GOTO      RUSERR20 IF NOT EQUAL    * no index on U/R so loop over
.                                              all records
..
.          PACK      SAVKEY23,RSERDATE,RSERDEPT,RSERURNO,RSERPTYP
.          MOVE      NEWURNO,RSERURNO
.          CALL      UPRSERR1
.          MOVE      SAVKEY23,KEY23
.          GOTO      RUSERR15
..
.RUSERR90  CLOSE     RUSERRA1
.          GOTO      RUSERR99
.
.          INC       IBAOVRIO/INC
.          INC       RUSERRIO/INC
.
.RUSERR99  ENDPROC
+
.*********************************************************************
.         procedure to update the W/L details for a single procedure
.         Para's  : KEY38         the OLD and NEW details
.                   BKREBOOK      the booking number     
.*********************************************************************
          DEFPROC   UPWTSGL
.
          INC       ALLWLNFD/INC
          INC       WATCATFD/INC
          INC       WATLHIFD/INC
          INC       WATMESFD/INC
          INC       WATPNPFD/INC
          INC       WATSUSFD/INC
.
          INC       WATHISFD/INC
          INC       WATMHDFD/INC
          INC       WATMTXFD/INC
          INC       WATCHAFD/INC
          INC       WATPACFD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
.
OLD       DIM       19        * old ur and count
NEW       DIM       19        * new ur and count
.
.*********************************************************************
.         maintain the W/L files
.*********************************************************************
WLSGL000  UNPACK    KEY38,OLD,NEW           * the OLD count and NEW count
.
. fix watpnpaf
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPNPA1,"watpnpaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL100
.
          MOVE      BKREBOOK,KEY8
          CALL      RDWTPNP1
          IF        OVRCD = ZERO
            UNPACK    NEW,WTNPURNO,WTNPCODE,KEY2
            MOVE      KEY2,WTNPCNT
            CALL      UPWTPNP1
          ENDIF
.
. fix watlhiaf
.
WLSGL100  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATLHIA1,"watlhiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL200
.
WLSGL120  PACK      KEY30,OLD,SP30
          CALL      RSWTLHI1
          CALL      RKWTLHI1
          BRANCH    OVRCD,WLSGL200
          PACK      KEY19,WTLHURNO,WTLHCODE,WTLHCONT
          MATCH     OLD,KEY19
          GOTO      WLSGL200 IF NOT EQUAL
.
          UNPACK    NEW,WTLHURNO,WTLHCODE,KEY2
          MOVE      KEY2,WTLHCONT
          CALL      UPWTLHI1
          GOTO      WLSGL120
.
. fix watcataf
.
WLSGL200  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATCATA2,"watcataf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL300
.
WLSGL220  PACK      KEY29,OLD,SP30
          CALL      RSWTCAT2
          CALL      RKWTCAT2
          BRANCH    OVRCD,WLSGL300
          PACK      KEY19,WTCAURNO,WTCAPROC,WTCAPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL300 IF NOT EQUAL
.
          UNPACK    NEW,WTCAURNO,WTCAPROC,KEY2
          MOVE      KEY2,WTCAPCNT
          CALL      UPWTCAT2
          GOTO      WLSGL220
.
. fix watmesaf
.
WLSGL300  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMESA1,"watmesaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL400
.
WLSGL320  PACK      KEY21,OLD,SP30
          CALL      RDSMESA1
          CALL      RDKMESA1
          BRANCH    OVRCD,WLSGL400
          PACK      KEY19,WAURNO,WAPROC,WACNT
          MATCH     OLD,KEY19
          GOTO      WLSGL400 IF NOT EQUAL
.
          UNPACK    NEW,WAURNO,WAPROC,KEY2
          MOVE      KEY2,WACNT
          CALL      UPMESA1
          GOTO      WLSGL320
.
. fix watsusaf
.
WLSGL400  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATSUSA1,"watsusaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL500
.
WLSGL420  PACK      KEY21,OLD,SP30
          CALL      RSWTSUS1
          CALL      RKWTSUS1
          BRANCH    OVRCD,WLSGL500
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT 
          MATCH     OLD,KEY19
          GOTO      WLSGL500 IF NOT EQUAL
.
          UNPACK    NEW,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT 
          CALL      UPWTSUS1
          GOTO      WLSGL420
.
. fix watpacaf
.
WLSGL500  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPACA1,"watpacaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL600
.
WLSGL520  PACK      KEY21,OLD,SP30
          CALL      RSWTPAC1
          CALL      RKWTPAC1
          BRANCH    OVRCD,WLSGL600
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL600 IF NOT EQUAL
.
          UNPACK    NEW,WTPCURNO,WTPCPCOD,KEY2
          MOVE      KEY2,WTPCPCNT
          CALL      UPWTPAC1
          GOTO      WLSGL520
.
. fix wathisaf
.
WLSGL600  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATHISA1,"wathisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL700
.
WLSGL620  PACK      KEY31,OLD,SP30
          CALL      RSWTHIS1
          CALL      RKWTHIS1
          BRANCH    OVRCD,WLSGL700
          PACK      KEY19,WTHIURNO,WTHIPROC,DWTHIPCN
          MATCH     OLD,KEY19
          GOTO      WLSGL700 IF NOT EQUAL
.
          UNPACK    NEW,WTHIURNO,WTHIPROC,KEY2
          MOVE      KEY2,WTHIPCNT
          CALL      UPWTHIS1
          GOTO      WLSGL620
.
. fix watmhdaf
.
WLSGL700  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMHDA1,"watmhdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL800
.
WLSGL720  PACK      KEY28,OLD,SP30
          CALL      RSWTMHD1
          CALL      RKWTMHD1
          BRANCH    OVRCD,WLSGL800
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL800 IF NOT EQUAL
.
          UNPACK    NEW,WTMHURNO,WTMHPROC,KEY2
          MOVE      KEY2,WTMHPCNT
          CALL      UPWTMHD1
          GOTO      WLSGL720
.
. fix watmtxaf
.
WLSGL800  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMTXA1,"watmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL900
.
WLSGL820  PACK      KEY31,OLD,SP30
          CALL      RSWTMTX1
          CALL      RKWTMTX1
          BRANCH    OVRCD,WLSGL900
          PACK      KEY19,WTMTURNO,WTMTPROC,WTMTPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL900 IF NOT EQUAL
.
          UNPACK    NEW,WTMTURNO,WTMTPROC,KEY2
          MOVE      KEY2,WTMTPCNT
          CALL      UPWTMTX1
          GOTO      WLSGL820
.
. fix watchaaf
.
WLSGL900  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATCHAA1,"watchaaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL910
.
WLSGL905  PACK      KEY35,OLD,SP30
          CALL      RSWTCHA1
          CALL      RKWTCHA1
          BRANCH    OVRCD,WLSGL910
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL910 IF NOT EQUAL
.
          UNPACK    NEW,WTCHURNO,WTCHPROC,KEY2
          MOVE      KEY2,WTCHPCNT
          CALL      UPWTCHA1
          GOTO      WLSGL905
.
WLSGL910  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATOPAA1,"watopaaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL920
.
WLSGL915  PACK      KEY27,OLD,SP30
          CALL      RSWTOPA1
          CALL      RKWTOPA1
          BRANCH    OVRCD,WLSGL920
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN
          MATCH     OLD,KEY19
          GOTO      WLSGL920 IF NOT EQUAL
.
          UNPACK    NEW,WTOPURNO,WTOPCODE,KEY2
          MOVE      KEY2,WTOPCOUN
          CALL      UPWTOPA1
          MATCH     "1",WTOPSTAT
          IF        !@EQUAL
            MOVE      WTOPOUTN,WLOTPACN
          ENDIF
          GOTO      WLSGL915
.
WLSGL920  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATOPSA1,"watopsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL930
.
WLSGL925  PACK      KEY27,OLD,SP30
          CALL      RSWTOPS1
          CALL      RKWTOPS1
          BRANCH    OVRCD,WLSGL930
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN
          MATCH     OLD,KEY19
          GOTO      WLSGL930 IF NOT EQUAL
.
          UNPACK    NEW,WTOSURNO,WTOSCODE,KEY2
          MOVE      KEY2,WTOSCOUN
          CALL      UPWTOPS1
          MATCH     "1",WTOPSTAT
          IF        !@EQUAL
            MOVE      WTOSOUTN,WLOTANAE
          ENDIF
          GOTO      WLSGL925
.
WLSGL930  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLWLNA1,"allwlnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL940
.
          PACK      KEY19,OLD,SP70
          CALL      RDALWLN1
          BRANCH    OVRCD,WLSGL999
.
          UNPACK    NEW,ALWLURNO,ALWLPCOD,ALWLPCNT
          CALL      UPALWLN1
.
WLSGL940
          GOTO      WLSGL999
.
          INC       ALLWLNIO/INC
          INC       IBAOVRIO/INC
          INC       WATCATIO/INC
          INC       WATMESIO/INC
          INC       WATLHIIO/INC
          INC       WATPNPIO/INC
          INC       WATSUSIO/INC
          INC       WATHISIO/INC
          INC       WATMHDIO/INC
          INC       WATMTXIO/INC
          INC       WATCHAIO/INC
          INC       WATPACIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
.
WLSGL999  ENDPROC
.
+
          INC       MRGURPRI                * Change U/R for Private Practice
.         INC       MRGURCCS                * Clinical Costing Interface
          INC       MRGURCCI                * Clinical Costing Interface
          INC       MRGURCMH                * Community Health
          INC       MRGURWEB                * WEB
          INC       MRGUREOC                * EOC & ACC
+
.------------------------------------------------------------------------
.------------------------------------------------------------------------
. OLD CODE WHICH ISNT CALLED ANYMORE
.------------------------------------------------------------------------
.------------------------------------------------------------------------
.
.*********************************************************************
.                   FIXNAT
.         Subroutine to fix up the national master patient index file
.*********************************************************************
FIXNAT    OPEN      PATNIDA1,"patnidaf"
          DISPLAY   *P1:24,*EL,"NMPI : ",*V2LON,PURNO;
.
.         Delete or Merge the old U/R details
.
          BRANCH    CMERGURS,FXNAT1
.
.         Delete the old U/R details
.
          PACK      KEY10,CHOSINDX,OURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,ENDNAT
          MOVE      PURNO,PTNINMPI
          CALL      UPPTNID1
          GOTO      ENDNAT
.
.         Merge the old U/R details
.
FXNAT1    CALL      MERGB000                * merge for patnidaf
.
ENDNAT    CLOSE     PATNIDA1
          RETURN
+
.*********************************************************************
.                   MERGB000
.         merge the U/R's for patnidaf
.*********************************************************************
MERGB000  MOVE      SP20,SAVNMPI
          PACK      KEY10,CHOSINDX,OURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,MERGB200
.
          MOVE      PTNINMPI,SAVNMPI
          GOTO      MERGB300
.
MERGB200  PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,MERGB999
.
          CALL      DEPTNID1
          MOVE      NEWURNO,PURNO             * move saved new u/r number
          GOTO      MERGB999
.
MERGB300  PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,MERGB400
.
          MOVE      SAVNMPI,PTNINMPI          * nmpi number
          CALL      UPPTNID1
          MOVE      OURNO,PURNO               * move old u/r number to new
          GOTO      MERGB200
.
MERGB400  MOVE      SAVNMPI,PTNINMPI          * nmpi number
          MOVE      NEWURNO,PTNILNUM          * new u/r number
          MOVE      CHOSINDX,PTNIHNUM         * hospital number
          CALL      WRPTNID1
          MOVE      OURNO,PURNO               * move old u/r number to new
          GOTO      MERGB200
.
MERGB999  RETURN
+
.*******************************************************************************
.         Create a medical record
.*******************************************************************************
CRMED000  READ      CONTROLF,NINTY7;*152,MRCNACRR
          COMPARE   ONE,MRCNACRR
          GOTO      CRMED999 IF NOT EQUAL
.
          OPEN      MRTMASA1,"mrtmasaf"
          MOVE      PURNO,MRMAURNO
          IF        IBCNMHOS=1
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,CRMED999
.
            MOVE      PTHSHLOC,MRMAHLOC            * Home Location
            MOVE      PTHSHLOC,MRMACLOC            * Current Location
            MOVE      PTHSRCTY,MRMADOTY            * Document Type
            MOVE      PTHSSTAT,MRMASTAT            * Status
            SQUEEZE   PTHSVOLM
            MOVE      PTHSVOLM,MRMAVOLN
          ELSE
            READ      CONTROLF,SIXTY;*84,MRCNHLOC
            READ      CONTROLF,SIXTY;*88,MRCNRCTY
            READ      CONTROLF,SIXTY;*91,MRCNVOLM
            READ      CONTROLF,SIXTY;*108,MRCNSTAT
            MOVE      MRCNHLOC,MRMAHLOC            * Home Location
            MOVE      MRCNHLOC,MRMACLOC            * Current Location
            MOVE      MRCNRCTY,MRMADOTY            * Document Type 
            MOVE      MRCNSTAT,MRMASTAT            * Status
            SQUEEZE   MRCNVOLM
            MOVE      MRCNVOLM,MRMAVOLN
          ENDIF
.
          MATCH     SP70,MRMAHLOC
          GOTO      CRMED999 IF EQUAL
.
          MATCH     SP70,MRMADOTY
          GOTO      CRMED999 IF EQUAL
.
          READ      CONTROLF,SIXTY;*95,MRCNUKEY
          ADD       ONE,MRCNUKEY
          WRITAB    CONTROLF,SIXTY;*95,MRCNUKEY
          SUB       ONE,MRCNUKEY
          MOVE      MRCNUKEY,MRMAKEY
          MOVE      SP70,MRMACOMM
.
          CALL      IBACLOCK
          PACK      MRMADTCR,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTCR
          MOVE      CTIMEIS,MRMATMCR
          MOVE      WBSEUID,MRMACUID
          MOVE      SP70,MRMADTUP
          MOVE      SP70,MRMATMUP
          MOVE      SP70,MRMAUUID
.
          PACK      KEY17,MRMAURNO,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
          CALL      RAMRMAS1
          IF        OVRCD=1
            CALL      WRTMAS1
          ENDIF
.
CRMED999  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the A/Health referral file
.       =================================================================
.
FIXALL    MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLREFA1,"allrefaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDALL
.
          MATCH     "1",ALCNRAUD            
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RLALREF1
          BRANCH    OVRCD,CLSALL
.
.       Write the new U/R number to the referral
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          CALL      ARMHI000                * Set MHINC indicator
          MOVE      NEWURNO,ALREURNO
          CALL      UPALREF1
          CALL      UUALREF1
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
CLSALL    CLOSE     ALLREFA1
.
ENDALL    RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Event file
.       =================================================================
.
.         Update current patient record file with new UR
.
FIXEVT    OPEN      PMSCURA1,"pmscuraf"
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ENDEVT
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ENDEVT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMCUR1
          BRANCH    OVRCD,FIXEVT1
.
          MOVE      NEWURNO,PMCUURNO
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          CALL      UPPMCUR1
.
.         Update patient visit file with new UR
.
FIXEVT1   OPEN      PATVISA1,"patvisaf"
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,FIXEVT2
.
          MOVE      NEWURNO,PVIURNO
          CALL      UPVISA1
.
.         Update patient location details file with new UR
.
FIXEVT2   OPEN      PATLOCA1,"patlocaf"
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,ADMISSNO,SP70,SP70
          CALL      RDLOCA1
          BRANCH    OVRCD,FIXEVT3
.
          MOVE      NEWURNO,LURNO
          MOVE      PTMASNAM,LSNAME
          MOVE      PMPXFNAM,LGNAME
          MOVE      PMPXSNAM,PTLCGNM2
          CALL      UPLOCA1
.
FIXEVT3   MOVE      ADMISSNO,PVIBILL
          MOVE      ONE,FORM1         * using pat files in fixinv
          PROC      FIXINV            * Invoice file
.
ENDEVT  RETURN
+
.******************************************************************************
.         MHINC - MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the A/Health Clinical Document
.       Links file
.       =================================================================
.
FIXCDL    MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLLINA1,"alllinaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDCDL
.
          PACK      KEY11,PVIBILL,SP70
          CALL      RSALLIN1
NXTCDL    CALL      RKALLIN1
          BRANCH    OVRCD,CLSCDL
.
          MATCH     DPVIBILL,ALLIVISN
          GOTO      CLSCDL IF NOT EQUAL
.
.       Write the new U/R number to the referral
.
          MOVE      NEWURNO,ALLIURNO
          CALL      UPALLIN1
          GOTO      NXTCDL
.
CLSCDL    CLOSE     ALLLINA1
.
ENDCDL    RETURN
+
.**********************************************************************
.*                            RMHV0000                                *
.*            Update Mental Health Visit File for referral            *
.**********************************************************************
RMHV0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHVI1A1,"mehvi1af"
          TRAPCLR   IO
          BRANCH    OVRCD,RMHV9999

          MOVE      ADMISSNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,RMHV9999
.
          DISPLAY   *P30:24,*EL,"Mental Health: ",*V2LON,ADMISSNO;
          MOVE      NEWURNO,MHVIURNO
          CALL      UPMHVIS1
.
RMHV9999  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the A/Health Loan Details File
.       =================================================================
.
FIXLON    MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLLONA1,"alllonaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLON
.
NXTLON    PACK      KEY16,OURNO,SP70
          CALL      RSALLON1                    * check old U/R for loans
          CALL      RKALLON1
          BRANCH    OVRCD,CLSLON
.
          MATCH     OURNO,ALLOURNO              * correct U/R
          GOTO      CLSLON IF NOT EQUAL
.
          PACK      SAVKEY16,ALLOURNO,ALLOLOAN,SP70   * save original loan key
          MOVE      ONE,FORM8                 
          MOVE      ALLOLOAN,FORM8              * save loan number
.
RDDLON    PACK      KEY16,NEWURNO,FORM8,SP70
          CALL      RAALLON1                    * read into ans;
          BRANCH    OVRCD,UPDLON                * new u/r not on file, go update
.
          ADD       ONE,FORM8                   * Add one to loan number
          GOTO      RDDLON
.
UPDLON    PACK      KEY16,SAVKEY16,SP70
          CALL      RDALLON1                    * full read of original
          BRANCH    OVRCD,CLSLON                * record
.
          MOVE      NEWURNO,ALLOURNO            * update u/r   
          MOVE      FORM8,ALLOLOAN              * updale loan number
.
          CALL      UPALLON1                    * update record
.
          CALL      FLCM0000                    * Move loan comments
.
          GOTO      NXTLON
.
CLSLON    CLOSE     ALLLONA1
.
ENDLON    RETURN
+
.       =================================================================
.       Change U/R number in the A/H Equipment Loan Comments File
.       Required SAVKEY16 = Old U/R and Old Loan Number
.       =================================================================
.
FLCM0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLEDTA1,"alledtaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FLCM9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLETXA1,"alletxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FLCM9999
.
FLCM1000  PACK      KEY25,SAVKEY16,SP70          * check for notes on the
          CALL      RSALEDT1                     * original loan number
          CALL      RKALEDT1
          BRANCH    OVRCD,FLCM9000
.
          PACK      DIM16,ALEDURNO,ALEDLOAN,SP70
          MATCH     DIM16,SAVKEY16               * are comment from the original
          GOTO      FLCM9000 IF NOT EQUAL        * loan number
.
          PACK      SAVKEY25,ALEDURNO,ALEDLOAN,ALEDTYPE,ALEDNOTE,SP70
.
          PACK      KEY25,ALLOURNO,ALLOLOAN,ALEDTYPE,ALEDNOTE,SP70
          CALL      RAALEDT1                     * does new record exits
          COMPARE   ONE,OVRCD
          GOTO      FLCM9000 IF NOT EQUAL
.
          PACK      KEY25,SAVKEY25,SP70
          CALL      RDALEDT1                     * re Read original record
          BRANCH    OVRCD,FLCM9000
.
          MOVE      ALLOURNO,ALEDURNO            * update U/R
          MOVE      ALLOLOAN,ALEDLOAN            * update loan number
.
          CALL      UPALEDT1
.
FLCM5000  PACK      KEY28,SAVKEY16,ALEDTYPE,SP70 * check for notes lines on the
          CALL      RSALETX1                     * original loan number and
          CALL      RKALETX1                     * note type
          BRANCH    OVRCD,FLCM1000
.
          PACK      DIM16,ALETURNO,ALETLOAN,SP70
          MATCH     DIM16,SAVKEY16               * are comment from the original
          GOTO      FLCM1000 IF NOT EQUAL        * loan number
.
          MATCH     ALEDTYPE,ALETTYPE            * correct note type
          GOTO      FLCM1000 IF NOT EQUAL
.
          MATCH     ALEDNOTE,ALETNOTE            * correct note number
          GOTO      FLCM1000 IF NOT EQUAL
.
          PACK      SAVKEY28,ALETURNO,ALETLOAN:
                             ALETTYPE,ALETNOTE,ALETUNIQ,SP70
.
          PACK      KEY28,ALEDURNO,ALEDLOAN:
                          ALETTYPE,ALETNOTE,ALETUNIQ,SP70
          CALL      RAALETX1                     * does new record exits
          COMPARE   ONE,OVRCD
          GOTO      FLCM1000 IF NOT EQUAL
.
          PACK      KEY28,SAVKEY28,SP70
          CALL      RDALETX1                     * re Read original record
          BRANCH    OVRCD,FLCM1000
.
          MOVE      ALEDURNO,ALETURNO            * update U/R
          MOVE      ALEDLOAN,ALETLOAN            * update loan number
.
          CALL      UPALETX1
.
          GOTO      FLCM5000
.
FLCM9000  CLOSE     ALLEDTA1
          CLOSE     ALLETXA1
.
FLCM9999  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the A/Health Patient Care
.       Team File
.       =================================================================
.
FIXPCT    MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ALLPCTA1,"allpctaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDPCT
.
NXTPCT    PACK      KEY26,OURNO,SP70
          CALL      RSALPCT1
          CALL      RKALPCT1
          BRANCH    OVRCD,CLSPCT
.
          MATCH     OURNO,ALPCURNO
          GOTO      CLSPCT IF NOT EQUAL
.
          PACK      KEY26,NEWURNO,ALPCTYPE,ALPCCODE,ALPCSITE,SP70
          CALL      RAALPCT1                    * read into ans;
          BRANCH    OVRCD,UPDPCT                * new u/r not on file, go update
          CALL      DEALPCT1                    * delete new u/r no.
.
UPDPCT    PACK      KEY26,OURNO,ALPCTYPE,ALPCCODE,ALPCSITE,SP70
          CALL      RDALPCT1                          * full read
          BRANCH    OVRCD,NXTPCT
.
          MOVE      NEWURNO,ALPCURNO                  * move new u/r to old u/r
          CALL      UPALPCT1                          * update record
          GOTO      NXTPCT
.       
CLSPCT    CLOSE     ALLPCTA1
.
ENDPCT    RETURN    
+
.       =================================================================
.       Subroutine to change U/R number in the Alternate Legacy File
.       =================================================================
.
FIXALLEG  MOVE      ZERO,OVRCD
          MOVE      ZERO,F1 
          TRAP      OVERCOND IF IO
          OPEN      LEGALTA1,"legaltaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDALLEG
.
NXTALLEG  PACK      KEY32,OURNO,SP70
          CALL      RSLGALT1
          CALL      RKLGALT1
          BRANCH    OVRCD,CLSALLEG
.
          MATCH     OURNO,LGATURNO
          GOTO      CLSALLEG IF NOT EQUAL
          MOVE      ONE,F1
.
          PACK      KEY32,NEWURNO,LGATADAT,LGATATIM,LGATEVNO,SP70
          CALL      RALGALT1
          BRANCH    OVRCD,UPDALLEG
.
          CALL      DELGALT1
.
UPDALLEG  PACK      KEY32,OURNO,LGATADAT,LGATATIM,LGATEVNO,SP70
          CALL      RDLGALT1
          BRANCH    OVRCD,NXTALLEG
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LGATURNO
          CALL      UPLGALT1
          GOTO      NXTALLEG
.
CLSALLEG  CLOSE     LEGALTA1
.
.         Make sure that the legacy visit flag (patmx1af.ptmxsin5) is set
.         for the new U/R
.
          IF        F1=0
            GOTO     ENDALLEG
          ENDIF
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ENDLGVIS
.
          MATCH     "1",PTMXSIN5
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN5
            CALL      UPMAST1
          ENDIF
.
.
ENDALLEG  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Visit File
.       =================================================================
.
FIXLGVIS  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGVISA2,"legvisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGVIS
.
.         Initialise legacy visit record flag for no records found for U/R
.
          MOVE      ONE,LEGCFLAG
.
NXTLGVIS  PACK      KEY24,OURNO,SP70
          CALL      RSLGVIS2
          CALL      RKLGVIS2
          BRANCH    OVRCD,CLSLGVIS
.
          MATCH     OURNO,LVIURNO
          GOTO      CLSLGVIS IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LVIURNO
          CALL      UPLGVIS2
          MOVE      ZERO,LEGCFLAG                * legacy visit records found
          GOTO      NXTLGVIS
.
CLSLGVIS  CLOSE     LEGVISA2
.
          BRANCH    LEGCFLAG,ENDLGVIS            * no legacy visit records
.
.         Fix all the other related legacy tables
.
          MOVE      OURNO,FORMURNO               * save U/R as FORM field
          CALL      FIXLGBOA                     * Change U/R for legbokaf
          CALL      FIXLGDEA                     * Change U/R for legdetaf
          CALL      FIXLGDSC                     * Change U/R for legdschf
          CALL      FIXLGINV                     * Change U/R for leginvrf
          CALL      FIXLGMIS                     * Change U/R for legmissf
          CALL      FIXLGTRN                     * Change U/R for legtranf
.
.         Make sure that the legacy visit flag (patmx1af.ptmxsin5) is set
.         for the new U/R
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ENDLGVIS
.
          MATCH     "1",PTMXSIN5
          IF        !@EQUAL
            MOVE      ONE,PTMXSIN5
            CALL      UPMAST1
          ENDIF
.
ENDLGVIS  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Prosthetic Tracking Detail File
.       =================================================================
.
FIXPMPTD  MATCH     "1",PTCNTRPR                 * using tracking prosthetics?
          GOTO      ENDPMPTD IF NOT EQUAL        * no
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPTDA3,"pmsptdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDPMPTD
.
NXTPMPTD  PACK      KEY38,OURNO,SP70
          CALL      RSPMPTD3
          CALL      RKPMPTD3
          BRANCH    OVRCD,CLSPMPTD
.
          MATCH     OURNO,PMPEURNO
          GOTO      CLSPMPTD IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,PMPEURNO
          CALL      UPPMPTD3
          GOTO      NXTPMPTD
.
CLSPMPTD  CLOSE     PMSPTDA3
.
ENDPMPTD  RETURN
+
.=================================================================
. change U/R number in the eAdmission Pending Header Table
.=================================================================
.
PMSEHB00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSEHBA3,"pmsehbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PMSEHB99
.
PMSEHB20  PACK      KEY37,OURNO,SP70
          CALL      RSPMEHB3
          CALL      RKPMEHB3
          BRANCH    OVRCD,PMSEHB99
.
          MATCH     OURNO,PMHBURNO
          GOTO      PMSEHB99 IF NOT EQUAL
.
. Update the record with the new U/R number
.
          MOVE      NEWURNO,PMHBURNO
          CALL      UPPMEHB3
          GOTO      PMSEHB20
.
PMSEHB90  CLOSE     PMSEHBA3
.
PMSEHB99  RETURN
+
.=================================================================
. change U/R number in the eReferral Pending Header Table
. for non W/L related eReferrals
.=================================================================
.
          DEFPROC   COMERH
.
          INC       COMERHFD/INC
.
SAVKEY38  DIM       38
.
          MATCH     "1",PTCNEPIS            * Using Episoft interface
          GOTO      COMERH90 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMERHA3,"comerhaf"
          TRAPCLR   IO
          BRANCH    OVRCD,COMERH90
.
          PACK      KEY38,OURNO,SP70
          CALL      RSCMERH3
COMERH20  CALL      RKCMERH3
          BRANCH    OVRCD,COMERH90
.
          MATCH     OURNO,CMRHURNO
          GOTO      COMERH90 IF NOT EQUAL
.
          MATCH     SP70,CMRHPCOD           * Skip W/L eReferrals
          GOTO      COMERH20 IF NOT EQUAL
.
          MATCH     SP70,CMRHPCNT           * Skip W/L eReferrals:
          GOTO      COMERH20 IF NOT EQUAL
.
. Update the record with the new U/R number
.
          PACK      SAVKEY38,CMRHURNO,CMRHEDAT,CMRHSTAT,CMRHUNIQ,SP70
          MOVE      NEWURNO,CMRHURNO
          CALL      UPCMERH3
.
          MOVE      SAVKEY38,KEY38
          CALL      RSCMERH3
          GOTO      COMERH20
.
COMERH90  CLOSE     COMERHA3
          GOTO      ENDERH
.
          INC       IBAOVRIO/INC
          INC       COMERHIO/INC
.
ENDERH    ENDPROC
+
.       =================================================================
.       Subroutine to change U/R number in the dispataf and disptlaf Files
.       =================================================================
          DEFPROC   FIXDIS00
.
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
.
FIXDIS05  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DISPATA1,"dispataf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXDIS99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DISPTLA1,"disptlaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXDIS99
.
FIXDIS10  PACK      KEY17,OURNO,SP70
          CALL      RSDSPAT1
          CALL      RKDSPAT1
          BRANCH    OVRCD,FIXDIS50
.
          MATCH     OURNO,DSPTURNO
          GOTO      FIXDIS50 IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,DSPTURNO
          PACK      KEY17,DSPTURNO,DSPTCODE,SP70
          CALL      RADSPAT1
          IF        OVRCD<>1
            PACK      KEY17,OURNO,DSPTCODE,SP70
            CALL      DEDSPAT1
          ELSE
            PACK      KEY17,OURNO,DSPTCODE,SP70
            CALL      RDDSPAT1
            MOVE      NEWURNO,DSPTURNO
            CALL      UPDSPAT1
          ENDIF
          GOTO      FIXDIS10
.
FIXDIS50  PACK      KEY25,OURNO,SP70
          CALL      RSDSPTL1
          CALL      RKDSPTL1
          BRANCH    OVRCD,FIXDIS99
.
          MATCH     OURNO,DSPLURNO
          GOTO      FIXDIS99 IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,DSPLURNO
          PACK      KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL      RADSPTL1
          IF        OVRCD<>1
            PACK      KEY25,OURNO,DSPLCODE,DSPLVISN,SP70
            CALL      DEDSPTL1
          ELSE
            PACK      KEY25,OURNO,DSPLCODE,DSPLVISN,SP70
            CALL      RDDSPTL1
            MOVE      NEWURNO,DSPLURNO
            CALL      UPDSPTL1
          ENDIF
          GOTO      FIXDIS50
.
FIXDIS99  GOTO      ENDFIXDS
.
          INC       IBAOVRIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
.
ENDFIXDS  ENDPROC
+
.       =================================================================
.       Subroutine to change U/R number in the dispataf and disptlaf Files
.       ***** for one visit only *******
.       =================================================================
          DEFPROC   FXDSPT00
.
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
.
FXDSPT05  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DISPATA1,"dispataf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXDSPT99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DISPTLA1,"disptlaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXDSPT99
.
          PACK      KEY25,OURNO,SP70
          CALL      RSDSPTL1
FXDSPT10  CALL      RKDSPTL1
          BRANCH    OVRCD,FXDSPT99
.
          MATCH     OURNO,DSPLURNO
          GOTO      FXDSPT99 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      FXDSPT10 IF NOT EQUAL
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,DSPLURNO
          PACK      KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL      RADSPTL1
          IF        OVRCD<>1
            PACK      KEY25,OURNO,DSPLCODE,DSPLVISN,SP70
            CALL      DEDSPTL1
          ELSE
            PACK      KEY25,OURNO,DSPLCODE,DSPLVISN,SP70
            CALL      RDDSPTL1
            MOVE      NEWURNO,DSPLURNO
            CALL      UPDSPTL1
          ENDIF
          PACK      KEY9,DSPLCODE,SP70
.
FXDSPT50  PACK      KEY17,OURNO,SP70
          CALL      RSDSPAT1
FXDSPT60  CALL      RKDSPAT1
          BRANCH    OVRCD,FXDSPT99
.
          MATCH     OURNO,DSPTURNO
          GOTO      FXDSPT99 IF NOT EQUAL
.
          MATCH     KEY9,DSPTCODE
          GOTO      FXDSPT60 IF NOT EQUAL
.
.         Write the new U/R number to the dispataf record
.
          MOVE      NEWURNO,DSPTURNO
          PACK      KEY17,DSPTURNO,DSPTCODE,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            CALL      WRDSPAT1
          ENDIF
.
. if no records now exist for this UR on disptlaf, delete the old dispataf
          PACK      KEY25,OURNO,KEY9,SP70
          CALL      RSDSPTL1
          CALL      RKDSPTL1
          BRANCH    OVRCD,FXDSPT70
.
          MATCH     OURNO,DSPLURNO
          GOTO      FXDSPT70 IF NOT EQUAL
.
          MATCH     KEY9,DSPLCODE
          GOTO      FXDSPT99 IF EQUAL
.
FXDSPT70  PACK      KEY17,OURNO,KEY9,SP70
          CALL      DEDSPAT1
.
          GOTO      FXDSPT99
.
FXDSPT99  GOTO      ENDFXDSP
.
          INC       IBAOVRIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
.
ENDFXDSP  ENDPROC
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy O/P Booking A File
.       =================================================================
.
FIXLGBOA  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGBOKA3,"legbokaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGBOA
.
NXTLGBOA  PACK      KEY36,OURNO,SP70
          CALL      RSLGBOA3
          CALL      RKLGBOA3
          BRANCH    OVRCD,CLSLGBOA
.
          COMPARE   FORMURNO,LOBAURNO
          GOTO      CLSLGBOA IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LOBAURNO
          CALL      UPLGBOA3
          GOTO      NXTLGBOA
.
CLSLGBOA  CLOSE     LEGBOKA3
.
ENDLGBOA  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy A&E Detail File
.       =================================================================
.
FIXLGDEA  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGDETA2,"legdetaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGDEA
.
NXTLGDEA  PACK      KEY16,OURNO,SP70
          CALL      RSLGDEA2
          CALL      RKLGDEA2
          BRANCH    OVRCD,CLSLGDEA
.
          COMPARE   FORMURNO,LADAURNO
          GOTO      CLSLGDEA IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LADAURNO
          CALL      UPLGDEA2
          GOTO      NXTLGDEA
.
CLSLGDEA  CLOSE     LEGDETA2
.
ENDLGDEA  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Discharge File
.       =================================================================
.
FIXLGDSC  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGDSCH3,"legdschf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGDSC
.
NXTLGDSC  PACK      KEY16,OURNO,SP70
          CALL      RSLGDSC3
          CALL      RKLGDSC3
          BRANCH    OVRCD,CLSLGDSC
.
          COMPARE   FORMURNO,LDURNO
          GOTO      CLSLGDSC IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LDURNO
          CALL      UPLGDSC3
          GOTO      NXTLGDSC
.
CLSLGDSC  CLOSE     LEGDSCH3
.
ENDLGDSC  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Invoice File
.       =================================================================
.
FIXLGINV  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGINVR5,"leginvrf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGINV
.
NXTLGINV  PACK      KEY32,OURNO,SP70
          CALL      RSLGINV5
          CALL      RKLGINV5
          BRANCH    OVRCD,CLSLGINV
.
          COMPARE   FORMURNO,LPINVUR
          GOTO      CLSLGINV IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LPINVUR
          CALL      UPLGINV5
          GOTO      NXTLGINV
.
CLSLGINV  CLOSE     LEGINVR5
.
ENDLGINV  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Admission File
.       =================================================================
.
FIXLGMIS  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGMISS6,"legmissf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGMIS
.
NXTLGMIS  PACK      KEY16,OURNO,SP70
          CALL      RSLGMIS6
          CALL      RKLGMIS6
          BRANCH    OVRCD,CLSLGMIS
.
          MATCH     OURNO,LAURNO
          GOTO      CLSLGMIS IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LAURNO
          CALL      UPLGMIS6
          GOTO      NXTLGMIS
.
CLSLGMIS  CLOSE     LEGMISS6
.
ENDLGMIS  RETURN
+
.       =================================================================
.       Subroutine to change U/R number in the Legacy Transfer File
.       =================================================================
.
FIXLGTRN  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGTRAN5,"legtranf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLGTRN
.
NXTLGTRN  PACK      KEY38,OURNO,SP70
          CALL      RSLGTRN5
          CALL      RKLGTRN5
          BRANCH    OVRCD,CLSLGTRN
.
          COMPARE   FORMURNO,LTURNO
          GOTO      CLSLGTRN IF NOT EQUAL
.
.         Write the new U/R number to the record
.
          MOVE      NEWURNO,LTURNO
          CALL      UPLGTRN5
          GOTO      NXTLGTRN
.
CLSLGTRN  CLOSE     LEGTRAN5
.
ENDLGTRN  RETURN
+
.        =============================================================
.        Procedure to change UR number in Patient Future Actions file.
.        =============================================================
.
          DEFPROC   FIXPFA
.
          INC       PATFACFD/INC
.
          OPEN      PATFACT3,"patfactf"
.
RADPFA    PACK      KEY27 WITH OURNO,SP70
          CALL      RDSFACT3
          CALL      RDKFACT3
          BRANCH    OVRCD OF ENDPFA
.
          MATCH     OURNO,PTFCURNO
          GOTO      ENDPFA IF NOT EQUAL
.
          PACK      KEY27,NEWURNO,FADATE,DFADMNO,FACODE,SP70
          CALL      RDAFACT3                    * read into ans;
          BRANCH    OVRCD,UPDPFA                * new u/r not on file, go update
          CALL      DEFACT3                     * delete new u/r no.
.
UPDPFA    PACK      KEY27,OURNO,FADATE,DFADMNO,FACODE,SP70   * read old record
          CALL      RDFACT3                           * full read
          MOVE      NEWURNO,PTFCURNO                  * move new u/r to old u/r
          CALL      UPFACT3                           * update record
.
          GOTO      RADPFA
.
          INC       IBAOVRIO/INC
          INC       PATFACIO/INC
.
ENDPFA    CLOSE     PATFACT3
          ENDPROC
.        =========================================
.        Procedure to fix up the alternate ID file
.        =========================================
.
          DEFPROC   FIXAID
.
          INC       PMSAIDFD/INC
.
          READ      CONTROLF,HUND25;*155,PTCNEPMI     * Using External PMI ?
.
          OPEN      PMSAIDA1,"pmsaidaf"
.
RADAID    PACK      KEY31,OURNO,SP10
          CALL      RSPMAID1
RKDAID    CALL      RKPMAID1
          BRANCH    OVRCD,ENDAID
.
          MATCH     OURNO,PMAIURNO
          GOTO      ENDAID IF NOT EQUAL
.
.         If UPI don't copy this record to newurno - update merge date/time/user
.
          MATCH     "1",PTCNEPMI
          GOTO      CHKAID IF NOT EQUAL        * not using extrnal PMI
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKAID
.
          MATCH     "U",TCINDC4
          GOTO      CHKAID IF NOT EQUAL
.
          PACK      KEY31,OURNO,PMAITYPE,PMAIALID     * read old upi record
          CALL      RDPMAID1                          * full read
          BRANCH    OVRCD,CHKAID
.
          MOVE      USERID,PMAIUSMR                   * User Who Merged Record
          CALL      IBACLOCK
          PACK      PMAIDTMR,CCC,CYY,CMM,CDD          * Date Record Merged
          REP       " 0",PMAIDTMR
          MOVE      CTIMEIS,PMAITMMR                  * Time Record Merged
          CALL      UPPMAID1                          * update old upi record
.
          GOTO      RKDAID                            * keep old upi record
.
CHKAID    PACK      KEY31,NEWURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1                    * read into ans;
          BRANCH    OVRCD,UPDAID                * new u/r not on file, go update
          CALL      DEPMAID1                    * delete new u/r no.
.
UPDAID    PACK      KEY31,OURNO,PMAITYPE,PMAIALID     * read old record
          CALL      RDPMAID1                          * full read
          MOVE      NEWURNO,PMAIURNO                  * move new u/r to old u/r
          MOVE      USERID,PMAIUPUD
          CALL      IBACLOCK
          PACK      PMAIUPDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIUPDT
          MOVE      CTIMEIS,PMAIUPTM
          CALL      UPPMAID1                          * update record
.
          GOTO      RADAID
.
          INC       IBAOVRIO/INC
          INC       PMSAIDIO/INC
.
ENDAID    CLOSE     PMSAIDA1
          ENDPROC
.
.        ============================================
.        Procedure to fix up the concession card file
.        ============================================
.
          DEFPROC   FIXCCD
.
          INC       PMSCCDFD/INC
.
OLDCDATE  DIM       8
OLDCTYPE  DIM       3
.
          OPEN      PMSCCDA1,"pmsccdaf"
.
RADCCD    PACK      KEY19,OURNO,SP70
          CALL      RSPMCCD1
          CALL      RKPMCCD1
          BRANCH    OVRCD,ENDCCD
.
          MATCH     OURNO,PMCDURNO
          GOTO      ENDCCD IF NOT EQUAL
.
          MOVE      PMCDEXDT,OLDCDATE           * save old u/r card expiry date
          MOVE      PMCDCTYP,OLDCTYPE           * save old u/r card type
.
          PACK      KEY19,NEWURNO,SP70
          CALL      RSPMCCD1
NEWCCD    CALL      RKPMCCD1
          BRANCH    OVRCD,OLDCCD                * new u/r not on file, upd. old
.
          MATCH     NEWURNO,PMCDURNO
          GOTO      OLDCCD IF NOT EQUAL         * new u/r not on file, upd. old
.
          MATCH     OLDCTYPE,PMCDCTYP
          GOTO      NEWCCD IF NOT EQUAL         * not same card type
.
.         new u/r is on file, so keep record with latest card expiry date
.
          MATCH     OLDCDATE,PMCDEXDT
          IF        !@LESS
            PACK      KEY19,OURNO,OLDCDATE,OLDCTYPE
            CALL      DEPMCCD1                        * delete old u/r record
            GOTO      RADCCD
          ENDIF
.
          PACK      KEY19,NEWURNO,PMCDEXDT,PMCDCTYP
          CALL      DEPMCCD1                          * delete new u/r record
.
OLDCCD    PACK      KEY19,OURNO,OLDCDATE,OLDCTYPE     * read old record
          CALL      RDPMCCD1                          * full read
          MOVE      NEWURNO,PMCDURNO                  * move new u/r to old u/r
          CALL      UPPMCCD1                          * update record
.  write nsw edw record for concession card added
          PACK      PMEWURNO,PMCDURNO,SP70
          MOVE      "18 ",PMEWTYPE
          PACK      PMEWNEWV,PMCDURNO,PMCDCTYP,PMCDCNUM,PMCDEXDT,SP70
          CALL      EREDW000
.
          GOTO      RADCCD
.
          INC       IBAOVRIO/INC
          INC       PMSCCDIO/INC
.
ENDCCD    CLOSE     PMSCCDA1
          ENDPROC
.
.        ==================================================
.        Procedure to fix up the concession card audit file
.        ==================================================
.
          DEFPROC   FIXCCAUD
.
          INC       PATCCHFD/INC
.
HOURTM    DIM       2
MINTIME   DIM       2
SECTIME   DIM       2
SAVEKY35  DIM       35
ZERO2     INIT      "00"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATCCHA1,"patcchaf"
          TRAPCLR   IO
          IF        OVRCD=1
            GOTO      ENDCCAUD
          ENDIF
.
RADCCAUD  PACK      KEY35,OURNO,SP70
          CALL      RSPTCCH1
          CALL      RKPTCCH1
          BRANCH    OVRCD,ENDCCA99
.
          MATCH     OURNO,PTCCURNO
          GOTO      ENDCCA99 IF NOT EQUAL
.
          PACK      SAVEKY35,OURNO,PTCCEXDT,PTCCCTYP,PTCCDATE,PTCCTIME,SP70
.
RADCCAU1  PACK      KEY35,NEWURNO,PTCCEXDT,PTCCCTYP,PTCCDATE,PTCCTIME,SP70
          CALL      RAPTCCH1                   * read into ans;
          COMPARE   ONE,OVRCD     
          GOTO      RADCCAU2 IF NOT EQUAL
.
          PACK      KEY35,SAVEKY35             * read old record
          CALL      RAPTCCH1                   * full read
.
          MOVE      NEWURNO,PTCCURNO           * move new u/r to old u/r
          PACK      KEY35,PTCCURNO,PTCCEXDT,PTCCCTYP,PTCCDATE,PTCCTIME,SP70
          CALL      UPPTCCH1
          GOTO      RADCCAUD
.
.      Add one second to the Date when Concession Card was Added/Updated/Delted
.
RADCCAU2  UNPACK    PTCCDATE,DIM8
          UNPACK    PTCCTIME,HOURTM,DIM1,MINTIME,DIM1,SECTIME
          MATCH     "59",SECTIME
          IF        !@EQUAL
            MOVE      SECTIME,FORM2              * just increment seconds
            ADD       ONE,FORM2
            MOVE      FORM2,SECTIME
            REP       " 0",SECTIME
            PACK      PTCCTIME,HOURTM,DIM1,MINTIME,DIM1,SECTIME
            GOTO      RADCCAU1
          ENDIF
.
.         The seconds were "59", so reset these to "00" and increment the
.         minutes
.
          MOVE      "00",SECTIME
          MATCH     "59",MINTIME
          IF        !@EQUAL
            MOVE      MINTIME,FORM2              * just increment minutes
            ADD       ONE,FORM2
            MOVE      FORM2,MINTIME
            REP       " 0",MINTIME
            PACK      PTCCTIME,HOURTM,DIM1,MINTIME,DIM1,SECTIME
            GOTO      RADCCAU1
          ENDIF
.
.         The minutes were "59", so reset these to "00" and increment the
.         hours
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MATCH     "23",HOURTM
          IF        !@EQUAL
            MOVE      HOURTM,FORM2              * just increment hours
            ADD       ONE,FORM2
            MOVE      FORM2,HOURTM
            REP       " 0",HOURTM
            PACK      PTCCTIME,HOURTM,DIM1,MINTIME,DIM1,SECTIME
            GOTO      RADCCAU1
          ENDIF
.
.         The hours were "59", so reset these to "00" and increment the
.         date
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MOVE      "00",HOURTM
.
.         We need to increment the date by 1 day
.
          UNPACK    PTCCDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON                       * get julian day
          ADD       ONE,JULDAY                   * increment julian day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                       * get new date
          PACK      PTCCDATE,CC,YY,MM,DD
          PACK      PTCCTIME,ZERO2,DIM1,ZERO2,DIM1,ZERO2
          REP       " 0",PTCCDATE
          REP       " 0",PTCCTIME
          GOTO      RADCCAU1
.
          INC       IBAOVRIO/INC
          INC       PATCCHIO/INC
.
ENDCCA99  CLOSE     PATCCHA1
ENDCCAUD  ENDPROC
.
.
.        =============================================================
.        Procedure to change UR number in extra contacts.
.        =============================================================
.
          DEFPROC   FIXCONT
.
SAVKEY14  DIM       14
SAVKEY33  DIM       33
F3A       FORM      3
.
          INC       PMSCEXFD/INC
          INC       PMSCEXTD/INC
.
          OPEN      PMSCEXA1,"pmscexaf"
          READ      CONTROLF,HUND18;*167,PTCNNWCA
.
          MATCH     "1",PTCNNWCA
          IF        @EQUAL
            OPEN      PMSAUDC2,"pmsaudce"
          ENDIF
.
RACONT    PACK      KEY14,OURNO,SP70
          CALL      RSPMCEX1
          CALL      RKPMCEX1
          BRANCH    OVRCD,NXDCONT
.
          MATCH     OURNO,PMCEURNO
          GOTO      NXDCONT IF NOT EQUAL
.
          PACK      SAVKEY14,PMCEURNO,PMCETYPE,PMCECNTR,SP70
.
          MOVE      PMCECNTR,PMCEX003           * Save counter
          PACK      KEY14,NEWURNO,PMCETYPE,PMCECNTR,SP70
          CALL      RAPMCEX1                    * read into ans;
          BRANCH    OVRCD,UPDCONT               * new u/r not on file, go update
.
          MOVE      NEWURNO,PMCEX001
          MOVE      PMCETYPE,PMCEX002
          CALL      CONC0000                      * Calculate contact counter
.
UPDCONT   PACK      KEY14,SAVKEY14,SP70               * read old record
          CALL      RDPMCEX1                          * full read
          BRANCH    OVRCD,RACONT
.
          MOVE      NEWURNO,PMCEURNO                  * move new u/r to old u/r
          MOVE      PMCEX003,PMCECNTR                 * new contact type count
          CALL      UPPMCEX1                          * update record
.
          MATCH     "1",PTCNNWCA                      * Using contact audit
          GOTO      RACONT IF NOT EQUAL
.
. Update contact audit with the new U/R and contact count 
.
FXACONT   PACK      KEY33,SAVKEY14,SP20
          CALL      ASPMCEX2
          CALL      AKPMCEX2
          BRANCH    OVRCD,RACONT  
.
          PACK      KEY14,PMCEURNO,PMCETYPE,PMCECNTR,SP70
.
          MATCH     SAVKEY14,KEY14
          GOTO      RACONT IF NOT EQUAL
.
          MOVE      NEWURNO,PMCEURNO                  * move new u/r to old u/r
          MOVE      PMCEX003,PMCECNTR                 * new contact type count
. 
          CALL      AUPMCEX2                          * update audit
          GOTO      FXACONT
.
. Update contact audit for deleted contacts with the new U/R and contact count 
.
NXDCONT   MATCH     "1",PTCNNWCA                      * Using contact audit
          GOTO      ENDCONT IF NOT EQUAL
.
RKDCONT   PACK      KEY33,OURNO,SP20
          CALL      ASPMCEX2
          CALL      AKPMCEX2
          BRANCH    OVRCD,ENDCONT
.
          MATCH     OURNO,PMCEURNO
          GOTO      ENDCONT IF NOT EQUAL
.
          PACK      SAVKEY33,PMCEURNO,PMCETYPE,PMCECNTR,PMCEAUDD:
                          PMCEAUDT,PMCEAUDP,PMCEAUDR,SP70
.
          MOVE      NEWURNO,PMCEX001
          MOVE      PMCETYPE,PMCEX002
          CALL      CONC0000                      * Calculate contact counter
.
          MOVE      SAVKEY33,KEY33                    * re read audit record
          CALL      ADPMCEX2
.
          MOVE      NEWURNO,PMCEURNO                  * move new u/r to old u/r
          MOVE      PMCEX003,PMCECNTR                 * new contact type count
.
          CALL      AUPMCEX2                          * update audit
          GOTO      RKDCONT
.
          INC       IBAOVRIO/INC
          INC       PMSCEXIO/INC
          INC       PMSCEXTM
.
ENDCONT   CLOSE     PMSCEXA1
          ENDPROC
.
.        =============================================================
.        Procedure to change UR number in expected payors.
.        =============================================================
.
          DEFPROC   FIXEPAY
.
NEWSEQN   FORM      2
SAVKEY14  DIM       14
.
          INC       PMSPAYFD/INC
.
          OPEN      PMSPAYA1,"pmspayaf"
          OPEN      PMSPAYA2,"pmspayaf"
.
RAEPAY    PACK      KEY10,OURNO,SP70
          CALL      RSPMPAY2
          CALL      RKPMPAY2
          BRANCH    OVRCD,ENDEPAY
.
          MATCH     OURNO,PMPAURNO
          GOTO      ENDEPAY IF NOT EQUAL
.
          PACK      SAVKEY14,OURNO,PMPAPAYC,SP70   * save key to old record
          PACK      KEY14,NEWURNO,PMPAPAYC,SP70
          CALL      RAPMPAY1                    * read into ans;
          BRANCH    OVRCD,UPDEPAY               * new u/r not on file, go update
.
          PACK      KEY14,OURNO,PMPAPAYC,SP70
          CALL      RDPMPAY1                    * read into ans;
          BRANCH    OVRCD,RAEPAY                * Delete old u/r as new u/r has 
.                                               * record for this payor
          CALL      DEPMPAY1                    * delete old u/r no.
.
          GOTO      RAEPAY
.
UPDEPAY   MOVE      ONE,NEWSEQN
          PACK      KEY10,NEWURNO,Z70
          CALL      RSPMPAY2
          CALL      RPPMPAY2
          BRANCH    OVRCD,SAVEPAY
.
          MATCH     NEWURNO,PMPAURNO
          GOTO      SAVEPAY IF NOT EQUAL
.
          MOVE      PMPASEQN,NEWSEQN
          ADD       ONE,NEWSEQN                       * Generate next seq
.
SAVEPAY   MOVE      SAVKEY14,KEY14 
          CALL      RDPMPAY1                          * full read
          BRANCH    OVRCD,RAEPAY 
.
          MOVE      NEWURNO,PMPAURNO                  * move new u/r to old u/r
          MOVE      NEWSEQN,PMPASEQN                  * move new seq to old seq
          CALL      UPPMPAY1                          * update record
.
          GOTO      RAEPAY
.
          INC       IBAOVRIO/INC
          INC       PMSPAYIO/INC
.
ENDEPAY   CLOSE     PMSPAYA1
          ENDPROC
.**********************************************************************
.*             Fix patwc1af                                           *
.**********************************************************************
          DEFPROC   FIXWC1
.
          INC       PATWC1FD/INC
.
FIXC0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATWC1A2,"patwc1af"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDWC1
.
          MOVE      "patwc1af",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXC1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY16,PVIURNO,SP30
          CALL      RDSWCOM2
          CALL      RDKWCOM2
          BRANCH    OVRCD,FIXC9000
.
          MATCH     PVIURNO,PTWCURNO
          GOTO      FIXC9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTWCURNO
          CALL      UPWCOM2
          GOTO      FIXC1000
.
FIXC9000  CLOSE     PATWC1A2
          GOTO      ENDWC1
.
          INC       IBAOVRIO/INC
          INC       PATWC1IO/INC
.
ENDWC1    ENDPROC
+
.**********************************************************************
.*             Fix patwmabf                                           *
.**********************************************************************
          DEFPROC   FIXWMA
.
          INC       PATWMAFD/INC
.
FIXM0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATWMAB2,"patwmabf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDWMA
.
          MOVE      "patwmabf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXM1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY16,PVIURNO,SP30
          CALL      RDSWMAB2
          CALL      RDKWMAB2
          BRANCH    OVRCD,FIXM9000
.
          MATCH     PVIURNO,PTWMURNO
          GOTO      FIXM9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PTWMURNO
          CALL      UPWMAB2
          GOTO      FIXM1000
.
FIXM9000  CLOSE     PATWMAB2
          GOTO      ENDWMA
.
          INC       IBAOVRIO/INC
          INC       PATWMAIO/INC
.
ENDWMA    ENDPROC
+
.**********************************************************************
.*             Fix pmsextaf                                           *
.**********************************************************************
          DEFPROC   FIXEXT
.
          INC       PMSEXTFD/INC
.
FIXE0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSEXTA2,"pmsextaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDEXT
.
          MOVE      "pmsextaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXE1000  MOVE      OLDURNO,PVIURNO
          PACK      KEY19,PVIURNO,SP30
          CALL      RSPMEXT2
          CALL      RKPMEXT2
          BRANCH    OVRCD,FIXE9000
.
          MATCH     PVIURNO,PMEXURNO
          GOTO      FIXE9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMEXURNO
.
          PACK      PMEXUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEXUDAT
          CLOCK     TIME,PMEXUTIM
          MOVE      USERID,PMEXUUID
.
          CALL      UPPMEXT2
          GOTO      FIXE1000
.
FIXE9000  CLOSE     PMSEXTA2
          GOTO      ENDEXT
.
          INC       IBAOVRIO/INC
          INC       PMSEXTIO/INC
.
ENDEXT    ENDPROC
.
.        =============================================================
.        Procedure to change UR number in cdm file.
.        =============================================================
.
          DEFPROC   FIXCDM
.
          INC       PMSCDMFD/INC
.
          OPEN      PMSCDMA1,"pmscdmaf"
.
RACDM     PACK      KEY8,OURNO,SP70
          CALL      RSPMCDM1
          CALL      RKPMCDM1
          BRANCH    OVRCD,ENDCDM  
.
          MATCH     OURNO,PMDMURNO
          GOTO      ENDCDM IF NOT EQUAL
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RAPMCDM1                    * read into ans;
          BRANCH    OVRCD,UPDCDM                * new u/r not on file, go update
          CALL      DEPMCDM1                    * delete new u/r no.
.
UPDCDM    PACK      KEY11,OURNO,SP70            * read old record
          CALL      RDPMCDM1                          * full read
          MOVE      NEWURNO,PMDMURNO                  * move new u/r to old u/r
          CALL      UPPMCDM1                          * update record
.
          GOTO      RACDM   
.
          INC       IBAOVRIO/INC
          INC       PMSCDMIO/INC
.
ENDCDM    CLOSE     PMSCDMA1
          ENDPROC
.
.        =============================================================
.        Procedure to change UR number in cdm visit level file.
.        =============================================================
.
          DEFPROC   FIXCDME
.
          INC       PMSCDNFD/INC
.
          OPEN      PMSCDNA2,"pmscdnaf"
.
RACDME    PACK      KEY16,OURNO,SP70
          CALL      RSPMCDN2
          CALL      RKPMCDN2
          BRANCH    OVRCD,ENDCDME
.
          MATCH     OURNO,PMDNURNO
          GOTO      ENDCDME IF NOT EQUAL
.
          PACK      KEY16,NEWURNO,PMDNVISN,SP70
          CALL      RAPMCDN2                    * read into ans;
          BRANCH    OVRCD,UPDCDME               * new u/r not on file, go update
          CALL      DEPMCDN2                    * delete new u/r no.
.
UPDCDME   PACK      KEY16,OURNO,PMDNVISN,SP70         * read old record
          CALL      RDPMCDN2                          * full read
          MOVE      NEWURNO,PMDNURNO                  * move new u/r to old u/r
          CALL      UPPMCDN2                          * update record
.
          GOTO      RACDME
.
          INC       IBAOVRIO/INC
          INC       PMSCDNIO/INC
.
ENDCDME   CLOSE     PMSCDNA2
          ENDPROC
+
.        =============================================================
.        Procedure to change UR number in mental health files
.        =============================================================
.        
          DEFPROC   FIXMEH
.         
          INC       MEHDLSFD/INC
          INC       MEHHLSFD/INC
          INC       MEHMDTFD/INC
          INC       MEHMTXFD/INC
          INC       MEHPRDFD/INC
          INC       MEHPATFD/INC
          INC       MEHPCNFD/INC
          INC       MEHPCOFD/INC
          INC       MEHSCRFD/INC
          INC       MEHPCSFD/INC
          INC       MEHPOIFD/INC
          INC       MEHPLSFD/INC
.
DIM19A    DIM       19
.         
          CALL      MHDL0000
          CALL      MHAD0000
          CALL      MHAH0000
          CALL      MHHL0000
          CALL      MHMD0000
          CALL      MHMT0000
          CALL      MHSC0000
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS       * NZ only (PRIMHD)
          IF        PTCNHDPS = 1
            CALL      MHPRD000              * RD, AT, CN, CO, OI Tables
            CALL      MHPLS000              * LS Table
          ENDIF
.
          GOTO      ENDMEH
.
.**********************************************************************
.*             MH Legal status detail                                 *
.**********************************************************************
MHDL0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHDLSA1,"mehdlsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHDL9999
.
          MOVE      "mehdlsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHDL1000  PACK      KEY32,PVIURNO,SP30
          CALL      RSMHDLS1
          CALL      RKMHDLS1
          BRANCH    OVRCD,MHDL9999
.
          MATCH     PVIURNO,MHDLURNO
          GOTO      MHDL9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHDLURNO
          CALL      UPMHDLS1
          GOTO      MHDL1000
.
MHDL9999  RETURN
+
.**********************************************************************
.*             MH Supplementary Consumer Record                       *
.**********************************************************************
MHSC0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHSCRA1,"mehscraf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHSC9999
.
          MOVE      "mehscraf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
.  find the highest counter for the ur to keep
.
          MOVE      ZERO,F5
          PACK      KEY16,NEWURNO,SP70
          CALL      RSMHSCR1
MHSC0200  CALL      RKMHSCR1
          BRANCH    OVRCD,MHSC0500
.
          MATCH     NEWURNO,MHSCURNO
          GOTO      MHSC0500 IF NOT EQUAL
.
          ADD       ONE,F5
          GOTO      MHSC0200
.
MHSC0500  MOVE      OLDURNO,PVIURNO
MHSC1000  PACK      KEY16,PVIURNO,SP30
          CALL      RSMHSCR1
          CALL      RKMHSCR1
          BRANCH    OVRCD,MHSC9999
.
          MATCH     PVIURNO,MHSCURNO
          GOTO      MHSC9999 IF NOT EQUAL
.
          PACK      KEY16,NEWURNO,MHSCSDAT,SP70
          CALL      RAMHSCR1
          IF        OVRCD=1
            PACK      KEY16,OLDURNO,MHSCSDAT,SP70
            CALL      RDMHSCR1
            IF        OVRCD=0
              MOVE      NEWURNO,MHSCURNO
              ADD       ONE,F5
              MOVE      F5,MHSCCOUN
              CALL      UPMHSCR1
            ENDIF
          ELSE
            PACK      KEY16,OLDURNO,MHSCSDAT,SP70
            CALL      DEMHSCR1
          ENDIF
          GOTO      MHSC1000
.
MHSC9999  RETURN
+
.**********************************************************************
.*             MH Legal status detail                                 *
.**********************************************************************
MHAD0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHAUDDA,"mehaudda"
          TRAPCLR   IO
          BRANCH    OVRCD,MHAD9999
.
          MOVE      "mehaudda",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHAD1000  PACK      KEY32,PVIURNO,SP30
          CALL      ASMHDL
          CALL      APMHDL
          BRANCH    OVRCD,MHAD9999
.
          MATCH     PVIURNO,MHDLURNO
          GOTO      MHAD9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHDLURNO
          CALL      AUMHDL
          GOTO      MHAD1000
.
MHAD9999  RETURN
+
.**********************************************************************
.*             MH Header audit                                        *
.**********************************************************************
MHAH0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHAUDHA,"mehaudha"
          TRAPCLR   IO
          BRANCH    OVRCD,MHAH9999
.
          MOVE      "mehaudha",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHAH1000  PACK      KEY32,PVIURNO,SP30
          CALL      ASMHHL
          CALL      APMHHL
          BRANCH    OVRCD,MHAH9999
.
          MATCH     PVIURNO,MHHLURNO
          GOTO      MHAH9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHHLURNO
          CALL      AUMHHL
          GOTO      MHAH1000
.
MHAH9999  RETURN
+
.**********************************************************************
.*             MH Legal status header                                 *
.**********************************************************************
MHHL0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHHLSA1,"mehhlsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHHL9999
.
          MOVE      "mehhlsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHHL1000  PACK      KEY16,PVIURNO,SP30
          CALL      RSMHHLS1
          CALL      RKMHHLS1
          BRANCH    OVRCD,MHHL9999
.
          MATCH     PVIURNO,MHHLURNO
          GOTO      MHHL9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHHLURNO
          CALL      UPMHHLS1
          GOTO      MHHL1000
.
MHHL9999  RETURN
+
.**********************************************************************
.*             MH Notes                                               *
.**********************************************************************
MHMD0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHMDTA1,"mehmdtaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHMD9999
.
          MOVE      "mehmdtaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHMD1000  PACK      KEY17,PVIURNO,SP30
          CALL      RSMHMDT1
          CALL      RKMHMDT1
          BRANCH    OVRCD,MHMD9999
.
          MATCH     PVIURNO,MHMDURNO
          GOTO      MHMD9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHMDURNO
          CALL      UPMHMDT1
          GOTO      MHMD1000
.
MHMD9999  RETURN
+
.**********************************************************************
.*             MH Free Text Notes                                     *
.**********************************************************************
MHMT0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHMTXA1,"mehmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHMT9999
.
          MOVE      "mehmtxaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHMT1000  PACK      KEY20,PVIURNO,SP30
          CALL      RSMHMTX1
          CALL      RKMHMTX1
          BRANCH    OVRCD,MHMT9999
.
          MATCH     PVIURNO,MHMTURNO
          GOTO      MHMT9999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHMTURNO
          CALL      UPMHMTX1
          GOTO      MHMT1000
.
MHMT9999  RETURN
+
.**********************************************************************
.*             MH PRIMHD Transmission RD Record                       *
.**********************************************************************
MHPRD000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPRDA3,"mehprdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPRD999
.
          MOVE      "mehprdaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPRD100  PACK      KEY27,SP30
          CALL      RSMHPRD3
          CALL      RKMHPRD3
          BRANCH    OVRCD,MHPRD999
.
          MATCH     PVIURNO,MHPDURNO
          GOTO      MHPRD999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPDURNO
          CALL      UPMHPRD3
.
.                                           * convert "child" Tables
          PACK      KEY27,MHPDXDAT,MHPDXNUM,MHPDVISN,PVIURNO,SP30
          CALL      MHPAT000                * "AT" records
          CALL      MHPCN000                * "CN"
          CALL      MHPCO000                * "CO"
          CALL      MHPOI000                * "OT/OI"
          CALL      MHPSC000                * "SC"
.
          GOTO      MHPRD100
.
MHPRD999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission AT Record                       *
.**********************************************************************
MHPAT000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPATA1,"mehpataf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPAT999
.
          MOVE      "mehpataf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPAT100  PACK      KEY32,KEY27,SP30
          CALL      RSMHPAT1
MHPAT200  CALL      RKMHPAT1
          BRANCH    OVRCD,MHPAT999
.
          PACK      DIM19A,MHPTXDAT,MHPTXNUM,MHPTVISN,SP30
          MATCH     DIM19A,KEY32
          GOTO      MHPAT999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPTURNO
          GOTO      MHPAT200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPTURNO
          CALL      UPMHPAT1
          GOTO      MHPAT100
.
MHPAT999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission CN Record                       *
.**********************************************************************
MHPCN000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCNA1,"mehpcnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPCN999
.
          MOVE      "mehpcnaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPCN100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCN1
MHPCN200  CALL      RKMHPCN1
          BRANCH    OVRCD,MHPCN999
.
          PACK      DIM19A,MHPNXDAT,MHPNXNUM,MHPNVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPCN999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPNURNO
          GOTO      MHPCN200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPNURNO
          CALL      UPMHPCN1
          GOTO      MHPCN100
.
MHPCN999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission SC Record                       *
.**********************************************************************
MHPSC000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCSA1,"mehpcsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPSC999
.
          MOVE      "mehpcsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPSC100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCS1
MHPSC200  CALL      RKMHPCS1
          BRANCH    OVRCD,MHPSC999
.
          PACK      DIM19A,MHPCXDAT,MHPCXNUM,MHPCVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPSC999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPCURNO
          GOTO      MHPSC200 IF NOT EQUAL
.
.
.         check if changing UR will create a duplicate key before updating
.
          PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,NEWURNO,MHPCOCUR,SP70
          CALL      RAMHPCS1
          IF        OVRCD=1
            PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,OLDURNO,MHPCOCUR,SP70
            CALL      RDMHPCS1
            IF        OVRCD=0
              MOVE      NEWURNO,MHPCURNO
              CALL      UPMHPCS1
            ENDIF
          ELSE
            PACK      KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,OLDURNO,MHPCOCUR,SP70
            CALL      DEMHPCS1
          ENDIF
          GOTO      MHPSC100
.
MHPSC999  RETURN
.
..**********************************************************************
.*             MH PRIMHD Transmission CO Record                       *
.**********************************************************************
MHPCO000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPCOA1,"mehpcoaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPCO999
.
          MOVE      "mehpcoaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPCO100  PACK      KEY30,KEY27,SP30
          CALL      RSMHPCO1
MHPCO200  CALL      RKMHPCO1
          BRANCH    OVRCD,MHPCO999
.
          PACK      DIM19A,MHPOXDAT,MHPOXNUM,MHPOVISN,SP30
          MATCH     DIM19A,KEY30
          GOTO      MHPCO999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPOURNO
          GOTO      MHPCO200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPOURNO
          CALL      UPMHPCO1
          GOTO      MHPCO100
.
MHPCO999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission OI Record                       *
.**********************************************************************
MHPOI000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPOIA1,"mehpoiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPOI999
.
          MOVE      "mehpoiaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPOI100  PACK      KEY36,KEY27,SP30
          CALL      RSMHPOI1
MHPOI200  CALL      RKMHPOI1
          BRANCH    OVRCD,MHPOI999
.
          PACK      DIM19A,MHPIXDAT,MHPIXNUM,MHPIVISN,SP30
          MATCH     DIM19A,KEY36
          GOTO      MHPOI999 IF NOT EQUAL
.
          MATCH     PVIURNO,MHPIURNO
          GOTO      MHPOI200 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPIURNO
          CALL      UPMHPOI1
          GOTO      MHPOI100
.
MHPOI999  RETURN
.
.**********************************************************************
.*             MH PRIMHD Transmission LS Record                       *
.**********************************************************************
MHPLS000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHPLSA3,"mehplsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,MHPLS999
.
          MOVE      "mehplsaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
          MOVE      OLDURNO,PVIURNO
MHPLS100  PACK      KEY30,PVIURNO,SP30
          CALL      RSMHPLS3
          CALL      RKMHPLS3
          BRANCH    OVRCD,MHPLS999
.
          MATCH     PVIURNO,MHPSURNO
          GOTO      MHPLS999 IF NOT EQUAL
.
          MOVE      NEWURNO,MHPSURNO
          CALL      UPMHPLS3
          GOTO      MHPLS100
.
MHPLS999  RETURN
+
.**********************************************************************
          INC       IBAOVRIO/INC
          INC       MEHDLSIO/INC
          INC       MEHHLSIO/INC
          INC       MEHMDTIO/INC
          INC       MEHMTXIO/INC
          INC       MEHPRDIO/INC
          INC       MEHPATIO/INC
          INC       MEHPCNIO/INC
          INC       MEHPCOIO/INC
          INC       MEHPCSIO/INC
          INC       MEHSCRIO/INC
          INC       MEHPOIIO/INC
          INC       MEHPLSIO/INC
.
ENDMEH    ENDPROC
.
+
.        ================================================
.        Procedure to fix up the NZ related provider
.        invoice files
.        ================================================
.         
          DEFPROC   FIXREL
.
          INC       NZPPICFD/INC
          INC       NZPRPIFD/INC
          INC       NZPAPIFD/INC
.         
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NZPPICA1,"nzppicaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          TRAP      OVERCOND IF IO
          OPEN      NZPRPIA1,"nzprpiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          TRAP      OVERCOND IF IO
          OPEN      NZPAPIA1,"nzpapiaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXREL999
.
          PACK      KEY22,DPVIBILL,SP70
          CALL      RSNZPIC1
FXREL100  CALL      RKNZPIC1
          BRANCH    OVRCD,FXREL500
.
          MATCH     DPVIBILL,NZPIADMN
          GOTO      FXREL500 IF NOT EQUAL
.
          MOVE      NEWURNO,NZPIURNO
.
          CALL      UPNZPIC1
          GOTO      FXREL100
.
FXREL500  PACK      KEY36,DPVIBILL,SP70
          CALL      RSNZRPI1
FXREL550  CALL      RKNZRPI1
          BRANCH    OVRCD,FXREL999
.
          MATCH     DPVIBILL,NZRPADMN
          GOTO      FXREL999 IF NOT EQUAL
.
          PACK      KEY8,NZRPRPIS,SP70
          CALL      RDNZAPI1
          IF        OVRCD=0
            MOVE      NEWURNO,NZAPURNO
            CALL      UPNZAPI1
          ENDIF
.
          GOTO      FXREL550
.
          INC       IBAOVRIO/INC
          INC       NZPPICIO/INC
          INC       NZPRPIIO/INC
          INC       NZPAPIIO/INC

FXREL999  CLOSE     NZPPICA1
          CLOSE     NZPRPIA1
          CLOSE     NZPAPIA1
          ENDPROC
.
.**********************************************************************       
.*             Fees Estimation Details                                *       
.**********************************************************************       
          DEFPROC   FIXFES
.
          INC       PMSFEDFD/INC
          INC       PMSFESFD/INC
.
          MOVE      ZERO,OVRCD     
          TRAP      OVERCOND IF IO
          OPEN      PMSFEDA2,"pmsfedaf"   
          TRAPCLR   IO                                                 *I-90301
          BRANCH    OVRCD,FEST9999                                     *I-90301
.
          TRAP      OVERCOND IF IO                                     *I-90301
          OPEN      PMSFESA1,"pmsfesaf"                                       
          TRAPCLR   IO
          BRANCH    OVRCD,FEST9999
.
          MOVE      "pmsfedaf",XXFILE      
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO                      
.
          MOVE      OLDURNO,PVIURNO
FEST1000  PACK      KEY20 WITH PVIURNO,SP30
          CALL      RSPMFED2
          CALL      RKPMFED2
          BRANCH    OVRCD OF FEST9999
.
          MATCH     PVIURNO,PMFDURNO
          GOTO      FEST9999 IF NOT EQUAL
.
          MOVE      NEWURNO,PMFDURNO
          CALL      UPPMFED2
.
          PACK      KEY17,PMFDQUOT,SP30
          CALL      RSPMFES1
FEST2000  CALL      RKPMFES1
          BRANCH    OVRCD OF FEST1000
.
          MATCH     PMFSQUOT,PMFDQUOT
          GOTO      FEST1000 IF NOT EQUAL
.
          MATCH     PVIURNO,PMFSURNO
          GOTO      FEST2000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMFSURNO
          CALL      UPPMFES1
          GOTO      FEST2000
.
          INC       IBAOVRIO/INC
          INC       PMSFEDIO/INC
          INC       PMSFESIO/INC
.
FEST9999  CLOSE     PMSFEDA2
          CLOSE     PMSFESA1
          ENDPROC
+
+
.*********************************************************************
.       Procedure to fix the bed board file
.*********************************************************************
.
          DEFPROC   FIXBED
.
          INC       PMSBBDFD/INC
.
.         Open bed board file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsbbdaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSBBDA2,"pmsbbdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXBED99
.
          DISPLAY   *P1:24,*EL,"Fixing bed board file";
          CALL      FIXBD000
          GOTO      FIXBED99
.*********************************************************************
.         Subroutine to update the bed board file
.*********************************************************************
FIXBD000  OPEN      PMSBBDA2,"pmsbbdaf"
.
FIXBD010  PACK      KEY28,OLDURNO,SP70
          CALL      RSPMBBD2
          CALL      RKPMBBD2
          BRANCH    OVRCD,FIXBD099
.
.         Update file with new UR
.
          MATCH     PMBDURNO,OLDURNO
          GOTO      FIXBD099 IF NOT EQUAL
.
          MOVE      NEWURNO,PMBDURNO
          MOVE      PSNAME,PMBDSURN
          MOVE      PGNAME,PMBDGIVN
          CALL      UPPMBBD2
.
          GOTO      FIXBD010           * Loop back to correct file position
.                                      * after key has been updated
FIXBD099  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSBBDIO/INC
.
FIXBED99  ENDPROC
+
.*********************************************************************
.       Procedure to fix the expected patient file
.*********************************************************************
.
          DEFPROC   FIXEXP
.
          INC       PMSEPBFD/INC
.
.         Open expected patient file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsepbaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSEPBA2,"pmsepbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXEXP99
.
          DISPLAY   *P1:24,*EL,"Fixing expected patient file";
          CALL      FIXEX000
          GOTO      FIXEXP99
.*********************************************************************
.         Subroutine to update the expected patient file
.*********************************************************************
FIXEX000  OPEN      PMSEPBA2,"pmsepbaf"
.
FIXEX010  PACK      KEY28,OLDURNO,SP70
          CALL      RSPMEPB2
          CALL      RKPMEPB2
          BRANCH    OVRCD,FIXEX099
.
.         Update file with new UR
.
          MATCH     PMEBURNO,OLDURNO
          GOTO      FIXEX099 IF NOT EQUAL
.
          MOVE      NEWURNO,PMEBURNO
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          CALL      UPPMEPB2
.
          GOTO      FIXEX010           * Loop back to correct file position
.                                      * after key has been updated
FIXEX099  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSEPBIO/INC
.
FIXEXP99  ENDPROC
.
+
.*********************************************************************
.       Procedure to fix the bed board file by visit number
.*********************************************************************
.
          DEFPROC   FIXVBED
.
          INC       PMSBBDFD/INC
.
.         Open bed board file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsbbdaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSBBDA2,"pmsbbdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXVBED99
.
          DISPLAY   *P1:24,*EL,"Fixing bed board file";
          CALL      FXVBD000
          GOTO      FXVBED99
.*********************************************************************
.         Subroutine to update the bed board file by visit number
.*********************************************************************
FXVBD000  OPEN      PMSBBDA2,"pmsbbdaf"
.
FXVBD010  PACK      KEY28,OLDURNO,SP70
          CALL      RSPMBBD2
FXVBD020  CALL      RKPMBBD2
          BRANCH    OVRCD,FXVBD099
.
.         Update file with new UR
.
          MATCH     PMBDURNO,OLDURNO
          GOTO      FXVBD099 IF NOT EQUAL
.
          MATCH     DPVIBILL,PMBDCADM
          GOTO      FXVBD020 IF NOT EQUAL
.
          MOVE      NEWURNO,PMBDURNO
          MOVE      PSNAME,PMBDSURN
          MOVE      PGNAME,PMBDGIVN
          CALL      UPPMBBD2
.
          GOTO      FXVBD010           * Loop back to correct file position
.                                      * after key has been updated
FXVBD099  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSBBDIO/INC
.
FXVBED99  ENDPROC
+
.*********************************************************************
.       Procedure to fix the expected patient file by visit number
.*********************************************************************
.
          DEFPROC   FIXVEXP
.
          INC       PMSEPBFD/INC
.
.         Open expected patient file if it exists
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsepbaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSEPBA2,"pmsepbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXVEXP99
.
          DISPLAY   *P1:24,*EL,"Fixing expected patient file";
          CALL      FXVEX000
          GOTO      FXVEXP99
.*********************************************************************
.         Subroutine to update the expected patient file by visit number
.*********************************************************************
FXVEX000  OPEN      PMSEPBA2,"pmsepbaf"
.
FXVEX010  PACK      KEY28,OLDURNO,SP70
          CALL      RSPMEPB2
FXVEX020  CALL      RKPMEPB2
          BRANCH    OVRCD,FXVEX099
.
.         Update file with new UR
.
          MATCH     PMEBURNO,OLDURNO
          GOTO      FXVEX099 IF NOT EQUAL
.
          MATCH     DPVIBILL,PMEBADMN
          GOTO      FXVEX020 IF NOT EQUAL
.
          MOVE      NEWURNO,PMEBURNO
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          CALL      UPPMEPB2
.
          GOTO      FXVEX010           * Loop back to correct file position
.                                      * after key has been updated
FXVEX099  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSEPBIO/INC
.
FXVEXP99  ENDPROC
+
.*****************************************************************************
.*  WRWATR00
.*  Procedure to write to the WA triggers table if required
.*****************************************************************************
          DEFPROC   WRWATR00
.
          INC       PMSWTRFD/INC
.
          COMPARE   SIX,PTCNHDPS           * If not WA - exit
          GOTO      WRWATR99 IF NOT EQUAL
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          COMPARE   THREE,ASTAT
          GOTO      WRWATR99 IF NOT EQUAL
.
          PACK      KEY19,PMVXMHOS,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      WRWATR99    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,PMVXMHOS,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
          GOTO      WRWATR99
.
          INC       PMSWTRIO/INC
          INC       IBAOVRIO/INC
.
WRWATR99  CLOSE     PMSWTRA1
.
          ENDPROC
+
.**********************************************************************
.*             Fix pmselfaf                                           *
.**********************************************************************
          DEFPROC   FIXELF
.
          INC       PMSELFFD/INC
.
FIXF0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSELFA2,"pmselfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDELF
.
          MOVE      "pmselfaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXF1000  PACK      KEY16,OLDURNO,SP30
          CALL      RSPMELF2
          CALL      RKPMELF2
          BRANCH    OVRCD,FIXF9000
.
          MATCH     OLDURNO,PMEFURNO
          GOTO      FIXF9000 IF NOT EQUAL
.
          MOVE      NEWURNO,PMEFURNO
.
          CALL      UPPMELF2
          GOTO      FIXF1000
.
FIXF9000  CLOSE     PMSELFA2
          GOTO      ENDELF
.
          INC       IBAOVRIO/INC
          INC       PMSELFIO/INC
.
ENDELF    ENDPROC
+
.**********************************************************************
.*             Fix pmsovraf                                           *
.**********************************************************************
          DEFPROC   FIXOVR
.
          INC       PMSOVRFD/INC
.
SAVKEY26  DIM       26
NEWCOUNT  FORM      2
.
FIXR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOVRA1,"pmsovraf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOVR
.
          MOVE      "pmsovraf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXR1000  PACK      KEY26,OLDURNO,SP30
          CALL      RSPMOVR1
          CALL      RKPMOVR1
          BRANCH    OVRCD,FIXR9000
.
          MATCH     OLDURNO,PMORURNO
          GOTO      FIXR9000 IF NOT EQUAL
.
          PACK      SAVKEY26,PMORURNO,PMORDATE,PMORTIME,PMORCNTR,SP70
.
          MOVE      NEWURNO,PMORURNO
          MOVE      PMORCNTR,NEWCOUNT
.
FIXR2000  PACK      KEY26,PMORURNO,PMORDATE,PMORTIME,PMORCNTR,SP70
          CALL      RAPMOVR1
          BRANCH    OVRCD,FIXR3000
.
          ADD       ONE,NEWCOUNT
          MOVE      NEWCOUNT,PMORCNTR                 * Add 1 to unique counter
.
          IF        PMORCNTR=99
            PACK      KEY26,SAVKEY26,SP70
            CALL      DEPMOVR1
            GOTO      FIXR1000
          ENDIF
          GOTO      FIXR2000
.
FIXR3000  PACK      KEY26,SAVKEY26,SP70
          CALL      RDPMOVR1
          BRANCH    OVRCD,FIXR1000
.
          MOVE      NEWURNO,PMORURNO
          MOVE      NEWCOUNT,PMORCNTR
.
          CALL      UPPMOVR1
          GOTO      FIXR1000
.
FIXR9000  CLOSE     PMSOVRA1
          GOTO      ENDOVR
.
          INC       IBAOVRIO/INC
          INC       PMSOVRIO/INC
.
ENDOVR    ENDPROC
+/de
.------------------------------------------------------------------------------
.         merge mehhonaf
.------------------------------------------------------------------------------
          DEFPROC   FIXMHHN     
.
          INC       MEHHONFD/INC
.
SAVKEY24  DIM       24
.
MMRG0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHHONA4,"mehhonaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOVR
.
MMRG0100  PACK      KEY24,OLDURNO,SP70
          CALL      RAMHHON4
MMRG0200  CALL      RKMHHON4
          BRANCH    OVRCD,MMRG9000
.
          MATCH     OLDURNO,MHHNURNO
          GOTO      MMRG9000 IF NOT EQUAL
.
          PACK      SAVKEY24,MHHNURNO,MHHNVISN,MHHNUNIQ
          RJUSTIFY  MHHNUNIQ
          MOVE      MHHNUNIQ,FORM8
.
MMRG0300  PACK      KEY24,NEWURNO,MHHNVISN,MHHNUNIQ
          CALL      RDMHHON4
          BRANCH    OVRCD,MMRG0400
.
          MOVE      MHHNUNIQ,FORM8               * yes - increment counter
          ADD       ONE,FORM8
          MOVE      FORM8,MHHNUNIQ
          GOTO      MMRG0300
.
MMRG0400  MOVE      SAVKEY24,KEY24
          CALL      RDMHHON4                     * re-read the old record again
          MOVE      NEWURNO,MHHNURNO
          MOVE      FORM8,MHHNUNIQ               * load new counter
          CALL      UPMHHON4                     * update record
          GOTO      MMRG0200
.
MMRG9000  CLOSE     MEHHONA4
          GOTO      ENDOVR
.
          INC       MEHHONIO/INC
          INC       IBAOVRIO/INC
.
ENDOVR    ENDPROC
+
.------------------------------------------------------------------------------
.         merge legacmaf
.------------------------------------------------------------------------------
          DEFPROC   FIXLEG
.
          INC       LEGACMFD/INC
.
SAVKEY35  DIM       35
.
MMRG0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LEGACMA1,"legacmaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOVR
.
MMRG0100  PACK      KEY35,OLDURNO,SP70
          CALL      RSLGACM1
MMRG0200  CALL      RKLGACM1
          BRANCH    OVRCD,MMRG9000
.
          MATCH     OLDURNO,LGACURNO
          GOTO      MMRG9000 IF NOT EQUAL
.
          PACK      SAVKEY35,LGACURNO,LGACADAT,LGACATIM,LGACEVNO,LGACLINE
          MOVE      ZERO,FORM3
          MOVE      LGACLINE,FORM3
.
MMRG0300  PACK      KEY35,NEWURNO,LGACADAT,LGACATIM,LGACEVNO,FORM3
          CALL      RDLGACM1
          BRANCH    OVRCD,MMRG0400
.
          MOVE      LGACLINE,FORM3               * yes - increment counter
          ADD       ONE,FORM3
          MOVE      FORM3,LGACLINE
          GOTO      MMRG0300
.
MMRG0400  MOVE      SAVKEY35,KEY35
          CALL      RDLGACM1                     * re-read the old record again
          MOVE      NEWURNO,LGACURNO
          MOVE      FORM3,LGACLINE               * load new counter
          CALL      UPLGACM1                     * update record
          GOTO      MMRG0100
.
MMRG9000  CLOSE     LEGACMA1
          GOTO      ENDOVR
.
          INC       LEGACMIO/INC
          INC       IBAOVRIO/INC
.
ENDOVR    ENDPROC
+
.------------------------------------------------------------------------------
.         merge transport (pmstspaf)
.------------------------------------------------------------------------------
          DEFPROC   FIXTRNST
.
          INC       PMSTSPFD/INC
.
TMRG0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSTSPA1,"pmstspaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOVR
.
TMRG0100  PACK      KEY19,OLDURNO,SP70
          CALL      RAPMTSP1
TMRG0200  CALL      RKPMTSP1
          BRANCH    OVRCD,TMRG9000
.
          MATCH     OLDURNO,PMTSURNO
          GOTO      TMRG9000 IF NOT EQUAL
.
          PACK      SAVKEY19,PMTSURNO,PMTSVISN,PMTSUNIQ
          RJUSTIFY  PMTSUNIQ
          MOVE      PMTSUNIQ,FORM3
.
TMRG0300  PACK      KEY19,NEWURNO,PMTSVISN,PMTSUNIQ
          CALL      RAPMTSP1           
          BRANCH    OVRCD,TMRG0400
.
          MOVE      PMTSUNIQ,FORM3               * yes - increment counter
          ADD       ONE,FORM3
          MOVE      FORM3,PMTSUNIQ
          GOTO      TMRG0300
.
TMRG0400  MOVE      SAVKEY19,KEY19
          CALL      RDPMTSP1                     * re-read the old record again
          MOVE      NEWURNO,PMTSURNO
          MOVE      FORM3,PMTSUNIQ               * load new counter
          CALL      UPPMTSP1                     * update record
          GOTO      TMRG0200
.
TMRG9000  CLOSE     PMSTSPA1
          GOTO      ENDOVR
.
          INC       IBAOVRIO/INC
          INC       PMSTSPIO/INC
.
ENDOVR    ENDPROC
+
.------------------------------------------------------------------------------
.         change transport by visit(pmstspaf)
.------------------------------------------------------------------------------
FXVT0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSTSPA1,"pmstspaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FXVT9000
.
FXVT1000  PACK      KEY19,OLDURNO,ADMISSNO,SP70
          CALL      RSPMTSP1
FXVT2000  CALL      RKPMTSP1
          BRANCH    OVRCD,FXVT9000
.
          MATCH     OLDURNO,PMTSURNO
          GOTO      FXVT9000 IF NOT EQUAL
.
          MATCH     PMTSVISN,ADMISSNO
          GOTO      FXVT9000 IF NOT EQUAL
.
          PACK      SAVKEY19,PMTSURNO,PMTSVISN,PMTSUNIQ
          RJUSTIFY  PMTSUNIQ
          MOVE      PMTSUNIQ,FORM3
.
FXVT3000  PACK      KEY19,NEWURNO,PMTSVISN,PMTSUNIQ
          CALL      RAPMTSP1
          BRANCH    OVRCD,FXVT4000
.
          MOVE      PMTSUNIQ,FORM3               * yes - increment counter
          ADD       ONE,FORM3
          MOVE      FORM3,PMTSUNIQ
          GOTO      FXVT3000
.
FXVT4000  MOVE      SAVKEY19,KEY19
          CALL      RDPMTSP1                     * re-read the old record again
          MOVE      NEWURNO,PMTSURNO
          MOVE      FORM3,PMTSUNIQ               * load new counter
          CALL      UPPMTSP1                     * update record
          GOTO      FXVT2000
.
FXVT9000  CLOSE     PMSTSPA1
FXVT9999  RETURN
+
.------------------------------------------------------------
. Write an update demographics record (pmsupdaf)
.------------------------------------------------------------
WRUPD000  OPEN      PMSUPDA1,"pmsupdaf"
.
          PACK      PMUDURNO,NEWURNO,SP70
.
          CALL      IBACLOCK
          PACK      PMUDDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",PMUDDATE
          CLOCK     TIME,PMUDTIME
.
          PACK      PMUDUSER,USERID,SP70
.
          PACK      KEY8,PMUDURNO,SP70
          CALL      RDPMUPD1
          IF        OVRCD=1
            CALL      IBACLOCK
            PACK      PMUDDATC,CCC,CYY,CMM,CDD
            REPLACE   " 0",PMUDDATC
            CLOCK     TIME,PMUDTIMC
            PACK      PMUDWEBC,USERID,SP70
            CALL      WRPMUPD1
          ELSE
            CALL      IBACLOCK
            PACK      PMUDDATE,CCC,CYY,CMM,CDD
            REPLACE   " 0",PMUDDATE
            CLOCK     TIME,PMUDTIME
            CALL      UPPMUPD1
          ENDIF
.
          CLOSE     PMSUPDA1
.
WRUPD999  RETURN
.
+
.*********************************************************************
.        fix up the outpatient Appointment Request Table
.*********************************************************************
FIXART00  MOVE      ZERO,EXIT
.
          OPEN      OUTARTA1,"outartaf"
          DISPLAY   *P1:24,*EL,"Appointment Requests : ",*V2LON,OURNO;
.
.        Loop thru Outpatient Appointment Request Table
.
FIXART10  PACK      KEY32,OURNO,PVIBILL,SP70
          CALL      RSOTART1
          CALL      RKOTART1
          BRANCH    OVRCD,FIXART95
.
          MATCH     OTARURNO,OURNO
          GOTO      FIXART95 IF NOT EQUAL
.
          MOVE      PVIBILL,DIM8
          MATCH     OTARREFN,DIM8
          GOTO      FIXART95 IF NOT EQUAL          
.
          MOVE      NEWURNO,OTARURNO
          CALL      UPOTART1
          GOTO      FIXART10
.
FIXART95  CLOSE     OUTARTA1
.
FIXART99  RETURN
+
.*==========================================================================*
.*      Procedure to fix the U/R number in the health fund program files    *
.*==========================================================================*
.
          DEFPROC   FIXPRG
.
          INC       PMSUPGFD/INC
          INC       PMSAPGFD/INC
.
SAVKEY31  DIM       31
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSUPGA1,"pmsupgaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXPRG99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSAPGA1,"pmsapgaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXPRG99
.
FIXPRG10  PACK      KEY31,OURNO,SP70
          CALL      RSPMUPG1
          CALL      RKPMUPG1
          BRANCH    OVRCD,FIXPRG50
.
          MATCH     OURNO,PMUGURNO
          GOTO      FIXPRG50 IF NOT EQUAL
.
          PACK      SAVKEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                             PMUGEDAT,SP70
.
          PACK      KEY31,NEWURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RAPMUPG1                    * read into ans;
          BRANCH    OVRCD,FIXPRG20              * new u/r not on file, go update
.
          MOVE      SAVKEY31,KEY31              * New ur on file so
          CALL      DEPMUPG1                    * delete old u/r no.
          GOTO      FIXPRG10
.
FIXPRG20  MOVE      SAVKEY31,KEY31               * read old record
          CALL      RDPMUPG1                          * full read
          BRANCH    OVRCD,FIXPRG10
.
          MOVE      NEWURNO,PMUGURNO                  * move new u/r to old u/r
          CALL      UPPMUPG1                          * update record
.
          GOTO      FIXPRG10
.
FIXPRG50  PACK      KEY31,OURNO,SP70
          CALL      RSPMAPG1
          CALL      RKPMAPG1
          BRANCH    OVRCD,FIXPRG95
.
          MATCH     OURNO,PMAGURNO
          GOTO      FIXPRG95 IF NOT EQUAL
.
          PACK      SAVKEY31,PMAGURNO,PMAGATYP,PMAGCLAM,PMAGFUND,PMAGTABT:
                             PMAGEDAT,SP70
.
          PACK      KEY31,NEWURNO,PMAGATYP,PMAGCLAM,PMAGFUND,PMAGTABT:
                          PMAGEDAT,SP70
          CALL      RAPMAPG1                    * read into ans;
          BRANCH    OVRCD,FIXPRG60              * new u/r not on file, go update
.
          MOVE      SAVKEY31,KEY31              * New ur on file
          CALL      DEPMAPG1                    * delete old u/r no.
          GOTO      FIXPRG50
.
FIXPRG60  MOVE      SAVKEY31,KEY31               * read old record
          CALL      RDPMAPG1                          * full read
          BRANCH    OVRCD,FIXPRG50
.
          MOVE      NEWURNO,PMAGURNO                  * move new u/r to old u/r
          CALL      UPPMAPG1    
.
          GOTO      FIXPRG50
.
FIXPRG95  CLOSE     PMSUPGA1
          CLOSE     PMSUPGA1
          GOTO      FIXPRG99
.
          INC       IBAOVRIO/INC
          INC       PMSUPGIO/INC
          INC       PMSAPGIO/INC
.
FIXPRG99  ENDPROC
.
+
.**********************************************************************
.*                            FIXEBS00                                *
.*                  Update Electronic Booking Files                   *
.**********************************************************************
          DEFPROC   FIXEBS00
.
          INC       PMSARQFD/INC
          INC       PMSAMNFD/INC
          INC       PMSARVFD/INC
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsarqaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSARQA2,"pmsarqaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXEBS98
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsamnaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSAMNA1,"pmsamnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXEBS98
.
          MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"pmsarvaf"
          TRAP      OVERCOND IF IO
          OPEN      PMSARVA1,"pmsarvaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXEBS98
.
          MOVE      "pmsarqaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXEBS10  PACK      KEY18,OLDURNO,SP70
          CALL      RSPMARQ2                * position in file
          CALL      RKPMARQ2                * read next record
          BRANCH    OVRCD,FIXEBS98          * end of file
.
          MATCH     PMARURNO,OLDURNO        * same number ?
          GOTO      FIXEBS98 IF NOT EQUAL   * no - ignore
.
          MOVE      NEWURNO,PMARURNO        * load new U/R number
          CALL      UPPMARQ2                * update record
.
          PACK      KEY15,PMARREQN,SP70
          CALL      RSPMAMN1
FIXEBS15  CALL      RKPMAMN1
          BRANCH    OVRCD,FIXEBS20
.
          MATCH     PMARREQN,PMAMREQN
          GOTO      FIXEBS20 IF NOT EQUAL
.
          MOVE      NEWURNO,PMAMURNO        * load new U/R number
          CALL      UPPMAMN1
          GOTO      FIXEBS15
.
FIXEBS20  PACK      KEY16,PMARREQN,SP70
          CALL      RSPMARV1
FIXEBS21  CALL      RKPMARV1
          BRANCH    OVRCD,FIXEBS10
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      FIXEBS10 IF NOT EQUAL
.
          MOVE      NEWURNO,PMAVURNO        * load new U/R number
          CALL      UPPMARV1
          GOTO      FIXEBS21                * get next record
.
FIXEBS98  CLOSE     PMSARQA2
          CLOSE     PMSAMNA1
          CLOSE     PMSARVA1
          GOTO      FIXEBS99
.
          INC       IBAOVRIO/INC
          INC       PMSARQIO/INC
          INC       PMSAMNIO/INC
          INC       PMSARVIO/INC
.
FIXEBS99  ENDPROC
.*==========================================================================*
.*      Procedure to fix the U/R number in the patient attribute file       *
.*==========================================================================*
.
          DEFPROC   FIXATR
.
          INC       PATATRFD/INC
.
SAVKEY35  DIM       35
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXATR99
.
FIXATR10  PACK      KEY35,OURNO,SP70
          CALL      RSPTATR1
          CALL      RKPTATR1
          BRANCH    OVRCD,FIXATR95
.
          MATCH     OURNO,PTARURNO
          GOTO      FIXATR95 IF NOT EQUAL
.
          PACK      SAVKEY35,PTARURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
.
          PACK      KEY35,NEWURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
          CALL      RAPTATR1                    * read into ans;
          BRANCH    OVRCD,FIXATR20              * new u/r not on file, go update
.
          MOVE      SAVKEY35,KEY35              * New ur on file so
          CALL      DEPTATR1                    * delete old u/r no.
          GOTO      FIXATR10
.
FIXATR20  MOVE      SAVKEY35,KEY35               * read old record
          CALL      RDPTATR1                          * full read
          BRANCH    OVRCD,FIXATR10
.
          MOVE      NEWURNO,PTARURNO                  * move new u/r to old u/r
          CALL      UPPTATR1                          * update record
.
          GOTO      FIXATR10
.
FIXATR95  CLOSE     PATATRA1
          GOTO      FIXATR99
.
          INC       IBAOVRIO/INC
          INC       PATATRIO/INC
.
FIXATR99  ENDPROC
.
.**********************************************************************
. Fix Patient Attribute for multiple birth. 
. PTARVISN = 0 and PTARTYPE = 022
.**********************************************************************
.
          DEFPROC   PATATR00
.
NMBIRACT  DIM       1                       * new multiple birth active flag
OMBIRACT  DIM       1                       * old multiple birth active flag
MBIRACT   DIM       1                       * multiple birth active flag
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
PATATR00  MOVE      ZERO,OVRCD
          DISPLAY   *P64:24,"patatraf"
          TRAP      OVERCOND IF IO
          OPEN      PATATRA3,"patatraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PATATR90
          OPEN      PATATRA1,"patatraf"
.
          MOVE      "0",OMBIRACT
          MOVE      "0",NMBIRACT
          PACK      DIM8,SP7,ZERO
.
. determine if there is multiple birth active row for new UR
.
PATATR10  PACK      KEY35,NEWURNO,DIM8,ATYPE022,Z70
          CALL      RSPTATR3
PATATR12  CALL      RPPTATR3
          BRANCH    OVRCD,PATATR30
.
          MATCH     NEWURNO,PTARURNO
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     DIM8,PTARVISN
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      PATATR30 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR12 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      PATATR12 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      PATATR12 IF NOT EQUAL
.
          MOVE      "1",NMBIRACT
.
. determine if there is multiple birth active row for old UR
.
PATATR30  PACK      KEY35,OLDURNO,DIM8,ATYPE022,Z70
PATATR31  CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,PATATR80
.
          MOVE      "0",MBIRACT
.
          MATCH     OLDURNO,PTARURNO
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     DIM8,PTARVISN
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      PATATR80 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR40 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      PATATR40 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      PATATR40 IF NOT EQUAL
.
          MOVE      "1",MBIRACT
.
. Update file with new UR
.
PATATR40  PACK      SAVKEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          PACK      KEY35,NEWURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,PATATR45
.
. key with new ur already exists, no update will be done
.
          MOVE      SAVKEY35,KEY35
          GOTO      PATATR31               * Loop back to next row
.
PATATR45  MATCH     "1",MBIRACT
          IF        @EQUAL
            MOVE      MBIRACT,OMBIRACT
          ENDIF
.
          MATCH     "1",NMBIRACT
          IF        @EQUAL
            MOVE      "1",PTARDELR
          ENDIF
          MOVE      NEWURNO,PTARURNO
          CALL      UPPTATR3
.
          MOVE      SAVKEY35,KEY35
          GOTO      PATATR31               * Loop back to next row
.
PATATR80  MATCH     "1",NMBIRACT          * Do nothing if new ur is active
          GOTO      PATATR90 IF EQUAL
.
          MATCH     "1",OMBIRACT          * Do nothing if old ur not active
          GOTO      PATATR90 IF NOT EQUAL
.
. Update pmpxsn20 = "1"
.
          MOVE      NEWURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,PATATR90
.
          MOVE      "1",PMPXSN20
          CALL      UPPMPX21          * update the record
.
PATATR90  CLOSE     PATATRA1
          CLOSE     PATATRA3
          GOTO      PATATR99
.
          INC       IBAOVRIO/INC
          INC       PATATRIO/INC
.
PATATR99  ENDPROC 
+
.*==========================================================================*
.*      Procedure to fix the U/R number in the theatre request   file       *
.*==========================================================================*
.
          DEFPROC   FIXRQ1
.
          INC       BOKRQ1FD/INC
.
SAVKEY18  DIM       18
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      BOKRQ1A2,"bokrq1af"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXRQ199
.
FIXRQ110  PACK      KEY18,OURNO,SP70
          CALL      RSBKRQ12
          CALL      RKBKRQ12
          BRANCH    OVRCD,FIXRQ195
.
          MATCH     OURNO,BKRQURNO
          GOTO      FIXRQ195 IF NOT EQUAL
.
          PACK      SAVKEY18,BKRQURNO,BKRQREQN,SP70
.
          PACK      KEY18,NEWURNO,BKRQREQN,SP70
          CALL      RABKRQ12                    * read into ans;
          BRANCH    OVRCD,FIXRQ120              * new u/r not on file, go update
.
          MOVE      SAVKEY18,KEY18              * New ur on file so
          CALL      DEBKRQ12                    * delete old u/r no.
          GOTO      FIXRQ110
.
FIXRQ120  MOVE      SAVKEY18,KEY18               * read old record
          CALL      RDBKRQ12                          * full read
          BRANCH    OVRCD,FIXRQ110
.
          MOVE      NEWURNO,BKRQURNO                  * move new u/r to old u/r
          CALL      UPBKRQ12                          * update record
.
          GOTO      FIXRQ110
.
FIXRQ195  CLOSE     BOKRQ1A2
          GOTO      FIXRQ199
.
          INC       IBAOVRIO/INC
          INC       BOKRQ1IO/INC
.
FIXRQ199  ENDPROC
.
+
.*==========================================================================*
.*      Procedure to fix the U/R number in the Death audit table            *
.*==========================================================================*
.
          DEFPROC   FIXPMDAU
.
          INC       PMSDAUFD/INC
.
SAVKEY27  DIM       27
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSDAUA1,"pmsdauaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXDAU99
.
FIXDAU10  PACK      KEY27,OURNO,SP70
          CALL      RSPMDAU1
          CALL      RKPMDAU1
          BRANCH    OVRCD,FIXDAU95
.
          MATCH     OURNO,PMDEURNO
          GOTO      FIXDAU95 IF NOT EQUAL
.
          PACK      SAVKEY27,PMDEURNO,PMDECDAT,PMDECTIM,PMDERTYP,SP70
.
          PACK      KEY27,NEWURNO,PMDECDAT,PMDECTIM,PMDERTYP,SP70
          CALL      RAPMDAU1                    * read into ans;
          BRANCH    OVRCD,FIXDAU20              * new u/r not on file, go update
.
          MOVE      SAVKEY27,KEY27              * New ur on file so
          CALL      DEPMDAU1                    * delete old u/r no.
          GOTO      FIXDAU10
.
FIXDAU20  MOVE      SAVKEY27,KEY27               * read old record
          CALL      RDPMDAU1                          * full read
          BRANCH    OVRCD,FIXDAU10
.
          MOVE      NEWURNO,PMDEURNO                  * move new u/r to old u/r
          CALL      UPPMDAU1                          * update record
.
          GOTO      FIXDAU10
.
FIXDAU95  CLOSE     PMSDAUA1
          GOTO      FIXDAU99
.
          INC       IBAOVRIO/INC
          INC       PMSDAUIO/INC
.
FIXDAU99  ENDPROC
.
+
.**********************************************************************
.*             Fix pmsoosaf - Opt out of SMS                          *
.**********************************************************************
          DEFPROC   FIXOOS
.
          INC       PMSOOSFD/INC
.
FIXS0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOOSA1,"pmsoosaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOOS
.
          MOVE      "pmsoosaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXS1000  PACK      KEY8,OLDURNO,SP70
          CALL      RDPMOOS1                * Any record for old U/R
          BRANCH    OVRCD,FIXS9000          * No so exit
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDPMOOS1                * Any record for new U/R
          BRANCH    OVRCD,FIXS2000        
.
          PACK      KEY8,OLDURNO,SP70       * Delete old U/R record as one
          CALL      DEPMOOS1                * already exists for the new U/R
.
          GOTO      FIXS9000
.           
FIXS2000  PACK      KEY8,OLDURNO,SP70       * No so moved old U/R to New U/R
          CALL      RDPMOOS1
          BRANCH    OVRCD,FIXS9000
.
          MOVE      NEWURNO,PMOOURNO        * Populate new U/R
.
          CALL      UPPMOOS1                * Update record to new U/R
.
FIXS9000  CLOSE     PMSOOSA1
          GOTO      ENDOOS
.
          INC       IBAOVRIO/INC
          INC       PMSOOSIO/INC
.
ENDOOS    ENDPROC
+
.**********************************************************************
.*             Fix pmsmupaf - Missing UPI Patients                    *
.**********************************************************************
          DEFPROC   FIXMUP
.
          INC       PMSMUPFD/INC
.
FIXMUP00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSMUPA1,"pmsmupaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDMUP
.
          MOVE      "pmsmupaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIXMUP10  PACK      KEY8,OLDURNO,SP70
          CALL      RDPMMUP1                * Any record for old U/R
          BRANCH    OVRCD,FIXMUP90          * No so exit
.
          PACK      KEY8,NEWURNO,SP70
          CALL      RDPMMUP1                * Any record for new U/R
          BRANCH    OVRCD,FIXMUP20        
.
          PACK      KEY8,OLDURNO,SP70       * Delete old U/R record as one
          CALL      DEPMMUP1                * already exists for the new U/R
.
          GOTO      FIXMUP90
.           
FIXMUP20  PACK      KEY8,OLDURNO,SP70       * No so moved old U/R to New U/R
          CALL      RDPMMUP1
          BRANCH    OVRCD,FIXMUP90
.
          MOVE      NEWURNO,PMMUURNO        * Populate new U/R
.
          CALL      UPPMMUP1                * Update record to new U/R
.
FIXMUP90  CLOSE     PMSMUPA1
          GOTO      ENDMUP
.
          INC       IBAOVRIO/INC
          INC       PMSMUPIO/INC
.
ENDMUP    ENDPROC
+
.******************************************************************************
.*        Fix obsmdtaf & obsmtxaf - Clinical Observations Notes               *
.*                                                                            *
.*          Copy obsmdtaf & obsmtxaf records from OLDURNO to NEWURNO          *
.******************************************************************************
          DEFPROC   FIXOBSNT
.
          INC       OBSMDTFD/INC
          INC       OBSMTXFD/INC
.
NEWNOTEN  FORM      6         * New UR's Note Number
OLDNOTEN  DIM       6         * Old UR's Note Number
SAVKEY14  DIM       14
SAVKEY17  DIM       17
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OBSMDTA1,"obsmdtaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOBS
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OBSMTXA1,"obsmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENDOBS
.
FIXOBS00  PACK      KEY14,NEWURNO,Z70
          CALL      RSOBMDT1
          CALL      RPOBMDT1
          BRANCH    OVRCD,FIXOBS90
.
          MATCH     OBMDURNO,NEWURNO
          IF        !@EQUAL
            MOVE      ZERO,NEWNOTEN    * no notes exist; reset new note counter
          ELSE
            MOVE      OBMDNOTE,NEWNOTEN     * notes exist; get last counter
          ENDIF
.
.        
.         Copy the Details records from OLDURNO to NEWURNO
.
          PACK      KEY14,OLDURNO,SP70
          CALL      RSOBMDT1
FIXOBS10  CALL      RKOBMDT1
          BRANCH    OVRCD,FIXOBS90
.
          PACK      SAVKEY14,OBMDURNO,OBMDNOTE,SP70
          MATCH     OBMDURNO,OLDURNO
          GOTO      FIXOBS90 IF NOT EQUAL
.
          MOVE      OBMDNOTE,OLDNOTEN       * old note counter for free text
.
          MOVE      NEWURNO,OBMDURNO
          ADD       ONE,NEWNOTEN            * new note details record counter
          MOVE      NEWNOTEN,OBMDNOTE
          RJUSTIFY  OBMDNOTE
.
          PACK      KEY14,OBMDURNO,OBMDNOTE,SP70
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      UPOBMDT1
          TRAPCLR   IO
          BRANCH    OVRCD,FIXOBS90
.
          PACK      KEY14,SAVKEY14
          CALL      RDOBMDT1
.        
.         Now we copy the Free Text records from OLDURNO to NEWURNO; use
.         NEWURNO and new Note Number BUT preserve the unique counter from
.         OLDURNO records.
.
          PACK      KEY17,OLDURNO,OLDNOTEN,SP70
          CALL      RSOBMTX1
FIXOBS11  CALL      RKOBMTX1
          BRANCH    OVRCD,FIXOBS10
.
          PACK      SAVKEY17,OBMTURNO,OBMTNOTE,OBMTUNIQ
.
          MATCH     OBMTURNO,OLDURNO
          GOTO      FIXOBS10 IF NOT EQUAL
.
          MATCH     OBMTNOTE,OLDNOTEN
          GOTO      FIXOBS10 IF NOT EQUAL
.
          MOVE      NEWURNO,OBMTURNO
          MOVE      NEWNOTEN,OBMTNOTE
.
          PACK      KEY17,OBMTURNO,OBMTNOTE,OBMTUNIQ,SP70
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      UPOBMTX1
          TRAPCLR   IO
.
          PACK      KEY17,SAVKEY17
          CALL      RDOBMTX1
          GOTO      FIXOBS11
.
FIXOBS90  CLOSE     OBSMDTA1
          CLOSE     OBSMTXA1
          GOTO      ENDOBS
.
          INC       IBAOVRIO/INC
          INC       OBSMTXIO/INC
          INC       OBSMDTIO/INC
.
ENDOBS    ENDPROC
+
.******************************************************************************
.*                                 EREDW000                                   *
.* If any of the EDWWARD variables have changed, write/update pmsedwaf        *
.******************************************************************************
.
EREDW000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      EREDW999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      EREDW999 IF EQUAL
.
          OPEN      PMSEDWA2,"pmsedwaf"
.
          CALL      IBACLOCK
          PACK      PMEWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEWCDAT
          CLOCK     TIME,PMEWCTIM
          PACK      PMEWCUID,USERID
          PACK      PMEWSPAR,SP70,SP70
.
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RAPMEDW2
          IF        OVRCD=1
            CALL      WRPMEDW2
          ELSE
            CALL      UPPMEDW2
          ENDIF
.
EREDW999  RETURN
.
.**********************************************************************
.*             Fix webelfaf                                           *
.**********************************************************************
          DEFPROC   FIWELF
.
          INC       WEBELFFD/INC
.
FIWF0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBELFA2,"webelfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENWELF
.
          MOVE      "webelfaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIWF1000  PACK      KEY16,OLDURNO,SP30
          CALL      RSWBELF2
          CALL      RKWBELF2
          BRANCH    OVRCD,FIWF9000
.
          MATCH     OLDURNO,WBEFURNO
          GOTO      FIWF9000 IF NOT EQUAL
.
          MOVE      NEWURNO,WBEFURNO
.
          CALL      UPWBELF2
          GOTO      FIWF1000
.
FIWF9000  CLOSE     WEBELFA2
          GOTO      ENWELF
.
          INC       IBAOVRIO/INC
          INC       WEBELFIO/INC
.
ENWELF    ENDPROC
+
.**********************************************************************
.*             Fix webopvaf                                           *
.**********************************************************************
          DEFPROC   FIWOPV
.
          INC       WEBOPVFD/INC
.
SAVKEY26  DIM       26
NEWCOUNT  FORM      2
.
FIWR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBOPVA1,"webopvaf"
          TRAPCLR   IO
          BRANCH    OVRCD,ENWOPV
.
          MOVE      "webopvaf",XXFILE
          TRAP      WERR0000 NORESET GIVING XXDESC IF IO
.
FIWR1000  PACK      KEY26,OLDURNO,SP30
          CALL      RSWBOPV1
          CALL      RKWBOPV1
          BRANCH    OVRCD,FIWR9000
.
          MATCH     OLDURNO,WBOPURNO
          GOTO      FIWR9000 IF NOT EQUAL
.
          PACK      SAVKEY26,WBOPURNO,WBOPDATE,WBOPTIME,WBOPCNTR,SP70
.
          MOVE      NEWURNO,WBOPURNO
          MOVE      WBOPCNTR,NEWCOUNT
.
FIWR2000  PACK      KEY26,WBOPURNO,WBOPDATE,WBOPTIME,WBOPCNTR,SP70
          CALL      RAWBOPV1
          BRANCH    OVRCD,FIWR3000
.
          ADD       ONE,NEWCOUNT
          MOVE      NEWCOUNT,WBOPCNTR                 * Add 1 to unique counter
.
          IF        WBOPCNTR=99
            PACK      KEY26,SAVKEY26,SP70
            CALL      DEWBOPV1
            GOTO      FIWR1000
          ENDIF
          GOTO      FIWR2000
.
FIWR3000  PACK      KEY26,SAVKEY26,SP70
          CALL      RDWBOPV1
          BRANCH    OVRCD,FIWR1000
.
          MOVE      NEWURNO,WBOPURNO
          MOVE      NEWCOUNT,WBOPCNTR
.
          CALL      UPWBOPV1
          GOTO      FIWR1000
.
FIWR9000  CLOSE     WEBOPVA1
          GOTO      ENWOPV
.
          INC       IBAOVRIO/INC
          INC       WEBOPVIO/INC
.
ENWOPV    ENDPROC
+
