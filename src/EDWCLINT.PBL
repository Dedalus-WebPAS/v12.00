.******************************************************************************
.* EDWCLINT - This is a routine used by IBAPMS40 to extract NSW EDWARD        *
.*            Client Data                                                     *
.*                                                                            *
.* PARAMETERS  :                                                              *
.* RETURNS     :                                                              *
.* Mods        :                                                              *
.* V12.00.01 05/08/2025 Ebon Clements  Task 0959930                           *
.*           Set current column count F2 to ZERO  - CHKSTR00                  *
.* V11.04.02 26/08/2024 Ebon Clements  Task 0941700                           *
.*           Added trigger 01 objects - TR010000                              *
.* V11.04.01 21/06/2024 Ebon Clements  Task 0947309                           *
.*           Report last legal status for each start date                     *
.*           Obj 10 - Attr 04 -  CL100600                                     *
.* V11.03.05 03/07/2023 Ebon Clements  Task 0931366                           *
.*           Only send birth fields if the last admission prior to the        *
.*           extract end date was a birth event - CL011360 WR081000           *
.* V11.03.04 22/05/2023 Alina Bhari    Task 0926535                           *
.*           Correctly displayed the overseas country code in EDW extract     *
.*           - SADD0000,SADD1050,CL020500 
.* V11.03.03 04/05/2023 Jacob Jackson  Task 0924804                           *
.*           Report 2 new patient contacts types (3-unpaid carer, 5-sole      *
.*           dependent) - MERG3700/CL03260                                    *
.* V11.03.02 28/03/2023 Ebon Clements  Task 0926535                           *
.*           Obj 2 - Fixed postal address OS post code reporting - CL022600   *
.* V11.03.01 13/02/2023 Bella Turco    Task 0926535                           *
.*           Obj 2 - if post code is 8888 move 9990 (for SJOG)                *
.* V11.02.02 08/11/2022 Jill Parkinson Task 0923421                           *
.*           Obj 5 - report 99999999999 if pmedi is blank                     *
.* V11.02.01 13/10/2022 Ebon Clements  Task 0923424                           *
.*           Obj 8 - Report N in BIRTH_ORDER_CODE if not a new-born           *
.*           AUSR6 - CL011400 and WR082000                                    *
.* V11.02.01 24/01/2022 Jill Parkinson Task 0899679                           *
.*           Added check for obj 05 to not send if created in range           *
.* V11.01.01 06/01/2022 Jill Parkinson Task 0914424                           *
.*           Corrected check for expired cards to use blank as valid          *
.* V11.00.14 11/08/2021 Jill Parkinson Task 0893922                           *
.*           Added write of 18 for NDIS in object 10                          *
.* V11.00.13 24/08/2020 Jill Parkinson Task 0896174                           *
.*           Added pack of OBJECTTY="05" before calling NEW05000              *
.* V11.00.12 17/08/2020 Jill Parkinson Task 0895889                           *
.*           Changed interpreter to use ATTRVALU instead of D1                *
.* V11.00.11 29/06/2020 Jill Parkinson Task 0893710                           *
.*           Changed unmerge to use ptmxrdat                                  *
.* V11.00.10 25/06/2020 Jill Parkinson Task 0893710                           *
.*           Changed 09 016 to send N                                         *
.* V11.00.09 25/06/2020 Jill Parkinson Task 0893710                           *
.*           Added un-merge - send 01 and 09                                  *
.* V11.00.08 23/06/2020 Jill Parkinson Task 0893582                           *
.*           Changed 09 merges to use old ur as CLIENT_ID_RECORD_ID           *
.* V11.00.07 11/06/2020 Jill Parkinson Task 0893076                           *
.*           Changed 01 merges to use 23:58 as end time not 00:01             *
.* V11.00.06 26/05/2020 Jill Parkinson Task 0892256                           *
.*           Added send of 09 016 record for merges                           *
.* V11.00.05 24/05/2020 Jill Parkinson Task 0892256                           *
.*           Removed send of D for old ur in merges                           *
.* V11.00.04 20/05/2020 Jill Parkinson Task 0892096                           *
.*           Added write of 04 even if dva in cl01000 and also cl040000       *
.* V11.00.03 16/05/2020 Jill Parkinson Task 0891375                           *
.*           Fixed ending of object 10 attribute 04 and changes OS for state  *
.* V11.00.02 07/04/2020 Jill Parkinson Task 0890394                           *
.*           Added ptmxrdat to NEW030000 primary key for GP relationships     *
.* V11.00.01 04/04/2020 Jill Parkinson Task 0890394                           *
.*           Added MB to mother/baby and date to GP relationships             *
.* V10.15.09 26/03/2020 Jill Parkinson Task 0889929                           *
.*           Added replace of 0 with 1 for birth plurality                    *
.* V10.15.08 18/02/2020 Jill Parkinson Task 0888471 and 0888464               *
.*           Added merge writes of 04, 09 and 10 objects                      *
.*           Fixed update of medicare source modified date                    *
.* V10.15.07 12/02/2020 Ebon Clements  Task 0879283                           *
.*           Added date to NDIS EXTERNAL_CLIENT_ID_RECORD_ID - Obj 05 CL054000*
.* V10.15.06 07/02/2020 Ebon Clements  Task 0879283                           *
.*           Fixed source created/modifield date - Object 10 CL102000         *
.* V10.15.05 23/01/2020 Ebon Clements  Task 0879283                           *
.*           Added date to CLIENT_PROFILE_RECORD_ID - Object 10 CL102000      *
.* V10.15.04 23/01/2020 Ebon Clements  Task 0879283                           *
.*           Fixed NDIS details loop GOTO - Object 10 CL102000                *
.* V10.15.03 06/01/2020 Ebon Clements  Task 0879283                           *
.*           Report NDIS details on object 05 and 10 CL054000 CL102000        *
.* V10.15.02 19/12/2019 Jill Parkinson Task 0886414                           *
.*           Fixed packing of key with UR for merges                          *
.* V10.15.01 27/11/2019 Jill Parkinson Task 0884271                           *
.*           Only send 04 when clearing fund if no dva card exists            *
.* V10.14.23 22/11/2019 Jill Parkinson Task 0884280                           *
.*           Added read of cat C in SADD0000 for postcode 9990                * 
.* V10.15.03 15/11/2019 Jill Parkinson Task 0884280                           *
.*           Added pack of 0000 for overseas address if no match on cat C     *
.* V10.15.02 10/11/2019 Jill Parkinson Task 0884271                           *
.*           Fixed key to end previous 04 insurance record                    *
.*           10/11/2019 Jill Parkinson Task 0884280                           *
.*           Mods to get category C for overseas country                      *
.* V10.15.01 17/10/2019 Jill Parkinson Task 0882763                           *
.*           Added CHKSTR00 to find actual alias record that was sent for del *
.* V10.14.19 25/09/2019 Jill Parkinson Task 0881755                           *
.*           Removed sending of GP names in 03 objects                        *
.* V10.14.18 13/09/2019 Jill Parkinson Task 0881375                           *
.*           Fixed source modified date/time for 10 attribute updates         *
.* V10.14.17 10/09/2019 Jill Parkinson Task 0881375                           *
.*           Added check for ovrcd for previous address                       *
.* V10.14.16 03/09/2019 Jill Parkinson Task 0880814                           *
.*           Mods to ignore merged records if changed previously              *
.*           Mods to use previous address not always current address          *
.* V10.14.15 27/08/2019 Jill Parkinson Task 0880389                           *
.*           Corrected read of dva card number                                *
.* V10.14.14 21/08/2019 Jill Parkinson Task 0880280                           *
.*           Corrected health fund 04 writes                                  *
.*           Alias deletes to send end date                                   *
.* V10.14.13 08/08/2019 Jill Parkinson Task 0878412                           *
.*           Corrected alias deletes                                          *
.* V10.14.12 22/07/2019 Jill Parkinson Task 0878412 and 0877986               *
.*           Added alias deletes/additions and 04 insurance records           *
.* V10.14.11 17/07/2019 Jill Parkinson Task 0877083                           *
.*           Object 10 MHLS                                                   *
.* V10.14.10 28/06/2019 Jill Parkinson Task 0876602                           *
.*           Fixed ending of previous address                                 *
.* V10.14.09 15/05/2019 Jill Parkinson Task 0874143                           *
.*           Changed to send hdp equivalent 4 instead of 1 for pmcetype 03    *
.* V10.14.08 03/05/2019 Jill Parkinson Task 0874143                           *
.*           Corrected source modified date/time for 02 updates               *
.* V10.14.07 17/04/2019 Jill Parkinson Task 0873835                           *
.*           Added baby ur to mother relationship to allow multiple births    *
.* V10.14.06 17/04/2019 Jill Parkinson Task 0873055                           *
.*           Removed PATIME from objectky 02                                  *
.* V10.14.05 10/04/2019 Jill Parkinson Task 0873164                           *
.*           Corrected source modified date to use patime                     *
.* V10.14.04 01/04/2019 Jill Parkinson Task 0872599                           *
.*           Corrected source create date for 02 updates                      *
.* V10.14.03 24/03/2019 Jill Parkinson Task 0871958                           *
.*           Corrected source create date for 03 updates                      *
.* V10.14.02 20/02/2019 Tracey Nguyen  Task 0869882                           *
.*           Modified MAPREL00 to read PMSRELAF.PMRLHDPE for relationship     *
.*           mapping                                                          *
.* V10.14.01 30/01/2019 Jill Parkinson Task 0869604                           *
.*           Correct mother baby relationship values                          *
.* V10.13.19 30/01/2019 Jill Parkinson Task 0869604                           *
.*           Added mapping of relationship                                    *
.* V10.13.18 23/01/2019 Jill Parkinson Task                                   *
.*           Swapped old ur and new ur columns for merged 01 objects          *
.* V10.13.17 21/01/2019 Jill Parkinson Task 0864975                           *
.*           Added end of all object 10 before sending new values             *
.* V10.13.16 18/01/2019 Jill Parkinson Task 0864976                           *
.*           Mods to rep 1Y for pmpxedob                                      *
.* V10.13.15 17/01/2019 Jill Parkinson Task 0864976                           *
.*           Added date to medicare keys                                      *
.* V10.13.14 14/01/2019 Jill Parkinson Task 0864976                           *
.*           Added default address for quick registrations                    *
.* V10.13.13 14/01/2019 Jill Parkinson Task 0864976                           *
.*           Fixed alias key                                                  *
.* V10.13.12 09/01/2019 Jill Parkinson Task 0864975                           *
.*           populated source modified date for all objects                   *
.* V10.13.11 09/01/2019 Jill Parkinson Task 0864975                           *
.*           Rebound HD emails 08 and 09/01/19                                *
.*           estimated DOB                                                    *
.*           changed issuing auth to use ptcnnssi                             *
.* V10.13.10 18/12/2018 Jill Parkinson Task 0864975                           *
.*           Rebound doc issues 7/14/15/16                                    *
.* V10.13.09 14/12/2018 Jill Parkinson Task 0864975                           *
.*           Corrected parameter 1/parameter 2 in column 7                    *
.* V10.13.08 02/12/2018 Jill Parkinson Task 0864975                           *
.*           Added MERG0000 to end/resend client records                      *
.* V10.13.07 27/10/2018 Jill Parkinson                                        *
.*           Added setting of source created date and time                    *
.* V10.13.06 08/10/2018 Jill Parkinson Task 0862355                           *
.*           Mods to not send blank medicare                                  *
.* V10.13.05 03/10/2018 Jill Parkinson Task 0862271                           *
.*           Beta rebounds doc 3                                              *
.* V10.13.04 26/09/2018 Jill Parkinson Task 0862271                           *
.*           Beta rebounds doc 2                                              *
.* V10.13.03 21/09/2018 Jill Parkinson Task 0861535                           *
.*           Hea rebounds                                                     *
.* V10.13.02 14/09/2018 Jill Parkinson Task 0861535                           *
.*           Hea rebounds                                                     *
.* V10.13.01 06/09/2018 Jill Parkinson Task 0862271                           *
.*           Key changes as per CR                                            *
.* V10.12.14 06/09/2018 Jill Parkinson Task 0861535                           *
.*           Beta rebounds document 4                                         *
.* V10.12.13 05/09/2018 Jill Parkinson Task 0861535                           *
.*           Beta rebounds document 3                                         *
.* V10.12.12 03/09/2018 Jill Parkinson Task 0862271                           *
.*           Removed UR from column 10 for objects 03,05 and 06               *
.* V10.12.11 31/08/2018 Jill Parkinson Task 0861535                           *
.*           Rebound document 2                                               *
.* V10.12.10 30/08/2018 Jill Parkinson Task 0861535                           *
.*           Rebound document 1                                               *
.* V10.12.09 29/08/2018 Jill Parkinson Task 0861535                           *
.*           Fixed sending original GP 03 record when ur first created        *
.* V10.12.08 24/08/2018 Jill Parkinson Task 0861535                           *
.*           Mods to send gp relationships (03)                               *
.* V10.12.07 22/08/2018 Jill Parkinson Task 0862355                           *
.*           Mods to medicare reference fields                                *
.* V10.12.06 19/08/2018 Jill Parkinson Task 0854795                           *
.*           Mods to end previous 06 records                                  *
.* V10.12.05 13/08/2018 Jill Parkinson Task 0861535                           *
.*           Added setting of address_restrictions                            *
.*           Removed sending 04 and 07 blank records                          *
.*           Fixed previous address end                                       *
.* V10.12.04 02/08/2018 Jill Parkinson Task 0854795                           *
.*           Fixed sending of 06 records                                      *
.* V10.12.03 22/06/2018 Jill Parkinson Task 0854795                           *
.*           Removed packing of 11, 12 or 13 in object 01 for additions       *
.* V10.12.02 23/05/2018 Jill Parkinson Task 0854795                           *
.*           Added delete if upi alternate id no longer against patiient      *
.* V10.12.01 13/04/2018 Jill Parkinson Task 0846167                           *
.*           Added medicare eligibility write                                 *
.* V10.12.00 23/01/2018 Jill Parkinson Task 0846167                           *
.*           Created include                                                  *
.******************************************************************************
EDCL0000  CALL      CL010000 * extract 01 - Client records to 
                             * container details file
          CALL      UNMERG00 * extract 01 and 09  - Client records for unmerge
.
          CALL      CL020000 * extract 02 - Client address records to 
                             * container details file
          CALL      CL030000 * extract 03 - Client relationship records to 
                             * container details file
          CALL      CL040000 * extract 04 - Client insurance records to
                             * container details file
          CALL      CL050000 * extract 05 - Client external id records to 
                             * container details file
          CALL      CL060000 * extract 06 - Client name records to 
.                            * container details file
. extract 07  ** Client ongoing conditions not required - 
.                blank sent with 01 only **  
          CALL      CL080000 * extract 08 - Client static demographic records  
                             * to container details file
          CALL      CL090000 * extract 05 - Client externalidentifier(UPI)
                             * to container details file
. extract 10
          CALL      CL100000 * extract 10 - Client profile records  
                             * to container details file
. extract merged patients
          CALL      MERG0000
.
          CALL      TR010000 * Retrigger 01 client objects
  
EDCL9999  RETURN
+
.******************************************************************************
.*  CL010000 - Loop paturadf and extract Client Registration records 
.*  This is only sent when a new UR has been created or a UR has been merged
.*  Also requires an 
.******************************************************************************
CL010000  PACK      KEY17,ANSA,STRTDATE,SP70
          CALL      RDSURAD1         *   get new UR's in the period
CL010500  CALL      RDKURAD1
          BRANCH    OVRCD,CL019999
.
          MATCH     ANSA,URRTYPE * Is this an Addition? not change
          GOTO      CL019999 IF NOT EQUAL
.
          MATCH     URDATE,ENDDATE
          GOTO      CL019999 IF LESS
.
          PACK      KEY8,URURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL010500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL010500
.
. * ignore merged patients
          COMPARE   "1",PSTAT
          GOTO      CL010500 IF EQUAL
.
          MOVE      "01",OBJECTTY
          PACK      OBJECTKY,URURNO,SP70,SP70
          MOVE      URURNO,DIM8
          SQUEEZE   DIM8
.
          MOVE      URDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      OBJECTTX,ANS035,TILDA:   * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISSUING_AUTHORITY
			     DIM8,TILDA:     * PRIMARY_CLIENT_RECORD_ID
                             DIM10A,SP1,TIME001,TILDA: * START_DATE_TIME
                             TILDA:          * END_DATE_TIME
                             TILDA:          * REPLACED_CLIENT_ID_TYPE_CODE
                             TILDA:          * REPLACED_CLIENT_ID_ISSUING_AUTH
                             SP900     * REPLACED_PRIMARY_CLIENT_RECORD_ID
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          PACK      KEY24,PURNO,SP70
          CALL      RDSPADD1
          CALL      RDKPADD1
          IF        OVRCD<>1
            MATCH     PAURNO,PURNO
            IF        @EQUAL
              PACK      PADD1,PAADD1
              PACK      PADD2,PAADD2
              PACK      PSUBRB,PASUBR
              PACK      PADD4,PAADD4
              PACK      PPOST,PAPOST
            ENDIF
          ENDIF
          CALL      SADD0000     * send address records (02)
.
. * new client - add 03 if GP has been collected
CL011200  MATCH     SP70,PMPXRHC1
          GOTO      CL011250 IF EQUAL
.
          CALL      NEW03000   * write new 03 for GP relationship
.
. * new client - add 04 for UR
.
CL011250  MOVE      URDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      SP70,KEY1        * dva code
          MOVE      ZERO,D1          * default to no fund
          MOVE      "None",KEY24
          PACK      D3,ZERO,ZERO,ZERO
          MATCH     SP70,PFUNDH
          IF        !@EQUAL
            MOVE      NINE,D1
            PACK      D3,ZERO,NINE,NINE
            MOVE      "Unknown",KEY24
          ELSE
. * write no fund record - task 0892096
            PACK      SRCRDATE,PTMXRDAT,SP70
            PACK      SRCRTIME,TIME001,SP70
            PACK      SRMDDATE,PTMXRDAT,SP70
            PACK      SRMDTIME,TIME001,SP70
            CALL      WR040000
.
            CALL      CHDV0000   * send dva if it exists
            IF        EXIT=1
              MOVE      ANSD,D1
              PACK      D3,ZERO,TWO,THREE
              PACK      KEY24,PMCDCNUM,SP70
              PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                PACK     KEY1,THCSCOD
              ENDIF
            ENDIF
          ENDIF
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WR040000
.
. * new client - add 05 for external identifier info
CL011300  MATCH     SP70,PMEDI
          IF        @EQUAL
            REP       " 9",PMEDI
            PACK      PTMXMCCD,NINE,SP70
          ENDIF
          CALL      NWMEDI00
.
. * new client - add 06 for patient name
.
CL011350  CALL      NEW06000
.
. * new client - add 09 for UR (004)
. 
          MOVE      URDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      "09",OBJECTTY
          PACK      OBJECTKY,PURNO,ZERO,ZERO,FOUR,SP70
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM8,DASH,ZERO,ZERO,FOUR,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ZERO,FOUR,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * CLIENT_ID
                             ANSY,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
. * new client - add 09 for UR (016)
.
          MOVE      "09",OBJECTTY
          PACK      OBJECTKY,PURNO,ZERO,ONE,SIX,SP70
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM8,DASH,ZERO,ONE,SIX,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * CLIENT_ID
                             ANSY,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
. * new client - add 08 for client static demographics
          MOVE      "08",OBJECTTY
          PACK      OBJECTKY,URURNO,SP70,SP70
          SQUEEZE   URDATE
          MOVE      SP70,DIM4   
          MATCH     SP70,PCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PCONT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      THCSCOD,DIM4
            ENDIF
          ENDIF
          REP       " 0",DIM4
          STRIP     DIM4
          MOVE      ANSN,KEY1
          MOVE      SP70,DIM1
          COMPARE   "1",PCEASE
          IF        @EQUAL
            PACK      KEY1,ANSY
            PACK      DIM1,ANSN
            MATCH     ANSY,PTMAUKDD
            IF        @EQUAL
              PACK      DIM1,ANSY
            ENDIF
          ENDIF
          MOVE      URURNO,DIM8
          SQUEEZE   DIM8
          STRIP     THCSCOD
          STRIP     PDECDTE
          STRIP     DIM1
          STRIP     KEY1
. map patient sex
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXNO,D1
          REP       "49",D1
.
. only send birth fields if last admission was birth event (cat CC hcp=70)
.
          PACK      KEY17,PURNO,Z70
          CALL      RSPTMI18
CL011360  CALL      RPPTMI18
          BRANCH    OVRCD,CL011400
.
          MATCH     PURNO,AURNO
          GOTO      CL011400 IF NOT EQUAL
.
          COMPARE   "5",ASTAT               * Skip cancelled amission
          GOTO      CL011360 IF EQUAL
.
          MATCH     ADATE,ENDDATE           * First admission prior to extra
          GOTO      CL011360 IF LESS        * end date, eg the last admission
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL011400
.
          MATCH     "70",PTCDNHCP
          GOTO      CL011400 IF NOT EQUAL
.
          MOVE      APLUR,CODINGST
          REP       "01",CODINGST
          SQUEEZE   AUSR6
          PACK      DIM9,ABWGHT,DOT,ZERO,ZERO
          GOTO      CL011500
.
CL011400  MOVE      SP70,APLUR
          MOVE      ANSN,AUSR6
          MOVE      SP70,DIM9
          MOVE      SP70,CODINGST
.
CL011500  SQUEEZE   CODINGST
          SQUEEZE   DIM9
          SQUEEZE   AUSR6
.
          REP       " N",PMPXEDOB
          REP       "0N1Y",PMPXEDOB
          PACK      OBJECTTX,ANS035,TILDA:    * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:  * ISSUING_AUTHORITY
                             DIM8,TILDA:      * CLIENT_RECORD_ID
                             D1,TILDA:        * SEX_CODE
                             PBDATE,TILDA:    * DATE_OF_BIRTH
                             DIM4,TILDA:      * COUNTRY_OF_BIRTH_CODE
                             PMPXEDOB,TILDA:  * DATE_OF_BIRTH_ESTIMATION_FLAG
                             AUSR6,TILDA:     * BIRTH_ORDER_CODE
                             CODINGST,TILDA:  * BIRTH_PLURALITY_CODE
                             DIM9,TILDA:      * BIRTH_WEIGHT
                             PDECDTE,TILDA:   * DATE_OF_DEATH
                             DIM1,TILDA:      * DATE_OF_DEATH_ESTIMATION_FLAG
                             KEY1,SP70,SP70   * DECEASED_FLAG
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
          PACK      STRATRD,URDATE
          PACK      ENDATRD,SP70  
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          MOVE      "01",ATTRTYPE
          MOVE      PMPXABRG,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "02",ATTRTYPE
          MOVE      PMSTAT,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "05",ATTRTYPE
          MOVE      PTYPE,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "06",ATTRTYPE
          MOVE      "01",ATTRVALU
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      GOVP0000  * check for government
          IF        EXIT=0
            PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
            PACK      SRMDDATE,PTMXRDAT,SP70
            PACK      SRMDTIME,TIME001,SP70
            CALL      WRPROF00     * write profile attribute records
          ENDIF
.
          MOVE      "07",ATTRTYPE
          MOVE      PMPXLNG1,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "08",ATTRTYPE
          MOVE      PREG,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "13",ATTRTYPE
          MOVE      ANSN,ATTRVALU
          CMATCH    "1",PMPXINTR
          IF        @EQUAL
            MOVE      ANSY,ATTRVALU
          ENDIF
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRPROF00     * write profile attribute records
.
          GOTO      CL010500
.
CL019999  RETURN
.
.******************************************************************************
.*  TR010000 - Retrigger client 01 object
.******************************************************************************
TR010000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
TR011000  CALL      RKPMEDW1
          BRANCH    OVRCD,TR019999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      TR019999 IF LESS
.
          MATCH     "29 ",PMEWTYPE           * Trigger 01 object
          GOTO      TR011000 IF NOT EQUAL
.
          PACK      KEY17,PMEWURNO,ANSA,SP70
          CALL      RDSURAD2
          CALL      RDKURAD2                * Read Add U/R Audit Record
          BRANCH    OVRCD,TR011000
.
          MATCH     PMEWURNO,URURNO         * Correct U/R
          GOTO      TR011000 IF NOT EQUAL
.
          MATCH     ANSA,URRTYPE            * Add
          GOTO      TR011000 IF NOT EQUAL
.
          PACK      KEY8,URURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,TR011000
.
          CALL      RDPMPX21
          BRANCH    OVRCD,TR011000
.
. * ignore merged patients
.
          COMPARE   "1",PSTAT
          GOTO      TR011000 IF EQUAL
.
          MOVE      "01",OBJECTTY
          PACK      OBJECTKY,URURNO,SP70,SP70
          MOVE      URURNO,DIM8
          SQUEEZE   DIM8
.
          MOVE      URDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      OBJECTTX,ANS035,TILDA:   * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISSUING_AUTHORITY
                             DIM8,TILDA:     * PRIMARY_CLIENT_RECORD_ID
                             DIM10A,SP1,TIME001,TILDA: * START_DATE_TIME
                             TILDA:          * END_DATE_TIME
                             TILDA:          * REPLACED_CLIENT_ID_TYPE_CODE
                             TILDA:          * REPLACED_CLIENT_ID_ISSUING_AUTH
                             SP900     * REPLACED_PRIMARY_CLIENT_RECORD_ID
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70  
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      TR011000
.
TR019999  RETURN
.
.******************************************************************************
.*  Check for government pensions
.******************************************************************************
GOVP0000  MOVE      ZERO,EXIT * no records
          MOVE      ZERO,F1  * 99 sent?
          MOVE      ZERO,D1  * 18 sent?
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1
GOVP1000  CALL      RKPMCCD1
          BRANCH    OVRCD,GOVP9999
.
          MATCH     PURNO,PMCDURNO
          GOTO      GOVP9999 IF NOT EQUAL
.
          PACK      KEY5,LOWC,LOWT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GOVP9999
.
          MATCH     SP70,PMCDEXDT   * only check expiry if entered
          IF        !@EQUAL
            MATCH     ENDDATE,PMCDEXDT  * expired before end of extract
            GOTO      GOVP1000 IF LESS
          ENDIF
.
          MATCH     "1",TCINDC1  * centrelink
          GOTO      GOVP9000 IF EQUAL
          MATCH     "3",TCINDC1  * dva
          GOTO      GOVP9000 IF EQUAL
          MATCH     "7",TCINDC1  * ndis
          GOTO      GOVP9100 IF EQUAL
          GOTO      GOVP1000
.
GOVP9000  COMPARE   ONE,F1
          GOTO      GOVP1000 IF EQUAL   * already sent 99
          MOVE      "99",ATTRVALU
          MOVE      ONE,F1
          GOTO      GOVP9200
.
GOVP9100  MATCH     "1",D1
          GOTO      GOVP1000 IF EQUAL   * already sent 18
          MOVE      "18",ATTRVALU
          MOVE      ONE,D1
          GOTO      GOVP9200
.
GOVP9200  PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
          MOVE      ONE,EXIT
          GOTO      GOVP1000
.
GOVP9999  RETURN
+
.******************************************************************************
.*  Send un-merge changes
.******************************************************************************
UNMERG00  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
UNMERG10  CALL      RKPMEDW1
          BRANCH    OVRCD,UNMERG99
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      UNMERG99 IF LESS
.
          MATCH     "24",PMEWTYPE
          GOTO      UNMERG10 IF NOT EQUAL
.
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UNMERG10
          CALL      RDPMPX21
          BRANCH    OVRCD,UNMERG10
.
. * ignore merged patients
          COMPARE   "1",PSTAT
          GOTO      UNMERG10 IF EQUAL
.
          MOVE      "01",OBJECTTY
          PACK      OBJECTKY,PMEWURNO,SP70,SP70
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
.
          MOVE      PTMXRDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      OBJECTTX,ANS035,TILDA:   * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISSUING_AUTHORITY
                             DIM8,TILDA:     * PRIMARY_CLIENT_RECORD_ID
                             DIM10A,SP1,TIME001,TILDA: * START_DATE_TIME
                             TILDA:          * END_DATE_TIME
                             TILDA:          * REPLACED_CLIENT_ID_TYPE_CODE
                             TILDA:          * REPLACED_CLIENT_ID_ISSUING_AUTH
                             SP900     * REPLACED_PRIMARY_CLIENT_RECORD_ID
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      "09",OBJECTTY
          PACK      OBJECTKY,PURNO,ZERO,ZERO,FOUR,SP70
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM8,DASH,ZERO,ZERO,FOUR,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ZERO,FOUR,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * CLIENT_ID
                             ANSY,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
          PACK      OBJECTKY,PURNO,ZERO,ONE,SIX,SP70
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
.
          MOVE      PTMXRDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM8,DASH,ZERO,ONE,SIX,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * CLIENT_ID
                             ANSY,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             SP900   * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
UNMERG99  RETURN
+
.******************************************************************************
.*  Corrected health fund 04 writes
.******************************************************************************
WR040000  MOVE      "04",OBJECTTY
          PACK      OBJECTKY,PURNO,D1,DIM10A,SP70
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          STRIP     KEY24
          STRIP     KEY1
          PACK      KEY10,DIM10A
          REP       "- ",KEY10 
          SQUEEZE   KEY10
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             D1,DIM10A,TILDA:    * CLIENT_INSURANCE_RECORD_ID
                             D3,TILDA:           * INSURANCE_FUND_CODE
                             D1,TILDA:           * INSURANCE_TYPE_CODE
                             KEY24,TILDA:        * INSURANCE_FUND_MEMBER_ID
                             KEY1,TILDA:         * DVA_INSURANCE_COVER_CODE
                             KEY10,TILDA:        * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          CALL      WRCOND00     * write record to container detail table
.
WR049999  RETURN
+
.******************************************************************************
.*  NEW03000 - Write new 03 object              
.******************************************************************************
NEW03000  MOVE      "03",OBJECTTY
          SQUEEZE   PMPXRHC1
          PACK      OBJECTKY,PURNO,PMPXRHC1,SP70
          UNPACK    PMPXRHC1,DIM10
          STRIP     DIM10
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
.
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,NEW03999
.
          STRIP     PMHCSNAM
          STRIP     PMHCGNAM
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM10,PTMXRDAT,TILDA:*CLIENT_RELATIONSHIP_RECORD_ID
                             TWO,TILDA: * RELATED_PERSON_ROLE_TO_CLIENT_CODE
                             NINE,ANSD,TILDA:*RELATED_PERSON_RELATIONSHIP_TO_CLI
                             TILDA: * RELATED_PERSON_FAMILY_NAME
                             TILDA: * RELATED_PERSON_GIVEN_NAME
                             TILDA: * RELATED_PERSON_DATE_OF_BIRTH
                             TILDA: * RELATED_PRIMARY_CLIENT_ID_TYPE_CODE
                             TILDA: * RELATED_PRIMARY_CLIENT_ID_ISSUING_AUTH
                             TILDA:*RELATED_PRIMARY_CLIENT_RECORD_ID
                             ANS035,TILDA:       * RELATED_ISP_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * RELATED_ISP_SOURCE_ID
                             DIM10,TILDA:        * RELATED_ISP_ID
                             PTMXRDAT,TILDA:     * RELATIONSHIP_START_DATE
                             SP900               * RELATIONSHIP_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
NEW03999  RETURN
+
.******************************************************************************
.*  NWMEDI00 - Write records for medicare number 05
.******************************************************************************
NWMEDI00  MOVE      "05",OBJECTTY
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          SQUEEZE   PTMXMCCD
          PACK      OBJECTKY,PURNO,PMEDI,PTMXMCCD,PTMXRDAT,SP70
          STRIP     PMEDI
          PACK      OBJECTTX,ANS035,TILDA:   * CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:     * RECORD_ID
                             PMEDI,PTMXRDAT,TILDA:  * EXT_CLIENT_ID_RECORD_ID
                             ZERO,ONE,EIGHT,TILDA:   * CLIENT_ID_TYPE_CODE
                             THREE,ZERO,ZERO,THREE,THREE,FIVE,SEVEN,TILDA:
                             PMEDI,PTMXMCCD,TILDA:    * EXTERNAL_CLIENT_ID
                             PTMXRDAT,TILDA:   * START_DATE
                             SP900     * END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
NWMEDI99  RETURN
+
.******************************************************************************
.*  NEW06000 - Write records for names 06
.******************************************************************************
NEW06000  MOVE      "06",OBJECTTY
          MOVE      ZERO,RECCOUNT
          PACK      OBJECTKY,PURNO,ANSL,RECCOUNT,SP70
          PACK      KEY16,RECCOUNT
          SQUEEZE   KEY16
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          STRIP     PTMASNAM
          STRIP     PMPXFNAM
          STRIP     PMPXSNAM
          STRIP     PTITL
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA: * PRIMARY_CLIENT_RECORD_ID
                             ANSL,KEY16,TILDA:   * CLIENT_NAME_RECORD_ID
                             ANSL,TILDA:         * NAME_TYPE_CODE
                             PTMASNAM,TILDA:     * FAMILY_NAME
                             PMPXFNAM,TILDA:     * GIVEN_NAME
                             PMPXSNAM,TILDA:     * MIDDLE_NAMES
                             PTITL,TILDA:        * NAME_TITLE
                             URDATE,TILDA:       * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
NEW06999  RETURN
+
.******************************************************************************
.*  MERG0000 - Write records for merged patients
.******************************************************************************
MERG0000  PACK      KEY25,STRTDATE,SP70
          CALL      RSPTMRG3         *   get merged UR's in the period
MERG2100  CALL      RKPTMRG3
          BRANCH    OVRCD,MERG9999
.
          MATCH     PTMRRDTE,ENDDATE
          GOTO      MERG9999 IF LESS
.
          PACK      KEY8,PTMROLUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
.
. ** check if the old UR details were kept and set DETLKEPT accordingly
          CALL      CHKDK000
.
MERG2500  MOVE      "01",OBJECTTY
          PACK      OBJECTKY,PTMROLUR,SP70,SP70
          MOVE      PTMROLUR,DIM8
          SQUEEZE   DIM8
          MOVE      PTMRNWUR,DIM8A
          SQUEEZE   DIM8A
.
          MOVE      PTMRRDTE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      PTMXRDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
.
. write 01 for old ur
          PACK      OBJECTTX,ANS035,TILDA:    * PRIMARY_CLIENT_ID_TYPE
                             PTCNNSSI,TILDA:  * ISSUING_AUTHORITY
                             DIM8,TILDA:      * PRIMARY_CLIENT_RECORD_ID
                             DIM10B,SP1,TIME001,TILDA:  * MAJOR_CLIENT_START_DT
                             DIM10A,SP1,TIME058,TILDA:  * MAJOR_CLIENT_END_DT
                             ANS035,TILDA:   * REPLACED_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISSUING_AUTHORITY
                             DIM8A,SP900     * REPLACED_RECORD_ID
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ONE,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
.* commented out for task 0892256
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "02 ",CHANGOBJ                     * RELATIONSHIP        
.         MOVE      "21",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,KEY8,SP70,SP70            * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      CSOF0000           * Change sent stream object field
.
.
. * if old ur details were kept, resend 02 objects for new UR
          IF        DETLKEPT=1
            MOVE      PTMRNWUR,DIM8
            MOVE      SP70,DIM8C
            CALL      ME020000 * resend 02 object for new UR with no end date
          ENDIF
.
. * end 03 for client identifier
MERG3000  
. * commented out for 0892256
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "03 ",CHANGOBJ                     * RELATIONSHIP        
.         MOVE      "22",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,KEY8,SP70,SP70            * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      CSOF0000           * Change sent stream object field
.
. * if old ur details were kept, delete new ur 03 and resend 03 objects
          IF        DETLKEPT<>1
            GOTO      MERG4000
          ENDIF
.         MOVE      "1  ",DELETSTM                     * 1=Client
.         MOVE      "03 ",DELETOBJ                     * Relationship
.         PACK      DELETKEY,PTMRNWUR,SP70      
.         CALL      EDDK0000
.
          PACK      KEY8,PTMRNWUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          MATCH     SP70,PMPXRHC1
          IF        !@EQUAL
             CALL     NEW03000
          ENDIF
.
          PACK      KEY14,PTMRNWUR,SP70
          CALL      RSPMCEX1
MERG3700  CALL      RKPMCEX1
          BRANCH    OVRCD,MERG4000
.
          MATCH     PTMRNWUR,PMCEURNO
          GOTO      MERG4000 IF NOT EQUAL
.
. * only send hdp 1,2 or 9 records
          PACK      KEY5,LOWT,LOWC,PMCETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MERG3700
.
          MATCH     "4",THCSCOD
          GOTO      MERG3800 IF EQUAL
.
          MATCH     "3",THCSCOD
          GOTO      MERG3800 IF EQUAL      
.
          MATCH     "2",THCSCOD
          GOTO      MERG3800 IF EQUAL
.
          MATCH     "5",THCSCOD
          GOTO      MERG3800 IF EQUAL
.
          MATCH     "9",THCSCOD
          GOTO      MERG3700 IF NOT EQUAL
.
MERG3800  MOVE      "03",OBJECTTY
          PACK      KEY8,PMCEURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          PACK      SRCRDATE,PMCECDAT,SP70
          PACK      SRCRTIME,PMCECTIM,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
.
          CALL      NEWCE000
          GOTO      MERG3700
.
. * end 04 for client identifier
MERG4000  
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "04 ",CHANGOBJ                     * RELATIONSHIP
.         MOVE      "12",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,KEY8,SP70,SP70            * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. * send deletes for old UR 05 - no end date required
MERG5000  
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "05 ",CHANGOBJ                     * RELATIONSHIP
.         MOVE      "14",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,KEY8,SP70,SP70            * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      CSOF0000           * Change sent stream object field
.
. * if old ur details were kept, resend 05 object for new UR
          IF        DETLKEPT<>1
            GOTO      MERG6000
          ENDIF
.
          PACK      KEY8,PTMRNWUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          MATCH     SP70,PMEDI
          IF        @EQUAL
            REP       " 9",PMEDI
            PACK      PTMXMCCD,NINE,SP70
          ENDIF
          CALL      NWMEDI00
.
          CALL      M05N0000     * New Object 05 - NDIS details
.
          PACK      KEY27,PTMRNWUR,ONE,SIX,SP70
          CALL      RSPMEDW2
MERG5500  CALL      RKPMEDW2
          BRANCH    OVRCD,MERG6000
.
          MATCH     PTMRNWUR,PMEWURNO
          GOTO      MERG6000 IF NOT EQUAL
.
          MATCH     "16 ",PMEWTYPE
          GOTO      MERG6000 IF NOT EQUAL
.
          MOVE      "05",OBJECTTY
          PACK      OBJECTKY,PMEWURNO,PMEWNEWV,SP70,SP70
          UNPACK    PMEWNEWV,DIM8,DIM3,DIM20
          MOVE      PMEWURNO,DIM8
          CALL      NEW05000
.
. * end 06 for client identifier
MERG6000  
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "06 ",CHANGOBJ                     * CLIENT_NAME
.         MOVE      "16",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,KEY8,SP70,SP70            * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      CSOF0000           * Change sent stream object field
.
. * if old ur details were kept, resend 06 object for new UR
          IF        DETLKEPT<>1
            GOTO      MERG8000
          ENDIF
.
          PACK      KEY8,PTMRNWUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          CALL      NEW06000
.
. * send delete for old UR 08 - no end date required
MERG8000  
.         MOVE      "1  ",DELETSTM                     * 1=Client
.         MOVE      "08 ",DELETOBJ                     * EXTERNAL_ID 
.         PACK      DELETKEY,PTMROLUR,SP70             * Change column
.         CALL      EDDK0000
.
. * if old ur details were kept, resend 08 object for new UR
          IF        DETLKEPT<>1
            GOTO      MERG9000
          ENDIF
.
          PACK      KEY8,PTMRNWUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WR080000
.
. * end 09 for client identifier
. * merged client - add 09 for UR (004)
.
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "09 ",CHANGOBJ                     * CLIENT_NAME
.         MOVE      "15",CHANGCOL                      * Change column
.         MOVE      PTMRRDTE,DATFIELD
.         CALL      FMTD0000
.         MOVE      FORMATDT,DIM10A
.
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         PACK      CHANGNVL,DIM10A,SP1,TIME058        * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,ZERO,FOUR,SP70,SP70  * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "09 ",CHANGOBJ                     * CLIENT_NAME
.         MOVE      "15",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         PACK      CHANGNVL,DIM10A,SP1,TIME058        * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,ONE,SIX,SP70,SP70  * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. * end 09 for client identifier
. * merged client - add 09 for UR (004)
.
MERG9000  MOVE      "09",OBJECTTY
          PACK      KEY8,PTMROLUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG9999
.
          PACK      OBJECTKY,PTMRNWUR,ZERO,ZERO,FOUR,SP70
          MOVE      PTMRNWUR,DIM8
          SQUEEZE   DIM8
          MOVE      PTMROLUR,KEY8
          SQUEEZE   KEY8
.
          MOVE      PTMXRDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      PTMRRDTE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             KEY8,DASH,ZERO,ZERO,FOUR,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ZERO,FOUR,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             KEY8,TILDA:         * CLIENT_ID
                             ANSN,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             DIM10B,SP1,TIME058,SP900   * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
          PACK      OBJECTKY,PTMRNWUR,ZERO,ONE,SIX,SP70
          MOVE      PTMRNWUR,DIM8
          SQUEEZE   DIM8
          MOVE      PTMROLUR,KEY8
          SQUEEZE   KEY8
.
          MOVE      PTMXRDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      PTMRRDTE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             KEY8,DASH,ZERO,ONE,SIX,TILDA:*CLIENT_ID_RECORD_ID
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_RECORD_TYPE_CODE
                             PTCNNIAI,TILDA:     * ISSUING_AUTHORITY
                             KEY8,TILDA:         * CLIENT_ID
                             ANSN,TILDA:         * CLIENT_ID_MAJOR_FLAG
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATE
                             DIM10B,SP1,TIME058,SP900   * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
. * end 10 for client identifier
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
. attribute type 01
.         PACK      CHANGKEY,PTMROLUR,ZERO,ONE,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 02
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,TWO,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 05
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,FIVE,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 06
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,SIX,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 07
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,SEVEN,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 08
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,EIGHT,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. attribute type 13
.         MOVE      ANSD,OBJECTRT
.         MOVE      "1  ",CHANGSTM                     * 1=Client
.         MOVE      "10 ",CHANGOBJ                     * CLIENT_PROFILE
.         MOVE      "13",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * Change old U/R value
.         MOVE      PTMRRDTE,CHANGNVL                  * Change new U/R value
.         PACK      KEY8,PTMROLUR,SP70
.         PACK      CHANGKEY,PTMROLUR,ZERO,ONE,THREE,SP70,SP70 * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         PACK      SRMDDATE,PTMRRDTE,SP70
.         PACK      SRMDTIME,TIME058,SP70
.         CALL      LSOF0000           * Change sent stream object field
.
. * if old ur details were kept, resend 10 object for new UR
          IF        DETLKEPT<>1
            GOTO      MERG2100
          ENDIF
.
          PACK      KEY8,PTMRNWUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MERG2100
          CALL      RDPMPX21
          BRANCH    OVRCD,MERG2100
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
.
          PACK      STRATRD,PTMXRDAT
          PACK      ENDATRD,SP70
          MOVE      "01",ATTRTYPE
          MOVE      PMPXABRG,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "02",ATTRTYPE
          MOVE      PMSTAT,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "05",ATTRTYPE
          MOVE      PTYPE,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "07",ATTRTYPE
          MOVE      PMPXLNG1,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "08",ATTRTYPE
          MOVE      PREG,ATTRVALU
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.
          MOVE      "13",ATTRTYPE
          MOVE      ANSN,ATTRVALU
          CMATCH    "1",PMPXINTR
          IF        @EQUAL
            MOVE      ANSY,ATTRVALU
          ENDIF
          PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
          CALL      WRPROF00     * write profile attribute records
.    
          CALL      M10N0000     * Object 10 - NDIS details
.
          GOTO      MERG2100
.
MERG9999  RETURN
+
.******************************************************************************
.*  M05N0000 - Write object 05 NDIS details for a merge
.******************************************************************************
M05N0000  PACK      KEY35,PURNO,SP70
          CALL      RSPTATR3
M05N1000  CALL      RKPTATR3
          BRANCH    OVRCD,M05N9999
.
          MATCH     PTARURNO,PURNO               * Correct U/R
          GOTO      M05N9999 IF NOT EQUAL
.
          MATCH     "020",PTARTYPE               * NDIS
          GOTO      M05N1000 IF NOT EQUAL
.
          MATCH     "1",PTARDELR                 * Record marked as deleted
          GOTO      M05N1000 IF EQUAL
.
          MOVE      "05",OBJECTTY
          PACK      OBJECTKY,PTARURNO,PTARDATE,PTARTIME,PTARTXT1,SP70
.
          MOVE      PTARURNO,DIM8                * U/R
          SQUEEZE   DIM8
          SQUEEZE   PTARTXT1                     * NDIS Number
          PACK      DIM20,PTARTXT1,PTARDATE,SP70 * NDIS Number and start date
          SQUEEZE   DIM20
          SQUEEZE   PTARDATE                     * Start Date
          SQUEEZE   PTARFDTE                     * End Date
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTH
                             DIM8,TILDA:         * CLIENT_RECORD_ID
                             DIM20,TILDA:        * EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,SIX,ZERO,TILDA:* TYPE_CODE
                             THREE,ZERO,TWO,SEVEN,SIX,FIVE,SIX,TILDA:
                             PTARTXT1,TILDA:     * EXTERNAL_CLIENT_ID
                             PTARDATE,TILDA:     * EFFECTIVE_START_DATE
                             PTARFDTE,SP900      * END_DATE
.
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      M05N1000
.
M05N9999  RETURN
+
.******************************************************************************
.*  M10N0000 - Write object 10 NDIS details for a merge
.******************************************************************************
M10N0000  PACK      KEY35,PURNO,SP70
          CALL      RSPTATR3
M10N1000  CALL      RKPTATR3
          BRANCH    OVRCD,M10N9999
.
          MATCH     PTARURNO,PURNO               * Correct U/R
          GOTO      M10N9999 IF NOT EQUAL
.
          MATCH     "020",PTARTYPE               * NDIS
          GOTO      M10N1000 IF NOT EQUAL
.
          MATCH     "1",PTARDELR                 * Record marked as deleted
          GOTO      M10N1000 IF EQUAL
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "17",ATTRTYPE         * NDIS Plan Manager
            MOVE      PTARCOD2,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ENDIF
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "18",ATTRTYPE         * NDIS Status
            MOVE      PTARCOD1,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ENDIF
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD3
          IF        !@EQUAL
            MOVE      "20",ATTRTYPE         * Disabliliyt or Impairment staus
            MOVE      PTARCOD3,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ENDIF
.
          GOTO      M10N1000
.
M10N9999  RETURN
+
.******************************************************************************
.*  SADD0000 - Write Address records
.******************************************************************************
. * add 02 for usual address info
SADD0000  MATCH     SP70,PADD1
          IF        @EQUAL
            MOVE      "NFIA",PSUBRB
            MOVE      "9999",PPOST
            MOVE      "NFD",PADD4
            MOVE      "1101",COUNTRY
          ENDIF
.
          MATCH     "NFIA",PSUBRB
          IF        @EQUAL
            MOVE      "NFD",PADD4
            MOVE      "9999",PPOST
          ENDIF
.
          MATCH     "NFA",PSUBRB
          IF        @EQUAL
            MOVE      "NFA",PADD4
            MOVE      "9998",PPOST
          ENDIF
.
          MOVE      "1101",COUNTRY
          MOVE      "02",OBJECTTY
          PACK      OBJECTKY,URURNO,ONE,SP70
          MOVE      ANSN,ADDRESFL
          CALL      GETADD00
.
          MATCH     "8888",PPOST
          IF        @EQUAL
            MOVE      "9990",PPOST     * SJOG use 8888 for OS
          ENDIF
.
          MATCH     "9990",PPOST       * HEA use 9990 for OS
          IF        @EQUAL
            PACK      COUNTRY,ZERO,ZERO,ZERO,ZERO
            PACK      PTCDKEY2,ANSC,SP1,PADD4,SP70
            CALL      RDSCODE2
            CALL      RDKCODE2
            IF        OVRCD<>1
              MATCH     "C ",TCODE
              IF        @EQUAL
                MATCH     TDESC,PADD4
                IF        @EQUAL 
                  MATCH     SP70,PTCDASC1
                  IF        !@EQUAL
                    PACK      COUNTRY,PTCDASC1,SP70
                  ELSE
                    PACK      COUNTRY,THCSCOD,SP70
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            PACK      PADD4,ANSO,ANSS,SP70 *  0891375
          ENDIF
          PACK      DIM8,PURNO
          SQUEEZE   DIM8
          STRIP     PADD1
          STRIP     PADD2
          STRIP     PSUBRB
          STRIP     PPOST
          STRIP     PADD4
          STRIP     COUNTRY
          PACK      OBJECTTX,ANS035,TILDA:   * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISSUING_AUTHORITY
                             DIM8,TILDA:     * CLIENT_ID
                             ONE,PTMXRDAT,TILDA: * CLIENT_ADDRESS_RECORD_ID
                             ONE,TILDA:       * ADDRESS_TYPE_CODE
                             PADD1,SP1,PADD2,TILDA: * ORIGINAL_ADDRESS
                             PSUBRB,TILDA:    * ORIGINAL_SUBURB
                             PPOST,TILDA:    * ORIGINAL_POSTCODE
                             PADD4,TILDA:    * ORIGINAL_STATE
                             TILDA:    * ORIGINAL_LATITIDE
                             TILDA:    * ORIGINAL_LONGITUDE
                             TILDA:    * ORIGINAL_DELIVERY_POINT_ID
                             COUNTRY,TILDA:    * COUNTRY_OF_ADDRESS_CODE
                             ADDRESFL,TILDA:    * ADDRESS_RESTRICTION_FLAG
                             URDATE,TILDA:    * EFFECTIVE_START_DATE
                             SP900    * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
.. modified date set before calling
          CALL      WRCOND00     * write record to container detail table
.
. * add 02 for mailing address info
SADD1000  PACK      KEY14,PURNO,SP70
          CALL      RSPMCEX1
SADD1050  CALL      RKPMCEX1
          BRANCH    OVRCD,SADD9999
.
          MATCH     PURNO,PMCEURNO
          GOTO      SADD9999 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV         * ignore inactive addresses
          GOTO      SADD1050 IF EQUAL
.
          PACK      KEY5,LOWT,LOWC,PMCETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SADD1050
.
          MATCH     "2",TCINDC1
          GOTO      SADD1050 IF NOT EQUAL
.
          MOVE      "02",OBJECTTY
          PACK      OBJECTKY,PURNO,THREE,PMCEWPID,SP70
          MOVE      ANSN,ADDRESFL
          CALL      GETADD00
          PACK      DIM4,COUNTRY
.
          MATCH     "8888",PMCEPOST
          IF        @EQUAL
            MOVE      "9990",PMCEPOST  * SJOG use 8888 for OS
          ENDIF
.
          MATCH     "9990",PMCEPOST    * HEA use 9990 for OS
          IF        @EQUAL
            PACK      DIM4,ZERO,ZERO,ZERO,ZERO
            PACK      PTCDKEY2,ANSC,SP1,PMCEADD4,SP70
            CALL      RDSCODE2
            CALL      RDKCODE2
            IF        OVRCD<>1
              MATCH     "C ",TCODE
              IF        @EQUAL
                MATCH     TDESC,PMCEADD4
                IF        @EQUAL
                  MATCH     SP70,PTCDASC1
                  IF        !@EQUAL
                    PACK      DIM4,PTCDASC1,SP70
                  ELSE
                    PACK      DIM4,THCSCOD,SP70
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            PACK      PMCEADD4,ANSO,ANSS,SP70 *  0891375
          ENDIF
.
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          STRIP     PMCEADD1
          STRIP     PMCEADD2
          STRIP     PMCEADD3
          STRIP     PMCEADD4
          STRIP     PMCEPOST
          SQUEEZE   PMCEWPID
          PACK      OBJECTTX,ANS035,TILDA:
                             PTCNNSSI,TILDA:  *ISSUING_AUTHORITY
                             DIM8,TILDA:
                             THREE,PMCEWPID,TILDA: *CLIENT_ADDRESS_RECORD_ID
                             THREE,TILDA:
                             PMCEADD1,SP1,PMCEADD2,TILDA:
                             PMCEADD3,TILDA:
                             PMCEPOST,TILDA:
                             PMCEADD4,TILDA:
                             TILDA:
                             TILDA:
                             TILDA:
                             DIM4,TILDA:
                             ADDRESFL,TILDA:
                             PMCECDAT,TILDA:
                             PMCEDINA,SP900
.
          PACK      SRCRDATE,PMCECDAT,SP70
          PACK      SRCRTIME,PMCECTIM,SP70
          PACK      SRMDDATE,PMCECDAT,SP70
          PACK      SRMDTIME,PMCECTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
SADD9999  RETURN
+
.******************************************************************************
.*  WRPROF00 - Write Profile attribute record
.******************************************************************************
WRPROF00  MOVE      "10",OBJECTTY
          STRIP     ATTRTYPE
          STRIP     ATTRVALU
. Indigenous status
          MATCH     "01",ATTRTYPE
          IF        @EQUAL
            PACK      KEY5,ANSV,ANSA,ATTRVALU,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    THCSCOD,DIM1
              PACK      ATTRVALU,DIM1,SP70
            ENDIF
          ENDIF
.
. Marital status
          MATCH     "02",ATTRTYPE
          IF        @EQUAL
            PACK      KEY5,ANSM,SP1,ATTRVALU,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    THCSCOD,D1,D1,DIM1
              PACK      ATTRVALU,DIM1,SP70
            ENDIF
          ENDIF
.
. Medicare Eligibility
          MATCH     "05",ATTRTYPE
          IF        @EQUAL
            PACK      KEY5,ANST,SP1,ATTRVALU,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    THCSCOD,DIM1
              PACK      ATTRVALU,DIM1,SP70
            ENDIF
          ENDIF
.
. Preferred language
          MATCH     "07",ATTRTYPE
          IF        @EQUAL
            PACK      KEY5,ANSL,ANSA,ATTRVALU,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      ATTRVALU,THCSCOD,SP70
            ENDIF
          ENDIF
.
. Religious Group
          MATCH     "08",ATTRTYPE
          IF        @EQUAL
            PACK      KEY5,ANSR,SP1,ATTRVALU,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      ATTRVALU,THCSCOD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,ATTRVALU
          GOTO      WRPROF99 IF EQUAL
.
          UNPACK    OBJECTKY,DIM8,DIM20
          SQUEEZE   DIM20
          SQUEEZE   DIM8
          STRIP     ATTRTYPE
          STRIP     ATTRVALU
          STRIP     STRATRD
          STRIP     ENDATRD
          STRIP     DIM20
          PACK      OBJECTTX,ANS035,TILDA:    * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:  * ISSUING_AUTHORITY
                             DIM8,TILDA:      * CLIENT_RECORD_ID
                             DIM20,TILDA:     * PROFILE_RECORD_ID
                             ATTRTYPE,TILDA:  * ATTRIBUTE_TYPE_CODE
                             ATTRVALU,TILDA:  * ATTRIBUTE_CODE
                             STRATRD,TILDA:   * START_DATE
                             ENDATRD,SP900    * END_DATE
.
          CALL      WRCOND00
.
WRPROF99  RETURN
+
.******************************************************************************
.*  ADDR0000 - Send Address restriction changes
.*  Loop pmsedwaf for type 22 and resend Client Address records
.******************************************************************************
ADDR0000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
ADDR2000  CALL      RKPMEDW1
          BRANCH    OVRCD,ADDR9999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      ADDR9999 IF LESS
.
          MATCH     "22",PMEWTYPE
          IF        @EQUAL
            PACK      KEY8,PMEWURNO,SP70
            CALL      RDMAST1
            IF        OVRCD<>1
              CALL      RDPMPX21
              BRANCH    OVRCD,ADDR2000
              PACK      URDATE,PTMXRDAT,SP70
              PACK      URURNO,PURNO,SP70
              PACK      SRMDDATE,PMEWCDAT,SP70
              PACK      SRMDTIME,PMEWCTIM,SP70
              CALL      SADD0000      * resend all records
            ENDIF
          ENDIF
          GOTO      ADDR2000
.
ADDR9999  RETURN
+
.******************************************************************************
.*  CL020000 - Client Address records
.*  Loop patpa1af and extract Client Address records
.******************************************************************************
CL020000  MOVE      "02",OBJECTTY
          CALL      ADDR0000         * resend address restriction changes first
.
          PACK      KEY24,STRTDATE,SP70
          CALL      RSPTPAD2         *   get UR's changed in the period
CL020500  CALL      RKPTPAD2
          BRANCH    OVRCD,CL022000
.
          MATCH     PADATE,ENDDATE
          GOTO      CL022000 IF LESS
.
          PACK      KEY8,PAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL020500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL020500
.
          PACK      SAVKEY24,PADATE,PATIME,PAURNO,SP70
          PACK      KEY24,PAURNO,PADATE,PATIME,SP70
          CALL      RDPADD1
          CALL      RDKPADD1
          IF        OVRCD<>1
            MATCH     PAURNO,PURNO
            IF        @EQUAL
              PACK      PADD1,PAADD1
              PACK      PADD2,PAADD2
              PACK      PSUBRB,PASUBR
              PACK      PADD4,PAADD4
              PACK      PPOST,PAPOST
            ENDIF
          ENDIF
.
          PACK      KEY24,SAVKEY24
          CALL      RDPTPAD2
          BRANCH    OVRCD,CL020500
.
. * changed address, send new info - add 02 for usual address info
          MATCH     SP70,PADD1
          GOTO      CL020500 IF EQUAL
.
. * end previous
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "02 ",CHANGOBJ                     * Adress
          MOVE      "21",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL
          MOVE      PADATE,CHANGNVL                    * Change new value
          PACK      CHANGKEY,PURNO,ONE,SP70,SP70       * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PADATE,SP70
          PACK      SRMDTIME,PATIME,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          MOVE      "1101",COUNTRY
          MATCH     SP70,PADD1
          IF        @EQUAL
            MOVE      "NFIA",PSUBRB
            MOVE      "9999",PPOST
            MOVE      "NFD",PADD4
            MOVE      "1101",COUNTRY
          ENDIF
.
          MATCH     "NFIA",PSUBRB
          IF        @EQUAL
            MOVE      "NFD",PADD4
            MOVE      "9999",PPOST
          ENDIF
.
          MATCH     "NFA",PSUBRB
          IF        @EQUAL
            MOVE      "NFA",PADD4
            MOVE      "9998",PPOST
          ENDIF
.
          MATCH     "8888",PPOST
          IF        @EQUAL
            MOVE      "9990",PPOST  * SJOG use 8888 for OS
          ENDIF
.
          MATCH     "9990",PPOST    * HEA use 9990 for OS
          IF        @EQUAL
            PACK      COUNTRY,ZERO,ZERO,ZERO,ZERO
            PACK      PTCDKEY2,ANSC,SP1,PADD4,SP70
            CALL      RDSCODE2
            CALL      RDKCODE2
            IF        OVRCD<>1
              MATCH     "C ",TCODE
              IF        @EQUAL
                MATCH     TDESC,PADD4
                IF        @EQUAL
                  MATCH     SP70,PTCDASC1
                  IF        !@EQUAL
                    PACK      COUNTRY,PTCDASC1,SP70
                  ELSE
                    PACK      COUNTRY,THCSCOD,SP70
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            PACK     PADD4,ANSO,ANSS,SP70   *  0891375
          ENDIF
.
          MOVE      "02",OBJECTTY
          PACK      OBJECTKY,PURNO,ONE,PADATE,SP70
          MOVE      ANSN,ADDRESFL
          CALL      GETADD00
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8 
          STRIP     PADD1
          STRIP     PADD2
          STRIP     PSUBRB
          STRIP     PPOST
          STRIP     PADD4
          STRIP     COUNTRY
          STRIP     PADATE
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             ONE,PADATE,TILDA:   * CLIENT_ADDRESS_RECORD_ID
                             ONE,TILDA:          * ADDRESS_TYPE_CODE
                             PADD1,SP1,PADD2,TILDA: * ORIGINAL_ADDRESS
                             PSUBRB,TILDA:       * ORIGINAL_SUBURB_LOCALITY
                             PPOST,TILDA:        * ORIGINAL_POSTCODE
                             PADD4,TILDA,TILDA,TILDA: * ORIGINAL_STATE_TERRITORY
                             TILDA:
                             COUNTRY,TILDA:
                             ADDRESFL,TILDA:
                             PADATE,TILDA:
                             SP900
.
          PACK      SRCRDATE,PADATE,SP70
          PACK      SRCRTIME,PATIME,SP70
          PACK      SRMDDATE,PADATE,SP70
          PACK      SRMDTIME,PATIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL020500
.
. * also send 12 and 13 records from pmsedwaf
CL022000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL022500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL023000
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL023000 IF LESS
.
          MATCH     "12",PMEWTYPE
          GOTO      CL022600 IF EQUAL
.
          MATCH     "13",PMEWTYPE
          GOTO      CL022500 IF NOT EQUAL
.
CL022600  UNPACK    PMEWNEWV,KEY14
          CALL      RDPMCEX1
          BRANCH    OVRCD,CL022500
.
          MATCH     "1",PMCEACTV         * ignore inactive addresses
          GOTO      CL022500 IF EQUAL
.
          PACK      KEY5,LOWT,LOWC,PMCETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL022500
.
          MATCH     "2",TCINDC1
          GOTO      CL022500 IF NOT EQUAL
.
          PACK      KEY8,PMCEURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL022500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL022500
.
. * end previous
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "02 ",CHANGOBJ                     * Adress
          MOVE      "21",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * Change old U/R value
          MOVE      PMEWCDAT,CHANGNVL                  * Change new U/R value
          PACK      CHANGKEY,PMCEURNO,THREE,SP70,SP70  * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      OBJECTKY,PMCEURNO,THREE,PMCEWPID,SP70
          MOVE      ANSN,ADDRESFL
          CALL      GETADD00
.
          MOVE      "1101",COUNTRY
          PACK      DIM4,COUNTRY
.
          MATCH     "8888",PMCEPOST
          IF        @EQUAL
            MOVE      "9990",PMCEPOST     * SJOG use 8888 for OS
          ENDIF
.
          MATCH     "9990",PMCEPOST       * HEA use 9990 for OS
          GOTO      CL022700 IF NOT EQUAL
.
          PACK      DIM4,ZERO,ZERO,ZERO,ZERO
.
          PACK      PTCDKEY2,ANSC,SP1,PMCEADD4,SP70
          CALL      RDSCODE2
          CALL      RDKCODE2
          BRANCH    OVRCD,CL022700
.
          MATCH     ANSC,TCODE
          GOTO      CL022700 IF NOT EQUAL
.
          MATCH     TDESC,PMCEADD4
          GOTO      CL022700 IF NOT EQUAL
.
          MATCH     SP70,PTCDASC1
          IF        !@EQUAL
            PACK      DIM4,PTCDASC1,SP70
          ELSE
            PACK      DIM4,THCSCOD,SP70
          ENDIF
          PACK      PMCEADD4,ANSO,ANSS,SP70   *  0891375
.
CL022700  MOVE      PMCEURNO,DIM8
          SQUEEZE   DIM8
          STRIP     PMCEADD1
          STRIP     PMCEADD2
          STRIP     PMCEADD3
          STRIP     PMCEADD4
          STRIP     PMCEPOST
          SQUEEZE   PMCEWPID
          PACK      OBJECTTX,ANS035,TILDA:         * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:       * ISSUING_AUTH
                             DIM8,TILDA:           * CLIENT_RECORD_ID
                             THREE,PMCEWPID,TILDA: * ADDRESS_RECORD_ID
                             THREE,TILDA:          * ADDRESS_TYPE
                             PMCEADD1,SP1,PMCEADD2,TILDA: * ORIGINAL_ADDRESS
                             PMCEADD3,TILDA:       * ORIGINAL_SUBURB
                             PMCEPOST,TILDA:       * ORIGINAL_POSTCODE
                             PMCEADD4,TILDA:       * ORIGINAL_STATE
                             TILDA,TILDA:          * LATITUDE/LONGITUDE
                             TILDA:                * DELIVERY_POINT
                             DIM4,TILDA:           * COUNTRY
                             ADDRESFL,TILDA:       * ADDRESS_RESTRICTION
                             PMCECDAT,TILDA:       * START_DATE
                             PMCEDINA,SP900        * END_DATE
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,PMEWCTIM,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL022500
.
CL023000
.
CL029999  RETURN
+
.******************************************************************************
.*  PRADD000 - Get prior address record     
.*  already sent new 02 for address, find prior record on patpa1af OR
.*  use original patma1af record to set end date/time
.******************************************************************************
PRADD000  PACK     SAVKEY24,PADATE,PATIME,PAURNO,SP70
          PACK     SAVKEY8,PAURNO
          PACK     DIM8C,PADATE,SP70
          PACK     TIM8A,SP70
.
          PACK     KEY24,PAURNO,PADATE,PATIME
          CALL     RDPADD1   
          BRANCH   OVRCD,PRADD900
.
          CALL     RDPPADD1
          BRANCH   OVRCD,PRADD500   * if no prior, use master file
.
          MATCH    PAURNO,SAVKEY8
          GOTO     PRADD500 IF NOT EQUAL
.
          PACK     DIM8A,PADATE,SP70
          PACK     TIM8A,PATIME,SP70
          PACK     DIM8B,PADATE,SP70
          GOTO     PRADD900
.
PRADD500  PACK     KEY8,SAVKEY8,SP70
          CALL     RDMAST1
          BRANCH   OVRCD,PRADD900
.
          PACK     DIM8A,SP70
          PACK     TIM8A,SP70
          PACK     DIM8B,PTMXRDAT,SP70
.
PRADD900  
. * re-read postion on index 2
          PACK      KEY24,SAVKEY24
          CALL      RDPTPAD2
          BRANCH    OVRCD,PRADD999
.
PRADD999  RETURN
+
.******************************************************************************
.*  GETADD00 - Get Address Restriction flag 
.******************************************************************************
GETADD00  MATCH     SP70,PMPXPRVI
          GOTO      GETADD99 IF EQUAL
.
          PACK      KEY5,ANSP,ANSV,PMPXPRVI,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSP,TCINDC1
            IF        @EQUAL
              MOVE      ANSY,ADDRESFL
            ENDIF
          ENDIF
.
GETADD99  RETURN
+
.******************************************************************************
.*  CL030000 - Client Relationship records
.*  Loop patlinkf and extract Client Relationship records
.*  Loop pmsedwaf and extract type 14 and 15 records
.******************************************************************************
CL030000  PACK      KEY24,STRTDATE,SP70
          CALL      RDSLINK2         *   get new UR's in the period
CL030500  CALL      RDKLINK2
          BRANCH    OVRCD,CL031000
.
          MATCH     LINKDAT,ENDDATE
          GOTO      CL031000 IF LESS
.
          PACK      KEY8,LINKFUR,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL030500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL030500
.
. * only send mother/baby links
          PACK      KEY5,ANSL,ANSU,LINKREA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL030500
.
          MATCH     ANSM,TCINDC1
          GOTO      CL030500 IF NOT EQUAL
.
. * send 03 for from UR
          MOVE      "03",OBJECTTY
          PACK      OBJECTKY,LINKTUR,ANSF,LINKFUR,SP70
          STRIP     OBJECTKY
          STRIP     PTMASNAM
          STRIP     PMPXFNAM
          STRIP     PMPXSNAM
          MOVE      LINKTUR,DIM8
          SQUEEZE   DIM8
          MOVE      LINKFUR,DIM8A
          SQUEEZE   DIM8A
          PACK      D2,TWO,ANSM * default to be baby
.
          MOVE      ZERO,F8
          DAYSEP    PBDATE,ENDDATE,F8
          IF        F8>364
            PACK      D2,THREE,ANSG * not baby- must be mother
          ENDIF
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:      * PRIMARY_CLIENT_RECORD_ID
                           ANSM,ANSB,DIM8A,TILDA: *CLIENT_RELATIONSHIP_RECORD_ID
                             FOUR,TILDA:         * ROLE_TO_CLIENT_CODE
                             D2,TILDA:           * RELATIONSHIP_TO_CLIENT
                             PTMASNAM,TILDA:     * REL_PERSON_FAMILY_NAME
                             PMPXFNAM,SP1,PMPXSNAM,TILDA: * REL_PERSON_GIVEN
                             TILDA:              * DOB
                             ANS035,TILDA:       * TYPE_CODE
                             PTCNNSSI,TILDA:     * AUTHORITY
                             DIM8A,TILDA:   * RELATED_PRIMARY_CLIENT_RECORD_ID
                             TILDA:              * TYPE_CODE
                             TILDA:              * SOURCE_ID
                             TILDA:              * ISP_ID
                             LINKDAT,TILDA:      * START_DATE
                             SP900         * END_DATE
.
          PACK      SRCRDATE,LINKDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,LINKDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL030500
.
CL031000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL031500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL033000
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL033000 IF LESS
.
          MATCH     "14",PMEWTYPE
          GOTO      CL032600 IF EQUAL
.
          MATCH     "15",PMEWTYPE
          GOTO      CL031500 IF NOT EQUAL
.
CL032600  UNPACK    PMEWNEWV,KEY14
          CALL      RDPMCEX1
          BRANCH    OVRCD,CL031500
.
. * only send hdp 1,2 or 9 records
          PACK      KEY5,LOWT,LOWC,PMCETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL031500
.
          MATCH     "4",THCSCOD
          GOTO      CL032700 IF EQUAL
.
          MATCH     "5",THCSCOD
          GOTO      CL032700 IF EQUAL
.
          MATCH     "2",THCSCOD
          GOTO      CL032700 IF EQUAL
.
          MATCH     "3",THCSCOD
          GOTO      CL032700 IF EQUAL
.
          MATCH     "9",THCSCOD
          GOTO      CL031500 IF NOT EQUAL
.
. 
CL032700  MOVE      "03",OBJECTTY
          PACK      KEY8,PMCEURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL031500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL031500
.
          MATCH     "14",PMEWTYPE
          IF       @EQUAL
            PACK      SRCRDATE,PMCECDAT,SP70
            PACK      SRCRTIME,PMCECTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
          ENDIF
.
          MATCH     "15",PMEWTYPE
          IF       @EQUAL
            PACK      SRCRDATE,PMCECDAT,SP70
            PACK      SRCRTIME,PMCECTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
          ENDIF
          CALL      NEWCE000
.
          GOTO      CL031500
.
CL033000  CALL      GP030000     * send GP relationship 03 records
CL039999  RETURN
+
.******************************************************************************
.*  NEWCE000 - New Extra contact relationship
.******************************************************************************
NEWCE000  PACK      OBJECTKY,PMCEURNO,PMCEWPID,SP70
          STRIP     OBJECTKY
          STRIP     PMCESNAM
          STRIP     PMCEGNAM
          STRIP     PMCEGNM2
          STRIP     THCSCOD
          MOVE      PMCEURNO,DIM8
          SQUEEZE   DIM8
          UNPACK    THCSCOD,D1,D3
.
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
             CALL      MAPREL00     * map relationship
             MATCH     SP70,MAPPEDRL
             IF        !@EQUAL
               PACK      D3,MAPPEDRL
             ENDIF
          ENDIF
.
          STRIP     D3
.
          SQUEEZE   PMCEWPID
          PACK      OBJECTTX,ANS035,TILDA:     * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:   * ISSUING_AUTHORITY
                             DIM8,TILDA:       * RECORD_ID
                             PMCEWPID,TILDA:   * RELATIONSHIP_RECORD_ID
                             D1,TILDA:         * RELATED_PERSON_ROLE_TO_CLIENT
                             D3,TILDA:         * RELATIONSHIP_TO_CLIENT
                             PMCESNAM,TILDA:   * FAMILY_NAME
                             PMCEGNAM,SP1,PMCEGNM2,TILDA: * GIVEN_NAME
                             TILDA:            * DATE_OF_BIRTH
                             TILDA:            * CLIENT_ID_TYPE_CODE
                             TILDA:            * CLIENT_ID_ISSUING_AUTH
                             TILDA:            * RELATED_PRIMARY_CLIENT_RECORD
                             TILDA:            * ISP_ID_TYPE_CODE
                             TILDA:            * ISP_SOURCE_ID
                             TILDA:            * ISP_ID
                             PMCECDAT,TILDA:   * START_DATE
                             PMCEDINA,SP900    * END_DATE
.
          CALL      WRCOND00     * write record to container detail table
.
NEWCE999  RETURN
+
.******************************************************************************
.*  MAPREL00 - Map relationship from PMSRELAF.PMRLHDPE
.******************************************************************************
MAPREL00  MOVE      SP70,MAPPEDRL
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          BRANCH    OVRCD,MAPREL99
.
          MOVE      PMRLHDPE,MAPPEDRL        
.
MAPREL99  RETURN
+
.******************************************************************************
.*  GP030000 - GP Client Relationships
.*  Loop pmsedwaf and extract type 20 and 21 records
.******************************************************************************
GP030000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
GP030500  CALL      RKPMEDW1
          BRANCH    OVRCD,GP039999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      GP039999 IF LESS
.
          MATCH     "20",PMEWTYPE
          GOTO      GP031000 IF EQUAL
.
          GOTO      GP030500
. ?? query about practice
...       MATCH     "21",PMEWTYPE
...       GOTO      GP030500 IF NOT EQUAL
.
GP031000  PACK      SAVKEY27,PMEWCDAT,PMEWCTIM,PMEWURNO,PMEWTYPE,SP70
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,GP030500
.
          PACK      DIM8A,PTMXRDAT,SP70
. * ignore blank records
          MATCH     SP70,PMEWOLDV
          IF        @EQUAL
            MATCH     SP70,PMEWNEWV
            GOTO      GP030500 IF EQUAL
          ENDIF
.
. * no old value, therefore just send new record (no need to end previous)
          MATCH     SP70,PMEWOLDV
          IF        @EQUAL
             GOTO     GP032000 IF EQUAL
          ENDIF

. * end previous 05 - read previous reocrd for this key
.
.. * get effective start date of prior record - use ptmxrdat if it was first
.
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RDPMEDW2     * read current record
          BRANCH    OVRCD,GP030500
          CALL      RPPMEDW2     * read prior
          BRANCH    OVRCD,GP030500
.
          MATCH     PMEWURNO,SAVKEY8
          IF        @EQUAL
            MATCH     "20",PMEWTYPE
            IF        @EQUAL
              PACK      DIM8A,PMEWCDAT
            ENDIF
          ENDIF
.
. * re-position back on current record
.
          PACK      KEY27,SAVKEY27
          CALL      RDPMEDW1
          BRANCH    OVRCD,CL059999
.
          MOVE      "03",OBJECTTY
          SQUEEZE   PMEWOLDV
          PACK      OBJECTKY,PMEWURNO,PMEWOLDV,SP70
          UNPACK    PMEWOLDV,DIM10
          STRIP     DIM10
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
.
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GP032000
.
          STRIP     PMHCSNAM
          STRIP     PMHCGNAM
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM10,DIM8A,TILDA:*CLIENT_RELATIONSHIP_RECORD_ID
                             TWO,TILDA: * RELATED_PERSON_ROLE_TO_CLIENT_CODE
                             NINE,ANSD,TILDA:*RELATED_PERSON_RELATIONSHIP_TO_CLI
                             TILDA: * RELATED_PERSON_FAMILY_NAME
                             TILDA: * RELATED_GIVEN_FAMILY_NAME
                             TILDA: * RELATED_PERSON_DATE_OF_BIRTH
                             TILDA: * RELATED_PRIMARY_CLIENT_ID_TYPE_CODE
                             TILDA: * RELATED_PRIMARY_CLIENT_ID_ISSUING_AUTH
                             TILDA: * RELATED_PRIMARY_CLIENT_RECORD_ID
                             ANS035,TILDA:       * RELATED_ISP_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * RELATED_ISP_SOURCE_ID
                             DIM10,TILDA:        * RELATED_ISP_ID
                             DIM8A,TILDA:     * RELATIONSHIP_START_DATE
                             PMEWCDAT,SP900      * RELATIONSHIP_END_DATE
.
          PACK      SRCRDATE,DIM8A,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
GP032000  MOVE      "03",OBJECTTY
          SQUEEZE   PMEWNEWV
          PACK      OBJECTKY,PMEWURNO,PMEWNEWV,SP70
          UNPACK    PMEWNEWV,DIM10
          STRIP     DIM10
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
.
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GP039999
.
          STRIP     PMHCSNAM
          STRIP     PMHCGNAM
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM10,PMEWCDAT,TILDA:*CLIENT_RELATIONSHIP_RECORD_ID
                             TWO,TILDA: * RELATED_PERSON_ROLE_TO_CLIENT_CODE
                             NINE,ANSD,TILDA:*RELATED_PERSON_RELATIONSHIP_TO_CLI
                             TILDA:
                             TILDA: 
                             TILDA: 
                             TILDA: 
                             TILDA: 
                             TILDA:*RELATED_PRIMARY_CLIENT_RECORD_ID
                             ANS035,TILDA:       * RELATED_ISP_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * RELATED_ISP_SOURCE_ID
                             DIM10,TILDA:        * RELATED_ISP_ID
                             PMEWCDAT,TILDA:     * RELATIONSHIP_START_DATE 
                             SP900               * RELATIONSHIP_END_DATE
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
          GOTO      GP030500
.
GP039999  RETURN
+
.******************************************************************************
.*  WR080000 - Client Static demographics for newborns
.******************************************************************************
WR080000  MOVE      "08",OBJECTTY
          PACK      OBJECTKY,PURNO,SP70,SP70
          MOVE      SP70,DIM4
          MOVE      SP70,THCSCOD
          MATCH     SP70,PCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PCONT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,THCSCOD
            ENDIF
            MOVE      THCSCOD,DIM4
          ENDIF
          MOVE      ANSN,KEY1
          MOVE      SP70,DIM1
          COMPARE   "1",PCEASE
          IF        @EQUAL
            PACK      KEY1,ANSY
            PACK      DIM1,ANSN
            MATCH     ANSY,PTMAUKDD
            IF        @EQUAL
              PACK      DIM1,ANSY
            ENDIF
          ENDIF
          MOVE      PURNO,DIM8
          SQUEEZE   DIM8
          STRIP     THCSCOD
          STRIP     PDECDTE
          STRIP     DIM1
          REP       " 0",DIM4
          STRIP     KEY1
. map patient sex
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXNO,D1
          REP       "49",D1
.
. only send birth fields if last admission was birth event (cat CC hcp=70)
.
          PACK      KEY17,PURNO,Z70
          CALL      RSPTMI18
WR081000  CALL      RPPTMI18
          BRANCH    OVRCD,WR082000
.
          MATCH     PURNO,AURNO
          GOTO      WR082000 IF NOT EQUAL
.
          COMPARE   "5",ASTAT               * Skip cancelled amission
          GOTO      WR081000 IF EQUAL
.
          MATCH     ADATE,ENDDATE           * First admission prior to extra
          GOTO      WR081000 IF LESS        * end date, eg the last admission
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WR082000
.
          MATCH     "70",PTCDNHCP
          GOTO      WR082000 IF NOT EQUAL
.
          MOVE      APLUR,CODINGST
          REP       "01",CODINGST
          SQUEEZE   AUSR6
          PACK      DIM9,ABWGHT,DOT,ZERO,ZERO
          GOTO      WR083000
.
WR082000  MOVE      SP70,APLUR
          MOVE      ANSN,AUSR6
          MOVE      SP70,DIM9
          MOVE      SP70,CODINGST
.
WR083000  SQUEEZE   CODINGST
          SQUEEZE   DIM9
          SQUEEZE   AUSR6
          REP       " N",PMPXEDOB
          REP       "0N1Y",PMPXEDOB
          REP       "01",CODINGST
          PACK      OBJECTTX,ANS035,TILDA:    * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:  * ISSUING_AUTHORITY
                             DIM8,TILDA:      * CLIENT_RECORD_ID
                             D1,TILDA:        * SEX_CODE
                             PBDATE,TILDA:    * DATE_OF_BIRTH
                             DIM4,TILDA:      * COUNTRY_OF_BIRTH
                             PMPXEDOB,TILDA:  * DATE_OF_BIRTH_ESTIMATION_FLAG
                             AUSR6,TILDA:     * BIRTH_ORDER_CODE
                             CODINGST,TILDA:  * BIRTH_PLURALITY_CODE
                             DIM9,TILDA:      * BIRTH_WEIGHT
                             PDECDTE,TILDA:   * DATE_OF_DEATH
                             DIM1,TILDA:  * DATE_OF_DEATH_EST_FLAG
                             KEY1,SP900 * DECEASED_FLAG
.
          CALL      WRCOND00     * write record to container detail table

WR089999  RETURN
+
.******************************************************************************
.*  CHDV0000 - Check if a patient has a dva record
.*  Returns EXIT=0 No dva record
.*          EXIT=1 DVA record exists
.******************************************************************************
CHDV0000  MOVE      ZERO,EXIT
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1
CHDV1000  CALL      RKPMCCD1
          BRANCH    OVRCD,CHDV9999
.
          MATCH     PURNO,PMCDURNO
          GOTO      CHDV9999 IF NOT EQUAL
.
          PACK      KEY5,LOWC,LOWT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHDV9999
          MATCH     "3",TCINDC1
          GOTO      CHDV9000 IF EQUAL
          GOTO      CHDV1000
.
CHDV9000  MOVE      ONE,EXIT
.
CHDV9999  RETURN
+
.******************************************************************************
.*  CL040000 - Client Insurance records
.*  Loop pmsedwaf and extract type 25 and 26 records
.******************************************************************************
CL040000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL040500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL049999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL049999 IF LESS
.
          MATCH     "18",PMEWTYPE       * check for dva
          GOTO      CL045000 IF EQUAL
.
          MATCH     "19",PMEWTYPE       * check for dva
          GOTO      CL045000 IF EQUAL
.
          MATCH     "25",PMEWTYPE
          GOTO      CL041000 IF EQUAL
.
          MATCH     "26",PMEWTYPE
          GOTO      CL041000 IF EQUAL
          GOTO      CL040500
.
CL041000  PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL040500
.
          MOVE      PMEWCDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
. * ignore blank records
          MATCH     SP70,PMEWOLDV    * both blank, ignore
          IF        @EQUAL
            MATCH     SP70,PMEWNEWV
            GOTO      CL040500 IF EQUAL
          ENDIF
.
          MATCH     SP70,PMEWOLDV    * ignore changes from 1 fund to another
          IF        !@EQUAL
            MATCH     SP70,PMEWNEWV
            GOTO      CL040500 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMEWOLDV    * changed from no fund to fund
          GOTO      CL042000 IF NOT EQUAL
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "04 ",CHANGOBJ                     * Insurance
          MOVE      "15",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL
          MOVE      PMEWCDAT,CHANGNVL                  * Change new value
          PACK      CHANGKEY,PURNO,ZERO,SP70,SP70      * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          MOVE      NINE,D1
          PACK      D3,ZERO,NINE,NINE
          MOVE      "Unknown",KEY24
          MOVE      SP70,KEY1
          GOTO      CL043000
.
CL042000  MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "04 ",CHANGOBJ                     * Insurance
          MOVE      "15",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL
          MOVE      PMEWCDAT,CHANGNVL                  * Change new value
          PACK      CHANGKEY,PURNO,NINE,SP70,SP70      * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
. * removed for 0892026
...       CALL      CHDV0000   * if dva exists, then exit, otherwise send public
...       IF        EXIT=1
...         GOTO      CL040500
...       ENDIF
          MOVE      ZERO,D1          * changed from fund to no fund
          MOVE      "None",KEY24
          PACK      D3,ZERO,ZERO,ZERO
          MOVE      SP70,KEY1
.
CL043000  PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,PMEWCTIM,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
.
          CALL      WR040000
          GOTO      CL040500
.
CL045000  PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL040500
.
. *** if new value is blank, assume a delete *** 
          MATCH     SP70,PMEWNEWV
          IF        @EQUAL
            UNPACK    PMEWOLDV,D8,D3
            PACK      D3,D3,SP70
          ELSE
            UNPACK    PMEWNEWV,D8,D3
            PACK      D3,D3,SP70
          ENDIF
.
. old value is ur,cat tc,card number, expiry date
. we only want to send card types where indicator 1=3
.
          MATCH     SP70,D3
          GOTO      CL040500 IF EQUAL
.
          PACK      KEY5,LOWC,LOWT,D3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL040500
          MATCH     "3",TCINDC1
          GOTO      CL040500 IF NOT EQUAL
.
.  ** end last record if this is a delete **
          MATCH     SP70,PMEWNEWV
          IF        @EQUAL
            MOVE      PMEWCDAT,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      ANSD,OBJECTRT
            MOVE      "1  ",CHANGSTM                     * 1=Client
            MOVE      "04 ",CHANGOBJ                     * Insurance
            MOVE      "15",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      PMEWCDAT,CHANGNVL                  * Change new value
            PACK      CHANGKEY,PURNO,ANSD,SP70,SP70      * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
            GOTO      CL040500
          ENDIF
.
          PACK      KEY19,PURNO,D3,Z70
          CALL      RSPMCCD1
          CALL      RPPMCCD1
          BRANCH    OVRCD,CL040500
          MATCH     PURNO,PMCDURNO
          GOTO      CL040500 IF NOT EQUAL
          MATCH     PMCDCTYP,D3
          GOTO      CL040500 IF NOT EQUAL
. 
          MOVE      PMCDCDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      KEY24,PMCDCNUM,SP70
          PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK     KEY1,THCSCOD
          ENDIF
          MOVE      ANSD,D1
          PACK      D3,ZERO,TWO,THREE
          PACK      SRCRDATE,PMCDCDAT,SP70
          PACK      SRCRTIME,PMCDCTIM,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WR040000
          GOTO      CL040500
.
CL049999  RETURN
+
.******************************************************************************
.*  CL050000 - Client External Identifier records
.*  Loop pmsedwaf and extract type 7 records
.*  Loop pmsedwaf and extract type 18 and 19 records
.******************************************************************************
CL050000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL050500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL052000
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL052000 IF LESS
.
          MATCH     "7",PMEWTYPE
          GOTO      CL050500 IF NOT EQUAL
.
. if this ur was created in the date range, don't send medicare again 0899679
          PACK      KEY17,PMEWURNO,ANSA,SP70
          CALL      RDSURAD2
          CALL      RDKURAD2
          BRANCH    OVRCD,CL050600
.
          MATCH     PMEWURNO,URURNO
          GOTO      CL050600 IF NOT EQUAL
.
          MATCH     ANSA,URRTYPE
          GOTO      CL050600 IF NOT EQUAL
.
          MATCH     STRTDATE,URDATE
          GOTO      CL050600 IF  LESS
          GOTO      CL050500
.
CL050600  PACK      SAVKEY27,PMEWCDAT,PMEWCTIM,PMEWURNO,PMEWTYPE,SP70
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL050500
.
          PACK      DIM8A,PTMXRDAT,SP70
. * ignore blank records
          MATCH     SP70,PMEWOLDV
          IF        @EQUAL
            MATCH     SP70,PMEWNEWV
            GOTO      CL050500 IF EQUAL
          ENDIF
.
... * no old value, therefore just send new record (no need to end previous)
...   commented out, 0923421 wants 99999999999
...       MATCH     SP70,PMEWOLDV
...       IF        @EQUAL
...          GOTO     CL051000 IF EQUAL
...       ENDIF
...
. * end previous 05 - read previous record for this key
.
.. * get effective start date of prior record - use ptmxrdat if it was first
.
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RDPMEDW2     * read current record
          BRANCH    OVRCD,CL059999
CL050700  CALL      RPPMEDW2     * read prior
          BRANCH    OVRCD,CL050800
.
          PACK      DIM8A,PTMXRDAT
          MATCH     PMEWURNO,SAVKEY8
          GOTO      CL050800 IF NOT EQUAL
.
          MATCH     "7",PMEWTYPE
          GOTO      CL050800 IF NOT EQUAL
.
          PACK      DIM8A,PMEWCDAT
.
. * re-position back on current record
.
CL050800  PACK      KEY27,SAVKEY27
          CALL      RDPMEDW1
          BRANCH    OVRCD,CL059999
.
          MOVE      "05",OBJECTTY
          SQUEEZE   PMEWOLDV
          PACK      OBJECTKY,PMEWURNO,PMEWOLDV,SP70
          UNPACK    PMEWOLDV,DIM10
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL
            MOVE      "99999999999",PMEWOLDV
            STRIP     PMEWOLDV
          ENDIF
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
          STRIP     DIM10
          PACK      OBJECTTX,ANS035,TILDA:     
                             PTCNNSSI,TILDA:
                             DIM8,TILDA:
                             DIM10,DIM8A,TILDA: *EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,ONE,EIGHT,TILDA:
                             THREE,ZERO,ZERO,THREE,THREE,FIVE,SEVEN,TILDA:
                             PMEWOLDV,TILDA:    * EXTERNAL_CLIENT_ID
                             DIM8A,TILDA:
                             PMEWCDAT,SP900
.
          PACK      SRCRDATE,DIM8A,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
CL051000  MOVE      "05",OBJECTTY
          SQUEEZE   PMEWNEWV
          PACK      OBJECTKY,PMEWURNO,PMEWNEWV,SP70
          UNPACK    PMEWNEWV,DIM10
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL
            MOVE      "99999999999",PMEWNEWV
            STRIP     PMEWNEWV
          ENDIF
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
          STRIP     DIM10
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM10,PMEWCDAT,TILDA: *EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,ONE,EIGHT,TILDA:
                             THREE,ZERO,ZERO,THREE,THREE,FIVE,SEVEN,TILDA:
                             PMEWNEWV,TILDA:
                             PMEWCDAT,TILDA:
                             SP900
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
          GOTO      CL050500
.
. * concession card * 
CL052000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL052500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL054000
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL054000 IF LESS
.
          MATCH     "18",PMEWTYPE
          GOTO      CL052600 IF EQUAL
.
          MATCH     "19",PMEWTYPE
          GOTO      CL052500 IF NOT EQUAL
.
. * end previous 05 - read last sent 05 for this key
.
CL052600  UNPACK    PMEWOLDV,D8,D3
          PACK      D3,D3,SP70
.
. old value is ur,cat tc,card number, expiry date
. we only want to send card types where indicator 1=1
.
          MATCH     SP70,D3
          GOTO      CL053000 IF EQUAL
.
          PACK      KEY5,LOWC,LOWT,D3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL053000
          MATCH     "1",TCINDC1
          GOTO      CL052500 IF NOT EQUAL
.
          PACK      KEY112,CONTSTRM,ZERO,FIVE,SP1,PMEWOLDV,Z70
          CALL      RSCMEWD2
          CALL      RKCMEWD2
          BRANCH    OVRCD,CL053000
.
          PACK      OBJECTKY,PMEWURNO,PMEWOLDV,SP70
          MATCH     OBJECTKY,CMEWOKEY
          GOTO      CL053000 IF NOT EQUAL  * no previous record - don't send end
.
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
          UNPACK    PMEWOLDV,DIM10
          STRIP     DIM10
          MATCH     SP70,DIM10
          GOTO      CL053000 IF EQUAL
.
          MOVE      "05",OBJECTTY
          PACK      OBJECTKY,PMEWURNO,D3,D10,SP70
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTH
                             DIM8,TILDA:         * CLIENT_RECORD_ID
                             DIM10,TILDA:        * EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,ZERO,SIX,TILDA:* TYPE_CODE
                             THREE,ZERO,ZERO,THREE,THREE,SIX,FIVE,TILDA:
                             PMEDI,PTMXMCCD,TILDA:    * EXTERNAL_CLIENT_ID
                             PTMXRDAT,TILDA:     * EFFECTIVE_START_DATE
                             PMEWCDAT,SP900      * END_DATE
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
CL053000  MOVE      "05",OBJECTTY
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
.
          UNPACK    PMEWNEWV,D8,D3,D10
          PACK      D3,D3,SP70
          STRIP     D10
.
. new value is ur,cat tc,card number, expiry date
. we only want to send card types where indicator 1=1
.
          MATCH     SP70,D3
          GOTO      CL052500 IF EQUAL
.
          PACK      KEY5,LOWC,LOWT,D3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CL052500
          MATCH     "1",TCINDC1
          GOTO      CL052500 IF NOT EQUAL
.
          PACK      OBJECTKY,PMEWURNO,D3,D10,SP70
          PACK      OBJECTTX,ANS035,TILDA:
                             PTCNNSSI,TILDA:
                             DIM8,TILDA:
                             D3,D10,TILDA:    * EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,ZERO,SIX,TILDA:
                             THREE,ZERO,ZERO,THREE,THREE,SIX,FIVE,TILDA:
                             D10,TILDA:
                             PMEWCDAT,TILDA:
                             SP900
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
          GOTO      CL052500
.
. * NDIS *
CL054000  PACK      KEY51,STRTDATE,SP70
          CALL      RSPTATR4
CL054500  CALL      RKPTATR4
          BRANCH    OVRCD,CL055000
.
          MATCH     PTARUDTE,ENDDATE
          GOTO      CL055000 IF LESS
.
          MATCH     "020",PTARTYPE               * NDIS
          GOTO      CL054500 IF NOT EQUAL
.
          MATCH     "1",PTARDELR                 * Record marked as deleted
          IF        @EQUAL
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "05 ",DELETOBJ             * External Identifier
            PACK      DELETKEY,PTARURNO,PTARDATE,PTARTIME,PTARTXT1:
                             SP70,SP70      * Delete Key
.
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
.
            CALL      DLOF0000                   * Delete last sent objec
            GOTO      CL054500
          ENDIF
.
          MOVE      "05",OBJECTTY
          PACK      OBJECTKY,PTARURNO,PTARDATE,PTARTIME,PTARTXT1,SP70
.
          MOVE      PTARURNO,DIM8                * U/R
          SQUEEZE   DIM8
          SQUEEZE   PTARTXT1                     * NDIS Number
          PACK      DIM20,PTARTXT1,PTARDATE,SP70 * NDIS Number and start date
          SQUEEZE   DIM20
          SQUEEZE   PTARDATE                     * Start Date
          SQUEEZE   PTARFDTE                     * End Date
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTH
                             DIM8,TILDA:         * CLIENT_RECORD_ID
                             DIM20,TILDA:        * EXTERNAL_CLIENT_ID_RECORD_ID
                             ZERO,SIX,ZERO,TILDA:* TYPE_CODE
                             THREE,ZERO,TWO,SEVEN,SIX,FIVE,SIX,TILDA:
                             PTARTXT1,TILDA:     * EXTERNAL_CLIENT_ID
                             PTARDATE,TILDA:     * EFFECTIVE_START_DATE
                             PTARFDTE,SP900      * END_DATE
.
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL054500
.
CL055000
.
CL059999  RETURN
+
.******************************************************************************
.*  CLUPI000 - Client External Identifier UPI records
.*  Loop pmsedwaf and extract type 16 and 19 records
.******************************************************************************
CLUPI000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CLUPI500  CALL      RKPMEDW1
          BRANCH    OVRCD,CLUPI999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CLUPI999 IF LESS
.
          MATCH     "16",PMEWTYPE
          GOTO      CLUPI500 IF NOT EQUAL
.
          PACK      SAVKEY27,PMEWCDAT,PMEWCTIM,PMEWURNO,PMEWTYPE,SP70
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CLUPI500
.
. * ignore blank records
          MATCH     SP70,PMEWNEWV
          GOTO      CLUPI500 IF EQUAL
.
. * end previous 05 - read previous reocrd for this key
.
.. * get effective start date of prior record
.
          PACK      SAVKEY8,PMEWURNO
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RDPMEDW2     * read current record
          BRANCH    OVRCD,CLUPI500
          CALL      RPPMEDW2     * read prior
.
          MATCH     PMEWURNO,SAVKEY8
          IF        @EQUAL
            PACK      DIM8A,PMEWCDAT
          ELSE
            GOTO     CLUPI500
          ENDIF
          MOVE      "05",OBJECTTY
          SQUEEZE   PMEWOLDV
          PACK      OBJECTKY,PMEWURNO,PMEWOLDV,SP70
          UNPACK    PMEWOLDV,DIM10
          STRIP     DIM10
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
          PACK      OBJECTTX,ANS035,TILDA:
                             PTCNNSSI,TILDA:
                             DIM8,TILDA:
                             DIM10,TILDA:
                             ZERO,ONE,EIGHT,TILDA:
                             THREE,ZERO,ZERO,THREE,THREE,FIVE,SEVEN,TILDA:
                             PMEWOLDV,TILDA:    * EXTERNAL_CLIENT_ID
                             DIM8A,TILDA:
                             PMEWCDAT,SP900
.
          PACK      SRCRDATE,DIM8A,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
. * re-position back on current record
.
          PACK      KEY27,SAVKEY27
          CALL      RDPMEDW1
          BRANCH    OVRCD,CLUPI999
.
CLUPI600  MOVE      "05",OBJECTTY
          SQUEEZE   PMEWNEWV
          PACK      OBJECTKY,PMEWURNO,PMEWNEWV,SP70
          UNPACK    PMEWNEWV,DIM10
          STRIP     DIM10
          MOVE      PMEWURNO,DIM8
          SQUEEZE   DIM8
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             DIM10,TILDA:
                             ZERO,ONE,EIGHT,TILDA:
                             THREE,ZERO,ZERO,THREE,THREE,FIVE,SEVEN,TILDA:
                             PMEWNEWV,TILDA:
                             PMEWCDAT,TILDA:
                             SP900
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
          GOTO      CL050500
.
CLUPI999 RETURN
+
.******************************************************************************
.*  CL060000 - Client Name records
.*  Loop pmsedwaf and extract type 17 records
.******************************************************************************
CL060000  MOVE      ZERO,KEY3
          MOVE      ZERO,F3
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL060500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL069999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL069999 IF LESS
.
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL060500
.
          MOVE      SP70,D8
          MOVE      SP70,OBJECTRT
          MATCH     "17",PMEWTYPE               * name changed
          GOTO      CL061000 IF EQUAL
.
          MATCH     "28",PMEWTYPE               * alias added
          GOTO      CL062000 IF EQUAL
.
          MATCH     "27",PMEWTYPE               * alias deleted
          IF        @EQUAL
            MOVE      ANSD,OBJECTRT
            UNPACK    PMEWOLDV,GSRSNAM,GSRGNAM,PTGSGNM2
            PACK      PMEWNEWV,GSRSNAM,SP10,SP1,GSRGNAM,SP10,SP1,PTGSGNM2
            PACK      D8,PMEWCDAT
            MOVE      "1  ",CHANGSTM                     * 1=Client
            MOVE      "06 ",CHANGOBJ                     * Adress
            PACK      CHANGKEY,PURNO,ANSA,SP70,SP70      * Change Key
            CALL      FNDT0000
          ENDIF
          GOTO      CL060500
.
CL061000  MOVE      SP70,CMEWOKEY
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "06 ",CHANGOBJ                     * Adress
          MOVE      "16",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL
          MOVE      PMEWCDAT,CHANGNVL                  * Change new value
          PACK      CHANGKEY,PURNO,ANSL,SP70,SP70      * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          UNPACK    CMEWOKEY,KEY8,DIM1,DIM8
          MOVE      ZERO,RECCOUNT
          MATCH     KEY8,PMEWURNO
          GOTO      CL061500 IF NOT EQUAL
          MOVE      DIM8,RECCOUNT
          ADD       ONE,RECCOUNT
.
CL061500  MOVE      "06",OBJECTTY
.
          PACK      OBJECTKY,PMEWURNO,ANSL,RECCOUNT,SP70
          PACK      DIM8,PMEWURNO
          SQUEEZE   DIM8
.
          PACK      KEY16,RECCOUNT,SP70
          UNPACK    PMEWNEWV,SAVPSNAM,SAVPFGNM,SAVPSGNM
          STRIP     SAVPSNAM
          STRIP     SAVPFGNM
          STRIP     SAVPSGNM
          SQUEEZE   KEY16
          STRIP     PTITL
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             ANSL,KEY16,TILDA:   * CLIENT_NAME_RECORD_ID
                             ANSL,TILDA:         * NAME_TYPE_CODE
                             SAVPSNAM,TILDA:     * FAMILY_NAME
                             SAVPFGNM,TILDA:     * GIVEN_NAME
                             SAVPSGNM,TILDA:     * MIDDLE_NAMES
                             PTITL,TILDA:        * NAME_TITLE
                             PMEWCDAT,TILDA:     * EFFECTIVE_START_DATE
                             SP900               * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,PMEWCTIM,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL060500
.
CL062000  PACK      OBJECTKY,PMEWURNO,ANSA,SP70
          MOVE      ZERO,F8
          UNPACK    PMEWNEWV,SAVPSNAM,SAVPFGNM,SAVPSGNM
.
          MOVE      ZERO,RECCOUNT
          MOVE      SP70,CMEWOKEY
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "06 ",CHANGOBJ                     * Adress
          PACK      CHANGKEY,PURNO,ANSA                * Change Key
          STRIP     CHANGKEY
          CALL      FNDL0000
.
          MATCH     SP70,CMEWOKEY
          IF        !@EQUAL
            UNPACK    CMEWOKEY,KEY8,KEY1,DIM8
            MOVE      DIM8,RECCOUNT
            MATCH     ANSD,OBJECTRT
            IF        !@EQUAL
              ADD       ONE,RECCOUNT
            ENDIF
          ENDIF
          SQUEEZE   D8
.
          MOVE      "06",OBJECTTY
          PACK      OBJECTKY,PMEWURNO,ANSA,RECCOUNT,SP70
          PACK      DIM8,PMEWURNO
          SQUEEZE   DIM8
          SQUEEZE   D8
.
          PACK      KEY16,RECCOUNT,SP70
          STRIP     SAVPSNAM
          STRIP     SAVPFGNM
          STRIP     SAVPSGNM
          SQUEEZE   KEY16
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             ANSA,KEY16,TILDA:   * CLIENT_NAME_RECORD_ID
                             ANSA,TILDA:         * NAME_TYPE_CODE
                             SAVPSNAM,TILDA:     * FAMILY_NAME
                             SAVPFGNM,TILDA:     * GIVEN_NAME
                             SAVPSGNM,TILDA:     * MIDDLE_NAMES
                             PTITL,TILDA:        * NAME_TITLE
                             PMEWCDAT,TILDA:     * EFFECTIVE_START_DATE
                             D8,SP900            * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMEWCDAT,SP70
          PACK      SRCRTIME,PMEWCTIM,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      CL060500
.
CL069999  RETURN
+
.******************************************************************************
.*  Find the last record count on comewdaf          
.******************************************************************************
FNDL0000  PACK      KEY112,CHANGSTM,CHANGOBJ,CHANGKEY,Z70
          CALL      RSCMEWD2
FNDL1000  CALL      RPCMEWD2                     * Loop sent objects
          BRANCH    OVRCD,FNDL9999
.
          MATCH     CHANGSTM,CMEWDSTR            * Stream
          GOTO      FNDL9000 IF NOT EQUAL
.
          MATCH     CHANGOBJ,CMEWOBJT            * Correct Object
          GOTO      FNDL9000 IF NOT EQUAL
.
          MATCH     CHANGKEY,CMEWOKEY            * Only match to length of
          GOTO      FNDL9000 IF NOT EQUAL        * DELETKEY after strip
.
          MATCH     ANSY,RERUNFL            * Ignore curreat date range
          IF        @EQUAL
            MOVE      CMEWCNTN,F8           * Include current extract records
            IF        CONTNUMB <> F8
              MATCH     STRTDATE,CMEWSDAT
              GOTO      FNDL1000 IF NOT LESS
            ENDIF
          ENDIF
.
          GOTO      FNDL9999
.
FNDL9000  MOVE      SP70,CMEWOKEY
.
FNDL9999  RETURN
+
.******************************************************************************
.*  Find a particular record on name record
.******************************************************************************
FNDT0000  STRIP     CHANGKEY
          STRIP     CHANGNVL
.
          PACK      KEY112,CHANGSTM,CHANGOBJ,CHANGKEY,Z70
          CALL      RSCMEWD2
FNDT1000  CALL      RPCMEWD2                     * Loop sent objects
          BRANCH    OVRCD,FNDT9999
.
          MATCH     CHANGSTM,CMEWDSTR            * Stream
          GOTO      FNDT9000 IF NOT EQUAL
.
          MATCH     CHANGOBJ,CMEWOBJT            * Correct Object
          GOTO      FNDT9000 IF NOT EQUAL
.
          MATCH     CHANGKEY,CMEWOKEY            * Only match to length of
          GOTO      FNDT9000 IF NOT EQUAL        * DELETKEY after strip
.
          MATCH     ANSY,RERUNFL            * Ignore curreat date range
          IF        @EQUAL
            MOVE      CMEWCNTN,F8           * Include current extract records
            IF        CONTNUMB <> F8
              MATCH     STRTDATE,CMEWSDAT
              GOTO      FNDT1000 IF NOT LESS
            ENDIF
          ENDIF
.
          UNPACK    PMEWNEWV,SAVPSNAM,SAVPFGNM,SAVPSGNM
.
          PACK      KEY40,SAVPSNAM
          MOVE      "5",CHANGCOL
          CALL      CHKSTR00
          BRANCH    EXIT,FNDT1000
.
          PACK      KEY40,SAVPFGNM
          MOVE      "6",CHANGCOL
          CALL      CHKSTR00
          BRANCH    EXIT,FNDT1000
.
          PACK      KEY40,SAVPSGNM
          MOVE      "7",CHANGCOL
          CALL      CHKSTR00
          BRANCH    EXIT,FNDT1000
.
          MOVE      ANSD,OBJECTRT
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "06 ",CHANGOBJ                     * NAME
          MOVE      "16",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * Change old U/R value
          MOVE      PMEWCDAT,CHANGNVL                  * Change new U/R value
          PACK      CHANGKEY,CMEWOKEY,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      CSOF0000           * Change sent stream object field
.
          GOTO      FNDT9999
.
FNDT9000  MOVE      SP70,CMEWOKEY
.
FNDT9999  RETURN
+
.******************************************************************************
.*  Find this record on comewdaf
.******************************************************************************
CHKSTR00  MOVE      ZERO,EXIT
          MOVE      SP70,CHANGAAA
          RESET     CHANGAAA
          CLEAR     CHANGAAA
          STRIP     KEY40
          MOVE      ZERO,F2
          MOVE      SP70,D1
.
CHKSTR20  UNPACK    CMEWTEXT,D1,CMEWTEXT         * Check char and count for ~
          GOTO      CHKSTR40 IF EOS
.
          MATCH     TILDA,D1
          IF        @EQUAL
            ADD       ONE,F2                     * Count ~ to find column
          ENDIF
.
          COMPARE   F2,CHANGCOL                  * Append to new text until
          GOTO      CHKSTR20 IF NOT EQUAL        * change column found
.
CHKSTR40  COMPARE   CHANGCOL,F2                  * Colum not found
          GOTO      CHKSTR99 IF NOT EQUAL
.
CHKSTR50  UNPACK    CMEWTEXT,D1,CMEWTEXT         * Check and count for ~
          GOTO      CHKSTR60 IF EOS
.
          MATCH     TILDA,D1
          IF        !@EQUAL
            APPEND    D1,CHANGAAA                * Save old column value
            GOTO      CHKSTR50
          ENDIF
.
CHKSTR60  UNPACK    CMEWTEXT,D1,CMEWTEXT         * Check and count for ~
          GOTO      CHKSTR90 IF EOS
.
          GOTO      CHKSTR60                     * new to new object text
.
CHKSTR90  RESET     CHANGAAA
          RESET     CMEWTEXT
          MATCH     KEY40,CHANGAAA
          GOTO      CHKSTR99 IF EQUAL
          MOVE      ONE,EXIT
.
CHKSTR99  RETURN
+
.******************************************************************************
.*  Find this record_id on pmsedwaf                 
.*  Loop pmsedwaf and count the record number           
.*  Requires : SAVKEY27 - exact pmsedwaf key
.*  returns: RECCOUNT
.*  returns: PREVDATE (the last change date prior - used for start date of rec)
.******************************************************************************
RECID000  MOVE      ZERO,RECCOUNT
          MOVE      SP70,PREVDATE
.
          UNPACK    SAVKEY27,THISDATE,THISTIME,URNUMBER,ALTTYPE
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,RECID900
.
          PACK      PREVDATE,PTMXRDAT,SP70
.
          PACK      KEY27,URNUMBER,ALTTYPE,SP70
          CALL      RSPMEDW2
RECID100  CALL      RKPMEDW2
          BRANCH    OVRCD,RECID900
.
          MATCH     URNUMBER,PMEWURNO
          GOTO      RECID900 IF NOT EQUAL
.
          MATCH     ALTTYPE,PMEWTYPE
          GOTO      RECID900 IF NOT EQUAL
.
          MATCH     PMEWCDAT,THISDATE
          GOTO      RECID900 IF LESS
.
          MATCH     THISTIME,PMEWCTIM
          GOTO      RECID900 IF NOT LESS
.
          ADD       ONE,RECCOUNT
          PACK      PREVDATE,PMEWCDAT
          GOTO      RECID100
.
. * re-position back on current record
.
RECID900  PACK      KEY27,SAVKEY27
          CALL      RDPMEDW1
          BRANCH    OVRCD,RECID999
.
RECID999  RETURN
+
.******************************************************************************
.*  CL080000 - Client Static Demographic records
.*  Loop pmsedwaf and extract type 1,2,3 and 4 records
.******************************************************************************
CL080000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL080500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL089999
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL089999 IF LESS
.
          MATCH     "1 ",PMEWTYPE
          GOTO      CL081000 IF EQUAL
.
          MATCH     "2 ",PMEWTYPE
          GOTO      CL081000 IF EQUAL
.
          MATCH     "3 ",PMEWTYPE
          GOTO      CL081000 IF EQUAL
.
          MATCH     "4 ",PMEWTYPE
          GOTO      CL080500 IF NOT EQUAL
.
. * new client - add 08 for client static demographics
CL081000  PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL080500
          CALL      RDPMPX21
          BRANCH    OVRCD,CL080500
.
. * ignore merged patients
          COMPARE   "1",PSTAT
          GOTO      CL080500 IF EQUAL
.
          PACK      SRCRDATE,PTMXRDAT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
          CALL      WR080000
.
          GOTO      CL080500
.
CL089999  RETURN
+
.******************************************************************************
.*  CL090000 - Client Identifier records (SENT AS 05)
.*  Loop pmsedwaf and extract type 16 records
.******************************************************************************
CL090000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL090500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL092000
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL092000 IF LESS
.
          MATCH     "16",PMEWTYPE
          GOTO      CL090500 IF NOT EQUAL
.
. * new client - add 09 for client identifier
CL091000  MOVE      "05",OBJECTTY
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL090500
.
. *** check still valid, send delete if no longer there
          PACK      KEY31,PMEWNEWV,SP70
          CALL      RDPMAID1
          IF        OVRCD=1
            MOVE      ANSD,OBJECTRT
            UNPACK    PMEWNEWV,DIM8,DIM3,PMAIALID
            PACK      PMAICRDT,PMEWCDAT
          ENDIF
.
          PACK      OBJECTKY,PMEWURNO,PMEWNEWV,SP70,SP70
          UNPACK    PMEWNEWV,DIM8,DIM3,DIM20
          MOVE      PMEWURNO,DIM8
          CALL      NEW05000
.
          GOTO      CL090500
.
CL092000
.
CL099999  RETURN
+
.******************************************************************************
.*  NEW05000 - Client Identifier records (SENT AS 05)
.******************************************************************************
NEW05000  SQUEEZE   DIM8
          SQUEEZE   DIM20
          SQUEEZE   PMAIALID
.
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             PMAIALID,TILDA: * EXT_CLIENT_REC_ID
                             ZERO,ZERO,FOUR,TILDA: *EXTERNAL_CLIENT_ID_TYPE_CODE
                             PTCNNEXT,TILDA:   * EXTERNAL_CLIENT_ID_ISSUING_AUTH
                             PMAIALID,TILDA:     *EXTERNAL_CLIENT_ID
                             PMAICRDT,TILDA:
                             SP900
.
          PACK      SRCRDATE,PMAICRDT,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PMAICRDT,SP70
          PACK      SRMDTIME,TIME001,SP70
          CALL      WRCOND00     * write record to container detail table
.
NEW05999  RETURN
+
.******************************************************************************
.*  CL100000 - Client Profile records
.*  Loop pmsedwaf and extract type 5,6,8,9,10 and 11 records
.******************************************************************************
CL100000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMEDW1
CL100500  CALL      RKPMEDW1
          BRANCH    OVRCD,CL100600
.
          PACK      KEY8,PMEWURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CL100500
.
. * ignore merged patients
          COMPARE   "1",PSTAT
          GOTO      CL100500 IF EQUAL
.
          PACK      STRATRD,PMEWCDAT
          PACK      ENDATRD,SP70
.
          MATCH     PMEWCDAT,ENDDATE
          GOTO      CL100600 IF LESS
.
          MATCH     PMEWOLDV,PMEWNEWV
          GOTO      CL100500 IF EQUAL
.
          MOVE      "1  ",CHANGSTM                     * 1=Client
          MOVE      "10 ",CHANGOBJ                     * RELATIONSHIP
          MOVE      "13",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * Change old U/R value
          MOVE      PMEWCDAT,CHANGNVL                  * Change new U/R value
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,PMEWCDAT,SP70
          PACK      SRMDTIME,PMEWCTIM,SP70
.
          MATCH     "5",PMEWTYPE
          IF        @EQUAL
            MOVE      "01",ATTRTYPE
            PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
            CALL      LSOF0000           * Change sent stream object field
            PACK      OBJECTKY,PMEWURNO,ATTRTYPE,PMEWNEWV,STRATRD,SP70
            MOVE      PMEWNEWV,ATTRVALU
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      WRPROF00     * write profile attribute records
            GOTO      CL100500
          ENDIF
.
          MATCH     "6",PMEWTYPE
          IF        @EQUAL
            MOVE      "02",ATTRTYPE
            PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
            CALL      LSOF0000           * Change sent stream object field
            PACK      OBJECTKY,PMEWURNO,ATTRTYPE,PMEWNEWV,STRATRD,SP70
            MOVE      PMEWNEWV,ATTRVALU
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      WRPROF00     * write profile attribute records
            GOTO      CL100500
          ENDIF
.
          MATCH     "18",PMEWTYPE
          IF        @EQUAL
            MOVE      "06",ATTRTYPE
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      GOVP0000  * check for government
            IF        EXIT=0
              PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
              CALL      LSOF0000           * Change sent stream object field
              PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
            ENDIF
            GOTO      CL100500
          ENDIF
.
          MATCH     "19",PMEWTYPE
          IF        @EQUAL
            MOVE      "06",ATTRTYPE
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      GOVP0000  * check for government
            IF        EXIT=0
              PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
              CALL      LSOF0000           * Change sent stream object field
              PACK      OBJECTKY,PURNO,ATTRTYPE,ATTRVALU,SP70,SP70
            ENDIF
            GOTO      CL100500
          ENDIF
.
          MATCH     "8",PMEWTYPE
          IF        @EQUAL
            MOVE      "07",ATTRTYPE
            PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
            CALL      LSOF0000           * Change sent stream object field
            PACK      OBJECTKY,PMEWURNO,ATTRTYPE,PMEWNEWV,STRATRD,SP70
            MOVE      PMEWNEWV,ATTRVALU
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      WRPROF00     * write profile attribute records
            GOTO      CL100500
          ENDIF
.
          MATCH     "9",PMEWTYPE
          IF        @EQUAL
            MOVE      "08",ATTRTYPE
            PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
            CALL      LSOF0000           * Change sent stream object field
            PACK      OBJECTKY,PMEWURNO,ATTRTYPE,PMEWNEWV,STRATRD,SP70
            MOVE      PMEWNEWV,ATTRVALU
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      WRPROF00     * write profile attribute records
            GOTO      CL100500
          ENDIF
.
          MATCH     "11",PMEWTYPE
          IF        @EQUAL
            MOVE      ANSN,ATTRVALU
            CMATCH    "1",PMEWNEWV
            IF         @EQUAL
              MOVE      ANSY,ATTRVALU
            ENDIF
            MOVE      "13",ATTRTYPE
            PACK      CHANGKEY,PMEWURNO,ATTRTYPE,SP70,SP70        * Change Key
            CALL      LSOF0000           * Change sent stream object field
            PACK      OBJECTKY,PMEWURNO,ATTRTYPE,D1,STRATRD,SP70
            PACK      SRCRDATE,PMEWCDAT,SP70
            PACK      SRCRTIME,PMEWCTIM,SP70
            PACK      SRMDDATE,PMEWCDAT,SP70
            PACK      SRMDTIME,PMEWCTIM,SP70
            CALL      WRPROF00     * write profile attribute records
            GOTO      CL100500
          ENDIF
.
          GOTO      CL100500
.
CL100600  PACK      KEY51,STRTDATE,SP70
          CALL      RSPTATR4
CL101000  CALL      RKPTATR4
          BRANCH    OVRCD,CL102000
.
          MATCH     PTARUDTE,ENDDATE
          GOTO      CL102000 IF LESS
.
          MATCH     "019",PTARTYPE
          GOTO      CL101000 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
.
            PACK      DELETKEY,PTARURNO,ATTRTYPE,PTARCOD1,PTARDATE,SP70
            CALL      DLOF0000                   * Delete last sent object
            GOTO      CL101000
          ENDIF
.
          MATCH     SP70,PTARCOD1
          GOTO      CL101000 IF EQUAL
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
.
          PACK      KEY5,ANSL,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF4,ATTRVALU
          ENDIF
.
          MOVE      "04",ATTRTYPE
          PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARCOD1,PTARDATE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
          CALL      WRPROF00     * write profile attribute records
          GOTO      CL101000
.
CL102000  PACK      KEY51,STRTDATE,SP70
          CALL      RSPTATR4
CL102100  CALL      RKPTATR4
          BRANCH    OVRCD,CL109999
.
          MATCH     PTARUDTE,ENDDATE
          GOTO      CL109999 IF LESS
.
          MATCH     "020",PTARTYPE          * NDIS
          GOTO      CL102100 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile 
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
.
            PACK      DELETKEY,PTARURNO,ONE,SEVEN,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent object
.
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile 
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
            PACK      DELETKEY,PTARURNO,ONE,EIGHT,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent object
.
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile 
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
            PACK      DELETKEY,PTARURNO,TWO,ZERO,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent object
.
            GOTO      CL102100
          ENDIF
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "17",ATTRTYPE         * NDIS Plan Manager
            MOVE      PTARCOD2,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ELSE
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
.
            PACK      DELETKEY,PTARURNO,ONE,SEVEN,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent objec
          ENDIF
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "18",ATTRTYPE         * NDIS Status
            MOVE      PTARCOD1,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ELSE
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
            PACK      DELETKEY,PTARURNO,ONE,EIGHT,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent object
          ENDIF
.
          PACK      STRATRD,PTARDATE,SP70
          PACK      ENDATRD,PTARFDTE,SP70
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARUDTE,SP70
          PACK      SRMDTIME,PTARUTME,SP70
.
          MATCH     SP70,PTARCOD3
          IF        !@EQUAL
            MOVE      "20",ATTRTYPE         * Disabliliyt or Impairment staus
            MOVE      PTARCOD3,ATTRVALU
            PACK      OBJECTKY,PTARURNO,ATTRTYPE,PTARDATE,SP70,SP70
            CALL      WRPROF00     * write profile attribute records
          ELSE
            MOVE      "1  ",DELETSTM             * 1=Client
            MOVE      "10 ",DELETOBJ             * Client Profile
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
            PACK      DELETKEY,PTARURNO,TWO,ZERO,PTARDATE:
                               SP70,SP70      * Delete Key
            CALL      DLOF0000                   * Delete last sent object
          ENDIF
.
          GOTO      CL102100
.
CL109999  RETURN
+
.******************************************************************************
.*  ME020000 - Merged, end 02 address objects
.******************************************************************************
ME020000  PACK     KEY8,DIM8,SP70
          CALL     RDMAST1
          BRANCH   OVRCD,ME029999
.
          PACK     DIM8A,SP70
          PACK     DIM8B,PTMXRDAT,SP70
.
          PACK     KEY24,PTMROLUR,PTMRRDTE,Z70
          CALL     RDSPADD1
          CALL     RDPPADD1
          BRANCH   OVRCD,ME020500   * if no prior, use master file
.
          MATCH    PAURNO,DIM8
          GOTO     ME020500 IF NOT EQUAL
.
          PACK     PADD1,PAADD1
          PACK     PADD2,PAADD2
          PACK     PSUBRB,PASUBR
          PACK     PADD4,PAADD4
          PACK     PPOST,PAPOST
          PACK     DIM8A,PADATE,SP70
          PACK     DIM8B,PADATE,SP70
.
ME020500  MOVE      "02",OBJECTTY
          PACK      OBJECTKY,PURNO,ONE,DIM8A,SP70
          MATCH     SP70,PADD1
          IF        @EQUAL
            MOVE      "NFIA",PSUBRB
            MOVE      "9999",PPOST
            MOVE      "NFD",PADD4
            MOVE      "1101",COUNTRY
          ENDIF
.
          MATCH     "NFIA",PSUBRB
          IF        @EQUAL
            MOVE      "NFD",PADD4
            MOVE      "9999",PPOST
          ENDIF
.
          MATCH     "NFA",PSUBRB
          IF        @EQUAL
            MOVE      "NFA",PADD4
            MOVE      "9998",PPOST
          ENDIF
.
          STRIP     PADD1
          STRIP     PADD2
          STRIP     PSUBRB
          STRIP     PPOST
          STRIP     PADD4
          STRIP     COUNTRY
          PACK      OBJECTTX,ANS035,TILDA:       * PRIMARY_CLIENT_ID_TYPE_CODE
                             PTCNNSSI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY
                             DIM8,TILDA:         * PRIMARY_CLIENT_RECORD_ID
                             ONE,DIM8B,TILDA:
                             ONE,TILDA:
                             PADD1,SP1,PADD2,TILDA:
                             PSUBRB,TILDA:
                             PPOST,TILDA:
                             PADD4,TILDA,TILDA,TILDA:
                             TILDA:
                             COUNTRY,TILDA:
                             ADDRESFL,TILDA:
                             DIM8B,TILDA:
                             DIM8C,SP900
.
          PACK      SRCRDATE,DIM8B,SP70
          PACK      SRCRTIME,TIME001,SP70
          PACK      SRMDDATE,PTMRRDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      WRCOND00     * write record to container detail table
.
ME029999  RETURN
+
.******************************************************************************
.*  CHKDK000 - Merged, check if the old details were kept
.******************************************************************************
CHKDK000  MOVE      ZERO,DETLKEPT
.
          PACK      KEY27,PTMRNWUR,TWO,THREE,SP70
          CALL      RSPMEDW2
CHKDK200  CALL      RKPMEDW2
          BRANCH    OVRCD,CHKDK999
.
          MATCH     PTMRNWUR,PMEWURNO
          GOTO      CHKDK999 IF NOT EQUAL
.
          MATCH     "23 ",PMEWTYPE
          GOTO      CHKDK999 IF NOT EQUAL
.
          MATCH     PMEWOLDV,PTMROLUR
          IF        @EQUAL
            MOVE      ONE,DETLKEPT
          ELSE 
            GOTO      CHKDK200
          ENDIF
.
CHKDK999  RETURN
+

