.******************************************************************************
.*   Module     :  PRMHDEXT                                                   *
.*                 Create NZ PRIMHD XML Extract file                          *
.*                 Used in IBAMEH16                                           *
.*                                                                            *
.*   Parameters :  Reads tempfile "primhd.."                                  *
.*                                                                            *
.* Modifications:                                                             *
.*       V11.01.03  03/12/2021  Davin          TSK 0913784                    *
.*                  Changed Family/Whanau Involvement collection start date   *
.*                  to SAVFWIDT instead of hardcoded 01/07/2021 (PROCAT10)    *
.*       V11.01.02  06/09/2021  Davin          TSK 0908531                    *
.*                  Only include Family/Whanau Involvement field if activity  *
.*                  start date is on or after 01/07/2021 (PROCAT10)           *
.*       V11.01.01  25/03/2021  Tracey Nguyen  TSK 0901817                    *
.*                  Added functionality for XXATFAMW new data element in the  *
.*                  Activity (AT) record XML that will be used to report      *
.*                  Family/Whanau Involvement for all activity records        *
.*----------------------------------------------------------------------------*
.*       V10.10.01  01/06/2017  Tracey Nguyen  TSK 0833934                    *
.*                  Replaced references to MEHCONFD.MHCNORID with SAVSSORG    *
.*                  for the new value of submitting Org Id value stored in    *
.*                  user defined 3 on category dh                             *
.*       V10.08.01  29/04/2016  Jill Parkinson TSK 0817063                    *
.*                  Added supplementary consumer record                       *
.*       V10.04.01  05/05/2014  Patrick Adair CAR 298965                      *
.*                  Change format of LS Header record Unique ID               *
.*       V10.03.02  23/04/2012  Mike Laming   CAR 261603                      *
.*                  Correct Tempfile Key (change Key31 to Key33)              *
.*       V10.03.01  12/04/2012  Mike Laming   CAR 261603                      *
.*                  Mods for MEHPATaf file change - see ATNO, MHPTOCUR        *
.*       V10.00.02  28/09/2010  Mike Laming   CAR 230740                      *
.*                  Increase DIM150 to DIM250, LCMDLINE from Dim 120 to 300   *
.*       V10.00.01  31/03/2010  Mike Laming   CAR 216783                      *
.*                  Remove <ORGANISATION_TYPE> XXRDOTYP (already done for LS) *
.*        V9.12.03  26/11/2009  Mike Laming   CAR 210949                      *
.*                  Mods to "CO" <FOCUS_OF_CARE> - not output if a Child      *
.*        V9.12.02  23/11/2009  Mike Laming   CAR 210363                      *
.*                  Change "zip" command as per Richard's note                *
.*        V9.12.01  30/07/2009  Mike Laming   CAR 201941                      *
.*                  Increase totals fields TOTRDNO & TOTLSNO to FORM 5        *
.*        V9.11.02  21/04/2009  Mike Laming   CAR 194314                      *
.*                  Mods for tempfile changes for "CO" record sequence        *
.*        V9.11.01  17/03/2009  Mike Laming   CAR 191877                      *
.*                  Mods to PRIMHD temp file increase siz of Unique No. field *
.*                  in IBAMEH16 and here                                      *
.*        V9.11.01  09/01/2009  Mike Laming   CAR 166690                      *
.*                  re-Ported from V9.10                                      *
.*        V9.10.04  20/10/2008  Mike Laming   CAR 166690                      *
.*                  Added MEHPTFaf PRIMHD Transmission file table             *
.*        V9.10.03  08/10/2008  Mike Laming   CAR 166690                      *
.*                  Stacks of little fixes                                    *
.*        V9.10.01  30/09/2008  Mike Laming   CAR 166690                      *
.*                  Stacks of little fixes                                    *
.*        V9.10.00  02/09/2008  Mike Laming   CAR 166690                      *
.*                  New routine                                               *
.*                                                                            *
.******************************************************************************
.
PRIMHDXT
PRMHD000  MOVE      ZERO,EXIT
          MOVE      ZERO,RECDISRD
          MOVE      ZERO,RECDISLS
          MOVE      ZERO,RECDISCO
          MOVE      ZERO,RECDISOT
          MOVE      ZERO,TOTRDNO 
          MOVE      ZERO,TOTLSNO 
.
          PACK      PATHNAME,MHCNEDIR,SP70
.
          CLEAR     PRNTLINE
          MOVE      "PRIMHD Extract started",PRNTLINE
          CALL      PRNT0000
.
          PACK      KEY33,SP70                                        *C-191877
          CALL      RSPRMH1                 * position tempfile
.
PRMHD100  CALL      RKPRMH1                 * read tempfile
          BRANCH    OVRCD,PRMHD800
.
          MOVE      PHSVRETY,PHRECTYP       * restore the Record type (fixes OT
.                                           * and OIs - OT was changed to "3")
.
          MOVE      PHRECTYP,F1             * if "RD" or "LS" records
          IF        F1 = 1 | F1 = 8
            CALL      WREXT000              * close previous RD or LS XML File  
          ELSE                              * if other record types
            IF        RECDISRD = 0
              CALL      SEQERR00
              GOTO      PRMHD100
            ENDIF 
          ENDIF
.
PRMHD500  PERFORM   F1,PROCRD00:            * 1 = RD record
                       PROCCO00:            * 2 = CO record (child of RD)
                       PROCOT00:            * 3 = OT record (child of CO)
                       PROCOI00:            * 4 = OI record (child of OT) ****
                       PROCAT00:            * 5 = AT record (child of RD)
                       PROCCN00:            * 6 = CN record (child of RD)
                       PROCSC00:            * 7 = SC record (child of RD)
                       PROCLS00             * 8 = LS record
.
          GOTO      PRMHD100                * 00 = HC record (not used)
.
PRMHD800  CALL      WREXT000                * close & rename previous XML File
.
          CLEAR     PRNTLINE                * print totals
          CALL      PRNT0000
          APPEND    "  RD Records extracted : ",PRNTLINE
          MOVE      TOTRDNO,KEY5  
          APPEND    KEY5,PRNTLINE
          CALL      PRNT0000
          CLEAR     PRNTLINE
          APPEND    "  LS Records extracted : ",PRNTLINE
          MOVE      TOTLSNO,KEY5
          APPEND    KEY5,PRNTLINE
          CALL      PRNT0000
.
          MOVE      TOTLSNO,F5
          ADD       TOTRDNO,F5
.
          CALL      PRNT0000
          IF        F5 > 0
            CALL      ZIPEXT00              * zip all XML files into one Zip
            CALL      PRHIS000              * write the PRIMHD Extract History
          ELSE
            APPEND    "    Zero records extracted - '.zip' ",PRNTLINE
            APPEND    "file was not created",PRNTLINE
            CALL      PRNT0000
          ENDIF
.
          CALL      PRNT0000
          MOVE      "*** end of Report ***",PRNTLINE
          CALL      PRNT0000
.
          CLOSE     EXTFILE1,DELETE         * delete XML temp file
.
PRMHD999  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCRD00
.                            Process "RD" record
. -----------------------------------------------------------------------------
PROCRD00  MOVE      ZERO,EXIT
          CALL      PENDRD00                * close any precious RD records
.
          MOVE      ONE,RECDISRD
          UNPACK    PHFIELDS,XXRDFVER,XXRDRFID,XXRDSORG,XXRDORID,XXRDOTYP:
                             XXRDFDAT,XXRDTDAT,XXRDDELT,XXRDTEAM,XXRDEHCU:
                             XXRDPSEX,XXRDPDOB,XXRDRFFR,XXRDRFTO,XXRDECOD:
                             XXRDRSTR,XXRDREND
.
          SQUEEZE   XXRDRFID
          STRIP     XXRDEHCU
          SQUEEZE   XXRDEHCU
          SQUEEZE   XXRDTEAM
.
          CALL      CRTMFIL0                * create temp XML file
          WRITE     EXTFILE1,SEQ;HED0001    * write Header XML records
.
          WRITE     EXTFILE1,SEQ;ST,RD00001             * <REFERRAL_DISCHARGE>
.
.
          WRITE     EXTFILE1,SEQ;ST,RD00002,XXRDFVER,STS,RD00002 * <FILE_VERSIO
          PACK      DIM250,ST,RD00003,XXRDRFID,STS,RD00003       * <REFERRAL_ID
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;ST,RD00004,XXRDSORG,STS,RD00004 * <SUBMITTING_
          WRITE     EXTFILE1,SEQ;ST,RD00005,XXRDORID,STS,RD00005 * <ORG_ID    
..removed.. WRITE     EXTFILE1,SEQ;ST,RD00006,XXRDOTYP,STS,RD00006 * <ORG_TYPE 
          WRITE     EXTFILE1,SEQ;ST,RD00007,XXRDFDAT,STS,RD00007 * <EXTRACT_FRO
          WRITE     EXTFILE1,SEQ;ST,RD00008,XXRDTDAT,STS,RD00008 * <EXTRACTED_D
          PACK      KEY7,XXRDDELT,SP10
          MATCH     SP7,KEY7
          IF        !@EQUAL
            PACK      DIM250,ST,RD00009,XXRDDELT,STS,RD00009     * <DELETE_FLAG
            WRITE     EXTFILE1,SEQ;*+,DIM250
          ENDIF
          PACK      DIM250,ST,RD00010,XXRDTEAM,STS,RD00010       * <TEAM_CODE>
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,RD00011,XXRDEHCU,STS,RD00011       * <EVENT_HCU_I
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;ST,RD00012,XXRDPSEX,STS,RD00012 * <SEX>       
          WRITE     EXTFILE1,SEQ;ST,RD00013,XXRDPDOB,STS,RD00013 * <DATE_OF_BIR
          WRITE     EXTFILE1,SEQ;ST,RD00014,XXRDRFFR,STS,RD00014 * <REFERRAL_FR
          WRITE     EXTFILE1,SEQ;ST,RD00015,XXRDRFTO,STS,RD00015 * <REFERRAL_TO
          WRITE     EXTFILE1,SEQ;ST,RD00016,XXRDECOD,STS,RD00016 * <REFERRAL_EN 
          WRITE     EXTFILE1,SEQ;ST,RD00017,XXRDRSTR,STS,RD00017 * <START_DATE_
          SQUEEZE   XXRDREND
          PACK      DIM250,ST,RD00018,XXRDREND,STS,RD00018       * <END_DATE_TI
.
          WRITE     EXTFILE1,SEQ;*+,DIM250
          ADD       ONE,TOTRDNO                                       *I-213741
.
PROCRD99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCCO00
.                            Process "CO" record
. -----------------------------------------------------------------------------
PROCCO00  MOVE      ZERO,EXIT    
          CALL      PENDCO00                * end "OT" and "CO" if active
          BRANCH    EXIT,PROCCO99
.
          MOVE      ONE,RECDISCO
          UNPACK    PHFIELDS,XXCOEVID,XXCOCCOD,XXCORCOL,XXCOCDAT:
                             XXCOWCPN,XXCOOESP,XXCOPVER,XXCOFCAR
.
          SQUEEZE   XXCOCCOD
          SQUEEZE   XXCOCDAT
          SQUEEZE   XXCOWCPN
.
          WRITE     EXTFILE1,SEQ;ST,CO00001             * <COLLECTION_OCCASION>
          PACK      DIM250,ST,CO00002,XXCOCCOD,STS,CO00002       * <COLLECTION_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;ST,CO00003,XXCORCOL,STS,CO00003 * <REASON_FOR_
          PACK      DIM250,ST,CO00004,XXCOCDAT,STS,CO00004       * <COLLECTION_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CO00005,XXCOWCPN,STS,CO00005       * <HEALTHCAR
          WRITE     EXTFILE1,SEQ;*+,DIM250
          MATCH     SP9,XXCOOESP
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,CO00006,XXCOOESP,STS,CO00006 * <OUTCOME_E
          ENDIF
          MATCH     SP4,XXCOPVER
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,CO00007,XXCOPVER,STS,CO00007 * <PROTOCOL_
          ENDIF
          MATCH     SP4,XXCOFCAR                                      *I-210949
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,CO00008,XXCOFCAR,STS,CO00008 * <FOCUS_OF_C
          ENDIF                                                       *I-210949
.
PROCCO99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCOT00
.                            Process "OT" record
. -----------------------------------------------------------------------------
PROCOT00  MOVE      ZERO,EXIT               * check that a "CO" has been read
          IF        RECDISCO = 0
            CALL      ERRCO000
          ENDIF
.
.                   * for sequencing in IBAMEH16
.                   *     - an "OT" record has Rec.Type = 3 and Unique No. = 1
.                   *     - an "OI" record has Rec.Type = 3 and Unique No. > 1
.
          IF        RECDISOT = 1
            WRITE     EXTFILE1,SEQ;STS,OT00001          * </OUTCOME_TOOL>
            MOVE      ZERO,RECDISOT
          ENDIF
.
          MOVE      ONE,RECDISOT            * set "OT read" indicator
          UNPACK    PHFIELDS,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA,XXOTCDAT
.
          SQUEEZE   XXOTCDAT
.
          WRITE     EXTFILE1,SEQ;ST,OT00001             * <OUTCOME_TOOL>      
          WRITE     EXTFILE1,SEQ;ST,OT00003,XXOTTYPE,STS,OT00003 * <OUTCOME_TOO
          WRITE     EXTFILE1,SEQ;ST,OT00004,XXOTMADM,STS,OT00004 * <MODE_OF_ADM
          WRITE     EXTFILE1,SEQ;ST,OT00005,XXOTCSTA,STS,OT00005 * <COLLECTION_
          PACK      DIM250,ST,OT00006,XXOTCDAT,STS,OT00006       * <COMPLETION_
          WRITE     EXTFILE1,SEQ;*+,DIM250
.
PROCOT99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCOI00
.                            Process "OI" record
. -----------------------------------------------------------------------------
PROCOI00  MOVE      ZERO,EXIT     
          IF        RECDISOT = 0
            CALL      ERROT000
          ENDIF
.
          UNPACK    PHFIELDS,XXOIEVID,XXOIOITM,XXOIIVAL
.
          WRITE     EXTFILE1,SEQ;ST,OI00001             * <OUTCOME_ITEM>
          WRITE     EXTFILE1,SEQ;ST,OI00002,XXOIOITM,STS,OI00002 * <OUTCOME_ITE
          WRITE     EXTFILE1,SEQ;ST,OI00004,XXOIIVAL,STS,OI00004 * <OUTCOME_ITEM
          WRITE     EXTFILE1,SEQ;STS,OI00001            * </OUTCOME_ITEM>
.
PROCOI99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCAT00
.                            Process "AT" record
. -----------------------------------------------------------------------------
PROCAT00  MOVE      ZERO,EXIT     
          CALL      PENDCO00                * end "OT" and "CO" if active
          BRANCH    EXIT,PROCAT99
.
.-------- UNPACK    PHFIELDS,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                    XXATSDAT,XXATEDAT
          UNPACK    PHFIELDS,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                             XXATWCPN,XXATSDAT,XXATEDAT
.
          SQUEEZE   XXATACID
          SQUEEZE   XXATEDAT
.
PROCAT10  MOVE      XXATSDAT,DIM10
          REP       "- ",DIM10
          SQUEEZE   DIM10
          MOVE      DIM10,D8                * activity start date (TSK 0908531)
.
          WRITE     EXTFILE1,SEQ;ST,AT00001             * <ACTIVITY>
          PACK      DIM250,ST,AT00002,XXATACID,STS,AT00002       * <ACTIVITY_ID
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;ST,AT00003,XXATATYP,STS,AT00003 * <ACTIVITY_TY
          WRITE     EXTFILE1,SEQ;ST,AT00004,XXATASET,STS,AT00004 * <ACTIVITY_SE
.
.         Is AT start date >= Family/Whanau Involvement collection start date ?
          MATCH     SAVFWIDT,D8
          IF        !@LESS
            WRITE     EXTFILE1,SEQ;ST,AT00004A,XXATFAMW,STS,AT00004A *<FAMILY_WH
          ENDIF
          MATCH     SP6,XXATWCPN
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,AT00005,XXATWCPN,STS,AT00005 * <HEALTHCAR
          ENDIF
          WRITE     EXTFILE1,SEQ;ST,AT00006,XXATSDAT,STS,AT00006 * <START_DATE_T
          PACK      DIM250,ST,AT00007,XXATEDAT,STS,AT00007       * <END_DATE_TI
          WRITE     EXTFILE1,SEQ;*+,DIM250
.
          WRITE     EXTFILE1,SEQ;STS,AT00001            * </ACTIVITY>
.
PROCAT99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCCN00
.                            Process "CN" record
. -----------------------------------------------------------------------------
PROCCN00  MOVE      ZERO,EXIT     
          CALL      PENDCO00                * end "OT" and "CO" if active
          BRANCH    EXIT,PROCCN99
.
          UNPACK    PHFIELDS,XXCNEVID,XXCNCSCD,XXCNCSYS,XXCNDTYP,XXCNCCOD:
                             XXCNICID,XXCNITYP,XXCNIVAL,XXCNSDAT,XXCNEDAT
.
          SQUEEZE   XXCNCSCD
          SQUEEZE   XXCNCCOD
          SQUEEZE   XXCNICID
          SQUEEZE   XXCNITYP
          SQUEEZE   XXCNIVAL
          SQUEEZE   XXCNSDAT
          SQUEEZE   XXCNEDAT
.
          WRITE     EXTFILE1,SEQ;ST,CN00001             * <CLASSIFICATION>
          PACK      DIM250,ST,CN00002,XXCNCSCD,STS,CN00002       * <CLASSIFICAT
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;ST,CN00003,XXCNCSYS,STS,CN00003 * <CLINICAL_CO
          WRITE     EXTFILE1,SEQ;ST,CN00004,XXCNDTYP,STS,CN00004 * <DIAGNOSIS_T
          PACK      DIM250,ST,CN00005,XXCNCCOD,STS,CN00005       * <CLINICAL_CO
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CN00006,XXCNICID,STS,CN00006       * <ISSUE_CODIN
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CN00007,XXCNITYP,STS,CN00007       * <ISSUE_TYPE>
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CN00008,XXCNIVAL,STS,CN00008       * <ISSUE_CODE_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CN00009,XXCNSDAT,STS,CN00009       * <START_DATE_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,CN00010,XXCNEDAT,STS,CN00010       * <END_DATE_TI
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;STS,CN00001            * </COLLECTION_OCCASION>
.
PROCCN99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCSC00
.                            Process "SC" record
. -----------------------------------------------------------------------------
PROCSC00  MOVE      ZERO,EXIT
          CALL      PENDCO00                * end "OT" and "CO" if active
          BRANCH    EXIT,PROCSC99
.
          UNPACK    PHFIELDS,XXSCUNIQ,XXSCCOLD,XXSCWELP,XXSCACCM,XXSCEMPS:
                             XXSCEDUC,SP70,SP70

.
          SQUEEZE   XXSCUNIQ
          SQUEEZE   XXSCCOLD
          SQUEEZE   XXSCWELP
          SQUEEZE   XXSCACCM
          SQUEEZE   XXSCEDUC
.
          WRITE     EXTFILE1,SEQ;ST,SC00000  *<SUPPLEMENTARY_CONSUMER_RECORD>
          PACK      DIM250,ST,SC00001,XXSCUNIQ,STS,SC00001       * <ID>
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,SC00002,XXSCCOLD,STS,SC00002       * <COLLECTION_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,SC00003,XXSCWELP,STS,SC00003       * <WELLNESS_PL
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,SC00004,XXSCACCM,STS,SC00004       * <ACCOMMODATI
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,SC00005,XXSCEMPS,STS,SC00005       * <EMPLOYMENT_
          WRITE     EXTFILE1,SEQ;*+,DIM250
          PACK      DIM250,ST,SC00006,XXSCEDUC,STS,SC00006       * <EDUCATION_ST
          WRITE     EXTFILE1,SEQ;*+,DIM250
          WRITE     EXTFILE1,SEQ;STS,SC00000            * </SUPPLEMENTARY_CONSU>
.
PROCSC99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PROCLS00
.                            Process "LS" record
. -----------------------------------------------------------------------------
PROCLS00  MOVE      ZERO,EXIT     
          CALL      PENDRD00                * close any previous RD Records
.
          MOVE      ONE,RECDISLS
          UNPACK    PHFIELDS,XXLSFVER,XXLSLSID,XXLSSORG,XXLSORID,XXLSOTYP:
                             XXLSEHCU,XXLSLSCD,XXLSRCPN,XXLSSDAT,XXLSEDAT:
                             XXLSFDAT,XXLSTDAT,XXLSDELT,XXLSPSEX,XXLSPDOB
.
.                                           * multiple sends of one Legal Status
.          UNPACK    PHUNQNUM,DIM2,KEY3                                *C-261603
.          REP       " 0",KEY3
.          PACK      KEY11,PHVISNUM,KEY3,SP10 * add Unique no. to LS Id.
.          LJUSTIFY  KEY11
.                                            * replacement for XXLSLSID
          UNPACK    XXLSSDAT,XCENT,XYEAR,DIM1A,XMON,DIM1A,XDAY,DIM1A,CALHH,DIM1A:
                             CALMM,DIM1A,CALSS
          STRIP     XXLSLSID
          PACK      XXLSLSID,XXLSLSID,XYEAR,XMON,XDAY,CALHH,CALMM,CALSS,SP20
.
          SQUEEZE   XXLSLSID
          STRIP     XXLSEHCU
          SQUEEZE   XXLSEHCU
          SQUEEZE   XXLSEDAT
          SQUEEZE   XXLSRCPN
.
          CALL      CRTMFIL0                * create temp XML file
          WRITE     EXTFILE1,SEQ;HED0001    * write Header XML records
.
          WRITE     EXTFILE1,SEQ;ST,LS00001             * <LEGAL_STATUS>      
          WRITE     EXTFILE1,SEQ;ST,LS00002,XXLSFVER,STS,LS00002 * <FILE_VERSIO
          PACK      DIM80A,ST,LS00003,XXLSLSID,STS,LS00003       * <LEGAL_STATU
          WRITE     EXTFILE1,SEQ;*+,DIM80A
          WRITE     EXTFILE1,SEQ;ST,LS00004,XXLSSORG,STS,LS00004 * <SUBMITTING_
          WRITE     EXTFILE1,SEQ;ST,LS00005,XXLSORID,STS,LS00005 * <ORGANISATIO
          WRITE     EXTFILE1,SEQ;ST,LS00006,XXLSFDAT,STS,LS00006 * <EXTRACT_FRO
          WRITE     EXTFILE1,SEQ;ST,LS00007,XXLSTDAT,STS,LS00007 * <EXTRACTED_D
          PACK      KEY7,XXLSDELT,SP10
          MATCH     SP7,KEY7
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,LS00008,XXLSDELT,STS,LS00008 * <DELETED_F
          ENDIF
..Deleted WRITE     EXTFILE1,SEQ;ST,LS00009,XXLSOTYP,STS,LS00009 * <ORGANISATIO
          PACK      DIM80A,ST,LS00010,XXLSEHCU,STS,LS00010       * <EVENT_HCU_I
          WRITE     EXTFILE1,SEQ;*+,DIM80A
          WRITE     EXTFILE1,SEQ;ST,LS00011,XXLSPSEX,STS,LS00011 * <SEX>
          WRITE     EXTFILE1,SEQ;ST,LS00012,XXLSPDOB,STS,LS00012 * <DATE_OF_BIR
          WRITE     EXTFILE1,SEQ;ST,LS00013,XXLSLSCD,STS,LS00013 * <LEGAL_STATU
....      WRITE     EXTFILE1,SEQ;ST,LS00014,XXLSRCPN,STS,LS00014 * <RESPONSIBLE
          PACK      DIM80A,ST,LS00014,XXLSRCPN,STS,LS00014       * <RESPONSIBLE
          WRITE     EXTFILE1,SEQ;*+,DIM80A
          WRITE     EXTFILE1,SEQ;ST,LS00015,XXLSSDAT,STS,LS00015 * <START_DATE_
          PACK      DIM80A,ST,LS00016,XXLSEDAT,STS,LS00016       * <END_DATE_TI
          WRITE     EXTFILE1,SEQ;*+,DIM80A
.
          MATCH     "1",MHCNELIV            * running in Test mode?
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,PR00001
            WRITE     EXTFILE1,SEQ;ST,PR00002,PR00002A,STS,PR00002
            WRITE     EXTFILE1,SEQ;ST,PR00003,PR00003A,STS,PR00003
            WRITE     EXTFILE1,SEQ;STS,PR00001
          ENDIF
.
          ADD       ONE,TOTLSNO
.
PROCLS99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PENDRD00
.                          Process "RD" end           
. -----------------------------------------------------------------------------
PENDRD00  CALL      PENDCO00                * end "OT" and "CO" if active
          BRANCH    RECDISRD,PENDRD10
          GOTO      PENDRD90
.
PENDRD10  MATCH     "1",MHCNELIV            * running in Test mode?
          IF        !@EQUAL
            WRITE     EXTFILE1,SEQ;ST,PR00001
            WRITE     EXTFILE1,SEQ;ST,PR00002,PR00002A,STS,PR00002
            WRITE     EXTFILE1,SEQ;ST,PR00003,PR00003A,STS,PR00003
            WRITE     EXTFILE1,SEQ;STS,PR00001
          ENDIF
.
          WRITE     EXTFILE1,SEQ;STS,RD00001        * </REFERRAL_DISCHARGE>
          MOVE      ZERO,RECDISRD
.
PENDRD90  MOVE      ZERO,RECDISRD
          MOVE      ZERO,RECDISCO
          MOVE      ZERO,RECDISOT
          MOVE      ZERO,RECDISLS
.
PENDRD99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PENDCO00
.                   Check if end of "OT" and/or "CO"             
. -----------------------------------------------------------------------------
PENDCO00  IF        RECDISOT = 1
            WRITE     EXTFILE1,SEQ;STS,OT00001     * </OUTCOME_TOOL>
            MOVE      ZERO,RECDISOT
          ENDIF
.
          IF        RECDISCO = 1
            WRITE     EXTFILE1,SEQ;STS,CO00001     * </COLLECTION_OCCASION>
            MOVE      ZERO,RECDISCO
          ENDIF
.
PENDCO99  RETURN
.
. -----------------------------------------------------------------------------
.                                    CRTMFIL0
.                   Create temp XML file for "RD" & "LS" records
. -----------------------------------------------------------------------------
CRTMFIL0  MOVE      ZERO,EXIT 
          MOVE      "meh16xml",DIM8A
          PACK      EXTFNAME,DIM8A,DOT,TXT     
          PREP      EXTFILE1,EXTFNAME       * create the tempfile
.
.                                           * set up MoH File Name (MOHFNAM)
          PACK      DIM250,SP70,SP70,SP70,SP70
          CLEAR     DIM250 
.                                           * PATHNAME from MHCNEDIR
          APPEND    PATHNAME,DIM250         * .... use default path instead
          MATCH     "1",PHRECTYP            * "RD" record type ?
          IF        @EQUAL
            APPEND    "R",DIM250        * RYYYYMMDD_Org_ID_Referral_ID.XML
            APPEND    MHCNEDAT,DIM250
            APPEND    USC,DIM250
...         APPEND    XXRDSORG,DIM250       * Submitting Org
            APPEND    XXRDORID,DIM250       * Org Id
            APPEND    USC,DIM250
            APPEND    XXRDRFID,DIM250
          ENDIF
.
          MATCH     "8",PHRECTYP            * "LS" record type ?
          IF        @EQUAL
            APPEND    "L",DIM250        * LYYYYMMDD_Org_ID_Legal_Status_ID.XML
            APPEND    MHCNEDAT,DIM250
            APPEND    USC,DIM250
...         APPEND    XXLSSORG,DIM250       * Submitting Org
            APPEND    XXLSORID,DIM250       * Org Id
            APPEND    USC,DIM250
            APPEND    XXLSLSID,DIM250
          ENDIF
.
CRTMFIL5  RESET     DIM250
          SQUEEZE   DIM250
          PACK      MOHFNAM,DIM250,DOT,XML
          STRIP     MOHFNAM
.
CRTMFIL9  RETURN
. -----------------------------------------------------------------------------
.                                    WREXT000
.                   Close temp XML file and move to new file name
. -----------------------------------------------------------------------------
WREXT000  MOVE      ZERO,EXIT
.
          IF        RECDISRD = 0 & RECDISLS = 0
            GOTO      WREXT999
          ENDIF
.
          IF        RECDISRD = 1
            CALL      PENDRD00              * end "RD" XML               
          ENDIF
.          
          IF        RECDISLS = 1
            WRITE     EXTFILE1,SEQ;STS,LS00001        * </LEGAL_STATUS>
            MOVE      ZERO,RECDISLS
          ENDIF
.         
          CLOSE     EXTFILE1
.                                           * move "meh16xml" to new XML name.
WREXT500  MOVE      "mv ",LCMDLINE
          ENDSET    LCMDLINE
          APPEND    EXTFNAME,LCMDLINE
          APPEND    SP1,LCMDLINE
          APPEND    MOHFNAM,LCMDLINE
          RESET     LCMDLINE
          DISPLAY   *P1:23,LCMDLINE
          EXECUTE   LCMDLINE,TASKID
.
          MATCH     "0       ",TASKID
          IF        !@EQUAL
            CLEAR     PRNTLINE
            APPEND    "Error when renaming the XML File - ",PRNTLINE
            APPEND    TASKID,PRNTLINE
            APPEND    " for Command -",PRNTLINE
            CALL      PRNT0000
            PACK      PRNTLINE,SP10,LCMDLINE
            CALL      PRNT0000
          ENDIF
.
WREXT999  RETURN
.
. -----------------------------------------------------------------------------
.                                    ZIPEXT00
.                        Execute "zip" to create Zip file
. -----------------------------------------------------------------------------
ZIPEXT00  MOVE      ZERO,EXIT
.                           Prod'n   Testing
          BRANCH    OPTION,ZIPEXT10,ZIPEXT99
.                                           * set up MoH Zip File Name
ZIPEXT10  PACK      DIM250,SP70,SP70,SP70
          CLEAR     DIM250
          APPEND    PATHNAME,DIM250         * from MHCNEDIR
          APPEND    "PE",DIM250          * PEYYYYMMDD_Submitting_Org_Id_xxx.zip
          APPEND    MHCNEDAT,DIM250         * Date
          APPEND    USC,DIM250
..........APPEND    MHCNORID,DIM250         * Submitting_Org_Id
          APPEND    SAVSSORG,DIM250         * Submitting_Org_Id     *C-0833934
          APPEND    USC,DIM250
          APPEND    MHCNENUM,DIM250         * extract no. for today
          RESET     DIM250
          SQUEEZE   DIM250
.
...EXT50  MOVE      "zip -jm ",LCMDLINE     * "zip -jm path/PEname ?date*.XML "
...       ENDSET    LCMDLINE
...       SQUEEZE   PATHNAME
...       SQUEEZE   MHCNEDAT
...       APPEND    DIM250,LCMDLINE
...       APPEND    SP1,LCMDLINE
...       APPEND    PATHNAME,LCMDLINE       * .... use default directory instead
...       APPEND    "?",LCMDLINE
...       APPEND    MHCNEDAT,LCMDLINE
...       APPEND    "*.XML",LCMDLINE
...       RESET     LCMDLINE
.
.
. find . -name "?yyyymmdd*.XML" | xargs zip  -jm  path_name/PEyyyymmdd_orgid_nnn
.     where "find . " means "find pathname "
.
ZIPEXT50  CLEAR     LCMDLINE                                 * start  *C-210363
          SQUEEZE   PATHNAME
          MOVE      "find ",KEY5
          APPEND    KEY5,LCMDLINE
          APPEND    PATHNAME,LCMDLINE
          MOVE      " -name #"?",DIM9A
          APPEND    DIM9A,LCMDLINE
          SQUEEZE   MHCNEDAT
          APPEND    MHCNEDAT,LCMDLINE
          MOVE      "*.XML#" | ",DIM9A
          APPEND    DIM9A,LCMDLINE
          MOVE      "xargs zip -jm ",DIM15A
          APPEND    DIM15A,LCMDLINE
          APPEND    DIM250,LCMDLINE
          RESET     LCMDLINE                                 * end    *C-210363
.
          CLEAR     PRNTLINE
          APPEND    "Creating '.zip' file -     ",PRNTLINE
          APPEND    DIM250,PRNTLINE
          APPEND    ".zip",PRNTLINE
          CALL      PRNT0000
          CLEAR     PRNTLINE                                 * test stuff
          CALL      PRNT0000                                 * test stuff
          MOVE      "Zip command =  ",DIM15A                 * test stuff
          PACK      PRNTLINE,DIM15A,LCMDLINE                 * test stuff
          CALL      PRNT0000                                 * test stuff
.
          EXECUTE   LCMDLINE,TASKID
          DISPLAY   *P1:23,LCMDLINE,*W3
.
ZIPEXT60  MATCH     "0       ",TASKID
          IF        !@EQUAL
            CLEAR     PRNTLINE
            APPEND    "Error when zipping the XML Files - ",PRNTLINE
            APPEND    TASKID,PRNTLINE
            CALL      PRNT0000
          ENDIF
.
          CALL      DISPHEAD
.
.
ZIPEXT99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PRHIS000
.                        Write PRIMHD Extract History 
. -----------------------------------------------------------------------------
PRHIS000  MOVE      ZERO,EXIT               * read tempfile for PRIMHD history
          MOVE      ZERO,ATNO
          MOVE      ZERO,CNNO
          MOVE      ZERO,CONO
          MOVE      ZERO,OTNO
          MOVE      ZERO,OINO
          MOVE      ZERO,TOTLSNO
          MOVE      ZERO,TOTRDNO
.                
          PACK      KEY33,SP70                                        *C-191877
          CALL      RSPRMH1                 * position tempfile
.
PRHIS100  CALL      RKPRMH1                 * read tempfile
          BRANCH    OVRCD,PRHIS500
.
          MOVE      PHSVRETY,PHRECTYP       * restore the Record type (fixes
.                                           * OT and OIs)
.
          MOVE      PHRECTYP,F1
          PERFORM   F1,PHISRD00:            * 1 = RD record
                       PHISCO00:            * 2 = CO record (child of RD)
                       PHISOT00:            * 3 = OT record (child of CO)
                       PHISOI00:            * 4 = OI record (child of OT) ****
                       PHISAT00:            * 5 = AT record (child of RD)
                       PHISCN00:            * 6 = CN record (child of RD)
                       PHISSC00:            * 7 = SC record
                       PHISLS00             * 8 = LS record
.
          GOTO      PRHIS100                * 00 = HC record (not used)
.
.
.                                           * Write the Transmission File Record
PRHIS500  MOVE      ZERO,EXIT
          MOVE      MHCNEDAT,MHPFXDAT
          MOVE      MHCNENUM,MHPFXNUM
          PACK      KEY11,MHPFXDAT,MHPFXNUM,SP10
..........MOVE      MHCNORID,MHPFSORG
          MOVE      SAVSSORG,MHPFSORG       * Submitting Org Id     *C-0833934
          MOVE      "1",MHPFSTAT
          MOVE      STRTDATE,MHPFFDAT
          MOVE      ENDDATE,MHPFTDAT
          MOVE      TOTRDNO,MHPFRDNO
          MOVE      TOTLSNO,MHPFLSNO
          UNPACK    SP70,MHPFRDER,MHPFRDWN,MHPFLSER,MHPFLSWN,MHPFSPAR
.
          CALL      WRMHPTF1
.
PRHIS999  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISRD00
.                              record "RD" history
. -----------------------------------------------------------------------------
PHISRD00  MOVE      ZERO,EXIT
          MOVE      ZERO,ATNO
          MOVE      ZERO,CNNO
          MOVE      ZERO,CONO
          MOVE      ZERO,OTNO
          MOVE      ZERO,OINO
          CALL      CLMHPD00                * clear "mehprdaf" fields        
.
          REP       " 0",MHCNENUM
          PACK      KEY19,MHCNEDAT,MHCNENUM,PHVISNUM,SP30
          CALL      RAMHPRD1
          COMPARE   ZERO,OVRCD
          GOTO      PHISRD90 IF EQUAL
.
          UNPACK    KEY19,MHPDXDAT,MHPDXNUM,MHPDVISN
          PACK      MHPDURNO,PHURNUMB,SP30
          MOVE      "1",MHPDSTAT            * History Status to "Sent"
.
          UNPACK    PHFIELDS,XXRDFVER,XXRDRFID,XXRDSORG,XXRDORID,XXRDOTYP:
                             XXRDFDAT,XXRDTDAT,XXRDDELT,XXRDTEAM,XXRDEHCU:
                             XXRDPSEX,XXRDPDOB,XXRDRFFR,XXRDRFTO,XXRDECOD:
                             XXRDRSTR,XXRDREND
          PACK      MHPDFVER,XXRDFVER,SP30
          PACK      MHPDRFID,XXRDRFID,SP30
          PACK      MHPDSORG,XXRDSORG,SP30
          PACK      MHPDORID,XXRDORID,SP30
          PACK      MHPDOTYP,XXRDOTYP,SP30
          PACK      MHPDFDAT,XXRDFDAT,SP30
          PACK      MHPDTDAT,XXRDTDAT,SP30
          PACK      MHPDDELT,XXRDDELT,SP30
          PACK      MHPDTEAM,XXRDTEAM,SP30
          PACK      MHPDEHCU,XXRDEHCU,SP30
          PACK      MHPDPSEX,XXRDPSEX,SP30
          PACK      MHPDPDOB,XXRDPDOB,SP30
          PACK      MHPDRFFR,XXRDRFFR,SP30
          PACK      MHPDRFTO,XXRDRFTO,SP30
          PACK      MHPDECOD,XXRDECOD,SP30
          PACK      MHPDRSTR,XXRDRSTR,SP30
          PACK      MHPDREND,XXRDREND,SP30
.
          CALL      WRMHPRD1
          ADD       ONE,TOTRDNO
          GOTO      PHISRD99
.
PHISRD90  MOVE      ONE,EXIT
.
PHISRD99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISAT00
.                              record "AT" history
. -----------------------------------------------------------------------------
PHISAT00  MOVE      ZERO,EXIT
.
          ADD       ONE,ATNO
.                                                                     C-261603
          PACK      KEY32,MHCNEDAT,MHCNENUM,PHVISNUM,PHURNUMB,ATNO,SP30
          CALL      RAMHPAT1
          COMPARE   ZERO,OVRCD
          GOTO      PHISAT90 IF EQUAL
.
.                                                                     C-261603
          UNPACK    KEY32,MHPTXDAT,MHPTXNUM,MHPTVISN,MHPTURNO,MHPTOCUR
.-------- UNPACK    PHFIELDS,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                    XXATSDAT,XXATEDAT
          UNPACK    PHFIELDS,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                             XXATWCPN,XXATSDAT,XXATEDAT
          PACK      MHPTACID,XXATACID,SP30
          PACK      MHPTATYP,XXATATYP,SP30
          PACK      MHPTASET,XXATASET,SP30
          PACK      MHPTFAMW,XXATFAMW,SP30
          PACK      MHPTWCPN,XXATWCPN,SP30
          PACK      MHPTSDAT,XXATSDAT,SP30
          PACK      MHPTEDAT,XXATEDAT,SP30
.
          CALL      WRMHPAT1
          GOTO      PHISAT99
.
PHISAT90  MOVE      ONE,EXIT
.
PHISAT99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISCN00
.                              record "CN" history
. -----------------------------------------------------------------------------
PHISCN00  MOVE      ZERO,EXIT
.
          ADD       ONE,CNNO
          PACK      KEY30,MHCNEDAT,MHCNENUM,PHVISNUM,PHURNUMB,CNNO,SP30
          CALL      RAMHPCN1
          COMPARE   ZERO,OVRCD
          GOTO      PHISCN90 IF EQUAL
.
          UNPACK    KEY30,MHPNXDAT,MHPNXNUM,MHPNVISN,MHPNURNO,MHPNOCUR
          UNPACK    PHFIELDS,XXCNEVID,XXCNCSCD,XXCNCSYS,XXCNDTYP,XXCNCCOD:
                             XXCNICID,XXCNITYP,XXCNIVAL,XXCNSDAT,XXCNEDAT
          PACK      MHPNCSCD,XXCNCSCD,SP30
          PACK      MHPNCSYS,XXCNCSYS,SP30
          PACK      MHPNDTYP,XXCNDTYP,SP30
          PACK      MHPNCCOD,XXCNCCOD,SP30
          PACK      MHPNICID,XXCNICID,SP30
          PACK      MHPNITYP,XXCNITYP,SP30
          PACK      MHPNIVAL,XXCNIVAL,SP30
          PACK      MHPNSDAT,XXCNSDAT,SP30
          PACK      MHPNEDAT,XXCNEDAT,SP30

          CALL      WRMHPCN1
          GOTO      PHISCN99
.
PHISCN90  MOVE      ONE,EXIT
.
PHISCN99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISSC00
.                              record "SC" history
. -----------------------------------------------------------------------------
PHISSC00  MOVE      ZERO,EXIT
.
          ADD       ONE,CNNO
          PACK      KEY30,MHPCXDAT,MHPCXNUM,PHVISNUM,PHURNUMB,CNNO,SP30
          CALL      RAMHPCS1
          COMPARE   ZERO,OVRCD
          GOTO      PHISSC90 IF EQUAL
.
          UNPACK    KEY30,MHPCXDAT,MHPCXNUM,MHPCVISN,MHPCURNO,MHPCOCUR
          UNPACK    PHFIELDS,XXSCUNIQ,XXSCCOLD,XXSCWELP,XXSCACCM,XXSCEMPS:
                             XXSCEDUC
          PACK      MHPCUNIQ,XXSCUNIQ,SP30
          PACK      MHPCCOLD,XXSCCOLD,SP30
          PACK      MHPCWELP,XXSCWELP,SP30
          PACK      MHPCACCM,XXSCACCM,SP30
          PACK      MHPCEMPS,XXSCEMPS,SP30
          PACK      MHPCEDUC,XXSCEDUC,SP30
.
          CALL      WRMHPCS1
          GOTO      PHISSC99
.
PHISSC90  MOVE      ONE,EXIT
.
PHISSC99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISCO00
.                              record "CO" history
. -----------------------------------------------------------------------------
PHISCO00  MOVE      ZERO,EXIT
          MOVE      ZERO,OTNO
          MOVE      ZERO,OINO
.
          ADD       ONE,CONO
          PACK      KEY30,MHCNEDAT,MHCNENUM,PHVISNUM,PHURNUMB,CONO,SP30
          CALL      RAMHPCO1
          COMPARE   ZERO,OVRCD
          GOTO      PHISCO90 IF EQUAL
.
          UNPACK    KEY30,MHPOXDAT,MHPOXNUM,MHPOVISN,MHPOURNO,MHPOOCUR
          UNPACK    PHFIELDS,XXCOEVID,XXCOCCOD,XXCORCOL,XXCOCDAT:
                             XXCOWCPN,XXCOOESP,XXCOPVER,XXCOFCAR
          PACK      MHPOCCOD,XXCOCCOD,SP30
          PACK      MHPORCOL,XXCORCOL,SP30
          PACK      MHPOCDAT,XXCOCDAT,SP30
          PACK      MHPOWCPN,XXCOWCPN,SP30
          PACK      MHPOOESP,XXCOOESP,SP30
          PACK      MHPOPVER,XXCOPVER,SP30
          PACK      MHPOFCAR,XXCOFCAR,SP30
.
          CALL      WRMHPCO1
          GOTO      PHISCO99
.
PHISCO90  MOVE      ONE,EXIT
.
PHISCO99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISOT00
.                               record "OT" history
. -----------------------------------------------------------------------------
PHISOT00  MOVE      ZERO,EXIT
          PACK      KEY19,MHCNEDAT,MHCNENUM,PHVISNUM,SP30
.
          ADD       ONE,OTNO                * capture "OT" data
          MOVE      ZERO,OINO
          PACK      KEY36,KEY19,PHURNUMB,CONO,OTNO,OINO,SP30
          CALL      RAMHPOI1
          COMPARE   ZERO,OVRCD
          GOTO      PHISOT90 IF EQUAL
.
          UNPACK    KEY36,MHPIXDAT,MHPIXNUM,MHPIVISN,MHPIURNO,MHPIOCUR:
                          MHPIOCOT,MHPIOCOI
          MOVE      PHFIELDS,SVFIELDS
          UNPACK    PHFIELDS,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA,XXOTCDAT
          PACK      MHPITYPE,XXOTTYPE,SP30
          PACK      MHPIMADM,XXOTMADM,SP30
          PACK      MHPICSTA,XXOTCSTA,SP30
          PACK      MHPICDAT,XXOTCDAT,SP30
          CALL      WRMHPOI1
          GOTO      PHISOT99
.
PHISOT90  MOVE      ONE,EXIT
.
PHISOT99  RETURN
.
. -----------------------------------------------------------------------------
.                                    PHISOI00
.                               record "OI" history
. -----------------------------------------------------------------------------
PHISOI00  MOVE      ZERO,EXIT
          PACK      KEY19,MHCNEDAT,MHCNENUM,PHVISNUM,SP30
.
          ADD       ONE,OINO                * capture "OI" data
          PACK      KEY36,KEY19,PHURNUMB,CONO,OTNO,OINO,SP30
          CALL      RAMHPOI1
          COMPARE   ZERO,OVRCD
          GOTO      PHISOI90 IF EQUAL
.
          UNPACK    KEY36,MHPIXDAT,MHPIXNUM,MHPIVISN,MHPIURNO,MHPIOCUR:
                          MHPIOCOT,MHPIOCOI
          UNPACK    SVFIELDS,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA,XXOTCDAT
          PACK      MHPITYPE,XXOTTYPE,SP30
          PACK      MHPIMADM,XXOTMADM,SP30
          PACK      MHPICSTA,XXOTCSTA,SP30
          PACK      MHPICDAT,XXOTCDAT,SP30
          UNPACK    PHFIELDS,XXOIEVID,XXOIOITM,XXOIIVAL
          PACK      MHPIOITM,XXOIOITM,SP30
          PACK      MHPIIVAL,XXOIIVAL,SP30
          CALL      WRMHPOI1
          GOTO      PHISOI99
.
PHISOI90  MOVE      ONE,EXIT
.
PHISOI99  RETURN
+
. -----------------------------------------------------------------------------
.                                    PHISLS00
.                              record "LS" history
. -----------------------------------------------------------------------------
PHISLS00  MOVE      ZERO,EXIT
          CALL      CLMHPS00                * clear LS variables
.
          REP       " 0",MHCNENUM
          UNPACK    PHUNQNUM,DIM2,KEY3                                *C-261603
          PACK      KEY22,MHCNEDAT,MHCNENUM,PHVISNUM,KEY3,SP30
          CALL      RAMHPLS1
          COMPARE   ZERO,OVRCD
          GOTO      PHISLS90 IF EQUAL
.
          UNPACK    KEY22,MHPSXDAT,MHPSXNUM,MHPSVISN,MHPSUNIQ
          MOVE      PHURNUMB,MHPSURNO
          MOVE      "1",MHPSSTAT
.
          UNPACK    PHFIELDS,XXLSFVER,XXLSLSID,XXLSSORG,XXLSORID,XXLSOTYP:
                             XXLSEHCU,XXLSLSCD,XXLSRCPN,XXLSSDAT,XXLSEDAT:
                             XXLSFDAT,XXLSTDAT,XXLSDELT,XXLSPSEX,XXLSPDOB
          PACK      MHPSFVER,XXLSFVER,SP30
          PACK      MHPSSORG,XXLSSORG,SP30
          PACK      MHPSORID,XXLSORID,SP30
          PACK      MHPSOTYP,XXLSOTYP,SP30
          PACK      MHPSEHCU,XXLSEHCU,SP30
          PACK      MHPSLSCD,XXLSLSCD,SP30
          PACK      MHPSRCPN,XXLSRCPN,SP30
          PACK      MHPSSDAT,XXLSSDAT,SP30
          PACK      MHPSEDAT,XXLSEDAT,SP30
          PACK      MHPSFDAT,XXLSFDAT,SP30
          PACK      MHPSTDAT,XXLSTDAT,SP30
          PACK      MHPSDELT,XXLSDELT,SP30
          PACK      MHPSPSEX,XXLSPSEX,SP30
          PACK      MHPSPDOB,XXLSPDOB,SP30
. 
          REP       " 0",KEY2
          PACK      KEY10,MHPSVISN,KEY2,SP10
          LJUSTIFY  KEY10       
          PACK      MHPSLSID,KEY10,SP20     * replace XXLSLSID with extended Id.  .
          CALL      WRMHPLS1
          ADD       ONE,TOTLSNO
          GOTO      PHISLS99
.
PHISLS90  MOVE      ONE,EXIT
.
PHISLS99  RETURN
+
. -----------------------------------------------------------------------------
.                                    Clear Variables
.                            
. -----------------------------------------------------------------------------
CLMHPD00  MOVE      SP70,MHPDXDAT           * Clear MEHPRDaf variables
          MOVE      SP70,MHPDXNUM
          MOVE      SP70,MHPDVISN
          MOVE      SP70,MHPDURNO
          MOVE      SP70,MHPDSTAT
          MOVE      SP70,MHPDETYP
          MOVE      SP70,MHPDECNT           *
          MOVE      SP70,MHPDWCNT           *
          MOVE      SP70,MHPDERID           *
          MOVE      SP70,MHPDFVER
          MOVE      SP70,MHPDRFID
          MOVE      SP70,MHPDSORG
          MOVE      SP70,MHPDORID
          MOVE      SP70,MHPDOTYP
          MOVE      SP70,MHPDFDAT
          MOVE      SP70,MHPDTDAT
          MOVE      SP70,MHPDDELT
          MOVE      SP70,MHPDTEAM
          MOVE      SP70,MHPDEHCU
          MOVE      SP70,MHPDPSEX
          MOVE      SP70,MHPDPDOB
          MOVE      SP70,MHPDRFFR
          MOVE      SP70,MHPDRFTO
          MOVE      SP70,MHPDECOD
          MOVE      SP70,MHPDRSTR
          MOVE      SP70,MHPDREND
          MOVE      SP70,MHPDSPAR
.
CLMHPT00  MOVE      SP70,MHPTXDAT           * Clear MEHPATaf variables
          MOVE      SP70,MHPTXNUM
          MOVE      SP70,MHPTVISN
          MOVE      SP70,MHPTURNO
          MOVE      SP70,MHPTOCUR
          MOVE      SP70,MHPTACID
          MOVE      SP70,MHPTERID           *
          MOVE      SP70,MHPTATYP
          MOVE      SP70,MHPTASET
          MOVE      SP70,MHPTFAMW
          MOVE      SP70,MHPTWCPN
          MOVE      SP70,MHPTSDAT
          MOVE      SP70,MHPTEDAT
          MOVE      SP70,MHPTSPAR
.
CLMHPN00  MOVE      SP70,MHPNXDAT           * Clear MEHPCNaf variables
          MOVE      SP70,MHPNXNUM
          MOVE      SP70,MHPNVISN
          MOVE      SP70,MHPNURNO
          MOVE      SP70,MHPNOCUR
          MOVE      SP70,MHPNERID           *
          MOVE      SP70,MHPNCSCD
          MOVE      SP70,MHPNCSYS
          MOVE      SP70,MHPNDTYP
          MOVE      SP70,MHPNCCOD
          MOVE      SP70,MHPNICID
          MOVE      SP70,MHPNITYP
          MOVE      SP70,MHPNIVAL
          MOVE      SP70,MHPNSDAT
          MOVE      SP70,MHPNEDAT
          MOVE      SP70,MHPNSPAR
.
CLMHPO00  MOVE      SP70,MHPOXDAT           * Clear MEHPCOaf variables
          MOVE      SP70,MHPOXNUM
          MOVE      SP70,MHPOVISN
          MOVE      SP70,MHPOURNO
          MOVE      SP70,MHPOOCUR
          MOVE      SP70,MHPOERID           *
          MOVE      SP70,MHPOCCOD
          MOVE      SP70,MHPORCOL
          MOVE      SP70,MHPOCDAT
          MOVE      SP70,MHPOWCPN
          MOVE      SP70,MHPOOESP
          MOVE      SP70,MHPOPVER
          MOVE      SP70,MHPOFCAR
          MOVE      SP70,MHPOSPAR
.
CLMHPI00  MOVE      SP70,MHPIXDAT           * Clear MEHPOIaf variables
          MOVE      SP70,MHPIXNUM
          MOVE      SP70,MHPIVISN
          MOVE      SP70,MHPIURNO
          MOVE      SP70,MHPIOCUR
          MOVE      SP70,MHPIOCOT           *
          MOVE      SP70,MHPIOCOI           *
          MOVE      SP70,MHPIERID           *
          MOVE      SP70,MHPIOITM
          MOVE      SP70,MHPITYPE
          MOVE      SP70,MHPIMADM
          MOVE      SP70,MHPICSTA
          MOVE      SP70,MHPICDAT
          MOVE      SP70,MHPIIVAL
CLMHPD99  MOVE      SP70,MHPISPAR
.
.
CLMHPS00  MOVE      SP70,MHPSXDAT
          MOVE      SP70,MHPSXNUM
          MOVE      SP70,MHPSVISN
          MOVE      SP70,MHPSUNIQ
          MOVE      SP70,MHPSURNO
          MOVE      SP70,MHPSSTAT
          MOVE      SP70,MHPSSTAT
          MOVE      SP70,MHPSETYP           *
          MOVE      SP70,MHPSECNT           *
          MOVE      SP70,MHPSWCNT           *
          MOVE      SP70,MHPSERID           *
          MOVE      SP70,MHPSFVER
          MOVE      SP70,MHPSLSID
          MOVE      SP70,MHPSSORG
          MOVE      SP70,MHPSORID
          MOVE      SP70,MHPSFDAT
          MOVE      SP70,MHPSTDAT
          MOVE      SP70,MHPSDELT
          MOVE      SP70,MHPSOTYP
          MOVE      SP70,MHPSEHCU
          MOVE      SP70,MHPSPSEX
          MOVE      SP70,MHPSPDOB
          MOVE      SP70,MHPSLSCD
          MOVE      SP70,MHPSRCPN
          MOVE      SP70,MHPSSDAT
          MOVE      SP70,MHPSEDAT
          MOVE      SP70,MHPSSPAR
CLMHPS99  RETURN
+
.******************************************************************************
.*                                  HEAD0000                                  *
.*                           Print The Report Header                          *
.******************************************************************************
HEAD0000  MOVE      ONE,CNOUNDLN
          MOVE      "- Extract report",CPHDROPT
          CALL      HEAD132                 * Print the report header
          PRINT     *1,HEADDES1,*36,HEADDES2,*N
          PRINT     *N;
HEAD9999  RETURN
+
.******************************************************************************
.*                                  PRNT0000                                  *
 *                            Print An Error Report                           *
.******************************************************************************
PRNT0000  COMPARE   "56",CLNO
          CALL      HEAD0000 IF NOT LESS    * Print the report header
.
          RESET     PRNTLINE
          PRINT     *1,PRNTLINE
.
          ADD       ONE,CLNO
          PACK      PRNTLINE,SP70,SP70
          CLEAR     PRNTLINE
.
PRNT9999  RETURN
+
. -----------------------------------------------------------------------------
.                                    SEQERR00
.                            Sequence error in records
. -----------------------------------------------------------------------------
SEQERR00  MOVE      ZERO,EXIT
          MOVE      "Record found without a preceeding RD record",PRNTLINE
          CALL      PRNT0000
.
SEQERR99  RETURN
.
ERRCO000  MOVE      ZERO,EXIT
          MOVE      "OT record read without preceeding CO record",PRNTLINE
          CALL      PRNT0000
.
ERRCO99   RETURN
.
ERROT000  MOVE      ZERO,EXIT
          MOVE      "OI record read without preceeding OT record",PRNTLINE
          CALL      PRNT0000
.
ERROT99   RETURN
