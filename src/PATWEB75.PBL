.---------------------------------------------------------------------
. Program       : PATWEB75
.
. Function      : Input Miscellaneous Charges and Journals 
.
. Modifications  :
.
.----------------------------------------------------------------------------
. V12.00.06 17/06/2025  Bella Turco    TSK 0961823
.           Added missing pmspx2af reads after read of patmi1af
. V12.00.05 06/06/2025  Peter Vela    TSK 0961623
.           Alphanumeric changes
. V12.00.04 03/06/2025  Ebon Clements TSK 0955096
.           Set FADMNO to ZEROVISN - CLRFAC00       
. V12.00.03 23/05/2025  Bella Turco   TSK 0925576
.           Recompiled for UPFAPPLN                                  
. V12.00.02 20/05/2025  Bella Turco   TSK 0925576
.           Recompiled for UPFAPPLN                                  
. V12.00.01 20/05/2025  Ebon Clements TSK 0955096
.           Alphanueric visit number changes
. V11.05.10 08/05/2025  J.Tan         TSK 0925576
.           Recompiled for UPFAPPLN - Checking for invoice number
. V11.05.09 17/04/2025  J.Tan         TSK 0958935
.           Mod to initialise PTONHLIN
. V11.05.08 17/03/2025  Nikitha B     TSK 0950919
.           Read PTCNSTUN into the current right position of 84 in section 130.
. V11.05.07 24/02/2025  PeterVela     TSK 0939466
.           Added Eclipse DVAW HTML tag to DSFD4500
. V11.05.06 21/02/2025  J.Tan   TSK 0955356
.           Added FININVN,FINADMN,FINURNO - Financial details
. V11.05.05 20/02/2025  Peter Vela    TSK 0939466
.           Added Eclipse Webservices DVAW functionality
.           17/02/2025  J.Tan         TSK 0945920
.           Mod defaulting Future Action HF from Adm.HF
. V11.05.04 13/02/2025  Nikitha B    TSK  0950919
.           Added Stock Usage Number Column Header at IHED0000 and PMMIREFN
.           at NZIP0000 on checked of parameter PTCNSTUN.
. V11.05.03 07/01/2025  J.Tan   TSK 0955356
.           Mods writting to Financial Summary details file
. V11.05.02 16/12/2024  J.Tan         TSK 0945920
.           Added tag for a Selection of invoices for Future Action
.           UPFAPPLN - Update FA Completion date for Fully balanced invoice
. V11.05.01 27/11/2024  Thanh T        TSK 0939466
.           Added Distance in kms field
.----------------------------------------------------------------------------
. V11.04.09 26/10/2024 J.Tan           TSK 0952468
.           Fixed Moving Misc.item from one procedure to another for NZ private
. V11.04.08 25/10/2024 J.Tan           TSK 0952468
.           Fixed Moving Misc.item from one procedure to another for NZ private
. V11.04.07 20/09/2024 J.Tan           TSK 0950577
.           Fixed issue with Hold Invoice audit
. V11.04.06 05/04/2024  Alina Bhari     TSK 0944537 
.           Updated the CASEKEYS vaue from 23 to  26
. V11.04.05 02/04/2024  J.Tan           TSK 0919569 
.           Mod to MBS Exploding charges file
. V11.04.04 12/03/2024  Thanh T        TSK 0923560
.           Added Hospital ID Changes.
.           13/03/2024 J.Tan           TSK 0910994
.           Recompiled for CMXMATRX-Added Att.Doctor,Concession card & Disc.UDF
.           13/03/2024  J.Tan          TSK 0919335
.           Mod checking for HF history (set Service date - TSRVDATE)
. V11.04.03 22.02.2024  DA Sarkies     TSK 0936282
.           Increased size of spaces going into Health Fund variable.
. V11.04.02 16/02/2024  J.Tan          TSK 0942877
.           Mod UJNL000 checking for existing trans.no in patjrnlf for Outpat.
. V11.04.01 24/11/2023  J.Tan          TSK 0935372
.           Mod Theatre fee for Contract Eff.date using 'Disc.From' (GTHR0000)
. V11.03.12 25/10/2023  Sunny          TSK 0927697
.           Changed OVRPAY00 to add From/To Invoice Info to KEY28
. V11.03.11 07/08/2023 J.Tan           TSK 0936050
.           Mod to do RA prior Write to Hold invoice history file
. V11.03.10 03/07/2023 Ebon Clements   TSK 0923998
.           Added clear of PTMMEDAT,PTMMRPST,PTMMRPET,PTMMVAID,PTMMAPRA prior
.           to write to patmmbsf - UPMBS000
. V11.03.09 21/06/2023 J.Tan           TSK 0934004
.           Fixed Patient Hold invocie issue 
. V11.03.08 09/05/2023 J.Tan           TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.07 27/04/2023  J.Tan          TSK 0930051
.           Mod UJNL6000 removed checking for OVRCD=2 after Read invoice
. V11.03.06 19.04.2023  Bella Turco    TSK 0911166
.           Added functionality for adding records into patonhaf from Hold   
.           Invoice template
. V11.03.05 02.03.2023  DA Sarkies     TSK 0925133
.           Added Tag to display Supervisor in title if the supervisor option
.           has been selected
. V11.03.04 22.02.2023  DA Sarkies     TSK 0925133
.           Added variable t switch to supervisor mode. Moved code to read    
.           health fund details to separate function. Added over ride so that
.           patient hold description is displayed if not blank.
. V11.03.03 07/02/2023  Davin          TSK 0922254
.           Added check for CodeFocus InvoiceOnHold reason (DPEN7000/CUIP0000)
. V11.03.02 23/01/2023  Davin          TSK 0922254
.           Send HL7 A08 after Invoice on Hold data change (PTCNINVH/BVISUP00)
. V11.03.01 28/11/2022 J.Tan           TSK 0916786
.           Added Bulk delete Misc.item for SCR
. V11.02.06 14.09.2022 DA Sarkies      TSK 0909756
.           Added the PMMIDES2 to display all of the misc item description to
.           be displayed
. V11.02.05 29/06/2022 Alina Bhari     TSK 0921384
.           Correctly displayed the Action Type column value               
.           in billing future action -FROWA100()                          
. V11.02.04 17/05/2022 J.Tan           TSK 0916336
.           Mod MVIT0000 to set PMMIITYP to blank for items coming from HL7
. V11.02.03 05.04.2022 DA Sarkies      TSK 0918666
.           Changed "qunty KEY3" in the UpdateItem function call to "this"
. V11.02.02 22/02/2022  Alina Bhari   TSK 0910971
.           Added REVRECPT cgi
.           Add an ability to list Refund List in ascending/ Descending order
.           based on REVRECPT vaue 0/1.
.           - TADN0000,RDEP1500,PREVGR00,NEXTGR00
. V11.02.01 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.14 05.04.2022 DA Sarkies      TSK 0918666
.           Changed "qunty KEY3" in the UpdateItem function call to "this"
. V11.01.13 08/11/2021 J.Tan           TSK 0880410
.           Added Hospital and System to Health Fund Hold Invoice
. V11.01.12 18/11/2021 J.Tan           TSK 0912337
.           Mod writing pmsmtiaf for Procedure with mutliple quantity
. V11.01.11 29/09/2021  J.Tan          TSK 0901515
.           Recompiled for CMXMATRX - Added Primary Proc.to Matrix
. V11.01.10 20/08/2021  Peter Vela     Task 0908714
.           Fixed initialisation of item variables in CLRPAR00
.           Changed loop from 100 to 999
. V11.01.09 13/08/2021  Jill Parkinson Task 0909843
.           Corrected goto after moving items from one procedure to another
. V11.01.08 07/07/2021  J.Tan           TSK 0908588
.           Recompiled for CMXMATRX - Exclude Unqualified days for Casepayment
. V11.01.07 06/07/2021  J.Tan          TSK 0901142
.           Mod to write a Visit Note for each Future action comments (NWCMHD10)
. V11.01.06 10/05/2021  J.Tan          TSK 0903326
.           Added CNTRFNFR, CNTRFNTO
. V11.01.05 28/04/2021  Thanh T         TSK 0895165                          
.           Recompiled for OPRARDFD changes                                  
.           07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.04 11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
. V11.01.03 09/03/2021  Thanh T         TSK 0903411
.           Mod checking for blank Requisition key (CHREQKEY)
. V11.01.02 03/03/2021  Thanh T         TSK 0903411
.           fixed issue with item charged even though Charge checkedbox have
.           not been checked
. V11.01.01 17/02/2021  J.Tan           TSK 0899323
.           Mod checking for visit type in GCMX0000
.           17/02/2021  J.Tan           TSK 0888639
.           Changed Counter PATMMBFD to DIM 3
.           25/02/2021  Thanh T         TSK 0899715
.           Changed EITM0000 to cater for EditDelMiscItems javascript
.           variable functionality. Removed DSFD4200 as it is no longer used
. V11.00.18 10/02/2021  Thanh T         TSK 0899715
.           Added DSFD4100, DSFD4200. Changed EITM0000 to cater for 
.           EditDelMiscItems javascript variable functionality
. V11.00.17 09/12/2020  Thanh T         TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.16 27/11/2020  J.Tan           TSK 0899323
.           Recompiled for debugging (Add Item)
. V11.00.15 10/11/2020  J.Tan           TSK 0899562
.           Recompiled for CMXMATRX - setup date for reading MBS item
. V11.00.14 02/11/2020  J.Tan         TSK 0896804
.           Fixed Un-reconciled inv.for transfer Deposit to an Invoice(TRDT0000)
. V11.00.13 28/10/2020  J.Tan         TSK 0896158
.           Mod MVIT0000 - set PTMICNTR to blank for 'Bill to Patient' item
. V11.00.12 22/10/2020  J.Tan         TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.11 06/10/2020  J.Tan          TSK 0897025
.           Mod WTEMP000 to check for Null item code
. V11.00.10 29/09/2020  J.Tan          TSK 0896829
.           Recompiled for CMXMATRX - use National(PTPGNDRG)DRG
. V11.00.09 23/09/2020  J.Tan          TSK 0897025
.           Mod CHKGAS00 to check for zero MULTNUM (quantity)
. V11.00.08 22/09/2020  J.Tan           TSK 0895330
.           Recompiled for CMXMATRX - reposition read of Matrix table
. V11.00.07 02/09/2020  J.Tan          TSK 0897163
.           Mod checking Matrix (GCMX0000) on Add item only (out of VALPAT00)
. V11.00.06 25/08/2020  J.Tan          TSK 0895840
.           Mod CHKAMT92 - checking for Keyin amount (Inc.to Contract)item
. V11.00.05 17/08/2020  J.Tan          TSK 0895207
.           Mod EITM000 - set KEY15 to Misc.Item
. V11.00.04 04/08/2020  J.Tan          TSK 0895207
.           Increased length of array for Requisitions
. V11.00.03 14/04/2020  Peter Vela     TSK 0871644
.           Fixed Recovery gases calculation in CHKGAS00
. V11.00.02 18/05/2020  J.Tan            Task 0891112
.           Mod DFAC0000 -  checking for Patient only invoice
. V11.00.01 27/02/2020  Ebon Clements    Task 0816715
.           Added created and updated by fields to future actions
.           25/02/2020  Ebon Clements  TSK 0888833
.           Only write future action comments if a future action code
.           or comments exists (was writing when null) - FUTCOM00
.           Added RA and fixed key before write to vismtxaf - FUTCOM00
.           24/02/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
. V10.15.04 07/02/2020  J.Tan          TSK 0879410
.           Mod to set PMMISVTM for MBS after SETMTI00
. V10.15.03 31/01/2020  J.Tan          TSK 0886395
.           Mod to initialise PMMICTYP in SETMTI00
. V10.15.02 08/01/2020  Peter Vela     TSK 0871644
.           Added Surgical Preferences / Gases Quantity functionality
. V10.15.01 30/12/2019  Peter Vela     TSK 0871644
.           Added Surgical Preferences functionality
. V10.14.08 03/09/2019  J.Tan          TSK 0878533
.           Fixed EXIT flag in GCMX0000
. V10.14.07 02/09/2019  Richa Phogat     TSK 0818135
.           Added INVPDVAL, FACT2200
. V10.14.06 17/07/2019  Ebon Clements    TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.05 12/07/2019  Richa Phogat     TSK 0877002
.           Added WIN2CL00
. V10.14.04 26/04/2019  Peter Vela       TSK 0872936
.           Moved SP70 to KEY3 in ADDPRC00 for RECMPAMT
. V10.14.03 26/04/2019  Peter Vela       TSK 0872936
.           Changed SITEM move back to KEY3 in ADDPRC00,CHKPTM00 
. V10.14.02 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.01 06/03/2019  Ebon Clements  TSK 0871327
.           Added EDWARD trigger to procedure maintanance - WEDV0000
. V10.13.11 15/01/2019  Peter Vela     TSK 0867807
.           Added missing Eclipse DBS variables to CLRPAR00
. V10.13.10 04/12/2018  Peter Vela     TSK 0859743
.           Mod to setup PMMIRTYP for Outpatient Theatre fee (UPDP2100)
.           Added sub item code to private prac MBS items in outpatient 
.           Eclipse Bulk Billing invoicing
.           Added Set Code / Misc.Group to private prac MBS items in outpatient
.           Eclipse Bulk Billing invoicing
. V10.13.09 28/11/2018  J.Tan          TSK 0866884
.           Fixed to setup CEFFDATE prior checking for funded C/P (GCMX0000)
. V10.13.08 26/11/2018  Peter Vela     TSK 0863035
.           Added indicators for Eclipse Store and Forward
. V10.13.07 29/10/2018  Thanh T        TSK 0865528
.           Changed FACT1800 to show the billing and eclipse comment in the
.           reverse order which the lastest to be shown at the top.
. V10.13.06 23/10/2018  Tracey Nguyen  TSK 0859743
.           1)Added tag DSFD3600 for Eclipse Bulk Billing type 
.           (Claim type (cat CL ind1=P) and Clinic indicator (cat CI ind1=P)
.           2)Added Eclipse Bulk Billing fields in WTEMP000,GETRGM00,SETMTI00,
.             PITEM000,CLREC000,CDTH8000,AUAT8000
.           3)Added PMMIHOSI - Hospital Indicator on PMSMTIFD
. V10.13.05 19/09/2018  J.Tan          TSK 0863727
.           Added Restrictive Override code
. V10.13.04 12/09/2018  Ebon Clements  TSK 0861770
.           Added clear of EMVCFTXT - WVCD0000
. V10.13.03 21/08/2018  J.Tan          TSK 0859742
.           Added ECLIPSE new fields from pmsmtiaf and aaedtref
. V10.13.02 03/08/2018  Peter Vela     TSK 0852438
.           Added new validation in ADDPRC03 to default from no sub item code
.           Changed item limit in ADDSUN00 to 43
. V10.13.01 26/07/2018  Peter Vela     TSK 0852438
.           Initialised KEY3 with SP70 in ADDPRC00 for Representation/Review
. V10.12.03 19/07/2018  J.Tan          TSK 0860609
.           Fixed PMMISVTM - Operation start time
. V10.12.02 26/06/2018  Peter Vela     Task 0852438
.           Added new Review charge in ADDPRC00
.           Search for compensable subitem if present
.           06/07/2018  Thanh T        TSK 0857684
.           Changed to display Occupational Group Desc instead of code in
.           Comments field
. V10.12.01 27/04/2018  J.Tan          Task 0845996
.           Mod to update CMDEUDAT,CMDEUTIM and CMDEUUID
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 27/10/2017  J.Tan          TSK 0846343
.           Mod MVIT0000 to set PTMICNTR to blank for Patient Contract
. V10.11.04 19/10/2017  J.Tan          TSK 0846343
.           Added tags for Contract type (CNTRTYFR CNTRTYTO)
. V10.11.03 31/08/2017  J.Tan         TSK 0837479
.           Added PMMICTYP - Consumption Type
. V10.11.02 30/08/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.01 28/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.           26/07/2017  J.Tan
.           Mod checking parameter Johns hopkins Fees for Insurance Provider
.----------------------------------------------------------------------------
. V10.09.01 23/12/2016  J.Tan          TSK 0827950
.           Checking on Health fund hold invoice
. V10.08.05 21/09/2016  J.Tan          TSK 0826370
.           Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3
. V10.08.04 26/08/2016  Don Nguyen     TSK 0312570
.           Recompiled for CMXMATRX - Added check for PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
. V10.08.03 13/07/2016  J.Tan             TSK 0822346
.           Fixed PMMISVTM - Operation start time
. V10.08.02 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.01 16/05/2016  Ebon Clements TSK 0314039
.           Fixed age display on refund deposits by date list - RWRDEP00
. V10.07.10 16/02/2016  J.Tan         CAR 0310703
.           Mods Public Hosp to check for to be inv.amnt before write to patipen
. V10.07.09 24/12/2015  J.Tan         CAR 0319116
.           Mods checking for Contract on hold invoices
. V10.07.08 21/12/2015  J.Tan         CAR 0303942
.           Mods to setup Payment code
. V10.07.07 03/12/2015  J.Tan          CAR 324233
.           Added 'class=Integer' to input quantity item
. V10.07.06 25/11/2015  J.Tan          CAR 324052
.           Fixed Contract for Moving item from one proc.to another (MVIT0000)
. V10.07.05 11/11/2015  J.Tan          CAR 323481
.           Fixed posting quantity for Pack items
. V10.07.04 23/10/2015  J.Tan          CAR 314089
.           Added PREDIR00 to NXTITM00 and fixed MVIT0000
. V10.07.03 20/10/2015  J.Tan          CAR 314089
.           Mods for Digital Charge sheet
. V10.07.02 12/09/2015  J.Tan          CAR 314089
.           Fixed checking Exploding item for NZ only
. V10.07.01 14/09/2015  J.Tan          CAR 314089
.           Mods for Digital Charge sheet for Braemar hospital
. V10.06.07 15/07/2015  J.Tan          CAR 319342
.           Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'
. V10.06.06 29/06/2015  Peter Vela     CAR 318720
.           Fixed DVA and DVF sub item validation in ADDPRC00
. V10.06.05 09/06/2015  J.Tan          CAR 317346
.           Mods NZ Private (CFEETYPE) updating Invoice Pending
. V10.06.04 03/06/2015  Peter Vela     CAR 299372
.           Added Sub Item DVA, DVF and no item functionality to ADDPRC00
. V10.06.03 05/05/2015  J.Tan          CAR 244314
.           Added 'Dr Billing In-complete' option to Cabrini ED billing
. V10.06.02 15/04/2015  J.Tan          CAR 312625
.           Mods to check Patient reason for Hold invoice after Adding items
. V10.06.01 30/03/2015  J.Tan            CAR 244314
.           Added 'Dr Billing Complete' and 'No Dr Charge' to ED Billing
. V10.05.12 02/02/2015  Ebon Clements  CAR 311997
.           Fixed billing notes date display - FACT1800
. V10.05.11 05/01/2015  J.Tan  CAR 302629
.           Mods for Input Bulk Journal
. V10.05.10 03/12/2014  J.Tan  CAR 309048
.           Mods to highlight Suspended Future Action
. V10.05.09 25/11/2014  J.Tan  CAR 309048
.           Mods to highlight Suspended Future Action
. V10.05.08 29/10/2014  J.Tan  CAR 301888
.           Fixed NOT to update Future Action Invoice no
. V10.05.07 27/10/2014  Ebon Clements    CAR 306917
.           Added branch on exit after web errors - PROC6000 & ADDPRC00
. V10.05.06 23/10/2014  J.Tan            CAR 307539
.           Fixed DTR record for SX Cash transfer (CSHTRN00)
. V10.05.05 29/09/2014 Ebon Clements   CAR 301888
.           Added invoice number output to future action list - FROWA000
. V10.05.04 27/08/2014 Peter Vela      CAR 302395
.           Added journal to type tmpjrnaf key 1
. V10.05.03 05/08/2014 Peter Vela      CAR 302164
.           Added PMMIRBRS - Rebate Reason CAT Rr
.           Added ATDTRBRS - Rebate Reason CAT Rr
. V10.05.02 23/07/2014 J.Tan           CAR 303861
.           Adding item to check for item amt before writing a record to Inv.
.           Pending for Public hosp. only
. V10.05.01 21/07/2014 J.Tan           CAR 291099
.           Mods to Billing comments
. V10.04.16 01/07/2014 J.Tan           CAR 293242
.           Added option to delete Hold Invoice
. V10.04.15 19/06/2014 J.Tan           CAR 302452
.           Recompiled for WEBDINVS - Changed MCHGARR/MCHGAMT
. V10.04.14 19/06/2014  Peter Vela     CAR 300986
.           Added new weights to EMR billing sheet
. V10.04.13 16/06/2014  Jill Parkinson CAR 301639  
.           Added call to DTEMP000 at MBSI9999 to clean up tempfile when done
.           Fixed regime errors to set EXIT after calling WEBERR00            
.           Fixed all calls to CHKITM00 to branch on EXIT after               
.           Added branch on EXIT after ADDITM00 in MBSI0000                   
.           Added move of 1 to EXIT after calling ERRLST00                    
. V10.04.12 05/06/2014  Jill Parkinson CAR 301639  
.           Moved calls to TFILENAM to INIT0000
. V10.04.11 07/05/2014  J.Tan            CAR 300260
.           Mods checking previous record after finding NZ Inactive Item
. V10.04.10 16/04/2014  J.Tan            CAR 261630
.           Removed pataub patauc pataum patauj pataup audit files
. V10.04.09 22/04/2014  J.Tan             CAR 300260
.           Mods checking for Active/Inactive NZ Misc.items
. V10.04.08 15/04/2013  J.Tan            CAR 261630
.           Removed port number from temp file name
. V10.04.07 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.06 01/04/2014  J.Tan             CAR 299227
.           Fixed checking blank Effective todate for SX Misc.Items (GETNZM00)
. V10.04.05 02/04/2014 J.Tan         CAR 299505
.           Fixed PCLNO  -  next line number for Future action comments
. V10.04.04 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.03 04/02/2015  J.Tan            CAR 285293
.           Recompiled for GETTFEES - fixed theatre banding
. V10.04.02 17/01/2014  J.Tan            CAR 295008
.           Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.           20/01/2014  J.Tan            CAR 249828
.           Added PMMIPMBS,PTDTPMBS - Patient MBS Team and Counter
. V10.04.01 17/01/2014  J.Tan            CAR 296189
.           Mods Billing Template to remove all items from Community Billing
.---------------------------------------------------------------------
. V10.03.41 13/12/2013  J.Tan            CAR 294609
.           Recompiled for CMXMATRX - mods for Default Grouper Version*
. V10.03.40 18/11/2013  Peter Vela       CAR 292886
.           Added Work Cover to ADDPRC00
. V10.03.39 29/11/2013 Sandra Barcham    CAR 283618
.           Fix regime read
. V10.03.38 14/08/2013  J.Tan            CAR 283618
.           Added Patient Regimes table, Independence services billing
. V10.03.37 25/09/2013  Peter Vela        CAR 290872
.           Removed changes made in V10.03.36
. V10.03.36 25/09/2013  Peter Vela        CAR 290872
.           Added variable to stop sub item from defaulting to spaces
.           in GSB20000
. V10.03.35 24/09/2013  Peter Vela        CAR 290782
.           Added new weights to ED Billing Sheet
. V10.03.34 17/09/2013  J.Tan             CAR 259879
.           Mods checking Effective date for Inactive SX Misc.Items (GETNZM00)
. V10.03.33 05/08/2013  J.Tan          CAR 288060
.           Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary MBS
. V10.03.32 23/05/2013  J.Tan            CAR 261630
.           Removed port number from temp file name
. V10.03.31 07/03/2013  J.Tan            CAR 282256
.           Removed setting up CURRDATE in INIT0000
. V10.03.30 06/03/2013  J.Tan            CAR 282256
.           Fixed service date searching for Misc.item
. V10.03.29 07/02/2013  Peter Vela       CAR 267297
.           Added visit based comments
. V10.03.28 16/01/2013  J.Tan            CAR 272996
.           Mods to KEY variables for Future Action file
. V10.03.27 14/01/2013  J.Tan            CAR 276647
.           Added a new Sundry charge (S20)
. V10.03.26 12/10/2012  J.Tan            CAR 272702
.           Fixed changing SX items with Keyin price
. V10.03.25 12/10/2012  J.Tan            CAR 271474
.           Recompiled for CMXMATRX - using index 5 of pmscmtaf
. V10.03.24 05/09/2012  J.Tan          CAR 267784
.           Mods Checking for TCINDC19 Claim Code
. V10.03.23 04/09/2012  J.Tan            CAR 268233
.           Mods for Emergency Reassign Debts
. V10.03.22 31/08/2012  J.Tan            CAR 270090
.           Mods to call FLAGDEBT after updating invoice file
. V10.03.21 31/07/2012  J.Tan            CAR 268318
.           Mods for Emergency Procedure fee information
. V10.03.20 24/07/2012  J.Tan            CAR 257771
.           Fixed SX multiple Pack items
. V10.03.19 03/07/2012  Peter Vela       CAR 264245
.           Clear out tkbox999 in CLRPAR00
. V10.03.18 03/07/2012  Peter Vela       CAR 264245
.           Check for EOS in ADDSUN EFF
. V10.03.17 28/06/2012  Saroeun Soeur    CAR 268137
.           reverted back from 999 to 500
. V10.03.16 28/06/2012  Saroeun Soeur    CAR 268137
.           changed maxed proci item to 999 from 500
. V10.03.15 25/06/2012  Don Nguyen       CAR 266364
.           Modified PURFAC00 to not output Future Actions for Cancelled admiss
. V10.03.14 15/06/2012 J.Tan             CAR 266864
.           Fixed setup pmsmtiaf for Input bulk misc.items
. V10.03.13 13/06/2012 J.Tan             CAR 267037
.           Mods to set CEFFDATE for Theatre fees using Contract Eff.As At Date
. V10.03.12 23/05/2012 J.Tan             CAR 264163
.           Mods checking for Keyin Indicator/Fixed Charge Procedure
. V10.03.11 15/05/2012 J.Tan             CAR 255708
.           Mods checking for Hold Invoices From Date
. V10.03.10 11/05/2012  J.Tan            CAR 250477
.           Fixed SX Pack items
. V10.03.09 04/04/2012  J.Tan            CAR 263193
.           Mods maximum number of input items to 999
. V10.03.08 21/03/2012  J.Tan            CAR 222603
.           Mods to display Eligibility Comments on Combined comments screen
. V10.03.07 23/02/2012  J.Tan            CAR 250477
.           Mods for SX Pack items
. V10.03.06 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.05 10/01/2012  Mike Laming      CAR 234909
.           Added "Discharge Comments" to Future Actions/Comments at FACT1900
. V10.03.04 29/11/2011  J.Tan            CAR 256458
.           Fixed allocating deposit to an invoice
. V10.03.03 27/10/2011  J.Tan             CAR 235425
.           Mods to return SX item description to DIM65
. V10.03.02 09/11/2011 J.Tan           CAR 255042
.           Recompiled for GETTFEES-reset overnight HF type if daycase notfound
. V10.03.01 11/08/2011 J.Tan          CAR 237245
.           Change Policy number to Policy amount for JHS
. V10.02.10 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.09 06/10/2011 J.Tan           CAR 251207
.           Mods for NOCHARGE ED Billing
. V10.02.08 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.07 10/08/2011 J.Tan           CAR 244790
.           Mods for Self insured Journals
. V10.02.06 16/06/2011 J.Tan          CAR 237245
.           Mods to allow changing insurance prov.after invoiced for JHS
. V10.02.04 21/04/2011 J.Tan           CAR 237245
.           Mods for Johns Hopkins Insurance Providers
. V10.02.03 14/04/2011  J.Tan          CAR 224550
.           Mods to initialise rebate amount for Sundry charges
. V10.02.02 06/04/2011 Peter Vela      CAR 233257
.           Move TMMTI008 to PMMIAMTP instead of TMMTI009 for Bulk misc charges
. V10.02.01 06/04/2011 Ebon Clements   CAR 233900
.           Fixed allocation of batch number for add journal and misc charge
. V10.01.13 16/03/2011 J.Tan           CAR 233264
.           Fixed updating Unreconciled invoice file to update date/time
. V10.01.12 09/03/2011  Ebon Clements  CAR 238388
.           Added call of FLAGDEBT PROC in OVRPAY00
. V10.01.11 11/02/2011  J.Tan          CAR 233048
.           Mods Theatre fees to use HF Table type instead of HF Table code
. V10.01.10 17/01/2011  Mike Laming    CAR 233146
.           Recompiled for changes to PATDTRFD/IO and CLPTDTR          
. V10.01.09 13/01/2011  Mike Laming    CAR 233084
.           Modified for new include CLPATINV (Added PTINCNID) in FIXINV00
. V10.01.08 23/12/2010  Ebon Clements     CAR 233900
.           Added report 18 - bulk input journal
. V10.01.07 20/12/2010  Jill Parkinson    CAR 233154
.           Added pack of PTMICONB,PTMIWEBC and PTMIWEBU
. V10.01.06 14/12/2010  Ebon Clements     CAR 233900
.           Added batch number to bulk misc charges
.           Added report 18 - bulk input journal
.           06/12/2010  Ebon Clements     CAR 233927
.           Added reason for hold update to invoice pending
.           02/12/2010  Mike Laming    CAR 233046
.           Mods to "patmchgf" - use "Table Type" (PTMCHFTT) replacing "H/F 
.           Table" (MHFTAB) - replace code to read/validate Item with PATMCHRD
. V10.01.05 25/11/2010  Ebon Clements  CAR 233198
.           Added invoice on hold to invoice pending - DPEN0000
. V10.01.04 24/11/2010  Ebon Clements  CAR 233156
.           Added created by to journals
. V10.01.03 12/11/2010  Peter Vela     CAR 233257
.           Added new reportno: Bulk Miscellaneous Charges
. V10.01.02 11/11/2010  Ebon Clements  CAR 233260
.           Added table sort future actions - FTABA000
. V10.01.01 09/11/2010  Davin          CAR 233227
.           Added tag for eclipse notes (fact1800)
.           09/11/2010  Mike Laming    CAR 230710
.           Added Cease Date (PRITDAT2) test in CHKITM00, GSB20000, GSB30000
. V10.00.26 27/10/2010 Davin            CAR 226831
.           Recomplied for CHNADMTP - move passcode to oper.id in pattranf
. V10.00.25 25/10/2010 J.Tan            CAR 232210
.           Fixed quantity and GST code for Exploding item
. V10.00.24 21/10/2010 J.Tan            CAR 231525
.           Fixed TDWARD for journal record in patdtraf file 
. V10.00.23 12/10/2010 J.Tan            CAR 230690
.           Fixed Emergency takeup o/s debt to write record to emrvisaf file
. V10.00.22 23/09/2010 Peter Vela       CAR 229958
.           Call ADDSUN00 (Add Sundry Items) before adding procedures.
. V10.00.21 13/09/2010 Peter Vela       CAR 229958
.           Added Emergency Department Fee to JFK Emergency Billing Sheet
. V10.00.20 03/09/2010 J.Tan            CAR 228967
.           Mods for HEC ED Add Procedures
. V10.00.19 23/08/2010 J.Tan            CAR 228192
.           Mods not to add Service Number to the item description(except NZPri)
. V10.00.18 18/08/2010 J.Tan            CAR 222031
.           Mods to set PMMIDUPD and PMMITUPD
. V10.00.17 17/08/2010 J.Tan            CAR 227873
.           Recompiled for CMXMATRX- getting the grouper version
. V10.00.16 11/08/2010 J.Tan            CAR 227873
.           Recompiled for CMXMATRX-searching for next matrix rules
. V10.00.15 05/08/2010 Ebon Clements    CAR 205582
.           Added report 16 delete invoice pending record
. V10.00.14 03/08/2010 J.Tan            CAR 191023
.           Mods to write un-balanced invoice to un-reconciled invoice file
. V10.00.13 02/08/2010 Ebon Clements    CAR 227432
.           Added using Prosthetic Tracking test to PRTABA00
. V10.00.12 16/07/2010 J.Tan            CAR 226322
.           Recompiled for CMXMATRX - search for next rule if Contract not valid
. V10.00.11 01/07/2010  J.Tan           CAR 213816
.           Mods to display Outstanding balance on Future action list
. V10.00.10 15/06/2010  J.Tan           CAR 224016
.           Fixed array out of bounds for ADDWRN00
. V10.00.09 30/04/2010  J.Tan     CAR 220887
.           Mods checking for Active/Inactive of Misc.charge
. V10.00.08 27/04/2010  J.Tan           CAR 219898
.           Added P50EDPCT- 50% of PRITSFEE - Schedule fee
.           (P50PERCT is still for 50% of PRITSF85 - Schedule fee 85%)
. V10.00.07 20/04/2010  J.Tan           CAR 219848
.           Added Pharmacy (tkbox037) to ED Sundry Charges
. V10.00.06 19/04/2010  J.Tan        CAR 219670
.           Mods to set date/time updated to rcpdteaf file
. V10.00.05 14/04/2010 Steve Armstrong   CAR 219933
.           Recompiled for changes to EMRVCDFD
. V10.00.04 12/04/2010  J.Tan           CAR 215864
.           Mods to display the Extract ID Number of Letter history (patlhiaf)
. V10.00.03 01/04/2010  J.Tan           CAR 219255
.           Fixed TRDEP000 - P*K  on comdepaf for multihospital
. V10.00.02 30/03/2010  J.Tan         CAR 174079
.           Added a new field to patfactaf for Act.Plan Inv.number
.           30/03/2010  Peter Vela      CAR 218880
.           Added 50% of AMA Fee to ADDPRC00
. V10.00.01 17/03/2010  Peter Vela      CAR 206240
.           Mods for ED Billing Sheet
.           15/03/2010  J.Tan           CAR 206240
.           Mods for ED Billing Sheet - Sundry Charges
.----------------------------------------------------------------------
. V9.12.25  05/03/2010  J.Tan           CAR 174079
.           Mods to remove future actions from Action plan for balanced invoice
. V9.12.24  23/02/2010  Peter Vela      CAR 214931
.           Added functionality to submit EMVIYN04
. V9.12.23  19/02/2009  J.Tan           CAR 216200
.           Mods add Proc.to check for Disc.date/time if status=3(Disc.Complete)
. V9.12.22  10/02/2009  J.Tan           CAR 214387
.           Mods to SX GST journals
. V9.12.21  15/01/2009  J.Tan           CAR 213974
.           Added Emergency takeup outstanding debt
. V9.12.20  08/01/2009  J.Tan           CAR 202780
.           Added Calculation of 65percent for SJOG WA
. V9.12.19  21/12/2009  Mike Laming     CAR 206410
.           Minor mod to move MBS Start Time to PMMISVTM at PITEM140
. V9.12.18  21/12/2009  Mike Laming     CAR 206410
.           Added MBS Item Start/End Times in Add MBS Items (see STRTIME/ENDTIME
.           21/12/2009  Ebon Clements   CAR 211779
.           Move zero to exit at end of GCMX0000
. V9.12.17  14/12/2009  J.Tan           CAR 211394
.           Fixed visit number of comdepaf for Deposit transfer to an Invoice
. V9.12.16  03/12/2009  J.Tan           CAR 211394
.           Fixed to set Eff.date (PTDTEFFD) to current date for Cash Trans
. V9.12.15  26/10/2009  J.Tan           CAR 206764
.           Recompiled for CHNADMTP - Suggested classification
. V9.12.14  12/10/2009  J.Tan         CAR 188108
.           Recompiled for CHKCMXPT - I*C on patcmxaf file
. V9.12.13  08/10/2009  J.Tan        CAR 191624
.           Fixed to set Applied Deposit date to current date
. V9.12.12  02/10/2009  J.Tan        CAR 206194
.           Fixed Item description for Johns Hopkins
. V9.12.11  08/09/2009  J.Tan        CAR 205303
.           Added Casemix Contract ID to casemix funding
. V9.12.10  27/08/2009  J.Tan         CAR 170784
.           Moved the warning for 'Invoice will be in Credit' to javascript
. V9.12.09  21/07/2009  J.Tan         CAR 199603
.           Mods to set theatre banding
. V9.12.08  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.07  20/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.06  10/07/2009  Ebon Clements CAR 187020
.           Added multi hospital test to TRDEP000
. V9.12.05  26/06/2009  J.Tan         CAR 191624
.           Added Transfer deposit to an invoice functionality
. V9.12.04  05/06/2009  J.Tan         CAR 197289
.           Mods to Add procedure to use keyin amount if schedule fee is zero
. V9.12.03  22/05/2009  J.Tan         CAR 188108
.           Mods for Invoice Comments
. V9.12.02  19/05/2009  S.Soeur       CAR 194109
.           Added Label ADDPROC10
. V9.12.01  01/05/2009  J.Tan         CAR 191023
.           Mods for Change Owner of Debt (patureaf)
. V9.11.10  28/04/2009  J.Tan         CAR 195596
.           Added fields PTDTADPT PTDTADRB
. V9.11.09  29/01/2009  J.Tan         CAR 180045
.           Fixed Add Procedure to default service doctor to Visit doctor
. V9.11.08  29/01/2009  Ebon Clements CAR 179431
.           Fixed display of future actions for cancelled pre admission
. V9.11.07  30/12/2008  J.Tan   CAR 184997 
.           Fixed description for NZ exploding items
. V9.11.06  12/12/2008  Steve Armstrong   CAR 181373
.           Recompiled for changes to PROSTRAK 
. V9.11.05  20/11/2008  Steve Armstrong   CAR 181373
.           Recompiled for changes to PMSPTDFD, PROSTRAK & CLPMSPTD.
. V9.11.04  10/11/2008  Steve Armstrong  CAR 183165
.           Removed isadd on tempfile and added second index to isbuild
.           (in CTEMP0000)
. V9.11.03  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.02  24/10/2008  Ebon Clements CAR 154581
.           Recompiled for PMSOSDTM - Added trap
. V9.11.01  06/10/2008  J.Tan         CAR 172904
.           Fixed SX split GST journal calculation
.----------------------------------------------------------------------
. V9.10.10  02/10/2008  J.Tan         CAR 172904
.           Mods for SX split GST journal
. V9.10.09  18/09/2008  J.Tan         CAR 178504
.           Fixed deleting Visit comment file (I*D on viscmtaf file)
. V9.10.08  20/08/2008  Ebon Clements CAR 166307
.           Added billing comments tag
. V9.10.07  11/08/2008  J.Tan         CAR 175859
.           Mods to use Daycase suggested classification (PTITDCSC) 
. V9.10.06  04/08/2008  J.Tan         CAR 175246
.           Mods Add procedures to default Service doctor from invoice screen
. V9.10.05  02/07/2008 Mike Laming   CAR 153024
.           Added logic for Future Actions also writing to Comments file if 
.           CFUTCOM is set (see FUTCOM00)
. V9.10.04  23/05/2008 J.Tan      CAR 169149
.           Added Date and Time invoice created/updated
. V9.10.03  16/05/2008  J.Tan         CAR 168168 168548
.           Fixed to set Effective date to Item date for SX misc.item
. V9.10.02  13/05/2008 J.Tan      CAR 162313
.           Added Deposit status to comdepaf
. V9.10.01  30/04/2007  J.Tan         CAR 167215
.           Mods to incl.Credit notes for checking outstanding balance
.----------------------------------------------------------------------
. V9.09.30  27/03/2008 J.Tan      CAR 161684
.           Mods to use PMMIINCT - indicator to 'Print Service Date/Time'
.           for EMR Procedures
. V9.09.29  04/03/2008 J.Tan          CAR 157583
.           Mods 'Rebate Portion' procedure to be equal to 'Schedule Fee 85%'
. V9.09.28  16/02/2008 Peter Vela     CAR 161154
.           Added NXTPAG50 Refresh Parent of Parent
. V9.09.27  31/01/2008 Peter Vela     CAR 155334
.           Added functionality for Prosthetic Tracking
. V9.09.26  24/12/2007 Ebon Clements  CAR 158189
.           Fixed BLCMN000 - Was writing a blank record when no comments entered
. V9.09.25  29/10/2007 J.Tan      CAR 153568
.           Mods checking for Journal code for GST Credit notes
. V9.09.24  12/11/2007 J.Tan         CAR 151803
.           Mods for Cabrini ED Billing
. V9.09.23  07/11/2007 Ebon Clements CAR 151935
.           Added tag for patient letter history
. V9.09.22  30/10/2007 Ebon Clements CAR 151935
.           Added tags for U/R and admission comments 
. V9.09.21  24/10/2007 Ebon Clements CAR 151941
.           Added health fund and occupational group to future actions
. V9.09.20  22/10/2007 Peter Vela CAR 150302
.           Added functionality to find doctor for backdated procedures
. V9.09.19  22/10/2007  Peter Vela       CAR 147342
.           Fixed tag for Doctor Seen Date and Time
. V9.09.18  19/10/2007  Jill Habasque    CAR 152042
.           Mods to only read patmchgf if nzprivate in MBSI0000
. V9.09.17  04/10/2007  Jill Habasque CAR 151646
.           Mods to check for valid uniqu[xxx] array
. V9.09.16  08/10/2007  J.Tan         CAR 151472
.           Fixed SX Keyin misc.item amt for FFS Win/Loss
. V9.09.15  24/09/2007  J.Tan         CAR 140282
.           Save the keyin amt to pmmiamtg for SX
. V9.09.14  24/09/2007  J.Tan         CAR 140282
.           Fixed SX input keyin price Item which Included in Contract
. V9.09.13  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.12  05/09/2007  Peter Vela    CAR 148954
.           Recompiled for PMSREGFD
. V9.09.11  11/07/2007  Jill Habasque CAR 144946
.           Changed CHKAMT00 to work the same as in NZPCATBI
. V9.09.10  02/07/2007  J.Tan         CAR 143182
.           Fixed populating Misc.group for keyin amt items
. V9.09.09  26/06/2007  Ebon Clements CAR 143757
.           Added multi hospital test to future actions - PURFAC00
. V9.09.08  18/06/2007  Peter Vela    CAR 142173
.           Added error message PROC9200
. V9.09.07  13/06/2007  Mike Laming   CAR 119158
.           Changes to fix RDMCHG1 for Misc.Charges Effective Date
. V9.09.06  04/06/2007 J.Tan      CAR 142173
.           SJOG Emergency billing
. V9.09.05  07/05/2007 Peter Vela CAR SJOG ED Billing
.           Initialised new pmsmtiaf variables
.           Initialised new aaedtref variables
.           Added SJOG ED Billing functionality
.           07/05/2007 J.Tan   CAR 140282
.           Mods to initialise batch no for NZ Priv.extract
. V9.09.04  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
. V9.09.03  02/05/2007 J.Tan         CAR 132276
.           Mods for SX outpatient input item 
. V9.09.02  18/04/2007 J.Tan         CAR 130467
.           Mods for Credit transfer overpayment
. V9.09.01  22/03/2007 J.Tan         CAR 130467
.           Mods for Credit transfer
.----------------------------------------------------------------------
. V9.08.10  01/03/2007 J.Tan         CAR 120009
.           Fixed misc.item without contract for SX
. V9.08.09  22/02/2007 Mike Laming   CAR 119436
.           Added PMSOSDTM for Outstanding Debt Alert indicator
. V9.08.08  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.07  23/01/2007  Mike Laming   CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.06  03/01/2007  Jill Habasque CAR 120009
.           Mods to read nzpmchaf   
. V9.08.05  18/12/2006 J.Tan         CAR 128643
.           Mods quantity to FORM 4
. V9.08.04  04/12/2006  Peter Vela    CAR 126013
.           Added functionality for posting regime codes
. V9.08.03  01/12/2006  J.Tan         CAR 12678
.           Mods JH Item description - not to append quantity after desc.
.           Fixed GST journals for Outpatients
. V9.08.02  26/10/2006 J.Tan         CAR 122541
.           Mods JH to set alternate misc.item group catg FN
. V9.08.01  26/10/2006 J.Tan         CAR 122541
.           Mods JH to set alternate misc.item group catg FN
.----------------------------------------------------------------------
. V9.07.03  20/09/2006 J.Tan         CAR 119336
.           Added claim code to Suggested classification file
. V9.07.02  12/09/2006  J.Tan         CAR 103365
.           Mods to check for UAE - to use alternate catg FI for Misc.Item group
. V9.07.01  03/06/2006  Ebon Clements CAR 110133
.           Added date action completed to FROWA000
.----------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. ........  10/03/2006  Mike Laming   CAR 79281
.           Change KEY16 to KEY19 for "patfactf" & add parameter where reqd
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B01 01/12/2005  Peter Vela    CAR 84255
.           Added Replace "+ " for urnumber and admissno in FUTURE00
.           BLCMN000 MBSI0000
.----------------------------------------------------------------------
. V9.04.16  25/10/2005 Sandra Barcham  81362
.           Fixed incorrect packing of fincode for CASH
. V9.04.15  12/08/2005  Jeni Tan       CAR 62750
.           Removed redefined variables  
.           19/08/05 J.Tan    CAR 64493
.           Added Bed type to dtr file
. V9.04.14  08/07/2005  Jill Habasque CAR 63890
.           Changed journal in credit to use warning instead of weberr00
. V9.04.13  16/06/2005  Mike Laming   CAR 61746
.           Added clears for PTDTTIME & PTDTCRST at SETJNL30
. V9.04.12  07/03/2005   Peter Vela CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.11  12/01/2005   J.Tan   CAR 52336 
.           Fixed checking for adm type to be excluded from auto update
. V9.04.10  06/01/2005  Lina Vo    CAR 54670
.           Changed Future action list to display all actions when user has
.           blank hospital
. V9.04.09  30/11/2004  J.Tan      CAR 55293
.           Added uniq id to patdtraf and pmsmtiaf
. V9.04.08  22/11/2004   J.Tan   CAR 52336 
.           Mods routine for validating item to check if item to
.           be excluded from auto update admission type
. V9.04.07  29/09/2004 - Lina Vo  CAR 53798
.           Added Hospital Id tag for Default Misc Charge keyword search.   
.           Mods to write to visit extension file
.           Added Hospital Field tag for Take up outstanding debt
.           21/09/2004 - Lina Vo  CAR 53660
.           Changed Add MBS Item to use PTHSTFEE for Multi Hospital instead 
.           of PTCNTFEE.
. V9.04.06  09/09/2004 Lina Vo          
.           Initialise RECNUMB in TADN0000 (Refund Deposit List) to fix
.           Next page problem.
. V9.04.05  01/09/2004 Jill Habasque
.           Added read of patinvrf when adding bad debts
. V9.04.04  31/08/2004 J.Tan  CAR 50391
.           Fixed fincode for Credit note
. V9.04.03  27/08/2004  Jill Habasque CAR 53046
.           Changed FROWA000 to check for multihospital - future actions
. V9.04.02  20/08/2004 J.Tan  CAR 52835
.           Mods to setup hospital ID for patfinsf
. V9.04.01  26/08/2004 J.Tan  CAR 52895
.           Fixed updating item using the keyin amount
.----------------------------------------------------------------------
. V9.03.30  02/08/2004 J.Tan  CAR 52033
.           Fixed updating multiple item amount
. V9.03.29  23/07/2004 J.Tan  CAR 51830
.           Fixed posting multiple MBS items and Misc.charges.
. V9.03.28  21/07/2004 J.Tan  CAR 51830
.           Fixed posting MBS items
. V9.03.27  14/07/2004 Jill Habasque  
.           Fixed I*C for Account in credit warning
.           15/07/2004 J.Tan  CAR 51619
.           Fixed posting MBS/Misc. items
.           Removed locking/unlocking files
. V9.03.26  17/06/2004 J.Tan CAR 50783
.           Mods posting journal to check for takeup outstanding debts
. V9.03.25  09/06/2004 Sylvek Litewka CAR 50371
.           Added new fields to patfactf - PTFCURNO (Patient UR Number) and 
.           PTFCDTCP (Date Action Completed). Added procedure PURFAC00 to 
.           display table of Future Actions for a given UR Number.
.           11/06/2004 J.Tan  CAR 50035
.           Mods to set mechanical vent var from pmsmtiaf
. V9.03.24  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
.           08/06/2004 J.Tan   CAR 50511
.           Fixed set up outpat,EMR number before writing record to patjrnlf 
. V9.03.23  01/06/2004 Ebon Clements             CAR 50364
.           Made admission number mandatory for future actions
. V9.03.22  25/05/2004 Pat Dirito                CAR 50117
.           Modified FROWA000 to output FDATE instead of DOB.
.           20/05/2004 Pat Dirito                CAR 50035
.           Now only initialising PTDTEPSD to ZERO for writes               
. V9.03.21  13/05/2004 J.Tan  CAR 49827
.           Mods to default item date to visit date for outpat and emergency
. V9.03.20  03/05/2004 J.Tan  CAR 41519
.           Mods to print reason for refund on refund list
.           04/05/2004 Lina Vo        CAR  49512
.           Changed report 8 - Take up outstanding debts  
. V9.03.19  29/04/2004 J.Tan  CAR 36504
.           Mods for Invoice estimate
. V9.03.18  22/04/2004  Mike Laming   CAR 46224
.           Change input of TSESSION so that it is right-aligned
.           (to match IBAOPR43)
. V9.03.17  26/03/2004 Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.16  16/03/2004 J.Tan  CAR 44109
.           Fixed up GST Code for GST journals
. V9.03.15  06/02/2004 Ebon Clements   CAR 47710
.           Mods to CTEMP000 file creation, file should be 269 long
. V9.03.14  29/01/2004 J.Tan   CAR 44086  
.           Mods for refund deposit        
. V9.03.13  19/12/2003 J.Tan   CAR 44093  
.           Replaced patcashf with comdepaf
. V9.03.12  08/12/2003 Pat Dirito    CAR 44114
.           Fixed various problems with Future Actions List FROWA000
.           11/12/2003 Peter Vela    CAR 40355
.           Recompiled for PATNAMCD
. V9.03.11  31/10/2003 S.Litewka     CAR 44328
.           Added clear of PTMMDESC field when writing a new record to patmmbsf.
. V9.03.10  16/10/2003 J.Tan    CAR 44172
.           Mods for credit note, write record to item pending file
.           Mods to write to unknown GST file if necessary
. V9.03.09  13/10/2003 Davin         CAR 39038
.           Recompiled for change to viscmtfd
. V9.03.08  26/09/2003 Tracey Nguyen CAR 36510
.           Added TUOSDT00 for Take up Outstanding Debts based on IBABIL33.PBL
. V9.03.07  01/09/2003 Lina Vo       CAR 40497
.           Recompiled for PATMCHFD & IO.
.           16/09/2003 Lina Vo       CAR 36504
.           Added Input Items 
. V9.03.06  22/08/2003 J.Tan
.           Added input Items
. V9.03.05  29/07/2003 J.Tan
.           Fixed Journals option
. V9.03.04  27/06/2003 Tracey Nguyen CAR 40428
.           Moved MASF0000 from PROFLD62 to PROFLD61 to comply with the 
.           coding standards.  Fixed patient folder colour issue.           
. V9.03.03  19/06/2003 J.Tan    CAR 29832
.           Mods for Billing comments
. V9.03.02  27/05/2003 Tracey Nguyen CAR 36508
.           Added Refund Deposit (based on IBABIL97)
. V9.03.01  13/05/2002 J.Tan    CAR 36505
.           Added Input Journals
.----------------------------------------------------------------------
. V9.02.06  20/04/2002 J.Tan
.           Recompiled for casemix
. V9.02.05  10/02/2002 Sandra Barcham
.           Read CRECPNO from correct sector and position in controlf
. V9.02.04  07/12/2001 Tonii
.           Recompiled for CMGETTHR - Casemix mods
. V9.02.03  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.02  29.11.2001  B.G.Ackland                                    *
.           Remove pi's from Program
. V9.02.01  26.10.2001 J.Tan
.           Mods to charge MBS items using MBS amount for selected claim codes
.----------------------------------------------------------------------
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
.----------------------------------------------------------------------
. V9.00.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B02 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B01 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
.----------------------------------------------------------------------
.                 V5.08.02  15/01/2001 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.09.01  04/01/2001 Jill Habasque
.                           Casemix Mods - Recompiled for WEBDINVS
.                 V5.08.04  28/09/2000 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.08.03  16/08/2000  Caleb Sharman  
.                           Changed Health Fund variables to be 8 chars
.                 V5.08.02  27.07.2000 B.G.Ackland
.                           Recompiled for PATFIG  
.                 V5.08.01  07/06/2000 Bronko Sosic
.                           Recompiled for PATMASTM
.----------------------------------------------------------
.                 V5.07.04  12/01/2000  Bronko Sosic
.                           Added REP " 0" after CYY
.                 V5.07.03  05.01.2000  Katie Nelson       
.                           Recompiled for WEBDATCD Y2K date correction 
.                           also PATMASTM changes 
.                 V5.07.02  20.12.1999  Katie Nelson       
.                           Recompiled for IBAWEBDF/IBAWEBCD
.                 V5.07.01  03/11/1999  Katie Nelson       
.                           Recompiled for WEBDATCD/DAYOFWEK
.                 V5.07.00  19/09/1999  Nicole Harrington
.                           Ported from 5.07
.----------------------------------------------------------------------
.                 V6.06.00 15.04.1999 K.C.Nelson 
.                          Created Program
.----------------------------------------------------------------------
.
          INC       IBAWEBDF    
          INC       WEBDATDF    
          INC       RSHWEBDF
.
          INC       TFILEVAR/INC
          INC       PATDHEAD/INC
          INC       IBAGSTFD/INC
          INC       IBAGEDFD/INC
          INC       WEBDINVS/INC
          INC       PATIPRTD/INC
.
          INC       OPRARDFD/INC
          INC       OPRSRGFD/INC
          INC       OPRDEAFD/INC
          INC       OPRREQFD/INC
          INC       APSMASFD/INC
          INC       EMRVISFD/INC
          INC       EMRVCDFD/INC
          INC       EMRHISFD/INC
          INC       AAEDE1FD/INC
          INC       AAEDI1FD/INC
          INC       AAEDTRFD/INC
          INC       AAEMCHFD/INC
          INC       COMDEPFD/INC
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       IBAPOLFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSPYRFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIDEFD/INC
          INC       NZPSPRFD/INC
          INC       NZPCMTFD/INC
          INC       PATALRFD/INC
          INC       PATCFAFD/INC
          INC       PATCMXFD/INC
          INC       PMSCIDFD/INC
          INC       PATDRGFD/INC
          INC       PATCALAG/INC
          INC       PATDDHFD/INC
          INC       PMSCHAFD/INC
.
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATCTFFD/INC
          INC       PATDETFD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATELGFD/INC
          INC       PATECHFD/INC
          INC       PATGTUFD/INC
          INC       PATFACFD/INC
          INC       PATFIGFD/INC
          INC       PATFLTFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATFINFD/INC
          INC       NZPFINFD/INC
          INC       NZPFIGFD/INC
          INC       PATHFRFD/INC
          INC       PATHSPFD/INC
          INC       PATIJRFD/INC
          INC       PATIPRFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATJRNFD/INC
          INC       PATILTFD/INC
          INC       PATIPEFD/INC
          INC       PATONHFD/INC
          INC       PATITMFD/INC
          INC       PRIITMFD/INC
          INC       PATIRNFD/INC
          INC       PATLHIFD/INC
          INC       PATMA1FD/INC
          INC       PATCMTFD/INC
          INC       PMSADWFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCMTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSMTIFD/INC
          INC       TMPMTIFD/INC
          INC       TMPJRNFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSLHIFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSPTHFD/INC
          INC       PMSPTDFD/INC
          INC       PATRGMFD/INC
          INC       PMSREGFD/INC
          INC       PMSVX1FD/INC
          INC       PATMCHFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPRFNFD/INC
          INC       PATPR1FD/INC
          INC       PATMI1FD/INC
          INC       PATMMBFD/INC
          INC       PATNIDFD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATSGCFD/INC
          INC       PATTRNFD/INC
          INC       PATTFEFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PATUREFD/INC
          INC       RESLNKFD/INC
          INC       MRTMASFD/INC
          INC       VISCMTFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PMSICMFD/INC
          INC       PATBFEFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATPGRFD/INC
          INC       PATRE1FD/INC
          INC       PATONLFD/INC
.
          INC       PMSHCGTD/INC
          INC       NZPSPRTD/INC
          INC       PMSHCPTD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPREGFD/INC
          INC       RCPBDTFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
.
ITEMFIL1  IFILE     SQL, FIXED=492, KEY="U1-8,9-10,11-18,19-25,26-30,31-38"
ITEMFIL2  IFILE     SQL, FIXED=492, KEY="U31-38"
.
. Name    Type     Size   Physical  Start
.------   ----     ----   --------  -----
XDAADMNO  DIM       8        8        1
.TSESSION DIM       2        2        9
SDATE     DIM       8        8        11
DXAMT     DIM       7        7        19
DXMBS     DIM       5        5        26
UNIQUEX   DIM       8        8        31
.TPATAMTT FORM     12.2      8        39
.AURNO    DIM       8        8        47
.MITMTYP  FORM      1        2        55
.MCHARGE  DIM       9        9        57
.MDESC    DIM       30       30       66
.ATRANNO  FORM      3        3        96
.PNAME    DIM       35       35       99
.TRECEIPT DIM       12       12       134
MULTNUM  FORM      4        3        146
.MINDIC   FORM      1        2        149
.MBSFLAG  FORM      1        2        151
.TPATAMTP FORM     12.2      8        153
.TREBATE  FORM     12.2      8        161
.ACLAIM   DIM       3        3        169
.AFUNDH   DIM       6        6        172
.AFNDTB   DIM       4        4        178
.IAMT     FORM      5        4        182
KEYFLAG  FORM      1        2        186
.MMSCGRP  DIM       3        3        188
.MNINV    FORM      1        2        191
.IBAND1   DIM       3        3        193
.IBAND2   DIM       3        3        196
.IBAND3   DIM       3        3        199
.IBAND4   DIM       3        3        202
.IBAND5   DIM       3        3        205
.IBAND6   DIM       3        3        208
.IBAND7   DIM       3        3        211
.IBAND8   DIM       3        3        214
.PVITYPE  FORM      1        2        217
.PVIBILL  FORM      8        5        219
SYSID    DIM       2        2        224
.ISDAYC   FORM      1        2        226
PCENFLG  FORM      1        2        228
.ACLSS    DIM       3        3        230
.IBAND9   DIM       3        3        203
.IBAND10  DIM       3        3        236
.IBAND11  DIM       3        3        239
.IBAND12  DIM       3        3        242
.IBAND13  DIM       3        3        245
.IBAND14  DIM       3        3        248
.IBAND15  DIM       3        3        251
.IBAND16  DIM       3        3        254
.PTMCKREB DIM       1        1        257
.CMIXFLAG  FORM      1        2        258
PTCTEPSD  DIM       2        2        260
.PTMCGSTA FORM      1        2        262
.PTMCGSTC DIM       6        6        264
CMBSFEE   DIM       1        1        270
.PTMCALGR  DIM       3        3        271
NZUNIQUE  DIM       3        3        274
NZINCTYP  DIM       1        1        278
.TPATAMTG FORM     12.2      8        279
.NZMCKPRI DIM       1        1        287
THEABAND  DIM       3        3        288
STRTIME   DIM       5        5        291   * MBS Item Start Time
ENDTIME   DIM       5        5        296   * MBS Item End Time
MISCDESC  DIM      65       65        301   * Misc.Desc
NZEXPITM  DIM       1        1        366
.-----------  Eclipse Bulk billing                             *T0859743-start
DURATIME  DIM       3        3        367   * Time Duration (mins)
ACOVRIDE  DIM       1        1        370   * After Care Override Ind
MULPROVR  DIM       1        1        371   * Multi Procedure Override
DUPSROVR  DIM       1        1        372   * Duplicate Service Override
SERVTEXT  DIM       50      50        373   * Service Text
HOSPINDI  DIM       1        1        423   * Hospital Indicator?
NUMPTSEE  DIM       2        2        424   * Number of Patients Seen
ROVRCODE  DIM       3        3        426   * Restrictive Override Code
SLDMCODE  DIM       3        3        429   * Self Deem Code
LSPNVNUM  DIM       6        6        432   * Location Specific Practice
SUBITEMN  DIM       3        3        438   * Sub Item Number
SETCMGRP  DIM       3        3        441   * Set Code / Misc Group
PMMTIKEY  DIM       36       36       444   * Set Code / Misc Group
.-----------                                                   *T0859743-end
.-----------  Eclipse DVAW 
DISTAKMS  DIM       8        8        480
.SPARE    DIM       4        4        488
. End of Record                       492
.
.  redefine form fields from key
.  -----------------------------
. Name    Type     Size   Start
.------   ----     ----   -----
.AADMNO   FORM      8        1
XAMT     FORM      4.2     15
XMBS     FORM      5       21
.
TEMP1     IFILE     SQL, FIXED=22, KEY="u1-17"
.----------------------------------------------------
.TEMP1  Temp file to store the number of misc charges per admission
.----------------------------------------------------
. Name     Type     Size   Physical  Start
.------    ----     ----   --------  -----
XADMNO    DIM       8        8        1
XCHARGE   DIM       9        9        9
XMCCNT    FORM      5        4        18
.EOF                                  22
.
TEMP2     IFILE     SQL, FIXED=22, KEY="u1-2,3-10"
.---------------------------------------------------------------------------
.TEMP2  Temp file to store effective date of changing atype for each session
.---------------------------------------------------------------------------
. Name     Type     Size   Physical  Start
.------    ----     ----   --------  -----
TMSESS    DIM       2        2        1      * Session
TMDATE    DIM       8        8        3      * Item date
TMEFFD    DIM       8        8        11     * Effective date
TMSPAR    DIM       3        3        19     * Spare
.EOF                                  22
.
SUBPACK   FORM      1
SYSIP     INIT      "IP"
SYSOP     INIT      "OP"
SYSOT     INIT      "OT"
SYSAE     INIT      "AE"
SYSDY     INIT      "DY"
BITMFLAG  FORM      1
DELFLAG   FORM      1
DELFLAG1  FORM      1
DEFTOCGR  FORM      1
DIM3A     DIM       3
DIM3B     DIM       3
DIM10A    DIM       10
DIM11     DIM       11
DIM16     DIM       16
DOCCHGIN  DIM       1
APPSIGHT  DIM       3
AAEPAT    INIT      "EMR"
OUTPAT    INIT      "OUT"
INPAT     INIT      "INP"
PPRAC     INIT      "PRI"
PLANNED   INIT      "Planned      "
PERFORMD  INIT      "Performed    "
MIN       DIM       2
NOTPERFD  INIT      "Not Performed"
NZCLDESC  DIM       25
PATINS    DIM       3
PRIMARY   DIM       3
PROCSTAT  DIM       13
RECEIPTN  DIM       12
RCPTRCNT  DIM       5
RCPTNUMB  DIM       12
RCPTAMNT  FORM      12.2
PAYMTYPE  DIM       1
PAYMCODE  DIM       3
PATSYST   FORM      1
PRITEMIN  DIM       1
PTRGM001  DIM       10
.
ADMTYP    DIM       3                       * Admission type
ADMTYPFG  FORM      1                       * Auto admission type flag
CASEKEYS  DIM       26
DISPCNAM  DIM       30
DISPCTIM  DIM       12
DISPCDAT  DIM       11
DIM2A     DIM       2
DIM2B     DIM       2
EBSMINDC  DIM       1          
FNAMET1   DIM       8
FNAMET2   DIM       8
FNAMET3   DIM       8
FGSTFLAG  FORM      1
FINCODE1  DIM       13            *     FINANCE CODE
FINCODE2  DIM       13            *     FINANCE CODE
FINTYPE1  DIM       1             *     FINANCIAL TYPE
FINTYPE2  DIM       1             *     FINANCIAL TYPE
FIVE9     FORM      "59"
F12P2     FORM      12.2
FORM1P2   FORM      1.2
FORM3P4   FORM      3.4
FORM12P4  FORM      12.4
FORM5     FORM      5
FORM8     FORM      8
FORM10    FORM      10
HX13INDC  DIM       1
KEY13A    DIM       13
KEY12A    DIM       12
KEY21A    DIM       21
..KEY26A    DIM       26
KEY29A    DIM       29
.SEC1      FORM      "00001"
HOUR      DIM       2
PCONSFEE  FORM      "1.01"
PCONSFEC  FORM      "1.02"
PMDOFEEX  FORM      "1.03"
PMEDSFEE  FORM      "1.04"
PREVSFEE  FORM      "1.05"
PWCVRFEE  FORM      "1.06"
STFOUTOH  FORM      "1.07"
CHEMOCRD  FORM      "1.08"
SUBITDVA  FORM      "1.09"
SUBITDVF  FORM      "1.10"
NOITEMXX  FORM      "1.11"
P140PERC  FORM      "1.40"
P135PERC  FORM      "1.35"
P85PERCT  FORM      "0.85"
P75PERCT  FORM      "0.75"
P50PERCT  FORM      "0.50"
P50EDPCT  FORM      "9.50"
P65PERCT  FORM      "0.65"
P43PERCT  FORM      "0.43"
P25PERCT  FORM      "0.25"
AMAFAMNT  FORM      " .00"
MMDOAMNT  FORM      "9.01"
A50PERCT  FORM      "9.50"
B25PERCT  FORM      "9.25"
B55PERCT  FORM      "9.55"
BULKFLAG  FORM      1
RECMPAMT  FORM      "9.97"
REVWAMNT  FORM      "9.98"
ZEROAMNT  FORM      "9.99"
PATINAME  DIM       18
DATEEND   DIM       12
DATESTR   DIM       12
DOCTCODE  DIM       6
DTRDATE   DIM       8                       * DTR date (ccyymmdd)
COUNTER   FORM      3
CURSESS   DIM       18
CURRDATE  DIM       8                       * Current date (ccyymmdd)
CDESC     DIM       25
CNTITEM   FORM      3
CALDAYS   FORM      4
INVPDVAL  DIM       1
.
CHREQKEY  DIM       66[999]
CHREQQUA  FORM      3[999]
CHREQCHR  FORM      1[999]
.
PMSMTIKY  DIM       14[999]
PMSMTICT  FORM      3
.
DAYCASEF  DIM       1
DIM30     DIM       30
.
ECLNOTES  DIM       100
ECLPDATE  DIM       12
EMCNGINV  DIM       1
EMCNAPRO  DIM       1
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
EFFADATE  DIM       11
ENDNAME   DIM       70
EXPCHCNT  FORM      2             * Exploding MBS charge counter
EFTADMIN  DIM       8                       * Effective admission number
EFTATYPE  DIM       3                       * Effective admission type
EFTDATE   DIM       8                       * Effective date (ccyymmdd)
EFTTIME   DIM       8                       * Effective time
EMBLINDC  DIM       1
EMVIS094  DIM       1
.
FACTDATE  DIM       8             * Future Action Date
FACTCODE  DIM       3             * Future Action Code 
FACTOCGR  DIM       3             * Future Action Occupational Group
FACTINVN  DIM       8             * Future Action -  Invoice number
FACTHFND  DIM       6             * Future Action Health Fund
FACTCOMM  DIM       60            * Future Action Comment
FADTCOMP  DIM       8             * Future Action -  Date Completed
DSDTCOMP  DIM       11            * Display Format for FA Date Completed
FILTHFND  DIM       6             * Future Action Health Fund Filter
FILTACTN  DIM       3             * Future Action Action Type Filter
FILTOCGR  DIM       3             * Future Action Occupational Group Filter
FLTRSTAT  FORM      1             * Search Filter - Future Action Status
FORM42    FORM      4.2
FORM102   FORM      10.2
FOLDSUFX  DIM       3
.
HTMLLNK3  DIM       256
.
ITTRN     DIM       6[999]
INVCFLAG  FORM      1
ISDAYC    FORM      1
LOCKCNT   FORM      3
MAXDATE   DIM       8
MISCTTL1  DIM       30
MISCTTL2  DIM       30
.
MHLRCODE  DIM       3
NOCHARGE  DIM       9
OCCGDESC  DIM       20
PATLINK   DIM       127                     * Link to the next patient info
.
DRBILCHR  DIM       1
.
PMTIFLAG  DIM       1  
PTRKFILN  DIM       25
PTDSVKEY  DIM       30
.
REGMFLAG  FORM      1
REBAREAS  DIM       3
.
SERVDATE  DIM       8
SERVDOCT  DIM       10
SDOCCODE  DIM       8
SAVAMNT   FORM      12.2
SAVKEY12  DIM       12
SAVKEY16  DIM       16
SAVADM    DIM       8
SAVKEY3   DIM       3
SAVKEY9   DIM       9
SAVKEY13  DIM       13
SAVKY13A  DIM       13
SAVKEY18  DIM       18
SAVKEY22  DIM       22
SAVTRNO   FORM      3
STOFYEAR  DIM       8
STRTNAME  DIM       70
SMCHARGE  DIM       9
.
TOTPAID   FORM      12.2
TRANSNUM  DIM       6
TDATE1    DIM       8
TEAMNUMB  DIM       1
UNIQUE    FORM      8
UPDATETY  DIM       1                       * Update Type
UPDLINK   DIM       127
UPDTTYPE  DIM       1                       * Update Type
UNIQUEKY  DIM       10
NEXTPAGE  DIM       2                       * Next Page Option
NMPNUMB   DIM       20
IDNOWARN  DIM       1
ROWCOUNT  FORM      5
.
ZERO8     INIT      "0000    "
ZERO4     INIT      "0000"
BLCOMMNT  DIM       70[35]
IVCOMMNT  DIM       70[35]
BATCHNO   FORM      8
BATCHND   DIM       8
BTYPEF    FORM      1
COMFILAF  FILE      ASCII, FIXED=127
ICMFILAF  FILE      ASCII, FIXED=127
PMHFILAF  FILE      ASCII, FIXED=127
WDIFILAF  FILE      ASCII, FIXED=127
CLNFILAF  FILE      ASCII, FIXED=127
COMFILNM  DIM       8
ICMFILNM  DIM       8
PMHFILNM  DIM       8
WDIFILNM  DIM       8
CLNFILNM  DIM       8
CODECL    INIT      "CL"
CODEJ     INIT      "J "
CODEA     INIT      "A "
DAY       DIM       2
FNAMEB    DIM       8
MONTH     DIM       2
ONAME     DIM       30
OPERCODE  DIM       4
OPOCFLAG  FORM      1
OPCNCONS  DIM       1
YR        DIM       2
CENT      DIM       2 
XDATE2    DIM       8
DIM1A     DIM       1
DIM3      DIM       3
DIM4      DIM       4
DIM18     DIM      18
DIM18A    DIM      18
SP14      INIT      "              "
INVICODE  INIT      "Invalid Item Code "
ITEMTYPE  DIM       1
THCFLG    FORM      2
TILDA35   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
PORTION   DIM       1
PTGTU001  DIM       1
PTGTU002  DIM       6
TRANFINV  DIM       8
TINVOICE  FORM      8
PATPORTN  FORM     12.2
REBPORTN  FORM     12.2
WDATE1    DIM       8
WDATE2    DIM       8
CATRH     INIT      "rh"
.
.AGEDATE   DIM       8
CASEFLAG  FORM      1
MBSFLAG   FORM      1
MBSLOP    FORM      2
MBSCOUNT  FORM      2                       * MBS item counter
MBSDATE   DIM       8[15]                   * MBS date (ccyymmdd)
MBSITEM   DIM       9[15]                   * MBS items
NOATYPUP  FORM      1                       * No admission type updated flag
.
.BRTHLYR   FORM      1 **
.
LASTITEM  FORM      3
LASTITM2  FORM      3
LASTITM3  FORM      3
MAXGSTJ   FORM      12.2
SAVERCPT  FORM      12.2
.
MTIFLAG   FORM      1
MISCPATT  FORM      10.2
MISCREBT  FORM      10.2
GSTAMT    FORM      10.2
GSTCODES  DIM       6
INVOICEN  FORM      8
ITEMCODE  DIM       9
.
JTYPE     DIM       1
JOURDATE  DIM       8
JOURITEM  DIM       3
JOURDESC  DIM       30
JOURPATT  FORM      10.2
JOURREBT  FORM      10.2
JOURAMTT  FORM      10.2
.
PTCSH001  FORM      1                    * receipt type/payment method
PTCSH002  FORM      6.2                  * receipt amount
PTCSH003  DIM       30                   * cheque drawer
PTCSH004  DIM       30                   * cheque bank
PTCSH005  DIM       30                   * cheque branch
PTCSH006  DIM       30                   * credit card type
.PTCSH007  DIM       30                   * merchant card type
.
PTIPE001  DIM       3                    *  Reason for Hold (Cat YH)
PTIPE002  DIM       80                   *  Reason for Hold Free Text
.
.PSAGEMNT  FORM      4  **
.PSAGEDAY  FORM      5  ** 
.PSAGEYRS  FORM      3  **
.
MDATE     DIM       8[999]
ITEMN     DIM       9[999]
SUBIT     DIM       3[999]
GSTAP     FORM      1[999]
GSTCD     DIM       6[999]
DESCP     DIM       30[999]
NZDES     DIM       65[999]
QUNTY     FORM      4[999]
REFNC     DIM       12[999]
SESSN     DIM       2[999]
CAMNT     FORM      10.2[999]
PATPR     FORM      12.2[999]
REBPR     FORM      12.2[999]
EFDAT     DIM       8[999]
UNIQU     DIM       3[999]
INCTY     DIM       1[999]
SUBPC     DIM       1[999]
MDATE000  DIM       8
INCTY000  DIM       1
ITEMN000  DIM       9
PROCE000  DIM       9
PROCDESC  DIM       80
UNIQU000  DIM       3
.
TRNNO     DIM       6[999]
CSTRN     DIM       1[999]
IVTRN     DIM       8[999]
STTIM     DIM       5[999]
ENTIM     DIM       5[999]
PYAMT     FORM      12.2[999]
PUNIQ     DIM       3[999]
.
. Variable for Emergency procedures
.
DOCTN     DIM       10[999]
ITYPE     DIM       1[999]
PROCI     DIM       9[999]
SITEM     DIM       5[999]
SCHDF     FORM      1.2[999]
PQUAN     FORM      4[999]
PAMNT     FORM      12.2[999]
RECPN     DIM       12[999]
TKBOX     DIM       1[999]
.
. Variables for Outpatient Eclipse Bulk Billing                *T0859743-start
.
DURAT     DIM       3[999]             * Time Duration (Mins)
ACOVR     DIM       1[999]             * After Care Override Indicator
MULPR     DIM       1[999]             * Multi Procedure Override  
DUPSR     DIM       1[999]             * Duplicate Service Override
SRVTX     DIM       50[999]            * Service Text
HOSIN     DIM       1[999]             * Hospital Indicator
NUMPT     DIM       2[999]             * Number of Patients Seen
SLDMC     DIM       2[999]             * Self Deem Code
LSPNV     DIM       6[999]             * Location Specific Practice No
ROVRC     DIM       3[999]             * Restrictive Override Code
.
TYPEBBIL  DIM       1                  * Eclipse Bulk Billing Type
.                                                              *T0859743-end
. Variables for Outpatient Eclipse DVAW
.
DSKMS     DIM       8[999]             * Distance Kms 
.
TYPEDVAW  DIM       1                  * Eclipse DVAW Type
.
PROCDATE  DIM       8
PROCTIME  DIM       8
GETCLCOD  DIM       1
PROCEDFR  DIM       9
PROCEDTO  DIM       9
CNTRTYFR  DIM       3
CNTRTYTO  DIM       3
CNTRFNFR  DIM       6
CNTRFNTO  DIM       6
UNIQNOTO  DIM       3
UNIQNUMB  DIM       3
.
. Refund Deposit variables
.
RFUND001   FORM     3                       * Cash transaction number     
RFUND002   DIM      3                       * Reason for refund
RFUND003   DIM      12                      * Cash receipt number     
DEPDATE    DIM      11                      * Deposit date
DEPTYPE    DIM      11                      * Deposit type
.
.SAVAGEYR  FORM      3  **
.
VALDTYPE  FORM      2                       * Validataion Status
WARCOUNT  FORM      2
WARNINGC  FORM      2           * Array Counter
WARNINGL  DIM       85          * Message,add,Array
WEBWARNG  DIM       127[20]
WARNINGM  DIM       85[20]      * Array of Warning Messages
.
. Take Up Outstanding Debts
.
OSDBT001  DIM       8           * Miscellaneous Debt
OSDBT002  DIM       8           * Miscellaneous H.F Debt
OSDBT003  DIM       8           * Admission Number   
OSDBT004  DIM       8           * U/R Number        
OSDBT005  FORM      8           * Invoice Number    
OSDBT006  DIM       8           * Invoice Date      
OSDBT007  FORM      8.2         * Debt Amount 1     
OSDBT008  FORM      8.2         * Debt Amount 2     
OSDBT009  DIM       3           * Claim Type   
OSDBT010  DIM       3           * Hospital Id  
OSDBT011  DIM       6           * Health Fund
OSDBT012  DIM       8           * Health Fund Table
OSDBT013  DIM       1           * System (1=AAE,3=Inpat)
.      
ADMFOUND  FORM      1
.
. Bulk Miscellaneous Charges 
.
TMMTI001  DIM       8           * UR Number
TMMTI002  DIM       8           * Visit Number
TMMTI003  DIM       8           * Transaction Date
TMMTI004  DIM       9           * Item Number
TMMTI005  DIM       30          * Description
TMMTI006  DIM       5           * Quantity
TMMTI007  DIM       12          * Reference
TMMTI008  DIM       15          * Patient Amount 
TMMTI009  DIM       15          * Rebate Amount
TMMTIBAT  DIM       8           * Batch Number
.
TRANNUMB  DIM       6
BMCHTOTL  FORM      12.2
.
. Bulk Journal Input
.
TMJRNBAT  DIM       8           * Batch Number
TMJRN001  DIM       8           * U/R Number  
TMJRN002  DIM       8           * Visit Number  
TMJRN003  DIM       8           * Invoice Number    
TMJRN004  DIM       3           * Type of Journal (C
TMJRN005  DIM       8           * Journal Date (CCYY
TMJRN006  DIM       30          * Journal Descriptio
TMJRN007  DIM       13          * Journal Amount
TMJRN008  DIM       6           * GST Code
.
BJNLTOTL  FORM      12.2
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
CMNOTENO  FORM      6
CMLINENO  FORM      3
CMEXIST   FORM      1  
CURRDATX  DIM       8
TRNSUPTY  FORM      1        * Supervisor Hold Invoice Flag
DIM80     DIM       80
.
REVRECPT  FORM      1        * Receipt Number Order
.
.==========================================================================
PRGID     INIT      "PATWEB75"
VERSION   INIT      "V12.00.06"
PRGNAM    INIT      "Input Miscellaneous Charges and Journals"
.==========================================================================
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
MAINLINE  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MBSI0000                * Add MBS Item
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTITM00
          GOTO      MAIN1000
.
MAIN1200  MOVE      ZERO,BULKFLAG           * Bulk journal input set to NO
          CALL      JNLUPD00                * Add Journal
          BRANCH    EXIT,MAIN1000
.
          CALL      WINCLS00
          GOTO      MAIN1000
.
MAIN1300  CALL      FUTURE00                * Add Future Action   
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      FUTACT00                * Future Actions by Date
          GOTO      MAIN1000
.
MAIN1500  CALL      CASH0000                * cash receipt
          BRANCH    EXIT,MAIN1000
          CALL      WINCLS00
          GOTO      MAIN1000
.
MAIN1600  CALL      DEPOST00                * Refund Deposit by date
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      BLCMN000                * Billing comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      TUOSDT00                * Take Up Outstanding Debts
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      CSHTRN00                * Cash Transfer
          BRANCH    EXIT,MAIN1000
          CALL      WINCLS00
          GOTO      MAIN1000
.
MAIN2000  CALL      OVRPAY00                * Cash Transfer for overpayment
          BRANCH    EXIT,MAIN1000
          CALL      WINCLS00
          GOTO      MAIN1000
.
MAIN2100  CALL      PROC0000                * Add Procedure item
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      PRSTRK00                * Prosthetic Tracking Enquiry
          GOTO      MAIN1000 
.
MAIN2300  CALL      IVCMN000                * Invoice comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      DEPTRN00                * Deposit Transfer
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      ADDSUN00                * Add Sundry Charges
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      DPEN0000                * Delete Invoice Pending Record
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      BMSC0000                * Bulk Miscellaneous Charges
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2800  CALL      BJRN0000                * Bulk Journal Input
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      INPROV00                * Johns Hopkins Insurance Provider
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      VBCMN000                * Visit Based Comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3100  CALL      RGMP0000   * Patient Regimes table
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F2
          MOVE      NEXTPAGE,F2
          BRANCH    F2,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINCL100
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      WEBWAR00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      WIN2CL00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------
. Close Window
.------------------------------------------------------------
WIN2CL00  CALL      OPENHTML
          BRANCH    EXIT,WIN2CL99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name.match(/PopUpFrame1/)) {":
  "  parent.parent.document.getElementById('PopUpScreen').style.display=#"none#"; ":
                             "} else if (self.name.match(/PopUpFrame/)) {":
  "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; ":
                             "} else { ":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WIN2CL99  RETURN
.------------------------------------------------------------
. MBS Item Next Page Routine
.------------------------------------------------------------
NXTITM00  MOVE      ZERO,F2
          MOVE      NEXTPAGE,F2
          BRANCH    F2,NXTITM10,NXTITM10,NXTITM10,NXTITM10,NXTITM10:
                       NXTITM10,NXTITM70,NXTITM80,NXTITM90,NXTIT100
.
NXTITM10  CALL      WINCLS00
          GOTO      NXTITM99
.
NXTITM70  CALL      PREDIR00
          GOTO      NXTITM99
.
NXTITM80  CALL      WINCL300
          GOTO      NXTITM99
.
NXTITM90  CALL      RDIREC00
          GOTO      NXTITM99
.
NXTIT100  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTITM99  RETURN
.------------------------------------------------------------
. Refresh Parent of Parent and Close Window
.------------------------------------------------------------
WINCL100  CALL      OPENHTML
          BRANCH    EXIT,WINCL199
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  reload2ParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCL199  RETURN
.-------------------------------------------------------------------------------
.  Goes back x number of pages
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F2
          SUB       TWO,F2
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
.                            "    self.close();":
                             "    window.history.go(-",F2,");":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00 
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      AAEDTRE1,"aaedtref"
          OPEN      AAEMCHG1,"aaemchgf"
.
          OPEN      COMDEPA1,"comdepaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      COMDEPA3,"comdepaf"
          OPEN      CONTROLF,"controlf"
.
          OPEN      EMRHISA1,"emrhisaf"
          OPEN      EMRHISA2,"emrhisaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVCDA1,"emrvcdaf"
.
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      IBAGSTA2,"ibagstaf"
          OPEN      IHAPASS1,"ihapassf"
.
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PMSUCHA1,"pmsuchaf"
          OPEN      PMSUCDA1,"pmsucdaf"
          OPEN      PATLETR1,"patletrf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDTRA1,"patdtraf"
..          OPEN      PATDTRA4,"patdtraf"
          OPEN      PATECHA1,"patechaf"
          OPEN      PATFLET1,"patfltrf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFACT1,"patfactf"
          OPEN      PATFACT2,"patfactf"
          OPEN      PATFACT3,"patfactf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATONHA1,"patonhaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PRIITEM1,"priitemf"
          OPEN      PATLHIS1,"patlhisf"
          OPEN      PMSLHIA1,"pmslhiaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMXCA1,"nzpmxcaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A3,"patmi1af"
          OPEN      PATTFEE1,"pattfeef"
          OPEN      PATTRAN2,"pattranf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          OPEN      PATGTUA1,"patgtuaf"
          OPEN      PATELGA1,"patelgaf"
.
          OPEN      PATFINS1,"patfinsf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      PATIJRN1,"patijrnf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR2,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATINVR4,"patinvrf"
          OPEN      PATIRNG1,"patirnge"
          OPEN      PATJRNL1,"patjrnlf"
          OPEN      PMSICMA1,"pmsicmaf"
          OPEN      PATRGMA2,"patrgmaf"
.
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSADWA1,"pmsadwaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          OPEN      TMPJRNA1,"tmpjrnaf"
          OPEN      TMPMTIA1,"tmpmtiaf"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PATRGMA2,"patrgmaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSREGA2,"pmsregaf"
          OPEN      PMSREGA4,"pmsregaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSPTHA1,"pmspthaf"
          OPEN      PATUREA1,"patureaf"
          OPEN      PATRE1A1,"patre1af"
.
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPREGA1,"rcpregaf"
.
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRDETA2,"oprdetaf" 
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRREQA1,"oprreqaf"
          OPEN      OPRREQA2,"oprreqaf"
          OPEN      OPRREQA3,"oprreqaf"
.
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
.
          READ      CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC:
                                  *43,IBCNMHOS:
                                  *85,IBCNUGST
          READ      CONTROLF,TEN3;*154,CUSEMBS,*245,CHOSTYP
          READ      CONTROLF,TEN5;*248,CBFXITM
          READ      CONTROLF,TEN8;*143,CLOWMBS,CLOWADM,CHIGHMBS,CHIGHADM:
                                       CTOPADM
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*136,PTCNMITM
          READ      CONTROLF,FIFTY9;*74,CGSTITEM
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          READ      CONTROLF,HUND05;*99,PTCNNWCM:
                                    *130,PTCNAUAT:    * auto update adm.type
                                         PTCNWSPC:    * Warning for sub-seq item
                                    *177,PTCNTFEE:      * Using theatre fees
                                    *190,PTSGCOPT     * Using suggested class.
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,TEN;*192,CACCFEE
          READ      CONTROLF,HUND03;*1,PTCNCJRN
          READ      CONTROLF,TEN8;*254,CJRNDAT,*255,CJRNREP
          READ      CONTROLF,FIFTY9;*25,CFUTCOM
          READ      CONTROLF,FIVE9;*62,CINVJRN
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,EIGHTY9;*204,EMCNAPRO,*205,EMCNDPOC,*206,EMCNOPOC:
                                     *221,EMCNGINV
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND12;*101,PTCNUFFR,*118,PTCNTRPR:
                                                  *248,PTCNGJRN
          READ      CONTROLF,HUND14;*249,PTCNDFUP
.
          READ      CONTROLF,HUND24;*222,PTCNUESF
          READ      CONTROLF,HUND25;*93,PTCNNSSI,*246,PTCNINVH
          READ      CONTROLF,HUND27;*122,PTCNUEBB                     *T0859743
          READ      CONTROLF,HUND29;*89,PTCNPPIN,*193,PTCNBBSW,*249,PTCNDVAW
          READ      CONTROLF,HUND30;*84,PTCNSTUN
.
          MATCH     "1",PTCNTRPR
          IF        @EQUAL
            OPEN      PMSPTDA1,"pmsptdaf"
            OPEN      PMSPTDA2,"pmsptdaf"
            OPEN      PMSPTDA3,"pmsptdaf"
            OPEN      PMSPTDA5,"pmsptdaf"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          IF        CFEETYP=9
            OPEN      PATIPRA1,"patipraf"    * Johns Hopkins Insurance provider
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,ICMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PMHFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,WDIFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CLNFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMET1
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMET2
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMET3
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CURRDATE
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,UPDATETY
          MOVE      ZERO,STARTNUM
          MOVE      SP70,ADMISSNO
          MOVE      SP70,VIEWTYPE
          MOVE      ZERO,NORECORD
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,FACTDATE 
          MOVE      SP70,FACTCODE
          MOVE      SP70,FACTOCGR
          MOVE      SP70,FACTINVN
          MOVE      SP70,FACTHFND
          MOVE      SP70,FACTCOMM
          MOVE      SP70,FADTCOMP 
          MOVE      ZERO,FLTRSTAT
          MOVE      ZERO,INVPDVAL
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,PTGTU001
          MOVE      SP70,PTGTU002
          MOVE      ZERO,PATPORTN
          MOVE      ZERO,REBPORTN
          MOVE      SP70,EFFADATE
          MOVE      SP70,FILTHFND
          MOVE      SP70,FILTACTN
          MOVE      SP70,FILTOCGR
          MOVE      ZERO,DEFTOCGR
          MOVE      Z70,PTIPE001
          MOVE      Z70,PTIPE002
          MOVE      ZERO,WARCOUNT
          MOVE      SP70,RECEIPTN
          MOVE      SP70,TRANSNUM
.
.         MOVE      ZERO,MISCPATT
.         MOVE      ZERO,MISCREBT
          MOVE      ZERO,INVOICEN
          MOVE      ZERO,TINVOICE
.
          MOVE      SP70,GSTCODES
          MOVE      SP70,JOURDATE
          MOVE      SP70,JOURDESC
          MOVE      SP70,JOURITEM
          MOVE      ZERO,JOURPATT
          MOVE      ZERO,JOURREBT
          MOVE      ZERO,VALDTYPE
.
          MOVE      ZERO,PTCSH001
          MOVE      ZERO,PTCSH002
          MOVE      SP70,PTCSH003
          MOVE      SP70,PTCSH004
          MOVE      SP70,PTCSH005
          MOVE      SP70,PTCSH006
.          MOVE      SP70,PTCSH007
.
          MOVE      ZERO,LASTITEM
          MOVE      ZERO,LASTITM2
          MOVE      ZERO,LASTITM3
          MOVE      SP70,PROCDATE
          MOVE      SP70,PROCTIME
          MOVE      SP70,GETCLCOD
          MOVE      ZERO,SUBPACK
.
          MOVE      ONE,F4
          WHILE     F4 <= 999
            MOVE      SP70,MDATE[F4]
            MOVE      SP70,ITEMN[F4]
            MOVE      SP70,SUBIT[F4]
            MOVE      SP70,GSTCD[F4]
            MOVE      SP70,DESCP[F4]
            MOVE      SP70,NZDES[F4]
            MOVE      SP70,REFNC[F4]
            MOVE      SP70,SESSN[F4]
            MOVE      SP70,EFDAT[F4]
            MOVE      SP70,UNIQU[F4]
            MOVE      SP70,INCTY[F4]
            MOVE      SP70,SUBPC[F4]
            MOVE      ZERO,CAMNT[F4]
            MOVE      ZERO,QUNTY[F4]
            MOVE      ZERO,GSTAP[F4]
            MOVE      ZERO,PATPR[F4]
            MOVE      ZERO,REBPR[F4]
            MOVE      SP70,TRNNO[F4]
            MOVE      SP70,IVTRN[F4]
            MOVE      SP70,CSTRN[F4]
            MOVE      SP70,STTIM[F4]
            MOVE      SP70,ENTIM[F4]
            MOVE      ZERO,PYAMT[F4]
            MOVE      SP70,PUNIQ[F4]
            ADD       ONE,F4
          DO
.
          MOVE      ONE,F4
          WHILE     F4 <= 999
            MOVE      SP70,DOCTN[F4]
            MOVE      SP70,ITYPE[F4]
            MOVE      SP70,PROCI[F4]
            MOVE      SP70,SITEM[F4]
            MOVE      SP70,RECPN[F4]
            MOVE      ZERO,SCHDF[F4]
            MOVE      ZERO,PQUAN[F4]
            MOVE      ZERO,PAMNT[F4]
            MOVE      SP70,TKBOX[F4]
            MOVE      SP70,DURAT[F4]
            MOVE      SP70,ACOVR[F4]
            MOVE      SP70,MULPR[F4]
            MOVE      SP70,DUPSR[F4]
            MOVE      SP70,SRVTX[F4]
            MOVE      SP70,HOSIN[F4]
            MOVE      SP70,NUMPT[F4]
            MOVE      SP70,SLDMC[F4]
            MOVE      SP70,LSPNV[F4]
            MOVE      SP70,ROVRC[F4]
            MOVE      SP70,DSKMS[F4]
            ADD       ONE,F4
          DO
.
          MOVE      "999",F3
          MOVE      SP70,TKBOX[F3]
.
          MOVE      SP70,OSDBT001
          MOVE      SP70,OSDBT002
          MOVE      ZERO,OSDBT003
          MOVE      SP70,OSDBT004
          MOVE      ZERO,OSDBT005
          MOVE      SP70,OSDBT006
          MOVE      ZERO,OSDBT007
          MOVE      ZERO,OSDBT008
          MOVE      SP70,OSDBT009
          MOVE      SP70,OSDBT010
          MOVE      SP70,OSDBT011
          MOVE      SP70,OSDBT012
          MOVE      SP70,OSDBT013
.
          MOVE      SP70,PTRKFILN
          MOVE      SP70,PTDSVKEY
          MOVE      SP70,SERVDOCT
          MOVE      SP70,SDOCCODE
.
          MOVE      SP70,EMBLINDC
          MOVE      SP70,EMVIS094
          MOVE      SP70,EBSMINDC
          MOVE      SP70,NOCHARGE
.
          MOVE      SP70,TMMTI001
          MOVE      SP70,TMMTI002
          MOVE      SP70,TMMTI003
          MOVE      SP70,TMMTI004
          MOVE      SP70,TMMTI005
          MOVE      SP70,TMMTI006
          MOVE      SP70,TMMTI007
          MOVE      SP70,TMMTI008
          MOVE      SP70,TMMTI009
          MOVE      SP70,TMMTIBAT
.
          MOVE      SP70,TRANNUMB
.
          MOVE      SP70,TMJRNBAT
          MOVE      SP70,TMJRN001
          MOVE      SP70,TMJRN002
          MOVE      SP70,TMJRN003
          MOVE      SP70,TMJRN004
          MOVE      SP70,TMJRN005
          MOVE      SP70,TMJRN006
          MOVE      SP70,TMJRN007
          MOVE      SP70,TMJRN008
.
          CALL      CPTIPR00
.
          MOVE      SP70,PTRGM001
          MOVE      SP70,REBAREAS
          MOVE      SP70,DRBILCHR
          MOVE      SP70,PROCEDFR
          MOVE      SP70,PROCEDTO
          MOVE      SP70,CNTRTYFR
          MOVE      SP70,CNTRTYTO
          MOVE      SP70,CNTRFNFR
          MOVE      SP70,CNTRFNTO
          MOVE      SP70,UNIQNOTO
          MOVE      SP70,UNIQNUMB
.
          MOVE      SP70,MDATE000
          MOVE      SP70,INCTY000
          MOVE      SP70,ITEMN000
          MOVE      SP70,PROCE000
          MOVE      SP70,PROCDESC
          MOVE      SP70,UNIQU000
.
          MOVE      SP70,HX13INDC
          MOVE      SP70,DOCCHGIN
          MOVE      SP70,PRITEMIN
.
          MOVE      SP70,CASEKEYS
          MOVE      SP70,UNIQUEKY
          MOVE      ONE,TEAMNUMB
          MOVE      ZERO,MTIFLAG
          MOVE      ZERO,TRNSUPTY
.
          MOVE      ONE,F4
          WHILE     F4 <= 999
            MOVE      SP70,CHREQKEY[F4]
            MOVE      ZERO,CHREQQUA[F4]
            MOVE      ZERO,CHREQCHR[F4]
            ADD       ONE,F4
          DO
.
          MOVE      ZERO,REVRECPT  *Receipt Number order
          MOVE      ZERO,BITMFLAG
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            PACK      ADMISSNO,ADMISSNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnno",QRYNAME
          IF        @EQUAL
            CALL      STTRNO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cstrn",QRYNAME
          IF        @EQUAL
            CALL      STCSTR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ivtrn",QRYNAME
          IF        @EQUAL
            CALL      STIVTR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pyamt",QRYNAME
          IF        @EQUAL
            CALL      STPYAM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tinvoice=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TINVOICE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "effadate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EFFADATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdate",QRYNAME
          IF        @EQUAL
            CALL      STMDAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemn",QRYNAME
          IF        @EQUAL
            CALL      STITMN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "subit",QRYNAME
          IF        @EQUAL
            CALL      SUBITM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstap",QRYNAME
          IF        @EQUAL
            CALL      STGSTA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcd",QRYNAME
          IF        @EQUAL
            CALL      STGSTC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "descp",QRYNAME
          IF        @EQUAL
            CALL      STITDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nzdes",QRYNAME
          IF        @EQUAL
            CALL      STNZDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refnc",QRYNAME
          IF        @EQUAL
            CALL      STREFN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recpt",QRYNAME
          IF        @EQUAL
            CALL      STRECP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sessn",QRYNAME
          IF        @EQUAL
            CALL      STSESN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "efdat",QRYNAME
          IF        @EQUAL
            CALL      EFFDAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqueky=",QRYNAME
          IF        @EQUAL
            PACK      UNIQUEKY,QRYDATA,SP70
            REP       "+ ",UNIQUEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqu",QRYNAME
          IF        @EQUAL
            CALL      UNIQU000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "puniq",QRYNAME
          IF        @EQUAL
            CALL      PUNIQ000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "incty",QRYNAME
          IF        @EQUAL
            CALL      INCTYP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "camnt",QRYNAME
          IF        @EQUAL
            CALL      STAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpr",QRYNAME
          IF        @EQUAL
            CALL      PTAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rebpr",QRYNAME
          IF        @EQUAL
            CALL      RBAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sttim",QRYNAME
          IF        @EQUAL
            CALL      STRTIM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "entim",QRYNAME
          IF        @EQUAL
            CALL      ENDTIM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "qunty",QRYNAME
          IF        @EQUAL
            CALL      STQUNT00
            GOTO      SETPAR99
          ENDIF
.
.-----------  Eclipse Bulk billing                             *T0859743-start
.
          MATCH     "durat",QRYNAME
          IF        @EQUAL
            CALL      STDRAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acovr",QRYNAME
          IF        @EQUAL
            CALL      STACOV00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mulpr",QRYNAME
          IF        @EQUAL
            CALL      STMULP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dupsr",QRYNAME
          IF        @EQUAL
            CALL      STDUPS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srvtx",QRYNAME
          IF        @EQUAL
            CALL      STSRVT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hosin",QRYNAME
          IF        @EQUAL
            CALL      STHOSI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "numpt",QRYNAME
          IF        @EQUAL
            CALL      STNUMP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sldmc",QRYNAME
          IF        @EQUAL
            CALL      STSLDM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lspnv",QRYNAME
          IF        @EQUAL
            CALL      STLSPN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rovrc",QRYNAME
          IF        @EQUAL
            CALL      STROVC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "typebbil=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TYPEBBIL
            GOTO      SETPAR99
          ENDIF
.-----------  Eclipse Bulk billing                             *T0859743-end
.
.-----------  Eclipse DVAW        
.
          MATCH     "dskms",QRYNAME
          IF        @EQUAL
            CALL      STDKMS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "typedvaw=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TYPEDVAW
            GOTO      SETPAR99
          ENDIF
.
.-----------
.
          MATCH     "miscpatt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,MISCPATT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "miscrebt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,MISCREBT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "idnowarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IDNOWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcodes=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,GSTCODES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourpatt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,JOURPATT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourrebt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,JOURREBT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jouritem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURITEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURDESC
            PACK      JOURDESC,JOURDESC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "factdate=",QRYNAME
          IF        @EQUAL
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL 
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      FACTDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "factcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FACTCODE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "factocgr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FACTOCGR
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "factinvn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FACTINVN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "facthfnd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FACTHFND
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "factcomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FACTCOMM
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "fadtcomp=",QRYNAME
          IF        @EQUAL
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      FADTCOMP,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcsh",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY5,KEY3
            MOVE      KEY3,F3
            STORE     QRYDATA,F3,PTCSH001,PTCSH002,PTCSH003,PTCSH004,PTCSH005:
                                 PTCSH006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "blcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETBCM00           * Get billing comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ivcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETICM00           * Get invoice comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETPMH00           * Get patient medical history comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETWDI00           * Get working diagnosis comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCLN00           * Get clinical notes comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU002
            PACK      PTGTU002,PTGTU002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patportn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPORTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rebportn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REBPORTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "osdbt",QRYNAME
          IF        @EQUAL
            CALL      STOD0000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procdate=",QRYNAME
          IF        @EQUAL
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PROCDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proctime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proce000=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCDESC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procedfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCEDFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procedto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCEDTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cntrtyfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNTRTYFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cntrtyto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNTRTYTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cntrfnfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNTRFNFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cntrfnto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNTRFNTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqnoto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQNOTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctn",QRYNAME
          IF        @EQUAL
            CALL      STDCTN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itype",QRYNAME
          IF        @EQUAL
            CALL      STITYP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proci",QRYNAME
          IF        @EQUAL
            CALL      STPROC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sitem",QRYNAME
          IF        @EQUAL
            CALL      STSITM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdf",QRYNAME
          IF        @EQUAL
            CALL      STSCHD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pquan",QRYNAME
          IF        @EQUAL
            CALL      STPQUA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pamnt",QRYNAME
          IF        @EQUAL
            CALL      STPAMT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "getclcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,GETCLCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthfnd=",QRYNAME
          IF        @EQUAL
            PACK      FILTHFND,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtactn=",QRYNAME
          IF        @EQUAL
            PACK      FILTACTN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtocgr=",QRYNAME
          IF        @EQUAL
            PACK      FILTOCGR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftocgr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTOCGR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "receiptn=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,RECEIPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrkfiln=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTRKFILN
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "ptdsvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTDSVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERVDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sdoccode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SDOCCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emblindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBLINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emvis094=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMVIS094
            GOTO      SETPAR99
          ENDIF
.
           MATCH     "tkbox",QRYNAME
           IF        @EQUAL
             CALL      SUNDBX00
             GOTO      SETPAR99
           ENDIF
.
          MATCH     "ebsmindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EBSMINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocharge=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCHARGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmmtibat=",QRYNAME
          IF        @EQUAL
            PACK      TMMTIBAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmmti",QRYNAME
          IF        @EQUAL
            CALL      STTMT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trannumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptipe001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTIPE001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptipe002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTIPE002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmjrnbat=",QRYNAME
          IF        @EQUAL
            PACK      TMJRNBAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmjrn",QRYNAME
          IF        @EQUAL
            CALL      STJRN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptipr",QRYNAME     *  this is for selection list
          IF        @EQUAL
            CALL      SPTIPR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTRGM001
            PACK      PTRGM001,PTRGM001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rebareas=",QRYNAME
          IF        @EQUAL
            PACK      REBAREAS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "drbilchr=",QRYNAME
          IF        @EQUAL
            PACK      DRBILCHR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hx13indc=",QRYNAME
          IF        @EQUAL
            PACK      HX13INDC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docchgin=",QRYNAME
          IF        @EQUAL
            PACK      DOCCHGIN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pritemin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRITEMIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invpdval=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVPDVAL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            REP      "+ ",CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "teamnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEAMNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crkey",QRYNAME
          IF        @EQUAL
            CALL      SCRKY000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crqua",QRYNAME
          IF        @EQUAL
            CALL      SCRQA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crchr",QRYNAME
          IF        @EQUAL
            CALL      SCRCH000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "revrecpt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REVRECPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsupty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSUPTY
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN        
+
.------------------------------------------------------------
. Set up Take up outstanding debts
.------------------------------------------------------------
STOD0000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STOD0010,STOD0020,STOD0030,STOD0040,STOD0050:
                       STOD0060,STOD0070,STOD0080,STOD0090,STOD0100:
                       STOD0110,STOD0120,STOD0130
          GOTO      STOD9999
.
STOD0010  MOVE      QRYDATA,OSDBT001
          GOTO      STOD9999
.
STOD0020  MOVE      QRYDATA,OSDBT002
          GOTO      STOD9999
.
STOD0030  MOVE      QRYDATA,OSDBT003
          GOTO      STOD9999
.
STOD0040  MOVE      QRYDATA,OSDBT004
          GOTO      STOD9999
.
STOD0050  MOVE      QRYDATA,OSDBT005
          GOTO      STOD9999
.
STOD0060  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      OSDBT006,CCENT,CYEAR,CMON,CDAY
          REP       " 0",OSDBT006
          GOTO      STOD9999
.
STOD0070  MOVE      QRYDATA,OSDBT007
          GOTO      STOD9999
.
STOD0080  MOVE      QRYDATA,OSDBT008
          GOTO      STOD9999
.
STOD0090  MOVE      QRYDATA,OSDBT009
          GOTO      STOD9999
.
STOD0100  MOVE      QRYDATA,OSDBT010
          GOTO      STOD9999
.
STOD0110  MOVE      QRYDATA,OSDBT011
          GOTO      STOD9999
.
STOD0120  MOVE      QRYDATA,OSDBT012
          GOTO      STOD9999
.
STOD0130  MOVE      QRYDATA,OSDBT013
          GOTO      STOD9999
.
STOD9999  RETURN
+
.------------------------------------------------------------
. Set parameters for item date
.------------------------------------------------------------
STMDAT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
.
          MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
            PACK      MDATE[F3],KEY8,SP70
            PACK      MDATE000,KEY8,SP70
          ELSE
            MOVE      QRYDATA,MDATE[F3]
            MOVE      QRYDATA,MDATE000
          ENDIF
STMDAT99  RETURN
.
.------------------------------------------------------------
. Set parameters for item code
.------------------------------------------------------------
STITMN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITMN99 IF EQUAL
          PACK      ITEMN[F3],QRYDATA,SP70
          PACK      ITEMN000,QRYDATA,SP70
          MOVE      F3,LASTITEM
STITMN99  RETURN
.
.------------------------------------------------------------
. Set parameters for sub item code
.------------------------------------------------------------
SUBITM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SUBITM99 IF EQUAL
          PACK      SUBIT[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
SUBITM99  RETURN
.
.------------------------------------------------------------
. Set parameters for Transaction Number
.------------------------------------------------------------
STTRNO00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STTRNO99 IF EQUAL
          PACK      TRNNO[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
STTRNO99  RETURN
.
.------------------------------------------------------------
. Set parameters for Cash transfer
.------------------------------------------------------------
STCSTR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCSTR99 IF EQUAL
          PACK      CSTRN[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
STCSTR99  RETURN
.
.------------------------------------------------------------
. Set parameters for Invoice Number
.------------------------------------------------------------
STIVTR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STIVTR99 IF EQUAL
          PACK      IVTRN[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
STIVTR99  RETURN
.
.------------------------------------------------------------
. Set parameters for Invoice Number
.------------------------------------------------------------
STPYAM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPYAM99 IF EQUAL
          MOVE      QRYDATA,PYAMT[F3]
STPYAM99  RETURN
.
.------------------------------------------------------------
. Set parameters for GST Applicable
.------------------------------------------------------------
STGSTA00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STGSTA99 IF EQUAL
          MOVE      QRYDATA,GSTAP[F3]
STGSTA99  RETURN
.------------------------------------------------------------
. Set parameters for GST Code
.------------------------------------------------------------
STGSTC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STGSTC99 IF EQUAL
          PACK      GSTCD[F3],QRYDATA,SP70
STGSTC99  RETURN
.------------------------------------------------------------
. Set parameters for item description
.------------------------------------------------------------
STITDS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITDS99 IF EQUAL
          PACK      DESCP[F3],QRYDATA,SP70
STITDS99  RETURN
.------------------------------------------------------------
. Set parameters for NZ private item description
.------------------------------------------------------------
STNZDS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STNZDS99 IF EQUAL
          PACK      NZDES[F3],QRYDATA,SP70
STNZDS99  RETURN
.------------------------------------------------------------
. Set parameters for item Reference
.------------------------------------------------------------
STREFN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STREFN99 IF EQUAL
          PACK      REFNC[F3],QRYDATA,SP70
STREFN99  RETURN
.------------------------------------------------------------
. Set parameters for item Session
.------------------------------------------------------------
STSESN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STSESN99 IF EQUAL
          PACK      SESSN[F3],QRYDATA,SP70
STSESN99  RETURN
.------------------------------------------------------------
. Set parameters for unique counter from nzpspraf
.------------------------------------------------------------
UNIQU000  MOVE      ZERO,EXIT
          MOVE      ZERO,F3
          MOVE      ZERO,FORM3
          UNPACK    QRYNAME,KEY5,KEY3
          TYPE      KEY3
          GOTO      UNIQU999 IF NOT EQUAL
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      UNIQU999 IF EQUAL
          PACK      DIM3,QRYDATA,SP70
          SQUEEZE   DIM3
          MOVE      DIM3,FORM3
          PACK      UNIQU[F3],FORM3,SP70
          PACK      UNIQU000,FORM3,SP70
UNIQU999  RETURN
.
.------------------------------------------------------------
. Set parameters for pack item unique counter from nzpmxcaf
.------------------------------------------------------------
PUNIQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      PUNIQ999 IF EQUAL
          PACK      PUNIQ[F3],QRYDATA,SP70
PUNIQ999  RETURN
+
.------------------------------------------------------------
. Set parameters for inclusion type
.------------------------------------------------------------
INCTYP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      INCTYP99 IF EQUAL
          PACK      INCTY[F3],QRYDATA,SP70
          PACK      INCTY000,QRYDATA
INCTYP99  RETURN
.------------------------------------------------------------
. Set parameters for item Start time
.------------------------------------------------------------
STRTIM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STRTIM99 IF EQUAL
          PACK      STTIM[F3],QRYDATA,SP70
STRTIM99  RETURN
.------------------------------------------------------------
. Set parameters for item End Time
.------------------------------------------------------------
ENDTIM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      ENDTIM99 IF EQUAL
          PACK      ENTIM[F3],QRYDATA,SP70
ENDTIM99  RETURN
.------------------------------------------------------------
. Set parameters for the effective date of changing adm type 
.------------------------------------------------------------
EFFDAT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
.
          MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
            PACK      EFDAT[F3],KEY8,SP70
          ELSE
            MOVE      QRYDATA,EFDAT[F3]
          ENDIF
EFFDAT99  RETURN
.------------------------------------------------------------
. Set parameters for item amount
.------------------------------------------------------------
STAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STAMNT99 IF EQUAL
          MOVE      QRYDATA,CAMNT[F3]
STAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item amount patient portion
.------------------------------------------------------------
PTAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      PTAMNT99 IF EQUAL
          MOVE      QRYDATA,PATPR[F3]
PTAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item amount rebate portion
.------------------------------------------------------------
RBAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      RBAMNT99 IF EQUAL
          MOVE      QRYDATA,REBPR[F3]
RBAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item quantity
.------------------------------------------------------------
STQUNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STQUNT99 IF EQUAL
          MOVE      QRYDATA,QUNTY[F3]
STQUNT99  RETURN
+
.-----------  Eclipse Bulk billing                             *T0859743-start
.------------------------------------------------------------
. Set parameters for item duration
.------------------------------------------------------------
STDRAT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDRAT99 IF EQUAL
            PACK      DURAT[F3],QRYDATA,SP70
          ENDIF
STDRAT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item a/c override indicator
.------------------------------------------------------------
STACOV00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STACOV99 IF EQUAL
            PACK      ACOVR[F3],QRYDATA,SP70
          ENDIF
STACOV99  RETURN
+
.------------------------------------------------------------
. Set parameters for multiple procedure override
.------------------------------------------------------------
STMULP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STMULP99 IF EQUAL
            PACK      MULPR[F3],QRYDATA,SP70
          ENDIF
STMULP99  RETURN
+
.------------------------------------------------------------
. Set parameters for duplicate service override
.------------------------------------------------------------
STDUPS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDUPS99 IF EQUAL
            PACK      DUPSR[F3],QRYDATA,SP70
          ENDIF
STDUPS99  RETURN
+
.------------------------------------------------------------
. Set parameters for service text
.------------------------------------------------------------
STSRVT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STSRVT99 IF EQUAL
            PACK      SRVTX[F3],QRYDATA,SP70
          ENDIF
STSRVT99  RETURN
+
.------------------------------------------------------------
. Set parameters for Hospital indicator
.------------------------------------------------------------
STHOSI00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STHOSI99 IF EQUAL
            PACK      HOSIN[F3],QRYDATA,SP70
          ENDIF
STHOSI99  RETURN
+
.------------------------------------------------------------
. Set parameters for number of patients
.------------------------------------------------------------
STNUMP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STNUMP99 IF EQUAL
            PACK      NUMPT[F3],QRYDATA,SP70
          ENDIF
STNUMP99  RETURN
+
.------------------------------------------------------------
. Set parameters for location specific practice number
.------------------------------------------------------------
STLSPN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STLSPN99 IF EQUAL
            PACK      LSPNV[F3],QRYDATA,SP70
          ENDIF
STLSPN99  RETURN
+
.------------------------------------------------------------
. Set parameters for rovc - Restrictive override
.------------------------------------------------------------
STROVC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STROVC99 IF EQUAL
            PACK      ROVRC[F3],QRYDATA,SP70
          ENDIF
STROVC99  RETURN
+
.------------------------------------------------------------
. Set parameters for self deemed
.------------------------------------------------------------
STSLDM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STSLDM99 IF EQUAL
            PACK      SLDMC[F3],QRYDATA,SP70
          ENDIF
STSLDM99  RETURN
+
.------------------------------------------------------------ *T0859743-end
.
.------------------------------------------------------------
. Set parameters for attending doctor
.------------------------------------------------------------
STDCTN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDCTN99 IF EQUAL
          PACK      DOCTN[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
STDCTN99  RETURN
+
.------------------------------------------------------------
. Set parameters for Item type
.------------------------------------------------------------
STITYP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITYP99 IF EQUAL
          PACK      ITYPE[F3],QRYDATA,SP70
STITYP99  RETURN
+
.------------------------------------------------------------
. Set parameters for Procedure code
.------------------------------------------------------------
STPROC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPROC99 IF EQUAL
          PACK      PROCI[F3],QRYDATA,SP70
STPROC99  RETURN
+
.------------------------------------------------------------
. Set parameters for sub item code
.------------------------------------------------------------
STSITM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STSITM99 IF EQUAL
          PACK      SITEM[F3],QRYDATA,SP70
STSITM99  RETURN
+
.------------------------------------------------------------
. Set parameters for receipt number
.------------------------------------------------------------
STRECP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STRECP99 IF EQUAL
          PACK      RECPN[F3],QRYDATA,SP70
STRECP99  RETURN
.
.------------------------------------------------------------
. Set parameters for Schedule fee
.------------------------------------------------------------
STSCHD00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STSCHD99 IF EQUAL
          MOVE      QRYDATA,SCHDF[F3]
STSCHD99  RETURN
+
.------------------------------------------------------------
. Set parameters for procedure quantity
.------------------------------------------------------------
STPQUA00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPQUA99 IF EQUAL
          MOVE      QRYDATA,PQUAN[F3]
STPQUA99  RETURN
+
.------------------------------------------------------------
. Set parameters for procedure amount
.------------------------------------------------------------
STPAMT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPAMT99 IF EQUAL
          MOVE      QRYDATA,PAMNT[F3]
STPAMT99  RETURN
+
.------------------------------------------------------------
. GETBCM00 - Get billing comments
.------------------------------------------------------------
GETBCM00  
          PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETBCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETBCM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETBCM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETBCM10
.
GETBCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETBCM90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
GETBCM99  RETURN
+
.------------------------------------------------------------
. GETPMH00 - Get patient medical history
.------------------------------------------------------------
GETPMH00  PREP      PMHFILAF,PMHFILNM
.
          MOVE      ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
.
GETPMH10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPMH90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPMH80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
          GOTO      GETPMH10
.
GETPMH80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPMH90  MOVE      F3,LASTITEM
          OPEN      PMHFILAF,PMHFILNM
GETPMH99  RETURN
+
.------------------------------------------------------------
. GETWDI00 - Get working diagnosis
.------------------------------------------------------------
GETWDI00  PREP      WDIFILAF,WDIFILNM
          MOVE      ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
.
GETWDI10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWDI90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWDI80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
          GOTO      GETWDI10
.
GETWDI80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWDI90  MOVE      F3,LASTITM2
          OPEN      WDIFILAF,WDIFILNM
GETWDI99  RETURN
+
.------------------------------------------------------------
. GETCLN00 - Get clinical notes
.------------------------------------------------------------
GETCLN00  PREP      CLNFILAF,CLNFILNM
          MOVE      ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
.
GETCLN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCLN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCLN80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
          GOTO      GETCLN10
.
GETCLN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCLN90  MOVE      F3,LASTITM3
          OPEN      CLNFILAF,CLNFILNM
GETCLN99  RETURN
+
.------------------------------------------------------------
. GETICM00 - Get Invoice comments
.------------------------------------------------------------
GETICM00  PREP      ICMFILAF,ICMFILNM
.
          MOVE      ONE,F3
          WRITE     ICMFILAF,SEQ;QRYDATA
.
GETICM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETICM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETICM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     ICMFILAF,SEQ;QRYDATA
          GOTO      GETICM10
.
GETICM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETICM90  MOVE      F3,LASTITEM
          OPEN      ICMFILAF,ICMFILNM
GETICM99  RETURN
+
.------------------------------------------------------------
. Set parameters for ED Sundry charges tick box
.------------------------------------------------------------
SUNDBX00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SUNDBX99 IF EQUAL
          PACK      TKBOX[F3],QRYDATA,SP70
SUNDBX99  RETURN
+
.------------------------------------------------------------
. Patient Regimes
.------------------------------------------------------------
RGMP0000
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,RGMP9200
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      RGMP8000 IF EQUAL
.
          MATCH     "A",UPDATETY
          GOTO      RGMP1000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      RGMP2000 IF EQUAL        * Delete
.
          GOTO      RGMP9000
.
.         Add Regime
.
RGMP1000  MOVE      " 1",PTRGCNTR
          PACK      KEY20,ADMISSNO,PTRGM001,PTRGCNTR,SP70
          CALL      RDPTRGM2
          COMPARE   ZERO,OVRCD
          GOTO      RGMP9100 IF EQUAL
.
          MOVE      ADMISSNO,PTRGADMN
          MOVE      PTRGM001,PTRGREGM
          MOVE      " 1",PTRGCNTR
          MOVE      USERID,PTRGCUID
          CALL      IBACLOCK
          PACK      PTRGCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTRGCDAT
          MOVE      CTIMEIS,PTRGCTIM
          MOVE      SP70,PTRGSPAR
          CALL      WRPTRGM2
.
          CALL      AREG0000              * Add items of the Regime
.
          GOTO      RGMP9800
.
.         Delete Regime
.
RGMP2000
          MOVE      " 1",PTRGCNTR
          PACK      KEY20,ADMISSNO,PTRGM001,PTRGCNTR,SP70
          CALL      RDPTRGM2
          BRANCH    OVRCD,RGMP9300
.
.         Delete all payers for the Regime
.
          CALL      DEPTRGM2
.
          CALL      DBRK0000             * Delete all payers breakdown
          CALL      DIDE0000             * Delete invoiced payer details
          CALL      DITM0000             * Delete pending items
.
          GOTO      RGMP9800
.
RGMP8000  PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
          CALL      RKPTRGM1
          IF        OVRCD=0
            MATCH     ADMISSNO,PTRGADMN
            IF        @EQUAL
              MOVE      "  0",PMREUNIQ
              PACK      KEY13,PTRGREGM,PMREUNIQ,SP70
              CALL      RDPMREG1
              IF        OVRCD=1
                MOVE       SP70,PMREREGM
                MOVE       SP70,PMREDESC
              ENDIF
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Community Billing Template",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,RGMP9999
.
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      RGMP9999
.
RGMP9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RGMP9999
.
RGMP9100  MOVE      "Billing Template has already been added.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RGMP9999
.
RGMP9200  MOVE      "Can't find Patient Master details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RGMP9999
.
RGMP9300  MOVE      "Record doesn't exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RGMP9999
.
RGMP9800  MOVE      ZERO,EXIT
RGMP9999  RETURN
+
.-----------------------------------------------------------------------
.  Automaticaly add items of the Regime for Independent Service Billing
.-----------------------------------------------------------------------
AREG0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREG9999
.
          PACK      KEY8,ADMISSNO,SP70   * is theatre complete
          CALL      RDMISS1
          BRANCH    OVRCD,AREG9999
          CALL      RDPMVX11
          BRANCH    OVRCD,AREG9999
.
.         Write all items of Regime with correct quantity
.
          MOVE      ALACDTE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD  * Default to current date
          REP       " 0",TODATE
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,AREG9999
            MOVE      DDATE,TODATE
          ENDIF
          MOVE      ZERO,NBRDAYS
          DAYSEP    FROMDATE,TODATE,NBRDAYS * LOS include leaves
          COMPARE   ZERO,NBRDAYS
          GOTO      AREG9999 IF EQUAL
.
          CALL      DCLM0000              * get default claim code
.
          PACK      KEY13,PTRGM001,SP70
          CALL      RSPMREG1
AREG2000  CALL      RKPMREG1
          BRANCH    OVRCD,AREG8000
.
          MATCH     PTRGM001,PMREREGM
          GOTO      AREG8000 IF NOT EQUAL      * different regime
          MATCH     "1",PMREITYP
          GOTO      AREG2000 IF NOT EQUAL
.
          CALL      AITM0000                   * Add item
.
          GOTO      AREG2000                   * next item
.
AREG8000  MOVE      ZERO,EXIT
          GOTO      AREG9999
.
AREG9999  RETURN
+
.------------------------------------------------------------
.         Add item with quantity equals to curent LOS
.------------------------------------------------------------
AITM0000  MOVE      ZERO,EXIT
.
          MOVE      ALACDTE,PMMITDAT
          REP       " 0",PMMITDAT
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMREITMN,PMMIITEM
          MOVE      PMMIITEM,MCHARGE
          CALL      GETMSC00            * Get the new misc. charge
          BRANCH    EXIT,AITM9999
.
          MOVE      ADMISSNO,KEY8
AITM4000  CALL      TRVISA1               * Get the next transaction number
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      AITM4000 IF EQUAL
.
          MOVE      ADMISSNO,PMMIVISN
          MOVE      URNUMBER,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      THREE,PMMIRTYP
          MOVE      NBRDAYS,PMMISERV
.
          MOVE      ZERO,PMMIGSTM
          UNPACK    SP70,PMMIDESC,PMMIDES2
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
.
          MOVE      PTMCGSTA,PMMIGSTA
          MOVE      PTMCGSTC,PMMIGSTC
          MOVE      MDESC,PMMIDESC
          MOVE      MITMTYP,PMMIRTYP
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MPATPOR,PMMIAMTP
          MOVE      MHFPOR,PMMIRBAT
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
          MOVE      ONE,PMMIINVN
.
          UNPACK    SP70,PMMIBTCH,PMMIMVBR,PMMIUNIQ,PMMICNTR,PMMISUNQ:
                         PMMITDOC,PMMIODOC
          UNPACK    SP70,PMMIINCT,PMMISUBN,PMMIEDAD,PMMISVTM,PMMICCON
          UNPACK    SP70,PMMIITYP,PMMIREFN,PMMISESS
          MOVE      "1",PMMIINCT          * flag Item from Regime
.
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          CALL      IBACLOCK
          MOVE      USERID,PMMIWUSR        * WEB user id
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR        * User id
          MOVE      CTIMEIS,PMMISVTM
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      WRPMMTI1
.
          MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          MOVE      PVITRAN,ATRANNO      * next transaction number
          PACK      PTMIWEBU,USERID,SP70
          CALL      UPLMISS1
.
AITM9999  RETURN
+
.------------------------------------------------------------
.         Delete existing records for the regime
.------------------------------------------------------------
DBRK0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,DBRK9999
.
DBRK1000  PACK      KEY22,ADMISSNO,SP70
          CALL      RSPMPBR1
          CALL      RKPMPBR1
          BRANCH    OVRCD,DBRK9999
.
          MATCH     PMPBADMN,ADMISSNO
          GOTO      DBRK9999 IF NOT EQUAL
.
          PACK      KEY22,PMPBADMN,PMPBCLTY,PMPBEFDT:
                          PMPBICNT,SP70
          CALL      DEPMPBR1
          GOTO      DBRK1000
.
DBRK9999  RETURN
+
.----------------------------------------------------------------------
.         Delete all invoice breakdown (only one regime for a patient)
.----------------------------------------------------------------------
DIDE0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA3,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DIDE9999
.
DIDE1000  PACK      KEY34,ADMISSNO,SP70
          CALL      RSPMIDE3
          CALL      RKPMIDE3
          BRANCH    OVRCD,DIDE9999
.
          MATCH     ADMISSNO,PMIDADMN
          GOTO      DIDE9999 IF NOT EQUAL
          MATCH     SP70,PMIDINVN                  * not invoiced yet
          GOTO      DIDE9999 IF NOT EQUAL
.
          PACK      KEY34,PMIDADMN,PMIDINVN,PMIDRTYP,PMIDFDAT:
                          PMIDCLTY,PMIDTRNO,SP70
          CALL      DEPMIDE3
          GOTO      DIDE1000
.
DIDE9999  RETURN
+
.------------------------------------------------------------
. Delete pending items for all Community Billing
.------------------------------------------------------------
DITM0000  MOVE      "3",KEY1                 * Misc.item
          PACK      KEY15,ADMISSNO,KEY1,SP70
DITM2000  CALL      RSPMMTI2
DITM4000  CALL      RKPMMTI2
          BRANCH    OVRCD,DITM9999
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      DITM9999 IF NOT EQUAL
          MATCH     KEY1,PMMIRTYP
          GOTO      DITM9999 IF NOT EQUAL    * Not a Misc.item
.
          MATCH     "1",PMMIINCT
          GOTO      DITM4000 IF NOT EQUAL
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
.
          GOTO      DITM2000
.
DITM9999  RETURN
+
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40,PROFLD99:
                             PROFLD60,PROFLD30,PROFLD80,PROFLD99,PROFLD99:
                             PROFLD99,PROFLD90,PROFLD99,PROFLD99,PROFLD99:
                             PROFL160,PROFL170,PROFL180,PROFL190,PROFLD99:
                             PROFL210
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      DSFD0000             * display fields
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      FACT0000
          GOTO      PROFLD99
.
PROFLD40  CALL      FUTR0000 
          GOTO      PROFLD99
.
. Refund Deposits
.------------------------------
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000                * Patient Header file
          GOTO      PROFLD99 
.
PROFLD62  CALL      RDEP0000                * Refund deposits
          GOTO      PROFLD99 
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81
          GOTO      PROFLD99
.
PROFLD81  CALL      TUOD0000               
          GOTO      PROFLD99 
.
PROFLD90  CALL      PRTR0000 
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162
          GOTO      PROFLD99
.
PROFL161  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL162  CALL      PTIP0000
          GOTO      PROFLD99
.
PROFL170  BRANCH    FLDSETNO,PROFL171,PROFL172
          GOTO      PROFLD99
.
PROFL171  CALL      BKMC0000
          GOTO      PROFLD99
.
PROFL172  CALL      BMCT0000
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181
          GOTO      PROFLD99
.
PROFL181  CALL      TMJR0000                     * Bulk journal tags
          GOTO      PROFLD99
.
PROFL190  BRANCH    FLDSETNO,PROFL191,PROFL192,PROFL193
          GOTO      PROFLD99
.
PROFL191  CALL      MASF0000                * Patient Header file
          GOTO      PROFLD99
.
PROFL192  CALL      DIPR0000               * JH Insurance Provider
          GOTO      PROFLD99
.
PROFL193  CALL      INSP0000
          GOTO      PROFLD99
.
PROFL210  BRANCH  FLDSETNO,PROFL211,PROFL212
          GOTO    PROFLD99
.
PROFL211  CALL    MASF0000    * Master File Info
          GOTO    PROFLD99
.
PROFL212  CALL    FRGM0000    * Patient Regimes
          GOTO    PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. Patient Regimes
.------------------------------------------------------------
FRGM0000  BRANCH    FLDITMNO,FRGM0100,FRGM0200,FRGM0300,FRGM0400
          GOTO      FRGM9999
.
FRGM0100  CALL      LRGM0000          * List of Patient Regimes
          GOTO      FRGM9999
.
FRGM0200  CALL      CRGM0000          * Check for Patient Regimes record
          GOTO      FRGM9999
.
FRGM0300  WRITE     HTMLFILE;PMREREGM;
          GOTO      FRGM9999
.
FRGM0400  WRITE     HTMLFILE;PMREDESC;
          GOTO      FRGM9999
.
FRGM9999  RETURN
+
.----------------------------------------------------------------
. Check if Patient payer setup for Independence Services Billing
.----------------------------------------------------------------
CRGM0000  MOVE      ZERO,F1
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,CRGM7000
.
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMPYR1
          CALL      RKPMPYR1
          BRANCH    OVRCD,CRGM7000
.
          MATCH     URNUMBER,PMPYURNO
          GOTO      CRGM7000 IF NOT EQUAL   * payer not setup yet
.
.         If Regime has already been entered, Add Billing will not be available
.
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
          CALL      RKPTRGM1
          BRANCH    OVRCD,CRGM8000
.
          MATCH     ADMISSNO,PTRGADMN
          GOTO      CRGM8000 IF NOT EQUAL
.
CRGM7000  MOVE      ONE,F1             * Add Billing disabled
.
CRGM8000  WRITE     HTMLFILE;F1;
CRGM9999  RETURN
+
.------------------------------------------------------------
. List of Patient Regimes
.------------------------------------------------------------
LRGM0000  PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
LRGM1000  CALL      RKPTRGM1
          BRANCH    OVRCD,LRGM9999
.
          MATCH     ADMISSNO,PTRGADMN
          GOTO      LRGM9999 IF NOT EQUAL
.
          MOVE      PTRGREGM,PMREREGM
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,LRGM9999
.
          CLEAR     HTMLLINK
          APPEND    "javascript:RegimeCode('",HTMLLINK
          APPEND    PTRGADMN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTRGREGM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PMREREGM,"#",":
                             "#"",PMREDESC,"#")"
          GOTO      LRGM1000
.
LRGM9999  RETURN
+
.------------------------------------------------------------
.    Take up outstanding debts
.------------------------------------------------------------
TUOD0000  PACK      CURRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CURRDATE
.
          BRANCH    FLDITMNO,TUOD0100,TUOD0200,TUOD0300,TUOD0400
          GOTO      TUOD9999
.
.        Display Miscellaneous Debt
.
TUOD0100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,TUOD0110    
.
          MATCH     SP70,OSDBT001
          GOTO      TUOD9999 IF EQUAL
          WRITE     HTMLFILE;OSDBT001;
          GOTO      TUOD9999
.
TUOD0110  IF        IBCNMHOS=1
            MOVE      SP10,KEY3
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,TUOD9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OSDBT001,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,OSDBT001,CURRDATE,SP10
          ENDIF
.                                           * Read Misc. Charges file
TUOD0112  CALL      PATMCHRD                * find Miscellaneous Charge Item
          COMPARE   ZERO,EXIT
          GOTO      TUOD0115 IF EQUAL       * found a valid item
.
TUOD0114  IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,TUOD9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OSDBT001,CURRDATE,SP10
            GOTO      TUOD0112 
          ENDIF
          GOTO      TUOD9999 
.
TUOD0115  WRITE     HTMLFILE;MDESC;
          GOTO      TUOD9999
.
.        Display Miscellaneous H.F. Debt
.
TUOD0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,TUOD0210
.
          MATCH     SP70,OSDBT002
          GOTO      TUOD9999 IF EQUAL
          WRITE     HTMLFILE;OSDBT002;
          GOTO      TUOD9999
.
TUOD0210  IF        IBCNMHOS=1
            MOVE      SP10,KEY3
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,TUOD9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OSDBT002,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,OSDBT002,CURRDATE,SP10
          ENDIF
.                                           * Read Misc. Charges file
TUOD0212  CALL      PATMCHRD                * find Miscellaneous Charge Item
          COMPARE   ZERO,EXIT
          GOTO      TUOD0215 IF EQUAL       * found a valid item
.
TUOD0214  IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,TUOD9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OSDBT002,CURRDATE,SP10
            GOTO      TUOD0212 
          ENDIF
.
TUOD0215  WRITE     HTMLFILE;MDESC;
          GOTO      TUOD9999
.
TUOD0300  WRITE     HTMLFILE;IBCNMHOS;
          GOTO      TUOD9999
.
TUOD0400  COMPARE   ONE,IBCNMHOS
          GOTO      TUOD9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=DataLabel>Hospital ID</td>":
                             "<td><select name=osdbt010 title='Hospital ID' ":
                             "class=Mandatory onchange=setHospital();>":
                             "<option value='   '></option>"
          MOVE      SP10,DIM3
          CALL      HSEL0000
          WRITE     HTMLFILE;"</select></td></tr>";
          GOTO      TUOD9999                           
.
TUOD9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     DIM3,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
+
.------------------------------------------------------------
. Item GST fields
.------------------------------------------------------------
DSFD0000  BRANCH    FLDITMNO,DSFD0100,DSFD0200,DSFD0300,DSFD0400,DSFD0500:
                             DSFD0600,DSFD0700,DSFD0800,DSFD0900,DSFD1000:
                             DSFD1100,DSFD1200,DSFD1300,DSFD1400,DSFD1500:
                             DSFD1600,DSFD1700,DSFD1800,DSFD1900,DSFD2000:
                             DSFD2100,DSFD2200,DSFD2300,DSFD2400,DSFD2500:
                             DSFD2600,DSFD2700,DSFD2800,DSFD2900,DSFD3000:
                             DSFD3100,DSFD3200,DSFD3300,DSFD3400,DSFD3500:
                             DSFD3600,DSFD3700,DSFD3800,DSFD3900,DSFD4000:
                             DSFD4100,DSFD4200,DSFD4300,DSFD4400,DSFD4500
          GOTO      DSFD9999
.
DSFD0100  CALL      GSTA0000                 * GST applicable
          GOTO      DSFD9999
.
DSFD0200  CALL      KYGC0000                 * GST code
          GOTO      DSFD9999
.
DSFD0300  CALL      KYPP0000                 * Patient portion
          GOTO      DSFD9999
.
DSFD0400  CALL      KYHP0000                 * Health fund portion
          GOTO      DSFD9999
.
DSFD0500  CALL      CTHE0000                 * MBS item previously entered?
          GOTO      DSFD9999
.
DSFD0600  CALL      SUBI0000                 * Change subsequence primary MBS
          GOTO      DSFD9999
.
DSFD0700  CALL      ADMN0000                 * Admission number
          GOTO      DSFD9999
.
DSFD0800  CALL      ADAT0000                 * Admission date
          GOTO      DSFD9999
.
DSFD0900  CALL      DDAT0000                 * Discharged date
          GOTO      DSFD9999
.
DSFD1000  RESET     EFFADATE
          MATCH     SP70,EFFADATE
          IF        !@EQUAL
            WRITE     HTMLFILE;EFFADATE;
          ELSE
            PACK       KEY8,CCC,CYY,CMM,CDD
            REP        " 0",KEY8
            UNPACK     KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE       CMON,F2
            LOAD       MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                                  DEC
            WRITE      HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      DSFD9999
.
DSFD1100  WRITE     HTMLFILE;PVITYPE;
          GOTO      DSFD9999
.
DSFD1200  PACK      MDATE000,MDATE000,SP70
          MATCH     SP70,MDATE000
          GOTO      DSFD1205 IF EQUAL
.
          REP       " 0",MDATE000
          UNPACK    MDATE000,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSFD9999
.
DSFD1205  MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY    * default to current date
          MOVE      ADMISSNO,KEY8
.
          COMPARE   NINE,PVITYPE
          GOTO      DSFD1210 IF NOT EQUAL
          MATCH     " 1",PVISYST             * check for Emergency event
          GOTO      DSFD1210 IF NOT EQUAL
.
          CALL      RDPMEVT1
          IF        OVRCD=0
            MOVE      PMEVADTE,DIM8
          ENDIF
          GOTO      DSFD1260
.
DSFD1210  COMPARE   ONE,PVITYPE
          GOTO      DSFD1220 IF NOT EQUAL
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,DIM8           * emergency visit
          ENDIF
          GOTO      DSFD1260
.
DSFD1220  COMPARE   TWO,PVITYPE
          GOTO      DSFD1240 IF NOT EQUAL
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      OBADATE,DIM8            * outpatient visit
          ENDIF
          GOTO      DSFD1260
.
DSFD1240  COMPARE   THREE,PVITYPE
          GOTO      DSFD1260 IF NOT EQUAL
          COMPARE   THREE,ASTAT
          GOTO      DSFD1260 IF NOT EQUAL
.
          MOVE      SP70,DDATE
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      DDATE,DIM8                    * Set date to disc.date
.
DSFD1260  REP       " 0",DIM8
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSFD9999
.
DSFD1300  WRITE     HTMLFILE;PMVXMHOS;
          GOTO      DSFD9999
.
DSFD1400  PACK      PROCE000,PROCE000,SP70
          MATCH     SP70,PROCE000
          GOTO      DSFD1420 IF EQUAL
.
          WRITE     HTMLFILE;PROCE000;
          GOTO      DSFD9999
.
DSFD1420  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPPROC;
          GOTO      DSFD9999
.
DSFD1500  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPUNIQ;
          GOTO      DSFD9999
.
DSFD1600  CALL      ITMHD000              * Display Input item header
          GOTO      DSFD9999
.
DSFD1700  CALL      EMDOC000              * Emergency doctor from history file
          GOTO      DSFD9999
.
DSFD1800  WRITE     HTMLFILE;ACLAIM;
          GOTO      DSFD9999
.
DSFD1900  WRITE     HTMLFILE;AFUNDH;
          GOTO      DSFD9999
.
DSFD2000  WRITE     HTMLFILE;AFNDTB;
          GOTO      DSFD9999
.
DSFD2100  WRITE     HTMLFILE;SERVDOCT;
          GOTO      DSFD9999
.
DSFD2200  WRITE     HTMLFILE;INVOICEN;
          GOTO      DSFD9999
.
DSFD2300  CALL      EITM0000              * Display existing items
          GOTO      DSFD9999
.
DSFD2400  WRITE     HTMLFILE;TRANSNUM;
          GOTO      DSFD9999
.
DSFD2500  CALL      NZLS0000          * procedure list
          GOTO      DSFD9999
.
DSFD2600  MOVE      ZERO,BITMFLAG     * Flag for Delete Bulk Item
          CALL      NZIP0000          * Items list for a procedure
          GOTO      DSFD9999
.
DSFD2700  MATCH     SP70,PROCEDFR
          IF        @EQUAL
            CALL      GETNZP00
            WRITE     HTMLFILE;NZSPPROC;
          ELSE
            WRITE     HTMLFILE;PROCEDFR;
          ENDIF
          GOTO      DSFD9999
.
DSFD2800  MATCH     SP70,PROCEDTO
          IF        !@EQUAL
            WRITE     HTMLFILE;PROCEDTO;
          ENDIF
          GOTO      DSFD9999
.
DSFD2900  MATCH     SP70,UNIQNUMB
          IF        @EQUAL
            CALL      GETNZP00
            WRITE     HTMLFILE;NZSPUNIQ;
          ELSE
            WRITE     HTMLFILE;UNIQNUMB;
          ENDIF
          GOTO      DSFD9999
.
DSFD3000  WRITE     HTMLFILE;UNIQNOTO;
          GOTO      DSFD9999
.
DSFD3100  WRITE     HTMLFILE;INCTY000;
          GOTO      DSFD9999
.
DSFD3200  WRITE     HTMLFILE;ITEMN000;
          GOTO      DSFD9999
.
DSFD3300  PACK      UNIQU000,UNIQU000,SP70
          MATCH     SP70,UNIQU000
          GOTO      DSFD3320 IF EQUAL
.
          WRITE     HTMLFILE;UNIQU000;
          GOTO      DSFD9999
.
DSFD3320  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPUNIQ;
          GOTO      DSFD9999
.
DSFD3400  MATCH     SP70,CNTRTYFR
          IF        @EQUAL
            CALL      GETNZP00
            WRITE     HTMLFILE;NZSPCLMN;
          ELSE
            WRITE     HTMLFILE;CNTRTYFR;
          ENDIF
          GOTO      DSFD9999
.
DSFD3500  MATCH     SP70,CNTRTYTO
          IF        !@EQUAL
            WRITE     HTMLFILE;CNTRTYTO;
          ENDIF
          GOTO      DSFD9999
.                                                                   
DSFD3600  COMPARE   TWO,PVITYPE             * Outpatient visit type
          GOTO      DSFD9999 IF NOT EQUAL
.
          MOVE      "out",OSTFILE                              
          MOVE      PVISITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PVIBILL,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,DSFD9999
.
          MOVE      "CL",CATEGORY             * Check Claim Type
          MOVE      OBACOMP,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSFD9999
.
          MATCH     "P",TCINDC1                * Check for Public
          GOTO      DSFD9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY             * Check Clinic Indicator
          MOVE      OTBBCIND,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSFD9999
.
          MATCH     "P",TCINDC1                * Check for Public
          GOTO      DSFD9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      DSFD9999
.
DSFD3700  MATCH     "1",PTCNUESF
          GOTO      DSFD3780 IF NOT EQUAL
.
          COMPARE   ONE,PVITYPE             * Emergency visit type
          GOTO      DSFD3780 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,DSFD3780
.
          MATCH     SP70,EMVICOMP
          GOTO      DSFD3780 IF EQUAL`
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          CALL      GETCOD00
.
          MATCH     "H",TCINDC1
          IF        @EQUAL
            GOTO      DSFD3790
          ENDIF
.
          MATCH     "J",TCINDC1
          IF        @EQUAL
            GOTO      DSFD3790
          ENDIF
.
DSFD3780  WRITE     HTMLFILE;ZERO;
.
          GOTO      DSFD9999
.
DSFD3790  WRITE     HTMLFILE;ONE;
.
          GOTO      DSFD9999
.
DSFD3800  WRITE     HTMLFILE;CASEKEYS;
          GOTO      DSFD9999
.
DSFD3900  WRITE     HTMLFILE;UNIQUEKY;
          GOTO      DSFD9999
.
DSFD4000  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      DSFD9999
.
DSFD4100  PACK      PROCDESC,PROCDESC,SP70
          MATCH     SP70,PROCDESC
          GOTO      DSFD4120 IF EQUAL
.
          WRITE     HTMLFILE;PROCDESC;
          GOTO      DSFD9999
.
DSFD4120  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPPDES;
          GOTO      DSFD9999
.
DSFD4200  MATCH     SP70,CNTRFNFR
          IF        !@EQUAL
            WRITE     HTMLFILE;CNTRFNFR;
          ENDIF
          GOTO      DSFD9999
.
DSFD4300  MATCH     SP70,CNTRFNTO
          IF        !@EQUAL
            WRITE     HTMLFILE;CNTRFNTO;
          ENDIF
          GOTO      DSFD9999
.          
DSFD4400  MOVE      ONE,BITMFLAG      * Flag for Delete Bulk Item
          CALL      NZIP0000          * Items list for a procedure
          MOVE      ZERO,BITMFLAG
          GOTO      DSFD9999
.
DSFD4500  COMPARE   TWO,PVITYPE             * Outpatient visit type
          GOTO      DSFD9999 IF NOT EQUAL
.
          MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PVIBILL,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,DSFD9999
.
          MOVE      "CL",CATEGORY             * Check Claim Type
          MOVE      OBACOMP,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSFD9999
.
          MATCH     "V",TCINDC1                * Check for Public
          GOTO      DSFD9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY             * Check Clinic Indicator
          MOVE      OTBBCIND,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSFD9999
.
          MATCH     "P",TCINDC1                * Check for Public
          GOTO      DSFD9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      DSFD9999
.
DSFD9999  RETURN
+
.******************************************************************************
.         Header for Input item screen
.******************************************************************************
ITMHD000  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,ITMHD200
.
          COMPARE   THREE,PVITYPE
          GOTO      ITMHD200 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCFFFF>":
                             "<td width=12%><b> Date </b></td>":
                             "<td width=12%><b> Inc Type </b></td>":
                             "<td width=10%><b> Procedure </b></td>":
                             "<td width=7%><b> Item </b></td>":
                             "<td width=15%><b> Description </b></td>":
                             "<td width=6%><b> Quantity </b></td>":
                             "<td width=8%><b> Reference </b></td>":
                             "<td width=11%><b> Amount </b></td></tr>"
          GOTO      ITMHD999
.
ITMHD200  WRITE     HTMLFILE;"<tr bgcolor=#CCFFFF>":
                             "<td width=11%><b> Date </b></td>":
                             "<td width=7%><b> Item </b></td>":
                             "<td width=26%><b> Description </b></td>":
                             "<td width=5%><b> Quantity </b></td>":
                             "<td width=8%><b> Reference </b></td>":
                             "<td width=5%><b> Session </b></td>":
                             "<td width=8%><b> Amount </b></td></tr>"
.
ITMHD999  RETURN
+
.******************************************************************************
.   Get doctors from history file
.******************************************************************************
.
EMDOC000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          OPEN      EMRHISA2,"emrhisaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          COMPARE   ONE,PVITYPE
          GOTO      EMDOC500 IF EQUAL
          COMPARE   NINE,PVITYPE
          GOTO      EMDOC100 IF EQUAL
.
          GOTO      EMDOC999
.
EMDOC100  MOVE      SP70,PMEVACON
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,EMDOC999
.
          MATCH     SP70,PMEVACON
          GOTO      EMDOC999 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDOC999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          BRANCH    F1,EMDOC200,EMDOC300
.
          PACK      KEY12,QUOTE,PMEVACON,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY12," selected>":
                             PACFNAME,"</option>"
.
          GOTO      EMDOC999
.
EMDOC200  REP       " 0",PMEVADTE
          UNPACK    PMEVADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EMDOC999
.
EMDOC300  WRITE     HTMLFILE;PMEVATIM;
          GOTO      EMDOC999
.
EMDOC500  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMDOC999
.
          MOVE      SP70,DIM10
.
          PACK      KEY32,ADMISSNO,Z70
          CALL      RSEMHIS2
EMDOC600  CALL      RPEMHIS2
          BRANCH    OVRCD,EMDOC999
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      EMDOC999 IF NOT EQUAL
.
          MATCH     SP70,EMHIDOC
          GOTO      EMDOC600 IF EQUAL
.
          MATCH     DIM10,EMHIDOC
          GOTO      EMDOC600 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          PACK      KEY10,EMHIDOC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDOC600
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          PACK      KEY12,QUOTE,EMHIDOC,QUOTE
          MATCH     "ALL",SERVDOCT
          GOTO      EMDOC660 IF EQUAL
          MATCH     SP70,SERVDOCT
          GOTO      EMDOC660 IF EQUAL
.
          MATCH     EMHIDOC,SERVDOCT
          GOTO      EMDOC680
.
EMDOC660  MATCH     EMHIDOC,EMVIDOCT
EMDOC680  IF        @EQUAL
            BRANCH    F1,EMDOC700,EMDOC800
.
            WRITE     HTMLFILE;"<option value=",KEY12," selected>":
                                PACFNAME,"</option>" 
          ELSE
            BRANCH    F1,EMDOC600,EMDOC600
.
            WRITE     HTMLFILE;"<option value=",KEY12,">":
                                PACFNAME,"</option>"
          ENDIF
.
          GOTO      EMDOC600
.
EMDOC700  REP       " 0",EMHIDSD
          UNPACK    EMHIDSD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EMDOC999
.
EMDOC800  UNPACK    EMHIDST,DIM2,DIM2A,DIM2B
          WRITE     HTMLFILE;DIM2,COLON,DIM2A,COLON,DIM2B;
          GOTO      EMDOC999
.
EMDOC999  RETURN
.
.EMDOC000  OPEN      EMRHISA2,"emrhisaf"
.          OPEN      PMSHCPA1,"pmshcpaf"
.          MOVE      SP70,PMEVACON
.          MOVE      PVIBILL,KEY8
.          CALL      RDPMEVT1
.          BRANCH    OVRCD,EMDOC999
.
.          MOVE      SP70,DIM10
.          MOVE      ZERO,FORM8
.          PACK      KEY32,ADMISSNO,SP70
.          CALL      RSEMHIS2
.EMDOC100  CALL      RKEMHIS2
.          BRANCH    OVRCD,EMDOC200
.          MATCH     ADMISSNO,EMHIVIS          * Same admission
.          GOTO      EMDOC200 IF NOT EQUAL
.
.          MATCH     SP70,EMHIDOC
.          GOTO      EMDOC100 IF EQUAL         * Blank doctor
.          MATCH     DIM10,EMHIDOC
.          GOTO      EMDOC100 IF EQUAL         * already been displayed
.
.          MOVE      EMHIDOC,DIM10
.          PACK      KEY10,EMHIDOC,SP70
.          CALL      RDPMHCP1
.          BRANCH    OVRCD,EMDOC100
.
.          MOVE      PMHCSNAM,PACSNAME
.          MOVE      PMHCGNAM,PACGNAME
.          MOVE      PMHCTITL,PACTITLE
.          MOVE      ONE,PACFRMT
.          CALL      PACNAME                 
.
.          MOVE      ONE,FORM8
.          PACK      KEY12,QUOTE,EMHIDOC,QUOTE
.          MATCH     EMHIDOC,PMEVACON
.          IF        @EQUAL
.            WRITE     HTMLFILE;"<option value=",KEY12," selected>":
.                               PACFNAME,"</option>"
.          ELSE
.            WRITE     HTMLFILE;"<option value=",KEY12,">",PACFNAME,"</option>;"
.          ENDIF
.
.          GOTO      EMDOC100
.
.EMDOC200  BRANCH    FORM8,EMDOC999
.          PACK      KEY10,PMEVACON,SP70
.          CALL      RDPMHCP1
.          BRANCH    OVRCD,EMDOC999
.
.          MOVE      PMHCSNAM,PACSNAME
.          MOVE      PMHCGNAM,PACGNAME
.          MOVE      PMHCTITL,PACTITLE
.          MOVE      ONE,PACFRMT
.          CALL      PACNAME                 
.          PACK      KEY12,QUOTE,PMEVACON,QUOTE
.          WRITE     HTMLFILE;"<option value=",KEY12," selected>":
.                               PACFNAME,"</option>"
.EMDOC999  RETURN
+
.******************************************************************************
.                 Display Existing items
.******************************************************************************
EITM0000  MOVE      ZERO,FORM3
          MOVE      "3",KEY1                * Set 3 for Misc.item
          PACK      KEY15,ADMISSNO,KEY1,SP20
          CALL      RSPMMTI2
EITM1000  CALL      RKPMMTI2
          BRANCH    OVRCD,EITM9999          * no (more) details for admission
.
          MATCH     PMMIVISN,ADMISSNO       * get admission number as form
          GOTO      EITM9999 IF NOT EQUAL   * different admission
.
          MATCH     "3",PMMIRTYP
          GOTO      EITM9999 IF NOT EQUAL   * Misc.Item
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,PMMIWUSR                * Item Created By
          IF        !@EQUAL
            PACK      KEY10,PMMIWUSR,SP70
            CALL      RDWBSE1
          ENDIF
.
          MOVE      ZERO,DELFLAG             * no delete option
          MOVE      ZERO,DELFLAG1            * no delete option
          MATCH     USERID,PMMIWUSR
          IF        @EQUAL
            CLEAR     HTMLLINK
            CLEAR     HTMLLNK3
            APPEND    "javascript:DeleteItm('",HTMLLINK
            APPEND    PMMITRAN,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
            MOVE      ONE,DELFLAG
            MOVE      ONE,DELFLAG1
            ADD       ONE,FORM3
            MOVE      FORM3,KEY3
            REP       " 0",KEY3
            MOVE      HTMLLINK,HTMLLNK3
            GOTO      EITM5000
          ENDIF
.
EITM4000  CLEAR     HTMLLNK3
          APPEND    "javascript:DeleteItm('",HTMLLNK3
          APPEND    PMMITRAN,HTMLLNK3
          APPEND    "')",HTMLLNK3
          RESET     HTMLLNK3
          MOVE      ONE,DELFLAG1
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
          REP       " 0",KEY3
.
EITM5000  MOVE      "Incl   ",KEY7
          MATCH     "1",PMMIINCT
          IF        @EQUAL
            MOVE      "Patient",KEY7
          ENDIF
          MATCH     "2",PMMIINCT
          IF        @EQUAL
            MOVE      "Extra  ",KEY7
          ENDIF
.
          PACK      KEY11,PMMIVISN,PMMISUNQ,SP70
          CALL      RDNZSPR1
          IF        OVRCD=1
            MOVE      SP70,NZSPPROC
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PMMITDAT,PMMISVTM,"#",":   * 1
                             "#"",PMMIITEM,"#",":            * 2
                             "#"",PMMIDESC,PMMIDES2,"#",";            * 3
.
          MATCH     USERID,PMMIWUSR
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=text size=5 name=qunty",KEY3:
                               " class=Integer value ='",PMMISERV:
                               "' onchange=\#"UpdateItm('":
                               PMMITRAN,"',this);\#">":
                               "#",";                        * 4
          ELSE
            WRITE     HTMLFILE;"#"",PMMISERV,"#",";          * 4
          ENDIF
.
          WRITE     HTMLFILE;"#"",WBSENAM,"#",":             * 5
                             "#"",DELFLAG,"#",":             * 6
                             "#"",KEY7,"#",":                * 7
                             "#"",NZSPPROC,"#",":            * 8
                             "#"",HTMLLNK3,"#",";            * 9
.
          WRITE     HTMLFILE;"#"<input type=text size=5 name=qunty",KEY3:
                             " class=Integer value ='",PMMISERV:
                             "' onchange=\#"UpdateItm('":
                             PMMITRAN,"',this);\#">":
                             "#",";                          * 10
.
          WRITE     HTMLFILE;"#"",DELFLAG1,"#");"            * 11
.
          GOTO      EITM1000
.
EITM9999  RETURN
+
.*******************************************************************************
. List NZ Procedure records
.*******************************************************************************
NZLS0000  CALL      PRHD0000                 * heading
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
NZLS1000  CALL      RKNZSPR1
          BRANCH    OVRCD,NZLS9999
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      NZLS9999 IF NOT EQUAL
.
          PACK      NZCLDESC,SP70
          MATCH     SP70,NZSPCLMN
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      NZCLDESC,TDESC,SP70
            ENDIF
          ENDIF
.
          PACK      KEY17,NZSPPROC,SP70
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      KEY17,NZSPPROC,OPDADATE,SP70
          ENDIF
          CALL      PATITMRD
          IF        OVRCD=1
            PACK      IDESC,SP70
          ENDIF
.
          PACK      KEY14,NZSPCNTR,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            PACK      HFNAME,SP70
          ENDIF
.
          PACK      DOCFNAME,SP70
          PACK      KEY10,NZSPSURG,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      DNO,PRIMARY
          COMPARE   ONE,NZSPPRIM
          IF        @EQUAL
            MOVE      DYES,PRIMARY
          ENDIF
.
          MOVE      DNO,PATINS
          COMPARE   ONE,NZSPPINS
          IF        @EQUAL
            MOVE      DYES,PATINS
          ENDIF
.
          MOVE      DNO,APPSIGHT
          COMPARE   ONE,NZSPAPSI
          IF        @EQUAL
            MOVE      DYES,APPSIGHT
          ENDIF
.
          MOVE      PLANNED,PROCSTAT
          COMPARE   ONE,NZSPPIND
          IF        @EQUAL
            MOVE      PERFORMD,PROCSTAT
          ENDIF
.
          COMPARE   TWO,NZSPPIND
          IF        @EQUAL
            MOVE      NOTPERFD,PROCSTAT
          ENDIF
.
          WRITE     HTMLFILE;"<tr>";
.
          IF        NZSPPRIM=1
            WRITE     HTMLFILE;"<td><font color=red>",NZSPPROC,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",NZSPPROC,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>",NZSPPDES,"</td>";
.
          MOVE      SP70,OPDADATE
          MOVE      SP70,OPDATIME
          MATCH     SP70,NZSPUNTH
          GOTO      NZLS2000 IF EQUAL
.
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,NZLS2000
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"<br>":
                             "at ",OPDATIME,"<br></td>":
                             "<td>",NZSPUNTH,"</td>";
          GOTO      NZLS3000
.
NZLS2000  WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
NZLS3000  WRITE     HTMLFILE;"<td>",DOCFNAME,"</td>":
                             "<td>",NZCLDESC,"</td>":
                             "<td>",HFNAME,"</td>":
                             "<td>",NZSPCPRC,"</td>":
                             "<td>",PRIMARY,"</td>":
                             "<td>",PROCSTAT,"</td></tr>";
          GOTO      NZLS1000
.
NZLS9999  RETURN
+
.******************************************************************************
.         Procedures heading
.******************************************************************************
PRHD0000  PACK       KEY5,ANSC,ANSL,SP70
          CALL       RDCODE1
          IF         OVRCD=1
            MOVE       "Claim Code          ",TDESC
          ENDIF
          WRITE      HTMLFILE;"<tr height=26>":
                              "<td class=HeadingCell>Procedure Code</td>":
                              "<td class=HeadingCell>Description</td>":
                              "<td class=HeadingCell>Session</td>":
                              "<td class=HeadingCell>Unique ID</td>":
                              "<td class=HeadingCell>Surgeon</td>":
                              "<td class=HeadingCell>",TDESC,"</td>":
                              "<td class=HeadingCell>Contract</td>":
                           "<td class=HeadingCell>Contract Procedure Code</td>":
                              "<td class=HeadingCell>Primary</td>":
                              "<td class=HeadingCell>Status</td>":
                              "</tr>";
.
PRHD9999  RETURN
+
.******************************************************************************
.         Items list for a procedure 
.******************************************************************************
NZIP0000  CALL      IHED0000                 * heading
.
          MATCH     SP70,PROCEDFR
          IF        @EQUAL
            CALL      GETNZP00
            MOVE      NZSPPROC,PROCEDFR
            MOVE      NZSPUNIQ,UNIQNUMB
          ENDIF
.
          MOVE      ZERO,DISNUMB
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
NZIP1000  CALL      RKNZSPR1
          BRANCH    OVRCD,NZIP9999
.
          MATCH     ADMISSNO,NZSPADMN        * Check admission no
          GOTO      NZIP9999 IF NOT EQUAL
.
          MATCH     SP70,NZSPPROC
          GOTO      NZIP1000 IF EQUAL
.
          MATCH     PROCEDFR,NZSPPROC
          GOTO      NZIP1000 IF NOT EQUAL    * not the selected procedure
.
          MATCH     UNIQNUMB,NZSPUNIQ
          GOTO      NZIP1000 IF NOT EQUAL    * not the selected procedure
.
          MOVE      "3",KEY1                 * Misc.Item record
          PACK      KEY15,NZSPADMN,KEY1,SP70
          CALL      RSPMMTI2
NZIP2000  CALL      RKPMMTI2
          BRANCH    OVRCD,NZIP9999
.
          MATCH     NZSPADMN,PMMIVISN
          GOTO      NZIP9999 IF NOT EQUAL
.
          MATCH     "3",PMMIRTYP             * Misc.item record?
          GOTO      NZIP9999 IF NOT EQUAL
.
          MATCH     PMMISUNQ,NZSPUNIQ        * same uniq number?
          GOTO      NZIP2000 IF NOT EQUAL
.
          ADD       ONE,DISNUMB
.
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "Incl   ",KEY7
          MATCH     "1",PMMIINCT
          IF        @EQUAL
            MOVE      "Patient",KEY7
          ENDIF
          MATCH     "2",PMMIINCT
          IF        @EQUAL
            MOVE      "Extra  ",KEY7
          ENDIF
         WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                            "<td>",PMMIDESC,PMMIDES2,"</td>":
                            "<td>&nbsp;",NZSPPROC,"</td>":
                            "<td>&nbsp;",KEY7,"</td>":
                            "<td>&nbsp;",NZSPCNTR,"</td>":
                            "<td>",PMMIITEM,"</td>";
.
          MOVE      DISNUMB,DIM5
          REP       " 0",DIM5
          UNPACK    DIM5,KEY2,KEY3
.
          WRITE     HTMLFILE;"<td align=center>",PMMISERV,"</td>";
.
          MATCH     "1",PTCNSTUN
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",PMMIREFN,"</td>";
          ENDIF
.
.         Delete option available for all records in pmsmtiaf
.
          BRANCH    BITMFLAG,NZIP7000         * Bulk Delete item
.
          MATCH     SP70,PROCEDTO
          GOTO      NZIP7000 IF NOT EQUAL

          WRITE     HTMLFILE;"<td align=center>":
                             "<input disabled type=checkbox name=trnno",KEY3:
                             " value='",PMMITRAN,"'";
          GOTO      NZIP8000
.
NZIP7000  WRITE     HTMLFILE;"<td align=right>":
                             "<input type=checkbox name=trnno",KEY3:
                             " value='",PMMITRAN,"' onclick='NotAllItem();'";
.
NZIP8000  WRITE     HTMLFILE;"</td>":
                             "<td>&nbsp;</td>";
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      NZIP2000
.
NZIP9999  RETURN
+
.******************************************************************************
.         Procedures heading
.******************************************************************************
IHED0000  WRITE      HTMLFILE;"<tr height=26>":
                              "<td class=HeadingCell>Date</td>":
                              "<td class=HeadingCell>Description</td>":
                              "<td class=HeadingCell>Procedure</td>":
                              "<td class=HeadingCell>Incl/Excl</td>":
                              "<td class=HeadingCell>Contract</td>":
                              "<td class=HeadingCell>Item</td>":
                              "<td class=HeadingCell align=center>Qty</td>";
.
          MATCH     "1",PTCNSTUN
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell width=8%>":
                               "Stock Usage Number</td>";
          ENDIF
.
.
          WRITE      HTMLFILE;"<td class=HeadingCell align=center>Mark All":
                              "</td>":
                              "<td class=HeadingCell>";
.
.         Delete All option available for Bulk Delete item
.
          BRANCH     BITMFLAG,IHED7000         * Bulk Delete item
.
          PACK       PROCEDTO,PROCEDTO,SP70
          MATCH      SP70,PROCEDTO
          GOTO       IHED7000 IF NOT EQUAL
.
          WRITE      HTMLFILE;"<input type=checkbox name=allitems value='0' ":
                              " disabled>";
          GOTO       IHED8000
.
IHED7000  WRITE      HTMLFILE;"<input type=checkbox name=allitems value='0' ":
                              "onclick='TickAllItem();'>";
.
IHED8000  WRITE     HTMLFILE;"</td>":
                             "</tr>";
.
IHED9999  RETURN
+
.******************************************************************************
.*  Get NZ Procedure details if required                                      *
.******************************************************************************
GETNZP00  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
GETNZP10  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZP90
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      GETNZP90 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      GETNZP10 IF NOT EQUAL
          GOTO      GETNZP999
.
GETNZP90  CALL      CLNZSP00
.
GETNZP99  RETURN
+
.------------------------------------------------------------
. GST 
.------------------------------------------------------------
GSTA0000  UNPACK   DIM127,D1,KEY1,DIM127
          MOVE     ZERO,F1
          MOVE     KEY1,F1
          BRANCH   F1,GSTA1000,GSTA2000
          WRITE    HTMLFILE;PTGTU001;
          GOTO     GSTA9999
.
GSTA1000  MOVE     "Unknown ",KEY8
          WRITE    HTMLFILE;KEY8;
          GOTO     GSTA9999
.
GSTA2000  WRITE    HTMLFILE;"<option value=2 selected>":
                            "Unknown</option>":
                            "<option value=1>":
                            "Yes</option>":
                            "<option value=0>":
                            "No</option>";
GSTA9999  RETURN
+
.------------------------------------------------------------
.      Keyin GST Code
.------------------------------------------------------------
KYGC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,KYGC1200,KYGC1400
          WRITE     HTMLFILE;PTGTU002;
          GOTO      KYGC9999
.
KYGC1200  PACK      KEY6,PTGTU002
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ELSE
            WRITE     HTMLFILE;PTGTU002;
          ENDIF
          GOTO      KYGC9999
.
.   Display Selection List for GST code
.
KYGC1400  PACK      KEY6,SP70
          CALL      RSIBGS1
KYGC1425  CALL      RKIBGS1 
          BRANCH    OVRCD,KYGC9999
.
          MATCH     IBGSCODE,PTGTU002
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      KYGC1425
.
KYGC9999  RETURN
+
.------------------------------------------------------------
. Output Patient portion
.------------------------------------------------------------
KYPP0000  WRITE    HTMLFILE;PATPORTN;
KYPP9999  RETURN
+
.------------------------------------------------------------
. Output Health fund portion
.------------------------------------------------------------
KYHP0000  WRITE    HTMLFILE;REBPORTN;
KYHP9999  RETURN
+
.------------------------------------------------------------
. Check if any MBS item previously entered
.------------------------------------------------------------
CTHE0000  MOVE      ZERO,ADMTYPFG           * Auto admission type flag - dont do
          COMPARE   ONE,PTCNAUAT
          GOTO      CTHE9000 IF NOT EQUAL   * Not using auto admin type update
          COMPARE   ONE,PTCNWSPC
          GOTO      CTHE9000 IF NOT EQUAL   * Dont want manual admin type update
.
          BRANCH    CFEETYP,CTHE9000        * Using the rates file, exit
.
. ----- Check for any existing theatre items for this patient -----
.
          MOVE      ONE,ADMTYPFG            * Auto admission type flag - yes
          PACK      KEY22,AADMNO,SP20
          CALL      RDSDTRN1                * Position on & read the DTR file
CTHE1000  CALL      RDKDTRN1
          BRANCH    OVRCD,CTHE2000
.
          MATCH     AADMNO,TADMNO
          GOTO      CTHE2000 IF NOT EQUAL   * Different admission number
.
          COMPARE   TWO,TRECTYPE
          GOTO      CTHE1000 IF NOT EQUAL   * Not a theatre item
.
          MOVE      ZERO,F1
          MOVE      PTDTCRST,F1
          BRANCH    F1,CTHE1000,CTHE1000    * Credit note
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          PACK      KEY17,TITEMNO,KEY8,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,CTHE1000
          GOTO      CTHE3000
.
.         Check for items not invoiced yet
.
CTHE2000  OPEN      PMSMTIA2,"pmsmtiaf"
          MOVE      "2",PMMIRTYP
          PACK      KEY15,AADMNO,PMMIRTYP,SP20
          CALL      RSPMMTI1
CTHE2200  CALL      RKPMMTI1
          BRANCH    OVRCD,CTHE9000
.
          MATCH     PMMIVISN,DAADMNO
          GOTO      CTHE9000 IF NOT EQUAL   * Different admission number
.
          MATCH     "2",PMMIRTYP
          GOTO      CTHE9000 IF NOT EQUAL   * Not a theatre item
.
          PACK      KEY17,PMMIITEM,PMMITDAT,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,CTHE2200
.
CTHE3000  MOVE      TWO,ADMTYPFG            * Auto admission type flag - no
.
CTHE9000  WRITE     HTMLFILE;ADMTYPFG;
CTHE9999  RETURN
+
.------------------------------------------------------------
. Subsequence Primary MBS
.------------------------------------------------------------
SUBI0000  READ      CONTROLF,EIGHTY;*131,PTCNWSPC    * Warning for sub-seq item
          WRITE     HTMLFILE;PTCNWSPC;
SUBI9999  RETURN
+
.------------------------------------------------------------
. Admission number
.------------------------------------------------------------
ADMN0000  WRITE     HTMLFILE;AADMNO;
ADMN9999  RETURN
.------------------------------------------------------------
. Admission date
.------------------------------------------------------------
ADAT0000  MATCH     ADATE,SP70 
          GOTO      ADAT9999 IF EQUAL   
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
ADAT9999  RETURN
+
.------------------------------------------------------------
. Discharged Date
.------------------------------------------------------------
DDAT0000  COMPARE   THREE,ASTAT
          GOTO      DDAT9999 IF NOT EQUAL 
          MATCH     DDATE,SP70
          GOTO      DDAT9999 IF EQUAL
          MATCH     DDATE,SP70 
          GOTO      DDAT9999 IF EQUAL   
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
DDAT9999  RETURN
+
.------------------------------------------------------------
. Output Future Action Details
.------------------------------------------------------------
FACT0000  BRANCH   FLDITMNO,FACT0100,FACT0200,FACT0300,FACT0400,FACT0500:
                            FACT0600,FACT0700,FACT0800,FACT0900,FACT1000:
                            FACT1100,FACT1200,FACT1300,FACT1400,FACT1500:
                            FACT1600,FACT1700,FACT1800,FACT1900,FACT2000:
                            FACT2100,FACT2200,FACT2300,FACT2400,FACT2500:
                            FACT2600,FACT2700,FACT2800,FACT2900,FACT3000
          GOTO     FACT9999
.
FACT0100  WRITE    HTMLFILE;FADMNO;
          GOTO     FACT9999
.
FACT0200  UNPACK   FADATE,CCENT,CYEAR,CMON,CDAY
          MOVE     CMON,F2
          LOAD     MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE    HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO     FACT9999
.
FACT0300  MOVE     "FA",CATEGORY
          MOVE     FACODE,CODE
          CALL     CODITM00
          GOTO     FACT9999
.
FACT0400  WRITE    HTMLFILE;FACOMM;
          GOTO     FACT9999
.
FACT0500  CALL     PATFAC00
          GOTO     FACT9999
.
FACT0600  WRITE    HTMLFILE;PTFCURNO;
          GOTO     FACT9999
.
FACT0700  MATCH     SP70,PTFCDTCP
          GOTO      FACT9999 IF EQUAL
          UNPACK    PTFCDTCP,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FACT9999
.
FACT0800  CALL      PURFAC00           * Future Action for UR Number List
          GOTO      FACT9999
.
FACT0900  WRITE    HTMLFILE;FLTRSTAT;
          GOTO     FACT9999
.
FACT1000  MOVE     "w0",CATEGORY
          MOVE     PTFCOCGR,CODE
          CALL     CODITM00
          GOTO     FACT9999
.
FACT1100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FACT1110
.
          MATCH     SP70,PTFCHFND
          GOTO      FACT9999 IF EQUAL
.
          WRITE     HTMLFILE;PTFCHFND;
          GOTO      FACT9999
.
FACT1110  PACK      KEY14,PTFCHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;PTFCHFND;
          ENDIF
          GOTO     FACT9999
.
FACT1200  PACK     KEY8,ADMISSNO,SP70
          CALL     RDMISS1
          IF       OVRCD=1
            WRITE    HTMLFILE;PFUNDH;
            GOTO     FACT9999
          ENDIF
.
          WRITE    HTMLFILE;AFUNDH;
          GOTO     FACT9999
.
FACT1300  CALL      VICMNT00
          GOTO      FACT9999 IF NOT EQUAL
.
FACT1400  CALL      URCMTA00
          GOTO      FACT9999
.
FACT1500  CALL      PLET0000
          GOTO      FACT9999
.
FACT1600  CALL      FLET0000
          GOTO      FACT9999
.
FACT1700  PACK      KEY14,ADMISSNO,ZERO,ZERO,THREE,SP70
          CALL      RSVSCMT1
FACT1710  CALL      RKVSCMT1
          BRANCH    OVRCD,FACT9999
.
          MATCH     ADMISSNO,VSCTVIST
          GOTO      FACT9999 IF NOT EQUAL
.
          MATCH     "003",VSCTTYPE
          GOTO      FACT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>",VSCTDATA,"</td><td>&nbsp</td></tr>"
          GOTO      FACT1710
.
FACT1800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      "010",KEY3              * Eclipse Comments
          IF        F1=1
            MOVE      "003",KEY3            * Billing Comments
          ENDIF
.
          PACK      KEY17,ADMISSNO,KEY3,Z70
          CALL      RSVSMDT1
FACT1801  CALL      RPVSMDT1 
          BRANCH    OVRCD,FACT9999          * end of file
.
          MATCH     VSMDVISN,ADMISSNO       * same Admission Number?
          GOTO      FACT9999 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE           * same comment type?
          GOTO      FACT9999 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT            * comment deleted?
          GOTO      FACT1801 IF EQUAL
.
          MOVE      SP70,ECLPDATE
.
          MATCH     SP70,VSMDDATE
          IF        !@EQUAL
            UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ECLPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      WBSENAM,SP70
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
.
          CLEAR     ECLNOTES
          APPEND    ECLPDATE,ECLNOTES
          APPEND    "  ",ECLNOTES
          APPEND    VSMDTIME,ECLNOTES
          APPEND    "  ",ECLNOTES
          APPEND    WBSENAM,ECLNOTES
          APPEND    "  ",ECLNOTES
          APPEND    VSMDOCCG,ECLNOTES
          RESET     ECLNOTES
.
          WRITE     HTMLFILE;"<tr><td>",ECLNOTES,":":
                             "</td><td>&nbsp</td></tr>"
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
FACT1805  CALL      RKVSMTX1
          BRANCH    OVRCD,FACT1801
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      FACT1801 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      FACT1801 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      FACT1801 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>",VSMTCMNT,"</td><td>&nbsp</td></tr>"
.
          GOTO      FACT1805
.
.                                                                     *I-234909
FACT1900  PACK     KEY8,ADMISSNO,SP70       * Discharge Comments from PATMI1af
          CALL     RDMISS1
          BRANCH   OVRCD,FACT9999
          MATCH     SP20,ACOMM1
          IF        @EQUAL
            MATCH     SP20,ACOMM2
            GOTO      FACT9999 IF EQUAL
          ENDIF
          WRITE     HTMLFILE;"<tr><td align=center>",ACOMM1:
                             "&nbsp &nbsp &nbsp",ACOMM2,"</td></tr>"
          GOTO      FACT9999
.
FACT2000  MOVE      ZERO,F1
          MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            MOVE      ONE,F1
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      FACT9999
.
FACT2100  MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          BRANCH    OVRCD,FACT9999
.
          WRITE     HTMLFILE;"<tr><td>",PTELECMN,"</td><td>&nbsp</td></tr>"
.
          GOTO      FACT9999
.
FACT2200  WRITE     HTMLFILE;INVPDVAL;
          GOTO      FACT9999
.
FACT2300  MATCH     PTFCCDAT,SP70
          GOTO      FACT9999 IF EQUAL
          UNPACK    PTFCCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FACT9999
.
FACT2400  WRITE     HTMLFILE;PTFCCTIM; 
          GOTO      FACT9999
.
FACT2500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FACT2510
          WRITE     HTMLFILE;PTFCCUID;
          GOTO      FACT9999
.
FACT2510  PACK      KEY10,PTFCCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFCCUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      FACT9999
.
FACT2600  MATCH     PTFCUDAT,SP70
          GOTO      FACT9999 IF EQUAL
          UNPACK    PTFCUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FACT9999
.
FACT2700  WRITE     HTMLFILE;PTFCUTIM; 
          GOTO      FACT9999
.
FACT2800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FACT2810
          WRITE     HTMLFILE;PTFCUUID;
          GOTO      FACT9999
.
FACT2810  PACK      KEY10,PTFCUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFCUUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      FACT9999
.
FACT2900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FACT2910,FACT2910
          WRITE     HTMLFILE;PTFCINVN;
          GOTO      FACT9999
.
FACT2910  CALL      SELINV00              * selection of invoices
          GOTO      FACT9999
.
FACT3000  WRITE     HTMLFILE;INVOICEN;
          GOTO      FACT9999
.
FACT9999  RETURN
.
.-----------------------------------------------------------------------
.         Selection of Invoices
.-----------------------------------------------------------------------
SELINV00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
          PACK      KEY16,ADMISSNO,Z70
          CALL      RDSINV3
SELINV10  CALL      RDPINV3
          BRANCH    OVRCD,SELINV99
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      SELINV99 IF NOT EQUAL
.
          BRANCH    F1,SELINV20,SELINV30
          GOTO      SELINV10
.
.         Update template
.
SELINV20  MATCH     SP70,PTFCINVN
          GOTO      SELINV30 IF EQUAL       * Blank invoice number
.
          MOVE      PTFCINVN,FORM8
          MOVE      FORM8,KEY8
          MATCH     KEY8,PINVNO
          GOTO      SELINV30 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",PINVNO,"#" selected>":
                             PINVNO,"</option>"
          GOTO      SELINV10
.
.         Add template
.
SELINV30  COMPARE   "3",PINVSYS
          GOTO      SELINV10 IF NOT EQUAL   * not Inpatient
          MATCH     "1",PTINCRST
          GOTO      SELINV10 IF EQUAL       * Fully Credited
.
          WRITE     HTMLFILE;"<option value=#"",PINVNO,"#">":
                             PINVNO,"</option>"
.
          GOTO      SELINV10
.
SELINV99  RETURN
+
.-----------------------------------------------------------------------
. Retrieve all the active number of visit comment details
.-----------------------------------------------------------------------
VICMNT00  MOVE      ADMISSNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
VICMNT10  CALL      RPVSMDT1
          BRANCH    OVRCD,VICMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VICMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VICMNT10 IF EQUAL
.
. Retrieve comment header
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     SP70,VSCMDATE
            GOTO     VICMNT20
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VSCMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VICMNT20  PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSENAM,VSCMUSRN
          ELSE
            MOVE      VSMDUSER,VSCMUSRN
          ENDIF
.
VICMNT30  PACK      OCCGDESC,SP70
          MATCH     VSMDOCCG,SP70
          IF        !@EQUAL
            MOVE      "w0",KEY2
            PACK      KEY5,KEY2,VSMDOCCG,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      OCCGDESC,VSMDOCCG,SP70
            ELSE
              PACK      OCCGDESC,TDESC,SP70
            ENDIF
          ENDIF
.
VICMNT40  PACK      VSCMLINE,VSCMDATE,SP1,VSMDTIME,SP1,VSCMUSRN,SP1,OCCGDESC
          WRITE     HTMLFILE;"<tr><td>",VSCMLINE,"</td><td>&nbsp</td></tr>"
.
          CALL      VICMTX00
.
          GOTO      VICMNT10
.
VICMNT99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
.
VICMTX00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VICMTX20  CALL      RKVSMTX1
          BRANCH    OVRCD,VICMTX99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VICMTX99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VICMTX99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>",VSMTCMNT,"</td><td>&nbsp</td></tr>"
.
          GOTO      VICMTX20
.
VICMTX99  RETURN
.
.-----------------------------------------------------------------------
. Retrieve all the active U/R comment details
.-----------------------------------------------------------------------
URCMTA00  MOVE      URNUMBER,KEY8
          PACK      KEY17,KEY8,URCMTTYP,Z70
.
          CALL      RSPMUCH1
URCMTA10  CALL      RPPMUCH1
          BRANCH    OVRCD,URCMTA99
.
          MATCH     KEY8,PMUHURNO
          GOTO      URCMTA99 IF NOT EQUAL
.
          MATCH     URCMTTYP,PMUHCTYP
          GOTO      URCMTA99 IF NOT EQUAL
.
          MATCH     "1",PMUHDELT            * is comment deleted
          GOTO      URCMTA10 IF EQUAL
.
. Retrieve comment header
.
          MATCH     PMUHCDAT,SP70
          IF        @EQUAL
            MOVE     SP70,URCMDATE
            GOTO     URCMTA20
          ENDIF
.
          UNPACK    PMUHCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                               JUL,AUG,SEP,OCT,NOV,DEC
          PACK      URCMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
URCMTA20  PACK      KEY10,PMUHCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSENAM,URCMUSRN
          ELSE
            MOVE      PMUHCUID,URCMUSRN
          ENDIF
.
URCMTA30  PACK      OCCGDESC,SP70
          MATCH     PMUHOCCG,SP70
          IF        !@EQUAL
            MOVE      "w0",KEY2
            PACK      KEY5,KEY2,PMUHOCCG,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      OCCGDESC,PMUHOCCG,SP70
            ELSE
              PACK      OCCGDESC,TDESC,SP70
            ENDIF
          ENDIF
.
URCMTA40  PACK      URCMLINE,URCMDATE,SP1,PMUHCTIM,SP1,URCMUSRN,SP1,OCCGDESC
          WRITE     HTMLFILE;"<tr><td>",URCMLINE,"</td><td>&nbsp</td></tr>"
.
          CALL      URCMXA00
.
          GOTO      URCMTA10
.
URCMTA99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
.
URCMXA00  PACK      KEY20,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RSPMUCD1
URCMXA20  CALL      RKPMUCD1
          BRANCH    OVRCD,URCMXA99
.
          MATCH     PMUHURNO,PMUCURNO
          GOTO      URCMXA99 IF NOT EQUAL
.
          MATCH     PMUHCTYP,PMUCCTTY
          GOTO      URCMXA99 IF NOT EQUAL
.
          MATCH     PMUHCNUM,PMUCCNUM
          GOTO      URCMXA99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>",PMUCCOMM,"</td><td>&nbsp</td></tr>"
.
          GOTO      URCMXA20
.
URCMXA99  RETURN
+
.------------------------------------------------------------
. Output Future Action Table Details
.------------------------------------------------------------
PATFAC00  MATCH     SP70,ADMISSNO
          GOTO      PATFAC99 IF EQUAL
          PACK      KEY19,ADMISSNO,Z70
          CALL      RDSFACT1
PATFAC10  CALL      RDPFACT1
          BRANCH    OVRCD,PATFAC99
          MATCH     ADMISSNO,DFADMNO 
          GOTO      PATFAC99 IF NOT EQUAL
.
          MOVE      "w0",CATEGORY
          MOVE      PTFCOCGR,CODE
          CALL      GETCOD00
          MOVE      TDESC,OCCGDESC
.
          MOVE      "FA",CATEGORY
          MOVE      FACODE,CODE
          CALL      GETCOD00
.
          MOVE      SP70,DSDTCOMP
          MATCH     SP70,PTFCDTCP
          IF        !@EQUAL
            UNPACK    PTFCDTCP,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DSDTCOMP,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,HFNAME
          MATCH     SP70,PTFCHFND
          IF        !@EQUAL
            PACK      KEY14,PTFCHFND,ZERO8,SP70
            CALL      RDFUND1
            IF        OVRCD=1
              MOVE     PTFCHFND,HFNAME
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPCNAM           * Clear created by fields
          MOVE      SP70,DISPCDAT
          MOVE      SP70,DISPCTIM
.
          MATCH     SP70,PTFCCUID           * Blank created by user
          GOTO      PATFAC30 IF EQUAL
.
          PACK      KEY10,PTFCCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFCCUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPCNAM
.
          MATCH     SP70,PTFCCDAT           * Blank created date
          GOTO      PATFAC30 IF EQUAL
.
          UNPACK    PTFCCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPCDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,PTFCCTIM           * Blank created time
          GOTO      PATFAC30 IF EQUAL
.
          MOVE      " at ",DIM4
          PACK      DISPCTIM,DIM4,PTFCCTIM,SP70
.
PATFAC30  UNPACK    FADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td><img src=../images/ActionIcon.gif ":
                             "class=ListIcon onclick='linkAction(#"":
                                URNUMBER,"#",#"",ADMISSNO,"#",#"":
                                CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#",#"":
                                FACODE,"#")'>";
.
          MATCH     "S",PTFCSTAT           * Status of Suspended
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=#FF0000><b>":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ELSE
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>":
                             "<td>&nbsp;",PTFCINVN,"</td>":
                             "<td>",HFNAME,"&nbsp;</td>":
                             "<td>",OCCGDESC,"&nbsp;</td>":
                             "<td>",FACOMM,"&nbsp;</td>":
                             "<td>",DSDTCOMP,"&nbsp;</td>":
                             "<td>",DISPCNAM,"<br>",DISPCDAT,DISPCTIM:
                             "&nbsp;</td></tr>"
          GOTO      PATFAC10
.
PATFAC99  PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE
          CALL      RDFACT1
          IF        OVRCD=1
            CALL      CLRFAC00    * Clear all file variables
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          RETURN
+
.------------------------------------------------------------
. Output Future Action Table bu UR Number 
.------------------------------------------------------------
PURFAC00  MATCH     SP70,URNUMBER
          GOTO      PURFAC99 IF EQUAL
          PACK      KEY27,URNUMBER,Z70
          CALL      RDSFACT3
PURFAC10  CALL      RDPFACT3
          BRANCH    OVRCD,PURFAC99
.
          MATCH     URNUMBER,PTFCURNO
          GOTO      PURFAC99 IF NOT EQUAL
.
.         PACK      KEY8,FADMNO,SP70        * Get Hosptal from visit extn file
.         CALL      RDPMVX11
.         BRANCH    OVRCD,PURFAC10
.
          PACK      KEY8,FADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PURFAC10
.
          COMPARE   FIVE,ASTAT              * Don't display cancelled pre adm
          GOTO      PURFAC10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      PURFAC10 IF NOT EQUAL
          ENDIF
.
          COMPARE   "2",FLTRSTAT            * Show All Future Actions?
          GOTO      PURFAC20 IF EQUAL       * Yes, skip status checks.
.
          COMPARE   "1",FLTRSTAT            * Show Completed Actions only?
          IF        @EQUAL
            MATCH     SP70,PTFCDTCP         * Yes, is completed date blank?
            GOTO      PURFAC10 IF EQUAL     * Yes, skip this record
          ELSE
            MATCH     SP70,PTFCDTCP         * No, is completed date blank?
            GOTO      PURFAC10 IF NOT EQUAL * No, skip this record
          ENDIF
.
PURFAC20  MOVE      "w0",CATEGORY
          MOVE      PTFCOCGR,CODE
          CALL      GETCOD00
          MOVE      TDESC,OCCGDESC
.
          MOVE      "FA",CATEGORY
          MOVE      FACODE,CODE
          CALL      GETCOD00
.
          MOVE      SP70,DSDTCOMP
          MATCH     SP70,PTFCDTCP
          IF        !@EQUAL
            UNPACK    PTFCDTCP,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DSDTCOMP,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,HFNAME
          MATCH     SP70,PTFCHFND
          IF        !@EQUAL
            PACK      KEY14,PTFCHFND,ZERO8,SP70
            CALL      RDFUND1
            IF        OVRCD=1
              MOVE     PTFCHFND,HFNAME
            ENDIF
          ENDIF
.
          UNPACK    FADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td><img src=../images/ActionIcon.gif ":
                             "class=ListIcon onclick='linkAction(#"":
                                URNUMBER,"#",#"",DFADMNO,"#",#"":
                                CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#",#"":
                                FACODE,"#")'>";
.
          MATCH     "S",PTFCSTAT           * Status of Suspended
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=#FF0000><b>":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ELSE
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
          MOVE      SP70,DISPCNAM           * Clear created by fields
          MOVE      SP70,DISPCDAT
          MOVE      SP70,DISPCTIM
.
          MATCH     SP70,PTFCCUID           * Blank created by user
          GOTO      PURFAC30 IF EQUAL
.
          PACK      KEY10,PTFCCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFCCUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPCNAM
.
          MATCH     SP70,PTFCCDAT           * Blank created date
          GOTO      PURFAC30 IF EQUAL
.
          UNPACK    PTFCCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPCDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,PTFCCTIM           * Blank created time
          GOTO      PURFAC30 IF EQUAL
.
          MOVE      " at ",DIM4
          PACK      DISPCTIM,DIM4,PTFCCTIM,SP70
.
PURFAC30  WRITE     HTMLFILE;"<td>",DFADMNO,"&nbsp;</td>":
                             "<td>",TDESC,"&nbsp;</td>":
                             "<td>",PTFCINVN,"&nbsp;</td>":
                             "<td>",HFNAME,"&nbsp;</td>":
                             "<td>",OCCGDESC,"&nbsp;</td>":
                             "<td>",FACOMM,"&nbsp;</td>":
                             "<td>",DSDTCOMP,"&nbsp;</td>":
                             "<td>",DISPCNAM,"<br>",DISPCDAT,DISPCTIM:
                             "&nbsp;</td></tr>"
          GOTO      PURFAC10
.
PURFAC99  PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE
          CALL      RDFACT1
          IF        OVRCD=1
            CALL      CLRFAC00    * Clear all file variables
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1 
          RETURN
+
.-----------------------------------------------------------
. Future Action Module
.-----------------------------------------------------------
FUTURE00  MOVE      ZERO,WARNINGC
          MOVE      ZERO,WARCOUNT
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      URNUMBER,KEY8     * Check if patient exists
          CALL      RDMAST1
          BRANCH    OVRCD,FUTURE90   
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      TEMPLATE,FORM3
          MOVE      FORM3,TEMPLATE
          REP       " 0",TEMPLATE
          MATCH     "003",TEMPLATE          * Future Actions for UR Number?
          GOTO      FUTURE05 IF EQUAL       * Yes, Admission is not mandatory
.
          MATCH     SP70,ADMISSNO   * Admission number is mandatory
          GOTO      FUTURE95 IF EQUAL
.
FUTURE05  MATCH     SP1,UPDTTYPE
          GOTO      FUTURE40 IF EQUAL 
          GOTO      FUTURE40 IF EOS
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      FUTURE10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      FUTURE20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      FUTURE30 IF EQUAL
.
          GOTO      FUTURE93
.
FUTURE10  MATCH     SP70,FACTDATE     * If date not set report an error 
          GOTO      FUTURE94 IF EQUAL     
          PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE,SP70
          CALL      RDFACT1
          COMPARE   ZERO,OVRCD
          GOTO      FUTURE92 IF EQUAL
.
          CALL      FUTSAV00      * Moves input variables to file variables  
          PACK      PTFCCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCCDAT
          CLOCK     TIME,PTFCCTIM
          MOVE      USERID,PTFCCUID
          MOVE      SP70,PTFCUDAT
          MOVE      SP70,PTFCUTIM
          MOVE      SP70,PTFCUUID
          PACK      KEY19,FADMNO,FADATE,FACODE,SP70
          CALL      WRFACT1       * Writes away the data
.
.                                 * Are Future Actions also posted to Comments?
          IF        CFUTCOM = 1
            CALL      LVCMNT00    * Check the current Comments line no
            BRANCH    EXIT,FUTURE99
            CALL      FUTCOM00    * write Future Actions to Adm.Comments file.
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      FUTURE99
.
FUTURE20  PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE,SP70
          CALL      RDFACT1
          BRANCH    OVRCD,FUTURE91 
.
          CALL      FUTSAV00      * Moves input variables to file variables  
          PACK      PTFCUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCUDAT
          CLOCK     TIME,PTFCUTIM
          MOVE      USERID,PTFCUUID
          CALL      UPFACT1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      FUTURE99
.
FUTURE30  PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE,SP70
          CALL      RDFACT1
          BRANCH    OVRCD,FUTURE91 
.
          CALL      DEFACT1       * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      FUTURE99
.
FUTURE40  PACK      KEY19,ADMISSNO,FACTDATE,FACTCODE,SP70
          CALL      RDFACT1
          IF        OVRCD=1
            CALL      CLRFAC00    * Clear all file variables
            MATCH     SP70,ADMISSNO   * Admission number is mandatory
            IF        !@EQUAL
              MOVE      ADMISSNO,KEY8
              CALL      RDMISS1
              IF        OVRCD=0
                MOVE      AFUNDH,PTFCHFND     * default from adm.HF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "Future Actions",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,FUTURE99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE90  MOVE      "Patient U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE91  MOVE      "Future Action does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE92  MOVE      "Future Action record exists for that Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE94  MOVE      "Future Action date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE95  MOVE      "Invalid visit number!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FUTURE99 
.
FUTURE99  RETURN
.
.-----------------------------------------------------------------------
. Get the latest active visit comment note and maximum line number
.-----------------------------------------------------------------------
.
LVCMNT00  MOVE      ZERO,CMNOTENO
          MOVE      ZERO,CMLINENO     
          MOVE      ZERO,CMEXIST
          MOVE      FADMNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
LVCMNT10  CALL      RPVSMDT1
          BRANCH    OVRCD,LVCMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      LVCMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      LVCMNT99 IF NOT EQUAL
.
. Save the latest note number
.
          IF        CMNOTENO = 0
            MOVE      VSMDNOTE,CMNOTENO
          ENDIF
.  
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      LVCMNT10 IF EQUAL
.
. Active comment header found
.
          MOVE      VSMDNOTE,CMNOTENO
.   
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,Z70
          CALL      RSVSMTX1
          CALL      RPVSMTX1
          BRANCH    OVRCD,LVCMNT99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      LVCMNT99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      LVCMNT99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      LVCMNT99 IF NOT EQUAL
.
          MOVE      VSMTUNIQ,CMLINENO
.
          MATCH     "999",VSMTUNIQ
          GOTO      LVCMNT90 IF NOT EQUAL
.
          CLEAR     WARNINGL
          APPEND    "WARNING: Comments has reached max ",WARNINGL
          APPEND   "No of Lines, Future Action NOT posted to Comments!",WARNINGL
          RESET     WARNINGL
          CALL      ADDWRN00                * Add Warning
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      LVCMNT99
.
LVCMNT90  MOVE      ZERO,EXIT
          MOVE      VSMTUNIQ,CMLINENO
.
LVCMNT99  RETURN
.
.--------------------------------------------------------------------
. Write Future Actions to Admission Comments file (vismdtaf/vismtxaf)
.--------------------------------------------------------------------
FUTCOM00  PACK      FACODE,FACODE,SP70
          MATCH     SP3,FACODE          * Do we have a future action code ?
          GOTO      FUTCOM40 IF EQUAL   * No. Check if there are any comments
.
.         Get the future action description
.
          PACK      KEY5,ANSF,ANSA,FACODE
          CALL      RDCODE1             * Cat."FA" 
          BRANCH    OVRCD,FUTCOM40      * No code -> Don't post to comments
.
          IF        CMEXIST = 0
            CALL      NWCMHD00 
            MOVE      ONE,CMEXIST
            MOVE      ZERO,CMLINENO
          ELSE
            MOVE      VSMDVISN,VSMTVISN
            MOVE      VSMDTYPE,VSMTTYPE
            MOVE      VSMDNOTE,VSMTNOTE
          ENDIF
.           
          ADD       ONE,CMLINENO        * Go to the next line number
          MOVE      CMLINENO,VSMTUNIQ
          UNPACK    FADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE             * Format the future action date
          PACK      VSMTCMNT,CPCDATE,SP1,FACODE,SP2,TDESC,SP30,SP20
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ
                                        * Key for the new comments record
          CALL      RAVSMTX1
          IF        OVRCD=1
            CALL      WRVSMTX1          * Write the comments to the file
          ENDIF
.
.         Write the Future action comment line to the next record
.
FUTCOM40  PACK      FACOMM,FACOMM,SP70
          MATCH     SP30,FACOMM         * Are there any comments ?
          GOTO      FUTCOM99 IF EQUAL   * No. Don't write to comments file
.
          IF        CMEXIST = 0
            CALL      NWCMHD00
            MOVE      ONE,CMEXIST 
            MOVE      ZERO,CMLINENO
          ELSE
            MOVE      VSMDVISN,VSMTVISN
            MOVE      VSMDTYPE,VSMTTYPE
            MOVE      VSMDNOTE,VSMTNOTE
          ENDIF
.
          ADD       ONE,CMLINENO        * Go to the next line number
          MOVE      CMLINENO,VSMTUNIQ
          UNPACK    FADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE             * Format the future action date
          PACK      VSMTCMNT,CPCDATE,SP1,FACOMM,SP10
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ
                                        * Key for the new comments record
          CALL      RAVSMTX1
          IF        OVRCD=1
            CALL      WRVSMTX1          * Write the comments to the file
          ENDIF
.
FUTCOM99  RETURN
.
.------------------------------------------------------------------------
.         Insert visit comment header
.------------------------------------------------------------------------
NWCMHD00  MOVE      FADMNO,VSMDVISN           * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
          MOVE      CURRDATX,VSMDDATE         * Visit date
          MOVE      CTIMEIS,VSMDTIME          * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG      * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
NWCMHD10  ADD       ONE,CMNOTENO
          MOVE      CMNOTENO,VSMDNOTE
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE
          CALL      RAVSMDT1
          COMPARE   ZERO,OVRCD
          GOTO      NWCMHD10 IF EQUAL
.
          CALL      WRVSMDT1
.
          MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE 
.
NWCMHD99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data for PATFACFD.INC
.----------------------------------------------------------- 
CLRFAC00  MOVE      SP70,FADATE 
          MOVE      SP70,DFADMNO
          MOVE      ZEROVISN,FADMNO
          MOVE      SP70,FACODE
          MOVE      SP70,FACOMM 
          MOVE      SP70,PTFCURNO
          MOVE      SP70,PTFCDTCP
          MOVE      SP70,PTFCOCGR
          MOVE      SP70,PTFCHFND
          MOVE      SP70,PTFCSTAT
          MOVE      SP70,PTFCINVN
          MOVE      SP70,PTFCCDAT
          MOVE      SP70,PTFCCTIM
          MOVE      SP70,PTFCCUID
          MOVE      SP70,PTFCUDAT
          MOVE      SP70,PTFCUTIM
          MOVE      SP70,PTFCUUID
          MOVE      SP70,PTFCSPAR
.
CLRFAC99  RETURN
.
.------------------------------------------------------------
. Moves cgi variables into file variables  
.------------------------------------------------------------
FUTSAV00  MOVE      FACTDATE,FADATE  
          MOVE      ADMISSNO,FADMNO
          MOVE      FACTCODE,FACODE
          MOVE      FACTCOMM,FACOMM
          MOVE      URNUMBER,PTFCURNO
          MOVE      FADTCOMP,PTFCDTCP
          MOVE      FACTOCGR,PTFCOCGR
          MOVE      FACTINVN,PTFCINVN
          MOVE      FACTHFND,PTFCHFND
          MOVE      SP70,PTFCSPAR
.
FUTSAV99  RETURN
.------------------------------------------------------------
. Future Actions by Date 
.------------------------------------------------------------
FUTACT00  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          MOVE      "Future Actions",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,FUTACT99
          CALL      WEBBOD00
          CALL      WEBEND00
FUTACT99  RETURN
+
.------------------------------------------------------------
. Future Actions List by Date 
.------------------------------------------------------------
FUTR0000  BRANCH    FLDITMNO,FUTR0100,FUTR0200,FUTR0300,FUTR0400,FUTR0500:
                             FUTR0600,FUTR0700,FUTR0800,FUTR0900,FUTR1000:
                             FUTR1100,FUTR1200,FUTR1300,FUTR1400
          GOTO      FUTR9999
.
FUTR0100  CALL      NEXT0000
          GOTO      FUTR9999
.
FUTR0200  CALL      PREV0000
          GOTO      FUTR9999
.
FUTR0300  CALL      CURSTD00
          GOTO      FUTR9999
.
FUTR0400  CALL      CUREND00
          GOTO      FUTR9999
.
FUTR0500  CALL      CURYR000
          GOTO      FUTR9999
.
FUTR0600  CALL      CURMON00
          GOTO      FUTR9999
.
FUTR0700  CALL      SELV0000
          GOTO      FUTR9999
.
FUTR0800  CALL      FTABA000  * Table Future Actions - Inpatients
          GOTO      FUTR9999
.
FUTR0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      FUTR9999
.
FUTR1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      FUTR9999
.
FUTR1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      FUTR9999
.
FUTR1200  MOVE      "FA",CATEGORY
          MOVE      FILTACTN,CODE
          CALL      CODITM00
          GOTO      FUTR9999
.
FUTR1300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FUTR1310
.
          MATCH     SP70,FILTHFND
          GOTO      FUTR9999 IF EQUAL
.
          WRITE     HTMLFILE;FILTHFND;
          GOTO      FUTR9999
.
FUTR1310  PACK      KEY14,FILTHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;FILTHFND;
          ENDIF
          GOTO      FUTR9999
.
FUTR1400  IF        DEFTOCGR=1
            MOVE      WBSEOCG,FILTOCGR
          ENDIF
.
          MOVE      "w0",CATEGORY
          MOVE      FILTOCGR,CODE
          CALL      CODITM00
          GOTO      FUTR9999
.
FUTR9999  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTHFND
          REP       " +",FILTACTN
          REP       " +",FILTOCGR
.
          WRITE     HTMLFILE;"patweb75.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&filthfnd=",FILTHFND:
                             "&filtactn=",FILTACTN:
                             "&filtocgr=",FILTOCGR;
.
          REP       "+ ",FILTHFND
          REP       "+ ",FILTACTN
          REP       "+ ",FILTOCGR
.
NEXT9999  RETURN
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTHFND
          REP       " +",FILTACTN
          REP       " +",FILTOCGR
.
          WRITE     HTMLFILE;"patweb75.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&filthfnd=",FILTHFND:
                             "&filtactn=",FILTACTN:
                             "&filtocgr=",FILTOCGR;
.
          REP       "+ ",FILTHFND
          REP       "+ ",FILTACTN
          REP       "+ ",FILTOCGR
.
PREV9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=POST >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=viewtype value=",KEY1,">";
.
          CALL      SELV0000
.
          WRITE     HTMLFILE;"<input type=submit value=View>":
                             "</form>"
.
SELDAT99  RETURN
.------------------------------------------------------------
. Displays Patient Future Actions Table 
.------------------------------------------------------------
FTABA000  PACK      KEY19,FRSTDATE,SP70
          CALL      RDSFACT2
FTABA100  CALL      RDKFACT2
          BRANCH    OVRCD,FTABA999 
.
          MATCH     FADATE,LASTDATE
          GOTO      FTABA999 IF LESS 
.
          MATCH     SP70,FILTHFND
          IF        !@EQUAL
            MATCH     FILTHFND,PTFCHFND
            GOTO      FTABA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTACTN
          IF        !@EQUAL
            MATCH     FILTACTN,FACODE
            GOTO      FTABA100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTOCGR
          IF        !@EQUAL
            MATCH     FILTOCGR,PTFCOCGR
            GOTO      FTABA100 IF NOT EQUAL
          ENDIF
.
FTABA400  CALL      FROWA000   * Display Future Actions Row   
          GOTO      FTABA100
.
FTABA999  RETURN
.------------------------------------------------------------
. Future Actions 
.------------------------------------------------------------
FROWA000  PACK      KEY8,DFADMNO          * Get U/R from visits file
          CALL      RDVISA1
          IF        OVRCD=1
            PACK     KEY8,DFADMNO,SP70
            CALL     RDMISS1
            IF       OVRCD<>1
              COMPARE  FIVE,ASTAT          * Don't display cancelled pre adm
              GOTO     FROWA999 IF EQUAL
            ENDIF     
            MOVE     PTFCURNO,PVIURNO
            GOTO     FROWA050
          ENDIF
.
          CALL      RDPMVX11
          BRANCH    OVRCD,FROWA050
.
          IF        IBCNMHOS<>1
            GOTO      FROWA050
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      FROWA050 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      FROWA999 IF NOT EQUAL
.
FROWA050  MATCH     PVIURNO,ZEROUR
          IF        @EQUAL
            MOVE      PVIBILL,KEY8
            CALL      RDPRAM1
          ELSE
            MOVE      PVIURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,FROWA999
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
FROWA100  MOVE      "w0",CATEGORY
          MOVE      PTFCOCGR,CODE
          CALL      GETCOD00
          MOVE      TDESC,OCCGDESC
.
          MOVE      SP70,HFNAME
          MATCH     SP70,PTFCHFND
          IF        !@EQUAL
            PACK      KEY14,PTFCHFND,ZERO8,SP70
            CALL      RDFUND1
            IF        OVRCD=1
              MOVE     PTFCHFND,HFNAME
            ENDIF
          ENDIF
.
          MOVE      PURNO,URNUMBER
          MOVE      DFADMNO,ADMISSNO
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      GBAL0000                * Get outstanding balance
.
          CALL      PATLN000
.
          MATCH     SP70,FACODE
          IF        @EQUAL
            MOVE      SP70,TDESC
          ELSE
            MOVE      "FA",CATEGORY     * Get Claim Code descirption
            MOVE      FACODE,CODE
            CALL      GETCOD00
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     UPDLINK
          APPEND    "javascript:linkAction('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          MOVE      SP70,KEY10
          MATCH     "S",PTFCSTAT           * Status of Suspended
          IF        @EQUAL
            MOVE      "RedText",KEY10
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",UPDLINK,"#",":
                                      "#"",FADATE,"#",":
                                      "#"",FORMATNM,"#",":
                                      "#"",TDESC,"#",":
                                      "#"",HFNAME,"#",":
                                      "#"",OCCGDESC,"#",":
                                      "#"",FACOMM,"#",":
                                      "#"",FORM12P2,"#",":
                                      "#"",PTFCDTCP,"#",":
                                      "#"",PTFCINVN,"#",":
                                      "#"",KEY10,"#");"
.
FROWA999 RETURN
.------------------------------------------------------------
. Get outstanding balance for the admission
.------------------------------------------------------------
GBAL0000  MOVE      ZERO,FORM12P2
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSPTINV3
GBAL1000  CALL      RKPTINV3
          BRANCH    OVRCD,GBAL9999
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      GBAL9999 IF NOT EQUAL
.
          ADD       PINVAMT,FORM12P2
          ADD       PINVPATA,FORM12P2
          ADD       PINVHFDA,FORM12P2
          ADD       PINVOTHA,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTINGSTJ,FORM12P2
          ENDIF
          GOTO      GBAL1000
.
GBAL9999  RETURN
+
.------------------------------------------------------------
. Update Journal Adjustment
.------------------------------------------------------------
JNLUPD00  MOVE      ZERO,WARNINGC
          MOVE      ZERO,WARCOUNT
.
          CALL      IBACLOCK
          MOVE      ZERO,JOURAMTT
          MOVE      ZERO,GSTAMT
          MATCH     SP70,JOURDATE
          IF        @EQUAL
            PACK      JOURDATE,CCC,CYY,CMM,CDD
            REP       " 0",JOURDATE
          ENDIF
          COMPARE   ZERO,INVOICEN
          GOTO      JNLUPD90 IF EQUAL
          MOVE      INVOICEN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,JNLUPD90
.
          MOVE      PINVADM,ADMISSNO
          MOVE      PINVUR,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,JNLUPD92
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,JNLUPD92
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
.
          CALL      VALPAT00
          BRANCH    EXIT,JNLUPD99
.
          MATCH     SP70,JOURITEM
          GOTO      JNLUPD94 IF EQUAL
.
          MOVE      JOURITEM,TTYPE
          PACK      KEY5,CODEJ,JOURITEM
          CALL      RDCODE1
          BRANCH    OVRCD,JNLUPD94
          IF        JOURPATT=0
            GOTO      JNLUPD96
          ENDIF
.
.         MATCH     XDATE2,JOURDATE
.         GOTO      JNLUPD93 IF LESS     * journal date less than adm.date
.
          MOVE      INVOICEN,KEY8
          CALL      RDPTINV1
          BRANCH    OVRCD,JNLUPD90,JNLUPD98
.
          IF        CFEETYP=5
            MATCH     "G",TCINDC4
            GOTO      JNLUPD70 IF EQUAL     * SX Split GST
          ENDIF
.
          MOVE      THCSCOD,JTYPE
          MATCH     SP1,JTYPE
          GOTO      JNLUPD20 IF EQUAL
          MATCH     "B",JTYPE
          GOTO      JNLUPD30 IF NOT EQUAL
          GOTO      JNLUPD60
.
.         Check Self Insured Journals
.
JNLUPD20  MATCH     "R",TCINDC5
          GOTO      JNLUPD22 IF EQUAL       * Self Insured Refund Journal
          MATCH     "F",TCINDC5
          GOTO      JNLUPD60 IF NOT EQUAL   * Not a Deposit OFF Journal
.
JNLUPD22  MOVE      "A",JTYPE
          GOTO      JNLUPD60
.
.         Check for GST Journal
.
JNLUPD30  MATCH     "G",JTYPE
          GOTO      JNLUPD60 IF NOT EQUAL   * not GST journal
.
          BRANCH    PINVSYS,JNLUPD97     * not applicable for Emergency
.
          MOVE      PTINGSTA,MAXGSTJ
          ADD       PTINGSTJ,MAXGSTJ     * Maximum GST Journal amount
          MOVE      JOURPATT,GSTAMT
          COMPARE   GSTAMT,MAXGSTJ
          GOTO      JNLUPD95 IF LESS      * invalid GST journal amount
.
JNLUPD60  MOVE      JOURPATT,JOURAMTT
          CALL      UJNL0000              * Update Journal Record
          BRANCH    EXIT,JNLUPD99
          CALL      CREC0000              * Update Un-reconciled inv.file
          GOTO      JNLUPD80
.
.         This Split GST is ONLY available to SX
.
JNLUPD70  CALL      AGST0000              * Get percentage of GST
.
.         Normal Journal = Total Journal/(1+PTCNAGST/100)
.         eg. GST=12.5% Journal entry $112.50, Normal Journal= $100 GST= $12.50
.
          MOVE      IBGEAMNT,FORM3P4
          DIV       "100",FORM3P4
          ADD       ONE,FORM3P4
.
          MOVE      ZERO,FORM12P4
          MOVE      JOURPATT,FORM12P4
          DIV       FORM3P4,FORM12P4
          MOVE      FORM12P4,FORM12P2     * Normal Journal amount
.
          MOVE      JOURPATT,GSTAMT
          SUB       FORM12P2,GSTAMT       * GST Journal amount
.
          MOVE      THCSCOD,JTYPE
          MATCH     "A",JTYPE              * Adjustment Journal
          IF        @EQUAL
            MULT      SEQ BY FORM12P2     * Reverse sign adj journals
            MULT      SEQ BY GSTAMT       * Reverse sign adj journals
          ENDIF
.
.         Validate the GST journal amount
.
          MOVE      PTINGSTA,MAXGSTJ
          ADD       PTINGSTJ,MAXGSTJ      * Maximum GST Journal amount
          COMPARE   GSTAMT,MAXGSTJ
          GOTO      JNLUPD95 IF LESS      * invalid GST journal amount
.
          MOVE      PTCNAGST,GSTCODES
          MOVE      JOURITEM,TTYPE
          MOVE      FORM12P2,JOURAMTT

          MOVE      SP70,JTYPE
          CALL      UJNL0000              * Update Journal Record
          BRANCH    EXIT,JNLUPD99
.
          MOVE      SP70,JOURDESC
          MOVE      PTCNGJRN,TTYPE
          PACK      KEY5,CODEJ,PTCNGJRN,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      JOURDESC,TDESC,SP70
          ENDIF
          MOVE      GSTAMT,JOURAMTT
          MOVE      THCSCOD,JTYPE
          CALL      UJNL0000                * Update GST Journal Record
.
JNLUPD80  MOVE      ZERO,EXIT
. 
          IF        BULKFLAG=1
            CALL      WEBWAR00              * Display warnings and redirect
            MOVE      ONE,EXIT
            GOTO      JNLUPD99
          ENDIF
.
          COMPARE   ZERO,WARNINGC
          GOTO      JNLUPD99 IF EQUAL       * No warning message
          CALL      WINCL200                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      JNLUPD99
.
JNLUPD90  MOVE      "Invalid Invoice",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD92  MOVE      "Invalid Patient U/R",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD93  UNPACK    XDATE2,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    "Journal Date must be after Admission Date.",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD94  MOVE      "Invalid Journal Adjustment Code",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD95  CLEAR     WEBTITLE
          APPEND    "GST Adjustment must be less than $",WEBTITLE
          APPEND    MAXGSTJ,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD96  MOVE      "No Adjustment Amount Specified",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD97  MOVE      "GST Journals are not applicable to Emergency.",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD98  MOVE      "Invoice Locked",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      JNLUPD99
.
JNLUPD99  RETURN
+
.******************************************************************************
.* AGST0000 : Get percentage of accommodation GST                             *
.******************************************************************************
AGST0000  MOVE     ZERO,IBGEAMNT            * Initialise GST percentage amount
          OPEN     IBAGEDA1,"ibagedaf"
.
          MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
.
          PACK     KEY14,PTCNAGST,KEY8
          CALL     RDIBGE1
          COMPARE  ZERO,OVRCD
          GOTO     AGST9999 IF EQUAL         * found GST amount for current date
.
          CALL     RPIBGE1                   * read previous record
          BRANCH   OVRCD,AGST8000
.
          MATCH    PTCNAGST,IBGECODE         * Same code ?
          GOTO     AGST9999 IF EQUAL
.
AGST8000  MOVE     ZERO,IBGEAMNT
.
AGST9999  RETURN
+
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
WINCL200  CALL      OPENHTML
          BRANCH    EXIT,WINCL299
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCL299  RETURN
.------------------------------------------------------------
. Refresh Parent of Parent and Close Window
.------------------------------------------------------------
WINCL300  CALL      OPENHTML
          BRANCH    EXIT,WINCL399
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             "  reload2ParentFrame();":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCL399  RETURN
+
.------------------------------------------------------------
.         Transfer Deposit to an existing Invoice
.------------------------------------------------------------
DEPTRN00  MOVE      ONE,CNTITEM
          MOVE      SP70,PAYMCODE
          WHILE     CNTITEM<=LASTITEM
            MOVE      RECPN[CNTITEM],RCPTNUMB
            MOVE      SITEM[CNTITEM],RCPTRCNT
.
            MATCH     "1",CSTRN[CNTITEM]
            GOTO      DEPTRN20 IF NOT EQUAL
.
            MATCH     SP70,RCPTNUMB
            GOTO      DEPTRN20 IF EQUAL
.
            PACK      KEY17,RCPTNUMB,RCPTRCNT,SP70
            CALL      RDCMDEP1
            BRANCH    OVRCD,DEPTRN20
.
            MATCH     "0",CMDESTAT             * Deposit must be Not applied yet
            GOTO      DEPTRN20 IF NOT EQUAL
.
            CALL      RDRCDTE1                 * deposit receipt details record
            BRANCH    OVRCD,DEPTRN20
.
.           Deposit can only have payment type 'From patient'
.           (it can not be from Health Fund or Insurance)
.
            MOVE      "P",PAYMTYPE
.
.           Read the first record of Bank details file to get the payment type
.           ie. Cash, Cheque
.
            PACK      KEY15,RCPTNUMB,SP70
            CALL      RSRCBDT1
            CALL      RKRCBDT1
            BRANCH    OVRCD,DEPTRN20
.
            MATCH     RCPTNUMB,RCBDRECN      * Same receipt number?
            GOTO      DEPTRN20 IF NOT EQUAL  * missing bank details
.
            MOVE      IVTRN[CNTITEM],KEY8    * Invoice number transfter to
            CALL      RDINV1
            BRANCH    OVRCD,DEPTRN20
.
            CALL      TDTR0000               * Update DTR
            CALL      TRDT0000               * Update Receipt details
            CALL      TINV0000               * Update Invoice
.
DEPTRN20    ADD       ONE,CNTITEM
          DO
.
          MOVE      ZERO,EXIT
          GOTO      DEPTRN99
.
DEPTRN90  CLEAR     WEBTITLE
          APPEND    "Invalid Invoice Number : ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPTRN99
.
DEPTRN91  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPTRN99
.
DEPTRN99  RETURN
+
.---------------------------------------------------------------
.         Update DTR file for transfering deposit to an invoice
.---------------------------------------------------------------
TDTR0000  MOVE      ZERO,EXIT
          IF        PINVSYS=2
            MOVE      "out",OSTFILE
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1
            PACK      CFNAME,OSTFILE,FILDTRO1
            OPEN      OUTDTRO1,CFNAME
          ENDIF
.
          MOVE      RCDTAMNT,RCPTAMNT        * Save receipt amount
          MOVE      PINVNO,TREF              * Invoice number transfer to
          MOVE      PINVADM,TADMNO           * Admission no transfer to
.
TDTR3000  CALL      NXTTRAN1               * Get the next transaction number
          PACK      KEY22,PINVADM,TREF,TTRANSN1,SP70
          CALL      RADTR000
          COMPARE   ZERO,OVRCD
          GOTO      TDTR3000 IF EQUAL
.
          CALL      CLPATDTR
          MOVE      RCDTRECN,TRECEIPT
          MOVE      RCBDPTYP,BTYPEF
          MOVE      RCBDPCOD,PAYMCODE
.
          MOVE      RCPTAMNT,TPATAMTT        * receipt amount
          MULT      SEQ BY TPATAMTT
          CALL      SETD0000                 * set up vars
.
          BRANCH    PINVSYS,TDTR4000,TDTR5000,TDTR6000
          GOTO      TDTR7000
.
TDTR4000  
.         MOVE      PINVDTE,ATDTEFFD       * move invoice date to eff.date
          PACK      ATDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",ATDTEFFD
          MOVE      RCDTTDAT,ATDDATE
          MOVE      PAYMTYPE,ATTYPE
          MOVE      PAYMCODE,ATDTPCOD
          GOTO      TDTR7000
.
TDTR5000  
.         MOVE      PINVDTE,OTDTEFFD     * move invoice date to eff.date
          PACK      OTDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",OTDTEFFD
          MOVE      RCDTTDAT,OTDDATE
          MOVE      PAYMTYPE,OTTYPE
          MOVE      PAYMCODE,OTDTPCOD
          GOTO      TDTR7000
.
TDTR6000  
.         MOVE      PINVDTE,PTDTEFFD         * move invoice date to eff.date
          PACK      PTDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",PTDTEFFD
          UNPACK    RCDTTDAT,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,TFDAY
          MOVE      XMON,TFMONTH
          MOVE      XYEAR,TFYEAR
          MOVE      XCENT,TFCENT
          MOVE      PAYMTYPE,TTYPEDEB
          MOVE      PAYMCODE,PTDTPCOD
.
TDTR7000  CALL      WRTD0000                 * post dtran record
.
          IF        PINVSYS=3
            MOVE      PINVADM,KEY8
            CALL      RDMISS1
            IF        OVRCD=0
              MOVE      PVITRAN,ATRANNO      * next transaction number
              PACK      PTMIWEBU,USERID,SP70
              CALL      UPMISS1
            ENDIF
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      TDTR9999
.
TDTR9000  MOVE      ONE,EXIT
TDTR9999  RETURN
+
.--------------------------------------------------------------------
.         Update Invoice file for transfering deposit to an invoice
.--------------------------------------------------------------------
TINV0000  SUB       RCPTAMNT,PINVPATA
          CALL      CBAL0000               * Check if invoice is now balanced
.
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
          IF        FORM102<=0
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            CALL      UPFAPPLN           * Update FA Completion date
          ENDIF
.
          PROC      FLAGDEBT
.
          CALL      CREC0000              * Update Un-reconciled inv.file
.
.         update the fees invoiced file
.
          MULT      SEQ,TPATAMTT         * make payment positive again
.
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
          CALL      SETF0000             * set up the variables
          CALL      PATCALF              * post data to the PATFINS file
.
TINV9999  RETURN
+
.---------------------------------------------------------------------------
.         Update Receipt Details file for transfering deposit to an Invoice
.---------------------------------------------------------------------------
TRDT0000  PACK      KEY17,RCPTNUMB,RCPTRCNT,SP70
          CALL      RDCMDEP1
          BRANCH    OVRCD,TRDT9999
          MOVE      "1",CMDESTAT           * Set deposit to be applied

          MOVE      PINVADM,CMDEADMN        * Visit number
          PACK      CMDEAINV,SP4,PINVNO,SP70
.         PACK      CMDEREFD,PINVDTE
          PACK      CMDEREFD,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CMDEREFD           * Date Applied deposit
          CALL      IBACLOCK
          MOVE      CTIMEIS,CMDEREFT        * Current time
.
          PACK      CMDEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",CMDEUDAT           * date updated
          CLOCK     TIME,CMDEUTIM           * time updated
          MOVE      USERID,CMDEUUID         * web user id
          CALL      UPCMDEP1
.
          PACK      KEY17,RCPTNUMB,RCPTRCNT,SP70
          CALL      RDRCDTE1               * Read deposit receipt details record
          BRANCH    OVRCD,TRDT9999
.
          PACK      RCDTINVN,SP4,PINVNO,SP70
          MOVE      PINVADM,RCDTVIST        * Visit number
          MOVE      PINVUR,RCDTURNO         * U/R number
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ENDIF
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE1
.
TRDT9999  RETURN
+
.------------------------------------------------------------
.         Credit transfer
.------------------------------------------------------------
CSHTRN00  COMPARE   ZERO,INVOICEN
          GOTO      CSHTRN90 IF EQUAL
          MOVE      INVOICEN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CSHTRN90             * invalid invoice number
.
          IF        PINVSYS=2
            MOVE      "out",OSTFILE
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1
            PACK      CFNAME,OSTFILE,FILDTRO1
            OPEN      OUTDTRO1,CFNAME
          ENDIF
.
          MOVE      PINVADM,ADMISSNO
          MOVE      PINVUR,URNUMBER
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CSHTRN91             * missing master record
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ONE,CNTITEM
          WHILE     CNTITEM<=LASTITEM
            MOVE      IVTRN[CNTITEM],TRANFINV
            MATCH     SP70,TRANFINV
            IF        !@EQUAL
              CALL      UDTR0000               * Update DTR
              CALL      URDT0000               * Update Receipt details
              CALL      UINV0000               * Update Invoice
            ENDIF
            ADD       ONE,CNTITEM
          DO
.
          MOVE      ZERO,EXIT
          GOTO      CSHTRN99
.
CSHTRN90  CLEAR     WEBTITLE
          APPEND    "Invalid Invoice Number : ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSHTRN99
.
CSHTRN91  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSHTRN99
.
CSHTRN99  RETURN
+
.------------------------------------------------------------
.         Update DTR file for Cash transfer
.------------------------------------------------------------
UDTR0000  MOVE      ZERO,EXIT
          MOVE      SP70,RCPTNUMB
          MOVE      ZERO,RCPTAMNT
          MOVE      INVOICEN,KEY8          * Invoice number transfer from
          MOVE      TRNNO[CNTITEM],KEY6    * Transaction number
          PACK      KEY22,ADMISSNO,KEY8,KEY6,SP70
          CALL      RDDTR000
          BRANCH    OVRCD,UDTR9000
.
          MOVE      KEY22,SAVKEY22         * Save key
          MOVE      TRECEIPT,RCPTNUMB      * Save receipt number
          MOVE      TPATAMTT,RCPTAMNT      * Save receipt amount
.
          MOVE      IVTRN[CNTITEM],KEY8    * Invoice number transfter to
          CALL      RDINV1
          BRANCH    OVRCD,UDTR9000
.
          MOVE      PINVNO,TREF              * Invoice number transfer to
          MOVE      PINVADM,TADMNO           * Admission no transfer to
.         MOVE      PINVDTE,PTDTEFFD         * move invoice date to eff.date
          PACK      PTDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",PTDTEFFD
          IF        PINVSYS=1
            MOVE      PINVNO,ATINVNO         * Invoice number transfer to
            MOVE      PINVADM,ATNUMB         * Admission no transfer to
.           MOVE      PINVDTE,ATDTEFFD       * move invoice date to eff.date
            PACK      ATDTEFFD,CCC,CYY,CMM,CDD
            REP       " 0",ATDTEFFD
          ELSE
            IF        PINVSYS=2
              MOVE      PINVNO,OTINVNO       * Invoice number transfer to
              MOVE      PINVADM,OTNUMB       * Admission no transfer to
.             MOVE      PINVDTE,OTDTEFFD     * move invoice date to eff.date
              PACK      OTDTEFFD,CCC,CYY,CMM,CDD
              REP       " 0",OTDTEFFD
            ENDIF
          ENDIF
.
UDTR3000  CALL      NXTTRAN1               * Get the next transaction number
          PACK      KEY22,PINVADM,TREF,TTRANSN1,SP70
          CALL      RADTR000
          COMPARE   ZERO,OVRCD
          GOTO      UDTR3000 IF EQUAL
          CALL      WRDTR000                * write a receipt record
.
          MOVE      SAVKEY22,KEY22          * restore key
          CALL      DEDTR000
.
          IF        PINVSYS=3
            MOVE      PINVADM,KEY8
            CALL      RDMISS1
            IF        OVRCD=0
              MOVE      PVITRAN,ATRANNO      * next transaction number
              PACK      PTMIWEBU,USERID,SP70
              CALL      UPMISS1
            ENDIF
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      UDTR9999
.
UDTR9000  MOVE      ONE,EXIT
UDTR9999  RETURN
+
.------------------------------------------------------------
.         Subroutine to get the next transaction number
.------------------------------------------------------------
NXTTRAN1  MOVE      TADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1
          MOVE      PVITRAN,TTRANSN1
          MOVE      PVITRAN,ATTRANS
          MOVE      PVITRAN,OTTRANS
          RETURN
+
.------------------------------------------------------------
.         Update Invoice file for Cash transfer
.------------------------------------------------------------
UINV0000  MOVE      INVOICEN,KEY8          * invoice transfer from
          CALL      RDINV1
          BRANCH    OVRCD,UINV9999
.
.         Get payment type from rcpbnkaf file
.
          MOVE      "P",PAYMTYPE
          MOVE      RCPTNUMB,KEY12
          CALL      RDRCBNK1
          IF        OVRCD=0
            MOVE      ZERO,F1
            MOVE      RCBNTTYP,F1
            LOAD      PAYMTYPE,F1,ANSH,ANSI,ANSG,ANSH
          ENDIF
.
          MOVE      ZERO,FORM1
          MATCH     "H",PAYMTYPE
          IF        @EQUAL
            SUB       RCPTAMNT,PINVHFDA    * Health Fund payment
            MOVE      ONE,FORM1
          ELSE
            MATCH     "I",PAYMTYPE
            IF        @EQUAL
              SUB       RCPTAMNT,PINVOTHA  * Insurance payment
              MOVE      TWO,FORM1
            ELSE
              SUB       RCPTAMNT,PINVPATA  * Patient payment
              MOVE      THREE,FORM1
            ENDIF
          ENDIF
          CALL      CBAL0000               * Check if invoice is now balanced
          MOVE      ZERO,F1
          IF        FORM102<=0
            MOVE      ONE,F1               * flag for balanced invoice
          ENDIF
.
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
          PROC      FLAGDEBT
.
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          MOVE      IVTRN[CNTITEM],KEY8    * Invoice number transfter to
          CALL      RDINV1
          BRANCH    OVRCD,UINV9999
.
          LOAD      FORM12P2,FORM1,PINVHFDA,PINVOTHA,PINVPATA
          ADD       RCPTAMNT,FORM12P2
          STORE     FORM12P2,FORM1,PINVHFDA,PINVOTHA,PINVPATA
          CALL      CBAL0000               * Check if invoice is now balanced
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
          IF        FORM102<=0 & F1=1
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            CALL      UPFAPPLN           * Update FA Completion date
          ENDIF
.
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
          PROC      FLAGDEBT
.
          CALL      CREC0000              * Update Un-reconciled inv.file
UINV9999  RETURN
+
.------------------------------------------------------------
.         Check if invoice is now balanced?
.------------------------------------------------------------
CBAL0000  MOVE      PINVAMT,FORM102      * Invoice amount +
          ADD       PINVPATA,FORM102     * Patient payments +
          ADD       PINVHFDA,FORM102     * H.F payments +
          ADD       PINVOTHA,FORM102     * Other payments +
          ADD       PTINCRTT,FORM102     * Credit Notes +
          ADD       PINVJOUR,FORM102     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM102     * Journal GST = amount outstanding
.
          MOVE      "99999999",PINVBLCD  * Assume it doesn't balance
.
.         Invoice is now balanced. Record the date that this occured
.
          IF        FORM102=0
            PACK      PINVBLCD,CCC,CYY,CMM,CDD
            REP       " 0",PINVBLCD
          ENDIF
CBAL9999  RETURN
+
.------------------------------------------------------------
.         Update Receipt Details file for Cash transfer
.------------------------------------------------------------
URDT0000  MOVE      INVOICEN,KEY8
          MOVE      INVOICEN,FORM12           * righ justified
          MOVE      FORM12,KEY12
          PACK      KEY29,KEY12,RCPTNUMB,SP70
          CALL      RSRCDTE3
URDT1000  CALL      RKRCDTE3
          BRANCH    OVRCD,URDT9999
.
          MATCH     KEY12,RCDTINVN            * Same invoice number?
          GOTO      URDT9999 IF NOT EQUAL
.
          MATCH     RCPTNUMB,RCDTRECN         * Same receipt number?
          GOTO      URDT9999 IF NOT EQUAL
.
          MOVE      RCPTAMNT,FORM12P2
          MULT      "-1",FORM12P2
          COMPARE   FORM12P2,RCDTAMNT
          GOTO      URDT1000 IF NOT EQUAL     * Not the right receipt
.
          MOVE      ZERO,FORM12
          MOVE      IVTRN[CNTITEM],FORM8
          MOVE      FORM8,FORM12
          MOVE      FORM12,RCDTINVN   * Invoice number transfter to
.
          MOVE      FORM8,KEY8
          CALL      RDINV1
          IF        OVRCD=0
            MOVE      PINVADM,RCDTVIST        * Visit number
          ENDIF
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE3
.
URDT9999  RETURN
+
.------------------------------------------------------------
.         Cash transfer for overpayment
.------------------------------------------------------------
OVRPAY00  COMPARE   ZERO,INVOICEN
          GOTO      OVRPAY90 IF EQUAL
.
          MOVE      INVOICEN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,OVRPAY90             * invalid invoice number
.
          MOVE      PINVADM,ADMISSNO
          MOVE      PINVUR,URNUMBER
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,OVRPAY91             * missing master record
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,OVRPAY91
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
.
          CALL      VALPAT00
          BRANCH    EXIT,OVRPAY99
.
          MATCH     SP70,PTCNCJRN              * Check Cash transfer Jrnl code
          GOTO      OVRPAY92 IF EQUAL          * Not setup yet
.
          MOVE      PTCNCJRN,JOURITEM
          MOVE      JOURITEM,TTYPE
          PACK      KEY5,CODEJ,JOURITEM
          CALL      RDCODE1
          BRANCH    OVRCD,OVRPAY92             * Invalid journal code
.
          CALL      IBACLOCK
          MOVE      ZERO,JOURAMTT
          MOVE      ZERO,GSTAMT
          MATCH     SP70,JOURDATE
          IF        @EQUAL
            PACK      JOURDATE,CCC,CYY,CMM,CDD
            REP       " 0",JOURDATE
          ENDIF
.
          MOVE      INVOICEN,KEY8          * Invoice number transfer from
          MOVE      JOURPATT,RCPTAMNT
          MULT      "-1",RCPTAMNT
          CLEAR     KEY28
          APPEND    "TO INV",KEY28
          APPEND    TINVOICE,KEY28
          APPEND    SP70,KEY28
          RESET     KEY28
          CALL      WJNL0000               * Write journal records
          BRANCH    EXIT,OVRPAY99
.
          MOVE      TINVOICE,KEY8          * Invoice number transfer to
          MOVE      JOURPATT,RCPTAMNT
          CLEAR     KEY28
          APPEND    "FROM INV",KEY28
          APPEND    INVOICEN,KEY28
          APPEND    SP70,KEY28
          RESET     KEY28                  * Journal description for DTR
          CALL      WJNL0000               * Write journal records
.
          MOVE      ZERO,EXIT
          GOTO      OVRPAY99
.
OVRPAY90  CLEAR     WEBTITLE
          APPEND    "Invalid Invoice Number : ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OVRPAY99
.
OVRPAY91  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OVRPAY99
.
OVRPAY92  CLEAR     WEBTITLE
          APPEND    "Invalid Journal Code for Trans.Overpayment - ",WEBTITLE
          APPEND    PTCNCJRN,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OVRPAY99
.
OVRPAY99  RETURN
+
.------------------------------------------------------------
.         Write a Journal record to an Invoice
.------------------------------------------------------------
WJNL0000  MOVE      ZERO,EXIT
          CALL      RDINV1
          BRANCH    OVRCD,WJNL9000
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,WJNL9000
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
          BRANCH    OVRCD,WJNL9000
.         
          IF        PINVSYS=2
            MOVE      "out",OSTFILE
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1
            PACK      CFNAME,OSTFILE,FILDTRO1
            OPEN      OUTDTRO1,CFNAME
          ENDIF
.
WJNL1000  MOVE      PVIBILL,KEY8              * get next transaction no
          CALL      TRVISA1
          CALL      CHKD0000                  * read dtra file
          COMPARE   ZERO,OVRCD
          GOTO      WJNL1000 IF EQUAL         * already exist, try next trans no
.
.                                            * Admission no transfer to
          MOVE      PINVADM,TADMNO                              (key field)
          MOVE      PVITRAN,TTRANSN1                            (key field)
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP        * Inpatient
          MOVE      ZERO,TREBATE
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTM
          MOVE      SP70,PTDTGSTC
.
          MOVE      RCPTAMNT,TPATAMTT    * receipt amount
          MULT      SEQ BY TPATAMTT
          MOVE      ZERO,TREBATE
          MOVE      "P",TTYPEDEB
          PACK      TDDESC,KEY28,SP70    * Journal description
          CALL      SETJNL00             * setup DTR record
          CALL      WRDTR000
.
          MOVE     "C",FINTYPE
          IF       PTCNJFEE=1
            PACK     FINCODE,ACLAIM,TTYPE,SP20
.                            Claim Code, Journal Code
          ELSE
            PACK     FINCODE,TTYPE,SP20
.                            Journal Code
          ENDIF
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          PACK     FINDATE,CCC,CYY,CMM,CDD
          REP      " 0",FINDATE
.
          IF       CJRNREP=1
            MOVE     JOURDATE,FINDATE
            REP      " 0",FINDATE
          ENDIF
.
          MOVE     PVITYPE,FINSYS
          CALL     CEVT0000                * Check for Events
          MATCH    SP70,KEY1
          IF       !@EQUAL
            MOVE     ZERO,FINSYS
            MOVE     KEY1,FINSYS
          ENDIF
          MOVE     PINVSITE,FINSITE
          MOVE     RCPTAMNT,FINAMT
          MOVE     ZERO,FGSTFLAG
          MOVE     PMVXMHOS,FINHOSP
          CALL     PATCALF
.
.         Update the Journal summary file
.
          MOVE      TTYPE,JCODE
          PACK      JDATE WITH CCC,CYY,CMM,CDD  * use current date
          REP       " 0",JDATE
.
          IF        CJRNREP=1
            MOVE      JOURDATE,JDATE
            REP       " 0",JDATE
          ENDIF
.
          MOVE      TADMNO,JADMN
          MOVE      TTRANSN1,JTRNS
          MOVE      PINVNO,JINVN
          MOVE      SP70,PTJRINDC
.
          MOVE      USERID,PTJRCUID              * Created by
          PACK      PTJRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTJRCDAT                * Date created
          CLOCK     TIME,PTJRCTIM                * Time created
          MOVE      SP70,JSPARE
.
          PACK      KEY24 WITH JCODE,JDATE,JADMN,JTRNS,SP70
          CALL      WRJRNL1
.
          MOVE      PINVNO,KEY8
          CALL      RDPTINV1
.
          ADD       TPATAMTT,PINVJOUR
          MOVE      PINVAMT,FORM102      * Invoice amount +
          ADD       PINVPATA,FORM102     * Patient payments +
          ADD       PINVHFDA,FORM102     * H.F payments +
          ADD       PINVOTHA,FORM102     * Other payments +
          ADD       PTINCRTT,FORM102     * Credit Notes +
          ADD       PINVJOUR,FORM102     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM102     * Journal GST = amount outstanding
.
          MOVE      "99999999",PINVBLCD  * Assume it doesn't balance
.
.         Invoice is now balanced. Record the date that this occured
.
          IF        FORM102=0
            PACK      PINVBLCD,CCC,CYY,CMM,CDD
            REP       " 0",PINVBLCD
          ENDIF
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
          PROC      FLAGDEBT
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
          IF        FORM102<=0
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            CALL      UPFAPPLN           * Update FA Completion date
          ENDIF
.
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          COMPARE   ONE,CINVJRN
          CALL      UPDJRN00 IF EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      WJNL9999
.
WJNL9000  MOVE      ONE,EXIT
WJNL9999  RETURN
+
.------------------------------------------------------------
.         Delete Future Actions where tcindc1= H,B or P
.------------------------------------------------------------
DFAC0000  MATCH     "1",PTCNDFUP
          GOTO      DFAC9999 IF NOT EQUAL
.
          PACK      DIM8,CCC,CYY,CMM,CDD    * setup current date
          REP       " 0",DIM8
          PACK      KEY19,ADMISSNO,DIM8,SP70
DFAC1000  CALL      RDSFACT1
DFAC2000  CALL      RDKFACT1
          BRANCH    OVRCD,DFAC9999
.
          MATCH     ADMISSNO,DFADMNO
          GOTO      DFAC9999 IF NOT EQUAL
.
          MATCH     PINVNO,PTFCINVN         * same invoice number?
          GOTO      DFAC2000 IF NOT EQUAL
.
          MOVE      "FA",TCODE
          PACK      KEY5,TCODE,FACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DFAC2000
.
          MATCH     "H",TCINDC1              * Health fund follow up
          GOTO      DFAC3000 IF EQUAL
          MATCH     "B",TCINDC1              * Claim debtor follow up
          GOTO      DFAC3000 IF EQUAL
.
          MATCH     "P",TCINDC1              * Patient follow up
          GOTO      DFAC2000 IF NOT EQUAL
          GOTO      DFAC4000
.
.         Do not delete HF and Claim debtor follow up for Patient only invoice
.
DFAC3000  COMPARE   ZERO,PINVREB
          GOTO      DFAC2000 IF EQUAL        * Patient only invoice
.
DFAC4000  PACK      KEY19,DFADMNO,FADATE,FACODE,SP70
          CALL      DEFACT1
          GOTO      DFAC1000
.
DFAC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after input journal
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM102
          MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM102       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM102,FORM12P2      * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF

          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
RECN0000  PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      USERID,PTURCUID       * WEB user id
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      PINVPATA,PTURPAYM    * Patient payments +
          ADD       PINVHFDA,PTURPAYM    * H.F payments +
          ADD       PINVOTHA,PTURPAYM    * Other payments +
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      USERID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      USERID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.------------------------------------------------------------
. Add MBS Item
.------------------------------------------------------------
MBSI0000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      ONE,MBSFLAG              * Set to MBS Item
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MBSI8000
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP10,ADMISSNO
          GOTO      MBSI8000 IF EQUAL
.
          MOVE      ADMISSNO,AADMNO
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,MBSI9100
          MOVE      SP2,SYSID
          LOAD      SYSID,PVITYPE,SYSAE,SYSOP,SYSIP,SYSOT,SYSDY
          CALL      CEVT0000                * Check for Events
          MATCH     SP70,KEY1
          IF        !@EQUAL
            MATCH     "1",KEY1
            IF        @EQUAL
              MOVE      SYSAE,SYSID         * Emergency 
            ELSE
              MATCH     "2",KEY1
              IF        @EQUAL
                MOVE      SYSOP,SYSID       * Outpatient
              ENDIF
            ENDIF
          ENDIF
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,MBSI9100
.
          IF        IBCNMHOS=1
            MOVE      SP1,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1                * get Hospital using Theatre fee
          ENDIF
.
          MOVE      ZERO,ASTAT
          MOVE      "0  ",ACLAIM
          MOVE      SP10,AFUNDH
          MOVE      SP10,AFNDTB
          MOVE      SP10,ACLSS
          MOVE      ZERO,CMIXFLAG
          MOVE      ZERO,ISDAYC
          MOVE      SP10,DDATE
          MOVE      ADMISSNO,XDAADMNO
. 
          CALL      VALPAT00               * Validate patient's details
          BRANCH    EXIT,MBSI9999
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      MBSI8000 IF EQUAL
          MATCH     ANSA,UPDATETY
          GOTO      MBSI4000 IF EQUAL      * Add items
          MATCH     ANSP,UPDATETY
          GOTO      MBSI2000 IF EQUAL      * Delete Pack and Add items
          MATCH     ANSM,UPDATETY
          GOTO      MBSI5000 IF EQUAL      * Move item from one proc.to another
          MATCH     ANSB,UPDATETY
          GOTO      MBSI5200 IF EQUAL      * Bulk Delete item for a procedure
          GOTO      MBSI9000
.
MBSI2000  CALL      NZPAC000       * Write Content of pack itm to tempfile
          GOTO      MBSI6000
.
MBSI4000  COMPARE   FIVE,CFEETYP
          GOTO      MBSI6000 IF NOT EQUAL    * Not NZ Private Billing
.
          CALL      CEXP0000       * Check for items to be exploded on invoice
          GOTO      MBSI6000
.
MBSI5000  CALL      MVIT0000       * Move items from one procedure to another
          GOTO      MBSI9999
.
MBSI5200  CALL      DBIT0000       * Delete Bulk items for a procedure
          GOTO      MBSI9999
.
.         Add MBS Items
.
MBSI6000  CALL      GCMX0000                * Check if casemix funded
.
          MOVE      ZERO,EXIT
          CALL      ADDITM00
          BRANCH    EXIT,MBSI9999
.
          CALL      UPDREQ00
.
          MATCH     ANSP,UPDATETY
          IF        @EQUAL
            CALL      DPAC0000              * Delete pack item
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MBSI9999
.
MBSI8000  MOVE      ZERO,F2
          MOVE      ZERO,LASTITEM
.
          MOVE      "Input MBS items",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create output & write HTML Header
          BRANCH    EXIT,MBSI9000
.
          CALL      WEBBOD00                * Process Web body
          CALL      WEBEND00                * Process end of HTML file
          MOVE      ONE,EXIT
          GOTO      MBSI9999
.
MBSI9000  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MBSI9999
.
MBSI9100  CLEAR     WEBTITLE
          APPEND    "Invalid Visit Number - ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
MBSI9999  CALL      DTEMP000
          RETURN
+
.------------------------------------------------------------
.  Add MBS/Miscellaneous items
.------------------------------------------------------------
ADDITM00  MOVE      ZERO,EXIT
          CALL      WTEMP000       *  Write items to tempfile
          BRANCH    EXIT,ADDITM99
          CALL      PITEM000
.
ADDITM99  RETURN
+
.*******************************************************************************
.         Check if Emergency patient has been invoiced
.*******************************************************************************
EINV0000  MOVE      ZERO,INVCFLAG               * Default to invoice item
.
          COMPARE   ONE,PVITYPE
          GOTO      EINV2000 IF EQUAL           * Emergency visit
.
          COMPARE   NINE,PVITYPE
          GOTO      EINV9999 IF NOT EQUAL
.
          MATCH     " 1",PVISYST                * Event?
          GOTO      EINV9999 IF NOT EQUAL
.
EINV2000  MATCH     "1",EMCNAPRO                * No invoice tobe raised?
          GOTO      EINV9999 IF NOT EQUAL       * Raise invoice
.
.         No Invoice to be raised for an invoice has already been raised
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSPTINV3
EINV4000  CALL      RKPTINV3
          BRANCH    OVRCD,EINV9999
          MATCH     DPINVADM,ADMISSNO           * Same admission?
          GOTO      EINV9999 IF NOT EQUAL
.
          MATCH     "1",PTINCRST                * Fully credit notes?
          GOTO      EINV4000 IF EQUAL           * Yes.
.
.         Invoice has already been raised
.
          MOVE      ONE,INVCFLAG                * No invoice pending
          MOVE      ZERO,PMMIAMTT
          MOVE      ZERO,PMMIRBAT
          MOVE      ZERO,PMMIAMTP
EINV9999  RETURN
+
.------------------------------------------------------------
.  Create tempfile
.------------------------------------------------------------
WTEMP000  CALL      CTEMP000       *  Create tempfile
          MOVE      ONE,UNIQUE
.
          MOVE      ONE,CNTITEM
          WHILE     CNTITEM<=LASTITEM
.
            CALL      CLREC000     * clear tempfile record variables
            MOVE      ZERO,SUBPACK
.
.  If Charge checked box for requisitions is not checked. do nothing
.
            MATCH     SP70,CHREQKEY[CNTITEM]
            IF        !@EQUAL
              UNPACK    CHREQKEY[CNTITEM],KEY36
              PACK      KEY36,KEY36,SP70
              CALL      RDOPREQ1
              BRANCH    OVRCD,WTEMP900
.
              IF        CHREQCHR[CNTITEM] = 1
                GOTO      WTEMP020
              ENDIF
              GOTO      WTEMP900
            ENDIF
.
WTEMP020    PACK      MCHARGE,ITEMN[CNTITEM],SP70
            MATCH     SP9,MCHARGE
            IF        !@EQUAL
              MOVE      MDATE[CNTITEM],MISCDATE
              PACK      KEY8,ADMISSNO
              MOVE      SUBPC[CNTITEM],SUBPACK
.
              MATCH     "1",PRITEMIN
              IF        @EQUAL
                CALL      CHKPIT00        * Check for valid MBS priitem
                BRANCH    EXIT,WTEMP999 
              ELSE
                MOVE      MISCDATE,WKITDATE
                CALL      CHKITM00        * Check for valid MBS/Misc.item number
                BRANCH    EXIT,WTEMP999
.
                IF        EXIT=2
                  MOVE      ZERO,REGMFLAG
                  CALL      GETRGM00
                  BRANCH    EXIT,WTEMP999
                  GOTO      WTEMP900
                ENDIF
              ENDIF
.
              MOVE      MDATE[CNTITEM],SDATE
              MOVE      QUNTY[CNTITEM],MULTNUM
              MOVE      REFNC[CNTITEM],TRECEIPT
.....         MOVE      SESSN[CNTITEM],TSESSION                         D-46224
              MOVE      ONE,FORM2           * set default              *I-46334
              SQUEEZE   SESSN[CNTITEM]      * get rid of any blanks    *I-46224
              MOVE      SESSN[CNTITEM],FORM2                           *I-46334
              MOVE      FORM2,TSESSION      * right-align Session      *I-46334
              MOVE      GSTAP[CNTITEM],PTMCGSTA
              MOVE      GSTCD[CNTITEM],PTMCGSTC
              MOVE      DESCP[CNTITEM],MDESC
              IF        CFEETYP=5
                MOVE      NZDES[CNTITEM],MISCDESC
              ENDIF
              MOVE      PATPR[CNTITEM],TPATAMTP
              MOVE      REBPR[CNTITEM],TREBATE
              MOVE      TPATAMTP,TPATAMTT
              ADD       TREBATE,TPATAMTT
              MOVE      UNIQU[CNTITEM],NZUNIQUE
              MOVE      INCTY[CNTITEM],NZINCTYP
              MOVE      STTIM[CNTITEM],STRTIME
              MOVE      ENTIM[CNTITEM],ENDTIME
              MOVE      CHREQKEY[CNTITEM],PMMTIKEY * pmsmtiaf key 
.
.-----------  Eclipse Bulk billing                             *T0859743-start
              MATCH     "1",PTCNUEBB               * Using Eclipse Bulk Billing
              IF        !@EQUAL
                MATCH     "1",PTCNBBSW
                IF        !@EQUAL
                  MATCH     "1",PTCNDVAW
                  GOTO      WTEMP050 IF NOT EQUAL      * No,check charge amount
                ENDIF
              ENDIF
.
              MATCH     "1",TYPEBBIL               * Eclipse Bulk Billing type
              IF        !@EQUAL
                MATCH     "1",TYPEDVAW
                GOTO      WTEMP050 IF NOT EQUAL      * No,check charge amount
              ENDIF
.
              MOVE      DURAT[CNTITEM],DURATIME    * Time Duration (mins)
              MOVE      ACOVR[CNTITEM],ACOVRIDE    * After Care Override Ind
              MOVE      MULPR[CNTITEM],MULPROVR    * Multi Procedure Override
              MOVE      DUPSR[CNTITEM],DUPSROVR    * Duplicate Service Override
              MOVE      SRVTX[CNTITEM],SERVTEXT    * Service Text
              MOVE      HOSIN[CNTITEM],HOSPINDI    * Hospital Indicator?
              MOVE      NUMPT[CNTITEM],NUMPTSEE    * Number of Patients Seen
              MOVE      ROVRC[CNTITEM],ROVRCODE    * Restrictive Override Code
              MOVE      SLDMC[CNTITEM],SLDMCODE    * Self Deem Code
              MOVE      LSPNV[CNTITEM],LSPNVNUM    * Location Specific Practice 
              MOVE      SUBIT[CNTITEM],SUBITEMN    * Sub Item Number
.-----------                                                   *T0859743-end  
.
.-----------  Eclipse DVAW
              MATCH     "1",PTCNDVAW               * Using Eclipse Bulk Billing
              GOTO      WTEMP050 IF NOT EQUAL
.
              MATCH     "1",TYPEDVAW              
              GOTO      WTEMP050 IF NOT EQUAL     
.
              MOVE      DSKMS[CNTITEM],DISTAKMS    * Sub Item Number
.
.-----------
.
.             If the total charge is zero, use the keyin amount
.
WTEMP050      IF        MBSFLAG=0 & TPATAMTP=0 & TREBATE=0
                MOVE      CAMNT[CNTITEM],TPATAMTT
                MOVE      TPATAMTT,TPATAMTP
              ENDIF
.
.             If the total is not zero, but pat+reb is zero, then default
.             patient portion to the total amount
.
              MOVE      ZERO,FORM12P2
              MOVE      TPATAMTP,FORM12P2
              ADD       TREBATE,FORM12P2
              IF        FORM12P2=0 & TPATAMTT<>0
                MOVE      TPATAMTT,TPATAMTP
              ENDIF
.
              IF        CFEETYP<>5 | MBSFLAG=0
                MATCH     "Y",PTMCKREB
                IF        @EQUAL
                  MOVE      TPATAMTT,TPATAMTG       * Save the keyin amount
                ENDIF
              ENDIF
.
              COMPARE   FIVE,CFEETYP
              GOTO      WTEMP400 IF NOT EQUAL    * Not NZ Private Billing
.
              PACK      KEY11,ADMISSNO,NZUNIQUE,SP70
              CALL      RDNZSPR1
              BRANCH    OVRCD,WTEMP400
.
              MATCH     SP70,NZSPCPRC
              GOTO      WTEMP080 IF EQUAL        * no contract - Normal charge
              MATCH     "1",NZSPCONT
              GOTO      WTEMP080 IF EQUAL        * max contr.- Normal charge
.
              MATCH     "0",NZINCTYP  
              GOTO      WTEMP100 IF NOT EQUAL    * Override Contract rule
.
              CALL      CHKAMT00                 * Check for Contract rule
              GOTO      WTEMP400
.
WTEMP080      MATCH     "0",NZINCTYP
              IF        @EQUAL
.               MATCH     "Y",NZMCKPRI
.               IF        @EQUAL
                  MOVE      TPATAMTT,TPATAMTG  * save keyin amfor FFS Win/Loss
.               ENDIF
              ENDIF
              GOTO      WTEMP400
.
.  NZINCTYP: 0=Use Contract Rule 1=Bill to Patient 2=Extra to Contract
.
WTEMP100      MATCH     "1",NZINCTYP
              IF        @EQUAL
                MOVE      ZERO,TREBATE           * zero rebate
                MOVE      TPATAMTP,TPATAMTT
              ENDIF
.
              MATCH     "2",NZINCTYP
              IF        @EQUAL
                MOVE      TPATAMTP,TREBATE 
                MOVE      ZERO,TPATAMTP
                MOVE      TREBATE,TPATAMTT
              ELSE
.
.         If this is not extra to contract and
.         there is a max.contr. misc.item charge goes to patient invoice
.
                MATCH     "1",NZSPCONT
                IF        @EQUAL
                   MOVE      ZERO,TREBATE           * zero rebate
                   MOVE      TPATAMTP,TPATAMTT
                ENDIF
              ENDIF
.
WTEMP400      CALL      CHKGAS00
.
              MOVE      XAMT,DXAMT
              MOVE      XMBS,DXMBS
              MOVE      URNUMBER,AURNO
              MOVE      UNIQUE,UNIQUEX
.
              MOVE      SP10,KEY3
              PACK      KEY38,XDAADMNO,TSESSION,SDATE,DXAMT,DXMBS,UNIQUEX
              WRITE     ITEMFIL1,KEY38;XDAADMNO,TSESSION,SDATE,DXAMT:
                              DXMBS,UNIQUEX:
                              TPATAMTT,AURNO,MITMTYP,MCHARGE,MDESC,ATRANNO:
                              PNAME,TRECEIPT,MULTNUM,MINDIC,MBSFLAG,TPATAMTP:
                              TREBATE,ACLAIM,AFUNDH,AFNDTB,IAMT,KEYFLAG:
                              MMSCGRP,MNINV,IBAND1,IBAND2,IBAND3,IBAND4:
                              IBAND5,IBAND6,IBAND7,IBAND8,PVITYPE,PVIBILL:
                              SYSID,ISDAYC,PCENFLG,ACLSS:
                              IBAND9,IBAND10,IBAND11,IBAND12:
                              IBAND13,IBAND14,IBAND15,IBAND16,PTMCKREB:
                              CMIXFLAG,PTCTEPSD,PTMCGSTA,PTMCGSTC,CMBSFEE:
                              PTMCALGR,NZUNIQUE,NZINCTYP,TPATAMTG,NZMCKPRI:
                              THEABAND,STRTIME,ENDTIME,MISCDESC,NZEXPITM:
.-----------  Eclipse Bulk billing                             *T0859743-start
                              DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,SERVTEXT:
                              HOSPINDI,NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM:
                              SUBITEMN,SETCMGRP,PMMTIKEY:
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
                              DISTAKMS
.-----------
.

              ADD       ONE,UNIQUE
.
.       Check if we are doing the Subsequence Primary MBS item changes
.
              MOVE        SP10,KEY8
              MOVE        EFDAT[CNTITEM],KEY8
              PACK        TMEFFD,KEY8,SP70
              MATCH       SP10,TMEFFD
              IF          !@EQUAL
                PACK      KEY10,TSESSION,SDATE
                CALL      RDTEMP2
                IF        OVRCD=1
                  MOVE      TSESSION,TMSESS
                  MOVE      SDATE,TMDATE
                  MOVE      EFDAT[CNTITEM],TMEFFD
                  CALL      WRTEMP2
                ENDIF
              ENDIF
.
            ENDIF
WTEMP900    ADD       ONE,CNTITEM
          DO
.
WTEMP999  RETURN
+
.------------------------------------------------------------
.     Clear variables for tempfile 
.------------------------------------------------------------
CLREC000  UNPACK    SP70,TSESSION,SDATE,DXAMT,DXMBS,MMSCGRP,UNIQUEX
          UNPACK    SP70,MCHARGE,MDESC
          UNPACK    SP70,PNAME,TRECEIPT
          UNPACK    SP70,IBAND1,IBAND2,IBAND3,IBAND4,IBAND5,IBAND6,IBAND7,IBAND8
          UNPACK    SP70,IBAND9,IBAND10,IBAND11,IBAND12:
                         IBAND13,IBAND14,IBAND15,IBAND16
          UNPACK    SP70,PTMCKREB,PTCTEPSD,PTMCGSTC
          MOVE      ZERO,PTMCGSTA
          MOVE      ZERO,MINDIC
          MOVE      ZERO,ATRANNO
          MOVE      ZERO,MULTNUM
          MOVE      ZERO,MITMTYP
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TPATAMTG
          MOVE      ZERO,TREBATE
          MOVE      ZERO,KEYFLAG
          MOVE      ONE,MNINV
          MOVE      ZERO,MBSFLAG
          MOVE      ZERO,IAMT
          MOVE      ZERO,PCENFLG
          MOVE      ZERO,XAMT
          MOVE      ZERO,XMBS
          MOVE      SP70,NZMCKPRI
          MOVE      SP70,THEABAND
          UNPACK    SP70,PTMCALGR,NZUNIQUE,NZINCTYP
          UNPACK    SP70,STRTIME,ENDTIME         * MBS Item Start/Finish Time
          UNPACK    SP70,MISCDESC
          MOVE      SP70,NZEXPITM
.
.-------- Eclipse Bulk billing                             *T0859743-start
          UNPACK    SP70,DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,HOSPINDI:
                         NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM
          MOVE      SP70,SERVTEXT
          MOVE      SP70,SUBITEMN
          MOVE      SP70,SETCMGRP
          MOVE      SP70,PMMTIKEY
.--------                                                   *T0859743-end
.
.-------- Eclipse DVAW
.
          MOVE      SP70,DISTAKMS
.
.-------- 
.
CLREC999  RETURN
+
.------------------------------------------------------------
.  Check for valid MBS item number
.------------------------------------------------------------
CHKITM00  MOVE      "0",NZEXPITM
          MATCH     SP70,MCHARGE
          GOTO      CHKITM90 IF EQUAL
.
          MOVE      MCHARGE,SMCHARGE
.
          MOVE      ZERO,MBSFLAG
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TREBATE
          MOVE      SP70,THEABAND
.
. **** nzprivate don't add mbs items through here ***
.
          IF        CFEETYP=5
            GOTO      CHKITM60
          ENDIF
.
          PACK      KEY17,MCHARGE,WKITDATE,SP70
          CALL      PATITMRD                 * check if key is valid
          IF        OVRCD=1
            IF        CMIXFLAG=1
              CALL      CASMIX00    * Casemix Stuff 1=Check M/C 2=Valid DRG
              BRANCH    CASEFLAG,CHKITM30
            ENDIF
            GOTO      CHKITM60    * check if it's a valid misc.item
          ENDIF
.
          CALL      CEVT0000                * Check for Events
          MATCH     "1",KEY1
          GOTO      CHKITM10 IF EQUAL       * Emergency event
.
          COMPARE   ONE,PVITYPE
          GOTO      CHKITM20 IF NOT EQUAL   * Not emergency patient
.
CHKITM10  PACK      KEY29,ACLAIM,AFUNDH,AFNDTB,ACLSS,MCHARGE
          CALL      RDAEMCH1
          IF        OVRCD=1
            PACK      KEY29,ACLAIM,SP6,SP8,ACLSS,MCHARGE
            CALL      RDAEMCH1
            IF        OVRCD=1
              PACK      KEY29,ZERO,SP2,SP6,SP8,ACLSS,MCHARGE
              CALL      RDAEMCH1
              BRANCH    OVRCD,CHKITM60
            ENDIF
          ENDIF
          MOVE      AEMCPAT,TPATAMTP
          MOVE      AEMCREB,TREBATE
.
CHKITM20  MOVE      ONE,MBSFLAG
          MOVE      IDESC,MDESC
          MOVE      ZERO,MINDIC             * MBS descriptions fixed
          MOVE      TWO,MITMTYP             * Theatre Fee
          MOVE      IMISGRP,MMSCGRP
          MOVE      PTITGSTA,PTMCGSTA
          MOVE      PTITGSTC,PTMCGSTC
          MOVE      "N",PTMCKREB            * do not keyin portions
.
          COMPARE   THREE,PVITYPE
          GOTO      CHKITM50 IF NOT EQUAL
          MOVE      MCHARGE,ITEMCODE
.
          OPEN      PATDTRA1,"patdtraf"
          MOVE      ZERO,TFHF1         * Zero health fund portion
          MOVE      ZERO,TFPAT1        * use MBS amount for patient portion
          MOVE      ONE,TFNINV         * default number of invoice to on
.
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      CHKITM30 IF EQUAL
          ELSE
            BRANCH    PTCNTFEE,CHKITM30    * using theatre fees file
          ENDIF
.
          MATCH     "1",CMBSFEE
          IF        @EQUAL
            IF        MBSFLAG=1
              MOVE      ZERO,TFHF1         * Zero health fund portion
              MOVE      QIAMT,TFPAT1       * use MBS amount for patient portion
            ENDIF
          ENDIF
          GOTO      CHKITM40
.
CHKITM30  MOVE      WKITDATE,TSRVDATE    * Service Date
          IF        CMIXFLAG = 1
            MOVE      ONE,PTCTITMS       * Default to the first
            PACK      TITEMNO,MCHARGE,SP10
            CALL      CMGETTHR           * Get theatre casemix funding
            IF        OVRCD=1
              CALL      NOCM0000         * no casemix rec so display warning
            ENDIF
            MOVE      ONE,TFNINV
            MOVE      PTCTDREB,TFHF1
            MOVE      PTCTDPAT,TFPAT1
            MOVE      PTCTMBSB,THEABAND
          ELSE
            CALL      GTHR0000           * Get normal theatre charge
          ENDIF
.
          COMPARE   ZERO,OVRCD
          GOTO      CHKITM92 IF NOT EQUAL
.
CHKITM40  MOVE      TFNINV,MNINV
          MOVE      TFPAT1,TPATAMTP
          MOVE      TFHF1,TREBATE
.
CHKITM50  MOVE      TREBATE,TPATAMTT
          ADD       TPATAMTP,TPATAMTT
.
          MOVE      "9999.99",XAMT
          SUB       TPATAMTT,XAMT
          MOVE      "99999",XMBS
          SUB       IAMT,XMBS
          GOTO      CHKITM99
.
CHKITM60  CALL      CHKMSC00          * Try miscellaneous charge
          COMPARE   ZERO,EXIT
          GOTO      CHKITM99 IF EQUAL    
.
          PACK      DIM10,SMCHARGE,SP70
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,CHKITM93
.
          MOVE      TWO,EXIT
          GOTO      CHKITM99
.
CHKITM90  MOVE      "** Invalid Item Code ** ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
CHKITM91  GOTO      CHKITM99
.
CHKITM92  MOVE      "** Theatre Fees not Set Up** ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKITM99
.
CHKITM93  PACK      WEBTITLE,INVICODE,DIM10
.         MOVE      "** Invalid Item Code ** ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKITM99
.
CHKITM99  RETURN
+
.------------------------------------------------------------
.  Check for valid Miscellaneous item number
.------------------------------------------------------------
CHKMSC00  MOVE      ZERO,MBSFLAG
          MOVE      SP70,THEABAND
.
          PACK      MISCDATE,MISCDATE,SP70
          MATCH     SP70,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD,SP70
            REP       " 0",MISCDATE
          ENDIF
.
. Check for this charge in the misc charges file
.
          IF        CFEETYP=5
            MOVE      THREE,MITMTYP
            CALL      GETNZM00
            BRANCH    EXIT,CHKMSC90               * invalid misc.item
.
            MOVE      NZMCCGRP,MMSCGRP
            MATCH     "Y",NZMCKPRI
            GOTO      CHKMSC99 IF EQUAL           * keyin amt, no update
.
            IF        NZMCCHGT=1 & NZMCPATP=0
              MOVE      "1",NZEXPITM              * Pack item
              IF        SUBPACK=1
                 MOVE     "0",NZEXPITM
              ENDIF
              GOTO      CHKMSC99
            ENDIF
            MOVE      NZMCPATP,MPATPOR
            MOVE      NZMCREBP,MHFPOR
          ELSE
.                                           * Read Misc. Charges file
            UNPACK    SP20,PTHFBCAT         * change "H/F Table" to "Table Type"
            PACK      KEY14,AFUNDH,AFNDTB,SP20
            CALL      RDFUND1               * "Table Type code" now in PTHFBCAT
            MOVE      MCHARGE,KEY9          * (MCHARGE re-used in PATMCHRD)
            PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,KEY9,MISCDATE,SP10
.
            CALL      PATMCHRD              * find Miscellaneous Charge Item
            IF        EXIT = 1
              PACK      KEY29,ACLAIM,SP6,SP3,KEY9,MISCDATE,SP10
              CALL      PATMCHRD            * find Miscellaneous Charge Item
              IF        EXIT = 1
                CALL      DCLM0000
                PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,MISCDATE,SP10
                CALL      PATMCHRD          * find Miscellaneous Charge Item
                BRANCH    EXIT,CHKMSC90     * not found or invalid
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ONE,CMIXFLAG
          GOTO      CHKMSC05 IF NOT EQUAL        * Not a casepayment
          COMPARE   ZERO,PTMCCFCY
          GOTO      CHKMSC02 IF EQUAL            * No charge on all items
.
          MOVE      AADMNO,XADMNO
          PACK      KEY17,XADMNO,MCHARGE
          CALL      RDTEMP1
          IF        OVRCD = 1
            MOVE      MCHARGE,XCHARGE
            MOVE      ONE,XMCCNT
            CALL      WRTEMP1
          ELSE
            ADD       ONE,XMCCNT
            CALL      UPTEMP1
          ENDIF
          COMPARE   PTMCCFCY,XMCCNT            * charge from item number ?
          GOTO      CHKMSC02 IF LESS           * no charge
          GOTO      CHKMSC05
.
CHKMSC02  MOVE      ZERO,MPATPOR                 * no charge
          MOVE      ZERO,MHFPOR
.
CHKMSC05  MOVE      MPATPOR,TPATAMTP
          MOVE      MHFPOR,TREBATE
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
.
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      CHKMSC30 IF NOT EQUAL
          ELSE
            COMPARE   ONE,PTCNTFEE
            GOTO      CHKMSC30 IF NOT EQUAL     * not using theatre fees
          ENDIF
          COMPARE   TWO,MITMTYP
          GOTO      CHKMSC30 IF NOT EQUAL     * not a theatre item
.
          MOVE      MPATPOR,TPATAMTT
          MOVE      ZERO,TREBATE
.
.        This is a Theatre Fee code - check in theatre fee file for the charge
.
          MOVE      ZERO,TFHF1         * Zero health fund portion
          MOVE      ZERO,TFPAT1        * use MBS amount for patient portion
          MOVE      ONE,TFNINV         * default number of invoice to on
.
          MOVE      WKITDATE,TSRVDATE  * Service Date
          MOVE      MCHARGE,TITEMNO
          IF        CMIXFLAG = 1
            MOVE      ONE,PTCTITMS       * Default to the first
            CALL      CMGETTHR           * Get theatre casemix funding
            MOVE      ONE,TFNINV
            MOVE      PTCTDREB,TFHF1
            MOVE      PTCTDPAT,TFPAT1
            MOVE      PTCTMBSB,THEABAND
          ELSE
            CALL      GTHR0000           * Get normal theatre charge
          ENDIF
          BRANCH    NOFEE,CHKMSC90       * invalid item
.
          COMPARE   TFHF1,TPATAMTT
          GOTO      CHKMSC20 IF NOT LESS
.
          MOVE      TPATAMTT,TFHF1
.
CHKMSC20  MOVE      TFHF1,TREBATE
.
.      Calculate real patient portion = patient portion - rebate
.
          MOVE      TPATAMTT,TPATAMTP
          SUB       TREBATE,TPATAMTP
          MOVE      ZERO,EXIT
          GOTO      CHKMSC99
.
.        Not a theatre fee, so use the amounts on the misc charges record
.
CHKMSC30  MOVE      MPATPOR,TPATAMTP
          MOVE      MHFPOR,TREBATE
.
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MOVE      ZERO,EXIT
          GOTO      CHKMSC99
.
CHKMSC90  MOVE      ONE,EXIT
          GOTO      CHKMSC99
.
CHKMSC99  RETURN
+
.------------------------------------------------------------
. Add Warning Messages
.------------------------------------------------------------
ADDWRN00  IF        WARNINGC<20
            ADD       ONE,WARNINGC
            MOVE      WARNINGL,WARNINGM[WARNINGC]
          ENDIF
ADDWRN99  RETURN
.
.------------------------------------------------------------
. Add Procedure Item
.------------------------------------------------------------
PROC0000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PROC9200
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP10,ADMISSNO
          GOTO      PROC8000 IF EQUAL
.
          MOVE      ZERO,TRNFLAG
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PROC9100
.
          CALL      CEVT0000                 * Check for Events
          MATCH     "1",KEY1
          GOTO      PROC4000 IF EQUAL        * Emergency event
.
          CALL      RDEMVIS1                 * Check for emergency visit
          BRANCH    OVRCD,PROC9100  
          MOVE      ONE,TRNFLAG
.
PROC4000  CALL      CKDT0000                 * Check procedure date range
          BRANCH    EXIT,PROC9999
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      PROC8000 IF EQUAL
          MATCH     ANSA,UPDATETY
          GOTO      PROC6000 IF EQUAL      * Add items
          GOTO      PROC9000
.
.         Add Procedure Items
.
PROC6000  CALL      ADDPRC00
          BRANCH    EXIT,PROC9999
.
          CALL      UHIS0000               * Write to history file
          CALL      WEDV0000               * EDWARD ED visit alteration
.
PROC6800  MOVE      ZERO,EXIT
          GOTO      PROC9999
.
PROC8000  MOVE      ZERO,F2
          MOVE      ZERO,LASTITEM
.
          MOVE      "Input Procedure items",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create output & write HTML Header
          BRANCH    EXIT,PROC9000
.
          CALL      WEBBOD00                * Process Web body
          CALL      WEBEND00                * Process end of HTML file
          MOVE      ONE,EXIT
          GOTO      PROC9999
.
PROC9000  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROC9999
.
PROC9100  CLEAR     WEBTITLE
          APPEND    "Invalid Visit Number - ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROC9999
.
PROC9200  MOVE      "Patient is not Registered.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PROC9999
.
PROC9999  RETURN
+
.------------------------------------------------------------
.         Update EMR History file for the doctor
.------------------------------------------------------------
UHIS0000  MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1                 * Check for emergency visit
          BRANCH    OVRCD,UHIS9999
.
          MOVE      DEMVIADM,EMHIVIS
          PACK      KEY32,EMHIVIS,SDOCCODE,Z70
          CALL      RSEMHIS2
UHIS1000  CALL      RPEMHIS2
          BRANCH    OVRCD,UHIS2000
          MATCH     EMHIVIS,DEMVIADM
          GOTO      UHIS2000 IF NOT EQUAL
          MATCH     EMHIDOC,SDOCCODE         * same doctor?
          GOTO      UHIS2000 IF NOT EQUAL
.
          MATCH     "ALDOC",EMHIUPT
          GOTO      UHIS1000 IF NOT EQUAL    * Not allocated doctor type
.
          MOVE      DRBILCHR,EMHIDRBC        * Dr Bill Complete/No Charge
          CALL      UPEMHIS2
          GOTO      UHIS1000
.
UHIS2000  PROC      EMRDRCHR               * Update Dr Billing complete
.
UHIS9999  RETURN
+
.------------------------------------------------------------
. Check date for Sundry charges
.------------------------------------------------------------
CHDT0000  MATCH     SP70,PROCDATE        * Item date
          GOTO      CHDT9999 IF EQUAL
.
          MATCH     EMVIDATE,PROCDATE    * check arrival date
          IF        @LESS
            GOTO      CHDT9000
          ENDIF
.
          COMPARE   THREE,EMVISTAT       * Discharged complete
          GOTO      CHDT9999 IF NOT EQUAL
.
          MATCH     SP70,EMVIDDAT
          GOTO      CHDT9999 IF EQUAL
.
          MATCH     PROCDATE,EMVIDDAT    * check discharge date
          IF        @LESS
            GOTO      CHDT9100
          ENDIF
          GOTO      CHDT9999
.
CHDT9000  UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE               * Format the MBS date
          REP       " 0",CPCDATE
          CLEAR     WEBTITLE
          APPEND    "Date must be after ",WEBTITLE
          APPEND    "Visit date - ",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHDT9999
.
CHDT9100  UNPACK    EMVIDDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE               * Format the MBS date
          REP       " 0",CPCDATE
          CLEAR     WEBTITLE
          APPEND    "Date must be before ",WEBTITLE
          APPEND    "discharge date - ",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHDT9999
.
CHDT9999  RETURN
+
.------------------------------------------------------------
. Check procedure date range before saving procedure details
.------------------------------------------------------------
CKDT0000  MATCH     SP70,PROCDATE                * Procedure date
          GOTO      CKDT9999 IF EQUAL
.
          MATCH     SP70,PROCTIME                * Procedure time
          GOTO      CKDT9999 IF EQUAL
.
          PACK      SAVKEY16,PROCDATE,PROCTIME,SP70
          REP       ":0",SAVKEY16
.
          BRANCH    TRNFLAG,CKDT4000             * check emergency visit
.
          MATCH     PROCDATE,PMEVADTE            * check attendance date
          GOTO      CKDT9300 IF NOT EQUAL
.
          GOTO      CKDT9999
.
CKDT4000  PACK      KEY16,EMVIDATE,EMVITIME,SP70
          REP       ":0",KEY16
.
          MATCH     SP70,KEY16
          GOTO      CKDT9200 IF EQUAL            * Visit date/time mandatory
.
          MATCH     SAVKEY16,KEY16    * check arrival date/time
          IF        !@LESS
            GOTO      CKDT9000
          ENDIF
.
          COMPARE   THREE,EMVISTAT    * Discharged complete
          GOTO      CKDT9999 IF NOT EQUAL
.
          PACK      KEY16,EMVIDDAT,EMVIDTIM,SP70 * discharge date/time
          MATCH     SP70,KEY16
          GOTO      CKDT9999 IF EQUAL
          REP       ":0",KEY16
.
          MATCH     KEY16,SAVKEY16    * check discharge date/time
          IF        !@LESS
            GOTO      CKDT9100
          ENDIF
          GOTO      CKDT9999
.
CKDT9000  UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE               * Format the MBS date
          REP       " 0",CPCDATE
          CLEAR     WEBTITLE
          APPEND    "Procedure date/time must be after ",WEBTITLE
          APPEND    "Visit date/time",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    EMVITIME,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDT9999
.
CKDT9100  UNPACK    EMVIDDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE               * Format the MBS date
          REP       " 0",CPCDATE
          CLEAR     WEBTITLE
          APPEND    "Procedure date/time must be before ",WEBTITLE
          APPEND    "discharge date/time",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    EMVIDTIM,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDT9999
.
CKDT9200  CLEAR     WEBTITLE
          APPEND    "Patient must have a traige date/time ",WEBTITLE
          APPEND    "before adding procedures",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDT9999
.
CKDT9300  UNPACK    PMEVADTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE               * Format the MBS date
          REP       " 0",CPCDATE
          CLEAR     WEBTITLE
          APPEND   "Procedure date must be same as Event ",WEBTITLE
          APPEND   "Attendance date : ",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDT9999
.
CKDT9999  RETURN
+
.------------------------------------------------------------
.  Add procedure  items
.------------------------------------------------------------
ADDPRC00  MATCH     "1",EBSMINDC
          IF        @EQUAL
            CALL      ADDSUN00
            BRANCH    EXIT,ADDPRC99
          ENDIF
.
          MOVE      ZERO,MTIFLAG
          MOVE      ONE,CNTITEM
          MOVE      SP70,PMMIITEM
          WHILE     CNTITEM<=500
            MOVE      PROCI[CNTITEM],MCHARGE
            MATCH     SP9,MCHARGE
            IF        !@EQUAL
.             IF    SCHDF[CNTITEM]=REVWAMNT
.               MOVE    "RV ",KEY3
.               CALL    GSB30000
.               MATCH   SP70,KEY3
.               GOTO    ADDPRC15 IF EQUAL
.             ELSE
.               MOVE      SITEM[CNTITEM],KEY3
.               CALL      GSUB0000                 * Get the sub item
.               CALL      CHKPTM00
.               BRANCH    EXIT,ADDPRC99
.             ENDIF
.
              IF    SCHDF[CNTITEM]=REVWAMNT
                MOVE    "RV ",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC15 IF EQUAL
                GOTO    ADDPRC05
              ENDIF
.
              IF    SCHDF[CNTITEM]=STFOUTOH  
                MOVE    "O  ",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC15 IF EQUAL
                GOTO    ADDPRC05
              ENDIF
.
              IF    SCHDF[CNTITEM]=CHEMOCRD
                MOVE    "C  ",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC15 IF EQUAL
                GOTO    ADDPRC05
              ENDIF
.
              IF    SCHDF[CNTITEM]=SUBITDVA
                MOVE    "DVA",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC15 IF EQUAL
                GOTO    ADDPRC05
              ENDIF
.
              IF    SCHDF[CNTITEM]=SUBITDVF
                MOVE    "DVF",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC15 IF EQUAL
                GOTO    ADDPRC05
              ENDIF              
.
              IF    SCHDF[CNTITEM]=RECMPAMT
.
                MATCH   SP70,EMVICOMP
                IF      !@EQUAL & !@EOS 
                  MOVE      SP70,KEY3
                  CALL      GSUB0000                 * Get the sub item
                  CALL      CHKPTM00
                  BRANCH    EXIT,ADDPRC99
.
                  MATCH     SP70,KEY3
                  GOTO      ADDPRC05 IF NOT EQUAL
                ENDIF
.
                MOVE    "RV ",KEY3
                CALL    GSB30000
                MATCH   SP70,KEY3
                GOTO    ADDPRC03 IF EQUAL
                GOTO    ADDPRC05
              ENDIF
.
              MOVE      SITEM[CNTITEM],KEY3
ADDPRC03      CALL      GSUB0000                 * Get the sub item
              CALL      CHKPTM00
              BRANCH    EXIT,ADDPRC99
.
ADDPRC05      MOVE      KEY3,PMMISUBN
              MOVE      DOCTN[CNTITEM],PMMIEDAD
.
              MATCH     "1",DOCCHGIN
              IF        !@EQUAL
                CALL      GTDCHS00
              ENDIF
.
              MOVE      PQUAN[CNTITEM],PMMISERV
.
              MOVE      PRITSFEE,PMMIAMTT
              MOVE      SCHDF[CNTITEM],PMMISCHF
              MOVE      SP70,PMMIITYP
              MATCH     ANSM,ITYPE[CNTITEM]
              IF        @EQUAL
                MOVE      "0",PMMIITYP
              ENDIF
              MATCH     ANSA,ITYPE[CNTITEM]
              IF        @EQUAL
                MOVE      "1",PMMIITYP
              ENDIF
.
              MOVE      ZERO,F1
              MOVE      PRITKEYI,F1
              IF        PRITFIXD=1
                MOVE      ZERO,F1    * Fixed item, no keyin amount
              ENDIF
              IF          F1=1
                MOVE      PAMNT[CNTITEM],PMMIAMTT    * use the keyin amount
                MOVE      PAMNT[CNTITEM],PMMIAMTP
                MOVE      ZERO,PMMIRBAT
                CALL      WMTI0000                  * Write to pmsmtiaf
                CALL      WVCD0000                  * Write to emrvcdaf
                GOTO      ADDPRC15
              ENDIF
.
              IF        SCHDF[CNTITEM]=P85PERCT
                MOVE      PRITSF85,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P75PERCT
                MOVE      PRITSF75,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
..... JH Added 29/5/09 for CAR 197848
              IF        SCHDF[CNTITEM]=P25PERCT
                MOVE      PRITSF85,PMMIAMTT
                ASSIGN    (PRITSF85*.25),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P50PERCT
                MOVE      PRITSF85,PMMIAMTT
                ASSIGN    (PRITSF85*.50),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P50EDPCT
                MOVE      PRITSFEE,PMMIAMTT
                ASSIGN    (PRITSFEE*.50),PMMIAMTT     * ED billing next invoice
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P65PERCT
                MOVE      PRITSF85,PMMIAMTT
                ASSIGN    (PRITSF85*.65),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P43PERCT
                MOVE      PRITSF85,PMMIAMTT
                ASSIGN    (PRITSF85*.43),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P135PERC
                ASSIGN    (PMMIAMTT*1.35),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=P140PERC
                ASSIGN    (PMMIAMTT*1.40),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
..... End JH Added 29/5/09 for CAR 197848
              IF        SCHDF[CNTITEM]=AMAFAMNT
                MOVE       PRITSAFE,PMMIAMTT
                GOTO       ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=REVWAMNT
                MOVE      PRITSAFE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=ZEROAMNT
                MOVE      ZERO,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = A50PERCT
                MOVE      PRITSAFE,PMMIAMTT
                ASSIGN    (PRITSAFE*.50),PMMIAMTT
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = B25PERCT
                MOVE      PRITSAFE,PMMIAMTT
                ASSIGN    (PRITSAFE*.25),PMMIAMTT     * HEC
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = B55PERCT
                MOVE      PRITSAFE,PMMIAMTT
                ASSIGN    (PRITSAFE*.50),PMMIAMTT     * HEC
                CALL      GRND0000
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PCONSFEE
                MOVE      "CF       ",KEY9
                CALL      GAMMB000
                ASSIGN    (PRITSFEE+FORM12P2),PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PCONSFEC
                MOVE      "CFD      ",KEY9
                CALL      GAMMB000
                ASSIGN    (PRITSFEE+FORM12P2),PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PMDOFEEX
                MOVE      "MDO      ",KEY9
                CALL      GAMMB000
                ASSIGN    (PRITSFEE+FORM12P2),PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PMEDSFEE
                MULT      ONE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PREVSFEE
                MULT      ONE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM] = PWCVRFEE
                MULT      ONE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=STFOUTOH
                MOVE      PRITSFEE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=CHEMOCRD
                MOVE      PRITSFEE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF    SCHDF[CNTITEM]=SUBITDVA
                MOVE      PRITSFEE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF    SCHDF[CNTITEM]=SUBITDVF
                MOVE      PRITSFEE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              IF        SCHDF[CNTITEM]=NOITEMXX
                GOTO      ADDPRC15
              ENDIF
.
              IF        SCHDF[CNTITEM]=RECMPAMT
                MOVE      PRITSAFE,PMMIAMTT
                GOTO      ADDPRC10
              ENDIF

.
              IF        SCHDF[CNTITEM]=MMDOAMNT
                ASSIGN    ((HUNDRED*2)+PRITSAFE),PMMIAMTT
                GOTO      ADDPRC10
              ENDIF
.
              MULT      SCHDF[CNTITEM],PMMIAMTT
.
ADDPRC10      MOVE      PRITSF85,PMMIRBAT       * 85% Rebate portion (Cab)
              MOVE      PMMIAMTT,PMMIAMTP
              IF        PMMIRBAT>PMMIAMTT
                MOVE      PMMIAMTT,PMMIRBAT
              ENDIF
              SUB       PMMIRBAT,PMMIAMTP
              IF        PMMIAMTT=0 & PMMIAMTP=0
                MOVE      PAMNT[CNTITEM],PMMIAMTT
                MOVE      PAMNT[CNTITEM],PMMIAMTP
              ENDIF
.
.         If parameter for displaying Out of Pocket is turned on, then
.         for Multiple quantity procedures... write each item in pmsmtiaf file
.             
              MATCH     "1",EMCNDPOC
              IF        @EQUAL
                IF        PMMISERV>1
                  CALL      MLTP0000              * Write to pmsmtiaf
                  GOTO      ADDPRC15
                ENDIF
              ENDIF
.
              CALL      WMTI0000                  * Write to pmsmtiaf
              CALL      WVCD0000                  * Write to emrvcdaf
	    ENDIF
.
ADDPRC15    ADD       ONE,CNTITEM
          DO
.
          MATCH     "1",EMBLINDC
          IF         @EQUAL
            PACK       KEY8,ADMISSNO,SP70
            CALL       RDEMVIS1
            IF         OVRCD=0
              MOVE       EMVIS094,EMVIYN04
              CALL       UPEMVIS1
            ENDIF
          ENDIF
.
          CALL      NOCH0000                  * Check No charge Misc.Item
.
          MOVE      ZERO,EXIT
.
ADDPRC99  RETURN
+
.------------------------------------------------------------
.         No Charge Item
.------------------------------------------------------------
NOCH0000  MATCH     SP70,NOCHARGE
          GOTO      NOCH9999 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,NOCH9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,NOCH9999
.
          CALL      RDPMVX11
          BRANCH    OVRCD,NOCH9999
.
          IF        IBCNMHOS=1
            MOVE      SP1,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1                * get default Claim for a hospital
          ENDIF
.
          PACK      MCHARGE,NOCHARGE,SP70
          CALL      GETMCD00                * Get description of NOCHARGE item
          BRANCH    EXIT,NOCH9999
.
          MOVE      ZERO,PMMIAMTT
          MOVE      ZERO,PMMIRBAT
          MOVE      ZERO,PMMIAMTP
          MOVE      PROCDATE,PMMITDAT
          UNPACK    PROCDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,TFCENT
          MOVE      XYEAR,TFYEAR
          MOVE      XMON,TFMONTH
          MOVE      XDAY,TFDAY
          MOVE      SP70,TRECEIPT
          MOVE      ONE,MULTNUM
          UNPACK    SP70,PMMIREFN,PMMISESS,PMMIMBCH,PMMICNTR
          CALL      UPDP0000                * Write Charge
.
NOCH9999  RETURN
+
.------------------------------------------------------------
.         Get the subitem for compensable patient
.------------------------------------------------------------
GSUB0000  MATCH     "1",GETCLCOD
          GOTO      GSUB9999 IF NOT EQUAL
.
.         Get the first char of sub item for the compensable patient
.
          CALL      COMP0000               * Check for compensable patient
          BRANCH    EXIT,GSUB9999
.
          PACK      KEY3,KEY1,SP70
          CALL      GSB20000
.
GSUB9999  RETURN
+
.------------------------------------------------------------
.         Check for Compensable patient
.------------------------------------------------------------
COMP0000  MATCH     SP70,EMVICOMP
          GOTO      COMP9000 IF EQUAL 
.
          MOVE      SP1,KEY1
          PACK      KEY5 WITH CODECL,EMVICOMP
          CALL      RDCODE1
          BRANCH    OVRCD OF COMP9000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
COMP1000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      COMP9000 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      COMP2000 IF EQUAL
.
          CMATCH    "M",ANS
          GOTO      COMP2000 IF EQUAL
.
          CMATCH    "V",ANS
          GOTO      COMP2000 IF EQUAL
.
          GOTO      COMP1000
.
.         We have a claim
.
COMP2000  MOVE      ANS,KEY1
          MOVE      ZERO,EXIT
          GOTO      COMP9999
.
COMP9000  MOVE      ONE,EXIT
COMP9999  RETURN
+
.------------------------------------------------------------
.      validate item
.------------------------------------------------------------
CHKPTM00  MOVE      ZERO,EXIT
.         MOVE      SITEM[CNTITEM],KEY3
          MOVE      ITYPE[CNTITEM],ITEMTYPE
.
          MATCH     ANSM,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ZERO
          ENDIF
          MATCH     ANSA,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ONE
          ENDIF
.
          MOVE      ZERO,FORM2
          PACK      KEY22,DIM2,MCHARGE,KEY3,Z70
          CALL      RSPRIT1                      * position after last record
.                                                  for this item
CHKPTM10  CALL      RPPRIT1                      * read previous record
          BRANCH    OVRCD,CHKPTM90               * end of file
.
          SQUEEZE   DIM2
          MOVE      DIM2,FORM2
          COMPARE   FORM2,PRITFLAG               * same item type ?
          GOTO      CHKPTM90 IF NOT EQUAL        * no
.
          MATCH     MCHARGE,PRITITMN             * same item number ?
          GOTO      CHKPTM90 IF NOT EQUAL        * no
.
          MATCH     SP70,KEY3
          IF        !@EQUAL
            MATCH     KEY3,PRITSUBN              * same subitem number ?
            GOTO      CHKPTM90 IF NOT EQUAL      * no
          ENDIF
.
          MATCH     PRITDAT1,PROCDATE            * item date > service date ?
          GOTO      CHKPTM10 IF LESS             * yes
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     PROCDATE,PRITDAT2
            GOTO      CHKPTM10 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
          GOTO      CHKPTM99
.
CHKPTM90  PACK      WEBTITLE,INVICODE,MCHARGE
          CALL      WEBERR00
          MOVE      ONE,EXIT
CHKPTM99  RETURN
+
.-----------------------------------------------------------------------------
.         Write Procedure to pmsmtiaf for Procedure with multiple quantity 
.-----------------------------------------------------------------------------
MLTP0000  MOVE      ONE,ROWCOUNT
          MOVE      PMMISERV,FORM5
.
          WHILE     ROWCOUNT<=FORM5
            MOVE      ONE,PMMISERV
            CALL      WMTI0000              * Write procedure to pmsmtiaf
            CALL      WVCD0000              * Write to emrvcdaf
            ADD       ONE,ROWCOUNT
            MOVE      ONE,MTIFLAG
          DO
MLTP9999  RETURN
+
.------------------------------------------------------------
.         Write Procedure to pmsmtiaf record
.------------------------------------------------------------
WMTI0000  BRANCH    MTIFLAG,WMTI0200
.
.         Check if item to be charged after invoice had been raised
.
          CALL      EINV0000
WMTI0200  BRANCH    INVCFLAG,WMTI9999        * No invoice pending amount
.
          MOVE      PVIBILL,PMMIVISN
          MOVE      PVIBILL,KEY8
.
WMTI1000  CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      WMTI1000 IF EQUAL
.         
          MOVE      PVIURNO,PMMIURNO
          MOVE      " 1",PMMISYST
          MOVE      MCHARGE,PMMIITEM
          MOVE      PRITSUBN,PMMISUBN
.
          CLEAR     PMMIDESC
          STRIP     PRITDESC
          APPEND    PRITDESC,PMMIDESC
.
          IF        SCHDF[CNTITEM] = PMEDSFEE
            APPEND    " Medicare",PMMIDESC
          ENDIF
.
          IF        SCHDF[CNTITEM] = PREVSFEE
            APPEND    " Review",PMMIDESC
          ENDIF
.
          IF        SCHDF[CNTITEM] = PWCVRFEE
            APPEND    " Work Cover",PMMIDESC
          ENDIF
.
          RESET     PMMIDESC
.
          MOVE      PRITSETC,PMMIMGRP
          MOVE      SP70,PMMIDES2
          MOVE      PROCDATE,PMMITDAT
          REP       " 0",PMMITDAT
          MOVE      "8",PMMIRTYP
          MOVE      SP70,PMMIREFN       * Reference no
.
          MOVE      SP70,PMMIBTCH
          MOVE      ONE,PMMIINVN
          MOVE      ZERO,PMMIAMTH
          MOVE      PROCTIME,PMMISVTM
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          IF        PMMISERV>1
            MULT      PMMISERV,PMMIAMTT
          ELSE
            MOVE      ONE,PMMISERV
          ENDIF
.
          MOVE      ONE,PMMIINVN
          MOVE      PRITGSTA,PMMIGSTA         * GST applicable
          MOVE      PRITGSTC,PMMIGSTC         * GST code
          MOVE      ZERO,PMMIGSTM
.
          MOVE      USERID,PMMIWUSR          * WEB user id
          MOVE      "0",PMMIMVBR             * Mechanical ventilation billing
          UNPACK    SP70,PMMIODOC,PMMITDOC,PMMISESS,PMMIBTCH
          PACK      PMMIUNIQ,SP70
          UNPACK    SP70,PMMICNTR,PMMISUNQ,PMMIINCT
          UNPACK    SP70,PMMICCON
.
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR        * WEB user id
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      REBAREAS,PMMIRBRS
          MOVE      SP70,PMMICTYP
.
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
.
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
          MOVE      PRITPDTI,PMMIINCT       * Flag for print date/time proc.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      WRPMMTI1
.
          BRANCH    MTIFLAG,WMTI9999
.
.  Add a new entry,the Invoices Pending file if there not already there.
.
          IF        PTCNIPEN=0
            CALL      CUIP0000              * Check Inv.pending update flag
.
            MOVE      PVIBILL,IPADMNO
            MOVE      "1",IPSYSTM            * Set to Emergency system
            MOVE      PVISITE,IPSITE
.
            MOVE      SP70,PENDHOSP
            IF        IBCNMHOS=1
              PACK      KEY8,IPADMNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
              ENDIF
            ENDIF
            MOVE      " 1",PENDSYST                 * Emergency
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RDEMVIS1
            IF        OVRCD<>1
              MOVE      EMVIDATE,PENDSDAT        * as at date
              MOVE      EMVIDATE,PENDADAT        * visit date
              MOVE      SP70,PENDDDAT
              IF        EMVISTAT=2 | EMVISTAT=3
                MOVE      EMVIDDAT,PENDDDAT      * discharged date
              ENDIF
              MOVE      EMVIFUND,PENDFUND
              MOVE      EMVICOMP,PENDCLAM
              CALL      IPRH0000
            ENDIF
            MOVE      SEVEN,PTIPRSTA
            MOVE      SP70,PTIPSVAR
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RAIPEN1
            IF        OVRCD=1
              CALL      WRIPEN1
            ELSE
              MATCH     SP70,KEY83
              IF        !@EQUAL
                UNPACK    KEY83,PTIPRHLD,PTIPRDES  * restore reason on hold inv.
              ENDIF
              CALL      UPIPEN1
            ENDIF
          ENDIF
          MOVE      ZERO,EXIT
.
WMTI9999  RETURN
+
.--------------------------------------------------------------------------
.         Check Update invoice pending flag
.         UPDTIPEN=0  Update Inv.pending with the previous Reason on hold
.         UPDTIPEN=1  Update Inv.pending with the HF/Claim Reason on hold
.--------------------------------------------------------------------------
CUIP0000  PACK      KEY83,SP70,SP70
          MOVE      PVIBILL,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,CUIP9999
.
          MATCH     SP70,PTIPRHLD
          GOTO      CUIP9999 IF EQUAL     * Inv.currently not on hold
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,CUIP9999
.
          MATCH     "P",TCINDC2
          GOTO      CUIP8000 IF EQUAL
.
          MATCH     "C",TCINDC4
          GOTO      CUIP9999 IF NOT EQUAL         * CodeFocus hold invoice
.
CUIP8000  PACK      KEY83,PTIPRHLD,PTIPRDES,SP70 * save pat.reason on hold inv.
.
CUIP9999  RETURN
+
.------------------------------------------------------------
.         Write to emrvcdaf file
.------------------------------------------------------------
WVCD0000  MOVE      PVIBILL,EMVCVIST         * Visit Number
          MOVE      ONE,FORM3
          PACK      KEY14,EMVCVIST,ZERO,ZERO,FOUR,Z70
          CALL      RSEMVCD1
          CALL      RPEMVCD1
          BRANCH    OVRCD,WVCD5090
.
          MOVE      PVIBILL,KEY8
          MATCH     KEY8,EMVCVIST             * same visit number?
          GOTO      WVCD5090 IF NOT EQUAL
          MATCH     "004",EMVCTYPE            * same procedure coding type?
          GOTO      WVCD5090 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          MOVE      EMVCUNIQ,FORM3
          ADD       ONE,FORM3
          GOTO      WVCD6000
.
WVCD5090  MOVE      "000",EMVCSEQU 
          GOTO      WVCD6005
.
WVCD6000  MOVE      "001",EMVCSEQU           * Sequencing
WVCD6005  MOVE      PVIBILL,EMVCVIST 
          MOVE      FORM3,EMVCUNIQ           * unique record number
          REP       " 0",EMVCUNIQ
.
          MOVE      "004",EMVCTYPE           * Coding Type 
          MOVE      "6",EMVCCSYS             * Coding System
          MOVE      MCHARGE,EMVCMNCD         * Main Code
          MOVE      PRITSUBN,EMVCSUBN        * Sub Item Number
          MOVE      PMMIEDAD,EMVCEDAD        * Attending Doctor
.
          MOVE      PROCDATE,EMVCDATE            * Date
          MOVE      PROCTIME,EMVCTIME            * Time
          MOVE      SP70,EMVCUDC1            * User Defined Code 1
          MOVE      SP70,EMVCUDC2            * User Defined Code 2
          MOVE      SP70,EMVCUDC3            * User Defined Code 3
          MOVE      SP70,EMVCUDC4            * User Defined Code 4
          MOVE      SP70,EMVCUDR1            * User Defined Reference 1
          MOVE      SP70,EMVCUDR2            * User Defined Reference 2
          MOVE      SP70,EMVCUYN1            * User Defined Y/N 1
          MOVE      SP70,EMVCUYN2            * User Defined Y/N 2
          MOVE      SP70,EMVCUYN3            * User Defined Y/N 3
          MOVE      SP70,EMVCUYN4            * User Defined Y/N 4
          MOVE      SCHDF[CNTITEM],EMVCUDA1  * User Defined Amount 1
          MOVE      ZERO,EMVCUDA2            * User Defined Amount 2
          MOVE      ZERO,EMVCUDA3            * User Defined Amount 3
          MOVE      ZERO,EMVCUDA4            * User Defined Amount 4
          MOVE      SP70,EMVCUDD1            * User Defined Date 1
          MOVE      SP70,EMVCUDD2            * User Defined Date 2
          MOVE      SP70,EMVCUDD3            * User Defined Date 3
          MOVE      SP70,EMVCUDD4            * User Defined Date 4
          MOVE      SP70,EMVCUDT1            * User Defined Time 1
          MOVE      SP70,EMVCUDT2            * User Defined Time 2
          MOVE      SP70,EMVCUDT3            * User Defined Time 3
          MOVE      SP70,EMVCUDT4            * User Defined Time 4
          MOVE      SP70,EMVCEFLG            * Send in Extract Flag
.
          CALL      IBACLOCK
          PACK      EMVCLUDT,CCC,CYY,CMM,CDD  * Last update date
          REP       " 0",EMVCLUDT
          PACK      EMVCLUTM,CTIMEIS          * last update time
          PACK      EMVCCDAT,CCC,CYY,CMM,CDD  * date created
          REP       " 0",EMVCCDAT
          PACK      EMVCCTIM,CTIMEIS         * time created
.
          MOVE      USERID,EMVCWUSR          * Last Update Web User
          MOVE      USERID,EMVCCUID          * WEB User ID Created (websecaf)
.
          MOVE      SP70,EMVCDELE            * Delete Flag 1=Deleted
          MOVE      SP70,EMVCFTXT            * Free format text
          MOVE      SP70,EMVCSPAR            * Spare
.
          PACK      KEY14,EMVCVIST,EMVCTYPE,EMVCUNIQ,SP70
          CALL      RAEMVCD1
          IF        OVRCD=0
            MOVE      ZERO,FORM3
            MOVE      EMVCUNIQ,FORM3
            ADD       ONE,FORM3
            GOTO      WVCD6000
          ENDIF
          CALL      WREMVCD1
WVCD9999  RETURN
+
.------------------------------------------------------------
. Check Casemix Stuff
.------------------------------------------------------------
CASMIX00  MOVE      SP10,KEY5
          UNPACK    KEY9,KEY4,KEY5
          MATCH     SP5,KEY5
          GOTO      CASMIX90 IF NOT EQUAL   * Not a DRG code
.
          OPEN      PATDGWA1,"patdgwaf"
          MOVE      "999",KEY3
          PACK      KEY7,KEY4,KEY3,SP10     * last DRG version        *I-137125
          CALL      RSPTDGW1   
          CALL      RPPTDGW1           * Valid DRG code ?             *C-137125
          CLOSE     PATDGWA1
          BRANCH    OVRCD,CASMIX90     * It might be a valid misc charge
          MATCH     PTDWDRGC,KEY4      * same DRG code ?              *I-137125
          GOTO      CASMIX90 IF NOT EQUAL                             *I-137125
.
          MOVE      KEY9,MCHARGE
          MOVE      TWO,MBSFLAG        * DRG code
          MOVE      PTDWDESC,MDESC
          MOVE      ZERO,MINDIC        * MBS description fixed
          MOVE      TWO,MITMTYP        * Theatre Fee
          MOVE      SP10,MMSCGRP       * Misc.group
          MOVE      "N",PTMCKREB       * Do not keyin portions
          MOVE      ZERO,PTMCGSTA      * Unknown GST for DRG Code
          MOVE      SP10,PTMCGSTC
          MOVE      ZERO,IAMT
          MOVE      ONE,CASEFLAG
          MOVE      TWO,MBSFLAG
          GOTO      CASMIX99
.
CASMIX90  MOVE      ZERO,CASEFLAG
CASMIX99  RETURN
+
.------------------------------------------------------------
. Get the appropriate miscellaneous charges record
.------------------------------------------------------------
GETMSC00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9            * (MCHARGE re-use in PATMCHRD)
.
          PACK      MISCDATE,MISCDATE,SP70
          MATCH     SP70,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD,SP70
            REP       " 0",MISCDATE
          ENDIF
.
          UNPACK    SP20,PTHFBCAT           * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1                 * "Table Type code" now in PTHFBCAT
.
          PACK      KEY29,ACLAIM,AFUNDH,PTMCHFTT,KEY9,MISCDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - try a blank health fund
.
GETMSC10  PACK      KEY29,ACLAIM,SP6,SP3,KEY9,MISCDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - last chance, try default claim
.
GETMSC20  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,MISCDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP3,KEY9,MISCDATE,SP10
          ENDIF
.
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
GETMSC90  MOVE      ONE,EXIT
.
GETMSC99  RETURN
+
.------------------------------------------------------------
. Get the appropriate miscellaneous charges  for NZ private billing
.------------------------------------------------------------
GETNZM00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9
.
          COMPARE   THREE,PVITYPE
          GOTO      GETNZM02 IF NOT EQUAL       * Not inpatient
.
          MOVE      UNIQU[CNTITEM],KEY3
          MATCH     "  0",KEY3
          GOTO      GETNZM04 IF NOT EQUAL
.
GETNZM02  PACK      NZSPCLMN,ACLAIM,SP70
          PACK      NZSPCNTR,AFUNDH,SP70
          GOTO      GETNZM05
.
GETNZM04  PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,GETNZM91
.
GETNZM05  MOVE      PMVXMHOS,KEY3
          MOVE      ZERO,F1
GETNZM07  MATCH     SP70,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD
            REP       " 0",MISCDATE
          ENDIF
          PACK      KEY29,KEY3,NZSPCLMN,NZSPCNTR,SP8,MCHARGE,SP70
          PACK      KEY37,KEY29,MISCDATE
          CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      GETNZM99 IF NOT EQUAL       * No
          ENDIF
.
GETNZM08  CALL      RPNZMCH1
          BRANCH    OVRCD,GETNZM10
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG,SP70
          MATCH     KEY29,KEY29A
          GOTO      GETNZM10 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      GETNZM08 IF EQUAL           * Yes
.
          MATCH     NZMCEFDT,MISCDATE       * effective date => serv. date ?
          GOTO      GETNZM10 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     MISCDATE,NZMCEEDT
            GOTO      GETNZM10 IF LESS
          ENDIF
          GOTO      GETNZM99
.
.         No record with health fund details - try a blank health fund
.
GETNZM10  PACK      KEY29,KEY3,NZSPCLMN,SP6,SP8,MCHARGE,SP70
          PACK      KEY37,KEY29,MISCDATE
          CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      GETNZM99 IF NOT EQUAL       * No
          ENDIF
.
GETNZM12  CALL      RPNZMCH1
          BRANCH    OVRCD,GETNZM20
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG,SP70
          MATCH     KEY29,KEY29A
          GOTO      GETNZM20 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      GETNZM12 IF EQUAL           * Yes
.
          MATCH     NZMCEFDT,MISCDATE       * effective date => serv. date ?
          GOTO      GETNZM20 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     MISCDATE,NZMCEEDT
            GOTO      GETNZM20 IF LESS
          ENDIF
          GOTO      GETNZM99
.
.         No record with health fund details - try default claim, blank hf
.
GETNZM20  IF        IBCNMHOS=1
            MOVE      PTHSDCLM,NZMCCLMC
          ELSE
            MOVE      PTCNDCLM,NZMCCLMC
          ENDIF
          PACK      KEY29,KEY3,NZMCCLMC,SP14,KEY9
          PACK      KEY37,KEY29,MISCDATE,SP70
          CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      GETNZM99 IF NOT EQUAL       * No
          ENDIF
.
GETNZM22  CALL      RPNZMCH1
          BRANCH    OVRCD,GETNZM30
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG,SP70
          MATCH     KEY29,KEY29A
          GOTO      GETNZM30 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      GETNZM22 IF EQUAL           * Yes
.
          MATCH     NZMCEFDT,MISCDATE       * effective date => serv. date ?
          GOTO      GETNZM30 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     MISCDATE,NZMCEEDT
            GOTO      GETNZM30 IF LESS
          ENDIF
          GOTO      GETNZM99
.
.         No record for the hosp.- try with blank hosp
.
GETNZM30  BRANCH    F1,GETNZM90
          ADD       ONE,F1
          MOVE      SP70,KEY3
          GOTO      GETNZM07
.
GETNZM90  MOVE      ONE,EXIT
          GOTO      GETNZM99
.
GETNZM91  MOVE      "Missing NZ Procedure Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
GETNZM99  RETURN
+
.------------------------------------------------------------
. Check for Patient Transfer record
.------------------------------------------------------------
CTRA0000  MOVE      ZERO,EXIT
          MOVE      ZERO,CMIXFLAG
          PACK      KEY30,AADMNO,SP20,SP10
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CTRA9000         * Missing transfer record
          MATCH     TADMN,AADMNO
          GOTO      CTRA9000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CTRA9999
.
CTRA9000  MOVE      ONE,EXIT
CTRA9999  RETURN
+
.------------------------------------------------------------
. Check if patient is casemix funded
.------------------------------------------------------------
GCMX0000  MOVE      ZERO,CMIXFLAG
          COMPARE   THREE,PVITYPE
          GOTO      GCMX9000 IF NOT EQUAL   * Not an inpatient
          MATCH     ANSY,PTMICMXP
          GOTO      GCMX9000 IF NOT EQUAL
          COMPARE   THREE,ASTAT
          GOTO      GCMX9000 IF NOT EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF                * Get Contract Effective details
          BRANCH    EXIT,GCMX9000
.
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      CDSC0000                * Check for 'Disc.Eff.Date From'
          BRANCH    EXIT,GCMX9000
.
          MOVE      ONE,PROGFLAG
          MOVE      ONE,MSGFLAG             * check if matrix button be avail.
          CALL      CMXMATRX                * Check for matrix
          MOVE      CMXFLAG,CMIXFLAG
.
GCMX9000  MOVE      ZERO,EXIT
GCMX9999  RETURN
.
.*****************************************************************************
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.*****************************************************************************
CDSC0000  MOVE      ZERO,EXIT
          COMPARE   TWO,CNTRCEFR
          GOTO      CDSC9999 IF NOT EQUAL      * Not 'For Discharges From'
.
          PACK      DDATE,DDATE,SP70
          MATCH     SP70,DDATE
          GOTO      CDSC9999 IF NOT EQUAL
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "D",TCINDC19
            IF        @EQUAL
              PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
              REP       " 0",CEFFDATE
              GOTO      CDSC9999
            ENDIF
          ENDIF
          MOVE      ONE,EXIT
CDSC9999  RETURN
+
.----------------------------------------------------------------------
. Post Miscellaneous Charge
.----------------------------------------------------------------------
PITEM000  MOVE      ZERO,WARNINGC
          COMPARE   ZERO,LASTITEM
          GOTO      PITEM999 IF EQUAL
.
          PACK      KEY38,SP70
          READ      ITEMFIL1,KEY38;;
.
          MOVE      SP20,DIM18
          MOVE      SP20,CURSESS
          MOVE      ZEROVISN,SAVADM
          MOVE      ZERO,EXPCHCNT           * Clear the exploding charge counter
.
PITEM100  READKS    ITEMFIL1;XDAADMNO,TSESSION,SDATE,DXAMT,DXMBS,UNIQUEX:
                             TPATAMTT,AURNO,MITMTYP,MCHARGE,MDESC,ATRANNO:
                             PNAME,TRECEIPT,MULTNUM,MINDIC:
                             MBSFLAG,TPATAMTP,TREBATE,ACLAIM,AFUNDH:
                             AFNDTB,IAMT,KEYFLAG,MMSCGRP,MNINV:
                             IBAND1,IBAND2,IBAND3,IBAND4,IBAND5,IBAND6:
                             IBAND7,IBAND8,PVITYPE,PVIBILL,SYSID,ISDAYC:
                             PCENFLG,ACLSS:
                             IBAND9,IBAND10,IBAND11,IBAND12:
                             IBAND13,IBAND14,IBAND15,IBAND16,PTMCKREB:
                             CMIXFLAG,PTCTEPSD,PTMCGSTA,PTMCGSTC,CMBSFEE:
                             PTMCALGR,NZUNIQUE,NZINCTYP,TPATAMTG,NZMCKPRI:
                             THEABAND,STRTIME,ENDTIME,MISCDESC,NZEXPITM:
.-----------  Eclipse Bulk billing                             *T0859743-start
                             DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,SERVTEXT:
                             HOSPINDI,NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM:
                             SUBITEMN,SETCMGRP,PMMTIKEY:
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
.
                             DISTAKMS
.
.-----------

          GOTO      PITEM900 IF OVER
          MOVE      XDAADMNO,AADMNO
.
          MOVE      DXAMT,XAMT
          MOVE      DXMBS,XMBS
          MOVE      UNIQUEX,UNIQUE
          PACK      SAVKEY8,UNIQUE          * Save the unique number
.
          IF        PVITYPE=3
            PACK      KEY8,AADMNO
            CALL      RDMISS1               * Read the admission file
            BRANCH    OVRCD,PITEM100
.
            PACK      KEY8,AADMNO
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ELSE
              IF        IBCNMHOS=1
                MOVE      SP10,PTHSDCLM
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1                
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SAVADM,AADMNO
          IF        !@EQUAL
            MOVE      AADMNO,SAVADM
            MOVE      ZERO,EXPCHCNT         * Clear the exploding charge counter
            CALL      CDTH0000              * Check for DTR theatre items
          ENDIF
          MOVE      XDAADMNO,PMMIVISN
          MOVE      AURNO,PMMIURNO
          MOVE      SDATE,PMMITDAT
          REP       " 0",PMMITDAT
          MOVE      NZUNIQUE,PMMISUNQ
          MOVE      NZINCTYP,PMMIINCT
          MOVE      SP70,PMMICNTR
.
          COMPARE   FIVE,CFEETYP
          GOTO      PITEM110 IF NOT EQUAL    * Not NZ Private Billing
.
.         If Item to be billed to Patient, Funder should be blank
.
          PACK      KEY11,ADMISSNO,NZUNIQUE,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,PITEM110
          MATCH     SP70,NZSPCPRC
          GOTO      PITEM110 IF EQUAL       * No contract
.
          MATCH     "1",NZINCTYP
          GOTO      PITEM110 IF EQUAL       * Bill to patient
.
.         If this is not extra to contract and 
.         there is a max.contr. misc.item charge goes to patient invoice
.
          MATCH     "2",NZINCTYP
          IF        !@EQUAL
            MATCH     "1",NZSPCONT
            GOTO      PITEM110 IF EQUAL 
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "P",TCINDC7
            GOTO      PITEM110 IF EQUAL     * item goes to patient invoice
          ENDIF
          PACK      PMMICNTR,NZSPCNTR,SP70
.
.         MBSFLAG = 0 (Misc.item), 1 (MBS Item), 2 (DRG Code)
.
PITEM110  MOVE      MCHARGE,TITEMNO
          BRANCH    MBSFLAG,PITEM120,PITEM220
          GOTO      PITEM300                * Normal miscellaneous charge
.
. Check if the Medical records MBS file need,be copied
.
PITEM120  MATCH     "1",PRITEMIN
          GOTO      PITEM200 IF EQUAL
.
          BRANCH    CUSEMBS,PITEM140,PITEM140
          GOTO      PITEM200
.
. Get the last record of Medical records MBS file
.
PITEM140  CALL      UPMBS000     * Update MBS File
          MOVE      ":00",KEY3                                        *I-206410
          PACK      PMMISVTM,MMSTIM,KEY3,SP8                          *I-206410
.
PITEM200  IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      PITEM220 IF EQUAL
          ELSE 
            BRANCH    PTCNTFEE,PITEM220    * using theatre fees file
          ENDIF
          MATCH     "1",CMBSFEE
          GOTO      PITEM300 IF EQUAL    * using MBS Amount
.
PITEM220  MATCH     "1",PRITEMIN
          GOTO      PITEM300 IF EQUAL
.
          PACK      DIM18 WITH AADMNO,TSESSION,SDATE
          MOVE      SDATE,MISCDATE
          CALL      UPTHE000     * Update Theatre Details
.
.  Total charge = Patient portion + Rebate portion
.
PITEM300  MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
.
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
          MOVE      TPATAMTT,PMMIAMTT
.
.         Save the variables
.
          UNPACK    SDATE INTO XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,TFDAY
          MOVE      XMON,TFMONTH
          MOVE      XYEAR,TFYEAR
          MOVE      XCENT,TFCENT
          MOVE      SDATE,PMMITDAT 
.
.         Post this charge,the patients account
.
          CALL      UPDP0000                * Write Charge
          BRANCH    EXIT,PITEM100
          CALL      UGTU0000                * Write to unknow GST file if req.
          CALL      WREMC000                * Write exploding MBS charges
          GOTO      PITEM100
.
PITEM900  COMPARE   ZERO,WARNINGC
          GOTO      PITEM999 IF EQUAL       * No warning message
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
.
PITEM999  RETURN
+
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {"
          MOVE      ZERO,F3
ERRLST10  ADD       ONE,F3
          IF        F3>WARNINGC | F3>50
            WRITE     HTMLFILE;"}":
                               "</script>"
.
            MATCH     "1",PTCNUFFR
            IF        @EQUAL
              WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                                 "<script type=#"text/javascript#"> {":
                            " getTop().content.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
            ELSE
              WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               " top.content.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
            ENDIF
            CALL      CLOSHTML
            GOTO      ERRLST98
          ENDIF
.
          WRITE     HTMLFILE;"    alert(#"",WARNINGM[F3],"\n#");"
          GOTO      ERRLST10
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST98  MOVE      ZERO,WARNINGC
ERRLST99  RETURN
.
.******************************************************************************
.*                                  CDTH0000              Called by: READLOP  *
.*                Check For DTR Theatre Items For This Patient                *
.******************************************************************************
CDTH0000  MOVE      ZERO,ADMTYPFG           * Auto admission type flag - dont do
.
          COMPARE   ONE,PTCNAUAT
          GOTO      CDTH9000 IF NOT EQUAL   * Not using auto admin type update
.
          COMPARE   THREE,PVITYPE
          GOTO      CDTH9000 IF NOT EQUAL   * Not an inpatient, exit
.
          BRANCH    CFEETYP,CDTH9000        * Using the rates file, exit
.
. ----- Check for any existing theatre items for this patient -----
.
          MOVE      ONE,ADMTYPFG            * Auto admission type flag - yes
          PACK      KEY22,AADMNO,SP20
          CALL      RDSDTRN1                * Position on & read the DTR file
CDTH1000  CALL      RDKDTRN1
          BRANCH    OVRCD,CDTH2000
.
          MATCH     AADMNO,TADMNO
          GOTO      CDTH2000 IF NOT EQUAL   * Different admission number
.
          COMPARE   TWO,TRECTYPE
          GOTO      CDTH1000 IF NOT EQUAL   * Not a theatre item
.
          MOVE      ZERO,F1
          MOVE      PTDTCRST,F1
          BRANCH    F1,CDTH1000,CDTH1000    * Credit note
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          PACK      KEY17,TITEMNO,KEY8,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,CDTH1000
          GOTO      CDTH3000
.
CDTH2000  PACK      KEY14,AADMNO,SP20
          CALL      RSPMMTI1
CDTH2200  CALL      RKPMMTI1
          BRANCH    OVRCD,CDTH8000
.
          MATCH     DAADMNO,PMMIVISN
          GOTO      CDTH8000 IF NOT EQUAL   * Different admission number
.
          MATCH     "2",PMMIRTYP
          GOTO      CDTH2200 IF NOT EQUAL   * Not a theatre item
.
          PACK      KEY17,PMMIITEM,PMMITDAT,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,CDTH2200
.
CDTH3000  MOVE      TWO,ADMTYPFG            * Auto admission type flag - no
.
. ----- Re position on original record -----
.
CDTH8000  MOVE      SAVKEY8,UNIQUE
          PACK      KEY8,UNIQUE
          RESET     KEY8
          READ      ITEMFIL2,KEY8;XDAADMNO,TSESSION,SDATE,DXAMT,DXMBS,UNIQUEX:
                                TPATAMTT,AURNO,MITMTYP,MCHARGE,MDESC,ATRANNO:
                                PNAME,TRECEIPT,MULTNUM,MINDIC,MBSFLAG,TPATAMTP:
                                TREBATE,ACLAIM,AFUNDH,AFNDTB,IAMT,KEYFLAG:
                                MMSCGRP,MNINV,IBAND1,IBAND2,IBAND3,IBAND4:
                                IBAND5,IBAND6,IBAND7,IBAND8,PVITYPE,PVIBILL:
                                SYSID,ISDAYC,PCENFLG,ACLSS:
                                IBAND9,IBAND10,IBAND11,IBAND12:
                                IBAND13,IBAND14,IBAND15,IBAND16,PTMCKREB:
                                CMIXFLAG,PTCTEPSD,PTMCGSTA,PTMCGSTC,CMBSFEE:
                                PTMCALGR,NZUNIQUE,NZINCTYP,TPATAMTG,NZMCKPRI:
                                THEABAND,STRTIME,ENDTIME,MISCDESC,NZEXPITM:
.-----------  Eclipse Bulk billing                             *T0859743-start
                                DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,SERVTEXT:
                                HOSPINDI,NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM:
                                SUBITEMN,SETCMGRP,PMMTIKEY:
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
.
                                DISTAKMS
.
.-----------
.
          MOVE      XDAADMNO,AADMNO
          MOVE      DXAMT,XAMT
          MOVE      DXMBS,XMBS
          MOVE      UNIQUEX,UNIQUE
.
CDTH9000  MOVE      ZERO,EXIT
CDTH9999  RETURN
+
.------------------------------------------------------------
. Update MBS File
.------------------------------------------------------------
UPMBS000  MOVE      ZERO,FORM3
          MOVE      AADMNO,MMADMN
          PACK      KEY11,MMADMN,SP70
          CALL      RDSMMBS1
UPMBS100  CALL      RDKMMBS1
          BRANCH    OVRCD OF UPMBS200
          MATCH     MMADMN,AADMNO
          GOTO      UPMBS200 IF NOT EQUAL
          MOVE      MMRECN,FORM3
          GOTO      UPMBS100
.
UPMBS200  ADD       ONE,FORM3
          PACK      MMCODE,MCHARGE,SP10
          MOVE      AADMNO,MMADMN
          MOVE      FORM3,MMRECN            * Record number
          MOVE      SP10,MMDATE             * Init. operation date
          MOVE      SDATE,MMDATE            * DD/MM/YY
          REP       " 0",MMDATE
.
          MOVE      "00:00",MMSTIM          * No operation start time
          MOVE      "00:00",MMETIM          * No operation end time
          MATCH     SP5,STRTIME
          IF        !@EQUAL
            MOVE      STRTIME,MMSTIM        * Start time from AddMBS()
          ENDIF
          MATCH     SP5,ENDTIME
          IF        !@EQUAL
            MOVE      ENDTIME,MMETIM        * End time from AddMBS()
          ENDIF
.
          MOVE      SP70,PTMMDESC
          UNPACK    SP70,PTMMOPID,PTMMTMNO
          MOVE      SP70,PTMMEDAT
          MOVE      SP70,PTMMRPST
          MOVE      SP70,PTMMRPET
          MOVE      SP70,PTMMVAID
          MOVE      SP70,PTMMAPRA
          MOVE      SP70,MMSPARE
.
          PACK      KEY11,MMADMN,MMRECN
          CALL      WRMMBS1
          RETURN
.------------------------------------------------------------
. Get Theatre Fees
.------------------------------------------------------------
.         Check if it's the same admission, session and date. MBSLOP contains
.         the order of theatre items within a given session for a given adm no.
.
UPTHE000  MATCH     DIM18,CURSESS
          GOTO      UPTHE100 IF EQUAL
.
.         New session, reset counter
.
          OPEN      PATTRAN2,"pattranf"
          IF        MBSFLAG=1
            CALL      AUAT0000           * Auto update of the admission type
          ENDIF
.
          MOVE      ZERO,MBSLOP
          MOVE      DIM18,CURSESS
.
.         Read the theatre fee file to get the charges for this item
.
UPTHE100  ADD       ONE,MBSLOP
.
.         Inpatient always use Theatre file
.
          MATCH     SYSIP,SYSID
          GOTO      UPTHE999 IF NOT EQUAL
.
.         Get the patient and health fund portions
.
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TREBATE
.
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      UPTHE300 IF EQUAL
          ELSE
            BRANCH    PTCNTFEE,UPTHE300         * using theatre fees file
          ENDIF
.
          MATCH     "1",CMBSFEE
          IF        @EQUAL
            IF        MBSFLAG=1
              MOVE      ZERO,TREBATE       * Zero health fund portion
              MOVE      QIAMT,TPATAMTP     * use MBS amount for patient portion
            ENDIF
          ENDIF
          GOTO      UPTHE999
.
.         Check for casemix or non-casemix
.
UPTHE300  MOVE      MISCDATE,TSRVDATE  * Service date
          IF        CMIXFLAG = 1
            MOVE      ISDAYC,PTCTDCAS
            MOVE      MBSLOP,PTCTITMS
            CALL      CMGETTHR           * Get theatre casemix funding
            IF        OVRCD=1
              MOVE      ZERO,PTCTDPAT    * no casemix/theatre fee record
              MOVE      ZERO,PTCTDREB
              MOVE      ZERO,OVRCD
            ENDIF

            MOVE      PTCTDPAT,TPATAMTP
            MOVE      PTCTDREB,TREBATE
            MOVE      PTCTMBSB,THEABAND
          ELSE
            CALL      GTHR0000           * Get normal theatre charge
.
.           We've found the appropriate Theatre Fee record. Calculate rate
.
            LOAD      TPATAMTP,MBSLOP,TFPAT1,TFPAT2,TFPAT3,TFPAT4,TFPAT5,TFPAT6
            LOAD      TREBATE,MBSLOP,TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
          ENDIF
.
UPTHE999  RETURN
.------------------------------------------------------------
. Subroutine,get the theatre fee charge record
.------------------------------------------------------------
GTHR0000  MOVE      ZERO,NOFEE
          MOVE      SP70,THEABAND
.
.        Set up the daycase rate indicator
.
          MOVE      SP1,DAYCASEF
          LOAD      DAYCASEF USING ISDAYC OF ANSD
.
GTHR1000  PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF                * Get Contract Effective details
          BRANCH    EXIT,GTHR9000
.         
          MOVE      MISCDATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date and
.         if TCINDC19 <> D set to Admission date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              MOVE      ADATE,CEFFDATE       * default to Admission date
              PACK      KEY5,CODECL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          REP       " 0",CEFFDATE
.
          MOVE      MISCDATE,TSRVDATE           * Service date
          PACK      KEY18 WITH ACLAIM,AFUNDH,AFNDTB,DAYCASEF,SP5
          CALL      GETTFEES
          BRANCH    EXIT,GTHR9000
.
          IF        HFBAND<>0
            UNPACK    DIM5,THEABAND             * Theatre banding
          ENDIF
          MOVE      ZERO,OVRCD
          GOTO      GTHR9999
.
GTHR9000  MOVE      ONE,OVRCD
          MOVE      ONE,NOFEE
          GOTO      GTHR9999 
.
GTHR9999  RETURN
.
.******************************************************************************
.*                                  AUAT0000              Called by: READLOP  *
.*                    Automatic Update Of The Admission Type                  *
.******************************************************************************
AUAT0000  COMPARE   ZERO,ADMTYPFG
          GOTO      AUAT9000 IF EQUAL       * No admission type update
.
          COMPARE   TWO,MITMTYP
          GOTO      AUAT9000 IF NOT EQUAL   * Not a theatre item, exit
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSX,TCINDC7
            GOTO      AUAT9000 IF EQUAL     * Exclude this adm type from auto
          ENDIF
.
          PACK      ADMTYP,SP5              * Admission type
          PACK      SAVKEY8,UNIQUE          * Save the unique number
.
.         ADMTPFG = 1 - Ok to update admission type
.                   2 - item already entered previously
.
          BRANCH    ADMTYPFG,AUAT1000       * Auto admission type update
.
          COMPARE   ONE,PTCNWSPC
          GOTO      AUAT9000 IF NOT EQUAL   * Dont want manual admin type update
.
AUAT1000  PACK      KEY17,MCHARGE,MISCDATE,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,AUAT8000
          MOVE      ICLSS,ADMTYP            * Admission type
.
          COMPARE   ONE,PTSGCOPT
          GOTO      AUAT1800 IF NOT EQUAL
.
          OPEN      PATSGCA1,"patsgcaf"
          PACK      KEY18,ACLAIM,AFUNDH,ITEMNO
          CALL      RDPTSGC1              * Read the suggested class file
          COMPARE   ZERO,OVRCD
          GOTO      AUAT1600 IF EQUAL
.
          MATCH     SP70,AFUNDH
          GOTO      AUAT1400 IF EQUAL
.
          MOVE      SP70,PTSGCLMN           * blank claim
          PACK      KEY18,PTSGCLMN,AFUNDH,ITEMCODE,SP20  * key of fund and item
          CALL      RDPTSGC1                * read exceptions file
          COMPARE   ZERO,OVRCD
          GOTO      AUAT1600 IF EQUAL
.
AUAT1400  MOVE      SP70,PTSGFUND           * blank health fund
          PACK      KEY18,ACLAIM,PTSGFUND,ITEMCODE,SP20  * key of fund and item
          CALL      RDPTSGC1                * read exceptions file
          BRANCH    OVRCD,AUAT1800           * no record so use ICLSS
.
AUAT1600  MOVE      PTSGCLSS,ADMTYP     * Admission type
.
AUAT1800  PACK      KEY8,AADMNO
          CALL      RDMISS1               * Read the admission file
          MOVE      SP70,DDATE
          IF        OVRCD=0 & ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MATCH     DDATE,ADATE
              IF        @EQUAL
                MOVE      PTITDCSC,ADMTYP     * Daycase Admission type
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ADMTYP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSX,TCINDC7
            GOTO      AUAT8000 IF EQUAL     * Exclude this adm type from auto
          ENDIF
.
          MATCH     ATYPE,ADMTYP
          GOTO      AUAT8000 IF EQUAL       * Same admission type, no change
.
          MATCH     SP3,ADMTYP
          IF        @EQUAL
.           DISPLAY   *P1:24,*EL,*B,"No Suggested Class for MBS ":
.                     *V2LON,ITEMNO,*HOFF,".  Adm Type not Updated.  ";
.
            CLEAR     WARNINGL
            APPEND    "No Suggested Class for MBS ",WARNINGL
            APPEND    ITEMNO,WARNINGL
            APPEND    ". Adm Type not Updated. ",WARNINGL
            RESET     WARNINGL
            CALL      ADDWRN00    * Add Warning
.
            GOTO      AUAT8000
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ADMTYP
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD=1
.           DISPLAY   *P1:24,*EL,*B,"Suggested Adm Type ",*V2LON,ADMTYP,*HOFF:
.                     " not found for MBS code ",*V2LON,ITEMNO,*HOFF,".  ";
.
            CLEAR     WARNINGL
            APPEND    "Suggested Adm Type,",WARNINGL
            APPEND    ADMTYP,WARNINGL
            APPEND    " not found for MBS code ",WARNINGL
            APPEND    ITEMNO,WARNINGL
            RESET     WARNINGL
            CALL      ADDWRN00    * Add Warning
            GOTO      AUAT8000
          ENDIF
.
          BRANCH    ADMTYPFG,AUAT3000       * Auto admission type update
.
          MOVE      ITEMNO,SAVKEY9
.         CALL      DPMI0000                * Display primary MBS items
.
.         CLEAR     WARNINGL
.         APPEND    "Warning: Possible Adm.Type changed required.",WARNINGL
.         APPEND    "Item: ",WARNINGL
.         APPEND    KEY9,WARNINGL
.         APPEND    "-",WARNINGL
.         APPEND    TDESC,WARNINGL
.         RESET     WARNINGL
.         CALL      ADDWRN00    * Add Warning
.
.          DISPLAY   *P1:24,*EL,*B,"Warning: Possible Admission Type changed ":
.                    "required.  Change (",*V2LON,"Y",*HOFF,"/",*V2LON,"N":
.                    *HOFF,") ? ";
.AUAT2000  KEYIN     *P68:24,*EL,*V2LON,ANS;
.          REP       UPPLOW,ANS
.
.          MATCH     ANSY,ANS
.          GOTO      AUAT4000 IF EQUAL       * Update the admission type
.
.          MATCH     ANSN,ANS
.          GOTO      AUAT8000 IF EQUAL       * Dont update the admission type
.
.          BEEP
.          GOTO      AUAT2000
.
.         Check if we want to change the admission type
.
          PACK      KEY10 WITH TSESSION,SDATE
          CALL      RDTEMP2
          BRANCH    OVRCD,AUAT8000          * Dont update the admission type
          MOVE      TMEFFD,EFTDATE
          REP       " 0",EFTDATE            * Effective date
          GOTO      AUAT4000                * Update the admission type
.
AUAT3000  MOVE      AADMNO,EFTADMIN         * Admission number
          MOVE      ADMTYP,EFTATYPE         * Admission type
          MOVE      TMEFFD,EFTDATE
          REP       " 0",EFTDATE            * Effective date
          CALL      CPAD0000                * Calc primary admin type eft date
          GOTO      AUAT5000
.
AUAT4000  MOVE      AADMNO,EFTADMIN         * Admission number
          MOVE      ADMTYP,EFTATYPE         * Admission type
          CALL      KSAD0000                * Keyin sub admin type eft date
.
AUAT5000  PROC      CHNADMTP                * Change the admission type
          BRANCH    NOATYPUP,AUAT8000
.
          PACK      KEY8,EFTADMIN
          CALL      RDMISS1                 * Read the admission file
.
          MOVE      TWO,ADMTYPFG            * Auto admission type flag - no
          GOTO      AUAT8000
.
AUAT8000  DISPLAY   *P1:24,*EL;
          MOVE      SAVKEY8,UNIQUE
          PACK      KEY8,UNIQUE
          RESET     KEY8
          READ      ITEMFIL2,KEY8;XDAADMNO,TSESSION,SDATE,DXAMT,DXMBS,UNIQUEX:
                                TPATAMTT,AURNO,MITMTYP,MCHARGE,MDESC,ATRANNO:
                                PNAME,TRECEIPT,MULTNUM,MINDIC,MBSFLAG,TPATAMTP:
                                TREBATE,ACLAIM,AFUNDH,AFNDTB,IAMT,KEYFLAG:
                                MMSCGRP,MNINV,IBAND1,IBAND2,IBAND3,IBAND4:
                                IBAND5,IBAND6,IBAND7,IBAND8,PVITYPE,PVIBILL:
                                SYSID,ISDAYC,PCENFLG,ACLSS:
                                IBAND9,IBAND10,IBAND11,IBAND12:
                                IBAND13,IBAND14,IBAND15,IBAND16,PTMCKREB:
                                CMIXFLAG,PTCTEPSD,PTMCGSTA,PTMCGSTC,CMBSFEE:
                                PTMCALGR,NZUNIQUE,NZINCTYP,TPATAMTG,NZMCKPRI:
                                THEABAND,STRTIME,ENDTIME,MISCDESC,NZEXPITM:
.-----------  Eclipse Bulk billing                             *T0859743-start
                                DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,SERVTEXT:
                                HOSPINDI,NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM:
                                SUBITEMN,SETCMGRP,PMMTIKEY:
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
.
                                DISTAKMS
.
.-----------

          MOVE      XDAADMNO,AADMNO
          MOVE      DXAMT,XAMT
          MOVE      DXMBS,XMBS
          MOVE      UNIQUEX,UNIQUE
.
AUAT9000  MOVE      ZERO,EXIT
AUAT9999  RETURN
+
.******************************************************************************
.*                                  DPMI0000              Called by: AUAT0000 *
.*                          Display Primary MBS Items                         *
.******************************************************************************
DPMI0000  MOVE      ONE,MBSCOUNT            * Clear the MBS counter
          REPEAT
            PACK      MBSDATE[MBSCOUNT],SP10     * Clear the MBS date
            PACK      MBSITEM[MBSCOUNT],SP10     * Clear the MBS items
            ADD       ONE,MBSCOUNT          * Increment the MBS counter
          UNTIL     MBSCOUNT>=16
.
. ----- Load the primary items into a screen array ------
.
          PACK      SAVKEY18,AADMNO,SP20    * Clear the theatre session & date
          MOVE      ONE,MBSCOUNT            * Clear the MBS counter
          PACK      KEY22,AADMNO,SP20
          CALL      RDSDTRN1                * Position on & read the DTR file
DPMI1000  CALL      RDKDTRN1
          BRANCH    OVRCD,DPMI2000
.
          MATCH     AADMNO,TADMNO
          GOTO      DPMI2000 IF NOT EQUAL   * Different admission number
.
          COMPARE   TWO,TRECTYPE
          GOTO      DPMI1000 IF NOT EQUAL   * Not a theatre item
.
          PACK      DTRDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",DTRDATE
          PACK      KEY18,TADMNO,TSESSION,DTRDATE
          MATCH     SAVKEY18,KEY18
          GOTO      DPMI1000 IF EQUAL       * Same theatre session & date
.
          MOVE      KEY18,SAVKEY18          * Save the theatre session & date
          PACK      KEY17,TITEMNO,DTRDATE,SP70
          CALL      PATITMRD                * Read the item file
          BRANCH    OVRCD,DPMI1000
.
          PACK      MBSDATE[MBSCOUNT],DTRDATE * Save the MBS date
          PACK      MBSITEM[MBSCOUNT],ITEMNO,SP10 * Save the MBS item
          ADD       ONE,MBSCOUNT            * Increment the MBS counter
          COMPARE   "15",MBSCOUNT
          GOTO      DPMI1000 IF LESS        * Save max of 14 items
.
. ----- Display the background screen -----
.
DPMI2000  PACK      MBSITEM[MBSCOUNT],SAVKEY9,SP10 * Save the MBS item
          ADD       ONE,MBSCOUNT            * Increment the MBS counter
.
          SUB       ONE,MBSCOUNT            * No of items
          MOVE      MBSCOUNT,FORM2
          ADD       "8",FORM2
          ASSIGN    13-(FORM2/2-1),CVERT    * Top   
          ASSIGN    13+(FORM2/2-2),EVERT    * Bottom
          BOXCLR    3,CVERT,78,EVERT
.
          MOVE      MBSCOUNT,FORM2
          ADD       "6",FORM2
          ASSIGN    13-(FORM2/2-1),CVERT    * Top   
          ASSIGN    13+(FORM2/2-2),EVERT    * Bottom
          BOX       1,4,CVERT,77,EVERT
.
.  |------------------------------------------------------------------------|
.  | MBS Item  MBS Description                          MBS Date   Adm Type |
.  | 123456789 1234567890123456789012345678901234567890 12/45/7890 123      |
          MOVE      MBSCOUNT,FORM2
          ADD       "4",FORM2
          ASSIGN    13-(FORM2/2-1),CVERT
          DISPLAY   *P6:CVERT,"Current Admission Type : ",*V2LON,ATYPE;
          DISPLAY   *P51:CVERT,"Admission Number : ",*V2LON,AADMNO;
          ADD       ONE,CVERT
          DISPLAY   *P6:CVERT,*ULON,"MBS Item ",*P16:CVERT,"MBS Description":
                    SP20,SP5,*P57:CVERT,"MBS Date  ",*P68:CVERT,"Adm Type";
.
. ----- Display MBS items on the screen -----
.
          ASSIGN    13-(MBSCOUNT/2-1),CVERT
          MOVE      ONE,FORM2
DPMI3000  COMPARE   FORM2,MBSCOUNT
          GOTO      DPMI9000 IF LESS        * All MBS items displayed
.
          COMPARE   "16",FORM2
          GOTO      DPMI9000 IF NOT LESS    * Only display 15 MBS items
.
          MOVE      ATYPE,ADMTYP            * Admission type
          DISPLAY   *P6:CVERT,*V2LON,MBSITEM[FORM2];
          PACK      KEY17,MBSITEM[FORM2],MBSDATE[MBSCOUNT],SP70
          CALL      PATITMRD                * Read the item file
          IF        OVRCD<>1
            DISPLAY   *P16:CVERT,IDESC;
            MOVE      ICLSS,ADMTYP          * Admission type
          ENDIF
.
          IF        PTSGCOPT=1
            OPEN      PATSGCA1,"patsgcaf"
            PACK      KEY15,AFUNDH,MBSITEM[FORM2]
            CALL      RDPTSGC1              * Read the suggested class file
            IF        OVRCD<>1
              MOVE      PTSGCLSS,ADMTYP     * Admission type
            ENDIF
            CLOSE     PATSGCA1
          ENDIF
.
          UNPACK    MBSDATE[FORM2],KEY8
          MATCH     SP8,KEY8
          IF        !@EQUAL
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE               * Format the MBS date
            REP       " 0",CPCDATE
            DISPLAY   *P57:CVERT,CPCDATE;
          ENDIF
.
          DISPLAY   *P68:CVERT,ADMTYP;
          ADD       ONE,FORM2
          ADD       ONE,CVERT
          GOTO      DPMI3000
.
DPMI9000  MOVE      ZERO,EXIT
DPMI9999  RETURN
+
.******************************************************************************
.*                                  CPAD0000              Called by: AUAT0000 *
.*               Calculate Primary Admission Type Effective Date              *
.******************************************************************************
CPAD0000  UNPACK    SDATE,CCENT,CYEAR,CMON,CDAY
          PACK      EFTDATE,CCENT,CYEAR,CMON,CDAY * Effective date = MBS date
.
          PACK      DIM8,CCC,CYY,CMM,CDD    * setup current date
          REP       " 0",DIM8
          MATCH     EFTDATE,DIM8            * Effective date = current date ?
          GOTO      CPAD0200 IF NOT EQUAL   * no.
          MATCH     ADATE,DDATE
          GOTO      CPAD0200 IF EQUAL       * Daycase
.
          CALL      IBACLOCK
          MOVE      CTIMEIS,EFTTIME            * yes, use current time
          REP       " 0",EFTTIME
          GOTO      CPAD9000
.
CPAD0200  UNPACK    ATIME,CHOUR,DIM1,CMIN,DIM1,DIM2
CPAD1000  MOVE      CHOUR,IHOUR
          MOVE      CMIN,IMIN
          IF        IMIN=59
            IF        IHOUR=23
              UNPACK    EFTDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CCENT,CC
              MOVE      CYEAR,YY
              MOVE      CMON,MM
              MOVE      CDAY,DD
.
              CALL      DMYCON              * Convert to julian format
.
              ADD       ONE,JULDAY          * Add 1 day
              MOVE      JULDAY,JWKDAY
              MOVE      JULYR,JWKYER
              MOVE      JULCC,JWKCC
.
              CALL      JULCON              * Convert back to DDMMCCYY format
.
              PACK      EFTDATE,CC,YY,MM,DD    * Effective date + 1 day
.
              MOVE      ZERO,IMIN
              MOVE      ZERO,IHOUR          * Start of next day
            ELSE
              ADD       ONE,IHOUR           * Increment the hour
              MOVE      ZERO,IMIN
            ENDIF
          ELSE
            ADD       ONE,IMIN              * Increment the minute
          ENDIF
          PACK      EFTTIME,IHOUR,COLON,IMIN,COLON,ZERO,ZERO    * Effective time
.
          REP       " 0",EFTDATE
          REP       " 0",EFTTIME
.
. ----- Check if transfer already exists at this date & time.  If so add -----
. ----- 1 minute to the effective time so no duplicates are written. -----
.
          PACK      KEY30,EFTADMIN,EFTDATE,EFTTIME,SP20
          CALL      RDSTRAN2                * Position on & read the transfer
          CALL      RDKTRAN2                  file
          BRANCH    OVRCD,CPAD9000
.
          MATCH     EFTADMIN,TADMN
          GOTO      CPAD9000 IF NOT EQUAL   * Different admission number
.
          MATCH     EFTDATE,TDATE
          GOTO      CPAD9000 IF NOT EQUAL   * Different date
.
          MATCH     EFTTIME,TTIME
          GOTO      CPAD9000 IF NOT EQUAL   * Different time
.
          UNPACK    EFTTIME,CHOUR,DIM1,CMIN,DIM1,DIM2
          GOTO      CPAD1000                * Add 1 minute to the effective time
.
CPAD9000  MOVE      ZERO,EXIT
CPAD9999  RETURN
+
.******************************************************************************
.*                                  KSAD0000              Called by: AUAT0000 *
.*              Keyin The Subsequent Admission Type Effective Date            *
.******************************************************************************
KSAD0000 
.         DISPLAY   *P1:24,*EL,"Subsequent MBS effective date : ";
.
.         PACK      CURRDATE,CCC,CYY,CMM,CDD,SP70
.         REP       " 0",CURRDATE
.         UNPACK    CURRDATE,CCENT,CYEAR,CMON,CDAY
.
.         MATCH     SP8,SDATE
.         IF        !@EQUAL
.           UNPACK    SDATE,CCENT,CYEAR,CMON,CDAY
.         ENDIF
.
.         MOVE      "33",CCOL
.         MOVE      "24",CVERT
.         MOVE      ZERO,CCANLDTE
.         MOVE      ZERO,CDEFDTE
.         MOVE      ZERO,CHIGHLT
.         CALL      KEYDATE                 * Keyin the effective date
.         BRANCH    OVRCD,KSAD0000
.
.         PACK      EFTDATE,CCENT,CYEAR,CMON,CDAY
.         REP       " 0",EFTDATE            * Effective date
.
.         MATCH     EFTDATE,CURRDATE
.         IF        @LESS
.           DISPLAY   *P1:24,*EL,*B,"Effective date needs to be before the ":
.                     "current date.  ";
.           CALL      HITENTER
.           GOTO      KSAD0000
.         ENDIF
.
.         MATCH     ADATE,EFTDATE
.         IF        @LESS
.           DISPLAY   *P1:24,*EL,*B,"Effective date needs to be after the ":
.                     "admission date.  ";
.           CALL      HITENTER
.           GOTO      KSAD0000
.         ENDIF
.
.         MATCH     SP8,DDATE
.         IF        !@EQUAL
.           MATCH     EFTDATE,DDATE
.           IF        @LESS
.             DISPLAY   *P1:24,*EL,*B,"Effective date needs to be before the ":
.                       "discharge date.  ";
.             CALL      HITENTER
.             GOTO      KSAD0000
.           ENDIF
.         ENDIF
.
          MATCH     ADATE,EFTDATE
          IF        @EQUAL
            MOVE      ATIME,EFTTIME
          ELSE
            MOVE      "00:01:00",EFTTIME      * Default the effective time
          ENDIF
.
. ----- Check if transfer already exists at this date & time.  If so add -----
. ----- 1 minute to the effective time so no duplicates are written. -----
.
KSAD1000  PACK      KEY30,EFTADMIN,EFTDATE,EFTTIME,SP20
          CALL      RDSTRAN2                * Position on & read the transfer
          CALL      RDKTRAN2                  file
          BRANCH    OVRCD,KSAD9000
.
          MATCH     EFTADMIN,TADMN
          GOTO      KSAD9000 IF NOT EQUAL   * Different admission number
.
          MATCH     EFTDATE,TDATE
          GOTO      KSAD9000 IF NOT EQUAL   * Different date
.
          MATCH     EFTTIME,TTIME
          GOTO      KSAD9000 IF NOT EQUAL   * Different time
.
          UNPACK    EFTTIME,CHOUR,DIM1,CMIN,DIM1,DIM2
          MOVE      CHOUR,IHOUR
          MOVE      CMIN,IMIN
          IF        IMIN=59
            ADD       ONE,IHOUR
            MOVE      ZERO,IMIN
          ELSE
            ADD       ONE,IMIN
          ENDIF
          PACK      EFTTIME,IHOUR,COLON,IMIN,COLON,ZERO,ZERO    * Effective time
          REP       " 0",EFTTIME
          GOTO      KSAD1000
.
KSAD9000  MOVE      ZERO,EXIT
KSAD9999  RETURN
+
.******************************************************************************
.*                                  WREMC000              Called by: USCHP000 *
.*                         Write Exploding MBS Charges                        *
.******************************************************************************
WREMC000  COMPARE   THREE,PVITYPE
          GOTO      WREMC900 IF NOT EQUAL   * Not an inpatient, exit
.
          BRANCH    MBSFLAG,WREMC100
          GOTO      WREMC900
.
. ----- Write exploding miscellaneous items for MBS charge -----
.
WREMC100  ADD       ONE,EXPCHCNT            * Increment the exploding charge cnt
.
          MOVE      TITEMNO,SAVKEY9
          PACK      KEY30,ACLAIM,ATYPE,AFUNDH,SP6,SAVKEY9,SP70
          CALL      PATECHRD
          BRANCH    EXIT,WREMC900
          UNPACK    KEY30,WKECCTYP,WKECATYP,WKECHFND,WKECHGRP,WKECMBSC
.
          CALL      RSPTECH1                * Position on & read the exploding
WREMC200  CALL      RKPTECH1                  charges file
          BRANCH    OVRCD,WREMC900
.
          MATCH     WKECCTYP,PTECCTYP
          GOTO      WREMC900 IF NOT EQUAL   * Different claim type
.
          MATCH     WKECATYP,PTECATYP
          GOTO      WREMC900 IF NOT EQUAL   * Different admission type
.
          MATCH     WKECHFND,PTECHFND
          GOTO      WREMC900 IF NOT EQUAL   * Different health fund
          MATCH     WKECHGRP,PTECHGRP
          GOTO      WREMC900 IF NOT EQUAL   * Different health fund group
.
          MATCH     WKECMBSC,PTECMBSC
          GOTO      WREMC900 IF NOT EQUAL   * Different MBS code
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          MATCH     SP8,SDATE               * save for orig PMMITDAT  *I-119158
          IF        !@EQUAL
            MOVE      SDATE,KEY8
          ENDIF
.
.                                           * Read Misc. Charges file
          UNPACK    SP20,PTHFBCAT      * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT

          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,PTECEMCH,KEY8,SP10
          CALL      PATMCHRD                * find Miscellaneous Charge Item
          IF        EXIT = 1
            PACK      KEY29,ACLAIM,SP6,SP3,PTECEMCH,KEY8,SP10
            CALL      PATMCHRD              * find Miscellaneous Charge Item
            IF        EXIT = 1
              CALL      DCLM0000            * set Hospital default
              PACK      KEY29,PTCNDCLM,SP6,SP3,PTECEMCH,KEY8,SP10
              CALL      PATMCHRD            * find Miscellaneous Charge Item
              BRANCH    EXIT,WREMC200       * not found or invalid
            ENDIF
          ENDIF
.
          MOVE      ZERO,MULTNUM
          STRIP     PTECQNTY
          MOVE      PTECQNTY,MULTNUM        * Quantity
.
.         Write record to item pending file
.
WREMC500  MOVE      AADMNO,PMMIVISN         * Admission no
          MOVE      AADMNO,PVIBILL
          PACK      KEY8,PVIBILL
          CALL      TRVISA1                 * Get next Transaction no
          MOVE      PVITRAN,PMMITRAN        * DTR no
.
          MOVE      AURNO,PMMIURNO          * U/R no
          MOVE      SP10,KEY1
          MOVE      PVITYPE,KEY1
          PACK      PMMISYST,SP1,KEY1
          CALL      CEVT0000                 * Check for Events
          MATCH     SP70,KEY1
          IF        !@EQUAL
            PACK      PMMISYST,SP1,KEY1     * Events
          ENDIF
.
          PACK      PMMIITEM,MCHARGE,SP10   * Miscellaneous item
          MOVE      MDESC,PMMIDESC          * Miscellaneous item description
          PACK      PMMIDES2,SP30,SP10      * 2nd item description
          MOVE      SDATE,PMMITDAT
          REP       " 0",PMMITDAT
          MOVE      MITMTYP,PMMIRTYP        * Record type
.
          MOVE      ZERO,PMMIAMTG           * Gross amount - zero
          MOVE      ZERO,PMMIAMTH
.
          MOVE      MPATPOR,PMMIAMTP
          MOVE      PTEC3MCF,FORM42
          LOAD      FORM42,EXPCHCNT,PTEC1MCF,PTEC2MCF
          ASSIGN    ((FORM42/100)*PMMIAMTP),PMMIAMTP * Patient amount
.
          MOVE      MHFPOR,PMMIRBAT
          MOVE      PTEC3MCF,FORM42
          LOAD      FORM42,EXPCHCNT,PTEC1MCF,PTEC2MCF
          ASSIGN    ((FORM42/100)*PMMIRBAT),PMMIRBAT * Rebate amount
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      MULTNUM,PMMIAMTT
.
          MOVE      SP6,PMMITDOC            * Treating doctor - none
          MOVE      SP6,PMMIODOC            * Operating doctor - none
          MOVE      SP10,PMMISESS           * Session
.
          IF        CFEETYP=9
            MOVE      PTMCALGR,PMMIMGRP       * Alt.Misc.charge group Cat FN
            PACK      PMMIBTCH,MMSCGRP,SP70   * Misc.Charge group Cat FI
          ELSE
            MOVE      MMSCGRP,PMMIMGRP        * Miscellaneous charge group
            MOVE      BATCHNO,PMMIBTCH        * Batch no
          ENDIF
.
          MOVE      ONE,PMMIINVN            * No of invoices
          MOVE      PTMCGSTA,PMMIGSTA       * GST Applicable
          MOVE      PTMCGSTC,PMMIGSTC       * GST Code
          MOVE      ZERO,PMMIGSTM           * GST Amount
.
          MOVE      MULTNUM,PMMISERV        * no of services
          MOVE      TRECEIPT,PMMIREFN       * Reference no
          MOVE      USERID,PMMIWUSR         * WEB user id
          MOVE      "0",PMMIMVBR            * Mechanical ventilation billing
          PACK      PMMIUNIQ,SP70
          UNPACK    SP70,PMMICNTR,PMMISUNQ,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          UNPACK    SP70,PMMICCON
          MOVE      "2",PMMIITYP             * Exploding misc.item
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          CALL      IBACLOCK
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR
          MOVE      CTIMEIS,PMMISVTM
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
.
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
          CALL      CIPMTI00
.
          MATCH     "1",PMTIFLAG
          IF        @EQUAL
            PACK      KEY14,PMMIVISN,PMMITRAN,SP70
            CALL      WRPMMTI1
          ENDIF
.
          GOTO      WREMC200
.
WREMC900  MOVE      ZERO,EXIT
WREMC999  RETURN
+
.------------------------------------------------------------------
.  Add Sundry charges
.------------------------------------------------------------------
ADDSUN00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ADDSUN98
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,ADDSUN98
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDSUN98
.
          IF        IBCNMHOS=1
            MOVE      SP1,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1                * get Hospital using Theatr
          ENDIF
.
          MOVE      ZERO,MTIFLAG
          MOVE      ZERO,NZEXPITM
          MOVE      ZERO,ASTAT
          MOVE      "0  ",ACLAIM
          MOVE      SP10,AFUNDH
          MOVE      SP10,AFNDTB
          MOVE      SP10,ACLSS
          MOVE      ZERO,CMIXFLAG
          MOVE      ZERO,ISDAYC
          MOVE      SP10,DDATE
          CALL      VALPAT00               * Validate patient's details
          BRANCH    EXIT,ADDSUN99
.
          CALL      CHDT0000               * Check date
          BRANCH    EXIT,ADDSUN99
.
          MOVE      ZERO,CNTITEM
.
          CALL      GTDCHS00
          MOVE      PMMIEDAD,ADADOCT
.
ADDSUN10  MATCH     "1",EBSMINDC
          IF        @EQUAL
            MOVE      999,CNTITEM
            MATCH     SP70,TKBOX[CNTITEM]
            GOTO      ADDSUN90 IF EQUAL       * Not ticked
            GOTO      ADDSUN90 IF EOS
          ELSE 
            ADD       ONE,CNTITEM
            COMPARE   "43",CNTITEM
            GOTO      ADDSUN90 IF NOT LESS
.
            MATCH     SP70,TKBOX[CNTITEM]
            GOTO      ADDSUN10 IF EQUAL       * Not ticked
          ENDIF
.
          CALL      CLREC000     * clear tempfile record variables
.
          MOVE      PROCI[CNTITEM],MCHARGE
          MATCH     SP9,MCHARGE
          IF        !@EQUAL
.
            MATCH     "1",HX13INDC
            IF        @EQUAL
ADDSUN20      MATCH       "HX013    ",MCHARGE
              IF          @EQUAL
.
                MOVE      "V  ",KEY3
                MOVE      "M",ITYPE[CNTITEM]
                CALL      GSB30000
                MATCH     SP70,KEY3
                GOTO      ADDSUN80 IF EQUAL
.                 
                MOVE      KEY3,PMMISUBN
                MOVE      EMVIDOCT,PMMIEDAD
                CALL      GTDCHS00
                MOVE      PQUAN[CNTITEM],PMMISERV
                MOVE      PRITSAFE,PMMIAMTT
                MOVE      " .00",PMMISCHF
                MOVE      "0",PMMIITYP
                MOVE      PMMIAMTT,PMMIAMTP
                MOVE      ZERO,PMMIRBAT
                CALL      WMTI0000                  * Write to pmsmtiaf
                CALL      WVCD0000                  * Write to emrvcdaf
.
              ELSE
                GOTO      ADDSUN50
              ENDIF
            ELSE
.
ADDSUN50      UNPACK    PROCDATE INTO XCENT,XYEAR,XMON,XDAY
              MOVE      XDAY,TFDAY
              MOVE      XMON,TFMONTH
              MOVE      XYEAR,TFYEAR
              MOVE      XCENT,TFCENT
              MOVE      SDATE,PMMITDAT 
              MOVE      SDATE,MISCDATE
.
              MOVE      PROCDATE,WKITDATE
              PACK      KEY8,ADMISSNO
              CALL      CHKITM00        * Check for valid MBS/Misc.item number
              BRANCH    EXIT,ADDSUN90
              MOVE      PQUAN[CNTITEM],MULTNUM
              MOVE      PAMNT[CNTITEM],PMMIAMTT
              MOVE      PAMNT[CNTITEM],PMMIAMTP
              MOVE      ZERO,PMMIRBAT
.
              MOVE      SP10,PMMISESS             * Session
              UNPACK    SP70,PMMICNTR,PMMISUNQ,PMMIINCT,PMMIBTCH
              MOVE      SP70,PMMIDKSM
              MOVE      SP70,PMMISPAR
              CALL      UPDP0000                  * Write to pmsmtiaf
.
            ENDIF
          ENDIF
.
ADDSUN80  MATCH     "1",EBSMINDC
          IF        !@EQUAL
            GOTO      ADDSUN10
          ENDIF
.
ADDSUN90  MOVE      ZERO,EXIT
          GOTO      ADDSUN99
.
ADDSUN98  MOVE      ONE,EXIT
ADDSUN99  RETURN
+
.------------------------------------------------------------------
.Update the files for this charge, depending on the system
.------------------------------------------------------------------
UPDP0000  MOVE      ZERO,INVCFLAG            * Initialise to invoice item
          BRANCH    PVITYPE OF UPDP3000,UPDP2000,UPDP1000
          CALL      CEVT0000                 * Check for Events
          MATCH     "1",KEY1
          GOTO      UPDP3000 IF EQUAL        * Emergency event
.
.         Update inpatient files
.
UPDP1000  MOVE      PVIBILL,AADMNO
.
UPDP1100  MOVE      AADMNO,KEY8
          CALL      RDPTMIS1
          COMPARE   ZERO,OVRCD
          GOTO      UPDP1200 IF EQUAL
          MOVE      ONE,EXIT
          GOTO      UPDP9999
.
UPDP1200  MOVE      PVIBILL,TADMNO
          MOVE      PVIBILL,KEY8
.
.         Get the next transaction number
.
UPDP1300  CALL      TRVISA1
.
          MOVE      PVITRAN,PMMITRAN
          MOVE      PMMITRAN,ATRANNO
          MOVE      TADMNO,PMMIVISN
.
          PACK      KEY14,PMMIVISN,PMMITRAN     
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      UPDP1300 IF EQUAL
.
          MOVE      MITMTYP,PMMIRTYP
          MOVE      " 3",PMMISYST
          MOVE      TSESSION,PMMISESS
          CALL      SETMTI00
.
.         Set service time to Start time if necessary
.
          MATCH     "1",PRITEMIN
          GOTO      UPDP1320 IF EQUAL
.
          IF        MBSFLAG=1
            BRANCH    CUSEMBS,UPDP1310,UPDP1310
          ENDIF
          GOTO      UPDP1320
.
UPDP1310  MOVE      ":00",KEY3
          PACK      PMMISVTM,MMSTIM,KEY3,SP8
.
UPDP1320  CALL      CIPMTI00
.
          MATCH     "1",PMTIFLAG
          IF        @EQUAL
            PACK      KEY14,PMMIVISN,PMMITRAN,SP70
            CALL      WRPMMTI1
          ELSE
            PACK      KEY36,PMMTIKEY,SP70
            CALL      RDOPREQ1
            IF        OVRCD=0
              MOVE      "2",OPRQCHRG
              CALL      UPOPREQ1
            ENDIF
          ENDIF
.
.       Update the control file with the transfer date if neccessary
.
          PACK      DIM6 WITH TFCENT,TFYEAR,TFMONTH
          REP       " 0",DIM6
          READ      CONTROLF,EIGHTY;*148,CFRDTE
          MATCH     CFRDTE,DIM6
          GOTO      UPDP1400 IF NOT LESS
          MOVE      DIM6,CFRDTE
          WRITAB    CONTROLF,EIGHTY;*148,CFRDTE
.
.       Update next transaction number in admission record
.
UPDP1400  ADD       ONE,ATRANNO
          MOVE      ATRANNO,SAVTRNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
.
.        Update and Release Admission record
.
          MOVE      SAVTRNO,ATRANNO
          PACK      PTMIWEBU,USERID,SP70
          CALL      UPMISS1
          GOTO      UPDP8000
.
. Update the outpatient files
.
UPDP2000  MOVE      PVIBILL,PMMIVISN
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
.
.        Get the next transactions number
.
UPDP2100  CALL      TRVISA1
.
          MOVE      PVITRAN,PMMITRAN
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      UPDP2100 IF EQUAL
.
          MOVE      "3",PMMIRTYP
          MATCH     "1",PRITEMIN
          IF        @EQUAL
            MOVE      "2",PMMIRTYP
          ENDIF
          IF        MBSFLAG=1
            MOVE      "2",PMMIRTYP             * Theatre Fee
          ENDIF
          MOVE      " 2",PMMISYST
          CALL      SETMTI00
.
          CALL      CIPMTI00
.
          MATCH     "1",PMTIFLAG
          IF        @EQUAL
            PACK      KEY14,PMMIVISN,PMMITRAN,SP70
            CALL      WRPMMTI1
          ELSE
            PACK      KEY36,PMMTIKEY,SP70
            CALL      RDOPREQ1
            IF        OVRCD=0
              MOVE      "2",OPRQCHRG
              CALL      UPOPREQ1
            ENDIF
          ENDIF
. 
          GOTO      UPDP8000
.
.        Update the A & E files
.
UPDP3000  
.         Check if invoice printed and item is to be charged
.
.         CALL      EINV0000
.         BRANCH    INVCFLAG,UPDP9999     * No invoice pending amount
.
          MOVE      PVIBILL,PMMIVISN
          MOVE      PVIBILL,KEY8
.
UPDP3100  CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      UPDP3100 IF EQUAL
.
          MOVE      "3",PMMIRTYP
          MOVE      " 1",PMMISYST
          CALL      SETMTI00
          MOVE      TPATAMTG,PMMIAMTG     * Save the entered amount
.
          MATCH     "1",EMCNGINV          * group item by service doctor?
          IF        @EQUAL
            PACK      PMMIEDAD,ADADOCT,SP70
          ENDIF
.
.         If parameter for displaying Out of Pocket is turned on, then
.         Misc.charges goes to Patient Portion
.
          MATCH     "1",EMCNDPOC
          IF        @EQUAL
            MOVE      PMMIAMTT,PMMIAMTP
            MOVE      ZERO,PMMIRBAT
          ENDIF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      USERID,PMMIWUSR        * WEB user id
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
.
          CALL      CIPMTI00
.
          MATCH     "1",PMTIFLAG
          IF        @EQUAL
            PACK      KEY14,PMMIVISN,PMMITRAN,SP70
            CALL      WRPMMTI1
          ELSE
            PACK      KEY36,PMMTIKEY,SP70
            CALL      RDOPREQ1
            IF        OVRCD=0
              MOVE      "2",OPRQCHRG
              CALL      UPOPREQ1
            ENDIF
          ENDIF
.
.  Add a new entry,the Invoices Pending file if there not already there.
.
UPDP8000  IF        PTCNIPEN=0
            CALL      CUIP0000              * Check Inv.pending update flag
.
            IF        CHOSTYP=1 & CFEETYP=0
              COMPARE   THREE,PVITYPE
              GOTO      UPDP8400 IF EQUAL      * Inpatient public hospital
            ENDIF
.
            MOVE      PVIBILL,IPADMNO
            MOVE      PVITYPE,IPSYSTM
            CALL      CEVT0000                 * Check for Events
            MATCH     "1",KEY1
            IF        @EQUAL
              MOVE      ONE,IPSYSTM            * Emergency visit
            ENDIF
            MOVE      PVISITE,IPSITE
.
            CALL      HOLD0000                 * Check HF/Claim on hold
.
            MOVE      SEVEN,PTIPRSTA
            MOVE      SP70,PTIPSVAR
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RAIPEN1
            IF        OVRCD=1
              CALL      WRIPEN1
            ELSE
              MATCH     SP70,KEY83
              IF        !@EQUAL
                UNPACK    KEY83,PTIPRHLD,PTIPRDES  * restore reason on hold inv.
              ENDIF
              CALL      UPIPEN1
            ENDIF
          ENDIF
          GOTO      UPDP9000
.
.         Public hospital - checks to be invoiced amount before write to patipen
.
UPDP8400  MOVE      SEVEN,PTIPRSTA
          MOVE      PMMITDAT,PENDSDAT             * as at date
          CALL      CINVP000                      * Check for tobe invoiced
.
UPDP9000  IF        PVITYPE=THREE
            MOVE      "A",DIM1
            MOVE      PMMIITEM,MCHARGE
            PACK      CURRDATE,CCC,CYY,CMM,CDD,SP70
            REP       " 0",CURRDATE
            CALL      PROTRK00
          ENDIF
.
          MOVE      ZERO,EXIT
.
UPDP9999  RETURN
.
.------------------------------------------------------------------------------
. Check category FI to see if pmsmtiaf needed to be updated
. Input :  PMMIMGRP - Misc Group 
. Output:  PMTIFLAG - pmsmtiaf to be written flag
.------------------------------------------------------------------------------
CIPMTI00  MOVE      "0",PMTIFLAG
.
          MATCH     SP70,PMMIMGRP
          GOTO      CIPMTI80 IF EQUAL
.
          MOVE      "FI",DIM2
          PACK      KEY5,DIM2,PMMIMGRP,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            GOTO      CIPMTI80
          ENDIF
.
          MATCH     "I",PTCOACTV            * Inactive?
          IF        @EQUAL
            GOTO      CIPMTI80
          ENDIF
.
          MATCH     "1",TCINDC9
          GOTO      CIPMTI80 IF NOT EQUAL
.
          GOTO      CIPMTI99
.
CIPMTI80  MOVE      "1",PMTIFLAG 
.
CIPMTI99  RETURN  
+
.------------------------------------------------------------
. Check HF/Claim on hold
.------------------------------------------------------------
HOLD0000  MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            PACK      KEY8,IPADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP        * Hospital ID
            ENDIF
          ENDIF
.
          IF        PVITYPE=1
            PACK      KEY8,IPADMNO,SP70
            CALL      RDEMVIS1
            IF        OVRCD<>1
              MOVE      EMVIDATE,PENDSDAT        * as at date
              MOVE      EMVIDATE,PENDADAT        * visit date
              MOVE      SP70,PENDDDAT
              IF        EMVISTAT=2 | EMVISTAT=3
                MOVE      EMVIDDAT,PENDDDAT      * discharged date
              ENDIF
              MOVE      EMVIFUND,PENDFUND               * ED
              MOVE      EMVICOMP,PENDCLAM
              MOVE      " 1",PENDSYST            * System
              CALL      IPRH0000
            ENDIF
          ENDIF
.
          IF        PVITYPE=2
            PACK      KEY8,IPADMNO,SP70
            CALL      RDBOKB1
            IF        OVRCD<>1
              MOVE      OBADATE,PENDSDAT         * as at date
              MOVE      OBADATE,PENDADAT         * Visit date
              MOVE      OBADATE,PENDDDAT         * discharged date
              MOVE      OTBBFUND,PENDFUND               * OP
              MOVE      OBACOMP,PENDCLAM
              MOVE      " 2",PENDSYST            * System
              CALL      IPRH0000
            ENDIF
          ENDIF
.
          IF        PVITYPE=3
            PACK      KEY8,IPADMNO,SP70
            CALL      RDMISS1
            IF        OVRCD<>1
              MOVE      PMMITDAT,PENDSDAT             * as at date
              MOVE      ADATE,PENDADAT                * admission date
              MOVE      SP70,PENDDDAT
              IF        ASTAT=3
                CALL      RDDSCH1
                IF        OVRCD=0
                  MOVE      DDATE,PENDDDAT            * discharged date
                ENDIF
              ENDIF
              MOVE      AFUNDH,PENDFUND               * IP
              MOVE      ACLAIM,PENDCLAM
              MOVE      " 3",PENDSYST                 * System
              CALL      IPRH0000
            ENDIF
          ENDIF
.
HOLD9999  RETURN
.
.------------------------------------------------------------
. Set up for inpatient item pending file
.------------------------------------------------------------
SETMTI00  MOVE      PVIURNO,PMMIURNO
          IF        CFEETYP=9
            MOVE      PTMCALGR,PMMIMGRP      * Misc.Charge group Cat FN
            PACK      PMMIBTCH,MMSCGRP,SP70  * Misc.Charge group Cat FI
          ELSE
            MOVE      MMSCGRP,PMMIMGRP
            MOVE      ONE,PMMIBTCH
          ENDIF
          MOVE      MNINV,PMMIINVN
          MOVE      ZERO,PMMIAMTG
.
          MOVE      ZERO,PMMIAMTH
          PACK      PMMITDAT WITH TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",PMMITDAT
          MOVE      MCHARGE,PMMIITEM
          MOVE      TRECEIPT,PMMIREFN       * Reference no
.
.         If this is a multiple item then multiply the charges
.
          PACK      PMMIDESC,MDESC,SP70
          PACK      PMMIDES2,SP20,SP20
          IF        CFEETYP=5
            UNPACK    MISCDESC,PMMIDESC,PMMIDES2
          ENDIF
.
          BRANCH    MULTNUM,SETMTI40
          MULT      MULTNUM,PMMIAMTT
.           
SETMTI40  MOVE      MULTNUM,PMMISERV
          MOVE      ZERO,PMMIGSTA         * GST applicable
          MOVE      SP10,PMMIGSTC         * GST code
          MOVE      ZERO,PMMIGSTM
          IF        IBCNUGST=2 
            MOVE      PTMCGSTA,PMMIGSTA
            MOVE      PTMCGSTC,PMMIGSTC
          ENDIF
          IF        IBCNUGST=3
            MOVE      "1",PMMIGSTA
            MOVE      PTCNAGST,PMMIGSTC
          ENDIF
.
.         If this is SX keyin-price item, then save keyin amt to pmmiamtg
.         because for item include in contract will have zero amount
.
          IF        CFEETYP=5
            MATCH     " 3",PMMISYST
            IF        @EQUAL
              MATCH     "0",NZINCTYP              * Include in contract item
              IF        @EQUAL
.               MATCH     "Y",NZMCKPRI            * Keyin price
.               IF        @EQUAL
                  MOVE      TPATAMTG,PMMIAMTG     * Save the entered amount
.               ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP10,PMMIODOC
          MOVE      SP10,PMMITDOC
          MOVE      USERID,PMMIWUSR          * WEB user id
          MOVE      "0",PMMIMVBR             *  Pack item
          IF        CFEETYP=5
            MATCH     "1",NZEXPITM
            IF        @EQUAL
              MOVE      "1",PMMIMVBR
            ENDIF
          ENDIF
.         PACK      PMMIUNIQ,SP70
          MOVE      UNIQUEKY,PMMIUNIQ
          IF        CFEETYP=5
            PACK      PMMISUNQ,NZUNIQUE,SP70
          ELSE
            PACK      PMMISUNQ,THEABAND,SP70
          ENDIF
          PACK      PMMIINCT,NZINCTYP,SP70
          UNPACK    SP70,PMMISUBN,PMMIEDAD,PMMISVTM
          UNPACK    SP70,PMMICCON,PMMIITYP
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          CALL      IBACLOCK
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR
          MOVE      CTIMEIS,PMMISVTM
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
.
..-----------  Eclipse Bulk billing                             *T0859743-start
.
          MATCH     "1",PTCNUEBB             * Using Elipse Bulk billing 
          IF        !@EQUAL
            MATCH     "1",PTCNBBSW
            IF        !@EQUAL 
              MATCH     "1",PTCNDVAW
              GOTO      SETMTI70 IF NOT EQUAL 
            ENDIF
          ENDIF
.
          MATCH     "1",TYPEBBIL             * Eclipse Bulk Billing type
          IF        !@EQUAL
            MATCH     "1",TYPEDVAW
            GOTO      SETMTI70 IF NOT EQUAL
          ENDIF
.
          PACK      PMMIACOI,ACOVRIDE,SP70   * After Care Override Indicator
          PACK      PMMIDSOV,DUPSROVR,SP70   * Duplicate Service Override
          PACK      PMMISTXT,SERVTEXT,SP70   * Service Text
          PACK      PMMILSPN,LSPNVNUM,SP70   * Location Specific Practice No
          PACK      PMMISUBN,SUBITEMN,SP70   * Sub Item Number
          PACK      PMMIMGRP,SETCMGRP,SP70   * Set Code / Misc Grp
          PACK      PMMIMPOV,MULPROVR,SP70   * Multi Procedure Override
          PACK      PMMINMPT,NUMPTSEE,SP70   * Number of Patients Seen
          PACK      PMMISDCD,SLDMCODE,SP70   * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,DURATIME,SP70   * Time Duration (Mins)
          PACK      PMMIROVR,ROVRCODE,SP70   * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,HOSPINDI,SP70   * Hospital Indicator 
          MOVE      SP70,PMMISPAR
.
          MATCH     "1",PTCNDVAW
          IF        @EQUAL
            MATCH     "1",TYPEDVAW
            IF       @EQUAL
              PACK      PMMIDKSM,DISTAKMS,SP70
            ELSE
              MOVE      SP70,PMMIDKSM
            ENDIF
          ELSE 
            MOVE      SP70,PMMIDKSM
          ENDIF
.
          GOTO      SETMTI99
.-----------                                                   *T0859743-end
.
SETMTI70  PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
          GOTO      SETMTI99
.
SETMTI99  RETURN
+
.**********************************************************************
.*                              UGTU0000                              *
.*                   Write/Update unknown GST file if necessary       *
.**********************************************************************
UGTU0000  COMPARE   TWO,PMMIGSTA
          GOTO      UGTU9999 IF NOT EQUAL   * Not unknown
.
          MOVE      "2",PTMCGSTA            * Unknown GST Applicable flag
          MOVE      SP8,PTMCGSTC
          MOVE      PMMIVISN,PTGTADMN
          PACK      KEY8,PMMIVISN
          CALL      RDPTGTU1                * Check if a record exists
          IF        OVRCD=0
            MOVE      ONE,PTGTGSTM          * set up unknown GST misc.
            CALL      UPPTGTU1             
          ELSE
            MOVE      ZERO,PTGTGSTA  
            MOVE      ONE,PTGTGSTM          * set up unknown GST misc.
            CALL      WRPTGTU1
          ENDIF
UGTU9999  RETURN
+
.**********************************************************************
.*                              CTEMP000                              *
.*                   Create the Indexed Temp File                     *
.**********************************************************************
CTEMP000  CALL      DTEMP000           * kill existing temp file
.
.------ Build new indexed temp file ------
.
          PACK      KEY90,SP70,SP70
          CLEAR     KEY90
          APPEND    "isbuild ",KEY90
          APPEND    FNAMET1,KEY90
          APPEND    " 492 UC1-8,9-10,11-18,19-25,26-30,31-38 UC31-38",KEY90
          RESET     KEY90
          EXECUTE   KEY90,TASKID
.
          OPEN      ITEMFIL1,FNAMET1
          OPEN      ITEMFIL2,FNAMET1
.
          PACK      KEY90,SP70,SP70
          CLEAR     KEY90
          APPEND    "isbuild ",KEY90
          APPEND    FNAMET2,KEY90
          APPEND    " 22 UC1-17",KEY90
          RESET     KEY90
          EXECUTE   KEY90,TASKID
          OPEN      TEMP1,FNAMET2
.
          CLEAR     KEY90
          APPEND    "isbuild ",KEY90
          APPEND    FNAMET3,KEY90
          APPEND    " 22 UC1-2,3-10",KEY90
          RESET     KEY90
          EXECUTE   KEY90,TASKID
          OPEN      TEMP2,FNAMET3
.
CTEMP999  RETURN
+
.**********************************************************************
.*                              DTEMP000                              *
.*                 Kill the Temp file if it already exists            *
.**********************************************************************
DTEMP000  PACK      KEY60,SP70
          CLEAR     KEY60
          CLOSE     ITEMFIL1
          CLOSE     ITEMFIL2
          CLOSE     TEMP1
          CLOSE     TEMP2
.
          APPEND    "iserase ",KEY60
          APPEND    FNAMET1,KEY60
          RESET     KEY60
          EXECUTE   KEY60,TASKID
.
          PACK      KEY60,SP70
          CLEAR     KEY60
          APPEND    "iserase ",KEY60
          APPEND    FNAMET2,KEY60
          RESET     KEY60
          EXECUTE   KEY60,TASKID
.
          PACK      KEY60,SP70
          CLEAR     KEY60
          APPEND    "iserase ",KEY60
          APPEND    FNAMET3,KEY60
          RESET     KEY60
          EXECUTE   KEY60,TASKID
.
DTEMP999  RETURN
+
.----------------------------------------------------------------------
. Subroutine to post a journal to an account
.----------------------------------------------------------------------
UJNL0000  MOVE      ZERO,EXIT
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1
          CALL      CHKD0000                * get the DTR record
          COMPARE   ZERO,OVRCD
          GOTO      UJNL0000 IF EQUAL
.
.         Outpatient visit who had been un-attended(where visit record removed),
.         the transaction counter for the visit might have been Reset'd
.         so Check if the transaction number from visit record already exists
.         in patjrnlf file
.
          IF        PVITYPE=2
            MOVE      TTYPE,JCODE
            PACK      JDATE WITH CCC,CYY,CMM,CDD  * use current date
            REP       " 0",JDATE
            MOVE      PVITRAN,JTRNS
            PACK      KEY24 WITH JCODE,JDATE,PVIBILL,JTRNS,SP70
            CALL      RDAJRNL1
            COMPARE   ZERO,OVRCD
            GOTO      UJNL0000 IF EQUAL
          ENDIF
          MOVE      PVITRAN,TTRANSN1
          MOVE      TTRANSN1,ATRANNO
.
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP        * Inpatient
          MOVE      ZERO,TREBATE
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTM
          MOVE      SP70,PTDTGSTC
.
          MATCH     "G",JTYPE
          GOTO      UJNL0200 IF NOT EQUAL
.
          MOVE      GSTAMT,PTDTGSTM       * GST Adjustment amount
          MULT      SEQ,PTDTGSTM
          MOVE      PTDTGSTM,OTDTGSTM
          MULT      SEQ,GSTAMT
          MOVE      GSTCODES,PTDTGSTC
          MOVE      GSTCODES,OTDTGSTC
          GOTO      UJNL0300
.
UJNL0200  MATCH     "R",JTYPE
          IF        @EQUAL
            MOVE      ZERO,TPATAMTT
            MOVE      JOURAMTT,TREBATE
          ELSE
            MOVE      JOURAMTT,TPATAMTT
            MOVE      ZERO,TREBATE
          ENDIF
.
UJNL0300  MOVE      "P",TTYPEDEB
          MATCH     "A",JTYPE              * Adjustment Journal
          IF        @EQUAL
            MULT      SEQ BY TPATAMTT   * Reverse sign adj journals(DTRAN only)
          ENDIF
.
          MATCH     SP70,JOURDESC
          IF        @EQUAL
            MOVE      TDESC,TDDESC
          ELSE
            MOVE      JOURDESC,TDDESC
          ENDIF
.
          CALL      SETJNL00
.
          MATCH    "R",JTYPE
          GOTO     UJNL3000 IF EQUAL
.
          MOVE     "C",FINTYPE
          IF       PTCNJFEE=1
            PACK     FINCODE,ACLAIM,TTYPE,SP20
.                            Claim Code, Journal Code
          ELSE
            PACK     FINCODE,TTYPE,SP20
.                            Journal Code
          ENDIF
.
          MOVE     TPATAMTT,FINAMT
          PACK     FINDATE,CCC,CYY,CMM,CDD
          REP      " 0",FINDATE
.
          IF       CJRNREP=1
            MOVE     JOURDATE,FINDATE
            REP      " 0",FINDATE
          ENDIF
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          MOVE     PVITYPE,FINSYS
          CALL     CEVT0000                 * Check for Events
          MATCH    "1",KEY1
          IF       @EQUAL
            MOVE     ONE,FINSYS             * Emergency system
          ENDIF
          MOVE     PINVSITE,FINSITE
.
          MATCH    "G",JTYPE
          IF       @EQUAL
            IF       GSTAMT<>0
              MOVE     GSTAMT,FINAMT
              MULT     SEQ,FINAMT
              MOVE     ONE,FGSTFLAG
              MOVE     PMVXMHOS,FINHOSP
              CALL     PATCALF
            ENDIF
          ELSE
            MOVE     TPATAMTT,FINAMT
            MOVE     ZERO,FGSTFLAG
            MOVE     PMVXMHOS,FINHOSP
            CALL     PATCALF
          ENDIF
.
.         SEQ IS A FORM -1
.
          MULT      SEQ,TPATAMTT
          MULT      SEQ,ATPATAMT
          MULT      SEQ,OTPATAMT
.
          GOTO      UJNL4000
.
UJNL3000  MOVE      ZERO,TPATAMTP        * Inpatient
          SUB       TREBATE,TPATAMTP
.
          MOVE      ZERO,OTPATPOR        * Outpatient
          SUB       OTREBPOR,OTPATPOR
.
          MOVE      ZERO,ATPATPOR        * A&E
          SUB       ATREBPOR,ATPATPOR
.
UJNL4000  BRANCH    PVITYPE OF UJNL4300,UJNL4200,UJNL4100,UJNL4150
          CALL      CEVT0000                 * Check for Events
          MATCH     "1",KEY1
          GOTO      UJNL4300 IF EQUAL        * Emergency event
          GOTO      UJNL9999
.
.         Inpatient invoice
.
UJNL4100  PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      WRDTRN1
          GOTO      UJNL5000
.
UJNL4150  MOVE      "out",OSTFILE
          GOTO       UJNL4220 
.
.         Outpatient invoice
.
UJNL4200  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1
.
UJNL4220  MOVE      ZERO,OTSERVS
          MOVE      SP70,OTDTDSKM
          MOVE      SP70,OTSPARE 
.
          PACK      CFNAME,OSTFILE,FILDTRO1
          PACK      KEY22 WITH OTNUMB,OTINVNO,OTTRANS,SP70
          OPEN      OUTDTRO1,CFNAME
.
          CALL      WRDTRO1
          CLOSE     OUTDTRO1
          MOVE      OTNUMB,TADMNO
          GOTO      UJNL5000
.
.         A & E invoice
.
UJNL4300  PACK      KEY22 WITH ATNUMB,ATINVNO,ATTRANS,SP70
          CALL      WRDTRE1
          MOVE      ATNUMB,TADMNO
.
.         Update the Journal summary file
.
UJNL5000  MOVE      TTYPE,JCODE
          PACK      JDATE WITH CCC,CYY,CMM,CDD  * use current date
          REP       " 0",JDATE
.
          COMPARE   ONE,CJRNREP
          GOTO      UJNL5100 IF NOT EQUAL
.
          MOVE      JOURDATE,JDATE
          REP       " 0",JDATE
.
UJNL5100  MOVE      TADMNO,JADMN
          MOVE      TTRANSN1,JTRNS
          MOVE      PINVNO,JINVN
          MOVE      SP70,PTJRINDC
.
          MOVE      USERID,PTJRCUID              * Created by
          PACK      PTJRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTJRCDAT                * Date created
          CLOCK     TIME,PTJRCTIM                * Time created
          MOVE      SP70,JSPARE
.
          PACK      KEY24 WITH JCODE,JDATE,JADMN,JTRNS,SP70
          CALL      WRJRNL1
.
          MATCH     "B",JTYPE               * Bad Debt Journal
          GOTO      UJNL6000 IF NOT EQUAL
.
.         UPDATE BAD DEBT INDICATOR IN MASTER FILE
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1                 * read and lock masterfile
          BRANCH    OVRCD,UJNL9900
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ONE,PBDEBT              * move "1",bad debt indicator
          CALL      UPMAST1                 * update master
.
.         NOW ADD TPATAMTP,JOURNAL FIELD IN INV1
.         NEG TAKEN CARE OF ABOVE
.
UJNL6000  MOVE      PINVNO,KEY8
          CALL      RDPTINV1
          BRANCH    OVRCD,UJNL9900
.
          MATCH     "R",JTYPE
          GOTO      UJNL6100 IF EQUAL
          ADD       TPATAMTT,PINVJOUR
.
          MATCH     "G",JTYPE
          GOTO      UJNL6200 IF NOT EQUAL
          ADD       GSTAMT,PTINGSTJ         * Add GST adjustment journal 
          GOTO      UJNL6200
.
UJNL6100  ADD       TREBATE,PINVREB
.
.         Check if the invoice now balances
.
UJNL6200  MOVE      PINVAMT,FORM102      * Invoice amount +
          ADD       PINVPATA,FORM102     * Patient payments +
          ADD       PINVHFDA,FORM102     * H.F payments +
          ADD       PINVOTHA,FORM102     * Other payments +
          ADD       PTINCRTT,FORM102     * Credit Notes +
          ADD       PINVJOUR,FORM102     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM102     * Journal GST = amount outstanding
.
          MOVE      "99999999",PINVBLCD  * Assume it doesn't balance
.
          COMPARE   ZERO,FORM102         * Does it balance ?
          GOTO      UJNL8000 IF NOT EQUAL
.
.         Invoice is now balanced. Record the date that this occured
.
          PACK      PINVBLCD,CCC,CYY,CMM,CDD
          REP       " 0",PINVBLCD
.
UJNL8000  PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
          IF        FORM102<=0
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            CALL      UPFAPPLN           * Update FA Completion date
          ENDIF
.
          PROC      FLAGDEBT
.
          COMPARE   ONE,CINVJRN
          CALL      UPDJRN00 IF EQUAL
.
.         Update the control file with the transfer date if neccessary
.
          PACK      DIM6,TFCENT,TFYEAR,TFMONTH
          REP       " 0",DIM6
          MOVE      ZERO,EXIT
          READ      CONTROLF,EIGHTY;*148,CFRDTE
          MATCH     CFRDTE,DIM6
          GOTO      UJNL9999 IF NOT LESS
          MOVE      DIM6,CFRDTE
          WRITAB    CONTROLF,EIGHTY;*148,CFRDTE
          GOTO      UJNL9999
.
UJNL9900  MOVE      "Invoice Error Contact IBA ",WEBTITLE
          IF        BULKFLAG=1
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ELSE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      UJNL9999
.
UJNL9999  RETURN
+
.----------------------------------------------------------------------
. CHKD0000 : Check the Debtors Transaction Records
.            Set up key depending on the system (A+E, Outpatient, Inpatient)
.----------------------------------------------------------------------
CHKD0000  BRANCH    PVITYPE,CHKD1000,CHKD2000,CHKD3000,CHKD2000
.
.         A & E Dtran
.
CHKD1000  PACK      KEY22,PVIBILL,PINVNO,PVITRAN
          CALL      RDADTRE1
          GOTO      CHKD9999
.
.         Outpatient Dtran
.
CHKD2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1
.
          PACK      CFNAME,OSTFILE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      KEY22,PVIBILL,PINVNO,PVITRAN
          CALL      RDADTRO1
          GOTO      CHKD9999
.
.         Inpatient Dtran
.
CHKD3000  PACK      KEY22,AADMNO,PINVNO,PVITRAN
          CALL      RDADTRN1
.
CHKD9999  RETURN
.
.
SETJNL00  BRANCH    PINVSYS OF SETJNL10,SETJNL20,SETJNL30,SETJNL20
+
.         A & E Dtran setup
.
SETJNL10  MOVE      PVIBILL,ATNUMB
          MOVE      PINVNO,ATINVNO
          MOVE      TTRANSN1,ATTRANS
          MOVE      TDDESC,ATDDESC
          MOVE      TPATAMTT,ATPATAMT
          MOVE      TPATAMTT,ATPATPOR
          MOVE      TREBATE,ATREBPOR
          MOVE      JOURDATE,ATDDATE
          REP       " 0",ATDDATE
          UNPACK    JOURDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          MOVE      PTDTGSTA,ATDTGSTA
          MOVE      PTDTGSTM,ATDTGSTM
          MOVE      PTDTGSTC,ATDTGSTC
.
          MOVE      SP10,ATITEMNO
          MOVE      TTYPE,ATTYPE
          MOVE      ZERO,ATPAYTYP
          MOVE      SP20,ATRECEPT
          MOVE      ONE,ATINVPRT
          MOVE      THREE,ATRECTYP
          MOVE      SP3,ATMISGRP
          MOVE      SP3,ATDEPTYP
          MOVE      ZERO,ATBATCHN
          MOVE      ZERO,ATSPARE1
          MOVE      ZERO,ATSPARE2
          MOVE      SP70,ATSPARE
          PACK      ATDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",ATDTEFFD
.
          MOVE      ZERO,ATDTSCHF
          MOVE      SP70,ATDTITYP
          MOVE      SP70,ATDTRBRS 
          MOVE      SP70,ATDTPCOD
.
          PACK      ATDTACOI,SP70       * After Care Override Indicator
          PACK      ATDTDSOV,SP70       * Duplicate Service Override
          PACK      ATDTSTXT,SP70       * Service Text
          PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      ATDTMPOV,SP70       * Multi Procedure Override
          PACK      ATDTNMPT,SP70       * Number of Patients Seen
          PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      ATDTTDUR,SP70       * Time Duration (Mins)
          PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
          GOTO      SETJNL99
+
.         Outpatient Dtran setup
.
SETJNL20  MOVE      PVIBILL,OTNUMB
          MOVE      PINVNO,OTINVNO
          MOVE      TTRANSN1,OTTRANS
          MOVE      TDDESC,OTDDESC
          MOVE      TPATAMTT,OTPATAMT
          MOVE      TPATAMTT,OTPATPOR
          MOVE      TREBATE,OTREBPOR
          MOVE      JOURDATE,OTDDATE
          REP       " 0",OTDDATE
          UNPACK    JOURDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          MOVE      PTDTGSTA,OTDTGSTA
          MOVE      PTDTGSTM,OTDTGSTM
          MOVE      PTDTGSTC,OTDTGSTC
.
          MOVE      SP10,OTITEMNO
          MOVE      TTYPE,OTTYPE
          MOVE      ZERO,OTPAYTYP
          MOVE      SP8,OTRECEPT
          MOVE      ONE,OTINVPRT
          MOVE      THREE,OTRECTYP
          MOVE      SP3,OTMISGRP
          MOVE      SP3,OTDEPTYP
          MOVE      ZERO,OTBATCHN
          MOVE      ZERO,OTNINVS
          MOVE      ZERO,OTSERVS
          PACK      OTDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",OTDTEFFD
          MOVE      SP70,OTDTPCOD
          MOVE      SP70,OTDTDSKM
          MOVE      SP70,OTSPARE 
          GOTO      SETJNL99
.
.         Inpatient Dtran setup
.
SETJNL30  MOVE      PVIBILL,TADMNO                              (key field)
          MOVE      PINVUR,TDCODE
          MOVE      SIX,TRECTYPE            * RECORD TYPE JOURNAL
          MOVE      ONE,TINVPRT             * set PRINT FLAG
          MOVE      ZERO,TPATAMTG
          MOVE      ZERO,TPATAMTH
          MOVE      ZERO,TPATAMTI
          MOVE      TPATAMTT,TPATAMTP
          MOVE      ZERO,TTDAY
          MOVE      ZERO,TTMONTH
          MOVE      ZERO,TTYEAR
          MOVE      ZERO,TTCENT
          MOVE      SP10,TITEMNO
          MOVE      SP3,TMISGRP
          MOVE      ZERO,TPAYTYPE
          MOVE      PINVNO,TREF             * PUT ONTO INVOICE  (key field)
          MOVE      ZERO,TNODAYS
          UNPACK    SP70,TDOCTA,TDOCTO,TSESSION,TDEPTYP,TDWARD:
                         PTDTCNTR,PTDTCPRC,PTDTCONT,PTDTSUNQ,PTDTBTCH
          MOVE      ZERO,TSERVS
          MOVE      ZERO,PTDTGSTL
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
.
          MOVE      SP20,TRECEIPT            * should key in ref
          MOVE      ZERO,TCLAIM
          MOVE      PINVCLM,TCLMTYP
          MOVE      SP70,TADMTYP
          MOVE      ZERO,TBATCHN
          MOVE      SP70,PTDTBTYP
          MOVE      ZERO,PTDTLSPT
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MOVE      ZERO,PTDTDTYP
          MOVE      ZERO,PTDTEPSD
          MOVE      ZERO,PTDTCCU
..          MOVE      SP6,PTDTSURG
..          MOVE      ZERO,PTDTAPAY
          PACK      PTDTDES2,SP20,SP20
          PACK      PTDTUNIQ,SP70
          MOVE      SP8,PTDTTIME                                       *I-61746
          MOVE      SP1,PTDTCRST                                       *I-61746
          PACK      TSPARE,SP30,SP30
          UNPACK    JOURDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
..          MOVE      SP10,PTDTDEPS
          PACK      PTDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",PTDTEFFD
          MOVE      SP70,PTDTTMNO
          MOVE      SP70,PTDTPMBS
          MOVE      SP70,PTDTPCOD
.
SETJNL99  RETURN
+
.         Subroutine to write to patient invoice with journal file
.
UPDJRN00  MOVE      ZERO,BATCHNO
          PACK      KEY16,BATCHNO,PINVNO
          CALL      RDIJRN1
          COMPARE   ZERO,OVRCD
          RETURN    IF EQUAL
.
          MOVE      PINVNO,IJINVNO
          MOVE      PVIBILL,IJADMNO
          MOVE      BATCHNO,IJBATCH
          MOVE      SP20,IJSPARE
          CALL      WRIJRN1
          RETURN
.------------------------------------------------------------
. Validate Patient
.------------------------------------------------------------
VALPAT00  MOVE      "0",CMBSFEE
          MOVE      PGNAME,ANS
          PACK      PNAME,ANS,DOT,PSNAME
          MOVE      PVIBILL,AADMNO
          BRANCH    PVITYPE OF VALPAT10,VALPAT20,VALPAT30,VALPAT50
          CALL      CEVT0000                 * Check for Events
          MATCH     "1",KEY1
          GOTO      VALPAT90 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,VALPAT90
.
          MOVE      PMEVACON,ADADOCT
          MOVE      PMEVADTE,ADADATE
          MOVE      PMEVCCOD,ACLAIM
          MOVE      SP70,ACLSS
          MOVE      PMEVDDTE,DDATE
          MOVE      PMEVADTE,XDATE2
          MOVE      TWO,ASTAT            * not discharged - treat as in.
          GOTO      VALPAT12
.
.         A & E Invoice
.
VALPAT10  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,VALPAT90
.
          CALL      RDDETA1
          BRANCH    OVRCD,VALPAT90
.
          MOVE      EMVIDATE,ADADATE
          MOVE      EMVICOMP,ACLAIM
          MOVE      EMVICLAS,ACLSS
          MOVE      EMVIDDAT,DDATE
          MOVE      EMVIDATE,XDATE2
.
          MATCH     SP70,EMVIDDAT
          IF        @EQUAL
            MOVE      TWO,ASTAT            * not discharged - treat as in.
          ELSE
            MOVE      THREE,ASTAT          * treat as being discharged
          ENDIF
.
VALPAT12  MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      ZERO,EXIT
          GOTO      VALPAT99
.
.         Outpatient Invoice
.
VALPAT20  MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PVIBILL,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,VALPAT90
.
          MOVE      OBACOMP,ACLAIM
          UNPACK    OBADATE WITH XDATE2
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          MOVE      ZERO,EXIT
          GOTO      VALPAT99
.
.         Inpatient invoice
.
VALPAT30  MOVE      PVIBILL,KEY8
          CALL      RDPTMIS1
          BRANCH    OVRCD,VALPAT90,VALPAT93
          BRANCH    ASTAT OF VALPAT90
.
          MOVE      ADATE,XDATE2
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "1",TCINDC1           * check if overseas
            IF        @EQUAL
              CMATCH    "1",TCINDC2         * check if we are using MBS Amount
              IF        @EQUAL
                MOVE      "1",CMBSFEE
              ENDIF
            ENDIF
          ENDIF
          MATCH     "00000000",ADATE
          GOTO      VALPAT45 IF EQUAL       * Takeup outstanding patient
.
          COMPARE   THREE,ASTAT
          GOTO      VALPAT40 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,VALPAT91
.
          MATCH     SP8,DDATE            * Check for invalid discharged date
          GOTO      VALPAT91 IF EQUAL
.
          MATCH     ADATE,DDATE
          GOTO      VALPAT40 IF NOT EQUAL
          MOVE      ONE,ISDAYC
.
.         Only current admissions, discharges and on-leave allowed
.
VALPAT40  CALL      CTRA0000                * Check for transfer record
          BRANCH    EXIT,VALPAT92
.
VALPAT45  MOVE      ZERO,EXIT
          GOTO      VALPAT99
.
.         Other Financial Invoice
.
VALPAT50  MOVE      PINVDTE,XDATE2
          MOVE      ZERO,EXIT
          GOTO      VALPAT99
.
VALPAT90  MOVE      "Invalid Visit Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALPAT99
.
VALPAT91  MOVE      "Missing Discharge Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALPAT99
.
VALPAT92  MOVE      "** Missing Transfer record ** ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALPAT99
.
VALPAT93  CLEAR     WEBTITLE
          APPEND    "Patient Admission ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " busy on Terminal ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALPAT99
.
VALPAT99  RETURN
.------------------------------------------------------------
.         Post single cash receipt
.------------------------------------------------------------
CASH0000  CALL      RECP0000
          MOVE      INVOICEN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CASH9000
.
          MOVE      PINVADM,ADMISSNO
          MOVE      PINVUR,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CASH9100
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CASH9200
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,ADMISSNO
          CALL      RDPMVX11
.
          CALL      OPNP0000                 * open appropriate files
          BRANCH    EXIT,CASH9999
.
          CALL      LCKI0000                 * lock invoice number
          BRANCH    EXIT,CASH9999
.
          MOVE      PINVNO,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CASH9000
.
CASH0100  MOVE      PINVADM,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1                  * get next transaction number
          CALL      CHKD0000                 * make sure is doesnt exist already
          COMPARE   ZERO,OVRCD
          GOTO      CASH0100 IF EQUAL
.
.         post debtor transaction records
.
          MOVE      TRECEIPT,KEY12A
          CALL      CLPATDTR                 * clear patdtraf record
          MOVE      KEY12A,TRECEIPT
.
          MOVE      PTCSH001,BTYPEF
          MOVE      PTCSH002,TPATAMTT
          MULT      SEQ,TPATAMTT             * make the payment negative
.
          MOVE      SP70,PAYMCODE
          PACK      KEY15,TRECEIPT,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     TRECEIPT,RCBDRECN      * Same receipt number?
            IF        @EQUAL
              MOVE      RCBDPCOD,PAYMCODE
            ENDIF
          ENDIF
.
          CALL      SETD0000                 * set up vars
          CALL      WRTD0000                 * post dtran record
.
.         update the invoice record
.
          ADD       TPATAMTT,PINVPATA
.
.         check in invoice now balances
.
          MOVE      PINVAMT,FORM102
          ADD       PINVPATA,FORM102
          ADD       PINVHFDA,FORM102
          ADD       PINVOTHA,FORM102
          ADD       PINVJOUR,FORM102
          ADD       PTINCRTT,FORM102     * Credit Notes
          ADD       PTINGSTJ,FORM102     * Journal GST = amount outstanding
.
          MOVE      "99999999",PINVBLCD
.
          COMPARE   ZERO,FORM102                * does it balance?
          GOTO      CASH0200 IF NOT EQUAL
.
.         invoice now balanced, record date this occurred
.
          PACK      PINVBLCD,CCC,CYY,CMM,CDD
          REP       " 0",PINVBLCD
.
CASH0200  PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT             * date updated
          CLOCK     TIME,PTINUTIM             * time updated
          MOVE      USERID,PTINUUID           * web user id
          CALL      UPINV1
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
          IF        FORM102<=0
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            CALL      UPFAPPLN           * Update FA Completion date
          ENDIF
.
          PROC      FLAGDEBT
.
.         reslese the invoice record
. 
          CALL      ULKI0000
.
.         update the fees invoiced file
.
          MULT      SEQ,TPATAMTT         * make payment positive again
.
          CALL      SETF0000             * set up the variables
          CALL      PATCALF              * post data to the PATFINS file
.
          MOVE      ZERO,EXIT
          GOTO      CASH9999
.
CASH9000  CLEAR     WEBTITLE
          APPEND    "Invoice number (",WEBTITLE
          APPEND    INVOICEN,WEBTITLE
          APPEND    ") not on file",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASH9999
.
CASH9100  CLEAR     WEBTITLE
          APPEND    "U/R (",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    ") not on file",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASH9999
.
CASH9200  CLEAR     WEBTITLE
          APPEND    "Patient visit(",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          APPEND    ") not on file",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASH9999
.
CASH9999  RETURN
.------------------------------------------------------------
.         OPNP0000: Open the patient files 
.------------------------------------------------------------
OPNP0000  CLOSE     PATDTRA1
          OPEN      PATDTRA1,"patdtraf"
          CLOSE     PATDTRA3
          OPEN      PATDTRA3,"patdtraf"
          CLOSE     PATINVR1
          OPEN      PATINVR1,"patinvrf"
          CLOSE     PATFINS1
          OPEN      PATFINS1,"patfinsf"
          CLOSE     PATHFRE1
          OPEN      PATHFRE1,"pathfrec"
.
          MOVE      ZERO,EXIT               * Initialization completed correctly
          GOTO      OPNP9999
.
OPNP9000  MOVE      ONE,EXIT                * Initialization failure
.
OPNP9999  RETURN
.------------------------------------------------------------
.         LCKI0000 : Lock the Health Fund Receipts Record
.------------------------------------------------------------
LCKI0000  MOVE      PINVNO,KEY8
          CALL      RDHFRE1
          BRANCH    OVRCD,LCKI2000
.
.         Zero means that it is currently not locked
.
          COMPARE   ZERO,HFRSTAT
          GOTO      LCKI1000 IF EQUAL
.
          RESET     WEBTITLE
          APPEND    "Invoice number (",WEBTITLE
          APPEND    INVOICEN,WEBTITLE
          APPEND    ") currently in use, please wait",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LCKI9999
.
.         Lock the record
.
LCKI1000  MOVE      PINVNO,KEY8
          CALL      RLHFRE1
          BRANCH    OVRCD,LCKI2000,LCKI1100
          MOVE      ONE,HFRSTAT
          CALL      UPHFRE1
          CALL      UUHFRE1
          GOTO      LCKI9999
.
LCKI1100  DISPLAY   *W1,"Waiting on Record Locked- PATHFRIO"
          GOTO      LCKI1000
.
.         Create a new record
.
LCKI2000  MOVE      ONE,HFRSTAT
          MOVE      PINVNO,HFRINVR
          CALL      WRHFRE1
.
LCKI9999  RETURN
.------------------------------------------------------------
.         SETD0000 : Set up the Debtors Transaction Records
.         Set up variables depending on the system (A+E, Outpatient, Inpatient)
.------------------------------------------------------------
SETD0000  BRANCH    PINVSYS,SETD1000,SETD2000,SETD3000,SETD2000
.
.         A & E Dtran
.
SETD1000  MOVE      PINVADM,ATNUMB
          MOVE      PINVNO,ATINVNO
          MOVE      PVITRAN,ATTRANS
.
          MOVE      "FROM PATIENT    RECEIPT ##",ATDDESC
          MOVE      TPATAMTT,ATPATAMT
          PACK      ATDDATE,CCC,CYY,CMM,CDD
          REP       " 0",ATDDATE
.
          MOVE      SP10,ATITEMNO
          MOVE      "PY",ATTYPE
          MOVE      BTYPEF,ATPAYTYP
          MOVE      TRECEIPT,ATRECEPT
          MOVE      ONE,ATINVPRT
          MOVE      TWO,ATRECTYP
.
          MOVE      SP3,ATMISGRP
          MOVE      SP3,ATDEPTYP
          MOVE      BATCHND,ATBATCHN
          MOVE      SP70,ATDTBTCH
          MOVE      SP70,ATDTSUBN
          MOVE      SP70,ATDTEDAD
          MOVE      SP70,ATDTSVTM
          MOVE      ZERO,ATDTSCHF
          MOVE      SP70,ATDTITYP
          MOVE      SP70,ATDTRBRS
.
          MOVE      TPATAMTT,ATPATPOR
          MOVE      ZERO,ATREBPOR
..          MOVE      SP10,ATDEPFLG
..          PACK      ATEFFDTE,CCC,CYY,CMM,CDD
..          REP       " 0",ATEFFDTE
          MOVE      ZERO,ATSPARE1
          MOVE      ZERO,ATSPARE2
          MOVE      SP70,ATSPARE
          MOVE      PAYMCODE,ATDTPCOD
          PACK      ATDTACOI,SP70       * After Care Override Indicator
          PACK      ATDTDSOV,SP70       * Duplicate Service Override
          PACK      ATDTSTXT,SP70       * Service Text
          PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      ATDTMPOV,SP70       * Multi Procedure Override
          PACK      ATDTNMPT,SP70       * Number of Patients Seen
          PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      ATDTTDUR,SP70       * Time Duration (Mins)
          PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
          GOTO      SETD9999
.
.         Outpatient Dtran
.
SETD2000  MOVE      PINVADM,OTNUMB
          MOVE      PINVNO,OTINVNO
          MOVE      PVITRAN,OTTRANS
.
          MOVE      "FROM PATIENT    RECEIPT ##",OTDDESC
          MOVE      TPATAMTT,OTPATAMT
          PACK      OTDDATE,CCC,CYY,CMM,CDD
          REP       " 0",OTDDATE
.
          MOVE      SP10,OTITEMNO
          MOVE      "PY",OTTYPE
          MOVE      BTYPEF,OTPAYTYP
          MOVE      TRECEIPT,OTRECEPT
          MOVE      ONE,OTINVPRT
          MOVE      TWO,OTRECTYP
.
          MOVE      SP3,OTMISGRP
          MOVE      SP3,OTDEPTYP
          MOVE      BATCHND,OTBATCHN
.
          MOVE      TPATAMTT,OTPATPOR
          MOVE      ZERO,OTREBPOR
..          MOVE      SP10,OTDEPFLG
..          PACK      OTEFFDTE,CCC,CYY,CMM,CDD
..          REP       " 0",OTEFFDTE
          MOVE      ZERO,OTNINVS
          MOVE      ZERO,OTSERVS
          MOVE      SP70,OTDTBTCH
          MOVE      PAYMCODE,OTDTPCOD
          MOVE      SP70,OTDTDSKM
          MOVE      SP70,OTSPARE 
          GOTO      SETD9999
.
.         Inpatient Dtran
.
SETD3000  MOVE      PINVADM,TADMNO                              (key field)
          MOVE      PVITRAN,TTRANSN1                            (key field)
.
          MOVE      ANSP,TTYPEDEB
          MOVE      PINVUR,TDCODE
.
          MOVE      TPATAMTT,TPATAMTP
          MOVE      ZERO,TREBATE
.
          MOVE      CDD,TFDAY
          MOVE      CMM,TFMONTH
          MOVE      CYY,TFYEAR
          MOVE      CCC,TFCENT
.
          MOVE      "PY",TTYPE
          MOVE      "FROM PATIENT    RECEIPT ##",TDDESC
          MOVE      PINVNO,TREF                                 (key field)
          MOVE      SP10,TITEMNO
          MOVE      SP3,TMISGRP
          MOVE      SP70,PTDTBTYP
          MOVE      ZERO,PTDTLSPT
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTDTYP
          PACK      PTDTDES2,SP20,SP20
          MOVE      ZERO,PTDTCCU
.
          MOVE      BTYPEF,TPAYTYPE
          MOVE      ONE,TINVPRT
          MOVE      FIVE,TRECTYPE
          MOVE      BATCHND,TBATCHN
..          PACK      PTDTSURG,SP10
..          MOVE      ZERO,PTDTAPAY
..          MOVE      SP10,PTDTDEPS
..          PACK      PTDTEFFD,CCC,CYY,CMM,CDD
..          REP       " 0",PTDTEFFD
.
          MOVE      ZERO,PTDTEPSD
          MOVE      SP70,PTDTUNIQ
          MOVE      SP70,PTDTBTCH
          MOVE      SP70,PTDTTMNO
          MOVE      SP70,PTDTPMBS
          MOVE      PAYMCODE,PTDTPCOD
.
SETD9999  RETURN
.------------------------------------------------------------
.         WRTD0000 : Write the Debtors Transaction Records
.         Set up key depending on the system (A+E, Outpatient, Inpatient)
.------------------------------------------------------------
WRTD0000  BRANCH    PINVSYS,WRTD1000,WRTD2000,WRTD3000,WRTD2000
.
.         A & E Dtran
.
WRTD1000  PACK      KEY22,ATNUMB,ATINVNO,ATTRANS
          CALL      WRDTRE1
          GOTO      WRTD9999
.
.         Outpatient Dtran
.
WRTD2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1
          PACK      CFNAME,OSTFILE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
..          OPEN      OUTDTRO3,CFNAME
          PACK      KEY22,OTNUMB,OTINVNO,OTTRANS
          CALL      WRDTRO1
.######   CLOSE     OUTDTRO1  * can't close here, used in print receipt routine
          GOTO      WRTD9999
.
.         Inpatient Dtran
.
WRTD3000  PACK      KEY22,TADMNO,TREF,TTRANSN1
          CALL      WRDTRN1
.
WRTD9999  RETURN
.------------------------------------------------------------
.         ULKI0000 : Unlock the Health Fund Receipts Record
.------------------------------------------------------------
ULKI0000  MOVE      PINVNO,KEY8
          CALL      RDHFRE1         * Read in the Health Fund Receipt Record
          BRANCH    OVRCD,ULKI9999
          MOVE      ZERO,HFRSTAT    * Set the status to 'free'
          CALL      UPHFRE1
ULKI9999  RETURN
.------------------------------------------------------------
.         SETF0000 : Set up the Fee's Invoiced Record
.         Set up the code depending on the option
.------------------------------------------------------------
SETF0000  MOVE      TPATAMTT,FINAMT             * The amount to be posted
.
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
          MOVE      PINVSYS,FINSYS              * The appropriate system
          MOVE      PINVSITE,FINSITE            * The outpatient site
.
          MOVE      ANSB,FINTYPE                * Cash received
.
.         Set up the financial summary code
.
          PACK      FINCODE,ANSA,SP20            * Patient cash
          MOVE      PMVXMHOS,FINHOSP
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
SETF9999  RETURN
.------------------------------------------------------------
.         RECP0000: Get the receipt number for a patient cash receipt
.         Check if computer generation is to be used or not.
.------------------------------------------------------------
RECP0000  MOVE      SP20,TRECEIPT
.
.         Check for a zero next receipt number. This means manual entry.
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,EIGHTY8;*210,CRECPNO
.
.         Computer generation of the receipt number
.
RECP1000  MOVE      " 88",PRXCODE   * System Lock Sector 88
          CALL      GETSLK00        * Get System Lock of Sector 88
          READ      CONTROLF,EIGHTY8;*210,CRECPNO
          ADD       ONE,CRECPNO
          WRITAB    CONTROLF,EIGHTY8;*210,CRECPNO
          CALL      RELSLK00        * Release System Lock of Sector 88
.
          SUB       ONE,CRECPNO                    * Get the receipt no. back
          MOVE      CRECPNO,TRECEIPT
.
.         We have the receipt number
.
RECP8000  MOVE      ZERO,EXIT
.
RECP9999  RETURN
.
.------------------------------------------------------------
. Refund Deposit by Date
.------------------------------------------------------------
DEPOST00  CALL      CURPER00
          CALL      CALCDT00                * Calc Next and Last Period Dates
          MOVE      "Deposits",WEBTITLE
          CALL      WEBHED00                * Create output file & write html pg
          BRANCH    EXIT,DEPOST99
.
          MOVE      TEMPLATE,F3
          MOVE      F3,DIM3
          REP       " 0",DIM3
          MATCH     "001",DIM3             * Is this a patient header template?
          GOTO      DEPOST10 IF EQUAL
.
          PACK      KEY8,URNUMBER         * No, patient is already admitted
          CALL      RDMAST1               * Read master file
          BRANCH    OVRCD,DEPOST95
          CALL      RDPMPX21              * Read master extension file
.         BRANCH    OVRCD,DEPOST95
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
.
DEPOST10  CALL      WEBBOD00                * Process Web body
          CALL      WEBEND00                * Process end of HTML file
.
          MOVE      ONE,EXIT
          GOTO      DEPOST99
.
DEPOST95  MOVE      "Patient not found on master file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPOST99
.
DEPOST99  RETURN
+
.------------------------------------------------------------
.  Billing comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
BLCMN000  
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,BLCMN999
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      "003",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
BLCMN400  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,BLCMN500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      BLCMN500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      BLCMN500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      BLCMN400
.
.         now write the new comments back
.
BLCMN500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
BLCMN510  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSCTDATA    
.
          MATCH     SP70,VSCTDATA
          GOTO      BLCMN600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      BLCMN900
            ENDIF   
.
            BRANCH    F3,BLCMN510             * If first line blank ignore
          ENDIF  
.
          IF        F3>=LASTITEM 
            GOTO      BLCMN900
          ELSE
            GOTO      BLCMN510
          ENDIF 
.
BLCMN600  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITEM 
            GOTO      BLCMN900
          ENDIF 
          GOTO      BLCMN510
.
BLCMN900  CLOSE     COMFILAF,DELETE
BLCMN999  RETURN
+
.------------------------------------------------------------
.  Invoice comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
IVCMN000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ICMFILAF,ICMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,IVCMN999
.
          REP       "+ ",ADMISSNO
          MOVE      SP70,KEY8
          IF        INVOICEN<>0
            MOVE      INVOICEN,KEY8
          ENDIF
          PACK      KEY19,ADMISSNO,KEY8,SP70
IVCMN400  CALL      RSPMICM1
          CALL      RKPMICM1
          BRANCH    OVRCD,IVCMN500          * end of file
          MATCH     PMICVISN,ADMISSNO       * same Admission Number?
          GOTO      IVCMN500 IF NOT EQUAL
.
          MATCH     KEY8,PMICINVN       * same Invoice Number?
          GOTO      IVCMN500 IF NOT EQUAL
.
          PACK      KEY19,PMICVISN,PMICINVN,PMICLNNO,SP70
          CALL      DEPMICM1
          GOTO      IVCMN400
.
.         now write the new comments back
.
IVCMN500  MOVE      ADMISSNO,PMICVISN          * set Admission Number
          MOVE      ZERO,F3
.
IVCMN510  ADD       ONE,F3
          READ      ICMFILAF,SEQ;PMICCMNT
.
          MATCH     SP70,PMICCMNT
          GOTO      IVCMN600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      IVCMN900
            ENDIF
.
            BRANCH    F3,IVCMN510             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITEM
            GOTO      IVCMN900
          ELSE
            GOTO      IVCMN510
          ENDIF
.
IVCMN600  MOVE      F3,PMICLNNO
          MOVE      ADMISSNO,PMICVISN
          MOVE      SP70,PMICINVN
          IF        INVOICEN<>0
            MOVE      INVOICEN,PMICINVN
          ENDIF
.
          PACK      PMICCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMICCDAT             * date updated
          CLOCK     TIME,PMICCTIM             * time updated
          MOVE      USERID,PMICCUID           * web user id
          UNPACK    SP70,PMICUDAT,PMICUTIM,PMICUUID
.
          PACK      KEY19,PMICVISN,PMICINVN,PMICLNNO,SP70
          CALL      WRPMICM1
          IF        F3>=LASTITEM
            GOTO      IVCMN900
          ENDIF
          GOTO      IVCMN510
.
IVCMN900  CLOSE     ICMFILAF,DELETE
IVCMN999  RETURN
+
.------------------------------------------------------------
.  Visit based comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
VBCMN000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMHFILAF,PMHFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN700
.
.         Past Medical History
.
          MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN400  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN400
.
.         now write the new comments back
.
VBCMN500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN510  ADD       ONE,F3
          READ      PMHFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      VBCMN700
            ENDIF
.
            BRANCH    F3,VBCMN510             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ELSE
            GOTO      VBCMN510
          ENDIF
.
VBCMN600  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ENDIF
          GOTO      VBCMN510
.
.         Working Diagnosis
.
VBCMN700  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WDIFILAF,WDIFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN800
.
          MOVE      "016",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN710  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN720          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN720 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN720 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN710
.
.         now write the new comments back
.
VBCMN720  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN730  ADD       ONE,F3
          READ      WDIFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN750 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM2
              GOTO      VBCMN800
            ENDIF
.
            BRANCH    F3,VBCMN730             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ELSE
            GOTO      VBCMN730
          ENDIF
.
VBCMN750  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ENDIF
          GOTO      VBCMN730
.
.         Clinical Notes
.
VBCMN800  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CLNFILAF,CLNFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN900
.
          MOVE      "017",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN810  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN820          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN820 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN820 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN810
.
.         now write the new comments back
.
VBCMN820  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN830  ADD       ONE,F3
          READ      CLNFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN850 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM3
              GOTO      VBCMN900
            ENDIF
.
            BRANCH    F3,VBCMN830             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM3
            GOTO      VBCMN900
          ELSE
            GOTO      VBCMN830
          ENDIF
.
VBCMN850  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM3
            GOTO      VBCMN900
          ENDIF
          GOTO      VBCMN830
.
VBCMN900  CLOSE     PMHFILAF,DELETE
          CLOSE     WDIFILAF,DELETE
          CLOSE     CLNFILAF,DELETE
.
VBCMN999  RETURN
+

.------------------------------------------------------------
. Take Up Outstanding Debts
.------------------------------------------------------------
TUOSDT00  MATCH     SP1,UPDTTYPE
          GOTO      TUOSDT50 IF EQUAL       * Display formaction

          MATCH     "A",UPDTTYPE
          GOTO      TUOSDT10 IF EQUAL       * Add formaction
.
          GOTO      TUOSDT90

.         ******* ADD/UPDATE FORMACTION ********
.
TUOSDT10  MOVE      ZERO,PATSYST
          MOVE      OSDBT013,PATSYST
          MOVE      ZERO,ADMFOUND
          MOVE      OSDBT003,KEY8
          BRANCH    PATSYST,TUOSDT12,TUOSDT99,TUOSDT18
          GOTO      TUOSDT99
.
.         Emergency
.
TUOSDT12  CALL      RDDETA1
          BRANCH    OVRCD,TUOSDT20
          MOVE      ONE,ADMFOUND
.
          MATCH     ADAURNO,OSDBT004
          GOTO      TUOSDT91 IF NOT EQUAL
          GOTO      TUOSDT20
.
.         Inpatient
.
TUOSDT18  CALL      RDMISS1
          BRANCH    OVRCD,TUOSDT20
          MOVE      ONE,ADMFOUND
.
          MATCH     AURNO,OSDBT004
          GOTO      TUOSDT91 IF NOT EQUAL
.
TUOSDT20  MOVE      OSDBT004,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,TUOSDT91
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,OSDBT003
          CALL      RDPMVX11
.
          MOVE      ZERO,EXIT
          CALL      ADDOSD00                * Add Debt
          GOTO      TUOSDT99  
.
.         ********* DISPLAY FORMACTN *********
.
TUOSDT50  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Take Up Outstanding Debts",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,TUOSDT99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      TUOSDT99
.
.         ********* ERROR MESSAGES *********
.
TUOSDT90  MOVE      "Invalid Formaction. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TUOSDT99
.
TUOSDT91  MOVE      "Invalid U/R Number. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TUOSDT99
.
TUOSDT99  RETURN
+
.---------------------------------------------------------------------
. Add debts via Program Scheduler
.---------------------------------------------------------------------
ADDOSD00  READ      CONTROLF,EIGHTY8;*94,CLACDATE
          UNPACK    CLACDATE WITH XCENT,XYEAR,XMON,XDAY
          PACK      MAXDATE WITH XCENT,XYEAR,XMON,XDAY
.
.         Now work out the start of the current financial year
.
          PACK      CPTDATE,CCC,CYY,CMM,CDD
          REP       " 0",CPTDATE
          CALL      GPERD
          BRANCH    EXIT,ADDOSD90
.
          MOVE      "01",DRGNUM              * the first period of year
          PACK      KEY6,DRGYR,DRGNUM
          CALL      RDDRGA1
          BRANCH    OVRCD,ADDOSD91
          MOVE      DRGFDTE,STOFYEAR         * start of this financial year
.
          CALL      GETMCH00                 * Get Misc Charge Details
.
          CALL      FIXADM00
          CALL      FIXDTR00
          CALL      FIXINV00                 * setup Invoice record
          CALL      FIXVIS00
.
.       Check for the visit file
.
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          COMPARE   ZERO,OVRCD
          GOTO      ADDOSD06 IF EQUAL
.
.       Write a new record for visit file
.
          CALL      WRVISA1
.
ADDOSD06  MOVE      PVIBILL,KEY8
          CALL      RAPMVX11
          COMPARE   ZERO,OVRCD
          GOTO      ADDOSD08 IF EQUAL
.
          CALL      CLPMSVX1
          MOVE      PVIBILL,PMVXVISN
          MOVE      PMVXVISN,KEY8
          MOVE      PVIDATE,PMVXVSDT     * Visit date
          IF        IBCNMHOS=1
            MOVE      OSDBT010,PMVXMHOS  * Hospital id
          ELSE
            MOVE      SP10,PMVXMHOS      * Hospital id
          ENDIF
          CALL      WRPMVX11
.
ADDOSD08  COMPARE   ONE,PATSYST
          GOTO      ADDOSD10 IF NOT EQUAL   * Not Emergency
.
          MOVE      PVIBILL,KEY8
          CALL      RAEMVIS1
          COMPARE   ZERO,OVRCD
          GOTO      ADDOSD10 IF EQUAL
.
          CALL      CLEMRVIS
          MOVE      PVIBILL,EMVIADMN
          MOVE      "3",EMVISTAT
          MOVE      PVIURNO,EMVIURNO
          MOVE      PVIDATE,EMVIDATE
          CALL      WREMVIS1
.
.       Write the invoice record
.
ADDOSD10  MOVE      OSDBT005,KEY8
          CALL      RDINV1
          IF        OVRCD<>1
            GOTO      ADDOSD92
          ENDIF
          PACK      PTINCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINCDAT             * date created
          CLOCK     TIME,PTINCTIM             * time created
          MOVE      USERID,PTINCUID           * web user id
          CALL      WRINV1
          PROC      FLAGDEBT
.
.       Write the DTRAN record
.
          COMPARE   ZERO,OSDBT007           * Debt (1) Amount
          GOTO      ADDOSD20 IF EQUAL
.
ADDOSD12  MOVE      OSDBT003,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1                 * set next transaction number
.
          IF        PATSYST=1
            MOVE      PVITRAN,ATTRANS
            MOVE      OSDBT007,ATPATAMT
            MOVE      OSDBT007,ATPATPOR
            PACK      ATITEMNO,OSDBT001,SP70
            MOVE      MISCTTL1,ATDDESC
            PACK      KEY22,ATNUMB,ATINVNO,ATTRANS,SP70
            CALL      RDADTRE1
            COMPARE   ZERO,OVRCD
            GOTO      ADDOSD12 IF EQUAL
            CALL      WRDTRE1
          ELSE
            MOVE      PVITRAN,TTRANSN1
            MOVE      OSDBT007,TPATAMTT
            MOVE      OSDBT007,TPATAMTP
            PACK      TITEMNO,OSDBT001,SP70
            MOVE      MISCTTL1,TDDESC
            PACK      PTDTUNIQ,SP70
            PACK      KEY22 WITH OSDBT003,TREF,TTRANSN1,SP70
            CALL      RDADTRN1
            COMPARE   ZERO,OVRCD
            GOTO      ADDOSD12 IF EQUAL
            CALL      WRDTRN1
          ENDIF
.
ADDOSD20  COMPARE   ZERO,OSDBT008           * Debt (2) Amount
          GOTO      ADDOSD30 IF EQUAL
.
ADDOSD22  MOVE      OSDBT003,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1                 * set next transaction number
.
          IF        PATSYST=1
            MOVE      PVITRAN,ATTRANS
            MOVE      OSDBT008,ATPATAMT
            MOVE      OSDBT008,ATREBPOR
            MOVE      OSDBT002,ATITEMNO
            MOVE      MISCTTL2,ATDDESC
            PACK      KEY22,ATNUMB,ATINVNO,ATTRANS,SP70
            CALL      RDADTRE1
            COMPARE   ZERO,OVRCD
            GOTO      ADDOSD12 IF EQUAL
            CALL      WRDTRE1
          ELSE
            MOVE      PVITRAN,TTRANSN1
            MOVE      OSDBT008,TPATAMTT
            MOVE      OSDBT008,TREBATE
            MOVE      OSDBT002,TITEMNO
            MOVE      MISCTTL2,TDDESC
            PACK      PTDTUNIQ,SP70
            PACK      KEY22 WITH OSDBT003,TREF,TTRANSN1
            CALL      WRDTRN1
          ENDIF
.
ADDOSD30  BRANCH    PATSYST,ADDOSD50
.
          MOVE      TTRANSN1,ATRANNO
          ADD       ONE,ATRANNO
.
          PACK      ACODDTE,CCC,CYY,CMM,CDD   * set coding date to current date
          REP       " 0",ACODDTE
.
          MOVE      OSDBT003,KEY8
          BRANCH    ADMFOUND,ADDOSD40
.
          CALL      WRMISS1                   * write new admission
          GOTO      ADDOSD50
.  
ADDOSD40  PACK      PTMIWEBU,USERID,SP70
          CALL      UPMISS1                   * update existing admission
.
ADDOSD50  MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          COMPARE   ZERO,OSDBT007             * Debt (1) Amount
          GOTO      ADDOSD60 IF EQUAL
.
          MATCH     OSDBT006,STOFYEAR         * Invoice Date
          IF        @LESS
            PACK      FINDATE,OSDBT006
          ELSE
            PACK      FINDATE,STOFYEAR
          ENDIF
          REP       " 0",FINDATE
.
          MOVE      OSDBT007,FINAMT
          MOVE      FINTYPE1,FINTYPE
          MOVE      FINCODE1,FINCODE
          IF        PTCNMFEE=1
            UNPACK    FINCODE1,DIM1,MMSCGRP,MCHARGE,DIM15
.                                Misc. Charge, Group Code, Item Code
            MATCH     MMSCGRP,SP3
            IF        @EQUAL
              PACK      FINCODE,ANSM,ACLAIM,MCHARGE,SP20
.                                 Misc. Charge, Claim Code, Item Code
            ELSE
              PACK        FINCODE,ANSM,ACLAIM,MMSCGRP,SP20
.                                 Misc. Charge, Claim Code, Group Code
            ENDIF
          ENDIF
          MOVE      PATSYST,FINSYS
          MOVE      SP6,FINSITE
          MOVE      ZERO,FGSTFLAG
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
ADDOSD60  COMPARE   ZERO,OSDBT008           * Debt (2) Amount
          GOTO      ADDOSD99 IF EQUAL
.
          MATCH     OSDBT006,STOFYEAR       * Invoice Date
          IF        @LESS
            PACK      FINDATE,OSDBT006
          ELSE
            PACK      FINDATE,STOFYEAR
          ENDIF
          REP       " 0",FINDATE
.
          MOVE      OSDBT008,FINAMT
          MOVE      FINTYPE2,FINTYPE
          MOVE      FINCODE2,FINCODE
          IF        PTCNMFEE=1
            UNPACK    FINCODE2,DIM1,MMSCGRP,MCHARGE,DIM15
.                                Misc. Charge, Group Code, Item Code
            MATCH     MMSCGRP,SP3
            IF        @EQUAL
              PACK      FINCODE,ANSM,ACLAIM,MCHARGE,SP20
.                                 Misc. Charge, Claim Code, Item Code
            ELSE
              PACK      FINCODE,ANSM,ACLAIM,MMSCGRP,SP20
.                                 Misc. Charge, Claim Code, Group Code
            ENDIF
          ENDIF
          MOVE      PATSYST,FINSYS
          MOVE      SP6,FINSITE
          MOVE      ZERO,FGSTFLAG
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          GOTO      ADDOSD99
.
.         ********* ERROR MESSAGES *********
.
ADDOSD90  MOVE      "Current Date not on Period File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDOSD99
.
ADDOSD91  MOVE      "Start of Year not on Period File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDOSD99
.
ADDOSD92  CLEAR     WEBTITLE
          APPEND    "Invoice number already exists for UR ",WEBTITLE
          APPEND    PINVUR,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDOSD99
.
ADDOSD99  RETURN
+
.---------------------------------------------------------------------
.        Get Misc Charge descriptions
.---------------------------------------------------------------------
GETMCH00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
.         Miscellaneous Debt
.
          IF        IBCNMHOS=1
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,OSDBT010
            CALL      RDPTHSP1
            BRANCH    OVRCD,GETMCH20          * invalid hospital
            PACK      KEY21,PTHSDCLM,SP6,SP3,OSDBT001,SP30
          ELSE
            PACK      KEY21,PTCNDCLM,SP6,SP3,OSDBT001,SP30
          ENDIF
          PACK      KEY29,KEY21,KEY8
          CALL      RDMCHG1
          IF        OVRCD=0
            MATCH     "1",PTMCACTV               * Inactive ?
            GOTO      GETMCH10 IF NOT EQUAL      * No
          ENDIF
.
          CALL      RDPMCHG1
          BRANCH    OVRCD,GETMCH20          * invalid code
.
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70
          MATCH     KEY21,KEY21A
          GOTO      GETMCH20 IF NOT EQUAL
          MATCH     "1",PTMCACTV               * Inactive ?
          GOTO      GETMCH20 IF EQUAL          * Yes
.
GETMCH10  MOVE      "A",FINTYPE1
          PACK      FINCODE1,ANSM,MMSCGRP,MCHARGE,SP20
          MOVE      MDESC,MISCTTL1
          GOTO      GETMCH50
.
GETMCH20  MOVE      SP70,MISCTTL1
          MOVE      "A",FINTYPE1
          PACK      FINCODE1,ANSM,SP3,MCHARGE,SP70
.
.         Miscellaneous H.F. Debt
.
GETMCH50  IF        IBCNMHOS=1
            PACK      KEY21,PTHSDCLM,SP6,SP3,OSDBT002,SP30
          ELSE
            PACK      KEY21,PTCNDCLM,SP6,SP3,OSDBT002,SP30
          ENDIF
          PACK      KEY29,KEY21,KEY8
          CALL      RDMCHG1
          IF        OVRCD=0
            MATCH     "1",PTMCACTV               * Inactive ?
            GOTO      GETMCH60 IF NOT EQUAL      * No
          ENDIF
.
          CALL      RDPMCHG1
          BRANCH    OVRCD,GETMCH70          * invalid code
.
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE,SP70
          MATCH     KEY21,KEY21A
          GOTO      GETMCH70 IF NOT EQUAL
          MATCH     "1",PTMCACTV               * Inactive ?
          GOTO      GETMCH70 IF EQUAL          * yes
.
GETMCH60  MOVE      "A",FINTYPE2
          PACK      FINCODE2,ANSM,MMSCGRP,MCHARGE,SP20
          MOVE      MDESC,MISCTTL2
          GOTO      GETMCH99
.
GETMCH70  MOVE      SP70,MISCTTL2
          MOVE      "A",FINTYPE2
          PACK      FINCODE2,ANSM,SP3,MCHARGE,SP70
.
GETMCH99  RETURN
.---------------------------------------------------------------------
.        Set up Admission record for writing
.---------------------------------------------------------------------
FIXADM00 BRANCH     PATSYST,FIXADM10,FIXADM99,FIXADM30
         GOTO       FIXADM99
.
.        A&E
.
FIXADM10 BRANCH     ADMFOUND,FIXADM99
         MOVE       OSDBT003,KEY8
         MOVE       OSDBT004,ADAURNO
         MOVE       OSDBT003,ADANUMB
         MOVE       "00000000",ADADATE
         MOVE       "00:00   ",ADATIME
         MOVE       OSDBT011,AEDAFUND
         MOVE       OSDBT012,AEDATBLE
         MOVE       OSDBT009,ADACOMP
         UNPACK     SP70,ADACLASS,ADAINSUR,ADASRC,ADASIT,ADAMODE
         UNPACK     SP70,ADAFILL,ADADOCT,ADALOCK
         MOVE       "00:00   ",ADASEEN
         MOVE       ZERO,ADAADMIT
         MOVE       ZERO,ADADURN
         UNPACK     SP70,ADAEMPL,ADAPOST
         MOVE       SP70,ADAADD1
         MOVE       SP70,ADAADD2
         MOVE       SP70,ADASUBR
         MOVE       SP70,ADASUBR
         UNPACK     SP70,ADATELE,ADACONT
         UNPACK     SP70,ADAUSR1,ADAUSR2,ADAUSR3,ADAUSR4,ADAUSR5
         MOVE       SP70,ADADIAG
         MOVE       ZERO,ADAFIL2
         UNPACK     SP70,ADAWAIT,ADASDTE,ADAPREV
         MOVE       ZERO,AEDAPVIS
         UNPACK     SP70,AEDARFGP,AEDAGPPC,AEDATIAS,AEDADTAT,AEDATESI,AEDAEMPL
         UNPACK     SP70,AEDARTAS,AEDAINIT,AEDAPLIN,AEDADIAS,AEDARNEN,AEDACONS
         UNPACK     SP70,AEDAGPPT,AEDAPRTM,AEDARDOC,ADAPRTY,AEDAOPER
         MOVE       SP70,AEDASPAR
         MOVE       ZERO,AEDANPNA
         CALL       WRDETA1
         GOTO       FIXADM99
.
.        Inpatient
.
FIXADM30  BRANCH    ADMFOUND,FIXADM50
          MOVE      OSDBT004,AURNO
          MOVE      OSDBT003,AADMNO
          MOVE      "00000000",ADATE
          MOVE      "00:00   ",ATIME
          MOVE      ZERO,AWARD
          MOVE      ZERO,ABED
          MOVE      SP6,ADOCTR
          MOVE      SP30,ARDRNAM
          MOVE      SP6,ADOCTA
          MOVE      SP3,ASRCE
          MOVE      SP3,ATYPE
          MOVE      SP3,ACLSS
          MOVE      SP3,ACARE
          MOVE      OSDBT011,AFUNDH
          MOVE      OSDBT012,AFNDTB
          MOVE      SP70,AFNDMM
          MOVE      ZERO,AELIG
          MOVE      ZERO,AVISIT
          MOVE      ZERO,AALERG
          MOVE      ZERO,ADISC
          MOVE      ZERO,AALLOW
          MOVE      SP70,ADOCTL
          MOVE      ZERO,APURGE
          MOVE      THREE,ASTAT
          MOVE      ZERO,AILLN
          MOVE      OSDBT009,ACLAIM
          MOVE      ZERO,ASTAY
          MOVE      ONE,ATRANNO
          MOVE      ZERO,AINVPRT
          MOVE      SP8,ALACDTE
          MOVE      SP6,ADIET
          MOVE      SP6,ADOCTT
          MOVE      SP30,PTMSSPAR
          MOVE      ZERO,APORT
          MOVE      ZERO,ADSCHI
          MOVE      ANSN,PTMICMXP
          UNPACK    SP70,PTMIPCMX,PTMIGSTA,PTMIEBED,PTMIDMOV
          MOVE      ZERO,PTMICONB
          PACK      PTMIWEBC,USERID,SP70
.
FIXADM50  MOVE      ATRANNO,TTRANSN1
          ADD       ONE,ATRANNO
          ADD       ONE,AINVPRT
.
          MOVE      ALACDTE,TDATE1
.
          MATCH     MAXDATE,TDATE1
          GOTO      FIXADM99 IF NOT LESS
.
          MOVE      MAXDATE,ALACDTE
.
FIXADM99  RETURN
+
.---------------------------------------------------------------------
.        Set up Debtors Transaction Record for writing
.---------------------------------------------------------------------
FIXDTR00  BRANCH    PATSYST,FIXDTR10,FIXDTR99,FIXDTR30
          GOTO      FIXDTR99
.
.         Emergency
.
FIXDTR10  MOVE      OSDBT003,ATNUMB
          MOVE      ZERO,ATPATAMT
          MOVE      ZERO,ATPATPOR
          MOVE      ZERO,ATREBPOR
          MOVE      OSDBT005,ATINVNO
          MOVE      OSDBT006,ATDDATE
          UNPACK    SP70,ATITEMNO,ATRECEPT,ATMISGRP,ATDEPTYP,ATBATCHN
          MOVE      SP70,ATDDESC
          MOVE      ZERO,ATPAYTYP
          MOVE      ONE,ATINVPRT
          MOVE      "1",ATRECTYP
          MOVE      "DB",ATTYPE
          MOVE      ONE,ATNINVS
          MOVE      ONE,ATSERVS
          UNPACK    SP70,ATDTEFFD
          MOVE      ZERO,ATSPARE1
          MOVE      ZERO,ATSPARE2
          MOVE      ZERO,ATDTGSTA
          UNPACK    SP70,ATDTGSTC
          MOVE      "0",ATDTCRST
          MOVE      ZERO,ATDTGSTM
.
          UNPACK    SP70,ATDTBTCH,ATDTSUBN,ATDTEDAD,ATDTSVTM,ATDTITYP
          MOVE      ZERO,ATDTSCHF
          MOVE      SP70,ATDTRBRS
          MOVE      SP70,ATDTPCOD
.
          PACK      ATDTACOI,SP70       * After Care Override Indicator
          PACK      ATDTDSOV,SP70       * Duplicate Service Override
          PACK      ATDTSTXT,SP70       * Service Text
          PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      ATDTMPOV,SP70       * Multi Procedure Override
          PACK      ATDTNMPT,SP70       * Number of Patients Seen
          PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      ATDTTDUR,SP70       * Time Duration (Mins)
          PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
          MOVE      SP70,ATSPARE
          GOTO      FIXDTR99
.
.         Inpatient
.
FIXDTR30  MOVE      OSDBT003,TADMNO
          MOVE      OSDBT004,TDCODE
.
          MOVE      ZERO,TPATAMTT
          ADD       OSDBT007,TPATAMTT
          ADD       OSDBT008,TPATAMTT
.
          MOVE      ZERO,TPATAMTG
          MOVE      ZERO,TPATAMTH
          MOVE      ZERO,TPATAMTI
          MOVE      ZERO,TPATAMTP
          UNPACK    OSDBT006 WITH XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,TFCENT
          MOVE      XYEAR,TFYEAR
          MOVE      XMON,TFMONTH
          MOVE      XDAY,TFDAY
          MOVE      ZERO,TTCENT
          MOVE      ZERO,TTYEAR
          MOVE      ZERO,TTMONTH
          MOVE      ZERO,TTDAY
          MOVE      "DB",TTYPE
          MOVE      "P",TTYPEDEB
          MOVE      OSDBT005,TREF
          MOVE      SP1,TPAYTYPE
          MOVE      SP8,TRECEIPT
          MOVE      ONE,TINVPRT
          MOVE      THREE,TRECTYPE
          MOVE      ZERO,TNODAYS
          MOVE      ONE,TCLAIM
          MOVE      ZERO,TSERVS
.
          PACK      PTDTDES2,SP20,SP20
          MOVE      ZERO,PTDTLSPT
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTDTYP
          MOVE      ZERO,PTDTCCU
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTL
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          UNPACK    SP20,PTDTGSTC,PTDTEFFD
          MOVE      ZERO,PTDTEPSD
          MOVE      SP70,PTDTBTYP
          MOVE      SP70,PTDTBTCH
          MOVE      SP70,PTDTTMNO
          MOVE      SP70,PTDTPMBS
.
FIXDTR99  RETURN
+
.---------------------------------------------------------------------
.        Set up Invoice record for writing
.---------------------------------------------------------------------
FIXINV00  CALL      CLPATINV                * clear Invoice record
.
          MOVE      OSDBT005,PINVNO
          MOVE      OSDBT006,PINVDTE
          MOVE      PSNAME,PINALPHA
.
          MOVE      OSDBT003,PINVADM
          MOVE      OSDBT004,PINVUR
.
          MOVE      ZERO,PINVAMT
          ADD       OSDBT007,PINVAMT
          ADD       OSDBT008,PINVAMT
.
          MOVE      OSDBT008,PINVREB       * H.F Invoice amount
.
          MOVE      OSDBT009,PINVCLM
          MOVE      PATSYST,PINVSYS
.
          MOVE      OSDBT011,PTINHFND
.
FIXINV99  RETURN
+
.---------------------------------------------------------------------
.        Set up Patient Visitor Record for writing
.---------------------------------------------------------------------
FIXVIS00  BRANCH    PATSYST,FIXVIS10,FIXVIS99,FIXVIS30
          GOTO      FIXVIS99
.
FIXVIS10  MOVE      ADAURNO,PVIURNO
          MOVE      ADADATE,PVIDATE
          REP       " 0",PVIDATE
          MOVE      ADANUMB,PVIBILL
          MOVE      ONE,PVITYPE
          MOVE      ADADOCT,PVIDOCT
          MOVE      ZERO,PVISTAT
          MOVE      SP2,PVILOCK
          MOVE      ONE,PVITRAN
          MOVE      SP30,PVISPAR
          GOTO      FIXVIS99
.
FIXVIS30  MOVE      AURNO,PVIURNO
          MOVE      ADATE,PVIDATE
          REP       " 0",PVIDATE
          MOVE      AADMNO,PVIBILL
          MOVE      THREE,PVITYPE
          MOVE      ADOCTA,PVIDOCT
          MOVE      ONE,PVISTAT
          MOVE      SP2,PVILOCK
          MOVE      ONE,PVITRAN
          MOVE      SP30,PVISPAR
.
FIXVIS99  RETURN
+
.---------------------------------------------------------------------
. Refund Deposits
.---------------------------------------------------------------------
RDEP0000  BRANCH    FLDITMNO,RDEP0100,RDEP0200,RDEP0300,RDEP0400,RDEP0500:
                             RDEP0600,RDEP0700,RDEP0800,RDEP0900,RDEP1000:
                             RDEP1100,RDEP1200,RDEP1300,RDEP1400,RDEP1500
.
RDEP0100  CALL      NEXT0000
          GOTO      RDEP9999
.
RDEP0200  CALL      PREV0000
          GOTO      RDEP9999
.
RDEP0300  CALL      CURSTD00
          GOTO      RDEP9999
.
RDEP0400  CALL      CUREND00
          GOTO      RDEP9999
.
RDEP0500  CALL      CURYR000
          GOTO      RDEP9999
.
RDEP0600  CALL      CURMON00
          GOTO      RDEP9999
.
RDEP0700  CALL      SELV0000
          GOTO      RDEP9999
.
RDEP0800  CALL      TRDEP000                * Table of refund deposits by date
          GOTO      RDEP9999
.
RDEP0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      RDEP9999
.
RDEP1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      RDEP9999
.
RDEP1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      RDEP9999
.
RDEP1200  CALL      TADN0000                * Table of refund deposist by admno
          GOTO      RDEP9999
.
RDEP1300  CALL      PREVGR00                 * Show previous group of records
          GOTO      RDEP9999
.
RDEP1400  CALL      NEXTGR00                 * Show next group of records
          GOTO      RDEP9999
.
RDEP1500  WRITE     HTMLFILE;REVRECPT;
          GOTO      RDEP9999
.
RDEP9999  RETURN
+
.----------------------------------------------------------------------------
. Table display of refund deposits by admission date
.----------------------------------------------------------------------------
TRDEP000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
TRDEP100  CALL      RDKMISS3
          BRANCH    OVRCD,TRDEP999
.
          MATCH     ADATE,LASTDATE
          GOTO      TRDEP999 IF LESS
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TRDEP100
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS          * Check hospital same as
            GOTO      TRDEP100 IF NOT EQUAL      * users current hospital
          ENDIF
.
          MOVE      AADMNO,DAADMNO
          MOVE      "0",CMDESTAT
          PACK      KEY26,AADMNO,CMDESTAT,SP70
          CALL      RSCMDEP2
TRDEP200  CALL      RKCMDEP2
          BRANCH    OVRCD,TRDEP100
.
          MATCH     DAADMNO,CMDEADMN
          GOTO      TRDEP100 IF NOT EQUAL
          MATCH     "0",CMDESTAT
          GOTO      TRDEP100 IF NOT EQUAL
.
          MOVE      CMDERECN,KEY12
          CALL      RDRCBNK1
          BRANCH    OVRCD,TRDEP200
.
          CALL      RWRDEP00                * Display refund deposit row
          GOTO      TRDEP200
.
TRDEP999  RETURN
+
.------------------------------------------------------------------------------
. Display refund deposit row
.------------------------------------------------------------------------------
RWRDEP00  MATCH     "       0",AURNO        * is this a pre-admission?
          IF        @EQUAL
            MOVE      AADMNO,KEY8
            CALL      RDPRAM1               * read pre-admission master record
            BRANCH    OVRCD,RWRDEP99        * exit, if not found
          ELSE
            MOVE      AURNO,KEY8
            CALL      RDMAST1               * patient master file
            BRANCH    OVRCD,RWRDEP99        * exit, if not found
            MOVE      AURNO,KEY8
            CALL      RDPMPX21              * Read master extension file
            BRANCH    OVRCD,RWRDEP99        * exit, if not found
          ENDIF
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      SP70,FORMATNM
          MOVE      ZERO,FOLDSUFX
          CALL      PATLN000                * Format name
          CALL      PATFLD00                 
          MOVE      KEY3,FOLDSUFX           * Patient folder colour suffix
.
          MOVE      RCBNTDAT,DEPDATE
          REP       " 0",DEPDATE
.
          PACK      KEY5,ANSD,ANSP,CMDEDTYP
          CALL      RDCODE1
          MOVE      TDESC,DEPTYPE            * Deposit type
.
          MOVE      CMDEADMN,ADMISSNO
          MOVE      AURNO,URNUMBER
          
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          CLEAR     UPDLINK
	  APPEND    "javascript:LinkReceipt('",UPDLINK
	  APPEND    URNUMBER,UPDLINK
	  APPEND    "','",UPDLINK
	  APPEND    ADMISSNO,UPDLINK
	  APPEND    "','",UPDLINK
	  APPEND    CMDERECN,UPDLINK
	  APPEND    "','",UPDLINK
	  APPEND    CMDETCNT,UPDLINK
	  APPEND    "')",UPDLINK
	  RESET     UPDLINK
.
	  REP       "+ ",ADMISSNO
	  REP       "+ ",URNUMBER
.
	  WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",CMDERECN,"#",":
                             "#"",DEPDATE,"#",":
                             "#"",DEPTYPE,"#",":
                             "#"",RCBNTOTP,"#",":
                             "#"",UPDLINK,"#",":
                             "#"",FOLDSUFX,"#");"
          GOTO      RWRDEP99
.
RWRDEP99  RETURN
+
.----------------------------------------------------------------------------
. Table display of deposits for an U/R number
.----------------------------------------------------------------------------
TADN0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      "10",NORECORD           * Numb of records=0 Default to 10
          MOVE      ZERO,ROWCOUNT           * Init number of records output
          MOVE      ZERO,RECNUMB
.
          MOVE      SP70,KEY12A
          MOVE      "0",CMDESTAT
.
          IF        REVRECPT=0
            PACK      KEY34,URNUMBER,CMDESTAT,SP70
          ELSE
            PACK      KEY34,URNUMBER,CMDESTAT,Z70
          ENDIF
.

          CALL      RSCMDEP3
TADN1000  IF        REVRECPT = 0
            CALL      RKCMDEP3
          ELSE
            CALL      RPCMDEP3
          ENDIF
.
          BRANCH    OVRCD,TADN9999
.
          MATCH     URNUMBER,CMDEURNO
          GOTO      TADN9999 IF NOT EQUAL   * different U/R
          MATCH     "0",CMDESTAT            * Deposit held?
          GOTO      TADN9999 IF NOT EQUAL
.
          MATCH     CMDERECN,KEY12A
          GOTO      TADN1000 IF EQUAL
          MOVE      CMDERECN,KEY12A     * Save receipt number
.
          MOVE      CMDERECN,KEY12
          CALL      RDRCBNK1
          BRANCH    OVRCD,TADN1000
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      TADN1000
          ENDIF
.
          UNPACK    RCBNTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP10,KEY3
          LOAD      KEY3,CMDESYST,AAEPAT,OUTPAT,INPAT,PPRAC
.
          MOVE      "&nbsp",TDESC
          MATCH     SP3,CMDERRFN
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSR,CMDERRFN
            CALL      RDCODE1
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkReceipt(#"":
                             CMDEURNO,"#",#"",CMDEADMN,"#",#"":
                             CMDERECN,"#",#"",CMDETCNT,"#")'>":
                             CMDERECN,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",KEY3,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td align=right>",RCBNTOTP,"</td></tr>"
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      TADN1000 IF NOT EQUAL
.
TADN9999  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
.
          WRITE     HTMLFILE;"patweb75.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&revrecpt=",REVRECPT:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",ADMISSNO    
          REP       "+ ",URNUMBER    
.
PREVGR99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
.
          WRITE     HTMLFILE;"patweb75.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&revrecpt=",REVRECPT:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.         
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
NEXTGR99  RETURN
.
.-----------------------------------------------------------
. Process Regime Code MBS/Misc Items
.-----------------------------------------------------------
GETRGM00   IF        REGMFLAG=0
             PACK      KEY13,ITEMN[CNTITEM],SP70
           ELSE
             MOVE      PMREREGM,DIM10A
             PACK      KEY13,DIM10A,SP70
           ENDIF
           CALL      RSPMREG1
GETRGM10   CALL      RKPMREG1
           BRANCH    OVRCD,GETRGM99
.
           IF        REGMFLAG=0
             PACK      SAVKEY13,PMREREGM,PMREUNIQ,SP70
           ELSE
             PACK      SAVKY13A,PMREREGM,PMREUNIQ,SP70
           ENDIF
.
           MATCH     "  0",PMREUNIQ
           GOTO      GETRGM10 IF EQUAL
.
           IF        REGMFLAG=0
             MATCH     ITEMN[CNTITEM],PMREREGM
           ELSE
             MATCH     DIM10A,PMREREGM
           ENDIF
           GOTO      GETRGM99 IF NOT EQUAL
.
           CALL      CLREC000     * clear tempfile record variables
.
           MOVE      PMREITMN,MCHARGE
           MATCH     SP9,MCHARGE
           IF        !@EQUAL
             MOVE      ZERO,EXIT
             MOVE      MDATE[CNTITEM],MISCDATE
             MOVE      MISCDATE,WKITDATE
             PACK      KEY8,ADMISSNO
             CALL      CHKITM00         * Check for valid MBS/Misc.item number
             BRANCH    EXIT,GETRGM99
.
             IF        EXIT=2
               IF        REGMFLAG<>1
                 MOVE      ONE,REGMFLAG
                 CALL      GETRGM00
                 BRANCH    EXIT,GETRGM99
                 MOVE      ZERO,REGMFLAG
.
                 PACK      KEY13,SAVKEY13,SP70
               ELSE
                 PACK      KEY13,SAVKY13A,SP70
               ENDIF
               CALL      RDPMREG1
.
               GOTO      GETRGM10
             ENDIF
.
             MOVE      MDATE[CNTITEM],SDATE
             MOVE      QUNTY[CNTITEM],MULTNUM
             MOVE      REFNC[CNTITEM],TRECEIPT
             MOVE      ONE,FORM2
             MOVE      FORM2,TSESSION
             MOVE      PMREDESC,MDESC
             MOVE      XAMT,DXAMT
             MOVE      XMBS,DXMBS
             MOVE      URNUMBER,AURNO
             MOVE      UNIQUE,UNIQUEX
             MOVE      PMREITMN,MCHARGE
             MOVE      UNIQU[CNTITEM],NZUNIQUE
             MOVE      INCTY[CNTITEM],NZINCTYP
             MOVE      STTIM[CNTITEM],STRTIME 
             MOVE      ENTIM[CNTITEM],ENDTIME 
.
.-----------  Eclipse Bulk billing                             *T0859743-start
             MATCH     "1",PTCNUEBB               * Using Eclipse Bulk Billing
             IF        !@EQUAL
               MATCH     "1",PTCNBBSW
               IF        !@EQUAL
                 MATCH     "1",PTCNDVAW
                 GOTO      GETRGM50 IF NOT EQUAL      * No,check charge amount
               ENDIF
             ENDIF
.
             MATCH     "1",TYPEBBIL               * Eclipse Bulk Billing type
             IF        !@EQUAL
               MATCH     "1",TYPEDVAW
               GOTO      GETRGM50 IF NOT EQUAL      * No,check charge amount
             ENDIF
.
             MOVE      DURAT[CNTITEM],DURATIME    * Time Duration (mins)
             MOVE      ACOVR[CNTITEM],ACOVRIDE    * After Care Override Ind
             MOVE      MULPR[CNTITEM],MULPROVR    * Multi Procedure Override
             MOVE      DUPSR[CNTITEM],DUPSROVR    * Duplicate Service Override
             MOVE      SRVTX[CNTITEM],SERVTEXT    * Service Text
             MOVE      HOSIN[CNTITEM],HOSPINDI    * Hospital Indicator?
             MOVE      NUMPT[CNTITEM],NUMPTSEE    * Number of Patients Seen
             MOVE      ROVRC[CNTITEM],ROVRCODE    * Restrictive Override Code
             MOVE      SLDMC[CNTITEM],SLDMCODE    * Self Deem Code
             MOVE      LSPNV[CNTITEM],LSPNVNUM    * Location Specific Practice
             MOVE      SUBIT[CNTITEM],SUBITEMN    * Sub Item Number
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
.
             MATCH     "1",PTCNDVAW               
             GOTO      GETRGM50 IF NOT EQUAL
.
             MATCH     "1",TYPEDVAW
             GOTO      GETRGM50 IF NOT EQUAL
.
             MOVE      DSKMS[CNTITEM],DISTAKMS    * Distance Kms
.
.-----------
.
GETRGM50     MOVE      ZERO,FORM12P2
             MOVE      TPATAMTP,FORM12P2
             ADD       TREBATE,FORM12P2
             IF        FORM12P2=0 & TPATAMTT<>0
               MOVE      TPATAMTT,TPATAMTP
             ENDIF
.
             PACK      KEY38,XDAADMNO,TSESSION,SDATE,DXAMT,DXMBS,UNIQUEX
             WRITE     ITEMFIL1,KEY38;XDAADMNO,TSESSION,SDATE,DXAMT:
                             DXMBS,UNIQUEX:
                             TPATAMTT,AURNO,MITMTYP,MCHARGE,MDESC,ATRANNO:
                             PNAME,TRECEIPT,MULTNUM,MINDIC,MBSFLAG,TPATAMTP:
                             TREBATE,ACLAIM,AFUNDH,AFNDTB,IAMT,KEYFLAG:
                             MMSCGRP,MNINV,IBAND1,IBAND2,IBAND3,IBAND4:
                             IBAND5,IBAND6,IBAND7,IBAND8,PVITYPE,PVIBILL:
                             SYSID,ISDAYC,PCENFLG,ACLSS:
                             IBAND9,IBAND10,IBAND11,IBAND12:
                             IBAND13,IBAND14,IBAND15,IBAND16,PTMCKREB:
                             CMIXFLAG,PTCTEPSD,PTMCGSTA,PTMCGSTC,CMBSFEE:
                             PTMCALGR,NZUNIQUE,NZINCTYP,TPATAMTG,NZMCKPRI:
                             THEABAND,STRTIME,ENDTIME,MISCDESC,NZEXPITM:
.-----------  Eclipse Bulk billing                             *T0859743-start
                             DURATIME,ACOVRIDE,MULPROVR,DUPSROVR,SERVTEXT:
                             HOSPINDI,NUMPTSEE,ROVRCODE,SLDMCODE,LSPNVNUM:
                             SUBITEMN,SETCMGRP,PMMTIKEY:
.-----------                                                   *T0859743-end
.
.-----------  Eclipse DVAW
.
                             DISTAKMS
.
.-----------

             ADD       ONE,UNIQUE
.
          ENDIF
.
          GOTO      GETRGM10
.
GETRGM99  RETURN
+
.------------------------------------------------------------------------------
.* Check for included/excluded miscellaneous items if NZ Private billing
.------------------------------------------------------------------------------
CHKAMT00  MOVE      ZERO,EXIT
          MOVE      ZERO,F1
          MOVE      ZERO,FORM3
          PACK      KEY26,NZSPCPRC,NZSPCLMN,NZSPCNTR,ANSE,ONE,SP70
          CALL      RSNZCMT2
CHKAMT10  CALL      RKNZCMT2
          BRANCH    OVRCD,CHKAMT20
.
          MATCH     NZSPCPRC,NZCMCPRC
          GOTO      CHKAMT20 IF NOT EQUAL
.
          MATCH     NZSPCLMN,NZCMCLMC
          GOTO      CHKAMT20 IF NOT EQUAL
.
          BRANCH    F1,CHKAMT12
          MATCH     NZSPCNTR,NZCMCNTR
          GOTO      CHKAMT20 IF NOT EQUAL
.
CHKAMT12  MATCH     ANSE,NZCMRTYP
          GOTO      CHKAMT20 IF NOT EQUAL
.
          MATCH     "1",NZCMITYP
          GOTO      CHKAMT20 IF NOT EQUAL   * Not a misc.item record
.
          COMPARE   ZERO,NZCMCCNT           * header record?
          GOTO      CHKAMT15 IF NOT EQUAL
.
          MOVE      ONE,FORM3               * Found a header record
          MOVE      NZCMFTYP,FORM1
          GOTO      CHKAMT10
.
CHKAMT15  COMPARE   ZERO,NZCMFTYP
          GOTO      CHKAMT18 IF NOT EQUAL
.
          MATCH     SP70,NZCMPROC
          IF        !@EQUAL
            MATCH     MCHARGE,NZCMPROC     * excluded from contract
            GOTO      CHKAMT90 IF EQUAL    * item Not to be charged
            GOTO      CHKAMT10
          ELSE
            MATCH     MMSCGRP,NZCMMIGP     * group excluded from contract
            GOTO      CHKAMT90 IF EQUAL    * item Not to be charged
            GOTO      CHKAMT10
          ENDIF
          GOTO      CHKAMT20
.
CHKAMT18  MATCH     SP70,NZCMPROC
          IF        !@EQUAL
            MATCH     MCHARGE,NZCMPROC     * included in contract
            GOTO      CHKAMT92 IF EQUAL    * item to be charged
            GOTO      CHKAMT10
          ELSE
            MATCH     MMSCGRP,NZCMMIGP     * group included in contract
            GOTO      CHKAMT92 IF EQUAL    * item to be charged
            GOTO      CHKAMT10
          ENDIF
.
.         Check if a header record is found
.
CHKAMT20  COMPARE   ONE,FORM3
          GOTO      CHKAMT22 IF NOT EQUAL
.
.   If a header record is found with Field type=0 Include item - Charge Item
.             if Field type=1 Exclude item - No Charge 
.
          BRANCH    FORM1,CHKAMT90
          GOTO      CHKAMT92
.
.         Try with default
.
CHKAMT22  MOVE      ZERO,FORM3
          ADD       ONE,F1
          BRANCH    F1,CHKAMT30            * try with blank contract
          GOTO      CHKAMT90
.
.         Blank Contract
.
CHKAMT30  PACK      KEY26,NZSPCPRC,NZSPCLMN,SP6,ANSE,ONE,SP70
          CALL      RSNZCMT2
          GOTO      CHKAMT10
.
CHKAMT90  MATCH     "Y",NZMCKPRI
          IF        @EQUAL
            MOVE      TPATAMTT,TPATAMTG    * save keyin amount for FFS Win/Loss
          ENDIF
          IF        NZMCCHGT=1
            MOVE      TPATAMTT,TPATAMTG    * Exploding item,save Keyin price amt
          ENDIF
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TREBATE
          GOTO      CHKAMT99
.
CHKAMT92  MATCH     "Y",NZMCKPRI
          IF        @EQUAL
            MOVE      TPATAMTT,TPATAMTG    * save keyin amount
          ENDIF
.
CHKAMT99  RETURN
+
.------------------------------------------------------------------------------
.* Check if Any of Explode pack items need to be explode on invoice (NZ)
.------------------------------------------------------------------------------
CEXP0000  MOVE      ONE,CNTITEM
          MOVE      LASTITEM,LASTITM2
          WHILE     CNTITEM<=LASTITM2
            PACK      MCHARGE,ITEMN[CNTITEM],SP70
            MATCH     SP9,MCHARGE
            IF        !@EQUAL
.                                                 * Charge checkbox clicked
              MATCH     SP70,CHREQKEY[CNTITEM]
              GOTO      CEXP6000 IF EQUAL
.
              UNPACK    CHREQKEY[CNTITEM],KEY36
              PACK      KEY36,KEY36,SP70
              CALL      RDOPREQ1
              BRANCH    OVRCD,CEXP8000
              IF        CHREQCHR[CNTITEM] = 1
                GOTO      CEXP6000
              ENDIF
              GOTO      CEXP8000
.
CEXP6000      MOVE      MDATE[CNTITEM],MISCDATE
              CALL      GETNZM00
              IF        EXIT=0
                IF        NZMCCHGT=1
                  MATCH     "1",NZMCSHWD        * Check Show detail on Inv.
                  IF        @EQUAL
                    CALL      XPLIT000          * Explode individual item
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
CEXP8000    ADD       ONE,CNTITEM
          DO
CEXP9999  RETURN
+
.------------------------------------------------------------------------------
.         Move items from one procedure to another
.------------------------------------------------------------------------------
MVIT0000  PACK      PROCEDFR,PROCEDFR,SP70
          PACK      PROCEDTO,PROCEDTO,SP70
          PACK      UNIQNOTO,UNIQNOTO,SP70
          PACK      KEY11,ADMISSNO,UNIQNOTO
          CALL      RDNZSPR1
          BRANCH    OVRCD,MVIT9999
.
          MOVE      ONE,CNTITEM
.
MVIT1000  COMPARE   CNTITEM,LASTITEM
          GOTO      MVIT9999 IF LESS
.
          MOVE      TRNNO[CNTITEM],PMMITRAN
          PACK      PMMITRAN,PMMITRAN,SP70
          MATCH     SP70,PMMITRAN
          GOTO      MVIT8000 IF EQUAL
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      RDPMMTI1
          BRANCH    OVRCD,MVIT8000
.
          MATCH     PMMISUNQ,UNIQNUMB         * Same unique number?
          GOTO      MVIT8000 IF NOT EQUAL
.
          MOVE      UNIQNOTO,PMMISUNQ         * Proc Unique no
          MOVE      SP70,PMMICNTR
.
          MATCH     SP70,NZSPCPRC
          GOTO      MVIT6000 IF EQUAL         * No contract
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MVIT6000
.
          MATCH     "1",PMMIINCT              * Bill to Patient item ?
          GOTO      MVIT6000 IF EQUAL
.
.         If this is not Extra to contract and
.         there is a max.contr. misc.item charge goes to patient invoice
.
          MATCH     "0",PMMIINCT              * Include in contract
          IF        @EQUAL
            MATCH     "1",NZSPCONT
            GOTO      MVIT6000 IF EQUAL
            MATCH     "P",TCINDC7
            GOTO      MVIT6000 IF EQUAL
            MOVE      NZSPCNTR,PMMICNTR         * Contract
            GOTO      MVIT6000
          ENDIF
.
          MATCH     "2",PMMIINCT              * Extra to Contract
          IF        @EQUAL
            MATCH     "P",TCINDC7
            GOTO      MVIT7000 IF EQUAL
            MOVE      NZSPCNTR,PMMICNTR         * Contract
            MATCH     "F",TCINDC7
            GOTO      MVIT7000 IF EQUAL
            GOTO      MVIT6000
          ENDIF
.
MVIT6000  MATCH     "3",PMMIITYP
          IF        @EQUAL
            MOVE      SP70,PMMIITYP           * set item type to recalculate
          ENDIF
.
MVIT7000  PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR        * User id
          CALL      UPPMMTI1
.
MVIT8000  ADD       ONE,CNTITEM
          GOTO      MVIT1000
.
MVIT9999  RETURN
+
.------------------------------------------------------------------------------
.         Move items from one procedure to another
.------------------------------------------------------------------------------
DBIT0000  PACK      PROCEDFR,PROCEDFR,SP70
          MOVE      ONE,CNTITEM
.
DBIT1000  COMPARE   CNTITEM,LASTITEM
          GOTO      DBIT9999 IF LESS
.
          MOVE      TRNNO[CNTITEM],PMMITRAN
          PACK      PMMITRAN,PMMITRAN,SP70
          MATCH     SP70,PMMITRAN
          GOTO      DBIT8000 IF EQUAL
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      RDPMMTI1
          BRANCH    OVRCD,DBIT8000
.
          MATCH     PMMISUNQ,UNIQNUMB         * Same unique number?
          GOTO      DBIT8000 IF NOT EQUAL
.
          CALL      DEPMMTI1
.
DBIT8000  ADD       ONE,CNTITEM
          GOTO      DBIT1000
.
DBIT9999  RETURN
+
.------------------------------------------------------------------------------
.         Explode the pack item on invoice
.------------------------------------------------------------------------------
XPLIT000  MOVE      UNIQU[CNTITEM],PMMISUNQ
          MOVE      MDATE[CNTITEM],PMMITDAT
          MOVE      REFNC[CNTITEM],PMMIREFN
          MOVE      SESSN[CNTITEM],PMMISESS
          MOVE      INCTY[CNTITEM],PMMIINCT
          MOVE      QUNTY[CNTITEM],PMMISERV
.
          MOVE      LASTITEM,F3
          MOVE      ZERO,FORM3
.
          PACK      KEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                          NZMCEFDT,SP70
          PACK      SAVKEY37,KEY37,SP70
.
          PACK      KEY40,KEY37,SP70
          CALL      RSNZMXC1
XPLIT100  CALL      RKNZMXC1
          BRANCH    OVRCD,XPLIT600
.
          PACK      DIM37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                              NZMXEFDT,SP70
.
          MATCH     DIM37,SAVKEY37
          GOTO      XPLIT600 IF NOT EQUAL
.
          PACK      MCHARGE,NZMXITMN,SP70       * item code of pack item
          CALL      GETNZM00
          BRANCH    EXIT,XPLIT100               * invalid misc.item
.
          ADD       ONE,F3
          ADD       ONE,FORM3
.
          MOVE      PMMISUNQ,UNIQU[F3]
          MOVE      PMMITDAT,MDATE[F3]
          MOVE      NZMXITMN,ITEMN[F3]
          MOVE      NZMCGSTA,GSTAP[F3]
          MOVE      NZMCGSTC,GSTCD[F3]
          MOVE      NZMCDESC,DESCP[F3]
          MOVE      NZMCDESC,NZDES[F3]
          MOVE      NZMXQNTY,QUNTY[F3]
          MULT      PMMISERV,QUNTY[F3]
.
          MOVE      PMMIREFN,REFNC[F3]
          MOVE      PMMISESS,SESSN[F3]
          MOVE      NZMCPATP,CAMNT[F3]
          ADD       NZMCREBP,CAMNT[F3]
          MOVE      NZMCPATP,PATPR[F3]
          MOVE      NZMCREBP,REBPR[F3]
          MOVE      SP70,EFDAT[F3]
          MOVE      PMMIINCT,INCTY[F3]
          MOVE      "1",SUBPC[F3]
.
          GOTO      XPLIT100
.
XPLIT600  ADD       FORM3,LASTITEM
          MOVE      SP70,ITEMN[CNTITEM]       * clear pack item record
.
XPLIT999  RETURN
+
.------------------------------------------------------------------------------
.* Write NZ Private Pack item to tempfile for posting
.------------------------------------------------------------------------------
NZPAC000  COMPARE   FIVE,CFEETYP
          GOTO      NZPAC999 IF NOT EQUAL    * Not NZ Private Billing
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,NZPAC9999
.
          MATCH     "1",PMMIMVBR
          GOTO      NZPAC9999 IF NOT EQUAL      * not a pack item
.
          MOVE      ONE,CNTITEM
          MOVE      PMMISUNQ,UNIQU[CNTITEM]
.
          PACK      MISCDATE,PMMITDAT,SP70
          PACK      MCHARGE,PMMIITEM,SP70       * item code of pack item
          CALL      GETNZM00
          BRANCH    EXIT,NZPAC9999
.
          MOVE      ZERO,CNTITEM
          PACK      KEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                          NZMCEFDT,SP70
          PACK      SAVKEY37,KEY37,SP70
.
          PACK      KEY40,KEY37,SP70
          CALL      RSNZMXC1
NZPAC100  CALL      RKNZMXC1
          BRANCH    OVRCD,NZPAC200
.
          PACK      DIM37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                              NZMXEFDT,SP70
.
          MATCH     DIM37,SAVKEY37
          GOTO      NZPAC200 IF NOT EQUAL
.
          ADD       ONE,CNTITEM
          MATCH     "1",CSTRN[CNTITEM]
          GOTO      NZPAC100 IF EQUAL           * to be deleted
.
          MOVE      PMMISUNQ,UNIQU[CNTITEM]
          PACK      MCHARGE,NZMXITMN,SP70       * item code of pack item
          CALL      GETNZM00
          BRANCH    EXIT,NZPAC100               * invalid misc.item
.
          MOVE      PMMITDAT,MDATE[CNTITEM]
          MOVE      NZMXITMN,ITEMN[CNTITEM]
          MOVE      NZMCGSTA,GSTAP[CNTITEM]
          MOVE      NZMCGSTC,GSTCD[CNTITEM]
          MOVE      NZMCDESC,DESCP[CNTITEM]
          MOVE      NZMCDESC,NZDES[CNTITEM]
          MOVE      NZMXQNTY,QUNTY[CNTITEM]
          MULT      PMMISERV,QUNTY[CNTITEM]
.
          MOVE      PMMIREFN,REFNC[CNTITEM]
          MOVE      PMMISESS,SESSN[CNTITEM]
          MOVE      NZMCPATP,CAMNT[CNTITEM]
          ADD       NZMCREBP,CAMNT[CNTITEM]
          MOVE      NZMCPATP,PATPR[CNTITEM]
          MOVE      NZMCREBP,REBPR[CNTITEM]
          MOVE      SP70,EFDAT[CNTITEM]
          MOVE      PMMIINCT,INCTY[CNTITEM]
          MOVE      "1",SUBPC[CNTITEM]
          GOTO      NZPAC100
.
NZPAC200  MOVE      CNTITEM,LASTITEM
NZPAC999  RETURN
+
.------------------------------------------------------------------------------
.         Delete Pack item
.------------------------------------------------------------------------------
DPAC0000  COMPARE   FIVE,CFEETYP
          GOTO      DPAC9999 IF NOT EQUAL    * Not NZ Private Billing
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      DEPMMTI1
.
          IF        PVITYPE=THREE
            MOVE      "D",DIM1
            MOVE      PMMIITEM,MCHARGE
            PACK      CURRDATE,CCC,CYY,CMM,CDD,SP70
            REP       " 0",CURRDATE
            CALL      PROTRK00
          ENDIF
.
          COMPARE   ZERO,PTCNIPEN
          GOTO      DPAC9999 IF NOT EQUAL
.
.         Check if accommodation charged had been raised for Inpatient
.
          COMPARE   THREE,PVITYPE
          GOTO      DPAC8200 IF NOT EQUAL
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,DPAC9999
          COMPARE   THREE,ASTAT
          GOTO      DPAC9999 IF NOT EQUAL      * do not delete if patient not
          COMPARE   ZERO,AINVPRT               * do not delete if patient has
          GOTO      DPAC9999 IF EQUAL          * not been invoiced
.
.         Check if Accommodation had been invoiced up to discharged date
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,DPAC9999
.
          MATCH     DDATE,ALACDTE
          GOTO      DPAC9999 IF LESS
.
.         Check if there is any item to be invoiced
.
DPAC8200  PACK      KEY14,ADMISSNO,SP20
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,DPAC8400
          MATCH     PMMIVISN,ADMISSNO
          GOTO      DPAC9999 IF EQUAL
.
DPAC8400  MOVE      ADMISSNO,KEY8           * remove invoice pending record
          CALL      DEIPEN1
.
DPAC9999  RETURN
+
.------------------------------------------------------------------------------
.* Temp file IO
.------------------------------------------------------------------------------
RDSTEMP1  READ      TEMP1,KEY17;;
          RETURN
.
RDTEMP1   MOVE      ZERO,OVRCD
          READ      TEMP1,KEY17;XADMNO,XCHARGE,XMCCNT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   MOVE      ZERO,OVRCD
          WRITE     TEMP1,KEY17;XADMNO,XCHARGE,XMCCNT
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTEMP1   MOVE      ZERO,OVRCD
          UPDATE    TEMP1;XADMNO,XCHARGE,XMCCNT
          GOTO      OVERCOND IF OVER
          RETURN
.
DETEMP1   RESET     KEY17
          DELETE    TEMP1,KEY17
          RETURN
.
.------------------------------------------------------------------------------
.* Temp file IO
.------------------------------------------------------------------------------
RDSTEMP2  READ      TEMP2,KEY10;;
          RETURN
.
RDTEMP2   MOVE      ZERO,OVRCD
          READ      TEMP2,KEY10;TMSESS,TMDATE,TMEFFD,TMSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RDKTEMP2  MOVE      ZERO,OVRCD
          READKS    TEMP2;TMSESS,TMDATE,TMEFFD,TMSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP2   MOVE      ZERO,OVRCD
          WRITE     TEMP2,KEY10;TMSESS,TMDATE,TMEFFD,TMSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTEMP2   MOVE      ZERO,OVRCD
          UPDATE    TEMP2;TMSESS,TMDATE,TMEFFD,TMSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
DETEMP2   RESET     KEY10
          DELETE    TEMP2,KEY10
          RETURN
.
.------------------------------------------------------------
RDDTR000  CALL      CLPATDTR
          BRANCH    PINVSYS,RDDTR100,RDDTR200,RDDTR300
          GOTO      RDDTR999
.
RDDTR100  CALL      RDDTRE1            * Emergency
          BRANCH    OVRCD,RDDTR999
          MOVE      DATNUMB,DTADMNO
          MOVE      ATINVNO,TREF
          MOVE      ATTRANS,TTRANSN1
          MOVE      ATRECEPT,TRECEIPT
          LOAD      TRECTYPE,ATRECTYP,THREE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      ATPATPOR,TPATAMTP
          MOVE      ATREBPOR,TREBATE
          MOVE      ATPATAMT,TPATAMTT
          GOTO      RDDTR999
.
RDDTR200  CALL      RDDTRO1            * Outpatient
          BRANCH    OVRCD,RDDTR999
          MOVE      DOTNUMB,DTADMNO
          MOVE      OTINVNO,TREF
          MOVE      OTTRANS,TTRANSN1
          MOVE      OTRECEPT,TRECEIPT
          LOAD      TRECTYPE,OTRECTYP,THREE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      OTPATPOR,TPATAMTP
          MOVE      OTREBPOR,TREBATE
          MOVE      OTPATAMT,TPATAMTT
          GOTO      RDDTR999
.
RDDTR300  CALL      RDDTRN1            * Inpatient
          GOTO      RDDTR999
.
RDDTR999  RETURN
.
.------------------------------------------------------------
DEDTR000  BRANCH    PINVSYS,DEDTR100,DEDTR200,DEDTR300
          GOTO      DEDTR999
.
DEDTR100  CALL      DEDTRE1             * Emergency
          GOTO      DEDTR999
.
DEDTR200  CALL      DEDTRO1             * Outpatient
          GOTO      DEDTR999
.
DEDTR300  CALL      DEDTRN1             * Inpatient
          GOTO      DEDTR999
.
DEDTR999  RETURN
.
.------------------------------------------------------------------------------
RADTR000  BRANCH    PINVSYS,RADTR100,RADTR200,RADTR300
          GOTO      RADTR999
.
RADTR100  CALL      RDADTRE1             * Emergency
          GOTO      RADTR999
.
RADTR200  CALL      RDADTRO1             * Outpatient
          GOTO      RADTR999
.
RADTR300  CALL      RDADTRN1             * Inpatient
          GOTO      RADTR999
.
RADTR999  RETURN
.
.------------------------------------------------------------------------------
WRDTR000  BRANCH    PINVSYS,WRDTR100,WRDTR200,WRDTR300
          GOTO      WRDTR999
.
WRDTR100  CALL      WRDTRE1             * Emergency
          GOTO      WRDTR999
.
WRDTR200  CALL      WRDTRO1             * Outpatient
          GOTO      WRDTR999
.
WRDTR300  CALL      WRDTRN1             * Inpatient
          GOTO      WRDTR999
.
WRDTR999  RETURN
+
.------------------------------------------------------------------------------
UPDTR000  BRANCH    PINVSYS,UPDTR100,UPDTR200,UPDTR300
          GOTO      UPDTR999
.
UPDTR100  CALL      UPDTRE1             * Emergency
          GOTO      UPDTR999
.
UPDTR200  CALL      UPDTRO1             * Outpatient
          GOTO      UPDTR999
.
UPDTR300  CALL      UPDTRN1             * Inpatient
          GOTO      UPDTR999
.
UPDTR999  RETURN
+
.------------------------------------------------------------------------------
.* Get the rest of the Sub Item Code
.------------------------------------------------------------------------------
GSB20000  MOVE      ITYPE[CNTITEM],ITEMTYPE
.
          MATCH     ANSM,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ZERO
          ENDIF
          MATCH     ANSA,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ONE
          ENDIF          
.
          MOVE      ZERO,FORM2
          PACK      KEY22,DIM2,MCHARGE,KEY3,SP70
          CALL      RSPRIT1
GSB20010  CALL      RKPRIT1
          BRANCH    OVRCD,GSB20090
.
          SQUEEZE   DIM2
          MOVE      DIM2,FORM2
          COMPARE   FORM2,PRITFLAG
          GOTO      GSB20090 IF NOT EQUAL
.
          MATCH     MCHARGE,PRITITMN
          GOTO      GSB20090 IF NOT EQUAL
.
          MATCH     SP70,KEY3
          GOTO      GSB29999 IF EQUAL
.
          UNPACK    KEY3,KEY1
          CMATCH    KEY1,PRITSUBN
          GOTO      GSB20090 IF NOT EQUAL
.
          MATCH     PRITDAT1,PROCDATE
          GOTO      GSB20010 IF LESS
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     PROCDATE,PRITDAT2
            GOTO      GSB20010 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
.
          MOVE      PRITSUBN,KEY3
.
          GOTO      GSB29999
.
GSB20090  MOVE      SP70,KEY3
.
GSB29999  RETURN
+
.------------------------------------------------------------------------------
.* Validate Review Items
.------------------------------------------------------------------------------
GSB30000  MOVE      ITYPE[CNTITEM],ITEMTYPE
.
          MATCH     ANSM,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ZERO
          ENDIF
          MATCH     ANSA,ITEMTYPE
          IF        @EQUAL
            PACK      DIM2,SP1,ONE
          ENDIF
.
          MOVE      ZERO,FORM2
          PACK      KEY22,DIM2,MCHARGE,KEY3,SP70
          CALL      RSPRIT1
GSB30010  CALL      RKPRIT1                    * ?? should it be RPPRIT1 ????
          BRANCH    OVRCD,GSB30090
.
          SQUEEZE   DIM2
          MOVE      DIM2,FORM2
          COMPARE   FORM2,PRITFLAG
          GOTO      GSB30090 IF NOT EQUAL
.
          MATCH     MCHARGE,PRITITMN
          GOTO      GSB30090 IF NOT EQUAL
.
          MATCH     SP70,KEY3
          GOTO      GSB39999 IF EQUAL
.
          MATCH     KEY3,PRITSUBN
          GOTO      GSB30090 IF NOT EQUAL
.
          MATCH     PRITDAT1,PROCDATE
          GOTO      GSB30010 IF LESS
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     PROCDATE,PRITDAT2
            GOTO      GSB30010 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
.
          MOVE      PRITSUBN,KEY3
.
          GOTO      GSB39999
.
GSB30090  MOVE      SP70,KEY3
.
GSB39999  RETURN
+
.------------------------------------------------------------
.         Check for Events
.         Return KEY1=1 for Emergency 2=Outpatient
.------------------------------------------------------------
CEVT0000  MOVE      SP70,KEY1
          COMPARE   NINE,PVITYPE
          GOTO      CEVT9999 IF NOT EQUAL
.
          MATCH     " 1",PVISYST          * Event?
          GOTO      CEVT9999 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,CEVT9999
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CEVT9999
.
          MATCH     ANSE,TCINDC1
          IF        @EQUAL
            MOVE      "1",KEY1           * Emergency system
          ENDIF
.
          MATCH     ANSO,TCINDC1
          IF        @EQUAL
            MOVE      "2",KEY1           * Outpatient system
          ENDIF
.
CEVT9999  RETURN
+
.------------------------------------------------------------
.         Get Doctor from EMR History file
.------------------------------------------------------------
GTDCHS00  PACK      KEY22,ADMISSNO,Z70
          CALL      RSEMHIS1
GTDCHS10  CALL      RPEMHIS1
          BRANCH    OVRCD,GTDCHS99
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      GTDCHS99 IF NOT EQUAL
.
          MATCH     SP70,EMHIDOC
          GOTO      GTDCHS10 IF EQUAL
          GOTO      GTDCHS10 IF EOS
.
          MATCH     SP70,EMHIDSD
          GOTO      GTDCHS10 IF EQUAL
          GOTO      GTDCHS10 IF EOS
.
          MATCH     SP70,EMHIDST
          GOTO      GTDCHS10 IF EQUAL
          GOTO      GTDCHS10 IF EOS
.
          MATCH     EMHIDSD,PROCDATE
          GOTO      GTDCHS10 IF LESS
.
          IF        @EQUAL
            UNPACK    PROCTIME,DIM2,DIM1,DIM2A,DIM1,DIM2B
            PACK      DIM6,DIM2,DIM2A,DIM2B
            REP       " 0",DIM6
            MATCH     EMHIDST,DIM6
            GOTO      GTDCHS10 IF LESS
          ENDIF
.
          MOVE      EMHIDOC,PMMIEDAD
.
GTDCHS99  RETURN
.
.------------------------------------------------------------------------------
. List patient letter history by admission
.------------------------------------------------------------------------------
PLET0000  PACK      KEY19,ADMISSNO,Z70
          CALL      RSPMLHI1
PLET1000  CALL      RPPMLHI1
          BRANCH    OVRCD,PLET9999
.
          MATCH     ADMISSNO,PMLHVISN
          GOTO      PLET9999 IF NOT EQUAL
.
          PACK      KEY6,PMLHLETN,SP2,ZERO,SP70
          CALL      RDPTLET1
          IF        OVRCD=1
            MOVE      PMLHLETN,PTLETEXT
          ENDIF
.
          MOVE      SP70,KEY11
          MATCH     SP70,PMLHDATE
          IF        !@EQUAL
            UNPACK    PMLHDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",KEY11,"</td>":
                                 "<td>",PTLETEXT,"</td><tr>"
.
          GOTO      PLET1000
.
PLET9999  RETURN
.
.------------------------------------------------------------------------------
. List financial letter history by admission
.------------------------------------------------------------------------------
FLET0000  PACK      KEY19,ADMISSNO,Z70
          CALL      RSPTLH1 
FLET1000  CALL      RPPTLH1 
          BRANCH    OVRCD,FLET9999
.
          MATCH     ADMISSNO,DPTLHADM
          GOTO      FLET9999 IF NOT EQUAL
.
          PACK      KEY6,PTLHLCOD,SP2,ZERO,SP70
          CALL      RDPTFL1
          IF        OVRCD=1
            MOVE      PTLHLCOD,PTFLTEXT
          ENDIF
.
          MOVE      SP70,KEY11
          MATCH     SP70,PTLHDATE
          IF        !@EQUAL
            UNPACK    PTLHDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",KEY11,"</td>":
                                 "<td>",PTFLTEXT,"</td>":
                                 "<td>&nbsp;",PTLHSEID,"</td></tr>"
.
          GOTO      FLET1000
.
FLET9999  RETURN
.
.-----------------------------------------------------------
. Insurance Provider
.-----------------------------------------------------------
INPROV00  COMPARE   NINE,CFEETYP
          GOTO      INPROV99 IF NOT EQUAL     * Not running Johns Hopkins fees
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      URNUMBER,KEY8     * Check if patient exists
          CALL      RDMAST1
          BRANCH    OVRCD,INPROV90
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,INPROV95
.
          MATCH     SP1,UPDTTYPE
          GOTO      INPROV40 IF EQUAL
          GOTO      INPROV40 IF EOS
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      INPROV10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      INPROV20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      INPROV30 IF EQUAL
.
          GOTO      INPROV93
.
INPROV10  MOVE      ZERO,FORM3
          PACK      KEY16,ADMISSNO,PTIPR002,SP70
          PACK      KEY19,KEY16,Z70
          CALL      RSPTIPA1
          CALL      RPPTIPA1
          BRANCH    OVRCD,INPROV12
.
          PACK      DIM16,PTIRVISN,PTIRINVN,SP70
          MATCH     DIM16,KEY16
          GOTO      INPROV12 IF NOT EQUAL
.
          MOVE      PTIRCOUN,FORM3
.
INPROV12  COMPARE   "999",FORM3
          GOTO      INPROV99 IF EQUAL
.
          ADD       ONE,FORM3
          MOVE      FORM3,PTIRCOUN
.
          PACK      KEY19,KEY16,PTIRCOUN,SP70
          CALL      RAPTIPA1
          COMPARE   ZERO,OVRCD
          GOTO      INPROV12 IF EQUAL
.
          CALL      MVPIPR00
          UNPACK    KEY16,PTIRVISN,PTIRINVN
          CALL      WRPTIPA1
          GOTO      INPROV99
.
INPROV20  PACK      KEY19,ADMISSNO,PTIPR002,PTIPR003,SP70
          CALL      RDPTIPA1
          BRANCH    OVRCD,INPROV91
.
          CALL      MVPIPR00
          CALL      UPPTIPA1
          MOVE      ZERO,EXIT
          GOTO      INPROV99
.
INPROV30  PACK      KEY19,ADMISSNO,PTIPR002,PTIPR003,SP70
          CALL      RDPTIPA1
          BRANCH    OVRCD,INPROV91
.
          CALL      DEPTIPA1
          MOVE      ZERO,EXIT
          GOTO      INPROV99
.
INPROV40  PACK      KEY19,ADMISSNO,PTIPR002,PTIPR003,SP70
          CALL      RDPTIPA1
          IF        OVRCD=1
            UNPACK    SP70,PTIRINVN,PTIRMEDI
            MOVE      ZERO,PTIRPOLA
            UNPACK    SP70,PTIRCHOL,PTIRCPFN
            MOVE      ZERO,PTIRAMNT
.
          ENDIF
.
          MOVE      "Insurance Provider",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,INPROV99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV90  MOVE      "Patient U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV91  MOVE      "Insurance Provider does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV92  MOVE      "Insurance Provider record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV95  MOVE      "Invalid visit number!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPROV99
.
INPROV99  RETURN
+
.------------------------------------------------------------
. Prosthetic Tracking Enquiry
.------------------------------------------------------------
PRSTRK00  MATCH     ANSD,UPDTTYPE
          GOTO      PRSTRK10 IF EQUAL
.
          MATCH     ANSV,UPDTTYPE
          GOTO      PRSTRK20 IF EQUAL
.
          GOTO      PRSTRK90
.
PRSTRK10  REP       "+ ",PTDSVKEY
          PACK      KEY30,PTDSVKEY
          CALL      RDPMPTD1
          IF        OVRCD=1
            CALL      CLPMSPTD            
          ENDIF
.
          PACK      KEY8,PMPEURNO,SP70
          CALL      RDMAST1 
          BRANCH    OVRCD,PRSTRK99
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          GOTO      PRSTRK90
.
PRSTRK20  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PRSTRK99
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          GOTO      PRSTRK90
.
PRSTRK90  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          MOVE      "Prosthetic Tracking Enquiry",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PRSTRK99
          CALL      WEBBOD00
          CALL      WEBEND00
PRSTRK99  RETURN
+
.----------------------------------------------------------------
. Prosthetic Tracking Extract List by Date/Visit Number/UR Number
.----------------------------------------------------------------
PRTR0000  BRANCH    FLDITMNO,PRTR0100,PRTR0200,PRTR0300,PRTR0400,PRTR0500:
                             PRTR0600,PRTR0700,PRTR0800,PRTR0900,PRTR1000:
                             PRTR1100,PRTR1200,PRTR1300,PRTR1400,PRTR1500:
                             PRTR1600,PRTR1700,PRTR1800,PRTR1900,PRTR2000:
                             PRTR2100,PRTR2200,PRTR2300,PRTR2400,PRTR2500:
                             PRTR2600,PRTR2700,PRTR2800,PRTR2900,PRTR3000:
                             PRTR3100,PRTR3200,PRTR3300,PRTR3400,PRTR3500:
                             PRTR3600,PRTR3700,PRTR3800,PRTR3900,PRTR4000:
                             PRTR4100,PRTR4200,PRTR4300,PRTR4400,PRTR4500:
                             PRTR4600
          GOTO      PRTR9999
.
PRTR0100  CALL      NEXT0000
          GOTO      PRTR9999
.
PRTR0200  CALL      PREV0000
          GOTO      PRTR9999
.
PRTR0300  CALL      CURSTD00
          GOTO      PRTR9999
.
PRTR0400  CALL      CUREND00
          GOTO      PRTR9999
.
PRTR0500  CALL      CURYR000
          GOTO      PRTR9999
.
PRTR0600  CALL      CURMON00
          GOTO      PRTR9999
.
PRTR0700  CALL      SELV0000
          GOTO      PRTR9999
.
PRTR0800  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PRTR9999
.
PRTR0900  CALL      PROTAB00           * Prosthetic Tracking Table by Date
          GOTO      PRTR9999
.
PRTR1000  CALL      NXTPRO00
          GOTO      PRTR9999
.
PRTR1100  CALL      PRVPRO00
          GOTO      PRTR9999
.
PRTR1200  UNPACK    PTRKFILN,DIM11,DIM8
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DIM11;
          GOTO      PRTR9999
.
PRTR1300  CALL      PRTABA00          * Prosthetic Tracking Enquiry Detail Tab
          GOTO      PRTR9999
.
PRTR1400  CALL      NXTPRD00
          GOTO      PRTR9999
.
PRTR1500  CALL      PRVPRD00          
          GOTO      PRTR9999
.
PRTR1600  UNPACK    PMPETRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DIM11;
          GOTO      PRTR9999
.
PRTR1700  WRITE     HTMLFILE;PMPETRTM;
          GOTO      PRTR9999
.
PRTR1800  WRITE     HTMLFILE;PMPEVISN;
          GOTO      PRTR9999
.
PRTR1900  WRITE     HTMLFILE;PMPEURNO;
          GOTO      PRTR9999
.
PRTR2000  MATCH     ANSA,PMPETRTY
          IF        @EQUAL
            WRITE     HTMLFILE;"Add   ";
          ENDIF
          MATCH     ANSC,PMPETRTY
          IF        @EQUAL
            WRITE     HTMLFILE;"Change";
          ENDIF
          MATCH     ANSD,PMPETRTY
          IF        @EQUAL
            WRITE     HTMLFILE;"Delete";
          ENDIF
          GOTO      PRTR9999
.
PRTR2100  WRITE     HTMLFILE;PMPEITEM;
          GOTO      PRTR9999
.
PRTR2200  WRITE     HTMLFILE;PMPETRAN;
          GOTO      PRTR9999
.
PRTR2300  WRITE     HTMLFILE;PMPEIDES;
          GOTO      PRTR9999
.
PRTR2400  WRITE     HTMLFILE;PMPESERV;
          GOTO      PRTR9999
.
PRTR2500  UNPACK    PMPETDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DIM11;
          GOTO      PRTR9999
.
PRTR2600  WRITE     HTMLFILE;PMPEAMTT;
          GOTO      PRTR9999
.
PRTR2700  WRITE     HTMLFILE;PMPEAMTP;
          GOTO      PRTR9999
.
PRTR2800  WRITE     HTMLFILE;PMPERBAT;
          GOTO      PRTR9999
.
PRTR2900  WRITE     HTMLFILE;PMPEGSTC;
          GOTO      PRTR9999
.
PRTR3000  WRITE     HTMLFILE;PMPEGSTM;
          GOTO      PRTR9999
.
PRTR3100  WRITE     HTMLFILE;PMPEWUSR;
          GOTO      PRTR9999
.
PRTR3200  WRITE     HTMLFILE;PMPEEXFN;
          GOTO      PRTR9999
.
PRTR3300  UNPACK    PMPEDTEX,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DIM11;
          GOTO      PRTR9999
.
PRTR3400  WRITE     HTMLFILE;PMPETMEX;
          GOTO      PRTR9999
.
PRTR3500  CALL      PATNAM00
          WRITE     HTMLFILE;PATFNAME;
          GOTO      PRTR9999
.
PRTR3600  PACK      KEY6,PMPEGSTC
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ENDIF
          GOTO      PRTR9999
.
PRTR3700  PACK      KEY10,PMPEWUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM;
          ENDIF
.
PRTR3800  WRITE     HTMLFILE;ADMISSNO;
          GOTO      PRTR9999
.
PRTR3900  WRITE     HTMLFILE;URNUMBER;
          GOTO      PRTR9999
.
PRTR4000  MATCH     SP70,URNUMBER
          GOTO      PRTR9999 IF EQUAL
          GOTO      PRTR9999 IF EOS
          CALL      PATNAA00
          WRITE     HTMLFILE;PATFNAME;
          GOTO      PRTR9999
.
PRTR4100  CALL      PRTABB00
          GOTO      PRTR9999
.
PRTR4200  CALL      NXTPRV00
          GOTO      PRTR9999
.
PRTR4300  CALL      PRVPRV00
          GOTO      PRTR9999
.
PRTR4400  CALL      PRTABC00
          GOTO      PRTR9999
.
PRTR4500  CALL      NXTPRU00
          GOTO      PRTR9999
.
PRTR4600  CALL      PRVPRU00
          GOTO      PRTR9999
.
PRTR9999  RETURN
.**********************************************************************
.         Prosthetic Tracking Table by Date
.**********************************************************************
PROTAB00  IF        NORECORD=0
            MOVE      "20",NORECORD       * Set Default No Records to Display
          ENDIF     
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.                   
          PACK      KEY16,LASTDATE,Z70
          CALL      RSPMPTH1
PROTAB10  CALL      RPPMPTH1
          BRANCH    OVRCD,PROTAB99
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PROTAB10
          ENDIF
.
          UNPACK    PMPTEXDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>":
                    "<img src=../images/MaintenanceIcon.gif ":
                    " class=ListIcon onclick=updateParent(#"":
                    PMPTFLNM,"#");>":
                    PMPTFLNM,"</td><td>&nbsp ",DIM11,"</td>":
                    "<td>&nbsp ",PMPTEXTM,"</td>":
                    "<td>&nbsp ",PMPTRCCT,"</td>":
                    "</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PROTAB10 IF NOT EQUAL
.
PROTAB99  RETURN
.**********************************************************************
.         Prosthetic Tracking Enquiry Next Screen
.**********************************************************************
NXTPRO00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE;
.
NXTPRO99  RETURN    
.         
.**********************************************************************
.         Prosthetic Tracking Enquiry Previous Screen
.**********************************************************************
PRVPRO00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE;
.
PRVPRO99  RETURN
.
.**********************************************************************
.         Prosthetic Tracking Detail Table
.**********************************************************************
PRTABA00  MATCH     "1",PTCNTRPR          * Not using Prosthetic Tracking
          GOTO      PRTABA99 IF NOT EQUAL
.
          IF        NORECORD=0
            MOVE      "20",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY55,PTRKFILN,SP70
          CALL      RSPMPTD5
PRTABA10  CALL      RKPMPTD5
          BRANCH    OVRCD,PRTABA99
.
          MATCH     PTRKFILN,PMPEEXFN
          GOTO      PRTABA99 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PRTABA10
          ENDIF
.
          MOVE      SP70,KEY30
          PACK      KEY30,PMPETRDT,PMPETRTM,PMPEVISN,PMPETRAN
          REP       " +",KEY30
.
          MOVE      SP70,DIM6 
          MATCH     ANSA,PMPETRTY
          IF        @EQUAL
            MOVE      "Add",DIM6
          ENDIF
          MATCH     ANSC,PMPETRTY
          IF        @EQUAL
            MOVE      "Change",DIM6
          ENDIF
          MATCH     ANSD,PMPETRTY
          IF        @EQUAL
            MOVE      "Delete",DIM6
          ENDIF
          PACK      DIM6,DIM6,SP70
.
          UNPACK    PMPETRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>":
                    "<img src=../images/MaintenanceIcon.gif ":
                    " class=ListIcon onclick=updateParent(#'":
                    KEY30,"#');>":
                    DIM11,"</td><td>&nbsp ",PMPETRTM,"</td>":
                    "<td>&nbsp ",PMPEURNO,"</td>":
                    "<td>&nbsp ",PMPEVISN,"</td>":
                    "<td>&nbsp ",PMPETRAN,"</td>":
                    "<td>&nbsp ",DIM6,"</td>":
                    "<td>&nbsp ",PMPEITEM,"</td>":
                    "<td>&nbsp ",PMPEAMTT,"</td>":
                    "</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PRTABA10 IF NOT EQUAL
.
PRTABA99  RETURN
.
.**********************************************************************
.         Prosthetic Tracking Detail Next Screen
.**********************************************************************
NXTPRD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptrkfiln=",PTRKFILN;
.
NXTPRD99  RETURN
.
.**********************************************************************
.         Prosthetic Tracking Detail Previous Screen
.**********************************************************************
PRVPRD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2 
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptrkfiln=",PTRKFILN;
.
PRVPRD99  RETURN
.**********************************************************************
.         Prosthetic Tracking Detail Table by Visit Number
.**********************************************************************
PRTABB00  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MATCH     SP70,ADMISSNO
          GOTO      PRTABB99 IF EQUAL
          GOTO      PRTABB99 IF EOS
.
          IF        NORECORD=0
            MOVE      "20",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY30,ADMISSNO,SP70
          CALL      RSPMPTD2
PRTABB10  CALL      RKPMPTD2
          BRANCH    OVRCD,PRTABB99
.
          MATCH     ADMISSNO,PMPEVISN
          GOTO      PRTABB99 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PRTABB10
          ENDIF
.
          MOVE      SP70,KEY30
          PACK      KEY30,PMPETRDT,PMPETRTM,PMPEVISN,PMPETRAN
          REP       " +",KEY30
.
          MOVE      SP70,DIM6
          MATCH     ANSA,PMPETRTY
          IF        @EQUAL
            MOVE      "Add",DIM6
          ENDIF
          MATCH     ANSC,PMPETRTY
          IF        @EQUAL
            MOVE      "Change",DIM6
          ENDIF
          MATCH     ANSD,PMPETRTY
          IF        @EQUAL
            MOVE      "Delete",DIM6
          ENDIF
          PACK      DIM6,DIM6,SP70
.
          UNPACK    PMPETRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>":
                    "<img src=../images/MaintenanceIcon.gif ":
                    " class=ListIcon onclick=updateParent(#'":
                    KEY30,"#');>":
                    DIM11,"</td><td>&nbsp ",PMPETRTM,"</td>":
                    "<td>&nbsp ",PMPETRAN,"</td>":
                    "<td>&nbsp ",DIM6,"</td>":
                    "<td>&nbsp ",PMPEITEM,"</td>":
                    "<td>&nbsp ",PMPEAMTT,"</td>":
                    "<td>&nbsp ",PMPEEXFN,"</td>":
                    "</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PRTABB10 IF NOT EQUAL
.
PRTABB99  RETURN
.**********************************************************************
.         Prosthetic Tracking Detail Next Screen by Visit Number
.**********************************************************************
NXTPRV00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&updttype=V":
                                 "&admissno=",ADMISSNO:
                                 "&urnumber=",URNUMBER;
.
NXTPRV99  RETURN
.
.**********************************************************************
.         Prosthetic Tracking Detail Previous Screen by Visit Number
.**********************************************************************
PRVPRV00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&updttype=V":
                                 "&admissno=",ADMISSNO:
                                 "&urnumber=",URNUMBER;
.
PRVPRV99  RETURN
.**********************************************************************
.         Prosthetic Tracking Detail Table by U/R Number
.**********************************************************************
PRTABC00  REP       "+ ",URNUMBER
          MATCH     SP70,URNUMBER
          GOTO      PRTABC99 IF EQUAL
          GOTO      PRTABC99 IF EOS
.         
          IF        NORECORD=0
            MOVE      "20",NORECORD       * Set Default No Records to Display
          ENDIF     
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.           
          PACK      KEY38,URNUMBER,SP70
          CALL      RSPMPTD3
PRTABC10  CALL      RKPMPTD3
          BRANCH    OVRCD,PRTABC99
.         
          MATCH     URNUMBER,PMPEURNO
          GOTO      PRTABC99 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PRTABC10
          ENDIF
.
          MOVE      SP70,KEY30
          PACK      KEY30,PMPETRDT,PMPETRTM,PMPEVISN,PMPETRAN
          REP       " +",KEY30
.
          MOVE      SP70,DIM6
          MATCH     ANSA,PMPETRTY
          IF        @EQUAL
            MOVE      "Add",DIM6
          ENDIF
          MATCH     ANSC,PMPETRTY
          IF        @EQUAL
            MOVE      "Change",DIM6
          ENDIF
          MATCH     ANSD,PMPETRTY
          IF        @EQUAL
            MOVE      "Delete",DIM6
          ENDIF
          PACK      DIM6,DIM6,SP70
.
          UNPACK    PMPETRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>":
                    "<img src=../images/MaintenanceIcon.gif ":
                    " class=ListIcon onclick=updateParent(#'":
                    KEY30,"#');>":
                    DIM11,"</td><td>&nbsp ",PMPETRTM,"</td>":
                    "<td>&nbsp ",PMPETRAN,"</td>":
                    "<td>&nbsp ",PMPEVISN,"</td>":
                    "<td>&nbsp ",DIM6,"</td>":
                    "<td>&nbsp ",PMPEITEM,"</td>":
                    "<td>&nbsp ",PMPEAMTT,"</td>":
                    "<td>&nbsp ",PMPEEXFN,"</td>":
                    "</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PRTABC10 IF NOT EQUAL
.
PRTABC99  RETURN
.**********************************************************************
.         Prosthetic Tracking Detail Next Screen by U/R Number
.**********************************************************************
NXTPRU00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&updttype=V":
                                 "&urnumber=",URNUMBER;
.
NXTPRU99  RETURN
.
.**********************************************************************
.         Prosthetic Tracking Detail Previous Screen by U/R Number
.**********************************************************************
PRVPRU00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb75.pbl?reportno=12":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&updttype=V":
                                 "&urnumber=",URNUMBER;
.
PRVPRU99  RETURN
.
.------------------------------------------------------------
. Insurance Provider
.------------------------------------------------------------
INSP0000  BRANCH    FLDITMNO,INSP0100,INSP0200,INSP0300,INSP0400
          GOTO      INSP9999
.
INSP0100  IF        CFEETYP=9
            CALL      LIPR0000              * List of JH Insurance Provider
          ENDIF
          GOTO      INSP9999
.
INSP0200  WRITE     HTMLFILE;PTIPR002;
          GOTO      INSP9999
.
INSP0300  WRITE     HTMLFILE;PTIPR003;
          GOTO      INSP9999
.
INSP0400  WRITE     HTMLFILE;INVOICEN;
          GOTO      INSP9999
.
INSP9999  RETURN
+
.*******************************************************************************
. List Johns Hopkins Insurance provider
.*******************************************************************************
LIPR0000  CALL      LIPRHD00      * Output Table Heading
.
          PACK      KEY19,ADMISSNO,PTIPR002,SP70
          CALL      RSPTIPA1
LIPR1000  CALL      RKPTIPA1
          BRANCH    OVRCD,LIPR9999
.
          MATCH     ADMISSNO,PTIRVISN
          GOTO      LIPR9999 IF NOT EQUAL
.
          MATCH     PTIPR002,PTIRINVN
          GOTO      LIPR9999 IF NOT EQUAL
.
          CALL      TIPR0000
.
          GOTO      LIPR1000
.
LIPR9999 RETURN
+
.------------------------------------------------------------
. TABLE HEADING
.------------------------------------------------------------
LIPRHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell>Medical Claim</td>":
                             "<td class=HeadingCell>Account Holder</td>":
                             "<td class=HeadingCell>CPF Number</td>":
                             "<td align=right class=HeadingCell>":
                             "Policy Amount</td>":
                             "<td align=right class=HeadingCell>":
                             "Amount Deducted</td>":
                             "</tr>"
.
LIPRHD99  RETURN
.------------------------------------------------------------
. TABLE ROW
.------------------------------------------------------------
TIPR0000  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:UpdInsProv":
                               "(#"":
                             PTIRVISN,"#",#"",PTIRINVN,"#",#"",PTIRCOUN,"#")'>":
                               "<img src=../images/EditIcon.gif ":
                               "class=ListIcon></a>":
                               PTIRMEDI,"</td>";
.
          WRITE     HTMLFILE;"<td>&nbsp;",PTIRCHOL,"</td>":
                             "<td>&nbsp;",PTIRCPFN,"</td>":
                             "<td align=right>",PTIRPOLA,"</td>":
                             "<td align=right>",PTIRAMNT,"</td>":
                             "</tr>"
.
TIPR9999 RETURN
+
.------------------------------------------------------------------------------
. PREDIR00 - Redirect Parent URL
.------------------------------------------------------------------------------
.
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
          ADD       ONE,COUNTER
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else if ":
                             "    (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else {":
                             "    location.href=#"",REDIRECT,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
.
.******************************************************************************
.        Workout the rounding amount
.******************************************************************************
GRND0000 MOVE      PMMIAMTT,FORM12P2
         MOVE      FORM12P2,KEY15
         UNPACK    KEY15,KEY14,KEY1
         MOVE      ZERO,FORM1
         MOVE      ZERO,FORM12D2
         MOVE      KEY1,FORM1
         COMPARE   ZERO,FORM1
         GOTO      GRND9999 IF EQUAL
.
.        5 cent rounding
.
         BRANCH    FORM1,GRND1000,GRND1000:
                         GRND1000,GRND1000,GRND9999,GRND7000,GRND7000:
                         GRND7000,GRND7000
.
GRND1000 MOVE      FIVE,FORM12D2
         GOTO      GRND8000
.
GRND7000 ADD       ".1",FORM12P2
.
GRND8000 SUB       FORM1,FORM12D2
         DIV       "100",FORM12D2
         ADD       FORM12D2,FORM12P2
         GOTO      GRND9999
.
GRND9999 MOVE      FORM12P2,PMMIAMTT
         RETURN
+
GETBF00   RETURN
.
.------------------------------------------------------------
. Delete Invoice Pending Record
.------------------------------------------------------------
DPEN0000  MATCH     SP70,UPDTTYPE
          GOTO      DPEN7000 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * Remove holding invoice
          GOTO      DPEN1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Place visit invoice on hold
          GOTO      DPEN2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      DPEN3000 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * apply health fund/claim on hold
          GOTO      DPEN4000 IF EQUAL
.
          GOTO      DPEN9000   
.
DPEN1000  PACK      KEY8,ADMISSNO,SP70 
          CALL      RDIPEN1 
          BRANCH    OVRCD,DPEN9200
.
          UNPACK    SP70,PTIPRHLD,PTIPRDES
          CALL      UPIPEN1
.
          MOVE      ADMISSNO,PTONVISN
          MOVE      " 3",PTONVAVL
.
          MOVE      WBSEUID,PTONURID
          MOVE      PTIPE001,PTONREAH
          MOVE      PTIPE002,PTONDESC
          MOVE      "R",PTONHACT              * removed hold for visit
          PACK      PTONHLIN,SP70
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMISS1
          MOVE      ACLAIM,PTONCLCD
          MOVE      AFUNDH,PTONHLFU
.
DPEN1200  CALL      IBACLOCK
          PACK      PTONTDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",PTONTDAT
          MOVE      CTIMEIS,PTONTTIM
.
          PACK      KEY24,ADMISSNO,PTONTDAT,PTONTTIM,SP70
          CALL      RAPTONH1
          COMPARE   ZERO,OVRCD
          GOTO      DPEN1200 IF EQUAL
.
          CALL      WRPTONH1          
.
          CALL      BVISUP00      * Send A08 when invoice hold removed
.
          MOVE      ZERO,EXIT
          GOTO      DPEN9999
.         
DPEN2000  PACK      KEY8,ADMISSNO,SP70 
          CALL      RDIPEN1 
          BRANCH    OVRCD,DPEN9200
.
          MATCH     Z70,PTIPE001
          IF        !@EQUAL
            PACK      PTIPRHLD,PTIPE001,SP70
          ENDIF
.
          MATCH     Z70,PTIPE002
          IF        !@EQUAL
            PACK      PTIPRDES,PTIPE002,SP70
          ENDIF
.
          CALL      UPIPEN1
.
          PACK      PTONHLIN,SP70                 * hold invoice from date
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPTONH1
          CALL      RPPTONH1
          BRANCH    OVRCD,DPEN2100
          MATCH     ADMISSNO,PTONVISN
          GOTO      DPEN2100 IF NOT EQUAL
.
          PACK      KEY5,CATRH,PTONREAH,SP70
          CALL      RDCODE1                     
          BRANCH    OVRCD,DPEN2100 
          PACK      D1,TCINDC2,SP70               * Ind 2 of previous record
          PACK      KEY5,CATRH,PTIPE001,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DPEN2100
.
          MOVE      "T",PTONHACT                  * Updated hold for visit
          GOTO      DPEN2200
.
DPEN2100  MOVE      "A",PTONHACT                  * Added hold for visit
.
DPEN2200  MOVE      ADMISSNO,PTONVISN
          MOVE      " 3",PTONVAVL
          MOVE      WBSEUID,PTONURID
          MOVE      PTIPE001,PTONREAH
          MOVE      PTIPE002,PTONDESC
          PACK      PTONHLIN,SP70
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMISS1 
          MOVE      ACLAIM,PTONCLCD
          MOVE      AFUNDH,PTONHLFU
.
DPEN2300  CALL      IBACLOCK
          PACK      PTONTDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",PTONTDAT
          MOVE      CTIMEIS,PTONTTIM
.
          PACK      KEY24,ADMISSNO,PTONTDAT,PTONTTIM,SP70
          CALL      RAPTONH1
          COMPARE   ZERO,OVRCD
          GOTO      DPEN2300 IF EQUAL
.
          CALL      WRPTONH1
.
          CALL      BVISUP00      * Send A08 when Invoice placed on hold
.
          MOVE      ZERO,EXIT
          GOTO      DPEN9999
.
DPEN3000  PACK      KEY8,ADMISSNO,SP70 
          CALL      RDIPEN1 
          BRANCH    OVRCD,DPEN9200
.
          CALL      DEIPEN1                
.
          MOVE      ZERO,EXIT
          GOTO      DPEN9999
.
DPEN4000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDIPEN1
          BRANCH    OVRCD,DPEN9200
.
          MOVE      IPSYSTM,PVITYPE
          CALL      HOLD0000                 * Check HF/Claim on hold
          CALL      UPIPEN1
.
          GOTO      DPEN9999
.
DPEN7000  PACK      KEY8,URNUMBER,SP70 
          CALL      RDMAST1
          BRANCH    OVRCD,DPEN9100
.
          PACK      KEY8,URNUMBER,SP70 
          CALL      RDPMPX21
          BRANCH    OVRCD,DPEN9100
.
          PACK      KEY8,ADMISSNO,SP70 
          CALL      RDMISS1
          BRANCH    OVRCD,DPEN9300
          CALL      RDIPEN1 
          BRANCH    OVRCD,DPEN9200
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,DPEN8000
.
          MATCH     "P",TCINDC2
          GOTO      DPEN8000 IF EQUAL             * Patient hold invoice
.
          MATCH     "C",TCINDC4
          GOTO      DPEN8000 IF EQUAL             * CodeFocus hold invoice
.
          PACK      DIM80,SP70,SP70
          MOVE      PTIPRDES,DIM80
          CALL      HFIV0000                      * Check Health Fund Hold
          MATCH     SP70,DIM80
          IF        !@EQUAL
            MOVE      DIM80,PTIPRDES
          ENDIF
.
DPEN8000  CLEAR     WEBTITLE
          MOVE      "Invoice Pending",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DPEN9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      DPEN9999
.
DPEN9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DPEN9999
.
DPEN9100  MOVE      "Patient U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DPEN9999
.
DPEN9200  CLEAR     WEBTITLE
          APPEND    "No invoice pending details found for visit : ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DPEN9999
.
DPEN9300  MOVE      "Patient Admission does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DPEN9999
.
DPEN9999  RETURN
+
.------------------------------------------------------------
. Bulk Miscellaneous Charges
.------------------------------------------------------------
BMSC0000  MATCH     SP70,UPDTTYPE
          GOTO      BMSC8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add misc charge
          GOTO      BMSC2000 IF EQUAL
.
          MATCH     "B",UPDTTYPE            * Display update misc item
          GOTO      BMSC3000 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Update misc charge
          GOTO      BMSC4000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete misc charge
          GOTO      BMSC5000 IF EQUAL
.
          MATCH     "E",UPDTTYPE            * Post temp records to patients
          GOTO      BMSC6000 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Cancel Batch
          GOTO      BMSC7000 IF EQUAL
.
          GOTO      BMSC9000
.
BMSC2000  CALL      ADDBMC00                * Add
.
          STRIP     REDIRECT                * Append batch number to redirect
          ENDSET    REDIRECT
          APPEND    "&tmmtibat=",REDIRECT
          REP       " +",PMMIMBCH
          APPEND    PMMIMBCH,REDIRECT
          RESET     REDIRECT
.
          GOTO      BMSC9999
.
BMSC3000  PACK      KEY22,TMMTIBAT,ADMISSNO,TRANNUMB       * Display
          CALL      RDTMMTI1
          BRANCH    OVRCD,BMSC9010
.
          GOTO      BMSC8000
.
BMSC4000  PACK      KEY8,TMMTI002,SP70                     * Update
          CALL      RDPMVX11
          BRANCH    OVRCD,BMSC9050
.
          IF        IBCNMHOS=1
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,BMSC9060
          ENDIF
.
          PACK      KEY8,TMMTI002,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,BMSC9030
.
          REP       " 0",ADATE
          MATCH     ADATE,TMMTI003
          GOTO      BMSC9070 IF LESS
.
          MOVE      TMMTI003,MISCDATE
          MOVE      TMMTI004,MCHARGE
          PACK      MCHARGE,MCHARGE,SP70
          CALL      GETMSC00
          BRANCH    EXIT,BMSC9040
.
          PACK      KEY8,TMMTI002,SP70
          CALL      RDDSCH1
          IF        OVRCD=0
            REP       " 0",DDATE
            MATCH     TMMTI003,DDATE
            GOTO      BMSC9020 IF LESS
          ENDIF 
.
          PACK      KEY22,TMMTIBAT,TMMTI002,TRANNUMB,SP70
          CALL      RDTMMTI1
          BRANCH    OVRCD,BMSC9010
.
          CALL      BMCSAV00      * Moves input variables to file variables
          CALL      UPTMMTI1      * Writes away the data
          MOVE      ZERO,EXIT
          GOTO      BMSC9999
.
BMSC5000  PACK      KEY22,TMMTIBAT,TMMTI002,TRANNUMB,SP70       * Delete
          CALL      RDTMMTI1
          BRANCH    OVRCD,BMSC9010
.
          CALL      DETMMTI1      * Deletes the data
          MOVE      ZERO,EXIT
          GOTO      BMSC9999
.
BMSC6000  CALL      PBMSC000                * Post temp records to patients
          MOVE      ZERO,EXIT
          GOTO      BMSC9999
.
BMSC7000  CALL      CANBMS00                * Cancel Batch
.
          MOVE      ZERO,EXIT
          GOTO      BMSC9999
.
BMSC8000  CLEAR     WEBTITLE
          MOVE      "Bulk Miscellaneous Charges",WEBTITLE
          RESET     WEBTITLE 
.
          CALL      WEBHED00
          BRANCH    EXIT,BMSC9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9010  MOVE      "Bulk Miscellaneous Item Record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9020  CLEAR     WEBTITLE
          APPEND    "Date must be before Discharge Date: ",WEBTITLE
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9030  CLEAR     WEBTITLE
          MOVE      "Admission Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9040  CLEAR     WEBTITLE
          MOVE      "Miscellaneous Charge Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9050  CLEAR     WEBTITLE
          MOVE      "Visit Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9060  CLEAR     WEBTITLE
          MOVE      "Hospital Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999
.
BMSC9070  CLEAR     WEBTITLE
          APPEND    "Date must be after Admission Date: ",WEBTITLE
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BMSC9999

.
BMSC9999  RETURN
+
.------------------------------------------------------------
. Cancel Bulk Misc Charge Batch
.------------------------------------------------------------
CANBMS00  PACK      KEY22,TMMTIBAT,SP70     * Cancel Batch
          CALL      RSTMMTI1
CANBMS10  CALL      RKTMMTI1
          BRANCH    OVRCD,CANBMS99
.
          MATCH     TMMTIBAT,PMMIMBCH
          GOTO      CANBMS99 IF NOT EQUAL
.
          PACK      KEY22,PMMIMBCH,PMMIVISN,PMMITRAN,SP70
          CALL      DETMMTI1
          GOTO      CANBMS10
.
CANBMS99  RETURN
+
.------------------------------------------------------------
. Bulk Miscellaneous Charges Tags
.------------------------------------------------------------
BKMC0000  BRANCH    FLDITMNO,BKMC0100,BKMC0200,BKMC0300,BKMC0400
          GOTO      BKMC9999
.
BKMC0100  PACK      KEY22,TMMTIBAT,SP70
          CALL      RSTMMTI1
          CALL      RKTMMTI1
          IF        OVRCD=1
            WRITE     HTMLFILE;ZERO;
          ELSE
            MATCH     TMMTIBAT,PMMIMBCH
            IF        !@EQUAL
              WRITE     HTMLFILE;ZERO;
            ELSE
              WRITE     HTMLFILE;ONE;
            ENDIF
          ENDIF      
.
          GOTO      BKMC9999
.
BKMC0200  CALL      BMTAB000
          GOTO      BKMC9999
.
BKMC0300  MOVE      ZERO,BMCHTOTL
.
          PACK      KEY22,TMMTIBAT,SP70
          CALL      RSTMMTI1
BKMC0310  CALL      RKTMMTI1
          BRANCH    OVRCD,BKMC0350
.
          MATCH     TMMTIBAT,PMMIMBCH
          GOTO      BKMC0350 IF NOT EQUAL
.
          ADD       PMMIAMTT,BMCHTOTL
.
          GOTO      BKMC0310
.
BKMC0350  MOVE      BMCHTOTL,DIM15
          LJUSTIFY  DIM15
          WRITE     HTMLFILE;DIM15;
          GOTO      BKMC9999
.
BKMC0400  WRITE     HTMLFILE;TMMTIBAT;           * Batch number
          GOTO      BKMC9999
.
BKMC9999  RETURN
.------------------------------------------------------------
. Bulk Miscellaneous Charges Table
.------------------------------------------------------------
BMTAB000  MOVE      ZERO,BMCHTOTL
.
          MATCH     SP70,TMMTIBAT
          GOTO      BMTAB999 IF EQUAL
.
          PACK      KEY22,TMMTIBAT,SP70
          CALL      RSTMMTI1
BMTAB010  CALL      RKTMMTI1
          BRANCH    OVRCD,BMTAB999
.
          MATCH     TMMTIBAT,PMMIMBCH
          GOTO      BMTAB999 IF NOT EQUAL
.
          MOVE      SP70,DIM30
          PACK      KEY8,PMMIURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,DIM30
          ENDIF
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMMITDAT
          IF        !@EQUAL
            REP       " 0",PMMITDAT
            UNPACK    PMMITDAT INTO CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          ADD       PMMIAMTT,BMCHTOTL
.
          CALL      BMTROW00
          GOTO      BMTAB010
.
BMTAB999  RETURN
.------------------------------------------------------------
. Bulk Miscellaneous Charges Table Row
.------------------------------------------------------------
BMTROW00  WRITE     HTMLFILE;"<tr>":
                      "<td>&nbsp;<img src=../images/MaintenanceIcon.gif ":
                      "class=ListIcon onclick='updBulkMiscChargesPopUpFrame(#"":
                             PMMIMBCH,"#",#"":
                             PMMIVISN,"#",#"":
                             PMMITRAN,"#")'>":
                             PMMIURNO,"</td>":
                            "<td>&nbsp;",PMMIVISN,"</td>":
                            "<td>&nbsp;",DIM30,"</td>":
                            "<td>&nbsp;",DIM11,"</td>":
                            "<td>&nbsp;",PMMIITEM," ",PMMIDESC,"</td>":
                            "<td>&nbsp;",PMMISERV,"</td>":
                            "<td>&nbsp;",PMMIAMTT,"</td>":
                            "</tr>"
.
BMTROW99  RETURN
.
.------------------------------------------------------------
. Add Bulk Miscellaneous Charges
.------------------------------------------------------------
ADDBMC00  MOVE      ZERO,EXIT
.
          PACK      KEY8,TMMTI002,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDBMC93
.
          IF        IBCNMHOS=1
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,ADDBMC94
          ENDIF
.
          PACK      KEY8,TMMTI002,SP70
          CALL      RDPTMIS1          
          BRANCH    OVRCD,ADDBMC91
.
          REP       " 0",ADATE
          MATCH     ADATE,TMMTI003
          GOTO      ADDBMC95 IF LESS 
.
          MOVE      TMMTI003,MISCDATE
          MOVE      TMMTI004,MCHARGE
          PACK      MCHARGE,MCHARGE,SP70
          CALL      GETMSC00
          BRANCH    EXIT,ADDBMC92
.
          PACK      KEY8,TMMTI002,SP70
          CALL      RDDSCH1
          IF        OVRCD=0
            REP       " 0",DDATE
            MATCH     TMMTI003,DDATE
            GOTO      ADDBMC90 IF LESS
          ENDIF          
.
          CALL      CLTMTI00
.
          MOVE      TMMTI002,PMMIVISN
          MOVE      TMMTI002,KEY8
.
ADDBMC10  CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      ADDBMC10 IF EQUAL
.
          MOVE      TMMTI001,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      TMMTI004,PMMIITEM
          MOVE      TMMTI005,PMMIDESC
          MOVE      SP70,PMMIDES2
          MOVE      TMMTI003,PMMITDAT
          MOVE      "3",PMMIRTYP
          MOVE      TMMTI007,PMMIREFN
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      TMMTI006,PMMISERV
.
          MOVE      TMMTI008,PMMIAMTP
          MOVE      TMMTI009,PMMIRBAT
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
.
          MOVE      SP70,PMMITDOC
          MOVE      SP70,PMMIODOC
          MOVE      SP70,PMMISESS
          MOVE      SP70,PMMIMGRP
          MOVE      SP70,PMMIBTCH
          MOVE      ONE,PMMIINVN
          IF        IBCNUGST=2
            MOVE      PTMCGSTA,PMMIGSTA
            MOVE      PTMCGSTC,PMMIGSTC
          ENDIF
          IF        IBCNUGST=3
            MOVE      "1",PMMIGSTA
            MOVE      PTCNAGST,PMMIGSTC
          ENDIF
          MOVE      ZERO,PMMIGSTM
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      USERID,PMMIWUSR        * WEB user id
          CALL      IBACLOCK
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          MOVE      CTIMEIS,PMMITMCR
          MOVE      USERID,PMMIIDCR
          MOVE      CTIMEIS,PMMISVTM
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMIMVBR
          MOVE      SP70,PMMIUNIQ
          MOVE      SP70,PMMICNTR
          MOVE      SP70,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD 
          MOVE      SP70,PMMICCON
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIITYP
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
          MATCH     SP70,TMMTIBAT
          IF        @EQUAL
            MOVE      "118",PRXCODE   * System Lock Sector 118
            CALL      GETSLK00        * Get System Lock of Sector 118
            READ      CONTROLF,HUND18;*104,PTCNNMBN
            MOVE      PTCNNMBN,FORM8
            ADD       ONE,FORM8
            WRITAB    CONTROLF,HUND18;*104,FORM8
            CALL      RELSLK00        * Release System Lock of Sector 119
            SUB       ONE,FORM8
            MOVE      FORM8,PMMIMBCH         * got batch number
            MOVE      FORM8,TMMTIBAT
          ELSE
            MOVE      TMMTIBAT,PMMIMBCH
          ENDIF
.
          PACK      KEY22,PMMIMBCH,PMMIVISN,PMMITRAN
          CALL      WRTMMTI1
.
          GOTO      ADDBMC99
.
ADDBMC90  CLEAR     WEBTITLE
          APPEND    "Date must be before Discharge Date: ",WEBTITLE
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC91  CLEAR     WEBTITLE
          MOVE      "Admission Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC92  CLEAR     WEBTITLE
          MOVE      "Miscellaneous Charge Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC93  CLEAR     WEBTITLE
          MOVE      "Visit Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC94  CLEAR     WEBTITLE
          MOVE      "Hospital Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC95  CLEAR     WEBTITLE
          APPEND    "Date must be After Admission Date: ",WEBTITLE
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBMC99
.
ADDBMC99  RETURN
.
.------------------------------------------------------------
. Set up Bulk Misc Charges variables
.------------------------------------------------------------
STTMT000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STTMT010,STTMT020,STTMT030,STTMT040,STTMT050:
                       STTMT060,STTMT070,STTMT080,STTMT090
          GOTO      STTMT999
.
STTMT010  MOVE      QRYDATA,TMMTI001
          GOTO      STTMT999
.
STTMT020  MOVE      QRYDATA,TMMTI002
          GOTO      STTMT999
.
STTMT030  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      TMMTI003,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TMMTI003
          GOTO      STTMT999
.
STTMT040  MOVE      QRYDATA,TMMTI004
          GOTO      STTMT999
.
STTMT050  MOVE      QRYDATA,TMMTI005
          GOTO      STTMT999
.
STTMT060  MOVE      QRYDATA,TMMTI006
          GOTO      STTMT999
.
STTMT070  MOVE      QRYDATA,TMMTI007
          GOTO      STTMT999
.
STTMT080  MOVE      QRYDATA,TMMTI008
          GOTO      STTMT999
.
STTMT090  MOVE      QRYDATA,TMMTI009
          GOTO      STTMT999
.
STTMT999  RETURN
+
.------------------------------------------------------------
. Clear tmpmtiaf variables (pmsmtiaf)
.------------------------------------------------------------
CLTMTI00  MOVE      SP70,PMMIVISN
          MOVE      SP70,PMMITRAN
          MOVE      SP70,PMMIURNO
          MOVE      SP70,PMMISYST
          MOVE      SP70,PMMIITEM
          MOVE      SP70,PMMIDESC
          MOVE      SP70,PMMIDES2
          MOVE      SP70,PMMITDAT
          MOVE      SP70,PMMIRTYP
          MOVE      SP70,PMMIREFN
          MOVE      ZERO,PMMIAMTT
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      ZERO,PMMIAMTP
          MOVE      ZERO,PMMIRBAT
          MOVE      SP70,PMMITDOC
          MOVE      ZERO,PMMISERV
          MOVE      SP70,PMMIODOC
          MOVE      SP70,PMMISESS
          MOVE      SP70,PMMIMGRP
          MOVE      SP70,PMMIBTCH
          MOVE      SP70,PMMIINVN
          MOVE      ZERO,PMMIGSTA
          MOVE      SP70,PMMIGSTC
          MOVE      ZERO,PMMIGSTM
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          MOVE      SP70,PMMIDTCR
          MOVE      SP70,PMMITMCR
          MOVE      SP70,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMIMVBR
          MOVE      SP70,PMMIUNIQ
          MOVE      SP70,PMMICNTR
          MOVE      SP70,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP70,PMMICCON
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIITYP
          MOVE      SP70,PMMIMBCH
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
CLTMTI99  RETURN
.
.------------------------------------------------------------
.    Bulk Miscellaneous Charges Tags
.------------------------------------------------------------
BMCT0000  BRANCH    FLDITMNO,BMCT0100,BMCT0200,BMCT0300,BMCT0400:
                             BMCT0500,BMCT0600,BMCT0700,BMCT0800:
                             BMCT0900,BMCT1000,BMCT1100,BMCT1200
          GOTO      BMCT9999
.
BMCT0100  WRITE     HTMLFILE;PMMIURNO;
          GOTO      BMCT9999
.
BMCT0200  WRITE     HTMLFILE;PMMIVISN;
          GOTO      BMCT9999
.
BMCT0300  REP       " 0",PMMITDAT
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      BMCT9999
.
BMCT0400  WRITE     HTMLFILE;PMMIITEM;
          GOTO      BMCT9999
.
BMCT0500  WRITE     HTMLFILE;PMMIDESC;
          GOTO      BMCT9999
.
BMCT0600  WRITE     HTMLFILE;PMMISERV;
          GOTO      BMCT9999
.
BMCT0700  WRITE     HTMLFILE;PMMIREFN;
          GOTO      BMCT9999
.
BMCT0800  WRITE     HTMLFILE;PMMIAMTT;
          GOTO      BMCT9999
.
BMCT0900  WRITE     HTMLFILE;PMMITRAN;
          GOTO      BMCT9999
.
BMCT1000  WRITE     HTMLFILE;PMMIAMTP;
          GOTO      BMCT9999
.
BMCT1100  WRITE     HTMLFILE;WBSEHOSP;
          GOTO      BMCT9999
.
BMCT1200  WRITE     HTMLFILE;PMMIMBCH;
          GOTO      BMCT9999
.
BMCT9999  RETURN
.
.------------------------------------------------------------
. Save Bulk Miscellaneous Charges variables
.------------------------------------------------------------
BMCSAV00  MOVE      TMMTI004,PMMIITEM
          MOVE      TMMTI005,PMMIDESC
          MOVE      TMMTI003,PMMITDAT
          MOVE      TMMTI007,PMMIREFN
          MOVE      TMMTI006,PMMISERV
.
          MOVE      TMMTI008,PMMIAMTP
          MOVE      TMMTI009,PMMIRBAT
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT

          CALL      IBACLOCK
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          MOVE      CTIMEIS,PMMITUPD
          MOVE      USERID,PMMIWUSR
.
BMCSAV99  RETURN
.
.------------------------------------------------------------
. Post Bulk Miscellaneous Charges
.------------------------------------------------------------
PBMSC000  PACK      KEY22,TMMTIBAT,SP70
          CALL      RSTMMTI1
PBMSC010  CALL      RKTMMTI1
          BRANCH    OVRCD,PBMSC100
.
          MATCH     TMMTIBAT,PMMIMBCH
          GOTO      PBMSC100 IF NOT EQUAL
.
PBMSC015  PACK      KEY14,PMMIVISN,PMMITRAN,SP70
          CALL      RAPMMTI1
          IF        OVRCD=0
            PACK      KEY8,PMMIVISN,SP70
            CALL      TRVISA1
            MOVE      PVITRAN,PMMITRAN
            GOTO      PBMSC015
          ENDIF
.
          UNPACK    SP70,PMMITMNO,PMMIPMBS,PMMIRBRS,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          PACK      PMMIDKSM,SP70       * Distance Kms
.
          PACK      KEY14,PMMIVISN,PMMITRAN,SP70
          CALL      WRPMMTI1
.
          GOTO      PBMSC010
.
PBMSC100  PACK      KEY22,TMMTIBAT,SP70
          CALL      RSTMMTI1
          CALL      RKTMMTI1
          BRANCH    OVRCD,PBMSC999
.
          MATCH     TMMTIBAT,PMMIMBCH
          GOTO      PBMSC999 IF NOT EQUAL
.
          PACK      KEY22,PMMIMBCH,PMMIVISN,PMMITRAN,SP70
          CALL      DETMMTI1
.
          GOTO      PBMSC100
.
PBMSC999  RETURN
.
.------------------------------------------------------------
. Get Default Miscellaneous Charge
.------------------------------------------------------------
GETMCD00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          IF        IBCNMHOS=1
            MOVE      PTHSDCLM,MCLMCOD
          ELSE
            MOVE      PTCNDCLM,MCLMCOD
          ENDIF
          PACK      KEY21,MCLMCOD,SP9,KEY9
          PACK      KEY29,KEY21,KEY8
          CALL      RDMCHG1
          IF        OVRCD=0
            MATCH     "1",PTMCACTV               * Inactive ?
            GOTO      GETMCD99 IF NOT EQUAL      * No
          ENDIF
.
          CALL      RDPMCHG1
          BRANCH    OVRCD,GETMCD90
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE
          MATCH     KEY21,KEY21A
          GOTO      GETMCD90 IF NOT EQUAL
.
          MATCH     "1",PTMCACTV               * Inactive ?
          GOTO      GETMCD99 IF NOT EQUAL      * No
.
GETMCD90  MOVE      ONE,EXIT
GETMCD99  RETURN
.
+
.----------------------------------------------------------------
. Invoice Pending Tags
.----------------------------------------------------------------
PTIP0000  BRANCH    FLDITMNO,PTIP0100,PTIP0200,PTIP0300,PTIP0400,PTIP0500:
                             PTIP0600,PTIP0700,PTIP0800
          GOTO      PTIP9999
.
PTIP0100  WRITE     HTMLFILE;IPADMNO;       * Adission number
          GOTO      PTIP9999
.
PTIP0200  WRITE     HTMLFILE;IPSYSTM;       * System Indicator
          GOTO      PTIP9999
.
PTIP0300  WRITE     HTMLFILE;IPSITE;        * OP Site Code 
          GOTO      PTIP9999
.
PTIP0400  MOVE      "rh",CATEGORY           * Reason for Hold
          MOVE      PTIPRHLD,CODE
          CALL      CODITM00
          GOTO      PTIP9999
.
PTIP0500  WRITE     HTMLFILE;PTIPRDES;      * Reason for Hold Free Text
          GOTO      PTIP9999
.
PTIP0600  WRITE     HTMLFILE;TRNSUPTY;      * Supervisor Hold Invoice  
          GOTO      PTIP9999
.
PTIP0700  MOVE      "rh",CATEGORY           * Reason for Hold
          MOVE      PTFHHREA,CODE
          CALL      CODITM00
          GOTO      PTIP9999
.
PTIP0800  IF        TRNSUPTY=1
            WRITE     HTMLFILE;"Supervisor "; * Supervisor Hold Invoice title  
          ENDIF
PTIP0850  GOTO      PTIP9999
.
PTIP9999  RETURN
.
.------------------------------------------------------------
. Bulk Journal Input
.------------------------------------------------------------
BJRN0000  CALL      CLTMJR00                * Clear file vars
.
          MATCH     SP70,UPDTTYPE
          GOTO      BJRN8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add journal
          GOTO      BJRN2000 IF EQUAL
.
          MATCH     "B",UPDTTYPE            * Display update journal
          GOTO      BJRN3000 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Update journal
          GOTO      BJRN4000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete journal
          GOTO      BJRN5000 IF EQUAL
.
          MATCH     "E",UPDTTYPE            * Post temp records to patients
          GOTO      BJRN6000 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Cancel batch 
          GOTO      BJRN7000 IF EQUAL
.
          GOTO      BJRN9000
.
BJRN2000  CALL      ADDBJR00                * Add
.
          STRIP     REDIRECT                * Append batch number to redirect
          ENDSET    REDIRECT
          APPEND    "&tmjrnbat=",REDIRECT
          REP       " +",TMJRBTCH
          APPEND    TMJRBTCH,REDIRECT
          RESET     REDIRECT
.
          GOTO      BJRN9999
.
BJRN3000  PACK      KEY35,TMJRNBAT,TMJRN001,TMJRN002,TMJRN003,TMJRN004,SP70 * Display
          CALL      RDTMJRN1
          BRANCH    OVRCD,BJRN9100          
.
          GOTO      BJRN8000
.
BJRN4000  PACK      KEY35,TMJRNBAT,TMJRN001,TMJRN002,TMJRN003,TMJRN004,SP70 * Update 
          CALL      RDTMJRN1
          BRANCH    OVRCD,BJRN9100
.
          MOVE      TMJRN004,TMJRJTYP
          MOVE      TMJRN005,TMJRJDAT
          MOVE      TMJRN006,TMJRDESC
          MOVE      TMJRN007,TMJRAMNT
          MOVE      TMJRN008,TMJRGSTC
.
          CALL      UPTMJRN1
.
          MOVE      ZERO,EXIT
          GOTO      BJRN9999
.
BJRN5000  PACK      KEY35,TMJRNBAT,TMJRN001,TMJRN002,TMJRN003,TMJRN004,SP70 * Delete
          CALL      RDTMJRN1
          BRANCH    OVRCD,BJRN9100
.
          CALL      DETMJRN1
.
          MOVE      ZERO,EXIT
          GOTO      BJRN9999
.
BJRN6000  CALL      POSBJR00                * Post temp records to patients
          GOTO      BJRN9999
.
BJRN7000  CALL      CANBJR00                * Cancel Batch
.
          MOVE      ZERO,EXIT
          GOTO      BJRN9999
.
BJRN8000  CLEAR     WEBTITLE
          MOVE      "Bulk Journal",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,BJRN9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      BJRN9999
.
BJRN9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BJRN9999
.
BJRN9100  MOVE      "Bulk Journal Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BJRN9999
.
BJRN9999  RETURN
.
.------------------------------------------------------------
. Set up bulk journal cgi variables
.------------------------------------------------------------
STJRN000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STJRN010,STJRN020,STJRN030,STJRN040,STJRN050:
                       STJRN060,STJRN070,STJRN080
          GOTO      STJRN999
.
STJRN010  MOVE      QRYDATA,TMJRN001
          GOTO      STJRN999
.
STJRN020  MOVE      QRYDATA,TMJRN002
          GOTO      STJRN999
.
STJRN030  MOVE      QRYDATA,TMJRN003
          GOTO      STJRN999
.
STJRN040  MOVE      QRYDATA,TMJRN004
          GOTO      STJRN999
.
STJRN050  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      TMJRN005,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TMJRN003
          GOTO      STJRN999
.
STJRN060  MOVE      QRYDATA,TMJRN006
          GOTO      STJRN999
.
STJRN070  MOVE      QRYDATA,TMJRN007
          GOTO      STJRN999
.
STJRN080  MOVE      QRYDATA,TMJRN008
          GOTO      STJRN999
.
STJRN999  RETURN
.
.------------------------------------------------------------
. Bulk journal tags
.------------------------------------------------------------
TMJR0000  BRANCH    FLDITMNO,TMJR0100,TMJR0200,TMJR0300,TMJR0400,TMJR0500:
                             TMJR0600,TMJR0700,TMJR0800,TMJR0900,TMJR1000:
                             TMJR1100,TMJR1200,TMJR1300,TMJR1400,TMJR1500:
                             TMJR1600,TMJR1700,TMJR1800
          GOTO      TMJR9999
.
TMJR0100  WRITE     HTMLFILE;TMJRBTCH;
          GOTO      TMJR9999
.
TMJR0200  WRITE     HTMLFILE;TMJRURNO;
          GOTO      TMJR9999
.
TMJR0300  WRITE     HTMLFILE;TMJRVIST;
          GOTO      TMJR9999
.
TMJR0400  WRITE     HTMLFILE;TMJRINVN;
          GOTO      TMJR9999
.
TMJR0500  MOVE      "J ",CATEGORY
          MOVE      TMJRJTYP,CODE
          CALL      CODITM00
          GOTO      TMJR9999
.
TMJR0600  REP       " 0",TMJRJDAT
          UNPACK    TMJRJDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                               DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TMJR9999
.
TMJR0700  WRITE     HTMLFILE;TMJRDESC;
          GOTO      TMJR9999
.
TMJR0800  WRITE     HTMLFILE;TMJRAMNT;
          GOTO      TMJR9999
.
TMJR0900  WRITE     HTMLFILE;TMJRNBAT;                             
          GOTO      TMJR9999
.
TMJR1000  PACK      KEY35,TMJRNBAT,SP70
          CALL      RSTMJRN1
          CALL      RKTMJRN1
          IF        OVRCD=1
            WRITE     HTMLFILE;ZERO;
          ELSE
            MATCH     TMJRNBAT,TMJRBTCH
            IF        !@EQUAL
              WRITE     HTMLFILE;ZERO;
            ELSE
              WRITE     HTMLFILE;ONE;
            ENDIF
          ENDIF
.                               
          GOTO      TMJR9999
.
TMJR1100  MOVE      ZERO,BJNLTOTL
.
          PACK      KEY35,TMJRNBAT,SP70
          CALL      RSTMJRN1
TMJR1150  CALL      RKTMJRN1
          BRANCH    OVRCD,TMJR1160
.
          MATCH     TMJRNBAT,TMJRBTCH
          GOTO      TMJR1160 IF NOT EQUAL
.
          ADD       TMJRAMNT,BJNLTOTL
.
          GOTO      TMJR1150
.
TMJR1160  MOVE      BJNLTOTL,DIM15
          LJUSTIFY  DIM15
          WRITE     HTMLFILE;DIM15;
          CALL      CLTMJR00
          GOTO      TMJR9999
.
TMJR1200  CALL      BJTAB000                              
          GOTO      TMJR9999
.
TMJR1300  PACK      KEY6,SP70
          CALL      RSIBGS1
TMJR1310  CALL      RKIBGS1
          BRANCH    OVRCD,TMJR9999
.
          MATCH     IBGSCODE,TMJRGSTC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      TMJR1310  
.
TMJR1400  MOVE      TMJRINVN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,TMJR9999
          WRITE     HTMLFILE;PINVAMT;
          GOTO      TMJR9999
.
TMJR1500  MOVE      TMJRINVN,FORM8
          MOVE      FORM8,PINVNO
          CALL      TPAY0000              * Get total payment
          WRITE     HTMLFILE;TOTPAID;
          GOTO      TMJR9999
.
TMJR1600  MOVE      TMJRINVN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,TMJR9999
          MOVE      ZERO,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;    * Total Journals
          GOTO      TMJR9999
.
TMJR1700  MOVE      TMJRINVN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,TMJR9999
          MOVE      PINVAMT,FORM12P2
.
          CALL      TPAY0000              * Get total payment
          ADD       TOTPAID,FORM12P2
.
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;
          GOTO      TMJR9999
.
.
TMJR1800  WRITE     HTMLFILE;BMCHTOTL;
          GOTO      TMJR9999
.
TMJR9999  RETURN
.
.------------------------------------------------------------------------------
.      get all receipts/payments
.------------------------------------------------------------------------------
TPAY0000 MOVE      ZERO,TOTPAID
         PACK      SAVKEY12,SP4,PINVNO,SP70  * set up invoice number
         PACK      KEY29,SAVKEY12,SP70
         CALL      RSRCDTE3
TPAY1000 CALL      RKRCDTE3
         BRANCH    OVRCD,TPAY9000
.
         MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
         GOTO      TPAY9000 IF NOT EQUAL
.
         PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,TPAY1000
         MATCH     "1",RCBNSTAT
         GOTO      TPAY1000 IF EQUAL       * Receipt cancelled
.
.        Check for Deposit register
.
         PACK      KEY3,RCDTREGI,SP70
         CALL      RDREGA1
         BRANCH    OVRCD,TPAY1000
.
         COMPARE   "2",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * Private Practice
         COMPARE   "96",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * PRI Deposit
.
         ADD       RCDTAMNT,TOTPAID
         GOTO      TPAY1000
.
TPAY9000 MULT      "-1",TOTPAID
TPAY9999 RETURN
+
.------------------------------------------------------------
. Bulk Journal Table
.------------------------------------------------------------
BJTAB000  MOVE      ZERO,BJNLTOTL
          MOVE      ZERO,BMCHTOTL
.
          MATCH     SP70,TMJRNBAT
          GOTO      BJTAB999 IF EQUAL
.
          PACK      KEY35,TMJRNBAT,SP70
          CALL      RSTMJRN1
BJTAB010  CALL      RKTMJRN1
          BRANCH    OVRCD,BJTAB999
.
          MATCH     TMJRNBAT,TMJRBTCH
          GOTO      BJTAB999 IF NOT EQUAL
.
          MOVE      SP70,DIM30
          PACK      KEY8,TMJRURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,DIM30
          ENDIF
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,TMJRJDAT
          IF        !@EQUAL
            REP       " 0",TMJRJDAT
            UNPACK    TMJRJDAT INTO CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      KEY5,ANSJ,SP1,TMJRJTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      TMJRJTYP,TDESC
          ENDIF
.
          MOVE      ZERO,FORM8
          MOVE      TMJRINVN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,BJTAB010
.
          MOVE      PINVAMT,FORM12P2
          CALL      TPAY0000              * Get total payment
          ADD       TOTPAID,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTINGSTJ,FORM12P2   * current outstanding amount
          ENDIF
.
          ADD       TMJRAMNT,BJNLTOTL
.
          CALL      BJROW000
          GOTO      BJTAB010
.
BJTAB999  RETURN
.------------------------------------------------------------
. Bulk Journal Table Row
.------------------------------------------------------------
BJROW000  WRITE     HTMLFILE;"<tr>":
                      "<td>&nbsp;<img src=../images/MaintenanceIcon.gif ":
                      "class=ListIcon onclick='updBulkJrnlChargesPopUpFrame(#"":
                             TMJRBTCH,"#",#"":
                             TMJRURNO,"#",#"":
                             TMJRVIST,"#",#"":
                             TMJRINVN,"#",#"":
                             TMJRJTYP,"#")'>":
                             TMJRURNO,"</td>":
                            "<td>&nbsp;",TMJRVIST,"</td>":
                            "<td>&nbsp;",FORM8,"</td>":
                            "<td>&nbsp;",DIM30,"</td>":
                            "<td>&nbsp;",DIM11,"</td>":
                            "<td>&nbsp;",TDESC,"</td>":
.                           "<td>&nbsp;",TMJRDESC,"</td>":
                            "<td align=right>&nbsp;",FORM12P2,"</td>";
.
.
          PACK      KEY5,CODEJ,TMJRJTYP
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      THCSCOD,JTYPE
            MATCH     "A",JTYPE
            IF        @EQUAL
              MULT      "-1",TMJRAMNT
            ENDIF
          ENDIF
.
          MOVE      TMJRAMNT,F12P2
          MULT      "-1",F12P2
          IF        TMJRAMNT<0
            WRITE    HTMLFILE;"<td align=right><font color=red>&nbsp;",F12P2:
                               "</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>&nbsp;",F12P2,"</td>";
          ENDIF
.
          SUB       TMJRAMNT,FORM12P2
.
          SUB       TMJRAMNT,BMCHTOTL           * Actual total journal
.
          WRITE     HTMLFILE;"<td align=right>&nbsp;",FORM12P2,"</td>":
                            "</tr>"
.
BJROW999  RETURN
.
.------------------------------------------------------------
. Add Bulk Journal
.------------------------------------------------------------
ADDBJR00  MOVE      ZERO,EXIT
.
          PACK      KEY8,TMJRN002,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,ADDBJR90
.
          MATCH     SP70,TMJRNBAT
          IF        @EQUAL
            MOVE      "118",PRXCODE   * System Lock Sector 118
            CALL      GETSLK00        * Get System Lock of Sector 118
            READ      CONTROLF,HUND18;*96,PTCNNJBN
            MOVE      PTCNNJBN,FORM8
            ADD       ONE,FORM8
            WRITAB    CONTROLF,HUND18;*96,FORM8
            CALL      RELSLK00        * Release System Lock of Sector 119
            SUB       ONE,FORM8
            MOVE      FORM8,TMJRBTCH         * got batch number
            MOVE      FORM8,TMJRNBAT
          ELSE
            MOVE      TMJRNBAT,TMJRBTCH
          ENDIF
.
          MOVE      TMJRN001,TMJRURNO
          MOVE      TMJRN002,TMJRVIST
          MOVE      TMJRN003,TMJRINVN
          MOVE      TMJRN004,TMJRJTYP
          MOVE      TMJRN005,TMJRJDAT
          MOVE      TMJRN006,TMJRDESC
          MOVE      TMJRN007,TMJRAMNT
          MOVE      TMJRN008,TMJRGSTC
          MOVE      SP70,TMJRSPAR
.
          PACK      KEY35,TMJRBTCH,TMJRURNO,TMJRVIST,TMJRINVN,TMJRJTYP,SP70
          CALL      RATMJRN1
          COMPARE   ONE,OVRCD
          GOTO      ADDBJR91 IF NOT EQUAL
.
          CALL      WRTMJRN1
.
          GOTO      ADDBJR99
.
ADDBJR90  CLEAR     WEBTITLE
          MOVE      "Visit Record not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBJR99
.
ADDBJR91  CLEAR     WEBTITLE
          MOVE      "Journal Record already exists for this invoice.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBJR99
.
ADDBJR99  RETURN
.
.------------------------------------------------------------
. Cancel Bulk Journal Batch
.------------------------------------------------------------
CANBJR00  PACK      KEY35,TMJRNBAT,SP70     * Cancel Batch
          CALL      RSTMJRN1
CANBJR10  CALL      RKTMJRN1
          BRANCH    OVRCD,CANBJR99
.
          MATCH     TMJRNBAT,TMJRBTCH
          GOTO      CANBJR99 IF NOT EQUAL
.
          PACK      KEY35,TMJRBTCH,TMJRURNO,TMJRVIST,TMJRINVN,TMJRJTYP,SP70
          CALL      DETMJRN1
          GOTO      CANBJR10
.
CANBJR99  RETURN
.
.------------------------------------------------------------
. Post Bulk Journal Batch to Patients
.------------------------------------------------------------
POSBJR00  PACK      KEY35,TMJRNBAT,SP70
          CALL      RSTMJRN1
POSBJR10  CALL      RKTMJRN1
          BRANCH    OVRCD,POSBJR99
.
          MATCH     TMJRNBAT,TMJRBTCH
          GOTO      POSBJR99 IF NOT EQUAL
.
          MOVE      TMJRURNO,URNUMBER           * U/R Number  
          MOVE      TMJRVIST,ADMISSNO           * Visit Number  
          MOVE      TMJRINVN,INVOICEN           * Invoice Number
          MOVE      TMJRJTYP,JOURITEM           * Type of Journal
          MOVE      TMJRJDAT,JOURDATE           * Journal date
          MOVE      TMJRDESC,JOURDESC           * Journal Descripti
          MOVE      TMJRAMNT,JOURPATT           * Journal Amount
          MOVE      TMJRGSTC,GSTCODES           * GST Code
.
          MOVE      ONE,BULKFLAG           * Bulk journal input set to Yes
          CALL      JNLUPD00               * Add Journal
.
          PACK      KEY35,TMJRBTCH,TMJRURNO,TMJRVIST,TMJRINVN,TMJRJTYP,SP70
          CALL      DETMJRN1
          GOTO      POSBJR10
.
POSBJR99  RETURN
.
.------------------------------------------------------------
. Clear TMPJRNFD file vars
.------------------------------------------------------------
CLTMJR00  MOVE      SP70,TMJRBTCH
          MOVE      SP70,TMJRURNO
          MOVE      SP70,TMJRVIST
          MOVE      SP70,TMJRINVN
          MOVE      SP70,TMJRJTYP
          MOVE      SP70,TMJRJDAT
          MOVE      SP70,TMJRDESC
          MOVE      ZERO,TMJRAMNT
          MOVE      SP70,TMJRGSTC
          MOVE      SP70,TMJRSPAR
.
CLTMJR99  RETURN
.--------------------------------------------------------------------------
. Get AMA/MBS Private Practice Item
.--------------------------------------------------------------------------
GAMMB000  PACK      SAVKEY22,PRITFLAG,PRITITMN,PRITSUBN,PRITDAT1,SP70
.
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD  * Last update date
          REP       " 0",KEY8
.
          PACK      KEY22,SP1,ZERO,KEY9,SP3,SP70
          CALL      RSPRIT1
          CALL      RKPRIT1
          BRANCH    OVRCD,GAMMB900
.
          COMPARE   ZERO,PRITFLAG
          GOTO      GAMMB900 IF NOT EQUAL
.
          MATCH     KEY9,PRITITMN
          GOTO      GAMMB900 IF NOT EQUAL
.
          MATCH     SP70,PRITSUBN
          GOTO      GAMMB900 IF NOT EQUAL
.
          MATCH     PRITDAT1,KEY8
          GOTO      GAMMB900 IF LESS
.
          MATCH     SP70,PRITDAT2
          IF        !@EQUAL
            MATCH     KEY8,PRITDAT2
            GOTO      GAMMB900 IF LESS
          ENDIF
.
          COMPARE   ZERO,PRITSFEE
          GOTO      GAMMB900 IF EQUAL
.
          MOVE      PRITSFEE,FORM12P2
.
GAMMB900  PACK      KEY22,SAVKEY22,SP70
          CALL      RDPRIT1
.
GAMMB999  RETURN
.
.------------------------------------------------------------
.      validate item
.------------------------------------------------------------
CHKPIT00  MOVE      ZERO,EXIT
          MOVE      SUBIT[CNTITEM],KEY3
          PACK      DIM2,SP1,ZERO
.
          MOVE      ZERO,FORM2
          PACK      KEY22,DIM2,MCHARGE,KEY3,Z70
          CALL      RSPRIT1                      * position after last record
.                                                  for this item
CHKPIT10  CALL      RPPRIT1                      * read previous record
          BRANCH    OVRCD,CHKPIT90               * end of file
.
          SQUEEZE   DIM2
          MOVE      DIM2,FORM2
          COMPARE   FORM2,PRITFLAG               * same item type ?
          GOTO      CHKPIT90 IF NOT EQUAL        * no
.
          MATCH     MCHARGE,PRITITMN             * same item number ?
          GOTO      CHKPIT90 IF NOT EQUAL        * no
.
          MATCH     SP70,KEY3
          IF        !@EQUAL
            MATCH     KEY3,PRITSUBN              * same subitem number ?
            GOTO      CHKPIT90 IF NOT EQUAL      * no
          ENDIF
.
          MATCH     PRITDAT1,MISCDATE            * item date > service date ?
          GOTO      CHKPIT10 IF LESS             * yes
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     MISCDATE,PRITDAT2
            GOTO      CHKPIT10 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
.
          MOVE      PRITSETC,SETCMGRP
          MOVE      PRITGSTA,PTMCGSTA
          MOVE      PRITGSTC,PTMCGSTC
.
          GOTO      CHKPIT99
.
CHKPIT90  PACK      WEBTITLE,INVICODE,MCHARGE
          CALL      WEBERR00
          MOVE      ONE,EXIT
CHKPIT99  RETURN
.
.-----------------------------------------------------------
. Write EDWARD emergency visit alteration record
.------------------------------------------------------------
WEDV0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDV9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDV9999 IF EQUAL
.
          MOVE      EMVIADMN,PMAWVISN
          MOVE      FOUR,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDV9999  RETURN
+
.----------------------------------------------------------------
. Set Parameters for Charge Requisitions Key
.----------------------------------------------------------------
SCRKY000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SCRKY999 IF EQUAL
          PACK      CHREQKEY[F3],QRYDATA,SP70
.
SCRKY999  RETURN
+
.----------------------------------------------------------------
. Set Parameters for Charge Requisitions Quantity
.----------------------------------------------------------------
SCRQA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SCRQA999 IF EQUAL
          MOVE      QRYDATA,CHREQQUA[F3]
.
SCRQA999  RETURN
+
.----------------------------------------------------------------
. Set Parameters for Charge Requisitions Charged
.----------------------------------------------------------------
SCRCH000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SCRCH999 IF EQUAL
          MOVE      QRYDATA,CHREQCHR[F3]
.
SCRCH999  RETURN
+
.----------------------------------------------------------------
. Update Requisitions if required                 
.----------------------------------------------------------------
UPDREQ00  MOVE      ONE,F3
          MOVE      ZERO,EXIT
.
UPDREQ10  MATCH     SP70,CHREQKEY[F3]
          GOTO      UPDREQ99 IF EQUAL
.
          UNPACK    CHREQKEY[F3],KEY36,DIM30
.
          PACK      KEY36,KEY36,SP70
          CALL      RDOPREQ1
          IF        OVRCD=0
            MOVE      CHREQQUA[F3],OPRQAMNT
            MATCH     "2",OPRQCHRG
            IF        !@EQUAL 
              MOVE      CHREQCHR[F3],OPRQCHRG
            ENDIF
.
            CALL      UPOPREQ1
          ENDIF
.
          ADD       ONE,F3
          GOTO      UPDREQ10
.
UPDREQ99  RETURN
+
.----------------------------------------------------------------
. Check Quantities for Theatre, Anaesthetic, Recovery Gases
.----------------------------------------------------------------
CHKGAS00  MATCH     SP70,MMSCGRP
          GOTO      CHKGAS99 IF EQUAL
          GOTO      CHKGAS99 IF EOS
.
          COMPARE   ONE,MULTNUM
          GOTO      CHKGAS99 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,MMSCGRP,SP70
          MOVE      "FI",CATEGORY
          MOVE      MMSCGRP,CODE
          CALL      GETCOD00
.
          MOVE      TCINDC10,DIM1
.
          REP       "A~T~R~",DIM1
          MATCH     "~",DIM1
          GOTO      CHKGAS50 IF EQUAL
.
          GOTO      CHKGAS99
.
CHKGAS50  MATCH     SP70,UNIQUEKY
          IF        @EQUAL | @EOS
.
            PACK      KEY31,XDAADMNO,SP70
            CALL      RSOPDEA2
CHKGAS52    CALL      RKOPDEA2
            BRANCH    OVRCD,CHKGAS55
.
            MATCH     XDAADMNO,OPDAADMN 
            GOTO      CHKGAS55 IF NOT EQUAL
.
            COMPARE   ZERO,OPDASTAT
            GOTO      CHKGAS52 IF EQUAL
.
            COMPARE   ONE,OPDASTAT
            GOTO      CHKGAS52 IF EQUAL
.
            COMPARE   THREE,OPDASTAT
            GOTO      CHKGAS52 IF EQUAL
.
            MOVE      OPDAUNIQ,UNIQUEKY
.
CHKGAS55    MATCH     SP70,UNIQUEKY
            GOTO      CHKGAS99 IF EQUAL
            GOTO      CHKGAS99 IF EOS
.
          ENDIF
.
          PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,CHKGAS99          
.
.
          MATCH     ANSA,TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS99
.
            MATCH     SP70,OPARANAS
            GOTO      CHKGAS99 IF EQUAL
.
            MATCH     SP70,OPARANAE
            GOTO      CHKGAS99 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARANAS,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARANAE,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",MULTNUM
            ELSE
              MOVE      CALCTIME,MULTNUM
            ENDIF
.
            GOTO      CHKGAS90
.
          ENDIF
.
.
          MATCH     ANST,TCINDC10
          IF        @EQUAL
            IF        CFEETYP=5
.
              PACK      KEY11,XDAADMNO,SP70
              CALL      RSNZSPR1
CHKGAS70      CALL      RKNZSPR1
              BRANCH    OVRCD,CHKGAS80
.
              MATCH     XDAADMNO,NZSPADMN
              GOTO      CHKGAS80 IF NOT EQUAL
.
              MATCH     MCHARGE,NZSPPROC
              GOTO      CHKGAS70 IF NOT EQUAL
.
              IF        NZSPTDUR>9999
                MOVE      "9999",MULTNUM
              ELSE 
                MOVE      NZSPTDUR,MULTNUM
              ENDIF
.
            ELSE
.
CHKGAS80      PACK      KEY11,UNIQUEKY,ONE,SP70
              CALL      RDOPSRG1
              BRANCH    OVRCD,CHKGAS99
.
              MATCH     SP70,OPSGTISS
              GOTO      CHKGAS99 IF EQUAL
.
              MATCH     SP70,OPSGTISE
              GOTO      CHKGAS99 IF EQUAL
.
.             Calculate new time/amount
.
              MOVE      OPDADATE,FIRSTDAT
              UNPACK    OPSGTISS,HOUR,D1,MIN
              PACK      FIRSTIME,HOUR,MIN
              REP       " 0",FIRSTDAT
              REP       " 0",FIRSTIME
.
              MOVE      OPDADATE,LASTDATE
              REP       " 0",LASTDATE
              UNPACK    OPSGTISE,HOUR,D1,MIN
              PACK      LASTTIME,HOUR,MIN
              REP       " 0",LASTTIME
              CALL      TIMEDIFF
              IF        CALCTIME>9999
                MOVE      "9999",MULTNUM
              ELSE
                MOVE      CALCTIME,MULTNUM
              ENDIF
.
            ENDIF
.
            GOTO      CHKGAS90
.
          ENDIF
.
.
          MATCH     ANSR,TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS90
.
            MATCH     SP70,OPARTIRD
            GOTO      CHKGAS90 IF EQUAL
.
            MATCH     SP70,OPARTETC
            GOTO      CHKGAS90 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARTIRD,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARTETC,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
.        
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",MULTNUM
            ELSE
              MOVE      CALCTIME,MULTNUM
            ENDIF
.
            GOTO      CHKGAS90
.
          ENDIF
.
CHKGAS90  IF        MULTNUM<1
            MOVE      ONE,MULTNUM
          ENDIF
.
CHKGAS99  RETURN
+
.----------------------------------------------------------------------------
. Read the relevant records for the patient and broadcast an HL7 update visit
. message (A08) - Based on "Send A08 when Invoice on Hold data is changed"
.----------------------------------------------------------------------------
BVISUP00  MATCH     "1",PTCNINVH
          GOTO      BVISUP99 IF NOT EQUAL        * sending A08?
.
          CALL      IBACLOCK                     * current date/time
.
.         Read the relevant records for the patient and
.         broadcast an HL7 update visit message (A08)
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RDDSCH1                      * check for discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.         Get the last transfer record
.
          PACK      KEY30,IPADMNO,TILDA35
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,BVISUP99               * eof - finish
.
          MATCH     IPADMNO,TADMN                * same admission still ?
          GOTO      BVISUP99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast change admission details
.
BVISUP99  RETURN
.
.
.         Check current status of hold invoice
.
HFIV0000  MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            PACK      KEY8,IPADMNO,SP70 
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 3",PENDSYST
.
          PACK      PENDSDAT,CCC,CYY,CMM,CDD
          REP       " 0",PENDSDAT
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND               * IP
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
.
HFIV9999  RETURN
.
+
.------------------------------------------------------------
. Set parameters for dkms - Distance Kms
.------------------------------------------------------------
STDKMS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDKMS99 IF EQUAL
            PACK      DSKMS[F3],QRYDATA,SP70
          ENDIF
STDKMS99  RETURN
+

          INC       TFILENAM
          INC       IBAWEBCD
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       PATIJRIO/INC
          INC       PATIPRIO/INC
          INC       PATILTIO/INC
          INC       PATFINIO/INC
          INC       NZPFINIO/INC
          INC       NZPFIGIO/INC
          INC       PATFLTIO/INC
          INC       PATJRNIO/INC
.
          INC       COMDEPIO/INC
          INC       EMRVISIO/INC
          INC       EMRVCDIO/INC
          INC       EMRHISIO/INC
          INC       OPRARDIO/INC
          INC       OPRSRGIO/INC
          INC       OPRDEAIO/INC
          INC       OPRREQIO/INC
          INC       APSMASIO/INC
          INC       AAEDE1IO/INC
          INC       AAEDI1IO/INC
          INC       AAEDTRIO/INC
          INC       AAEMCHIO/INC
          INC       OUTDTRIO/INC
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       IBAPOLIO/INC
.
          INC       NZPSPRIO/INC
          INC       NZPCMTIO/INC
          INC       PATDRGIO/INC
          INC       PATCTFIO/INC
          INC       PATALRIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATPR1IO/INC
          INC       PATDDHIO/INC
          INC       PMSCHAIO/INC
.
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPRFNIO/INC
          INC       PATMCHIO/INC
          INC       PATFACIO/INC
          INC       PATDETIO/INC
          INC       PATDGWIO/INC
          INC       PATCFAIO/INC
          INC       PATCMXIO/INC
          INC       PMSCIDIO/INC
          INC       PATDSCIO/INC
          INC       PATDO1IO/INC
          INC       PATDTRIO/INC
          INC       PATELGIO/INC
          INC       PATECHIO/INC
          INC       PATGTUIO/INC
          INC       PATHFRIO/INC
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC
          INC       PATFN1IO/INC
          INC       PATFIGIO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATONHIO/INC
          INC       PATITMIO/INC
          INC       PRIITMIO/INC
          INC       PATIRNIO/INC
          INC       PATLHIIO/INC
          INC       PATMA1IO/INC
          INC       PATCMTIO/INC
          INC       PMSADWIO/INC
          INC       PMSCMTIO/INC
          INC       PMSEVTIO/INC
          INC       PMSMTIIO/INC
          INC       TMPMTIIO/INC
          INC       TMPJRNIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSLHIIO/INC
          INC       PMSPX2IO/INC
          INC       PATRGMIO/INC
          INC       PMSREGIO/INC
          INC       PMSVX1IO/INC
          INC       PMSPTHIO/INC
          INC       PMSPTDIO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATNIDIO/INC
          INC       PATRE1IO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATTRNIO/INC
          INC       PATTFEIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PATUREIO/INC
          INC       PATSGCIO/INC
          INC       RESLNKIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       RCPREGIO/INC
          INC       RCPBDTIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       VISCMTIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PMSICMIO/INC
          INC       PATBFEIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATPGRIO/INC
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIDEIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
.
          INC       UPFAPPLN           * Update FA Completion date
          INC       PATDATYP
          INC       PATITMRD
          INC       PATIPRTM
          INC       CLEMRVIS
          INC       CHNADMTP
          INC       PATSTRYR
          INC       PATIPERH
          INC       CLPATINV
          INC       CLPATRE1
          INC       CLPMSVX1
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       PATCOMN3
          INC       PATMASTM
          INC       PATDEFCL                * routine DCLM0000
          INC       NZPSPRTM
          INC       CLPMSPX2
          INC       CLPATDSC
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       CALCAGE
          INC       PATCALFN
          INC       PATNAMCD
          INC       CMGETTHR
          INC       PMSOSDTM
          INC       CLPATDTR
          INC       PROSTRAK
          INC       CLPMSPTD
          INC       CHKCMXPT
          INC       CMXMATRX
          INC       NHOSPDAY
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       GETBFEES
          INC       GETTFEES
          INC       GETCNEFF
          INC       EMRDRCHR
          INC       CINVPEND
          INC       PATECHRD
.         
          INC       DAYOFWEK
          INC       WEBDATCD 
          INC       RSHWEBCD
          INC       GETEFDRG
          INC       DGCLICAC
          INC       PMIGTNID
          INC       PATDDHRD
.
