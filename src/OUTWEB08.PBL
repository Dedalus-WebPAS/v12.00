.------------------------------------------------------------------------------
. Program       : OUTWEB08
.
. Function      : Outpatients series bookings and lists
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.02 30/06/2025  Alina Bhari    TSK 0946439
.           Set Flag to cancel appointment and close referral-CREFFLAG,MAIN1600
.           -CLSPFM00
. V12.00.01 29/05/2025  Bella Turco     TSK 0955096
.           Alphanumeric changes
.           13/05/2025  Ebon Clements   TSK 0955096
.           Added alpanumeric visit number generation - REAP0000 - GENANVIS
. V11.05.04 20/03/2025  Davin          TSK 0956210
.           Recompiled for VALDIOPS (ICD10 Ed.13)
. V11.05.03 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.02 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.01 14/11/2024 Ebon Clements     TSK 0952662
.           Book all - Default tier 2 code from the clinic master if the slot
.           template is blank. bookalla.
. V11.04.05 08/11/2024 Ebon Clements     TSK 0952662
.           Added book all appointment cgi bookalla. This uses the tier 2 code
.           from each clinic for individual appointments
. V11.04.04 16/04/2024 PJ Le Febour      TSK 0906342a
.           added INC OUTCPCFD OPEN OUTCPCA1 Close OUTCPCA1 INC OUTCPCIO/INC
.           new tag OEXT3900 retrieve Client type Procedure Code and Desc
. V11.04.03 23/01/2024 Thanh T           TSK 0935901
.           Changed RHTB0000 to add reason for request column
. V11.04.02 16/01/2024 Nikitha B         TSK 0932069
.           Added ATAG3400 to Use Security level to restrict update of OP 
.           Appointment Request Comments 
. V11.04.01 09/01/2024 Thanh T           TSK 0936263
.           Added CLPMSQPX to clear pmsqpxaf table variables
. V11.03.02 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes 
. V11.03.01 04/07/2023 Nikitha B      TSK 0932738a
.           Added OEXT3800 tag to display OTMATCOD for Tier 2 code
. V11.02.06 19/05/2022 J.Tan           TSK 0837128
.           Recompiled for PRFAINSR - to use Cat CL indic 24
. V11.02.05 02/05/2022  Ebon Clements  TSK 0918114
.           Added cgi vars for contract code - contract mapped to outbb074
. V11.02.04 20/04/2022 J.Tan           TSK 0837128
.           Mod Default PRFA based on Claim type (PRFAINSR)
. V11.02.03 30/03/3022  Davin         TSK 0917793
.           Recompiled for VALDIOPS (ICD10 Ed.12)
. V11.02.02 09/02/2022 Thanh T         TSK 0905641
.           Added Additional HCP Code (1-4) for outbb1af      
. V11.02.01 07/02/2022  Thanh T        TSK 0896905
.           Recompiled for ALLDEPFD changes
. V11.01.03 06/08/2021  Ebon Clements  TSK 0905327
.           Fixed cancel future series bookings if master booking is
.           cancelled - SERF0000
. V11.01.02 13/07/2021  Ebon Clements  TSK 0907528
.           Addded linked referral expiry date tag - STAG3600
. V11.01.01 25/03/2021  Ebon Clements  TSK 0904373
.           CrossBrowser ViewIcon close tag - APRQSP00
. V11.00.10 12/01/2021  Ebon Clements  TSK 0901440
.           Fixed deposit file read comdepaf index 2 key size - KEY26
. V11.00.09 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.08 27/11/2020  Ebon Clements     TSK 0900461
.           Added id's to seribkeyXX, seribimXX and serisessXX
. V11.00.07 06/10/2020  Ebon Clements     TSK 0890602
.           Don't allow bookings into MOSAIQ clinics - MOSAIQCL
. V11.00.06 22/04/2020  Ebon Clements     TSK 0850105 
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.05 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.04 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.03 20/03/2020  Peter Vela     TSK 0889143
.           Fixed OUTLET IO calls
. V11.00.02 18/03/2020  Peter Vela     TSK 0889143
.           Recompiled for OUTLETFD
. V11.00.01 28/02/2020  Ebon Clements   TSK 0888944
.           Changed referring GP cgi to DIM 10 from DIM 8 - OUTBB029
. V10.15.03 20/02/2020  Peter Vela      TSK 0887845
.           Recompiled for NZHISWIO
. V10.15.02 17/12/2019  Thanh T          TSK 0885255
.           Changed GOTO RHTB1010 to GOTO RHTB2010 from RHTB2050 section
.           to prevent it goes to the wrong loop
. V10.15.01 23/10/2019  Ebon Clements    TSK 0308709
.           Recompiled for OUTBOATM - Clinic type linked visit types
.------------------------------------------------------------------------------
. V10.14.19 25/09/2019  J.Tan            TSK 0857392
.           Removed OUT002 as it is not used
. V10.14.18 12/09/2019  Ebon Clements    TSK 0878994
.           Also select appointment requests with a blank hospital when
.           site is not multi hospital - ATAG1700
. V10.14.17 09/09/2019  Richa Phogat     TSK 0881117
.           Updated OCMTLK00 by adding condition to check spaces for 'OTRCCOMM'
. V10.14.16 10/07/2019  Ebon Clements    TSK 0877824
.           Added VINAH audit trigger flags VINAHFLG, EPAUDFLG, RIAUDFLG and
.           VINAHREF to CLRPAR00
. V10.14.15 05/07/2019  Ebon Clements    TSK 0877657
.           Added missing RETURNS to ADEPDS00 and RDEPDS00
.           Added reqaptdp to NEXT0000 and PREV0000
. V10.14.14 01/07/2019  Thanh T.         TSK 0874693
.           Added WROTBC00 to write out outbokcf with booking number and
.           referral date for Series booking or multiple HCP series 
.           booking  
. V10.14.13 24/06/2019  Ebon Clements    TSK 0876926
.           Allow department on file to display if inactive - DEPA0000
.           Added department default from referral - ATAG2800
. V10.14.12 24/06/2019  Ebon Clements    TSK 0876902
.           Fixed appointment action list referral and suspended booking
.           department display - AHTB0000 SHTB0000
. V10.14.11 18/06/2019  Steve Armstrong  TSK 0874842
.           Mods to minimise the number of audit records written when calling
.           AMAS0000, FAPD0000 and VINAHDEF from WRTBOK00.
. V10.14.10 30/05/2019  Thanh T.        TSK 0872539
.           Recompiled for NZHISWIO changes
. V10.14.09 24/05/2019  Ebon Clements   TSK 0868837
.           Recompiled for VINAHDEF - Episode patient ready for care date clear
. V10.14.08 13/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to VINAHDEF.
. V10.14.07 29/03/2019  Thanh T.        TSK 0869558
.           Changed APRQSP00 for re-link appointment requests
. V10.14.06 28/03/2019  Thanh T.        TSK 0869558
.           Changed APRQSP00 for re-link appointment requests
. V10.14.05 06/03/2019  Thanh T.        TSK 0869558
.           Added APRQSP00,NXTARQ00,PRVARQ00 for appointment request supervisor
.           list
.           21/03/2019  Tracey Nguyen   TSK 0838668
.           Added CHARTREV for OUTBOATM
. V10.14.04 19/03/2019  Don Nguyen      TSK 0869412
.           Recompiled for VALDIOPS - Added ICD10 Ed.11 - Go-live Date check
. V10.14.03 28/02/2019  Ken Bell        TSK 0869548
.           Add OPEN accdiaaf, emricdaf because diagnosis are added to PATCLMTM
. V10.14.02 26/02/2019  Nicole Torrisi  TSK 0870838
.           Added DEPA0000 to output only Referrals Departments
. V10.14.01 12/02/2019  Nicole Torrisi  TSK 0869113
.           Added output of ALRERDAT to STAG3500
. V10.13.05 21/12/2018  Thanh T.        TSK 0867136
.           Added closeref field
. V10.13.04 15/10/2018  Thanh T         TSK 0859743
.           Added OEXT3500, OEXT3500 
. V10.13.03 17/09/2018  Davin           TSK 0862121
.           Don't broadcast HL7 A08 when writing new series booking (HL7TRGID=3)
. V10.13.02 30/07/2018  Ebon Clements   TSK 0815359
.           Don't display IP department in selection lists
. V10.13.01 30/07/2018  Don Nguyen      TSK 0847735
.           Added GETMHF00 - Output Mental Health Flag for the clinic session
. V10.12.05 26/06/2018  Jill Parkinson Task 0858803
.           Removed changes made in version 02 and 03 for filthosp
. V10.12.04 27/04/2018  Thanh Tieu     Task 0851975
.           Changed for triage status enhancement. Added codes to
.           output the triage status description TRGSDESC to show on various
.           templates.
. V10.12.03 10/04/2018  Nicole Torrisi  TSK 0851648
.           Changed to leave FILTHOSP blank when IBCNMHOS!=1
. V10.12.02 20/03/2018  Nicole Torrisi  TSK 0851648
.           Changed to always override FILTHOSP when IBCNMHOS!=1
. V10.12.01 05/03/2018  Ebon Clements   TSK 0846913
.           Populate original booking date/time in OUTCANFD and OUTRSHFD
. V10.11.11 18/12/2017  Ebon Clements   TSK 0846952
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.10 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.09 11/09/2017  Thanh T.        TSK 0821710
.           Recompiled for OUTBOATM
. V10.11.08 10/08/2017  Thanh T.        TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.07 30/07/2017  Thanh T.        TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM
.           04/08/2017  Ebon Clements   TSK 0843265
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.06 30/07/2017  Thanh T.        TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM
. V10.11.05 28/07/2017  Ebon Clements   TSK 0840698
.           Display reschduled/cancel appointment details in letter history
.           OHIS0000
. V10.11.04 21/07/2017  Ebon Clements   TSK
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.03 21/07/2107  Richa Phogat    TSK 0841016
.           Added priority condition check in RHTB0000 and fixed error displayed
.           due to two display fields missing in SHTB0000
. V10.11.02 21/07/2017  Ania P          TSK 0835148
.           Added OEXT3300
. V10.11.01 13/07/2107  Ebon Clements   TSK 0841129
.           Added PopUpFrame1 test to COOPAR00 & OUTPAR00 redirect
. V10.10.08 03/07/2017  Richa Phogat    TSK 0817112
.           Rollback changes done for task 0817112
. V10.10.07 20/06/2017  Richa Phogat    TSK 0817112
.           Added code to display Referred by Practice value (ALRERHCR) and
.           Referring Practice Count (ALRERHCT) in OEXT3300
. V10.10.06 23/05/2017  Ebon Clements  TSK 0828866
.           Recompiled for VINAHDEF - Date referral accepted
. V10.10.05 10/04/2017  Ebon Clements  TSK 0836214
.           Added before and after referral audit - FAPD0000
. V10.10.04 23/03/2017  Ebon Clements  TSK 0835266
.           Added keep alive and max date to of 01/01/9900 to 
.           series booking - ADAT0000
. V10.10.03 20/03/2017  Ebon Clements  TSK 0815831
.           Added unique comment id to appointment requests
. V10.10.02 20/03/2017  Richa Phogat   TSL 0828621
.           Added Dropdown button to filter records based on Location
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Recompiled for VALDIOPS (ICD10 Ed.10)
. V10.09.04 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.09.03 14/12/2016  Ebon Clements  TSK 0828925
.           Changed letter history to show appointment details from
.           time of printing - OHIS0000
. V10.09.02 07/12/2016  Peter Vela     TSK 0828210
.           Added Referral Date to RHTB0000
.           Added Reason to RHTB0000 AHTB0000
.           Added Must Be Seen By Date to RHTB0000 AHTB0000
. V10.09.01 02/12/2016  Jill Parkinson TSK 0822329
.           Added ACC Purchase order number and write pmswx1af
. V10.08.07 18/11/2016  Peter Vela     TSK 0827671
.           Added single space after Parent of <Initial>.
.           before write to patre1af
. V10.08.06 17/11/2016  Ebon Clements  TSK 0826404
.           Fixed appointment request priority display - RHTB4000
. V10.08.05 14/10/2016  Ebon Clements  TSK 0817582
.           Recompiled for VINAHDEF - Notified of first appointment default
. V10.08.04 05/10/2016  Ebon Clements  TSK 0304330
.           Added Health fund/table to OP booking functionality
. V10.08.03 10/08/2016  Ebon Clements  TSK 0813331
.           Added zero visit number error to REAP9040
. V10.08.02 08/06/2016  Don Nguyen     TSK 0323386
.           Modified Hospital Level routines (RHTB0000, AHTB0000, SHTB0000) 
.           and Patient Level routines (PRHT0000, PAHT0000, PSHT0000) to output
.           Presenting Complaint data.
.           Added PTCOLUMN for Presenting Complaint display flag.
. V10.08.01 14/04/2016  Peter Vela     TSK 0814969
.           Added loop counts for RHTB0000, AHTB0000, SHTB0000
.           Added switch to display all departments in RHTB0000 AHTB0000
. V10.07.06 17/03/2016  Peter Vela     CAR 0814969
.           Added all clinic types indicator for Appointment Action List
. V10.07.05 31/12/2015  Peter Vela     CAR 0323185
.           Changed OTARRDEP to read from category CG in RTAB1000
. V10.07.04 04/12/2015  Peter Vela     CAR 324343
.           Added multihospital validation in ACTN7000
. V10.07.03 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
. V10.07.02 26/10/2015  Ebon Clements  CAR 268970
.           Recompiled for OUTWMPFD index changes - GETMAP00
. V10.07.01 14/10/2015  Ebon Clements  CAR 316629
.           Added hospital to holiday file key  - OUTPHOFD
. V10.06.16 26/08/2015  Jill Parkinson CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.15 25/08/2015  Jill Parkinson CAR 320905
.           Recompiled for changes to NZHISWIO
. V10.06.14 14/08/2015  Ebon Clements  CAR 316109
.           Added non vinah referral test to create program button display
. V10.06.13 11/08/2015  Peter Vela     CAR 319532
.           Recompiled for OUTBOATM - Added slot template location to APPTAB00
. V10.06.12 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.11 31/07/2015  Ebon Clements  CAR 316109
.           Added create program button to referral action list -  AHTB0000
. V10.06.10 01/07/2015  Don Nguyen     CAR 317693
.           Recompiled for VALDIOPS - Removed Area checks '3' & '4' in VOPCD200
. V10.06.09 01/07/2015  Ebon Clements     CAR 318730
.           Added series booking date time sort key seribsrt to SMULTB20
. V10.06.08 10/06/2015  Steve Armstrong   CAR 313856
.           Mods to use CLVISINT & CLVISIAU instead of internal
.           clear routines
.           15/05/2015  Ebon Clements     CAR 315791
.           Don't write alllnkaf records if no referral number - WRTBOK00
. V10.06.07 15/05/2015  Ebon Clements     CAR 303890
.           Added visit base procedure and problem functionality
. V10.06.06 12/05/2015  Ebon Clements  CAR 303890
.           Added ALLPROFD and open
. V10.06.05 07/05/2015  Ebon Clements  CAR 316355
.           Added default disaster from referral functionality
. V10.06.04 30/04/2015  Don Nguyen     CAR 314266
.           Recompiled for OUTBOATM - Modified OBOA3300 with test on indicator 1
. V10.06.03 31/03/2015 Peter Vela     CAR 298921
.           Changed OUTBB031 to DIM 10
. V10.06.02 17/03/2015  Davin         CAR 311669
.           Recompiled for VALDIOPS (ICD10 Ed.9)
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.------------------------------------------------------------------------------
. V10.05.14 24/02/2015  Don Nguyen     CAR 303885
.           Recompiled for OUTBOATM - Modified APPTAB00 to output PTHSNAME.
. V10.05.13 20/02/2015  Peter Vela     CAR 310124
.           Added read forward if clinic id not found in RHTB0000, SHTB0000
. V10.05.12 08/12/2014  Ebon Clements  CAR 305618
.           Added VINAHDEF - Default VINAH field functionality
. V10.05.11 26/11/2014  Ebon Clements  CAR 304549
.           Restored lost functionality after re write of RHTB0000. Include
.           pending reschedule records with requsted. Fixed preferred date loop
. V10.05.10 14/11/2014  Ebon Clements     CAR 292656
.           Added link cancelled OP visit to a referral functionality
. V10.05.09 16/10/2014  Ebon Clements     CAR 291413
.           Write record for polling server for AH referral expiry
.           date recalulation on attendance - POLX0000
. V10.05.08 06/10/2014  Ebon Clements     CAR 268970
.           Removed OUTCLIFD index 4 open as it was not used
. V10.05.07 04/09/2014  Jill Parkinson CAR 304422
.           Added read forward if clinic id not found in PAHT0000
. V10.05.06 11/09/2014  Don Nguyen     CAR 302792
.           Recompiled for changes to VALDIOPS
.           10/09/2014  J.Tan             CAR 274958
.           Added Employer code to pmswx1af file
. V10.05.05 03/09/2014  Ania P         CAR 304549
.           Replaced old RHTB0000 to RHTB3000 with clean code using new index 4
. V10.05.04 26/08/2014  Jill Parkinson CAR 304422
.           Added read forward if clinic id not found in AHTB0000
. V10.05.03 18/08/2014  Ania P         CAR 303879
.           Added OTBBPURC
.           13/08/2014  Peter Vela     CAR 304860
.           Recompiled for PMSVX1TM
. V10.05.02 29/07/2014  Ebon Clements  CAR 251384
.           Fixed save of tier 2 code 
. V10.05.01 16/07/2014  Ebon Clements  CAR 251384
.           Added tier 2 code functionality
. V10.04.07 02/07/2014  Ebon Clements  CAR 289315
.           Re read the correct referral record before leaving the auto
.           activate master referral function - AMAS0000
. V10.04.06 09/05/2014  Don Nguyen     CAR 300097
.           Recompiled for NHIMASTM - Fixed SETMWD00 to clear date values
. V10.04.05 06.05.2014  Ania P         CAR 208234
.           Added STAG3200
. V10.04.04 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 24/03/2014 Ebon Clements      CAR 299036
.           Fixed display of referral date on appointment request list PRHT0000
.           21/03/2014  Steve Armstrong   CAR 298483
.           Recompiled for changes to DGCLICOB, DGCLICON & DGCLICOC
. V10.04.01 06/02/2013  Peter Vela       CAR 295606
.           Added ALCNDAMR to AMAS0000
.------------------------------------------------------------------------------
. V10.03.43 11/12/2013  Ebon Clements  CAR 293092
.           Added notified and confirmed to interpreter audit
. V10.03.42 21/11/2013  Ebon Clements  CAR 292602
.           Added waitflag cgi
. V10.03.41 14/10/2013  Ania P         CAR 278232
.           Refactored code - now using COUNTSLT for session recalculation
. V10.03.40 14/10/2013  Ania P         CAR 278232
.           Removed all recalculation code ADDTIM/SUBTIM/CALTIM and 
.           inserted new consolidated include file.
. V10.03.39 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.38 02/10/2013  Peter Vela     CAR 291757
.           Recompiled for ALLREFTM
. V10.03.37 26/09/2013  Jill Parkinson CAR 291691
.           Recompiled for NZHISWIO - over 15 medical warnings looping
. V10.03.36 30/08/2013  Don Nguyen       CAR 273426
.           Recompiled for changes to CLALLREF
.           27/08/2013  Ebon Clements    CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.35 30/06/2013  Davin            CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.34 18/07/2013  Jill Parkinson CAR 288525
.           Recompiled for NZHISWIO
. V10.03.33 30/06/2013  Davin            CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.32 24/05/2013  Peter Vela       CAR 261630
.           Removed port number from temp file name
. V10.03.31 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.30 01/05/2013  Peter Vela    CAR 284276
.           Added read to index 2 of outartaf @ RHTB0000
. V10.03.29 23/04/2013  Davin         CAR 284420
.           Recompiled for VALDIOPS (ICD10 Ed.8)
. V10.03.28 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.27 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.26 01/03/2013  Ebon Clements    CAR 277862
.           Added mandatory referral functionality
. V10.03.25 19/02/2013  Peter Vela       CAR 262297
.           Fixed Patient Instructions for SERIFLAG=2 @ WRTBOK00
. V10.03.24 23/01/2013  Ebon Clements    CAR 262292
.           Recompiled for PMSVX1TM - Interpreter tag
. V10.03.23 29/11/2012  Peter Vela       CAR 262297
.           Recompiled for VISCMTFD
.           Added Patient Instructions
. V10.03.22 21/11/2012  Peter Vela       CAR 276423
.           Recompiled for OUTARTTM
. V10.03.21 09/10/2012  Davin            CAR 271432
.           Don't send letter for past appointments (chrt0000)
. V10.03.20 31/08/2012  Peter Vela       CAR 266428
.           Added VSINCHON before write to visintaf
. V10.03.19 10/08/2012 J.Tan               CAR 269432
.           Mods to check for 'Parent of' option for PRFA
. V10.03.18 31/07/2012  Peter Vela       CAR 266428
.           Added INTDEL00 to INTUPD00
. V10.03.17 22/06/2012  Peter Vela       CAR 267290
.           Added RAVSCMT1 reads before WRVSCMT1 to fix I * D
. V10.03.16 16/05/2012  Steve Armstrong  CAR 256322
.           Recompiled for changes to NZHISWIO.
. V10.03.15 01.05.2012  Ebon Clements     CAR 264510
.           Fixed P * K on outbokaf in series booking lists SERTAB00 & SERBOK00
. V10.03.14 26.04.2012  Ebon Clements     CAR 261277
.           Populate first appointment booked on SOP int referral - FAPD0000
. V10.03.13 12.04.2012  Ebon Clements     CAR 261277
.           Auto activate master referral if internal is activated  - AMAS0000
. V10.03.12 16/03/2012  Ebon Clements   CAR 261794
.           Fixed display of requested by on action list - RTAB0000
. V10.03.11 06/03/2012  Peter McMullen  CAR 2569587
.           Remove reference to file patyear1
. V10.03.10 17/02/2012  Ebon Clements   CAR 256039
.           Set letter date to current if calculated less than today - CHRT0000
. V10.03.09 17/01/2012  Ebon Clements   CAR 255521
.           Added visit extn file tags to report 8
. V10.03.08 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.07 12/01/2012  Ebon Clements    CAR 244332
.           Added population of visit extn file aboriginality
. V10.03.06 04/01/2011  Ebon Clements   CAR 253762
.           Don't save OPD actions for hospital based OPD users
. V10.03.05 09/12/2011  Ebon Clements   CAR 246872
.           Populate new fields in OUTCANFD
. V10.03.04 01/12/2011  Ebon Clements   CAR 256004
.           Default ref claim detail to OP if booked from a referral - RCLM0000
. V10.03.03 25/11/2011  Ebon Clements   CAR 255521
.           Added read of visit extn for new appointment defaults - NEWBOK00
. V10.03.02 17/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
. V10.03.01 15/11/2011  Ebon Clements    CAR 250001 
.           Added search button to appointment action list 
. V10.02.19 28/10/2011  Ebon Clements    CAR 253837 
.           Added end of search results line to SRCH0000 and SHWM0000
. V10.02.18 25/10/2011  Ebon Clements    CAR 248740 
.           Added linked ref department filter to suspended appt list - SHTB0000
. V10.02.17 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.16 30/09/2011 Ebon Clements   CAR 252283
.           Recompiled for OUTARTTM - Create by tag
. V10.02.15 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.14 12/09/2011  Ebon Clements     CAR 248740
.           Fixed department and hospital filter in appointment action list
. V10.02.13 08/09/2011  Peter Vela        CAR 249984
.           Mods to delete disptlaf dispataf and alternate id records when
.           cancelling outpatient
. V10.02.12 07/09/2011  Peter Vela        CAR 249285
.           Added Disaster functionality
. V10.02.11 01/09/2011  Ebon Clements     CAR 242014
.           Added outpatient direct functionality
. V10.02.10 12/07/2011  Peter McMullen CAR 248483 
.           Recompile for OUTARTTM  
. V10.02.09 26/07/2011  Ebon Clements     CAR 242246
.           Added OUTBB068 to OUTBB071
. V10.02.08 15/07/2011  Ebon Clements     CAR 242246
.           Added NMDS, care type, service delivery and clinic risk - OEXT0000
. V10.02.07 13/07/2011  Ebon Clements     CAR 242246
.           Added hospital output to series booking list - SERTAB00
.           13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.06 22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PATGSRFD:
.                - GSRSNAM & GSRGNAM extended to 30 chars.
.                - PTGSGNM2 added.
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
. V10.02.05 02/06/2011  Ebon Clements    CAR 239551
.           Added triage referral functionality
. V10.02.04 27/05/2011  Ebon Clements  CAR 239554
.           Added generate letter date functionality
. V10.02.03 24/05/2011  Ebon Clements     CAR 240720
.           Fixed status link HTMLLNK2 on appointment action list
. V10.02.02 06/05/2011  Ebon Clements     CAR 240720
.           Added report 8 - Outpatient appointment action list
. V10.02.01 21/03/2011  Jill Parkinson    CAR 239574
.           Increased SCHDPRNT
. V10.01.01 17/11/2010  Jill Parkinson    CAR 233088
.           Increased PTMAS038 from 10 to 19
. V10.00.08 15/10/2010  Peter Vela        CAR 227556
.           Added OEXT2000 and OEXT21000
. V10.00.07 17/09/2010  Ebon Clements     CAR 230239
.           Re-Compiled for MRTVISCD - Home Location and Document type test
. V10.00.06 08/06/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.05 03/06/2010  Ebon Clements  CAR 208220
.           Recompiled for OUTBOATM -  Added comment icon link to APPTSU00
. V10.00.04 21/05/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.03 20/05/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.00.02 27/04/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.08  02/02/2010  Steve Armstrong   CAR 135505
.           Added DGCLII13 trigger
.           24/02/2010  Ebon Clements  CAR 207040
.           Added manage health fund program functionality
. V9.12.07  21/01/2010  Ebon Clements  CAR 214121
.           Added OTCNINTR - Using visit based interpreter required
. V9.12.06  17/12/2009  Peter McMullen CAR 210130
.           Concert to newer Dr name format routine DOCNM000
. V9.12.05  30/11/2009  WeeLee Koo     CAR 210459
.           Added new tag to track interpreter required (OEXT1900)
. V9.12.04  03/08/2009  Peter Vela     CAR 202829
.           Added functionality for OTCNREVC - Visit Type when OTCNCrEV is set
.           to Yes
. V9.12.03  08/07/2009  Ebon Clements  CAR 200816
.           Fixed claim default as bookings don't have a visit record - LCLM0000
. V9.12.02  18/06/2009  Ebon Clements  CAR 196539
.           Allow update of bookings if they are before the deceased date
. V9.12.01  11/06/2009  Ebon Clements     CAR 198280
.           Fixed incorrect spelling of redirectParentFrame
. V9.11.04  07/04/2008  Peter Vela        CAR 183976
.           Moved spaces to PMVXPILC before WRPMVX11
. V9.11.03  17/02/2009  Peter Vela        CAR 183976
.           Moved spaces to PMVXPOEC before WRPMVX11
. V9.11.02  30/01/2009  Ebon Clements     CAR 173227
.           Changed SERF0000 to cancel future bookings by booking date/time
. V9.11.01  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.03  26/08/2008  Mike Laming       CAR 176293
.           Recompiled for VALDIOPS - correct "Posting Code" test
. V9.10.02  31/07/2008  Ebon Clements  CAR 171540
.           Fixed open of ALLAUDLN
. V9.10.01  05/05/2008  J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.09.08  12/02/2008  J.Tan          CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.07  15/01/2007  Ebon Clements  CAR 146279
.           Added new tag for SRCHDATF
. V9.09.06  09/01/2008  Ebon Clements  CAR 150795
.           Added cancel all future booking option to series booking
. V9.09.05  04/01/2008  J.Tan          CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.04  15/11/2007  Peter McMullen CAR 145200
.           Filter clinics on Multiple HCP bookings
. V9.09.03  13/09/2007  Ebon Clements CAR 100599
.           Recompiled for VALDIOPS - Added OUTPFLAG
. V9.09.02  10/08/2007  Steve Armstrong   CAR 145650
.           Added call to DGCLICOB when ACC (patwc1af) record is created.
. V9.09.01  03/07/2007  Ebon Clements  CAR 143552
.           Recompiled for OUTRFLTM - Referring gp on referral list display
.------------------------------------------------------------------------------
. V9.08.08  08/06/2007  Ebon Clements  CAR 142612
.           Added NORECCNT to SETPAR00
. V9.08.07  10/04/2007  Jill Habasque  CAR 138027
.           Added NORECCNT to allow over 100 search limit
. V9.08.06  01/03/2007  Janet George   CAR 120378
.           Added Series Booking Functionality to AH
. V9.08.05  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.04  23/01/2007  Mike Laming   CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.03  14/11/2006  Peter Vela     CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.02  20/10/2006  Ebon Clements  CAR 122116
.           Added open of referral audit file
. V9.08.01  19/10/2006  Ebon Clements  CAR 119559
.           Recompiled for PATCODTM - Include/Exclude cat codes with indicator
.------------------------------------------------------------------------------
. V9.07.05  06/09/2006  Steve Armstrong    CAR 108060
.           Added calls to PMIGTNID prior to all DGCLI* routines so that
.           the nhi variables are set.
. V9.07.04  18/08/2006  Ebon Clements      CAR 110245
.           Delete trasnport details when cancelling appointments
. V9.07.03  24/07/2006  Ebon Clements CAR 99899 
.           Fixed save of series booking extra screen details
. V9.07.02  17/07/2006  Peter Vela    CAR 112753
.           Recompiled for VALDIOPS
. V9.07.01  12/07/2006  Ebon Clements     CAR 103365
.           Added adm expected payor functionality 
.------------------------------------------------------------------------------
. V9.06.03  17/05/2006  Ebon Clements CAR 105541
.           Added multi hospital test to VTYSEL00
. V9.06.02  17/05/2006  Mike Laming      CAR 101974
.           Recompiled for ICD10 Ed.5 changes to VALDIOPS
. V9.06.01  08/05/2006  Steve Armstrong  CAR 103759
.           Recompiled for changes to DGCLICON & OUTQUEFD
.------------------------------------------------------------------------------
. V9.05.03  03/04/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.02  23/03/2006  Ebon Clements CAR 79277
.           Added OUTBB065 - Send correspondence to carer 
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B07 03/03/2006  Steve Armstrong   CAR 88829
.            Recompiled for changes to OUTQUEFD
. V9.05.B06 20/02/2006  Ebon Clements     CAR 76341
.            Added referral and encounter file audit 
. V9.05.B05 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B04 11/01/2006  Peter Vela    CAR 89639
.           Recompiled for OUTRFLTM - Removed single quotes from OTRLDIAG
. V9.05.B03 10/01/2006  Ebon Clements CAR 76341
.           Added search for next session in SRCH0000
. V9.05.B02 09/01/2006  Ebon Clements CAR 76341
.           Added search by care team to series booking searches
. V9.05.B01 21/12/2005  Ebon Clements CAR 76341
.           Added book all functionality to multiple HCP series bookings
.------------------------------------------------------------------------------
. V9.04.07  14/10/2005  Ebon Clements CAR 59229
.           Changed RCAL0000 to use slot duration OTHEDURN not OMADURN
. V9.04.06  23/05/2005  Ebon Clements    CAR 62018
.           Recompiled from OUTBITFD - Added provider usage
. V9.04.05  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.04  10/02/2005  Mike Laming              CAR 48413
.           Add Cancellation Comments free text field using "viscmtaf"
. V9.04.03  11/01/2005  Ebon Clements CAR 56397
.           Added cancelled to referral letter filter status
. V9.04.02  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for ADDVIS00 - medical record link
.           08/09/2004  Henry son                CAR 52585
.           Add Indeterminate to Sex check.
. V9.04.01  30/08/2004  Ebon Clements            CAR 52930
.           Populate visit extn file hospital code when creating bookings
.------------------------------------------------------------------------------
. V9.03.17  29/07/2004  Ebon Clements        CAR 19975
.           Added REVD0000 update waiting list review date
. V9.03.16  23/06/2004  Henry Son                CAR 49037
.           ICD10 Ed.4 Changes. Re-compile VALDIOPS.
. V9.03.15  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.14  07/06/2004 Ebon Clements  CAR 50493
.           Changed icon display to align=left for series booking search
.           04/04/2004 Ebon Clements  CAR 50427
.           Added shwprint cgi to series booking redirect
. V9.03.13  11/05/2004 Ebon Clements  CAR 49613
.           Added SRCHCLID code and description tag - STAG2800
. V9.03.12  10/02/2004 Ebon Clements 
.           Fixed comments save for series bookings
. V9.03.11  23/12/2003 Sylvek Litewka CAR 45685
.           VIC DHS 2003 changes - recompiled for VALDIOPS.PBL changes.
.           15/12/2003 Ebon Clements  CAR 45551
.           Change a referral letter back to unbooked when an appointment
.           is cancelled
.           15/12/2003 Ebon Clements  CAR 45481
.           Mods for PMSCURFD file change - added outpatient site
.           09/12/2003 Sylvek Litewka CAR 20222
.           Modified procedure DISCOD00 to use Booking Date and RDPTICD1 IO
.           routine to access ICD Disease file.
. V9.03.10  04/12/2003 Ebon Clements  CAR 44091
.           Changed the cancel booking deposit error to user the new rcp files
. V9.03.09  12/11/2003 Ebon Clements  CAR 44091
.           Added an error if you try to cancel a booking with a deposit
. V9.03.08  07/11/2003 Ebon Clements  CAR 43484
.           Added PATCMNFD patient comments cgi variable and update functions
. V9.03.07  22/10/2003  J.Tan    CAR 44172
.           Mods for Misc.theatre item file(pmsmitaf)
. V9.03.06  17/10/2003 Ebon Clements  CAR 44425
.           Changed SAVAIL00 to show reserved slots.
.           Added reopen of COMFILAF in XWPCOM90 to reset the file position
. V9.03.05  10/10/2003 Ebon Clements  CAR 44206
.           Fixed output of series booking available appointments
. V9.03.04  30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
. V9.03.03  29/09/2003 Ebon Clements CAR 22361
.           Added reads of outhedaf to display the correct session setup details
. V9.03.02  22/09/2003  Ebon Clements            CAR 43398 & 43552
.           Fixed series bookings and multiple HCP booking bugs
. V9.03.01  23/07/2003  Ebon Clements            CAR 41801
.           Created server from OUTWEB02
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
.
          INC       ACCDIAFD/INC
          INC       ALLAEFFD/INC
          INC       ALLCONFD/INC
          INC       ALLDEPFD/INC
          INC       ALLERCFD/INC
          INC       ALLRLNFD/INC
          INC       ALLQUEFD/INC
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       EMRICDFD/INC
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       IBAPOSFD/INC
          INC       NZHISIFD/INC
          INC       NHIDCDFD/INC
          INC       NHIDMCFD/INC
          INC       NHIDNRFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       NHIMCCFD/INC
          INC       NHIRELFD/INC
          INC       PATALRFD/INC
          INC       PATGSRFD/INC
          INC       TMPALIFD/INC
.
          INC       OUTARTFD/INC        * Appointment Action
          INC       OUTARTTD/INC
          INC       OUTBOAFD/INC        * Bookings file A
          INC       OUTBB1FD/INC        * Bookings file B
          INC       OUTBOCFD/INC        * Bookings file C
          INC       OUTXSCFD/INC        * Extension File 
          INC       OUTXSCTD/INC        * Extension File - CGI parameters
          INC       OUTXWPFD/INC        * Extension File Comments
          INC       OUTCLIFD/INC        * Clinic Ids
          INC       OUTCONFD/INC        * Outpatient System Parameters
          INC       OUTCANFD/INC        * Outpatient System Parameters
          INC       OUTCTYFD/INC        * Clinic Types
          INC       OUTCVTFD/INC   * Outpatients - Clinic Type Visit Types
          INC       OUTDANFD/INC        * OP direct actions
          INC       OUTDANTD/INC
          INC       OUTDCOFD/INC        * OP direct comments
          INC       OUTDIAFD/INC        * Clinic Types
          INC       OUTDTRFD/INC        * DTR
          INC       OUTHISFD/INC        * Clinic Types
          INC       OUTLETFD/INC        * Letters
          INC       OUTLHIFD/INC        * Letter History
          INC       OUTLPCFD/INC        * Clinic Types
          INC       OUTMA1FD/INC        * Session Master file
          INC       OUTMABFD/INC        * Session Master file
          INC       OUTMSPFD/INC        * Session Master file
          INC       OUTPRCFD/INC        * Outpatient problems and procedures
          INC       OUTPRCTD/INC
          INC       OUTPREFD/INC        * Outpatient Pre-attendance file
          INC       OUTRAPFD/INC        * Clinic Open Sessions file
          INC       OUTRCMFD/INC        * Appointment Request Comments
          INC       OUTSESFD/INC        * Clinic Open Sessions file
          INC       OUTSITFD/INC        * Site file
          INC       OUTRF1FD/INC        * Referral List
          INC       OUTRSHFD/INC        * Referral List
          INC       OUTWMPFD/INC        * Template Mapping
          INC       BOKRC1FD/INC
          INC       OUTTXSFD/INC        * Outpatients Extra Templates file - FD
          INC       OUTTXSTD/INC        * Outpatients Extra Templates file - TD
          INC       OUTSIPFD/INC        * Outpat Site Specific Categories - FD
          INC       OUTSIPTD/INC        * Outpat Site Specific Categories - TD
          INC       OUTLKBTD/INC        * Outpat Linked bookings table         
          INC       OUTLKBFD/INC        * Outpat Linked bookings table         
          INC       OUTPHOFD/INC        * Outpat public holiday file           
          INC       OUTBITFD/INC        * Booking items
          INC       OUTCCTFD/INC
.
          INC       APSMASFD/INC
          INC       PATCOMM/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATFN1FD/INC
          INC       PATIPEFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSQPTFD/INC
          INC       PMSTSPFD/INC
          INC       PATIN1FD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PMSAIDFD/INC
          INC       PMSEXTFD/INC
          INC       PATNIPFD/INC
          INC       PATPR1FD/INC
          INC       PATVISFD/INC
          INC       PATRE1FD/INC
          INC       PATWR1FD/INC
          INC       PATCALAG/INC
          INC       RESLNKFD/INC
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       MRTCONFD/INC
          INC       SCRMASFD/INC
          INC       IBALPCFD/INC            *** HPS Code Starts Here *** 
          INC       PMSPX2FD/INC            
          INC       PMSPX2TD/INC
          INC       PMSPAYFD/INC
          INC       VISINTFD/INC           
          INC       VISIAUFD/INC          
          INC       VISCMTFD/INC            * Text comments file       *I-48413
          INC       OUTCMNFD/INC         
          INC       PMSVX1FD/INC            * Visit Extension Table        
          INC       PMSCURFD/INC            * Current Patient Table        
          INC       PMSVX1TD/INC
          INC       OUTSRVFD/INC            *** HPS Code Ends Here ***
          INC       PATCANFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       EOCLNKFD/INC
.
          INC       PATWC1FD/INC
          INC       PATWVEFD/INC
          INC       PATWMAFD/INC
          INC       PATEORFD/INC
          INC       PMSCCDFD/INC            * Concession Card Details
          INC       PMSCTCFD/INC
          INC       PMSWX1FD/INC
          INC       PMSMTIFD/INC
          INC       PMSUPGFD/INC
          INC       PMSUPOFD/INC
          INC       PMSHPGFD/INC
          INC       PMSHPOFD/INC
          INC       PATECDFD/INC
. 
          INC       CCICONFD/INC
          INC       CCIEX7FD/INC
          INC       OUTCPBFD/INC
          INC       OUTHEDFD/INC            * Outpatient header template file
          INC       OUTCPCFD/INC   
.
          INC       COMDEPFD/INC        * Receipting deposit details
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       WATMESFD/INC
          INC       PATHSPFD/INC
          INC       MRTLOCFD/INC
          INC       HICBCNFD/INC
          INC       HICCLMFD/INC
          INC       HICCITFD/INC
.
          INC       ALLREFFD/INC
          INC       ALLREFTD/INC
          INC       ALLRITFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLPCTFD/INC
          INC       ALLDIAFD/INC
          INC       ALLCASFD/INC
          INC       ALLCTMFD/INC
          INC       ALLLNKFD/INC
          INC       ALLSTSFD/INC
          INC       ALLENCFD/INC
.
          INC       PRIITMFD/INC
          INC       PRITHDFD/INC
          INC       VISPAYFD/INC
          INC       TFILEVAR/INC
.
ACCPORDN  DIM       20
ACTNDATE  DIM       8
ADDNEWPG  FORM      1          * Add new health fund program to patient
ALLFLAG   FORM      1
CANCELRQ  DIM       1
CATTZ     INIT      "Tz"
CATZG     INIT      "zG"
CHECKDAT  DIM       1
CHECKREF  DIM       8                       * Auto activate internal referral
CHECKSIT  DIM       6
CHILDBOK  DIM       8
CHKGRPIN  FORM      1
CISMFLAG  FORM      1
CTYPDESC  DIM       30
CURRDATE  DIM       8
DATEPREF  FORM      1
DIACODES  DIM       6[10]
DIM13A    DIM       13
DIM13B    DIM       13
DISPDAT1  DIM       11
SEARCHFL  FORM      1
SENDLETT  DIM       1
SHOWFLAG  FORM      1
SHOWHOSC  FORM      1
SPECDESC  DIM       20
ADEPDESC  DIM       20
RDEPDESC  DIM       20
SUPRFLAG  FORM      1          * Supervisor flag for suspended appointment list
DEPTFLAG  FORM      1          * Flag for departure screen time defaults
DEPTINDC  DIM       1
DEPTCODE  DIM       3
DISPSUR   DIM       8          * Display Saved U/R Number
DISPMUR   DIM       8          * Display Merged U/R Number
DISPT001  DIM       9
DISPT002  DIM       20
DIM60     DIM       60
DIM40     DIM       40
DMULTCNT  DIM       2
EPAUDFLG  FORM      1             * Episode audit flag
.                                    0 = no audits written
.                                    1 = before audit written
CLNIDESC  DIM       20
CLIDDESC  DIM       30
EXPRDATE  DATE      8
IBAMFLAG  FORM      1
INCLSUSP  FORM      1
INCLWAIT  FORM      1
MASTREFN  DIM       8                       * Master referral number
MOSAIQCL  FORM      1          * MOSAIQ clinic
MESSAGID  DIM       20
MRGEFLAG  FORM      1
NOPROGRM  FORM      1
NORECCNT  FORM      3
REASNREQ  DIM       20
RECCNTR   FORM      3
REQBDEPT  DIM       20
REQUESTB  DIM       30
REQUESTA  DIM       1
RIAUDFLG  FORM      1             * Referral In audit flag
.                                    0 = no audits written
.                                    1 = before audit written
POPUPAPP  DIM       28
POPUPREQ  DIM       32
PREFHOSP  DIM       50
PROCODES  DIM       6[10]
PRTYDESC  DIM       20
RREQDESC  DIM       20
SAVDISKY  DIM       17
SAVEURNO  DIM       8
SAVBTIME  DIM       5
SAVFHOSP  DIM       3
SAVIADAT  DIM       8                       * Save internal ref date active
SAVPFUND  DIM       6
SAVSKEYS  DIM       25
SAVVPRTY  DIM       3
SAVVREFN  DIM       8
SAVVTRGS  DIM       3
JAVSNAME  DIM       80
ENDNAME   DIM       80
STRTNAME  DIM       80
VINAHFLG  FORM      1             * VINAH Flag
.                                   0 = writing after audits in VINAHDEF
.                                   1 = not writing after audits in VINAHDEF
VINAHREF  DIM       8
WARNINGF  FORM      1
WORKDATE  DATE      8
FIRSTFLG  FORM      1
.
FILTCLID  DIM       6
FILTCTYP  DIM       6
FILTDEPT  DIM       3
FILTHOSP  DIM       3
FILTPRTY  DIM       3
FILTSITE  DIM       6
FILTSTAT  DIM       1
.
FOLDERSF  DIM       3                        * Patient Folder suffix
GLETDATE  DATE      8
SERIFLAG  FORM      1
PRINTONE  FORM      1
PUBLICFL  FORM      1
PARNTBOK  DIM       8 
REFSTAT   DIM       10         * referral status
COUNTDNA  FORM      2
SKEY28    DIM       28
SPECANAM  DIM       20
INTERNAM  DIM       20
DUPFOUND  FORM      1
FLUPDESC  DIM       4
VISCMFLG  FORM      1
VISTDESC  DIM       20
VOUTCODE  DIM       3                  * Visit Outcome Code (Cat OZ)
CHKSITE   DIM       6
CHKCLIN   DIM       6
CHKSTRT   DIM       5
CHKCTYP   DIM       6
CHKTIME   DIM       5
NEWVTYP   DIM       3
OLDVTYP   DIM       3
NEWSLOTS  FORM      3
OLDSLOTS  FORM      3
CNTSLOTS  FORM      3
CLNEWBOK  FORM      1
CLOSEREF  DIM       1
REQAPTDP  DIM       1
FMULTCNT  FORM      2
REQSLOTS  FORM      3
SAVKEY28  DIM       28
SAVKEY24  DIM       24
RECALFLG  FORM      1
REFRLVIS  DIM       8
SLOTSTAT  FORM      1        * Slot Status
HBWAIT    FORM      1        * S27/P46 - Waiting Lists (1=ON,  2=OFF)BOKCONFD
SRCHFTYP  DIM       1
SRCHCARE  DIM       1
SRCHDATF  DIM       8
SRCHDATT  DIM       8
SRCHMOND  DIM       1
SRCHTUES  DIM       1
SRCHWEDN  DIM       1
SRCHTHUR  DIM       1
SRCHFRID  DIM       1
SRCHSATU  DIM       1
SRCHSUND  DIM       1
SHOWYEAR  DIM       4   * Year of Dates to Show (Leave/Sessions etc)
SHOWCNTF  DIM       1   * Shouw session count format
SHWTYEAR  DIM       4   * Year to show session to 
SHOWMNTO  DIM       2   * Show month from
SHOWMNFR  DIM       2   * Show month to
MONTHTOT  FORM      2   * Total No of days in a month
MONTHNO   FORM      2   * Actual month no eg; Jan=1.....Dec=12
MONTHROW  DIM       2   * Actual month no eg; Jan=01.....Dec=12
MONDESC   DIM       10  * Month of Year Description
DISPCOL   FORM      2   * Last Column in Session Date Table
DATECGI   DIM       12  * Date cgi parameter
DAYNO     FORM      2   * Day Number
LINKVTYP  FORM      1
LOOKDAY   FORM      1   * Day to be searched
FIRSTDAY  FORM      1   * First day of the year eg Mon=1.....Sun=7
DATE      DIM       8   * Date Displayed to HTML
LABEL     DIM       2   * Screen Labels
SUSPEND   FORM      1        * Suspended session flag
FROMDTE   FORM      8   * Date in Form Format
TODTE     FORM      8   * Date in Form Format
TRIAGDES  DIM       20
SEXASSCD  FORM      1   * Sex Associated Code Flag
FOUNDFLG  FORM      1
.
LABELOUT  INIT      "LABELOUT"
LETTROUT  INIT      "LETTROUT"
FORMSOUT  INIT      "FORMSOUT"
.
PRNTTYPE  FORM      1
LETTNCOD  FORM      3
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
.
INTAUDTY  DIM       1
ALERTSTR  DIM       10
CSEC      DIM       2
RESVMINS  FORM      2
FORM4D    FORM      4
FORM10    FORM      10
SFORM4D   FORM      4
lOCKCNT   FORM      2
RSHCOUNT  FORM      2
SLOTTYPE  FORM      1
MM1       DIM       2
DD1       DIM       2
CC1       DIM       2
YY1       DIM       2
NXTAIDKY  DIM       28
NXTAPPKY  DIM       28
CASEKEY   DIM       28
SAVCKEYS  DIM       28
ADMISSNU  DIM       8
UPDTTIME  FORM      1
RESERVE   DIM       8
RESERVE1  DIM       2
RESERVE2  DIM       8
RESERVE3  DIM       8
REVWFLAG  FORM      1
HTIME     DIM       8
HTMLLNK2  DIM       127
HTMLLNK5  DIM       127
HTMLLNK6  DIM       256
HCTIME    DIM       5
OUTPATE   DIM       8                   
HFCFDTE   DIM       8                       * Int'm date from (CCYYMMDD)
HFCFINVN  DIM       8                       * Save last invoice number 
KHH       DIM       2
KMM       DIM       2
KSS       DIM       2
KTF       FORM      2
KBLANK    DIM       1
KMM1      FORM      3
KKMIN     FORM      3
KHH1      FORM      2
KSECONDS  INIT      ":00"
KCDATE    DIM       8
KCCC      DIM       2
KCYY      DIM       2
KCMM      DIM       2
KCDD      DIM       2
KIDSONLY  FORM      1
.                                         
BOOKALLA  FORM      1        * Book all appointments flag
BSTATUS   DIM       10
REFLINK   DIM       35
FULLONLY  FORM      1
VCTYP     DIM       6
VSESST    DIM       3
ENDATE    DIM       11       * Date Variable
DIDATE    DIM       11
PANTLOCN  DIM       2        * Patient Location1
PNTLOCTN  DIM       20       * Patient Location2
CHARTREV  FORM      1        * Chart Review               * T0838668
CLINDESC  DIM       30       * Clinic Description
WDAY      FORM      3
DAYDESC   DIM       10       * Day of Week Description 
VSLOT     DIM       3
SLOTOPT   DIM       3
BEFSLOT   FORM      3
OUTCDESC  DIM       25
VTYPDESC  DIM       25
SARRDESC  DIM       25
SAVKEY6   DIM       6
NEXTPAGE  FORM      1
REDIREC1  DIM       227
FORM8     FORM      8
SELOPTCT  FORM      3
ATTDFLAG  FORM      1        * Booking Update in Case List (0=No 1=Yes)
CATgb     INIT      "gb"
FRSTREAD  FORM      1
DNOATTN   INIT      "Not Attd"
DBOOKED   INIT      "Booked  "
DIM3      DIM       3
DIM8      DIM       8
DIM9      DIM       9
DIM30     DIM       30
AUDIFLAG  FORM      1  
UPDTTYPE  DIM       1
NEWSLOTK  DIM       28
SAVSLOTK  DIM       28
LINKOUTN  DIM       8
LISTDAYS  FORM      5
PARNSLOT  FORM      3
PATLINK   DIM       127
F12P2     FORM      12.2
F8P2      FORM      8.2
.TEMPONE   DIM       1
TMPDATE   DIM       8
TXTLEN    FORM      3
TABLTYPE  FORM      1
D2TEMP    DIM       2
RESHFLAG  DIM       1
RESHKEYS  DIM       25
SVRSKEYS  DIM       25
TIMESEEN  FORM      4
CKINTIME  FORM      4
SKIPWARN  FORM      1                  * Flag for kip warning
BOOKFLAG  FORM      1                  * Flag for booking from referral letter
FIRSTADM  DIM       8                  * This CGI contains the parent admission
.                                        number for multiple HCP bookings  
SERIESNO  DIM       8                  * Series booking master admission number
TMPLTYPE  DIM       1                  * Outpatients Extra Template type
CLSESKEY  DIM      28                  * Key to Clinic Session Booking file
NEXTSCRN  DIM       3                  * Outpatients Extra Redirect program  
LSTUNBFL  FORM      1                  * Flag to list unbooked letters only
SAVADMNO  DIM       8                  * Saved Admission number
SAVBCOMP  DIM       3                  * Saved Claim code
.
TOTSLCNT  FORM      3   * Total number of slots processed so far
NUMSLVIS  FORM      3   * Number of slots per visit type
PARNTSLT  FORM      3   * Holds the slot number of the parent slot
VALSLOTS  FORM      3   * Number of slots to validate
SLTEXFLG  FORM      1   * "Slots Exist" Flag. If ZERO then session is empty. 
.
TSITE     DIM       6
TCLINIC   DIM       6
TDATE     DIM       8
TSTRT     DIM       5
CHKKEY19  DIM       19
.
OTXWEND   FORM      2
OTXWEN2   FORM      2
REQCEND   FORM      3
OTRCEND   FORM      3
OVERBOOK  FORM      1   * Over bookings flag
RESERVED  FORM      1   * Reserved slot flag
.
COMM127   DIM       127  
.
COMFILAF  FILE      ASCII, FIXED=128   
COMFILBF  FILE      ASCII, FIXED=128
COMFILOF  FILE      ASCII, FIXED=128
COMFILRF  FILE      ASCII, FIXED=128
.
COMFILNM  DIM       8
COMFILNB  DIM       8
COMFILNO  DIM       8
COMFILNR  DIM       8
.
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
.
CURRDATX  DIM       8
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
VSTXUNIQ  FORM      3
QRYDATA1  DIM       240
.
COMFILPR  INIT      "out08a"
COMFILPC  INIT      "out08c"
COMFILPB  INIT      "out08b"
COMFILPO  INIT      "out08d"
.
COMMURNO  DIM       8
COMMADAT  DIM       8
COMMATIM  DIM       8
COMMTYPE  DIM       2
.
CREFFLAG  FORM      1        * Flag set by Cancel Appt & Close Referral button
.
OTXFLAG   FORM      1
OTXFLA2   FORM      1
OPDFLAG   FORM      1
OTRCFLAG  FORM      1
OPDWEND   FORM      2
REQCFLAG  FORM      1
OUTPFLAG  FORM      1
.
FLGOTBOK  FORM      1
.
SAVDSPLC  DIM       9
SHWPRINT  FORM      1        Pop Up Printer Screen Options on Page Enter
BOOKSTAT  FORM      1        Change Booking Status
.
OUTBB001  DIM       3        Source of Referral (S)      
OUTBB002  DIM       3        Compensation Eligibility (CL)
OUTBB003  DIM       3        Patient Classification (A )
OUTBB004  DIM       3        Insurance Status (U1)
OUTBB005  DIM       3        Attendance Code (CA)
OUTBB006  DIM       6        Doctor's Code
OUTBB007  DIM       25       Comments
OUTBB008  DIM       6        Health fund code
OUTBB009  DIM       8        Health fund table
OUTBB010  DIM       3        No. of prev. visits charged
OUTBB011  DIM       8        Date (CCYYMMDD)
OUTBB012  DIM       3        Patient Category (P )
OUTBB013  DIM       3        Priority Code (PR)
OUTBB014  DIM       3        Reason for Reschedule (RR)
OUTBB015  DIM       1        Non-booked attendee flag
OUTBB016  DIM       6        Clinic type for tracking NBA.s
OUTBB017  DIM       3        User Defined Field 1 (O1)
OUTBB018  DIM       3        User Defined Field 2 (O2)
OUTBB019  DIM       3        User Defined Field 3 (O3)
OUTBB020  DIM       3        User Defined Field 4 (O4)
OUTBB021  DIM       8        Linked Outpatient Visit Number
OUTBB022  DIM       3        Department code (Cat AC)
OUTBB023  DIM       3        Transport Allocation (Cat OB)
OUTBB024  DIM       3        Language of Interpreter (Cat OL)
OUTBB025  DIM       8        Time First Seen
OUTBB026  DIM       8        Time Booked Out
OUTBB027  DIM       20       GPFH Approval Number
OUTBB028  DIM       20       ECR Approval Number
OUTBB029  DIM       10       Referring GP
OUTBB030  DIM       6        GP Practice Code
OUTBB031  DIM       10       Actual Doctor Seen
OUTBB032  DIM       5        Check In Time
OUTBB033  DIM       5        Time Actually Seen
OUTBB034  DIM       5        Time of Departure
OUTBB035  DIM       3        Outcome    (CAT OZ)
OUTBB036  DIM       1        Send Letter (Y/N)
OUTBB037  DIM       2        GP Practice count
OUTBB038  DIM       3        District of Residence (Cat DA)
OUTBB039  DIM       4        Operator who made O/P Book/Re-app
OUTBB040  DIM       3        User Defined Field 5 (O5)
OUTBB041  DIM       3        User Defined Field 6 (O6)
OUTBB042  DIM       3        User Defined Field 7 (O7)
OUTBB043  DIM       3        User Defined Field 8 (O8)
OUTBB044  DIM       6        Patient Rank
OUTBB045  DIM       9        Diagnosis code (MBS or ICD9)
OUTBB046  DIM       50       Diagnosis description
OUTBB047  DIM       3        VISIT TYE (N,R,S)(CV)
OUTBB048  DIM       1        X-Ray Pulling List Indicator
OUTBB049  DIM       3        SESSION STATUS CODE (CS)
OUTBB050  DIM       3        DISCHARGE STATUS (Cat DO)
OUTBB051  DIM       2        Number of days to reserve for
OUTBB052  DIM       8        Referral Date (outbocaf.otbcrdat)
OUTBB053  DIM       3        Cancellation Reason
.
.                                           *** HPS Code Starts Here ***
OUTBB054  DIM       3        Special Arrangements Code
OUTBB055  DIM       9        Diagnosis code2 (MBS or ICD9)
OUTBB056  DIM       50       Diagnosis description2
OUTBB057  DIM       9        Diagnosis code3 (MBS or ICD9)
OUTBB058  DIM       50       Diagnosis description3
OUTBB059  DIM       9        Diagnosis code4 (MBS or ICD9)
OUTBB060  DIM       50       Diagnosis description4
OUTBB061  DIM       9        Diagnosis code5 (MBS or ICD9)
OUTBB062  DIM       50       Diagnosis description5
OUTBB063  DIM       3        Clinic Indicator      
OUTBB064  DIM       1        Supervisor flag to reset the followup made flag
OUTBB065  DIM       1        Send correspondence to carer                    
OUTBB066  DIM       8        Generate Letter Date
OUTBB067  DIM       1        Send Generate Letter (Y/N)
OUTBB068  DIM       3        NMDS Code (Category NM)
OUTBB069  DIM       3        Care Type (Category CC)
OUTBB070  DIM       3        Service Delivery Mode(Cat sd)
OUTBB071  DIM       1        Clinical High Risk
OUTBB072  DIM       3        Tier 2 Code (category NC)
OUTBB073  DIM       3        Health Purchaser (Cat HP)
OUTBB074  DIM       3        Contract Code (Cat gb)
.
NEWSLTIM  DIM       5        New Slot Time
UPDSLTIM  DIM       5        Update Slot Time
UPDSLTNO  DIM       3        Update Slot key
NEWSLTYP  DIM       3        New Slot Type
.
DIAGOVR   FORM      1
.
PWATFLAG  FORM      2         2          20      Item flag 1
PWATITEM  DIM       9         9          22      Item code 1
PWATSUBC  DIM       3         3          31      Item sub code 1
PWATDESC  DIM       30        30         34      Item description 1
PWATIAMT  FORM     12.2       8          64      Item amount 1
.
.*******************************************************************************
.                 Save variables for SVHM Transition II     
.*******************************************************************************
SAVOUTNO  DIM       8          * Outpatient Number
SAVDATE   DIM       8          
SAVURNO   DIM       8
SAVTIME   DIM       5      
SAVCLIN   DIM       6
SAVBDEPT  DIM       3
SAVSRCR   DIM       3
SAVCOMP   DIM       3
SAVDOCT   DIM       6
SAVRFGP   DIM       8
SAVMONTH  DIM       2
.
LASTOUTN  FORM      8
SAVKEY44  DIM       14
STATDESC  DIM       40
RELINK    FORM      1
COUNTER   FORM      3
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
FLAGCLIN  FORM      1
WAITKEYS  DIM       18
SLOTOVER  FORM      1
SLOTINDX  FORM      2
SLOTCNT   FORM      2
SLOTKEYS  DIM       28[99]
CASEKEYS  DIM       28
SAVCASEK  DIM       28  * Save Case keys
SESSKEYS  DIM       25
VIEWNAME  DIM       5
CLINICID  DIM       6
SRCHCLID  DIM       6
SAVECLID  DIM       6
SRCHCLTY  DIM       6
SAVECLTY  DIM       6
SRCHLTYP  DIM       3
SRCHDOCT  DIM       6
SRCHCYCL  DIM       2
SRCHFRST  DIM       1
SRCHDAYS  DIM       2
SESUSED   FORM      4
SESTOTAL  FORM      4
CODEST    INIT      "ST"
CODEA     INIT      "A "
STRTIM    DIM       5
ENDTIM    DIM       5
SESSFILL  FORM      3.1   Fill Percentage for Session
SESHEAD1  DIM       80
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
STRAMPM   DIM       2
ENDAMPM   DIM       2
ENDDAY    FORM      2
ENDMON    FORM      2
ENDYER    FORM      4
CURDATE   DIM       8
.
MEDRTYPE  DIM       3
MINSCHD   FORM      5
MINUSED   FORM      5
MINAVAI   FORM      5
DIMHRS    DIM       2
DIMMIN    DIM       2
FORMHRS   FORM      2
FORMMIN   FORM      2
.
PSRHNAME  DIM       30
DOCTCODE  DIM       6
.
CASECNT   FORM      3
THISCAS   FORM      3
LSTCASE   FORM      3
.
ACTION    DIM       1
TAGMATCH  DIM       14
OLDEXPD   FORM      4
.
PTSTATUS  DIM       20
WAITMIN   FORM      6
ARRMIN    FORM      6
CURMIN    FORM      6
TABLNA    DIM       60
TIMEDISP  DIM       5
TIMEPERD  DIM       2
.
HCEEND    FORM      3
HCETOT    FORM      3
HCECNT    FORM      3
READDNR   FORM      1
TOTALALI  FORM      3
FORM3     FORM      3
COUNT     FORM      3
SEVRDESC  DIM       20
DNRCOD01  DIM       1
DNRCOD02  DIM       1
DNRCOD03  DIM       1
DNRCOD04  DIM       1
DNRCOD05  DIM       1
DNRCOD06  DIM       1
DNRCOD07  DIM       1
DNRCOD08  DIM       1
DNRCOD09  DIM       1
DNRCOD10  DIM       1
NMPNUMB   DIM       20        * actual number keyed in
Z15       INIT      "zzzzzzzzzzzzzzz"
SP12      INIT      "            "
.
KEY2A     DIM       2
CHGUR     FORM      1
CHGADD    FORM      1
PTCUPDFL  FORM      1
MASUPDFL  FORM      1
PTMAS001  DIM       4                   
PTMAS002  FORM      1                                      
PTMAS003  FORM      3
PTMAS004  FORM      1
PTMAS005  DIM       20                                         
PTMAS006  DIM       25                                      
PTMAS007  DIM       19                                        
PTMAS008  DIM       35                                 
PTMAS009  DIM       35                                         
PTMAS010  DIM       35                            
PTMAS011  DIM       35                            
PTMAS012  DIM       8                       
PTMAS013  DIM       20                       
PTMAS014  DIM       20                        
PTMAS015  DIM       1
PTMAS016  DIM       3                  
PTMAS017  DIM       8
PTMAS018  FORM      3
PTMAS019  DIM       3             
PTMAS020  DIM       3                                  
PTMAS021  DIM       3             
PTMAS022  DIM       14        
PTMAS023  DIM       10        
PTMAS024  DIM       15        
PTMAS025  DIM       6       
PTMAS026  DIM       10        
PTMAS027  FORM      1        
PTMAS028  DIM       20        
PTMAS029  FORM      1        
PTMAS030  FORM      1        
PTMAS031  FORM      1        
PTMAS032  DIM       3        
PTMAS033  DIM       3        
PTMAS034  DIM       3        
PTMAS035  DIM       30
PTMAS036  DIM       6        
PTMAS037  DIM       8        
PTMAS038  DIM       19        
PTMAS039  DIM       3        
PTMAS040  DIM       3        
PTMAS041  DIM       3        
PTMAS042  DIM       3        
PTMAS043  DIM       3        
PTMAS044  DIM       3        
PTMAS045  FORM      1        
PTMAS046  FORM      1        
PTMAS047  FORM      1        
PTMAS048  FORM      2        
PTMAS049  DIM       20        
PTMAS050  DIM       35        
PTMAS051  DIM       35        
PTMAS052  DIM       35        
PTMAS053  DIM       35        
PTMAS054  DIM       8        
PTMAS055  DIM       20        
PTMAS056  DIM       20        
PTMAS057  DIM       10        
PTMAS058  FORM      3        
PTMAS059  DIM       2        
PTMAS060  DIM       6        
PTMAS061  DIM       8        
PTMAS062  DIM       3        
PTMAS063  DIM       2        
PTMAS064  DIM       6        
PTMAS065  DIM       14       
PTMAS066  DIM       6 
.
.                                           *** HPS Code Starts Here ***
LETPRT01  DIM       1       * Print Indicator - Pat Reappointment Letter
LETPRT02  DIM       1       * Print Indicator - GP Discharge Letter
LETPRT03  DIM       1       * Print Indicator - Pat Discharge Letter
LETPRT04  DIM       1       * Print Indicator - Std Booking Letter
LETPRT05  DIM       1       * Print Indicator - Std Reappointment Letter 
LETPRT06  DIM       1       * Print Indicator - Std Re-Schedule Letter
LETPRT07  DIM       1       * Print Indicator - Pat Cancellation Letter
LETPRT08  DIM       1       * Print Indicator - Hos Re-Schedule Letter
.
LETPSL01  DIM       3       * Printer Selected - Pat Reapp Letter
LETPSL02  DIM       3       * Printer Selected - GP Discharge Letter
LETPSL03  DIM       3       * Printer Selected - Pat Discharge Letter
LETPSL04  DIM       3       * Printer Selected - Std Booking Letter
LETPSL05  DIM       3       * Printer Selected - Std Re-Appt Letter
LETPSL06  DIM       3       * Printer Selected - Std Re-Schd Letter
LETPSL07  DIM       3       * Printer Selected - Pat Cancel Letter
LETPSL08  DIM       3       * Printer Selected - Hos Re-Schd Letter
.
LABPRT01  DIM       1       * Print Indicator - Booking Label
LABPRT02  DIM       1       * Print Indicator - Appt Mailing Label
LABPRT03  DIM       1       * Print Indicator - PMI Mailing Label
LABPRT04  DIM       1       * Print Indicator - GP Mailing Label
.
LABPNO01  DIM       3       * Number of Labels for Booking Label 
LABPNO02  DIM       3       * Number of Labels for Appt Mailing Label
LABPNO03  DIM       3       * Number of Labels for PMI Mailing Label
LABPNO04  DIM       3       * Number of Labels for GP Mailing Label
.
LABPSL01  DIM       3       * Printer Selected - Booking Label
LABPSL02  DIM       3       * Printer Selected - Appt Mailing Label
LABPSL03  DIM       3       * Printer Selected - PMI Mailing Label
LABPSL04  DIM       3       * Printer Selected - GP Mailing Label
.
LOOPCNTR  FORM      8
.
FRMPRT01  DIM       1       * Print Indicator  - Standard MR3 Form
FRMPSL01  DIM       3       * Printer Selected - Standard MR3 Form
FRMPRT02  DIM       1       * Print Indicator  - Standard Invoice Form
FRMPSL02  DIM       3       * Printer Selected - Standard Invoice Form
.
LABELTYP  DIM       10      * Type of Label To Print Coded Field
STATNCOD  DIM       6       * Stationary Code Coded Field
NOLABELS  DIM       3       * Number of Labels to Print
.
CLINTYPE  DIM       6            
OEMPTY    FORM      6
TMPFLG    FORM      1
CLILDESC  DIM       25                
SITEID    DIM       6              
CLINCID   DIM       6
SESSDATE  DIM       8
SESSTIME  DIM       5
OTSESCOM  DIM       25
OTSES001  DIM       3 
OTSES002  DIM       3 
SNEWKEYS  DIM       28            
NEWSKEYS  DIM       28
MARKKEYS  DIM       28[100]
MARKINDX  FORM      2
MARKCNT   FORM      2
.DIDATE    DIM       1
.ENDATE    DIM       1
XVISTYPE   DIM       3
XCHGFLAG   FORM      1
SESKYVL1  DIM        28
SESKYVL2  DIM        28
CLINDATE  DIM        11                     *** HPS ODC(13/08/01) Starts Here 
DIM10     DIM        10       
DIM5      DIM        5
NONATNDT  DIM        8
SLOTTIME  DIM        5                      
TEMPTIME  DIM        5                      
CLINTIME  DIM        5         
.
AUTCDFLG  FORM      1
TEMPCNT   FORM      1
WARNCNT   FORM      2       * Warning counter
WAITFLAG  FORM      1         * Return to waiting list flag
WEBWRN    DIM       120[10] * Warning Array
WEBERR    DIM       45      * Output Web error
CODTYP    FORM      3       * Coding type
.                             9 - ICD9 coding
.                             101 - ICD10 version 1 coding
.                             102 - ICD10 version 2 coding
DSCOD     DIM       9       * Disease code
DSCODNO   FORM      2       * Disease code no
DISCODNO  FORM      2       * Disease code no
DSCODPFX  DIM       1       * Disease code prefix
ECODECNT  FORM      2       * 'E' code counter
EDITFLG   FORM      1       * Edit flag marker
FORM2A    FORM      2
FORM2B    FORM      2
F3A       FORM      3
F3B       FORM      3
OPCOD     DIM       9       * Operation code
OPCODNO   FORM      2       * Operation code no
SWAPFLG   FORM      1       * Swap flag
SDSCNCD   DIM       9       * Save the disease cancer code
SDSDGCD   DIM       9       * Save the disease dagger code
MIN       DIM       2       * Minutes Variable
MINUTES   FORM      6       * Minutes Variable
MINTIME   FORM      2       * Set minutes to a form after computation
TIME      FORM      3       * Allows for negative Symbol
HOUR      FORM      2       * Hour Variable
FLTRSTAT  DIM       1       * Filter for Ref. Status (Booked/Unbooked)
FLTRCTYP  DIM       6       * Filter for Clinic Type
FLTRCLID  DIM       6       * Filter for Clinic Id
FLTRPRIO  DIM       3       * Filter for Priority
FLTRDCDE  DIM       6       * Filter for Doctor
FLTRRFGP  DIM       6       * Filter for Referring GP
SITECODE  DIM       6
CLNCTYPE  DIM       6
CLNCID    DIM       6
BSTATDSC  DIM       9
PRIODESC  DIM       20
RECCNT    FORM      2       * Counter
DRECCNT   DIM       2       * Counter
SESSNCGI  DIM       10      
SESSTCGI  DIM       10
HUND90    FORM      "190"
CALCDATE  DATE      8
BOOKDATE  DATE      8
ENDBDATE  DATE      8
SAVBDATE  DIM       8
HASBFLAG  FORM      1
HASBTIME  DIM       5
SERIBKEY  DIM       28[45]
MULTBKEY  DIM       28
DATESRCH  DIM       8[45]
MULTSRCH  DIM       25[6]
INTSTATS  FORM      1        * Integer of Filter Status (FILTSTAT)
SERIBEND  FORM      2
DATESEND  FORM      2
MULTSEND  FORM      1
COUNTBOK  FORM      2
COUNTDAT  FORM      2
SERIADMN  DIM       8
SERICASE  DIM       28
SESSFULL  FORM      1
.
VISTFLAG  FORM      1
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVREPTN  FORM      2
SAVPRGID  DIM       8
LINK2PRT  FORM      1        * Link to parent variable
PTCOLUMN  DIM       1        * Display Presenting Complaint flag
FILTLOCA  DIM       3        * Category Code - CT
FLTRTRGS  DIM       3        * Filter Triage status
TRGSDESC  DIM       20
.
.                                           *** HPS Code Ends Here ***
.
OTBIT001  DIM       2
OTBIT002  DIM       9
OTBIT003  DIM       3
OTBIT004  DIM       2
OTBIT005  DIM       9
OTBIT006  DIM       3
OTBIT007  DIM       2
OTBIT008  DIM       9
OTBIT009  DIM       3
OTBIT010  DIM       2
OTBIT011  DIM       9
OTBIT012  DIM       3
OTBIT013  DIM       2
OTBIT014  DIM       9
OTBIT015  DIM       3
OTBIT016  DIM       20                      * Item 1 provider usage
OTBIT017  DIM       20                      * Item 2 provider usage
OTBIT018  DIM       20                      * Item 3 provider usage
OTBIT019  DIM       20                      * Item 4 provider usage
OTBIT020  DIM       20                      * Item 5 provider usage
.
CMBSFLAG  FORM      1
CMBSTEMP  DIM       4      * Template ID
.
.------------------------------------------------------------------------------
PRGID     INIT      "OUTWEB08"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Outpatient Processing"
.------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
          CALL      IBACLOCK       * get current date
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MAIN1000
.
MAIN1020  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      SERB0000        * Series Booking search and display
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00 
          GOTO      MAIN1000
.
MAIN1200  CALL      SERS0000        * Show Available slots
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00 
          GOTO      MAIN1000
.
MAIN1300  CALL      NEWBOK00        * Show New Booking Page
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00 
          GOTO      MAIN1000
.
MAIN1400  CALL      WRTBOK00        * New Booking Details
          BRANCH    EXIT,MAIN1000
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&admissno=",REDIRECT
          MOVE      SERIADMN,KEY8
          REP       " +",KEY8
          APPEND    KEY8,REDIRECT
          APPEND    "&casekeys=",REDIRECT
          MOVE      SERICASE,CASEKEYS
          REP       " +",CASEKEYS
          APPEND    CASEKEYS,REDIRECT
          RESET     REDIRECT
.
          STRIP     REDIREC1
          ENDSET    REDIREC1
.
          IF        SERIFLAG=1
            APPEND    "&seriflag=1",REDIREC1   * Set series booking flag for
            APPEND    "&shwprint=1",REDIREC1   * Extra screen detailslag for
          ENDIF                              
.
          IF        SERIFLAG=2
            APPEND    "&firstadm=",REDIREC1   * Save multiple HCP booking master
            MOVE      FIRSTADM,KEY8           * admission number
            REP       " +",KEY8
            APPEND    KEY8,REDIREC1
            APPEND    "&bookflag=",REDIREC1   * Save multiple HCP booking flag
            MOVE      BOOKFLAG,KEY8 
            REP       " +",KEY8
            APPEND    KEY8,REDIREC1
            APPEND    "&refrlvis=",REDIREC1   * Save multiple HCP booking 
            MOVE      REFRLVIS,KEY8           * referral visit number
            REP       " +",KEY8
            APPEND    KEY8,REDIREC1
            APPEND    "&seriflag=2",REDIREC1   * Set series booking flag for
          ENDIF                                * Extra screen details
.
          RESET     REDIREC1
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      SHWBOK00       * Show Booking and letter pages
          GOTO      MAIN1000
.
MAIN1600  CALL      UPDBOK00       * Update Booking Details
          BRANCH    EXIT,MAIN1000
.
          STRIP     REDIRECT                * HPS_ODC(Screen No.9)Starts here
          ENDSET    REDIRECT
.
          STRIP     REDIREC1                * HPS_ODC(Screen No.9)Starts here
          ENDSET    REDIREC1
.
          MATCH     "2",UPDTTYPE
          IF        @EQUAL
            APPEND    "&admissno=",REDIREC1    * Extra booking screen
            MOVE      OBAOUTNO,KEY8
            REP       " +",KEY8
            APPEND    KEY8,REDIREC1
. 
            IF        SERIFLAG=2
              APPEND    "&firstadm=",REDIREC1   * Save multiple HCP booking
              MOVE      FIRSTADM,KEY8           * master admission number
              REP       " +",KEY8
              APPEND    KEY8,REDIREC1
            ENDIF
          ENDIF
.
          MATCH     "3",UPDTTYPE
          IF        !@EQUAL
            MATCH     "4",UPDTTYPE
            IF        !@EQUAL
              RESET     REDIREC1
              SCAN      "&casekeys=",REDIREC1
              IF        !@EQUAL
                STRIP     REDIREC1
                ENDSET    REDIREC1
                APPEND    "&casekeys=",REDIREC1
                PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
                REP       " +",CASEKEYS
                APPEND    CASEKEYS,REDIREC1
              ENDIF
            ENDIF
          ENDIF
.
          RESET     REDIRECT
          RESET     REDIREC1
.
          COMPARE   CREFFLAG,ONE
          IF        @EQUAL
            CALL      CLSPFM00
          ELSE
            CALL      NXTPAG00                * HPS_ODC(Screen No.9)Ends here
          ENDIF
.
          GOTO      MAIN1000
.
MAIN1700  CALL      RESLOT00           * Appointment Remote Scripting
          GOTO      MAIN1000
.
MAIN1800  CALL      ACTN0000           * OP Appointment Action List
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00 
          GOTO      MAIN1000
.
MAIN1900  CALL      LHIS0000           * OP letter History
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00 
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.*******************************************************************************
.                              Redirect URL
.*******************************************************************************
OUTRED00  CALL      OPENHTML
          BRANCH    EXIT,OUTRED90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
.                             "    alert(#"",WEBTITLE,"#");":
          "var Red=GetOutCookie('",REDIRECT,"','",REDIREC1,"','MultipleHCP');":
                             "    location.href=Red;":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      OUTRED99
.
OUTRED90  DISPLAY   "*** Fifo Not Found ***"
.
OUTRED99  RETURN
.
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
COOPAR00  CALL      OPENHTML
          BRANCH    EXIT,COOPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
          "var Red=GetOutCookie('",REDIRECT,"','",REDIREC1,"','MultipleHCP');":
                             " if (self.name==#"PopUpFrame#") {":
                             " redirectParentFrame(Red); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             " redirectParentParentFrame(Red); }":
                             " else { ":
                             " opener.location.href=Red; ":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML
.
COOPAR99  RETURN
.
.
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
OUTPAR00  CALL      OPENHTML
          BRANCH    EXIT,OUTPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name==#"PopUpFrame#") {":
          " redirectParentFrame(#"",REDIRECT,REDIREC1,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
          " redirectParentParentFrame(#"",REDIRECT,REDIREC1,"#"); }":
                             " else { ":
          "  opener.location.href=#"",REDIRECT,REDIREC1,"#";":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML
OUTPAR99  RETURN
.*******************************************************************************
.  close the popup and direct to a new popup
.*******************************************************************************
CLSPFM00  CALL      OPENHTML
          BRANCH    EXIT,CLSPFM99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
.
          CALL      CLOSHTML
CLSPFM99  RETURN
.*******************************************************************************
.             Output Next Page Based on CGI Parameter nextpage
.*******************************************************************************
NXTPAG00  MOVE      ONE,EXIT
          BRANCH    NEXTPAGE,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                             NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      LOCDIR00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  MOVE      ZERO,EXIT
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      COOPAR00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      OUTPAR00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      OUTRED00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.*******************************************************************************
.                              Redirect URL
.*******************************************************************************
LOCDIR00  CALL      OPENHTML
          BRANCH    EXIT,LOCDIR90
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             "    alert(#"",WEBTITLE,"#");":
                             "    location.href=#"",REDIRECT,REDIREC1,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      LOCDIR99
LOCDIR90  DISPLAY   "*** Fifo Not Found ***"
LOCDIR99  RETURN
.*******************************************************************************
.                         Goes back 1 page
.*******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F1
          SUB       ONE,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-",F1,");":
                             "    reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.*******************************************************************************
.                     Open Files and Initialize Variables
.*******************************************************************************
INIT0000  OPEN      ALLDEPA1,"alldepaf"
          OPEN      PMSPX2A1,"pmspx2af"       * opened for fix of BUG/CR 47
          OPEN      PMSVX1A1,"pmsvx1af"       * for writing presenting complaint
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PMSCURA1,"pmscuraf"       * for writing current patient
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      SCRMASA1,"scrmasaf"
          OPEN      PATMI1A2,"patmi1af" 
          OPEN      PATRE1A1,"patre1af" 
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      PMSHCPA1,"pmshcpaf" 
          OPEN      PMSPAYA1,"pmspayaf" 
          OPEN      PMSPAYA2,"pmspayaf" 
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IBAPOST1,"ibapostf"
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      ALLPCTA1,"allpctaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      ALLREFA3,"allrefaf"
          OPEN      ALLREFA4,"allrefaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLENCA7,"allencaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLCTMA1,"allctmaf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLRITA1,"allritaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      ALLSTSA1,"allstsaf"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
.
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSTSPA1,"pmstspaf"
          OPEN      HICCLMA2,"hicclmaf"
          OPEN      OUTDANA1,"outdanaf"
          OPEN      OUTDANA2,"outdanaf"
          OPEN      OUTDCOA1,"outdcoaf"
          OPEN      OUTCCTA1,"outcctaf"
.
          OPEN      PRIITEM1,"priitemf"
          OPEN      PRITHDA1,"prithdaf"
.
          OPEN      PATCANA1,"patcanaf"
          OPEN      PATICUA1,"paticuaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      BOKRC1A1,"bokrc1af"  
.
          OPEN      IBALPCA1,"ibalpcaf" 
          OPEN      VISINTA1,"visintaf"  .
          OPEN      VISIAUA1,"visiauaf"
          OPEN      VISCMTA1,"viscmtaf"        * comments file         *I-48413
          OPEN      EOCLNKA2,"eoclnkaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      OUTLETR1,"outletrf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      VISPAYA1,"vispayaf" 
          OPEN      VISPAYA2,"vispayaf" 
.
          CALL      OPICD1                * Open ICD Disease files
          CALL      OPICO1                * Open ICD Operation files
          CALL      INTMAS00
.
. Open AE diagnosis and codes for PATCLMTM
.
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      EMRICDA1,"emricdaf"
.
. Read outpatient booking audit indicators
.
          READ      CONTROLF,THIRTY1;*51,HOAUDA,*52,HOAUDB
.
. Open outpatient file with site prefix
.
          OPEN      OUTSITA2,"outsitaf"
.
          MOVE      "out",CFILEPRE       * Save Current File Prefix
          CALL      OPNOUT00             * Open Outpatient Files
.
. Open outpatient file with no site prefix
.
          OPEN      OUTARTA1,"outartaf"
          OPEN      OUTARTA2,"outartaf"
          OPEN      OUTARTA3,"outartaf"
          OPEN      OUTARTA4,"outartaf"
          OPEN      OUTLPCA1,"outlpcaf" 
          OPEN      OUTRCMA1,"outrcmaf"
          OPEN      OUTRF1A1,"outrf1af"  
          OPEN      OUTRF1A2,"outrf1af"  
          OPEN      OUTWMPA1,"outwmpaf"  
          OPEN      OUTTXSA1,"outtxsaf"
          OPEN      OUTSIPA1,"outsipaf"
          OPEN      OUTPHOA1,"outphoaf"
          OPEN      OUTPREA1,"outpreaf" 
.
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,PTCNBAGE,*180,PTCNCDRS:
                                     *209,PTCNADMT
          READ      CONTROLF,TWENTY1;*13,PTCNUNAK,*56,PTCNDEFT,*119,PTCNRPIK:
                             *138,PTCNNHII,PTCNNHID,PTCNDONR,PTCNMEDW,PTCNUDNG:
                             *178,PTCNMPTR,PTCNCDRS,PTCNLNCD,PTCNLP01:
                             *189,PTCNUONL:
                             PTCNPCON,PTCNNHIF,*204,PTCNAWRN,*226,PTCNMWAD:
                             *237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,TWENTY7;*46,HBWAIT
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,*187,OTCNCSRR:
                                     *239,OTCNOCRD,*242,OTCNOCDD
          READ      CONTROLF,THIRTY2;*108,OTCNCREV,*111,OTCNAUPD,*128,OTCNREVC:
                                     *131,OTCNINTR,*155,OTCNAPRC,*156,OTCNSCLV
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG
          READ      CONTROLF,SEVENTY1;*200,CCCNSVHM
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*104,PTCNDGET,*147,CMDISM,*158,PTCNDGPV:
                                    *173,PTCNICUT,*210,PTCNLCLM
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND10;*248,PTCNEPAY
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*213,ALCNLAUD:
                                    *225,ALCNDEVP
          READ      CONTROLF,HUND12;*96,PTCNH7AC
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,HUND21;*101,ALCNDAMR
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          MATCH     "1",ALCNRAUD
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          IF        HBWAIT=1
            OPEN      WATTR1A1,"wattr1af"
            OPEN      WATOPAA1,"watopaaf"
            OPEN      WATOPAA2,"watopaaf"
            OPEN      WATOPSA1,"watopsaf"
            OPEN      WATOPSA2,"watopsaf"
            OPEN      WATTX1A1,"wattx1af"
            OPEN      WATMESA1,"watmesaf"
          ENDIF
.
          MATCH     "1",ALCNLAUD
          IF        @EQUAL
            OPEN      ALLAUDLN,"allaudln"
          ENDIF
.
          MOVE      ZERO,OVRCD
          MOVE      ZERO,NOPROGRM
          TRAP      OVERCOND IF IO
          OPEN      PMSHPGA1,"pmshpgaf"
          TRAPCLR   IO
          IF        OVRCD<>1
            OPEN      PMSHPOA1,"pmshpoaf"
            OPEN      PMSUPGA1,"pmsupgaf"
            OPEN      PMSUPOA1,"pmsupoaf"
          ELSE
            MOVE      ONE,NOPROGRM
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNB
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNO
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNR
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no.
.
          COMPARE   ONE,PTCNNHII
          GOTO      INIT9999 IF NOT EQUAL
.
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      NHIMASA2,"nhimasaf"
          OPEN      NHIETHA1,"nhiethaf"
          OPEN      NHIDNRA1,"nhidnraf"
          OPEN      NHIRELA1,"nhirelaf"
          OPEN      NHIDCDA1,"nhidcdaf"
          OPEN      NHIDMCA1,"nhidmcaf"
          OPEN      NHIMCCA1,"nhimccaf"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      TMPALIA1,"tmpaliaf"
.
          CALL      CONNECT
.
          GOTO      INIT9999             * Open Outpatient Files
.
INIT9000  DISPLAY   *R,"NO SITES EXIST IN OUTSITAF"
          DISPLAY   *R,"SERVER SHUTDOWN"
          STOP
.
INIT9999  RETURN
.*******************************************************************************
.                     Check Correct Files are Open for System
.*******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
OUTFIL99  RETURN
.*******************************************************************************
.                    Open Outpateint Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA2  * Get the name of the BOKA2 file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA4  * Get the name of the BOKA4 file
          CLOSE     OUTBOKA4
          OPEN      OUTBOKA4,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA5  * Get the name of the BOKA5 file
          CLOSE     OUTBOKA5
          OPEN      OUTBOKA5,CFNAME
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBOKC1  * Get the name of the BOKC1 file
          CLOSE     OUTBOKC1
          OPEN      OUTBOKC1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXSCA1  * Get the name of the XSCA1 file
          CLOSE     OUTXSCA1
          OPEN      OUTXSCA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXWPA1  * Get the name of the XWPA1 file
          CLOSE     OUTXWPA1
          OPEN      OUTXWPA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRAPA1  * Get the name of the PAPA1 file
          CLOSE     OUTRAPA1
          OPEN      OUTRAPA1,CFNAME         * Open the Re-Appointment file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA2 file
          CLOSE     OUTSESA2
          OPEN      OUTSESA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA4  * Get the name of the SESA4 file
          CLOSE     OUTSESA4
          OPEN      OUTSESA4,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CLIA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA1 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME          * Open the cancellation log file
.
          PACK      CFNAME,CFILEPRE,FILDIAG1  * Get the name of the DIAG1 file
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          CLOSE     OUTDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
          PACK      CFNAME,CFILEPRE,FILMA1A2
          CLOSE     OUTMA1A2
          CALL      OPOTMA12                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11               * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRSHA1 
          CLOSE     OUTRSHA1
          OPEN      OUTRSHA1,CFNAME          * Open the rescheduling file
.
          PACK      CFNAME,CFILEPRE,FILRSHA2 
          CLOSE     OUTRSHA2
          OPEN      OUTRSHA2,CFNAME          * Open the rescheduling file
.
          PACK      CFNAME,CFILEPRE,FILHISA1 
          CLOSE     OUTHISA1
          OPEN      OUTHISA1,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILSRVA1 
          CLOSE     OUTSRVA1
          OPEN      OUTSRVA1,CFNAME      
          PACK      CFNAME,CFILEPRE,FILSRVA3 
          CLOSE     OUTSRVA3
          OPEN      OUTSRVA3,CFNAME      
.
          PACK      CFNAME,CFILEPRE,FILMSPA1 
          CLOSE     OUTMSPA1
          OPEN      OUTMSPA1,CFNAME      
.
          PACK      CFNAME,CFILEPRE,FILCMNA1 
          CLOSE     OUTCMNA1
          OPEN      OUTCMNA1,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILMASB1 
          CLOSE     OUTMASB1
          OPEN      OUTMASB1,CFNAME    
.
          IF        HOAUDA=0
            PACK      CFNAME,CFILEPRE,FILAUDBA 
            CLOSE     OUTAUDBA
            OPEN      OUTAUDBA,CFNAME    
          ENDIF
.
          IF        HOAUDB=0
            PACK      CFNAME,CFILEPRE,FILAUBB1 
            CLOSE     OUTAUBB1
            OPEN      OUTAUBB1,CFNAME      * 0 = use audit, 1 = not required
          ENDIF
.
          PACK      CFNAME,CFILEPRE,FILLKBA1  * Get the name of the LKBA1 file
          CLOSE     OUTLKBA1
          OPEN      OUTLKBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILLKBA2  * Get the name of the LKBA2 file
          CLOSE     OUTLKBA2
          OPEN      OUTLKBA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBITA1  * Get the name of the BITA1 file
          CLOSE     OUTBITA1
          OPEN      OUTBITA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILLHIA1  * Get the name of the LHIA1 file
          CLOSE     OUTLHIA1
          OPEN      OUTLHIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILPRCA1
          CLOSE     OUTPRCA1
          OPEN      OUTPRCA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCPBA1  * Get the name of the CPBA1 file
          CLOSE     OUTCPBA1
          OPEN      OUTCPBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCVTA1  * Get the name of the CVTA1 file
          CLOSE     OUTCVTA1
          OPEN      OUTCVTA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCPCA1  * Get the name of the CPCA1 file
          CLOSE     OUTCPCA1
          OPEN      OUTCPCA1,CFNAME           * Open the file
.
          RETURN
.*******************************************************************************
.                              Clear Parameters
.*******************************************************************************
CLRPAR00  MOVE      ZERO,ADDNEWPG
          MOVE      ZERO,OTXWEND
          MOVE      ZERO,OTRCEND
          MOVE      ZERO,REQCEND
          MOVE      ONE,OTXFLAG
          MOVE      ONE,OTXFLA2
          MOVE      TEN,NORECORD
          MOVE      ZERO,NORECCNT
          MOVE      ZERO,STARTNUM
          MOVE      SP70,REQUESTA
          MOVE      SP70,POPUPAPP
          MOVE      SP70,POPUPREQ
          MOVE      SP70,SENDLETT
          MOVE      ZERO,OPDWEND
          MOVE      ONE,OPDFLAG
          MOVE      ONE,OTRCFLAG
          MOVE      ONE,REQCFLAG
          MOVE      ZERO,VSCMTFLG
          MOVE      ZERO,VSCMTLIN
.
          MOVE      ZERO,SHWPRINT
          MOVE      ZERO,BOOKSTAT
          MOVE      SP70,NXTAPPKY
          MOVE      SP70,NXTAIDKY
          MOVE      SP70,DOCTCODE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,CLNEWBOK
          MOVE      SP70,CLOSEREF
          MOVE      SP70,REQAPTDP
          MOVE      SP70,CLINICID
          MOVE      SP70,SRCHCLID
          MOVE      SP70,SRCHCARE
          MOVE      SP70,SRCHCLTY
          MOVE      SP70,SRCHLTYP
          MOVE      SP70,SRCHDOCT
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,SRCHDATF
          MOVE      SP70,SRCHDATT
          MOVE      SP70,VYEARMTH
          MOVE      SP70,SESSKEYS
          MOVE      SP70,CASEKEYS
          MOVE      SP70,SAVCASEK
          MOVE      ZERO,SLOTINDX
          MOVE      ZERO,SLOTOVER
          MOVE      SP70,WAITKEYS
          MOVE      SP70,NEWSLOTK
          MOVE      SP70,NEWSLTIM
          MOVE      Z70,UPDSLTIM
          MOVE      Z70,UPDSLTNO
          MOVE      SP70,NEWSLTYP
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,FLGOTBOK
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          PACK      REDIREC1,SP70,SP70,SP70,SP70
.                                           *** HPS Code Starts Here ***
          MOVE      Z70,ACCPORDN
          MOVE      SP70,NEWSKEYS 
          MOVE      SP70,OTSES001 
          MOVE      SP70,OTSES002 
          MOVE      SP70,OTSESCOM
          MOVE      ZERO,MARKINDX
          MOVE      ZERO,UPDTTIME
          MOVE      SP70,RESERVE1
          MOVE      SP70,RESERVE2
          MOVE      SP70,RESERVE3
          MOVE      SP70,REFRLVIS
          MOVE      ZERO,WAITFLAG
.                                           *** HPS Code Ends Here ***
          CALL      CLRBB000 
          CALL      CPVXTF00 
.
          MOVE      Z70,PTMAS001 
          MOVE      ZERO,PTMAS002
          MOVE      ZERO,PTMAS003
          MOVE      ZERO,PTMAS004
          MOVE      Z70,PTMAS005  
          MOVE      Z70,PTMAS006  
          MOVE      Z70,PTMAS007  
          MOVE      Z70,PTMAS008  
          MOVE      Z70,PTMAS009  
          MOVE      Z70,PTMAS010  
          MOVE      Z70,PTMAS011  
          MOVE      Z70,PTMAS012  
          MOVE      Z70,PTMAS013
          MOVE      Z70,PTMAS014 
          MOVE      Z70,PTMAS015  
          MOVE      Z70,PTMAS016
          MOVE      Z70,PTMAS017 
          MOVE      ZERO,PTMAS018  
          MOVE      Z70,PTMAS019
          MOVE      Z70,PTMAS020 
          MOVE      Z70,PTMAS021  
          MOVE      Z70,PTMAS022  
          MOVE      Z70,PTMAS023 
          MOVE      Z70,PTMAS024
          MOVE      Z70,PTMAS025  
          MOVE      Z70,PTMAS026 
          MOVE      ZERO,PTMAS027
          MOVE      Z70,PTMAS028 
          MOVE      ZERO,PTMAS029
          MOVE      ZERO,PTMAS030  
          MOVE      ZERO,PTMAS031 
          MOVE      Z70,PTMAS032
          MOVE      Z70,PTMAS033  
          MOVE      Z70,PTMAS034 
          MOVE      Z70,PTMAS035
          MOVE      Z70,PTMAS036 
          MOVE      Z70,PTMAS037 
          MOVE      Z70,PTMAS038 
          MOVE      Z70,PTMAS039 
          MOVE      Z70,PTMAS040 
          MOVE      Z70,PTMAS041 
          MOVE      Z70,PTMAS042 
          MOVE      Z70,PTMAS043 
          MOVE      Z70,PTMAS044 
          MOVE      ZERO,PTMAS045
          MOVE      ZERO,PTMAS046
          MOVE      ZERO,PTMAS047
          MOVE      ZERO,PTMAS048
          MOVE      Z70,PTMAS049
          MOVE      Z70,PTMAS050
          MOVE      Z70,PTMAS051
          MOVE      Z70,PTMAS052
          MOVE      Z70,PTMAS053
          MOVE      Z70,PTMAS054
          MOVE      Z70,PTMAS055
          MOVE      Z70,PTMAS056
          MOVE      Z70,PTMAS057
          MOVE      ZERO,PTMAS058
          MOVE      Z70,PTMAS059
          MOVE      Z70,PTMAS060
          MOVE      Z70,PTMAS061
          MOVE      Z70,PTMAS062
          MOVE      Z70,PTMAS063
          MOVE      Z70,PTMAS064
          MOVE      Z70,PTMAS065
          MOVE      Z70,PTMAS066
.
          MOVE      Z70,LETPRT01 
          MOVE      Z70,LETPRT02
          MOVE      Z70,LETPRT03
          MOVE      Z70,LETPRT04
          MOVE      Z70,LETPRT05  
          MOVE      Z70,LETPRT06  
          MOVE      Z70,LETPRT07  
          MOVE      Z70,LETPRT08  
          MOVE      Z70,LETPSL01  
          MOVE      Z70,LETPSL02  
          MOVE      Z70,LETPSL03  
          MOVE      Z70,LETPSL04  
          MOVE      Z70,LETPSL05
          MOVE      Z70,LETPSL06 
          MOVE      Z70,LETPSL07  
          MOVE      Z70,LETPSL08
          MOVE      Z70,LABPRT01 
          MOVE      Z70,LABPRT02  
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04 
          MOVE      Z70,LABPNO01  
          MOVE      Z70,LABPNO02  
          MOVE      Z70,LABPNO03 
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPSL01  
          MOVE      Z70,LABPSL02 
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04 
          MOVE      Z70,FRMPRT01
          MOVE      Z70,FRMPRT02  
          MOVE      Z70,FRMPSL01 
          MOVE      Z70,FRMPSL02
          MOVE      Z70,LABELTYP  
          MOVE      Z70,STATNCOD 
          MOVE      Z70,NOCOPIES
          MOVE      Z70,NOLABELS 
          MOVE      Z70,SELPRINT 
          MOVE      SP70,CLINDATE           *** HPS ODC Code Here  
          MOVE      ZERO,MRGEFLAG
          MOVE      SP70,SAVEURNO
          MOVE      SP70,CLINTYPE
          MOVE      ZERO,BOOKFLAG
          MOVE      ZERO,SKIPWARN
          MOVE      SP70,TMPLTYPE
          MOVE      SP70,NEXTSCRN
          MOVE      SP70,CLSESKEY
          MOVE      SP70,SAVSKEYS
          MOVE      ZERO,LSTUNBFL 
          MOVE      ZERO,RECALFLG
          MOVE      SP70,SVRSKEYS
          MOVE      ZERO,DEPTFLAG
          MOVE      SP70,DEPTINDC
          MOVE      SP70,SRCHFTYP
.
          MOVE      SP70,SRCHMOND
          MOVE      SP70,SRCHTUES
          MOVE      SP70,SRCHWEDN
          MOVE      SP70,SRCHTHUR
          MOVE      SP70,SRCHFRID
          MOVE      SP70,SRCHSATU
          MOVE      SP70,SRCHSUND
          MOVE      SP70,SRCHCYCL
          MOVE      SP70,SRCHFRST
          MOVE      SP70,SRCHDAYS
          MOVE      SP70,BOOKDATE
          MOVE      SP70,ENDBDATE
          MOVE      ZERO,SEARCHFL
.
          CALL      CPOTXS00            * Outpatients Extra Screen Details
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 45
            MOVE      SP70,SERIBKEY[COUNT]  * Clear series booking key array
            MOVE      SP70,DATESRCH[COUNT]  * Series booking date search array
            ADD       ONE,COUNT
          DO
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 6
            MOVE      SP70,MULTSRCH[COUNT]  * Clear multiple HCP session search
            ADD       ONE,COUNT
          DO
.
          MOVE      ZERO,SERIBEND
          MOVE      ZERO,DATESEND
          MOVE      ZERO,MULTSEND
          MOVE      SP70,FIRSTADM
          MOVE      SP70,MULTBKEY
          MOVE      ZERO,SERIFLAG
          MOVE      ZERO,PRINTONE
          MOVE      SP70,SERIESNO
          MOVE      ONE,OUTPFLAG
          MOVE      Z70,CANCELRQ
          MOVE      SP70,FILTCLID
          MOVE      SP70,FILTCTYP
          MOVE      SP70,FILTDEPT
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTPRTY
          MOVE      SP70,FILTSITE
          MOVE      ZERO,SHOWFLAG
          MOVE      ZERO,INCLSUSP
          MOVE      ZERO,INCLWAIT
          MOVE      ZERO,DATEPREF
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
.
          CALL      CPOTAR00
.
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
          CALL      CPOTPC00
.
          MOVE      ZERO,PTCOLUMN
          MOVE      SP70,FILTLOCA
.
          MOVE      Z70,OTBIT001
          MOVE      Z70,OTBIT002
          MOVE      Z70,OTBIT003
          MOVE      Z70,OTBIT004
          MOVE      Z70,OTBIT005
          MOVE      Z70,OTBIT006
          MOVE      Z70,OTBIT007
          MOVE      Z70,OTBIT008
          MOVE      Z70,OTBIT009
          MOVE      Z70,OTBIT010
          MOVE      Z70,OTBIT011
          MOVE      Z70,OTBIT012
          MOVE      Z70,OTBIT013
          MOVE      Z70,OTBIT014
          MOVE      Z70,OTBIT015
          MOVE      Z70,OTBIT016
          MOVE      Z70,OTBIT017
          MOVE      Z70,OTBIT018
          MOVE      Z70,OTBIT019
          MOVE      Z70,OTBIT020
.
          MOVE      ZERO,CMBSFLAG
          MOVE      Z70,CMBSTEMP
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no.
          MOVE      ZERO,BOOKALLA
.
          MOVE      ZERO,CREFFLAG
.
CLRPAR99  RETURN
+
.*******************************************************************************
.                           Set Parameters
.*******************************************************************************
SETPAR00  MATCH     "clnewbok=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLNEWBOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shwprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas",QRYNAME
          IF        @EQUAL
            CALL      SPMAS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "newsltyp=",QRYNAME
          IF        @EQUAL
            PACK      NEWSLTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updsltno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDSLTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updsltim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDSLTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newsltim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWSLTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outbb",QRYNAME
          IF        @EQUAL
            MOVE      ONE,FLGOTBOK
            CALL      SETBB000 
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newslotk=",QRYNAME
          IF        @EQUAL
            PACK      NEWSLOTK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            PACK      REDIRECT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec1=",QRYNAME
          IF        @EQUAL
            PACK      REDIREC1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn=",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinicid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchclid=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCLID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcare=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCARE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchclty=",QRYNAME
          IF        @EQUAL
            PACK      SRCHCLTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchltyp=",QRYNAME
          IF        @EQUAL
            PACK      SRCHLTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdoct=",QRYNAME
          IF        @EQUAL
            PACK      SRCHDOCT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRLVIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdatf=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,KEY11         * Change Date format
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            GOTO      SETPAR99 IF EQUAL
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      SRCHDATF,CCENT,CYEAR,CMON,CDAY
            REP       " 0",SRCHDATF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdatt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11         * Change Date format
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            GOTO      SETPAR99 IF EQUAL
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      SRCHDATT,CCENT,CYEAR,CMON,CDAY
            REP       " 0",SRCHDATT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            PACK      CASEKEYS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slotkeys=",QRYNAME
          IF        @EQUAL
            CALL      SLOTKY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitkeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crefflag",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREFFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otxwpcom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outptcom",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "areqcomm",QRYNAME
          IF        @EQUAL
            CALL      GETREQ00
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "otrcmcom",QRYNAME
          IF        @EQUAL
            CALL      GETRCM00
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "clintype=",QRYNAME
          IF        @EQUAL
            PACK      CLINTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "letprt",QRYNAME
          IF        @EQUAL
            CALL     STLET000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labprt",QRYNAME
          IF        @EQUAL
            CALL     STLAB000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "letpsl",QRYNAME
          IF        @EQUAL
            CALL     STPSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpno",QRYNAME
          IF        @EQUAL
            CALL     STPNO000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpsl",QRYNAME
          IF        @EQUAL
            CALL     STLSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "frmprt01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPRT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmprt02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPRT02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpsl01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPSL01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpsl02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPSL02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labeltyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABELTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nolabels=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOLABELS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTIME
            GOTO    SETPAR99
          ENDIF
.
          MATCH     "reserve1=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reserve2=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "reserve3=",QRYNAME
          IF        @EQUAL
            PACK      RESERVE3,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.          
          MATCH    "newskeys=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,NEWSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "markkeys=",QRYNAME
          IF        @EQUAL
            ADD       ONE,MARKINDX
            MOVE      QRYDATA,MARKKEYS[MARKINDX]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otses001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSES001
            GOTO      SETPAR99
          ENDIF
.       
          MATCH     "otses002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSES002
            GOTO      SETPAR99
          ENDIF
.       
          MATCH     "otsescom=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTSESCOM
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "clindate=",QRYNAME
          IF        @EQUAL
            CALL      CLINDT00
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "pmsvx",QRYNAME
          IF        @EQUAL
            CALL      SPVXTF00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "skipwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SKIPWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lstunbfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LSTUNBFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmpltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TMPLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outxs",QRYNAME
          IF        @EQUAL
            CALL      SPXSC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clseskey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLSESKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextscrn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTSCRN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEPTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEPTINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchftyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHFTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchmond=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHMOND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtues=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHTUES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchwedn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHWEDN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchthur=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHTHUR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchfrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHFRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchsatu=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHSATU
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchsund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHSUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcycl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHCYCL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchfrst=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHFRST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdays=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHDAYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seribkey=",QRYNAME
          IF        @EQUAL
            COMPARE   FORTY5,SERIBEND
            GOTO      SETPAR99 IF NOT LESS
            ADD       ONE,SERIBEND
            PACK      SERIBKEY[SERIBEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "datesrch=",QRYNAME
          IF        @EQUAL
            COMPARE   FORTY5,DATESEND              * Array is only 45
            GOTO      SETPAR99 IF NOT LESS
            ADD       ONE,DATESEND
            PACK      DATESRCH[DATESEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "multsrch=",QRYNAME
          IF        @EQUAL
            COMPARE   "6",MULTSEND
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,MULTSEND
            PACK      MULTSRCH[MULTSEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "firstadm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FIRSTADM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seriesno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERIESNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "multbkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULTBKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seriflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERIFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printone=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTONE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "noreccnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECCNT
            GOTO      SETPAR99
          ENDIF
.
. ******************************************* Start of addition        *I-48413
          MATCH     "cancommt",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00           * Get cancellation comments
            GOTO      SETPAR99
          ENDIF
. *******************************************   End of addition        *I-48413
.
          MATCH     "addnewpg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDNEWPG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otart",QRYNAME
          IF        @EQUAL
            CALL      SPOTAR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cancelrq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CANCELRQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclid=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtctyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTCTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdept=",QRYNAME
          IF        @EQUAL
            PACK      FILTDEPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtprty=",QRYNAME
          IF        @EQUAL
            PACK      FILTPRTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtsite=",QRYNAME
          IF        @EQUAL
            PACK      FILTSITE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inclsusp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INCLSUSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inclwait=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INCLWAIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "datepref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DATEPREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requesta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQUESTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "popupapp=",QRYNAME
          IF        @EQUAL
            PACK      POPUPAPP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "popupreq=",QRYNAME
          IF        @EQUAL
            PACK      POPUPREQ,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sendlett=",QRYNAME
          IF        @EQUAL
            PACK      SENDLETT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdcommt",QRYNAME
          IF        @EQUAL
            CALL      GETOPD00           * Get OPD comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "searchfl",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SEARCHFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patinstr",QRYNAME
          IF        @EQUAL
            CALL      GETINS00           * Patient Instructions
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otprc",QRYNAME
          IF        @EQUAL
            CALL      SPOTPR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcolumn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTCOLUMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtloca=",QRYNAME
          IF        @EQUAL
            PACK      FILTLOCA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otbit",QRYNAME
          IF        @EQUAL
            MOVE      ONE,CMBSFLAG
            CALL      SPBIT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "closeref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLOSEREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reqaptdp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQAPTDP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contract=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OUTBB074
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookalla=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKALLA
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.-----------------------------------------------------------------------------.
.         Set parameters for otbit
.-----------------------------------------------------------------------------.
SPBIT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPBIT010,SPBIT020,SPBIT030,SPBIT040,SPBIT050:
                       SPBIT060,SPBIT070,SPBIT080,SPBIT090,SPBIT100:
                       SPBIT110,SPBIT120,SPBIT130,SPBIT140,SPBIT150:
                       SPBIT160,SPBIT170,SPBIT180,SPBIT190,SPBIT200
.
          MOVE      ONE,EXIT
          GOTO      SPBIT999
.
SPBIT010  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT001
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT001
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT020  PACK      OTBIT002,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT030  MOVE      QRYDATA,OTBIT003
          GOTO      SPBIT999
.
SPBIT040  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT004
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT004
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT050  PACK      OTBIT005,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT060  MOVE      QRYDATA,OTBIT006
          GOTO      SPBIT999
.
SPBIT070  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT007
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT007
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT080  PACK      OTBIT008,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT090  MOVE      QRYDATA,OTBIT009
          GOTO      SPBIT999
.
SPBIT100  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT010
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT010
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT110  PACK      OTBIT011,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT120  MOVE      QRYDATA,OTBIT012
          GOTO      SPBIT999
.
SPBIT130  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",OTBIT013
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",OTBIT013
          ENDIF
.
          GOTO      SPBIT999
.
SPBIT140  PACK      OTBIT014,QRYDATA,SP70
          GOTO      SPBIT999
.
SPBIT150  MOVE      QRYDATA,OTBIT015
          GOTO      SPBIT999
.
SPBIT160  MOVE      QRYDATA,OTBIT016
          GOTO      SPBIT999
.
SPBIT170  MOVE      QRYDATA,OTBIT017
          GOTO      SPBIT999
.
SPBIT180  MOVE      QRYDATA,OTBIT018
          GOTO      SPBIT999
.
SPBIT190  MOVE      QRYDATA,OTBIT019
          GOTO      SPBIT999
.
SPBIT200  MOVE      QRYDATA,OTBIT020
          GOTO      SPBIT999
.
SPBIT999  RETURN
+
.*******************************************************************************
.                   Clinical Date
.*******************************************************************************
CLINDT00  UNPACK    QRYDATA,DIM10,CLINDATE,D1,CLINTIME 
          UNPACK    CLINDATE,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      NONATNDT,CCENT,CYEAR,CMON,CDAY          
          GOTO      CLINDT99
CLINDT99  RETURN 
+
.*******************************************************************************
.                   Slot Keys
.*******************************************************************************
SLOTKY00  COMPARE   "99",SLOTINDX
          GOTO      SLOTKY90 IF EQUAL
          ADD       ONE,SLOTINDX
          PACK      SLOTKEYS[SLOTINDX],QRYDATA,SP70
          MOVE      ZERO,SLOTOVER
          GOTO      SLOTKY99
.
SLOTKY90  MOVE      ONE,SLOTOVER
          GOTO      SLOTKY99 
.
SLOTKY99 RETURN
+
.*******************************************************************************
.                          Get Text Comments
.*******************************************************************************
GETEXT00  PREP      COMFILAF,COMFILNM
          MOVE      ZERO,OTXFLAG
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETEXT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETEXT90  MOVE      F3,OTXWEND
          OPEN      COMFILAF,COMFILNM
GETEXT99  RETURN
.
.-----------------------------------------------------------------
. GTVISC00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVISC10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   NINTY9,VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
.
.*******************************************************************************
.                          Get appointment request comments
.*******************************************************************************
GETREQ00  PREP      COMFILBF,COMFILNB
          MOVE      ZERO,REQCFLAG
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETREQ10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETREQ90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETREQ80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETREQ10
.
GETREQ80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETREQ90  MOVE      F3,REQCEND
          OPEN      COMFILBF,COMFILNB
GETREQ99  RETURN
.
.*******************************************************************************
. Get appointment request comments - OUTRCMFD
.*******************************************************************************
GETRCM00  PREP      COMFILRF,COMFILNR

          MOVE      ZERO,OTRCFLAG
          MOVE      ONE,F3
          WRITE     COMFILRF,SEQ;QRYDATA
.
GETRCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETRCM90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETRCM80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMFILRF,SEQ;QRYDATA
          GOTO      GETRCM10
.
GETRCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETRCM90  MOVE      F3,OTRCEND
          OPEN      COMFILRF,COMFILNR
GETRCM99  RETURN
.
.*******************************************************************************
.                        SET LETPRT PARAMETERS                 
.*******************************************************************************
.
STLET000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLET001,STLET002,STLET003,STLET004,STLET005:
                       STLET006,STLET007,STLET008
.
          MOVE      ONE,EXIT
          GOTO      STLET999
.
STLET001  MOVE      QRYDATA,LETPRT01
          GOTO      STLET999
.
STLET002  MOVE      QRYDATA,LETPRT02
          GOTO      STLET999
.
STLET003  MOVE      QRYDATA,LETPRT03
          GOTO      STLET999
.
STLET004  MOVE      QRYDATA,LETPRT04
          GOTO      STLET999
.
STLET005  MOVE      QRYDATA,LETPRT05
          GOTO      STLET999
.
STLET006  MOVE      QRYDATA,LETPRT06
          GOTO      STLET999
.
STLET007  MOVE      QRYDATA,LETPRT07
          GOTO      STLET999
.
STLET008  MOVE      QRYDATA,LETPRT08
          GOTO      STLET999
.
STLET999  RETURN
.
.*******************************************************************************
.                        SET LABPRT PARAMETERS
.*******************************************************************************
STLAB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLAB001,STLAB002,STLAB003,STLAB004
.
          MOVE      ONE,EXIT
          GOTO      STLAB999
.
STLAB001  MOVE      QRYDATA,LABPRT01
          GOTO      STLAB999
.
STLAB002  MOVE      QRYDATA,LABPRT02
          GOTO      STLAB999
.
STLAB003  MOVE      QRYDATA,LABPRT03
          GOTO      STLAB999
.
STLAB004  MOVE      QRYDATA,LABPRT04
          GOTO      STLAB999
.
STLAB999  RETURN
.
.*******************************************************************************
.                      SET LABPN PARAMETERS 
.*******************************************************************************
.
STPNO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPNO001,STPNO002,STPNO003,STPNO004
.
          MOVE      ONE,EXIT
          GOTO      STPNO999
.
STPNO001  MOVE      QRYDATA,LABPNO01
          GOTO      STPNO999
.
STPNO002  MOVE      QRYDATA,LABPNO02
          GOTO      STPNO999
.
STPNO003  MOVE      QRYDATA,LABPNO03
          GOTO      STPNO999
.
STPNO004  MOVE      QRYDATA,LABPNO04
          GOTO      STPNO999
.
STPNO999  RETURN
.
.*******************************************************************************
.                      SET LETPSL PARAMETERS
.*******************************************************************************
.
STPSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPSL001,STPSL002,STPSL003,STPSL004,STPSL005:
                       STPSL006,STPSL007,STPSL008
.
          MOVE      ONE,EXIT
          GOTO      STPSL999
.
STPSL001  MOVE      QRYDATA,LETPSL01
          GOTO      STPSL999
.
STPSL002  MOVE      QRYDATA,LETPSL02
          GOTO      STPSL999
.
STPSL003  MOVE      QRYDATA,LETPSL03
          GOTO      STPSL999
.
STPSL004  MOVE      QRYDATA,LETPSL04
          GOTO      STPSL999
.
STPSL005  MOVE      QRYDATA,LETPSL05
          GOTO      STPSL999
.
STPSL006  MOVE      QRYDATA,LETPSL06
          GOTO      STPSL999
.
STPSL007  MOVE      QRYDATA,LETPSL07
          GOTO      STPSL999
.
STPSL008  MOVE      QRYDATA,LETPSL08
          GOTO      STPSL999
.
STPSL999  RETURN
.
.******************************************************************************
.                           SET LABPSL PARAMETERS
.******************************************************************************
.
STLSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLSL001,STLSL002,STLSL003,STLSL004
.
          MOVE      ONE,EXIT
          GOTO      STLSL999
.
STLSL001  MOVE      QRYDATA,LABPSL01
          GOTO      STLSL999
.
STLSL002  MOVE      QRYDATA,LABPSL02
          GOTO      STLSL999
.
STLSL003  MOVE      QRYDATA,LABPSL03
          GOTO      STLSL999
.
STLSL004  MOVE      QRYDATA,LABPSL04
          GOTO      STLSL999
.
STLSL999  RETURN
.
.*******************************************************************************
.                          Process Templated Fields
.*******************************************************************************
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD99,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD80,PROFLD90
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000     * Master file Details
          GOTO      PROFLD99
.
PROFLD12  CALL      STAG0000     * Series booking general tags
          GOTO      PROFLD99
.
PROFLD13  CALL      OEXT0000     * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD14  CALL      ORFL0000     * Outpatient Referral letter file
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      STAG0000     * Series booking general tags
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37
.
PROFLD31  CALL      MASF0000     * Master file Details
          GOTO      PROFLD99
.
PROFLD32  CALL      OBOA0000     * Outpatient Booking File
          GOTO      PROFLD99
.
PROFLD33  CALL      OEXT0000     * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD34  CALL      ORFL0000     * Outpatient Referral letter file
          GOTO      PROFLD99
.
PROFLD35  CALL      STAG0000     * Series booking general tags
          GOTO      PROFLD99
.
PROFLD36  CALL      VXTF0000     * Visit Extension Details
          GOTO      PROFLD99
.
PROFLD37  CALL      ALRE0000
          GOTO      PROFLD99     * A/H Referral Tags
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55:
                             PROFLD56,PROFLD57,PROFLD58,PROFLD59
.
PROFLD51  CALL      MASF0000     * Master file Details
          GOTO      PROFLD99
.
PROFLD52  CALL      OOSE0000     * Session Details
          GOTO      PROFLD99
.
PROFLD53  CALL      DOCF0000     * Doctor Details
          GOTO      PROFLD99
.
PROFLD54  CALL      OBOA0000     * Outpatient Booking File
          GOTO      PROFLD99
.
PROFLD55  CALL      MSXF0000     * Master Extension File
          GOTO      PROFLD99
.
PROFLD56  IF        PTCNNHII=1
            CALL      NHIF0000   * National System
          ENDIF
          GOTO      PROFLD99
.
PROFLD57  CALL      OEXT0000     * Extra Outpatient Fields for Booking/Followup
          GOTO      PROFLD99
.
PROFLD58  CALL      STAG0000     * series booking general tags
          GOTO      PROFLD99
.
PROFLD59  CALL      VXTF0000     * Visit Extension Details
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84,PROFLD85:
                             PROFLD86  
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000     * Master file Details
          GOTO      PROFLD99
.
PROFLD82  CALL      ALRE0000     * A/H Referral Tags
          GOTO      PROFLD99
.
PROFLD83  CALL      OTAR0000     * Appointment Action Tags
          GOTO      PROFLD99
.
PROFLD84  CALL      ATAG0000     * General Appointment Action Tags
          GOTO      PROFLD99
.
PROFLD85  CALL      VXTF0000     * Visit Extension Details
          GOTO      PROFLD99
.
PROFLD86  CALL      STAG0000     * series booking general tags
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000     * Master file Details
          GOTO      PROFLD99
.
PROFLD92  CALL      LTAG0000     * OP Letter History Tags
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
CLRBB000  MOVE       Z70,OUTBB001
          MOVE       Z70,OUTBB002
          MOVE       Z70,OUTBB003
          MOVE       Z70,OUTBB004
          MOVE       Z70,OUTBB005
          MOVE       Z70,OUTBB006
          MOVE       Z70,OUTBB007
          MOVE       Z70,OUTBB008
          MOVE       Z70,OUTBB009
          MOVE       Z70,OUTBB010
          MOVE       Z70,OUTBB011
          MOVE       Z70,OUTBB012
          MOVE       Z70,OUTBB013
          MOVE       Z70,OUTBB014
          MOVE       Z70,OUTBB015
          MOVE       Z70,OUTBB016
          MOVE       Z70,OUTBB017
          MOVE       Z70,OUTBB018
          MOVE       Z70,OUTBB019
          MOVE       Z70,OUTBB020
          MOVE       Z70,OUTBB021
          MOVE       Z70,OUTBB022
          MOVE       Z70,OUTBB023
          MOVE       Z70,OUTBB024
          MOVE       Z70,OUTBB025
          MOVE       Z70,OUTBB026
          MOVE       Z70,OUTBB027
          MOVE       Z70,OUTBB028
          MOVE       Z70,OUTBB029
          MOVE       Z70,OUTBB030
          MOVE       Z70,OUTBB031
          MOVE       Z70,OUTBB032
          MOVE       Z70,OUTBB033
          MOVE       Z70,OUTBB034
          MOVE       Z70,OUTBB035
          MOVE       Z70,OUTBB036
          MOVE       Z70,OUTBB037
          MOVE       Z70,OUTBB038
          MOVE       Z70,OUTBB039
          MOVE       Z70,OUTBB040
          MOVE       Z70,OUTBB041
          MOVE       Z70,OUTBB042
          MOVE       Z70,OUTBB043
          MOVE       Z70,OUTBB044
          MOVE       Z70,OUTBB045
          MOVE       Z70,OUTBB046
          MOVE       Z70,OUTBB047
          MOVE       Z70,OUTBB048
          MOVE       Z70,OUTBB049
          MOVE       Z70,OUTBB050
          MOVE       Z70,OUTBB051
          MOVE       Z70,OUTBB052
          MOVE       Z70,OUTBB053
.                                           *** HPS Code Starts Here ***
          MOVE       Z70,OUTBB054
          MOVE       Z70,OUTBB055
          MOVE       Z70,OUTBB056
          MOVE       Z70,OUTBB057
          MOVE       Z70,OUTBB058
          MOVE       Z70,OUTBB059
          MOVE       Z70,OUTBB060
          MOVE       Z70,OUTBB061
          MOVE       Z70,OUTBB062
          MOVE       Z70,OUTBB063
          MOVE       Z70,OUTBB064
          MOVE       Z70,OUTBB065
          MOVE       Z70,OUTBB066
          MOVE       Z70,OUTBB067
          MOVE       Z70,OUTBB068
          MOVE       Z70,OUTBB069
          MOVE       Z70,OUTBB070
          MOVE       Z70,OUTBB071
          MOVE       Z70,OUTBB072
          MOVE       Z70,OUTBB073
          MOVE       Z70,OUTBB074
.                                           *** HPS Code Ends Here ***
CLRBB999  RETURN
.
.*******************************************************************************
.                           Set Out B Parameters
.*******************************************************************************
SETBB000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          IF        (F3=11|F3=52|F3=66)
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY,SP70
          ENDIF
.
          STORE     QRYDATA,F3,OUTBB001,OUTBB002,OUTBB003,OUTBB004,OUTBB005:
                               OUTBB006,OUTBB007,OUTBB008,OUTBB009,OUTBB010:
                               OUTBB011,OUTBB012,OUTBB013,OUTBB014,OUTBB015:
                               OUTBB016,OUTBB017,OUTBB018,OUTBB019,OUTBB020:
                               OUTBB021,OUTBB022,OUTBB023,OUTBB024,OUTBB025:
                               OUTBB026,OUTBB027,OUTBB028,OUTBB029,OUTBB030:
                               OUTBB031,OUTBB032,OUTBB033,OUTBB034,OUTBB035:
                               OUTBB036,OUTBB037,OUTBB038,OUTBB039,OUTBB040:
                               OUTBB041,OUTBB042,OUTBB043,OUTBB044,OUTBB045:
                               OUTBB046,OUTBB047,OUTBB048,OUTBB049,OUTBB050:
                               OUTBB051,OUTBB052,OUTBB053,OUTBB054,OUTBB055:
                               OUTBB056,OUTBB057,OUTBB058,OUTBB059,OUTBB060:
                               OUTBB061,OUTBB062,OUTBB063,OUTBB064,OUTBB065:
                               OUTBB066,OUTBB067,OUTBB068,OUTBB069,OUTBB070:
                               OUTBB071,OUTBB072,OUTBB073,OUTBB074
.
SETBB999  RETURN
.
.*******************************************************************************
.                   Set Parameters for Master Details
.*******************************************************************************
SPMAS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMAS010,SPMAS020,SPMAS030,SPMAS040,SPMAS050:
                       SPMAS060,SPMAS070,SPMAS080,SPMAS090,SPMAS100:
                       SPMAS110,SPMAS120,SPMAS130,SPMAS140,SPMAS150:
                       SPMAS160,SPMAS170,SPMAS180,SPMAS190,SPMAS200:
                       SPMAS210,SPMAS220,SPMAS230,SPMAS240,SPMAS250:
                       SPMAS260,SPMAS270,SPMAS280,SPMAS290,SPMAS300:
                       SPMAS310,SPMAS320,SPMAS330,SPMAS340,SPMAS350:
                       SPMAS360,SPMAS370,SPMAS380,SPMAS390,SPMAS400:
                       SPMAS410,SPMAS420,SPMAS430,SPMAS440,SPMAS450:
                       SPMAS460,SPMAS470,SPMAS480,SPMAS490,SPMAS500:
                       SPMAS510,SPMAS520,SPMAS530,SPMAS540,SPMAS550:
                       SPMAS560,SPMAS570,SPMAS580,SPMAS590,SPMAS600:
                       SPMAS610,SPMAS620,SPMAS630,SPMAS640,SPMAS650:
                       SPMAS660
.
          MOVE      ONE,EXIT
          GOTO      SPMAS999

SPMAS010  MOVE      QRYDATA,PTMAS001
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS020  MOVE      QRYDATA,PTMAS002
          GOTO      SPMAS900
.
SPMAS030  MOVE      QRYDATA,PTMAS003
          GOTO      SPMAS900
.
SPMAS040  MOVE      QRYDATA,PTMAS004
          GOTO      SPMAS900
.
SPMAS050  MOVE      QRYDATA,PTMAS005
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS060  MOVE      QRYDATA,PTMAS006
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS070  MOVE      QRYDATA,PTMAS007
          GOTO      SPMAS900
.
SPMAS080  MOVE      QRYDATA,PTMAS008
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS090  MOVE      QRYDATA,PTMAS009
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS100  MOVE      QRYDATA,PTMAS010
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS110  MOVE      QRYDATA,PTMAS011
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS120  MOVE      QRYDATA,PTMAS012
          MOVE      ONE,CHGUR
          MOVE      ONE,CHGADD
          GOTO      SPMAS900
.
SPMAS130  MOVE      QRYDATA,PTMAS013
          GOTO      SPMAS900
.
SPMAS140  MOVE      QRYDATA,PTMAS014
          GOTO      SPMAS900
.
SPMAS150  MOVE      QRYDATA,PTMAS015
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS160  MOVE      QRYDATA,PTMAS016
          GOTO      SPMAS900
.
SPMAS170  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS017,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS180  MOVE      QRYDATA,PTMAS018
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS190  MOVE      QRYDATA,PTMAS019
          GOTO      SPMAS900
.
SPMAS200  MOVE      QRYDATA,PTMAS020
          GOTO      SPMAS900
.
SPMAS210  MOVE      QRYDATA,PTMAS021
          GOTO      SPMAS900
.
SPMAS220  MOVE      QRYDATA,PTMAS022
          GOTO      SPMAS900
.
SPMAS230  MOVE      QRYDATA,PTMAS023
          GOTO      SPMAS900
.
SPMAS240  MOVE      QRYDATA,PTMAS024
          GOTO      SPMAS900
.
SPMAS250  UNPACK    QRYDATA,KEY2,KEY1,KEY2A
          PACK      PTMAS025,KEY2,KEY2A
          GOTO      SPMAS900
.
SPMAS260  MOVE      QRYDATA,PTMAS026
          GOTO      SPMAS900
.
SPMAS270  MOVE      QRYDATA,PTMAS027
          GOTO      SPMAS900
.
SPMAS280  MOVE      QRYDATA,PTMAS028
          GOTO      SPMAS900
.
SPMAS290  MOVE      QRYDATA,PTMAS029
          GOTO      SPMAS900
.
SPMAS300  MOVE      QRYDATA,PTMAS030
          GOTO      SPMAS900
.
SPMAS310  MOVE      QRYDATA,PTMAS031
          GOTO      SPMAS900
.
SPMAS320  MOVE      QRYDATA,PTMAS032
          GOTO      SPMAS900
.
SPMAS330  MOVE      QRYDATA,PTMAS033
          GOTO      SPMAS900
.
SPMAS340  MOVE      QRYDATA,PTMAS034
          GOTO      SPMAS900
.
SPMAS350  MOVE      QRYDATA,PTMAS035
          GOTO      SPMAS900
.
SPMAS360  MOVE      QRYDATA,PTMAS036
          GOTO      SPMAS900
.
SPMAS370  MOVE      QRYDATA,PTMAS037
          GOTO      SPMAS900
.
SPMAS380  MOVE      QRYDATA,PTMAS038
          GOTO      SPMAS900
.
SPMAS390  MOVE      QRYDATA,PTMAS039
          GOTO      SPMAS900
.
SPMAS400  MOVE      QRYDATA,PTMAS040
          GOTO      SPMAS900
.
SPMAS410  MOVE      QRYDATA,PTMAS041
          GOTO      SPMAS900
.
SPMAS420  MOVE      QRYDATA,PTMAS042
          GOTO      SPMAS900
.
SPMAS430  MOVE      QRYDATA,PTMAS043
          GOTO      SPMAS900
.
SPMAS440  MOVE      QRYDATA,PTMAS044
          GOTO      SPMAS900
.
SPMAS450  MOVE      QRYDATA,PTMAS045
          GOTO      SPMAS900
.
SPMAS460  MOVE      QRYDATA,PTMAS046
          GOTO      SPMAS900
.
SPMAS470  MOVE      QRYDATA,PTMAS047
          GOTO      SPMAS900
.
SPMAS480  MOVE      QRYDATA,PTMAS048
          GOTO      SPMAS900
.
SPMAS490  MOVE      QRYDATA,PTMAS049
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS500  MOVE      QRYDATA,PTMAS050
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS510  MOVE      QRYDATA,PTMAS051
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS520  MOVE      QRYDATA,PTMAS052
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS530  MOVE      QRYDATA,PTMAS053
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS540  MOVE      QRYDATA,PTMAS054
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS550  MOVE      QRYDATA,PTMAS055
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS560  MOVE      QRYDATA,PTMAS056
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS570  MOVE      QRYDATA,PTMAS057
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS580  MOVE      QRYDATA,PTMAS058
          GOTO      SPMAS900
.
SPMAS590  MOVE      QRYDATA,PTMAS059
          GOTO      SPMAS900
.
SPMAS600  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS060,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS610  MATCH     SP70,QRYDATA
          GOTO      SPMAS900 IF EQUAL
          GOTO      SPMAS900 IF EOS
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS061,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS620  MOVE      QRYDATA,PTMAS062
          GOTO      SPMAS900
.
SPMAS630  MOVE      QRYDATA,PTMAS063
          GOTO      SPMAS900
.
SPMAS640  MOVE      QRYDATA,PTMAS064
          GOTO      SPMAS900
.
SPMAS650  MOVE      QRYDATA,PTMAS065
          GOTO      SPMAS900
.
SPMAS660  MOVE      QRYDATA,PTMAS066
          GOTO      SPMAS900
.
SPMAS900  MOVE      ONE,MASUPDFL
.
SPMAS999  RETURN
.
.*******************************************************************************
.                   Determine Template from Mapping Table
.*******************************************************************************
GETMAP00  MOVE      REPORTNO,F2
          PACK      KEY13,PRGID,F2,TEMPLATE,SP70
          REP       " 0",KEY13
.
          PACK      KEY25,SITECODE,CLINICID,KEY13,SP70
          CALL      RDOTWM1
          IF        OVRCD=0
            MOVE      OTWMMPTT,TEMPLATE
          ENDIF
.
GETMAP99  RETURN
.
.*******************************************************************************
.                         Show Booking Details
.*******************************************************************************
SERB0000  MATCH     SP70,UPDTTYPE
          GOTO      SERB5000 IF EQUAL
.
          GOTO      SERB9000

SERB5000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SERB9100
          CALL      RDPMPX21
          BRANCH    OVRCD,SERB9100
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      SERB9200 IF EQUAL
.
          MOVE      ADMISSNO,KEY8  * Get Referral Details
          CALL      RDOTRFL1
          IF        OVRCD=1
            CALL      CLOUTRFL
          ENDIF
.
          MOVE      REFRLVIS,KEY8  * Get Allied Health Referral Details
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
SERB8000  MOVE      "Series Bookings",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,SERB9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      SERB9999
.
SERB9000  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERB9999
.
SERB9100  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERB9999
.
SERB9200  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERB9999
.
SERB9999  RETURN
.
.*******************************************************************************
. Series booking general tags
.*******************************************************************************
STAG0000  BRANCH    FLDITMNO,STAG0100,STAG0200,STAG0300,STAG0400,STAG0500:
                             STAG0600,STAG0700,STAG0800,STAG0900,STAG1000:
                             STAG1100,STAG1200,STAG1300,STAG1400,STAG1500:
                             STAG1600,STAG1700,STAG1800,STAG1900,STAG2000:
                             STAG2100,STAG2200,STAG2300,STAG2400,STAG2500:
                             STAG2600,STAG2700,STAG2800,STAG2900,STAG3000:
                             STAG3100,STAG3200,STAG3300,STAG3400,STAG3500:
                             STAG3600
.
          WRITE     HTMLFILE;"Invalid IBA TAG";
          GOTO      STAG9999
.
STAG0100  WRITE     HTMLFILE;SRCHCLTY;
          GOTO      STAG9999
.
STAG0200  WRITE     HTMLFILE;SRCHCLID;
          GOTO      STAG9999
.
STAG0300  UNPACK    DIM127,D1,SHOWCNTF,DIM127   * Output session count format
.                                               * 0=Standard, 1=RCH
          CALL      SRCH0000                    * Series Booking Search
          GOTO      STAG9999
.
STAG0400  MATCH     SRCHDATF,SP70
          IF        @EQUAL
            PACK      CALCDATE,CCC,CYY,CMM,CDD
            REP       " 0",CALCDATE
            UNPACK    CALCDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            GOTO      STAG9999
          ENDIF
.
          UNPACK    SRCHDATF,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      STAG9999
.
STAG0500  MATCH     SRCHDATT,SP70
          IF        @EQUAL
            PACK      CALCDATE,CCC,CYY,CMM,CDD
            REP       " 0",CALCDATE
            ADD       HUND90,CALCDATE
            UNPACK    CALCDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            GOTO      STAG9999
          ENDIF
.
          UNPACK    SRCHDATT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      STAG9999
.
STAG0600  WRITE     HTMLFILE;SRCHFTYP;
          GOTO      STAG9999
.
STAG0700  WRITE     HTMLFILE;SRCHMOND;
          GOTO      STAG9999
.
STAG0800  WRITE     HTMLFILE;SRCHTUES;
          GOTO      STAG9999
.
STAG0900  WRITE     HTMLFILE;SRCHWEDN;
          GOTO      STAG9999
.
STAG1000  WRITE     HTMLFILE;SRCHTHUR;
          GOTO      STAG9999
.
STAG1100  WRITE     HTMLFILE;SRCHFRID;
          GOTO      STAG9999
.
STAG1200  WRITE     HTMLFILE;SRCHSATU;
          GOTO      STAG9999
.
STAG1300  WRITE     HTMLFILE;SRCHSUND;
          GOTO      STAG9999
.
STAG1400  CALL      SAVAIL00                * Show Available appointments
          GOTO      STAG9999
.
STAG1500  WRITE     HTMLFILE;SRCHCYCL;
          GOTO      STAG9999
.
STAG1600  WRITE     HTMLFILE;SRCHDAYS;
          GOTO      STAG9999
.
STAG1700  WRITE     HTMLFILE;SRCHFRST;
          GOTO      STAG9999
.
STAG1800  MATCH     SP70,SRCHDAYS
          GOTO      STAG9999 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      SRCHDAYS,F1
          LOAD      DAYDESC,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          WRITE     HTMLFILE;DAYDESC;   * Day Indicator
          GOTO      STAG9999
.
STAG1900  CALL      SESTBL00     * Table Session Dates
          GOTO      STAG9999
.
STAG2000  UNPACK    DIM127,D1,SHOWCNTF,DIM127   * Output session count format
.                                               * 0=Standard, 1=RCH
          MATCH     SP70,SRCHDATF
          GOTO      STAG9999 IF EQUAL
.
          CALL      SHWM0000                * Search by a given date
          CALL      EOSR0000                * End of search results line
          GOTO      STAG9999
.
STAG2100  CALL      MULAVL00                * ShowMultiple  Avail appointments
          GOTO      STAG9999
.
STAG2200  WRITE     HTMLFILE;FIRSTADM;
          GOTO      STAG9999
.
STAG2300  WRITE     HTMLFILE;MULTBKEY;
          GOTO      STAG9999
.
STAG2400  UNPACK    DIM127,D1,ANS,DIM127   * Output search session keys
          MOVE      ZERO,F1
          MOVE      ANS,F1 
.
          IF        F1>6
            GOTO    STAG9999
          ENDIF
.
          WRITE     HTMLFILE;MULTSRCH[F1];
          GOTO      STAG9999
.
STAG2500  CALL      SERTAB00                * Show master series booking list
          GOTO      STAG9999
.
STAG2600  CALL      SERBOK00                * Show all bookings for a series 
          GOTO      STAG9999
.
STAG2700  WRITE     HTMLFILE;SERIFLAG;
          GOTO      STAG9999
.
STAG2800  UNPACK    DIM127,ANS,KEY1,DIM127
          MATCH     SP70,SRCHCLID
          GOTO      STAG9999 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,STAG2810
.
          PACK      KEY20,WBSESIT,SRCHCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,STAG9999
.
          MATCH     OCASITE,WBSESIT
          GOTO      STAG9999 IF NOT EQUAL
.
          MATCH     OCACLIN,SRCHCLID
          GOTO      STAG9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      STAG9999
.
STAG2810  WRITE     HTMLFILE;SRCHCLID;
          GOTO      STAG9999
.
STAG2900  WRITE     HTMLFILE;SRCHCARE;
          GOTO      STAG9999
.
STAG3000  WRITE     HTMLFILE;REFRLVIS;
          GOTO      STAG9999
.
STAG3100  MATCH     SP70,SRCHDATF
          GOTO      STAG9999 IF EQUAL
.
          UNPACK    SRCHDATF,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      STAG9999
.
STAG3200  MOVE      ONE,FRSTREAD
          PACK      KEY15,OBASITE,OBACTYP,SP70
          CALL      RSOTCCT1
STAG3201  CALL      RKOTCCT1
          IF        OVRCD=1
            IF        FRSTREAD=1
              GOTO      STAG3202
            ELSE
              GOTO      STAG9999
            ENDIF
          ENDIF
.
          MATCH     OBASITE,OTCCSITE
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      STAG3202
            ELSE
              GOTO      STAG9999
            ENDIF
          ENDIF
.
          MATCH     OBACTYP,OTCCCTYP
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      STAG3202
            ELSE
              GOTO      STAG9999
            ENDIF
          ENDIF
.
          PACK      KEY5,CATgb,OTCCCONT
          CALL      RDCODE1
.
          MATCH     "A",PTCOACTV
          GOTO      STAG3201 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value='",OTCCCONT,"'>",TDESC,"</option>";
          MOVE      ZERO,FRSTREAD
          GOTO      STAG3201
.
STAG3202  MOVE      CATgb,CATEGORY
          CALL      CODSEL00
          GOTO      STAG9999
.
STAG3300  MOVE      "CT",CATEGORY
          MOVE      FILTLOCA,CODE
          CALL      CODITM00
          GOTO      STAG9999
.
STAG3400  WRITE     HTMLFILE;CLOSEREF;
          GOTO      STAG9999
.
STAG3500  MATCH     SP70,REFRLVIS
          GOTO      STAG9999 IF EQUAL
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,STAG9999
          WRITE     HTMLFILE;ALRERDAT;      * Referral date
          GOTO      STAG9999
.
STAG3600  MATCH     SP70,REFRLVIS
          GOTO      STAG9999 IF EQUAL
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,STAG9999
          WRITE     HTMLFILE;ALREREXP;      * Referral expiry date
          GOTO      STAG9999
.
STAG9999  RETURN
.
.*******************************************************************************
. Select outpatient sessions. User the most appropriate key according to 
. the filters selected
.*******************************************************************************
SRCH0000  MATCH     "5",SRCHFTYP            * Using search date template
          GOTO      SRCH1000 IF NOT EQUAL
.
          MATCH     "1",SRCHCARE            * Template search by care team
          GOTO      SRCH0500 IF EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SRCH9999 IF EQUAL
.
          MATCH     SP70,SRCHCLTY
          GOTO      SRCH9999 IF EQUAL
.  
SRCH0500  CALL      SRCC0000                * Search by template dates
.
          CALL      EOSR0000                * End of search results line
          GOTO      SRCH9999
.
SRCH1000  MATCH     "1",SRCHCARE            * Search by care team
          GOTO      SRCH1500 IF EQUAL
.
          MATCH     SP70,SRCHCLID
          GOTO      SRCH5000 IF EQUAL
.
SRCH1500  CALL      SRCA0000                * Site/Clinic/Date/Start
.
          CALL      EOSR0000                * End of search results line
          GOTO      SRCH9999
.
SRCH5000  MATCH     SP70,SRCHCLTY
          GOTO      SRCH9999 IF EQUAL
.
          CALL      SRCB0000                * Site/Clinic Type/Date/Clinic/Start
          CALL      EOSR0000                * End of search results line
.
SRCH9999  RETURN
.*******************************************************************************
. Get Outpatient Sessions for a Range - By clinic id
.*******************************************************************************
SRCA0000  MATCH     SP70,SRCHDATF
          GOTO      SRCA9999 IF EQUAL
.
          MATCH     SP70,SRCHDATT
          GOTO      SRCA9999 IF EQUAL
.
          MOVE      ZERO,RECCNT
          MOVE      SP70,BOOKDATE
.
SRCA1000  CALL      ADAT0000                * Calculate next booking date
          BRANCH    EXIT,SRCA9999
.
          MATCH     "1",SRCHCARE
          IF        @EQUAL
            CALL      SHWC0000              * Display available sessions
            BRANCH    EXIT,SRCA9999         * by care team
          ELSE
            CALL      SHWA0000              * Display available sessions
            BRANCH    EXIT,SRCA9999
          ENDIF
.
          GOTO      SRCA1000
.
SRCA9999  RETURN
.*******************************************************************************
. Get Outpatient Sessions for a Range - By clinic type
.*******************************************************************************
SRCB0000  MATCH     SP70,SRCHDATF
          GOTO      SRCB9999 IF EQUAL
.
          MATCH     SP70,SRCHDATT
          GOTO      SRCB9999 IF EQUAL
.
          MOVE      ZERO,RECCNT
          MOVE      SP70,BOOKDATE
.
SRCB1000  CALL      ADAT0000                * Calculate next booking date
          BRANCH    EXIT,SRCB9999
.
          CALL      SHWB0000                * Display available sessions
          BRANCH    EXIT,SRCB9999
.
          GOTO      SRCB1000
.
SRCB9999  RETURN
.*******************************************************************************
. Get Outpatient Sessions for the selected template dates
.*******************************************************************************
SRCC0000  MOVE      ZERO,RECCNT
          MOVE      SP70,BOOKDATE
          MOVE      ZERO,COUNTDAT
.
SRCC1000  ADD       ONE,COUNTDAT
.
          COMPARE   FORTY5,COUNTDAT        * Array limit reached
          GOTO      SRCC9000 IF NOT LESS
        
          MATCH     SP70,DATESRCH[COUNTDAT]
          GOTO      SRCC9999 IF EQUAL
.
          MOVE      DATESRCH[COUNTDAT],BOOKDATE
.
          MATCH     "1",SRCHCARE
          IF        @EQUAL
            CALL      SHWC0000              * Display available sessions
            BRANCH    EXIT,SRCC9999         * by care team
          ELSE
            CALL      SHWA0000              * Display available sessions
            BRANCH    EXIT,SRCC9999
          ENDIF
.
          GOTO      SRCC1000
.
SRCC9000  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=11 align=center>":
                                 "Search Limit Reached</td>"
 
SRCC9999  RETURN
.
.*******************************************************************************
. Calculate the next booking date to search for available appointments on
.*******************************************************************************
ADAT0000  MATCH     SP70,BOOKDATE           * Get next date to search
          GOTO      ADAT1000 IF NOT EQUAL
.
          MATCH     "99000101",SRCHDATF
          GOTO      ADAT9500 IF NOT LESS  * Search from > 01 Jan 9900
.
          MATCH     "2",SRCHFTYP            *Weekly
          IF        @EQUAL
            MOVE      SRCHDATF,BOOKDATE
            MOVE      BOOKDATE,ENDBDATE
            ADD       SIX,ENDBDATE          * Add 6 days to get weekly to date
            GOTO      ADAT8000
          ENDIF
.
          MATCH     "3",SRCHFTYP            * Monthly
          IF        @EQUAL
            UNPACK    SRCHDATF,CCENT,CYEAR,CMON,CDAY
            MOVE      "01",D2
            PACK      BOOKDATE,CCENT,CYEAR,CMON,D2
            GOTO      ADAT4100
          ENDIF
.
          MATCH     "4",SRCHFTYP            * Yearly
          IF        @EQUAL
            UNPACK    SRCHDATF,CCENT,CYEAR,CMON,CDAY
            MOVE      "01",D2
            PACK      BOOKDATE,CCENT,CYEAR,SRCHCYCL,D2
            GOTO      ADAT5100
          ENDIF
.
          MOVE      SRCHDATF,BOOKDATE
          GOTO      ADAT8000
.
ADAT1000  MOVE      ZERO,F1
          MOVE      SRCHFTYP,F1
.
          BRANCH    F1,ADAT2000,ADAT3000,ADAT4000,ADAT5000
.                      Daily    Weekly   Monthly  Yearly
          GOTO      ADAT9500
.
ADAT2000  MOVE      ZERO,F2                 * Daily - Add number of days
          SQUEEZE   SRCHCYCL                * 1,2,3,4,5,6,7
          MOVE      SRCHCYCL,F2
.
          COMPARE   ZERO,F2
          GOTO      ADAT9500 IF EQUAL
.
          ADD       F2,BOOKDATE
          GOTO      ADAT8000
.
ADAT3000  MOVE      ZERO,F1                 * Weekly
          SQUEEZE   SRCHCYCL      
          MOVE      SRCHCYCL,F2
.
          IF        F2=1
            ADD       SEVEN,BOOKDATE        * 1 Week
            MOVE      BOOKDATE,ENDBDATE
            ADD       SIX,ENDBDATE          * Add 6 days to get weekly to date
            GOTO      ADAT8000              
          ENDIF
.
          IF        F2=2
            ADD       TEN4,BOOKDATE         * 2nd Week
            MOVE      BOOKDATE,ENDBDATE
            ADD       SIX,ENDBDATE          * Add 6 days to get weekly to date
            GOTO      ADAT8000              
          ENDIF
.
          IF        F2=3
            ADD       TWENTY1,BOOKDATE      * 3rd Week
            MOVE      BOOKDATE,ENDBDATE
            ADD       SIX,ENDBDATE          * Add 6 days to get weekly to date
            GOTO      ADAT8000              
          ENDIF
.
          IF        F2=4
            ADD       TWENTY8,BOOKDATE      * 4th Week
            MOVE      BOOKDATE,ENDBDATE
            ADD       SIX,ENDBDATE          * Add 6 days to get weekly to date
            GOTO      ADAT8000              
          ENDIF
.
          GOTO      ADAT9500
.
ADAT4000  MOVE      ZERO,F1                 * Monthly
          SQUEEZE   SRCHCYCL
          MOVE      SRCHCYCL,F2
.
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,MM
          ADD       F2,MM                   * If after december go to next year
          IF        MM>=13
            PACK      D4,CCENT,CYEAR
            MOVE      D4,F4
            ADD       ONE,F4
            MOVE      F4,D4
            UNPACK    D4,CCENT,CYEAR
            SUB       TEN2,MM
          ENDIF
.
          MOVE      "01",CDAY               * Set to 1st of month
          MOVE      MM,CMON
          PACK      BOOKDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BOOKDATE
.
ADAT4100  UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK                *1=Mon,2=Tue,3=Wed.....7=Sun
.
          MOVE      SRCHDAYS,F1             * Start at the first day that
          COMPARE   F1,WEEKDAY              * matches the day. eg Mon = Mon
          IF        !@EQUAL
            ADD       ONE,BOOKDATE
            GOTO      ADAT4100
          ENDIF
.
          MATCH     "1",SRCHFRST            * Add days to get the correct 
          GOTO      ADAT8000 IF EQUAL       * occurance of week,eg 1st,2nd..5th
.
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,SAVMONTH           * Save current month to validate
          MOVE      BOOKDATE,SAVBDATE       * occurance cycle

          MATCH     "2",SRCHFRST            * Add to get 2nd monthly occurance
          IF        @EQUAL
            ADD       SEVEN,BOOKDATE
          ENDIF
.
          MATCH     "3",SRCHFRST            * Add to get 3rd monthly occurance
          IF        @EQUAL
            ADD       TEN4,BOOKDATE
          ENDIF
.
          MATCH     "4",SRCHFRST            * Add to get 4th monthly occurance
          IF        @EQUAL
            ADD       TWENTY1,BOOKDATE
          ENDIF
.
          MATCH     "5",SRCHFRST            * Add to get 5th monthly occurance
          IF        @EQUAL
            ADD       TWENTY8,BOOKDATE
          ENDIF
.
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SAVMONTH,CMON
          IF        !@EQUAL
            MOVE      SAVBDATE,BOOKDATE     * Check to see if occurance calc has
            GOTO      ADAT0000              * passed this month. If so go to
          ENDIF                             * next date cycle
.
          GOTO      ADAT8000
.
ADAT5000  UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY    * Yearly
          PACK      D4,CCENT,CYEAR
          MOVE      D4,F4
          ADD       ONE,F4
          MOVE      F4,D4
          UNPACK    D4,CCENT,CYEAR          * Add one year and get next date
.
          MOVE      "01",CDAY
          PACK      BOOKDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",BOOKDATE
.
ADAT5100  UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK                *1=Mon,2=Tue,3=Wed.....7=Sun
.
          MOVE      SRCHDAYS,F1             * Start at the first day that
          COMPARE   F1,WEEKDAY              * matches the day. eg Mon = Mon
          IF        !@EQUAL
            ADD       ONE,BOOKDATE
            GOTO      ADAT5100
          ENDIF
.
          MATCH     "1",SRCHFRST            * Add days to get the correct
          GOTO      ADAT8000 IF EQUAL       * day of week. eg 1st,2nd..5th
.
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,SAVMONTH           * Save current month
          MOVE      BOOKDATE,SAVBDATE

          MATCH     "2",SRCHFRST            * Add to get 2nd monthly occurance
          IF        @EQUAL
            ADD       SEVEN,BOOKDATE
          ENDIF
.
          MATCH     "3",SRCHFRST            * Add to get 3rd monthly occurance
          IF        @EQUAL
            ADD       TEN4,BOOKDATE
          ENDIF
.
          MATCH     "4",SRCHFRST            * Add to get 4th monthly occurance
          IF        @EQUAL
            ADD       TWENTY1,BOOKDATE
          ENDIF
.
          MATCH     "5",SRCHFRST            * Add to get 5th monthly occurance
          IF        @EQUAL
            ADD       TWENTY8,BOOKDATE
          ENDIF
.
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SAVMONTH,CMON         
          IF        !@EQUAL
            MOVE      SAVBDATE,BOOKDATE     * Check to see if occurance calc has
            GOTO      ADAT0000              * passed this month. If so go to
          ENDIF                             * next date cycle
.
          GOTO      ADAT8000
.
ADAT8000  MATCH     SRCHDATF,BOOKDATE
          GOTO      ADAT0000 IF LESS
.
          MATCH     BOOKDATE,SRCHDATT       * Next date is after to date
          GOTO      ADAT9500 IF LESS
.
          WRITE     HTMLFILE;"<!--",BOOKDATE,"-->"
.
          MATCH     "99000101",BOOKDATE
          GOTO      ADAT9500 IF NOT LESS  * Search from > 01 Jan 9900
. 
ADAT9000  MOVE      ZERO,EXIT
          GOTO      ADAT9999
.
ADAT9500  MOVE      ONE,EXIT
          GOTO      ADAT9999
.
ADAT9999  RETURN
.
.*******************************************************************************
.                    Show available sessions for a Range
.*******************************************************************************
SHWA0000  MOVE      ZERO,EXIT 
          PACK      KEY25,WBSESIT,SRCHCLID,BOOKDATE,SP70
          CALL      RDSSESA1
SHWA1000  CALL      RDKSESA1
          BRANCH    OVRCD,SHWA9000
.
          MATCH     OSECLIN,SRCHCLID
          GOTO      SHWA9000 IF NOT EQUAL
.
          CALL      CDAT0000               * Check date range for search option
          BRANCH    EXIT,SHWA9000,SHWA1000
. 
          MOVE      ZERO,SESSFULL
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      CAVL0000               * Check if there are empty slots
          IF        EXIT=1
            MOVE      ONE,SESSFULL
            MOVE      ZERO,EXIT
          ENDIF
.
          CALL      CBOK0000               * Check if U/R already has a booking
.                                          * in this session
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SHWA1000
          BRANCH    OMASTAT,SHWA1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SHWA1000
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      SHWA1000 IF LESS
.
          CALL      CPUB0000               * Check public holiday range
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL         * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF

          BRANCH    MOSAIQCL,SHWA1000      * MOSAIQ Clinic
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      SHWA1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,REFRLVIS         * Check if referral populated when
            GOTO      SHWA1000 IF EQUAL     * referral is mandatory
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,SHWA1000
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SHWA1000
.
SHWA1100  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.         
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MOVE      "seribkey",KEY8  
          PACK      SESSNCGI,KEY8,DRECCNT,SP70
.
          MOVE      "seribtim",KEY8  
          PACK      SESSTCGI,KEY8,DRECCNT,SP70
.
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr bgcolor=red><td nowrap align=left>&nbsp;";
          ELSE
            IF        PUBLICFL=1
              WRITE     HTMLFILE;"<tr bgcolor=#a0b8c8>":
                                 "<td nowrap align=left>&nbsp;";
            ELSE
              WRITE     HTMLFILE;"<tr><td nowrap align=left>&nbsp;";
            ENDIF
          ENDIF
.
          IF        SESSFULL=0
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif ":
                               "class=Icon onclick=#"SearchSes":
                               "('",SESSKEYS,"',",SESSNCGI,",",SESSTCGI,");#">";
.
            WRITE     HTMLFILE;"<input type=hidden name=serisess",DRECCNT:
                               " id=serisess",DRECCNT:
                               " value='",SESSKEYS,"'>"
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DAYNAM3,"</td>":
                             "<td>&nbsp;",OSESTRT,"</td>":
                             "<td>&nbsp;",OCTDESC,"</td>":
                             "<td>&nbsp;",OCADESC,"</td>":
                             "<td><input type=hidden ":
                             "name=seribkey",DRECCNT:
                             " id=seribkey",DRECCNT,">":
                             "<input type=text class=Readonly readonly ":
                             "size=7 name=seribtim",DRECCNT:
                             " id=seribtim",DRECCNT:
                             " </td>":
                             "<td>&nbsp;",HASBTIME,"</td>";
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
.
          MATCH     "0",SHOWCNTF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",OSESSLTN,"</td>":        * Standard
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSESSLTR,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",OEMPTY,"</td>":          * RCH
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>":
                               "<td>&nbsp;",OSEBSPC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          COMPARE   NORECORD,RECCNT
          IF        @EQUAL
            WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=11 align=center>":
                                 "Search Limit Reached</td>"
            GOTO      SHWA9100
          ENDIF
          GOTO      SHWA1000
.
SHWA9000  MOVE      ZERO,EXIT
          GOTO      SHWA9999
.
SHWA9100  MOVE      ONE,EXIT
          GOTO      SHWA9999
.
SHWA9999  RETURN
.
.*******************************************************************************
.                    Show available sessions for a Range
.*******************************************************************************
SHWB0000  MOVE      ZERO,EXIT
          PACK      KEY31,WBSESIT,SRCHCLTY,BOOKDATE,SRCHCLID,SP70
          CALL      RDSSESA4
SHWB1000  CALL      RDKSESA4
          BRANCH    OVRCD,SHWB9000
.
          MATCH     OSESCTYP,SRCHCLTY
          GOTO      SHWB9000 IF NOT EQUAL
.
          CALL      CDAT0000               * Check date range for search option
          BRANCH    EXIT,SHWB9000,SHWB1000
.
          MOVE      ZERO,SESSFULL
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      CAVL0000               * Check if there are empty slots
          IF        EXIT=1
            MOVE      ONE,SESSFULL
            MOVE      ZERO,EXIT
          ENDIF
.
.
          CALL      CBOK0000               * Check if U/R already has a booking
.                                          * in this session
          MATCH     SP70,SRCHCLID
          IF        !@EQUAL
            MATCH     OSECLIN,SRCHCLID
            GOTO      SHWB1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SHWB1000
          BRANCH    OMASTAT,SHWB1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SHWB1000
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      SHWB1000 IF LESS
.
          CALL      CPUB0000               * Check public holiday range
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF

          BRANCH    MOSAIQCL,SHWB1000       * MOSAIQ Clinic
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,REFRLVIS         * Check if referral populated when
            GOTO      SHWB1000 IF EQUAL     * referral is mandatory
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,SHWB1000
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SHWB1000
.
SHWB1100  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MOVE      "seribkey",KEY8
          PACK      SESSNCGI,KEY8,DRECCNT,SP70
.
          MOVE      "seribtim",KEY8
          PACK      SESSTCGI,KEY8,DRECCNT,SP70
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr bgcolor=red><td nowrap align=left>&nbsp;";
          ELSE
            IF        PUBLICFL=1
              WRITE     HTMLFILE;"<tr bgcolor=#a0b8c8>":
                                 "<td nowrap align=left>&nbsp;";
            ELSE
              WRITE     HTMLFILE;"<tr><td nowrap align=left>&nbsp;";
            ENDIF
          ENDIF
.
          IF        SESSFULL=0
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif ":
                               "class=Icon onclick=#"SearchSes":
                               "('",SESSKEYS,"',",SESSNCGI,",",SESSTCGI,");#">";
            WRITE     HTMLFILE;"<input type=hidden name=serisess",DRECCNT:
                               " id=serisess",DRECCNT:
                               " value='",SESSKEYS,"'>"
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DAYNAM3,"</td>":
                             "<td>&nbsp;",OSESTRT,"</td>":
                             "<td>&nbsp;",OCTDESC,"</td>":
                             "<td>&nbsp;",OCADESC,"</td>":
                             "<td><input type=hidden ":
                             "name=seribkey",DRECCNT:
                             " id=seribkey",DRECCNT,">":
                             "<input type=text class=Readonly readonly ":
                             "size=7 name=seribtim",DRECCNT:
                             " id=seribtim",DRECCNT:
                             " </td>":
                             "<td>&nbsp;",HASBTIME,"</td>";
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
.
          MATCH     "0",SHOWCNTF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",OSESSLTN,"</td>":        * Standard
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSESSLTR,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",OEMPTY,"</td>":          * RCH
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>":
                               "<td>&nbsp;",OSEBSPC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          COMPARE   NORECORD,RECCNT
          IF        @EQUAL
            WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=11 align=center>":
                                 "Search Limit Reached</td>"
            GOTO      SHWB9100
          ENDIF
          GOTO      SHWB1000
.
SHWB9000  MOVE      ZERO,EXIT
          GOTO      SHWB9999
.
SHWB9100  MOVE      ONE,EXIT
          GOTO      SHWB9999
.
SHWB9999  RETURN
.
.*******************************************************************************
.                    Show available sessions for a Range by care team
.*******************************************************************************
SHWC0000  MOVE      ZERO,EXIT
          PACK      KEY25,BOOKDATE,SP70
          CALL      RDSSESA2
SHWC1000  CALL      RDKSESA2
          BRANCH    OVRCD,SHWC9000
.
          CALL      CDAT0000               * Check date range for search option
          BRANCH    EXIT,SHWC9000,SHWC1000
.
          MATCH     WBSESIT,OSESITE
          GOTO      SHWC1000 IF NOT EQUAL
.
          MOVE      ZERO,SESSFULL
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      CAVL0000               * Check if there are empty slots
          IF        EXIT=1
            MOVE      ONE,SESSFULL
            MOVE      ZERO,EXIT
          ENDIF
.
          CALL      CBOK0000               * Check if U/R already has a booking
.                                          * in this session
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SHWC1000
          BRANCH    OMASTAT,SHWC1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SHWC1000
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      SHWC1000 IF LESS
.
          CALL      CPUB0000               * Check public holiday range
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL         * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF

          BRANCH    MOSAIQCL,SHWC1000      * MOSAIQ Clinic
.
          MATCH     SP70,SRCHCLTY
          IF        !@EQUAL
            MATCH     OTHECTYP,SRCHCLTY
            GOTO      SHWC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,REFRLVIS         * Check if referral populated when
            GOTO      SHWC1000 IF EQUAL     * referral is mandatory
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,SHWC1000
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SHWC1000
.
SHWC1100  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",SRCHCARE
          IF        @EQUAL
            CALL      CCAR0000                * Check care team details
            BRANCH    EXIT,SHWC1000
          ENDIF
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MOVE      "seribkey",KEY8
          PACK      SESSNCGI,KEY8,DRECCNT,SP70
.
          MOVE      "seribtim",KEY8
          PACK      SESSTCGI,KEY8,DRECCNT,SP70
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr bgcolor=red><td nowrap align=left>&nbsp;";
          ELSE
            IF        PUBLICFL=1
              WRITE     HTMLFILE;"<tr bgcolor=#a0b8c8>":
                                 "<td nowrap align=left>&nbsp;";
            ELSE
              WRITE     HTMLFILE;"<tr><td nowrap align=left>&nbsp;";
            ENDIF
          ENDIF
.
          IF        SESSFULL=0
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif ":
                               "class=Icon onclick=#"SearchSes":
                               "('",SESSKEYS,"',",SESSNCGI,",",SESSTCGI,");#">";
            WRITE     HTMLFILE;"<input type=hidden name=serisess",DRECCNT:
                               " id=name=serisess",DRECCNT:
                               " value='",SESSKEYS,"'>"
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DAYNAM3,"</td>":
                             "<td>&nbsp;",OSESTRT,"</td>":
                             "<td>&nbsp;",OCTDESC,"</td>":
                             "<td>&nbsp;",OCADESC,"</td>":
                             "<td><input type=hidden ":
                             "name=seribkey",DRECCNT:
                             " id=seribkey",DRECCNT,">":
                             "<input type=text class=Readonly readonly ":
                             "size=7 name=seribtim",DRECCNT:
                             " id=seribtim",DRECCNT:
                             " </td>":
                             "<td>&nbsp;",HASBTIME,"</td>";
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
.
          MATCH     "0",SHOWCNTF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",OSESSLTN,"</td>":        * Standard
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSESSLTR,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",OEMPTY,"</td>":          * RCH
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>":
                               "<td>&nbsp;",OSEBSPC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          COMPARE   NORECORD,RECCNT
          IF        @EQUAL
            WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=11 align=center>":
                                 "Search Limit Reached</td>"
            GOTO      SHWC9100
          ENDIF
          GOTO      SHWC1000
.
SHWC9000  MOVE      ZERO,EXIT
          GOTO      SHWC9999
.
SHWC9100  MOVE      ONE,EXIT
          GOTO      SHWC9999
.
SHWC9999  RETURN
.
.*******************************************************************************
. Check to see if there are available appointments in this session
.*******************************************************************************
CAVL0000  PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CAVL1000  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CAVL9000          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CAVL9000 IF NOT EQUAL   * different session
.
          COMPARE   ZERO,OBASTAT
          GOTO      CAVL1000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CAVL9999
.
CAVL9000  MOVE      ONE,EXIT
          GOTO      CAVL9999
.
CAVL9999  RETURN
.
.*******************************************************************************
. Check to see if this patient has a booking in this session        
.*******************************************************************************
CBOK0000  MOVE      ZERO,HASBFLAG
          MOVE      SP70,HASBTIME
          PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
CBOK1000  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CBOK9999          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      CBOK9999 IF NOT EQUAL   * different session
.
          MATCH     URNUMBER,OBAURNO
          GOTO      CBOK9000 IF EQUAL
.
          GOTO      CBOK1000
.
CBOK9000  MOVE      ONE,HASBFLAG
          MOVE      OBATIME,HASBTIME
          GOTO      CBOK9999
.
CBOK9999  RETURN
.
.------------------------------------------------------------
. Check date range and session day according to search type
.------------------------------------------------------------
CDAT0000  MATCH     "2",SRCHFTYP            * Weekly so check days for date 
          GOTO      CDAT5000 IF EQUAL       * range
. 
          MATCH     OSEDATE,BOOKDATE
          GOTO      CDAT9100 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CDAT9999
.
CDAT5000  MATCH     OSEDATE,ENDBDATE
          GOTO      CDAT9100 IF LESS
.
          MATCH     "1",SRCHMOND
          IF        @EQUAL
            COMPARE    ONE,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHTUES
          IF        @EQUAL
            COMPARE    TWO,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHWEDN
          IF        @EQUAL
            COMPARE    THREE,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHTHUR
          IF        @EQUAL
            COMPARE    FOUR,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHFRID
          IF        @EQUAL
            COMPARE    FIVE,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHSATU
          IF        @EQUAL
            COMPARE    SIX,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          MATCH     "1",SRCHSUND
          IF        @EQUAL
            COMPARE    SEVEN,OSEDAY
            GOTO       CDAT9000 IF EQUAL
          ENDIF
.
          GOTO      CDAT9500
. 
CDAT9000  MOVE      ZERO,EXIT           * Ok to select this session
          GOTO      CDAT9999
.
CDAT9100  MOVE      ONE,EXIT            * End session search for this date
          GOTO      CDAT9999
.
CDAT9500  MOVE      TWO,EXIT            * Skip this day but continue search
          GOTO      CDAT9999
.
CDAT9999  RETURN
.
.------------------------------------------------------------
. Check for Master Suspension
.------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
CHKSUS10  CALL      RPOTMSP1
          BRANCH    OVRCD,CHKSUS99
          MATCH     OSESITE,OTMSSITE
          GOTO      CHKSUS99 IF NOT EQUAL
          MATCH     OSECLIN,OTMSCLIN
          GOTO      CHKSUS99 IF NOT EQUAL
          MOVE      OSEDAY,KEY1
          MATCH     KEY1,OTMSDOWK
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     OSESTRT,OTMSSTIM             * Same session start time
          GOTO      CHKSUS10 IF NOT EQUAL
.
.         MATCH     SP70,OTMSTDAT
.         IF        !@EQUAL
.           MATCH     OTMSTDAT,OSEDATE           * ????????????
.           GOTO      CHKSUS10 IF LESS
.         ENDIF
.
          MATCH     OTMSFDAT,OSEDATE
          GOTO      CHKSUS10 IF LESS
          GOTO      CHKSUS20 IF EQUAL
.
          MATCH     OSEDATE,OTMSTDAT
          GOTO      CHKSUS10 IF LESS
.
CHKSUS20  MOVE      ONE,EXIT
.
CHKSUS99  RETURN
.
.
.*******************************************************************************
.                         Show Booking Details
.*******************************************************************************
SERS0000  MATCH     SP70,UPDTTYPE
          GOTO      SERS5000 IF EQUAL
.
          GOTO      SERS9000

SERS5000 
.
SERS8000  MOVE      "Series Bookings",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,SERS9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      SERS9999
.
SERS9000  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERS9999
.
SERS9999  RETURN
.
.*******************************************************************************
. Show available appointments for a multiple session search
.*******************************************************************************
MULAVL00  MOVE      ZERO,F1
          MOVE      ZERO,FMULTCNT
.
MULAVL10  ADD       ONE,F1
          IF        F1>6
            GOTO      MULAVL99
          ENDIF

          MATCH     SP70,MULTSRCH[F1]
          GOTO      MULAVL99 IF EQUAL
.
          MOVE      MULTSRCH[F1],SESSKEYS
.
          CALL      SMULTB00                * Show Available appointments
.
          GOTO      MULAVL10
.
MULAVL99  RETURN
.
.*******************************************************************************
. Show available appointments for a multiplate HCP session search
.*******************************************************************************
SMULTB00  PACK      SESSKEYS,SESSKEYS,SP70
.
          ASSIGN   (100/MULTSEND),F2
.
          WRITE     HTMLFILE;"<td valign=top width=",F2,"%>":
                             "<table cellspacing=0 cellpadding=2 border=1 ":
                             "width=100% align=center >":
                             "<input type=hidden name=multsrch ":
                             "value='",SESSKEYS,"'>"
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SMULTB90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SMULTB90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SMULTB90
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SMULTB90
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SMULTB90
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;*+,"<tr><td class=HeadingCell width=50%":
                             ">",OCADESC,"</td>":
                             "<td class=HeadingCell width=50%":
                             ">",OCTDESC,"</td></tr>":
                             "<tr><td class=HeadingCell>",DISPDAT1,"</td>":
                             "<td class=HeadingCell>",OSESTRT,"</td></tr>":
                             "<tr><td class=HeadingCell>Time</td>":
                             "<td class=HeadingCell>Visit Type</td></tr>";
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
SMULTB10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,SMULTB90          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      SMULTB90 IF NOT EQUAL   * different sessio
.
          MOVE      ZERO,RESERVED
          MOVE      ZERO,HASBFLAG
          MATCH     URNUMBER,OBAURNO
          IF        @EQUAL
            MOVE      ONE,HASBFLAG
            GOTO      SMULTB20
          ENDIF
.
          COMPARE   NINE,OBASTAT            * Is this slot reserved
          GOTO      SMULTB15 IF NOT EQUAL
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      RDOTSRV1                * Check if this slot is reserved
          BRANCH    OVRCD,SMULTB20
.
          MATCH     USERID,OTSRWEBU         * Was this reserved by the same user
          GOTO      SMULTB10 IF NOT EQUAL
.
          MOVE      ONE,RESERVED
          GOTO      SMULTB20
.
SMULTB15  COMPARE   ZERO,OBASTAT
          GOTO      SMULTB10 IF NOT EQUAL
.
SMULTB20  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr height=25 bgcolor=red><td nowrap>&nbsp;":
                               "<img src=../images/AppointmentIcon.gif":
                               " class=Icon":
                               " onclick=#"SelectMultApp('",CASEKEYS,"');#">":
                               "&nbsp;",OBATIME,"</td>":
                               "<td>",TDESC,"</td></tr>"
            GOTO      SMULTB10
          ENDIF
.
          IF        RESERVED=1
            ADD       ONE,FMULTCNT
            MOVE      FMULTCNT,DMULTCNT
            REP       " 0",DMULTCNT
.
            WRITE     HTMLFILE;"<tr height=25 bgcolor=darkturquoise>":
                               "<td nowrap>&nbsp;":
                               "<input type=hidden ":
                               "name=seribsrt",DMULTCNT:
                               " value='",OBADATE,OBATIME,"'>":
                               "<input type=hidden ":
                               "name=seribkey",DMULTCNT:
                               " id=seribkey",DMULTCNT:
                               " value='",CASEKEYS,"'>":
                               "<img src=../images/AppointmentIcon.gif":
                               " class=Icon":
                    " onclick=#"SelectMultSes('",CASEKEYS,"');#">":
                               "&nbsp;",OBATIME," - Reserved ":
                               "<img src=../images/erase.gif":
                               " class=Icon": 
                    " onclick=#"cancelSlot('",CASEKEYS,"',DisplayPage);#">":
                               "</td><td>",TDESC:
                               "</td></tr>"
            GOTO      SMULTB10
          ENDIF
.
          WRITE     HTMLFILE;"<tr height=25><td nowrap>&nbsp;":
                             "<img src=../images/AppointmentIcon.gif":
                             " class=Icon":
                  " onclick=#"checkReservation('",CASEKEYS,"');#">":
                              "&nbsp;",OBATIME,"</td>":
                              "<td>",TDESC,"</td></tr>"
.
          GOTO      SMULTB10
.
SMULTB90  WRITE     HTMLFILE;"</table></td>";
.
SMULTB99  RETURN
.
.*******************************************************************************
. Show available appointments for a session
.*******************************************************************************
SAVAIL00  PACK      SESSKEYS,SESSKEYS,SP70
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SAVAIL99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SAVAIL99
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SAVAIL99
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SAVAIL99
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>",OCADESC,"</td>":
                             "<td class=HeadingCell>",OCTDESC,"</td>":
                             "<tr><td class=HeadingCell>",DISPDAT1,"</td>":
                             "<td class=HeadingCell>",OSESTRT,"</td>":
                             "<tr><td class=HeadingCell>Time</td>":
                             "<td class=HeadingCell>Visit Type</td>":
                             "</tr>"
 
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
SAVAIL10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,SAVAIL99          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      SAVAIL99 IF NOT EQUAL   * different sessio
.
          MOVE      ZERO,RESERVED
          MOVE      ZERO,HASBFLAG
          MATCH     URNUMBER,OBAURNO
          IF        @EQUAL
            MOVE      ONE,HASBFLAG
            GOTO      SAVAIL20
          ENDIF
.
          COMPARE   NINE,OBASTAT            * Is this slot reserved
          GOTO      SAVAIL15 IF NOT EQUAL
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      RDOTSRV1                * Check if this slot is reserved
          BRANCH    OVRCD,SAVAIL20
.
          MATCH     USERID,OTSRWEBU         * Was this reserved by the same user
          GOTO      SAVAIL10 IF NOT EQUAL
.
          MOVE      ONE,RESERVED
          GOTO      SAVAIL20
.
SAVAIL15  COMPARE   ZERO,OBASTAT
          GOTO      SAVAIL10 IF NOT EQUAL
.
SAVAIL20  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr bgcolor=red><td nowrap>&nbsp;":
                             "&nbsp;",OBATIME,"</td>":
                             "<td>",TDESC,"</td></tr>"
            GOTO      SAVAIL10
          ENDIF
.
          IF        RESERVED=1
            WRITE     HTMLFILE;"<tr bgcolor=darkturquoise><td nowrap>&nbsp;":
                               "<img src=../images/AppointmentIcon.gif":
                               " class=Icon":
                       " onclick=#"SelectSes('",CASEKEYS,"','",OBATIME,"');#">":
                               "&nbsp;",OBATIME:
                               "<img src=../images/erase.gif":
                               " class=Icon":
                    " onclick=#"cancelSlot('",CASEKEYS,"',DisplayPage);#">":
                              "</td>":
                               "<td>",TDESC,"</td></tr>"
            GOTO      SAVAIL10
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap>&nbsp;":
                             "<img src=../images/AppointmentIcon.gif":
                             " class=Icon":
                       " onclick=#"SelectSes('",CASEKEYS,"','",OBATIME,"');#">":
                             "&nbsp;",OBATIME,"</td>":
                             "<td>",TDESC,"</td></tr>"
.
          GOTO      SAVAIL10
.
SAVAIL99  RETURN
.
.*******************************************************************************
.                            New Booking Details
.*******************************************************************************
NEWBOK00  MATCH     SP70,UPDTTYPE
          GOTO      NEWBOK04 IF EQUAL
.
          GOTO      NEWBOK97
.
NEWBOK04  CALL      CLPATMAS       * Clear All Patient Details
          CALL      CLPMSPX2       * Clear All Patient Details
          MATCH     SP70,URNUMBER
          GOTO      NEWBOK05 IF EQUAL
.         IF        !@EQUAL
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,NEWBOK91
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            IF        PSTAT=1 | PSTAT=2
              MOVE      PURNO,SAVEURNO
              MOVE      PPSNAME,URNUMBER
              MOVE      ONE,MRGEFLAG
              GOTO      NEWBOK00
            ENDIF
.         ENDIF
.
NEWBOK05  CALL      CLOUTBOA       * Clear All Outpatient Details
          CALL      CLOUTBOB       * Clear All Outpatient Details
.
          MOVE      ADMISSNO,KEY8  * Get Referral Details
          CALL      RDOTRFL1
          IF        OVRCD=1
            CALL      CLOUTRFL
          ENDIF
.
          MOVE      REFRLVIS,KEY8  * Get Allied Health Referral Details
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLPMSVX1
          ELSE
            MOVE      REFRLVIS,KEY8  * Get visit extn details
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
          ENDIF
.
          MOVE      SP70,SAVDSPLC
          PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
NEWBOK07  CALL      RKDSPTL1
          BRANCH    OVRCD,NEWBOK08
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      NEWBOK08 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      NEWBOK07 IF NOT EQUAL
.
          MOVE      DSPLCODE,SAVDSPLC
.
NEWBOK08  IF        CLNEWBOK=1
            MOVE      SP70,CASEKEYS
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            MOVE      SP70,OMACIND
            GOTO      NEWBOK10
          ENDIF
.
          MOVE      CASEKEYS,SESSKEYS
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,NEWBOK92
          COMPARE   ZERO,OBASTAT
          GOTO      NEWBOK10 IF EQUAL
          COMPARE   NINE,OBASTAT
          GOTO      NEWBOK93 IF NOT EQUAL
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      NEWBOK94 IF LESS
            ELSE    
              GOTO      NEWBOK94
            ENDIF
          ENDIF   
.
          MOVE      CASEKEYS,SESSKEYS
          CALL      SESDET00
          BRANCH    EXIT,NEWBOK96
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          MOVE      CASEKEYS,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      NEWBOK95 IF NOT EQUAL    * Record isn't vacant !!
          ENDIF
          MOVE      ZERO,OBASTAT             * Make sure record isn't booked
.
NEWBOK10  MOVE      "New Appointment ",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,NEWBOK99
.
          CALL      WEBBOD00
.
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK91  MOVE      "Invalid Patient U/R ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK92  CLEAR     WEBTITLE
          APPEND    "Invalid Slot - ",WEBTITLE
          APPEND    KEY28,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK93  MOVE      "Slot Already Taken",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK94  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK95  MOVE      "Slot Reserved.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK96  MOVE      "Invalid Session key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK97  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK99  RETURN
.
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.
.*******************************************************************************
.                    Get Session Details for SESSKEYS
.*******************************************************************************
SESDET00  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
SESDET10  CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SESDET99
.
          MATCH     OCASITE,OSESITE
          GOTO      SESDET10 IF NOT EQUAL
.
          MATCH     OCACLIN,OSECLIN
          GOTO      SESDET10 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME
.
          MATCH     SP70,OCADESC
          IF        @EQUAL
            MATCH     SP70,OCADOCT
            IF        !@EQUAL
              MOVE      OCADOCT,KEY6
              CALL      RDDOCT1
              IF        OVRCD=1
                MOVE      OCADOCT,DOCFNAME
              ELSE
                MOVE      OCADOCT,DOCTCODE
                MOVE      DTITL,FMTTITLE
                MOVE      DGNAME,FMTGNAME
                MOVE      DSNAME,FMTSNAME
                CALL      DOCNM000
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SESDET99
SESDET90  MOVE      ONE,EXIT
SESDET99  RETURN
.
.------------------------------------------------------------
. Extra Outpatient Fields for Booking/Follow up/Reschedule
.------------------------------------------------------------
OEXT0000  BRANCH    FLDITMNO,OEXT0100,OEXT0200,OEXT0300,OEXT0400,OEXT0500:
                             OEXT0600,OEXT0700,OEXT0800,OEXT0900,OEXT1000:
                             OEXT1100,OEXT1200,OEXT1300,OEXT1400,OEXT1500:
                             OEXT1600,OEXT1700,OEXT1800,OEXT1900,OEXT2000: 
                             OEXT2100,OEXT2200,OEXT2300,OEXT2400,OEXT2500:
                             OEXT2600,OEXT2700,OEXT2800,OEXT2900,OEXT3000:
                             OEXT3100,OEXT3200,OEXT3300,OEXT3400,OEXT3500:
                             OEXT3600,OEXT3700,OEXT3800,OEXT3900,OEXT4000
.
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      OEXT9999
.
OEXT0100  CALL      SCODL000
          GOTO      OEXT9999
.
OEXT0200  CALL      RSHCNT00
          GOTO      OEXT9999
.
OEXT0300  WRITE     HTMLFILE;PMVXUDF1;      * PMSVX1FD (Visit Extension Table)
          GOTO      OEXT9999
.
OEXT0400  
          GOTO      OEXT9999
.
OEXT0500  CALL      GETCTY00
          GOTO      OEXT9999
.
OEXT0600  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1
          GOTO      OEXT9999
.
OEXT0700  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT0800  IF        OBASTAT=1
            WRITE     HTMLFILE;"<option value=1 selected>Booked</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=1>Booked</option>"
          ENDIF
          IF        OBASTAT=4
            WRITE     HTMLFILE;"<option value=4 selected>Attended</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=4>Attended</option>"
          ENDIF
          IF        OBASTAT=5
            WRITE     HTMLFILE;"<option value=5 selected>Did Not Attend</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=5>Did Not Attend</option>"
          ENDIF
          GOTO      OEXT9999
.
OEXT0900  WRITE     HTMLFILE;SHWPRINT;
          GOTO      OEXT9999
.
OEXT1000  
          GOTO      OEXT9999
.
OEXT1100  MOVE      "R  ",CODE
          MOVE      ZERO,VISTFLAG
          CALL      VTYSEL00
          GOTO      OEXT9999
.
OEXT1200  WRITE     HTMLFILE;OTCNOCRD;
          GOTO      OEXT9999
.
OEXT1300  WRITE     HTMLFILE;OTCNOCDD;
          GOTO      OEXT9999
.
OEXT1400  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      OEXT9999
.
OEXT1500  WRITE     HTMLFILE;NEXTSCRN;  * redirect program after extra pgm
          GOTO      OEXT9999
.
OEXT1600  WRITE     HTMLFILE;PTCNUEOC;  * Using episode of care
          GOTO      OEXT9999
.
OEXT1700  WRITE     HTMLFILE;DEPTFLAG;  * Time default flag for departure screen
          GOTO      OEXT9999
.
OEXT1800  WRITE     HTMLFILE;OTHECCAR;  * Collct Carer Contact
          GOTO      OEXT9999
.
OEXT1900  PACK      KEY8,URNUMBER,SP10
          CALL      RDPMPX21
          BRANCH    OVRCD,OEXT9999
 
          WRITE     HTMLFILE;PMPXINTR;  * Interpreter (y/n)?
          GOTO      OEXT9999 
.
OEXT2000  MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT2100  CALL      WATCOM00
          GOTO      OEXT9999
.
OEXT2200  MOVE      "NM",CATEGORY
          MOVE      OTHENMDS,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT2300  MOVE      "CC",CATEGORY
          MOVE      OTHECART,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT2400  MOVE      "sd",CATEGORY
          MOVE      OTHESRVD,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT2500  WRITE     HTMLFILE;OTHECLHR;
          GOTO      OEXT9999
.
OEXT2600  CALL      DISSEL00
          GOTO      OEXT9999
.
OEXT2700  CALL      DISCD000
          GOTO      OEXT9999
.
OEXT2800  CALL      DISDS000
          GOTO      OEXT9999
.
OEXT2900  WRITE     HTMLFILE;WAITFLAG;        * Return to Waiting list flag
          GOTO      OEXT9999
.
OEXT3000  MOVE      "NC",CATEGORY
          MOVE      OTHETCOD,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT3100  WRITE     HTMLFILE;SAVDSPLC;
          GOTO      OEXT9999
.
OEXT3200  CALL      DISSD000
          GOTO      OEXT9999
.
OEXT3300  MOVE      ZERO,F2
          MOVE      OTBBGPPT,F2
          PACK      KEY10,OTBBGPPC,SP70
          PACK      GPPCCODE,KEY10,F2
          CALL      HCGDET00                * hcp practice details
          GOTO      OEXT9999
.
OEXT3400  CALL      GETMHF00      * Get Mental Health Flag (for clinic session)
          GOTO      OEXT9999
.
OEXT3500  MOVE      "CI",CATEGORY	    
          MOVE      OTHECIND,CODE	   
          CALL      GETCOD00		
          WRITE     HTMLFILE;TCINDC1;		
          GOTO      OEXT9999		
.
OEXT3600  PACK      KEY4,SP70
          CALL      RSPRTHD1
OEXT3610  CALL      RKPRTHD1
          BRANCH    OVRCD,OEXT9999
          PACK      KEY6,QUOTE,PRTHTMID,QUOTE
          MATCH     PRTHTMID,OTMAMBST
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               PRTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">",PRTHDESC,"</option>"
          ENDIF
          GOTO      OEXT3610
.
OEXT3700  WRITE     HTMLFILE;SKIPWARN;
          GOTO      OEXT9999
.
OEXT3800  MOVE      "NC",CATEGORY         *tier2 code outma1af
          MOVE      OTMATCOD,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT3900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,OTHEPCOD
          GOTO      OEXT9999 IF EQUAL
.
          IF        F1=0
            WRITE     HTMLFILE;OTHEPCOD;  * Clinic type procedure code
          ELSE
            PACK      KEY21,OTHESITE,OTHECTYP,OTHEPCOD,SP70
            CALL      RDOTCPC1
            IF        OVRCD<>1
              WRITE     HTMLFILE;OTCPDESC; * Clinic type procedure desc
            ENDIF
          ENDIF
          GOTO      OEXT9999
.
OEXT4000  WRITE     HTMLFILE;BOOKALLA;     * Book all appointments
          GOTO      OEXT9999
.
OEXT9999  RETURN
.
.------------------------------------------------------------
. Display Comments  
.------------------------------------------------------------
WATCOM00  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      WATCOM99 IF NOT EQUAL
.         
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WATCOM10  CALL      RDKMESA1
          BRANCH    OVRCD,WATCOM99
.         
          MATCH     WMURNO,WAURNO
          GOTO      WATCOM99 IF NOT EQUAL
.
          MATCH     WMCODE,WAPROC
          GOTO      WATCOM99 IF NOT EQUAL
.
          COMPARE   WMCNT,WACNT
          GOTO      WATCOM99 IF NOT EQUAL
.
          STRIP     WATEXT
          MOVELPTR  WATEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WATEXT,VAR
          WRITE     HTMLFILE;VAR,"\n";
          SFORMAT   VAR,127
.
          GOTO      WATCOM10
WATCOM99  RETURN
.
.------------------------------------------------------------
. Visit Type Selection Options
. Category CV - Indictor 6 ="U"navailable slot type
. OVERBOOK - 0 = Do not display over bookings sloty types
. OVERBOOK - 1 = Only display over bookings sloty types
.------------------------------------------------------------
VTYSEL00  MOVE      ZERO,OVERBOOK
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH    ANSZ,TCINDC2
            IF       @EQUAL
              MOVE     ONE,OVERBOOK        * Yes only display over booking types
            ENDIF
          ENDIF
.
          MOVE      "CV",CATEGORY
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
VTYSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,VTYSEL99
.
          MATCH     CATEGORY,TCODE
          GOTO      VTYSEL99 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      VTYSEL10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      VTYSEL10 IF EQUAL
.
          IF        VISTFLAG=0
            MATCH     "U",TCINDC6           * Skip unavailable
            GOTO      VTYSEL10 IF EQUAL
.
            IF        OVERBOOK =1
              MATCH     ANSZ,TCINDC2          * Skip over bookings
              GOTO      VTYSEL10 IF NOT EQUAL
            ELSE
              MATCH     ANSZ,TCINDC2          * Skip over bookings
              GOTO      VTYSEL10 IF EQUAL
            ENDIF
          ENDIF
.
          IF        VISTFLAG=1
            MATCH     "U",TCINDC6           * Only display unavailable
            GOTO      VTYSEL10 IF NOT EQUAL
          ENDIF
.
          IF        VISTFLAG=2
            MATCH     "U",TCINDC6           * Exclude unavailable
            GOTO      VTYSEL10 IF EQUAL
.
            MATCH     ANSZ,TCINDC2          * Display over bookings for add
            GOTO      VTYSEL50 IF EQUAL
.
            MATCH     ANSN,TCINDC1          * Skip new slots
            GOTO      VTYSEL50 IF EQUAL
.
            IF        TCFORM6 > ONE
              GOTO     VTYSEL10             * Skip of not a single slot
            ENDIF
          ENDIF
.
VTYSEL50  PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY20," selected>":
                               TDESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,VTYSEL10
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY20,">",TDESC,"</option>"
          ENDIF
          GOTO      VTYSEL10
.
VTYSEL99  RETURN
.
.------------------------------------------------------------
. Ouput Clinic Type for Selected Session (SESSKEYS)
.------------------------------------------------------------
GETCTY00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          MATCH     SP70,SESSKEYS
          GOTO      GETCTY99 IF EQUAL
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GETCTY99
.
          BRANCH    F1,GETCTY10
.
          WRITE     HTMLFILE;OCTDESC;
          GOTO      GETCTY99
.
GETCTY10  WRITE     HTMLFILE;OCTCTYP;
          GOTO      GETCTY99
.
GETCTY99  RETURN
.
.------------------------------------------------------------
. Count Reschedules for Booking
.------------------------------------------------------------
RSHCNT00  MOVE      ZERO,RSHCOUNT
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1
RSHCNT10  CALL      RDKRSHA1
          BRANCH    OVRCD,RSHCNT90
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      RSHCNT90 IF NOT EQUAL
          ADD       ONE,RSHCOUNT
          GOTO      RSHCNT10
.
RSHCNT90  WRITE     HTMLFILE;RSHCOUNT;
RSHCNT99  RETURN
.
.*******************************************************************************
.                    Stationery Codes Selection List
.*******************************************************************************
SCODL000  PACK      KEY6,SP70
          CALL      RSIBTH1
SCODL100  CALL      RKIBTH1
          BRANCH    OVRCD,SCODL999
.
          WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">":
                             IBTHDESC,"</option>"
          GOTO      SCODL100
.
SCODL999  RETURN
.
.
.*******************************************************************************
.                                Write New Booking
.*******************************************************************************
WRTBOK00  MOVE      ONE,VINAHFLG              * set for no after VINAHDEF audits
.
.         Initialise flags to show no audit records have been written
.
          MOVE      ZERO,EPAUDFLG
          MOVE      ZERO,RIAUDFLG
.
          MOVE      ZERO,COUNTBOK
          MOVE      SP70,SERIADMN
          MOVE      SP70,SERICASE
.
          IF        SERIFLAG=2
            MOVE      MULTBKEY,NEWSLOTK
            GOTO      WRTBOK15
          ENDIF
.
          MATCH     SP70,SERIBKEY[ONE]           * Must select at least one
          GOTO      WRTBOK91 IF EQUAL            * appointment
.
WRTBOK10  ADD       ONE,COUNTBOK
.
          COMPARE   FORTY5,COUNTBOK
          GOTO      WRTBOK80 IF NOT LESS
.
          MATCH     SP70,SERIBKEY[COUNTBOK]      * Any more bookings to write
          GOTO      WRTBOK80 IF EQUAL
.
          MOVE      SERIBKEY[COUNTBOK],NEWSLOTK

WRTBOK15  CALL      CLOUTBOA                     * clear bok variables
          CALL      CLOUTBOB
          MOVE      SP70,OTBBCIND
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,WRTBOK89
.
          CALL      RDPMPX21
          BRANCH    OVRCD,WRTBOK89
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,WRTBOK92
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      WRTBOK90 IF LESS
            ELSE
              GOTO      WRTBOK90
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      VALICD00
          BRANCH    EXIT,WRTBOK99
.
          MOVE      NEWSLOTK,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,WRTBOK92,WRTBOK93
          COMPARE   NINE,OBASTAT             * Slot Reserved
          GOTO      WRTBOK30 IF EQUAL
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      WRTBOK94 IF NOT EQUAL    * Record isn't vacant !!
.
WRTBOK30  MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      WRTBOK94 IF NOT EQUAL    * Record isn't vacant !!
            CALL      DEOTSRV1
          ENDIF
          MOVE      ZERO,OBASTAT             * Make sure record isn't booked
          CALL      UPBOKA1
.
          MOVE      OBAVISIT,OLDVTYP
          MOVE      OBAVISIT,NEWVTYP
          MATCH     Z70,OUTBB047
          IF        !@EQUAL
            MOVE      OUTBB047,NEWVTYP
          ENDIF
.
          CALL      REAP0000
          BRANCH    EXIT,WRTBOK99
.                                                 * Save first booking UR and 
.                                                 * casekey for redirect
          IF        SERIFLAG=2
            PACK      SERICASE,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            MOVE      OBAOUTNO,SERIADMN      
.
            MATCH     SP70,FIRSTADM
            IF        @EQUAL
              MOVE      OBAOUTNO,FIRSTADM
              PACK      KEY24,URNUMBER,FIRSTADM,SP70
              CALL      RAOTLKB1
              IF        OVRCD=1
                MOVE      URNUMBER,OTLKURNO
                MOVE      FIRSTADM,OTLKOBOK
                MOVE      SP70,OTLKLBOK
                MOVE      ZERO,OTLKBSTA
                MOVE      ZERO,OTLKSSTA
                PACK      OTLKLDAT,CCC,CYY,CMM,CDD * current date
                REP       " 0",OTLKLDAT
                MOVE      CTIMEIS,OTLKLTIM
                MOVE      WBSEUID,OTLKLUID
                MOVE      SP70,OTLKUDAT
                MOVE      SP70,OTLKUTIM
                MOVE      SP70,OTLKUUID
                MOVE      SP70,OTLKSPAR
.
                CALL      WROTLKB1
                GOTO      WRTBOK40
              ENDIF
            ELSE
              PACK      KEY24,URNUMBER,FIRSTADM,OBAOUTNO,SP70
              CALL      RAOTLKB1
              IF        OVRCD=1
                MOVE      URNUMBER,OTLKURNO
                MOVE      FIRSTADM,OTLKOBOK
                MOVE      OBAOUTNO,OTLKLBOK
                MOVE      ZERO,OTLKBSTA
                MOVE      ZERO,OTLKSSTA
                PACK      OTLKLDAT,CCC,CYY,CMM,CDD * current date
                REP       " 0",OTLKLDAT
                MOVE      CTIMEIS,OTLKLTIM
                MOVE      WBSEUID,OTLKLUID
                MOVE      SP70,OTLKUDAT
                MOVE      SP70,OTLKUTIM
                MOVE      SP70,OTLKUUID
                MOVE      SP70,OTLKSPAR
.
                CALL      WROTLKB1
                GOTO      WRTBOK40
              ENDIF

            ENDIF
          ENDIF
.
          IF        COUNTBOK=1
            MOVE      OBAOUTNO,SERIADMN      
            PACK      SERICASE,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            
            PACK      KEY24,URNUMBER,SERIADMN,SP70
            CALL      RAOTLKB1
            IF        OVRCD=1
              MOVE      URNUMBER,OTLKURNO
              MOVE      SERIADMN,OTLKOBOK
              MOVE      SP70,OTLKLBOK
              MOVE      ZERO,OTLKBSTA
              MOVE      ZERO,OTLKSSTA
              PACK      OTLKLDAT,CCC,CYY,CMM,CDD * current date
              REP       " 0",OTLKLDAT
              MOVE      CTIMEIS,OTLKLTIM
              MOVE      WBSEUID,OTLKLUID
              MOVE      SP70,OTLKUDAT
              MOVE      SP70,OTLKUTIM 
              MOVE      SP70,OTLKUUID 
              MOVE      SP70,OTLKSPAR 
. 
              CALL      WROTLKB1
            ENDIF
          ELSE
            PACK      KEY24,URNUMBER,SERIADMN,OBAOUTNO,SP70
            CALL      RAOTLKB1
            IF        OVRCD=1
              MOVE      URNUMBER,OTLKURNO
              MOVE      SERIADMN,OTLKOBOK
              MOVE      OBAOUTNO,OTLKLBOK
              MOVE      ZERO,OTLKBSTA
              MOVE      ZERO,OTLKSSTA
              PACK      OTLKLDAT,CCC,CYY,CMM,CDD * current date
              REP       " 0",OTLKLDAT
              MOVE      CTIMEIS,OTLKLTIM
              MOVE      WBSEUID,OTLKLUID
              MOVE      SP70,OTLKUDAT
              MOVE      SP70,OTLKUTIM 
              MOVE      SP70,OTLKUUID 
              MOVE      SP70,OTLKSPAR
.             
              CALL      WROTLKB1
            ENDIF

          ENDIF
.
.
WRTBOK40  MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          CALL      MOVBB000
.
          MOVE      OBACOMP,KEY3
          CALL      LCLM0000                 * get default claim details
.
          CALL      UPBOKA1
          MATCH     OLDVTYP,NEWVTYP
          IF        !@EQUAL
            PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
            MOVE      OLDVTYP,OBAVISIT
            CALL      SUBBOK00
            MOVE      NEWVTYP,OBAVISIT
            CALL      ADDBOK00
            CALL      ADJNEW00
            CALL      ADJOLD00
.
            MOVE      ONE,RECALFLG          * Slot type has changed so
          ENDIF                             * recalculate clinic counts
.
          IF        BOOKFLAG=2
            MATCH     SP70,REFRLVIS
            IF        !@EQUAL
              PACK      KEY16,REFRLVIS,OBAOUTNO,SP70
              CALL      RAALLNK1              * Write link to A/H referral
              IF        OVRCD=1
                MOVE      REFRLVIS,ALLNVISN
                MOVE      OBAOUTNO,ALLNLNKV
                MOVE      OBASITE,ALLNSITE
                MOVE      OBACLIN,ALLNCLIN
                MOVE      OBADATE,ALLNDATE
                MOVE      OBASTRT,ALLNSTRT
                MOVE      OBASLOT,ALLNSLOT
                MOVE      ZERO,ALLNSTAT
                MOVE      SP70,ALLNSPAR
                MOVE      "0",ALLNMOHR            * Set to Unsent
                CALL      WRALLNK1
.
                MOVE      ONE,AUDTTYPE          * write history record
                CALL      WAALLN00
              ENDIF
              CALL      WROTBC00 
            ENDIF
.
            PACK      KEY8,REFRLVIS,SP70
            CALL      RDALREF1
            IF        OVRCD=0
              MATCH     "0",ALRESTAT
              IF        @EQUAL
.
.               Write a before audit record for the referral, then set the
.               flag to show that we just wrote a before audit record for
.               an Episode Referral
.
                MOVE      TWO,AUDTTYPE            * before history record
                CALL      WAALRE00
                MOVE      ONE,EPAUDFLG
.
                PACK      ALREUDAT,CCC,CYY,CMM,CDD
                REP       " 0",ALREUDAT
                CLOCK     TIME,ALREUTIM
                MOVE      USERID,ALREUUID
                PACK      ALREDACT,CCC,CYY,CMM,CDD
                REP       " 0",ALREDACT
                MOVE      ONE,ALRESTAT         * Activate referral
                MOVE      ALREDACT,ALSTSDAT    * write to Referral History Table
.
                MOVE      OBADATE,BOOKDATE
                CALL      CALX0000             * calculate expiry date
.
                CALL      ARMHI000             * Set MHINC indicator
                CALL      UPALREF1
.
                CALL      PMIGTNID             * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      ONE,HL7TRGID
                MOVE      SP8,HL7INCLD
                CALL      DGCLII13             * broadcast Update Ref. (REF^I13)
.
                CALL      WRTRSH00             * write a record to allstsaf
.
                MOVE      ALREVISN,CHECKREF
                CALL      AMAS0000             * Auto activate master referral
              ENDIF
.
              CALL      FAPD0000               * Set first appointment booked
              MOVE      ALREPRTY,SAVVPRTY      * Save referral priority
              MOVE      ALRETRGS,SAVVTRGS     * Save referral triage status
              MOVE      ALREVISN,SAVVREFN     * Referral number
              PROC      VDEF0000              * VINAH Field defaults
.
.             Check if an after Episode audit is still required and if so,
.             write one.
.
              IF        EPAUDFLG = 1
                MOVE      THREE,AUDTTYPE         * write after history record
                CALL      WAALRE00
              ENDIF
.
.             Check if an after Referral In audit is still required and if so,
.             write one
.
              IF        RIAUDFLG = 1
                MATCH     SP8,VINAHREF
                IF        !@EQUAL
                  MOVE      VINAHREF,KEY8
                  CALL      RDALREF1
                  IF        OVRCD = 0
                    MOVE      THREE,AUDTTYPE     * write after history record
                    CALL      WAALRE00
                  ENDIF
                ENDIF
              ENDIF
.
              CALL      RCLM0000               * Default Ref claim details
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          MOVE      OVRCD,DIAGOVR
          IF        OVRCD=1
            MOVE      OBAOUTNO,OPDIOUTN
            MOVE      SP70,OPDICODE
            MOVE      SP70,OPDIDESC
.                                           *** HPS Code Starts Here ***
            MOVE      SP70,OPDICOD2
            MOVE      SP70,OPDIDES2
            MOVE      SP70,OPDICOD3
            MOVE      SP70,OPDIDES3
            MOVE      SP70,OPDICOD4
            MOVE      SP70,OPDIDES4
            MOVE      SP70,OPDICOD5
            MOVE      SP70,OPDIDES5
.                                           *** HPS Code Ends Here ***
            MOVE      SP70,OPDISPAR
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            CALL      MOVBB000
            CALL      UPBOKB1
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
                CALL      IBACLOCK
                PACK      PMVXLUPD,CCC,CYY,CMM,CDD
                REP       " 0",PMVXLUPD
                MOVE      CTIMEIS,PMVXLUPT
                MOVE      USERID,PMVXWEBU
                CALL      UPPMVX11
            ENDIF
.
          ELSE
            CALL      CHRT0000           * Clear send letter if chart review
.
            CALL      MOVBB000
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
            PACK      KEY3,OBACOMP,SP70
            CALL      PRAD0000           * write to person responsible file
          ENDIF
.
          IF        PTCNHDPS=1
            MOVE      OBAOUTNO,ADMISSNO
            CALL      WRPORD00          * write/upd ACC Purchase Order
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          IF        DIAGOVR=0
            CALL      UPDIAG1
          ELSE
            CALL      WRDIAG1
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTPRC1
          IF        OVRCD=1
            CALL      CLOUTPRC
            MOVE      OBAOUTNO,OTPROUTN
            CALL      MVOTPC00
            CALL      WROTPRC1
          ELSE
            CALL      MVOTPC00
            CALL      UPOTPRC1
          ENDIF
.
          CALL      XWPCOM00                  *wrtbok
          CALL      UPVCM000                  * Admnission Comments  
.
          IF        SERIFLAG=1
            IF        COUNTBOK=1
              CALL      PATINS00              * Patient Instructions
            ENDIF 
          ENDIF
.
          IF        SERIFLAG=2
            CALL      PATINS00                * Patient Instructions
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WRTBOK99
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,WRTBOK99
.
          MATCH     Z70,OUTBB008            * Health fund received from
          GOTO      WRTBOK60 IF EQUAL       * booking
.
          MOVE      OTBBFUND,PFUNDH         * Update PMI health fund
          MOVE      OTBBTBLE,PFNDTB         * Update PMI health fund table
.
          CALL      UPMAST1
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP              * broadcast PMI update message
.
WRTBOK60  MATCH     "1",OTCNINTR       * Not Using visit based interpreter req
          IF        !@EQUAL
            MATCH     "1",PMPXINTR
            IF        @EQUAL
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
              CALL      INTUPD00                 * Interpreter Table Processing
            ENDIF
          ENDIF
          CALL      PRNT0000
.
          MOVE      NEWSLOTK,SESSKEYS          * Read session details to get
          CALL      SESDET00                   * hospital code
          IF        EXIT=1
            MOVE      WBSEHOSP,OTHEHOSP
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            CALL      MVVXTF00
            MOVE      USERID,PMVXWEBU
            PACK      PMVXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",PMVXLUPD
            CLOCK     TIME,PMVXLUPT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * get SLA/ASGC code
            MOVE      PMPXABRG,PMVXABRG
            CALL      UPPMVX11
          ELSE
            CALL      CLPMSVX1
            CALL      MVVXTF00
            MOVE      ADMISSNO,PMVXVISN
            MOVE      USERID,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * get SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPILC
            MOVE      PMPXABRG,PMVXABRG
            CALL      WRPMVX11
          ENDIF
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            IF        @EQUAL
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
              CALL      INTUPD00                 * Interpreter Table Processing
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,PVIBILL
          MOVE      ADMISSNO,DPVIBILL
          MOVE      URNUMBER,PVIURNO
          CALL      ADDVIS00              * Writes to MRTVISFD
          CALL      AEXP0000              * write adm based expected payors
.
          CALL      WOPG0000              * Write new OP program to patient
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICON              * DG API O/P New Appoint.  *I-90203
.
          CALL      DISVAL00
.
          COMPARE   ONE,RECALFLG          * This may need to be changed to only
          GOTO      WRTBOK70 IF NOT EQUAL * re calc if the slot type has changed
.                                         * ie New - Review - Special
          PACK      SAVSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RCAL0000               * Recalculate clinic counts as a
.                                         * slot type was changed
          MOVE      NEWSLOTK,KEY28        * Read correct appointment for
          CALL      RDBOKA1               * redirect
          BRANCH    OVRCD,WRTBOK92
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,WRTBOK92
.
WRTBOK70  CALL      CMBS0000
          CALL      UUOTBOA1
          IF        SERIFLAG=2
            GOTO      WRTBOK80
          ENDIF
.
          GOTO      WRTBOK10              * Loop back to next booking
.
WRTBOK80  CLOSE     COMFILAF,DELETE       * Delete comments file
          CLOSE     COMVISAF,DELETE       * Delete Admission comments file
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
.
WRTBOK89  MOVE      "Error: Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK90  MOVE      "Error: Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK91  MOVE      "Error: Appointment Details Must be Specified",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK92  MOVE      "Error: Appointment Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK93  MOVE      "Error: Appointment Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK94  MOVE      "Error: Appointment Time Has Been Taken. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
. HPS Code Starts Here
WRTBOK95  MOVE      "Patient already has a booking in this Clinic/Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
.
WRTBOK96  MOVE      "Patient already booked to the Clinic at same time",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
. HPS Code Ends Here
.
WRTBOK99  CLOSE     COMVISAF,DELETE
          CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          CALL      UUOTBOA1
          MOVE      ZERO,VINAHFLG                * reset audit flags
          MOVE      ZERO,EPAUDFLG
          MOVE      ZERO,RIAUDFLG
          MOVE      SP8,VINAHREF
          RETURN
.
.------------------------------------------------------------
. Check for CMBS items
.------------------------------------------------------------
CMBS0000  COMPARE   ONE,CMBSFLAG             * check if any cmbs items updated
          GOTO      CMBS9999 IF NOT EQUAL
.
CMBS1000  MOVE      ZERO,F2
          MOVE      ZERO,FORM2
          MOVE      OBAOUTNO,OTBIVISN         * Visit number
.
CMBS1200  COMPARE   FIVE,F2
          GOTO      CMBS9999 IF EQUAL         * reach maximum of 5 MBS items
          ADD       ONE,F2
          LOAD      OTBIIFLG,F2,OTBIT001,OTBIT004,OTBIT007,OTBIT010,OTBIT013
.
          MATCH     Z70,OTBIIFLG
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     SP70,OTBIIFLG
          GOTO      CMBS1200 IF EQUAL
.
          LOAD      OTBIITMN,F2,OTBIT002,OTBIT005,OTBIT008,OTBIT011,OTBIT014
          LOAD      OTBISUBN,F2,OTBIT003,OTBIT006,OTBIT009,OTBIT012,OTBIT015
          LOAD      OTBIPUSE,F2,OTBIT016,OTBIT017,OTBIT018,OTBIT019,OTBIT020
.
          MATCH     SP70,OTBIITMN
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     Z70,OTBIITMN
          GOTO      CMBS1200 IF EQUAL
.
          ADD       ONE,FORM2
          MOVE      FORM2,OTBIITMC
.
          MOVE      OBADATE,OTBIDATE
          MOVE      OBAURNO,OTBIURNO
          MOVE      "0",OTBISTAT
          UNPACK    SP70,OTBICDAT,OTBICTIM,OTBICUID
          UNPACK    SP70,OTBIUDAT,OTBIUTIM,OTBIUUID
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          MOVE      KEY8,OTBICDAT             * date created
          CLOCK     TIME,OTBICTIM             * time created
          MOVE      USERID,OTBICUID           * web user id
          CALL      WROTBIT1
.
          GOTO      CMBS1200
.
CMBS9999  RETURN
+
.
.------------------------------------------------------------------------------
. Re calculate the session statistics
.------------------------------------------------------------------------------
RCAL0000  MATCH     SP70,SAVSKEYS
          GOTO      RCAL9999 IF EQUAL
.
          MOVE      SAVSKEYS,SESSKEYS
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RCAL9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RCAL9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RCAL9999
.
... SRF 33923 - Commented out the next 3 lines of code
.          PACK      KEY25,OSESITE,OSECLIN,OSEDATE,OSESTRT
.          PACK      OSESCSTT,SP5
.          CALL      GCST0000
.
          MOVE      "00:00",OSETIMEU
          MOVE      ZERO,OSESLOTB              * slots booked
          MOVE      ZERO,OSESLOTS              * slots scheduled
          MOVE      ZERO,OSESSLTN              * New slots scheduled
          MOVE      ZERO,OSESSLTR              * Review slots scheduled
          MOVE      ZERO,OSESSLTS              * Special slots scheduled
          MOVE      ZERO,OSEBNEW               * New slots scheduled
          MOVE      ZERO,OSEBRV                * Review slots scheduled
          MOVE      ZERO,OSEBSPC               * Special slots scheduled
          MOVE      ZERO,OSEANEW               * New slots scheduled
          MOVE      ZERO,OSEARV                * Review slots scheduled
          MOVE      ZERO,OSEASPC               * Special slots scheduled
.
          CALL      CSLT0000
.
          CALL      UPSESA1
.
RCAL9999  RETURN
.
.
.**********************************************************************
.*                               CSLT0000                             *
.*        Count Slots                                                 *
.**********************************************************************
CSLT0000  PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT
          CALL      RDSBOKA1
CSLT1000  CALL      RDKBOKA1
          BRANCH    OVRCD,CSLT9999
          MATCH     OSESITE,OBASITE
          GOTO      CSLT9999 IF NOT EQUAL
          MATCH     OSECLIN,OBACLIN
          GOTO      CSLT9999 IF NOT EQUAL
          MATCH     OSEDATE,OBADATE
          GOTO      CSLT9999 IF NOT EQUAL
          MATCH     OSESTRT,OBASTRT
          GOTO      CSLT9999 IF NOT EQUAL
.
          COMPARE   THREE,OBASTAT
          GOTO      CSLT1000 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT
          GOTO      CSLT1000 IF EQUAL
.
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,CSLT1000
.
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          ADD       TCFORM6,OSESLOTS
.
          IF        (OBASTAT=1|OBASTAT=4|OBASTAT=5)
            ADD       TCFORM6,OSESLOTB
            CALL      ADDTIM00
          ENDIF
.
          MATCH     ANSN,TCINDC1
          GOTO      CSLT2000 IF NOT EQUAL
.
          ADD       ONE,OSESSLTN
          IF        (OBASTAT=1|OBASTAT=5)
            ADD       ONE,OSEBNEW
          ENDIF
          IF        OBASTAT=4
            ADD       ONE,OSEBNEW
            ADD       ONE,OSEANEW
          ENDIF
          GOTO      CSLT1000
.
CSLT2000  MATCH     ANSR,TCINDC1
          GOTO      CSLT3000 IF NOT EQUAL
.
          ADD       ONE,OSESSLTR
          IF        (OBASTAT=1|OBASTAT=5)
            ADD       ONE,OSEBRV
          ENDIF
          IF        OBASTAT=4
            ADD       ONE,OSEBRV
            ADD       ONE,OSEARV
          ENDIF

          GOTO      CSLT1000
.
CSLT3000  MATCH     ANSS,TCINDC1
          GOTO      CSLT1000 IF NOT EQUAL
.
          ADD       ONE,OSESSLTS
          IF        (OBASTAT=1|OBASTAT=5)
            ADD       ONE,OSEBSPC
          ENDIF
          IF        OBASTAT=4
            ADD       ONE,OSEBSPC
            ADD       ONE,OSEASPC
          ENDIF
          GOTO      CSLT1000
.
CSLT9999  RETURN
.
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  CALL      CLRPRT00                * HPS_ODC(Screen No.9) Modified
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      CASEKEYS,SUBSYSKY
          MOVE      SP70,STATNCOD
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
.
          MATCH     "1",LABPRT01
          GOTO      PRNT0010 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASBKL
.
          MOVE      LABELOUT,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASBKL
          GOTO      PRNT0010 IF EQUAL
          CALL      ADDPRN00
.
PRNT0010  MATCH     "1",LABPRT02
          GOTO      PRNT0020 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASAPL
.
          MOVE      LABELOUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASAPL
          GOTO      PRNT0020 IF EQUAL
          CALL      ADDPRN00
.
PRNT0020  MATCH     "1",LABPRT03
          GOTO      PRNT0030 IF NOT EQUAL
          MOVE      LABPSL03,SCHDPRNT
          MOVE      LABPNO03,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASPMM
.
          MOVE      LABELOUT,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASPMM
          GOTO      PRNT0030 IF EQUAL
          CALL      ADDPRN00
.
PRNT0030  MATCH     "1",LABPRT04
          GOTO      PRNT0200 IF NOT EQUAL
          MOVE      LABPSL04,SCHDPRNT
          MOVE      LABPNO04,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASGPM
.
          MOVE      LABELOUT,SETDFPRG
          MOVE      "4",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASGPM
          GOTO      PRNT0200 IF EQUAL
          CALL      ADDPRN00
.
PRNT0200  MATCH     "1",LETPRT01              * Print Process for Letters
          GOTO      PRNT0210 IF NOT EQUAL
          MOVE      LETPSL01,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPTR
          GOTO      PRNT0210 IF EQUAL
          MOVE      OTMALPTR,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0210  MATCH     "1",LETPRT02
          GOTO      PRNT0220 IF NOT EQUAL
          MOVE      LETPSL02,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALGPD
          GOTO      PRNT0220 IF EQUAL
          MOVE      OTMALGPD,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0220  MATCH     "1",LETPRT03
          GOTO      PRNT0230 IF NOT EQUAL
          MOVE      LETPSL03,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPTD
          GOTO      PRNT0230 IF EQUAL
          MOVE      OTMALPTD,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0230  MATCH     "1",LETPRT04
          GOTO      PRNT0240 IF NOT EQUAL
          MOVE      LETPSL04,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "4",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMABKLT
          GOTO      PRNT0240 IF EQUAL
          MOVE      OTMABKLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0240  MATCH     "1",LETPRT05
          GOTO      PRNT0250 IF NOT EQUAL
          MOVE      LETPSL05,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "5",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARALT
          GOTO      PRNT0250 IF EQUAL
          MOVE      OTMARALT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0250  MATCH     "1",LETPRT06
          GOTO      PRNT0260 IF NOT EQUAL
          MOVE      LETPSL06,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "6",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARSLT
          GOTO      PRNT0260 IF EQUAL
          MOVE      OTMARSLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0260  MATCH     "1",LETPRT07
          GOTO      PRNT0270 IF NOT EQUAL
.
          MATCH     SP70,CASEKEYS
          GOTO      PRNT0270 IF EQUAL

          MOVE      LETPSL07,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "7",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPPC
          GOTO      PRNT0270 IF EQUAL
          MOVE      OTMALPPC,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          MOVE      PURNO,URNUMBER
          MOVE      PURNO,OBAURNO
          CALL      PRNTUD00
.
PRNT0270  MATCH     "1",LETPRT08
          GOTO      PRNT0400 IF NOT EQUAL
          MOVE      LETPSL08,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "8",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMASRLH
          GOTO      PRNT0400 IF EQUAL
          MOVE      OTMASRLH,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0400  MATCH     "1",FRMPRT01                * Print Process for Forms
          GOTO      PRNT0500 IF NOT EQUAL
          MOVE      FRMPSL01,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "31",SECTOR
          READ      CONTROLF,SECTOR;*139,HOMR3COD
          MOVE      HOMR3COD,STATNCOD
          MOVE      SP70,LETTNCOD
          MOVE      ONE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
PRNT0500  MATCH     "1",FRMPRT02                * Print Process for Invoices
          GOTO      PRNT0600 IF NOT EQUAL
          MOVE      FRMPSL02,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      SP70,STATNCOD
          MOVE      SP70,LETTNCOD
          MOVE      THREE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
PRNT0600
.
PRNT9999  RETURN
.
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
.
SETDEF99  RETURN
.
.*******************************************************************************
.              Update Labels and Forms Printing Control Table
.*******************************************************************************
PRNTUD00  PACK      KEY5,Z70
          CALL      RSOTLPC1
          CALL      RPOTLPC1
          IF        OVRCD=1
            MOVE      ZERO,F5
            MOVE      F5,OTLPSCHE
          ENDIF
.
          MOVE      OTLPSCHE,F5
          ADD       ONE,F5
          MOVE      F5,OTLPSCHE
          MOVE      OBAURNO,OTLPURNO
          MOVE      OBAOUTNO,OTLPBOOK
          MOVE      OBASITE,OTLPSITE
          MOVE      OBACLIN,OTLPCLIN
          MOVE      OBADATE,OTLPSDAT
          MOVE      OBASTRT,OTLPSTIM
          MOVE      OBASLOT,OTLPSLOT
.
          MOVE      SCHDPRNT,OTLPPRNT
          MOVE      SCHDCOPY,OTLPCOPY
          MOVE      STATNCOD,OTLPSTAT
          MOVE      LETTNCOD,OTLPLETT
.         MOVE      PRNTTYPE,OTLPLETT
          MOVE      PRNTTYPE,OTLPPTYP
          MOVE      USERID,OTLPWEBU
          PACK      OTLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTLPRDAT
          MOVE      CTIMEIS,OTLPRTIM
.
PRNTUD50  PACK      KEY5,OTLPSCHE
          CALL      RAOTLPC1
          IF        OVRCD=1
            TRAP      WRTRAP IF IO               * Trap to stop I * D when
            CALL      WROTLPC1                   * multiple servers write to the
            TRAPCLR   IO                         * outpatient print file
          ELSE
            GOTO      PRNTUD00
          ENDIF
.
PRNTUD99  RETURN
.
.*******************************************************************************
.                 Clear Variables for Printing Control Table
.*******************************************************************************
CLRPRT00  MOVE      Z70,IBLPSCHE
          MOVE      Z70,IBLPURNO
          MOVE      Z70,IBLPVISN
          MOVE      Z70,IBLPSKEY
          MOVE      Z70,IBLPPRNT
          MOVE      ZERO,IBLPCOPY
          MOVE      Z70,IBLPSTAT
          MOVE      Z70,IBLPLAPR
          MOVE      Z70,IBLPLASC
          MOVE      Z70,IBLPFRE1
          MOVE      Z70,IBLPFRE2
          MOVE      Z70,IBLPFRE3
          MOVE      Z70,IBLPFRE4
          MOVE      Z70,IBLPFRE5
          MOVE      Z70,IBLPFRE6
          MOVE      Z70,IBLPFRE7
          MOVE      Z70,IBLPRUID
          MOVE      Z70,IBLPRDAT
          MOVE      Z70,IBLPRTIM
.
CLRPRT99  RETURN
.
.------------------------------------------------------------
. Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
GTASGC00  MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
GTASGC99  RETURN
.
.*******************************************************************************
. Update Interpreter Table
. Input  - OBAURNO
.        - OBAOUTNO
.        - CASEKEYS - for New Booking
.*******************************************************************************
INTUPD00  PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTUPD99
.
.         MATCH     SP70,OBAVISIT
.         IF        !@EQUAL
.           PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
.           CALL      RDCODE1
.           IF        OVRCD=0
.             MATCH     ANSC,TCINDC8
.             IF        @EQUAL
.               CALL      INTDEL00          * Delete Interpreter record if it
.               GOTO      INTUPD99          * exists and write audit record
.             ENDIF
.           ENDIF
.         ENDIF
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            GOTO      INTUPD10 IF EQUAL
            GOTO      INTUPD99
          ENDIF
.
          MATCH     "1",PMPXINTR
          GOTO      INTUPD99 IF NOT EQUAL
.
INTUPD10  CALL      CLVISINT
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDVSINT1
          IF        OVRCD=0
            MOVE      "B",INTAUDTY
            CALL      INTAUD00
          ENDIF
.
          MOVE      OBAOUTNO,VSINVISN
          MOVE      OBADATE,VSINDATE
          PACK      VSINTIME,OBATIME,KSECONDS
          MOVE      "2",VSINTYPE
          MOVE      CASEKEYS,VSINSUBK
          MOVE      USERID,VSINWUID
.
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSC,TCINDC8
              IF        @EQUAL
                MOVE      "1",VSINCHON
              ELSE
                MOVE      "0",VSINCHON
              ENDIF
            ENDIF
          ENDIF 
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RAVSINT1
          IF        OVRCD=0
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ELSE
            MOVE      ZERO,VSINNOTF
            MOVE      SP70,VSINUDC1
            MOVE      SP70,VSINUDC2
            MOVE      SP70,VSINUDC3
            MOVE      SP70,VSINUDC4
            MOVE      SP70,VSININTP
            MOVE      SP70,VSINSPAR
            MOVE      ZERO,VSINCONF              
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ENDIF
          MOVE      ZERO,EXIT
.
INTUPD99  RETURN
.
.*******************************************************************************
.                         Move in Bok B Details
.*******************************************************************************
MOVBB000  MATCH     Z70,OUTBB001
          IF        !@EQUAL
            MOVE      OUTBB001,OBASRCR
          ENDIF
.
          MATCH     Z70,OUTBB002
          IF        !@EQUAL
            MOVE      OUTBB002,OBACOMP
          ENDIF
.
          MATCH     Z70,OUTBB003
          IF        !@EQUAL
            MOVE      OUTBB003,OBACLASS
          ENDIF
.
          MATCH     Z70,OUTBB004
          IF        !@EQUAL
            MOVE      OUTBB004,OBAINS
          ENDIF
.
          MATCH     Z70,OUTBB005
          IF        !@EQUAL
            MOVE      OUTBB005,OBAATTN
          ENDIF
.
          MATCH     Z70,OUTBB006
          IF        !@EQUAL
            MOVE      OUTBB006,OBADOCT
          ENDIF
.
          MATCH     Z70,OUTBB007
          IF        !@EQUAL
            MOVE      OUTBB007,OBACOMM
          ENDIF
.
          MATCH     Z70,OUTBB008
          IF        !@EQUAL
            MOVE      OUTBB008,OTBBFUND
          ENDIF
.
          MATCH     Z70,OUTBB009
          IF        !@EQUAL
            MOVE     OUTBB009,OTBBTBLE
          ENDIF
.
          MATCH     Z70,OUTBB010
          IF        !@EQUAL
            MOVE     OUTBB010,DOTBBPVI
          ENDIF
.
          MATCH     Z70,OUTBB011
          IF        !@EQUAL
            MOVE      OUTBB011,OBADATE
          ENDIF
.
          MATCH     Z70,OUTBB012
          IF        !@EQUAL
            MOVE      OUTBB012,OBACAT
          ENDIF
.
          MATCH     Z70,OUTBB013
          IF        !@EQUAL
            MOVE      OUTBB013,OBAPRTY
          ENDIF
.
          MATCH     Z70,OUTBB014
          IF        !@EQUAL
            MOVE      OUTBB014,OBARSCHD
          ENDIF
.
          MATCH     Z70,OUTBB015
          IF        !@EQUAL
            MOVE      OUTBB015,OBBBOOK
          ENDIF
.
          MATCH     Z70,OUTBB016
          IF        !@EQUAL
            MOVE      OUTBB016,OBBCTYP
          ELSE
            MATCH     SP70,OBBCTYP
            IF        @EQUAL
              MOVE      OBACTYP,OBBCTYP
            ENDIF
          ENDIF
.
          MATCH     Z70,OUTBB017
          IF        !@EQUAL
            MOVE      OUTBB017,OBOUSR1
          ENDIF
.
          MATCH     Z70,OUTBB018
          IF        !@EQUAL
            MOVE      OUTBB018,OBOUSR2
          ENDIF
.
          MATCH     Z70,OUTBB019
          IF        !@EQUAL
            MOVE      OUTBB019,OBOUSR3
          ENDIF
.
          MATCH     Z70,OUTBB020
          IF        !@EQUAL
            MOVE      OUTBB020,OBOUSR4
          ENDIF
.
          MATCH     Z70,OUTBB021
          IF        !@EQUAL
            MOVE      OUTBB021,OBALADMN
          ENDIF
.
          MATCH     Z70,OUTBB022
          IF        !@EQUAL
            MOVE      OUTBB022,OTBBDEPT
          ENDIF
.
          MATCH     Z70,OUTBB023
          IF        !@EQUAL
            MOVE      OUTBB023,OTBBTRAN
          ENDIF
.
          MATCH     Z70,OUTBB024
          IF        !@EQUAL
            MOVE      OUTBB024,OTBBLNGI
          ENDIF
.
          MATCH     Z70,OUTBB025
          IF        !@EQUAL
            MOVE      OUTBB025,OTBBTMFS
          ENDIF
.
          MATCH     Z70,OUTBB026
          IF        !@EQUAL
            MOVE      OUTBB026,OTBBTMBO
          ENDIF
.
          MATCH     Z70,OUTBB027
          IF        !@EQUAL
            MOVE      OUTBB027,OTBBGPFA
          ENDIF
.
          MATCH     Z70,OUTBB028
          IF        !@EQUAL
            MOVE      OUTBB028,OTBBECRA
          ENDIF
.
          MATCH     Z70,OUTBB029
          IF        !@EQUAL
            MOVE      OUTBB029,OTBBRFGP
          ENDIF
.
          MATCH     Z70,OUTBB030
          IF        !@EQUAL
            MOVE      OUTBB030,OTBBGPPC
          ENDIF
.
          MATCH     Z70,OUTBB031
          IF        !@EQUAL
            MOVE      OUTBB031,OTBBADCS
          ENDIF
.
          MATCH     Z70,OUTBB032
          IF        !@EQUAL
            MOVE      OUTBB032,OTBBCITM
          ENDIF
.
          MATCH     Z70,OUTBB033
          IF        !@EQUAL
            MOVE      OUTBB033,OTBBASTM
          ENDIF
.
          MATCH     Z70,OUTBB034
          IF        !@EQUAL
            MOVE      OUTBB034,OTBBDPTM
          ENDIF
.
          MATCH     Z70,OUTBB035
          IF        !@EQUAL
            MOVE      OUTBB035,OTBBOUTC
          ENDIF
.
          MATCH     Z70,OUTBB036
          IF        !@EQUAL
            MOVE      OUTBB036,OTBBSNDL
          ELSE
            MOVE      ZERO,OTBBSNDL
          ENDIF
.
          MATCH     Z70,OUTBB037
          IF        !@EQUAL
            MOVE      OUTBB037,OTBBGPPT
          ENDIF
.
          MATCH     Z70,OUTBB038
          IF        !@EQUAL
            MOVE      OUTBB038,OTBBDOFR
          ENDIF
.
          MATCH     Z70,OUTBB039
          IF        !@EQUAL
            MOVE      OUTBB039,OTBBOPER
          ENDIF
.
          MATCH     Z70,OUTBB040
          IF        !@EQUAL
            MOVE      OUTBB040,OBOUSR5
          ENDIF
.
          MATCH     Z70,OUTBB041
          IF        !@EQUAL
            MOVE      OUTBB041,OBOUSR6
          ENDIF
.
          MATCH     Z70,OUTBB042
          IF        !@EQUAL
            MOVE      OUTBB042,OBOUSR7
          ENDIF
.
          MATCH     Z70,OUTBB043
          IF        !@EQUAL
            MOVE      OUTBB043,OBOUSR8
          ENDIF
.
          MATCH     Z70,OUTBB044
          IF        !@EQUAL
            MOVE      OUTBB044,OTBBRANK
          ENDIF
.
          MATCH     Z70,OUTBB045
          IF        !@EQUAL
            MOVE      OUTBB045,OPDICODE
          ENDIF
.
          MATCH     Z70,OUTBB046
          IF        !@EQUAL
            MOVE      OUTBB046,OPDIDESC
          ENDIF
.
          MATCH     Z70,OUTBB047
          IF        !@EQUAL
            MOVE      OUTBB047,OBAVISIT
          ENDIF
.
          MATCH     Z70,OUTBB048
          IF        !@EQUAL
            MOVE      OUTBB048,OBAPXRAY
          ENDIF
.
          MATCH     Z70,OUTBB049
          IF        !@EQUAL
            MOVE      OUTBB049,OBASESST
          ENDIF
.
          MATCH     Z70,OUTBB050
          IF        !@EQUAL
            MOVE      OUTBB050,OBADISCH
          ENDIF
.
          MATCH     Z70,OUTBB051
          IF        !@EQUAL
            MOVE      OUTBB051,OTBARESV
          ENDIF
.
          MATCH     Z70,OUTBB052
          IF        !@EQUAL
            MOVE      OUTBB051,OTBCRDAT
          ENDIF
          MATCH     Z70,OUTBB054
          IF        !@EQUAL
            MOVE      OUTBB054,OTBBSPCA
          ENDIF
.
.                                           *** HPS Code Starts Here ***
          MATCH     Z70,OUTBB055
          IF        !@EQUAL
            MOVE      OUTBB055,OPDICOD2
          ENDIF
.
          MATCH     Z70,OUTBB056
          IF        !@EQUAL
            MOVE      OUTBB056,OPDIDES2
          ENDIF
.
          MATCH     Z70,OUTBB057
          IF        !@EQUAL
            MOVE      OUTBB057,OPDICOD3
          ENDIF
.
          MATCH     Z70,OUTBB058
          IF        !@EQUAL
            MOVE      OUTBB058,OPDIDES3
          ENDIF
.
          MATCH     Z70,OUTBB059
          IF        !@EQUAL
            MOVE      OUTBB059,OPDICOD4
          ENDIF
.
          MATCH     Z70,OUTBB060
          IF        !@EQUAL
            MOVE      OUTBB060,OPDIDES4
          ENDIF
.
          MATCH     Z70,OUTBB061
          IF        !@EQUAL
            MOVE      OUTBB061,OPDICOD5
          ENDIF
.
          MATCH     Z70,OUTBB062
          IF        !@EQUAL
            MOVE      OUTBB062,OPDIDES5
          ENDIF
.
          MATCH     Z70,OUTBB063
          IF        !@EQUAL
            MOVE      OUTBB063,OTBBCIND
          ENDIF
.                                           *** HPS Code Ends Here ***
          MATCH     Z70,OUTBB064
          IF        !@EQUAL
            MOVE      OUTBB064,OTBBFLUP
          ENDIF
.
          MATCH     Z70,OUTBB065
          IF        !@EQUAL
            MOVE      OUTBB065,OTBBSCAR
          ENDIF
.
          MATCH     Z70,OUTBB066
          IF        !@EQUAL
            MOVE      OUTBB066,OTBBGLDT
          ENDIF
.
          MATCH     Z70,OUTBB067
          IF        !@EQUAL
            MOVE      OUTBB067,OTBBSNGL
          ENDIF
.
          MATCH     Z70,OUTBB068
          IF        !@EQUAL
            MOVE      OUTBB068,OTBBNMDS
          ENDIF
.
          MATCH     Z70,OUTBB069
          IF        !@EQUAL
            MOVE      OUTBB069,OTBBCART
          ENDIF
.
          MATCH     Z70,OUTBB070
          IF        !@EQUAL
            MOVE      OUTBB070,OTBBSRVD
          ENDIF
.
          MATCH     Z70,OUTBB071
          IF        !@EQUAL
            MOVE      OUTBB071,OTBBCLHR
          ENDIF
.
          MATCH     Z70,OUTBB072
          IF        !@EQUAL
            MOVE      OUTBB072,OTBBTCOD
          ENDIF
.
          MATCH     Z70,OUTBB073
          IF        !@EQUAL
            MOVE      OUTBB073,OTBBPURC
          ENDIF
.
          MATCH     Z70,OUTBB074
          IF        !@EQUAL
            MOVE      OUTBB074,OTBBCONT
          ENDIF
.
MOVBB999  RETURN
.
.*******************************************************************************
. Update Interpreter Audit Table
.  Input - CASEKEYS  Key To Booking
.          INTAUDTY  Audit Type
.*******************************************************************************
INTAUD00  CALL      CLVISIAU
          PACK      VSIACDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSIACDAT
          MOVE      CTIMEIS,VSIACTIM
          MOVE      INTAUDTY,VSIARTYP
.
          MOVE      VSINVISN,VSIAVISN
          MOVE      VSINDATE,VSIADATE
          MOVE      VSINTIME,VSIATIME
          MOVE      "2",VSIATYPE
          MOVE      VSINSUBK,VSIASUBK
          MOVE      VSINWUID,VSIAWUID
          MOVE      PMPXLNG1,VSIALNG1
          MOVE      PMPXLNG2,VSIALNG2
          MOVE      PMPXLNG3,VSIALNG3
          MOVE      VSINNOTF,VSIANOTF
          MOVE      VSINCONF,VSIACONF
.
          PACK      KEY25,VSIACDAT,VSIACTIM,VSIARTYP,VSIAVISN,SP70
          CALL      RAVSIAU1
          IF        OVRCD=0
            CALL      UPVSIAU1
          ELSE
            CALL      WRVSIAU1
          ENDIF
          MOVE      ZERO,EXIT
INTAUD99  RETURN
+
.*****************************************************************************
. Check for the Disease code and Sex Combination
.*****************************************************************************
VALICD00  MATCH     Z70,OUTBB045
          IF        !@EQUAL
            MOVE      OUTBB045,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB055
          IF        !@EQUAL
            MOVE      OUTBB055,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB057
          IF        !@EQUAL
            MOVE      OUTBB057,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB059
          IF        !@EQUAL
            MOVE      OUTBB059,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB061
          IF        !@EQUAL
            MOVE      OUTBB061,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MOVE      ZERO,EXIT
.
VALICD99  RETURN
.
.------------------------------------------------------------
. Write to the current patient list
.------------------------------------------------------------
WRCPAT00  CALL      CALRAN00
.
          MATCH     STRTDATE,OBADATE        * before start date
          GOTO      WRCPAT99 IF LESS
.
          MATCH     OBADATE,LASTDATE        * after end date
          GOTO      WRCPAT99 IF LESS
.
          MOVE      DOBAOUTN,PMCUVISN
          MOVE      OBADATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "2",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      OBASITE,PMCUOSIT
          MOVE      OTHEHOSP,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPAT99  RETURN
.
.--------------------------------------------------------------
. Write to Outpatient Clinic Session Booking Table C (outbokcf) 
.--------------------------------------------------------------
WROTBC00  MATCH     SP70,REFRLVIS
          GOTO      WROTBC99 IF EQUAL
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,WROTBC99
.
          MOVE      OBAOUTNO,KEY8	      
          CALL      RDOTBOC1	
          IF        OVRCD=0	      
            MOVE      ALRERDAT,OTBCRDAT	  
            CALL      UPOTBOC1	  
          ELSE	  
            MOVE      ALRERDAT,OTBCRDAT	    
            MOVE      SP70,OTBCSPAR	
            CALL      WROTBOC1	  
          ENDIF	    
.
WROTBC99  RETURN
+
.------------------------------------------------------------
. Calculate the date range for current patient records
.------------------------------------------------------------
CALRAN00  READ      CONTROLF,HUND01;*49,CWEBSDAY  * no of days for search
          MOVE      SP70,STRTDATE
          MOVE      SP70,LASTDATE
.
. ---  calculate starting date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          SUB       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
. ---  calculate last date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          ADD       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      LASTDATE,CC,YY,MM,DD
          REP       " 0",LASTDATE
.
CALRAN99  RETURN
.
.------------------------------------------------------------
. Validate ICD Code
.------------------------------------------------------------
DISCOD00  MOVE      ZERO,WARNCNT
          MOVE      SP70,WEBERR
.
          MOVE      OBADATE,ICDRDDTE  * Use Booking Date to read ICD file
          UNPACK    D9,D1
          MOVE      D9,KEY9
          CALL      RDPTICD1
          BRANCH    OVRCD,DISCOD99
          COMPARE   ONE,ICDRDVER      * ICD9?
          GOTO      DISCOD99 IF EQUAL * Yes, skip this record
.
          MOVE      ONE,AUTCDFLG      * Auto Coding off
          MOVE      ZERO,SWAPFLG      * Off
          MOVE      ZERO,ECODECNT     * E code counter
          MOVE      DISCODNO,DSCODNO  * Diagnosis Code Sequence Counter
          MOVE      D1,DSCODPFX       * Diagnosis Code Prefix
          MOVE      D9,DSCOD          * Set Var for routine
.
          MOVE      OBADATE,DDATE     * Set up trigger date for ICD Versions
.
          CALL      VDSCD000
          BRANCH    EXIT,DISCOD90
          GOTO      DISCOD99
.
DISCOD90  MATCH     SP70,WEBERR
          IF        !@EQUAL
            MOVE      WEBERR,WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      DISCOD99
DISCOD99  RETURN
.
+
.*******************************************************************************
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.*******************************************************************************
PRAD0000  CALL      PRFAINSR              * Copy Claim Insurance details to PRFA
          IF        OVRCD=0
            MOVE      OBAOUTNO,PKADMN
            GOTO      PRAD7000
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000
.
. patient is responsible for account
.
          MOVE    PTMASNAM,PACSNAMX
          MOVE    PGNAME,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PTITL,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    OBAOUTNO,PKADMN
          MOVE    PACFNAMX,PKNAME
          MOVE    PADD1,PKADD1
          MOVE    PADD2,PKADD2
          MOVE    PSUBRB,PKSUBR
          MOVE    PADD4,PKADD4
          MOVE    PPOST,PKPOST
          MOVE    PTELEP,PKTELEP
          MOVE    PTELEB,PKTELEB
          MOVE    "SELF      ",PKRELP
.
          CALL    PARN0000                  * Check for 'Parent of'
.
          GOTO    PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXMSNA,PACSNAMX
          MOVE    PMPXMGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXMTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXMAD1,PKADD1
          MOVE    PMPXMAD2,PKADD2
          MOVE    PMPXMAD3,PKSUBR
          MOVE    PMPXMAD4,PKADD4
          MOVE    PMPXMPOS,PKPOST
          MOVE    PMPXMPNO,PKTELEP
          MOVE    PMPXMBNO,PKTELEB
          MOVE    PMPXMREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXFSNA,PACSNAMX
          MOVE    PMPXFGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXFTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXFAD1,PKADD1
          MOVE    PMPXFAD2,PKADD2
          MOVE    PMPXFAD3,PKSUBR
          MOVE    PMPXFAD4,PKADD4
          MOVE    PMPXFPOS,PKPOST
          MOVE    PMPXFPNO,PKTELEP
          MOVE    PMPXFBNO,PKTELEB
          MOVE    PMPXFREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE    OBAOUTNO,PKADMN
          MOVE    PNKNAME,PKNAME
          MOVE    PNKADD1,PKADD1
          MOVE    PNKADD2,PKADD2
          MOVE    PNKSUBR,PKSUBR
          MOVE    PNKADD4,PKADD4
          MOVE    PNKPOST,PKPOST
          MOVE    PNKTELP,PKTELEP
          MOVE    PNKTELB,PKTELEB
          MOVE    PNKRELP,PKRELP
.
          GOTO    PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXECNM,PKNAME
          MOVE    PTMXECA1,PKADD1
          MOVE    PTMXECA2,PKADD2
          MOVE    PTMXECA3,PKSUBR
          MOVE    PTMXECA4,PKADD4
          MOVE    PTMXECPC,PKPOST
          MOVE    PTMXECPP,PKTELEP
          MOVE    PTMXECBP,PKTELEB
          MOVE    PTMXECRE,PKRELP
.
          GOTO    PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXNRNM,PKNAME
          MOVE    PTMXNRA1,PKADD1
          MOVE    PTMXNRA2,PKADD2
          MOVE    PTMXNRA3,PKSUBR
          MOVE    PTMXNRA4,PKADD4
          MOVE    PTMXNRPC,PKPOST
          MOVE    PTMXNRPP,PKTELEP
          MOVE    PTMXNRBP,PKTELEB
          MOVE    PTMXNRRE,PKRELP
.
          GOTO    PRAD7000
.
PRAD7000  PACK    KEY8,OBAOUTNO,SP10
          CALL    RDARESP1
          IF      OVRCD=1
            CALL    WRRESP1
          ELSE
            CALL    UPRESP1
          ENDIF
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
.
.***********************************************************************
.        Check for Using 'Parent of' option
.***********************************************************************
PARN0000 COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      PARN9999 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,PTCNAGEC         * Child?
         GOTO      PARN9999 IF LESS          * No
.
         UNPACK    PGNAME,ANS
         PACK      PKNAME,SP70
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
.
PARN9999 RETURN
+
.------------------------------------------------------------
WRTRAP    NORETURN
          ADD         ONE,F5
          MOVE        F5,OTLPSCHE
          GOTO        PRNTUD50
.
+
.------------------------------------------------------------
. Get default claim details from previous visit
.------------------------------------------------------------
LCLM0000  MATCH     SP3,KEY3
          GOTO      LCLM7000 IF EQUAL       * no claim code
.
          MATCH     ANSN,PTCNLCLM
          GOTO      LCLM9999 IF EQUAL
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5 WITH ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD OF LCLM7000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
LCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      LCLM7000 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      LCLM4000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      LCLM5000 IF EQUAL
          GOTO      LCLM3000
.
.         We have a workers comp. claim, get the previous workers comp details
.
LCLM4000  OPEN     PATWC1A1,"patwc1af"
          OPEN     PATWC1A2,"patwc1af"
          PACK     KEY16,URNUMBER,Z70
          CALL     RDSWCOM2
LCLM4100  CALL     RDPWCOM2
          BRANCH   OVRCD,LCLM7000
          MATCH    PTWCURNO,URNUMBER
          GOTO     LCLM7000 IF NOT EQUAL
.
          MATCH    ANSI,PTCNLCLM           * Check inpatient visit only
          GOTO     LCLM4200 IF NOT EQUAL   * Any visit
.
          MOVE     WCADMNO,KEY8
          CALL     RDVISA1
          BRANCH   OVRCD,LCLM4100
.
          COMPARE  THREE,PVITYPE
          GOTO     LCLM4100 IF NOT EQUAL   * get next visit
.
LCLM4200  MOVE     WCADMNO,KEY8
          CALL     RDPMWX11           * read ext.workers comp file(prev adm)
.
          MOVE     OBAOUTNO,WCADMNO   * current outpatient number
          MOVE     WCADMNO,KEY8
          CALL     RDAWCOM1
          IF       OVRCD=1
            MOVE     OBADATE,PTWCVDAT
            MOVE     OBAURNO,PTWCURNO
            CALL     WRWCOM1          * write workers comp file
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC 
            IF        @EQUAL
              MATCH    "5",UPDTTYPE
              IF        !@EQUAL
                CALL      PMIGTNID             * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      THREE,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICOB             * send update O/P details
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     OBAOUTNO,PMWXVISN
          CALL     RAPMWX11
          IF       OVRCD=1
            CALL     WRPMWX11         * write extension workers comp file
          ENDIF
.
          GOTO     LCLM9999
.
.         We have a motors accident claim, get the previous workers comp details
.
LCLM5000  OPEN     PATWMAB1,"patwmabf"
          OPEN     PATWMAB2,"patwmabf"
          PACK     KEY16,URNUMBER,Z70
          CALL     RDSWMAB2           * read claim details for previous visit
LCLM5100  CALL     RDPWMAB2
          BRANCH   OVRCD,LCLM7000
          MATCH    PTWMURNO,URNUMBER
          GOTO     LCLM7000 IF NOT EQUAL
.
          MATCH    ANSI,PTCNLCLM           * Check inpatient visit only
          GOTO     LCLM5200 IF NOT EQUAL   * Any visit
.
          MOVE     MADMNO,KEY8
          CALL     RDVISA1
          BRANCH   OVRCD,LCLM5100
.
          COMPARE  THREE,PVITYPE
          GOTO     LCLM5100 IF NOT EQUAL   * get next visit
.
LCLM5200  MOVE     OBAOUTNO,MADMNO    * current outpatient number
          MOVE     OBAOUTNO,KEY8
          CALL     RDAWMAB1
          IF       OVRCD=1
            MOVE     OBADATE,PTWMVDAT
            MOVE     OBAURNO,PTWMURNO
            CALL     WRWMAB1          * write workes comp file
          ENDIF
          GOTO     LCLM9999
.
LCLM7000  CALL     CLRCLM00
LCLM9999  RETURN
+
.------------------------------------------------------------
.     Clear Claim Details
.------------------------------------------------------------
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      ZERO,WCCLMNO
.
          MOVE      SP70,VCLMNO
.
          MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
          MOVE      SP70,PMWXVISN           * Visit Number
          MOVE      SP70,PMWXALOC           * Accident Location
          MOVE      SP70,PMWXCINJ           * of Injury (Cat IK)
          MOVE      SP70,PMWXICOD           * Injury Code (Cat IJ)
          MOVE      SP70,PMWXECOD           * Employer code
          MOVE      SP70,PMWXCNAM           * Contact Name
          MOVE      SP70,PMWXCDTE           * Date Record Created (ccyymmdd)
          MOVE      SP70,PMWXCTIM           * Time Record Created (hh:mm:ss)
          MOVE      SP70,PMWXWEBC           * WEB User Id rec. creator(websecaf)
          MOVE      SP70,PMWXLUPD           * Last Update Date (ccyymmdd)
          MOVE      SP70,PMWXLUPT           * Last Update Time (hh:mm:ss)
          MOVE      SP70,PMWXWEBU           * WEB User Id rec. updater(websecaf)
          MOVE      SP70,PMWXSPAR           * Spare Variable
+
.*******************************************************************************
.                            Update Booking Comments
.*******************************************************************************
XWPCOM00  BRANCH    OTXFLAG,XWPCOM90
          PACK      KEY12,OBAOUTNO,SP70
          CALL      RDOTXWP1
XWPCOM10  CALL      RKOTXWP1
          BRANCH    OVRCD,XWPCOM20
          MATCH     OBAOUTNO,OTXWOUTN
          GOTO      XWPCOM20 IF NOT EQUAL
          PACK      KEY12,OTXWOUTN,OTXWLINE,SP70
          CALL      DEOTXWP1
          CALL      RSOTXWP1
          GOTO      XWPCOM10
.
XWPCOM20  COMPARE   ZERO,OTXWEND
          GOTO      XWPCOM99 IF EQUAL
          MOVE      ZERO,F2
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,XWPCOM99
.
XWPCOM30  READ      COMFILAF,SEQ;COMM127
          GOTO      XWPCOM90 IF OVER
.
          ADD       ONE,F2
          MOVE      OBAOUTNO,OTXWOUTN
          MOVE      F2,OTXWLINE
          PACK      KEY12,OTXWOUTN,OTXWLINE,SP70
          CALL      RDOTXWP1
          IF        OVRCD=1
            MOVE      COMM127,OTXWDESC
            CALL      WROTXWP1
          ENDIF
          COMPARE   F2,OTXWEND
          GOTO      XWPCOM30 IF NOT EQUAL
.
XWPCOM90  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM  * To reset position back to the start
          TRAPCLR   IO
          BRANCH    OVRCD,XWPCOM99
.
XWPCOM99  RETURN
.
.
.-----------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPVCM000  IF        VSCMTFLG <> 1
            GOTO      UPVCM999
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          MOVE      VSCMTTYP,KEY3
          CALL      DLVCM000                  * delete visit comments
.
          IF        VSCMTLIN = 0
            GOTO      UPVCM999
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVCM200  MOVE      OBAOUTNO,KEY8
          MOVE      KEY8,VSMDVISN            * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      ONE,F6
          MOVE      F6,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE        * Visit date
          MOVE      CTIMEIS,VSMDTIME         * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG       * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVCM400  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVCM990 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      UPVCM990
          ENDIF
.
          GOTO      UPVCM400
.
UPVCM990  MOVE      ZERO,OVRCD 
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM  * To reset position back to the start
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
UPVCM999  RETURN
.
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,KEY8,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     KEY8,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
.
.*******************************************************************************
.                            Update Appointment Request Comments
.*******************************************************************************
REQCOM00  BRANCH    REQCFLAG,REQCOM90
.
          MOVE      "012",KEY3        
          PACK      KEY14,OTARREFN,KEY3,SP70
          CALL      RSVSCMT1
REQCOM10  CALL      RKVSCMT1
          BRANCH    OVRCD,REQCOM20
.
          MATCH     OTARREFN,VSCTVIST
          GOTO      REQCOM20 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      DEVSCMT1
          CALL      RSVSCMT1
          GOTO      REQCOM10
.
REQCOM20  COMPARE   ZERO,REQCEND
          GOTO      REQCOM99 IF EQUAL
.
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILBF,COMFILNB
          TRAPCLR   IO
          BRANCH    OVRCD,REQCOM99
.
REQCOM30  READ      COMFILBF,SEQ;COMM127
          GOTO      REQCOM90 IF OVER
.
          ADD       ONE,F3
          MOVE      OTARREFN,VSCTVIST
          MOVE      KEY3,VSCTTYPE
          MOVE      F3,VSCTLINE
          MOVE      SP70,VSCTUKEY
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RAVSCMT1
          IF        OVRCD=1
            MOVE      COMM127,VSCTDATA
            CALL      WRVSCMT1
          ENDIF
          COMPARE   F3,REQCEND
          GOTO      REQCOM30 IF NOT EQUAL
.
REQCOM90  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILBF,COMFILNB  * To reset position back to the start
          TRAPCLR   IO
          BRANCH    OVRCD,REQCOM99
REQCOM99  RETURN
.
.*******************************************************************************
. Update Appointment Request Comments - OUTRCMFD
.*******************************************************************************
RCMCOM00  BRANCH    OTRCFLAG,RCMCOM90
.
          MATCH     SP70,OTARCMID           * Unique comment id
          GOTO      RCMCOM05 IF NOT EQUAL
.
          MOVE      "121",PRXCODE           * System Lock Sector 121
          CALL      GETSLK00                * Get System Lock of Sector 121
.
          READ      CONTROLF,HUND21;*112,ALCNNUCI
          MOVE      ALCNNUCI,FORM10
          ADD       ONE,FORM10
          MOVE      FORM10,ALCNNUCI
          WRITAB    CONTROLF,HUND21;*112,ALCNNUCI
.
          CALL      RELSLK00                * Release System Lock of Sector 121
          SUB       ONE,FORM10
          MOVE      FORM10,ALCNNUCI         * Next unique comment id
.
          MOVE      ALCNNUCI,OTARCMID
          CALL      UPOTART1                * Read in calling routine
.
RCMCOM05  PACK      KEY13,OTARCMID,SP70
          CALL      RSOTRCM1
RCMCOM10  CALL      RKOTRCM1
          BRANCH    OVRCD,RCMCOM20
.
          MATCH     OTARCMID,OTRCUNIQ
          GOTO      RCMCOM20 IF NOT EQUAL
.
          PACK      KEY13,OTRCUNIQ,OTRCLINE,SP70
          CALL      DEOTRCM1
          CALL      RSOTRCM1
          GOTO      RCMCOM10
.
RCMCOM20  COMPARE   ZERO,OTRCEND
          GOTO      RCMCOM99 IF EQUAL
.
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILRF,COMFILNR
          TRAPCLR   IO
          BRANCH    OVRCD,RCMCOM99
.
RCMCOM30  READ      COMFILRF,SEQ;COMM127
          GOTO      RCMCOM90 IF OVER
.
          MOVE      OTARCMID,OTRCUNIQ
          ADD       ONE,F3
          MOVE      F3,OTRCLINE
.
          PACK      KEY13,OTRCUNIQ,OTRCLINE,SP70
          CALL      RAOTRCM1
          IF        OVRCD=1
            MOVE      USERID,OTRCCUID
            PACK      OTRCCDAT,CCC,CYY,CMM,CDD
            REP       " 0",OTRCCDAT
            CLOCK     TIME,OTRCCTIM
            UNPACK    SP70,OTRCUUID,OTRCUDAT,OTRCUTIM,OTRCSPAR
            MOVE      COMM127,OTRCCOMM
            CALL      WROTRCM1
          ENDIF
          COMPARE   F3,OTRCEND
          GOTO      RCMCOM30 IF NOT EQUAL
.
RCMCOM90  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILRF,COMFILNR  * To reset position back to the start
          TRAPCLR   IO
          BRANCH    OVRCD,RCMCOM99
.
RCMCOM99  RETURN
.
ADJNEW00  IF        NEWSLOTS<=0
            GOTO      ADJNEW99
          ENDIF
          MOVE      ZERO,LOCKCNT
.
ADJNEW10  PACK      KEY25,NEWSLOTK,SP70      * Key for selected booking
          CALL      RLOTSES1
          BRANCH    OVRCD,ADJNEW99,ADJNEW90
          SUB       NEWSLOTS,OSESLOTB
          CALL      UPSESA1
          CALL      UUOTSES1
          GOTO      ADJNEW99
.
ADJNEW90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<10
            GOTO      ADJNEW10
          ENDIF
ADJNEW99  RETURN
.
ADJOLD00  IF        OLDSLOTS<=0
            GOTO      ADJOLD99
          ENDIF
          MOVE      ZERO,LOCKCNT
.
ADJOLD10  PACK      KEY25,NEWSLOTK,SP70      * Key for selected booking
          CALL      RLOTSES1
          BRANCH    OVRCD,ADJOLD99,ADJOLD90
          ADD       OLDSLOTS,OSESLOTB
          CALL      UPSESA1
          CALL      UUOTSES1
          GOTO      ADJOLD99
.
ADJOLD90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<10
            GOTO      ADJOLD10
          ENDIF
ADJOLD99  RETURN
.
.---------------------------------------------------
. Reduce Booking Count on Session
.---------------------------------------------------
SUBBOK00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,SUBBOK98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
SUBBOK10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,SUBBOK98,SUBBOK90
          SUB       TCFORM6,OSESLOTB
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBNEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBRV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBSPC
          ENDIF
          CALL      SUBTIM00
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      SUBBOK99
SUBBOK90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      SUBBOK10
          ENDIF
SUBBOK98  MOVE      ONE,EXIT
SUBBOK99  RETURN
.---------------------------------------------------
. Increment Booking Count on Session
.---------------------------------------------------
ADDBOK00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,ADDBOK98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
ADDBOK10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,ADDBOK98,ADDBOK90
          ADD       TCFORM6,OSESLOTB
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBNEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBRV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBSPC
          ENDIF
          CALL      ADDTIM00
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      ADDBOK99
ADDBOK90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      ADDBOK10
          ENDIF
ADDBOK98  MOVE      ONE,EXIT
ADDBOK99  RETURN
.
.                                           *** HPS Code Ends Here ***
.*******************************************************************************
.            REAP0000: Generate and post a new outpatient number
.*******************************************************************************
REAP0000  COMMIT
          BEGIN
.
          READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OPROUTN
          ELSE
            MOVE      " 10",PRXCODE
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8V  * Get the next Outpatient number
            ADD       ONE,FORM8V              * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8V  * Post new outpatient no
            SUB       ONE,FORM8V              * Go back to original O/P Number
            MOVE      FORM8V,OPROUTN
            CALL      RELSLK00
          ENDIF
.
          COMMIT
          BEGIN
.
REAP0500  PACK      KEY8,OPROUTN             * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for bokb file
          CALL      RDABOKB1
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
.         We have a valid outpatient number. Post the Boka data
.
REAP0700  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          BRANCH    OVRCD,REAP9020
.
.         Update this record with the booking data
.
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      REAP1000 IF EQUAL
          COMPARE   NINE,OBASTAT             * Make sure record isn't booked
          GOTO      REAP9010 IF NOT EQUAL    * Record isn't vacant !!
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      REAP9020 IF NOT EQUAL * Record is locked by another
            CALL      DEOTSRV1
          ENDIF
.
REAP1000  MOVE      OPROUTN,OBAOUTNO         * Outpatient number
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      REAP9040 IF EQUAL
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      "       0",URNUMBER
            CALL      WRTZUR00
          ENDIF
          MOVE      URNUMBER,OBAURNO         * U/R Number
          MOVE      ONE,OBASTAT              * Status = Booked
          MOVE      ZERO,OBAPULL             * Clear pulling list flag
          CLOCK     TIME,CTIMEIS             * Get the current time
          PACK      OBABKDTE,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",OBABKDTE            * Zero-fill booking date/time
          CALL      UPBOKA1
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          CALL      PPRE0000                 * Updating the pre-attend file data
.
          MOVE      ZERO,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,REAP9050
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD<>1
            CALL      CHRT0000               * Clear send letter if chart review
          ENDIF
.
          IF        BOOKALLA = 1
            MATCH     SP70,OTHETCOD
            IF        @EQUAL
              MOVE      OTMATCOD,OUTBB072    * Tier 2 code clinic master
            ELSE
              MOVE      OTHETCOD,OUTBB072    * Tier 2 code slot template header
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70       * Key for bokb file
          CALL      RDABOKB1                 * Write the bokb record
          IF        OVRCD=1
            MOVE      LINKOUTN,OBALADMN
            MOVE      OBACTYP,OBBCTYP        * Store Clinic Type (SRF 103335)
            MOVE      SP10,OTBBADCS
            MOVE      SP10,OTBBCITM
            MOVE      SP10,OTBBASTM
            MOVE      SP10,OTBBDPTM
            MOVE      SP10,OTBBOUTC
            MOVE      SP70,OTBBCIND          * Clear before write
            MOVE      SP70,OTBBHCP1
            MOVE      SP70,OTBBHCP2
            MOVE      SP70,OTBBHCP3
            MOVE      SP70,OTBBHCP4
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
            PACK      KEY3,OBACOMP,SP70
            CALL      PRAD0000           * write to person responsible file
          ENDIF
.
          CALL      WRAP0000
.
          MATCH     OLDVTYP,NEWVTYP
          GOTO      REAP8900 IF EQUAL
.
          CALL      EXTSLT00
          GOTO      REAP8900
.
.REAP7000  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
.          CALL      RDBOKA1                  * Read in the booking record
.          MOVE      OBASLOT,PARNSLOT
.REAP8000  CALL      RDKBOKA1                 * Check the next record
.          BRANCH    OVRCD,REAP8900           * Finished
.          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
.          MATCH     KEY25,NEWSLOTK         * Correct session ?
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
.          COMPARE   THREE,OBASTAT            * Is this an extended slot ?
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
.          COMPARE   OBAEXSL,PARNSLOT
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
..
.          MOVE      OPROUTN,OBAOUTNO         * Outpatient number
.          MOVE      URNUMBER,OBAURNO         * U/R Number
.          CALL      UPBOKA1                  * Update this record
.
.          GOTO      REAP8000                 * Check for another extended slot
.
.         Finished update. Re-read the original record to make sure
.         variables such as OBAOUTNO and OBAURNO contain the correct data
.
REAP8900  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      ZERO,EXIT
          GOTO      REAP9999                * Finished posting data
.
.         Booking record has the wrong status
.
REAP9010  MOVE      "Booking Record has wrong status.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9020  MOVE      "New Booking Record not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9030  MOVE      "Invalid Booking Status for Referral Letter.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9040  MOVE      "New Booking has a Zero Visit Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9050  MOVE      "Invalid Clinic Master details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9999  COMMIT
          BEGIN
          RETURN
.
.------------------------------------------------------------
. Extend Slots
.  Input - NEWVTYP New Visit Type
.          OLDVTYP old Visit Type
.          NEWSLOTK - Slot Key
.------------------------------------------------------------
EXTSLT00  MOVE      NEWVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,NEWSLOTS
.
          MOVE      OLDVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,OLDSLOTS
.
          PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      NEWVTYP,OBAVISIT         * Update to New Visit Type
          CALL      UPBOKA1
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
.
          MOVE      OBASLOT,PARNSLOT         * Set Parent Slot
.
EXTSLT10  CALL      RDKBOKA1                 * Check the next record
          BRANCH    OVRCD,EXTSLT90           * Finished
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK         * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL    * No. Finished
          COMPARE   ZERO,NEWSLOTS
          GOTO      EXTSLT30 IF EQUAL
.
          MATCH     OLDVTYP,OBAVISIT
          IF        !@EQUAL
            MOVE      OBAVISIT,CODE          * Check Slot is not Extended
            CALL      GETSCT00               * Get Slot Count
            COMPARE   ONE,CNTSLOTS           * Exit if This Slot Extended
            GOTO      EXTSLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     ANSU,TCINDC6
          GOTO      EXTSLT90 IF EQUAL        * Ignore unavailable slots
.
          MATCH     ANSZ,TCINDC2
          GOTO      EXTSLT90 IF EQUAL        * Ignore over bookings slots
.
          MATCH     ZEROVISN,OBAOUTNO        * Outpatient number
          GOTO      EXTSLT90 IF NOT EQUAL    * Exit if Slot has Booking
.
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
          MOVE      THREE,OBASTAT            * Update as Extended Slot
          MOVE      NEWVTYP,OBAVISIT
          MOVE      PARNSLOT,OBAEXSL
          CALL      UPBOKA1
          GOTO      EXTSLT10
.
EXTSLT20  CALL      RDKBOKA1     * Read Next Slot
          BRANCH    OVRCD,EXTSLT90
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK          * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL   * No. Finished
.
EXTSLT30  COMPARE   PARNSLOT,OBAEXSL
          GOTO      EXTSLT90 IF NOT EQUAL
.
          SUB       ONE,OLDSLOTS
          MOVE      ZEROVISN,OBAOUTNO       * Outpatient number
          MOVE      ZEROUR,OBAURNO          * Outpatient number
          MOVE      "R  ",OBAVISIT
          MOVE      ZERO,OBAEXSL            * Update as Not Extended
          MOVE      ZERO,OBASTAT            * Update as Not Extended
          CALL      UPBOKA1
          GOTO      EXTSLT20
.
EXTSLT90  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          RETURN
.
.******************************************************************************
.*          WRAP0000: write to the outrapaf file (Re-appointments File)       *
.******************************************************************************
WRAP0000  READ      CONTROLF,THIRTY1;*226,OTCNRAPA
          IF        OTCNRAPA=1
            MOVE      ADMISSNO,OTRPOBKN   * Old
            MOVE      OBAOUTNO,OTRPRBKN   * New
            PACK      OTRPDATE,CCC,CYY,CMM,CDD
            REP       " 0",OTRPDATE
            CLOCK     TIME,OTRPTIME
            MOVE      PASSCODE,OTRPLOGI
            MOVE      SP30,OTRPSPAR
            PACK      KEY16,OTRPOBKN,OTRPRBKN
            CALL      RDOTRAP1
            IF        OVRCD=1
              CALL      WROTRAP1
            ENDIF
          ENDIF
          RETURN
.
.*******************************************************************************
.             PPRE0000 : Post the pre-attendance file data
.*******************************************************************************
PPRE0000  MOVE      OBAOUTNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,PPRE5000
.
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          CALL      UPPREA1
          GOTO      PPRE9999
.
PPRE5000  MOVE      OBAOUTNO,OPROUTN
          MOVE      OBASITE,OPRSITE
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          MOVE      SP20,OPRSPAR
          MOVE      OPROUTN,KEY8
          CALL      WRPREA1
.
PPRE9999  RETURN
.
.------------------------------------------------------------
. Get Slot Count from Code File
.------------------------------------------------------------
GETSCT00  MOVE      ONE,CNTSLOTS
          MOVE      "CV",CATEGORY
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          BRANCH    OVRCD,GETSCT99
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,CNTSLOTS
GETSCT99  RETURN
.
.------------------------------------------------------------
. Wite Zero UR Records
.------------------------------------------------------------
WRTZUR00  MOVE      OBAOUTNO,KEY8
          CALL      RDPRAM1
          IF        OVRCD=1
            CALL      CLPATMAS
            MOVE      OBAOUTNO,PURNO
            CALL      MVPRAM00
            CALL      WRPRAM1
            CALL      WZUS0000
          ENDIF
.
WRTZUR99  RETURN
.
.******************************************************************************
.*                         WZUS0000                                           *
.*         Write a zero u/r record to double soundex surname file             *
.*                   called by : WRIT5100                                     *
.******************************************************************************
WZUS0000  MOVE      PTMASNAM,GSRSNAM         * Surname
          MOVE      PMPXFNAM,GSRGNAM         * Given Name 1
          MOVE      PMPXSNAM,PTGSGNM2        * Given Name 2
          MOVE      ZEROUR,GSRURNO           * No U/R Number
          MOVE      OBAOUTNO,GSRBILL         * Billing Number
          MOVE      TWO,GSRSYS               * Outpatients System
          CALL      SOUNDEX                  * Calculate soundex key
          CALL      SOUNDX2                  * given name soundex
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1                 * check if its already there
          COMPARE   ZERO,OVRCD               * check overcond flag
          GOTO      WZUS9999 IF EQUAL        * already exists
          CALL      WRPTGSR1                 * Write the surname record
.
WZUS9999  RETURN
.
.*******************************************************************************
.                         Update Master Details
.*******************************************************************************
MVPRAM00  MATCH     PTMAS001,Z70
          IF        !@EQUAL
            MOVE      PTMAS001,PTITL
          ENDIF
.
          COMPARE   PTMAS002,ZERO
          IF        !@EQUAL
            MOVE      PTMAS002,PHOSP
          ENDIF
.
          COMPARE   PTMAS003,ZERO
          IF        !@EQUAL
            MOVE      PTMAS003,PLDAYS
          ENDIF
.
          COMPARE   PTMAS004,ZERO
          IF        !@EQUAL
            MOVE      PTMAS004,PBDEBT
          ENDIF
.
          MATCH     PTMAS005,Z70
          IF        !@EQUAL
            MOVE      PTMAS005,PSNAME
          ENDIF
.
          MATCH     PTMAS006,Z70
          IF        !@EQUAL
            MOVE      PTMAS006,PGNAME
          ENDIF
.
          MATCH     PTMAS007,Z70
          IF        !@EQUAL
            MOVE      PTMAS007,PPSNAME
          ENDIF
.
          MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
          ENDIF
.
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
          ENDIF
.
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
          ENDIF
.
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
          ENDIF
.
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
          ENDIF
.
          MATCH     PTMAS013,Z70
          IF        !@EQUAL
            MOVE      PTMAS013,PTELEP
          ENDIF
.
          MATCH     PTMAS014,Z70
          IF        !@EQUAL
            MOVE      PTMAS014,PTELEB
          ENDIF
.
          MATCH     PTMAS015,Z70
          IF        !@EQUAL
            MOVE      PTMAS015,PSEX
          ENDIF
.
          MATCH     PTMAS016,Z70
          IF        !@EQUAL
            MOVE      PTMAS016,PMSTAT
          ENDIF
.
          MATCH     PTMAS017,Z70
          IF        !@EQUAL
            MOVE      PTMAS017,PBDATE
          ENDIF
.
          COMPARE   PTMAS018,ZERO
          IF        !@EQUAL
            MOVE      PTMAS018,PSAGE
          ENDIF
.
          MATCH     PTMAS019,Z70
          IF        !@EQUAL
            MOVE      PTMAS019,PCONT
          ENDIF
.
          MATCH     PTMAS020,Z70
          IF        !@EQUAL
            MOVE      PTMAS020,PREG
          ENDIF
.
          MATCH     PTMAS021,Z70
          IF        !@EQUAL
            MOVE      PTMAS021,PTYPE
          ENDIF
.
          MATCH     PTMAS022,Z70
          IF        !@EQUAL
            MOVE      PTMAS022,POCCUP
          ENDIF
.
          MATCH     PTMAS023,Z70
          IF        !@EQUAL
            MOVE      PTMAS023,PMEDI
          ENDIF
.
          MATCH     PTMAS024,Z70
          IF        !@EQUAL
            MOVE      PTMAS024,PPENNO
          ENDIF
.
          MATCH     PTMAS025,Z70
          IF        !@EQUAL
            MOVE      PTMAS025,PPNDTE
          ENDIF
.
          MATCH     PTMAS026,Z70
          IF        !@EQUAL
            MOVE      PTMAS026,PREPAT
          ENDIF
.
          COMPARE   PTMAS027,ZERO
          IF        !@EQUAL
            MOVE      PTMAS027,PSMOK
          ENDIF
.
          MATCH     PTMAS028,Z70
          IF        !@EQUAL
            MOVE      PTMAS028,PMICRO
          ENDIF
.
          COMPARE   PTMAS029,ZERO
          IF        !@EQUAL
            MOVE      PTMAS029,PCEASE
          ELSE
            MOVE      ZERO,PCEASE
          ENDIF
.
          COMPARE   PTMAS030,ZERO
          IF        !@EQUAL
            MOVE      PTMAS030,PCASE
          ENDIF
.
          COMPARE   PTMAS031,ZERO
          IF        !@EQUAL
            MOVE      PTMAS031,PAUTOPY
          ENDIF
.
          MATCH     PTMAS032,Z70
          IF        !@EQUAL
            MOVE      PTMAS032,PHIGH1
          ENDIF
.
          MATCH     PTMAS033,Z70
          IF        !@EQUAL
            MOVE      PTMAS033,PHIGH2
          ENDIF
.
          MATCH     PTMAS034,Z70
          IF        !@EQUAL
            MOVE      PTMAS034,PHIGH3
          ENDIF
.
          MATCH     PTMAS035,Z70
          IF        !@EQUAL
            MOVE      PTMAS035,PLOCDOC
          ENDIF
.
          MATCH     PTMAS036,Z70
          IF        !@EQUAL
            MOVE      PTMAS036,PFUNDH
          ENDIF
.
          MATCH     PTMAS037,Z70
          IF        !@EQUAL
            MOVE      PTMAS037,PFNDTB
          ENDIF
.
          MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PFNDMM
          ENDIF
.
          MATCH     PTMAS039,Z70
          IF        !@EQUAL
            MOVE      PTMAS039,PUSR1
          ENDIF
.
          MATCH     PTMAS040,Z70
          IF        !@EQUAL
            MOVE      PTMAS040,PUSR2
          ENDIF
.
          MATCH     PTMAS041,Z70
          IF        !@EQUAL
            MOVE      PTMAS041,PUSR3
          ENDIF
.
          MATCH     PTMAS042,Z70
          IF        !@EQUAL
            MOVE      PTMAS042,PUSR4
          ENDIF
.
          MATCH     PTMAS043,Z70
          IF        !@EQUAL
            MOVE      PTMAS043,PUSR5
          ENDIF
.
          MATCH     PTMAS044,Z70
          IF        !@EQUAL
            MOVE      PTMAS044,PUSR6
          ENDIF
.
          COMPARE   PTMAS045,ZERO
          IF        !@EQUAL
            MOVE      PTMAS045,PUYN1
          ENDIF
.
          COMPARE   PTMAS046,ZERO
          IF        !@EQUAL
            MOVE      PTMAS046,PUYN2
          ENDIF
.
          COMPARE   PTMAS047,ZERO
          IF        !@EQUAL
            MOVE      PTMAS047,PUYN3
          ENDIF
.
          COMPARE   PTMAS048,ZERO
          IF        !@EQUAL
            MOVE      PTMAS048,PYRRES
          ENDIF
.
          MATCH     PTMAS049,Z70
          IF        !@EQUAL
            MOVE      PTMAS049,PNKNAME
          ENDIF
.
          MATCH     PTMAS050,Z70
          IF        !@EQUAL
            MOVE      PTMAS050,PNKADD1
          ENDIF
.
          MATCH     PTMAS051,Z70
          IF        !@EQUAL
            MOVE      PTMAS051,PNKADD2
          ENDIF
.
          MATCH     PTMAS052,Z70
          IF        !@EQUAL
            MOVE      PTMAS052,PNKSUBR
          ENDIF
.
          MATCH     PTMAS053,Z70
          IF        !@EQUAL
            MOVE      PTMAS053,PNKADD4
          ENDIF
.
          MATCH     PTMAS054,Z70
          IF        !@EQUAL
            MOVE      PTMAS054,PNKPOST
          ENDIF
.
          MATCH     PTMAS055,Z70
          IF        !@EQUAL
            MOVE      PTMAS055,PNKTELP
          ENDIF
.
          MATCH     PTMAS056,Z70
          IF        !@EQUAL
            MOVE      PTMAS056,PNKTELB
          ENDIF
.
          MATCH     PTMAS057,Z70
          IF        !@EQUAL
            MOVE      PTMAS057,PNKRELP
          ENDIF
.
          COMPARE   PTMAS058,ZERO
          IF        !@EQUAL
            MOVE      PTMAS058,PNXRAY
          ENDIF
.
          MATCH     PTMAS059,Z70
          IF        !@EQUAL
            MOVE      PTMAS059,PFNDYY
          ENDIF
.
          MATCH     PTMAS060,Z70
          IF        !@EQUAL
            MOVE      PTMAS060,PFNDCG
          ENDIF
.
          MATCH     PTMAS061,Z70
          IF        !@EQUAL
            MOVE      PTMAS061,PDECDTE
          ENDIF
.
          MATCH     PTMAS062,Z70
          IF        !@EQUAL
            MOVE      PTMAS062,PDIET
          ENDIF
.
          MATCH     PTMAS063,Z70
          IF        !@EQUAL
            MOVE      PTMAS063,PINITHOS
          ENDIF
.
          MATCH     PTMAS064,Z70
          IF        !@EQUAL
            MOVE      PTMAS064,PTMAEMPC
          ENDIF
.
          MATCH     PTMAS065,Z70
          IF        !@EQUAL
            MOVE      PTMAS065,PTMANOKO
          ENDIF
.
          MATCH     PTMAS066,Z70
          IF        !@EQUAL
            MOVE      PTMAS066,PTMANOKE
          ENDIF
.
MVPRAM99  RETURN
.
.*******************************************************************************
.                         Show Booking Details
.*******************************************************************************
SHWBOK00  PACK      CASEKEYS,CASEKEYS,SP70
          MATCH     SP70,CASEKEYS
          GOTO      SHWBOK30 IF NOT EQUAL
.
          MATCH     "001",TEMPLATE          * Skip if only have U/R details
          GOTO      SHWBOK40 IF EQUAL
.
          MATCH     "002",TEMPLATE          * Skip if only have U/R details
          GOTO      SHWBOK40 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,SHWBOK10
          COMPARE   "2",PVITYPE
          GOTO      SHWBOK94 IF NOT EQUAL
.
          CALL      OUTVIS00
          BRANCH    EXIT,SHWBOK99
          GOTO      SHWBOK30
.
SHWBOK10  MOVE      ADMISSNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,SHWBOK97
          CALL      OUTPRE00
          BRANCH    EXIT,SHWBOK99
          GOTO      SHWBOK30
.
SHWBOK30  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,SHWBOK95
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=1
            MOVE      SP70,OPDICODE
            MOVE      SP70,OPDIDESC
.                                           *** HPS Code Starts Here ***
            MOVE      SP70,OPDICOD2
            MOVE      SP70,OPDIDES2
            MOVE      SP70,OPDICOD3
            MOVE      SP70,OPDIDES3
            MOVE      SP70,OPDICOD4
            MOVE      SP70,OPDIDES4
            MOVE      SP70,OPDICOD5
            MOVE      SP70,OPDIDES5
.                                           *** HPS Code Ends Here ***
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      CASEKEYS,SESSKEYS
          CALL      SESDET00
          BRANCH    EXIT,SHWBOK96
.
          MOVE      OSECLIN,CLINICID  * Setup Clinic ID
          MOVE      OSESITE,SITECODE  * Site Code
          CALL      GETMAP00          * Get Template Mapping
.
          CALL      CLOUTBOB
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,SHWBOK97
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
.
          CALL      CLPATMAS
          CALL      CLPMSPX2
          MATCH     "       0",OBAURNO
          IF        @EQUAL
            MOVE      OBAOUTNO,KEY8           * visit number
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,OBAURNO            * r5
            CALL      RDMAST1
            BRANCH    OVRCD,SHWBOK93
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
          CALL      PATNAA00
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          COMPARE   ONE,PTCNNHII
          GOTO      SHWBOK80 IF NOT EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,SHWBOK98
.
.         CALL      CHKHCU00
.         BRANCH    EXIT,SHWBOK99
          MOVE      ZERO,READDNR     * Set Flag as Donor Details Not Read
.
. HPS Code Starts Here
          GOTO      SHWBOK80
SHWBOK40  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SHWBOK99
          CALL      RDPMPX21
          BRANCH    OVRCD,SHWBOK99
. HPS Code Ends Here
.
SHWBOK80  MOVE      "Appointment Details",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,SHWBOK99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      SHWBOK99
.
SHWBOK93  MOVE      "U/R Invalid.",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK94  CLEAR     WEBTITLE
          APPEND    "Visit is Not for a Appointment - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK95  MOVE      "INVALID CASE KEY",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK96  MOVE      "INVALID SESSION KEY",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK97  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK98  MOVE      "INVALID NHI RECORD",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWBOK99
.
SHWBOK99  RETURN
.
+
.*******************************************************************************
.                              Update Booking
.*******************************************************************************
.  Update Type (UPDTTYPE)
.   1 = Print series booking letters
.*******************************************************************************
UPDBOK00  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDBOK89
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,UPDBOK88
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UPDBOK85
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      UPDBOK86 IF LESS
            ELSE
              GOTO      UPDBOK86
            ENDIF
          ENDIF
.
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDBOK85
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MATCH    "1",UPDTTYPE             * Print Letters
          GOTO     UPDBOK10 IF EQUAL
.
          MATCH    "2",UPDTTYPE             * Extra booking screen details
          GOTO     UPDBOK20 IF EQUAL
.
          MATCH    "3",UPDTTYPE             * Cancel Multiple HCP series booking
          GOTO     UPDBOK40 IF EQUAL
.
          MATCH    "4",UPDTTYPE             * Cancel future bookings in
          GOTO     UPDBOK50 IF EQUAL        * a Multiple HCP series
.
          GOTO      UPDBOK89
.----------------------------------------
. Print Series booking letters
.----------------------------------------
UPDBOK10  CALL      SERL0000                * Print series booking letters 
          BRANCH    EXIT,UPDBOK87
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDBOK89
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,UPDBOK88
.
          MOVE      "Letters Printed",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
.----------------------------------------
. Write Extra booking screen details 
.----------------------------------------
UPDBOK20  CALL      XTRB0000                * Write Extra booking screen details
          BRANCH    EXIT,UPDBOK87
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDBOK89
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,UPDBOK88
.
          MOVE      "Extra Screen Details Updated",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
.----------------------------------------   
. Cancel an entire series booking
.----------------------------------------
UPDBOK40  CALL      WREQ0000                * Write new appointment request
          CALL      SERC0000                * Cancel entre series
          BRANCH    EXIT,UPDBOK99
. 
          MOVE      "Series Bookings Cancelled",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
.----------------------------------------  
. Cancel all future booking in a series
.----------------------------------------
UPDBOK50  CALL      WREQ0000                * Write new appointment request
          CALL      SERF0000                * Cancel future bookings in series
          BRANCH    EXIT,UPDBOK99
.
          MOVE      "Series Bookings Cancelled",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
UPDBOK85  MOVE      "Invalid Patient UR",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK86  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK87  MOVE      "Invalid Case",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK88  MOVE      "Invalid Booking Status",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK89  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK99  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILOF,DELETE
          RETURN
.
.------------------------------------------------------------
. Print letters for series bookings print one or multiple letters
.------------------------------------------------------------
SERL0000  MOVE      ZERO,EXIT
.
          PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RDOTLKB1
          BRANCH    OVRCD,SERL9100
.
          CALL      PRNT0000                * Print letter
          BRANCH    PRINTONE,SERL9999       * Only printing one letter
.
          MOVE      ADMISSNO,SERIADMN
SERL1000  CALL      RKOTLKB1
          BRANCH    OVRCD,SERL9000
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      SERL9000 IF NOT EQUAL
.
          MATCH     OTLKOBOK,SERIADMN       * Same series booking original
          GOTO      SERL9000 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      SERL1000 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      SERL9000 IF EQUAL
.
          PACK      KEY36,OTLKLBOK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SERL1000
.
          MATCH     DOBAOUTN,OTLKLBOK       * Check series booking admiss no
          GOTO      SERL1000 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER        * Check if it is the correct U/R
          GOTO      SERL1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    EXIT,SERL1000
.
          CALL      PRNT0000                * Print Letter
.
          GOTO      SERL1000
.
SERL9000  MOVE      SERIADMN,ADMISSNO       * Restore the original admission no
          GOTO      SERL9999
.
SERL9100  MOVE      ONE,EXIT
          GOTO      SERL9999
.
SERL9999  RETURN
.
.------------------------------------------------------------
. Write Extra booking screen details
.------------------------------------------------------------
XTRB0000  MOVE      ZERO,EXIT
.
          COMPARE   TWO,SERIFLAG       * Only process current admission for
          GOTO      XTRB0900 IF EQUAL  * multiple HCP bookings
.  
          PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RDOTLKB1
          BRANCH    OVRCD,XTRB9100
.
XTRB0900  PACK      KEY8,ADMISSNO,SP70
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          CALL      MVOTXS00           * Move CGI parameters to File fields
          MOVE      ADMISSNO,OTXSOUTN
.
          CALL      RAOTXSC1
          IF        OVRCD=1
            CALL      WROTXSC1
          ELSE
            CALL      UPOTXSC1
          ENDIF
.
          COMPARE   TWO,SERIFLAG            * Exit if multiple HCP
          GOTO      XTRB9999 IF EQUAL
.
          MOVE      ADMISSNO,SERIADMN
XTRB1000  CALL      RKOTLKB1
          BRANCH    OVRCD,XTRB9000
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      XTRB9000 IF NOT EQUAL
.
          MATCH     OTLKOBOK,SERIADMN       * Same series booking original
          GOTO      XTRB9000 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      XTRB1000 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      XTRB9000 IF EQUAL
.
          PACK      KEY36,OTLKLBOK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,XTRB1000
.
          MATCH     DOBAOUTN,OTLKLBOK       * Check series booking admiss no
          GOTO      XTRB1000 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER        * Check if it is the correct U/R
          GOTO      XTRB1000 IF NOT EQUAL
.
XTRB6000  MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    EXIT,XTRB1000
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          CALL      MVOTXS00           * Move CGI parameters to File fields
          MOVE      OBAOUTNO,OTXSOUTN
.
          CALL      RAOTXSC1
          IF        OVRCD=1
            CALL      WROTXSC1
          ELSE
            CALL      UPOTXSC1
          ENDIF
.
          GOTO      XTRB1000
.
XTRB9000  MOVE      SERIADMN,ADMISSNO       * Restore the original admission no
          GOTO      XTRB9999
.
XTRB9100  MOVE      ONE,EXIT
          GOTO      XTRB9999
.
XTRB9999  RETURN
.
.*******************************************************************************
.                Get Booking Details Based on Visit File Details
.*******************************************************************************
OUTVIS00  MOVE      PVISITE,WBSESIT
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,OUTVIS99
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTVIS90
          MOVE      ADMISSNO,KEY8
          CALL      RDOTXSC1
.
          PACK      CASEKEYS,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDSBOKA1
OUTVIS10  CALL      RDKBOKA1
          BRANCH    OVRCD,OUTVIS90
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     KEY20,CASEKEYS
          GOTO      OUTVIS90 IF NOT EQUAL
          MATCH     OBAOUTNO,PVIBILL         * Set up billing number
          GOTO      OUTVIS10 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      OUTVIS99
.
OUTVIS90  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OUTVIS99
.
OUTVIS99  RETURN
.
.
.*******************************************************************************
.             Get Booking Details Based on Pre-Attendance Details
.*******************************************************************************
OUTPRE00  MOVE      OPRSITE,WBSESIT
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,OUTPRE99
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTPRE90
          MOVE      ADMISSNO,KEY8
          CALL      RDOTXSC1
.
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
          CALL      RDBOKA1
          BRANCH    OVRCD,OUTPRE90
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      ZERO,EXIT
          GOTO      OUTPRE99
.
OUTPRE90  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OUTPRE99
.
OUTPRE99  RETURN
.
.-----------------------------------------------------------------
.                         SESTBL00
. Table of Clinics Session Details Dates : Report 6
. Outputs occurances of a particular Day. eg; Mondays for the Year
.                                              called by: OSES0000
.-----------------------------------------------------------------
SESTBL00  MATCH     SP70,SRCHDATF
          GOTO      SESTBL99 IF EQUAL
.
          MATCH     SP70,SRCHDATT
          GOTO      SESTBL99 IF EQUAL
.
          UNPACK    SRCHDATF,SHOWYEAR,SHOWMNFR    * Show Year/Month from
          UNPACK    SRCHDATT,SHWTYEAR,SHOWMNTO    * Show to Year/Month to
.
          SQUEEZE   SRCHDAYS
          MOVE      SRCHDAYS,LOOKDAY     * Day to Searched
          RESET     SRCHDAYS
.
          UNPACK    SRCHDATF,CCENT,CYEAR,CMON,CDAY
          MOVE      "01",CDAY
          CALL      DAYOFWEK                *1=Mon,2=Tue,3=Wed.....7=Sun
          MOVE      WEEKDAY,FIRSTDAY
.
          MOVE      SHOWMNFR,F2
.
          BRANCH    F2,SESTBL10,SESTBL15,SESTBL20,SESTBL25,SESTBL30:
                       SESTBL35,SESTBL40,SESTBL45,SESTBL50,SESTBL55:
                       SESTBL60,SESTBL65
.
.  Set months(no. of days) and call display routine
.
SESTBL10  MOVE      ONE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * January
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL15 IF NOT EQUAL
.
          MATCH     "01",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL15  MOVE      TWO,MONTHNO             * February
          CALL      LEAPYR00                * Check if Leap Year
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL20 IF NOT EQUAL
.
          MATCH     "02",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL20  MOVE      THREE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * March
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL25 IF NOT EQUAL
.
          MATCH     "03",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL25  MOVE      FOUR,MONTHNO
          MOVE      THIRTY,MONTHTOT         * April
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL30 IF NOT EQUAL
.
          MATCH     "04",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL30  MOVE      FIVE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * May
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL35 IF NOT EQUAL
.
          MATCH     "05",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL35  MOVE      SIX,MONTHNO
          MOVE      THIRTY,MONTHTOT         * June
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL40 IF NOT EQUAL
.
          MATCH     "06",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL40  MOVE      SEVEN,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * July
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL45 IF NOT EQUAL
.
          MATCH     "07",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL45  MOVE      EIGHT,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * August
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL50 IF NOT EQUAL
.
          MATCH     "08",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL50  MOVE      NINE,MONTHNO
          MOVE      THIRTY,MONTHTOT         * September
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL55 IF NOT EQUAL
.
          MATCH     "09",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL55  MOVE      TEN,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * October
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL60 IF NOT EQUAL
.
          MATCH     "10",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL60  MOVE      TEN1,MONTHNO
          MOVE      THIRTY,MONTHTOT         * November
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL65 IF NOT EQUAL
.
          MATCH     "11",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL65  MOVE      TEN2,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * December
          CALL      SESDAT00
.
          MATCH     SHOWYEAR,SHWTYEAR
          GOTO      SESTBL70 IF NOT EQUAL
.
          MATCH     "12",SHOWMNTO  
          GOTO      SESTBL99 IF EQUAL
.
SESTBL70  MATCH     SHWTYEAR,SHOWYEAR
          IF        @LESS
            MOVE      SHOWYEAR,F4
            ADD       ONE,F4
            MOVE      F4,SHOWYEAR
            MOVE      SHOWYEAR,KEY4        * Get first day of year
            CALL      DOFYR000
            BRANCH    EXIT,SESTBL90
            MOVE      FSTDAY,FIRSTDAY
.
            GOTO     SESTBL10
          ENDIF
.
          GOTO      SESTBL99
.

.
.  Error must be displayed this way as within profields
.
SESTBL90  WRITE     HTMLFILE;"<tr>":
                             "<td align=center><br><b>First day of year not ":
                             "set!</td></tr>";
.
SESTBL99  RETURN
.
.-----------------------------------------------------------------
. Outputs occurances of a particula Day. eg; Mondays for the Year
.       INPUTS: LOOKDAY,MONTHNO,MONTHTOT       called by: SESTBL00
.-----------------------------------------------------------------
SESDAT00  MOVE      ONE,DAYNO      * Day of month
          MOVE      ZERO,DISPCOL   * Number of columns to be displayed.
.
          CALL      SESHED00       * Diplay Month Heading
.                                  * Loops through Month
          WHILE     (DAYNO<=MONTHTOT)
            IF        LOOKDAY = FIRSTDAY
              ADD       ONE,DISPCOL
              CALL      SESROW00     * Display Date & CheckBox
            ENDIF
            ADD       ONE,FIRSTDAY
            IF        FIRSTDAY>7
              MOVE      ONE,FIRSTDAY   * Reset Day to 1=Monday
            ENDIF
            ADD       ONE,DAYNO
          DO
          IF          DISPCOL<5
            CALL        SESBLK00   * Last Column in table must be set to "&nbsp"
          ENDIF
.
          WRITE       HTMLFILE;"<tr>" * Close Row
.
SESDAT99  RETURN
.
.----------------------------------------------------------------------
.  Displays Month left justified                    called by: SESDAT00
.----------------------------------------------------------------------
SESHED00  LOAD      MONDESC,MONTHNO,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                    OCT,NOV,DEC
.
          MOVE      MONTHNO,MONTHROW
          REP       " 0",MONTHROW
          ASSIGN    MONTHNO%2,F2
          COMPARE   ZERO,F2
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr class=MonthRowEven><td>";
          ELSE
            WRITE     HTMLFILE;"<tr class=MonthRowOdd><td>";
          ENDIF
          WRITE     HTMLFILE;MONDESC,"</td>"
.
SESHED99  RETURN
.
.----------------------------------------------------------------------
.  Display Date & CheckBox row column               called by: SESDAT00
.----------------------------------------------------------------------
SESROW00  MOVE      "datesrch",KEY8
          MOVE      MONTHNO,KEY2
          REP       " 0",KEY2
          MOVE      DISPCOL,LABEL
          REP       " 0",LABEL
          PACK       DATECGI,KEY8,KEY2,LABEL     * format = "date0101"
.
          MOVE      DAYNO,LABEL
          REP       " 0",LABEL
          PACK      DATE,SHOWYEAR,KEY2,LABEL
.
          WRITE     HTMLFILE;"<td align=right width=5%>":
                            DAYNO,"</td><td><input type=checkbox name=":
                            DATECGI," value=",DATE,">":
                            "</td>"
.
.
          GOTO      SESROW99
.
SESROW99  RETURN
.
.----------------------------------------------------------------------
.  Display row column with Blanks
.  And Output cgi parameter for Javascript Column 5 ticks. As date__05
.  must be present else Javascript error is raised.
.                                                   called by: SESDAT00
.----------------------------------------------------------------------
SESBLK00  MOVE      "&nbsp;",KEY6
.
          MOVE      "dummydat",KEY8
          MOVE      MONTHNO,KEY2
          REP       " 0",KEY2
          ADD       ONE,DISPCOL
          MOVE      DISPCOL,LABEL
          REP       " 0",LABEL
          PACK       DATECGI,KEY8,KEY2,LABEL * format = "date0101"
.
          WRITE     HTMLFILE;"<td align=right width=5%>":
                             KEY6,"</td><td><input type=hidden name=":
                             DATECGI,">",KEY6,"</td>"
.
SESBLK99  RETURN
.
.----------------------------------------------------------------
.  If Leap Year, set Febuary to 29 days else set to 28
.                                             called by: SESTBL00
.----------------------------------------------------------------
LEAPYR00  MOVE      SHOWYEAR,F4
          ASSIGN    F4%FOUR,F2
          COMPARE   ZERO,F2
          IF        @EQUAL
            MOVE      TWENTY9,MONTHTOT   * Leap Year Feb has 29 days
          ELSE
            MOVE      TWENTY8,MONTHTOT   * Not a Leap Year Feb has 28 days
          ENDIF
.
LEAPYR99  RETURN
.
.*******************************************************************************
.                    Show available sessions for a given date
.*******************************************************************************
SHWM0000  MOVE      ZERO,RECCNT
          MOVE      ZERO,RECCNTR
          PACK      KEY25,SRCHDATF,SP70
          CALL      RDSSESA2
SHWM1000  CALL      RDKSESA2
          BRANCH    OVRCD,SHWM9000
.
          MATCH     OSEDATE,SRCHDATF
          GOTO      SHWM9999 IF NOT EQUAL
.
          MATCH     WBSESIT,OSESITE
          GOTO      SHWM1000 IF NOT EQUAL
.
          MATCH     SRCHCLTY,SP70          * are we filtering clinic types
          GOTO      SHWM1050 IF EQUAL      * NO
.
          MATCH     OSESCTYP,SRCHCLTY      * is this the filtered clinic type?
          GOTO      SHWM1000 IF NOT EQUAL  * NO - get next
.
SHWM1050  MOVE      ZERO,SESSFULL
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      CAVL0000               * Check if there are empty slots
          IF        EXIT=1
            MOVE      ONE,SESSFULL
            MOVE      ZERO,EXIT
          ENDIF
.
          CALL      CBOK0000               * Check if U/R already has a booking
.                                          * in this session
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SHWM1000
          BRANCH    OMASTAT,SHWM1000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SHWM1000
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      SHWM1000 IF LESS
.
          CALL      CPUB0000               * Check public holiday range
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF

          BRANCH    MOSAIQCL,SHWM1000       * MOSAIQ Clinic
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,REFRLVIS         * Check if referral populated when
            GOTO      SHWM1000 IF EQUAL     * referral is mandatory
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          MATCH     SP70,FILTLOCA
          IF        !@EQUAL
            MATCH     FILTLOCA,OTHELTYP
            GOTO      SHWM1000 IF NOT EQUAL
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,SHWM1000
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SHWM1000
.
SHWM1100  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
.
          MOVE      DOSEDAY,F1
          LOAD      DAYNAM3,F1,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OSEDATE
          IF        !@EQUAL
            UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",SRCHCARE
          IF        @EQUAL
            CALL      CCAR0000                * Check care team details
            BRANCH    EXIT,SHWM1000
          ENDIF
.
          ADD       ONE,RECCNT
          ADD       ONE,RECCNTR
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MOVE      "seribkey",KEY8
          PACK      SESSNCGI,KEY8,DRECCNT,SP70
.
          MOVE      "seribtim",KEY8
          PACK      SESSTCGI,KEY8,DRECCNT,SP70
.
          IF        HASBFLAG=1
            WRITE     HTMLFILE;"<tr bgcolor=red><td nowrap>&nbsp;";
          ELSE
            IF        PUBLICFL=1
              WRITE     HTMLFILE;"<tr bgcolor=#a0b8c8><td nowrap>&nbsp;";
            ELSE
              WRITE     HTMLFILE;"<tr><td nowrap>&nbsp;";
            ENDIF
          ENDIF
.
          IF        SESSFULL=1
            WRITE     HTMLFILE;"</td>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox ":
                               "name=multsrch",DRECCNT:
                               " onclick=CheckCount(this)":
                               " value=",SESSKEYS,"></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DAYNAM3,"</td>":
                             "<td>&nbsp;",OSESTRT,"</td>":
                             "<td>&nbsp;",OCTDESC,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "<td>&nbsp;",OCADESC,"</td>":
                             "<td>&nbsp;",HASBTIME,"</td>";
.
          ASSIGN    OSESLOTS-OSESLOTB,OEMPTY
          SUB       OSEBNEW,OSESSLTN
          SUB       OSEBRV,OSESSLTR
          SUB       OSEBSPC,OSESSLTS
.
          MATCH     "0",SHOWCNTF 
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",OSESSLTN,"</td>":        * Standard
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSESSLTR,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",OEMPTY,"</td>":          * RCH
                               "<td>&nbsp;",OSEBNEW,"</td>":
                               "<td>&nbsp;",OSEBRV,"</td>":
                               "<td>&nbsp;",OSEBSPC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          COMPARE   ZERO,NORECCNT
          IF        !@EQUAL
            COMPARE   NORECCNT,RECCNTR
            IF        @EQUAL
              WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                   "<td colspan=11 align=center>":
                                   "Search Limit Reached</td>"
              GOTO      SHWM9100
            ENDIF
          ELSE
            COMPARE   NORECORD,RECCNT
            IF        @EQUAL
              WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                   "<td colspan=11 align=center>":
                                   "Search Limit Reached</td>"
              GOTO      SHWM9100
            ENDIF
          ENDIF
          GOTO      SHWM1000
.
SHWM9000  MOVE      ZERO,EXIT
          GOTO      SHWM9999
.
SHWM9100  MOVE      ONE,EXIT
          GOTO      SHWM9999
.
SHWM9999  RETURN
.
.------------------------------------------------------------
. Master Table of Series Bookings
.------------------------------------------------------------
SERTAB00  PACK      KEY24,URNUMBER,SP70
          CALL      RSOTLKB2
SERTAB10  CALL      RKOTLKB2
          BRANCH    OVRCD,SERTAB99
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      SERTAB99 IF NOT EQUAL
.
          MATCH     SP70,OTLKLBOK          * Check all master link records
          GOTO      SERTAB99 IF NOT EQUAL
.
          MATCH     "1",OTLKBSTA           * Booking Cancelled Check outcanaf
          GOTO      SERTAB60 IF EQUAL
.
          PACK      KEY36,OTLKOBOK,SP70    * Clinic Session Booking Table A
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SERTAB10
.
          MATCH     DOBAOUTN,OTLKOBOK
          GOTO      SERTAB10 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1               * Clinic Session Booking Table B
          BRANCH    OVRCD,SERTAB10
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11              * Read visit extn to get hospital id
          IF        OVRCD=1           
            CALL      CLPMSVX1
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SeriesLink('",HTMLLINK
          APPEND    OTLKURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTLKOBOK,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1             * Clinic Type Table
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1             * Clinic Table
          IF        OVRCD=0
            GOTO      SERTAB30
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SERTAB30
.
          MATCH     OBASITE,OCASITE
          GOTO      SERTAB30 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      SERTAB30 IF NOT EQUAL
.
SERTAB30  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBADATE,OBATIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VTYPDESC,"#",":
                             "#"",OTLKOBOK,"#",":
                             "#"",OTLKLBOK,"#",";
          BRANCH    OBASTAT,SERTAB51,SERTAB52,SERTAB53,SERTAB54,SERTAB55:
                            SERTAB56
          WRITE     HTMLFILE;"#" #",";
          GOTO      SERTAB58
.
SERTAB51  WRITE     HTMLFILE;"#"Booked#",";
          GOTO      SERTAB58
SERTAB52  WRITE     HTMLFILE;"#"Not Used#",";
          GOTO      SERTAB58
SERTAB53  WRITE     HTMLFILE;"#"Extended Slot#",";
          GOTO      SERTAB58
SERTAB54  WRITE     HTMLFILE;"#"Attended#",";
          GOTO      SERTAB58
SERTAB55  WRITE     HTMLFILE;"#"DNA#",";
          GOTO      SERTAB58
SERTAB56  WRITE     HTMLFILE;"#"Suspended#",";
          GOTO      SERTAB58
.
SERTAB58  WRITE     HTMLFILE;"#"",PMVXMHOS,"#");"
          GOTO      SERTAB10
.
SERTAB60  PACK      KEY8,OTLKOBOK,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,SERTAB10
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SeriesLink('",HTMLLINK
          APPEND    OTLKURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTLKOBOK,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SERTAB10
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SERTAB10
.
          MOVE      "CV",CATEGORY
          MOVE      OPCNVTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      SERTAB75
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,SERTAB72
.
          MATCH     OPCNSITE,OCASITE
          GOTO      SERTAB72 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      SERTAB72 IF NOT EQUAL
          GOTO      SERTAB75
.
SERTAB72  MOVE      OPCNCLIN,OCADESC
.
SERTAB75  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPCNDATE,OPCNTIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VTYPDESC,"#",":
                             "#"",OTLKOBOK,"#",":
                             "#"",OTLKLBOK,"#",":
                             "#"Cancelled#",":
                             "#"",OTHEHOSP,"#");"
.
          GOTO      SERTAB10
.
SERTAB99  RETURN
.
.------------------------------------------------------------
. List all bookings for a series
.------------------------------------------------------------
SERBOK00  PACK      KEY24,URNUMBER,SERIESNO,SP70
          CALL      RDOTLKB1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            MOVE      OTLKOBOK,OTLKLBOK
            GOTO      SERBOK15
          ENDIF
.
          CALL      RSOTLKB1
SERBOK10  CALL      RKOTLKB1
          BRANCH    OVRCD,SERBOK99
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      SERBOK99 IF NOT EQUAL
.
          MATCH     SERIESNO,OTLKOBOK
          GOTO      SERBOK99 IF NOT EQUAL
.
          MATCH     SP70,OTLKLBOK          * Check all master link records
          GOTO      SERBOK10 IF EQUAL
.
SERBOK15  MATCH     "1",OTLKBSTA           * Booking Cancelled Check outcanaf
          GOTO      SERBOK60 IF EQUAL
.
          PACK      KEY36,OTLKLBOK,SP70    * Clinic Session Booking Table A
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SERBOK10
.
          MATCH     DOBAOUTN,OTLKLBOK
          GOTO      SERBOK10 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1               * Clinic Session Booking Table B
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CLEAR     HTMLLINK
          APPEND    "javascript:AppointLink('",HTMLLINK
          APPEND    KEY28,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SERBOK10
.
          MATCH     SP70,OTLKLUID
          GOTO      SERBOK25 IF EQUAL
.
          MOVE      SP70,WBSENAM
          PACK      KEY10,OTLKLUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      OTLKLUID,WBSENAM
          ENDIF
.
SERBOK25  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1             * Clinic Type Table
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1             * Clinic Table
          IF        OVRCD=0
            GOTO      SERBOK30
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SERBOK30
.
          MATCH     OBASITE,OCASITE
          GOTO      SERBOK30 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      SERBOK30 IF NOT EQUAL
.
SERBOK30  MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBADATE,OBATIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VTYPDESC,"#",":
                             "#"",OTLKOBOK,"#",":
                             "#"",OTLKLBOK,"#",":
                             "#"",WBSENAM,"#",";
          BRANCH    OBASTAT,SERBOK51,SERBOK52,SERBOK53,SERBOK54,SERBOK55:
                            SERBOK56
          WRITE     HTMLFILE;"#" #");"
          GOTO      SERBOK10
.
SERBOK51  WRITE     HTMLFILE;"#"Booked#");"
          GOTO      SERBOK10
SERBOK52  WRITE     HTMLFILE;"#"Not Used#");"
          GOTO      SERBOK10
SERBOK53  WRITE     HTMLFILE;"#"Extended Slot#");"
          GOTO      SERBOK10
SERBOK54  WRITE     HTMLFILE;"#"Attended#");"
          GOTO      SERBOK10
SERBOK55  WRITE     HTMLFILE;"#"DNA#");"
          GOTO      SERBOK10
SERBOK56  WRITE     HTMLFILE;"#"Suspended#");"
          GOTO      SERBOK10
.
SERBOK60  PACK      KEY8,OTLKLBOK,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,SERBOK10
.
          MOVE      "javascript:alert('This bookings is cancelled')",HTMLLINK
.
          PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SERBOK10
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SERBOK10
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,OTLKLUID
          GOTO      SERBOK56 IF EQUAL
.
          PACK      KEY10,OTLKLUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      OTLKLUID,WBSENAM
          ENDIF
.
SERBOK65  MOVE      "CV",CATEGORY
          MOVE      OPCNVTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      SERBOK75
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,SERBOK72
.
          MATCH     OPCNSITE,OCASITE
          GOTO      SERBOK72 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      SERBOK72 IF NOT EQUAL
          GOTO      SERBOK75
.
SERBOK72  MOVE      OPCNCLIN,OCADESC
.
SERBOK75  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPCNDATE,OPCNTIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VTYPDESC,"#",":
                             "#"",OTLKOBOK,"#",":
                             "#"",OTLKLBOK,"#",":
                             "#"",WBSENAM,"#",":
                             "#"Cancelled#");"
.
          GOTO      SERBOK10
.
SERBOK99  RETURN
.
.
.------------------------------------------------------------
. Cancel an entire series of booking
.------------------------------------------------------------
SERC0000  PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RDOTLKB1
          BRANCH    OVRCD,SERC9100
.
          PACK      SAVKEY24,OTLKURNO,OTLKOBOK,OTLKLBOK,SP70
.
          CALL      CANS0000                * Cancel booking
          BRANCH    EXIT,SERC9999
.
          MOVE      SAVKEY24,KEY24          * re-position on saved record
          CALL      RDOTLKB1
          BRANCH    OVRCD,SERC9100
.
          MOVE      ADMISSNO,PARNTBOK
SERC1000  CALL      RKOTLKB1
          BRANCH    OVRCD,SERC9000
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      SERC9000 IF NOT EQUAL
.
          MATCH     OTLKOBOK,PARNTBOK       * Same series booking original
          GOTO      SERC9000 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      SERC1000 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      SERC9000 IF EQUAL
.
          MOVE      OTLKLBOK,ADMISSNO
.
          PACK      SAVKEY24,OTLKURNO,OTLKOBOK,OTLKLBOK,SP70
.
          CALL      CANS0000                * Cancel booking                  
          BRANCH    EXIT,SERC9999
.                                       
          MOVE      SAVKEY24,KEY24          * re-position of saved record
          CALL      RDOTLKB1
          BRANCH    OVRCD,SERC9100
.
          GOTO      SERC1000
.
SERC9000  MOVE      PARNTBOK,ADMISSNO       * Restore the original admission no
          GOTO      SERC9999
.
SERC9100  MOVE      "Invalid Master series booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERC9999
.
SERC9999  RETURN
.
.------------------------------------------------------------
. Cancel future bookings in a series. Work out what the master
. series booking number is for a child booking. Cancel the child
. booking and all bookings (including the master) after that in the series
. (by booking date/time)
.------------------------------------------------------------
SERF0000  MOVE      ADMISSNO,CHILDBOK       * Save child booking number
          MOVE      SP70,PARNTBOK
.         
          PACK      KEY24,URNUMBER,CHILDBOK,SP70
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,SERF9100
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      SERF9100 IF NOT EQUAL
.
          MATCH     OTLKLBOK,CHILDBOK       * Same child booking for
          GOTO      SERF9100 IF NOT EQUAL   * this series
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      SERF9100 IF EQUAL
.
          MOVE      OTLKOBOK,PARNTBOK       * Save master series booking
          MOVE      OTLKLBOK,ADMISSNO
          PACK      SAVKEY24,OTLKURNO,OTLKOBOK,OTLKLBOK,SP70
.
          MOVE      SP70,DIM13A
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SERF9000
.
          MATCH     DOBAOUTN,ADMISSNO
          GOTO      SERF9000 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER
          GOTO      SERF9000 IF NOT EQUAL
.
          PACK      DIM13A,OBADATE,OBATIME,SP70  * Save first booking date/time
.
          CALL      CANS0000                     * Cancel booking
          BRANCH    EXIT,SERF9999
.
          PACK      KEY36,PARNTBOK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6                * Get master booking details
          BRANCH    OVRCD,SERF0500
.
          MATCH     DOBAOUTN,PARNTBOK       * Check series mater booking admiss
          GOTO      SERF0500 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER        * Check if it is the correct U/R
          GOTO      SERF0500 IF NOT EQUAL
.
          PACK      DIM13B,OBADATE,OBATIME,SP70
.
          MATCH     DIM13A,DIM13B           * Check if this master booking is a
          GOTO      SERF0500 IF LESS        * future booking by date/time in the
.                                           * series
          MOVE      PARNTBOK,ADMISSNO
.
          CALL      CANS0000                * Cancel booking
          BRANCH    EXIT,SERF9999
.
SERF0500  PACK      KEY24,URNUMBER,PARNTBOK,SP70
          CALL      RSOTLKB1
SERF1000  CALL      RKOTLKB1                * Skips master booking
          BRANCH    OVRCD,SERF9000
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      SERF9000 IF NOT EQUAL
.
          MATCH     OTLKOBOK,PARNTBOK       * Same series booking original
          GOTO      SERF9000 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      SERF1000 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      SERF9000 IF EQUAL
.
          PACK      KEY36,OTLKLBOK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SERF1000
.
          MATCH     DOBAOUTN,OTLKLBOK       * Check series booking admiss no
          GOTO      SERF1000 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER        * Check if it is the correct U/R
          GOTO      SERF1000 IF NOT EQUAL
.
          PACK      DIM13B,OBADATE,OBATIME,SP70
.
          MATCH     DIM13A,DIM13B           * Check if this booking is a future
          GOTO      SERF1000 IF LESS        * booking by date/time in the series
.
          MOVE      OTLKLBOK,ADMISSNO
.
          PACK      SAVKEY24,OTLKURNO,OTLKOBOK,OTLKLBOK,SP70
.
          CALL      CANS0000                * Cancel booking
          BRANCH    EXIT,SERF9999
.
          MOVE      SAVKEY24,KEY24          * re-position of saved record
          CALL      RDOTLKB1
          BRANCH    OVRCD,SERF9100
.
          GOTO      SERF1000
.
SERF9000  MOVE      CHILDBOK,ADMISSNO       * Restore the original admission no
          GOTO      SERF9999
.
SERF9100  MOVE      "Invalid series booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SERF9999
.
SERF9999  RETURN
.
.*******************************************************************************
.  Cancel a single booking - See CANS0000 in OUTWEB02
.*******************************************************************************
CANS0000  MOVE      ZERO,OVERBOOK
          BRANCH    OTXFLAG,CANS0500        * bypass if no comments    *I-48413
          CALL      UPCOM000                * update text comments     *I-48413
.
CANS0500  PACK      KEY36,ADMISSNO,SP70                                *C-48413
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CANS9910
.
          MATCH     DOBAOUTN,ADMISSNO       * Check series booking admiss no
          GOTO      CANS9910 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER        * Check if it is the correct U/R
          GOTO      CANS9910 IF NOT EQUAL
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      CASEKEYS,KEY28
          MOVE      CASEKEYS,SAVSKEYS
.
          CALL      RDBOKA1
          BRANCH    OVRCD,CANS9910,CANS9920
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CANS9910
          MOVE      OBAOUTNO,KEY8
          COMPARE   ONE,OBASTAT              * Make sure record is booked
          GOTO      CANS1000 IF EQUAL        * Record is booked.
          COMPARE   SIX,OBASTAT              * Is this a suspended booking?
          GOTO      CANS9930 IF NOT EQUAL    * No, exit.
.
CANS1000  CALL      CHKD0000                 * Check for deposits
          BRANCH    EXIT,CANS9940
.
          CALL      LOGC0000                 * Log the cancellation of booking
          BRANCH    EXIT,CANS9910            * Input aborted
.
          CALL      COPD0000                 * Write OPD Cancel action
.
          CALL      INTDEL00                 * Delete Interpretor Details
.
          CALL      CLET0000                 * Clear referral letter booking
.
          CALL      DLNK0000                 * Delete A/H referral link
.
          CALL      DHIC0000                 * Delete HIC CMBS items (if any)
.         
          CALL      DTRN0000                 * Delete Transport Details(if any)
.
          MOVE      OBAOUTNO,KEY8            * Key for the bokb file
          CALL      DEBOKB1                  * Delete the bokb record
          MOVE      FOUR,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOB                 * write the audit
.
          CALL      CWAT0000                 * Cancel waiting list link PAC
          CALL      CWAI0000                 * Cancel waiting list link PAS
.
          MOVE      ONE,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          CALL      SCAN0000                 * Cancel series booking
.
          MOVE      OBAOUTNO,KEY8            * Key for the bokc file
          CALL      RAOTBOC1
          IF        OVRCD = 0
            CALL      DEOTBOC1               * Delete the bokc record
          ENDIF
.
          MOVE      OBAOUTNO,KEY8            * Key for the diagnosis file
          CALL      DEDIAG1                  * Delete the diagnosis record
.
          MOVE      OBAOUTNO,KEY8            * Key for the preaf file
          CALL      DEPREA1                  * Delete the preaf record
.
          MOVE      OBAOUTNO,KEY8            * Key for the visit extn file
          CALL      DEPMVX11                 * Delete the pmsvx1af record
.
          MOVE      CASEKEYS,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,CANS5000
.
CANS5000  MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
.
          CALL      RMDIS000                 * Remove Disaster Details
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          BRANCH    OVRCD,CANS6000           * Check for extended slots
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANS5500
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK           * Yes it is an over bookings
          ENDIF                              * so delete slots
.
CANS5500  CALL      CHKSUS00                 * Check Clinic Master Suspension
          IF        EXIT = 1
            MOVE      SIX,SLOTSTAT           * Suspended - set status to Susp.
          ELSE
            MOVE      ZERO,SLOTSTAT          * Not Suspended - reset status
          ENDIF
.
          MOVE      SLOTSTAT,OBASTAT         * Set slot status
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      CANS5050 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
CANS5050      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                * Delete this over booking slot
          ELSE
            CALL      UPBOKA1                * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
.
.         Check for any extended slots that also need to be cleared
.
          PACK      SAVSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RCAL0000               * Recalculate clinic counts as a
.
          MOVE      CASEKEYS,KEY25
          CALL      RDSESA1
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          MOVE      OBASLOT,VSLOT            * Correct parent ?
.
CANS6000  CALL      RDKBOKA1                 * Get the next booking record
          BRANCH    OVRCD,CANS9000           * Booking cancelled.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,CASEKEYS            * Correct session ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
          COMPARE   THREE,OBASTAT            * Is this an extended slot ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
.
          MOVE      OBAEXSL,SLOTOPT          * Move parent slot to a dim field
          MATCH     SLOTOPT,VSLOT            * Correct parent ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
.
          MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
.
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
.
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      CANS6050 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
CANS6050      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
.
            MOVE      ZERO,OBAEXSL           * Clear parent slot number
            MOVE      SLOTSTAT,OBASTAT       * Set slot status
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                  * Clear this slot
            CALL      RDSBOKA1
          ELSE
            CALL      UPBOKA1                  * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
          GOTO      CANS6000                 * Check for another extended slot
.
CANS9000  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          IF        OVRCD=1
            CALL      CLOUTBOA               * Clear outbokaf variables
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CANS9999
.
CANS9910  MOVE      "Booking Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9920  MOVE      "Booking Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9930  MOVE      "Booking has the wrong status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9940  MOVE      "Deposits Exist - Booking not cancelled",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9999  RETURN
.
.
.******************************************************************************
.*             LOGC0000: Log the cancellation of a booking                    *
.******************************************************************************
LOGC0000  MOVE      OBAOUTNO,KEY8            * Key for the bokb record
          CALL      RDBOKB1                  * Read in the bokb record
          BRANCH    OVRCD,LOGC9999           * Details missing
.
.         Open the log file and post the record
.
          MOVE      OUTBB053,OPCNREAS        * Reason
          MOVE      OBASITE,OPCNSITE         * Site
          MOVE      OBACLIN,OPCNCLIN         * Clinic Id
          MOVE      OBADATE,OPCNDATE         * Booking Date
          MOVE      OBASTRT,OPCNSTRT         * Clinic Start Time
          MOVE      OBASLOT,OPCNSLOT         * Booking Slot Number
          MOVE      OBATIME,OPCNTIME         * Booking Slot Time
          MOVE      OBAOUTNO,OPCNOUTN        * Outpatient Number
          MOVE      OBAURNO,OPCNURNO         * Site
          PACK      OPCNRDTE,CCC,CYY,CMM,CDD * Cancellation date
          REP       " 0",OPCNRDTE        * Zero-fill Cancellation DAte
          CLOCK     TIME,OPCNRTIM            * Cancellation Time
          MOVE      OBASRCR,OPCNSRCR         * Source of Referral
          MOVE      OBACOMP,OPCNCOMP         * Compensation Eligibilty
          MOVE      OBACLASS,OPCNCLAS        * Patient Classification
          MOVE      OBAINS,OPCNINS           * U1 User Defined field
          MOVE      OBACAT,OPCNCAT           * Patient Category
          MOVE      OBAPRTY,OPCNPRTY         * Priority Code
          MOVE      OTBBTRAN,OPCNTRAN        * Transport Allocation (cat oB)
          MOVE      OBAVISIT,OPCNVTYP        * Visit type (Cat CV)
          MOVE      SP70,OPCNSPAR            * Spare Variable
          MOVE      PASSCODE,OPCNOPER
.
          MOVE      OBACTYP,OPCNCTYP         * Clinic Type
          MOVE      OTBBNMDS,OPCNNMDS        * NMDS Clinic (Cat NM)
          MOVE      OTBBSRVD,OPCNSRVC        * Service Delivery (Cat sd)
          MOVE      OTBBCART,OPCNCART        * Care Type (Cat CC)
          MOVE      OBABKDTE,OPCNBKDT        * Book Date/Time
.
          MOVE      SP70,OPCNREFN            * linked AH referral number
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,LOGC0800          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      LOGC0800 IF NOT EQUAL
.
          MOVE      ALLNVISN,OPCNREFN        * linked AH referral number
.
LOGC0800  MOVE      OPCNOUTN,KEY8            * Key for file
          CALL      RAOTCAN1
          BRANCH    OVRCD,LOGC1000           * not exists
          CALL      UPOTCAN1                 * Update the cancellation record
          GOTO      LOGC2000
.
LOGC1000  CALL      WROTCAN1                 * Write the cancellation record
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOC                * DG O/P Cancel Appoint    *I-90203
.
LOGC2000  MOVE      ZERO,EXIT
          GOTO      LOGC9999
.
LOGC9500  MOVE      ONE,EXIT
LOGC9999  RETURN
.
.******************************************** Start of addition        *I-48413
.------------------------------------------------------------
.  Cancellation text comments
.------------------------------------------------------------
.         copy the comments back to file - first delete existing comments
.
UPCOM000  MOVE      "005",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
UPCOM400  CALL      RKVSCMT1
          BRANCH    OVRCD,UPCOM500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      UPCOM500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      UPCOM400
.
.         now write the new comments back
.
UPCOM500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCOM999
.
UPCOM510  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          IF        @EQUAL
            IF        F3>=OTXWEND
              GOTO      UPCOM999
            ELSE
              GOTO      UPCOM510
            ENDIF
          ENDIF
.
          MOVE      F3,VSCTLINE
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RAVSCMT1
          IF        OVRCD=1
            CALL      WRVSCMT1
          ENDIF
.
          IF        F3>=OTXWEND
            GOTO      UPCOM999
          ENDIF
          GOTO      UPCOM510
.
UPCOM999  MOVE      ONE,OTXFLAG
          RETURN
.********************************************   End of addition        *I-48413
.
.*******************************************************************************
. Delete Interpreter Table Record
. Input  - OBAURNO
.          OBAOUTNO
.*******************************************************************************
INTDEL00  PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTDEL99
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          GOTO      INTDEL10 IF EQUAL
.
          MATCH     "1",PMPXINTR
          GOTO      INTDEL99 IF NOT EQUAL
.
INTDEL10  PACK      KEY8,OBAOUTNO
          CALL      RDVSINT1
          IF        OVRCD=0
            CALL      DEVSINT1           * Delete record from Int.Table(Cancel)
            MOVE      "D",INTAUDTY
            CALL      INTAUD00           * Add record to Int.Audit after Delete
          ENDIF
          MOVE      ZERO,EXIT
INTDEL99  RETURN
.
.******************************************************************************
.                                 AUDOTBOA
.    Audits for patient outpatients bookings file (outaudba)
.*******************************************************************************
AUDOTBOA  READ      CONTROLF,THIRTY1;*51,HOAUDA,*52,HOAUDB
          BRANCH    HOAUDA,OTBOA999
.
.
          COMPARE   THREE,AUDIFLAG     * is it a after ?
          GOTO      OTBOA200 IF EQUAL
.
          COMPARE   FIVE,AUDIFLAG      * is it a delete ?
          GOTO      OTBOA600 IF EQUAL
.
          CALL      IBACLOCK           * get current date
          PACK      OTBAAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OTBAAUDD
          CLOCK     TIME,OTBAAUDT      * clock current time
          MOVE      ONE,OTBAAUDS       * set print status
          MOVE      PASSCODE,OTBAAUDO  * get user ID
          MOVE      PORT,OTBAAUDP      * get port number
.
          BRANCH    AUDIFLAG,OTBOA200,OTBOA200,OTBOA200,OTBOA200,OTBOA600
          GOTO      OTBOA999

OTBOA200  MOVE      AUDIFLAG,OTBAAUDR
          REPLACE   "1A2B3C4D",OTBAAUDR
          PACK      KEY19,OTBAAUDD,OTBAAUDT,OTBAAUDP,OTBAAUDR
          CALL      AWOTBOA           * write to audit file
          GOTO      OTBOA999
.
OTBOA600  PACK      KEY19,OTBAAUDD,OTBAAUDT,OTBAAUDP,ANSB
          CALL      ADOTBOA           * delete audit file
.
OTBOA999  RETURN
.
+
.****************************************************************************
.                        AUDIT ROUTINES for BOKB
.    AUDIFLAG : 1   Write a A audit to file
.               2   Write a B audit to file
.               3   Write a C audit to file
.               4   Write a D audit to file
.               5   Delete  B audit to file
.****************************************************************************
.                                 AUDOTBOB
.    Audits for patient outpatients bookings file (outaudb1)
.****************************************************************************
AUDOTBOB  READ      CONTROLF,THIRTY1;*51,HOAUDA,*52,HOAUDB
          BRANCH    HOAUDB,OTBOB999
.
          COMPARE   THREE,AUDIFLAG     * is it a delete ?
          GOTO      OTBOB200 IF EQUAL
.
          COMPARE   FIVE,AUDIFLAG      * is it a delete ?
          GOTO      OTBOB600 IF EQUAL
.
          CALL      IBACLOCK           * get current date
          PACK      OTBBAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OTBBAUDD
          CLOCK     TIME,OTBBAUDT      * clock current time
          MOVE      ONE,OTBBAUDS       * set print status
          MOVE      PASSCODE,OTBBAUDO  * get user ID
          MOVE      PORT,OTBBAUDP      * get port number
.
          BRANCH    AUDIFLAG,OTBOB200,OTBOB200,OTBOB200,OTBOB200,OTBOB600
          GOTO      OTBOB999
.
OTBOB200  MOVE      AUDIFLAG,OTBBAUDR
          REPLACE   "1A2B3C4D",OTBBAUDR
          PACK      KEY19,OTBBAUDD,OTBBAUDT,OTBBAUDP,OTBBAUDR
          MOVE      IDDD,OTBBSITE
          CALL      AWOTBOB           * write to audit file
          GOTO      OTBOB999
.
OTBOB600  PACK      KEY19,OTBBAUDD,OTBBAUDT,OTBBAUDP,ANSB
          CALL      ADOTBOB           * delete audit file
.
OTBOB999  RETURN
.
.**********************************************************************
.*  SCAN0000  - Update the status of a series booking to cancelled    *
.*              OTLKBSTA  1=Cancelled  0=Not Cancelled                *
.**********************************************************************
SCAN0000  PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Is this a master record
          CALL      RDOTLKB1
          BRANCH    OVRCD,SCAN1000
.
          MOVE      ONE,OTLKBSTA
          PACK      OTLKUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",OTLKUDAT
          MOVE      CTIMEIS,OTLKUTIM
          MOVE      WBSEUID,OTLKUUID
          CALL      UPOTLKB1
          GOTO      SCAN9999
.
SCAN1000  PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Check non master records
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,SCAN9999
.
          MATCH     OBAURNO,OTLKURNO
          GOTO      SCAN9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,OTLKLBOK
          GOTO      SCAN9999 IF NOT EQUAL
.
          MOVE      ONE,OTLKBSTA
          PACK      OTLKUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",OTLKUDAT
          MOVE      CTIMEIS,OTLKUTIM
          MOVE      WBSEUID,OTLKUUID
          CALL      UPOTLKB2
.
SCAN9999  RETURN
.
.**********************************************************************
.*  CPUB0000  - Check to see is the session date is with +/- 2 Days   *
.*              from a public holiday. PUBLICFL 1=Yes 0=No            *
.**********************************************************************
CPUB0000  MOVE      ZERO,PUBLICFL
.
          PACK      KEY11,OSEDATE,SP70
          CALL      RDPHOA1                       * Public holiday all hospitals
          IF        OVRCD=1
            IF        IBCNMHOS=1
              PACK      KEY11,DATE,OTHEHOSP,SP70  * Check for Public Holiday
              CALL      RDPHOA1                   * for the clinics hospital
              BRANCH    OVRCD,CPUB2000
            ENDIF
          ENDIF
.
          MOVE      ONE,PUBLICFL       * Yes this is a public holiday
          GOTO      CPUB9999
.
CPUB2000  PACK      KEY11,OSEDATE,SP70
          CALL      RDSPHOA1
CPUB2100  CALL      RDPPHOA1
          BRANCH    OVRCD,CPUB9999
.
          DAYSEP    OPHDATE,OSEDATE,F8
          IF        F8<=2
            IF        IBCNMHOS=1
              MATCH     SP70,OPHHOSP             * Holiday for all hospitals
              IF        !@EQUAL
                MATCH     OTHEHOSP,OPHHOSP       * Check if holiday is for 
                GOTO      CPUB2100 IF NOT EQUAL  * the clinics hospital
              ENDIF
            ENDIF
.
            MOVE      ONE,PUBLICFL
            GOTO      CPUB9999
          ENDIF
.
          PACK      KEY11,OSEDATE,SP70
          CALL      RDSPHOA1
CPUB3000  CALL      RDKPHOA1
          BRANCH    OVRCD,CPUB9999
.
          DAYSEP    OSEDATE,OPHDATE,F8
          IF        F8<=2
            IF        IBCNMHOS=1
              MATCH     SP70,OPHHOSP             * Holiday for all hospitals
              IF        !@EQUAL
                MATCH     OTHEHOSP,OPHHOSP       * Check if holiday is for
                GOTO      CPUB3000 IF NOT EQUAL  * the clinics hospital
              ENDIF
            ENDIF
.
            MOVE      ONE,PUBLICFL
            GOTO      CPUB9999
          ENDIF
.
CPUB9999  RETURN
.
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
RESLOT00  CALL      XMLHED00
          BRANCH    EXIT,RESLOT99
.
          MATCH     "1",UPDTTYPE
          GOTO      RESLOT10 IF EQUAL
.
          MATCH     "2",UPDTTYPE
          GOTO      RESLOT20 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      RESLOT90
.
RESLOT10  CALL      CHKSLT00                * Reserve a slot
          GOTO      RESLOT90
.
RESLOT20  CALL      RESERV00                * Reserve a slot
          GOTO      RESLOT90
.
RESLOT90  CALL      XMLEND00
.
RESLOT99  RETURN
.
.******************************************************************************
. REMOTE SCRIPTING ROUTINE - Slot Reservation
.******************************************************************************
RESERV00  MATCH     SP70,CASEKEYS
          GOTO      RESERV90 IF EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RLOTBOA1
          BRANCH    OVRCD,RESERV90,RESERV92
          COMPARE   ZERO,OBASTAT
          GOTO      RESERV10 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT
          GOTO      RESERV94 IF EQUAL
.
          COMPARE   NINE,OBASTAT
          GOTO      RESERV91 IF NOT EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDOTSRV1
          BRANCH    OVRCD,RESERV10
          MATCH     USERID,OTSRWEBU
          GOTO      RESERV93 IF NOT EQUAL
          GOTO      RESERV20
.
RESERV10  PACK      KEY16,RESERVE2,RESERVE3
          MATCH     SP70,KEY16            * Specified Reservation Date & Time
          CALL      CALRSV00 IF EQUAL     * Call to find expiry date & Time
.
          PACK      KEY28,CASEKEYS,SP70
          UNPACK    KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT
          CALL      RDOTSRV1
          COMPARE   ZERO,OVRCD
          GOTO      RESERV93 IF EQUAL   * Reservation Exists for Slot
.
          MOVE      RESERVE2,OTSREDAT
          MOVE      RESERVE3,OTSRETIM
          MOVE      USERID,OTSRWEBU
          PACK      OTSRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTSRRDAT
          CLOCK     TIME,OTSRRTIM
          MOVE      SP70,OTSRSPAR
          CALL      WROTSRV1
.
          MOVE      NINE,OBASTAT
          CALL      UPBOKA1
          CALL      UUOTBOA1
.
RESERV20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Appointment Slot Key":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
RESERV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Locked ":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
RESERV92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Slot Not Available ":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
RESERV93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Slot Reserved By Another User":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "This slot in Unavailable":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      RESERV99
.
RESERV99  RETURN
.
.******************************************************************************
. REMOTE SCRIPTING ROUTINE - Slot Reservation
.******************************************************************************
CHKSLT00  MATCH     SP70,CASEKEYS
          GOTO      CHKSLT90 IF EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKSLT90,CHKSLT92
.
          MOVE      OBATIME,SAVBTIME
.
          COMPARE   ZERO,OBASTAT
          GOTO      CHKSLT20 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT
          GOTO      CHKSLT94 IF EQUAL
.
          COMPARE   NINE,OBASTAT
          GOTO      CHKSLT91 IF NOT EQUAL
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDOTSRV1
          BRANCH    OVRCD,CHKSLT20
          MATCH     USERID,OTSRWEBU
          GOTO      CHKSLT93 IF NOT EQUAL
.
CHKSLT20  PACK      KEY38,USERID,WBSESIT,SP70
          CALL      RSOTSRV3
CHKSLT21  CALL      RKOTSRV3
          BRANCH    OVRCD,CHKSLT30
.
          MATCH     OTSRWEBU,USERID
          GOTO      CHKSLT30 IF NOT EQUAL
.
          MATCH     OTSRSITE,WBSESIT
          GOTO      CHKSLT30 IF NOT EQUAL
.
          PACK      KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT,SP70
.
          MATCH     KEY28,CASEKEYS          * Skip record if this is the one we
          GOTO      CHKSLT21 IF EQUAL       * just created by this reservation
.
          CALL      RDBOKA1
          BRANCH    OVRCD,CHKSLT21

          MATCH     OBATIME,SAVBTIME        * Possible start time conflict
          GOTO      CHKSLT25 IF EQUAL
.
          GOTO      CHKSLT21
.
CHKSLT25  MOVE      SP70,OCTDESC
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SMULTB90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                    "This appointment conflicts with appointment "
          WRITE     HTMLFILE;"Clinic Type : ",OCTDESC
          WRITE     HTMLFILE;"Clinic : ",OCADESC
          WRITE     HTMLFILE;"Time : ",OBATIME
          WRITE     HTMLFILE;"Continue with reservation ":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Appointment Slot Key":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Locked ":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Slot Not Available ":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Appointment Slot Reserved By Another User":
                    "</RETURN_VALUE>"
          GOTO      CHKSLT99
.
CHKSLT94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "This slot in Unavailable":
                    "</RETURN_VALUE>"
          CALL      UUOTBOA1
          GOTO      CHKSLT99
.
CHKSLT99  RETURN
.
.----------------------------------------------------
. Calculate Expiry Date & Time for Slot Reservation
.----------------------------------------------------
CALRSV00  SQUEEZE   RESERVE1
          MOVE      ZERO,RESVMINS
          MOVE      RESERVE1,RESVMINS
          IF        RESVMINS=0
            MOVE      "2",RESVMINS
          ENDIF
          CLOCK     TIME,CTIMEIS
          UNPACK    CTIMEIS,CHOUR,KEY1,CMIN,KEY1,CSEC
          MOVE      CHOUR,FORM2        * set up hours as a form
          MOVE      FORM2,FORM4D       * get in work variable
          MULT      "60",FORM4D        * get the minutes of full hours
          MOVE      CMIN,FORM2         * set up minutes as a form
          ADD       FORM2,FORM4D       * get the total min of end time
          ADD       RESVMINS,FORM4D    * add reservation mins
          MOVE      FORM4D,SFORM4D
.
          IF        FORM4D>1440
            SUB       "1440",FORM4D
            MOVE     CCC,CC
            MOVE     CYY,YY
            MOVE     CMM,MM
            MOVE     CDD,DD
            CALL     DMYCON
            ADD      ONE,JULDAY
            MOVE     JULDAY,JWKDAY
            MOVE     JULYR,JWKYER
            MOVE     JULCC,JWKCC
            CALL     JULCON
          ENDIF
.
          ASSIGN    FORM4D/SIXTY,FORM4D
          ASSIGN    FORM4D*SIXTY,FORM4D
          SUB       FORM4D,SFORM4D
          MOVE      SFORM4D,F2
          MOVE      F2,CMIN
          ASSIGN    FORM4D/SIXTY,FORM4D
          MOVE      FORM4D,F2
          MOVE      F2,CHOUR
          PACK      RESERVE2,CCC,CYY,CMM,CDD
          REP       " 0",RESERVE2
          PACK      RESERVE3,CHOUR,KEY1,CMIN,KEY1,CSEC
          REP       " 0",RESERVE3
          RETURN
.
.**********************************************************************
.*  CHKD0000  - Check if there are any deposits for this visit if so  *
.*              display an error                                      *
.**********************************************************************
CHKD0000  MOVE      ZERO,EXIT
          MOVE      "0",CMDESTAT
          PACK      KEY26,OBAOUTNO,CMDESTAT,SP70
          CALL      RSCMDEP2
          CALL      RKCMDEP2
          BRANCH    OVRCD,CHKD9999
.
          MATCH     DOBAOUTN,CMDEADMN            * Same outpatient booking
          GOTO      CHKD9999 IF NOT EQUAL
.
          MATCH     "0",CMDESTAT                 * Deposit held?
          GOTO      CHKD9999 IF NOT EQUAL        * so check for other deposits
.
CHKD9000  MOVE      ONE,EXIT
          GOTO      CHKD9999

CHKD9999  RETURN
.
.*******************************************************************************
.  CLET0000 - Clear the referral letter booked site and clinic if an appointment
.             is cancelled
.*******************************************************************************
CLET0000  READ      CONTROLF,THIRTY1;*174,OTCNULET
          COMPARE   ONE,OTCNULET
          GOTO      CLET9999 IF NOT EQUAL   * not using referral letters
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,CLET9999          * not a referral
.
          MOVE      SP70,OTRLBSIT
          MOVE      SP70,OTRLBCLI
          MOVE      SP70,OTRLBDTE
          MOVE      SP70,OTRLBSTR
          MOVE      SP70,OTRLBSLT
.
          PACK      OTRLUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLUDAT
          CLOCK     TIME,OTRLUTIM
          MOVE      WBSEUID,OTRLUUID
.
          CALL      UPOTRFL1
.
CLET9999  RETURN
.
.------------------------------------------------------------------------------
. Update waiting list review date
. OTCNAUPD - Update waiting list outpatient review date set to yes
. REVWFLAG - 0 = Update review date
.            1 = Delete review date
.------------------------------------------------------------------------------
REVD0000  COMPARE   ONE,HBWAIT                   * Using w/list
          GOTO      REVD9999 IF NOT EQUAL
.
          MATCH     "1",OTCNAUPD                 * Not using auto update review
          GOTO      REVD9999 IF NOT EQUAL        * date
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     CURRDATE,OBADATE             * Exit if booking date is
          GOTO      REVD9999 IF LESS             * less than today
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1                      * Exit if invalid clinic type
          BRANCH    OVRCD,REVD9999
.
          MATCH     SP70,OCTWUNIT                * Exit if no W/List unit
          GOTO      REVD9999 IF EQUAL
.
          PACK      KEY19,OBAURNO,SP70
          CALL      RDSTREA1
REVD1000  CALL      RDKTREA1
          BRANCH    OVRCD,REVD9999
.
          MATCH     WMURNO,OBAURNO               * Select records that are
          GOTO      REVD9999 IF NOT EQUAL        * Unscheduled, Scheduled or
.                                                * Pre-Admitted
          BRANCH    WMSTAT,REVD2000,REVD2000,REVD2000
.
          GOTO      REVD1000
.
REVD2000  BRANCH    REVWFLAG,REVD6000            * Cancel booking
.
          MATCH     SP70,WMDATE2                 * Update if no review date
          GOTO      REVD5000 IF EQUAL
.
          MATCH     WMDATE2,OBADATE              * Skip if booking date is
          GOTO      REVD1000 IF EQUAL            * equal to review date
.
          MATCH     WMDATE2,OBADATE              * Exit if booking date is
          GOTO      REVD1000 IF LESS             * less than review date
.
REVD5000  MOVE      OBADATE,WMDATE2              * Set review date to book date
          GOTO      REVD8000
.
REVD6000  MATCH     SP70,WMDATE2                 * Skip if no review date to
          GOTO      REVD1000 IF EQUAL            * clear on cancel
.
          MOVE      SP70,WMDATE2                 * Clear review date
.
REVD8000  CALL      UPTREA1                      * Update waiting list
.
          GOTO      REVD1000                     * Check next record
.
REVD9999  RETURN
.
.------------------------------------------------------------
. Check care team details against this clinic
.------------------------------------------------------------
CCAR0000  PACK      KEY26,URNUMBER,SP70
          CALL      RSALPCT1
CCAR1000  CALL      RKALPCT1
          BRANCH    OVRCD,CCAR9100
.
          MATCH     URNUMBER,ALPCURNO
          GOTO      CCAR9100 IF NOT EQUAL
.
          MOVE      ZERO,F2
          MOVE      ALPCTYPE,F2
          BRANCH    F2,CCAR2000,CCAR3000,CCAR4000,CCAR5000
.
          GOTO      CCAR1000
.
CCAR2000  MATCH     ALPCCODE,OCADOCT             * HCP
          GOTO      CCAR1000 IF NOT EQUAL
.
          GOTO      CCAR9000   
.
CCAR3000  MATCH     ALPCSITE,WBSESIT             * Clinic Type
          GOTO      CCAR1000 IF NOT EQUAL
.
          MATCH     ALPCCODE,OSESCTYP
          GOTO      CCAR1000 IF NOT EQUAL
.
          GOTO      CCAR9000   
.
CCAR4000  MATCH     ALPCSITE,WBSESIT             * Clinic Id
          GOTO      CCAR1000 IF NOT EQUAL
.
          MATCH     ALPCCODE,OSECLIN
          GOTO      CCAR1000 IF NOT EQUAL
.
          GOTO      CCAR9000   
.
CCAR5000  PACK      KEY10,ALPCCODE,SP70          * Case Team
          CALL      RDALCAS1
          BRANCH    OVRCD,CCAR1000
.
          MATCH     "1",ALCAACTV
          GOTO      CCAR1000 IF NOT EQUAL
.
          PACK      KEY20,ALCATEAM,SP70
          CALL      RSALCTM1
CCAR5100  CALL      RKALCTM1
          BRANCH    OVRCD,CCAR1000
.
          MATCH     ALCTTEAM,ALCATEAM
          GOTO      CCAR1000 IF NOT EQUAL
.
          MATCH     ALCTHCPC,OCADOCT
          GOTO      CCAR5100 IF NOT EQUAL
.
          MATCH     ALCTSDAT,OSEDATE
          GOTO      CCAR5100 IF LESS
.
          MATCH     SP70,ALCTEDAT
          IF        !@EQUAL
            MATCH     OSEDATE,ALCTEDAT
            GOTO      CCAR5100 IF LESS
          ENDIF
.
          GOTO      CCAR9000   
.
CCAR9000  MOVE      ZERO,EXIT                    * Accept this clinic
          GOTO      CCAR9999
.         
CCAR9100  MOVE      ONE,EXIT                     * Reject this clinic
          GOTO      CCAR9999
.
CCAR9999  RETURN
.
.------------------------------------------------------------
. Delete transport details when cancelling a booking
.------------------------------------------------------------
DTRN0000  PACK      KEY19,OBAURNO,OBAOUTNO,SP70
          CALL      RSPMTSP1
DTRN1000  CALL      RKPMTSP1
          BRANCH    OVRCD,DTRN9999
.
          MATCH     OBAURNO,PMTSURNO             * Correct U/R
          GOTO      DTRN9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,PMTSVISN            * Correct Visit
          GOTO      DTRN9999 IF NOT EQUAL
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      DEPMTSP1                     * Delete Transport Details
.
          GOTO      DTRN0000
.
DTRN9999  RETURN
.
.*******************************************************************************
. DLNK0000 - Delete allied health referral letter link
.*******************************************************************************
DLNK0000  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,DLNK9999          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      DLNK9999 IF NOT EQUAL
.
          MOVE      ONE,ALLNSTAT            * Set to cancelled
.
          PACK      KEY16,ALLNVISN,ALLNLNKV,SP70
          CALL      UPALLNK2
.
          MATCH     "1",ALLNMOHR
          IF        @EQUAL           
            MOVE      "2",ALLNMOHR          * set to 'Send Delete'
          ENDIF
          MOVE      FOUR,AUDTTYPE           * delete history record
          CALL      WAALLN00         
.
          CALL      URSR0000                * Update Referral Status
.
DLNK9999  RETURN
.
.------------------------------------------------------------
. Delete CMBS items for booking for HIC
.------------------------------------------------------------
DHIC0000  PACK      KEY10,OBAOUTNO,SP70
          CALL      RSOTBIT1
          CALL      RKOTBIT1
          BRANCH    OVRCD,DHIC2000          * no items on file
.
          MATCH     DOBAOUTN,OTBIVISN
          GOTO      DHIC2000 IF NOT EQUAL
.
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      DEOTBIT1
          GOTO      DHIC0000
.
.         Check if claim form had been printed
.
DHIC2000  MATCH     "1",IBCNUMCI            * Using medclaims
          GOTO      DHIC9999 IF NOT EQUAL
.
          OPEN      HICBCNA1,"hicbcnaf"
          OPEN      HICCITA1,"hiccitaf"
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSHCCLM2
          CALL      RKHCCLM2
          BRANCH    OVRCD,DHIC9999
          MATCH     DOBAOUTN,HCCLVISN       * Same visit
          GOTO      DHIC9999 IF NOT EQUAL
.
          MATCH     " 0",HCCLSTAT           * Status of Printed?
          GOTO      DHIC9999 IF NOT EQUAL   * No
.
.         Delete records from Item claims file
.
DHIC3000  PACK      KEY18,HCCLCLMN,HCCLVISN,SP70
          CALL      RSHCCIT1
          CALL      RKHCCIT1
          BRANCH    OVRCD,DHIC4000
          MATCH     HCCLCLMN,HCCICLMN       * same claim number?
          GOTO      DHIC4000 IF NOT EQUAL
          MATCH     HCCLVISN,HCCIVISN       * same visit number?
          GOTO      DHIC4000 IF NOT EQUAL
.
          PACK      KEY18,HCCICLMN,HCCIVISN,HCCITRAN
          CALL      DEHCCIT1
          GOTO      DHIC3000
.
DHIC4000  PACK      KEY16,HCCLVISN,HCCLCLMN
          CALL      DEHCCLM2
.
          PACK      KEY33,HCCLPMCI,HCCLPYEE,HCCLPSRV,HCCLBTCH
          CALL      RDHCBCN1
          BRANCH    OVRCD,DHIC9999
          SUB       ONE,HCBCBCNT            * subtract batch counter
          MOVE      "0",HCBCSTAT            * batch not completed
          CALL      UPHCBCN1
.
DHIC9999  RETURN
.
.------------------------------------------------------------
. Update referral status to waiting/active
.------------------------------------------------------------
URSR0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY8,ALLNVISN,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,URSR9999
.
          MATCH     "0",ALRESTAT           * Waiting
          GOTO      URSR1000 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      URSR1000 IF EQUAL
.
          GOTO      URSR9999                * Not waiting/Active so exit
.
URSR1000  CALL      ARMHI000                * Set MHINC indicator
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
URSR1050  CALL      RKALLNK1
          BRANCH    OVRCD,URSR2000
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          IF        @EQUAL
            MATCH     "1",ALLNSTAT          * Skip cancelled booking
            GOTO      URSR1050 IF EQUAL
.
            CALL      DATR0000              * Get first booking date
            GOTO      URSR9100
          ENDIF
.
URSR2000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
          CALL      RKALENC1
          BRANCH    OVRCD,URSR9000
.
          MATCH     ALREVISN,ALENVISN       * Encounters
          GOTO      URSR9200 IF EQUAL
.
URSR9000  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00

            MOVE      ZERO,ALRESTAT         * Update status to waiting
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      UPALREF1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FIVE,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
          ENDIF
          GOTO        URSR9999
.
URSR9100  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      ONE,ALRESTAT          * Update status to active
          CALL      CALX0000              * Calculate referral expiry date
          CALL      UPALREF1
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
          GOTO      URSR9999
.
URSR9200  MATCH     "1",ALRESTAT            * EOC only no linked referrals
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
            MOVE      ONE,ALRESTAT          * Update status to active
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      UPALREF1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SEVEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE          * after history record
            CALL      WAALRE00
          ENDIF
          GOTO        URSR9999
.
URSR9999  RETURN
.
.------------------------------------------------------------
. Calculate referral expiry date if required
.------------------------------------------------------------
CALX0000  MATCH     SP70,ALRERTYP           * No referral type
          GOTO      CALX9999 IF EQUAL
.
          MATCH     SP70,BOOKDATE           * No booking date
          GOTO      CALX9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CALX9999
.
          COMPARE   ZERO,TCFORM6            * No days for expiry warning
          GOTO      CALX9999 IF EQUAL
.
          MOVE      BOOKDATE,EXPRDATE
          ADD       TCFORM6,EXPRDATE
          MOVE      EXPRDATE,ALREREXP
.
CALX9999  RETURN
.
.------------------------------------------------------------
. Work out the first booking date for this referral
.------------------------------------------------------------
DATR0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
DATR1000  CALL      RKALLNK1
          BRANCH    OVRCD,DATR9999
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      DATR9999 IF NOT EQUAL
.
          MATCH     SP70,BOOKDATE
          IF        @EQUAL
            MOVE      ALLNDATE,BOOKDATE         * Calc ref expiry
          ENDIF
.
          MATCH     BOOKDATE,ALLNDATE
          IF        @LESS
            MOVE      ALLNDATE,BOOKDATE
          ENDIF
          GOTO      DATR1000
.
DATR9999  RETURN
.
.
.------------------------------------------------------------------------------
. Cancel/DNA - Cancel waiting list link record PAC
.------------------------------------------------------------------------------
CWAT0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      CWAT9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          BRANCH    OVRCD,CWAT9999
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CWAT9999
.
          MOVE      SP70,WTWMREAD      * Clear Pre Adm date
          CALL      UPTREA1
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,CWAT9999
.
          MOVE      WTOPOSTA,WTTXPAST  * Set back to original pre adm stat
          MOVE      SP70,WTTXPTIM      * Clear Pre Adm time
          CALL      UPWTTX11
.
          MOVE      ONE,WTOPSTAT       * Cancelled
          PACK      WTOPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOPUDAT
          CLOCK     TIME,WTOPUTIM
          MOVE      WBSEUID,WTOPUUID
          CALL      UPWTOPA2
.
CWAT9999  RETURN
.
.------------------------------------------------------------------------------
. Cancel/DNA - Cancel waiting list link record PAS
.------------------------------------------------------------------------------
CWAI0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      CWAI9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPS2
          BRANCH    OVRCD,CWAI9999
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CWAI9999
.
          MOVE      SP70,WTWMTRPA      * Clear Pre Anaesthetic date
          CALL      UPTREA1
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,CWAI9999
.
          MOVE      WTOSOSTA,WTTXPANS  * Set back to original pre adm stat
          MOVE      SP70,WTTXPANT      * Clear Pre Adm time
          CALL      UPWTTX11
.
          MOVE      ONE,WTOSSTAT       * Cancelled
          PACK      WTOSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOSUDAT
          CLOCK     TIME,WTOSUTIM
          MOVE      WBSEUID,WTOSUUID
          CALL      UPWTOPS2
.
CWAI9999  RETURN
.
.******************************************************************************
.      write a record to the Referral Status History Table
.******************************************************************************
WRTRSH00  MOVE      ALREVISN,ALSTVISN       * Populate all the fields and write
          MOVE      ALRESTAT,ALSTSTAT
          PACK      ALSTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      WBSEUID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RAALSTS1
          IF        OVRCD=0
            CALL      UPALSTS1                * update to the file
          ELSE
            CALL      WRALSTS1                * write to the file
          ENDIF
.
WRTRSH99  RETURN
.
.******************************************************************************
.         MHINC - MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.
.*******************************************************************************
. OP Appointment Action List           
.*******************************************************************************
ACTN0000  MATCH     SP70,UPDTTYPE
          GOTO      ACTN5000 IF EQUAL
.
          MATCH     ANSA,UPDTTYPE         * Add
          GOTO      ACTN1000 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE         * Update
          GOTO      ACTN2000 IF EQUAL
.
          GOTO      ACTN9000
.
.         ************ ADD FORMACTION ***********
.
ACTN1000  PACK      KEY32,OTART001,OTART002,OTART003,OTART004,SP70
          CALL      RDOTART1
          COMPARE   ZERO,OVRCD
          GOTO      ACTN9300 IF EQUAL
.
          CALL      CLOUTART                     * Clear file vars	
          CALL      MVOTAR00                     * Move cgi to file variables
.
        
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OTARCDAT                * System date
          CLOCK     TIME,OTARCTIM                * System time (Var chgd HPS)
          MOVE      USERID,OTARCUID              * web user id
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      WROTART1                     * Writes the data
.
          CALL      REQCOM00                   * Appointment request comments
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      RDOTART1                     * Writes the data
          BRANCH    OVRCD,ACTN9400
.
          CALL      RCMCOM00                   * Appt Request Comments OUTRCMFD
.
          MOVE      ZERO,EXIT
          GOTO      ACTN9999
.
.         ************ UPDATE FORMACTION ***********
.
ACTN2000  PACK      KEY32,OTART001,OTART002,OTART003,OTART004,SP70
          CALL      RDOTART1
          BRANCH    OVRCD,ACTN9400
.
          CALL      MVOTAR00                     * Move cgi to file variables
.
          MATCH     "1",CANCELRQ                 * Cancel Appointment Request
          IF        @EQUAL
            MATCH     "3",OTARSTAT
            IF        !@EQUAL
              PACK      KEY8,CCC,CYY,CMM,CDD       
              REP       " 0",KEY8
              MOVE      KEY8,OTARCADT     
              CLOCK     TIME,OTARCATM    
              MOVE      USERID,OTARCAUS 
              MOVE      THREE,OTARSTAT           * Cancelled
            ENDIF
          ENDIF
.
          MATCH     "1",OTARSTAT                 * Do not change pending
          GOTO      ACTN2500 IF EQUAL            * reschedule status back to 
.                                                * requested
          MATCH     "0",CANCELRQ
          IF        @EQUAL
            MATCH     "0",OTARSTAT
            IF        !@EQUAL
              MOVE      SP70,OTARCADT
              MOVE      SP70,OTARCATM
              MOVE      SP70,OTARCAUS
              MOVE      SP70,OTARRCAN
              MOVE      ZERO,OTARSTAT            * Requested
            ENDIF
          ENDIF
.
ACTN2500  CALL      UPOTART1                     * update the data
.
          CALL      REQCOM00                   * Appointment request comments
          CALL      RCMCOM00                   * Appt Request Comments OUTRCMFD
.
          MOVE      ZERO,EXIT
          GOTO      ACTN9999

ACTN5000  CALL      CURPER00              * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates.
          MATCH     SP70,URNUMBER         * Hospital Level Appt Action List
          IF        @EQUAL
            CALL      CLPATMAS
            CALL      CLPMSPX2
            CALL      CLALLREF
            CALL      CLOUTART
            CALL      CLPATVIS
            CALL      CLPMSVX1
            GOTO      ACTN7000
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ACTN9100
.
          CALL      RDPMPX21
          BRANCH    OVRCD,ACTN9100
.
          MATCH     "5",TEMPLATE            * Patient Level Action List
          GOTO      ACTN7000 IF EQUAL
.
          MATCH     "005",TEMPLATE          * Patient Level Action List
          GOTO      ACTN7000 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ACTN9200
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,ACTN9200
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ACTN9200
.
          PACK      KEY32,OTART001,OTART002,OTART003,OTART004,SP70
          CALL      RDOTART1
          IF        OVRCD=1
            CALL      CLOUTART                   * Clear file vars	
            MOVE      URNUMBER,OTARURNO
            MOVE      ADMISSNO,OTARREFN
          ENDIF
.
          MATCH     SP70,POPUPREQ  
          IF        !@EQUAL
            PACK      KEY32,POPUPREQ,SP70        * Read request for redirect
            CALL      RDOTART1                   * popup
          ENDIF
.
          CALL      DEFA0000                     * Default appointment fields
.
ACTN7000  IF        SHOWFLAG=0
            MATCH     SP70,FILTSTAT
            IF        @EQUAL
              MOVE      ZERO,FILTSTAT            * Default status filter
            ENDIF                                * to requested
.
            IF        IBCNMHOS=1
              MATCH     SP70,FILTHOSP
              IF        @EQUAL
                MOVE      WBSEHOSP,FILTHOSP        * Default to users hospital
              ENDIF
            ELSE
              MATCH     SP70,FILTHOSP
              IF        @EQUAL
                PACK      KEY3,SP70
                CALL      RSPTHSP1
                CALL      RKPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSHOSP,FILTHOSP
                ELSE
                  MOVE      SP70,FILTHOSP
                ENDIF
              ENDIF
            ENDIF
.
            MATCH     SP70,FILTDEPT
            IF        @EQUAL
              MOVE      WBSEDALL,FILTDEPT        * Default AH department
            ENDIF
          ENDIF
.
          MOVE      "Appointment Action List",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,ACTN9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ACTN9999
.
ACTN9000  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTN9999
.
ACTN9100  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTN9999
.
ACTN9200  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTN9999
.
ACTN9300  MOVE      "Request already exists for this date/time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
ACTN9400  MOVE      "Invalid Appointment Request.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTN9999
.
ACTN9999  CLOSE     COMFILBF,DELETE
          CLOSE     COMFILRF,DELETE
          RETURN
.
.*******************************************************************************
. Appointment Action List General Tags
.*******************************************************************************
ATAG0000  BRANCH    FLDITMNO,ATAG0100,ATAG0200,ATAG0300,ATAG0400,ATAG0500:
                             ATAG0600,ATAG0700,ATAG0800,ATAG0900,ATAG1000:
                             ATAG1100,ATAG1200,ATAG1300,ATAG1400,ATAG1500:
                             ATAG1600,ATAG1700,ATAG1800,ATAG1900,ATAG2000:
                             ATAG2100,ATAG2200,ATAG2300,ATAG2400,ATAG2500:
                             ATAG2600,ATAG2700,ATAG2800,ATAG2900,ATAG3000:
                             ATAG3100,ATAG3200,ATAG3300,ATAG3400
.
          WRITE     HTMLFILE;"Invalid IBA TAG";
          GOTO      ATAG9999
.
ATAG0100  CALL      RTAB0000                * Requested appointments table
          GOTO      ATAG9999
.
ATAG0200  WRITE     HTMLFILE;FILTSTAT;      * Status filter
          GOTO      ATAG9999
.
ATAG0300  CALL      STAB0000                * Suspended appointments table
          GOTO      ATAG9999
.
ATAG0400  WRITE     HTMLFILE;INCLSUSP;      * Include suspended patients
          GOTO      ATAG9999
.
ATAG0500  CALL      FLHOSP00;               * Hospital filter
          GOTO      ATAG9999
.
ATAG0600  PACK      KEY36,SP70              * OP site filter
          CALL      RDSSITA2               
ATAG0610  CALL      RDKSITA2
          BRANCH    OVRCD,ATAG9999
.
          MATCH     FILTSITE,OSTSITE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OSTSITE,"#" selected>":
                               OSTDESC,"</option>"
          ELSE
            MATCH     OSTSITE,WBSESIT
            GOTO      ATAG0610 IF NOT EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",OSTSITE,"#">":
                               OSTDESC,"</option>"
          ENDIF
          GOTO      ATAG0610
.
ATAG0700  CALL      DEPF0000                * AH department filter
          GOTO      ATAG9999
.
ATAG0800  WRITE     HTMLFILE;FILTCTYP;      * Clinic type filter
          GOTO      ATAG9999
.
ATAG0900  MOVE      "PR",CATEGORY           * Priority Filter
          MOVE      FILTPRTY,CODE
          CALL      CODITM00
          GOTO      ATAG9999
.
ATAG1000  WRITE     HTMLFILE;FILTCLID;      * Clinic Id filter
          GOTO      ATAG9999
.
ATAG1100  WRITE     HTMLFILE;INCLWAIT;      * Include waiting referrals
          GOTO      ATAG9999
.
ATAG1200  WRITE     HTMLFILE;DATEPREF;      * Preferred date
          GOTO      ATAG9999
.
ATAG1300  CALL      SELV0000
          GOTO      ATAG9999
.
ATAG1400  CALL      NEXT0000
          GOTO      ATAG9999
.
ATAG1500  CALL      PREV0000
          GOTO      ATAG9999
.
ATAG1600  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ATAG9999
.
ATAG1700  CALL      RHTB0000      * Hospital level Requested Appointments table
.
.         If not multi hospital and the hospital filter is populated. Also 
.         get appointment request records with a blank preferred hospital
.
          BRANCH    IBCNMHOS,ATAG9999
.
          MATCH     SP70,FILTHOSP      * Exit if hospital filter is blank
          GOTO      ATAG9999 IF EQUAL
          GOTO      ATAG9999 IF EOS
.         
          MOVE      FILTHOSP,SAVFHOSP  * Save original hospital filter
          MOVE      SP70,FILTHOSP      * Set hospital filter to all
          CALL      RHTB0000           * Hospital level Requested Appointments
          MOVE      SAVFHOSP,FILTHOSP  * Restore original hospital filter
          GOTO      ATAG9999
.
ATAG1800  CALL      AHTB0000      * Hospital level Waiting AH referral table
          GOTO      ATAG9999
.
ATAG1900  CALL      SHTB0000      * Hospital level Suspended OP Appointments tbl
          GOTO      ATAG9999
.
ATAG2000  WRITE     HTMLFILE;POPUPAPP;
          GOTO      ATAG9999
.
ATAG2100  WRITE     HTMLFILE;POPUPREQ;
          GOTO      ATAG9999
.
ATAG2200  MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      ATAG9999 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ATAG9999
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      ATAG9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;TDESC;
          GOTO      ATAG9999
.
ATAG2300  CALL      PRHT0000           * Patient level Requested Appointments
          GOTO      ATAG9999                
.
ATAG2400  CALL      PAHT0000           * Patient level Waiting AH Referrals
          GOTO      ATAG9999
.
ATAG2500  CALL      PSHT0000           * Patient level Suspended OP Appts
          GOTO      ATAG9999 
.
ATAG2600  WRITE     HTMLFILE;DEPTINDC;
          GOTO      ATAG9999
.
ATAG2700  WRITE     HTMLFILE;PTCOLUMN;
          GOTO      ATAG9999
.
ATAG2800  PACK      FILTDEPT,ALREDEPT,SP70
          CALL      DEPA0000
          GOTO      ATAG9999
.
ATAG2900  PACK      FILTDEPT,OTARADEP,SP70
          CALL      DEPA0000
          GOTO      ATAG9999
.
ATAG3000  WRITE     HTMLFILE;REQAPTDP;
          GOTO      ATAG9999
.
ATAG3100  MOVE      ONE,RELINK              * Appt Request Supervisor
          CALL      EVTH0000                * Event Table Output with relink
          CALL      APRQSP00
          GOTO      ATAG9999
.
ATAG3200  CALL      NXTARQ00
          GOTO      ATAG9999
.
ATAG3300  CALL      PRVARQ00
          GOTO      ATAG9999
.
ATAG3400  MATCH     "1",OTCNAPRC          * using request comments security
          GOTO      ATAG9999 IF NOT EQUAL 
.
          PACK      KEY18,USERID,PRGID,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,ATAG3450        * user security for OUTWEB08
.
          MOVE      ZERO,F2
          MOVE      OTCNSCLV,F2
.         
          IF        WBSTLEV>=F2
            GOTO      ATAG9999           * update for comment section allowed
          ENDIF
.
ATAG3450  WRITE     HTMLFILE;ONE;        * cannot update the comment section 
          GOTO      ATAG9999
.
ATAG9999  RETURN
.
.-----------------------------------------------------------
. Next action for appointment request supervisor list
.-----------------------------------------------------------
NXTARQ00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          MOVE      NORECORD,DIM2
          REP       " +",DIM2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,DIM3
          REP       " +",DIM3
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"outweb08.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&startnum=",DIM3:
                             "&norecord=",DIM2;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NXTARQ99  RETURN
.
.-----------------------------------------------------------
. Previous action for appointment request supervisor list
.-----------------------------------------------------------
PRVARQ00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          MOVE      NORECORD,DIM2
          REP       " +",DIM2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,DIM3
          REP       " +",DIM3
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"outweb08.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&startnum=",DIM3:
                             "&norecord=",DIM2;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PRVARQ99  RETURN
.
.--------------------------------------------------------------------------
. Display Of Header (Appointment Request Supervisor)
.--------------------------------------------------------------------------
EVTH0000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=16%>":
                             "<b>Date & Time</b></td>":
                             "<td class=HeadingCell width=19%>":
                             "<b>Requesting Department</b></td>":
                             "<td class=HeadingCell width=19%>":
                             "<b>Department Required</b></td>":
                             "<td class=HeadingCell width=19%>":
                             "<b>Request Reason</b></td>":
                             "<td class=HeadingCell width=19%>":
                             "<b>Clinic Type</b></td>":
                             "<td class=HeadingCell width=8%>":
                             "<b>Re-Link</b></td></tr>"
.
EVTH9999  RETURN
.
.--------------------------------------------------------------------------
. List Of Appointment Request Supervisor
.--------------------------------------------------------------------------
APRQSP00  MOVE      ONE,SHOWFLAG                   
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MOVE      ZERO,COUNTER
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web Security Id
          IF        OVRCD=1
            GOTO      APRQSP96 
          ENDIF
.
          PACK      KEY32,URNUMBER,ADMISSNO,Z70
          CALL      RSOTART1                * positional read
APRQSP10  CALL      RPOTART1                * read a record
          BRANCH    OVRCD,APRQSP95   
.
          MATCH     URNUMBER,OTARURNO       * same ur number
          GOTO      APRQSP95 IF NOT EQUAL          
.
          MATCH     ADMISSNO,OTARREFN       * if the referral/visit matches
          GOTO      APRQSP95 IF NOT EQUAL 
.
          MATCH     "0",OTARSTAT
          GOTO      APRQSP10 IF NOT EQUAL  
.
          PACK      KEY3,OTARADEP,SP70
          CALL      RDALDEP1                * Reading For Department Security
          BRANCH    OVRCD,APRQSP10
.
          MATCH     "0",ALDESECU
          GOTO      APRQSP15 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,OTARADEP
            GOTO      APRQSP15 IF EQUAL
            GOTO      APRQSP10 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,OTARADEP
            GOTO      APRQSP10 IF NOT EQUAL
          ENDIF
.
APRQSP15  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      APRQSP10                        
          ENDIF
.
          UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,REQBDEPT                     * Requested By Department
          MATCH     SP70,OTARRDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARRDEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRDEP,TDESC
            ENDIF
            MOVE      TDESC,REQBDEPT
          ENDIF
.
          MOVE      SP70,ADEPDESC                     * Appointment Dept
          MATCH     SP70,OTARADEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARADEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARADEP,TDESC
            ENDIF
            MOVE      TDESC,ADEPDESC
          ENDIF
.
          MOVE      SP70,REASNREQ                      * Requested By Department
          MATCH     SP70,OTARRREQ
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSU,OTARRREQ,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRREQ,TDESC
            ENDIF
            MOVE      TDESC,REASNREQ
          ENDIF
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          PACK      KEY32,URNUMBER,ADMISSNO,OTARRQDT,OTARRQTM,SP70
.
          WRITE     HTMLFILE;"<tr>":
                    "<td nowrap>":
                    "<a HREF ='javascript:UpdateApptRequest":
                    "(#"",LINKPRG:
                    ".pbl?reportno=",LINKREP:
                    "&template=",LINKTEM:
                    "&urnumber=",URNUMBER:
                    "&admissno=",ADMISSNO:
                    "&otart001=",URNUMBER:
                    "&otart002=",ADMISSNO:
                    "&otart003=",DISPDAT1:
                    "&otart004=",OTARRQTM,"#");'>";
.
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif></a>"
.
          WRITE     HTMLFILE;DISPDAT1,SP1,OTARRQTM,"</td>":
                             "<td>",REQBDEPT,"</td>":
                             "<td>",ADEPDESC,"</td>":
                             "<td>",REASNREQ,"</td>":
                             "<td>",CTYPDESC,"</td>"
.
          WRITE     HTMLFILE;"<td><img src=../images/ViewIcon.gif ":
                             "alt='Quick re-link' ":
                             "onclick='Relink(#"":
                             URNUMBER,"#",#"":
                             ADMISSNO,"#",#"":
                             KEY32,"#");'></td></tr>";
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      APRQSP10 IF NOT EQUAL
.
APRQSP95  WRITE     HTMLFILE;"<tr bgcolor=#FF0000>":
                             "<td colspan=10 align=center>":
                             "No more Requests</td></tr>"
          GOTO      APRQSP99
.
APRQSP96  MOVE      "User ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      APRQSP99
.
APRQSP99  RETURN
+
DEPA0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPA0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPA9999
.
          MATCH     "CG",TCODE
          GOTO      DEPA9999 IF NOT EQUAL
.
          MATCH     FILTDEPT,ACODE
          IF        !@EQUAL
            MATCH     ANSA,TCINDC3            * Skip non-referral Departments
            GOTO      DEPA0100 IF NOT EQUAL
          ENDIF
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPA0100
.
          MATCH     FILTDEPT,ALDEDEPT
          IF        !@EQUAL
            MATCH     "1",ALDEACTV
            GOTO      DEPA0100 IF EQUAL       * Skip Inactive
          ENDIF
.
          MATCH     FILTDEPT,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      DEPA0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ENDIF
.
          GOTO      DEPA0100
.
DEPA9999  RETURN
.
.*******************************************************************************
.                          Next Day, Week, Month
.*******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",FILTHOSP
          REP       " +",FILTDEPT
          REP       " +",FILTPRTY
          REP       " +",FILTSITE
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",FILTSTAT
          REP       " +",DEPTINDC
          REP       " +",REQAPTDP
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"outweb08.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filthosp=",FILTHOSP:
                             "&filtdept=",FILTDEPT:
                             "&filtprty=",FILTPRTY:
                             "&filtsite=",FILTSITE:
                             "&filtctyp=",FILTCTYP:
                             "&filtclid=",FILTCLID:
                             "&filtstat=",FILTSTAT:
                             "&datepref=",DATEPREF:
                             "&inclwait=",INCLWAIT:
                             "&inclsusp=",INCLSUSP:
                             "&deptindc=",DEPTINDC:
                             "&reqaptdp=",REQAPTDP;
.
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTDEPT
          REP       "+ ",FILTPRTY
          REP       "+ ",FILTSITE
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",FILTSTAT
          REP       "+ ",DEPTINDC
          REP       "+ ",REQAPTDP
.
NEXT9999  RETURN
.*******************************************************************************
.                          Previous Day, Week, Month
.*******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",FILTHOSP
          REP       " +",FILTDEPT
          REP       " +",FILTPRTY
          REP       " +",FILTSITE
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",FILTSTAT
          REP       " +",DEPTINDC
          REP       " +",REQAPTDP
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"outweb08.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filthosp=",FILTHOSP:
                             "&filtdept=",FILTDEPT:
                             "&filtprty=",FILTPRTY:
                             "&filtsite=",FILTSITE:
                             "&filtctyp=",FILTCTYP:
                             "&filtclid=",FILTCLID:
                             "&filtstat=",FILTSTAT:
                             "&datepref=",DATEPREF:
                             "&inclwait=",INCLWAIT:
                             "&inclsusp=",INCLSUSP:
                             "&deptindc=",DEPTINDC:
                             "&reqaptdp=",REQAPTDP;
.
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTDEPT
          REP       "+ ",FILTPRTY
          REP       "+ ",FILTSITE
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",FILTSTAT
          REP       "+ ",DEPTINDC
          REP       "+ ",REQAPTDP
.
PREV9999  RETURN
.
.------------------------------------------------------------
. Preferred Hospital filter
.------------------------------------------------------------
FLHOSP00  PACK      KEY3,SP70
          CALL      RSPTHSP1
FLHOSP10  CALL      RKPTHSP1
          BRANCH    OVRCD,FLHOSP99
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY13,USERID,SP70                * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,FLHOSP10
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      FLHOSP10
.
FLHOSP99  RETURN
.
.-------------------------------------------------------------------
.  Allied health department drop down filter
.-------------------------------------------------------------------
DEPF0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPF0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPF9999
.
          MATCH     "CG",TCODE
          GOTO      DEPF9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPF0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPF0100
.
          MATCH     "1",ALDEACTV
          GOTO      DEPF0100 IF EQUAL       * Skip Inactive
.
          MATCH     FILTDEPT,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      DEPF0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ENDIF
.
          GOTO      DEPF0100
.
DEPF9999  RETURN
.
.******************************************************************************
. Requested Appointments Table                          
.******************************************************************************
RTAB0000  PACK      KEY32,URNUMBER,ADMISSNO,SP70
          CALL      RSOTART1
RTAB1000  CALL      RKOTART1
          BRANCH    OVRCD,RTAB9999
.
          MATCH     URNUMBER,OTARURNO
          GOTO      RTAB9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTARREFN
          GOTO      RTAB9999 IF NOT EQUAL
.
          MATCH     SP70,FILTSTAT                     * Status filter
          IF        !@EQUAL
            MATCH     "0",FILTSTAT
            IF        @EQUAL
              MATCH     "0",OTARSTAT
              IF        !@EQUAL
                MATCH     "1",OTARSTAT                * Include pending resch.
                GOTO      RTAB1000 IF NOT EQUAL       * with requested
              ENDIF
            ELSE
              MATCH     FILTSTAT,OTARSTAT
              GOTO      RTAB1000 IF NOT EQUAL
            ENDIF
          ENDIF     
.
          MOVE      SP70,REQBDEPT                     * Requested By Department
          MATCH     SP70,OTARRDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARRDEP,SP70 
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRDEP,TDESC
            ENDIF
            MOVE      TDESC,REQBDEPT
          ENDIF
.
          MOVE      SP70,REASNREQ                      * Requested By Department
          MATCH     SP70,OTARRREQ
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSU,OTARRREQ,SP70 
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRREQ,TDESC
            ENDIF
            MOVE      TDESC,REASNREQ
          ENDIF
.
          MOVE      SP70,REQUESTB                     * Requested By
          MATCH     SP70,OTARCUID
          IF        !@EQUAL
            PACK      KEY10,OTARCUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      OTARCUID,WBSENAM
            ENDIF
            MOVE      WBSENAM,REQUESTB
          ENDIF
.
          MOVE      SP70,PREFHOSP                     * Preferred Hospital
          MATCH     SP70,OTARPRHS
          IF        !@EQUAL
            PACK      KEY3,OTARPRHS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      OTARPRHS,PTHSNAME
            ENDIF
            MOVE      PTHSNAME,PREFHOSP
          ENDIF
.
          MOVE      OTARPRSI,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OTARCLID
          IF        !@EQUAL
            PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,RTAB1100
.
              MATCH     OTARPRSI,OCASITE
              GOTO      RTAB1100 IF NOT EQUAL
.
              MATCH     OTARCLID,OCACLIN
              GOTO      RTAB1100 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
RTAB1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,OTARVIST
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OTARVIST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARVIST,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,STATDESC
          MATCH     "0",OTARSTAT
          IF        @EQUAL
            MOVE      "Requested",STATDESC
          ENDIF
. 
          MATCH     "1",OTARSTAT
          IF        @EQUAL
            MOVE      "Pending Reschedule",STATDESC
          ENDIF
. 
          MATCH     "2",OTARSTAT
          IF        @EQUAL
            MOVE      SP70,DISPDAT1
            UNPACK    OTARBKDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CLEAR     STATDESC
            APPEND    "Booked ",STATDESC
            APPEND    DISPDAT1,STATDESC
            APPEND    " at ",STATDESC
            APPEND    OTARCLTM,STATDESC
            RESET     STATDESC
          ENDIF
. 
          MATCH     "3",OTARSTAT
          IF        @EQUAL
            MOVE      "Cancelled",STATDESC
          ENDIF
. 
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OTARRQDT
          IF        !@EQUAL
            UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateRequest('",HTMLLINK
          APPEND    OTARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARREFN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARRQTM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0 
                             "#"",OTARRQDT,OTARRQTM,"#",":      * 1
                             "#"",REQBDEPT,"#",":               * 2
                             "#"",REASNREQ,"#",":               * 3
                             "#"",REQUESTB,"#",":               * 4
                             "#"",PREFHOSP,"#",":               * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",VISTDESC,"#",":               * 8
                             "#"",ALREMDAT,"#",":               * 9
                             "#"",STATDESC,"#",":               * 10
                             "#"",NINE,OTARRQDT,OTARRQTM,"#");" * 11  
.
          GOTO      RTAB1000
.
RTAB9999  RETURN
.
.******************************************************************************
. Suspended Appointments Table                          
.******************************************************************************
STAB0000  COMPARE   "1",INCLSUSP                 * Include suspended patients
          GOTO      STAB9999 IF NOT EQUAL
.
          PACK      KEY36,URNUMBER,SP70   
          CALL      RDSBOKA3
STAB1000  CALL      RDKBOKA3
          BRANCH    OVRCD,STAB9999
.
          MATCH     OBAURNO,URNUMBER
          GOTO      STAB9999 IF NOT EQUAL
.
          COMPARE   SIX,OBASTAT                  * Suspended 
          GOTO      STAB1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1      
          BRANCH    OVRCD,STAB1000
.
          MOVE      SP70,REQBDEPT
          MOVE      SP70,REASNREQ
          MOVE      SP70,REQUESTB
          MOVE      SP70,PREFHOSP
.
          MOVE      SP70,CTYPDESC
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD=1
            MOVE      OBACTYP,OCTDESC
          ENDIF
          MOVE      OCTDESC,CTYPDESC
.
          MOVE      SP70,CLIDDESC
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,STAB1100
.
            MATCH     OBASITE,OCASITE
            GOTO      STAB1100 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      STAB1100 IF NOT EQUAL
          ENDIF
          MOVE      OCADESC,CLIDDESC
.
STAB1100  PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,STAB1000
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,STAB1000
.
          MOVE      SP70,VISTDESC                      * Requested Visit Type
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      OBAVISIT,TDESC
          ENDIF
          MOVE      TDESC,VISTDESC
.
          MOVE      SP70,PREFHOSP                     * Preferred Hospital
          MATCH     SP70,OTMAHOSP
          IF        !@EQUAL
            PACK      KEY3,OTMAHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      OTMAHOSP,PTHSNAME
            ENDIF
            MOVE      PTHSNAME,PREFHOSP
          ENDIF
.
          MOVE      "Suspended",STATDESC
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CLEAR     HTMLLINK
          APPEND    "javascript:AppointLink('",HTMLLINK
          APPEND    KEY28,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",OBADATE,OBATIME,"#",":        * 1
                             "#"",REQBDEPT,"#",":               * 2
                             "#"",REASNREQ,"#",":               * 3
                             "#"",REQUESTB,"#",":               * 4
                             "#"",PREFHOSP,"#",":               * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",VISTDESC,"#",":               * 8
                             "#"",SP1,"#",":                    * 9
                             "#"",STATDESC,"#",":               * 10
                             "#"",ONE,OBADATE,OBATIME,"#");"   * 11
.
          GOTO      STAB1000
.
STAB9999  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the preferred site of the appointment request
.*******************************************************************************
COTFIL00  MATCH     SP70,CHECKSIT            * Does the app request have a site
          GOTO      COTFIL99 IF EQUAL
.
COTFIL50  MOVE      CHECKSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL99           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
COTFIL99  RETURN
.
.******************************************************************************
. Hospital Level Requested Appointments Table
.******************************************************************************
RHTB0000  MOVE      ZERO,LOOPCNTR
.
          COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      RHTB9999 IF NOT EQUAL
.
          BRANCH    DATEPREF,RHTB2000            * Read by Preferred Date Index
.
......... Read by mandatory input fields: Hospital,Site,Dept ..................
.
RHTB1000  PACK      KEY42,FILTHOSP,FILTSITE,FILTSTAT,SP70
          CALL      RSOTART4
RHTB1010  CALL      RKOTART4
          BRANCH    OVRCD,RHTB9999
.
          MATCH     FILTHOSP,OTARPRHS            * Must Match, mandatory field
          GOTO      RHTB9999 IF NOT EQUAL
.
          MATCH     FILTSITE,OTARPRSI            * Must Match, mandatory field
          GOTO      RHTB9999 IF NOT EQUAL
.
          MATCH     "0",FILTSTAT
          IF        @EQUAL
            MATCH     "0",OTARSTAT
            IF        !@EQUAL
              MATCH     "1",OTARSTAT             * Include pending resch.
              GOTO      RHTB9999 IF NOT EQUAL    * with requested
            ENDIF
          ELSE
            MATCH     FILTSTAT,OTARSTAT          * Must Match, mandatory field
            GOTO      RHTB9999 IF NOT EQUAL
          ENDIF
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
RHTB1020  MATCH     "1",DEPTINDC
          IF        @EQUAL
            MATCH     FILTDEPT,SP70
            GOTO      RHTB1030 IF EQUAL
          ENDIF
.
          MATCH     "1",REQAPTDP
          IF        @EQUAL
            MATCH     FILTDEPT,OTARADEP            * match with appoint dept
            GOTO      RHTB1010 IF NOT EQUAL
          ELSE
            MATCH     FILTDEPT,OTARRDEP            * match with request dept
            GOTO      RHTB1010 IF NOT EQUAL
          ENDIF
.
RHTB1030  MATCH     FILTCLID,SP70
          GOTO      RHTB1040 IF EQUAL
.
          MATCH     FILTCLID,OTARCLID
          GOTO      RHTB1010 IF NOT EQUAL
.
RHTB1040  MATCH     FILTCTYP,SP70
          GOTO      RHTB1050 IF EQUAL
.
          MATCH     FILTCTYP,OTARCLTY
          GOTO      RHTB1010 IF NOT EQUAL
.
RHTB1050  MATCH     FILTPRTY,SP70                 * Priority Filter
          GOTO      RHTB3000 IF EQUAL
.
          MATCH     FILTPRTY,OTARPRIO
          GOTO      RHTB1010 IF NOT EQUAL
.
          GOTO      RHTB3000
.
RHTB2000  PACK      KEY41,FRSTDATE,FILTSTAT,SP70
          CALL      RSOTART3
RHTB2010  CALL      RKOTART3
          BRANCH    OVRCD,RHTB9999
.
          MATCH     OTARPRDT,LASTDATE
          GOTO      RHTB9999 IF LESS
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
RHTB2020  MATCH     FILTSTAT,SP70
          GOTO      RHTB2030 IF EQUAL
.
         MATCH     "0",FILTSTAT                    * with requested
          IF        @EQUAL
            MATCH     "0",OTARSTAT
            IF        !@EQUAL
              MATCH     "1",OTARSTAT
              IF        !@EQUAL
                MOVE      OTARPRDT,WORKDATE            * Re pack key and skip
                ADD       ONE,WORKDATE                 * foreward to the next
                PACK      KEY41,WORKDATE,FILTSTAT,SP70 * day
                CALL      RSOTART3
                GOTO      RHTB2010
              ENDIF
            ENDIF
          ELSE
            MATCH     FILTSTAT,OTARSTAT
            IF        !@EQUAL
              MOVE      OTARPRDT,WORKDATE              * Re pack key and skip
              ADD       ONE,WORKDATE                   * foreward to the next
              PACK      KEY41,WORKDATE,FILTSTAT,SP70   * day
              CALL      RSOTART3
              GOTO      RHTB2010
            ENDIF
          ENDIF
.
RHTB2030  MATCH     FILTHOSP,SP70
          GOTO      RHTB2040 IF EQUAL
.
          MATCH     FILTHOSP,OTARPRHS
          GOTO      RHTB2010 IF NOT EQUAL
.
RHTB2040  MATCH     FILTSITE,SP70
          GOTO      RHTB2050 IF EQUAL
.
          MATCH     FILTSITE,OTARPRSI
          GOTO      RHTB2010 IF NOT EQUAL
.
RHTB2050  MATCH     FILTDEPT,SP70
          GOTO      RHTB2060 IF EQUAL
.
          MATCH     "1",REQAPTDP
          IF        @EQUAL
            MATCH     FILTDEPT,OTARADEP            * match with appoint dept
            GOTO      RHTB2010 IF NOT EQUAL
          ELSE
            MATCH     FILTDEPT,OTARRDEP            * match with request dept
            GOTO      RHTB2010 IF NOT EQUAL
          ENDIF
.
RHTB2060  MATCH     FILTCLID,SP70
          GOTO      RHTB2070 IF EQUAL
.
          MATCH     FILTCLID,OTARCLID
          GOTO      RHTB2010 IF NOT EQUAL
.
RHTB2070  MATCH     FILTCTYP,SP70
          GOTO      RHTB2080 IF EQUAL
.
          MATCH     FILTCTYP,OTARCLTY
          GOTO      RHTB2010 IF NOT EQUAL
.
RHTB2080  MATCH     FILTPRTY,SP70                 * Priority Filter
          GOTO      RHTB3000 IF EQUAL
.
          MATCH     FILTPRTY,OTARPRIO
          GOTO      RHTB2010 IF NOT EQUAL
.
.
......... Main Reading Complete. Read related information .....................
.
RHTB3000  PACK      KEY8,OTARREFN,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            BRANCH    DATEPREF,RHTB2010
            GOTO      RHTB1010
          ENDIF
.
          PACK      KEY8,OTARURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            BRANCH    DATEPREF,RHTB2010
            GOTO      RHTB1010
          ENDIF
.
          PACK      KEY8,OTARURNO,SP70
          CALL      RDPMPX21              
          IF        OVRCD=1
            BRANCH    DATEPREF,RHTB2010
            GOTO      RHTB1010
          ENDIF
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          MOVE      OTARPRSI,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OTARCLID
          IF        !@EQUAL
            PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,RHTB3050
.
              MATCH     OTARPRSI,OCASITE
              GOTO      RHTB3050 IF NOT EQUAL
.
              MATCH     OTARCLID,OCACLIN
              GOTO      RHTB3050 IF NOT EQUAL
              MOVE      OCADESC,CLIDDESC
              GOTO      RHTB4000
.
RHTB3050      PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,SP70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDKCLIA1          * Read Clinic Record
              BRANCH    OVRCD,RHTB4000
.
              MATCH     OTARPRSI,OCASITE
              GOTO      RHTB4000 IF NOT EQUAL
.
              MATCH     OTARCLID,OCACLIN
              GOTO      RHTB4000 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
RHTB4000  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,OTARVIST
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OTARVIST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARVIST,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority 
          MATCH     SP70,OTARPRIO
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,OTARPRIO,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARPRIO,TDESC
            ENDIF
            MOVE      TDESC,PRTYDESC
          ENDIF
.
          MOVE      SP70,RREQDESC                      * Reason for Request
          MATCH     SP70,OTARRREQ
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSU,OTARRREQ,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRREQ,TDESC
            ENDIF
            MOVE      TDESC,RREQDESC
          ENDIF
.
          MOVE      SP70,SPECDESC                      * Special Arrangements
          MATCH     SP70,OTARSARR
          IF        !@EQUAL
            PACK      KEY5,ANSS,ANSA,OTARSARR,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARSARR,TDESC
            ENDIF
            MOVE      TDESC,SPECDESC
          ENDIF
.
          MOVE      SP70,ACTNDATE                     * Action Date
.
          MOVE      SP70,STATDESC
          MATCH     "0",OTARSTAT
          IF        @EQUAL
            MOVE      "Requested",STATDESC
            MOVE      OTARCDAT,ACTNDATE 
          ENDIF
.
          MATCH     "1",OTARSTAT
          IF        @EQUAL
            MOVE      "Pending Reschedule",STATDESC
            MOVE      OTARRQDT,ACTNDATE 
          ENDIF
.
          MATCH     "2",OTARSTAT
          IF        @EQUAL
            MOVE      SP70,DISPDAT1
            UNPACK    OTARBKDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CLEAR     STATDESC
            APPEND    "Booked ",STATDESC
            APPEND    DISPDAT1,STATDESC
            APPEND    " at ",STATDESC
            APPEND    OTARCLTM,STATDESC
            RESET     STATDESC
          ENDIF
.
          MATCH     "3",OTARSTAT
          IF        @EQUAL
            MOVE      "Cancelled",STATDESC
          ENDIF
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OTARRQDT
          IF        !@EQUAL
            UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    OTARRQDT,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    OTARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARREFN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,TRIAGDES
          MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      RHTB5000 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RHTB5000
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      RHTB5000 IF NOT EQUAL
.
          MOVE      TDESC,TRIAGDES

RHTB5000  CLEAR     HTMLLNK2
          APPEND    "javascript:BookPatientHosp('",HTMLLNK2
          APPEND    OTARURNO,HTMLLNK2
          APPEND    OTARREFN,HTMLLNK2
          APPEND    OTARRQDT,HTMLLNK2
          APPEND    OTARRQTM,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    TRIAGDES,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MATCH     "3",OTARSTAT
          IF        @EQUAL
            CLEAR     HTMLLNK2
            APPEND    "javascript:UpdateRequest('",HTMLLNK2
            APPEND    OTARURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARREFN,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DISPDAT1,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARRQTM,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.
          MATCH     "0",OTARSTAT
          IF        @EQUAL
            CLEAR     HTMLLNK2
            APPEND    "javascript:UpdateRequest2('",HTMLLNK2
            APPEND    OTARURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARREFN,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DISPDAT1,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARRQTM,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.
          MATCH     "1",OTARSTAT
          IF        @EQUAL
            CLEAR     HTMLLNK2
            APPEND    "javascript:UpdateRequest2('",HTMLLNK2
            APPEND    OTARURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARREFN,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DISPDAT1,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARRQTM,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.
          CALL      ADEPDS00
          CALL      RDEPDS00  
          CALL      OCMTLK00 
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",FORMATNM,"#",":               * 1
                             "#"",FOLDERSF,"#",":               * 2
                             "#"",OTARURNO,"#",":               * 3
                             "#"",ALRERDAT,"#",":               * 4
                             "#"",SP1,"#",":                    * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",VISTDESC,"#",":               * 8
                             "#"",PRTYDESC,"#",":               * 9
                             "#"",LISTDAYS,"#",":               * 10
                             "#"",SPECDESC,"#",":               * 11
                             "#"",STATDESC,"#",":               * 12
                             "#"",HTMLLNK2,"#",":               * 13
                             "#"",OTARPRDT,"#",":               * 14
                             "#"",ACTNDATE,"#",":               * 15
                             "#"",OTARPCOM,"#",":               * 16
                             "#"",OTARPCOM,"#",":               * 17
                             "#"",ALREMDAT,"#",":               * 18
                             "#"",ADEPDESC,"#",":               * 19
                             "#"",RDEPDESC,"#",":               * 20
                             "#"",HTMLLNK6,"#",":               * 21
                             "#"",RREQDESC,"#");"               * 22
.
          BRANCH    DATEPREF,RHTB2010
          GOTO      RHTB1010
.
RHTB9999  RETURN
.
.--------------------------------------------------------------------
. Retrieve description for appointmnet department
.--------------------------------------------------------------------
ADEPDS00  MOVE      SP70,ADEPDESC                     * Appointment Dept
          MATCH     SP70,OTARADEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARADEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARADEP,TDESC
            ENDIF
            MOVE      TDESC,ADEPDESC
          ENDIF  
.
ADEPDS99  RETURN
.
.--------------------------------------------------------------------
. Retrieve description for requesting department
.--------------------------------------------------------------------
RDEPDS00  MOVE      SP70,RDEPDESC                     * Requesting dept
          MATCH     SP70,OTARRDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARRDEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRDEP,TDESC
            ENDIF
            MOVE      TDESC,RDEPDESC
          ENDIF  
.
RDEPDS99  RETURN
.--------------------------------------------------------------------
. Create comment icon and link when outpatient request comment exist
.--------------------------------------------------------------------
OCMTLK00  CLEAR     HTMLLNK6
          MATCH     SP70,OTARCMID
          IF        @EQUAL
            GOTO      OCMTLK99
          ENDIF 
.
          PACK      KEY13,OTARCMID,SP70
          CALL      RSOTRCM1
          CALL      RKOTRCM1
          BRANCH    OVRCD,OCMTLK99
.
          MATCH     OTARCMID,OTRCUNIQ
          GOTO      OCMTLK99 IF NOT EQUAL
.
          MATCH     SP70,OTRCCOMM
          GOTO      OCMTLK99 IF EQUAL
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OTARRQDT
          IF        !@EQUAL
          UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          APPEND    "&nbsp;<img src=../images/CommentIcon.gif",HTMLLNK6
          APPEND    " style='cursor:pointer' ",HTMLLNK6
          APPEND    " title='Oupatient Appointment Request Comments' ",HTMLLNK6
          APPEND    " onclick='",HTMLLNK6
          APPEND    "ViewRequestComment(\#"",HTMLLNK6
          APPEND    OTARURNO,HTMLLNK6 
          APPEND    "\#",\#"",HTMLLNK6  
          APPEND    OTARREFN,HTMLLNK6 
          APPEND    "\#",\#"",HTMLLNK6  
          APPEND    DISPDAT1,HTMLLNK6 
          APPEND    "\#",\#"",HTMLLNK6  
          APPEND    OTARRQTM,HTMLLNK6 
          APPEND    "\#");' ",HTMLLNK6 
          APPEND    "border=0>&nbsp;&nbsp;",HTMLLNK6 
          RESET     HTMLLNK6  
.
OCMTLK99  RETURN
+
.******************************************************************************
. Hospital level waiting AH referral Table
.******************************************************************************
AHTB0000  MOVE      ZERO,LOOPCNTR
.
          COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      AHTB9999 IF NOT EQUAL
.
          COMPARE   "1",INCLWAIT                      * Include waiting AH
          GOTO      AHTB9999 IF NOT EQUAL             * referrals
.
          MATCH     "1",DEPTINDC
          IF        @EQUAL
            PACK      KEY17,ZERO,SP70
            CALL      RSALREF3
          ELSE
            MATCH     SP70,FILTDEPT                     * Exit if department
            GOTO      AHTB9999 IF EQUAL                 * filter is blank
.
            PACK      KEY22,FILTDEPT,ZERO,SP70
            CALL      RSALREF4
          ENDIF
.
AHTB1000  MATCH     "1",DEPTINDC
          IF        @EQUAL
            CALL      RKALREF3
            BRANCH    OVRCD,AHTB9999
.
            MATCH     SP70,FILTDEPT
            IF        !@EQUAL
              MATCH     FILTDEPT,ALREDEPT                 * Department filter
              GOTO      AHTB1000 IF NOT EQUAL
            ENDIF
.
          ELSE
            CALL      RKALREF4
            BRANCH    OVRCD,AHTB9999
.
            MATCH     FILTDEPT,ALREDEPT                 * Department filter
            GOTO      AHTB9999 IF NOT EQUAL
          ENDIF
.
          MATCH     "0",ALRESTAT                      * Waiting only
          GOTO      AHTB9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          MATCH     SP70,FILTSITE                     * Site Filter
          IF        !@EQUAL
            MATCH     FILTSITE,ALREPSIT
            GOTO      AHTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP                     * Clinic Type Filter
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AHTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLID                     * Clinic Id Filter
          IF        !@EQUAL
            MATCH     FILTCLID,ALRECLID
            GOTO      AHTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPRTY                     * Priority Filter
          IF        !@EQUAL
            MATCH     FILTPRTY,ALREPRTY
            GOTO      AHTB1000 IF NOT EQUAL
          ENDIF
.
          IF        DATEPREF=1
            MATCH     FRSTDATE,ALREUDT1              * Preferred date
            GOTO      AHTB1000 IF LESS                * filter
.
            MATCH     ALREUDT1,LASTDATE              
            GOTO      AHTB1000 IF LESS
          ENDIF
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,AHTB1000
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS               * Hospital
            GOTO      AHTB1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,AHTB1000
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,AHTB1000
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          MOVE      ALREPSIT,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,ALRECTYP
          IF        !@EQUAL
            PACK      KEY12,ALREPSIT,ALRECTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      ALRECTYP,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,ALRECLID
          IF        !@EQUAL
            PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,AHTB1050
.
              MATCH     ALREPSIT,OCASITE
              GOTO      AHTB1050 IF NOT EQUAL
.
              MATCH     ALRECLID,OCACLIN
              GOTO      AHTB1050 IF NOT EQUAL
              MOVE      OCADESC,CLIDDESC
              GOTO      AHTB1100
.
.***** added for CAR 304422 when referrals added before clinic opened
AHTB1050      PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,SP70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDKCLIA1          * Read Clinic Record
              BRANCH    OVRCD,AHTB1100
.
              MATCH     ALREPSIT,OCASITE
              GOTO      AHTB1100 IF NOT EQUAL
.
              MATCH     ALRECLID,OCACLIN
              GOTO      AHTB1100 IF NOT EQUAL
.
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
AHTB1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,ALRESTYP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,ALRESTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALRESTYP,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority
          MATCH     SP70,ALREPRTY
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALREPRTY,TDESC
            ENDIF
            MOVE      TDESC,PRTYDESC
          ENDIF
.
          MOVE      "Waiting",STATDESC
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,ALRERDAT
          IF        !@EQUAL
            UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    ALRERDAT,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    ALREURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:LinkReferral('",HTMLLNK2
          APPEND    ALREURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREVISN,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MOVE      ALRECDAT,ACTNDATE
.
          PACK      HTMLLNK5,SP70,SP70
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,AHTB1200
.
          MATCH     ALRLLNKV,ALREVISN
          GOTO      AHTB1300 IF EQUAL
.
AHTB1200  CALL      PROG0000 
.
AHTB1300  MOVE      ALREDEPT, OTARADEP   * Appointmnet department
          MOVE      ALREDEPT,OTARRDEP    * Requesting department
          MOVE      SP70,OTARCMID        * Request comment id
          CALL      ADEPDS00
          CALL      RDEPDS00
          CALL      OCMTLK00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",FORMATNM,"#",":               * 1
                             "#"",FOLDERSF,"#",":               * 2
                             "#"",ALREURNO,"#",":               * 3
                             "#"",ALRERDAT,"#",":               * 4
                             "#"",SP1,"#",":                    * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",VISTDESC,"#",":               * 8
                             "#"",PRTYDESC,"#",":               * 9
                             "#"",LISTDAYS,"#",":               * 10
                             "#"",SP1,"#",":                    * 11
                             "#"",STATDESC,HTMLLNK5,"#",":      * 12
                             "#"",HTMLLNK2,"#",":               * 13
                             "#"",ALREUDT1,"#",":               * 14
                             "#"",ACTNDATE,"#",":               * 15
                             "#"",ALREPRCM,"#",":               * 16
                             "#"",ALREUFR1,"#",":               * 17
                             "#"",ALREMDAT,"#",":               * 18
                             "#"",ADEPDESC,"#",":               * 19
                             "#"",RDEPDESC,"#",":               * 20
                             "#"",HTMLLNK6,"#",":               * 21
                             "#"",SP1,"#");"                    * 22
.
          GOTO      AHTB1000
.
AHTB9999  RETURN
.
.-----------------------------------------------------------------------------.
. Show create program referrral icon
.-----------------------------------------------------------------------------.
PROG0000  PACK      HTMLLNK5,SP70,SP70
.
          MATCH     "0",ALRESTAT            * Waiting or Active only
          IF        !@EQUAL
            MATCH     "1",ALRESTAT
            GOTO      PROG9999 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",ALREUYN4            * Episode referrals only
          GOTO      PROG9999 IF EQUAL
.
          MATCH     "1",ALRENVIN            * Non VINAH referal
          GOTO      PROG9999 IF EQUAL
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     SP70,TCINDC8            * Not a VINAH program
          GOTO      PROG9999 IF EQUAL
.
          MATCH     ANSE,TCINDC11           * VINAH Combined episode stream
          GOTO      PROG9999 IF NOT EQUAL
.
          MATCH     "1",ALCNDEVP            * Display Event Program
          GOTO      PROG2000 IF NOT EQUAL
.
          MATCH     SP70,ALREEVPR           * Blank Event Program
          GOTO      PROG2000 IF EQUAL
.
          PACK      KEY5,CATZG,ALREEVPR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PROG2000
.
          MATCH     ANSE,TCINDC2            * Exclude from VINAH
          GOTO      PROG9999 IF EQUAL
.
PROG2000  REP       " +",ALREURNO
          REP       " +",ALREVISN
          CLEAR     HTMLLNK5
          APPEND    "<input type=button class=button ",HTMLLNK5
          APPEND    "value='Create Program' ",HTMLLNK5
          APPEND    "onclick=CreateProgramRef('",HTMLLNK5
          APPEND    ALREURNO,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    ALREVISN,HTMLLNK5
          APPEND    "')>",HTMLLNK5
          RESET     HTMLLNK5
          REP       "+ ",ALREURNO
          REP       "+ ",ALREVISN
.
PROG9999  RETURN

.
.******************************************************************************
. Hospital Level Suspended OP Appointments Table
.******************************************************************************
SHTB0000  MOVE      ZERO,LOOPCNTR
.         
          COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      SHTB9999 IF NOT EQUAL
.
          COMPARE   "1",INCLSUSP                      * Include suspended OP
          GOTO      SHTB9999 IF NOT EQUAL             * appointments
.
          MATCH     SP70,FILTCTYP                     * Exit if clinic type
          GOTO      SHTB9999 IF EQUAL                 * filter is blank
.
          PACK      KEY35,FILTSITE,FILTCTYP,SIX,SP70
          CALL      RDSBOKA2
SHTB1000  CALL      RDKBOKA2
          BRANCH    OVRCD,SHTB9999
.
          MATCH     FILTSITE,OBASITE
          GOTO      SHTB9999 IF NOT EQUAL
.
          MATCH     FILTCTYP,OBACTYP
          GOTO      SHTB9999 IF NOT EQUAL
.
          COMPARE   SIX,OBASTAT
          GOTO      SHTB9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      SHTB1000 IF EQUAL
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     OBACLIN,FILTCLID
            GOTO      SHTB1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,SHTB1000
.
          MATCH     SP70,FILTPRTY
          IF        !@EQUAL
            MATCH     OBAPRTY,FILTPRTY
            GOTO      SHTB1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,SHTB1000
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS               * Hospital
            GOTO      SHTB1000 IF NOT EQUAL
          ENDIF
.
          CALL      CLALLREF
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                     * Check for linked referral
          BRANCH    OVRCD,SHTB1050
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      SHTB1050 IF NOT EQUAL
.
          CALL      CLALLREF
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                    * Read linked AH referral
          BRANCH    OVRCD,SHTB1050
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     ALREDEPT,FILTDEPT          * Linked referral department 
            GOTO      SHTB1000 IF NOT EQUAL      * filter
          ENDIF
.
SHTB1050  PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SHTB1000
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,SHTB1000
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          MOVE      OBASITE,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OBACTYP
          IF        !@EQUAL
            PACK      KEY12,OBASITE,OBACTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OBACTYP,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OBACLIN
          IF        !@EQUAL
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,SHTB1075
.
              MATCH     OBASITE,OCASITE
              GOTO      SHTB1075 IF NOT EQUAL
.
              MATCH     OBACLIN,OCACLIN
              GOTO      SHTB1075 IF NOT EQUAL
              MOVE      OCADESC,CLIDDESC
              GOTO      SHTB1100
.
SHTB1075      PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDKCLIA1          * Read Clinic Record
              BRANCH    OVRCD,SHTB1100
.
              MATCH     OBASITE,OCASITE
              GOTO      SHTB1100 IF NOT EQUAL
.
              MATCH     OBACLIN,OCACLIN
              GOTO      SHTB1100 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
SHTB1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OBAVISIT,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority
          MATCH     SP70,OBAPRTY
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,OBAPRTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OBAPRTY,TDESC
            ENDIF
            MOVE      TDESC,PRTYDESC
          ENDIF
.
          MOVE      SP70,SPECDESC                      * Special Arrangements
          MATCH     SP70,OTBBSPCA
          IF        !@EQUAL
            PACK      KEY5,ANSS,ANSA,OTBBSPCA,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTBBSPCA,TDESC
            ENDIF
            MOVE      TDESC,SPECDESC
          ENDIF
.
          MOVE      SP70,STATDESC
          MOVE      "Suspended",STATDESC
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OBADATE
          IF        !@EQUAL
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    OBADATE,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    OBAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBAOUTNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:RescheduleAppt('",HTMLLNK2
          APPEND    OBAURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    OBAOUTNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    KEY28,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MOVE      SP70,ACTNDATE
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD<>1
            CALL      CHKSUS00           * Get session suspension details
            IF        EXIT=1
              MOVE      OTMSEDAT,ACTNDATE
            ENDIF
          ENDIF
.
          MOVE      ALREDEPT, OTARADEP   * Appointmnet department
          MOVE      ALREDEPT,OTARRDEP    * Requesting department
          MOVE      SP70,OTARCMID        * Request comment id
          CALL      ADEPDS00
          CALL      RDEPDS00
          CALL      OCMTLK00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",FORMATNM,"#",":               * 1
                             "#"",FOLDERSF,"#",":               * 2
                             "#"",OBAURNO,"#",":                * 3
                             "#"",SP1,"#",":                    * 4
                             "#"",OBADATE,"#",":                * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",VISTDESC,"#",":               * 8
                             "#"",PRTYDESC,"#",":               * 9
                             "#"",LISTDAYS,"#",":               * 10
                             "#"",SPECDESC,"#",":               * 11
                             "#"",STATDESC,"#",":               * 12
                             "#"",HTMLLNK2,"#",":               * 13
                             "#"",SP1,"#",":                    * 14
                             "#"",ACTNDATE,"#",":               * 15
                             "#"",PMVXUDF1,"#",":               * 16
                             "#"",SP1,"#",":                    * 17
                             "#"",ALREMDAT,"#",":               * 18
                             "#"",ADEPDESC,"#",":               * 19
                             "#"",RDEPDESC,"#",":               * 20
                             "#"",HTMLLNK6,"#",":               * 21
                             "#"",SP1,"#");"                    * 22
.
          GOTO      SHTB1000
.
SHTB9999  RETURN
.
.---------------------------------------------------------------------------
. Write new appointment request for cancelled booking
.---------------------------------------------------------------------------
WREQ0000  MATCH     "1",REQUESTA                 * Write appointment request
          GOTO      WREQ9999 IF NOT EQUAL
.
          MATCH     Z70,OTART001                 * U/R
          GOTO      WREQ9999 IF EQUAL
.
          MATCH     Z70,OTART002                 * Referral Number
          GOTO      WREQ9999 IF EQUAL
.
          MOVE      OBAOUTNO,KEY8                * Read visit extn to get
          CALL      RDPMVX11                     * pres comp and hospital
          BRANCH    OVRCD,WREQ9999
.
          CALL      CLOUTART                     * Clear file vars
          MOVE      OTART001,OTARURNO            * U/R
          MOVE      OTART002,OTARREFN            * Referral
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OTARRQDT                * System date
          CLOCK     TIME,OTARRQTM                * System time
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      RDOTART1
          COMPARE   ZERO,OVRCD
          GOTO      WREQ9999 IF EQUAL
.
          MOVE      OTBBDEPT,OTARRDEP    * Requesting Department
          MOVE      OTBBDEPT,OTARADEP    * Appointment with Department(Cat.AC)
          MOVE      PMVXMHOS,OTARPRHS    * Preferred Hospital
          MOVE      OBASITE,OTARPRSI     * Preferred Site
          MOVE      OBACTYP,OTARCLTY     * Clinic Type
          MOVE      OBACLIN,OTARCLID     * Clinic Id
          MOVE      OBAVISIT,OTARVIST    * Visit Type                 (Cat.CV)
          MOVE      OTBBTRAN,OTARTRRQ    * Transport Required         (Cat.OB)
          MOVE      PMVXUDF1,OTARPCOM    * Presenting Complaint
          MOVE      OBACOMP,OTARFINC     * Financial Class            (Cat.CL)
          MOVE      OBAPRTY,OTARPRIO     * Priority                   (Cat.PR)
          MOVE      OBASRCR,OTARSORF     * Source of Referral         (Cat.S )
          MOVE      OTBBSPCA,OTARSARR    * Special Arrangements       (Cat.SA)
          MOVE      OBAOUTNO,OTAROOBN    * Original O/P Booking Number
          MOVE      ONE,OTARSTAT         * Status   1 - Pending Reschedule
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OTARCDAT        * System date
          CLOCK     TIME,OTARCTIM        * System time
          MOVE      USERID,OTARCUID      * web user id
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      WROTART1
.
          STRIP     REDIRECT                     * Append key for request to
          ENDSET    REDIRECT                     * redirect popup
          APPEND    "&popupreq=",REDIRECT
          APPEND    KEY32,REDIRECT
          RESET     REDIRECT
.
WREQ9999  RETURN
.
.---------------------------------------------------------------------------
. Read existing OP appointment and default fields to the add request screen
.---------------------------------------------------------------------------
DEFA0000  MATCH     SP70,POPUPAPP        * Any appointment to default 
          GOTO      DEFA9999 IF EQUAL
.  
          PACK      KEY28,POPUPAPP,SP70        
          CALL      RDBOKA1               
          BRANCH    OVRCD,DEFA9999
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,DEFA9999
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,DEFA9999
.
          MOVE      OTBBDEPT,OTARRDEP    * Requesting Department
          MOVE      OTBBDEPT,OTARADEP    * Appointment with Department(Cat.AC)
          MOVE      PMVXMHOS,OTARPRHS    * Preferred Hospital
          MOVE      OBASITE,OTARPRSI     * Preferred Site
          MOVE      OBACTYP,OTARCLTY     * Clinic Type
          MOVE      OBACLIN,OTARCLID     * Clinic Id
          MOVE      OBAVISIT,OTARVIST    * Visit Type                 (Cat.CV)
          MOVE      OTBBTRAN,OTARTRRQ    * Transport Required         (Cat.OB)
          MOVE      PMVXUDF1,OTARPCOM    * Presenting Complaint
          MOVE      OBACOMP,OTARFINC     * Financial Class            (Cat.CL)
          MOVE      OBAPRTY,OTARPRIO     * Priority                   (Cat.PR)
          MOVE      OBASRCR,OTARSORF     * Source of Referral         (Cat.S )
          MOVE      OTBBSPCA,OTARSARR    * Special Arrangements       (Cat.SA)
          MOVE      OBAOUTNO,OTAROOBN    * Original O/P Booking Number
.
DEFA9999  RETURN
+
.------------------------------------------------------------------------------
. If the slot type is chart review set the send letter to N/A
. and clear the send letter date. If send letter is yes calculate 
. the generate letter date
.------------------------------------------------------------------------------
CHRT0000  MOVE      SP70,OUTBB066         * Clear letter cgi vars
          MOVE      SP70,OUTBB067
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHRT9999
.
          MATCH     "C",TCINDC8                  * Chart review
          IF        @EQUAL
            MOVE      "2",OUTBB067               * Sent send letter to N/A 
          ENDIF
.
          MOVE      SENDLETT,OUTBB067 
.
          MATCH     "1",OUTBB067                 * Send letter yes/no
          GOTO      CHRT9999 IF NOT EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Current date
          REP       " 0",CURRDATE
.    
          MOVE      ZERO,F3
          MOVE      OTHENDPS,F3                  * No. of days prior to send
          MOVE      OBADATE,GLETDATE             * letter
          SUB       F3,GLETDATE
.
          MATCH     GLETDATE,CURRDATE
          IF        !@LESS
            MOVE      CURRDATE,GLETDATE          *  Set letter date to today
....        ADD       ONE,GLETDATE               * if less that today
            MOVE      GLETDATE,OUTBB066
          ELSE
            MOVE      GLETDATE,OUTBB066
          ENDIF
.
          MATCH     CURRDATE,OBADATE             * WA CAR 271432
          IF        @LESS
            MOVE      SP70,OUTBB066              * past appointment = no letter
            MOVE      "2",OUTBB067               * Send letter = N/A
          ENDIF
.
CHRT9999  RETURN
+
.*******************************************************************************
. OP Letter History
.*******************************************************************************
LHIS0000  MATCH     SP70,UPDTTYPE
          GOTO      LHIS5000 IF EQUAL
.
          GOTO      LHIS9000
.
LHIS5000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LHIS9100
.
          CALL      RDPMPX21
          BRANCH    OVRCD,LHIS9100
.
          MOVE      "Outpatient Letter History",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,LHIS9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      LHIS9999
.
LHIS9000  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LHIS9999
.
LHIS9100  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LHIS9999
.
LHIS9999  RETURN
.
.*******************************************************************************
. OP Letter History General Tags
.*******************************************************************************
LTAG0000  BRANCH    FLDITMNO,LTAG0100
.
          WRITE     HTMLFILE;"Invalid IBA TAG";
          GOTO      LTAG9999
.
LTAG0100  CALL      OHIS0000
          GOTO      LTAG9999
.
LTAG9999  RETURN
.
.******************************************************************************
. Patient Level OP Letter History Table
.******************************************************************************
OHIS0000  PACK      KEY27,URNUMBER,SP70
          CALL      RSOTLHI1
OHIS1000  CALL      RKOTLHI1
          BRANCH    OVRCD,OHIS9999
.
          MATCH     URNUMBER,OTLHURNO
          GOTO      OHIS9999 IF NOT EQUAL
.
          MOVE      OTLHSITE,CHECKSIT
          CALL      COTFIL00                * Check outpatient file prefix
.
          PACK      KEY28,OTLHSITE,OTLHCLIN,OTLHCDAT,OTLHCTIM,OTLHSLOT,SP70
          CALL      RDBOKA1
          COMPARE   ONE,OVRCD              * Original slot found from time of
          GOTO      OHIS1500 IF NOT EQUAL  * letter printing
.
. Original slot may be missing as overbooking slots are delete on
. reschedule
.
          PACK      KEY36,OTLHSITE,OTLHCLIN,OTLHCDAT,OTLHCTIM,OTLHOUTN,SP70
          CALL      RDSRSHA2
          CALL      RDKRSHA2               * Check if origina slot was
          BRANCH    OVRCD,OHIS1200         * rescheduled
.
          MATCH     OTLHSITE,OPRSSITE
          GOTO      OHIS1200 IF NOT EQUAL
.
          MATCH     OTLHCLIN,OPRSCLIN
          GOTO      OHIS1200 IF NOT EQUAL
.
          MATCH     OTLHCDAT,OPRSDATE
          GOTO      OHIS1200 IF NOT EQUAL
.
          MATCH     OTLHCTIM,OPRSSTRT
          GOTO      OHIS1200 IF NOT EQUAL
.
          MATCH     OTLHOUTN,OPRSOUTN
          GOTO      OHIS1200 IF NOT EQUAL
.
          CALL      CLOUTBOA
          MOVE      OPRSSITE,OBASITE
          MOVE      OPRSCLIN,OBACLIN
          MOVE      OPRSDATE,OBADATE
          MOVE      OPRSSTRT,OBASTRT
          MOVE      OPRSSLOT,OBASLOT
          MOVE      OPRSTIME,OBATIME
          MOVE      OPRSCLTY,OBACTYP
.
          GOTO      OHIS1500
.
. Original slot may be missing as overbooking slots are delete on
. cancel appointment
.
OHIS1200  PACK      KEY8,OTLHOUTN,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,OHIS1300
.
          CALL      CLOUTBOA
          MOVE      OPCNSITE,OBASITE
          MOVE      OPCNCLIN,OBACLIN
          MOVE      OPCNDATE,OBADATE
          MOVE      OPCNSTRT,OBASTRT
          MOVE      OPCNSLOT,OBASLOT
          MOVE      OPCNTIME,OBATIME
          MOVE      OPCNCTYP,OBACTYP
.
          GOTO      OHIS1500
.
OHIS1300  PACK      KEY36,OTLHOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6                * Read current OP Booking for letter
          BRANCH    OVRCD,OHIS1400
.
          MATCH     OBAOUTNO,OTLHOUTN
          GOTO      OHIS1400 IF NOT EQUAL
.
          MATCH     OBAURNO,URNUMBER
          GOTO      OHIS1400 IF NOT EQUAL
.
          GOTO      OHIS1500
.
OHIS1400  CALL      CLOUTBOA
.
OHIS1500  MOVE      SP70,CTYPDESC
          MATCH     SP70,OBACTYP
          IF        !@EQUAL
            PACK      KEY12,OBASITE,OBACTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OBACTYP,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OBACLIN
          IF        !@EQUAL
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,OHIS2000
.
              MATCH     OBASITE,OCASITE
              GOTO      OHIS2000 IF NOT EQUAL
.
              MATCH     OBACLIN,OCACLIN
              GOTO      OHIS2000 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
OHIS2000  PACK      KEY6,OTLHLNUM,SP1,SP1,ZERO,SP70
          CALL      RDOTLET1
          IF        OVRCD=1
            MOVE     OTLHLNUM,OTLTTEXT
          ENDIF
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,OTLHPUID
          IF        !@EQUAL
            PACK      KEY10,OTLHPUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      OTLHPUID,WBSENAM
            ENDIF
          ENDIF
.
          MOVE      SP70,HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",OTLHURNO,"#",":               * 1
                             "#"",OTLHDATE,"#",":               * 2
                             "#"",OTLHLNUM,"#",":               * 3
                             "#"",OTLHOUTN,"#",":               * 4
                             "#"",OBADATE,OBATIME,"#",":        * 5
                             "#"",CTYPDESC,"#",":               * 6
                             "#"",CLIDDESC,"#",":               * 7
                             "#"",WBSENAM,"#",":                * 8
                             "#"",OTLTTEXT,"#");"               * 9`
.
          GOTO      OHIS1000
.
OHIS9999  RETURN
.
.*******************************************************************************
. Get OPD Comment
.*******************************************************************************
GETOPD00  PREP      COMFILOF,COMFILNO
          MOVE      ZERO,OPDFLAG
          MOVE      ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
.
GETOPD10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETOPD90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETOPD80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
          GOTO      GETOPD10
.
GETOPD80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETOPD90  MOVE      F3,OPDWEND
          OPEN      COMFILOF,COMFILNO
GETOPD99  RETURN
.
.------------------------------------------------------------------------------
. Write cancel OPD action and comments
.------------------------------------------------------------------------------
COPD0000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     SP70,WBSEOPDU                * Exit if not an OPD user
          GOTO      COPD9999 IF EQUAL
.
          PACK      KEY5,CATTZ,WBSEOPDU,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     ANSO,TCINDC1                 * OPD user
          GOTO      COPD9999 IF NOT EQUAL
.
          CALL      CLOUTDAN
          MOVE      OPCNURNO,OTDNURNO
          MOVE      OPCNRDTE,OTDNADAT
          MOVE      OPCNRTIM,OTDNATIM
          MATCH     "1",REQUESTA
          IF        @EQUAL
            MOVE      " 4",OTDNATYP                * pending reschedule
          ELSE
            MOVE      " 3",OTDNATYP                * Cancel appointment
          ENDIF
          MOVE      OPCNOUTN,OTDNVISN
          MOVE      OPCNDATE,OTDNVDAT
.
          PACK      OTDNCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTDNCDAT           *
          CLOCK     TIME,OTDNCTIM
          MOVE      USERID,OTDNCUID
.
          PACK      KEY34,OTDNURNO,OTDNADAT,OTDNATIM,OTDNATYP,OTDNVISN,SP70
          CALL      RAOTDAN1
          IF        OVRCD=1
            CALL      WROTDAN1                    * Write actions record
          ENDIF
.
          MOVE      OTDNURNO,COMMURNO
          MOVE      OTDNADAT,COMMADAT
          MOVE      OTDNATIM,COMMATIM
          MATCH     "1",REQUESTA
          IF        @EQUAL
            MOVE      " 4",COMMTYPE            * Pending reschedule   
          ELSE
            MOVE      " 3",COMMTYPE            * Cancelled Appointment
          ENDIF
          CALL      UPOPD000                 * OPD Message
.
COPD9999  RETURN
.
.*******************************************************************************
. OPD appointment comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPOPD000  BRANCH    OPDFLAG,UPOPD999
.
          PACK      KEY29,COMMURNO,COMMADAT,COMMATIM,COMMTYPE,SP70
          CALL      RSOTDCO1
UPOPD400  CALL      RKOTDCO1
          BRANCH    OVRCD,UPOPD500          * end of file
.
          MATCH     COMMURNO,OTDOURNO
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMADAT,OTDOADAT
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMATIM,OTDOATIM
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMTYPE,OTDOATYP
          GOTO      UPOPD500 IF NOT EQUAL
.
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      DEOTDCO1
          GOTO      UPOPD400
.
.         now write the new comments back
.
UPOPD500  MOVE      COMMURNO,OTDOURNO
          MOVE      COMMADAT,OTDOADAT
          MOVE      COMMATIM,OTDOATIM
          MOVE      COMMTYPE,OTDOATYP
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILOF,COMFILNO
          TRAPCLR   IO
          BRANCH    OVRCD,UPOPD999
.
UPOPD510  ADD       ONE,F3
          READ      COMFILOF,SEQ;OTDOCOMM
.
          MATCH     SP70,OTDOCOMM
          IF        @EQUAL
            IF        F3>=OPDWEND
              GOTO      UPOPD999
            ELSE
              GOTO      UPOPD510
            ENDIF
          ENDIF
.
          MOVE      F3,OTDOCLNO
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      WROTDCO1
          IF        F3>=OPDWEND
            GOTO      UPOPD999
          ENDIF
          GOTO      UPOPD510
.
UPOPD999  MOVE      ONE,OPDFLAG
          RETURN
+
.-------------------------------------------------------------------------------
.  DISVAL00 - Disaster Validations and Post
.-------------------------------------------------------------------------------
DISVAL00  MATCH     SP70,DISPT001
          GOTO      DISVAL99 IF EQUAL
          GOTO      DISVAL99 IF EOS
.
          PACK      KEY9,DISPT001,SP70
          CALL      RDDSMAS1
          IF        OVRCD=ONE
            GOTO      DISVAL99
          ENDIF
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,OBADATE
            IF        @LESS
              GOTO      DISVAL99
            ENDIF
          ENDIF
.
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL & !@EOS
            MATCH     OBADATE,DSMAEDAT
            IF        @LESS
              GOTO      DISVAL99
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT002,DSPTDIID
          MOVE      DISPT001,DSPTCODE
          MOVE      DSMASDAT,DSPTSDAT
          MOVE      DSMAEDAT,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      " 3",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT001,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      WBSEUID,DSPTUUSR
            CALL      IBACLOCK
            PACK      DSPTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPAT1
          ENDIF
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT001,DSPLCODE
          MOVE      DOBAOUTN,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT001,DOBAOUTN,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      WBSEUID,DSPLUUSR
            CALL      IBACLOCK
            PACK      DSPLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPTL1
          ENDIF
.
          CALL     NWDALT00
.
DISVAL99  RETURN
.
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,PURNO,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.
NWDALT99  RETURN
+
.------------------------------------------------------------
. DISSEL00 - Display Selection List for Disasters
.------------------------------------------------------------
.
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "3",DSMAACTV
          GOTO      DISSEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DSMACODE,"#">":
                             DSMADESC,"</option>"
          GOTO      DISSEL10
.
DISSEL99  RETURN
+
.------------------------------------------------------------
. DISCD000 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCD000  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCD010  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCD999
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCD999 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISCD010 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSPLCODE;
          ENDIF
.
DISCD999  RETURN
.
.------------------------------------------------------------
. DISDS000 - Get Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISDS000  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISDS010  CALL      RKDSPTL1
          BRANCH    OVRCD,DISDS999
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISDS999 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISDS010 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            PACK      KEY9,DSPLCODE,SP70
            CALL      RDDSMAS1
            IF        OVRCD=0
              WRITE     HTMLFILE;DSMADESC;
            ENDIF
          ENDIF
.
DISDS999  RETURN
.*******************************************************************************
. RMDIS000 - Remove disaster details when cancelling preadmission
.*******************************************************************************
..  First, delete the disaster link record if there is one
RMDIS000  PACK     SAVDISKY,SP70
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
RMDIS100  CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS999
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS999 IF NOT EQUAL
.
          MATCH    DSPLVISN,ADMISSNO
          GOTO     RMDIS100 IF NOT EQUAL
.
          PACK     KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL     DEDSPTL1
          PACK     SAVDISKY,DSPLURNO,DSPLCODE,SP70
.
..  If this was the only disaster link record, delete the patient level record
.
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
          CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS200
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS200 IF NOT EQUAL
          GOTO     RMDIS999
.
RMDIS200  PACK     KEY17,SAVDISKY,SP70
          CALL     DEDSPAT1
          CALL     DELALT00
.
RMDIS999  RETURN
+
.---------------------------------------------------------------------
. DELALT00 - Delete alternate ID record for disaster patients
.---------------------------------------------------------------------
DELALT00  UNPACK    SAVDISKY,DIM8,DIM9
          PACK      KEY9,DIM9,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DELALT99
.
          MATCH     SP70,DSMAAICD
          GOTO      DELALT99 IF EQUAL
          GOTO      DELALT99 IF EOS
.
          PACK      KEY31,DIM8,DSMAAICD,SP70
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,DELALT99
.
          MATCH     PMAIURNO,DIM8
          GOTO      DELALT99 IF NOT EQUAL
.
          MATCH     PMAITYPE,DSMAAICD
          GOTO      DELALT99 IF NOT EQUAL
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      DEPMAID1
.
DELALT99  RETURN
+
.---------------------------------------------------------------------
. EOSR0000 - End of search results line
.---------------------------------------------------------------------
EOSR0000  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=15 align=center>":
                              "End of search results</td>"
.
EOSR9999  RETURN
.
.------------------------------------------------------------------------------
. Default AH referrals claim details to OP booking if booked from an AH referral
.------------------------------------------------------------------------------
RCLM0000  MATCH     "1",PTCNXCOM            * Using extra compensable details
          GOTO      RCLM9999 IF NOT EQUAL
.
          PACK      KEY11,ALREVISN,OBACOMP,SP70
          CALL      RDPMEXT1                     * Copy compensable details
          BRANCH    OVRCD,RCLM9999               * from AH to OP if same claim
.                                                * code
          MOVE      OBAOUTNO,PMEXVISN
.
          PACK      KEY11,PMEXVISN,PMEXCLAM,SP70
          CALL      RAPMEXT1
          IF        OVRCD=1
            MOVE      OBADATE,PMEXVDAT
            CALL      WRPMEXT1
          ENDIF
.
RCLM9999  RETURN
.
.******************************************************************************
. Patient level waiting AH referral Table
.******************************************************************************
PAHT0000  COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      PAHT9999 IF NOT EQUAL
.
          COMPARE   "1",INCLWAIT                      * Include waiting AH
          GOTO      PAHT9999 IF NOT EQUAL             * referrals
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
PAHT1000  CALL      RKALREF2
          BRANCH    OVRCD,PAHT9999
.
          MATCH     URNUMBER,ALREURNO                 * Correct U/R
          GOTO      PAHT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     FILTDEPT,ALREDEPT               * Department filter
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "0",ALRESTAT                      * Waiting only
          GOTO      PAHT1000 IF NOT EQUAL
.
          MATCH     SP70,FILTSITE                     * Site Filter
          IF        !@EQUAL
            MATCH     FILTSITE,ALREPSIT
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP                     * Clinic Type Filter
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLID                     * Clinic Id Filter
          IF        !@EQUAL
            MATCH     FILTCLID,ALRECLID
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPRTY                     * Priority Filter
          IF        !@EQUAL
            MATCH     FILTPRTY,ALREPRTY
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          IF        DATEPREF=1
            MATCH     FRSTDATE,ALREUDT1              * Preferred date
            GOTO      PAHT1000 IF LESS                * filter
.
            MATCH     ALREUDT1,LASTDATE
            GOTO      PAHT1000 IF LESS
          ENDIF
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,PAHT1000
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS               * Hospital
            GOTO      PAHT1000 IF NOT EQUAL
          ENDIF
.
          MOVE      ALREPSIT,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,ALRECTYP
          IF        !@EQUAL
            PACK      KEY12,ALREPSIT,ALRECTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      ALRECTYP,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,ALRECLID
          IF        !@EQUAL
            PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,PAHT1050
.
              MATCH     ALREPSIT,OCASITE
              GOTO      PAHT1050 IF NOT EQUAL
.
              MATCH     ALRECLID,OCACLIN
              GOTO      PAHT1050 IF NOT EQUAL
              MOVE      OCADESC,CLIDDESC
              GOTO      PAHT1100
.
.***** added for CAR 304422 when referrals added before clinic opened
PAHT1050      PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,SP70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDKCLIA1          * Read Clinic Record
              BRANCH    OVRCD,PAHT1100
.
              MATCH     ALREPSIT,OCASITE
              GOTO      PAHT1100 IF NOT EQUAL
.
              MATCH     ALRECLID,OCACLIN
              GOTO      PAHT1100 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
PAHT1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,ALRESTYP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,ALRESTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALRESTYP,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority
          MATCH     SP70,ALREPRTY
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALREPRTY,TDESC
            ENDIF
            MOVE      TDESC,PRTYDESC
          ENDIF
.
          MOVE      "Waiting",STATDESC
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,ALRERDAT
          IF        !@EQUAL
            UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    ALRERDAT,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    ALREURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:LinkReferral('",HTMLLNK2
          APPEND    ALREURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREVISN,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MOVE      ALRECDAT,ACTNDATE
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",ALRERDAT,"#",":               * 1
                             "#"",SP1,"#",":                    * 2
                             "#"",CTYPDESC,"#",":               * 3
                             "#"",CLIDDESC,"#",":               * 4
                             "#"",VISTDESC,"#",":               * 5
                             "#"",PRTYDESC,"#",":               * 6
                             "#"",LISTDAYS,"#",":               * 7 
                             "#"",SP1,"#",":                    * 8 
                             "#"",STATDESC,"#",":               * 9 
                             "#"",HTMLLNK2,"#",":               * 10
                             "#"",ALREUDT1,"#",":               * 11
                             "#"",ACTNDATE,"#",":               * 12
                             "#"",ALREPRCM,"#");"               * 13
.
          GOTO      PAHT1000
.
PAHT9999  RETURN
.
.
.******************************************************************************
. Patient Level Requested Appointments Table
.******************************************************************************
PRHT0000  COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      PRHT9999 IF NOT EQUAL
.
          PACK      KEY32,URNUMBER,SP70
          CALL      RSOTART1
PRHT1000  CALL      RKOTART1
          BRANCH    OVRCD,PRHT9999
.
          MATCH     URNUMBER,OTARURNO                 * U/R
          GOTO      PRHT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP                     * Hospital Filter
          IF        !@EQUAL
            MATCH     FILTHOSP,OTARPRHS
            GOTO      PRHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSITE                     * Site Filter
          IF        !@EQUAL
            MATCH     FILTSITE,OTARPRSI
            GOTO      PRHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP                     * Clinic Type Filter
          IF        !@EQUAL
            MATCH     FILTCTYP,OTARCLTY
            GOTO      PRHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLID                     * Clinic Id Filter
          IF        !@EQUAL
            MATCH     FILTCLID,OTARCLID
            GOTO      PRHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT                     * Status filter
          IF        !@EQUAL
            MATCH     "0",FILTSTAT
            IF        @EQUAL
              MATCH     "0",OTARSTAT
              IF        !@EQUAL
                MATCH     "1",OTARSTAT                * Include pending resch.
                GOTO      PRHT1000 IF NOT EQUAL       * with requested
              ENDIF
            ELSE
              MATCH     FILTSTAT,OTARSTAT
              GOTO      PRHT1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTDEPT                     * Required department
          IF        !@EQUAL
            MATCH     FILTDEPT,OTARADEP
            GOTO      PRHT1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OTARREFN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,PRHT1000
.
          MOVE      OTARPRSI,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OTARCLID
          IF        !@EQUAL
            PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OTARPRSI,OTARCLID,OTARRQDT,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,PRHT1100
.
              MATCH     OTARPRSI,OCASITE
              GOTO      PRHT1100 IF NOT EQUAL
.
              MATCH     OTARCLID,OCACLIN
              GOTO      PRHT1100 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
PRHT1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,OTARVIST
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OTARVIST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARVIST,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority
.
          MOVE      SP70,SPECDESC                      * Special Arrangements
          MATCH     SP70,OTARSARR
          IF        !@EQUAL
            PACK      KEY5,ANSS,ANSA,OTARSARR,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARSARR,TDESC
            ENDIF
            MOVE      TDESC,SPECDESC
          ENDIF
.
          MOVE      SP70,ACTNDATE                     * Action Date
.
          MOVE      SP70,STATDESC
          MATCH     "0",OTARSTAT
          IF        @EQUAL
            MOVE      "Requested",STATDESC
            MOVE      OTARCDAT,ACTNDATE
          ENDIF
.
          MATCH     "1",OTARSTAT
          IF        @EQUAL
            MOVE      "Pending Reschedule",STATDESC
            MOVE      OTARRQDT,ACTNDATE
          ENDIF
.
          MATCH     "2",OTARSTAT
          IF        @EQUAL
            MOVE      SP70,DISPDAT1
            UNPACK    OTARBKDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CLEAR     STATDESC
            APPEND    "Booked ",STATDESC
            APPEND    DISPDAT1,STATDESC
            APPEND    " at ",STATDESC
            APPEND    OTARCLTM,STATDESC
            RESET     STATDESC
          ENDIF
.
          MATCH     "3",OTARSTAT
          IF        @EQUAL
            MOVE      "Cancelled",STATDESC
          ENDIF
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OTARRQDT
          IF        !@EQUAL
            UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    OTARRQDT,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    OTARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARREFN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,TRIAGDES
          MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      PRHT5000 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PRHT5000
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      PRHT5000 IF NOT EQUAL
.
          MOVE      TDESC,TRIAGDES

PRHT5000  CLEAR     HTMLLNK2
          APPEND    "javascript:BookPatientHosp('",HTMLLNK2
          APPEND    OTARURNO,HTMLLNK2
          APPEND    OTARREFN,HTMLLNK2
          APPEND    OTARRQDT,HTMLLNK2
          APPEND    OTARRQTM,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    TRIAGDES,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MATCH     "3",OTARSTAT
          IF        @EQUAL
            CLEAR     HTMLLNK2
            APPEND    "javascript:UpdateRequest('",HTMLLNK2
            APPEND    OTARURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARREFN,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DISPDAT1,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    OTARRQTM,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",ALRERDAT,"#",":               * 1
                             "#"",SP1,"#",":                    * 2
                             "#"",CTYPDESC,"#",":               * 3
                             "#"",CLIDDESC,"#",":               * 4
                             "#"",VISTDESC,"#",":               * 5
                             "#"",PRTYDESC,"#",":               * 6
                             "#"",LISTDAYS,"#",":               * 7 
                             "#"",SPECDESC,"#",":               * 8 
                             "#"",STATDESC,"#",":               * 9 
                             "#"",HTMLLNK2,"#",":               * 10
                             "#"",OTARPRDT,"#",":               * 11
                             "#"",ACTNDATE,"#",":               * 12
                             "#"",OTARPCOM,"#");"               * 13
.
          GOTO      PRHT1000
.
PRHT9999  RETURN
.
.******************************************************************************
. Patient Level Suspended OP Appointments Table
.******************************************************************************
PSHT0000  COMPARE   ONE,SEARCHFL                      * Search button clicked
          GOTO      PSHT9999 IF NOT EQUAL
.
          COMPARE   "1",INCLSUSP                      * Include suspended OP
          GOTO      PSHT9999 IF NOT EQUAL             * appointments
.
          PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
PSHT1000  CALL      RDKBOKA3
          BRANCH    OVRCD,PSHT9999
.
          MATCH     URNUMBER,OBAURNO                  * Correct U/R
          GOTO      PSHT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTSITE
          IF        !@EQUAL
            MATCH     FILTSITE,OBASITE
            GOTO      PSHT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,OBACTYP
            GOTO      PSHT1000 IF NOT EQUAL
          ENDIF
.
          COMPARE   SIX,OBASTAT
          GOTO      PSHT1000 IF NOT EQUAL
.
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      PSHT1000 IF EQUAL
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     OBACLIN,FILTCLID
            GOTO      PSHT1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,PSHT1000
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,PSHT1000
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS               * Hospital
            GOTO      PSHT1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                     * Check for linked referral
          BRANCH    OVRCD,PSHT1050
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      PSHT1050 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                    * Read linked AH referral
          BRANCH    OVRCD,PSHT1050
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     ALREDEPT,FILTDEPT          * Linked referral department
            GOTO      PSHT1000 IF NOT EQUAL      * filter
          ENDIF
.
PSHT1050  MOVE      OBASITE,CHECKSIT
          CALL      COTFIL00                     * Check outpatient file prefix
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OBACTYP
          IF        !@EQUAL
            PACK      KEY12,OBASITE,OBACTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OBACTYP,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      SP70,CLIDDESC
          MATCH     SP70,OBACLIN
          IF        !@EQUAL
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1          * Read Clinic Record
              BRANCH    OVRCD,PSHT1100
.
              MATCH     OBASITE,OCASITE
              GOTO      PSHT1100 IF NOT EQUAL
.
              MATCH     OBACLIN,OCACLIN
              GOTO      PSHT1100 IF NOT EQUAL
            ENDIF
            MOVE      OCADESC,CLIDDESC
          ENDIF
.
PSHT1100  MOVE      SP70,VISTDESC                      * Requested Visit Type
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OBAVISIT,TDESC
            ENDIF
            MOVE      TDESC,VISTDESC
          ENDIF
.
          MOVE      SP70,PRTYDESC                      * Priority
.
          MOVE      SP70,SPECDESC                      * Special Arrangements
          MATCH     SP70,OTBBSPCA
          IF        !@EQUAL
            PACK      KEY5,ANSS,ANSA,OTBBSPCA,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTBBSPCA,TDESC
            ENDIF
            MOVE      TDESC,SPECDESC
          ENDIF
.
          MOVE      SP70,STATDESC
          MOVE      "Suspended",STATDESC
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OBADATE
          IF        !@EQUAL
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LISTDAYS
          DAYSEP    OBADATE,CURRDATE,LISTDAYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkPatient('",HTMLLINK
          APPEND    OBAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBAOUTNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:RescheduleAppt('",HTMLLNK2
          APPEND    OBAURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    OBAOUTNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    KEY28,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          MOVE      SP70,ACTNDATE
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD<>1
            CALL      CHKSUS00           * Get session suspension details
            IF        EXIT=1
              MOVE      OTMSEDAT,ACTNDATE
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",SP1,"#",":                    * 1
                             "#"",OBADATE,"#",":                * 2
                             "#"",CTYPDESC,"#",":               * 3
                             "#"",CLIDDESC,"#",":               * 4
                             "#"",VISTDESC,"#",":               * 5
                             "#"",PRTYDESC,"#",":               * 6
                             "#"",LISTDAYS,"#",":               * 7 
                             "#"",SPECDESC,"#",":               * 8 
                             "#"",STATDESC,"#",":               * 9 
                             "#"",HTMLLNK2,"#",":               * 10
                             "#"",SP1,"#",":                    * 11
                             "#"",ACTNDATE,"#",":               * 12
                             "#"",PMVXUDF1,"#");"               * 13
.
          GOTO      PSHT1000
.
PSHT9999  RETURN
.
.*******************************************************************************
. Activate a waiting master referral if the linked internal referral is active
. Requires CHECKREF - Internal Referral Number
.*******************************************************************************
AMAS0000  MATCH     "1",ALCNDAMR
          GOTO      AMAS9999 IF EQUAL
.
          PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Read the referral to see if it's
          BRANCH    OVRCD,AMAS9999          * an internal referral
.
          MATCH     "1",ALREUYN4            * Exit if not an internal referral
          GOTO      AMAS9999 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Exit if not active
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALREDACT,SAVIADAT       * Save internal referral date active
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          PACK      KEY16,CHECKREF,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,AMAS9999
.
          MATCH     CHECKREF,ALRLLNKV       * Linked referrals
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number

          PACK      KEY8,MASTREFN,SP70
          CALL      RDALREF1                * Read the master referral
          BRANCH    OVRCD,AMAS9999
.
          MATCH     "1",ALREUYN4            * Exit if not an master referral
          GOTO      AMAS9000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Exit if not waiting
          GOTO      AMAS9000 IF NOT EQUAL
.
          IF        RIAUDFLG = 0
            MOVE      TWO,AUDTTYPE          * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            MOVE      ONE,RIAUDFLG
          ENDIF
.
          MOVE      "1",ALRESTAT            * Set status to active
          MOVE      SAVIADAT,ALREDACT
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      ARMHI000                * Set MHINC indicator
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
.         Check if we need to write an after audit record
.
          IF        RIAUDFLG = 1
            MOVE      ALREVISN,VINAHREF     * save the master referral no.
          ENDIF
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
AMAS9000  PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Re read original referral
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
AMAS9999  RETURN
.
.*******************************************************************************
. Populate the first appointment booked field for SOP internal referrals
.*******************************************************************************
FAPD0000  MATCH     "1",ALREUYN4                 * Exit if master referral
          GOTO      FAPD9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1                      * Read department
          BRANCH    OVRCD,FAPD9999
.
.         MATCH     ANSO,TCINDC8                 * SOP referrals only
.         GOTO      FAPD9999 IF NOT EQUAL
.
          MATCH     SP70,ALREUDT8                * Exit if first appointment
          GOTO      FAPD9999 IF NOT EQUAL        * booked alredy populated
.
          IF        EPAUDFLG = 0
            MOVE      TWO,AUDTTYPE               * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            MOVE      ONE,EPAUDFLG
          ENDIF
.
          MOVE      OBADATE,ALREUDT8             * Set to booking date
.
          CALL      UPALREF1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      NINE,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
FAPD9999  RETURN
.
.*******************************************************************************
.                          Get Patient Instructions
.*******************************************************************************
GETINS00  PREP      COMFILBF,COMFILNB 
          MOVE      ZERO,OTXFLA2
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETINS10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETINS90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETINS80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETINS10
.
GETINS80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETINS90  MOVE      F3,OTXWEN2
          OPEN      COMFILBF,COMFILNB
GETINS99  RETURN
.
.*******************************************************************************
.                        Patient Instructions
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
PATINS00  MOVE      "013",KEY3
          PACK      KEY14,OBAOUTNO,KEY3,SP70
          CALL      RSVSCMT1
PATINS40  CALL      RKVSCMT1
          BRANCH    OVRCD,PATINS50          * end of file
          MOVE      OBAOUTNO,DIM8
          MATCH     VSCTVIST,DIM8           * same Admission Number?
          GOTO      PATINS50 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      PATINS50 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      PATINS40
.
.         now write the new comments back
.
PATINS50  MOVE      OBAOUTNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILBF,COMFILNB
          TRAPCLR   IO
          BRANCH    OVRCD,PATINS99
.
PATINS51  ADD       ONE,F3
          READ      COMFILBF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          IF        @EQUAL
            IF        F3>=OTXWEN2
              GOTO      PATINS99
            ELSE
              GOTO      PATINS51
            ENDIF
          ENDIF
.
          MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=OTXWEN2
            GOTO      PATINS99
          ENDIF
          GOTO      PATINS51
.
PATINS99  MOVE      ONE,OTXFLA2
          RETURN
.
.------------------------------------------------------------
. DISSD000 - Get Saved Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISSD000  MATCH     SP70,SAVDSPLC
          IF        !@EQUAL & !@EOS
            PACK      KEY9,SAVDSPLC,SP70
            CALL      RDDSMAS1
            IF        OVRCD=0
              WRITE     HTMLFILE;DSMADESC;
            ENDIF
          ENDIF
.
DISSD999  RETURN
+
.------------------------------------------------------------------------------
.         Output Mental Health Flag for the Selected Clinic (Type) Session
.         using SESSKEYS (similar to GETCTY00).
.------------------------------------------------------------------------------
GETMHF00  MATCH     SP70,SESSKEYS
          GOTO      GETMHF99 IF EQUAL
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GETMHF99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GETMHF99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GETMHF99
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GETMHF99
.
          MOVE      "CG",KEY2
          PACK      KEY5,KEY2,OCTGRP,SP70        * Clinic Group
          CALL      RDCODE1
          BRANCH    OVRCD,GETMHF90
.
          MATCH     "M",TCINDC4
          GOTO      GETMHF91 IF EQUAL
.
GETMHF90  WRITE     HTMLFILE;ZERO;     * Not a Mental Health Clinic
          GOTO      GETMHF99
.
GETMHF91  WRITE     HTMLFILE;ONE;      * Is a Mental Health Clinic
          GOTO      GETMHF99
.
GETMHF99  RETURN
+
.******************************************************************************
          INC       CLVISINT
          INC       CLVISIAU
          INC       CLPMSWX1
          INC       ACCDIAIO/INC
          INC       ALLRLNIO/INC
          INC       ALLDEPIO/INC
          INC       ALLQUEIO/INC
          INC       EMRICDIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       OUTARTIO/INC        * Appointment Action
          INC       OUTBOAIO/INC       * Bookings file A
          INC       OUTBB1IO/INC       * Bookings file B
          INC       OUTBOCIO/INC       * Bookings file C
          INC       OUTXSCIO/INC       * Extension File
          INC       OUTXWPIO/INC       * Extension File Comments
          INC       OUTCLIIO/INC       * Clinic Ids
          INC       OUTCANIO/INC       * Clinic Types
          INC       OUTCTYIO/INC       * Clinic Types
          INC       OUTDIAIO/INC       * Clinic Types
          INC       OUTDTRIO/INC       * DTR
          INC       OUTLPCIO/INC        * Clinic Types
          INC       OUTMA1IO/INC       * Session Master file
          INC       OUTMABIO/INC       * Session Master file
          INC       OUTSESIO/INC       * Clinic Open Sessions file
          INC       OUTSITIO/INC       * Site file
          INC       OUTPREIO/INC       * Outpatient Pre-attendance file
          INC       OUTRF1IO/INC       * Referral List
          INC       OUTHISIO/INC
          INC       OUTRAPIO/INC
          INC       OUTRSHIO/INC
          INC       OUTWMPIO/INC       * Template Mapping
          INC       OUTMSPIO/INC        * Session Master file
          INC       OUTTXSIO/INC       * Outpatients Extra Templates file
          INC       OUTSIPIO/INC       * Outpat Site Specific Categories file
.
          INC       NHIMASTM
          INC       NHIDCDIO/INC
          INC       NHIDMCIO/INC
          INC       NHIDNRIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NHIMCCIO/INC
          INC       NHIRELIO/INC
          INC       TMPALIIO/INC
.
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC
          INC       IBAPOSIO/INC
          INC       PATALRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC
          INC       PATEORIO/INC
          INC       PMSCTCIO/INC
          INC       PATFN1IO/INC
          INC       PATIN1IO/INC
          INC       PATIPEIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCLIO/INC
          INC       PMSMTIIO/INC
          INC       PMSQPTIO/INC
          INC       PMSTSPIO/INC
          INC       SCRMASIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATNIPIO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       RESLNKIO/INC
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
          INC       MRTMASIO/INC
          INC       MRTVISIO/INC
          INC       PMSPX2IO/INC            *** HPS Code Starts Here ***
          INC       IBALPCIO/INC        
          INC       IBALPCCD
          INC       VISINTIO/INC       
          INC       PMSVX1IO/INC       
          INC       PMSCURIO/INC       
          INC       PMSPAYIO/INC
          INC       VISIAUIO/INC      
          INC       VISCMTIO/INC            * Text comments file       *I-48413
          INC       OUTCMNIO/INC     
          INC       OUTCVTIO/INC
          INC       OUTDCOIO/INC            * OP direct comments
          INC       OUTDANIO/INC            * OP direct actions
          INC       OUTLETIO/INC
          INC       OUTLHIIO/INC
          INC       OUTPRCIO/INC
          INC       OUTRCMIO/INC
          INC       OUTSRVIO/INC            *** HPS Code Ends Here ***
          INC       EOCLNKIO/INC
          INC       PATWC1IO/INC
          INC       PATWVEIO/INC
          INC       PATWMAIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSAIDIO/INC
          INC       PMSEXTIO/INC
          INC       PMSUPGIO/INC
          INC       PMSUPOIO/INC
          INC       PMSHPGIO/INC
          INC       PMSHPOIO/INC
          INC       PMSWX1IO/INC
          INC       OUTBITIO/INC
          INC       OUTLKBIO/INC        * Outpat Linked bookings table         
          INC       OUTPHOIO/INC        * Outpat public holiday file           
          INC       OUTCCTIO/INC
.
          INC       CCIEX7IO/INC
.
          INC       BRHLCOMN
          INC       COUNTSLT
          INC       MRTVISCD
          INC       DGCLICUP
          INC       DGCLICOB
          INC       DGCLICOC                * DG O/P Cancel Appoint.   *I-90203
          INC       DGCLICON                * DG O/P New Appointment   *I-90203
          INC       DGCLII13
.
          INC       EXPPAYCD
          INC       PATDOCTM    * Template Fill-in for Doctors File
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PATMASTM    * Template Fill-in for Patient Master File
          INC       CLPMSPX2
          INC       CLPMSUPO
          INC       CLPMSUPG
          INC       CLPATVIS
          INC       PMSHPGTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       CLMRTMAS
          INC       CLPATMAS
          INC       CLPMSVX1
          INC       CLOUTHED
          INC       PMSVX1TM
          INC       OUTARTTM
          INC       OUTBOATM      
          INC       OUTRFLTM
          INC       CLOUTRFL
          INC       OUTDANTM
          INC       OUTSESTM
          INC       PATDOCCD    * Create Patient Name String
          INC       PATNAMCD    * Create Patient Name String
          INC       NAMSTRCD    * Create Name String
          INC       IBAWEBCD    * Standard WEB Functions
          INC       DAYOFWEK
          INC       WEBDATCD    
          INC       NZHISWIO
          INC       CALCAGE 
          INC       PATCLMTM
          INC       PATSNDX 
          INC       PATSNX2
          INC       PATGSRIO/INC
          INC       VALDIOPS
          INC       PATCANIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       OUTCPBIO/INC
          INC       PATECDIO/INC
          INC       OUTHEDIO/INC
          INC       HICBCNIO/INC
          INC       HICCITIO/INC
          INC       HICCLMIO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLOUTCAN
          INC       CLOUTPRC
          INC       CLOUTRSH
          INC       CLPMSPAY
          INC       CLVISPAY
          INC       CLPATRE1
          INC       OUTTXSTM
          INC       OUTXSCTM
          INC       CLOUTXSC
          INC       CLPMSQPX
          INC       GENANVIS
.
          INC       OUTPRCTM
          INC       OUTSIPTM
          INC       CLALLREF
          INC       ALLREFTM
          INC       PMIGTNID
          INC       PRFAINSR                * Default PRFA based on claim code
          INC       COMDEPIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATMESIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       PATHSPIO/INC
          INC       MRTLOCIO/INC
          INC       ALLREFIO/INC 
          INC       ALLENCIO/INC
          INC       ALLRITIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLPCTIO/INC
          INC       ALLDIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLCTMIO/INC
          INC       ALLLNKIO/INC
          INC       ALLSTSIO/INC
.
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
.
          INC       OUTCPCIO/INC          

          INC       PATNIDIO/INC
.
          INC       PRIITMIO/INC
          INC       PRITHDIO/INC
          INC       VISPAYIO/INC
          INC       TFILENAM
          INC       VINAHDEF

