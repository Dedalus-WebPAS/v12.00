.******************************************************************************
. Program        : OPRWEB06
.
. Function       : Theatre Procedure Server
.
. Modifications  : 
.-------------------------------------------------------------------------------
. V12.00.04 25/09/2025  Bella Turco    TSK 0956710
.           New remote script POTPRV00 - Get Patient Out of Theatre of Previous
.           Patient
. V12.00.03 23/09/2025  Thanh T        TSK 0937505
.           Added GTEXDS00, AUEXDS00 and CLEXDS00 for extended procedure
.           description
. V12.00.02 08/08/2025  Ebon Clements   TSK 0964891
.           Fixed wattx1af read for ASA score - WESE0000
. V12.00.01 19/05/2025  Ebon Clements   TSK 0955096
.           Alphanueric visit number changes
. V11.05.03 21.03.2025  DA Sarkies     Task 0955909
.           Opened wattx1af table
. V11.05.02 18.03.2025  DA Sarkies     Task 0955909
.           Updated the ESIS extract to add the ASAS code
. V11.05.01 29/11/2024  Thanh T        TSK 0939466
.           Added Distance in kms field
.-------------------------------------------------------------------------------
.  V11.04.14 10/10/2024 J.Tan           TSK 0952188
.            Fixed displaying Unused Consumption type of items
.  V11.04.13 23/09/2024 J.Tan           TSK 0950577
.            Recompiled for PATIPERH - Fixed Hold Invoice audit issue
.  V11.04.12 09/09/2024  Thanh T        TSK 0950692
.            Changed THSRDT00 to validate Anaesthetic time when Category OA
.            indicator 1 <> 5    
.  V11.04.11 26/07/2024  Peter Vela     Task 0949702
.            Recompiled for FHRDATCD
.  V11.04.10 27.06.2024  DA Sarkies     TSK 0948535
.            Recompiled for PATMSXTM
.  V11.04.09 28/05/2024  Thanh T        TSK 0923560
.            Changed FAVTAC20 to show alert message when the charge check box
.            is checked for misc charge group (FI) indicator 9 = 1
.  V11.04.08 27/05/2024  Thanh T        TSK 0923560
.            Changed SHWREC00 to disbaled/protected the charge checked box
.            when item type is Tray or equipment 
.  V11.04.07 25/05/2024  Thanh T        TSK 0923560
.            Changed PRFDSC10 to fix issue with charge checked box is disabled 
.  V11.04.06 09/05/2024  Thanh T        TSK 0923560
.            Recompiled as OPRCASTM changes
.  V11.04.05 17/04/2024  Bella Turco    TSK 0919569
.            Added new update type "Q" to update Theatre Item Quantity OPRMBS39
.  V11.04.04 02/04/2024  J.Tan          TSK 0919569
.            Mod to MBS Exploding charges
.  V11.04.03 04/03/2024  Thanh T        TSK 0923560
.            Added Hospital ID Changes.
.            Commented out unsued sections. DISPRF00, DISPTR00, SHWPAN00,
.            SHWDDA00, SHWSPT00. 
.            13/03/2024  J.Tan          TSK 0919335
.            Mod checking for HF history (set Service date - TSRVDATE)
.  V11.04.02 23/02/2024  Nikitha B      TSK 0941402
.            Changed width of Favourite Group & Sub-Group Heading from 20 to 15%
.            & Code width from 5 to 15% at FAVTAC00 to remove irregular columns
.  V11.04.01 19/12/2023  Ebon Clements  TSK 0937359
.            Fixed multi joint form type display - JTAB0000
.  V11.03.20 16/11/2023  J.Tan          TSK 0938426
.            Mod display Operating Surgeon (FNDSRG00) to check for OPCNCLSU
.  V11.03.19 16/11/2023  Nikitha B      TSK 0939998
.            Made OUTDESC length from 20 to 30 to avoid display truncated value.
.  V11.03.18 13/11/2023   J.Tan          TSK  0939447
.            Commented out entering items one day after discharged date
.  V11.03.17 01/11/2023  J.Tan          TSK 0938516
.            Mod posting items for Oncology usage to check for Booking/Adm.date
.  V11.03.16 31/08/2023  Peter Vela     TSK 0924401
.            Added validation for Case Abandoned around Surgical Start Time
.            Check in OPRMBS10
.  V11.03.15 04/08/2023  J.Tan          TSK 0929464
.            Mod Item for Oncology (TABONC00) to check for Invoiced items
.  V11.03.14 01/08/2023  Peter Vela     TSK 0927262
.            Recompiled for FHRDATCD
.            Added dxc-hc-hcp and dxc-hc-speciality extensions
.  V11.03.13 28/07/2023  Ebon Clements  TSK 0935527
.            Recompiled for OPRQUEFD - Theatre booking hospital
.  V11.03.12 21/06/2023  J.Tan          TSK 0934004
.            Recompiled for PATIPERH - checking Patient Hold invoice
.  V11.03.11 02/06/2023  Peter Vela         TSK 0927262
.            ClinicalAide FHIR api
.            Added Subject include FHRSUBIN functionality
.            Added Participant include FHRPARIN functionality
.            Added Location include FHRLOCIN functionality
.  V11.03.10 30/05/2023  Peter Vela         TSK 0927262
.            Increased FHRAPPID to DIM 26
.            30/05/2023  Davin          TSK 0933052
.            Added check for CodeFocus InvoiceOnHold reason (CUIP0000)
.  V11.03.09 17/05/2023  Ebon Clements      TSK 0932616
.            Recompiled for PMSPX2TM - Current IP
.  V11.03.08 04/04/2023  Bella Turco        TSK 0911166
.            Recompiled for PATIPERH - Hold Invoice Audit             
.  V11.03.07 21/03/2023  Ebon Clements      TSK 0909393
.            Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
.  V11.03.06 23/01/2023  Thanh T.           TSK 0919770
.            Changed OPRPRF00, PRFTAB00, PRFDSC00, SHWPRF00, SHWPAN00, SHWDDA00
.            to cater for adding Hospital field changes  
.  V11.03.05 10/01/2023 Bella Turco      TSK 0921957
.            Added NOMORE00 - Display "No more records" at end of list
.            Added PTCNNRTD - Displays number of rows set by parameter value
.  V11.03.04 09.01.2023 DA Sarkies       TSK 0922510  
.            CHanged branch endpoint in WRTMBS00 from 10 to 05
.  V11.03.03 13/12/2022 Thanh T          TSK 0909503  
.            Changed FAVTAC00. Added GFAVG000, CTMPFV00 and DTMPFV00 for
.            Charge favourite list with ascending description sorting order 
.  V11.03.02 13/12/2022 DA Sarkies       TSK 0919497
.            Recompiled for OPRARDTM
.  V11.03.01 15/11/2022 J.Tan  Task 0926814
.            Recompiled for OPTHCMPL - checking for Abandoned case
.  V11.02.15 09.01.2023 DA Sarkies       TSK 0922510  
.            CHanged branch endpoint in WRTMBS00 from 10 to 05
.  V11.02.11 09.11.2022  DA Sarkies     Task 0919497
.            Added new variable DLYRSNRC and to pass to recovery list. Added
.            function calls to Exit Recovery Time for oprweb0610002 & 4 to
.            check time difference if DLYRSNRC is 1  
.  V11.02.10 14.09.2022  DA Sarkies     Task 0909756
.            Changed size of table columns in FAVTAC00
.  V11.02.09 16.08.2022  Ebon Clements  Task 0904278
.            Added calculation of operaton duration after entry of recover 
.            details of RECOVDUR is yes - OPRREC10 - RECOVDUR - ROPMIN00
.  V11.02.08 21.07.2022  DA Sarkies     Task 0904278
.            Added CGI variables for additional provisional codes 4,5,6
.            Added goto to divert user if EAN is blank
.  V11.02.07 14/07/2022  Jill Parkinson Task 0921220
.            Changed MMBONC00 to use PMMITDAT in MMBDATE
.  V11.02.06 13/05/2022  J.Tan         TSK 0904080
.            Mod validate MBS items when Posting Prov.CMBS (VPRV0000)
.  V11.02.05 11.04.2022  DA Sarkies    TSK 0918655
.            Added ids to tags 
.  V11.02.04 01.04.2022  DA Sarkies    TSK 0918429
.            Fixed malformed code by changing MOVE to PACK and moving KEY36
.            to front
.  V11.02.03 28/03/2022  Thanh T.      TSK 0909503
.            Recompiled for PMSUFIFD changes
.  V11.02.02 09/03/2022  Thanh T.      TSK 0912820
.            Recompiled for CLOPRARD changes
.  V11.02.01 10/02/2022  Thanh T          TSK 0889899
.            Recompiled as WATTR1FD changes
.  V11.01.12 08/11/2021 J.Tan           TSK 0880410
.            Recompiled for PATIPERH - added Hospital and System
.  V11.01.11 03/09/2021  J.Tan         TSK 0907030
.            Mod to display 'Quantity must not be zero'
.  V11.01.10 22/07/2021  Thanh T.      TSK 0895165
.            Recompiled for OPRARDTM changes
.  V11.01.09 06/07/2021  J.Tan           TSK 0907030
.            Mod mininum input item quantity to 1 (not zero)
.  V11.01.08 30/06/2021  Peter Vela      TSK 0908430
.            Made new date validation subroutine for PRFDSC00 - VDAP0000
.            Commented out validations for date of pre-admission and current
.            date
.            29/06/2021  J.Tan           TSK 0901227
.            Mod MISC1810 to check for MBS items
.  V11.01.07 19/05/2021  Ebon Clements   TSK 0897794
.            Added a new tag to not display the edit icon on the requisition
.            list - PMSC2900, SHOWEDIT - REQTAC00
.  V11.01.06 11/05/2021  Ebon Clements  TSK 0902987
.            Update CDATE with CURRDATE - MAIN1000 and FAVTAC10
.  V11.01.05 27/04/2021  Thanh T        TSK 0895165
.            Recompiled for OPRARDFD changes
.  V11.01.04 25/03/2021  J.Tan           TSK 0902417
.            Mod FAVTAC00 - Added id= to hidden field for CrossBrowser
.            09/04/2021  DA Sarkies      TSK 0904924
.            Added <tr> tags to IMPL4000
.  V11.01.03 11/03/2021  Thanh T         TSK 0899715
.            Changed PMSC2800 to get the defaulted primary procedure
.            description when it is not passed in
.  V11.01.02 05/03/2021  Thanh T         TSK 0899715
.            Changed PMSC2800 to return the correct procedure description
.  V11.01.01 17/02/2021  J.Tan           TSK 0888639
.            Changed Counter OPRPMBFD PATMMBFD to DIM 3
.  V11.00.20 09/12/2020  Thanh T         TSK 0872840
.            Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
.  V11.00.19 19/11/2020  J.Tan           TSK 0895375
.            Mod PMSC1800 to get Primary procedure            
.  V11.00.18 22/10/2020  J.Tan           TSK 0898866
.            Recompiled for PATIPERH - on hold invoice
.  V11.00.17 30/09/2020  J.Tan          TSK 0897025
.            Fixed validating NZ items for Booked patients
.  V11.00.16 28/09/2020  Peter Vela     TSK 0894526
.            Added delete loop of OPRREQ records at OPRPRF10 
.  V11.00.15 23/09/2020  Peter Vela     TSK 0893202
.            Initialised arguments before calling PRFDSC00 in SHWPRF00
.            and SHWREQ00 
.            Fixed tempfile sorting order for SHWPRF00
.  V11.00.14 22/09/2020  J.Tan          TSK 0897025
.            Added routine to workout the NZ item charges
.  V11.00.13 15/09/2020  Tracey Nguyen  TSK 0893100
.            Added NOWARNFL functionality to display/not display a warning 
.            message in OPRICM17
.  V11.00.12 27/07/2020  Peter Vela     TSK 0893202
.            Added temp file sorting in SHWPRF00 (Cat OG Assoc No)
.            04/08/2020  J.Tan          TSK 0895207
.            Increased length of array for Requisitions Key
.  V11.00.11 16/07/2020  Ebon Clements  TSK 0889773
.            Added missing table sort item 20 for admitted visits 
.            on the recovery list - RECLST00 
.  V11.00.10 16/06/2020  Peter Vela     TSK 0871644
.            Added User Validation in PMSC2600
.            Added Favourite Group column in FAVTAC00
.  V11.00.09 18/05/2020  Peter Vela     TSK 0871644
.            Added validation for spaces in OPPRPREF in PRFTAB00
.            Do not display preferences with zero quantities in SHWPRF00
.            Validate for zero quantity preferences in OPRREQ61
.            Fixed quantity assignment in OPRPRF22
.            Added CHKGAS00
.            Changed CHRITMDS to DIM 90
.  V11.00.08 27/04/2020  Ebon Clements  TSK 0850105
.            Added procedure calls PMSCURTH - Theatre status in patient header
.  V11.00.07 23/04/2020  Ebon Clements  TSK 0850105
.            Recompiled for PATMASTM - Theatre status in patient header
.  V11.00.06 21/04/2020  Peter Vela     TSK 0889188
.            Fixed save variable functionality in UPDDAY00
.  V11.00.05 06/04/2020  Peter Vela     TSK 0889188
.            Added save variable functionality for time/date in
.            UPDDAY00 WOPTSM00 WOPTSR00
.  V11.00.04 27/03/2020  Peter Vela       TSK  0871644
.            Added display of Doctor and Anaesthetist Preferences in PRFTAB00
.            Added Specialty Tray Preference in PRFTAB00
.            Changed OPRREQ40 to print HTML report
.            Added Occupational Group validation in PMSC2600
.  V11.00.03 19/03/2020  Peter Vela     TSK 0889143
.            Recompiled for WATLETFD 
.  V11.00.02 11/03/2020  J.Tan          TSK 0838262
.            Added Effective from and to date to MBS Item file
.  V11.00.01 25/02/2020  J.Tan            TSK 0888639
.            Mod checking for maximum no of MBS items TITM0000 (patmmbsf)
.  V10.15.07 20/02/2020  J.Tan            TSK 0888639
.            Mod checking for maximum no of MBS items TITM0000
.  V10.15.06 18/02/2020  Peter Vela       TSK 0887882
.            Fixed CSRBTH00 to prevent duplicate ceasarian births for
.            different patients
.  V10.15.05 17/02/2020  Peter Vela       TSK 0871644
.            Fixed Print Requisition Report functionality
.            Recompiled for OPHTMREQ
.  V10.15.04 13/02/2020  Peter Vela       TSK 0871644
.            Added Print Requisition Report functionality
.            Fixed functionality for Preferences and Requisitions
.  V10.15.03 03/02/2020  Peter Vela       TSK 0871644
.            Added Charge User Group Favourites functionality
.  V10.15.02 07/01/2020  Peter Vela       TSK 0871644
.            Added Surgical Preferences functionality
.  V10.15.01 28/11/2019  Peter Vela       TSK 0871644
.            Recompiled for OPRREQFD
.  V10.14.06 09/08/2019  Ebon Clements    TSK 0879652
.            Added trap to operating surgeon update for double clicks - OPRDAY30
.  V10.14.05 28/03/2019  Peter Vela       TSK 0839663
.            Recompiled for OPRSESTM
.  V10.14.04 12/03/2019  Tracey Nguyen   TSK 0863060
.            Recompiled for PATVISTM - Added VISS6400 & VISS6500
.  V10.14.03 05/03/2019  Tracey Nguyen  Task 0869563
.            Added HTMLLNK7 and remote script REMOTE60/UPTIDP00 to update
.            Ready to Depart Time (oprardaf.opartidp) with the current time
.  V10.14.02 19/02/2019  Jill Parkinson Task 0870553
.            Added the close delete for all comment text areas in CLRPAR00 to
.            stop comments copying from one patient to the next
.  V10.14.01 04/02/2019  Ebon Clements    TSK 0869804
.            Changed provisional CMBS item array from 15 to 50 - PROVM[]
.  V10.13.08 30/01/2019  Ania P           TSK 0869095
.            Added output in PTHE0000 for Hospital Name
.  V10.13.07 17/12/2018  Davin            TSK 0862992
.            Added remote script to check for Referral Waiting List Links
.            (REMOTE50/CHKRWL00)
.  V10.13.06 01/11/2018  Ania P           TSK 0864721
.            Populate SUBSYSKY with SESSKEYS
.  V10.13.05 23/10/2018  Tracey Nguyen    TSK 0859743
.            Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
.  V10.13.04 27/09/2018  Ania P 
.            Added PROFL110
.  V10.13.03 19/09/2018  J.Tan        TSK 0863727
.            Added Restrictive Override code
.  V10.13.02 21/08/2017  J.Tan        TSK 0859742
.            Added ECLIPSE new fields from pmsmtiaf
.  V10.13.01 17/07/2018  Steve Armstrong  TSK 0851661
.            Removed reference to CLRCBD00 and changed to use
.            external routine CLOPRCBD instead.
.            12/07/2018  Ken Bell       TSK 0850101
.            Added New Visit Theatre Enquiry List
.  V10.12.20 04/06/2018  Richa Phogat   TSK 0850937
.            Added field 'PACAFLAG'
.            08/06/2018  J.Tan          TSK 0858102
.            Fixed USCHP111 - NOT to move UNIQUE to OPPMCNTR
.            12/06/2018  Jill Parkinson TSK 0858646
.            Moved naming of OPRFNAM1 to use tfilenam instead of opruse[PORT]
.  V10.12.19 08/06/2018  J.Tan          TSK 0851006
.            Recompiled for OPRSRGTM - removed changes for Cat Ti,Tj
.  V10.12.18 07/06/2018  J.Tan          TSK 0851006
.            Recompiled for OPRSRGTM - for Cat Ti,Tj
.  V10.12.17 01/06/2018  Ebon Clements  TSK 0858171
.            Recompiled for OPTHETAT
.  V10.12.16 18/05/2018  Thanh T.       TSK 0851528
.            Recompiled for PATVISTM changed
.  V10.12.15 10/05/2018  Peter Vela     TSK 0851006
.            Added Theatre Usage functionality
.  V10.12.14 04/05/2018  Peter Vela     TSK 0851006
.            Added stationery template functionality to OPRREC10 
.            30/05/2018  Richa Phogat   TSK 0843171
.            Added code to get OPDAPOWD in RECLST00, added FIRSTBOK
.  V10.12.13 27/03/2018  Ebon Clements  TSK 0843946
.            Branch on exit after WEBERR00 at ADDTMN00, UPDTMN00, USMBS000,
.            UPDDAY00, UPDTRN00, BCOD0000
.            Added warning array alert to WARN0000
.            Added warning array alert to next page 1 - RDIRWR00
.  V10.12.12 22/03/2018  J.Tan          TSK 0310703
.            Mod updating invoice pending for Public hospital
.  V10.12.11 20/03/2018  Peter Vela     TSK 0842991
.            Recompiled for OPRSESTM
.  V10.12.10 15/03/2018  Richa Phogat   TSK 0846618
.            Updated condition in MISC3000 to turn 'Chg Over Count' button red
.            when some value is entered on the page
.  V10.12.09 08/03/2018  Richa Phogat   TSK 0846618
.            Added code 'MISC3000' to save and display 'Dressing Type'
.            Added new parameter 'CNTDTAIL'
.  V10.12.08 28/02/2018  Ken Bell       TSK 0651092
.            Added Hospital Code to Recovery Close table for Multihospital 
.            client
.            01/03/2018  J.Tan          TSK 0851408
.            Increased the array of items to 999 instead of 100
.  V10.12.07 02/02/2018  Ebon Clements  TSK 0845295
.            Added eReferral functionality
.  V10.12.06 31/01/2018  Thanh Tieu     TSK 0851375
.            Recompiled as OPRCASTM changed
.  V10.12.05 23/01/2018  Tracey Nguyen  Task 0825792
.            Modified STAF0150/TDET1900/TDET4100 to read pmshcpaf if OPCNURSE=1
.            Note: Added STAF0151 to STAF01544 to fix long IF statements 
.  V10.12.04 22/01/2018  Thanh T.       TSK 0848472
.            Fixed the issue with Patient recovery list where the patient data
.            is not display correctly
.  V10.12.03 11/01/2018  Richa Phogat   Task 0844206
.            Removed 'Recovery' check from Tourniquet template when accessed
.            from Clinical Details template
.  V10.12.02 10/01/2018  J.Tan          TSK 0847295
.            Added OPCNDMBS - Disp.Items for selected Uniq ID on Input charges
.  V10.12.01 11/12/2017  J.Tan          Task 0844301
.            Added Extra MBS codes
.            20/12/2017  Jill Parkinson Task 0844982
.            Added move of wmurno to wteeurno in case ur has been merged
.-------------------------------------------------------------------------------
.  V10.11.16 27/11/2017  Thanh Tieu     Task 0821710
.            Recompiled as PATMASTM changed
.  V10.11.15 23.11.2017  J.Tan          TSK 0846231 
.            Mod to set OPPMREFN - Reference Number
.  V10.11.14 11.10.2017  B.G.Ackland    TSK 0835482 
.            Change FHIR Include for Appointment
.  V10.11.13 16/10/2017  Thanh T.       TSK 0846191
.            Recomplied for OPTHETAT
.  V10.11.12 13.10.2017  B.G.Ackland    TSK 0835482 
.            FHIR Output Expected Duration in munitesDuration Attribute of the Appointment
.  V10.11.11 10.10.2017  B.G.Ackland    TSK 0835482 
.            Change FHIR Output include FHROPRCD
.  V10.11.10 28.09.2017  B.G.Ackland    TSK 0835482 
.            Change FHIR Status Output to standards code set
.            Change FHIR Output Remove serviceCategory output
.            Change FHIR Output Fix various issues
.  V10.11.09 25/09/2017  Davin           TSK 0837479
.            Added new theatre audit type THADT021 - 'S14 message received'
.  V10.11.08 30/08/2017 J.Tan           TSK 0837479
.            Added Consumption type items
.  V10.11.07 28.08.2017  B.G.Ackland    TSK 0835482 
.            FHIR Output Change to Patient Reference ID to strip spaces
.            FHIR Change Extension Naming
.  V10.11.06 25/08/2017 J.Tan           TSK 0843725
.            Added tags for OPDADES4,OPDADES5,OPDADES6
.  V10.11.05 08/08/2017  J.Tan          TSK 0842740
.            Fixed OPCL6200 to get Attribute Value GETOVV00 instead of Coded fld
.  V10.11.04 07/08/2017  Peter Vela     TSK 0837660
.            Move ZERO to EXIT in OPRSRG20
.  V10.11.03 03/08/2017  Thanh T.       TSK 0821710
.            Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.  V10.11.02 24/07/2017  Don Nguyen     TSK 0320729
.            Modified TABONC00 to output Theatre MBS Item Date & Start/End Time
.            (GMBSDT00) and Linked Booking number.
.            14/07/2017 Peter Vela      TSK 0837660
.            Initialised OVRCD before the traps in INIT0000
.            14/07/2017 B.G.Ackland     TSK 0835482
.            Mods for FHIR
.  V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.            Audit Amission/outpatient visit comments. PATMISTM changed.
.-------------------------------------------------------------------------------
.  V10.10.10 04.07.2017 B.G.Ackland     TSK 0835482
.            FHIR API for Appointment Resource
.            04/07/2017 J.Tan           TSK 0840669
.            Added JMPHFLAG
.  V10.10.09 20/06/2017 J.Tan           TSK 0840669
.            Fixed displaying Update implant screen
.  V10.10.08 02/06/2017 Peter Vela      TSK 0837660
.            Added Jessie McPherson Theatre Enhancement
.  V10.10.07 16/05/2017 Nicole Torrisi  TSK 0838234
.            Fixed RECLST00 to correctly display/exclude exit patients
.  V10.10.06 28/04/2017 Peter Vela      TSK 0813019
.            Added Abandoned Cases to PTHE0000
.  V10.10.05 24/04/2017 Ania P          TSK 0813019
.            Corrected setting of status for Abandoned cases
.  V10.10.04 27/03/2017  Peter Vela       TSK 0835786
.            Converted read prev to read direct in IMPTBD00
.            to avoid P*K in oracle (oracle doesn't like read prev on a
.            duplicate index)
.  V10.10.03 17/03/2017  Peter Vela       TSK 0824042
.            Added Theatre Attributes functionality
.  V10.10.02 10/03/2017  J.Tan            TSK 0829089
.            Fixed adding theatre implant for Using barcode
.  V10.10.01 14/02/2017  J.Tan            TSK 0829089
.            Changed index on oprthiaf file
.            22/02/2017  Davin            TSK 0829089
.            Added tags for implant barcode search tables (IMPBAR00/IMPBRD00)
.  V10.08.16 12/10/2016  Ebon Clements    TSK 0318770
.            Added THADT020
.  V10.08.15 04/10/2016  J.Tan            TSK 0813931
.            Added (gm) to Baby birth weight 
.  V10.08.14 23/09/2016  J.Tan            TSK 0813931
.            Added Baby birth weight and Placenta delivevery time
.  V10.08.13 29/07/2016  Ebon Clements    TSK 0312728
.            Only test recovery review if patient in recovery - REVW0000
.  V10.08.12 20/07/2016  Ebon Clements    TSK 0312728
.            Fixed admitted patients filter on recovery list - RECLST00
.  V10.08.11 14/07/2016  Ebon Clements    TSK 0312728
.            Added title to sadfacelos image title - RECLST00
.  V10.08.10 11/07/2016  Peter Vela        TSK 0821439
.            Added OT out time to error message in OPRREC95
.  V10.08.09 08/07/2016  Jill Parkinson    TSK 0822002
.            Recompiled for PATMASTM
.  V10.08.08 23/06/2016  Ebon Clements    TSK 0312728
.            Added extra fields to recovery list display - RECLST00
.  V10.08.07 21/06/2016  Ebon Clements    TSK 0308881
.            Fixed close recovery title - RECCLS00
.  V10.08.06 07/06/2016  Ebon Clements    TSK 0308881
.            Further recovery closed functionality changes
.  V10.08.05 26/05/2016  Peter Vela       TSK 0321157
.            Added Theatre CheckList functionality
.  V10.08.04 23/05/2016  Ebon Clements    TSK 0308881
.            Added report 19 recovery closed functionality -  RECCLS00
.            25/05/2016  B.G.Ackland      TSK 0819523
.            Added Anaethetist Name to Patient Theatre List -  PTHE0000
.  V10.08.03 28/04/2016  Peter Vela       TSK 0323979
.            Moved call to UPMMB000 in UPDTMN30 
.  V10.08.02 11/04/2016  Steve Armstrong  TSK 0813931
.            Added OPCBPDTM to CLRCBD00
.  V10.08.01 31/03/2016  Steve Armstrong  TSK 0813931
.            Added OPCBBWGT to CLRCBD00
.-------------------------------------------------------------------------------
.  V10.07.06 26/02/2016  Peter Vela    CAR 0814175
.            Added reads to discharge tags in TDET0000
.            16/02/2016  J.Tan         CAR 0310703
.            Mods Public Hosp to check for tobe inv.amnt before write to patipen
.  V10.07.05 18/02/2016  Peter Vela     CAR 0823979
.            Added UPMMB000 in UPDTMN30 for svmp
.  V10.07.04 24/12/2015  Peter Vela     CAR 0808574
.            Created CCITE2CN form 2 counter for USIMB000 and USGIM000
.  V10.07.03 08/12/2015  Ebon Clements  CAR 324593 
.            Added clear of discharge file fields if not discharged - DAYPDT10
.  V10.07.02 30/10/2015  Don Nguyen     CAR 320394
.            Recompiled for changes to WATTX1FD/IO
.            29/10/2015  J.Tan          CAR 322738
.            Added tag checking for Billing comments
.  V10.07.01 15/10/2015  Ebon Clements  CAR 316638
.            Added cancelled/tranferred status display - PATSTS00
.  V10.06.13 15/09/2015  Peter Vela     CAR 315115
.            Added reads to admission and discharge tables in THSRDT00
.  V10.06.12 20/08/2015  Ania P         CAR 320802
.            Recompiled for OPRSRGTM
.  V10.06.11 13/08/2015  Don Nguyen     CAR 308621 
.            Recompiled for PATVISTM - Added VISS6100
.            11/08/2915  Ania P         CAR 319861
.            Recompile for ALLREFTM
.  V10.06.10 21/07/2015 Peter Vela      CAR 299386
.            Added Day Oncology Usage validation in OPRICM00
.  V10.06.09 06/07/2015 Peter Vela      CAR 316498
.            Added BKRXPOBD to Post Op Ward/Bed default in RECLST30
.  V10.06.08 24/06/2015  Don Nguyen     CAR 318454
.            Recompiled for OPRSESTM - Added OPSES078 in MOVSES00
.  V10.06.07 16/06/2015  Don Nguyen     CAR 299117
.            Moved audit type values 018 & 019 (TADTTYPE) to theatre visit level
.  V10.06.06 09/06/2015 Peter Vela      CAR 316511
.            Added call to CUIP0000 to USRAT000
.  V10.06.05 13/05/2015  Don Nguyen     CAR 299117
.            Added THADT018 & THADT019
.  V10.06.04 07/05/2015 J.Tan           CAR 312376
.            Added tag for checking Birth in Theatre
.  V10.06.03 22/04/2015 J.Tan           CAR 315167
.            Fixed checking for Unique number (patmmbsf.ptmmopid)in USIMB0000
.  V10.06.02 22/04/2015  Don Nguyen     CAR 299117
.            Modified OPRMBS34 - called OPTHCMPL and update OPDAACPD / OPDARICM.
.            Added OPTHCMPL and tag processing for CMBS2200 & CMBS2300.
.            20/04/2015 Sandra Barcham  CAR 315688
.            Change 005 Case Reorded to Case Sorted
.  V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.            Removed definition of PTCGDATE as PATCGPFD is no longer
.            in use.
.-------------------------------------------------------------------------------
.  V10.05.15 03/03/2015  J.Tan          CAR 313576
.            Added tag for PMVXMHOS for report 2
.  V10.05.14 26/02/2015  Ebon Clements  CAR 313396
.            Added branch on exit after call to CHKMBS00
.  V10.05.13 13/01/2014  Peter Vela     CAR 309100
.            Added OPAR0000 to PROFL120 
.            Added direct read of opraaeaf in OPRDAY00
.  V10.05.12 17/12/2014  Peter Vela     CAR 304784
.            Recompiled for WATDETTM
.  V10.05.11 12/12/2014  J.Tan          CAR 309912
.            Recompiled for AUTOATYP - Getting Primary MBS
.  V10.05.10 26/11/2014  Ebon Clements  CAR 307967
.            Check theatre date is prior to discharge date - DAYPDT10
.  V10.05.09 20/11/2014  Peter Vela     CAR 307594
.            Move USERID to OPDAWEBU before update to oprdetaf in UPDDAY00
.  V10.05.08 06/11/2014  Don Nguyen     CAR 304059
.            Recompiled for changes to OPRSESIO - added Default Team Completed
.            fields.
.  V10.05.07 27/10/2014  Ebon Clements  CAR 306505
.            Fixed status display of booked on theatre history list - PTHE0400
.  V10.05.06 16/10/2014  J.Tan          CAR 304284
.            Added Extra provisional MBS Codes
.  V10.05.05 04.09.2014  Ania P         CAR 298084
.            Recompiled for OPRSESTM
.  V10.05.04 19/08/2014 Jill Parkinson CAR 299980
.            Added output of AuditDetails for PTHE0000
.            Added OPTHETAT functionality to write audit details
.  V10.05.03 13/08/2014 Peter Vela     CAR 304860
.            Recompiled for PMSVX1TD
.  V10.05.02 04/08/2014  Peter Vela    CAR 302164
.            Added PMMIRBRS - Rebate Reason CAT Rr
.  V10.05.01 01/08/2014  Don Nguyen    CAR 250925
.            Added Report 18 (MAIN2800) - Caesarean Birth Details.
.            Modified REMOTE00 to include VALURN00.
.  V10.04.14 25/06/2014 Jill Parkinson CAR 273374
.            Added nodressg to links for RECLST00
.  V10.04.13 25/06/2014 Jill Parkinson CAR 273374
.            Added nodressg to links for RECLST00
.  V10.04.12 24/06/2014 Jill Parkinson CAR 273374
.            Fixed RECLST00 for sjog not collecting OPSGTIDR
.  V10.04.11 19/06/2014 Jill Parkinson CAR 273374
.            Added check for OPSRTISS in PATSTS00 to display 'Theatre'
.  V10.04.10 17/06/2014 Peter Vela     CAR 273374
.            Added tag for NODRESSG
.  V10.04.09 17/06/2014 Jill Parkinson CAR 273374 
.            Mods to allow templates 10 and 11 without all recovery times enterd
.  V10.04.08 30/05/2014 Jill Parkinson CAR 273374 
.            Added nodressg to allow sites to access recovery pages without
.            completing dressing time
.  V10.04.07 01/05/2014  J.Tan          CAR 261630
.            Removed PATAUM 
.  V10.04.06 01/05/2014  Don Nguyen     CAR 298409
.            Changed OPDEA014, OPDEA015, OPDEA016 to be 80 chars long
.  V10.04.05 07/04/2014  Peter Vela     CAR 286258
.            Recompiled for PATMASTM
.  V10.04.04 31.03.2014  B.G.Ackland    CAR 299363
.            Replace META Tag Redirect with Javascript in Common RDIREC00
.            Routine
.  V10.04.03 31/01/2014  J.Tan          CAR 285293
.            Mods to set PMMISUNQ - MBS Item Banding
.  V10.04.02 17/01/2014  J.Tan        CAR 295008
.            Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.            20/01/2014  J.Tan        CAR 249828
.            Added PMMIPMBS - Patient MBS Team and Counter
.  V10.04.01 31/12/2013  Don Nguyen     CAR 294389
.            Recompiled for changes to WATLETFD & WATLETIO
.-------------------------------------------------------------------------------
.  V10.03.32 04/10/2013  Patrick Adair  CAR 284134
.            Recompiled for new oprcliaf field
.  V10.03.31 02/10/2013  Peter Vela        CAR 291757
.            Recompiled for ALLREFTM
.  V10.03.30 10/09/2013  Steve Armstrong   CAR 291089
.            Recompiled for changes to PMSQVIIO
.  V10.03.29 28/08/2013  J.Tan             CAR 287941
.            Mods checking Hosp.type & zero item amt before writing to Pending
.  V10.03.28 08/08/2013  J.Tan             CAR 288416
.            Fixed to default MBS quantity to one
.  V10.03.27 06/08/2013  Patrick Adair  CAR 289877
.            Recompiled for OPRCASTM after eAdmission changes "disappeared"
.  V10.03.26 31/07/2013  Patrick Adair    CAR 289389
.            Recompiled for changes to OPRCASTM 
.  V10.03.25 18/07/2013  Steve Armstrong  CAR 268961
.            Recompiled for changes to PMSQVIFD.
.  V10.03.24 02/07/2013  Jill Parkinson    CAR 287600
.            Removed 'Billing might need to be adjusted', now in oprweb0605003
.  V10.03.23 02/07/2013  J.Tan           CAR 287600
.            Move zero to EXIT after adding Expensive item (OPRIEX10)
.  V10.03.22 01/07/2013  Jill Parkinson    CAR 287600
.            Added move one,exit after all weberr00 calls
.  V10.03.21 25/06/2013  J.Tan             CAR 287218
.            Fixed to default MBS quantity to one
.  V10.03.20 23/05/2013  Peter Vela        CAR 261630
.            Removed port number from temp file name
.  V10.03.19 08/05/2013  J.Tan             CAR 284289
.            Fixed PMMIAMTT to include quantity and Record status of patipen
.  V10.03.18 26/03/2013  Patrick Adair  CAR 281548
.            Recompiled for changes to CLBOKRC1
.  V10.03.17 21/03/2013  J.Tan          CAR 280847
.            Mods to save quantity to oppmserv
.  V10.03.16 19/03/2013  Jill Parkinson CAR 282814
.            Recompiled for PATMASTM - Disability alert DSAL0000 change
.  V10.03.15 11/01/2013  J.Tan          CAR 277735
.            Fixed checking Effective date of Misc.item
.  V10.03.14 10/12/2012  Nicole Torrisi   CAR 242527
.            Fixed calculation of surgery duration when overnight indicator
.            is checked, Surgery End Time is before midnight and Exit Theatre
.            Complex is after midnight
.  V10.03.13 26/10/2012  Peter Vela     CAR 266331
.            Added Recovery Time Day Proc validation @ OPRDAY10
.  V10.03.12 05/09/2012  J.Tan          CAR 267784
.            Mods to Check for TCINDC19 Claim Contract Eff.'Disc.From'
.  V10.03.11 14/08/2012 Jill Parkinson CAR 267531
.            Mods to write to oprtsmaf if no record in OPRDAY30
.  V10.03.10 03/07/2012  Don Nguyen         CAR 267531
.            Updated surgeon code for output in SESDET00.
.  V10.03.09 15/05/2012 J.Tan               CAR 255708
.            Mods checking for Hold Invoices From Date
.  V10.03.08 23/04/2012  Peter Vela       CAR 263418
.            Fixed clear theatre reason incomplete when theatre complete
.  V10.03.07 07/03/2012  Peter Vela       CAR 260294
.            Added OPCNCLSU validation to SURFNAME @ SESDET00
.  V10.03.06 02/03/2012  Peter Vela       CAR 260360
.            Added tags for BKREEDAT and BKREATIM @ MISC0000
.  V10.03.05 22/02/2012  Ebon Clements    CAR 233883
.            Fixed esis episode created/updated by field - WESE0000
.  V10.03.04 31/01/2012  Peter McMullen   CAR 249819
.            Fix corruption of 'correct count' OPSGCCNT
.  V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.            Recompiled for PATMASTM
.  V10.03.02 18/12/2011  Nicole Torrisi   CAR 246185
.            Added output of Admission Details (MISF0000) to report 12
.  V10.03.01 22/11/2011  J.Tan            CAR 255876
.            Mods Patient Implant Details to display invalid implant code
.  V10.02.12 04/11/2011  Steve Armstrong  CAR 254751
.            Recompiled for changes to OPRQUEFD
.  V10.02.11 27/10/2011  Steve Armstrong CAR 251323
.            Recompiled for PMSQVIFD changes
.  V10.02.10 25/10/2011  J.Tan            LANDESK 500738
.            Recompiled for CLOPRPIM - initialised OPPIDTRT
.  V10.02.09 11/10/2011  Mark Coupland    CAR 252429
.            Recompiled for PMSPX2TM and PATMASTM
.  V10.02.08 13/09/2011 Jill Parkinson  CAR 248652
.            Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
.  V10.02.07 19/08/2011 Saroeun Soeur     CAR 240675
.            added urnumber and admissno to HTML5 patient recovery list
.  V10.02.06 29/06/2011 Peter McMullen             240725
.            Re-compile for WATDETTM                             
.  V10.02.05 28/06/2011 J.Tan             LAN DESK 500633
.            Fixed total amount of Misc.item with quantity
.  V10.02.04 24/06/2011 Jill Parkinson    CAR 242253
.            Removed write to patmmbsf in STVMBS000 unless OPCNMREC=1
.  V10.02.03 22/06/2011 J.Tan             LAN DESK 500633
.            Fixed total amount of Misc.item with quantity
.  V10.02.02 15/06/2011 Saroeun Soeur     CAR 244565
.            fixed clear theatre reason incomplete when theatre complete
.  V10.02.01 27/05/2011  Saroeun Soeur CAR 238062
.            THEACOMP - added ELSE branch 
.  V10.01.03 13/01/2011  J.Tan         CAR 233048
.            Mods for PATTFEFD using H/F Table Type                      
.            15/12/2010  Mike Laming   CAR 233046
.            Mods for PATMCHFD using H/F Table Type (replacing H/F Table)
.  V10.01.02 08/12/2010 Sandra Barcham    CAR 235280
.            Remove sin tables
.            Added reason for hold update to invoice pending
.  V10.00.29 25/10/2010 J.Tan             CAR 232223
.            Mods for Exploding MBS items
.  V10.00.28 18/10/2010 Mike Laming       CAR 230028
.            Added "squeeze" to "SPPID000"
.  V10.00.27 18/10/2010 Mike Laming       CAR 230028
.            Rebound - move "SQUEEZE" to "STOPT000" (not savtid00 & savpid00)
.  V10.00.26 07/10/2010 Davin             CAR 214408
.            Added cgi stafflag to determine when to default staff on update of 
.            day procedures (based on whether anaesthetic time exists).
.  V10.00.25 05/10/2010 Peter Vela        CAR 231241
.            Added folder colours to RECLST00
.  V10.00.24 15/09/2010 Mike Laming       CAR 230028
.            Remove spaces from implant code when moving cgi to data (savtid00
.            and savpid00)
.  V10.00.23 03/09/2010 Mike Laming       CAR 224277
.            Add test Unique Id (OPDAUNIQ) in MBS Items (PTMMOPID) & change
.            MMSTIM & MMETIM test to check for change (not blank) at UPMMB010
.  V10.00.22 25/08/2010 J.Tan             CAR 228192
.            Mods not to add Service Number to the item description
.  V10.00.21 23/08/2010 J.Tan             CAR 228192
.            Fixed item description after changing the quantity of implant
.  V10.00.20 18/08/2010 J.Tan             CAR 222031
.            Mods to set PMMIDUPD and PMMITUPD
.            19/08/2010 J.Tan             CAR 228192
.            Mods to display input charges screen in table sort
.  V10.00.19 18/08/2010 Saroeun Soeur     CAR 218727
.            Recomplied for OPRAAETM
.  V10.00.18 18/08/2010 Peter Vela        CAR 228327
.            Added Recovery Time Front KEY9 only to RECLIST00
.            18/08/2010  Davin            CAR 223805
.            Recompiled for PATVISTM
.            18/08/2010 J.Tan             CAR 227257
.            Updating quantity of implant to chg quantity of item in pmsmtiaf
.  V10.00.17 17/08/2010 J.Tan             CAR 227257
.            Mods updating implant details to pmsmtiaf file
.  V10.00.16 17/08/2010 Davin S           CAR 216360
.            Recompiled for OPRCASTM
.  V10.00.15 16/08/2010 J.Tan             CAR 225155
.            Fixed displaying invoiced items - checking record type IITM0000
.  V10.00.14 16/08/2010 J.Tan             CAR 228192
.            Recompiled for AUTOATYP -to use MBS amount for getting most exp.itm
.  V10.00.13 09/08/2010  Saroeun Soeur  CAR 218727
.            set trapio on opraaeaf = AAEFLAG
.  V10.00.12 30/07/2010  Ebon Clements  CAR 226559
.            Added read of oprdetaf record for the theatre booking that
.            is in context at the end of EITM0000 and IITM0000
.  V10.00.11 29/07/2010  Saroeun Soeur  CAR 218727
.            OPRREC30,ADDOPR00 to store recovery adverse event details 
.  V10.00.10 29/06/2010  Peter Vela     CAR 215424
.            Added validation for Case Abandoned in OPRREC00 
.            Added validation for Case Abandoned in RECLST20
.  V10.00.09 30/06/2010  J.Tan          CAR 224883
.            Mods removing Implant to remove item charges as well
.  V10.00.08 23/06/2010  Peter Vela     CAR 216356
.            Added tags for ATIME DTIME PTCNADDF
.  V10.00.07 02/06/2010  J.Tan          CAR 219888
.            Mods deleting existing items for STV
.  V10.00.06 01/06/2010  Ebon Clements  CAR 222983
.            Added Implant Search By Description - IMPTBD00
.  V10.00.05 26/05/2010  J.Tan          CAR 222586
.            Fixed pmmirbat and pmmiamtp for multiple items
.            13/05/2010  J.Tan          CAR 219888
.            Mods for STV entering theatre MBS item
.  V10.00.04 30/04/2010 J.Tan         CAR 220887
.            Mods checking for Active/Inactive of Misc.charge
.  V10.00.03 29/04/2010  Mike Laming    CAR 207386
.            Added MMBS Start & End times to Items List at TABCMB00
.  V10.00.02 21/04/2010  J.Tan          CAR 180094
.            Added tag to display 'Patient Already Invoiced'
.  V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.            Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
.  V9.12.31  09/03/2010  J.Tan          CAR 217017
.            Recompiled for AUTOATYP - Mods to set PTTRAUAT (Auto update Admtyp)
.  V9.12.30  02/03/2010  Jill Parkinson CAR 207822
.            Mods to output ADATE in MISC0000
.  V9.12.29  26/02/2010  J.Tan          CAR 217017
.            Recompiled for AUTOATYP - Change record after Disc.
.  V9.12.28  23/02/2010  Mike Laming    CAR 207386
.            Clean up UPMMB000 - now includes restore of Arrival/Depart. record
.  V9.12.27  20/01/2010  Mike Laming    CAR 207386
.            Add Update MBS End Times (UPMMB000) to Day Recovery screen at 
.            OPRDAY10
.  V9.12.26  04/01/2010  Mike Laming    CAR 207386
.            Add new fields to "patmmbsf" for Theatre Unique No. & Team No.
.            Mods to update of MBS Theatre Items when Recovery Times change
.  V9.12.25  04/01/2010  Mike Laming    CAR 206410
.            Add "Start time" to "pmsmtiaf" for Theatre MBS Items at USRAT300
.  V9.12.24  11/12/2009  Ebon Clements  CAR 210196
.            Recompiled for OPRSESTM - Default start/end time for duration
.  V9.12.23  11/12/2009  Jill Parkinson  CAR 187587
.            Added GNEWS000
.  V9.12.22  07/12/2009  Saroeun Soeur   CAR 209738
.            added EXTTODAY cgi, OPRC1500 - Tag and check if cgi
.            value is 1 RECLST20
.  V9.12.21  07/12/2009  Peter McMullen  CAR 210130
.            replace call DOCNAM00 wwith DOCNM000 (paramter controlled version) 
.  V9.12.20  02/12/2009  Davin           CAR 187491
.            Added "recovery time - back" (opartirb) to Recovery List (reclst00)
.  V9.12.19  20/11/2009  J.Tan           CAR 210035
.            Fixed adding MBS to check for credit notes
.  V9.12.18  16/11/2009  Saroeun Soeur   CAR 208198
.            added Tag - CMBS1500 - quantity, CMBS1600 - amount
.  V9.12.17  11/11/2009  Jill Parkinson  CAR 207822
.            Mods for day oncology when using linked admission number
.  V9.12.16  05/11/2009  Ebon Clements   CAR 194191
.            Added recovery full functionality - RECF0000
.  V9.12.15  05/11/2009  Ebon Clements   CAR 207604                
.            Added call to RCVT0000 - determine time in recovery      
.  V9.12.14  30/10/2009  Ebon Clements   CAR 206487
.            Added update ready to depart functionality to RECLST00
.  V9.12.13  26/10/2009  J.Tan           CAR 206764
.            Recompiled for AUTOATYP - Suggested classification
.  V9.12.12  29/09/2009  Jill Parkinson  CAR 205241
.            Mods for day oncology to use bkreedat for pmmitdat
.  V9.12.11  22/09/2009  Saroeun Soeur   CAR 205761
.            changed RECLST00, removed V9.12.10 
.  V9.12.09  21/09/2009  Saroeun Soeur   CAR 205761
.            Added PatientFolder Icon to RECLST00
.  V9.12.08  10/09/2009  Jill Parkinson  CAR 205241
.            Changed WRREG000 to use aadmno instead of admissno
.            Changed TABONC00 to also output pmsmtiaf records for the linked adm
.  V9.12.07  01/09/2009  Jill Habasque   CAR 201966
.            Mods to move OPDADATE to MMDATE instead of ADATE
.  V9.12.06  20/08/2009  Jill Habasque   CAR 199583
.            Added output of bkreadat
.  V9.12.05  30/07/2009  Saroeun Soeur    CAR 201846
.            overnight indicator - OPRREC10 
.  V9.12.04  21/05/2009  Jill Habasque    CAR 195396
.            Added MMBONC00 - write to patmmbsf for oncology bookings
.  V9.12.03  18/05/2009  Ebon Clements    CAR 181799
.            Added session date/time and unique number to TABITM00
.  V9.12.02  14/05/2009  WeeLee  Koo      CAR 186034
.            Read doctor name under PTHE0011
.  V9.12.01  14/05/2009  Ebon Clements     CAR 196775
.            Added branch on exit after call to UPDTMN00 in OPRSRG40
.  V9.11.13  02/04/2009  J.Tan             CAR 188076
.            Added Reason Theatre Incomplete
.  V9.11.12  28/01/2009  J.Tan             CAR 168838
.            Recompiled for AUTOATYP - calculates daycase duration
.  V9.11.11  20/01/2009  Jill Habasque     CAR 187384
.            Mods to call WESE0000 if OPSGTISE is not blank in OPRDAY00
.  V9.11.10  13/01/2009  Ebon Clements     CAR 169339
.            Recompiled for OPRTSMFD - User defined Y/N 1
.  V9.11.09  15/12/2008  Steve Armstrong   CAR 184423
.            Mods to load PMMIODOC with OPDACLIN instead of spaces.
.  V9.11.08  12/12/2008  Ebon Clements     CAR 166942
.            Added recovery comments functionality. Added admission file
.            tags and read to recovery details
.  V9.11.07  12/12/2008  Steve Armstrong   CAR 181373
.            Recompiled for changes to PROSTRAK 
.  V9.11.06  20/11/2008  Steve Armstrong   CAR 181373
.            Recompiled for changes to PMSPTDFD, PROSTRAK & CLPMSPTD.
.  V9.11.05  14/11/2008  Davin            CAR 182311
.            Mods to confirm all cmbs items if 'theatre complete' checkbox is
.            ticked (cfrm0000)
.            Only send hl7 delete trigger if item being deleted is currently
.            'confirmed'
.            Mods to initialise pmmiccon to blank when writing to pmsmtiaf
.  V9.11.04  07/11/2008  Steve Armstrong  CAR 183001
.            Recompiled for changes to DGCLIITM.
.            06/11/2008  Peter McMullen CAR 174725
.            convert internal javascript to W3C standards
.  V9.11.03  26/10/2008  Peter Vela    CAR 179639
.            Added read to oprsesaf @ OPRMBS40
.  V9.11.02  23/10/2008  Peter Vela    CAR 181373
.            Added write to prosthetic tracking table @ input theatre charges
.  V9.11.01  09/10/2008  Peter Vela    CAR 158208
.            Added update to patmmbsf end times on submit of Recovery Details
.            Added warnings for blank Operation Start and End Times on submit
.            MBS codes.
.******************************************************************************
.  V9.10.06  03/09/2008  Davin         CAR 147323
.            Send hl7 message for upd bookings (added call DGCLIS14)
.  V9.10.05  22/08/2008  J.Tan         CAR 174667
.            Added Input GST code and Patient/Rebate portion
.            Added quantity to Misc.item description
.  V9.10.04  11/08/2008  J.Tan         CAR 164485
.            Mods Add Item for Oncology to default to Current/Disc.date
.  V9.10.03  02/07/2008  Jill Habasque CAR 172200
.            Added functionality to update opdaknow
.  V9.10.02  03/06/2008  Ebon Clements CAR 164485
.            Added regime display tags to day oncology usage
.            06/06/2008  J.Tan         CAR 164485
.            Added Option to Bill Prov.MBS Items
.  V9.10.01  02/06/2008  J.Tan         CAR 162259
.            Mods to input MBS and Misc.screen
.******************************************************************************
.  V9.09.15  02/04/2008  Ebon Clements CAR 164516
.            Recompiled for OPRSRGTM - populate OPSGUTHR
.  V9.09.14  19/02/2008 Jill Habasque CAR 157574 
.            Added write to bokunqaf
.  V9.09.13  13/02/2008  Ebon Clements CAR 161090
.            Added functionality to update oprardaf at OPRSRG20
.  V9.09.12  01/02/2008  Peter Vela    CAR 155334
.            Initialised new pmsmtiaf variable
.            Added functionality for Prosthetic Tracking Add Implant 
.            (Change and delete not included becuase pmsmtiaf is not accessed)
.  V9.09.11  30/01/2008  Ebon Clements CAR 160155
.            Added OPDEA020 to OPDEA028 posting functionality
.  V9.09.10  22/01/2008  Peter Vela    CAR 159607
.            Added OPDEA004 (Operation Type) posting functionality
.  V9.09.09  09/01/2007  Jill Habasque CAR 158306
.            Mods to update oppiuf01
.  V9.09.08  20/12/2007  Jill Habasque    CAR 126282 
.            Added update of updated date/time for oprdetaf
.  V9.09.07  14/12/2007  Steve Armstrong   CAR 155887
.            Added HL7 Trigger (DGCLIITM)
.  V9.09.06  04/12/2007  Jill Habasque CAR 153381
.            Added output of patient outcome table
.  V9.09.05  24/10/2007  Jill Habasque CAR 147719
.            Mods to allow staff details before patient is admitted
.            01/10/2007  Ebon Clements  CAR 150315
.            Added join registry functionality    
.  V9.09.04  19/09/2007  Jill Habasque  CAR 150318
.            Added PREVTIME procedure - check previous end time if required
.  V9.09.03  14/09/2007  Ebon Clements CAR 150226
.            Added PTCNUFFR - Using frame friendly
.  V9.09.02  20/07/2007  Ebon Clements  CAR 145544
.            Recompiled for OPRSESTM - display theatres with no hospital
.            Don't do multi hospital test on theatre list if act
.  V9.09.01  18/06/2007  J.Tan          CAR 143128
.            Recompiled for AUTOATYP - Using the suggested classification file
.******************************************************************************
.  V9.08.11  07/05/2007 Peter Vela CAR SJOG ED Billing
.            Initialised new pmsmtiaf variables
.  V9.08.10  17/05/2007  J.Tan          CAR 140864
.            Fixed session number for same admission but diff.uniq.number
.  V9.08.09  16/05/2007  J.Tan          CAR 140864
.            Fixed GST Applicable/Code for MBS item
.  V9.08.08  02/05/2007  Jill Habasque  CAR 125135
.            Added OPDEA006 to UPPROC00
.  V9.08.07  22/03/2007  Neelkamal Pyla CAR 116551
.            Added code to IMPROW00 to display Misc. Charge Code and Description
.  V9.08.06  28/02/2007  Jill Habasque CAR 120004
.            Added tag for first miscellaneous item
.  V9.08.05  26/02/2007  Peter Vela    CAR 126014
.            Recompiled for OPRCASTM
.  V9.08.04  22/02/2007  Jill Habasque  CAR 120004
.            Added RDIRFLAG - nz procedure redirect
.  V9.08.03  25/01/2007  Peter Vela CAR 127930
.            Recompiled for MRTMASFD
.  V9.08.02  04/12/2006  Peter Vela    CAR 126014
.            Recompiled for OPRCASTM - Added Unplanned Visit To Theatre
.                                    - Added tag for existing record in pmsvx1af
.  V9.08.01  02/10/2006  Ebon Clements CAR 119992
.            Added multi hospital test to theatre lists
.******************************************************************************
.  V9.07.02  19/09/2006  Mike Laming   CAR 111288
.            Move routine CLWATDET out of here into WATDETTM
.  V9.07.01  10/08/2006  Jill Habasque CAR 107342
.            Removed changes from V9.06.01                              
.            Fixed writing of removal reason (WTEERREM)                 
.******************************************************************************
.  V9.06.01  02/06/2006  Peter Vela    CAR 107342
.            Added direct read of to wateseaf using a blank sent date
.            in the index
.******************************************************************************
.  V9.05.01  09/03/2006  Ebon Clements CAR 78533
.            Mods for PATCODTM - Hospital specific category codes
.  V9.05.B05 14/02/2006  J.Tan         CAR 94947
.            Recompiled for AUTOATYP - not to update rate for force stepdown
.            prior operation date.
.  V9.05.B04 30/01/2006  Ebon Clements CAR 93186
.            Mods for REDIRECT length change. Recompiled for IBAWEBDF
.  V9.05.B03 20/12/2005  Peter Vela    CAR 89503
.            Added pack of SP70 to WROPPIM1 OPRPID12
.  V9.05.B02 16/12/2005  Peter Vela    CAR 88123
.            Added unique number for theatre history table PTHE0000
.******************************************************************************
.  V9.04.34  02/122005   Ebon Clements CAR 86280
.            Added read of correct oprdetaf record in ROPMIN00 after
.            recalculation of session actual op minutes
.  V9.04.33  29/11/2005  Ebon Clements CAR 86062
.            Set manually added record to no for esis episode file
.  V9.04.32  11/11/2005  Peter Vela    CAR 80156
.            Recompiled for OPRCASTM
.  V9.04.31  10/11/2005  Jill Habasque CAR 81717 
.            Added update and output of OPPIONUM and OPPIICOS
.  V9.04.30  10/11/2005  Jill Habasque CAR 83979 
.            Added move of ADATE to MMDATE before calling WESE0000 
.  V9.04.29  28/10/2005  Jill Habasque CAR 81654 
.            Added calls to WESE0000 when adding a team
.  V9.04.28  21/10/2005  Peter Vela    CAR 77536
.            Removed check for CUSEMBS in USMMB050
.            26/10/2005  Mike Laming   CAR 52354
.            Change all calls to WTRE0000 to WTDE0000 in line with changes to
.            include module WATDETTM - re-compile for WATDETTM
.  V9.04.27  19/10/2005  J.Tan         CAR 74278
.            Fixed generating MBS theatre fees
.  V9.04.26  05/09/2005  Ebon Clements CAR 73209
.            Recompiled for OPRSESTM - Session usage default times
.            01/09/2005 Peter Vela     CAR 71792
.            Fixed refresh of update implant coding
.            Fixed refresh of delete implant coding
.            03/08/05 J.Tan    CAR 62750             
.            Removed redefined amount variables      
.  V9.04.25  19/07/2005  J.Tan         CAR 67484
.            Fixed Updating MBS items
.  V9.04.24  07/07/2005  Mike Laming   CAR 58289
.            Add OPCNFTIM & OPCNTTIM controls for selecting Theatre start &
.            finish times at WRTMMB20 & USMMB400
.  V9.04.23  07/06/2005  Jill Habasque CAR 60165
.            Added clear of wteeardt
.  V9.04.22  01/04/2005  Ebon Clements CAR 58876
.            Fixed key on test for expensive items in PTHE0000               
.  V9.04.21  23/03/2005  Lina Vo       CAR 56404
.            Changed Preference to default checked for tray/item if same code
.            Changed wording for Requisition Table
.  V9.04.20  22/03/2005  Lina Vo       CAR 58853
.            Added Implant Search Dframe Tag
.  V9.04.19  18/03/2005  Guomin Fu     CAR 59532
.            Recompiled for OPRSESTM
.  V9.04.18  16/03/2005  Lina Vo       CAR 56404 
.            Recompiled for OPRSRGFD, TD & TM.
.  V9.04.17  10/03/2005  Lina Vo       CAR 56404 
.            Added Print option to Requistions
.  V9.04.16  10/03/2005  Jill Habasque CAR 58443
.            Added type 6 and 7 for torniquet
.  V9.04.15  03/03/2005  Jill Habasque CAR 58443
.            Added option for recovery list to use surgery end time
.            03/03/2005  Lina Vo CAR 56404
.            Added Report 13 - Preferences
.            Added Report 14 - Requistions
.            Recompiled for OPRITEFD & IO, OPRSRGFD, TD & TM.
.  V9.04.14  16/02/2005  J.Tan CAR 54754
.            Recomp.for AUTOATYP - updating trans records with new sugg.class
.            Mods input MBS to check for surgery start time (must not be blank)
.  V9.04.13  20/01/2005 J.Tan  CAR 56395
.            Added fields for 'No Charge' and 'Broken/Unused' to Input Exp.items
.  V9.04.12  18/01/2005 J.Tan  CAR 54679
.            Fixed charging a blank provisional mbs item
.  V9.04.11  29/11/2004 J.Tan  CAR 55293
.            Fixed charging prov mbs from add mbs screen
.  V9.04.10  11/01/2005 J Habasque CAR 56200
.            Added update of WTEERREM
.  V9.04.09  09/12/2004  Mike Laming  CAR 54343
.            Add Print Opr Registration Form to Day Procedure
.   V9.04.08 29/11/2004 J.Tan  CAR 55293
.            Added tag for charging prov mbs from add mbs screen
.   V9.04.07 23/11/2004 J.Tan  CAR 52385
.            Fixed warning for'Billing might need to be adjusted'
.   V9.04.06 09/11/2004 Peter Vela CAR 53371
.            Recompiled for PATVISTM
.   V9.04.05 14/10/2004 Lina Vo CAR 54267
.            Fixed Write of patmmbsf and oprpmbaf to read just
.            before writing
.            13/10/2004 Lina Vo CAR 54267    
.            Fixed Write and Update of oprtsmaf to have a read
.            with the proper key first.
.   V9.04.04 01/10/2004 Lina Vo CAR 53798    
.            Added Read of visit files in GURN0000 and added
.            Visit tags to report 7
.            Changed program to use PTHSDCLM instead of PTCNDCLM
.            for Implant Maintenance
.   V9.04.03 22/09/2004 Lina Vo CAR 53660    
.            Changed USMBS000 to use PTHSTFEE instead
.            of PTCNTFEE for Multi Hospital
.            24/09/2004 Lina Vo CAR 53751
.            Added OPSG0000 tags to report 12 
.   V9.04.02 27/08/2004 J.Tan   CAR 53038    
.            Fixed setting up quantity number for MBS items
.                  V9.04.01 18/08/2004  Lina Vo        CAR 52746
.                           Added open of pathspaf and included PATHSPFD & IO 
.                           for PATVISTM
.******************************************************************************
.                  V9.03.16 05/08/2004 Lina Vo    CAR 49016
.                           Fixed writing to Misc charge audit file (WRSAUDMX)
.                           to check audit parameter switched on first.
.                  V9.03.15 17/06/2004 Peter Vela CAR 49016
.                           2004 Stat Changes PRS/2
.                           Recompiled for PMSPX2TM
.                  V9.03.14 11/06/2004 J.Tan  CAR 50035
.                           Mods to set mechanical vent var from pmsmtiaf
.                  V9.03.13 07/06/2004  Sylvek Litewka CAR 37097
.                           Added new field oprthiaf.OPTISTAT (Implant Status)
.                           and CGI variable OPTHI010.
.                  V9.03.12 19/05/2004  Sylvek Litewka CAR 49988
.                           Modified OPRDAY00 to include update type of "B" -
.                           Bill MBS Items functionality.
.                  V9.03.11 15/04/2004  Jill/Guomin    CAR 48048
.                           Added CLSRED00 in NXTPAG00
.                  V9.03.10 26/03/2004 Peter Vela      CAR 13038
.                           Recompiled for PATDOCCD - Doctor Name format 
.                           Parameter
.                  V9.03.09 10/03/2004 Peter Vela      CAR 42126
.                           Used Operation date when Implant Coding write to
.                           patdtraf.
.                  V9.03.08 31/10/2003 Sylvek Litewka  CAR 44328
.                           Added code to populate new field patmmbaf.PTMMDESC
.                  V9.03.07 23/10/2003 Sylvek Litewka  CAR 44159
.                           Added procedures DFLTTM00 and SAVDFL00 to create 
.                           default team. Replaced calls to SAVSUR00 with 
.                           calls to DFLTTM00.
.                  ........ 22/10/2003  J.Tan CAR 44172
.                           Mods for Misc.Theatre item file (pmsmtiaf)
.                  V9.03.06 15/10/2003 Sylvek Litewka  CAR 43963
.                           Recompiled for changes made to 'OPRSESTM.PBL'.
.                  V9.03.05 01/09/2003 Lina Vo         CAR 40497
.                           Changed index and read of patmchgf.          
.                  V9.03.04 12/08/2003 Sylvek Litewka  CAR 41293
.                           Removed WEBSCHFD and WEBSCHIO. These are now 
.                           included in IBAWEBDF.PBL and IBAWEBCD.PBL.
.                  V9.03.03 05/08/2003 Sylvek Litewka  CAR 23803
.                           Added new procedures CHKOPM00,ROPMIN00 and ACTDUR00
.                           for calculation of Theatre Actual Operation Minutes.
.                  V9.03.02 30/07/2003 Jill Habasque CAR 41815
.                           Added linkprg,linkrep,linktem for theatre enquiry
.                  ........ 24/07/2003 CAR 41466    Peter Vela
.                           Recompiled for AUTOATYP
.                  ........ 26/06/2003 CAR 40412    Peter Vela
.                           Added new tag for implant mics charge reference
.                           number
.                  ........ 26/06/2003 Sylvek Litewka  CAR 38345/41805
.                           Added Report No 12 - Day Procedures. Modified 
.                           Patient Recovery List to include Surgery Type filter
.                           and "Expected Discharge Time" column. Modified
.                           procedure PTHE0000 to prefix patient status with 
.                           "RIP" for deceased patients.
.                  V9.03.01 22/05/2003 Ebon Clements SRF 39380
.                           Added new tag for implant mics charge code desc
.******************************************************************************
.                  V9.02.43  01/04/2004 Ebon Clements SRF 37754
.                           Changed UPCOM000 to not save blank comment lines
.                  V9.02.42 06/03/2003 J.Tan   SRF 37036
.                           Mods to clear staff members var.before write a rec.
.                  V9.02.41 19/02/2003 J.Tan 
.                           Recompiled for AUTOATYP
.                  V9.02.40 07/11/2002 Jill Habasque SRF 34262 
.                           Added uniqueky                                   
.                  V9.02.39 22/10/2002 Ebon Clements SRF 23319 
.                           Fixed staff type display when staff code is blank
.                  V9.02.38 03/10/2002 Peter Vela    SRF 17693
.                           Recompiled for PATVISTM - Admitting Point
.                  V9.02.37 23/09/2002 Ebon Clements SRF 22404
.                           Added TAG to OTDT0000 to display OPSGCCNT
.                  V9.02.36 19/09/2002 Ebon Clements SRF 22146
.                           Clear staff member vars before the default
.                           operating surgeon is written in UPDTMN10
.                           Clear the surgical details vars before the write
.                           of the surgical details record in UPDTMN10.
.                  V9.02.35 19/09/2002 Ebon Clements SRF 19995
.                           Fixed implant details display.
.                  V9.02.34 11/09/2002 J.Tan
.                           Mods to charge theatre fees 
.                  V9.02.33 19.08.2002 Ebon Clements SRF 20877
.                           Added update type E in OPRSRG00 to update the
.                           staff members end dates and times.
.                  V9.02.32 28.06.2002 Ebon Clements 19105  
.                           Recompiled for sigpipe trap
.                  V9.02.31 24.06.2002 Ebon Clements 18285  
.                           Fixed save and display of diathermy details. The
.                           correct variables are OPSGUC04 and OPSGUC05 not
.                           OPSGDCD1 and OPSGDCD2
.                  V9.02.30 21.06.2002 Ebon Clements 18285  
.                           Fixed save and display of skin prep details. The
.                           correct variable are OPSGUC01,OPSGUC02,OPSGUC03
.                           not OPSGICD1,OPSGICD2 and OPSGICD3
.                           22/06/2002 J.Tan
.                           Mods to write to patmmbs file
.                  V9.02.29 02.05.2002 Ebon Clements
.                           Pack key with correct cgi variables for update
.                           and delete of implants details.OPRPID00 
.                  V9.02.28 23.04.2002 Ashwin
.                           Remove recovery check for Implant Details
.                  V9.02.27 19/04/2002 J.Tan
.                           Recompiled for AUTOATYP
.                  V9.02.26 19.04.2002 Ebon Clements 
.                           Added open to IBAPDFA1
.                  V9.02.25 17.04.2002 Ebon Clements 
.                           Add functionality to print registration form
.                  V9.02.24 09.04.2002 Ashwin
.                           Add functionality for Supervisor Level
.                  V9.02.23 28.03.2002 Ashwin
.                           Validate if patient cancelled and Add functionality
.                           for Staff details
.                  V9.02.22 14.03.2002 Ashwin
.                           Fix Update Staff
.                  V9.02.21 04.03.2002 J.Tan  
.                           Mods not to use theatre fees for MBS items
.                  V9.02.20 28.02.2002 Ashwin
.                           Display Cancelled Sessions and Status
.                  V9.02.19 05.02.2002 Ashwin
.                           Add Tourniquet Notes,Display both ward/bed
.                  V9.02.18 31.01.2002 Ashwin
.                           Default Operating Surgeon category to OPCNSTCT
.                  V9.02.17 29.01.2002 Ashwin
.                           Fix Staff type,Default MBS while adding team,Update
.                           actual session end date
.                  V9.02.16 24.01.2002 Ashwin,Kuldeep
.                           Validate Tourniquet Time,Auto-Update Exit time
.                  V9.02.15 18/01/2002 J.Tan
.                           Recompiled for AUTOATYP
.                  V9.02.14 16.01.2002 Kuldeep/J.Tan 
.                           Mod for MBS Code 
.                           Ashwin
.                           Prep start time should be entered after anaesthetics
.                           Don't display cancelled session,Fix Ward/bed display
.                  V9.02.13 15.01.2002 Ashwin
.                           Mod for Auto update of team details,Add Operating
.                           Surgeon to Staff List
.                  V9.02.12 09.01.2002 Ashwin
.                           Fix recovery status,Post Ward/bed
.                  V9.02.11 03.01.2002 Ashwin
.                           Add Final Instrument Count,Auto update Exit Time
.                  V9.02.10 20.12.2001 Ashwin
.                           Check for patient in recovery,Display patient in
.                           recovery list when dressed,Add link for history
.                  V9.02.09 29.11.2001 J.Tan
.                           Mods for automatic update type of admission
.                  V9.02.08 29.11.2001 J.Tan
.                           Mods checking parameter for charging MBS
.                  V9.02.07 29.11.2001 J.Tan
.                           Mods for Implant,Expensive item and MBS item billing
.                  V9.02.06 27.11.2001 Ashwin,Raghu
.                           Correct Theatre History enquiry,Change for
.                           tourniquet lookup time
.                  V9.02.05 22.11.2001 Ashwin
.                           Change the sequence of display of current status
.                  V9.02.04 14.11.2001 Ashwin
.                           Add Recovery enquiry for patients
.                  V9.02.03 08.11.2001 Ashwin
.                           Change the Staff Member list to display Staff
.                           Category and swap prep soln with tourniquet table
.                  V9.02.02 13.10.2001 J.Tan
.                           Fixed reading miscellaneous charges
.                  V9.02.01 08.09.2001 Ashwin - HPS
.                           Changed for History status updation,
.                           Procedure description,MBS Coding
.******************************************************************************
.                  V9.01.04 20.08.2001 Ashwin - HPS
.                           Modified for Procedure Description.
.                  V9.01.03 17.08.2001 HPS -ODC
.                           Modified for Expensive item.
.                  V9.01.02 16.08.2001 J.Tan
.                            Recompiled for PATMASTM
.                  V9.01.01 14.08.2001 J.Tan
.                            Recompiled for PATMASTM
.                  V9.00.01 20/6/2001 HPS
.                                     Created Program
.******************************************************************************
.*                      Include Files                                          *
.******************************************************************************
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       FHRDATDF
          INC       RSHWEBDF
          INC       ALLCASFD/INC
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC
          INC       ALLWLNFD/INC
          INC       NZPSPRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       BOKDIAFD/INC
          INC       BOKUNQFD/INC
          INC       APSMASFD/INC            * Control file
          INC       IBALPCFD/INC
          INC       PATCFAFD/INC
          INC       PMSCIDFD/INC            * Contract ID file
          INC       PATCONFD/INC            * Control file
          INC       PATDDHFD/INC
          INC       PMSCHAFD/INC
.
          INC       PATDO1FD/INC            * patient doctor table
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATMA1FD/INC            * patient master
          INC       PATONLFD/INC            
          INC       PATONHFD/INC
          INC       PATICOFD/INC
          INC       PATVADFD/INC
          INC       PATDGWFD/INC
          INC       PATCMCFD/INC
          INC       PATDADFD/INC
          INC       PATASFFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATVISFD/INC            * patient visit table
.
          INC       PMSCCDFD/INC            * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSBRQFD/INC            * Misc.theatre item table
          INC       PMSMTIFD/INC            * Misc.theatre item table
          INC       PMSHCGFD/INC            * used in ALLREFTM.PBL
          INC       PMSHCPFD/INC            * HCP table
          INC       PMSHCGTD/INC            * used in ALLREFTM.PBL
          INC       PMSHCPTD/INC            * HCP table
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSVX1FD/INC            * visit extesion table
          INC       IBAGSTFD/INC
          INC       IBAPOLFD/INC
.
          INC       PATIN1FD/INC            * patient insurance table
          INC       PATCALAG/INC
          INC       PATMCHFD/INC            * Misc. Charges Table
          INC       PATALRFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PMSUFIFD/INC
          INC       PATMASTD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       PATDHEAD/INC
          INC       OBSPCOFD/INC            * Clinic Notes table
          INC       PMSVX1TD/INC
          INC       PATRE1FD/INC            * Person Responsible For Account
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATHSPFD/INC
          INC       PATIPEFD/INC
          INC       PATIKIFD/INC
          INC       PATNIDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSHCLFD/INC
          INC       PMSPTDFD/INC
          INC       PATMMBFD/INC
          INC       PATITMFD/INC            * Patient CMBS Item Table
          INC       PATSGCFD/INC
          INC       PATRGMFD/INC
          INC       PATTFEFD/INC
          INC       PMSADCFD/INC
          INC       PMSOCMFD/INC
          INC       PMSPODFD/INC
          INC       PMSREGFD/INC
          INC       PMSWX1FD/INC
          INC       PATECHFD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
.
          INC       BOKRX1TD/INC
          INC       OPR001FD/INC
          INC       OPRARDFD/INC
          INC       OPRARDTD/INC
          INC       OPRATRFD/INC
          INC       OPRATRTD/INC
          INC       OPRABIFD/INC
          INC       OPRABITD/INC
          INC       OPRCPIFD/INC
          INC       OPRCPITD/INC
          INC       OPRCBDFD/INC            * Caesarean Birth Details
          INC       OPRCLIFD/INC
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDEBFD/INC
          INC       OPRDECFD/INC
          INC       OPRDEDFD/INC
          INC       OPRADTFD/INC
          INC       OPRDPHFD/INC
          INC       OPRDPFFD/INC
          INC       OPRPCMFD/INC
          INC       OPREQPFD/INC
          INC       OPREXPFD/INC
          INC       OPRITEFD/INC
          INC       OPRJRRFD/INC
          INC       OPRJRRTD/INC
          INC       OPRNURFD/INC
          INC       OPROPRFD/INC
          INC       OPRPOCFD/INC
          INC       OPRPEIFD/INC
          INC       OPRCTYFD/INC
          INC       OPRPIMFD/INC
          INC       OPRMBSFD/INC
          INC       OPRPMBFD/INC
          INC       OPRPRFFD/INC
          INC       OPRPRFTD/INC
          INC       OPRRCIFD/INC
          INC       OPRRCITD/INC
          INC       OPRREQFD/INC
          INC       OPRREQTD/INC
          INC       OPRSESTD/INC
          INC       OPRSRGTD/INC
          INC       OPRSESFD/INC
          INC       OPRSDTFD/INC
          INC       OPRSDTTD/INC
          INC       OPRSRGFD/INC
          INC       OPRTHIFD/INC
          INC       OPRTPSFD/INC
          INC       OPRTRAFD/INC
          INC       OPRTRBFD/INC
          INC       OPRTQEFD/INC
          INC       OPRTSMFD/INC
          INC       WATLETFD/INC
.
          INC       OUTSITFD/INC
          INC       OUTCTYFD/INC
.
.         INC       SINCICFD/INC
          INC       WATMESFD/INC
          INC       WATOPAFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATESEFD/INC
.
          INC       OPRAAETD/INC
          INC       OPRAAEFD/INC
.
          INC       TFILEVAR/INC
          INC       PATMISTD/INC
.
ITMDESAF  FILE      ASCII,FIXED=300        * For Pre/By-Pass Reason
.
TMPREOR1  IFILE SQL, FIXED=205, KEY="U1-6,7-7,181-183"
TMPREOR2  IFILE SQL, FIXED=205, KEY="U190-192,1-6,7-7,181-183"
.
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TEMPASSC  DIM       6        6        1        Cat OG Assoc No.
TEMPTYPE  DIM       1        1        7        Requisition Type
TEMPKY36  DIM       36       36       8        Save Key 36
TEMPITEM  DIM       15       15       44       Preference
TEMPPDSC  DIM       90       90       59       Preference Description
TEMPKEY9  DIM       9        9        149      Requisition Type Description
TEMPTDSC  DIM       20       20       158      Cat OG Description
TEMPAMNT  DIM       3        3        178      Requisition Amount
TEMPCONT  DIM       3        3        181      Counter
TEMPDOCT  DIM       6        6        184      Doctor's Code
TEMPCLSS  DIM       3        3        190      Cat OG
TEMPUNIQ  DIM       10       10       193      Unique id for theatre booking
TEMPTEAM  DIM       1        1        203      Team number
TEMPVALD  DIM       1        1        204      Valid item (0=Yes)
.
.End of record                        205
.
TEMPCNTR  FORM      3
TEMPCNT1  FORM      3
TEMPCNTD  DIM       3
TEMPCND1  DIM       3
SAVETDSC  DIM       20
SAVETDS2  DIM       20
SAVEPMBS  DIM       4
.
SAVEASSC  DIM       6
SAVEASS2  DIM       6
.
TMPPRFR1  IFILE SQL, FIXED=73, KEY="U1-6,7-38,39-72"
.
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TEMPASS1  DIM       6        6        1        Cat OG Assoc No.
TEMPKY32  DIM       32       32       7        Save Key 32
TEMPKY34  DIM       34       34       39       Save Key 34
.
.End of record                        73
.
. Temporary File Definition ( User Group Favourite Charge Items)
. --------------------------------------------------------------
.
TMPFAVK1  IFILE SQL, FIXED=131, KEY="U14-16,1-3,17-19,23-25,41-120,26-34,4-13"
TMPFAVK2  IFILE SQL, FIXED=131, KEY="U14-16,17-19,23-25,41-120,26-34,4-13,1-3"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
TMUFUOGR  DIM       3      3        1     User Occupational Group (Cat w0)
TMUFUSER  DIM       10     10       4     Web User (websecaf) blank for all
TMUFHOSP  DIM       3      3        14    Hospital ID (pathspaf)
TMUFFAVG  DIM       3      3        17    Favourite Group (Cat w4)
TMUFFAVD  DIM       3      3        20    Default Favourite Group (Yes/No)
TMUFGHED  DIM       3      3        23    Group Heading (Cat w5)
TMUFCODE  DIM       9      9        26    Charge Code (patmchgf/nzpmchaf)
TMUFQUAN  DIM       6      6        35    Quantity
TMUFDESC  DIM       80     80       41    Charge Code Description (First 80)
TMUFDES1  DIM       10     10       121   Charge Code Description (Last 10)
.End of Record                      131
.
.******************************************************************************
.*                      CGI Parameters                                        *
.******************************************************************************
ALRMESFL  DIM       1 
ALRTTEXT  DIM       200
BKUNQ001  DIM       8    * bokunqaf admission number
ADMISNID  DIM       20
CNTDTAIL  DIM       1
CURRBCOD  DIM       60
CURRIMPL  DIM       15
CHCKRECO  DIM       1
CELCLASS  DIM       15
CHRITMDS  DIM       90
DTRNFLAG  FORM      1
DANS      DIM       3
DEFAINDC  DIM       1
DIM50     DIM       50
DISPDATE  DIM       11
DISPREAS  DIM       20
DISPLOCN  DIM       20
DURATIME  FORM      8
EREFRLID  DIM       20
F4A       FORM      4
F4B       FORM      4
FNAMEA    DIM       8
FNAMEB    DIM       8
FNAMEFAV  DIM       8
.
ITEMQNTY  FORM      5
JMPHFLAG  DIM       1
ADMITNRQ  FORM      1
FILTLOCN  DIM       3
HOSPCODE  DIM       3
PPACKITM  FORM      12.2
FPACKITM  FORM      12.2
PENDSDAT  DIM       8
PENDADAT  DIM       8
PENDDDAT  DIM       8
PENDFUND  DIM       6
PENDCLAM  DIM       3
PENDHOSP  DIM       3
PENDSYST  DIM       2
PRINTCLS  FORM      1
PRINTREG  FORM      1        * Print theatre registration form
MSHOSPID  DIM       3
MDATE000  DIM       8
INCTY000  DIM       1
PROCE000  DIM       9
PROCDESC  DIM       80
UNIQU000  DIM       3
MBSCONTR  DIM       6
MBSITEMN  FORM      3        * Increment no of MBS Items
MBSCOUNT  FORM      3
MBSDESC   DIM       40
MIN       DIM       2
MOTFNAME  DIM       20
NOWARNFL  DIM       1        * No warning message flag  
OPDAWARD  DIM       7
USERNAME  DIM       10
UPDATETY  DIM       1                       * Update Type
OLDUNIQ   DIM       10
SAVUNQID  DIM       10
SORTFLAG  FORM      1
.
SAVEANUR  DIM       6
SAVEADAT  DIM       8
SAVEATIM  DIM       8
SAVECLNO  FORM      3
.
SAVEGHED  DIM       3
.
SAVENUF1  DIM       6
SAVEDUF1  DIM       8
SAVETUF1  DIM       8
.
SAVENUF2  DIM       6
SAVEDUF2  DIM       8
SAVETUF2  DIM       8
.
SAVENUB1  DIM       6
SAVEDUB1  DIM       8
SAVETUB1  DIM       8
.
SAVENUB2  DIM       6
SAVEDUB2  DIM       8
SAVETUB2  DIM       8
.
SAVENUD1  DIM       6
SAVEDUD1  DIM       8
SAVETUD1  DIM       8
.
SAVENUD2  DIM       6
SAVEDUD2  DIM       8
SAVETUD2  DIM       8
.
SAVECDAT  DIM       8
SAVECTIM  DIM       8
SAVECUID  DIM       10
SAVEEDAT  DIM       8
SAVESCDE  DIM       6
SELCOCCG  DIM       3
SELCFAVG  DIM       3
SHOWADMT  FORM      1
SHOWEDIT  FORM      1
SUPRLEVL  DIM       1                       * Update Type
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
NODRESSG  DIM       1
STARTKEY  DIM       75                      * Starting Key
TSRVDATE  DIM       8
TADTTYPE  DIM       3
TRNSDATE  DIM       8
TFEEFLAG  FORM      1
TIMEDONE  FORM      1
TEAMNUMB  DIM       1                       * Team number
TIMEOUTD  DIM       3
SHOWPROV  DIM       1
THEACOMP  DIM       1
THERCOMP  DIM       3
LASTREGC  FORM      3
LINKEDFL  DIM       1
LNK2PRT   FORM      1                       
LOCATION  DIM       3
INVLDITM  FORM      1
IRECTYPE  DIM       1
INCLEXIT  FORM      1
TRANNUMB  DIM       6
ICOUNTER  FORM      2                       * Implant counter
REMOTENO  FORM      1
RECORDTY  DIM       1                       * Record Type
RECOVDUR  FORM      1                       * Recalculate OP duration 
RECOVFUL  DIM       1
EXPCHCNT  FORM      2                       * Exploding MBS charge counter
EXPEXCEL  FORM      1
EXTTODAY  DIM       1
RCOUNTER  DIM       2                       * Record Counter Dim Variable
CONTRCID  DIM       6
COUNT1    FORM      2                       * Record Counter      
COUNTM    FORM      3
CURRDATE  DIM       8
CURRTIME  DIM       8
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
PTMSX003  DIM       3
RLEGAPPL  DIM       8                       * Tourniquet right leg applied
RLEGREMV  DIM       8                       * Tourniquet right leg removed
LLEGAPPL  DIM       8                       * Tourniquet left leg applied
LLEGREMV  DIM       8                       * Tourniquet left leg removed
RARMAPPL  DIM       8                       * Tourniquet right arm applied
RARMREMV  DIM       8                       * Tourniquet right arm removed
LARMAPPL  DIM       8                       * Tourniquet left arm applied
LARMREMV  DIM       8                       * Tourniquet left arm removed
OTHRAPPL  DIM       8                       * Others applied
OTHRREMV  DIM       8                       * Others removed
CARTAPPL  DIM       8                       * Tourniquet carotid applied
CARTREMV  DIM       8                       * Tourniquet carotid removed
AORTAPPL  DIM       8                       * Tourniquet aorta applied
AORTREMV  DIM       8                       * Tourniquet aorta removed
OPTSM001  DIM       2                       * Staff type
OPTSM002  DIM       6                       * staff code
OPTSM003  DIM       8                       * start date
OPTSM004  DIM       8                       * start time
OPTSM005  DIM       8                       * end date
OPTSM006  DIM       8                       * end time
OPTSM007  DIM       3                       * supervisor level
OPTSM008  DIM       3                       * staff category code
OPTSM009  DIM       1                       * Final Instrument Count
OPTSM010  DIM       1                       * User defined Y/N 1
HOUR      DIM       2
HWDSOUR   DIM       1
ATYPDESC  DIM       25
BTYPDESC  DIM       25
CTYPDESC  DIM       25
AAEFLAG   FORM      1
FIRSTBOK  DIM       1
USERINDC  DIM       1
SAVEFAVG  DIM       3
.
. Caesarean Birth Details
.
OPCBD001  DIM       10                      * Theatre unique ID
OPCBD002  DIM       2                       * Count
OPCBD003  DIM       1                       * Baby Sex
OPCBD004  DIM       8                       * Date of Birth
OPCBD005  DIM       8                       * Time of Birth
OPCBD006  DIM       8                       * Baby U/R
OPCBD007  DIM       6                       * Birth Weight
OPCBD008  DIM       8                       * Placenta Delivery Time
HARDDELT  DIM       1                       * flag to indicate a hard delete
VALDCODE  DIM       70                      * Validation Code (remote scripting)
VALDBCOD  DIM       60
SAVBCODE  DIM       60
.
OPPIM001  DIM       15                      * Implant Code
OPPIM002  FORM      3                       * Quantity
OPPIM003  DIM       20                      * Lot/Serial Number
OPPIM004  DIM       10                      * Cost Code
OPPIM005  DIM       3
OPPIM006  DIM       2                       * Counter
OPPIM007  DIM       7                       * Order number
OPPIM008  DIM       15                      * Item cost
OPPIM009  DIM       6                       * Udf 1 (form field)
OPPIM010  DIM       60                      * Barcode
OPPIM011  DIM       1                       * udf 1 (y/n field)-oppiuy01
OPPIM012  DIM       3                       * udf cat oE (oppiuc01)
.
OPTHI001  DIM       15                      * Implant Code/EAN Number
OPTHI002  DIM       60                      * Implant Description
OPTHI003  DIM       3                       * Type Of Implant
OPTHI004  DIM       9                       * Misc. Charge Code
OPTHI005  DIM       60                      * Manufacture
OPTHI006  DIM       10                      * Size
OPTHI007  DIM       30                      * Supplier Name
OPTHI008  FORM      12.2                    * Cost
OPTHI009  DIM       10                      * Commonwealth Prosthetic Code
OPTHI010  DIM       1                       * Status (Active/Inactive)
OPTHI011  DIM       1                       * Prompt For Joint Registry Info
OPTHI012  DIM       60                      * Barcode
.
OPPMB001  DIM       9                       * MBS Item Code
OPPMB002  DIM       3                       * Counter
.
OPPEI001  DIM       6                       * Expensive items
OPPEI002  DIM       2                       * Counter
OPPEI003  FORM      8                       * Quantity
OPPEI004  FORM      1                       * No Charge
OPPEI005  FORM      1                       * Broken/Unused
.
OPTRQ001  DIM       1                       * Record Type
OPTRQ002  DIM       2                       * Counter
OPTRQ003  DIM       8                       * Applied Date
OPTRQ004  DIM       8                       * Applied Time
OPTRQ005  DIM       8                       * Removed Date
OPTRQ006  DIM       8                       * Removed Time
.
EXTIM001  DIM       8                       * Exit Time
EXTIM002  DIM       10                      * Unique Id
DATEFLAG  DIM       1
OPTQT001  DIM       10                      * Free Text Area for Tourniquet
OPTQT002  DIM       10                      * Free Text Area for Tourniquet 2
OPTQT003  DIM       10                      * Free Text Area for Tourniquet 3
OPTQT004  DIM       10                      * Free Text Area for Tourniquet 4
OPTQT005  DIM       10                      * Free Text Area for Tourniquet 5
TOURNTWK  DIM       10
.
HEALFUND  DIM       6                       * Health Fund
LINKREGF  DIM       2
CLAIMCOD  DIM       3
HEALFTAB  DIM       8
.
CHRGPMBS  FORM      1
CHARNUM   FORM      3
EXPITKEY  DIM       6[999]                  * Array of Expensive Item Codes
QUANTKEY  DIM       8[999]                  * Array of Expensive Item Quantity
NOCHARGE  FORM      1[999]                  * Array of No Charge
BROKENIT  FORM      1[999]                  * Array of Broken/Unused
MBSCD     DIM       9[999]                  * Array of CMBS Item Codes
MBSQN     FORM      4[999]                  * Array of CMBS Quantity
COUNT     DIM       2[999]                  * Counter
DIM2A     DIM       2
DIM2B     DIM       2
DIM8      DIM       8
DIM10     DIM       10
DIM15     DIM       15
DIM18A    DIM       18
DIM23     DIM       23
DIM32     DIM       32
DIM70     DIM       70
DIM90     DIM       90
DIM100    DIM       100
DIM256    DIM       256
FORM4D    FORM      4
FORM42    FORM      4.2
FORM6     FORM      6
FORM10    FORM      10
FORMTIDP  FORM      6           * Ready to Depart time form     *T0869563
FORMTIRF  FORM      6           * Time into recovery form       *T0869563
FORMTETC  FORM      6           * Exit Recovery time form       *T0869563
HL7ITMFL  DIM       1
CEFFDATE  DIM       8
CLINCODE  DIM       6
ANAFNAME  DIM       50
NMPNUMB   DIM       20
SURFNAME  DIM       50
CODEST    INIT      "ST"
STYPDES   DIM       25
SESSDATE  DIM       10
BOOKDATE  FORM      8
MBSCNT    FORM      3
NOOFDAYS  FORM      3
OPDUNQID  DIM       35                      * Unique id 
OPDUNQFF  DIM       89
OUTDESC   DIM       30
ONCOLOGY  FORM      1
KEY29A    DIM       29
KEY89A    DIM       89
STATNCOD  DIM       6       * Stationery Code
SETDEFPN  DIM       10
LABELTYP  DIM       11
PACAFLAG  DIM       4       * Menuflag
.
ITEMTYPE  DIM       1
ITEMN     DIM       9[999]
GSTAP     FORM      1[999]
GSTCD     DIM       6[999]
DESCP     DIM       30[999]    
QUNTY     FORM     4[999]
CAMNT     FORM      10.2[999]  
PATPR     FORM      12.2[999]  
REBPR     FORM      12.2[999]
CONSM     DIM       1[999]
RDTIM001  DIM       8                       * Ready to depart time
RDTIM002  DIM       10                      * Unique Id
PTGTU001  DIM       1
PTGTU002  DIM       6
.
ADDREQDT  DIM       28[999]    * Array of Add Requistion details         
PREFTKEY  DIM       33[999]    * Array of Preference keys         
PREFTQTY  FORM      3[999]     * Array of Preference quantity
PREFTFLG  FORM      1[999]     * Array of Preference Flag 1=Add/Update 0=Delete
CHECKPRF  FORM      1          * Make field checked 0=No 1=Yes
NOPRFFLG  FORM      1          * No previous preference 0=None 1=Pref Found
NUMDOCPR  FORM      3
.
. Variables Required for OPRCASTM
.
OPCOMFIL  FILE      ASCII,FIXED=128
OPCOMFNM  DIM       8 
OPCOMLIN  DIM       70
OPCOMTYP  DIM       3
OPCOMCNT  FORM      3
.
XPCOMFIL  FILE      ASCII,FIXED=128
XPCOMFNM  DIM       8
XPCOMLIN  DIM       70
XPCOMTYP  DIM       3
XPCOMCNT  FORM      3
XDATTIME  DIM       14                      * Date/Time (ccyymmddhhmmss)
.
YPCOMFIL  FILE      ASCII,FIXED=128
YPCOMFNM  DIM       8
YPCOMLIN  DIM       70
YPCOMTYP  DIM       3
YPCOMCNT  FORM      3
.
ZPCOMFIL  FILE      ASCII,FIXED=128
ZPCOMFNM  DIM       8
ZPCOMLIN  DIM       70
ZPCOMTYP  DIM       3
ZPCOMCNT  FORM      3
.
EXPCMTFI  FILE      ASCII,FIXED=128
EXPCMTNM  DIM       8
EXPCMTFL  FORM      1
.
WORKDATE  DATE      8
WORKTIME  DIM       8
.
WPCOMFIL  FILE      ASCII,FIXED=128
WPCOMFNM  DIM       8
WPCOMLIN  DIM       70
WPCOMTYP  DIM       3
WPCOMCNT  FORM      3
.
OPDEA001  DIM       5                       * Expected Start Time
OPDEA002  DIM       10                      * Expected Duration (min)
OPDEA003  DIM       3                      *  Anaesthetic Code (Cat. OA )
OPDEA004  DIM       3                       * Operation Type   (Cat. OY )
OPDEA005  DIM       3                       * Transport Code   (Cat. OR )
OPDEA006  DIM       3                       * User Defined 1 (Category Y6)
OPDEA007  DIM       3                       * 2 (Category Y7)
OPDEA008  DIM       3                       * 3 (Category Y8)
OPDEA009  DIM       3                       * 4 (Category Y9)
OPDEA010  DIM       1                       * Waiting Lists (Y/N)
OPDEA011  DIM       9                       * Provisional item # 1 ( MBS or
OPDEA012  DIM       9                       * Provisional item # 2 ( MBS or
OPDEA013  DIM       9                       * Provisional item # 3 ( MBS or
OPDEA014  DIM       80                      * Operation description line 1
OPDEA015  DIM       80                      * Operation description line 2
OPDEA016  DIM       80                      * Operation description line 3
OPDEA017  DIM       40                      * Comments
OPDEA018  DIM       3                       * Cancellation Code (Category SC)
OPDEA019  DIM       6                       * Operating Room Code
OPDEA020  DIM       5                       * Pre-operative time 1 (HH:MM)
OPDEA021  DIM       5                       * Pre-operative time 2 (HH:MM)
OPDEA022  DIM       5                       * Pre-operative time 3 (HH:MM)
OPDEA023  DIM       5                       * Pre-operative time 4 (HH:MM)
OPDEA024  DIM       5                       * Pre-operative time 5 (HH:MM)
OPDEA025  DIM       5                       * Post-operative time 1 (HH:MM)
OPDEA026  DIM       5                       * Post-operative time 2 (HH:MM)
OPDEA027  DIM       5                       * Post-operative time 3 (HH:MM)
OPDEA028  DIM       5                       * Post-operative time 3 (HH:MM)
OPDEA029  DIM       10                      * Actual duration in theatre (mins)
OPDEA030  DIM       3                       * Known Infection (Category OK)
OPDEA031  DIM       8                       * Cancellation Date
OPDEA032  DIM       3                       * Equipment Required 1(Category XE)
OPDEA033  DIM       3                       * Equipment Required 2(Category XE)
OPDEA034  DIM       3                       * Loan Equip. Required(Category XO)
OPDEA043  DIM       1                       * Prosthetic Items Complete
OPDEA044  DIM       80                      * Operation description line 4
OPDEA045  DIM       80                      * Operation description line 5
OPDEA046  DIM       80                      * Operation description line 6
OPDEA049  DIM       9                       * Provisional Item #4
OPDEA050  DIM       9                       * Provisional Item #5
OPDEA051  DIM       9                       * Provisional Item #6
.
UPDOPATR  DIM       1
UPDOPATI  DIM       1
UPDOPCPI  DIM       1
UPDOPABI  DIM       1
UPDOPSDT  DIM       1
.
WATER001  DIM       1
WATER002  DIM       1
WATER003  DIM       6
.
SALIN001  DIM       1
SALIN002  DIM       1
SALIN003  DIM       6
.
HAART001  DIM       1
HAART002  DIM       1
HAART003  DIM       6
.
GLYCI001  DIM       1
GLYCI002  DIM       1
GLYCI003  DIM       6
.
RINGR001  DIM       1
RINGR002  DIM       1
RINGR003  DIM       6
.
OTHER001  DIM       80
OTHER002  DIM       1
OTHER003  DIM       6
.
.
DIATH001  DIM       1
DIATH002  DIM       1
DIATH003  DIM       80
DIATH004  DIM       80
.
WOUND001  DIM       1
WOUND002  DIM       1
WOUND003  DIM       1
WOUND004  DIM       1
WOUND005  DIM       1
.
SKINI001  DIM       3
SKINI002  DIM       3
SKINI003  DIM       1
SKINI004  DIM       1
SKINI005  DIM       1
.
PATPO001  DIM       1
PATPO002  DIM       1
PATPO003  DIM       1
PATPO004  DIM       1
PATPO005  DIM       1
PATPO006  DIM       80
.
POSDE001  DIM       1
POSDE002  DIM       1
POSDE003  DIM       1
POSDE004  DIM       1
POSDE005  DIM       1
POSDE006  DIM       1
POSDE007  DIM       1
POSDE008  DIM       1
POSDE009  DIM       1
.
ARMBO001  DIM       1
ARMBO002  DIM       1
ARMBO003  DIM       1
ARMBO004  DIM       1
ARMBO005  DIM       1
ARMBO006  DIM       1
ARMBO007  DIM       1
ARMBO008  DIM       1
.
PRESR001  DIM       1
PRESR002  DIM       1
PRESR003  DIM       1
PRESR004  DIM       1
PRESR005  DIM       1
PRESR006  DIM       1
.
SKINP001  DIM       1
SKINP002  DIM       1
SKINP003  DIM       1
SKINP004  DIM       1
SKINP005  DIM       1
SKINP006  DIM       80
.
HAIRR001  DIM       1
HAIRR002  DIM       1
HAIRR003  DIM       1
HAIRR004  DIM       80
.
OTHRC001  DIM       80
.
SPECI001  DIM       6
SPECI002  DIM       80
SPECI003  DIM       80
SPECI004  DIM       80
SPECI005  DIM       80
.
DRAIN001  DIM       80
DRAIN002  DIM       80
DRAIN003  DIM       80
DRAIN004  DIM       80
DRAIN005  DIM       6
DRAIN006  DIM       6
DRAIN007  DIM       6
.
CATHT001  DIM       3
CATHT002  DIM       3
CATHT003  DIM       3
CATHT004  DIM       3
CATHT005  DIM       3
CATHT006  DIM       80
CATHT007  DIM       6
CATHT008  DIM       6
CATHT009  DIM       6
.
IRRIG001  DIM       80
IRRIG002  DIM       80
IRRIG003  DIM       80
IRRIG004  DIM       80
IRRIG005  DIM       80
IRRIG006  DIM       6
IRRIG007  DIM       6
IRRIG008  DIM       6
IRRIG009  DIM       6
IRRIG010  DIM       6
.
DRESN001  DIM       80
DRSSNIND  DIM       1
.
COUNC001  DIM       1
COUNC002  DIM       1
COUNC003  DIM       1
COUNC004  DIM       1
COUNC005  DIM       80
COUNC006  DIM       80
COUNC007  DIM       6
COUNC008  DIM       6
.
.
CASEKEYS  DIM       26
NEWSESSI  DIM       23
SAVKEY10  DIM       10
SAVKEY22  DIM       22
SAVKEY31  DIM       31
SVKEY36B  DIM       36
SAVKEY37  DIM       37
SAVKEY76  DIM       76
SAVFDATE  DIM       8
SAVLDATE  DIM       8
SESSKEYS  DIM       22
.
SAVEUOGR  DIM       3
SAVEHOSP  DIM       3
.
PATTITLE  DIM       4       * Title
PATSNAME  DIM       20      * Surname
PATGNAME  DIM       25      * Given Name
PATADDR1  DIM       25      * Address Line 1
PATADDR2  DIM       25      * Address Line 2
PATADDR3  DIM       15      * Address Line 3
PATPOSTC  DIM       4       * Post Code
PATBUSPH  DIM       12      * Phone Business
PATHOMPH  DIM       12      * Phone Private
PATGENDE  DIM       1       * Gender M or F
PATMSTAT  DIM       3       * Marital Status
PATBIRDT  DIM       11      * Date of Birth DD MMM YYYY
PATCOBIR  DIM       3       * Country of Birth
PATRELIG  DIM       3       * Religon
PATRSTAT  DIM       3       * Resident Status
PATOCCUP  DIM       14      * Occupation
PATMEDIC  DIM       10      * Medicare Number
PATPENSI  DIM       15      * Pension Number
PATPENEX  DIM       4       * Pension Expiry
PATHFUND  DIM       6       * Health Fund
PATPAYOR  DIM       9       * Payor (Health Fund 6, Claim Code 3)
PATADMDT  DIM       11      * Date of Admission DD MMM YYYY
PATCLAIM  DIM       3       * Claim Code
.
PROVM     DIM       19[50]    * Unique ID + Prov.CMBS item
.
REGCOMPR  INIT      "REGFIL"
REGCOMFL  FORM      1
REGCOMNM  DIM       8
REGCOMAF  FILE      ASCII, FIXED=127        * Joint Reg Comments
.
CALRTXT1  INIT      "Note: Non Billable Items Will not Saved to the Database"
CALRTXT2  INIT      " as 'Used' In Theatre Or Added to the Invoice."
.
. Details for New Booking
.-------------------------
OPEREXPD  FORM      4       * Expected Duration (min)
OPERANAE  DIM       3       * Anaesthetic Code (Cat. OA )
OPERTYPE  DIM       3       * Operation Type   (Cat. OY )
OPERTRAN  DIM       3       * Transport Code   (Cat. OR )
OPERUSR1  DIM       3       * User Defined 1 (Category Y6)
OPERUSR2  DIM       3       *              2 (Category Y7)
OPERUSR3  DIM       3       *              3 (Category Y8)
OPERUSR4  DIM       3       *              4 (Category Y9)
OPERPRV1  DIM       9       * Provisional item # 1 ( MBS or ICD9)
OPERPRV2  DIM       9       * Provisional item # 2 ( MBS or ICD9)
OPERPRV3  DIM       9       * Provisional item # 3 ( MBS or ICD9)
OPERPRV4  DIM       9       * Provisional item # 4 ( MBS or ICD9)
OPERPRV5  DIM       9       * Provisional item # 5 ( MBS or ICD9)
OPERPRV6  DIM       9       * Provisional item # 6 ( MBS or ICD9)
OPERPRV7  DIM       9       * Provisional item # 7 ( MBS or ICD9)
OPERPRV8  DIM       9       * Provisional item # 8 ( MBS or ICD9)
OPERPRV9  DIM       9       * Provisional item # 9 ( MBS or ICD9)
OPERPR10  DIM       9       * Provisional item # 10( MBS or ICD9)
OPERPR11  DIM       9       * Provisional item # 11( MBS or ICD9)
OPERPR12  DIM       9       * Provisional item # 12( MBS or ICD9)
OPERPR13  DIM       9       * Provisional item # 13( MBS or ICD9)
OPERPR14  DIM       9       * Provisional item # 14( MBS or ICD9)
OPERPR15  DIM       9       * Provisional item # 15( MBS or ICD9)
OPERPR16  DIM       9       * Provisional item # 16( MBS or ICD9)
OPERPR17  DIM       9       * Provisional item # 17( MBS or ICD9)
OPERPR18  DIM       9       * Provisional item # 18( MBS or ICD9)
OPERPR19  DIM       9       * Provisional item # 19( MBS or ICD9)
OPERPR20  DIM       9       * Provisional item # 20( MBS or ICD9)
OPERPR21  DIM       9       * Provisional item # 21( MBS or ICD9)
OPERPR22  DIM       9       * Provisional item # 22( MBS or ICD9)
OPERPR23  DIM       9       * Provisional item # 23( MBS or ICD9)
OPERPR24  DIM       9       * Provisional item # 24( MBS or ICD9)
OPERPR25  DIM       9       * Provisional item # 25( MBS or ICD9)
OPERPR26  DIM       9       * Provisional item # 26( MBS or ICD9)
OPERPR27  DIM       9       * Provisional item # 27( MBS or ICD9)
OPERPR28  DIM       9       * Provisional item # 28( MBS or ICD9)
OPERPR29  DIM       9       * Provisional item # 29( MBS or ICD9)
OPERPR30  DIM       9       * Provisional item # 30( MBS or ICD9)
OPERDES1  DIM       55      * Operation description line 1
OPERDES2  DIM       55      *                            2
OPERDES3  DIM       55      *                            3
OPERCOMM  DIM       40      * Comments
OPERCANC  DIM       3       * Cancellation Code (Category SC)
OPERTHET  DIM       6       * Operating Room Code
OPERKNOW  DIM       3       * Known Infection (Category OK)
OPERPREF  DIM       9       * Doctors Operation Preference
.
SAVCODE   DIM       3
.******************************************************************************
.*                       Program Variables                                    *
.******************************************************************************
CCITE2CN  FORM      3
CNTRCEFR  FORM      1
CATw0     INIT      "w0"
CATw4     INIT      "w4"
CATw5     INIT      "w5"
CATTC     INIT      "tc"
CATYD     INIT      "YD"
STATDESC  DIM       10                      * Status Description
CHRGDESC  DIM       10                      * Charge Description
DFLTWARD  DIM       3                       * Status Description
INITDTR   DIM       22[999]
INITMMBS  DIM       11[999]
INVOICED  FORM      1
ITYPDESC  DIM       30                      * Implant Type Description
IMPCOST   DIM       15                      * Implant Cost
APPLDATE  DIM       8
DCUINDIC  DIM       1
REMVDATE  DIM       8
FIRSTSEC  DIM       2
LASTSEC   DIM       2
PMBSFLAG  FORM      1
PTEXFLAG  DIM       1                       * Patient Expensive items flag
CMBSFLAG  DIM       1                       * Patient CMBS item flag
CMBSFEE   FORM      1
LIMBTYPE  DIM       10                      * Limb Type
SETDFPRG  DIM       8
SETDFREP  DIM       8
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
KEY21A    DIM       21
KEY26A    DIM       26
KEY35A    DIM       35
FIELDCNT  FORM      3
FORMTYP1  INIT      "Knee"
FORMTYP2  INIT      "Hip"
FORMTYP3  INIT      "Multi Joint"
FORMTYP4  INIT      "Spine"
FORMTY31  INIT      "Shoulder"
FORMTY32  INIT      "Elbow"
FORMTY33  INIT      "Wrist"
FORMTY34  INIT      "Ankle"
PREFDESC  DIM       90
PREFTYPE  DIM       1
RDIRFLAG  FORM      1
SKIPDPRF  FORM      1
SHOWHEAD  FORM      1
SAVKEY32  DIM       32
SAVKEY33  DIM       33
SAVKEY36  DIM       36
OPTHVISN  DIM       8        * Visit number used by OPTHCMPL proc call
OPTHRICM  DIM       3        * Reason Incomplete used by OPTHCMPL proc call
.
OPRCBUNI  DIM       10                      * Caesarean Birth Theatre Unique ID
OPRCBCNT  DIM       2                       * Caesarean Birth Count
OPCNFTYP  DIM       1
OPCNFTTM  FORM      1
OPCNTTYP  DIM       1
OPCNTTTM  DIM       1
.
OPTDESC0  INIT      "Operating Surgeon"
OPTDESC1  INIT      "Doctor"
OPTDESC2  INIT      "Nurse"
OPTDESC3  INIT      "Other"
OPPTDESC  DIM       18                      * staff type
STAFFNAM  DIM       50                      * staff name
APPLTIME  DIM       8                       * applied time tourniquete
PREPTIME  DIM       8                       * prep time
PTHVFLAG  FORM      1
DRESTIME  DIM       8
SKIPRECV  DIM       1
SUSTTIME  DIM       8
SUENTIME  DIM       8
DELYTIME  DIM       3
COUNTCOR  DIM       1
COUNTDPS  DIM       1
OPRTNAME  DIM       6
OPTSFDAT  DIM       11
INFCCONT  DIM       1
SURGCODE  DIM       6
SURGLEVL  DIM       3
TABLNAME  DIM       25                      * Table name
TOTMMBS   FORM      3
TOTDTRA   FORM      3
SLOTINDX  FORM      3                       * Index for Text boxes
DEFTODEB  FORM      1
DEFTODEC  FORM      1
DIM1A     DIM       1
DIM1B     DIM       1
DIM3      DIM       3
DIM5      DIM       5
DIM6      DIM       6
DIM6A     DIM       6
DIM6B     DIM       6
DIM9      DIM       9
DIM11     DIM       11
DIM18     DIM       18
DIM23A    DIM       23
DIM30     DIM       30
DIM37     DIM       37
HTMLLNK4  DIM       200
HTMLLNK5  DIM       200
HTMLLNK6  DIM       200
HTMLLNK7  DIM       200                     * T0869563
HTMLLNK8  DIM       200
DTRRE001  DIM       12                      * I CAR 40412
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
SAVKEY01  DIM       22
SERVER    DIM       13                      * Server Name
REPTNO    DIM       3                       * Report Number
UNIQUEKY  DIM       10
UNIQNUMB  DIM       10
UPDATMMB  DIM       1
.
TPAGENO   FORM      6
DIAMT     DIM       5
FORM12P2  FORM      12.2
IMPLANT   DIM       6
MCDESD45  DIM       45                      * Misc Charge Description
SHYPHENS  INIT      " - "
PATFLDER  DIM       3

.
INPUSETF  IFILE     SQL, FIXED=52, KEY="U1-26"
.Name     Type      Length   Phys.   Start    Desc.
.DAMOUNT  DIM       9        9       1        Amount
.DIAMT    DIM       5        5       10       MBS Item amount
.PROVITEM DIM       9        9       15       Prov.Item
UNIQUE    DIM       3        3       25       Uniq
.OPPMTMNO DIM       1        1       27       Team Number
.OPPMGSTA FORM      2        2       28       GST Applicable ?
.OPPMGSTC DIM       6        6       30       GST Code
.DOPPMCNT DIM       3        3       36       Counter
CONSTYPE  DIM       1        1       39       Consumption type
REFNUMBR  DIM       12       12      40       Reference Number
.EOR                                 52
.
NOFEE     FORM      1
OPRFNAM1  DIM       8
USINSNUM  FORM      2
THCFLG    FORM      2
OPERROOM  DIM       50
SECONDS   INIT      ":00"
SP14      INIT      "              "
STAFFLAG  FORM      1             * Default staff flag: 1 = no, 0/2/blank = yes
STAFTYPE  FORM      2
.
UPDTMFLG  FORM      1             * Update Team Indicator
RECOPMIN  FORM      1             * Recalculate Actual Op Mins flag
MINPREPT  DIM       5             * Minimum 'Prep Start Time'
MAXDREST  DIM       5             * Maximum 'Dressing Time'
PREPDIND  FORM      1             * 'Prep Start Time' Day Indicator
DRESDIND  FORM      1             * 'Dressing Time' Day Indicator
CURRDAY   FORM      1             * Current Day Indicator
ACDURMIN  FORM      4             * Actual Operation Duration (in Min)
PREPTMIN  FORM      4             * 'Prep Start Time' - Minute representation
DRESTMIN  FORM      4             * 'Dressing Time' - Minute representation
.
IMPLANTK  DIM       13
OPRARKEY  DIM       10            * oprardaf unique key    * T0869563
.
. Day Procedure Variables
.
MBSTOTAL  FORM      3
IMPTOTAL  FORM      2
EXPTOTAL  FORM      2
MBSFCODE  DIM       9
IMPFCODE  DIM       15
EXPFCODE  DIM       6
MSCFCODE  DIM       9
SURGTYPE  DIM       3                  * Surgery Type - Day/General
SRGEXIST  FORM      1                  
STFEXIST  FORM      1                  
MBSBILLD  FORM      1                  * MBS Billed Indicator
MBSCHRGD  FORM      1                  * charging prov MBS
NBSPS888  INIT      "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
.
WARNCNT   FORM      2       * Warning counter
WEBWRN    DIM       120[99] * Warning Array
.
ITMDESFL  FORM      1
ITMDESNM  DIM       8
ITMDESPR  INIT      "ITMFIL"
ITEMDATA  DIM       50
LASTITEM  FORM      3
ZERO8     INIT      "0000    "
OADESC    DIM       20
OYDESC    DIM       20
STDESC    DIM       20
.
STRTSTRN  DIM       5                  * start time "HH:MM"
ENDTSTRN  DIM       5                  * end time "HH:MM"
.
DLYRSNRC  DIM       1                  * Delay Reason to be Recorded
.
THADT001  INIT      "Booking Created"
THADT002  INIT      "Booking Updated"
THADT003  INIT      "Cancelled"
THADT004  INIT      "Transferred"
THADT005  INIT      "Case Sorted"
THADT006  INIT      "Adjusted Start Time"
THADT007  INIT      "Merged Booking"
THADT008  INIT      "Changed UR"
THADT009  INIT      "Reinstated Booking"
THADT010  INIT      "Day Surgery Details Updated"
THADT011  INIT      "Arrival Details Updated"
THADT012  INIT      "Anaesthetic Details Updated"
THADT013  INIT      "Surgery Details Updated"
THADT014  INIT      "Subsequent Team Added"
THADT015  INIT      "Recovery Details Updated"
THADT016  INIT      "Confirmed Adm Date Updated"
THADT017  INIT      "Theatre Items Updated"
THADT018  INIT      "Theatre Case Completed"
THADT019  INIT      "Theatre Case Flagged In-Complete"
THADT020  INIT      "Booking Updated With Ward/Bed Information From The Bed Board"
THADT021  INIT      "S14 Message Received"
.
.FHRDASH   INIT      "-"
.FHRPATID  DIM       8
FHRAPPID  DIM       26
FHRSUBIN  FORM      1      * _include=Appointment:subject
FHRLOCIN  FORM      1      * _include=Appointment:location
FHRPARIN  FORM      1      * _include=Appointment:participant
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.FHRSTAT   DIM       15
.
TABLE     INIT      "<table width=100% border=0>"
BOLD      INIT      "<b>"
EBOLD     INIT      "</b>"
ETABLE    INIT      "</table>"
NBSP      INIT      "&nbsp;"
TD        INIT      "<td>"
TD20      INIT      "<td width='20%'>"
TDCL3     INIT      "<td colspan=3 >"
TDRJ      INIT      "<td align='right'>"
TDHD      INIT      "<td class=HeadingCell>"
TDTY      INIT      "<td class=HighLightRed>"
ETD       INIT      "</td>"
TR        INIT      "<tr>"
ETR       INIT      "</tr>"
HR        INIT      "<hr>"
PGEBREAK  INIT      "<div style='page-break-before:always'></div>"
.
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.
.******************************************************************************
PRGID     INIT      "OPRWEB06"                                                *
VERSION   INIT      "V12.00.04"
PRGNAM    INIT      "Theatre Information Server"                              *
.******************************************************************************
          CALL      WEBINT00                * Initialise FIFO Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read FIFO WEBPID and USERID
          COMPARE   "999",REPORTNO          * ReadSvrProcess onReport Option 999
          GOTO      MAIN9999 IF EQUAL
          BRANCH    EXIT,MAIN1000
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,CDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00                * Create Output&Write HTMLFileHeader
          GOTO      MAIN1000
.
MAIN1100  CALL      OPRSRG00                * for theatre and surgical details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00               
          GOTO      MAIN1000
.
MAIN1200  CALL      OPRICM00                * for input theatre CMBS
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      OPRMBS00                * for CMBS items maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      OPRIEX00                * for input expensive items
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      OPREXP00                * for Expensive items maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      OPRIMP00                * For Maintenance Implant details
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      OPRPID00                * for input implant details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      OPROTD00                * for other thetre details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      OPRTQT00                * for tourniquet details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      OPRREC00                * for recovery details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      OPRHIS00                * for thetre history enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      OPRDAY00                * Day Procedure Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      OPRPRF00                * for Preference Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      OPRREQ00                * for Requistions Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      OPRREG00                * Joint Replacement Registry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      REMOTE00                * Remote Scripts
          GOTO      MAIN1000
.
MAIN2700  CALL      DONCU000                * Day oncology usage
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2800  CALL      CSRBTH00                * Caesarean Birth Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      RECCLS00                * Recovery Closed Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      PMSUFI00                * User Group Favourites
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.******************************************************************************
.*                       Output Next Page Based on CGI Parameter nextpage      *
.******************************************************************************
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
.... C CAR 48048
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60:
                       NXTPAG70,NXTPAG80
....
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIRWR00                * Redirect Parent Content Page
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00                * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      WINBAK00                * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00                * Redirect Content Page
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINPAR00
          GOTO      NXTPAG99
.... I CAR 48408
NXTPAG60  CALL      CLSRED00                * Close window and redirect
          GOTO      NXTPAG99
....
NXTPAG70  CALL      CLOFRM00               * Close Frame without refreshing the parent
          GOTO      NXTPAG99
.
NXTPAG80  CALL      RELOAD00               * Page Refresh
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------
.  Redirect to REDIRECT URL plus warnings
.------------------------------------------------------------
RDIRWR00  CALL      OPENHTML
          BRANCH    EXIT,RDIRWR99
.
          BRANCH    FHIRTYPE,RDIRWR30
.
          WRITE     HTMLFILE;"<html><head>":
                             "<script type=#"text/javascript#">{"
.
          COMPARE   ZERO,WARNCNT
          GOTO      RDIRWR20 IF EQUAL
.
          MOVE      ONE,F2
RDIRWR10  WRITE     HTMLFILE;"    alert(#"",WEBWRN[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,WARNCNT
          GOTO      RDIRWR20 IF LESS
          GOTO      RDIRWR10
.
RDIRWR20  WRITE     HTMLFILE;" location.href=#"",REDIRECT,"#";":
                             "}</script>":
                             "</head>":
                             "<body></body></html>"
          CALL      CLOSHTML
          GOTO      RDIRWR99
.
RDIRWR30  CALL      FHRSUC00
.
RDIRWR99  RETURN
.
.------------------------------------------------------------
. Close Window and redirect
.------------------------------------------------------------
CLSRED00  CALL      OPENHTML
          BRANCH    EXIT,CLSRED99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close();}":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
CLSRED99  RETURN
.    
.------------------------------------------------------------
. Close Frame
.------------------------------------------------------------
CLOFRM00  CALL      OPENHTML
          BRANCH    EXIT,CLOFRM99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             " DFrameExit();":
                             "</script>"
          CALL      CLOSHTML     * End of Document
CLOFRM99  RETURN
.
.******************************************************************************
.*                      Redirect Content URL                                  *
.******************************************************************************
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.

          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             " redirectTopContent(#"",REDIRECT,"#"); ":
                             "</script>"

          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.******************************************************************************
.*                         Goes back One page                                 *
.******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "          alert(#"",WEBTITLE,"#");":
                             "          self.close();":
                             "          opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
GOBACK99  RETURN
.*****************************************************************************
.*        Close Window and Goback to previous page                           *
.******************************************************************************
WINBAK00  CALL      OPENHTML
          BRANCH    EXIT,WINBAK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                        "   self.close();":
                        "   window.history.go(-2);":
                        "}":
                        "</script>";
          CALL      CLOSHTML
.
WINBAK99  RETURN
.*****************************************************************************
.*        Close Window or Frame and Goto New Location                         *
.******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>"

          CALL      CLOSHTML
.
WINPAR99  RETURN
.******************************************************************************
.*                      Open Files and Initialise variables                   *
.******************************************************************************
INIT0000  CALL      INTMAS00
          CALL      GETTZ000
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLWLNA1,"allwlnaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      WATESEA1,"wateseaf" 
          OPEN      WATOPAA1,"watopaaf" 
          OPEN      WATTR1A1,"wattr1af" 
          OPEN      WATMESA1,"watmesaf" 
          OPEN      NZPSPRA1,"nzpspraf" 
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMCHG2,"patmchgf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATITEM2,"patitemn"
          OPEN      PATITEM3,"patitemn"
          OPEN      PMSHCPA1,"pmshcpaf"	
          OPEN      PMSUFIA1,"pmsufiaf"
          OPEN      PMSUFIA2,"pmsufiaf"
          OPEN      PMSUFIA3,"pmsufiaf"
          OPEN      PATMMBS2,"patmmbsf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDO1A2,"patdo1af"
          OPEN      PATDO1A3,"patdo1af"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA3,"patdtraf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATRGMA1,"patrgmaf"
.
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSOCMA1,"pmsocmaf"
          OPEN      PMSADCA1,"pmsadcaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSPODA1,"pmspodaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCMCA1,"patcmcaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A2,"bokrc1af"
          OPEN      BOKRC1A3,"bokrc1af"
          OPEN      BOKRC1A4,"bokrc1af"
          OPEN      BOKRC1A5,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      BOKRC1A7,"bokrc1af"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      BOKUNQA1,"bokunqaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
          OPEN      OPRADTA1,"opradtaf"
          OPEN      OPRADTA2,"opradtaf"
          OPEN      OPRDPHA1,"oprdphaf"
          OPEN      OPRDPFA1,"oprdpfaf"
          OPEN      OPRPCMA1,"oprpcmaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRRCIA1,"oprrciaf"
          OPEN      OPRRCIA2,"oprrciaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRTQEA1,"oprtqeaf"
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPRPEIA1,"oprpeiaf"
          OPEN      OPREXPA1,"oprexpaf"
          OPEN      OPREXPA2,"oprexpaf"
          OPEN      OPREQPA1,"opreqpaf"
          OPEN      OPRDEDA1,"oprdedaf"
          OPEN      OPRPIMA1,"oprpimaf"
          OPEN      OPRPIMA3,"oprpimaf"
          OPEN      OPRTHIA1,"oprthiaf"
	  OPEN      OPRTHIA2,"oprthiaf"
          OPEN      OPRTHIA3,"oprthiaf"
          OPEN      OPRTHIA4,"oprthiaf"
          OPEN      OPRJRRA1,"oprjrraf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPROPRA2,"opropraf"
          OPEN      OPRPOCA1,"oprpocaf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      OPRNURA2,"oprnuraf"
          OPEN      OPRMBSA1,"oprmbsaf"
          OPEN      OPRPMBA1,"oprpmbaf"
          OPEN      OPRPRFA1,"oprprfaf"
          OPEN      OPRREQA1,"oprreqaf"
          OPEN      OPRREQA2,"oprreqaf"
          OPEN      OPRREQA3,"oprreqaf"
          OPEN      OPRTHIA1,"oprthiaf"
          OPEN      OPRTHIA2,"oprthiaf"
          OPEN      OPRTRYA1,"oprtryaf"
          OPEN      OPRTRYB1,"oprtrybf"
          OPEN      OPRTPSA1,"oprtpsaf"
          OPEN      OPRITEA1,"opriteaf"
          OPEN      OPRITEA2,"opriteaf"
          OPEN      OPRITEA3,"opriteaf"
.         OPEN      SINCICA1,"sincicaf"
.         OPEN      SINCICA2,"sincicaf"
.         OPEN      SINCICA3,"sincicaf"
          OPEN      OPRPMBA2,"oprpmbaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA3,"nzpmchaf"
          OPEN      NZPMXCA1,"nzpmxcaf"
.
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      IBAGSTA2,"ibagstaf"
.
          OPEN      OPRCBDA1,"oprcbdaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCLIA2,"oprcliaf"
          OPEN      OPRPEIA2,"oprpeiaf"
          OPEN      OPRCTYA1,"oprctyaf"
.
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      PATTFEE1,"pattfeef"
          OPEN      PATECHA1,"patechaf"
          OPEN      PMSCHAA1,"pmschaaf"
          OPEN      WATTX1A1,"wattx1af"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRAAE11,"opraaeaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,AAEFLAG
          ELSE
            MOVE      ONE,AAEFLAG
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRATRA1,"opratraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,UPDOPATI
          ELSE
            MOVE      ONE,UPDOPATI
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRCPIA1,"oprcpiaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,UPDOPCPI
          ELSE
            MOVE      ONE,UPDOPCPI
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRABIA1,"oprabiaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,UPDOPABI
          ELSE
            MOVE      ONE,UPDOPABI
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRSDTA1,"oprsdtaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,UPDOPSDT
          ELSE
            MOVE      ONE,UPDOPSDT
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,OPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,XPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,YPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,ZPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,WPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,REGCOMNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,ITMDESNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,OPRFNAM1
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEA
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEB
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEFAV
.
          CALL      TFILENAM
          MOVE      TFILNAME,EXPCMTNM
.
.***********************************************************************
.  Read the Control File Variables
.**********************************************************************
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,FORTY;*81,OPCNODSC,*96,OPCNCDSC,*111,OPCNCLSU
          READ      CONTROLF,FORTY;*112,OPCNCODE
          READ      CONTROLF,TEN3;*154,CUSEMBS,*245,CHOSTYP
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,FORTY2;*7,OPCNMREC,*43,OPCNXCHG,*102,OPCNCHMB:
                                    *235,OPCNFTIM,*237,OPCNTTIM        *I-58289
          READ      CONTROLF,HUND05;*130,PTCNAUAT,*177,PTCNTFEE:
                                    *190,PTSGCOPT     * Using suggested class.
          READ      CONTROLF,SIXTY8;*241,OPCNSTCT,*245,OPCNDSAS,*247,OPCNDSAE:
                                    *249,OPCNSEMP
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND12;*101,PTCNUFFR,*118,PTCNTRPR
          READ      CONTROLF,HUND13;*3,OPCNCOMB,*31,OPCNUTRA,*17,OPCNVRRD:
                                    *32,OPCNCTIN,*33,OPCNCOSO,*34,OPCNCRRH:
                                    *35,OPCNLDAE,*38,OPCNCRRM,*48,OPCNSIVB:
                                    *50,OPCNCONS,*51,OPCNURSE,*52,OPCNDMBS:
                                    *66,OPCNPTMC
          READ      CONTROLF,HUND18;*71,PTCNADDF,*115,PTCNPROS
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          MATCH     "1",PTCNTRPR
          IF        @EQUAL
            OPEN      PMSPTDA1,"pmsptdaf"
          ENDIF
.
          MATCH     SP3,PTCNDCLM
          IF        @EQUAL
            MOVE      "0  ",PTCNDCLM
          ENDIF
.
          CALL      OPICO1
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
GETTZ999  RETURN
.******************************************************************************
.                       Clear Parameters                                      *
.******************************************************************************
CLRPAR00  CALL      CPOPSG00
          CALL      CPOPAR00
.
          CLOSE     OPCOMFIL,DELETE
          CLOSE     XPCOMFIL,DELETE
          CLOSE     YPCOMFIL,DELETE
          CLOSE     ZPCOMFIL,DELETE
          CLOSE     WPCOMFIL,DELETE
.
          MOVE      ZERO,SLOTINDX
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,CNTDTAIL
          MOVE      SP70,UPDATETY
          MOVE      SP70,SUPRLEVL
          MOVE      SP70,NEXTPAGE
          MOVE      ZERO,ONCOLOGY
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,RDIRFLAG
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          PACK      STARTKEY,SP70,SP70
          MOVE      ZERO,STARTNUM
          MOVE      SP70,CASEKEYS
          MOVE      SP70,CHCKRECO
          MOVE      SP70,UNIQUEKY
          MOVE      ONE,TEAMNUMB
          MOVE      ZERO,ICOUNTER
          MOVE      ZERO,NORECORD
          MOVE      SP70,RECORDTY
          MOVE      ZERO,RCOUNTER
          MOVE      SP70,RLEGAPPL
          MOVE      SP70,RLEGREMV
          MOVE      SP70,LLEGAPPL
          MOVE      SP70,LLEGREMV
          MOVE      SP70,RARMAPPL
          MOVE      SP70,RARMREMV
          MOVE      SP70,LARMAPPL
          MOVE      SP70,LARMREMV
          MOVE      SP70,OTHRAPPL
          MOVE      SP70,OTHRREMV
          MOVE      SP70,CARTAPPL
          MOVE      SP70,CARTREMV
          MOVE      SP70,AORTAPPL
          MOVE      SP70,AORTREMV
          MOVE      ZERO,CHRGPMBS
          MOVE      ZERO,PTHVFLAG
          MOVE      SP70,IMPLANTK
          MOVE      ZERO,ITEMQNTY
          MOVE      SP70,LINKREGF
          MOVE      SP70,OPRARKEY                          * T0869563
          MOVE      SP70,IRECTYPE
          MOVE      SP70,TRANNUMB
          MOVE      ZERO,SHOWPROV
          MOVE      SP70,THEACOMP
          MOVE      SP70,THERCOMP
          MOVE      SP70,PTGTU001
          MOVE      SP70,PTGTU002
          MOVE      Z70,PTMSX003
          MOVE      Z70,RECOVFUL
          MOVE      Z70,EXTTODAY
          MOVE      SP70,NEWSESSI
          MOVE      SP70,NODRESSG
          MOVE      SP70,FILTLOCN
          MOVE      ZERO,EXPEXCEL
          MOVE      ZERO,INCLEXIT
          MOVE      ZERO,SHOWADMT
.
          CALL      CPOREQ00      * clear requistions
          MOVE      Z70,BKUNQ001
.
          MOVE      SP70,OPTHI001
          MOVE      SP70,OPTHI002
          MOVE      SP70,OPTHI003
          MOVE      SP70,OPTHI004
          MOVE      SP70,OPTHI005
          MOVE      SP70,OPTHI006
          MOVE      SP70,OPTHI007
          MOVE      ZERO,OPTHI008
          MOVE      SP70,OPTHI009
          MOVE      SP70,OPTHI010
          MOVE      SP70,OPTHI011
          MOVE      SP70,OPTHI012
          MOVE      SP70,OPTRQ001
          MOVE      SP70,OPTRQ002
          MOVE      SP70,OPTRQ003
          MOVE      SP70,OPTRQ004
          MOVE      SP70,OPTRQ005
          MOVE      SP70,OPTRQ006
          MOVE      SP70,EXTIM001
          MOVE      SP70,EXTIM002
          MOVE      SP70,RDTIM001
          MOVE      SP70,RDTIM002
.
          MOVE      SP70,OPPIM001 
          MOVE      ZERO,OPPIM002
          MOVE      SP70,OPPIM003 
          MOVE      SP70,OPPIM004
          MOVE      SP70,OPPIM005
          MOVE      SP70,OPPIM006
          MOVE      SP70,OPPIM007
          MOVE      SP70,OPPIM008
          MOVE      SP70,OPPIM009
          MOVE      SP70,OPPIM010
          MOVE      SP70,OPPIM011
          MOVE      SP70,OPPIM012
.
          MOVE      SP70,OPPMB001
          MOVE      SP70,OPPMB002
.
          MOVE      SP70,OPSES012
.
          MOVE      SP70,OPTSM001
          MOVE      SP70,OPTSM002
          MOVE      SP70,OPTSM003
          MOVE      SP70,OPTSM004
          MOVE      SP70,OPTSM005
          MOVE      SP70,OPTSM006
          MOVE      SP70,OPTSM007
          MOVE      SP70,OPTSM008
          MOVE      SP70,OPTSM009
          MOVE      SP70,OPTSM010
          MOVE      SP70,OPDUNQID
          MOVE      SP70,OPDUNQFF
.
          MOVE      SP70,OPPEI001
          MOVE      SP70,OPPEI002
          MOVE      ZERO,OPPEI003
          MOVE      ZERO,OPPEI004          * Default to Charged
          MOVE      ZERO,OPPEI005          * Default to Not Broken
.
          MOVE      Z70,OPDEA006
          MOVE      SP70,OPDEA016
          MOVE      SP70,OPDEA015
          MOVE      SP70,OPDEA014
          MOVE      SP70,OPDEA003
          MOVE      Z70,OPDEA004
          MOVE      Z70,OPDEA020
          MOVE      Z70,OPDEA021
          MOVE      Z70,OPDEA022
          MOVE      Z70,OPDEA023
          MOVE      Z70,OPDEA024
          MOVE      Z70,OPDEA025
          MOVE      Z70,OPDEA026
          MOVE      Z70,OPDEA027
          MOVE      Z70,OPDEA028
          MOVE      Z70,OPDEA030
          MOVE      Z70,OPDEA043
          MOVE      Z70,OPDEA044
          MOVE      Z70,OPDEA045
          MOVE      Z70,OPDEA046
          MOVE      Z70,OPDEA049
          MOVE      Z70,OPDEA050
          MOVE      Z70,OPDEA051
.
          MOVE      SP70,DATEFLAG
          MOVE      SP70,SAVKEY01
          PACK      SAVKEY76,SP70,SP70
          MOVE      Z70,OPTQT001
          MOVE      Z70,OPTQT002
          MOVE      Z70,OPTQT003
          MOVE      Z70,OPTQT004
          MOVE      Z70,OPTQT005
          MOVE      SP70,SCHDPRNT
          MOVE      SP70,SCHDPRIN
          MOVE      ZERO,SCHDCOPY
          MOVE      SP70,STATNCOD
          MOVE      SP70,SETDEFPN
          MOVE      SP70,LABELTYP
          MOVE      ZERO,PRINTREG
          MOVE      SP70,SURGTYPE
          MOVE      SP70,PACAFLAG
.
.         CLEAR     OPCOMFNM
.         APPEND    "OPWB06",OPCOMFNM
.         APPEND    PORT,OPCOMFNM
.         RESET     OPCOMFNM
.         REP       " 0",OPCOMFNM
.         PREP      OPCOMFIL,OPCOMFNM
.
.         CLEAR     XPCOMFNM
.         APPEND    "OPRW06",XPCOMFNM
.         APPEND    PORT,XPCOMFNM
.         RESET     XPCOMFNM
.         REP       " 0",XPCOMFNM
.         PREP      XPCOMFIL,XPCOMFNM
.
          MOVE      ONE,F4
          WHILE     F4 <= 999
            MOVE      SP70,EXPITKEY[F4]
            MOVE      SP70,QUANTKEY[F4]
            MOVE      ZERO,NOCHARGE[F4]
            MOVE      ZERO,BROKENIT[F4]
.
            MOVE      SP70,PREFTKEY[F4]    * for add pref
            MOVE      ZERO,PREFTQTY[F4]
            MOVE      ZERO,PREFTFLG[F4]
.
            MOVE      SP70,ADDREQDT[F4]    * for add doc pref
            ADD       ONE,F4
          DO
          MOVE      ONE,F2
          WHILE     F2 <=50
            MOVE      SP70,PROVM[F2]
            ADD       ONE,F2
          DO
          MOVE      SP70,MBSFCODE 
.
          CALL      CPOPJR00
.
.         PACK      REGCOMNM,REGCOMPR,PORT
.         REP       " 0",REGCOMNM
.         PREP      REGCOMAF,REGCOMNM
          MOVE      ZERO,REGCOMFL
.
          MOVE      ONE,F4
          WHILE     F4 <= 999
            MOVE      SP70,ITEMN[F4]
            MOVE      SP70,GSTCD[F4]
            MOVE      SP70,DESCP[F4]
            MOVE      SP70,MBSCD[F4]
            MOVE      ZERO,CAMNT[F4]
            MOVE      ZERO,QUNTY[F4]
            MOVE      ZERO,GSTAP[F4]
            MOVE      ZERO,PATPR[F4]
            MOVE      ZERO,REBPR[F4]
            MOVE      ZERO,MBSQN[F4]
            MOVE      ZERO,CONSM[F4]
            ADD       ONE,F4
          DO
.
          MOVE      ZERO,WARNCNT
          CALL      CPBKRX00
.
          CALL      COPRAA00
.
.         PACK      ITMDESNM,ITMDESPR,PORT
.         REP       " 0",ITMDESNM
.         PREP      ITMDESAF,ITMDESNM
          MOVE      ZERO,ITMDESFL
.
          MOVE      ZERO,STAFFLAG
.
          MOVE      SP70,OPRCBUNI
          MOVE      SP70,OPRCBCNT
          MOVE      SP70,OPCBD001
          MOVE      SP70,OPCBD002
          MOVE      SP70,OPCBD003
          MOVE      SP70,OPCBD004
          MOVE      SP70,OPCBD005
          MOVE      SP70,OPCBD006
          MOVE      SP70,OPCBD007
          MOVE      SP70,OPCBD008
          MOVE      SP70,VALDCODE
          MOVE      SP70,VALDBCOD
          MOVE      SP70,SAVBCODE
          MOVE      SP70,HARDDELT
          MOVE      SP70,DCUINDIC
          MOVE      SP70,UPDATMMB
          MOVE      ZERO,REMOTENO
.
          CALL      CPOPRC00
          MOVE      ZERO,PRINTCLS
          MOVE      SP70,USERNAME
          MOVE      SP70,DTRRE001
.
          CALL      CLROTR00
          MOVE      SP70,UPDOPATR
.
          MOVE      SP70,WATER001
          MOVE      SP70,WATER002
          MOVE      SP70,WATER003
          MOVE      SP70,SALIN001
          MOVE      SP70,SALIN002
          MOVE      SP70,SALIN003
          MOVE      SP70,HAART001
          MOVE      SP70,HAART002
          MOVE      SP70,HAART003
          MOVE      SP70,GLYCI001
          MOVE      SP70,GLYCI002
          MOVE      SP70,GLYCI003
          MOVE      SP70,RINGR001
          MOVE      SP70,RINGR002
          MOVE      SP70,RINGR003
          MOVE      SP70,OTHER003
          MOVE      SP70,OTHER002
          PACK      OTHER001,SP70,SP70
.
          MOVE      SP70,DIATH001
          MOVE      SP70,DIATH002
          PACK      DIATH003,SP70,SP70     
          PACK      DIATH004,SP70,SP70
          MOVE      SP70,WOUND001
          MOVE      SP70,WOUND002
          MOVE      SP70,WOUND003
          MOVE      SP70,WOUND004
          MOVE      SP70,WOUND005
          MOVE      SP70,SKINI001
          MOVE      SP70,SKINI002
          MOVE      SP70,SKINI003
          MOVE      SP70,SKINI004
          MOVE      SP70,SKINI005
          MOVE      SP70,PATPO001
          MOVE      SP70,PATPO002
          MOVE      SP70,PATPO003
          MOVE      SP70,PATPO004
          MOVE      SP70,PATPO005
          PACK      PATPO006,SP70,SP70
          MOVE      SP70,POSDE001
          MOVE      SP70,POSDE002
          MOVE      SP70,POSDE003
          MOVE      SP70,POSDE004
          MOVE      SP70,POSDE005
          MOVE      SP70,POSDE006
          MOVE      SP70,POSDE007
          MOVE      SP70,POSDE008
          MOVE      SP70,POSDE009
          MOVE      SP70,ARMBO001
          MOVE      SP70,ARMBO002
          MOVE      SP70,ARMBO003
          MOVE      SP70,ARMBO004
          MOVE      SP70,ARMBO005
          MOVE      SP70,ARMBO006
          MOVE      SP70,ARMBO007
          MOVE      SP70,ARMBO008
          MOVE      SP70,PRESR001
          MOVE      SP70,PRESR002
          MOVE      SP70,PRESR003
          MOVE      SP70,PRESR004
          MOVE      SP70,PRESR005
          MOVE      SP70,PRESR006
          MOVE      SP70,SKINP001
          MOVE      SP70,SKINP002
          MOVE      SP70,SKINP003
          MOVE      SP70,SKINP004
          MOVE      SP70,SKINP005
          PACK      SKINP006,SP70,SP70
          MOVE      SP70,HAIRR001
          MOVE      SP70,HAIRR002
          MOVE      SP70,HAIRR003
          PACK      HAIRR004,SP70,SP70
          PACK      OTHRC001,SP70,SP70
          MOVE      SP70,SPECI001 
          PACK      SPECI002,SP70,SP70
          PACK      SPECI003,SP70,SP70 
          PACK      SPECI004,SP70,SP70
          PACK      SPECI005,SP70,SP70
          PACK      DRAIN001,SP70,SP70
          PACK      DRAIN002,SP70,SP70
          PACK      DRAIN003,SP70,SP70
          PACK      DRAIN004,SP70,SP70
          MOVE      SP70,DRAIN005
          MOVE      SP70,DRAIN006
          MOVE      SP70,DRAIN007
          MOVE      SP70,CATHT001 
          MOVE      SP70,CATHT002
          MOVE      SP70,CATHT003
          MOVE      SP70,CATHT004
          MOVE      SP70,CATHT005
          PACK      CATHT006,SP70,SP70
          MOVE      SP70,CATHT007
          MOVE      SP70,CATHT008
          MOVE      SP70,CATHT009
          PACK      IRRIG001,SP70,SP70
          PACK      IRRIG002,SP70,SP70
          PACK      IRRIG003,SP70,SP70
          PACK      IRRIG004,SP70,SP70
          PACK      IRRIG005,SP70,SP70
          MOVE      SP70,IRRIG006
          MOVE      SP70,IRRIG007
          MOVE      SP70,IRRIG008
          MOVE      SP70,IRRIG009
          MOVE      SP70,IRRIG010
          PACK      DRESN001,SP70,SP70
          MOVE      SP70,DRSSNIND
          MOVE      SP70,COUNC001
          MOVE      SP70,COUNC002
          MOVE      SP70,COUNC003
          MOVE      SP70,COUNC004
          PACK      COUNC005,SP70,SP70
          PACK      COUNC006,SP70,SP70
          MOVE      SP70,COUNC007
          MOVE      SP70,COUNC008
          MOVE      SP70,JMPHFLAG
.
          MOVE      SP70,SKIPRECV
          MOVE      SP70,EREFRLID
.
          CALL      CLRSDT00
.
          MOVE      SP70,MDATE000
          MOVE      SP70,INCTY000
          MOVE      SP70,PROCE000
          MOVE      SP70,PROCDESC
          MOVE      SP70,UNIQU000
.
          MOVE      SP70,SELCOCCG
          MOVE      SP70,SELCFAVG
          MOVE      SP70,DEFAINDC
          MOVE      SP70,NOWARNFL
          MOVE      ZERO,RECOVDUR
          MOVE      ZERO,DLYRSNRC
          MOVE      SP70,HOSPCODE
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
.
          MOVE      ZERO,EXPCMTFL
.
CLRPAR99  RETURN
.******************************************************************************
.*                      Set Parameters                                        *
.******************************************************************************
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            REP       "+ ",URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            REP       "+ ",ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprlevl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRLEVL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rdirflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RDIRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkunq001=",QRYNAME
          IF        @EQUAL
            PACK      BKUNQ001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oncology=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ONCOLOGY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmsx003=",QRYNAME
          IF        @EQUAL
            PACK      PTMSX003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,NEXTPAGE
            GOTO    SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,REDIRECT
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            REP      "+ ",CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqueky=",QRYNAME
          IF        @EQUAL
            PACK      UNIQUEKY,QRYDATA,SP70
            REP       "+ ",UNIQUEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqu000",QRYNAME
          IF        @EQUAL
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
.
            PACK      DIM3,QRYDATA,SP70
            REP       "+ ",DIM3
            SQUEEZE   DIM3
            MOVE      DIM3,FORM3
            PACK      UNIQU000,FORM3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "teamnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEAMNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdunqid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDUNQID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdunqff=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDUNQFF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savkey01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVKEY01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savkey76=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVKEY76
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "icounter=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICOUNTER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dlyrsnrc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DLYRSNRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opard",QRYNAME
          IF        @EQUAL
            CALL      SPOAR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opcom",QRYNAME
          IF        @EQUAL
            CALL      OPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xpcom",QRYNAME
          IF        @EQUAL
            CALL      XPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ypcom",QRYNAME
          IF        @EQUAL
            CALL      YPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "zpcom",QRYNAME
          IF        @EQUAL
            CALL      ZPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wpcom",QRYNAME
          IF        @EQUAL
            CALL      WPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extprcmt",QRYNAME
          IF        @EQUAL
            CALL      GTEXDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opjrr",QRYNAME
          IF        @EQUAL
            CALL      SPOPJ000              * Set Para for joint reg
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opsrg",QRYNAME
          IF        @EQUAL
            CALL      SPOSG000              * Set Para for Surgical Details
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppim",QRYNAME
          IF        @EQUAL
           CALL     SPPID000                * Set cgi-parameters for patient
           GOTO     SETPAR99                * implant table
          ENDIF
.
          MATCH     "opthi",QRYNAME
          IF        @EQUAL
            CALL      STOPT000              * Set Parameters For Implant Code
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opreq",QRYNAME
          IF        @EQUAL
            CALL      SPREQ000             
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppmb001=",QRYNAME
          IF        @EQUAL
            PACK      OPPMB001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppmb002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPMB002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea006=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea014=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA014
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea015=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA015
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea016=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA016
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea020=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA020
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea021=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA021
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea022=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA022
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea023=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA023
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea024=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA024
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea025=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA025
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea026=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA026
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea027=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA027
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea028=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA028
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea030=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA030
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea043=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA043
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea044=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA044
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea045=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA045
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea046=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA046
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea049=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA049
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea050=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA050
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea051=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPDEA051
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optrq",QRYNAME         * Limb Type(Record Type)
          IF        @EQUAL
            CALL      STTRQ000
            GOTO      SETPAR99
          ENDIF
.
          MATCH   "recordty=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,RECORDTY
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "rcounter=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,RCOUNTER
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "rlegappl=",QRYNAME
          IF        @EQUAL
            PACK      RLEGAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rlegremv=",QRYNAME
          IF        @EQUAL
            PACK      RLEGREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "llegappl=",QRYNAME
          IF        @EQUAL
            PACK      LLEGAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "llegremv=",QRYNAME
          IF        @EQUAL
            PACK      LLEGREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rarmappl=",QRYNAME
          IF        @EQUAL
            PACK      RARMAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rarmremv=",QRYNAME
          IF        @EQUAL
            PACK      RARMREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "larmappl=",QRYNAME
          IF        @EQUAL
            PACK      LARMAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "larmremv=",QRYNAME
          IF        @EQUAL
            PACK      LARMREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "othrappl=",QRYNAME
          IF        @EQUAL
            PACK      OTHRAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "othrremv=",QRYNAME
          IF        @EQUAL
            PACK      OTHRREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cartappl=",QRYNAME
          IF        @EQUAL
            PACK      CARTAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cartremv=",QRYNAME
          IF        @EQUAL
            PACK      CARTREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aortappl=",QRYNAME
          IF        @EQUAL
            PACK      AORTAPPL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aortremv=",QRYNAME
          IF        @EQUAL
            PACK      AORTREMV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opses012=",QRYNAME
          IF        @EQUAL
            PACK      OPSES012,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optsm",QRYNAME
          IF        @EQUAL
            CALL      STTSM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppei001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPEI001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppei002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPEI002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppei003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPEI003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppei004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPEI004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppei005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPPEI005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nchrg",QRYNAME
          IF        @EQUAL
            CALL      STCHR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "brokn",QRYNAME
          IF        @EQUAL
            CALL      STBRK000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "provm",QRYNAME    * Contains CMBS Item Codes
          IF        @EQUAL
            CALL      STPRV000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mbscd",QRYNAME    * Contains CMBS Item Codes
          IF        @EQUAL
            CALL      STCMS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "count",QRYNAME    * Contains Counter
          IF        @EQUAL
            CALL      STCON000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "expit",QRYNAME    * Contains Expensive Item Codes
          IF        @EQUAL
            CALL      STIEX000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "quant",QRYNAME    * Contains Expensive Item Quantity
          IF        @EQUAL
            CALL      STQAN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extim001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTIM001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extim002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTIM002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rdtim001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RDTIM001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rdtim002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RDTIM002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dateflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DATEFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optqt001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTQT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optqt002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTQT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optqt003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTQT003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optqt004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTQT004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optqt005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPTQT005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printreg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTREG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dtrre001=",QRYNAME           * I CAR 40412
          IF        @EQUAL
            MOVE      QRYDATA,DTRRE001
            GOTO      SETPAR99
          ENDIF
.                                                 * end I CAR 40412
          MATCH     "surgtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SURGTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chrgpmbs=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,CHRGPMBS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prkey",QRYNAME
          IF        @EQUAL
            CALL      STPKY000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prqty",QRYNAME
          IF        @EQUAL
            CALL      STPQT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prflg",QRYNAME
          IF        @EQUAL
            CALL      STPFL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addrq",QRYNAME
          IF        @EQUAL
            CALL      STREQ000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "comments=",QRYNAME     * Joint Reg comments
          IF        @EQUAL
            CALL      GETCOM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "implantk=",QRYNAME
          IF        @EQUAL
            PACK      IMPLANTK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkregf=",QRYNAME
          IF        @EQUAL
            PACK      LINKREGF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprarkey=",QRYNAME                    * T0869563
          IF        @EQUAL
            PACK      OPRARKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showprov=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWPROV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "theacomp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THEACOMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thercomp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THERCOMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "irectype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IRECTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trannumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemn",QRYNAME
          IF        @EQUAL
            CALL      STITMN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "consm",QRYNAME
          IF        @EQUAL
            CALL      STCONS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstap",QRYNAME
          IF        @EQUAL
            CALL      STGSTA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcd",QRYNAME
          IF        @EQUAL
            CALL      STGSTC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "descp",QRYNAME
          IF        @EQUAL
            CALL      STITDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "camnt",QRYNAME
          IF        @EQUAL
            CALL      STAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpr",QRYNAME
          IF        @EQUAL
            CALL      PTAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rebpr",QRYNAME
          IF        @EQUAL
            CALL      RBAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "qunty",QRYNAME
          IF        @EQUAL
            CALL      STQUNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nodressg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NODRESSG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU002
            PACK      PTGTU002,PTGTU002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bokrx",QRYNAME
          IF        @EQUAL
            CALL      SPBKRX00
            GOTO      SETPAR99
          ENDIF
.
.
          MATCH     "recovful=",QRYNAME
          IF        @EQUAL
            PACK      RECOVFUL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exttoday=",QRYNAME
          IF        @EQUAL
            PACK      EXTTODAY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opraa",QRYNAME
          IF        @EQUAL
            CALL      SOPR0000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprtxtar=",QRYNAME
          IF        @EQUAL
            CALL      GETDES00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "stafflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STAFFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckreco=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHCKRECO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opcbd",QRYNAME
          IF        @EQUAL
            CALL      SCBD0000              * Caesarean Birth Details
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprcbuni=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPRCBUNI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprcbcnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPRCBCNT
            REP       "+ ",OPRCBCNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "harddelt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HARDDELT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdbcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDBCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savbcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVBCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dcuindic=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DCUINDIC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatmmb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATMMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inclexit=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INCLEXIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showadmt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWADMT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprci",QRYNAME
          IF        @EQUAL
            CALL      SOPRC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtlocn=",QRYNAME
          IF        @EQUAL
            PACK      FILTLOCN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printcls=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTCLS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "expexcel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXPEXCEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "username=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USERNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otatr",QRYNAME
          IF        @EQUAL
            CALL      SOTATR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "water",QRYNAME
          IF        @EQUAL
            CALL      SWATER00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "salin",QRYNAME
          IF        @EQUAL
            CALL      SSALIN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "haart",QRYNAME
          IF        @EQUAL
            CALL      SHAART00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "glyci",QRYNAME
          IF        @EQUAL
            CALL      SGLYCI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ringr",QRYNAME
          IF        @EQUAL
            CALL      SRINGR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "other",QRYNAME
          IF        @EQUAL
            CALL      SOTHER00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updopatr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDOPATR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diath",QRYNAME
          IF        @EQUAL
            CALL      SDIATH00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wound",QRYNAME
          IF        @EQUAL
            CALL      SWOUND00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "skini",QRYNAME
          IF        @EQUAL
            CALL      SSKINI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpo",QRYNAME
          IF        @EQUAL
            CALL      SPATPO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "posde",QRYNAME
          IF        @EQUAL
            CALL      SPOSDE00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "armbo",QRYNAME
          IF        @EQUAL
            CALL      SARMBO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "presr",QRYNAME
          IF        @EQUAL
            CALL      SPRESR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "skinp",QRYNAME
          IF        @EQUAL
            CALL      SSKINP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hairr",QRYNAME
          IF        @EQUAL
            CALL      SHAIRR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "othrc",QRYNAME
          IF        @EQUAL
            CALL      SOTHRC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "skiprecv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SKIPRECV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "speci",QRYNAME
          IF        @EQUAL
            CALL      SSPECI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "drain",QRYNAME
          IF        @EQUAL
            CALL      SDRAIN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "catht",QRYNAME
          IF        @EQUAL
            CALL      SCATHT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "irrig",QRYNAME
          IF        @EQUAL
            CALL      SIRRIG00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dresn",QRYNAME
          IF        @EQUAL
            CALL      SDRESN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "drssnind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DRSSNIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "counc",QRYNAME
          IF        @EQUAL
            CALL      SCOUNC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opsdt",QRYNAME
          IF        @EQUAL
            CALL      SOPSDT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jmphflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JMPHFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EREFRLID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cntdtail=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CNTDTAIL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcopy=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDCOPY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdefpn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETDEFPN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labeltyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABELTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemqnty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ITEMQNTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pacaflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PACAFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdate000=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11
            REP       "+ ",KEY11
            UNPACK    KEY11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      MDATE000,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "incty000=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INCTY000
            REP       "+ ",INCTY000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proce000=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCE000
            REP       "+ ",PROCE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCDESC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selcoccg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELCOCCG
            REP       "+ ",SELCOCCG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selcfavg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELCFAVG
            REP       "+ ",SELCFAVG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defaindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFAINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nowarnfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOWARNFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recovdur=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECOVDUR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcode=",QRYNAME
          IF        @EQUAL
            PACK      HOSPCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Caesarean Birth Details
.------------------------------------------------------------
SCBD0000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SCBD0001,SCBD0002,SCBD0003,SCBD0004,SCBD0005:
                       SCBD0006,SCBD0007,SCBD0008
.
          MOVE      ONE,EXIT
          GOTO      SCBD9999
.
SCBD0001  PACK      OPCBD001,QRYDATA,SP70   * Theatre unique ID
          GOTO      SCBD9999
.
SCBD0002  PACK      OPCBD002,QRYDATA,SP70   * Count
          GOTO      SCBD9999
.
SCBD0003  PACK      OPCBD003,QRYDATA,SP70   * Baby Sex
          GOTO      SCBD9999
.
SCBD0004  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      OPCBD004,CCENT,CYEAR,CMON,CDAY    * Date of Birth
          GOTO      SCBD9999
.
SCBD0005  PACK      OPCBD005,QRYDATA,SP70   * Time of Birth
          GOTO      SCBD9999
.
SCBD0006  PACK      OPCBD006,QRYDATA,SP70   * Baby U/R
          GOTO      SCBD9999
.
SCBD0007  PACK      OPCBD007,QRYDATA,SP70   * Birth Weight
          GOTO      SCBD9999
.
SCBD0008  PACK      OPCBD008,QRYDATA,SP70   * Placenta Delivery Time
          GOTO      SCBD9999
.
SCBD9999  RETURN
+
.------------------------------------------------------------
. Set parameters for item code
.------------------------------------------------------------
STITMN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITMN99 IF EQUAL
          PACK      ITEMN[F3],QRYDATA,SP70
STITMN99  RETURN
.
.------------------------------------------------------------
. Set parameters for consumption type items
.------------------------------------------------------------
STCONS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCONS99 IF EQUAL
          MOVE      QRYDATA,CONSM[F3]
STCONS99  RETURN
.
.------------------------------------------------------------
. Set parameters for GST Applicable
.------------------------------------------------------------
STGSTA00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STGSTA99 IF EQUAL
          MOVE      QRYDATA,GSTAP[F3]
STGSTA99  RETURN
.------------------------------------------------------------
. Set parameters for GST Code
.------------------------------------------------------------
STGSTC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STGSTC99 IF EQUAL
          PACK      GSTCD[F3],QRYDATA,SP70
STGSTC99  RETURN
.------------------------------------------------------------
. Set parameters for item description
.------------------------------------------------------------
STITDS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITDS99 IF EQUAL
          PACK      DESCP[F3],QRYDATA,SP70
STITDS99  RETURN
.
.------------------------------------------------------------
. Set parameters for item amount
.------------------------------------------------------------
STAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STAMNT99 IF EQUAL
          MOVE      QRYDATA,CAMNT[F3]
STAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item amount patient portion
.------------------------------------------------------------
PTAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      PTAMNT99 IF EQUAL
          MOVE      QRYDATA,PATPR[F3]
PTAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item amount rebate portion
.------------------------------------------------------------
RBAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      RBAMNT99 IF EQUAL
          MOVE      QRYDATA,REBPR[F3]
RBAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item quantity
.------------------------------------------------------------
STQUNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STQUNT99 IF EQUAL
          MOVE      QRYDATA,QUNTY[F3]
STQUNT99  RETURN
+
.******************************************************************************
.*                   Set cgi-parameters for Patient Implant Details Table     *
.******************************************************************************
SPPID000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          STORE     QRYDATA,F3,OPPIM001,OPPIM002,OPPIM003,OPPIM004,OPPIM005:
                               OPPIM006,OPPIM007,OPPIM008,OPPIM009,OPPIM010:
                               OPPIM011,OPPIM012
          IF        F3 = 1
            SQUEEZE   OPPIM001
            PACK      OPPIM001,OPPIM001,SP70
          ENDIF
          GOTO      SPPID999
.
SPPID999  RETURN
.******************************************************************************
.*                  Set Parameters For Implant Code Variables                 *
.******************************************************************************
STOPT000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          STORE     QRYDATA,F3,OPTHI001,OPTHI002,OPTHI003,OPTHI004,OPTHI005:
                               OPTHI006,OPTHI007,OPTHI008,OPTHI009,OPTHI010:
                               OPTHI011,OPTHI012
          IF        F3 = 1
            SQUEEZE   OPTHI001
            PACK      OPTHI001,OPTHI001,SP70
          ENDIF
.
STOPT999  RETURN
.******************************************************************************
.       Set Parameters For Prov.CMBS Code                                     *
.******************************************************************************
STPRV000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          IF        F3<=50
            PACK      PROVM[F3],QRYDATA,SP70
          ENDIF
.
STPRV999  RETURN
.******************************************************************************
.       Set Parameters For CMBS Code: Input Of CMBS Item Codes                *
.******************************************************************************
STCMS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          PACK      MBSCD[F3],QRYDATA,SP70
.
STCMS999  RETURN
.******************************************************************************
.                          Set Parameters For Counter                         *
.******************************************************************************
STCON000  MOVE      ZERO,EXIT
          ADD       ONE,SLOTINDX
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          PACK      COUNT[F3],QRYDATA,SP70
.
STCON999  RETURN
.******************************************************************************
.   Set Parameters For Input Expensive Code: Input Of Expensive Item Codes    *
.******************************************************************************
STIEX000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          PACK      EXPITKEY[F3],QRYDATA,SP70
.
STIEX999  RETURN
.******************************************************************************
.                          Set Parameters For Quantity                        *
.******************************************************************************
STQAN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          PACK      QUANTKEY[F3],QRYDATA,SP70
.
STQAN999  RETURN
.******************************************************************************
.                          Set Parameters for No Charge
.******************************************************************************
STCHR000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      QRYDATA,FORM1
          COMPARE   ONE,FORM1
          IF        @EQUAL
            MOVE      FORM1,NOCHARGE[F3]
          ENDIF
STCHR999  RETURN
.******************************************************************************
.                          Set Parameters for Broken/Unused
.******************************************************************************
STBRK000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      QRYDATA,FORM1
          COMPARE   ONE,FORM1
          IF        @EQUAL
            MOVE      FORM1,BROKENIT[F3]
          ENDIF
STBRK999  RETURN
.
+
.----------------------------------------------------------------
. Set Parameters for Requisition Detail Array
.----------------------------------------------------------------
STREQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      ADDREQDT[F3],QRYDATA,SP70
.
STREQ999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Preference Key Array
.----------------------------------------------------------------
STPKY000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      PREFTKEY[F3],QRYDATA,SP70
.
STPKY999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Preference Quantity Array
.----------------------------------------------------------------
STPQT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          MOVE      QRYDATA,PREFTQTY[F3]
.
STPQT999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Preference Flag Array
.----------------------------------------------------------------
STPFL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          MOVE      QRYDATA,PREFTFLG[F3]
.
STPFL999  RETURN
.
.*****************************************************************************
. Set Parameters for the Torniquet table
.*****************************************************************************
STTRQ000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STTRQ001,STTRQ002,STTRQ003,STTRQ004,STTRQ005:
                       STTRQ006
.
STTRQ001  MOVE      QRYDATA,OPTRQ001
          GOTO      STTRQ999
.
STTRQ002  MOVE      QRYDATA,OPTRQ002
          GOTO      STTRQ999
.
STTRQ003  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      OPTRQ003,CCENT,CYEAR,CMON,CDAY
          MATCH     QRYDATA,SP70           * Checking ApplDate if Null
          IF        @EQUAL
            MOVE     SP8,OPTRQ003
          ENDIF
          GOTO      STTRQ999
.
STTRQ004  MOVE      QRYDATA,OPTRQ004
          GOTO      STTRQ999
.
STTRQ005  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      OPTRQ005,CCENT,CYEAR,CMON,CDAY
          MATCH     QRYDATA,SP70           * Checking ApplDate if Null
          IF        @EQUAL
            MOVE     SP8,OPTRQ005
          ENDIF
          GOTO      STTRQ999
.
STTRQ006  MOVE      QRYDATA,OPTRQ006
          GOTO      STTRQ999
.
STTRQ999  RETURN
.*****************************************************************************
. Set Parameters for the Staff Member table
.*****************************************************************************
STTSM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STTSM001,STTSM002,STTSM003,STTSM004,STTSM005:
                       STTSM006,STTSM007,STTSM008,STTSM009,STTSM010
.
STTSM001  PACK      OPTSM001,SP1,QRYDATA
          GOTO      STTSM999
.
STTSM002  PACK      OPTSM002,QRYDATA,SP70
          GOTO      STTSM999
.
STTSM003  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      OPTSM003,CCENT,CYEAR,CMON,CDAY
          MATCH     QRYDATA,SP70           * Checking ApplDate if Null
          IF        @EQUAL
            MOVE     SP8,OPTSM003
          ENDIF
          GOTO      STTSM999
.
STTSM004  MOVE      QRYDATA,OPTSM004
          GOTO      STTSM999
.
STTSM005  PACK      QRYDATA,QRYDATA,SP70
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                * To Format Month
          PACK      OPTSM005,CCENT,CYEAR,CMON,CDAY
          MATCH     QRYDATA,SP70           * Checking ApplDate if Null
          IF        @EQUAL
            MOVE     SP8,OPTSM005
          ENDIF
          GOTO      STTSM999
.
STTSM006  MOVE      QRYDATA,OPTSM006
          PACK      OPTSM006,OPTSM006,SP70
          GOTO      STTSM999
.
STTSM007  MOVE      QRYDATA,OPTSM007
          GOTO      STTSM999
.
STTSM008  MOVE      QRYDATA,OPTSM008
          GOTO      STTSM999
.
STTSM009  MOVE      QRYDATA,OPTSM009
          GOTO      STTSM999
.
STTSM010  MOVE      QRYDATA,OPTSM010
          GOTO      STTSM999
.
STTSM999  RETURN
.******************************************************************************
.*                Main Action Routine for Theatre and Surgical Details        *
.******************************************************************************
OPRSRG00  CALL      VALCAS00
          BRANCH    EXIT,OPRSRG99
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRSRG80 IF EQUAL       * display theatre details
.
          MATCH     "A",UPDATETY            * add team
          GOTO      OPRSRG10 IF EQUAL
.
          MATCH     "U",UPDATETY            * update team
          GOTO      OPRSRG20 IF EQUAL
.
          MATCH     "D",UPDATETY            * delete team
          GOTO      OPRSRG30 IF EQUAL
.
          MATCH     "S",UPDATETY            * add staff member
          GOTO      OPRSRG40 IF EQUAL
.
          MATCH     "M",UPDATETY            * update staff member
          GOTO      OPRSRG50 IF EQUAL
.
          MATCH     "E",UPDATETY            * update staff member end date/time
          GOTO      OPRSRG55 IF EQUAL
.
          MATCH     "R",UPDATETY            * delete staff member
          GOTO      OPRSRG60 IF EQUAL
.
          MATCH     "F",UPDATETY            * add staff member freeformat
          GOTO      OPRSRG65 IF EQUAL
.
          MATCH     "O",UPDATETY            * update staff member freeformat
          GOTO      OPRSRG70 IF EQUAL
.
          MATCH     "T",UPDATETY            * delete staff member freeformat
          GOTO      OPRSRG75 IF EQUAL
.
          MATCH     "N",UPDATETY            * update staff member end date/time
          GOTO      OPRSRG78 IF EQUAL       * free format
.
          GOTO      OPRSRG91
.
OPRSRG10  CALL      ADDTMN00    *  Add Team 
          BRANCH    EXIT,OPRSRG99
.
          MOVE      OPDADATE,MMDATE
          MOVE      "014",TADTTYPE
          PROC      OPTHETAT             * write add team audit detail 
.
          CALL      WESE0000                * update Episode details
          PROC      PMSCURTH           * Update patient header theatre statu
          GOTO      OPRSRG99
.
OPRSRG20  CALL      UPDTMN00     * Update Team  
          BRANCH    EXIT,OPRSRG99
.
          MOVE      OPDADATE,MMDATE
          MOVE      "013",TADTTYPE
          PROC      OPTHETAT             * write update team audit detail 
.
          CALL      WESE0000                * update Episode details
          CALL      UARD0000
          CALL      UPCOM000
          CALL      UPODT000
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.
.******************************************************************************
.*                       Delete Team                                          *
.******************************************************************************
OPRSRG30  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RLOPSRG1                * locks the record for updating
          MOVE      "Surgical Members",TABLNAME
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      DEOPSRG1                * Deleting from surgical table
.
          CALL      DELPIM00                * Delete from Patient implant table 
.
          CALL      DELPEI00                * Delete Expensive Items
.
          CALL      DELPMB00                *  Delete CMBS Items     
.
          CALL      DELSTF00
.          
          CALL      ROPMIN00                * Recalculate Actual Op Min
.
          PROC      PMSCURTH           * Update patient header theatre statu
.
          ENDSET    REDIRECT
          APPEND    ONE,REDIRECT
          RESET     REDIRECT 
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Add Staff Member                                      *
.******************************************************************************
OPRSRG40  CALL      UPDTMN00
          BRANCH    EXIT,OPRSRG99
.
          MOVE      UNIQUEKY,OPDAUNIQ
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          COMPARE   ONE,OVRCD
          GOTO      OPRSRG96 IF NOT EQUAL
          CALL      CLOPRTSM
          CALL      SAVSTF00                * moving cgivar to file var
          CALL      WROPTSM1                * writing into staff members table
          PROC      PMSCURTH           * Update patient header theatre statu
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Update Staff Member                                   *
.******************************************************************************
OPRSRG50  MOVE      "Staff Member Table",TABLNAME 
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,SAVKEY01,SP70
          PACK      KEY35A,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          MATCH     KEY35A,KEY35
          GOTO      OPRSRG52 IF EQUAL
.
.
.         Check new key doesn't already exist
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          COMPARE   ZERO,OVRCD
          GOTO      OPRSRG96 IF EQUAL   
.         
.         Check old key still exists before updating
.         
OPRSRG52  PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,SAVKEY01,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      SAVSTF00
          CALL      UPOPTSM1                * updating the staff members table
          PROC      PMSCURTH           * Update patient header theatre statu
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Update Staff Member end date and time                 *
.******************************************************************************
OPRSRG55  MOVE      "Staff Member Table",TABLNAME 
          PACK      KEY35,OPDUNQID,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      IBACLOCK
          MOVE      CTIMEIS,OPTSETIM
.
          MOVE      CURRDATE,OPTSEDAT
.
          CALL      UPOPTSM1                * updating the staff members table
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
          PROC      PMSCURTH           * Update patient header theatre statu
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Delete Staff Member                                   *
.******************************************************************************
OPRSRG60  MOVE      "Staff Member Table",TABLNAME 
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      DEOPTSM1                * deleting the record from staff
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Add Staff Member Free Format                          *
.******************************************************************************
OPRSRG65  MATCH     "1",UPDOPSDT
          GOTO      OPRSRG99 IF NOT EQUAL
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004,OPSDT005,OPSDT006:
                          SP70
          CALL      RDOPSDT1
          IF        OVRCD=0
            GOTO      OPRSRG96
          ENDIF
.
          CALL      CLOPRSDT
          CALL      MVOPRSDT          
.
          CALL      WROPSDT1          
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.
.******************************************************************************
.*                      Update Staff Member Free Format                       *
.******************************************************************************
OPRSRG70  MATCH     "1",UPDOPSDT
          GOTO      OPRSRG99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,SAVKEY76,SP70
          PACK      KEY89A,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          MATCH     KEY89A,KEY89
          GOTO      OPRSRG72 IF EQUAL
.
.
.         Check new key doesn't already exist
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          COMPARE   ZERO,OVRCD
          GOTO      OPRSRG96 IF EQUAL
.
.         Check old key still exists before updating
.
OPRSRG72  PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,SAVKEY76,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      MVOPRSDT
          CALL      UPOPSDT1               
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                      Delete Staff Member Free Format                       *
.******************************************************************************
OPRSRG75  MATCH     "1",UPDOPSDT
          GOTO      OPRSRG99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          CALL      RDOPSDT1                * reading to check for existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      DEOPSDT1                * deleting the record from staff
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.
.******************************************************************************
.*                      Update Staff Member end date and timefree format      *
.******************************************************************************
OPRSRG78  MATCH     "1",UPDOPSDT
          GOTO      OPRSRG99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
          PACK      KEY89,OPDUNQFF,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          BRANCH    OVRCD,OPRSRG92,OPRSRG94
.
          CALL      IBACLOCK
          MOVE      CTIMEIS,OPSDETIM
.
          MOVE      CURRDATE,OPSDEDAT
.
          CALL      UPOPSDT1                * updating the staff members table
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
.
          MOVE      ZERO,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                     Display Theatre Details                                *
.******************************************************************************
OPRSRG80  CALL      THSRDT00              * read routine for display
          BRANCH    EXIT,OPRSRG99
.
          MOVE      "Theatre Case Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRSRG99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.******************************************************************************
.*                 Error Handling Section                                     *
.******************************************************************************
OPRSRG91  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG92  MOVE      "Record Doesn't Exist in",WEBTITLE
          MOVELPTR  WEBTITLE,F2
          ADD       ONE,F2
          RESET     WEBTITLE,F2
          APPEND    TABLNAME,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG93  MOVE      "Invalid Case Access",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG94  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG95  MOVE      "Applied Time must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG96  MOVE      "Record Already Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSRG99
.
OPRSRG99  RETURN
.******************************************************************************
UPPROC00  CALL      CLOPRTSM
          MATCH     Z70,OPDEA004
          IF        !@EQUAL
            MOVE      OPDEA004,OPDATYPE
          ENDIF
          MATCH     Z70,OPDEA006
          IF        !@EQUAL
            MOVE      OPDEA006,OPDAUSR1
          ENDIF
          MOVE      OPDEA014,OPDADES1
          MOVE      OPDEA015,OPDADES2 
          MOVE      OPDEA016,OPDADES3 
.
          MATCH     Z70,OPDEA020
          IF        !@EQUAL
            MOVE      OPDEA020,OPDAPRE1
          ENDIF
.
          MATCH     Z70,OPDEA021
          IF        !@EQUAL
            MOVE      OPDEA021,OPDAPRE2
          ENDIF
.
          MATCH     Z70,OPDEA022
          IF        !@EQUAL
            MOVE      OPDEA022,OPDAPRE3
          ENDIF
.
          MATCH     Z70,OPDEA023
          IF        !@EQUAL
            MOVE      OPDEA023,OPDAPRE4
          ENDIF
.
          MATCH     Z70,OPDEA024
          IF        !@EQUAL
            MOVE      OPDEA024,OPDAPRE5
          ENDIF
.
          MATCH     Z70,OPDEA025
          IF        !@EQUAL
            MOVE      OPDEA025,OPDAPOS1
          ENDIF
.
          MATCH     Z70,OPDEA026
          IF        !@EQUAL
            MOVE      OPDEA026,OPDAPOS2
          ENDIF
.
          MATCH     Z70,OPDEA027
          IF        !@EQUAL
            MOVE      OPDEA027,OPDAPOS3
          ENDIF
.
          MATCH     Z70,OPDEA028
          IF        !@EQUAL
            MOVE      OPDEA028,OPDAPOS4
          ENDIF
.
          MATCH     Z70,OPDEA030
          IF        !@EQUAL
            MOVE      OPDEA030,OPDAKNOW
          ENDIF
.
          MATCH     "1",PTCNPROS
          IF        @EQUAL
            MATCH     Z70,OPDEA043
            IF        !@EQUAL
              MOVE      OPDEA043,OPDAPCOM
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA044
          IF        !@EQUAL
            MOVE      OPDEA044,OPDADES4
          ENDIF
.
          MATCH     Z70,OPDEA045
          IF        !@EQUAL
            MOVE      OPDEA045,OPDADES5
          ENDIF
.
          MATCH     Z70,OPDEA046
          IF        !@EQUAL
            MOVE      OPDEA046,OPDADES6
          ENDIF
.
          MATCH     Z70,OPDEA049
          IF        !@EQUAL
            MOVE      OPDEA049,OPDAPRV4
          ENDIF
.
          MATCH     Z70,OPDEA050
          IF        !@EQUAL
            MOVE      OPDEA050,OPDAPRV5
          ENDIF
.
          MATCH     Z70,OPDEA051
          IF        !@EQUAL
            MOVE      OPDEA051,OPDAPRV6
          ENDIF
.
          CALL      IBACLOCK
          MOVE      CURRDATE,OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
.
          MOVE      ZERO,F2
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,F2,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,UPPROC99
          PACK      KEY13,OPTSUNID,OPTSTMNO,OPTSSIND
          MATCH     KEY13,KEY35
          GOTO      UPPROC99 IF NOT EQUAL
          MOVE      OPTSM007,OPTSSLEV
          CALL      UPOPTSM1
.
UPPROC99  RETURN
.******************************************************************************
.*        Delete records from Patient Implant Tables                          *
.******************************************************************************
DELPIM00  PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPIM1
          CALL      RKOPPIM1
          BRANCH    OVRCD,DELPIM99
          PACK      KEY11,OPPIUNID,OPPITMNO,SP70
          MATCH     KEY11,KEY13
          GOTO      DELPIM98 IF NOT EQUAL
          PACK      KEY13,KEY11,OPPICNTR,SP70
          CALL      DEOPPIM1
          GOTO      DELPIM00
.
DELPIM98  CALL      UUOPPIM1
          GOTO      DELPIM99     
.
DELPIM99  RETURN
.******************************************************************************
.*        Delete records from Patient Expensive Items Table                   *
.******************************************************************************
DELPEI00  PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPEI1
          CALL      RKOPPEI1
          BRANCH    OVRCD,DELPEI99
          PACK      KEY11,OPPEUNID,OPPETMNO,SP70
          MATCH     KEY11,KEY13
          GOTO      DELPEI98 IF NOT EQUAL
          PACK      KEY13,KEY11,OPPECNTR,SP70
          CALL      DEOPPEI1
          GOTO      DELPEI00
.
DELPEI98  CALL      UUOPPEI1
          GOTO      DELPEI99     
.
DELPEI99  RETURN
.******************************************************************************
.*        Delete records from CMBS Items Table                                *
.******************************************************************************
DELPMB00  PACK      KEY14,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB1
          CALL      RKOPPMB1
          BRANCH    OVRCD,DELPMB99
          PACK      KEY11,OPPMUNID,OPPMTMNO,SP70
          MATCH     KEY11,KEY14
          GOTO      DELPMB98 IF NOT EQUAL
          PACK      KEY14,KEY11,OPPMCNTR,SP70 
          CALL      DEOPPMB1
          GOTO      DELPMB00
.
DELPMB98  CALL      UUOPPMB1
          GOTO      DELPMB99     
.
DELPMB99  RETURN
.*****************************************************************************
.         Delete record from Staff File
.*****************************************************************************
DELSTF00  PACK      KEY35,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPTSM1
DELSTF10  CALL      RKOPTSM1
          BRANCH    OVRCD,DELSTF99
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      DELSTF99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPTSTMNO
          GOTO      DELSTF99 IF NOT EQUAL
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSSIND,OPTSSCDE,OPTSSDAT,OPTSSTIM
          CALL      DEOPTSM1
          GOTO      DELSTF10
.
DELSTF99  RETURN
.******************************************************************************
.*                Write a record to Tourniquet Table                         *
.******************************************************************************
WRTOQT00  MOVE      SP70,KEY10 
          MATCH     "5",RECORDTY
          IF        @EQUAL
            MOVE      ZERO,F2
            PACK      KEY13,OPDAUNIQ,FIVE,F2,SP70
            CALL      RDOPTQE1
            BRANCH    OVRCD,WRTOQT91
            MOVE      OPTQCOMM,KEY10
          ENDIF
.
          MATCH     "3",RECORDTY
          IF        @EQUAL
            MATCH     Z70,OPTQT002
            IF        !@EQUAL
              MOVE      OPTQT002,KEY10
            ENDIF
          ENDIF
.
          MATCH     "1",RECORDTY
          IF        @EQUAL
            MATCH     Z70,OPTQT003
            IF        !@EQUAL
              MOVE      OPTQT003,KEY10
            ENDIF
          ENDIF
.
          MATCH     "4",RECORDTY
          IF        @EQUAL
            MATCH     Z70,OPTQT004
            IF        !@EQUAL
              MOVE      OPTQT004,KEY10
            ENDIF
          ENDIF
.
          MATCH     "2",RECORDTY
          IF        @EQUAL
            MATCH     Z70,OPTQT005
            IF        !@EQUAL
              MOVE      OPTQT005,KEY10
            ENDIF
          ENDIF
.
          MOVE      RCOUNTER,COUNT1
          ADD       ONE,COUNT1
          MOVE      COUNT1,RCOUNTER
.
          PACK      KEY13,OPDAUNIQ,RECORDTY,RCOUNTER,SP70
          CALL      RDOPTQE1
          IF        OVRCD=0
            GOTO      WRTOQT90
          ELSE
            MOVE      SP70,OPTQUNID
            MOVE      SP70,OPTQRTYP
            MOVE      SP70,OPTQCNTR
          ENDIF
.
          MATCH     "5",RECORDTY
          IF        @EQUAL
            MOVE      OTHRAPPL,OPTQATIM
          ENDIF
          MOVE      OPDAUNIQ,OPTQUNID
          MOVE      RECORDTY,OPTQRTYP
          MOVE      RCOUNTER,OPTQCNTR
          MOVE      KEY10,OPTQCOMM
          MOVE      CURRDATE,OPTQADAT
          MOVE      SP70,OPTQRDAT
          MOVE      SP70,OPTQRTIM
.
          CALL      WROPTQE1                * writing to the tourniquete table
.
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT 
.
          MOVE      ZERO,EXIT
          GOTO      WRTOQT99
.
WRTOQT90  MOVE      "Record Already Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTOQT99
.
WRTOQT91  MOVE      "Tourniquet Text to be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTOQT99
.
WRTOQT99  RETURN 
.******************************************************************************
.*                Update a record of Tourniquete Table                         *
.******************************************************************************
UPTOQT00  PACK      KEY13,OPDAUNIQ,RECORDTY,RCOUNTER,SP70
          CALL      RLOPTQE1
          BRANCH    OVRCD,UPTOQT91,UPTOQT90
.
          MOVE      CURRDATE,OPTQRDAT
.
          MATCH     SP70,RLEGREMV
          IF        !@EQUAL
            MOVE      RLEGREMV,OPTQRTIM
          ENDIF
          MATCH     SP70,LLEGREMV
          IF        !@EQUAL
            MOVE      LLEGREMV,OPTQRTIM
          ENDIF
          MATCH     SP70,RARMREMV
          IF        !@EQUAL
            MOVE      RARMREMV,OPTQRTIM
          ENDIF
          MATCH     SP70,LARMREMV
          IF        !@EQUAL
            MOVE      LARMREMV,OPTQRTIM
          ENDIF
          MATCH     SP70,OTHRREMV
          IF        !@EQUAL
            MOVE      OTHRREMV,OPTQRTIM
          ENDIF
.
          MATCH     SP70,CARTREMV
          IF        !@EQUAL
            MOVE      CARTREMV,OPTQRTIM
          ENDIF
.
          MATCH     SP70,AORTREMV
          IF        !@EQUAL
            MOVE      AORTREMV,OPTQRTIM
          ENDIF
.
          CALL      UPOPTQE1                * updating the tourniquete table
          CALL      UUOPTQE1
.
          MOVE      TEAMNUMB,F1
          ENDSET    REDIRECT
          APPEND    F1,REDIRECT
          RESET     REDIRECT 
.
          MOVE      ZERO,EXIT
          GOTO      UPTOQT99
.
UPTOQT90  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPTOQT99
.
UPTOQT91  MOVE      "Applied Time must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPTOQT99
.
UPTOQT99  RETURN        
.******************************************************************************
.*                      Add Team                                              *
.******************************************************************************
ADDTMN00  PACK      KEY11,OPDAUNIQ,Z70
          CALL      RSOPSRG1                * reading surgical table
          CALL      RPOPSRG1
          BRANCH    OVRCD,ADDTMN10
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      ADDTMN10 IF NOT EQUAL
.
          MOVE      OPSGTMNO,F1
          ADD       ONE,F1
          CALL      CLOPRSRG
          GOTO      ADDTMN20
.
ADDTMN10  MOVE      "1",F1
          CALL      CLOPRSRG
          CALL      MVOPSG00                * moving cgi variables to file var
          PROC      PREVTIME
          BRANCH    EXIT,ADDTMN90,ADDTMN91
...       CALL      MBSCHK00                * Default MBS from Detail File
          CALL      UPPROC00
.
ADDTMN20  MOVE      F1,OPSGTMNO
          MOVE      OPDAUNIQ,OPSGUNID
          PACK      KEY11,OPDAUNIQ,F1,SP70
          CALL      RAOPSRG1                * Check if record already exists
          COMPARE   ZERO,OVRCD
          GOTO      ADDTMN00 IF EQUAL
.
          CALL      WROPSRG1              * writing to the surgical table
          MOVE      F1,TEAMNUMB
          CALL      DFLTTM00              * Write Default Team members
          CALL      UPDSES00
.
          ENDSET    REDIRECT
          APPEND    F1,REDIRECT
          RESET     REDIRECT 
          GOTO      ADDTMN99
.
ADDTMN90  MOVE      "Surgery start time cannot be before previous end time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      ADDTMN99                
. 
ADDTMN91  MOVE      "Previous end time required.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      ADDTMN99                
. 
ADDTMN99  RETURN
.******************************************************************************
.*                      Update Team                                           *
.******************************************************************************
UPDTMN00  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RLOPSRG1               * locks the record for updating
          BRANCH    OVRCD,UPDTMN10,UPDTMN92
          GOTO      UPDTMN20
.
UPDTMN10  MATCH     "1",TEAMNUMB
          GOTO      UPDTMN91 IF NOT EQUAL
          MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          CALL      CLOPRSRG
          MOVE      ZERO,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00
          PROC      PREVTIME
          BRANCH    EXIT,UPDTMN90,UPDTMN93
          CALL      WROPSRG1
          CALL      DFLTTM00                * Write Default Team members
...       CALL      MBSCHK00
          GOTO      UPDTMN30
.
UPDTMN20  MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          MOVE      ONE,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00                * moving cgi variables to file var
          PROC      PREVTIME
          BRANCH    EXIT,UPDTMN90,UPDTMN93
          CALL      UPOPSRG1                * updating surgical details
          CALL      UUOPSRG1                * unlock the record
.
UPDTMN30  CALL      UPPROC00
          CALL      UPDSES00
.
          MATCH     "1",UPDATMMB
          IF        @EQUAL
            CALL      UPMMB000              * update "patmmbsf" Start/End times
          ENDIF
.
          IF        RECOPMIN=ONE
            CALL      ROPMIN00              * Recalculate Actual Op Minutes.
          ENDIF
.
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT 
.
          MOVE      ZERO,EXIT
          GOTO      UPDTMN99
.
UPDTMN90  MOVE      "Surgery start time cannot be before previous end time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      UPDTMN99                
. 
UPDTMN91  MOVE      "Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTMN99
.
UPDTMN92  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTMN99
.
UPDTMN93  MOVE      "Previous end time required.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      UPDTMN99                
. 
UPDTMN99  RETURN
******************************************************************************
.*               Moving cgi parameters to the staff table file variables      *
.******************************************************************************
SAVSTF00  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      OPTSM001,OPTSSIND
          MOVE      OPTSM003,OPTSSDAT
          MOVE      OPTSM002,OPTSSCDE
          MOVE      OPTSM004,OPTSSTIM
          MOVE      OPTSM005,OPTSEDAT
          MOVE      OPTSM006,OPTSETIM
          MOVE      OPTSM008,OPTSSTYP
          MOVE      OPTSM009,OPTSINST
          MOVE      OPTSM010,OPTSUY01
.
SAVSTF99  RETURN
.*************************************************************************
. Default Consultant as Operating Surgeon in Staff Member List
. CLOPRTSM should be called before this routine to clear the fields
.*************************************************************************
SAVSUR00  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      ZERO,OPTSSIND
          MOVE      OPDACLIN,OPTSSCDE
          MOVE      OPDADATE,OPTSSDAT
          MOVE      OPCNSTCT,OPTSSTYP
          PACK      OPTSSTIM,OPDAEXPS,SECONDS
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
          CALL      RDOPTSM1
          COMPARE   ZERO,OVRCD
          GOTO      SAVSRG99 IF EQUAL
          CALL      WROPTSM1
SAVSRG99  RETURN
.
.*************************************************************************
. Write Default Team members from Session file. If no default team specified
. then default Consultatnt as Operating Surgeon.
.*************************************************************************
DFLTTM00  PACK      KEY22,CASEKEYS
          CALL      RDOPSES1
          BRANCH    OVRCD,DFLTTM99
.
          MATCH     SP70,OPSEDCC1           * Default team empty?
          GOTO      DFLTTM90 IF EQUAL       * Yes, default Cons as Op.Surgeon
.
          CALL      CLOPRTSM
          MOVE      ZERO,STAFTYPE           * Set Staff Type (Operating Surg)
          MOVE      OPSEDCC1,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD1,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
          MATCH     SP70,OPSETYD2           * Second default doctor type blank?
          GOTO      DFLTTM10 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC2           * Second default doctor code blank?
          GOTO      DFLTTM10 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC2,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD2,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM10  MATCH     SP70,OPSETYD3           * Next default doctor type blank?
          GOTO      DFLTTM15 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC3           * Next default doctor code blank?
          GOTO      DFLTTM15 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC3,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD3,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM15  MATCH     SP70,OPSETYD4           * Next default doctor type blank?
          GOTO      DFLTTM20 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC4           * Next default doctor code blank?
          GOTO      DFLTTM20 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC4,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD4,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM20  MATCH     SP70,OPSETYD5           * Next default doctor type blank?
          GOTO      DFLTTM25 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC5           * Next default doctor code blank?
          GOTO      DFLTTM25 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC5,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD5,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM25  MATCH     SP70,OPSETYD6           * Next default doctor type blank?
          GOTO      DFLTTM30 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC6           * Next default doctor code blank?
          GOTO      DFLTTM30 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC6,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD6,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM30  MATCH     SP70,OPSETYD7           * Next default doctor type blank?
          GOTO      DFLTTM35 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC7           * Next default doctor code blank?
          GOTO      DFLTTM35 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC7,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD7,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM35  MATCH     SP70,OPSETYD8           * Next default doctor type blank?
          GOTO      DFLTTM40 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC8           * Next default doctor code blank?
          GOTO      DFLTTM40 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC8,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD8,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM40  MATCH     SP70,OPSETYN1           * First default nurse type blank?
          GOTO      DFLTTM45 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC1           * First default nurse code blank?
          GOTO      DFLTTM45 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC1,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN1,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM45  MATCH     SP70,OPSETYN2           * Next default nurse type blank?
          GOTO      DFLTTM50 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC2           * Next default nurse code blank?
          GOTO      DFLTTM50 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC2,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN2,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM50  MATCH     SP70,OPSETYN3           * Next default nurse type blank?
          GOTO      DFLTTM55 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC3           * Next default nurse code blank?
          GOTO      DFLTTM55 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC3,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN3,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM55  MATCH     SP70,OPSETYN4           * Next default nurse type blank?
          GOTO      DFLTTM60 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC4           * Next default nurse code blank?
          GOTO      DFLTTM60 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC4,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN4,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM60  MATCH     SP70,OPSETYN5           * Next default nurse type blank?
          GOTO      DFLTTM65 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC5           * Next default nurse code blank?
          GOTO      DFLTTM65 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC5,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN5,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM65  MATCH     SP70,OPSETYN6           * Next default nurse type blank?
          GOTO      DFLTTM99 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC6           * Next default nurse code blank?
          GOTO      DFLTTM99 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC6,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN6,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
          GOTO      DFLTTM99
.
DFLTTM90  CALL      CLOPRTSM
          MOVE      TEAMNUMB,F1
          CALL      SAVSUR00                * Write Cons as Operating Surgeon
.
DFLTTM99  RETURN
.
.*****************************************************************************
.                  Save (Write) Deafult Team Member
.*****************************************************************************
SAVDFL00  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      STAFTYPE,OPTSSIND
          MOVE      OPDADATE,OPTSSDAT
          PACK      OPTSSTIM,OPDAEXPS,SECONDS
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
          CALL      RDOPTSM1
          COMPARE   ZERO,OVRCD
          GOTO      SAVDFL99 IF EQUAL
          CALL      WROPTSM1
.
SAVDFL99  RETURN
.
.******************************************************************************
.*                  Theatre Details Display Routine                           *
.******************************************************************************
THSRDT00  MOVE      ZERO,F1
          CALL      CLOPRSRG                 * clearing surgical file variables
          CALL      CLOPRTQE                 * clearing tourniquet file vars
.
          MATCH     "4",TEMPLATE
          GOTO      THSRDT10 IF EQUAL
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                 * arrival/recovery details
          BRANCH    OVRCD,THSRDT90
.
          MATCH     SP70,OPDAANAE
          GOTO      THSRDT04 IF EQUAL
. 
          MOVE      "OA",CATEGORY
          PACK      KEY5,CATEGORY,OPDAANAE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,THSRDT04
.
          MATCH     "5",TCINDC1
          GOTO      THSRDT06 IF EQUAL 
.
THSRDT04  MATCH     SP70,OPARANAS
          GOTO      THSRDT93 IF EQUAL
.
THSRDT06  MATCH     "S",SUPRLEVL
          GOTO      THSRDT10 IF EQUAL
.
          MATCH     "1",SKIPRECV
          IF        !@EQUAL
            MATCH     SP70,OPARTIRF
            GOTO      THSRDT92 IF NOT EQUAL
            MATCH     SP70,OPARTIRD
            GOTO      THSRDT92 IF NOT EQUAL
          ENDIF
.
THSRDT10  RESET     TEAMNUMB
          MATCH     SP70,TEAMNUMB
          IF        @EQUAL
            MOVE      "1",TEAMNUMB
          ENDIF
.
          MOVE      SP70,PREPTIME
          MOVE      SP70,DRESTIME
          MOVE      SP70,SUSTTIME
          MOVE      SP70,SUENTIME
          MOVE      SP70,DELYTIME
          MOVE      SP70,COUNTCOR
          MOVE      SP70,COUNTDPS
          MOVE      SP70,INFCCONT
          MOVE      SP70,SURGCODE
          MOVE      SP70,SURGLEVL
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          CALL      SESDET00
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70   * reading surgical table
          CALL      RDOPSRG1
          BRANCH    OVRCD,THSRDT30
.
THSRDT20  MOVE      OPSGTIPS,PREPTIME
          MOVE      OPSGTIDR,DRESTIME
          MOVE      OPSGTISS,SUSTTIME
          MOVE      OPSGTISE,SUENTIME
          MOVE      OPSGSGDL,DELYTIME
          MOVE      OPSGCCNT,COUNTCOR
          MOVE      OPSGDCK1,COUNTDPS
          MOVE      OPSGCNTO,OPRTNAME
          MOVE      OPSGINFC,INFCCONT
.
THSRDT30  PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=1
            MOVE      SP70,OPDADES1
            MOVE      SP70,OPDADES2
            MOVE      SP70,OPDADES3 
          ENDIF
.
          MOVE      OPDAUNIQ,DIM10
          PROC      PREVTHET
.
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1                * reading thetre operating room
          BRANCH    OVRCD,THSRDT91
.
          PACK      KEY8,OPDAADMN,SP70 
          CALL      RDMISS1
          IF        OVRCD=0
            IF        ASTAT=3
              PACK      KEY8,OPDAADMN,SP70
              CALL      RDDSCH1
              IF        OVRCD=1
                CALL      CLPATDSC
              ENDIF
            ENDIF
          ELSE
            CALL    CLPATMIS
          ENDIF
.
          MATCH     SP70,OPTSM001
          GOTO      THSRDT40 IF NOT EQUAL
          MOVE      ZERO,F2
THSRDT31  PACK      KEY35,OPDAUNIQ,TEAMNUMB,F2,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,THSRDT50
          PACK      KEY13,OPTSUNID,OPTSTMNO,OPTSSIND
          MATCH     KEY13,KEY35
          IF        @EQUAL
            MOVE      OPTSSCDE,SURGCODE
            MOVE      OPTSSLEV,SURGLEVL
          ENDIF
          CALL      CLOPRTSM
          GOTO      THSRDT50
.
THSRDT40  PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004
          CALL      RDOPTSM1
          IF        OVRCD=1
            CALL      CLOPRTSM
          ENDIF
          PACK      SAVKEY01,OPTSSCDE,OPTSSDAT,OPTSSTIM
          GOTO      THSRDT50 
.
THSRDT50  MATCH     "1",UPDOPSDT
          GOTO      THSRDT99 IF NOT EQUAL
.
          CALL      CLOPRSDT
.
          MATCH     SP70,OPSDT001
          GOTO      THSRDT99 IF EQUAL
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004,OPSDT005:
                          OPSDT006,SP70
          CALL      RDOPSDT1
          IF        OVRCD=1
            CALL      CLOPRSDT
          ENDIF
          PACK      SAVKEY76,OPSDSNAM,OPSDSDAT,OPSDSTIM
.
          GOTO      THSRDT99
.
THSRDT90  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THSRDT99
.
THSRDT91  MOVE      "Theatre Operating Room Details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THSRDT99
.
THSRDT92  MOVE      "Patient in Recovery.Cannot change Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THSRDT99
.
THSRDT93  MOVE      "Anaesthetic Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THSRDT99
.
THSRDT99  RETURN
.------------------------------------------------------------
. Get Details for Session
.------------------------------------------------------------
SESDET00  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,SESSDATE
          MOVE      OPSECLIN,CLINCODE
.
          COMPARE   ZERO,OPCNCLSU
          GOTO      SESDET10 IF NOT EQUAL
.
          PACK      KEY6,OPSECLIN,SP70
          CALL      RDOPCLI1
          IF        OVRCD=0
.
            MATCH     SP70,OPCLDOCT
            IF        @EQUAL | @EOS
              MOVE      OPCLDESC,SURFNAME
            ELSE
              PACK      KEY6,OPCLDOCT,SP70
              CALL      RDDOCT1
              IF        OVRCD=0
                MOVE      DTITL,FMTTITLE
                MOVE      DGNAME,FMTGNAME
                MOVE      DSNAME,FMTSNAME
                CALL      DOCNM000
                MOVE      DOCFNAME,SURFNAME
                MOVE      OPCLDOCT,SURGCODE
              ELSE
                MOVE      "&nbsp;",SURFNAME
              ENDIF
.
            ENDIF
.
          ELSE
            MOVE      "&nbsp;",SURFNAME
          ENDIF
.
          GOTO      SESDET20
.
SESDET10  MOVE      OPSECLIN,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,SURFNAME
            MOVE      OPSECLIN,SURGCODE
          ELSE
            MOVE      "&nbsp;",SURFNAME
          ENDIF
.
SESDET20  MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,ANAFNAME
          ELSE
            MOVE      "&nbsp;",ANAFNAME
          ENDIF
.
          MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      OPRMDESC,NAME35
            CALL      NAMSTR00
            RESET     DISPNAME
            PACK      OPRMDESC,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",OPRMDESC
          ENDIF
          MOVE      "&nbsp;",STYPDES
          PACK      KEY5,CODEST,OPSETYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,STYPDES
          ENDIF
SESDET99  RETURN
.*******************************************************************************
. Check for Provisional MBS Items in "oprdetaf" detail file
.*******************************************************************************
MBSCHK00  MOVE      ZERO,F2
.
          REPEAT
            ADD       ONE,F2
            LOAD      KEY9,F2,OPDAPROV,OPDAPRV2,OPDAPRV3
            MATCH     SP70,KEY9
            IF        !@EQUAL
              CALL      WPMB0000            * Write record to oprpmbaf file
            ENDIF
          UNTIL     F2 = 3
.
.         Check extra MBS codes
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
MBSCHK20  CALL      RKOPMBS1
          BRANCH    OVRCD,MBSCHK99
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      MBSCHK99 IF NOT EQUAL
.
          MOVE      OPMBMBSI,KEY9
          CALL      WPMB0000            * Write record to oprpmbaf file
          GOTO      MBSCHK20
.
MBSCHK99  RETURN
+
.*******************************************************************************
.         Write record to oprpmbaf
.*******************************************************************************
WPMB0000  CALL      WRTMBS00            * set up "oprpmbaf" record
          BRANCH    EXIT,WPMB9999       * has reached the maximum
.
          MOVE      ONE,F4
          MOVE      F4,OPPMSERV         * set quantity to one FOR Prov.
          MOVE      ZERO,OPPMGSTA
          MOVE      SP70,OPPMGSTC
          MOVE      SP70,OPPMREFN
.
          MOVE      KEY9,OPPMCMBS
          CALL      WROPPMB1            * write "oprpmbaf" record
.
          PACK      IDESC,SP70
.                                           * key is KEY9 for PATITMRD
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD            * get MBS Item description
.
          CALL      WRTMMB00            * set up "patmmbsf" item record
          BRANCH    EXIT,WPMB9999       * has reached the maximum
.
          MOVE      KEY9,MMCODE
          CALL      WRMMBS1             * write "patmmbsf" record
WPMB9999  RETURN
+
.*******************************************************************************
.         Posting STV Prov.MBS
.*******************************************************************************
STVMBS00  MOVE      ZERO,COUNTM
.
STVMBS10  ADD       ONE,COUNTM
          COMPARE   "51",COUNTM
          GOTO      STVMBS99 IF NOT LESS
.
          UNPACK    SP70,UNIQUEKY,KEY9
          MOVE      PROVM[COUNTM],KEY19
          PACK      KEY19,KEY19,SP70
          UNPACK    KEY19,UNIQUEKY,KEY9
.
          MATCH     SP70,KEY9
          GOTO      STVMBS10 IF EQUAL
.
          CALL      WRTMBS00            * set up "oprpmbaf" record
          BRANCH    EXIT,STVMBS99       * has reached the maximum
.
          MOVE      ONE,F4
          MOVE      F4,OPPMSERV         * set quantity to one for Prov.
          MOVE      ZERO,OPPMGSTA
          MOVE      SP70,OPPMGSTC
          MOVE      SP70,OPPMREFN
.
          MOVE      KEY9,OPPMCMBS
          CALL      WROPPMB1            * write "oprpmbaf" record
.
          PACK      IDESC,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD            * get MBS Item description
.
          IF        OPCNMREC=1
            CALL      WRTMMB00      * CAR 242253 - only write here if it is
            MOVE      KEY9,MMCODE   * not going to get written in next function
            BRANCH    EXIT,STVMBS99 * has reached the maximum
.
            CALL      WRMMBS1       * which is USMMB000
          ENDIF
          GOTO      STVMBS10
.
STVMBS99  RETURN
+
.*******************************************************************************
. Write MBS file 
.*******************************************************************************
WRTMBS00  MOVE      ZERO,EXIT
          PACK      KEY14,OPDAUNIQ,ONE,Z70
          CALL      RAOPPMB1
          CALL      RPOPPMB1
          BRANCH    OVRCD,WRTMBS05
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      WRTMBS10 IF EQUAL

WRTMBS05  MOVE      ONE,OPPMCNTR
          GOTO      WRTMBS20
.
WRTMBS10  COMPARE   "999",OPPMCNTR
          GOTO      WRTMBS90 IF EQUAL       * has reached the maximum
          ADD       ONE,OPPMCNTR            * set "oprpmbaf" unique count
.
WRTMBS20  MOVE      OPDAUNIQ,OPPMUNID
          MOVE      ONE,OPPMTMNO            * default Team no. to "1"
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR
          GOTO      WRTMBS99
.
WRTMBS90  MOVE      ONE,EXIT
WRTMBS99  RETURN
.*******************************************************************************
. Write MBS file to patmmbsf file
.*******************************************************************************
WRTMMB00  MOVE      ZERO,EXIT
          OPEN      PATMMBS1,"patmmbsf"
          MOVE      ZERO,MMRECN
          PACK      KEY11,OPDAADMN,Z70
          CALL      RDSMMBS1
          CALL      RDPMMBS1
          BRANCH    OVRCD,WRTMMB10
.
          MATCH     OPDAADMN,DMMADMN 
          GOTO      WRTMMB10 IF EQUAL
.
          MOVE      ONE,MMRECN
          GOTO      WRTMMB20
.
WRTMMB10  COMPARE   "999",MMRECN
          GOTO      WRTMMB90 IF EQUAL       * has reached the maximum
          ADD       ONE,MMRECN
.
WRTMMB20  MOVE      OPDAADMN,MMADMN
          MOVE      OPDADATE,MMDATE
          MOVE      OPSGTISS,MMSTIM         * default - surgical start time
          MOVE      OPSGTISE,MMETIM
.
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,WRTMMB30
.
          CALL      RCVT0000                * determine time in recovery
.
.                                           * load Start time from selected
          LOAD      MMSTIM,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
.                                           * load End time from selected
          LOAD      MMETIM,OPCNTTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
.
WRTMMB30  MOVE      IDESC,PTMMDESC
          PACK      PTMMOPID,OPDAUNIQ,SP10  * theatre unique no.      *I-207386
          PACK      PTMMTMNO,OPPMTMNO,SP1   * theatre Team No.        *I-207386
          PACK      MMSPARE,SP70
.
          PACK      KEY11,MMADMN,MMRECN
          CALL      RDMMBS1
          COMPARE   ZERO,OVRCD
          GOTO      WRTMMB10 IF EQUAL       * get a new MMRECN number
.
          CALL      WESE0000                * update Episode details
          GOTO      WRTMMB99
.
WRTMMB90  MOVE      ONE,EXIT
WRTMMB99  RETURN
+
.*******************************************************************************
. Update Actual session end date
.*******************************************************************************
UPDSES00  PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,UPDSES99
.
          MOVE      OPSEDATE,OPSEACDE
.
. If DATEFLAG=1 then surgery ends on next day else on same day.
.
          MATCH     "1",DATEFLAG
          IF        @EQUAL
            CALL      NXTDAT00
          ENDIF
          CALL      UPOPSES1
UPDSES99  RETURN
.*******************************************************************************
. Calculate next date 
.*******************************************************************************
NXTDAT00  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      CYY,JWKYER
          MOVE      CCC,JWKCC
          CALL      JULCON
.
          PACK      OPSEACDE,CC,YY,MM,DD
          REP       " 0",OPSEACDE
NXTDAT99  RETURN
.******************************************************************************
.*                      Input Theatre CMBS                                    *
.******************************************************************************
OPRICM00  COMPARE   ONE,ONCOLOGY
          GOTO      OPRICM05 IF EQUAL
.
          CALL      VALCAS00                     * Validate Case Keys
          BRANCH    EXIT,OPRICM99
          GOTO      OPRICM10
.
OPRICM05  MATCH     Z70,BKUNQ001                 * Oncology
          IF        !@EQUAL
            PACK      KEY18,BKUNQ001,SP70
          ELSE
            PACK      KEY18,ADMISSNO,SP70
          ENDIF
.
          CALL      RSBKUNQ1                     * Check for record
          CALL      RKBKUNQ1
          BRANCH    OVRCD,OPRICM93
.
          MATCH     Z70,BKUNQ001
          IF        !@EQUAL
            MATCH     BKUNQ001,BKUNVISN
          ELSE
            MATCH     ADMISSNO,BKUNVISN
          ENDIF
          GOTO      OPRICM93 IF NOT EQUAL
.
          CALL      CLOPRDEA
          PACK      OPDAUNIQ,BKUNUNIQ,SP70
          MOVE      ADMISSNO,OPDAADMN
          MATCH     SP70,BKUNLADM
          IF        !@EQUAL
            PACK      OPDAADMN,BKUNLADM,SP70
          ENDIF          
          MOVE      ONE,TEAMNUMB
.
          MOVE      CURRDATE,OPDADATE
          MOVE      ADMISSNO,KEY8
          MATCH     SP70,BKUNLADM
          IF        !@EQUAL
            PACK      KEY8,BKUNLADM,SP70
          ENDIF
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ADATE,OPDADATE
            IF        ASTAT=3
              CALL      RDDSCH1
              IF        OVRCD=0
                MOVE      DDATE,OPDADATE
              ENDIF
            ENDIF
          ENDIF
          REP       " 0",OPDADATE
.
OPRICM10  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Arrival/recovery Details
          BRANCH    OVRCD,OPRICM91 
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical details
          BRANCH    OVRCD,OPRICM92
.
          CALL      ALLMBS00                * Get total no of Theatre MBS 
          CALL      MBSBIL00                * Check for billed MBS Items
          CALL      GETMBS00                * Get Theatre MBS Details
          MATCH     SP70,MBSFCODE           * Save code of first MBS Item
          IF        @EQUAL
            MOVE      OPDAPROV,MBSFCODE
          ENDIF
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRICM20 IF EQUAL       * Display page
.
          MATCH     "A",UPDATETY            * Add Records
          GOTO      OPRICM15 IF EQUAL
.
          MATCH     "B",UPDATETY            * Add MBS or Misc Item
          GOTO      OPRICM12 IF EQUAL
.
          GOTO      OPRICM90
.
OPRICM12  MOVE      ONE,F1                *  to open misc.audit file
.
          CALL      AMISC000              * Add Misc.items
          COMPARE   ZERO,MBSITEMN
          GOTO      OPRICM19 IF EQUAL     *  No MBS item entered
.
          MOVE      MBSITEMN,SLOTINDX
          MOVE      ONE,CHRGPMBS          * charging Prov.MBS items
          MOVE      ONE,OPCNCHMB          * to close item audit file
.
          GOTO      OPRICM17
.
OPRICM15  MOVE      ZERO,F1
.         MOVE      ONE,CHRGPMBS
.
OPRICM17  MOVE      ONE,INVOICED            * Set as none invoiced
          MOVE      ZERO,TOTMMBS
          MOVE      ZERO,TOTDTRA
.
          CALL      ADCMBS00                * Add Theatre CMBS Items  
.
          CALL      USIMB000                * get the initial patmmbs 
          CALL      USGIM000                * locate any existing items records
.
          CALL      USMBS000              * Set up patient MBS Account
.
          CALL      USMMB000              * Write MBS Code to medical records
.
.                             * check Start & End times for Warnings
          CALL      RCVT0000              * determine time in recovery
.
          MOVE      SP70,DIM5
          MATCH     "1",DCUINDIC
          IF        @EQUAL
            MOVE      OPSGTISS,DIM5
          ELSE
            LOAD      DIM5,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
          ENDIF
.
          MATCH     SP70,DIM5
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning - Operation Start Time is blank.",WEBWRN[WARNCNT]
          ENDIF
.
          MOVE      SP70,DIM5
          MATCH     "1",DCUINDIC
          IF        @EQUAL
            MOVE      OPSGTISE,DIM5
          ELSE
            LOAD      DIM5,OPCNTTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
          ENDIF
.
          MATCH     SP70,DIM5
          IF        @EQUAL
            MATCH     SP1,NOWARNFL        * Show warning message 
            IF        @EQUAL    
              ADD       ONE,WARNCNT
              MOVE      "Warning - Operation End Time is blank.",WEBWRN[WARNCNT]
            ENDIF
          ENDIF
.
          COMPARE   ZERO,OPCNCHMB
          GOTO      OPRICM19 IF EQUAL
.
OPRICM19  CALL      ERRLST00
          MOVE      ONE,EXIT
          MOVE      "017",TADTTYPE            * write theatre item audit detail
          PROC      OPTHETAT
.
          GOTO      OPRICM99
.
.****************************************************************************
.  Display Theatre CMBS Items
.****************************************************************************
OPRICM20  CLEAR     WEBTITLE
          MOVE      "Input Theatre CMBS Items",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRICM99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ZERO,F3
          MOVE      ONE,EXIT
          GOTO      OPRICM99
.******************************************************************************
*                    Error Handling(INPUT THEATRE CMBS ITEMS)                 *
.******************************************************************************
OPRICM90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRICM99
.
OPRICM91  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRICM99
.
OPRICM92  MOVE      "Theatre Details must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRICM99
.
OPRICM93  MOVE      "Invalid Booking record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRICM99
.
OPRICM99  RETURN
+
.******************************************************************************
.                Add Misc.items
.******************************************************************************
AMISC000  MOVE      ZERO,MBSITEMN             * Number of Misc.items
          MOVE      SP70,MCHARGE
          MOVE      ZERO,EXPCHCNT             * Initialise exploding charge cnt
          MOVE      ONE,F3
.
          MOVE      OPDAADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,AMISC999            * not an admission so don't write
          BRANCH    ASTAT,AMISC999            * a pre-admission so don't write
.
.                                             * Multi-hospital
          IF        IBCNMHOS=1                
            MOVE      SP10,PMVXMHOS
            MOVE      OPDAADMN,KEY8
            CALL      RDPMVX11
            MOVE      SP10,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
          ENDIF
.
          WHILE     F3<=SLOTINDX
            MOVE      ITEMN[F3],MCHARGE
            MATCH     SP70,MCHARGE
            IF        !@EQUAL
              PACK      KEY9,MCHARGE,SP70
              PACK      KEY17,KEY9,OPDADATE,SP70
              CALL      PATITMRD
              IF        OVRCD=1
                CALL      GETMSC00            * Check for a valid Misc.Charge
                IF        EXIT=0
                  ADD       ONE,EXPCHCNT      * Increment Misc.charge cnt
                  CALL      WRITM000          * Write item to pmsmtiaf file
                ENDIF
              ELSE
                ADD       ONE,MBSITEMN        * Increment no of MBS Items
                MOVE      MCHARGE,MBSCD[MBSITEMN]
                MOVE      QUNTY[F3],MBSQN[MBSITEMN]
.
                PACK      TITEMNO,MCHARGE,SP70
                CALL      WREMC000            * Check for an exploding charge
              ENDIF
            ENDIF
            MOVE     SP70,ITEMN[F3]
            ADD      ONE,F3
          DO
AMISC999  RETURN
+
.******************************************************************************
.         Write misc.item to pmsmtiaf file
.******************************************************************************
WRITM000  MOVE      PATPR[F3],PMMIAMTP
          MOVE      REBPR[F3],PMMIRBAT
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
          IF        PMMIAMTP=0 & PMMIRBAT=0
            MOVE      CAMNT[F3],PMMIAMTT
            MOVE      PMMIAMTT,PMMIAMTP
          ENDIF
.
.         If the total is not zero, but pat+reb is zero, then default
.         patient portion to the total amount
.
          MOVE      ZERO,FORM12P2
          MOVE      PMMIAMTP,FORM12P2
          ADD       PMMIRBAT,FORM12P2
          IF        FORM12P2=0 & PMMIAMTT<>0
            MOVE      PMMIAMTT,PMMIAMTP
          ENDIF
.
.         Write a record to Misc.Theatre item file
.
          MOVE      OPDAADMN,PMMIVISN
          MOVE      AURNO,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      MCHARGE,PMMIITEM
          MOVE      QUNTY[F3],PMMISERV
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MOVE      PMMISERV,FORM3
          MULT      FORM3,PMMIAMTT
.         MULT      FORM3,PMMIAMTP
.         MULT      FORM3,PMMIRBAT
.
          PACK      PMMIDESC,SP70
          CLEAR     PMMIDESC
          APPEND    DESCP[F3],PMMIDESC
          BRANCH    FORM3,WRITM400          * quantity equals to one
.
          COMPARE   FIVE,CFEETYP
          GOTO      WRITM400 IF NOT EQUAL   * Not NZ Private
.
          UNPACK    DESCP[F3],KEY25
          PACK      PMMIDESC,SP70
               CLEAR     PMMIDESC
          APPEND    KEY25,PMMIDESC
.
WRITM100  CMATCH    SP1,PMMIDESC
          GOTO      WRITM200 IF NOT EQUAL
          BUMP      PMMIDESC,-1
          GOTO      WRITM100 IF NOT EOS
.
WRITM200  APPEND    " X",PMMIDESC
          APPEND    FORM3,PMMIDESC
.
WRITM400  APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
.
          MOVE      SP70,PMMIDES2
          MOVE      OPDADATE,PMMITDAT
          MOVE      "3",PMMIRTYP
          MOVE      SP20,PMMIREFN
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      SP10,PMMITDOC
          MOVE      OPDACLIN,PMMIODOC
.
          MOVE      CURCASE,FORM2           * get as current case as form2
          MOVE      FORM2,PMMISESS          * set session id as the case number
.
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      SP10,PMMIBTCH
          MOVE      ZERO,PMMIINVN
          MOVE      ZERO,PMMIGSTM
          MOVE      CONSM[F3],PMMICTYP
          MOVE      GSTAP[F3],PMMIGSTA
          MOVE      GSTCD[F3],PMMIGSTC
          MOVE      WBSEUID,PMMIWUSR
          MOVE      "0",PMMIMVBR
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
.         Get last transaction number
.
          MOVE      OPDAADMN,KEY8
          CALL      TRVISA1                 * get next transaction no. PVITRAN
.
          MOVE      PVITRAN,PMMITRAN
          MOVE      OPDAUNIQ,PMMIUNIQ
          PACK      KEY14,PMMIVISN,PMMITRAN
          MOVE      SP70,PMMICNTR
          MOVE      SP70,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP1,PMMICCON
.
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          MOVE      CURRDATE,PMMIDTCR
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
          CALL      WRPMMTI1                * write a record
.
          CALL      MMBONC00                * oncology items
.
          MOVE     "A",DIM1
          MOVE     PMMIITEM,MCHARGE
          PACK     CURRDATE,CCC,CYY,CMM,CDD
          REP      " 0",CURRDATE
          CALL     PROTRK00
.
.         Add to invoice pending file if necessary
.
. If Using the Invoice Pending File
.
          IF        PTCNIPEN = 0
            MOVE      OPDAADMN,IPADMNO
            MOVE      THREE,IPSYSTM
            MOVE      SP70,IPSITE
.
            MOVE      SP70,PENDHOSP
            IF        IBCNMHOS=1
              PACK      KEY8,IPADMNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
              ENDIF
            ENDIF
            MOVE      " 3",PENDSYST                 * Inpatient
.
            MOVE      PMMITDAT,PENDSDAT             * as at date
            MOVE      ADATE,PENDADAT                * admission date
            MOVE      SP70,PENDDDAT
            IF        ASTAT=3
              CALL      RDDSCH1
              IF        OVRCD=0
                MOVE      DDATE,PENDDDAT            * discharged date
              ENDIF
            ENDIF
            MOVE      AFUNDH,PENDFUND
            MOVE      ACLAIM,PENDCLAM
            CALL      IPRH0000
            MOVE      SEVEN,PTIPRSTA        * add item
            MOVE      SP70,PTIPSVAR
.
.           Public hospital, check if there is Item amount
.
            IF        CHOSTYP=1 & CFEETYP=0
              CALL      CINVP000                  * Check for tobe invoiced
              GOTO      WRITM900
            ENDIF
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RAIPEN1
            IF        OVRCD=1
              CALL      WRIPEN1
            ELSE
              CALL      UPIPEN1
            ENDIF
          ENDIF
.
WRITM900  
.
WRITM999  RETURN
+
.******************************************************************************
.*                                  WREMC000              Called by: AMISC000 *
.*                         Write Exploding MBS Charges                        *
.******************************************************************************
WREMC000  
.
. ----- Write exploding miscellaneous items for MBS charge -----
.
          PACK      KEY30,ACLAIM,ATYPE,AFUNDH,SP6,TITEMNO,SP70
          CALL      PATECHRD
          BRANCH    EXIT,WREMC900
.
          MOVE      ZERO,F1
          UNPACK    KEY30,WKECCTYP,WKECATYP,WKECHFND,WKECHGRP,WKECMBSC
.
          CALL      RSPTECH1                * Position on & read the exploding
WREMC200  CALL      RKPTECH1                  charges file
          BRANCH    OVRCD,WREMC900
.
          MATCH     WKECCTYP,PTECCTYP
          GOTO      WREMC900 IF NOT EQUAL   * Different claim type
.
          MATCH     WKECATYP,PTECATYP
          GOTO      WREMC900 IF NOT EQUAL   * Different admission type
.
          MATCH     WKECHFND,PTECHFND
          GOTO      WREMC900 IF NOT EQUAL   * Different health fund
          MATCH     WKECHGRP,PTECHGRP
          GOTO      WREMC900 IF NOT EQUAL   * Different health fund group
.
          MATCH     WKECMBSC,PTECMBSC
          GOTO      WREMC900 IF NOT EQUAL   * Different MBS code
.
          IF        F1=0
            ADD       ONE,EXPCHCNT      * Increment Misc.charge cnt
            MOVE      ONE,F1
          ENDIF
.
          MOVE      PTECEMCH,MCHARGE
          CALL      GETMSC00
.
          MOVE      MPATPOR,PMMIAMTP
          MOVE      PTEC3MCF,FORM42
          LOAD      FORM42,EXPCHCNT,PTEC1MCF,PTEC2MCF
          ASSIGN    ((FORM42/100)*PMMIAMTP),PMMIAMTP * Patient amount
.
          MOVE      MHFPOR,PMMIRBAT
          MOVE      PTEC3MCF,FORM42
          LOAD      FORM42,EXPCHCNT,PTEC1MCF,PTEC2MCF
          ASSIGN    ((FORM42/100)*PMMIRBAT),PMMIRBAT * Rebate amount
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
          MOVE      OPDAADMN,PMMIVISN       * Admission no
          MOVE      AURNO,PMMIURNO          * U/R no
          MOVE      " 3",PMMISYST
          PACK      PMMIITEM,MCHARGE,SP10   * Miscellaneous item
.
.         MOVE      QUNTY[F3],PMMISERV
          MOVE      ZERO,PMMISERV
          STRIP     PTECQNTY
          MOVE      PTECQNTY,PMMISERV        * Quantity
.
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MOVE      PMMISERV,FORM3
          MULT      FORM3,PMMIAMTT
.
          CLEAR     PMMIDESC
          APPEND    MDESC,PMMIDESC          * Miscellaneous item description
          BRANCH    FORM3,WREMC400
.
WREMC300  CMATCH    SP1,PMMIDESC
          GOTO      WREMC320 IF NOT EQUAL
          BUMP      PMMIDESC,-1
          GOTO      WREMC300 IF NOT EOS
.
WREMC320  APPEND    " X",PMMIDESC
          APPEND    FORM3,PMMIDESC
.
WREMC400  APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
.
          PACK      PMMIDES2,SP30,SP10      * 2nd item description
          MOVE      OPDADATE,PMMITDAT
          MOVE      "3",PMMIRTYP
          MOVE      SP20,PMMIREFN
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      SP10,PMMITDOC
          MOVE      OPDACLIN,PMMIODOC
.
          MOVE      CURCASE,FORM2           * get as current case as form2
          MOVE      FORM2,PMMISESS          * set session id as the case number
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      SP10,PMMIBTCH
          MOVE      ZERO,PMMIINVN
          MOVE      ZERO,PMMIGSTM
          MOVE      PTMCGSTA,PMMIGSTA
          MOVE      PTMCGSTC,PMMIGSTC
          MOVE      WBSEUID,PMMIWUSR
          MOVE      "0",PMMIMVBR            * Mechanical ventilation billing
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
.
.         Get last transaction number
.
          MOVE      OPDAADMN,KEY8
          CALL      TRVISA1                 * Get next Transaction no
          MOVE      PVITRAN,PMMITRAN        * DTR no
.
          MOVE      OPDAUNIQ,PMMIUNIQ
          PACK      KEY14,PMMIVISN,PMMITRAN
          UNPACK    SP70,PMMICNTR,PMMISUNQ,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP1,PMMICCON
          MOVE      "2",PMMIITYP             * Exploding misc.item
          MOVE      ZERO,PMMISCHF
.
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          MOVE      CURRDATE,PMMIDTCR
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      WRPMMTI1                * write a record
.
          GOTO      WREMC200
.
WREMC900  MOVE      ZERO,EXIT
WREMC999  RETURN
+
.*******************************************************************************
. Write MBS file to patmmbsf file for oncology bookings
.*******************************************************************************
MMBONC00  IF        ONCOLOGY<>1
            GOTO      MMBONC99
          ENDIF
.
          OPEN      PATMMBS1,"patmmbsf"
          MOVE      ZERO,MMRECN
          PACK      KEY11,ADMISSNO,Z70
          CALL      RDSMMBS1
          CALL      RDPMMBS1
          BRANCH    OVRCD,MMBONC10
.
          MATCH     ADMISSNO,DMMADMN
          GOTO      MMBONC10 IF EQUAL
.
          MOVE      ONE,MMRECN
          GOTO      MMBONC20
.
MMBONC10  COMPARE   "999",MMRECN
          GOTO      MMBONC99 IF EQUAL       * has reached the maximum
          ADD       ONE,MMRECN
.
MMBONC20  MOVE      ADMISSNO,MMADMN
          MOVE      PMMITDAT,MMDATE   * use the date written to pmsmtiaf
          MOVE      OPSGTISS,MMSTIM
          MOVE      OPSGTISE,MMETIM
.
          PACK      MMCODE,PMMIITEM
          PACK      PTMMDESC,PMMIDESC
          PACK      PTMMOPID,PMMIUNIQ       * theatre unique no.      *I-207386
          PACK      PTMMTMNO,OPPMTMNO,SP1   * theatre Team No.        *I-207386
          PACK      MMSPARE,SP70
.
          PACK      KEY11,MMADMN,MMRECN
          CALL      RDMMBS1
          COMPARE   ZERO,OVRCD
          GOTO      MMBONC10 IF EQUAL
          CALL      WRMMBS1                 * write MBS Item record "patmmbsf"
.
          GOTO      MMBONC99
.
MMBONC99  RETURN
+
.******************************************************************************
.*               Add Multiple Theatre CMBS Items                              *
.******************************************************************************
ADCMBS00  CALL      GETMBS00                * Get Theatre MBS Details
          CALL      MBSBIL00                * Check for billed MBS Items
.
          MATCH     "B",UPDATETY            * Add MBS or Misc Item
          GOTO      ADCMBS10 IF EQUAL
          BRANCH    PMBSFLAG,ADCMBS10       * Prov mbs already in oprpmb
.
.         write provisional MBS to oprpmbsf file
.
          PACK      KEY14,OPDAUNIQ,TEAMNUMB,Z70
          CALL      RSOPPMB1              * Writing To Patient CMBS File
          CALL      RPOPPMB1
          BRANCH    OVRCD,ADCMBS04
.
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      ADCMBS04 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPMTMNO
          GOTO      ADCMBS04 IF NOT EQUAL
          MOVE      OPPMCNTR,MBSCOUNT
          GOTO      ADCMBS06
.
ADCMBS04  MOVE      ZERO,MBSCOUNT
ADCMBS06  COMPARE   "999",MBSCOUNT
          GOTO      ADCMBS99 IF EQUAL     * has reached the maximum
.
          ADD       ONE,MBSCOUNT
          CALL      CLOPRPMB              * Clear File Variables
          MOVE      OPDAUNIQ,OPPMUNID
          MOVE      TEAMNUMB,OPPMTMNO
          MOVE      MBSFCODE,OPPMCMBS
          MOVE      MBSCOUNT,OPPMCNTR
          MOVE      ONE,F4
          MOVE      F4,OPPMSERV         * set quantity to one for Prov.
          MOVE      ZERO,OPPMGSTA
          MOVE      SP70,OPPMGSTC
          MATCH     SP70,OPPMCMBS
          GOTO      ADCMBS10 IF EQUAL
          PACK      KEY14,OPDAUNIQ,TEAMNUMB,OPPMCNTR,SP70
          MOVE      OPPMCNTR,DOPPMCNT
          CALL      RAOPPMB1              * Writing To Patient CMBS File
          IF        OVRCD=1
            CALL      WROPPMB1            * Writing To Patient CMBS File
          ENDIF
.
ADCMBS10  MOVE      ZERO,F3
          WHILE     F3<SLOTINDX
            PACK      KEY14,OPDAUNIQ,TEAMNUMB,Z70
            CALL      RSOPPMB1              * Writing To Patient CMBS File
            CALL      RPOPPMB1
            BRANCH    OVRCD,ADCMBS20
            MATCH     OPDAUNIQ,OPPMUNID
            GOTO      ADCMBS20 IF NOT EQUAL
            MATCH     TEAMNUMB,OPPMTMNO
            GOTO      ADCMBS20 IF NOT EQUAL
.
            COMPARE   "999",OPPMCNTR
            GOTO      ADCMBS99 IF EQUAL     * has reached the maximum
.
            MOVE      OPPMCNTR,MBSCOUNT
            GOTO      ADCMBS30
ADCMBS20    MOVE      ZERO,MBSCOUNT
ADCMBS30    ADD       ONE,F3
            CALL      CLOPRPMB              * Clear File Variables
            CALL      SAVICM00              * Moving Cgi variables To File Var.
.
            ADD       ONE,MBSCOUNT
            MATCH     SP70,OPPMCMBS
            IF        !@EQUAL
              MOVE      MBSCOUNT,OPPMCNTR
              PACK      KEY14,OPDAUNIQ,TEAMNUMB,OPPMCNTR,SP70
              UNPACK    KEY14,OPPMUNID,OPPMTMNO,DOPPMCNT
              MOVE      DOPPMCNT,OPPMCNTR
              CALL      RAOPPMB1              * Writing To Patient CMBS File
              IF        OVRCD=1
                CALL      WROPPMB1            * Writing To Patient CMBS File
              ENDIF
            ENDIF
          DO
.
ADCMBS99  RETURN
.******************************************************************************
.*               Moving Cgi Variables To File Variables                       *
.******************************************************************************
SAVICM00  MOVE      OPDAUNIQ,OPPMUNID
          MOVE      TEAMNUMB,OPPMTMNO
          PACK      OPPMCMBS,MBSCD[F3],SP70
.
          MOVE      GSTAP[F3],OPPMGSTA
          MOVE      GSTCD[F3],OPPMGSTC
          MOVE      ONE,F4
          MOVE      F4,OPPMSERV
.
          COMPARE   ZERO,MBSQN[F3]
          GOTO      SAVICM99 IF EQUAL
          MOVE      MBSQN[F3],OPPMSERV
.
SAVICM99  RETURN
.******************************************************************************
.*                   Main Action Routine for maintenance of CMBS Items        *
.******************************************************************************
OPRMBS00  COMPARE   ONE,ONCOLOGY
          GOTO      OPRMBS05 IF EQUAL
.
          CALL      VALCAS00
          BRANCH    EXIT,OPRMBS99
.
          GOTO      OPRMBS10
.
OPRMBS05  PACK      KEY18,ADMISSNO,SP70
          CALL      RSBKUNQ1                * Check for record
          CALL      RKBKUNQ1
          BRANCH    OVRCD,OPRMBS93
.
          MATCH     ADMISSNO,BKUNVISN
          GOTO      OPRMBS93 IF NOT EQUAL
.
          CALL      CLOPRDEA
          PACK      OPDAUNIQ,BKUNUNIQ,SP70
          PACK      OPDAADMN,BKUNVISN,SP70
          MATCH     SP70,BKUNLADM
          IF        !@EQUAL
            PACK      OPDAADMN,BKUNLADM,SP70
          ENDIF
.
          MOVE      ONE,TEAMNUMB
.
OPRMBS10  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * arrival/recovery details
          BRANCH    OVRCD,OPRMBS91
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical details
          BRANCH    OVRCD,OPRMBS95
.
          MATCH     "1",OPSGUY05       
          IF        !@EQUAL
.                                           * Only check Surgical Start time
.                                             if Case is not abandoned
            MATCH     SP70,OPSGTISS
            GOTO      OPRMBS97 IF EQUAL       * Surgical time is blank
          ENDIF
.
          CALL      ALLMBS00                * Get total number of Theatre MBS 
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRMBS40 IF EQUAL
.
          MOVE      ZERO,F1
.
          CALL      USIMB000                * get the initial patmmbs 
.
          PACK      SAVEPMBS,TEAMNUMB,OPPMB002,SP70
          CALL      USGIM000                * locate any existing items records
          UNPACK    SAVEPMBS,TEAMNUMB,OPPMB002
.
          MATCH     "U",UPDATETY            * Update CMBS Item
          GOTO      OPRMBS20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete CMBS Item
          GOTO      OPRMBS30 IF EQUAL
.
          MATCH     "R",UPDATETY            * Delete Theatre Item (MBS or Misc.)
          GOTO      OPRMBS25 IF EQUAL
.
          MATCH     "Q",UPDATETY            * Updae Theatre Item Quantyity      
          GOTO      OPRMBS39 IF EQUAL
.
          MATCH     "C",UPDATETY            * Theatre Complete flag
          GOTO      OPRMBS34 IF EQUAL
.
          MATCH     "P",UPDATETY            * Post Prov.CMBS items
          GOTO      OPRMBS36 IF EQUAL
.
          MATCH     "V",UPDATETY            * Post STV Prov.CMBS item
          GOTO      OPRMBS36 IF EQUAL
.
          MATCH     "B",UPDATETY            * Bill Prov.CMBS items
          GOTO      OPRMBS38 IF EQUAL
.
          GOTO      OPRMBS90
.
.******************************************************************************
.*                      Update CMBS Item                                      *
.******************************************************************************
OPRMBS20  CALL      CHKMBS00                 * For Checking Mandatory Field
          BRANCH    EXIT,OPRMBS99
.
          PACK      KEY9,OPPMB001,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,OPRMBS92
.
          PACK      KEY14,OPDAUNIQ,TEAMNUMB,OPPMB002,SP70
          CALL      RDOPPMB1                  * Read  Record from oprpmbaf
          BRANCH    OVRCD,OPRMBS93
.
          PACK      KEY23,OPPMCMBS,OPDAUNIQ,TEAMNUMB,OPPMCNTR,SP70
          CALL      RLOPPMB2                 * Read with Full key (oprpmbaf)
          BRANCH    OVRCD,OPRMBS93,OPRMBS94
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
          MOVE      OPPMB001,OPPMCMBS
          CALL      UPOPPMB2                 * Update Record in oprpmbaf
          CALL      UUOPPMB2
.
          CALL      USMBS000                * Set up patient MBS Account
.
          CALL      USMMB000                * Write MBS Code to medical records
.
          CALL      WARN0000
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS25  MATCH     "9",IRECTYPE             * Consumption type item ?
          IF        @EQUAL
            PACK      KEY13,OPDAUNIQ,TEAMNUMB,TRANNUMB
            CALL      DEOPCTY1
            GOTO      OPRMBS26
          ENDIF
.
          PACK      KEY14,OPDAADMN,TRANNUMB,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,OPRMBS93
          MOVE      PMMIITEM,OPPMB001
.
          MATCH     SP70,PMMIPMBS
          IF        !@EQUAL
            MOVE      PMMITMNO,TEAMNUMB
            MOVE      PMMIPMBS,OPPMB002
          ENDIF
.
.         This item is being deleted, so check if it is a 'confirmed'
.         theatre item. If so, send an appropriate HL7 message.
.
          MATCH     "2",PMMIRTYP
          IF        @EQUAL
            MATCH     "1",PMMICCON
            IF        @EQUAL
              CALL      PMIGTNID              * get national id for HL7 write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      ANSD,HL7ITMFL         * set flag for delete record
              MOVE      TWO,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLIITM              * send HL7 message
            ENDIF
          ENDIF
.
          PACK      KEY14,PMMIVISN,PMMITRAN,SP70
          CALL      DEPMMTI1
.
          MATCH     "3",IRECTYPE              * Misc.item?
          GOTO      OPRMBS28 IF NOT EQUAL
.
          MOVE     "D",DIM1
          MOVE     PMMIITEM,MCHARGE
          PACK     CURRDATE,CCC,CYY,CMM,CDD
          REP      " 0",CURRDATE
          CALL     PROTRK00
.
OPRMBS26  CALL      WARN0000
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS28  PACK      KEY23,OPPMB001,OPDAUNIQ,TEAMNUMB,OPPMB002,SP70
          CALL      RDOPPMB2
          COMPARE   ZERO,OVRCD
          GOTO      OPRMBS32 IF EQUAL
.
          PACK      KEY23,OPPMB001,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB2                 * Partial Read on oprpmbaf
          CALL      RKOPPMB2                 * Read Next Record from oprpmbaf
          BRANCH    OVRCD,OPRMBS93
.
          MATCH     OPPMB001,OPPMCMBS
          GOTO      OPRMBS33 IF NOT EQUAL    * Error Record NOt Exist
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      OPRMBS33 IF NOT EQUAL    * Error Record NOt Exist
          GOTO      OPRMBS31
.
.******************************************************************************
.*                      Delete CMBS Item                                      *
.******************************************************************************
OPRMBS30  PACK      KEY23,OPPMB001,OPDAUNIQ,TEAMNUMB,OPPMB002,SP70
          CALL      RDOPPMB2                 * Partial Read on oprpmbaf
          COMPARE   ZERO,OVRCD
          GOTO      OPRMBS32 IF EQUAL
.
          PACK      KEY23,OPPMB001,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB2                 * Partial Read on oprpmbaf
          CALL      RKOPPMB2                 * Read Next Record from oprpmbaf
          BRANCH    OVRCD,OPRMBS93
.
          MATCH     OPPMB001,OPPMCMBS
          GOTO      OPRMBS93 IF NOT EQUAL    * Error Record NOt Exist
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      OPRMBS93 IF NOT EQUAL    * Error Record NOt Exist
          MATCH     TEAMNUMB,OPPMTMNO
          GOTO      OPRMBS93 IF NOT EQUAL    * Error Record NOt Exist
.
OPRMBS31  PACK      KEY23,OPPMB001,OPDAUNIQ,TEAMNUMB,OPPMCNTR,SP70
          CALL      RLOPPMB2                 * Lock the record
OPRMBS32  CALL      DEOPPMB2                 * Deletes the Record (oprpmbaf)
.
OPRMBS33  CALL      USMBS000                * Set up patient MBS Account
.
          CALL      USMMB000                * Write MBS Code to medical records
.
          CALL      WARN0000
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
.******************************************************************************
OPRMBS34  MOVE      OPDAADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,OPRMBS99
.
.         Update all charges complete fields in the theatre record
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPDEA3                * Read original oprdetaf record
          IF        OVRCD=0
            MOVE      THEACOMP,OPDAACPD     * Theatre complete
            MATCH     "1",THEACOMP
            IF        @EQUAL
              MOVE      SP70,OPDARICM       * theatre complete; blank out reason
            ELSE
              MOVE      THERCOMP,OPDARICM   * Reason Incomplete
            ENDIF
            CALL      UPOPDEA3
          ENDIF
.
.         Now we update the theatre complete fields in our visit ext record
.
          MOVE      "0",PMVXATCP            * All theatre charges not posted
.
          MATCH     "1",THEACOMP
          IF        @EQUAL
            MOVE      "018",TADTTYPE        * Theatre complete audit record
            MOVE      PMVXVISN,OPTHVISN
            PROC      OPTHCMPL              * Validate that all theatre charges
                                            * are complete for the visit
            IF        EXIT=1
              MOVE      "1",PMVXATCP        * All theatre charges posted
              MOVE      SP70,THERCOMP
            ELSE
              MOVE      OPTHRICM,THERCOMP   * Reason Incomplete (theatre record)
            ENDIF
          ELSE
            MOVE      "019",TADTTYPE        * Theatre incomplete audit record
          ENDIF
.
          MOVE      THERCOMP,PMVXTICM       * Reason Theatre Incomplete for vis
.
          CALL      UPPMVX11
.
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
          PROC      OPTHETAT                * write audit
.
          MATCH     "1",THEACOMP            * theatre complete?
          IF        @EQUAL
            CALL      CFRM0000              * confirm all cmbs items
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OPRMBS99
.
.         Posting Prov.CMBS items
.
OPRMBS36  CALL      VPRV0000                * Validate Prov.CMBS item
          CALL      WPITM000                * Write Prov.mbs item to pmsmtiaf
.
          MOVE      "R",UPDATETY
          CALL      WARN0000
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS38  MOVE      ZERO,EXIT
          GOTO      OPRMBS99
.
.         Update Theatre Item Quantity
.
OPRMBS39  PACK      KEY14,ADMISSNO,TRANNUMB,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,OPRMBS99
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      OPRMBS99 IF NOT EQUAL   * No
.
          MOVE      ITEMQNTY,PMMISERV       * update quantity
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          MOVE      CURRDATE,PMMIDUPD
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          GOTO      OPRMBS99
.
.******************************************************************************
.*                      Display CMBS Items                                    *
.******************************************************************************
OPRMBS40  CLEAR     WEBTITLE
          MOVE      "Theatre CMBS Items Details",WEBTITLE
          RESET     WEBTITLE
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
.
          MATCH     "9",IRECTYPE             * Consumption type item ?
          IF        @EQUAL
            CALL      VCIT0000               * Validating Consumption type item
            GOTO      OPRMBS44
          ENDIF
.
          PACK      KEY14,OPDAADMN,TRANNUMB,SP70
          CALL      RDPMMTI1
          IF        OVRCD=1
            UNPACK    SP70,PMMIITEM,PMMIDESC,PMMITMNO,PMMIPMBS
          ELSE
            MATCH     SP70,PMMIPMBS
            IF        !@EQUAL
              MOVE      PMMITMNO,TEAMNUMB
              MOVE      PMMIPMBS,OPPMB002
            ENDIF
          ENDIF
.
OPRMBS44  PACK      KEY14,OPDAUNIQ,TEAMNUMB,OPPMB002
          CALL      RDOPPMB1
          IF        OVRCD=1
            CALL      CLOPRPMB
          ENDIF
.
          MOVE      OPDAADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXATCP         * All theatre charges posted
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPDEA3                * Read original oprdetaf record
          IF        OVRCD=1
            CALL      CLOPRDEA
          ENDIF
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ENDIF         
.
          MOVE      TEAMNUMB,OPPMTMNO
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRMBS99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
.******************************************************************************
.*                  Error Handling Section                                    *
.******************************************************************************
OPRMBS90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS91  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS92  MOVE      "Invalid CMBS Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS93  MOVE      "Record does not exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS94  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRMBS99
.
OPRMBS95  MOVE      "Theatre Details must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT 
          GOTO      OPRMBS99
.
OPRMBS97  MOVE      "Surgery Start Time must be entered first.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT 
          GOTO      OPRMBS99
.
OPRMBS99  RETURN
+
.-----------------------------------------------------------------
. Validating Prov.CMBS item
.-----------------------------------------------------------------
VPRV0000  MOVE      ZERO,WARNCNT
          MATCH     "V",UPDATETY            * Post STV Prov.CMBS item
          GOTO      VPRV4000 IF NOT EQUAL
.
          MOVE      ONE,COUNTM
          WHILE     COUNTM<51
            UNPACK    SP70,UNIQUEKY,KEY9
            MOVE      PROVM[COUNTM],KEY19
            PACK      KEY19,KEY19,SP70
            UNPACK    KEY19,UNIQUEKY,KEY9
.
            MOVE      ZERO,EXIT
            MATCH     SP70,KEY9
            IF        !@EQUAL
              PACK      KEY17,KEY9,OPDADATE,SP70
              CALL      PATITMRD            * get MBS Item description
              IF        OVRCD=1
                ADD       ONE,WARNCNT
                MOVE      "Warning - Prov.MBS item ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    KEY9,WEBWRN[WARNCNT]
                APPEND    " is not Active.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ENDIF
            ENDIF
            ADD       ONE,COUNTM
          DO
          GOTO      VPRV9999
.
VPRV4000  MOVE      ZERO,F2
          REPEAT
            ADD       ONE,F2
            LOAD      KEY9,F2,OPDAPROV,OPDAPRV2,OPDAPRV3
            MATCH     SP70,KEY9
            IF        !@EQUAL
              PACK      KEY17,KEY9,OPDADATE,SP70
              CALL      PATITMRD            * get MBS Item description
              IF        OVRCD=1
                ADD       ONE,WARNCNT
                MOVE      "Warning - Prov.MBS item ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    KEY9,WEBWRN[WARNCNT]
                APPEND    " is not Active.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ENDIF
            ENDIF
          UNTIL     F2=3
.
VPRV9999  RETURN
+
.-----------------------------------------------------------------
. Validating Consumption type item
.-----------------------------------------------------------------
VCIT0000  MATCH     "1",OPCNCONS
          GOTO      VCIT9999 IF NOT EQUAL  * Not using Consumption type items
.
          UNPACK    SP70,PMMIITEM,PMMIDESC,PMMITMNO,PMMIPMBS
          MOVE      ONE,PMMISERV
          MOVE      ZERO,PMMIAMTT
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,TRANNUMB
          CALL      RDOPCTY1
          BRANCH    OVRCD,VCIT9999
.
          MOVE      OPCYITEM,PMMIITEM      * item code
          MOVE      OPCYQUAN,PMMISERV      * Quantity
.
          MOVE      PTCNDCLM,MCLMCOD
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            MOVE      OPDAADMN,KEY8
            CALL      RDPMVX11
            MOVE      SP10,PTHSDCLM
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            MOVE      PTHSDCLM,MCLMCOD
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      OPCYQUAN,FORM3
            MOVE      OPCYITEM,DIM9
            CALL      SMTI0000        * Get Misc.charge amount
          ENDIF
.
VCIT9999  RETURN
+
.-----------------------------------------------------------------
. if theatre is complete, all existing mbs items will be confirmed
.-----------------------------------------------------------------
CFRM0000  PACK      KEY14,PMVXVISN,SP70
          CALL      RSPMMTI1
CFRM1000  CALL      RKPMMTI1
          BRANCH    OVRCD,CFRM9999
.
          MATCH     PMVXVISN,PMMIVISN
          GOTO      CFRM9999 IF NOT EQUAL
.
          MATCH     "1",PMMICCON
          GOTO      CFRM1000 IF EQUAL
.
          MOVE      "1",PMMICCON
          MOVE      CURRDATE,PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
.
.         This item is being confirmed, so send an appropriate HL7 message.
.
          CALL      PMIGTNID                * get national id for HL7 write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ANSA,HL7ITMFL           * set flag for add record
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIITM                * send HL7 message
.
          GOTO      CFRM1000
.
CFRM9999  RETURN
+
.-----------------------------------------------------------
.         Write Provisional MBS item to "pmsmtiaf" file
.-----------------------------------------------------------
WPITM000  MOVE      ZERO,F1               *  to open misc.audit file
.
          MATCH     "V",UPDATETY            * Post STV Prov.CMBS item
          IF        @EQUAL
            CALL      STVMBS00              * write any Provisional MBS Items
          ELSE
            CALL      MBSCHK00              * write any Provisional MBS Items
          ENDIF
.
          CALL      USMBS000                * Set up Patient MBS Account
.
          CALL      USMMB000                * write MBS Code to medical records
.
WPITM999  RETURN
+
.-----------------------------------------------------------
.         Warning message for theatre system
.-----------------------------------------------------------
WARN0000  IF        ONCOLOGY=1
            MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
            CALL      WCLSW000
            GOTO      WARN9999
          ENDIF
.
          CALL      OPENHTML
          BRANCH    EXIT,WARN9000
.
          MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");",012
.
          COMPARE   ZERO,WARNCNT
          GOTO      WARN2000 IF EQUAL
.
          MOVE      ONE,F2
WARN1000  WRITE     HTMLFILE;"    alert(#"",WEBWRN[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,WARNCNT
          GOTO      WARN2000 IF LESS
          GOTO      WARN1000
.
WARN2000  REP       " +",CASEKEYS
          CLEAR     REDIRECT
          MATCH     "R",UPDATETY            * Delete Theatre Item (MBS or Misc.)
          IF        @EQUAL
            APPEND    "oprweb06.pbl?reportno=03&template=004&casekeys=",REDIRECT
          ELSE
            APPEND    "oprweb06.pbl?reportno=03&template=001&casekeys=",REDIRECT
          ENDIF
          APPEND    CASEKEYS,REDIRECT
          APPEND    "&teamnumb=",REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
          REP       "+ ",CASEKEYS
.
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WARN9999
.
WARN9000  DISPLAY   "*** Fifo Not Found ***"
WARN9999  RETURN
+
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
WCLSW000  CALL      OPENHTML
          BRANCH    EXIT,WCLSW999
          MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");",012
.
          COMPARE   ZERO,WARNCNT
          GOTO      WCLSW200 IF EQUAL
.
          MOVE      ONE,F2
WCLSW100  WRITE     HTMLFILE;"    alert(#"",WEBWRN[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,WARNCNT
          GOTO      WCLSW200 IF LESS
          GOTO      WCLSW100
.
WCLSW200  WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "   reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WCLSW999  RETURN
.
.******************************************************************************
.*                      Check Mandatory Field For CMBS                        *
.******************************************************************************
CHKMBS00  RESET     OPPMB001
          MATCH     SP70,OPPMB001
          GOTO      CHKMBS90 IF EQUAL
          GOTO      CHKMBS99
.
CHKMBS90  MOVE      "CMBS is the required field",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKMBS99  RETURN
.******************************************************************************
.*                 To Move the CGI parameters to oprpmbaf variables           *
.******************************************************************************
SAVMBS00  MOVE     SP70,OPPMSPAR
          MOVE     OPDAUNIQ,OPPMUNID
          MOVE     TEAMNUMB,OPPMTMNO
          MOVE     OPPMB001,OPPMCMBS
.
SAVMBS99  RETURN
.******************************************************************************
.*                 To Move the Values into patmmbsf file  variables           *
.******************************************************************************
SAVPMB00  MOVE     OPPMB001,MMCODE
          MOVE     OPDADATE,MMDATE
          MOVE     OPDAADMN,MMADMN
          MOVE     SP70,MMSTIM
          MOVE     SP70,MMETIM
          MOVE     SP70,MMSPARE
.
SAVPMB99  RETURN
+
.*********************************************************************
.                   USIMB000                                         
.         get the initial patmmbaf items on file for patient   
.*********************************************************************
USIMB000  MOVE      ZERO,TOTMMBS
          MOVE      ONE,FORM3
          OPEN      PATMMBS1,"patmmbsf"
          MOVE      ZERO,CCITE2CN             * items stored counter
          PACK      KEY11,OPDAADMN,SP70
          CALL      RDSMMBS1
USIMB100  CALL      RDKMMBS1
          BRANCH    OVRCD,USIMB999          * end of file
.
          MATCH     OPDAADMN,MMADMN
          GOTO      USIMB999 IF NOT EQUAL   * different patient
.
          MATCH     PTMMOPID,OPDAUNIQ
          GOTO      USIMB100 IF NOT EQUAL   * different unique number
.
          MATCH     MMDATE,OPDADATE
          GOTO      USIMB100 IF NOT EQUAL   * different date
.
          MOVE      ZERO,FORM3 
          PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
USIMB200  CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USIMB100
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USIMB100 IF NOT EQUAL
.
          MOVE      OPPMCMBS,KEY9
          MATCH     KEY9,MMCODE
          GOTO      USIMB200 IF NOT EQUAL   * different codes
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
.
          ADD       ONE,CCITE2CN
          PACK      INITMMBS[CCITE2CN],MMADMN,MMRECN,SP70
          MOVE      CCITE2CN,TOTMMBS
          GOTO      USIMB100
.
USIMB999  RETURN
+
.*********************************************************************
.*                  USGIM000                    Called by : UCPRC555 *
.*        Locate the existing item records for the MBS codes         *
.*********************************************************************
USGIM000  MOVE      ZERO,TOTDTRA
          MOVE      ONE,INVOICED            * set as none invoiced
.
          CALL      GSES0000                * get current session
          MOVE      ZERO,CCITE2CN             * count for DTR items
          MOVE      OPDAADMN,TADMNO
          PACK      KEY22,TADMNO,SP20
          CALL      RDSDTRN1
.
USGIM100  CALL      RDKDTRN1
          BRANCH    OVRCD,USGIM500          * no (more) details for admission
.
          MATCH     TADMNO,OPDAADMN            
          GOTO      USGIM500 IF NOT EQUAL   * different admission
.
          MATCH     "1",PTDTCRST
          GOTO      USGIM100 IF EQUAL       * Fully credited
.
          MATCH     "2",PTDTCRST
          GOTO      USGIM100 IF EQUAL       * Credit by item
.
.         check if the session date matches
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          MATCH     KEY8,OPDADATE
          GOTO      USGIM100 IF NOT EQUAL   * different session
.
          MATCH     SP9,TITEMNO
          GOTO      USGIM100 IF EQUAL       * no code to check
.
.         check if the current DTR item code matches any of the usage codes
.
          MOVE      ZERO,FORM3          
          MATCH     SP70,PTDTPMBS
          GOTO      USGIM200 IF EQUAL
.
          PACK      KEY23,TITEMNO,OPDAUNIQ,PTDTTMNO,PTDTPMBS,SP70
          CALL      RDOPPMB2
          IF        OVRCD=0
            MOVE      PTDTTMNO,TEAMNUMB
            MOVE      PTDTPMBS,OPPMB002
            MOVE      OPPMCMBS,PROVITEM
            GOTO      USGIM320
          ENDIF
.
USGIM200  PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
USGIM300  CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USGIM100
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USGIM100 IF NOT EQUAL
.
          MOVE      OPPMCMBS,PROVITEM
          MATCH     PROVITEM,TITEMNO 
          GOTO      USGIM300 IF NOT EQUAL   * different code
.
USGIM320  MOVE      ZERO,INVOICED           * set as one invoiced
          GOTO      USGIM100
.
.        Check with pmsmtiaf for items not yet invoiced
.
USGIM500  MOVE      OPDAADMN,PMMIVISN
          PACK      KEY14,PMMIVISN,SP20
          CALL      RSPMMTI1
USGIM600  CALL      RKPMMTI1
          BRANCH    OVRCD,USGIM999          * no (more) details for admission
.
          MATCH     PMMIVISN,OPDAADMN       * get admission number as form
          GOTO      USGIM999 IF NOT EQUAL   * different admission
.
          MATCH     PMMIUNIQ,OPDAUNIQ        * Same unique number
          GOTO      USGIM600 IF NOT EQUAL
.
.         check if the session date matches
.
          MATCH     PMMITDAT,OPDADATE
          GOTO      USGIM600 IF NOT EQUAL   * different session
.
          MATCH     SP9,PMMIITEM
          GOTO      USGIM600 IF EQUAL       * no code to check
.
.         check if the current item code matches any of the usage codes
.
          MOVE      ZERO,FORM3          
          MATCH     SP70,PMMIPMBS
          GOTO      USGIM700 IF EQUAL
.
          PACK      KEY23,PMMIITEM,OPDAUNIQ,PMMITMNO,PMMIPMBS,SP70
          CALL      RDOPPMB2
          IF        OVRCD=0
            MOVE      PMMITMNO,TEAMNUMB
            MOVE      PMMIPMBS,OPPMB002
            MOVE      OPPMCMBS,PROVITEM
            GOTO      USGIM820
          ENDIF
.
USGIM700  PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
USGIM800  CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USGIM600
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USGIM600 IF NOT EQUAL
.
          MOVE      OPPMCMBS,PROVITEM
          MATCH     PROVITEM,PMMIITEM 
          GOTO      USGIM800 IF NOT EQUAL   * different code
.
USGIM820  MOVE      ZERO,F4
          SQUEEZE   OPPMSERV
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
.
.         one of the MBS codes matches item from the Misc.theare item file
.
          ADD       ONE,CCITE2CN
          MOVE      "00000000",TREF
          PACK      KEY22,PMMIVISN,TREF,PMMITRAN
          PACK      INITDTR[CCITE2CN],SP70
          MOVE      KEY22,INITDTR[CCITE2CN]   * save DTR code
          MOVE      CCITE2CN,TOTDTRA
          GOTO      USGIM600
.
USGIM999  RETURN
+
.******************************************************************************
.*            Setup current session                                           *
.******************************************************************************
GSES0000  MOVE      OPDAUNIQ,UNIQUEKY
          BRANCH    ONCOLOGY,GSES9999
          MOVE      ZERO,CURCASE              * initialise session
          MOVE      SP70,KEY10
          MOVE      OPDAADMN,KEY8
          PACK      KEY31,OPDAADMN,SP70
          CALL      RSOPDEA2
GSES1000  CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,GSES9000
.
          MATCH     KEY8,OPDAADMN
          GOTO      GSES9000 IF NOT EQUAL 
.
          MATCH     SP70,KEY10
          IF        !@EQUAL
            MATCH     KEY10,OPDAUNIQ
            GOTO      GSES1000 IF EQUAL     * get next record
          ENDIF
.
          MATCH     UNIQUEKY,OPDAUNIQ
          GOTO      GSES9000 IF EQUAL       * current booking/uniq number
.
          ADD       ONE,CURCASE
          MOVE      OPDAUNIQ,KEY10          * Save the uniq number
          GOTO      GSES1000
.
GSES9000  ADD       ONE,CURCASE            * default to session/case 1
.
          PACK      KEY10,UNIQUEKY,SP70      * reposition to current uniq id
          CALL      RDOPDEA3
GSES9999  RETURN
+
.******************************************************************************
.*         Setup patients MBS account (only if an inpatient) - (oprpmbaf)     *
.******************************************************************************
USMBS000  COMPARE   ONE,OPCNCHMB             * Bill MBS Items (Y/N)
          GOTO      USMBS9999 IF NOT EQUAL   * No bill for MBS item
.
          MOVE      OPDAADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,USMBS999           * not an admission so don't write
          BRANCH    ASTAT,USMBS999           * a pre-admission so don't write
.
          UNPACK    SP70,DDATE,DTIME
          IF        ASTAT=3
            CALL      RDDSCH1                * read the discharge record
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            MOVE      OPDAADMN,KEY8
            CALL      RDPMVX11
            MOVE      SP10,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
          ENDIF
.
          BRANCH    INVOICED,USMBS100       * all un-invoiced items
.
          CLEAR     WEBTITLE
          APPEND    "Warning: Patient has been invoiced,",WEBTITLE
          APPEND    " MBS item won't be posted to Billing",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARNCNT
          MOVE      WEBTITLE,WEBWRN[WARNCNT]
          GOTO      USMBS999
.
USMBS100  IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      USMBS800 IF NOT EQUAL   * not using theatre fees
          ELSE 
            COMPARE   "1",PTCNTFEE
            GOTO      USMBS800 IF NOT EQUAL   * not using theatre fees
          ENDIF
.
.         Get theatre fees for MBS item, based on the most expensive item amount
.
          MOVE      ZERO,MBSCNT             * initialize count and unique
          CALL      CTEMP000                * Create temp file
          MOVE      ONE,FORM3
          MOVE      FORM3,UNIQUE
.
.         Load the MBS from "oprpmbs" file and write to a tempfile with 
.         index on the amount
.
USMBS200  PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
          CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USMBS500
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USMBS500 IF NOT EQUAL
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
          MOVE      OPPMREFN,REFNUMBR       * Reference number
.
          MOVE      ZERO,AMOUNT             * initialize total theatre charge
          MOVE      OPPMCMBS,PROVITEM
          PACK      KEY9,OPPMCMBS 
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,USMBS300          * invalid code
.
          MOVE      OPDADATE,CEFFDATE
          MOVE      IAMT,DIAMT              * move charge to DIM field for file
          CALL      GETTHR00                * get theatre fee
          BRANCH    OVRCD,USMBS300
.
          MOVE      TFPAT1,AMOUNT           * patient portion of charge
          ADD       TFHF1,AMOUNT            * rebate portion of charge
.
USMBS300  PACK      DAMOUNT,AMOUNT,SP9      * Amount of charge
          PACK      KEY26,DAMOUNT,DIAMT,PROVITEM,UNIQUE 
          WRITE     INPUSETF,KEY26;KEY26,OPPMTMNO,OPPMGSTA,OPPMGSTC,DOPPMCNT:
                             CONSTYPE,REFNUMBR
          MOVE      UNIQUE,FORM3            * increment unique
          ADD       ONE,FORM3
          MOVE      FORM3,UNIQUE
.
          PACK      KEY14,OPDAUNIQ,OPPMTMNO,OPPMCNTR
          CALL      DEOPPMB1                * delete record from oprpmbaf
          GOTO      USMBS200
.
USMBS500  CALL      USCHP000                * charge patient 
          CALL      DTEMP000                * delete tempfile 
          GOTO      USMBS900
.
.
.         Use MBS Fee amount for charging
.
USMBS800  CALL      USDIM000                * delete non-invoiced item records
          PACK      KEY14,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
USMBS850  CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USMBS900
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USMBS900 IF NOT EQUAL
          MATCH     OPPMTMNO,TEAMNUMB
          GOTO      USMBS900 IF NOT EQUAL
.
          MOVE      OPPMCMBS,PROVITEM
          PACK      KEY9,OPPMCMBS 
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,USMBS850          * invalid code
.
          IF        PTITGSTA=2
            MOVE      OPPMGSTA,PTITGSTA
            MOVE      OPPMGSTC,PTITGSTC
          ENDIF
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
.
          MOVE      ZERO,TFPAT1
          MOVE      ZERO,TFHF1
          IF        CMBSFEE=1
            MOVE      QIAMT,TFPAT1
          ENDIF
.
          MOVE      IDESC,PMMIDESC
          MOVE      SP70,PMMISUNQ
          MOVE      OPPMREFN,PMMIREFN       * Reference number
          CALL      USRAT000                * calculate rate for item & write
          GOTO      USMBS850
.
USMBS900  PACK      KEY16,OPDADATE,OPSGTISS
          PROC      AUTOATYP                * automatic update admission type
          UNPACK    KEY16,OPDADATE,OPSGTISS
.
USMBS999  RETURN
+
.*********************************************************************
.                   USMMB000                    Called by : UCPRC0000
.            Save operations to PATMMBFD medical records file
.   (allow for change mode in which new codes may have been added/deleted)
.*********************************************************************
USMMB000  BRANCH    OPCNMREC,USMMB999       * dont update file
.
.         have to now check if in hospital due to new parameter (opcnusge)
.
          MOVE      OPDAADMN,KEY8           * Admission Number
          CALL      RDMISS1
          BRANCH    OVRCD,USMMB999          * not an admission so dont write
          BRANCH    ASTAT,USMMB999          * a pre-admission so dont write
.
.         delete the initial MBS codes from PATMMBFD
.
          OPEN      PATMMBS1,"patmmbsf"
          MOVE      ONE,FORM3
          WHILE     FORM3 <= TOTMMBS
            MOVE      INITMMBS[FORM3],KEY11
            CALL      DEMMBS1
            ADD       ONE,FORM3
          DO
.
.         now check what MBS codes have been entered and write these to file
.
          MOVE      ZERO,MMRECN             * clear counter
          MOVE      ZERO,FORM3
          MOVE      OPDAADMN,MMADMN         * set Admission Number
.
          PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
USMMB300  CALL      RKOPPMB1                 * Previous Read on oprpmbaf
          BRANCH    OVRCD,USMMB995
          MATCH     OPPMUNID,OPDAUNIQ        * Same unique number
          GOTO      USMMB995 IF NOT EQUAL
.
          MOVE      OPPMCMBS,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD                * Get Code Description
          IF        OVRCD=1
            MOVE      SP70,IDESC            
          ENDIF
.
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          IF        F4=0
            MOVE      ONE,F4
            MOVE      F4,OPPMSERV            * default to one
          ENDIF
.                                           * set up the "patmmbsf" record
          MOVE      KEY9,MMCODE             * set code
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          PACK      MMDATE,CCENT,CYEAR,CMON,CDAY
.
          UNPACK    SP70,OPSGTISS,OPSGTISE,OPSGTISE,OPSGTIDR
          PACK      KEY11,OPDAUNIQ,OPPMTMNO,SP70
          CALL      RDOPSRG1                * get the right oper start/end time
          MOVE      OPSGTISS,MMSTIM
          MOVE      OPSGTISE,MMETIM
.
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,USMMB500
.                                           * load Start time from selected
          CALL      RCVT0000              * determine time in recovery
.
          LOAD      MMSTIM,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
.                                           * load End time from selected
          LOAD      MMETIM,OPCNTTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
.
USMMB500  MOVE      IDESC,PTMMDESC
          PACK      PTMMOPID,OPDAUNIQ,SP10  * theatre unique no.      *I-207386
          PACK      PTMMTMNO,OPPMTMNO,SP1   * theatre Team No.        *I-207386
          PACK      MMSPARE,SP70
.
USMMB600  COMPARE   "999",MMRECN
          GOTO      USMMB995 IF EQUAL
.
          ADD       ONE,MMRECN              * add to counter
          PACK      KEY11,MMADMN,MMRECN
          CALL      RDAMMBS1
          COMPARE   ZERO,OVRCD
          GOTO      USMMB600 IF EQUAL       * record exists so get new counter
.
          CALL      WRMMBS1                 * write operation record
.
          CALL      WESE0000                * update Episode details
          GOTO      USMMB300
.
.         Sort MBS items into the required order.
.
USMMB995  PROC      SRTMB000
.
USMMB999  RETURN
+
.*********************************************************************
.*                  USCHP000                                         *
.*        Charge patient only if no invoices raised yet              *
.*********************************************************************
.         Check if the patient is discharged. This is necessary, as we
.         need to determine if the patient is a day case patient.
.
USCHP000  MOVE      SP8,DDATE               * default discharge date
          COMPARE   THREE,ASTAT             * patient discharged ?
          GOTO      USCHP100 IF NOT EQUAL   * no
.
          MOVE      OPDAADMN,DADMNO
          MOVE      DADMNO,KEY8
          CALL      RDDSCH1                 * read the discharge record
.
.         loop over the temp file for all MBS items entered
.
USCHP100  MOVE      ZERO,MBSCNT             * initialize op count
          MOVE      Z70,KEY26
          CALL      USDIM000                * delete non-invoiced item records
          READ      INPUSETF,KEY26;;        * position at end of file
.
USCHP111  READKP    INPUSETF;DAMOUNT,DIAMT,PROVITEM,UNIQUE,DIM1B:
                             OPPMGSTA,OPPMGSTC,DOPPMCNT,CONSTYPE,REFNUMBR
          GOTO      USCHP999 IF OVER
.
          COMPARE   "999",MBSCNT
          GOTO      USCHP999 IF EQUAL       * has reached the maximum
.
          ADD       ONE,MBSCNT              * update count number
.
.  Check in theatre fee for the charge
.
          MOVE      SP70,PMMISUNQ
          MOVE      PROVITEM,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,USCHP222           * not on file
.
          IF        PTITGSTA=2
            MOVE      OPPMGSTA,PTITGSTA
            MOVE      OPPMGSTC,PTITGSTC
          ENDIF
.
          MOVE      OPDADATE,CEFFDATE
          CALL      GETTHR00                 * get theatre fee
.         BRANCH    OVRCD,USCHP222
          IF        OVRCD=0
            IF        HFBAND<>0
              UNPACK    DIM5,PMMISUNQ       * Theatre banding
            ENDIF
          ENDIF
.
          MOVE      IDESC,PMMIDESC
          MOVE      DIM1B,OPPMTMNO
          MOVE      REFNUMBER,PMMIREFN       * Reference number
.
          MOVE      MBSCNT,DOPPMCNT
          CALL      USRAT000                 * calculate rate for item & write
.
.         Re-arrange the MBS codes to be posted from highest to lowest charge
.
USCHP222  BRANCH    ONCOLOGY,USCHP111
          MOVE      OPDAUNIQ,OPPMUNID
          MOVE      DIM1B,OPPMTMNO
.
          MOVE      MBSCNT,OPPMCNTR
          MOVE      PROVITEM,OPPMCMBS
          MOVE      REFNUMBR,OPPMREFN      * reference number
          MOVE      ZERO,F4
          MOVE      OPPMSERV,F4
          MOVE      F4,PMMISERV
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR,SP70
          CALL      RAOPPMB1              * Writing To Patient CMBS File
          IF        OVRCD=1
            CALL      WROPPMB1
          ENDIF
          GOTO      USCHP111
.
USCHP999  RETURN
+
.*********************************************************************
.*                  USDIM000                    Called by : USCHP000 *
.*        Delete all the item records for the MBS codes which were on *
.*        file before change mode as long as none are invoiced.      *
.*********************************************************************
USDIM000  MOVE      ZERO,FORM3
          COMPARE   ZERO,TOTDTRA
          GOTO      USDIM9999 IF EQUAL
.
USDIM100  ADD       ONE,FORM3
          COMPARE   FORM3,TOTDTRA
          GOTO      USDIM800 IF LESS        * finished codes
.
          MOVE      INITDTR[FORM3],KEY22    * get the item
          MATCH     SP30,KEY22
          GOTO      USDIM100 IF EQUAL       * no key to delete
.
          UNPACK    KEY22,PMMIVISN,TREF,PMMITRAN
          MATCH     "00000000",TREF
          GOTO      USDIM100 IF NOT EQUAL   * has been invoiced
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RDPMMTI1
          BRANCH    OVRCD,USDIM100          * invalid code
.
.
.>>>>     This item is being deleted, so check if it is a theatre item,
.>>>>     and if so, send an appropriate HL7 message.
.>>>>
.>>>>     MATCH     "2",PMMIRTYP
.>>>>     IF        @EQUAL
.>>>>       CALL      PMIGTNID              * get national id for HL7 write
.>>>>       MOVE      NMPNUMB,PTNINMPI
.>>>>       MOVE      ANSD,HL7ITMFL         * set flag for delete record
.>>>>       MOVE      FOUR,HL7TRGID
.>>>>       MOVE      SP8,HL7INCLD
.>>>>       PROC      DGCLIITM              * send HL7 message
.>>>>     ENDIF
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTI1                * delete un-invoiced item
          GOTO      USDIM100
.
.         clear the array once all items are deleted
.
USDIM800  MOVE      ONE,INVOICED            * set as none invoiced
          MOVE      TOTDTRA,FORM3           * total MBS items
          WHILE     FORM3>0
            MOVE      SP30,INITDTR[FORM3]   * clear the array
            SUB       ONE,FORM3 
          DO
.
USDIM999  RETURN
+
.*********************************************************************
.*                  USRAT000                    Called by : USCHP111 *
.*        Calculate charge rate for an item.                         *
.*        Para's  : PROVITEM      the MBS code                       *
.*                  MBSCNT        which number the code is           *
.*********************************************************************
USRAT000  MOVE      ZERO,PMMIAMTT            * initialize totals
          MOVE      ZERO,PMMIAMTP
          MOVE      ZERO,PMMIRBAT
.
.         Check if prov item will be billed
.
          IF        CHRGPMBS=0
            MATCH     PROVITEM,MBSFCODE
            GOTO      USRAT9999 IF EQUAL
          ENDIF
.
.         If this the claim code is for overseas and to use MBS amount
.
          IF        CMBSFEE=1
            MOVE      TFPAT1,PMMIAMTP
            MOVE      TFHF1,PMMIRBAT
            GOTO      USRAT200
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      USRAT100 IF EQUAL
          ELSE
            COMPARE   "1",PTCNTFEE
            GOTO      USRAT100 IF EQUAL
          ENDIF
.
          MOVE      ZERO,PMMIAMTP      * if theatre fees is not used
          MOVE      ZERO,PMMIRBAT      * zero charges.
          GOTO      USRAT200
.
.         Using Theatre Fee
.
USRAT100  MOVE      ZERO,FORM12P2
          LOAD      FORM12P2,MBSCNT,TFPAT1,TFPAT2,TFPAT3,TFPAT4,TFPAT5,TFPAT6
          MOVE      FORM12P2,PMMIAMTP          * set up patient portion
          MOVE      ZERO,FORM12P2
          LOAD      FORM12P2,MBSCNT,TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
          MOVE      FORM12P2,PMMIRBAT          * set up rebate portion
.
USRAT200  MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT         * set up total
.
.         Write a record to Misc.Theatre item file
.
          MOVE      OPDAADMN,PMMIVISN
          MOVE      AURNO,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      PROVITEM,PMMIITEM
          MOVE      SP70,PMMIDES2
          MOVE      OPDADATE,PMMITDAT
          MOVE      "2",PMMIRTYP
.
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
.
          MOVE      SP10,PMMITDOC
          MOVE      OPDACLIN,PMMIODOC
.
          MOVE      ONE,PMMISERV
          PACK      OPPMSERV,OPPMSERV,SP70
          MATCH     SP70,OPPMSERV
          IF        !@EQUAL
            MOVE      ZERO,F4
            MOVE      OPPMSERV,F4
            MOVE      F4,PMMISERV
          ENDIF
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MULT      PMMISERV,PMMIAMTT
.
          MOVE      CURCASE,FORM2           * get as current case as form2
          MOVE      FORM2,PMMISESS          * set session id as the case number
.
          MOVE      IMISGRP,PMMIMGRP
          MOVE      SP10,PMMIBTCH
          MOVE      ZERO,PMMIINVN
          MOVE      ZERO,PMMIGSTM
          MOVE      PTITGSTA,PMMIGSTA
          MOVE      PTITGSTC,PMMIGSTC
          MOVE      WBSEUID,PMMIWUSR
          MOVE      "0",PMMIMVBR
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
...       MOVE      SP70,PMMISVTM
.                                                             * start *I-206410
USRAT300  UNPACK    SP70,OPSGTISS,OPSGTISE,OPSGTISE,OPSGTIDR
          PACK      KEY11,OPDAUNIQ,OPPMTMNO,SP70
          CALL      RDOPSRG1                * get opr surgical start/end time
          PACK      PMMISVTM,OPSGTISS,SP8   * default - surgical start time
.
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,USRAT400
.                                           * load Start time from selected
          CALL      RCVT0000                * determine time in recovery
.
          LOAD      PMMISVTM,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                      OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                      OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                      OPARTIDP,OPARTETC        * end  *I-206410
.
.         Get last transaction number
.
USRAT400  MOVE      OPDAADMN,KEY8    
          CALL      TRVISA1                 * get next transaction no. PVITRAN
.
          MOVE      PVITRAN,PMMITRAN
          MOVE      OPDAUNIQ,PMMIUNIQ
          PACK      KEY14,PMMIVISN,PMMITRAN
          MOVE      SP70,PMMICNTR
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP1,PMMICCON
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          MOVE      CURRDATE,PMMIDTCR
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
.
          PACK      PMMITMNO,OPPMTMNO,SP70
          PACK      PMMIPMBS,DOPPMCNT,SP70
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
          CALL      WRPMMTI1                * write a record
.
          CALL      MMBONC00
.
.         Add to invoice pending file if necessary
.
. If Using the Invoice Pending File
.
          IF        PTCNIPEN = 0
            CALL      CUIP0000              * Check Inv.pending update flag
.
            MOVE      OPDAADMN,IPADMNO
            MOVE      THREE,IPSYSTM
            MOVE      SP70,IPSITE
.
            MOVE      SP70,PENDHOSP
            IF        IBCNMHOS=1
              PACK      KEY8,IPADMNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
              ENDIF
            ENDIF
            MOVE      " 3",PENDSYST                 * Inpatient
.
            MOVE      PMMITDAT,PENDSDAT             * as at date
            MOVE      ADATE,PENDADAT                * admission date
            MOVE      SP70,PENDDDAT
            IF        ASTAT=3
              CALL      RDDSCH1
              IF        OVRCD=0
                MOVE      DDATE,PENDDDAT            * discharged date
              ENDIF
            ENDIF
            MOVE      AFUNDH,PENDFUND
            MOVE      ACLAIM,PENDCLAM
            CALL      IPRH0000               
            MOVE      SEVEN,PTIPRSTA           
            MOVE      SP70,PTIPSVAR          
.
.           Public hospital, check if there is Item amount
.
            IF        CHOSTYP=1 & CFEETYP=0
              CALL      CINVP000                  * Check for tobe invoiced
              GOTO      USRAT900
            ENDIF
.
.           PACK      KEY8,IPADMNO,SP70
.           CALL      RAIPEN1
.           IF        OVRCD=1
.             CALL      WRIPEN1
.           ELSE
.             CALL      UPIPEN1
.           ENDIF
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RAIPEN1
            IF        OVRCD=1
              CALL      WRIPEN1
            ELSE
              MATCH     SP70,KEY83
              IF        !@EQUAL
                UNPACK    KEY83,PTIPRHLD,PTIPRDES  * restore reason on hold inv.
              ENDIF
              CALL      UPIPEN1
            ENDIF
.
          ENDIF
.
USRAT900  
.
USRAT999  RETURN
+
.--------------------------------------------------------------------------
.         Check Update invoice pending flag
.         UPDTIPEN=0  Update Inv.pending with the previous Reason on hold
.         UPDTIPEN=1  Update Inv.pending with the HF/Claim Reason on hold
.--------------------------------------------------------------------------
CUIP0000  PACK      KEY83,SP70,SP70
          MOVE      PVIBILL,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,CUIP9999
.
          MATCH     SP70,PTIPRHLD
          GOTO      CUIP9999 IF EQUAL     * Inv.currently not on hold
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,CUIP9999
.
          MATCH     "P",TCINDC2
          GOTO      CUIP9999 IF NOT EQUAL
.
          MATCH     "C",TCINDC4
          GOTO      CUIP9999 IF EQUAL             * CodeFocus hold invoice
.
          PACK      KEY83,PTIPRHLD,PTIPRDES,SP70 * save pat.reason on hold inv.
.
CUIP9999  RETURN
+
.*************************************************************************
.*                           GETTHR00                                    *
.*           Sub-routine to get the theatre fee amount                   *
.*                     called by :                                       *
.*************************************************************************
GETTHR00 MOVE      SP1,DIM1A
         MATCH     ADATE,DDATE
         IF        @EQUAL
           MOVE      "D",DIM1A             *  Set up the daycase rate indicator
         ENDIF
.
.        Determine if we are using MBS fee or theatre bandings
.
         PACK      KEY9,ACLAIM,AFUNDH,SP70
         CALL      GETCNEFF               * Get Contract Effective From
         BRANCH    EXIT,GETT900
.
         MOVE      CEFFDATE,TSRVDATE      * Service date
         LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,ANSC,ANSL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
         PACK      KEY18 WITH ACLAIM,AFUNDH,AFNDTB,DIM1A,SP70
         CALL      GETTFEES                * Get theatre amount
         GOTO      GETT999
.
GETT900  MOVE      ONE,OVRCD
GETT999  RETURN
+
.******************************************************************************
.*                 Main Action Routine for Input Expensive Items
.******************************************************************************
OPRIEX00  CALL      VALCAS00
          BRANCH    EXIT,OPRIEX99
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY           * Display Page
          GOTO      OPRIEX20 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Expensive Items
          GOTO      OPRIEX10 IF EQUAL
.
          GOTO      OPRIEX90
.
.***************************************************************************
.                   Add Formaction
.***************************************************************************
OPRIEX10  CALL      ADDEXP00 
          MOVE      ZERO,EXIT
          GOTO      OPRIEX99
.
.**************************************************************************
.                 Display Formaction
.**************************************************************************
OPRIEX20  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Arrival/recovery Details
          BRANCH    OVRCD,OPRIEX91
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,OPRIEX99
.
          MOVE      ZERO,F2
          MOVE      ZERO,SLOTINDX
.
          MOVE      "Input Expensive Items",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRIEX99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRIEX99
.
.*******************************************************************************
.*           Error Handling  For Expensive Items
.*******************************************************************************
OPRIEX90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIEX99
.
OPRIEX91  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIEX99
.
OPRIEX99  RETURN
.******************************************************************************
.*               Moving Cgi Variables To File Variables                       *
.******************************************************************************
SAVIEX00  SQUEEZE QUANTKEY[F3] 
          MOVE    EXPITKEY[F3],OPPECODE
          MOVE    COUNT[F3],OPPECNTR
          MOVE    QUANTKEY[F3],OPPEQUAN
          MOVE    NOCHARGE[F3],OPPECHRG
          MOVE    BROKENIT[F3],OPPEBROK
          MOVE    OPDAUNIQ,OPPEUNID
          MOVE    TEAMNUMB,OPPETMNO
          MOVE    SP70,OPPESPAR
.
SAVIEX99  RETURN
.******************************************************************************
.*               Add Multiple Theatre Expensive Items                         *
.******************************************************************************
ADDEXP00 MOVE      ZERO,F3
          WHILE     F3<SLOTINDX
            PACK      KEY13,OPDAUNIQ,TEAMNUMB,Z70
            CALL      RSOPPEI1                * Sequential Read for Exp. Table
            CALL      RPOPPEI1
            BRANCH    OVRCD,ADDEXP20
            MATCH     OPDAUNIQ,OPPEUNID
            GOTO      ADDEXP20 IF NOT EQUAL
            MATCH     TEAMNUMB,OPPETMNO
            GOTO      ADDEXP20 IF NOT EQUAL
.
            MOVE      OPPECNTR,MBSCOUNT
            GOTO      ADDEXP30
ADDEXP20    MOVE      ZERO,MBSCOUNT
ADDEXP30    ADD       ONE,F3
            ADD       ONE,MBSCOUNT
            CALL      CLOPRPEI              * Clear File Variables
            CALL      SAVIEX00              * Moving Cgi variables To File Var.
            MATCH     SP70,OPPECODE
            IF        !@EQUAL
              MOVE      MBSCOUNT,OPPECNTR
              PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPECNTR,SP70
              UNPACK    KEY13,OPPMUNID,OPPMTMNO,DOPPECNT
              MOVE      DOPPECNT,OPPECNTR
              CALL      RAOPPEI1              * Writing To Patient CMBS File
              IF        OVRCD=1
                CALL      WROPPEI1            * Writing To Patient CMBS File
              ENDIF
.
              MATCH     "1",OPPECHRG
              IF        !@EQUAL
                PACK      KEY6,OPPECODE,SP70    * read expensive item file
                CALL      RDOPEXP1              * to get the misc.charge code
                IF        OVRCD=0
                  PACK      DIM9,OPEXMCHG,SP10
                  MOVE      OPPEQUAN,FORM3
                  IF        OPCNXCHG=1
                    CALL      MISCHG00      * get charges for the expensive code
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          DO
.
ADDEXP99  RETURN
.******************************************************************************
.*                 Main Action Routine for Expensive Items Maintenance        *
.******************************************************************************
OPREXP00  CALL      VALCAS00                * validation for CASEKEYS
          BRANCH    EXIT,OPREXP99
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Check for record 
          BRANCH    OVRCD,OPREXP92
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPREXP40 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Expensive Item
          GOTO      OPREXP20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Expensive Item
          GOTO      OPREXP30 IF EQUAL
          GOTO      OPREXP90
.
.******************************************************************************
.*         Update Expensive Item                                              *
.******************************************************************************
OPREXP20  PACK      OPPEI001,OPPEI001,SP70
          PACK      KEY19,OPPEI001,OPDAUNIQ,TEAMNUMB,OPPEI002,SP70
          CALL      RDOPPEI2
          BRANCH    OVRCD,OPREXP99
.
          MOVE      ZERO,FORM8
          MOVE      OPPEQUAN,FORM8    * Save original quantity
          PACK      KEY19,OPPEI001,OPDAUNIQ,TEAMNUMB,DOPPECNT,SP70
          CALL      RLOPPEI2
          BRANCH    OVRCD,OPREXP91,OPREXP93
.
          CALL      SAVEXP00
          CALL      UPOPPEI2          * Update in Exp. Table
          CALL      UUOPPEI2
.
..        MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
..        CALL      WEBERR00
..
          MOVE      ZERO,EXIT
          GOTO      OPREXP99
.
.******************************************************************************
.*         Delete Expensive Item                                              *
.******************************************************************************
OPREXP30  PACK      OPPEI001,OPPEI001,SP70
          PACK      KEY19,OPPEI001,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPEI2
          CALL      RKOPPEI2
          BRANCH    OVRCD,OPREXP91
.
          MATCH     OPPEI001,OPPECODE
          GOTO      OPREXP91 IF NOT EQUAL    * Error Record NOt Exist
          MATCH     OPDAUNIQ,OPPEUNID
          GOTO      OPREXP91 IF NOT EQUAL    * Error Record NOt Exist
          MATCH     TEAMNUMB,OPPETMNO
          GOTO      OPREXP91 IF NOT EQUAL    * Error Record NOt Exist
.
          PACK      KEY19,OPPECODE,OPPEUNID,OPPETMNO,DOPPECNT,SP70
          CALL      RLOPPEI2
          BRANCH    OVRCD,OPREXP91,OPREXP93
          CALL      DEOPPEI2                * Delete in Exp. Table
.
..        MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
..        CALL      WEBERR00
..
.
          MOVE      ZERO,EXIT
          GOTO      OPREXP99
.
.******************************************************************************
.*         Display of Expensive items                                         *
.******************************************************************************
OPREXP40  PACK      KEY19,OPPEI001,OPDAUNIQ,TEAMNUMB,OPPEI002,SP70
          CALL      RDOPPEI2
          IF        OVRCD=1
            CALL      CLOPRPMB
            MOVE      TEAMNUMB,OPPETMNO
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical details
          BRANCH    OVRCD,OPREXP95
.
          MOVE      "Theatre Expensive Items Maintenance",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPREXP99
.          
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.******************************************************************************
.*                          ERROR HANDLING                                    *
.******************************************************************************
OPREXP90  MOVE      "Invalid Form Option",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP91  MOVE      "No Record in Patient Expensive table.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP92  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP93  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP94  MOVE      "Invalid Expensive Item Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP95  MOVE      "Theatre Details must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPREXP99
.
OPREXP99  RETURN
.**********************************************************************
.               Check for Mandatory Fields
.**********************************************************************
CHKEXP00  MOVE      ZERO,EXIT
          RESET     OPPEI001
          MATCH     SP70,OPPEI001           * Check for Blank Item Code
          GOTO      CHKEXP90 IF NOT EQUAL
.
CHKEXP90  MOVE      "Expensive Item Code is Blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKEXP99
.
CHKEXP99  RETURN
.******************************************************************************
.*                 Routine for moving CGI Variables                           *
.******************************************************************************
SAVEXP00  MOVE      SP70,OPPESPAR
          MOVE      OPDAUNIQ,OPPEUNID
          MOVE      TEAMNUMB,OPPETMNO
          MOVE      OPPEI001,OPPECODE
          MOVE      OPPEI003,OPPEQUAN
          MOVE      OPPEI004,OPPECHRG
          MOVE      OPPEI005,OPPEBROK
.
SAVEXP99  RETURN
.******************************************************************************
.*                 Main Action Routine for Thetre Implant Maintenance         *
.******************************************************************************
OPRIMP00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRIMP40 IF EQUAL
.
          MATCH     "H",UPDATETY
          GOTO      OPRIMP40 IF EQUAL       * Ad-hoc Implants
.
          MATCH     "A",UPDATETY            * Add Implant Code
          GOTO      OPRIMP10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Implant Code
          GOTO      OPRIMP20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Implant Code
          GOTO      OPRIMP30 IF EQUAL
.
          GOTO      OPRIMP90
.******************************************************************************
.*         Add Implant Code                                                   *
.******************************************************************************
OPRIMP10  PACK      KEY75,OPTHI001,OPTHI012,SP70
          CALL      RDOPTHI1                * Check If Record Already Exists
          COMPARE   ZERO,OVRCD
          GOTO      OPRIMP91 IF EQUAL
.
.         Check if Barcode already exists for a different EAN
.
          MATCH     "1",OPCNSIVB
          IF        @EQUAL
            PACK      KEY75,OPTHI012,SP70
            CALL      RSOPTHI3
            CALL      RKOPTHI3
            BRANCH    OVRCD,OPRIMP12
            MATCH     OPTIBCOD,OPTHI012          * same barcode?
            GOTO      OPRIMP12 IF NOT EQUAL      * No
.
            CLEAR     WEBTITLE
            APPEND    "Barcode already exists for item ",WEBTITLE
            APPEND    OPTICODE,WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
.
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      OPRIMP99
          ENDIF
.
OPRIMP12  CALL      SAVIMP00                * Moving Input Variable To File Var
          CALL      WROPTHI1                * Adding New Record
.
          MOVE      ZERO,EXIT
          GOTO      OPRIMP99
.******************************************************************************
.*         Update Implant Code                                                *
.******************************************************************************
OPRIMP20  PACK      KEY75,OPTHI001,OPTHI012,SP70
          CALL      RLOPTHI1                * Readlock File Record
          BRANCH    OVRCD,OPRIMP92,OPRIMP93
.
          CALL      SAVIMP00                * Moving Input Variable To File Var
          CALL      UPOPTHI1
          CALL      UUOPTHI1                * Unlock File Record
.
          MOVE      ZERO,EXIT
          GOTO      OPRIMP99
.******************************************************************************
.*         Delete Implant Code                                                *
.******************************************************************************
OPRIMP30  PACK      KEY75,OPTHI001,OPTHI012,SP70
          CALL      RLOPTHI1                * Check If Record Does Not Exist
          BRANCH    OVRCD,OPRIMP92,OPRIMP93
.
          CALL      DEOPTHI1                * Deletes The Record
.
          MOVE      ZERO,EXIT
          GOTO      OPRIMP99
.******************************************************************************
.*         Display of Theatre Implant Codes                                   *
.******************************************************************************
OPRIMP40  MATCH     "H",UPDATETY
          GOTO      OPRIMP42 IF EQUAL       * Ad-hoc Implants
.
          PACK      KEY75,OPTHI001,OPTHI012,SP70
          CALL      RDOPTHI1                * Reading From Implant Code File
          IF        OVRCD=1
            CALL      CLOPRTHI              * Clear all the file variables
          ENDIF
.
OPRIMP42  MOVE      "Implant Maintenance",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRIMP99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End Of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRIMP99
.******************************************************************************
.*                 Error Handling (IMPLANT CODE DETAILS)                      *
.******************************************************************************
OPRIMP90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIMP99
.
OPRIMP91  MOVE      "Implant Code Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIMP99
.
OPRIMP92  MOVE      "Implant Code Does Not Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIMP99
.
OPRIMP93  MOVE      "Record  Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRIMP99
.
OPRIMP99  RETURN
+
.*******************************************************************************
.*                 Moves Cgi Variables into File Variables                     *
.*******************************************************************************
SAVIMP00  MOVE      OPTHI001,OPTICODE
          MOVE      OPTHI002,OPTIDESC
          MOVE      OPTHI003,OPTITYIM
          MOVE      OPTHI004,OPTIMCHG
          MOVE      OPTHI005,OPTIMANU
          MOVE      OPTHI006,OPTISIZE
          MOVE      OPTHI007,OPTISUPP
          MOVE      OPTHI008,OPTICOST
          MOVE      OPTHI009,OPTICOPC
          MOVE      OPTHI010,OPTISTAT
          MOVE      OPTHI011,OPTIREGI
          MOVE      OPTHI012,OPTIBCOD
          MOVE      SP70,OPTISPAR
.
          MOVE      DTRRE001,TRECEIPT                 * I CAR 40412
          MOVE      DTRRE001,PMMIREFN
.
SAVIMP99  RETURN
.******************************************************************************
.*                 Main Action Routine for Patient Implant Details            *
.******************************************************************************
OPRPID00  CALL      VALCAS00
          BRANCH    EXIT,OPRPID99
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=1
            CALL      CLOPRDEA
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Check for record 
          BRANCH    OVRCD,OPRPID95
.
          RESET     UPDATETY
          MATCH     UPDATETY,SP70
          GOTO      OPRPID40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Patient Implant
          GOTO      OPRPID10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Patient Implant
          GOTO      OPRPID20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Patient Implant
          GOTO      OPRPID30 IF EQUAL
.
          MATCH     "H",UPDATETY            * Assign Ad-hoc Implant
          GOTO      OPRPID20 IF EQUAL
.
          GOTO      OPRPID90
.******************************************************************************
.*         Add Patient Implant                                                *
.******************************************************************************
OPRPID10  MATCH     "1",OPCNSIVB
          GOTO      OPRPID12 IF NOT EQUAL   * Not using barcode
.
          CALL      BCOD0000          * Add implant by barcde
          BRANCH    EXIT,OPRPID99
.
          GOTO      OPRPID18
.
OPRPID12  CALL      CHKPID00          * Check for Implant Code
          BRANCH    EXIT,OPRPID99     * blank code.
.
.         Get the next counter
.
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,Z70
          CALL      RSOPPIM1
          CALL      RPOPPIM1
          BRANCH    OVRCD,OPRPID14
.
          MATCH     OPDAUNIQ,OPPIUNID
          GOTO      OPRPID14 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPITMNO
          GOTO      OPRPID14 IF NOT EQUAL
          ADD       ONE,OPPICNTR
          GOTO      OPRPID16
.
OPRPID14  MOVE      ONE,OPPICNTR
OPRPID16  CALL      CLOPRPIM
          CALL      SAVPID00
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPICNTR,SP70
          CALL      RAOPPIM1
          IF        OVRCD=0
            ADD       ONE,OPPICNTR
          ENDIF
          CALL      WROPPIM1          * write a new record
.
          PACK      KEY75,OPPIM001,OPPIM010,SP70
          CALL      RDOPTHI1          * check if implant code already exists
          IF        OVRCD=1
            CALL      CLOPRTHI
            CALL      SAVTID00
            MOVE      ZERO,OPTISTAT   * Set implant status to ACTIVE
            MOVE      SP70,OPTIAIMP   * No Ad-hoc Implant
            CALL      WROPTHI1        * write a new record to theatre implant
          ENDIF
.
          RESET     OPTIMCHG
          MATCH     SP70,OPTIMCHG     * Check for Misc.Charge Code
          IF        !@EQUAL
            PACK      DIM9,OPTIMCHG,SP70
            MOVE      OPPIIQTY,FORM3
.
            IF        OPCNXCHG=1
              CALL      MISCHG00      * get charges for the misc.charge code
.
              PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPICNTR      * I CAR 40412
              CALL      RDOPPIM1
              IF        OVRCD=0
                MOVE      PMMITRAN,OPPIDTRT 
                CALL      UPOPPIM1
              ENDIF
.                                                             * end I CAR 40412
            ENDIF
          ENDIF
.
OPRPID18  MOVE      "017",TADTTYPE            * write theatre item audit detail
          PROC      OPTHETAT
.
          MOVE      ZERO,EXIT
          GOTO      OPRPID99
.******************************************************************************
.*         Update Patient Implant                                             *
.******************************************************************************
OPRPID20  MOVE      "Patient Implant Table",KEY24
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,ICOUNTER,SP70
          CALL      RLOPPIM1
          BRANCH    OVRCD,OPRPID94,OPRPID91
.
          MATCH     "H",UPDATETY      * Assign Ad-hoc Implant
          IF        @EQUAL
            CALL      GTHI0000        * Get Implant details
          ELSE
            CALL      SAVPID00        * Save routine for Patient Implants
          ENDIF
          CALL      UPOPPIM1          * Update Patient Implant Table
          CALL      UUOPPIM1          * unlock the record
          CALL      UBIL0000          * Updating billing - pmsmtiaf file
          CALL      UBAR0000          * Update other patients for the barcode
.
          CALL      UPRS0000      * Update Prosthetic input complete if required
.
.         MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
.         CALL      WEBERR00
.
.         MOVE      ZERO,EXIT
.
          CALL      WARNIM00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.******************************************************************************
.*         Delete Patient Implant                                             *
.******************************************************************************
OPRPID30  PACK      KEY13,OPDAUNIQ,TEAMNUMB,ICOUNTER,SP70
          CALL      RLOPPIM1
          MOVE      "Patient Implant Table",KEY24
          BRANCH    OVRCD,OPRPID94,OPRPID91
.
          PACK      KEY13,OPPIUNID,OPPITMNO,OPPICNTR,SP70
          CALL      DEOPPIM1          * Delete the record from
.                                     * Patient Implant Table
.
          CALL      RCHR0000          * Remove item charge from pmsmtiaf
.
.          MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
.          CALL      WEBERR00
.
.OPRPID32  MOVE      ZERO,EXIT
.
          CALL      WARNIM00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
.******************************************************************************
.*         Display of Patient Implant Details                                 *
.******************************************************************************
OPRPID40  CLEAR     WEBTITLE
          MOVE      "Patient Implant Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical details
          BRANCH    OVRCD,OPRPID92
.
          MOVE      "Operating Room Table",KEY24     * for error routine
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1                * Read Operating Room table
          BRANCH    OVRCD,OPRPID94
.
          MATCH     "1",OPCNSIVB
          GOTO      OPRPID42 IF NOT EQUAL
.
          PACK      OPPIM010,OPPIM010,SP70
          PACK      KEY75,OPPIM010,OPPIM001,SP70
          CALL      RDOPTHI3
          COMPARE   ZERO,OVRCD
          GOTO      OPRPID44 IF EQUAL
.
          PACK      KEY75,OPPIM010,SP70     * try with blank EAN number
          CALL      RDOPTHI3
          BRANCH    OVRCD,OPRPID43
          GOTO      OPRPID44
.
OPRPID42  PACK      KEY75,OPPIM001,OPPIM010,SP70
          CALL      RDOPTHI1                * Read Theatre implant table
          COMPARE   ZERO,OVRCD
          GOTO      OPRPID44 IF EQUAL
.
OPRPID43  CALL      CLOPRTHI
.
OPRPID44  PACK      KEY13,OPDAUNIQ,TEAMNUMB,ICOUNTER,SP70
          CALL      RDOPPIM1               * Read Patient implant table
          IF        OVRCD=1
            CALL    CLOPRPIM
          ENDIF
.
          MOVE      SP10,TRECEIPT
          PACK      KEY22,ADMISSNO,SP70     * I CAR 40412
          CALL      RDSDTRN1
OPRPID45  CALL      RDKDTRN1
          BRANCH    OVRCD,OPRPID46
.
          MATCH     DTADMNO,ADMISSNO
          GOTO      OPRPID46 IF NOT EQUAL
.
          MATCH     DTTRANSN1,OPPIDTRT
          GOTO      OPRPID45 IF NOT EQUAL     * end I CAR 40412
.
          MATCH     "1",PTDTCRST
          GOTO      OPRPID45 IF EQUAL         * Fully credited
.
          MATCH     "2",PTDTCRST
          GOTO      OPRPID45 IF EQUAL         * Credit by item
          GOTO      OPRPID48
.
OPRPID46  PACK      KEY14,ADMISSNO,SP20
          CALL      RSPMMTI1
OPRPID47  CALL      RKPMMTI1
          BRANCH    OVRCD,OPRPID48
.
          MATCH     PMMIVISN,ADMISSNO
          GOTO      OPRPID48 IF NOT EQUAL
.
          MATCH     PMMITRAN,OPPIDTRT
          GOTO      OPRPID47 IF NOT EQUAL
          MOVE      PMMIREFN,TRECEIPT
.
OPRPID48  CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRPID99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
.
          GOTO      OPRPID99
.******************************************************************************
.*                      ERROR HANDLING                                        *
.******************************************************************************
OPRPID90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID91  MOVE      "Record Locked",WEBTITLE
          APPEND    KEY24,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID92  MOVE      "Theatre Details must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID93  MOVE      "Error: Duplicate record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID94  MOVE      "Error:Record does not exist in ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    KEY24,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID95  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPID99
.
OPRPID99  RETURN
+
.*****************************************************************************
.         Get implant details
.*****************************************************************************
GTHI0000  PACK      KEY75,OPPIM001,SP70 * check if EAN number exists
          CALL      RSOPTHI1
GTHI1000  CALL      RKOPTHI1
          BRANCH    OVRCD,GTHI2000
          MATCH     OPTICODE,OPPIM001
          GOTO      GTHI2000 IF NOT EQUAL   * exisiting EAN number
.
          MATCH     OPTIBCOD,OPPIBCOD
          GOTO      GTHI1000 IF NOT EQUAL   * different barcode
.
.         Update EAN number to the Barcode
.
          MOVE      OPPIM001,OPTICODE
          CALL      UPOPTHI1
          GOTO      GTHI4000
.
.         the new EAN Number does not exit - update the barcode with blank EAN
.
GTHI2000  PACK      KEY75,OPPIBCOD,SP70
          CALL      RDOPTHI3
          BRANCH    OVRCD,GTHI4000
.
          MOVE      OPPIBCOD,OPTHI012    * Patient Barcode
          MOVE      OPTHI001,DIM15
          SQUEEZE   DIM15
          PACK      OPTICODE,DIM15,SP70     * Move cgi-parameters to file
          MOVE      OPTHI002,OPTIDESC       * variables of Patient Implant Table
          MOVE      OPTHI003,OPTITYIM
          MOVE      OPTHI004,OPTIMCHG
          MOVE      OPTHI005,OPTIMANU
          MOVE      OPTHI006,OPTISIZE
          MOVE      OPTHI007,OPTISUPP
          MOVE      OPTHI008,OPTICOST
          MOVE      OPTHI012,OPTIBCOD
          MOVE      SP70,OPTIAIMP       * No Ad-hoc Implant
          CALL      UPOPTHI3            * write a new record to theatre implant
.
GTHI4000  MOVE      OPPIM001,OPPIICDE   * New EAN number
          MOVE      OPPIM002,OPPIIQTY   * Quantity
          PACK      OPPILTSN,OPPIM003,SP70   * Lot/Serial No
          MOVE      OPPIM005,OPPILOCA   * Location
          MOVE      "0",OPPIAIMP        * not an Ad-hoc Implant anymore
.
          MOVE      OPPIUY01,OPPIM011   * 'Not used' field
          MOVE      OPPIUC01,OPPIM012   * Reason not used
          PACK      OPPIUUID,USERNAME,SP70 * User name
          CALL      IBACLOCK
          MOVE      CURRDATE,OPPIUDAT
          CLOCK     TIME,OPPIUTIM
.
GTHI9999  RETURN
+
.*****************************************************************************
.         Add implant for using Barcode
.*****************************************************************************
BCOD0000  CALL      CHKPID00          * Check for Implant Code
          BRANCH    EXIT,BCOD9999     * blank code.
.
          MOVE      "0",OPTIAIMP      * Ad-hoc implant
          PACK      KEY75,OPPIM010,OPPIM001,SP70
          CALL      RDOPTHI3
          COMPARE   ZERO,OVRCD
          GOTO      BCOD2000 IF EQUAL * record exists
.
          PACK      KEY75,OPPIM010,SP70
          CALL      RDOPTHI3
          COMPARE   ZERO,OVRCD
          GOTO      BCOD2000 IF EQUAL * exists with blank EAN number
.
          PACK      KEY60,OPPIM010,SP70
          PACK      KEY75,KEY60,SP70
          CALL      RSOPTHI3          * check if exists with EAN number
          CALL      RKOPTHI3
          BRANCH    OVRCD,BCOD1000
.
          MATCH     OPTIBCOD,KEY60
          GOTO      BCOD2000 IF EQUAL * Barcode exists
.
.         Write the barcode to oprthiaf
.
BCOD1000  CALL      CLOPRTHI
          CALL      SAVTID00
          MOVE      ZERO,OPTISTAT   * Set implant status to ACTIVE
          MOVE      "1",OPTIAIMP    * Ad-hoc implant
.
          PACK      KEY75,OPTICODE,OPTIBCOD
          CALL      WROPTHI1        * write a new record to theatre implant
.
.         Get the next counter
.
BCOD2000  PACK      KEY13,OPDAUNIQ,TEAMNUMB,Z70
          CALL      RSOPPIM1
          CALL      RPOPPIM1
          BRANCH    OVRCD,BCOD3000
.
          MATCH     OPDAUNIQ,OPPIUNID
          GOTO      BCOD3000 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPITMNO
          GOTO      BCOD3000 IF NOT EQUAL
          ADD       ONE,OPPICNTR
          GOTO      BCOD4000
.
BCOD3000  MOVE      ONE,OPPICNTR
BCOD4000  CALL      CLOPRPIM
          CALL      SAVPID00
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPICNTR,SP70
          CALL      RAOPPIM1
          IF        OVRCD=0
            ADD       ONE,OPPICNTR
          ENDIF
          MOVE      OPTICODE,OPPIICDE      * EAN number
          MOVE      OPTIAIMP,OPPIAIMP      * set Ad-hoc Implant
          CALL      WROPPIM1               * write a new record
.
BCOD5000  CALL      CHRG0000        * Check if Chargeable
          BRANCH    EXIT,BCOD9999   * not used and not chargeable
.
          RESET     OPTIMCHG
          MATCH     SP70,OPTIMCHG     * Check for Misc.Charge Code
          IF        !@EQUAL
            PACK      DIM9,OPTIMCHG,SP70
            MOVE      OPPIIQTY,FORM3
.
            IF        OPCNXCHG=1
              CALL      MISCHG00      * get charges for the misc.charge code
              PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPICNTR      * I CAR 40412
              CALL      RDOPPIM1
              IF        OVRCD=0
                MOVE      PMMITRAN,OPPIDTRT
                CALL      UPOPPIM1
              ENDIF
            ENDIF
          ENDIF
          CALL      UPRS0000      * Update Prosthetic input complete if required
.
BCOD9999  RETURN
+
.*****************************************************************************
.         Update Prosthetic items complete field
.*****************************************************************************
UPRS0000  MOVE      ONE,EXIT
          MATCH     "1",PTCNPROS
          GOTO      UPRS9999 IF NOT EQUAL  * Not prosthetic item complete field
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,UPRS9999
.
          MATCH     Z70,OPDEA043
          GOTO      UPRS9999 IF EQUAL
.
          MOVE      OPDEA043,OPDAPCOM       * Prosthetic items complete
          CALL      UPOPDEA1
.
          MOVE      ZERO,EXIT
UPRS9999  RETURN
+
.*****************************************************************************
.         Remove Implant item code from pmsmtiaf file
.*****************************************************************************
RCHR0000  PACK      KEY75,OPPIICDE,OPPIBCOD,SP70
          CALL      RDOPTHI1                * Reading From Implant Code File
          BRANCH    OVRCD,RCHR9999
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,RCHR9999
          MOVE      OPDAADMN,ADMISSNO
.
          MOVE      "3",KEY1
          PACK      KEY15,ADMISSNO,KEY1,SP70
          CALL      RSPMMTI2
RCHR1000  CALL      RKPMMTI2
          BRANCH    OVRCD,RCHR9999
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      RCHR9999 IF NOT EQUAL
.
          MATCH     KEY1,PMMIRTYP            * Is record type of Misc.Item?
          GOTO      RCHR9999 IF NOT EQUAL
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      RCHR1000 IF NOT EQUAL   * No
.
          MATCH     PMMIITEM,OPTIMCHG
          GOTO      RCHR1000 IF NOT EQUAL
.
          MATCH     OPPIDTRT,PMMITRAN
          GOTO      RCHR1000 IF NOT EQUAL
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
.
RCHR9999  RETURN
+
.*****************************************************************************
.*          Check if "Implant Code" is chargeable                            *
.*****************************************************************************
CHKPID00  MATCH     "1",OPCNSIVB
          GOTO      CHKPID60 IF NOT EQUAL   * Not using Barcode search
.
          RESET     OPPIM010                * using barcode
          MATCH     OPPIM010,SP70
          GOTO      CHKPID90 IF EQUAL
          GOTO      CHKPID70
.
CHKPID60  RESET     OPPIM001                * using EAN number
          MATCH     OPPIM001,SP70
          GOTO      CHKPID90 IF EQUAL
.
CHKPID70  MOVE      ZERO,EXIT
          COMPARE   ONE,OPCNXCHG
          GOTO      CHKPID99 IF NOT EQUAL      * Not charging Misc.Item
.
          MOVE      OPDAADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CHKPID99             * Not an admission
.
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            CALL      RDPMVX11
            MOVE      SP10,PTHSDCLM
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
          ENDIF
.
          MATCH     "1",OPCNSIVB
          IF        @EQUAL
            CALL      CHRG0000                   * Check if Chargeable
            BRANCH    EXIT,CHKPID98              * not chargeable
.
            PACK      KEY75,OPPIM010,OPPIM001
            CALL      RDOPTHI3
            COMPARE   ZERO,OVRCD
            GOTO      CHKPID80 IF EQUAL
.
            PACK      KEY75,OPPIM010,SP70        * try with blank EAN
            CALL      RDOPTHI3
            COMPARE   ZERO,OVRCD
            GOTO      CHKPID80 IF EQUAL          * found barcode with blank EAN
.
            PACK      KEY60,OPPIM010,SP70
            PACK      KEY75,KEY60,SP70
            CALL      RSOPTHI3                   * Try barcode with EAN
            CALL      RKOPTHI3
            BRANCH    OVRCD,CHKPID80
            MATCH     OPTIBCOD,KEY60             * Same barcode?
            IF        !@EQUAL
              MOVE       ONE,OVRCD
              GOTO       CHKPID80
            ENDIF
            PACK      KEY75,OPTICODE,OPPIM010,SP70
            CALL      RDOPTHI1                 * Read Theatre Implants Table
          ENDIF
.
CHKPID80  IF        OVRCD=0
            PACK      MCHARGE,OPTIMCHG,SP70
          ELSE
            PACK      MCHARGE,OPTHI004,SP70
          ENDIF
          MATCH     SP70,MCHARGE
          GOTO      CHKPID98 IF EQUAL           * No Misc.charge
.
          CALL      GETMSC00
          BRANCH    EXIT,CHKPID91
.
          GOTO      CHKPID99
.
CHKPID90  MOVE      "Implant code  must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKPID99
.
CHKPID91  CLEAR     WEBTITLE
          APPEND    "Misc.Item is Invalid/Inactive - ",WEBTITLE
          APPEND    MCHARGE,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKPID99
.
CHKPID98  MOVE      ZERO,EXIT
CHKPID99  RETURN
+
.*****************************************************************************
.*           Check if Item is used and chargeable                            *
.*****************************************************************************
CHRG0000  MATCH     "1",OPPIM011
          GOTO      CHRG9000 IF NOT EQUAL      * Used
.
          MATCH     SP70,OPPIM012
          GOTO      CHRG9000 IF EQUAL
          MOVE      "oE",KEY2
          PACK      KEY5,KEY2,OPPIM012
          CALL      RDCODE1
          BRANCH    OVRCD,CHRG9000
.
          MATCH     "N",TCINDC1
          GOTO      CHRG9000 IF NOT EQUAL
.
          MOVE      ONE,EXIT                * Item is not used & not chargeable
          GOTO      CHRG9999
.
CHRG9000  MOVE      ZERO,EXIT
CHRG9999  RETURN
+
.*****************************************************************************
.*           Write/Update Record to Patient & Theatre Implant Table          *
.*****************************************************************************
SAVTID00  MOVE      OPTHI001,DIM15
          SQUEEZE   DIM15
          PACK      OPTICODE,DIM15,SP70     * Move cgi-parameters to file
          MOVE      OPTHI002,OPTIDESC       * variables of Patient Implant Table
          MOVE      OPTHI003,OPTITYIM
          MOVE      OPTHI004,OPTIMCHG
          MOVE      OPTHI005,OPTIMANU
          MOVE      OPTHI006,OPTISIZE
          MOVE      OPTHI007,OPTISUPP
          MOVE      OPTHI008,OPTICOST
          MOVE      OPTHI009,OPTICOPC
          MOVE      OPTHI010,OPTISTAT
          MOVE      OPTHI011,OPTIREGI
          MOVE      OPTHI012,OPTIBCOD
.
SAVTID99  RETURN
.*****************************************************************************
.*           Write/Update Record to Patient & Theatre Implant Table          *
.*****************************************************************************
SAVPID00  MOVE      OPDAUNIQ,OPPIUNID       * Move cgi-parameters to file
          MOVE      TEAMNUMB,OPPITMNO       * variables of Patient Implant Table
          MOVE      OPPIM001,OPPIICDE
          MOVE      OPPIM002,OPPIIQTY
          MOVE      OPPIM003,OPPILTSN
          MOVE      OPPIM004,OPPICOST
          MOVE      OPPIM005,OPPILOCA
          MOVE      OPPIM007,OPPIONUM
          MOVE      OPPIM008,OPPIICOS
          MOVE      OPPIM009,OPPIUF01
          PACK      OPPIBCOD,OPPIM010,SP70
          MOVE      OPPIM011,OPPIUY01
          MOVE      OPPIM012,OPPIUC01
.
SAVPID99  RETURN
+
.*****************************************************************************
.*           Updating billing file                                           *
.*****************************************************************************
UBIL0000  MATCH     "1",OPCNSIVB            * Search via barcode ?
          GOTO      UBIL7000 IF NOT EQUAL
.
          CALL      CHRG0000                * Check if Chargeable
          BRANCH    EXIT,UBIL6000           * not used and not chargeable
.
.         Chargeable - make sure it has a record in pmsmtiaf file
.
          PACK      KEY14,ADMISSNO,OPPIDTRT,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,UBIL5000
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      UBIL8000 IF EQUAL
.
.         Write a record in pmsmtiaf
.
UBIL5000  RESET     OPTIMCHG
          MATCH     SP70,OPTIMCHG     * Check for Misc.Charge Code
          GOTO      UBIL9999 IF EQUAL
          PACK      DIM9,OPTIMCHG,SP70
          MOVE      OPPIIQTY,FORM3
.
          COMPARE   ONE,OPCNXCHG
          GOTO      UBIL9999 IF NOT EQUAL
.
          CALL      MISCHG00      * get charges for the misc.charge code
.
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,OPPICNTR      * I CAR 40412
          CALL      RDOPPIM1
          IF        OVRCD=0
            MOVE      PMMITRAN,OPPIDTRT
            CALL      UPOPPIM1
          ENDIF
          GOTO      UBIL9999
.
.         Not chargeable - remove pmsmtiaf record
.
UBIL6000  PACK      KEY14,ADMISSNO,OPPIDTRT,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,UBIL9999
.
          MATCH     "3",PMMIRTYP            * Is record type of Misc.Item?
          GOTO      UBIL9999 IF NOT EQUAL
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      UBIL9999 IF NOT EQUAL   * No
.
          MATCH     PMMIITEM,OPTIMCHG
          GOTO      UBIL9999 IF NOT EQUAL      * Not same item
.
          CALL      DEPMMTI1
          GOTO      UBIL9999
.
.         Update pmsmtiaf with the new quantity and amount
.
UBIL7000  PACK      KEY14,ADMISSNO,OPPIDTRT,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,UBIL9999
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      UBIL9999 IF NOT EQUAL   * No
.
UBIL8000  IF        OPPIIQTY=0
            MOVE      ONE,OPPIIQTY          * default to one quantity
          ENDIF
          MOVE      OPPIIQTY,PMMISERV       * update quantity
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
.
          MATCH     "H",UPDATETY            * Assign Ad-hoc Implant
          IF        @EQUAL
            PACK      DIM9,OPTHI004,SP70    * Update with assigned Misc.item
            MOVE      PMMISERV,FORM3
            CALL      SMTI0000              * Set up misc.theatre item record
          ENDIF
.
          MOVE      CURRDATE,PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          GOTO      UBIL9999
.
.
UBIL9999  RETURN
+
***************************************************************************
.         Update all other patients implant for the barcode
***************************************************************************
UBAR0000  MATCH    "H",UPDATETY                * Assign Ad-hoc Implant
          GOTO     UBAR9999 IF NOT EQUAL
.
          PACK     KEY73,OPTIBCOD,SP70         * position on the barcode
          CALL     RSOPPIM3
UBAR10000 CALL     RKOPPIM3
          BRANCH   OVRCD,UBAR9999
.
          MATCH    OPTIBCOD,OPPIBCOD
          GOTO     UBAR9999 IF NOT EQUAL       * different barcode
.
          MATCH    SP70,OPPIICDE               * Blank EAN?
          GOTO     UBAR8000 IF NOT EQUAL       * Not an adhoc implant
.
          MATCH    "1",OPPIAIMP                * Still Adhoc ?
          GOTO     UBAR1000 IF NOT EQUAL       * No
.
          MOVE     OPTICODE,OPPIICDE           * Update the barcode
.
UBAR8000  MOVE     "0",OPTIAIMP                * not an adhoc implant
          CALL     UPOPPIM3
          GOTO     UBAR1000
.
UBAR9999  RETURN
+
***************************************************************************
.              Misc Charge Code Check
.**************************************************************************
MISCHG00  MOVE     OPDAADMN,KEY8
          CALL     RDMISS1
          BRANCH   OVRCD,MISCHG99          * Not an admission
          BRANCH   ASTAT,MISCHG99          * a pre-admission so don't write
.
          IF       IBCNMHOS=1
            MOVE     OPDAADMN,KEY8
            CALL     RDPMVX11
            BRANCH   OVRCD,MISCHG99          * Not an admission
            MOVE     SP10,PTHSDCLM
            MOVE     PMVXMHOS,KEY3
            CALL     RDPTHSP1
          ENDIF
.
MISCHG10  MOVE     OPDAADMN,KEY8
          CALL     TRVISA1
          MOVE     PVITRAN,PMMITRAN
          MOVE     PMMITRAN,ATRANNO
.
          MOVE     OPDAADMN,PMMIVISN
          PACK     KEY14,PMMIVISN,PMMITRAN       * Check if already exist
          CALL     RAPMMTI1
          COMPARE  ZERO,OVRCD
          GOTO     MISCHG10 IF EQUAL       * exist, get next number
.
          CALL     SMTI0000                * Set up misc.theatre item record
          IF       EXIT = 1
            MOVE     ZERO,EXIT
            GOTO     MISCHG99
          ENDIF
.
          MOVE     OPDAUNIQ,PMMIUNIQ
          MOVE     SP70,PMMIDUPD
          MOVE     SP70,PMMITUPD 
.
          MOVE      SP70,PMMICNTR
          MOVE      SP70,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP1,PMMICCON
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          MOVE      CURRDATE,PMMIDTCR
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
.
          CALL     WRPMMTI1                * write record to pmsmtiaf
.
          CALL      MMBONC00
.
          MOVE     "A",DIM1
          MOVE     PMMIITEM,MCHARGE
          PACK     CURRDATE,CCC,CYY,CMM,CDD
          REP      " 0",CURRDATE
          CALL     PROTRK00
.
          ADD      ONE,ATRANNO
          MOVE     ATRANNO,FORM8           * save next transaction no.
          MOVE     OPDAADMN,KEY8
          CALL     RDMISS1                 * read admission file
          BRANCH   OVRCD,MISCHG99
          MOVE     FORM8,ATRANNO           * restore transaction number.
          CALL     UPMISS1                 * update next transaction number
.
          CALL     WRPEND00                * Write record to Pending Table
.
MISCHG99  RETURN
.******************************************************************************
.*        Write record to Pending Table
.******************************************************************************
WRPEND00  MOVE      OPDAADMN,IPADMNO
          MOVE      THREE,IPSYSTM
          MOVE      SP70,IPSITE
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            PACK      KEY8,IPADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 3",PENDSYST                 * Inpatient
.
          MOVE      PMMITDAT,PENDSDAT             * as at date
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000               
          MOVE      SEVEN,PTIPRSTA           
          MOVE      SP70,PTIPSVAR          
.
.         Public hospital, check if there is Item amount
.
          IF        CHOSTYP=1 & CFEETYP=0
            CALL      CINVP000                  * Check for tobe invoiced
            GOTO      WRPEND99
          ENDIF
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RAIPEN1
          IF        OVRCD=1
            CALL      WRIPEN1
          ELSE
            CALL      UPIPEN1
          ENDIF
.
WRPEND99  RETURN
+
.******************************************************************************
.*              SET PATIENT Misc.Theatre item'S FIELDS                        *
.******************************************************************************
SMTI0000  MOVE      ZERO,EXIT
          MOVE      OPDAADMN,PMMIVISN
          MOVE      PVIURNO,PMMIURNO
.
          UNPACK    SP20,PTHFBCAT      * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
.
.                                      * DIM9 comes from PMREITEM in WRREG000
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,DIM9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      SMTI0500 IF EQUAL
.
SMTI0100  PACK      KEY29,ACLAIM,SP6,SP3,DIM9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      SMTI0500 IF EQUAL
.
SMTI0200  IF        IBCNMHOS=1
            MOVE      PTHSDCLM,MCLMCOD
          ELSE
            MOVE      PTCNDCLM,MCLMCOD
          ENDIF
          PACK      KEY29,MCLMCOD,SP6,SP3,DIM9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
.
          COMPARE   ONE,EXIT                * is Item invalid ?
          GOTO      SMTI9000 IF EQUAL       * yes - drop out
.
SMTI0500  MOVE      " 3",PMMISYST
          MOVE      DIM9,PMMIITEM
          MOVE      SP70,PMMIDES2
          MOVE      OPDADATE,PMMITDAT       * I CAR 42126
          MOVE      MITMTYP,PMMIRTYP        * Financial Transaction Details
          MOVE      DTRRE001,PMMIREFN       * I CAR 40412
.
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MNINV,PMMIINVN
          MOVE      MPATPOR,PMMIAMTP
          MOVE      MHFPOR,PMMIRBAT
.
          MOVE      FORM3,PMMISERV
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
          ENDIF
          MOVE      ZERO,PMMIAMTT
          ADD       PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
.
          PACK      PMMIDESC,SP70
          RESET     PMMIDESC
          APPEND    MDESC,PMMIDESC
          BRANCH    FORM3,SMTI3000          * quantity equals to one
.
          COMPARE   FIVE,CFEETYP
          GOTO      SMTI3000 IF NOT EQUAL   * Not NZ Private
.
SMTI1000  CMATCH    SP1,PMMIDESC
          GOTO      SMTI2000 IF NOT EQUAL
          BUMP      PMMIDESC,-1
          GOTO      SMTI1000 IF NOT EOS
.
SMTI2000  APPEND    " X",PMMIDESC
          APPEND    FORM3,PMMIDESC
          APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
          GOTO      SMTI4000
.
SMTI3000  APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
.
SMTI4000  MOVE      PTMCGSTA,PMMIGSTA
          MOVE      PTMCGSTC,PMMIGSTC
          MOVE      ZERO,PMMIGSTM
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      SP70,PMMITDOC
.
          MOVE      OPDACLIN,PMMIODOC
          MOVE      SP70,PMMISESS
          MOVE      SP70,PMMIBTCH
          MOVE      WBSEUID,PMMIWUSR
          MOVE      "0",PMMIMVBR
          MOVE      SP70,PMMIDKSM
          MOVE      SP70,PMMISPAR
          GOTO      SMTI9999
.
SMTI9000  MOVE      ONE,EXIT 
SMTI9999  RETURN
+
.******************************************************************************
.*        Check if any theatre item had already been invoiced                 *
.******************************************************************************
CDTR0000  MOVE      ZERO,EXIT
          MOVE      OPDAADMN,TADMNO
          PACK      KEY22,TADMNO,SP20
          CALL      RDSDTRN1
CDTR1000  CALL      RDKDTRN1
          BRANCH    OVRCD,CDTR9999
.
          MATCH     OPDAADMN,TADMNO            * Same admission ?
          GOTO      CDTR9999 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE            * check for theatre record 
          GOTO      CDTR1000 IF NOT EQUAL
.
          MATCH     "1",PTDTCRST
          GOTO      CDTR1000 IF EQUAL       * Fully credited
.         
          MATCH     "2",PTDTCRST            
          GOTO      CDTR1000 IF EQUAL       * Credit by item
.
     MOVE  "Patient has been invoiced, Item won't be posted to Billing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CDTR9999
.
CDTR9999  RETURN
+
.******************************************************************************
.*                 Main Action Routine for Other Theatre Details              *
.******************************************************************************
OPROTD00  CALL      VALCAS00
          BRANCH    EXIT,OPROTD99
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPROTD20 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Details
          GOTO      OPROTD10 IF EQUAL
.
          MATCH     "T",UPDATETY            * update tourniquet
          GOTO      OPROTD40 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      OPROTD50 IF EQUAL
.
          MATCH     "S",UPDATETY
          GOTO      OPROTD60 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      OPROTD70 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      OPROTD75 IF EQUAL
.
          MATCH     "I",UPDATETY
          GOTO      OPROTD80 IF EQUAL
.
          MATCH     "G",UPDATETY
          GOTO      OPROTD85 IF EQUAL
.
          MATCH     "C",UPDATETY            * Close Screen
          GOTO      OPROTD99 IF EQUAL
.
          GOTO      OPROTD90
.******************************************************************************
.*        Update Other Theatre Details                                        *
.******************************************************************************
OPROTD10  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RLOPSRG1                * Read Operating Surgical Details
          BRANCH    OVRCD,OPROTD91,OPROTD93 * Goto Error Message
.
          CALL      MVOPSG00                * Move CGI vars to File vars
          PROC      PREVTIME
          BRANCH    EXIT,OPROTD96,OPROTD97
          CALL      UPOPSRG1                * Update Surgical Details
          CALL      UUOPSRG1                * Unlock the record
          CALL      UPCOM000                * Update Comment File
          CALL      UPCMX000                * Update Comment File
          CALL      UPCMY000                * Update Comment File
          CALL      UPCMZ000                * Update Comment File
          CALL      UPCMW000                * Update Comment File
          CALL      UPOAT000                * Update Theatre Attributes
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.******************************************************************************
.*         Display of Other Theatre Details                                   *
.******************************************************************************
OPROTD20  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical Details
          BRANCH    OVRCD,OPROTD91          * Goto Error Message
.
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,OPROTD94
.
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1                * Read Theatre Operation Room
          BRANCH    OVRCD,OPROTD92
.
          CLEAR     WEBTITLE
          MOVE      "Other Theatre Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPROTD99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.******************************************************************************
.*                      Update Tourniquet                                     *
.******************************************************************************
OPROTD40  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1                * Read Operating Surgical Details
          BRANCH    OVRCD,OPROTD91          * Goto Error Message
.
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,OPROTD94
.
          MATCH     "S",SUPRLEVL
          GOTO      OPROTD42 IF EQUAL
.         MATCH     SP70,OPARTIRF
.         GOTO      OPROTD95 IF NOT EQUAL
.         MATCH     SP70,OPARTIRD
.         GOTO      OPROTD95 IF NOT EQUAL
.
OPROTD42  MATCH     Z70,OPTQT001
          IF        !@EQUAL
            MATCH     "5",RECORDTY
            GOTO      OPROD42A IF NOT EQUAL
            MOVE      RCOUNTER,F2
            COMPARE   ZERO,F2
            GOTO      OPROD42A IF NOT EQUAL
            MOVE      SP70,TOURNTWK
            MOVE      OPTQT001,TOURNTWK
            CALL      TOURNT00
          ENDIF
.
OPROD42A  MATCH     Z70,OPTQT002
          IF        !@EQUAL
            MATCH     "3",RECORDTY
            GOTO      OPROD42B IF NOT EQUAL
            MOVE      RCOUNTER,F2
            MOVE      SP70,TOURNTWK
            MOVE      OPTQT002,TOURNTWK
            CALL      TOURNT00
          ENDIF
.
OPROD42B  MATCH     Z70,OPTQT003
          IF        !@EQUAL
            MATCH     "1",RECORDTY
            GOTO      OPROD42C IF NOT EQUAL
            MOVE      RCOUNTER,F2
            MOVE      SP70,TOURNTWK
            MOVE      OPTQT003,TOURNTWK
            CALL      TOURNT00
          ENDIF
.
OPROD42C  MATCH     Z70,OPTQT004
          IF        !@EQUAL
            MATCH     "4",RECORDTY
            GOTO      OPROD42D IF NOT EQUAL
            MOVE      RCOUNTER,F2
            MOVE      SP70,TOURNTWK
            MOVE      OPTQT004,TOURNTWK
            CALL      TOURNT00
          ENDIF
.
OPROD42D  MATCH     Z70,OPTQT005
          IF        !@EQUAL
            MATCH     "2",RECORDTY
            GOTO      OPROTD45 IF NOT EQUAL
            MOVE      RCOUNTER,F2
            MOVE      SP70,TOURNTWK
            MOVE      OPTQT005,TOURNTWK
            CALL      TOURNT00
          ENDIF
.
OPROTD45  MATCH     SP70,RLEGAPPL
          IF        !@EQUAL
            MOVE      RLEGAPPL,OPTQATIM 
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,LLEGAPPL
          IF        !@EQUAL
            MOVE      LLEGAPPL,OPTQATIM 
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,RARMAPPL
          IF        !@EQUAL
            MOVE      RARMAPPL,OPTQATIM 
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,LARMAPPL
          IF        !@EQUAL
            MOVE      LARMAPPL,OPTQATIM 
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,OTHRAPPL
          IF        !@EQUAL
            MOVE      OTHRAPPL,OPTQATIM 
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,CARTAPPL
          IF        !@EQUAL
            MOVE      CARTAPPL,OPTQATIM
            GOTO      OPROTD47
          ENDIF
          MATCH     SP70,AORTAPPL
          IF        !@EQUAL
            MOVE      AORTAPPL,OPTQATIM
            GOTO      OPROTD47
          ENDIF
          GOTO      OPROTD48
.
OPROTD47  CALL      WRTOQT00
          GOTO      OPROTD99
.
OPROTD48  MATCH     SP70,RLEGREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,LLEGREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,RARMREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,LARMREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,OTHRREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,CARTREMV
          GOTO      OPROTD49 IF NOT EQUAL
          MATCH     SP70,AORTREMV
          GOTO      OPROTD49 IF NOT EQUAL
          GOTO      OPROTD99
.
OPROTD49  CALL      UPTOQT00
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update Clinical Theatre Details                                     *
.******************************************************************************
OPROTD50  CALL      UPOAC000          * Update Theatre Attributes
          CALL      UPODT000          * Theatre Attributes Dressing Type Details
.                                     * Clinical Details
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update Specimens Theatre Details                                    *
.******************************************************************************
OPROTD60  CALL      UPOAS000                * Update Theatre Attributes
.                                           * Specimens Details
          CALL      UPCMY000                * Update Comment File
.
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update Drains Theatre Details                                       *
.******************************************************************************
OPROTD70  CALL      UPOAD000                * Update Theatre Attributes
.                                           * Drains Details
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update Count Correct Theatre Details                                *
.******************************************************************************
OPROTD75  CALL      UPOAR000                * Update Theatre Attributes
.                                           * Count Correct Details
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update In Dwelling Catheter Theatre Details                         *
.******************************************************************************
OPROTD80  CALL      UPOAI000                * Update Theatre Attributes
.                                           * Catheter Details
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*        Update Irrigation Used Theatre Details                              *
.******************************************************************************
OPROTD85  CALL      UPOAG000                * Update Theatre Attributes
.                                           * Irrigation Details
          MOVE      ZERO,EXIT
          GOTO      OPROTD99
.
.******************************************************************************
.*                      ERROR HANDLING                                        *
.******************************************************************************
OPROTD90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD91  MOVE      "Theatre Details must be entered first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD92  MOVE      "Theatre Operaton Room record doesn't exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD93  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD94  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD95  MOVE      "Patient in Recovery.Cannot change Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROTD99
.
OPROTD96  MOVE      "Surgery start time cannot be before previous end time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      OPROTD99                
. 
OPROTD97  MOVE      "Previous end time required.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      OPROTD99                
. 
OPROTD99  CLOSE     OPCOMFIL,DELETE
          CLOSE     XPCOMFIL,DELETE          
          CLOSE     YPCOMFIL,DELETE
          CLOSE     ZPCOMFIL,DELETE
          CLOSE     WPCOMFIL,DELETE
.
          RETURN
.***********************************************************************
. Update Tourniquet Free text area
.***********************************************************************
TOURNT00  PACK      KEY13,OPDAUNIQ,RECORDTY,F2,SP70
          CALL      RDOPTQE1
          BRANCH    OVRCD,TOURNT10
.
          MOVE      TOURNTWK,OPTQCOMM
          CALL      UPOPTQE1
          GOTO      TOURNT99
.
TOURNT10  MOVE      OPDAUNIQ,OPTQUNID
          MOVE      RECORDTY,OPTQRTYP
          MOVE      RCOUNTER,F2
          MOVE      F2,OPTQCNTR
          MOVE      TOURNTWK,OPTQCOMM
          CALL      WROPTQE1
          GOTO      TOURNT99
.
TOURNT99  RETURN
.******************************************************************************
.*                 Main Action Routine for Tourniquet Details                 *
.******************************************************************************
OPRTQT00  CALL      VALCAS00
          BRANCH    EXIT,OPRTQT99
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Check for record 
          BRANCH    OVRCD,OPRTQT97
.
          MATCH     "S",SUPRLEVL
          GOTO      OPRTQT05 IF EQUAL
          MATCH     SP70,OPARTIRF
          GOTO      OPRTQT98 IF NOT EQUAL
          MATCH     SP70,OPARTIRD
          GOTO      OPRTQT98 IF NOT EQUAL
.
OPRTQT05  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRTQT40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Implant Code
          GOTO      OPRTQT10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Implant Code
          GOTO      OPRTQT20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Implant Code
          GOTO      OPRTQT30 IF EQUAL
.
          GOTO      OPRTQT90
.******************************************************************************
.*         Add Tourniquet Details                                             *
.******************************************************************************
OPRTQT10  PACK      KEY13,OPDAUNIQ,OPTRQ001,Z70
          CALL      RSOPTQE1                *Doing positonal read
          CALL      RPOPTQE1                *Doing Sequential read
          BRANCH    OVRCD,OPRTQT11
.
          PACK      KEY11,OPTQUNID,OPTQRTYP
          MATCH     KEY11,KEY13
          GOTO      OPRTQT11 IF NOT EQUAL
.
          MATCH     SP70,OPTQRDAT
          GOTO      OPRTQT95 IF EQUAL       *Checking Removed Date
          MATCH     SP70,OPTQRTIM
          GOTO      OPRTQT95 IF EQUAL       *Checking Removed Time
          MOVE      ZERO,F2
          MOVE      OPTQCNTR,F2
          ADD       ONE,F2
          MOVE      F2,OPTQCNTR
          RJUSTIFY  OPTQCNTR
          GOTO      OPRTQT12
.
OPRTQT11  MOVE      ONE,F2
          MOVE      F2,OPTQCNTR
          RJUSTIFY  OPTQCNTR
.
OPRTQT12  CALL      SAVTQT00
          PACK      KEY13,OPDAUNIQ,OPTRQ001,OPTQCNTR,SP70
          CALL      RAOPTQE1
          IF        OVRCD=1
            CALL      WROPTQE1              *Writing record into oprtqeaf table
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OPRTQT99
.******************************************************************************
.*         Update Tourniquet Details                                          *
.******************************************************************************
OPRTQT20  PACK      KEY13,OPDAUNIQ,OPTRQ001,OPTRQ002,SP70
          CALL      RLOPTQE1                *Lock the record
          BRANCH    OVRCD,OPRTQT94,OPRTQT91
.
          CALL      SAVTQT00
          CALL      UPOPTQE1                * Updating data into oprtqeaf table
          CALL      UUOPTQE1                * Unlock the record
.
          MOVE      ZERO,EXIT
          GOTO      OPRTQT99
.******************************************************************************
.*         Delete Tourniquet Details                                          *
.******************************************************************************
OPRTQT30  PACK      KEY13,OPDAUNIQ,OPTRQ001,OPTRQ002,SP70
          CALL      RLOPTQE1                *Doing read Operation
          BRANCH    OVRCD,OPRTQT94,OPRTQT91
.
          CALL      DEOPTQE1                *Deleting the record
.
          MOVE      ZERO,EXIT
          GOTO      OPRTQT99
.******************************************************************************
.*         Display of Tourniquet Details                                      *
.******************************************************************************
OPRTQT40  PACK     KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL     RDOPSRG1
          BRANCH   OVRCD,OPRTQT92          
.
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1              
          BRANCH    OVRCD,OPRTQT96
.
          PACK      KEY13,OPDAUNIQ,OPTRQ001,OPTRQ002,SP70
          CALL      RDOPTQE1             
          IF        OVRCD=1
            CALL      CLOPRTQE
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Tourniquet Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRTQT99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.******************************************************************************
.*                      Error Handling                                        *
.******************************************************************************
OPRTQT90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99

OPRTQT91  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT92  MOVE      "Missing Theatre Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT93  MOVE      "Removed DateTime less/equal than Applied DateTime",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT94  MOVE      "The record doesn't exist for this key value ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT95  CLEAR     WEBTITLE                 
          APPEND    "Cannot add,if last tourniquet of limb has not",WEBTITLE: 
          APPEND    " been removed yet",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT96 MOVE      "Theatre Operating Room Details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT97  MOVE      "Arrival Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT98  MOVE      "Patient in Recovery.Cannot change Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRTQT99
.
OPRTQT99  RETURN
.******************************************************************************
.           Moving Values to file variables of tourniquet table(oprteqaf)
.******************************************************************************
SAVTQT00  MOVE      OPDAUNIQ,OPTQUNID
          MOVE      OPTRQ001,OPTQRTYP
          MOVE      OPTRQ003,OPTQADAT
          MOVE      OPTRQ004,OPTQATIM
          MOVE      OPTRQ005,OPTQRDAT
          MOVE      OPTRQ006,OPTQRTIM
SAVTQT99  RETURN
.******************************************************************************
.*   Main Action Routine for Recovery Details  
.******************************************************************************
OPRREC00  CALL      VALCAS00
          BRANCH    EXIT,OPRREC99
.
          MATCH     SP70,UPDATETY
          GOTO      OPRREC20 IF EQUAL
.
          MATCH     "E",UPDATETY
          GOTO      OPRREC20 IF EQUAL       * Recovery Enquiry List
.
          MATCH     "U",UPDATETY            * Update Recovery Details
          GOTO      OPRREC10 IF EQUAL
.
          MATCH     "C",UPDATETY            * Close Recovery Screen  
          GOTO      OPRREC99 IF EQUAL
.
          MATCH     "V",UPDATETY
          GOTO      OPRREC30 IF EQUAL
.
          MATCH     "P",UPDATETY            * Update PACU details
          GOTO      OPRREC40 IF EQUAL
.
          GOTO      OPRREC90
.******************************************************************************
.*         Update Recovery Details                                            *
.******************************************************************************
OPRREC10  MOVE      SP70,SAVENUF1
          MOVE      SP70,SAVEDUF1
          MOVE      SP70,SAVETUF1
.
          MOVE      SP70,SAVENUF2
          MOVE      SP70,SAVEDUF2
          MOVE      SP70,SAVETUF2
.
          MOVE      SP70,SAVENUB1
          MOVE      SP70,SAVEDUB1
          MOVE      SP70,SAVETUB1
.
          MOVE      SP70,SAVENUB2
          MOVE      SP70,SAVEDUB2
          MOVE      SP70,SAVETUB2
.
          MOVE      SP70,SAVENUD1
          MOVE      SP70,SAVEDUD1
          MOVE      SP70,SAVETUD1
.
          MOVE      SP70,SAVENUD2
          MOVE      SP70,SAVEDUD2
          MOVE      SP70,SAVETUD2
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RLOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,OPRREC92,OPRREC93
.
          MOVE      OPARNUF1,SAVENUF1
          MOVE      OPSEDATE,SAVEDUF1
          MOVE      OPARTIRF,SAVETUF1
.
          MOVE      OPARNUF2,SAVENUF2
          MOVE      OPSEDATE,SAVEDUF2
          MOVE      OPARTIRF,SAVETUF2
.
          MOVE      OPARNUB1,SAVENUB1
          MOVE      OPSEDATE,SAVEDUB1
          MOVE      OPARTIRB,SAVETUB1
.
          MOVE      OPARNUB2,SAVENUB2
          MOVE      OPSEDATE,SAVEDUB2
          MOVE      OPARTIRB,SAVETUB2
.
          MOVE      OPARNUD1,SAVENUD1
          MOVE      OPSEDATE,SAVEDUD1
          MOVE      OPARTIRD,SAVETUD1
.
          MOVE      OPARNUD2,SAVENUD2
          MOVE      OPSEDATE,SAVEDUD2
          MOVE      OPARTIRD,SAVETUD2
.
          CALL      MVOPAR00                * Moving to File Variables
          CALL      UPOPARD1                * Updating Arrival/Departure table
          CALL      UUOPARD1
          CALL      UPCOM000                * Updating the Oprn Comments table
          CALL      UPCMX000                * Updating the Oprn Comments table
.
          UNPACK    SP70,OPSGTISS,OPSGTISE,OPSGTISE,OPSGTIDR
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70   * reading surgical table
          CALL      RDOPSRG1
          IF        OVRCD <> 1
            CALL      MVOPSG00
            CALL      UPOPSRG1
          ENDIF
.
          CALL      UPMMB000                * update "patmmbsf" Start/End times
.
          IF        PRINTREG = 1
            CALL      PRTREG00              * Print Registration Form
          ENDIF
.
          MATCH     "1",SCHDPRIN
          IF        @EQUAL
            MOVE      CASEKEYS,SUBSYSKY
            CALL      ADDPRN00
            CALL      UPDEFP00
          ENDIF 
.
          MOVE      "015",TADTTYPE
          PROC      OPTHETAT            * write recovery details audit
.
          CALL      WOPTSR00
          PROC      PMSCURTH           * Update patient header theatre status
.
.          CALL      CHKGAS00
.
          IF        RECOVDUR = 1
            CALL      ROPMIN00         * Recalulate operation duration as some
          ENDIF                        * sites use recover times as end time
.
          MOVE      ZERO,EXIT
          GOTO      OPRREC99
.******************************************************************************
.*         Display of Recovery Details                                        *
.******************************************************************************
OPRREC20  MATCH     "E",UPDATETY
          GOTO      OPRREC23 IF EQUAL
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPTQE1                * Reading the Tourniquet table
OPRREC21  CALL      RKOPTQE1
          BRANCH    OVRCD,OPRREC22
          MATCH     OPDAUNIQ,OPTQUNID
          GOTO      OPRREC22 IF NOT EQUAL
.
          MATCH     "005",TEMPLATE          * PACU update
          GOTO      OPRREC22 IF EQUAL
.
          MATCH     "011",TEMPLATE
          GOTO      OPRREC22 IF EQUAL
.
          MATCH     "011",TEMPLATE
          GOTO      OPRREC22 IF EQUAL
.
          MATCH     SP70,OPTQRTIM
          GOTO      OPRREC91 IF EQUAL
          GOTO      OPRREC21
.
OPRREC22  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Reading Arrival/Departure table
          MATCH     "010",TEMPLATE
          IF        !@EQUAL
            MATCH     "011",TEMPLATE
            IF        !@EQUAL
               BRANCH    OVRCD,OPRREC92
            ENDIF 
          ENDIF 
.                                    
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70   * reading surgical table
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
            MATCH     "005",TEMPLATE               * PACU update
            GOTO      OPRREC94 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=1
           CALL      CLPATMIS
          ENDIF
.
          IF        AAEFLAG=1
            PACK      KEY30,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,ADMISSNO,SP70
            CALL      RDOPAAE1
            IF        OVRCD=1
              CALL      CLAAE000
            ENDIF
          ENDIF
. 
          MATCH     "005",TEMPLATE               * PACU update
          GOTO      OPRREC25 IF EQUAL
.
          MATCH     "1",OPSGUY05
          IF        !@EQUAL
            MATCH     "1",NODRESSG *sjog don't collect dressing-set menu option 
            IF        !@EQUAL
              MATCH     SP70,OPSGTIDR
              GOTO      OPRREC95 IF EQUAL
            ENDIF
          ENDIF
.
          GOTO      OPRREC25
.
OPRREC23  MATCH     SP70,SURGTYPE
          IF        @EQUAL
            MOVE      WBSEDGSI,SURGTYPE
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          STRIP     MTHNAM
.                                    
OPRREC25  MOVE      "Recovery Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRREC99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.
OPRREC30  CALL      ADDOPR00
          MOVE      ZERO,EXIT
          GOTO      OPRREC99
.
OPRREC40  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RLOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,OPRREC92,OPRREC93
.
          CALL      MVOPAR00                * Moving to File Variables
          CALL      UPOPARD1                * Updating Arrival/Departure table
          CALL      UUOPARD1
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      OPRREC99
.
.******************************************************************************
.*                      ERROR HANDLING                                        *
.******************************************************************************
OPRREC90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.
OPRREC91  MATCH     " 0",OPTQCNTR
          GOTO      OPRREC21 IF EQUAL
          MOVE      "Tourniquet has not been removed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.
OPRREC92  MOVE      "Arrival details missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.
OPRREC93  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.         
OPRREC94  MOVE      "Surgical details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99

OPRREC95  MOVE      "Dressing Time/OT Out time must be entered before Recovery",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREC99
.        
OPRREC99  CLOSE     OPCOMFIL,DELETE
          CLOSE     XPCOMFIL,DELETE
          CLOSE     ITMDESAF,DELETE
.
          RETURN
.******************************************************************************
.*                      Validation of CASEKEYS                                *
.******************************************************************************
VALCAS00  MATCH     "E",UPDATETY
          GOTO      VALCAS99 IF EQUAL
.
          CALL      CLWATDET
          CALL      CLPATMAS
          CALL      CLPATMSX
          MATCH     SP70,UNIQUEKY
          IF        !@EQUAL 
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPDEA3
            BRANCH    OVRCD,VALCAS90
            PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN:
                               OPDASTAT,OPDACASE,SP70
          ENDIF
.
          MATCH     SP70,CASEKEYS
          GOTO      VALCAS10 IF EQUAL
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,VALCAS90
          MOVE      OPDAADMN,ADMISSNO
          GOTO      VALCAS80
.
VALCAS10  GOTO      VALCAS85
.
...       PACK      KEY31,ADMISSNO,ZERO,SP70
...       CALL      RSOPDEA2
...       CALL      RKOPDEA2
...       BRANCH    OVRCD,VALCAS90
...       PACK      KEY9,OPDAADMN,OPDASTAT
...       MATCH     KEY9,KEY31
...       GOTO      VALCAS90 IF NOT EQUAL
...       PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
.
VALCAS80  COMPARE   THREE,OPDASTAT
          GOTO      VALCAS91 IF EQUAL
          CALL      CASDET00
          MOVE      ZERO,EXIT
          GOTO      VALCAS99
.
VALCAS85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALCAS99
.
VALCAS90  MOVE      "Invalid Case Access",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALCAS99
.
VALCAS91  MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Patient has been Transferred",WEBTITLE
          ELSE
            MOVE      "Patient has been Cancelled",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALCAS99
.
VALCAS99  RETURN
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
CASDET00  MOVE      ZERO,CMBSFEE
          MOVE      OPDAADMN,KEY8
          MOVE      OPDAADMN,ADMISSNO
          CALL      GURN0000
          BRANCH    EXIT,CASDET99
          MATCH     "0       ",AURNO
          GOTO      CASDET05 IF EQUAL   * have a UR number
          MATCH     "       0",AURNO
          GOTO      CASDET05 IF EQUAL   * have a UR number
          MATCH     "        ",AURNO
          GOTO      CASDET10 IF NOT EQUAL   * have a UR number
.
.         on pre-admission file
.
CASDET05  MOVE      OPDAADMN,KEY8           * visit number
          CALL      RDPRAM1
          BRANCH    OVRCD,CASDET10          * invalid visit number
.
          MOVE      ZERO,PURNO
          MOVE      PURNO,URNUMBER
          GOTO      CASDET99                * valid patient
.
.         on master file
.
CASDET10  PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CASDET99          * invalid UR number
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PURNO,URNUMBER
          PACK      KEY19,PURNO,SP70
          CALL      RDSTREA1
CASDET20  CALL      RDKTREA1
          BRANCH    OVRCD,CASDET30
          MATCH     PURNO,WMURNO
          GOTO      CASDET30 IF NOT EQUAL
          MOVE      WMBOOK,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      CASDET20 IF NOT EQUAL
          GOTO      CASDET99
 
CASDET30  CALL      CLWATDET
.                                          
CASDET99  RETURN
.******************************************************************************
.                   GURN0000
.    Given the admission number in KEY8/KEY6 this gets the UR number from
.    either the admission or booking master file.
.    Returns : AURNO
.    Routine by Bill Dew 14/03/90
.*******************************************************************************
GURN0000  CALL      RDMISS1                 * read admission file
          BRANCH    OVRCD,GURN5555
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "1",TCINDC1             * check for overseas
            IF        @EQUAL
              MATCH     "1",TCINDC2           * Use MBS fee amount ?
              IF        @EQUAL
                MOVE      ONE,CMBSFEE 
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTVIS1
          BRANCH    OVRCD,GURN9990          * invalid visit number
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,GURN9990          * invalid visit number
.
GURN5555  CALL      RDBKREC1                * read booking records file
          BRANCH    OVRCD,GURN9990
          MOVE      BKREURNO,AURNO
.
          CALL      RDBKRX11
          BRANCH    OVRCD,GURN9990
          MOVE      ZERO,EXIT               * a valid admission number
          GOTO      GURN9999
.
GURN9990  MOVE      ONE,EXIT                * an invalid admission number
.
GURN9999  RETURN
.******************************************************************************
.* Set Input Comments                     
.******************************************************************************
OPCOM000  PREP      OPCOMFIL,OPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     OPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     OPCOMFIL,SEQ;QRYDATA
.
OPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      OPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      OPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     OPCOMFIL,SEQ;QRYDATA
          GOTO      OPCOM100
.
OPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
OPCOM999  RETURN
.
.******************************************************************************
.* Update Comments                       
.******************************************************************************
UPCOM000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPCOMFIL,OPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCOM999
.
UPCOM100  READ      OPCOMFIL,SEQ;OPCOMLIN
          GOTO      UPCOM999 IF OVER
          MATCH     "%START:",OPCOMLIN
          IF        @EQUAL
            UNPACK    OPCOMLIN,KEY7,OPCOMTYP
            CALL      CLCOM000
            MOVE      ZERO,OPCOMCNT
            GOTO      UPCOM100
          ENDIF
UPCOM110  ADD       ONE,OPCOMCNT
          PACK      KEY16,OPDAUNIQ,OPCOMTYP,OPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCOM110 IF EQUAL
          MOVE      OPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCOM100 IF EQUAL       * Do not save blank lines
          GOTO      UPCOM100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCOM100
.
UPCOM999  RETURN
.******************************************************************************
.* Clear Comments                       
.******************************************************************************
CLCOM000  PACK      KEY16,OPDAUNIQ,OPCOMTYP,SP70
          CALL      RSOPDED1
CLCOM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCOM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCOM999 IF NOT EQUAL
          MATCH     OPDDTYPE,OPCOMTYP
          GOTO      CLCOM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCOM100
CLCOM999  RETURN                       
.
.
.******************************************************************************
.* Set 2nd Input Comments
.******************************************************************************
XPCOM000  PREP      XPCOMFIL,XPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     XPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     XPCOMFIL,SEQ;QRYDATA
.
XPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      XPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      XPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     XPCOMFIL,SEQ;QRYDATA
          GOTO      XPCOM100
.
XPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
XPCOM999  RETURN
.
.******************************************************************************
.* Update 2nd Comments
.******************************************************************************
UPCMX000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      XPCOMFIL,XPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMX999
.
UPCMX100  READ      XPCOMFIL,SEQ;XPCOMLIN
          GOTO      UPCMX999 IF OVER
          MATCH     "%START:",XPCOMLIN
          IF        @EQUAL
            UNPACK    XPCOMLIN,KEY7,XPCOMTYP
            CALL      CLCXM000
            MOVE      ZERO,XPCOMCNT
            GOTO      UPCMX100
          ENDIF
UPCMX110  ADD       ONE,XPCOMCNT
          PACK      KEY16,OPDAUNIQ,XPCOMTYP,XPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMX110 IF EQUAL
          MOVE      XPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMX100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMX100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMX100
.
UPCMX999  RETURN
.******************************************************************************
.* Clear 2nd Comments
.******************************************************************************
CLCXM000  PACK      KEY16,OPDAUNIQ,XPCOMTYP,SP70
          CALL      RSOPDED1
CLCXM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCXM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCXM999 IF NOT EQUAL
          MATCH     OPDDTYPE,XPCOMTYP
          GOTO      CLCXM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCXM100
CLCXM999  RETURN
.******************************************************************************
.*                  Theatre History Enquiry                                   *
.******************************************************************************
OPRHIS00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,OPRHIS99
.
          CALL      CLPMSPX2
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
.
          CALL      PATNAB00      * Format patient name for FHIR Output
.
          CALL      CLPATMIS
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            IF        OVRCD=1
             CALL      CLPATMIS
            ENDIF
          ENDIF
          MOVE      SP70,DDATE
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            MATCH     SP70,UNIQUEKY
            GOTO      OPRHIS80 IF EQUAL
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPDEA3
            IF        OVRCD=1
              CALL      CLOPRDEA
              GOTO      OPRHIS80
            ENDIF
            GOTO    OPRHIS50
          ENDIF
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=1
            CALL      CLOPRDEA
            GOTO      OPRHIS80
          ENDIF
.
OPRHIS50  PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=1
           CALL      CLPATMIS
          ENDIF
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE     SP70,DDATE
          ENDIF
.
          MOVE      SP70,CLINCODE
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ELSE
            MOVE      OPSECLIN,CLINCODE
          ENDIF
.
OPRHIS80  CLEAR     WEBTITLE
          MOVE      "Patient Theatre History Enquiry",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRHIS99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      OPRHIS99
.
OPRHIS99  RETURN
.******************************************************************************
.*                          Day Procedure Maintenance                         *
.******************************************************************************
OPRDAY00  CALL      VALCAS00
          BRANCH    EXIT,OPRDAY99
.
          CALL      GNEWS000                * Get new session for sportsmed
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRDAY50 IF EQUAL       * Display day procedure details
.
          MATCH     "U",UPDATETY            * Update day procedure details
          GOTO      OPRDAY10 IF EQUAL
.
          MATCH     "S",UPDATETY            * Add staff member
          GOTO      OPRDAY20 IF EQUAL
.
          MATCH     "M",UPDATETY            * Update staff member
          GOTO      OPRDAY25 IF EQUAL
.
          MATCH     "O",UPDATETY            * Update Operating Surgeon
          GOTO      OPRDAY30 IF EQUAL
.
          MATCH     "R",UPDATETY            * Delete Staff Member
          GOTO      OPRDAY35 IF EQUAL
.
          MATCH     "E",UPDATETY            * Update Staff Member End Time 
          GOTO      OPRDAY40 IF EQUAL
.
          MATCH     "B",UPDATETY            * Bill MBS Items Def. from Booking
          GOTO      OPRDAY45 IF EQUAL
.
          MATCH     "F",UPDATETY            * add staff member freeformat
          GOTO      OPRDAY65 IF EQUAL
.
          MATCH     "P",UPDATETY            * update staff member freeformat
          GOTO      OPRDAY70 IF EQUAL
.
          MATCH     "T",UPDATETY            * delete staff member freeformat
          GOTO      OPRDAY75 IF EQUAL
.
          MATCH     "N",UPDATETY            * update staff member end date/time
          GOTO      OPRDAY80 IF EQUAL       * free format
.
          GOTO      OPRDAY91
.
.******************************************************************************
.*                      Update Day Procedure Details                          *
.******************************************************************************
OPRDAY10  MATCH     "1",CHCKRECO
          IF         @EQUAL
            CALL      RECTIM00     * Validate Recovery Time - Day Procedure
            BRANCH    EXIT,OPRDAY99
          ENDIF
.
          CALL      UPDDAY00     * Update Day Procedure Details
          BRANCH    EXIT,OPRDAY99
.
          MOVE      "010",TADTTYPE
          PROC      OPTHETAT
.                                                                     *I-207386
          CALL      UPMMB000                * update "patmmbsf" Start/End times
.
          IF        PRINTREG = 1
            CALL      PRTREG00              * Print Registration Form  *I-54343
          ENDIF                                                        *I-54343
.
          MATCH     SP70,OPSGTISE
          IF        !@EQUAL
            MOVE      OPDADATE,MMDATE
            CALL      WESE0000                * update Episode details
          ENDIF
.
          MATCH     "1",SCHDPRIN
          IF        @EQUAL
            MOVE      CASEKEYS,SUBSYSKY
            CALL      ADDPRN00
            CALL      UPDEFP00
          ENDIF
.
          CALL      WOPTSM00 
.
          CALL      CHKGAS00
.
          PROC      PMSCURTH           * Update patient header theatre status
.
          GOTO      OPRDAY99
.
.******************************************************************************
.*                           Add Staff Member                                 *
.******************************************************************************
OPRDAY20  PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          COMPARE   ONE,OVRCD
          GOTO      OPRDAY92 IF NOT EQUAL
          CALL      CLOPRTSM
          CALL      SAVSTF00                * moving cgivar to file var
          CALL      WROPTSM1                * writing into staff members table
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                        Update Staff Member                                 *
.******************************************************************************
OPRDAY25  MOVE      "Staff Member Table",TABLNAME
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,SAVKEY01,SP70
          PACK      KEY35A,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          MATCH     KEY35A,KEY35
          GOTO      OPRDAY27 IF EQUAL
.
.         Check new key doesn't already exist
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          COMPARE   ONE,OVRCD
          GOTO      OPRDAY92 IF NOT EQUAL
.
.         Check old key still exists before updating
.
OPRDAY27  PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,SAVKEY01,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      SAVSTF00
          CALL      UPOPTSM1                * updating the staff members table
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.******************************************************************************
.*                      Update Operating Surgeon                              *
.******************************************************************************
OPRDAY30  MOVE      "Staff Member Table",TABLNAME
.
.         Check old key still exists before updating
.
          MOVE      ZERO,F2
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,F2,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1                * reading to check for its existance
          BRANCH    OVRCD,OPRDAY33,OPRDAY94
          PACK      KEY13,OPTSUNID,OPTSTMNO,OPTSSIND
          MATCH     KEY13,KEY35
          GOTO      OPRDAY33 IF NOT EQUAL
.
          MOVE      OPTSM002,OPTSSCDE       * Set new Operating Surgeon's code
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      UPOPTSM1                * updating the staff members table
          TRAPCLR   IO
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
OPRDAY33  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      ZERO,OPTSSIND
          MOVE      OPTSM002,OPTSSCDE
          MOVE      OPDADATE,OPTSSDAT
          MOVE      OPCNSTCT,OPTSSTYP
          PACK      OPTSSTIM,OPDAEXPS,SECONDS
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
          CALL      RDOPTSM1
          COMPARE   ZERO,OVRCD
          GOTO      OPRDAY99 IF EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROPTSM1
          TRAPCLR   IO
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                      Delete Staff Member                                   *
.******************************************************************************
OPRDAY35  MOVE      "Staff Member Table",TABLNAME
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004,SP70
          CALL      RDOPTSM1                * reading to check for existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      DEOPTSM1                * deleting the record from staff
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.******************************************************************************
.*                      Update Staff Member end date and time                 *
.******************************************************************************
OPRDAY40  MOVE      "Staff Member Table",TABLNAME
.
          PACK      KEY35,OPDUNQID,SP70
          CALL      RDOPTSM1                * reading to check for its existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      IBACLOCK
          MOVE      CTIMEIS,OPTSETIM
.
          MOVE      CURRDATE,OPTSEDAT
.
          CALL      UPOPTSM1                * updating the staff members table
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.******************************************************************************
.*                Bill MBS Items Defaulted from Booking                       *
.******************************************************************************
OPRDAY45  CALL      UPDDAY00           * Update Day Procedure Details
          BRANCH    EXIT,OPRDAY99
.
          CALL      MBSCHK00           * write any Privisional MBS Items
.
.         Update Billing Details
.
          MOVE      ZERO,F1
          MOVE      ONE,INVOICED       * Set as none invoiced
          MOVE      ZERO,TOTMMBS
          MOVE      ZERO,TOTDTRA
          MOVE      ONE,CHRGPMBS
.
          CALL      USIMB000           * get the initial patmmbs
          CALL      USGIM000           * locate any existing items records
.
          CALL      USMBS000           * Set up patient MBS Account
          CALL      USMMB000           * Write MBS Code to medical records
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                     Display Day Procedure Details                          *
.******************************************************************************
OPRDAY50  CALL      DAYPDT00              * read routine for display
          BRANCH    EXIT,OPRDAY99
.
          CALL      MBSBIL00              * Check for billed MBS Items
.          
OPRDAY60  MOVE      "Theatre Case Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRDAY99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                           Add Staff Member free format                     *
.******************************************************************************
OPRDAY65  MATCH     "1",UPDOPSDT
          GOTO      OPRDAY99 IF NOT EQUAL
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004,OPSDT005,OPSDT006:
                          SP70
          CALL      RDOPSDT1
          IF        OVRCD=0
            GOTO      OPRDAY92
          ENDIF
.
          CALL      CLOPRSDT
          CALL      MVOPRSDT
.
          CALL      WROPSDT1
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
+
.******************************************************************************
.*                        Update Staff Member free format                     *
.******************************************************************************
OPRDAY70  MATCH     "1",UPDOPSDT
          GOTO      OPRDAY99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,SAVKEY76,SP70
          PACK      KEY89A,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          MATCH     KEY89A,KEY89
          GOTO      OPRDAY72 IF EQUAL
.
.
.         Check new key doesn't already exist
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          COMPARE   ZERO,OVRCD
          GOTO      OPRDAY92 IF EQUAL
.
.         Check old key still exists before updating
.
OPRDAY72  PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,SAVKEY76,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      MVOPRSDT
          CALL      UPOPSDT1
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                      Delete Staff Member free format                       *
.******************************************************************************
OPRDAY75  MATCH     "1",UPDOPSDT
          GOTO      OPRDAY99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004:
                          OPSDT005,OPSDT006,SP70
          CALL      RDOPSDT1                * reading to check for existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      DEOPSDT1                * deleting the record from staff
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                      Update Staff Member end date and time free format     *
.******************************************************************************
OPRDAY80  MATCH     "1",UPDOPSDT
          GOTO      OPRDAY99 IF NOT EQUAL
.
          MOVE      "Staff Member Table",TABLNAME
          PACK      KEY89,OPDUNQFF,SP70
          CALL      RDOPSDT1                * reading to check for its existance
          BRANCH    OVRCD,OPRDAY93,OPRDAY94
.
          CALL      IBACLOCK
          MOVE      CTIMEIS,OPSDETIM
.
          MOVE      CURRDATE,OPSDEDAT
.
          CALL      UPOPSDT1                * updating the staff members table
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
.
          MOVE      ZERO,EXIT
          GOTO      OPRDAY99
.
.******************************************************************************
.*                 Error Handling Section                                     *
.******************************************************************************
OPRDAY91  MOVE      "OPRDAY - Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRDAY99
.
OPRDAY92  MOVE      "Record Already Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRDAY99
.
OPRDAY93  MOVE      "Record Doesn't Exist in",WEBTITLE
          MOVELPTR  WEBTITLE,F2
          ADD       ONE,F2
          RESET     WEBTITLE,F2
          APPEND    TABLNAME,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRDAY99
.
OPRDAY94  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRDAY99
.
OPRDAY99  CLOSE     OPCOMFIL,DELETE
          CLOSE     EXPCMTFI,DELETE
.
          RETURN
.
.******************************************************************************
.*                      Get new session for sportsmed                         *
.******************************************************************************
GNEWS000   PACK      NEWSESSI,SP70
.
           UNPACK    CASEKEYS,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
           PACK      KEY22,SESNCODE,SESNHOSP,SESNDATE,SP70
           CALL      RSOPSES2
GNEWS100   CALL      RKOPSES2
           BRANCH    OVRCD,GNEWS999
.
           MATCH     SESNCODE,OPSECLIN
           GOTO      GNEWS999 IF NOT EQUAL
.
           MATCH     SESNDATE,OPSEDATE
           GOTO      GNEWS999 IF NOT EQUAL
.
           MATCH     SESNTIME,OPSETIME
           GOTO      GNEWS100 IF EQUAL
.
           PACK      NEWSESSI,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
GNEWS999   RETURN
+
.******************************************************************************
.*              Check if MBS Items have been Billed
.*
.* OUTPUT:  MBSBILLD = 0    - MBS items have not been billed
.*          MBSBILLD = 1    - MBS items have been billed
.*          MBSCHRGD = 0    - To charge Prov MBS
.*          MBSCHRGD = 1    - Already charged Prov MBS
.******************************************************************************
MBSBIL00  MOVE      ZERO,MBSBILLD           * Reset MBS Billed flag
          MOVE      ZERO,MBSCHRGD
          PACK      KEY14,OPDAADMN,SP70
          CALL      RSPMMTI1
MBSBIL10  CALL      RKPMMTI1
          BRANCH    OVRCD,MBSBIL99
          MATCH     OPDAADMN,PMMIVISN       * Same Admission number?
          GOTO      MBSBIL99 IF NOT EQUAL   * No, exit
.
          MATCH     OPDAUNIQ,PMMIUNIQ       * Same unique number?
          GOTO      MBSBIL10 IF NOT EQUAL   * No
.
          MATCH     "2",PMMIRTYP            * Is record type MBS?
          IF        @EQUAL
            MOVE      ONE,MBSBILLD          * Yes, set MBS Billed flag
            MATCH     PMMIITEM,OPDAPROV
            IF        @EQUAL
              MOVE      ONE,MBSCHRGD        * Yes, prov mbs charged already
            ENDIF
          ENDIF
.
          GOTO      MBSBIL10                * Get next record
.
MBSBIL99  RETURN
.******************************************************************************
.*                    Day Preocudures Display Routine                         *
.******************************************************************************
DAYPDT00  MOVE      ZERO,F1
          CALL      CLOPRSRG             * clearing surgical file variables
.
          MOVE      ZERO,ADMITNRQ
          MOVE      TEMPLATE,F3
          MOVE      F3,TEMPLATE
          REP       " 0",TEMPLATE
          MATCH     "002",TEMPLATE
          IF        @EQUAL
            MOVE      ONE,ADMITNRQ
          ENDIF
          MATCH     "003",TEMPLATE
          IF        @EQUAL
            MOVE      ONE,ADMITNRQ
          ENDIF
          MATCH     "004",TEMPLATE
          IF        @EQUAL
            MOVE      ONE,ADMITNRQ
          ENDIF
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          COMPARE   ONE,ADMITNRQ
          IF        @EQUAL
            GOTO      DAYPDT10
          ELSE
            BRANCH    OVRCD,DAYPDT92
          ENDIF
.
          COMPARE   FOUR,ASTAT                   * Allow update of case details
          GOTO      DAYPDT10 IF EQUAL            * if patient is on leave
.
          COMPARE   THREE,ASTAT                  * Allow update of case details
          GOTO      DAYPDT10 IF EQUAL            * if patient is discharged
.
          COMPARE   TWO,ASTAT                    * Allow update of case details
          GOTO      DAYPDT92 IF NOT EQUAL        * if patient is admitted
.
DAYPDT10  MATCH     OPDADATE,CURRDATE
          GOTO      DAYPDT93 IF LESS
.
          IF        ASTAT=3
            PACK      KEY8,OPDAADMN,SP70
            CALL      RDDSCH1
            BRANCH    OVRCD,DAYPDT95

            MATCH     OPDADATE,DDATE               * Check case date is prior
            GOTO      DAYPDT94 IF LESS             * to the discharge date
          ELSE
            CALL      CLPATDSC                     * Not discharge clear vars
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                 * arrival/recovery details
          IF        OVRCD=1
            CALL      CLOPRARD               * clear arrival/recovery details
          ENDIF
.
          RESET     TEAMNUMB
          MATCH     SP70,TEAMNUMB
          IF        @EQUAL
            MOVE      "1",TEAMNUMB
          ENDIF
.
          MOVE      SP70,PREPTIME
          MOVE      SP70,DRESTIME
          MOVE      SP70,SUSTTIME
          MOVE      SP70,SUENTIME
          MOVE      SP70,DELYTIME
          MOVE      SP70,COUNTCOR
          MOVE      SP70,COUNTDPS
          MOVE      SP70,INFCCONT
          MOVE      SP70,SURGCODE
          MOVE      SP70,SURGLEVL
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          CALL      SESDET00
.
          CALL      CLAAE000
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=1
            MOVE      SP70,OPDADES1
            MOVE      SP70,OPDADES2
            MOVE      SP70,OPDADES3
          ELSE
.           MOVE      OPDACLIN,SURGCODE
            COMPARE   ZERO,OPCNCLSU
            IF        @EQUAL
.
.             Use clinic doctor...
.
              PACK      KEY6,OPSECLIN,SP70
              CALL      RDOPCLI1
              IF        OVRCD=0
                PACK      KEY6,OPCLDOCT,SP70
                CALL      RDDOCT1
                IF        OVRCD=0
                  MOVE      OPCLDOCT,SURGCODE
                ENDIF
              ENDIF
            ELSE
.
.             Use surgeon
.
              MOVE      OPSECLIN,KEY6
              CALL      RDDOCT1
              IF        OVRCD=0
                MOVE      OPSECLIN,SURGCODE
              ENDIF
            ENDIF
            IF        AAEFLAG=1
              PACK      KEY30,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,ADMISSNO,SP70
              CALL      RDOPAAE1
              IF        OVRCD=1
                CALL      CLAAE000
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,SRGEXIST
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70   * reading surgical table
          CALL      RDOPSRG1
          BRANCH    OVRCD,DAYPDT30
.
          MOVE      ONE,SRGEXIST
          MOVE      OPSGTIPS,PREPTIME
          MOVE      OPSGTIDR,DRESTIME
          MOVE      OPSGTISS,SUSTTIME
          MOVE      OPSGTISE,SUENTIME
          MOVE      OPSGSGDL,DELYTIME
          MOVE      OPSGCCNT,COUNTCOR
          MOVE      OPSGDCK1,COUNTDPS
          MOVE      OPSGCNTO,OPRTNAME
          MOVE      OPSGINFC,INFCCONT
.
DAYPDT30  PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1                * reading theatre operating room
          BRANCH    OVRCD,DAYPDT91
.
          CALL      GETMBS00                     * Get Theatre MBS Details
          CALL      GETIMP00                     * Get Implant Details
          CALL      GETEXP00                     * Get Expensive Items Details
          CALL      GETMIS00                     * Get Miscellaneous Item Detail
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL      CLBOKRC1
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            MOVE      SP70,BKRXUFF4              * Clear Booking Comment
          ENDIF
.
          MOVE      ZERO,STFEXIST
          MATCH     SP70,OPTSM001
          GOTO      DAYPDT80 IF NOT EQUAL
.
          MOVE      ZERO,F2
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,F2,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,DAYPDT85
          PACK      KEY13,OPTSUNID,OPTSTMNO,OPTSSIND
          MATCH     KEY13,KEY35
          IF        @EQUAL
            MOVE      OPTSSCDE,SURGCODE
            MOVE      OPTSSLEV,SURGLEVL
            MOVE      ONE,STFEXIST
          ENDIF
          CALL      CLOPRTSM
          GOTO      DAYPDT85
.
DAYPDT80  PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSM001,OPTSM002:
                          OPTSM003,OPTSM004
          CALL      RDOPTSM1
          IF        OVRCD=1
            CALL      CLOPRTSM
          ELSE
            MOVE      ONE,STFEXIST
          ENDIF
          PACK      SAVKEY01,OPTSSCDE,OPTSSDAT,OPTSSTIM
          GOTO      DAYPDT85
.
DAYPDT85  MATCH     "1",UPDOPSDT
          GOTO      DAYPDT99 IF NOT EQUAL
.
          CALL      CLOPRSDT
.
          MATCH     SP70,OPSDT001
          GOTO      DAYPDT99 IF EQUAL
.
          PACK      KEY89,OPSDT001,OPSDT002,OPSDT003,OPSDT004,OPSDT005:
                          OPSDT006,SP70
          CALL      RDOPSDT1
          IF        OVRCD=1
            CALL      CLOPRSDT
          ENDIF
          PACK      SAVKEY76,OPSDSNAM,OPSDSDAT,OPSDSTIM
.
          GOTO      DAYPDT99
.
DAYPDT91  MOVE      "Theatre Operating Room Details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DAYPDT99
.
DAYPDT92  MOVE      "Patient has not been admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DAYPDT99
.
DAYPDT93  MOVE      "Cannot update for future date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DAYPDT99
.
DAYPDT94  MOVE      "Patient has been discharged prior to case date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DAYPDT99
.
DAYPDT95  MOVE      "Invalid discharge record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DAYPDT99
.
DAYPDT99  RETURN
.
.******************************************************************************
.*                            Get Theatre MBS Details                         *
.* INPUTS : Unique Id and Team Number                                         *
.* OUTPUTS: MBSTOTAL - Total number of MBS Items                              *
.*          MBSFCODE - Code of the first MBS Item                             *
.******************************************************************************
GETMBS00  MOVE      ZERO,MBSTOTAL
          MOVE      SP70,MBSFCODE
          MOVE      ZERO,PMBSFLAG
          MATCH     SP70,OPDAPROV
          IF        @EQUAL
            MOVE      ONE,PMBSFLAG               * flag for prov mbs in oprpmb
          ENDIF
          MOVE      OPDAPROV,MBSFCODE            * Default to prov from theatre
          PACK      KEY14,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB1
GETMBS10  CALL      RKOPPMB1
          BRANCH    OVRCD,GETMBS99
          MATCH     OPPMUNID,OPDAUNIQ            * Same Unique Id?
          GOTO      GETMBS99 IF NOT EQUAL        * No, go to exit.
          MATCH     OPPMTMNO,TEAMNUMB            * Same Team?
          GOTO      GETMBS99 IF NOT EQUAL        * No, go to exit.
.
          ADD       ONE,MBSTOTAL
          MATCH     OPDAPROV,OPPMCMBS
          IF        @EQUAL
            MOVE      ONE,PMBSFLAG               * flag for prov mbs in oprpmb
          ENDIF
.
          IF        MBSTOTAL=1
            MATCH     SP70,MBSFCODE
            GOTO      GETMBS10 IF NOT EQUAL
            MOVE      OPPMCMBS,MBSFCODE          * Save code of first MBS Item
          ENDIF
          GOTO      GETMBS10
.
GETMBS99  RETURN
.
.******************************************************************************
.         Get total number of MBS items from all team
.******************************************************************************
ALLMBS00  MOVE      ZERO,MBSTOTAL 
          PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1
ALLMBS10  CALL      RKOPPMB1
          BRANCH    OVRCD,ALLMBS99
.
          MATCH     OPPMUNID,OPDAUNIQ            * Same Unique Id?
          GOTO      ALLMBS99 IF NOT EQUAL        * No, go to exit.
.
          ADD       ONE,MBSTOTAL
          GOTO      ALLMBS10
.
ALLMBS99  RETURN
+
.******************************************************************************
.*                         Get Implant Details                                *
.* INPUTS : Unique Id and Team Number                                         *
.* OUTPUTS: IMPTOTAL - Total number of Implants                               *
.*          IMPFCODE - Code of the first Implant                              *
.******************************************************************************
GETIMP00  MOVE      ZERO,IMPTOTAL
          MOVE      SP70,IMPFCODE
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPIM1
GETIMP10  CALL      RKOPPIM1
          BRANCH    OVRCD,GETIMP99
          MATCH     OPPIUNID,OPDAUNIQ            * Same Unique Id?
          GOTO      GETIMP99 IF NOT EQUAL        * No, go to exit.
          MATCH     OPPITMNO,TEAMNUMB            * Same Team?
          GOTO      GETIMP99 IF NOT EQUAL        * No, go to exit.
.
          ADD       ONE,IMPTOTAL
          IF        IMPTOTAL=1
            MOVE      OPPIICDE,IMPFCODE          * Save code of first Implant
          ENDIF
          GOTO      GETIMP10
.
GETIMP99  RETURN
.
.******************************************************************************
.*                      Get Expensive Items Details                           *
.* INPUTS : Unique Id and Team Number                                         *
.* OUTPUTS: EXPTOTAL - Total number of Expensive Items                        *
.*          EXPFCODE - Code of the first Expensive Item                       *
.******************************************************************************
GETEXP00  MOVE      ZERO,EXPTOTAL
          MOVE      SP70,EXPFCODE
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPEI1
GETEXP10  CALL      RKOPPEI1
          BRANCH    OVRCD,GETEXP99
          MATCH     OPPEUNID,OPDAUNIQ            * Same Unique Id?
          GOTO      GETEXP99 IF NOT EQUAL        * No, go to exit.
          MATCH     OPPETMNO,TEAMNUMB            * Same Team?
          GOTO      GETEXP99 IF NOT EQUAL        * No, go to exit.
.
          ADD       ONE,EXPTOTAL
          IF        EXPTOTAL=1
            MOVE      OPPECODE,EXPFCODE          * Save code of first Exp Item
          ENDIF
          GOTO      GETEXP10
.
GETEXP99  RETURN
.
.******************************************************************************
.*                      Get Miscellaneous Item Details                        *
.* INPUTS : Admission Number                                                  *
.* OUTPUTS: MSCFCODE - Code of the first Miscellaneous Item                   *
.******************************************************************************
GETMIS00  MOVE      SP70,MSCFCODE
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
GETMIS10  CALL      RKPMMTI1
          BRANCH    OVRCD,GETMIS20
          MATCH     ADMISSNO,PMMIVISN            * Same admission?
          GOTO      GETMIS20 IF NOT EQUAL        * No, go to exit.
          MATCH     "3",PMMIRTYP                 * Miscellaneous item
          GOTO      GETMIS10 IF NOT EQUAL        * No, get next record
.
          MOVE      PMMIITEM,MSCFCODE          * Save code of first MiscItem
          GOTO      GETMIS99
.
GETMIS20  PACK      KEY22,ADMISSNO,SP70
          CALL      RDSDTRN1
GETMIS30  CALL      RDKDTRN1
          BRANCH    OVRCD,GETMIS99
.
          MATCH     ADMISSNO,DTADMNO             * Same admission?
          GOTO      GETMIS99 IF NOT EQUAL        * No, go to exit.
          MATCH     "3",DTRECTYP                 * Miscellaneous item
          GOTO      GETMIS30 IF NOT EQUAL        * No, get next record
.
          MATCH     "1",PTDTCRST
          GOTO      GETMIS30 IF EQUAL       * Fully credited
.
          MATCH     "2",PTDTCRST
          GOTO      GETMIS30 IF EQUAL       * Credit by item
          MOVE      TITEMNO,MSCFCODE           * Save code of first MiscItem
          GOTO      GETMIS99
.
GETMIS99  RETURN
.
.-----------------------------------------------------------------------------
. Current Status of Patient
.-----------------------------------------------------------------------------
PATSTS00  MOVE      SP70,DIM30
          COMPARE   THREE,OPDASTAT
          GOTO      PATSTS05 IF NOT EQUAL
.
          MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Transferred",DIM30
          ELSE
            MOVE      "Cancelled",DIM30
          ENDIF
          GOTO      PATSTS99
.
PATSTS05  MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Holding",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Anaes",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Theatre",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPSGTISS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Theatre",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIDP
          IF        !@EQUAL
            MOVE      "Ready To Depart",DIM30
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",DIM30
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",DIM30
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,DIM30                 * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",DIM30         * Yes, set to "Deceased".
            ELSE
              MOVE      "RIP - ",DIM6            * No, prefix with "Dec"
              MOVE      DIM30,DIM19              * Save current status
              PACK      DIM30,DIM6,DIM19         * Build new status desc
            ENDIF
          ENDIF
.
PATSTS99  RETURN
.******************************************************************************
.*                      Miscelaneous Tags for PROFL120                        *
.******************************************************************************
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300,MISC1400,MISC1500:
                             MISC1600,MISC1700,MISC1800,MISC1900,MISC2000:
                             MISC2100,MISC2200,MISC2300,MISC2400,MISC2500:
                             MISC2600,MISC2700,MISC2800,MISC2900,MISC3000
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      MISC9999
.
MISC0100  WRITE     HTMLFILE;MBSTOTAL;      * Total number of MBS Items
          GOTO      MISC9999
.
MISC0200  WRITE     HTMLFILE;MBSFCODE;      * Code for First MBS Item
          GOTO      MISC9999
.
MISC0300  WRITE     HTMLFILE;IMPTOTAL;      * Total number of Implants
          GOTO      MISC9999
.
MISC0400  WRITE     HTMLFILE;IMPFCODE;      * Code for First Implant
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;EXPTOTAL;      * Total number of Expensive Items
          GOTO      MISC9999
.
MISC0600  WRITE     HTMLFILE;EXPFCODE;      * Code for First Expensive Item
          GOTO      MISC9999
.
MISC0700  WRITE     HTMLFILE;BKRXUFF4;      * Default Comment from Booking
          GOTO      MISC9999
.
MISC0800  CALL      PATSTS00                * Patient Status
          WRITE     HTMLFILE;DIM30
          GOTO      MISC9999
.
MISC0900  WRITE     HTMLFILE;SURGCODE;      * Operating Surgeon's Code
          GOTO      MISC9999
.
MISC1000  PACK      KEY6,SURGCODE,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,MISC1010
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          GOTO      MISC1020
.
MISC1010  MOVE      SP70,DOCFNAME
.
MISC1020  WRITE     HTMLFILE;DOCFNAME;
          GOTO      MISC9999
.
MISC1100  WRITE     HTMLFILE;SRGEXIST;
          GOTO      MISC9999
.
MISC1200  WRITE     HTMLFILE;MBSBILLD;
          GOTO      MISC9999
.
MISC1300  WRITE     HTMLFILE;MSCFCODE;      * Code for First Misc Item
          GOTO      MISC9999
.
MISC1400  WRITE     HTMLFILE;STFEXIST;      * Staff entered
          GOTO      MISC9999
.
MISC1500  CALL      TABONC00                * Table of Oncology items
          GOTO      MISC9999
.
MISC1600  CALL      GETRGC00                * Display regime code  
          GOTO      MISC9999
.
MISC1700  CALL      GETRGD00                * Display regime diescription
          GOTO      MISC9999
.
MISC1800  MOVE      ZERO,F1
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
MISC1810  CALL      RKPMMTI1
          BRANCH    OVRCD,MISC1820
.
          MATCH     ADMISSNO,PMMIVISN       * Same Admission number?
          GOTO      MISC1820 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      MISC1810 IF NOT EQUAL   * Not MBS item
          MOVE      ONE,F1
.
MISC1820  WRITE     HTMLFILE;F1;            * Items in pmsmtiaf
          GOTO      MISC9999
.
MISC1900  WRITE     HTMLFILE;SHOWPROV;      * Staff entered
          GOTO      MISC9999
.
MISC2000  PACK      KEY18,ADMISSNO,SP70
          CALL      RSBKUNQ1                * Check for record
          CALL      RKBKUNQ1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ADMISSNO,BKUNVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     SP70,BKUNLADM
          GOTO      MISC9999 IF EQUAL
.
          WRITE     HTMLFILE;BKUNLADM;
          GOTO      MISC9999
.
MISC2100  WRITE     HTMLFILE;NEWSESSI;      * New session for sportsmed
          GOTO      MISC9999
. 
MISC2200  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2300  WRITE     HTMLFILE;ATIME;
          GOTO      MISC9999
.
MISC2400  WRITE     HTMLFILE;DTIME;
          GOTO      MISC9999
.
MISC2500  WRITE     HTMLFILE;PTCNADDF;
          GOTO      MISC9999
.
MISC2600  UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2700  WRITE     HTMLFILE;BKREATIM;
          GOTO      MISC9999
.
MISC2800  WRITE     HTMLFILE;SAVKEY76;
          GOTO      MISC9999
.
MISC2900  WRITE     HTMLFILE;UPDOPSDT;
          GOTO      MISC9999
.
MISC3000  MATCH     "1",UPDOPATI
          GOTO      MISC9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,ONE,THREE,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,MISC9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MATCH     "1",KEY1
          IF        @EQUAL
            MATCH     SP70,OPABYN01
            IF        !@EQUAL
              MATCH     "0",OPABYN01
              GOTO      MISC3010 IF NOT EQUAL
            ENDIF
.
            MATCH     SP70,OPABYN02
            IF        !@EQUAL
              MATCH     "0",OPABYN02
              GOTO      MISC3010 IF NOT EQUAL
            ENDIF
.
            MATCH     SP70,OPABTXT1
            GOTO      MISC3010 IF NOT EQUAL
.
            MATCH     SP70,OPABTXT2
            GOTO      MISC3010 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            MATCH     SP70,OPABYN03
            IF        !@EQUAL
              MATCH     "0",OPABYN03
              GOTO      MISC3010 IF NOT EQUAL
            ENDIF
.
            MATCH     SP70,OPABYN04
            IF        !@EQUAL
              MATCH     "0",OPABYN04
              GOTO      MISC3010 IF NOT EQUAL
            ENDIF
.
            MATCH     SP70,OPABVAL1
            GOTO      MISC3010 IF NOT EQUAL
.
            MATCH     SP70,OPABVAL2
            GOTO      MISC3010 IF NOT EQUAL
          ENDIF
.
          GOTO      MISC9999
.
MISC3010  WRITE     HTMLFILE;ONE;
          GOTO      MISC9999
.
MISC9999  RETURN
+
.******************************************************************************
.*                  Caesarean Birth Details (Tags for PROFL180)               *
.******************************************************************************
CBTH0000  BRANCH    FLDITMNO,CBTH0100,CBTH0200,CBTH0300,CBTH0400,CBTH0500:
                             CBTH0600,CBTH0700,CBTH0800,CBTH0900,CBTH1000:
                             CBTH1100
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      CBTH9999
.
CBTH0100  WRITE     HTMLFILE;OPCBUNIQ;      * Theatre Unique ID
          GOTO      CBTH9999
.
CBTH0200  WRITE     HTMLFILE;OPCBCOUN;      * Count
          GOTO      CBTH9999
.
CBTH0300  WRITE     HTMLFILE;OPCBBSEX;      * Baby Sex
          GOTO      CBTH9999
.
CBTH0400  UNPACK    OPCBBDOB,CCENT,CYEAR,CMON,CDAY  * Date of Birth
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CBTH9999
.
CBTH0500  WRITE     HTMLFILE;OPCBBTME;      * Time of Birth
          GOTO      CBTH9999
.
CBTH0600  WRITE     HTMLFILE;OPCBBURN;      * Baby UR
          GOTO      CBTH9999
.
CBTH0700  WRITE     HTMLFILE;OPCBDELT;      * Delete Indicator (0=No,1=Yes)
          GOTO      CBTH9999
.
CBTH0800  CALL      CSBTBL00                * Display Birth Details table
          GOTO      CBTH9999
.
CBTH0900  CALL      GETCNT00                * Get next count
          GOTO      CBTH9999
.
CBTH1000  WRITE     HTMLFILE;OPCBBWGT;      * Birth Weight (grams)
          GOTO      CBTH9999
.
CBTH1100  WRITE     HTMLFILE;OPCBPDTM;      * Placenta Delivery Time
          GOTO      CBTH9999
.
CBTH9999  RETURN
+
.******************************************************************************
.*                  Output Caesarean Birth Details Table                      *
.******************************************************************************
CSBTBL00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      CBHED000      * Output Table Heading
.
          PACK      KEY26,CASEKEYS,SP70      * Re read original oprdetaf record
          CALL      RDOPDEA1
          BRANCH    OVRCD,CSBTBL99
.
          PACK      KEY12,OPDAUNIQ,SP70
          CALL      RSOPCBD1
CSBTBL10  CALL      RKOPCBD1
          BRANCH    OVRCD,CSBTBL99
.
          MATCH     OPDAUNIQ,OPCBUNIQ
          GOTO      CSBTBL99 IF NOT EQUAL
.
          MATCH     "1",OPCBDELT                 * Deleted?
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",CASEKEYS
          REP       " +",OPCBUNIQ
          MOVE      OPCBCOUN,OPRCBCNT
          REP       " +",OPRCBCNT
.
          MATCH     OPCBBDOB,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",DISPDATE
            GOTO     CSBTBL40
          ENDIF
.
          UNPACK    OPCBBDOB,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CSBTBL40  WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetails":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&casekeys=",CASEKEYS:
                             "&oprcbuni=",OPCBUNIQ:
                             "&oprcbcnt=",OPRCBCNT,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,OPCBCOUN,STRENDTG,"&nbsp</td>":
                             "<td>&nbsp;",STRIKETG,OPCBBSEX,STRENDTG,"</td>":
                             "<td>&nbsp;",STRIKETG,DISPDATE,STRENDTG,"</td>":
                             "<td>&nbsp;",STRIKETG,OPCBBTME,STRENDTG,"</td>":
                             "<td>&nbsp;",STRIKETG,OPCBPDTM,STRENDTG,"</td>":
                             "<td>&nbsp;",STRIKETG,OPCBBURN,STRENDTG,"</td>":
                             "<td>&nbsp;",STRIKETG,OPCBBWGT,STRENDTG,"</td>":
                             "</tr>"
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",CASEKEYS
          REP       "+ ",OPCBUNIQ
.
          GOTO      CSBTBL10
.
CSBTBL99  RETURN
+
.******************************************************************************
.*                  Get next count value for the Caesarean Birth Details      *
.******************************************************************************
GETCNT00  MOVE      ZERO,F2
.
          PACK      KEY26,CASEKEYS,SP70      * Re read original oprdetaf record
          CALL      RDOPDEA1
          BRANCH    OVRCD,GETCNT90
.
          PACK      KEY12,OPDAUNIQ,SP70
          CALL      RSOPCBD1
GETCNT10  CALL      RKOPCBD1
          BRANCH    OVRCD,GETCNT90
.
          MATCH     OPDAUNIQ,OPCBUNIQ
          GOTO      GETCNT90 IF NOT EQUAL
.
          MOVE      OPCBCOUN,F2
          GOTO      GETCNT10
.
GETCNT90  ADD       ONE,F2
          WRITE     HTMLFILE;F2;
.
GETCNT99  RETURN
+
.******************************************************************************
.*                  Output Caesarean Birth Details Table Heading Row          *
.******************************************************************************
CBHED000  WRITE     HTMLFILE;"<tr>":
                      "<td class=HeadingCell width=10%>Count</td>":
                      "<td class=HeadingCell width=10%>Sex</td>":
                      "<td class=HeadingCell width=15%>Date of Birth</td>":
                      "<td class=HeadingCell width=15%>Time of Birth</td>":
                  "<td class=HeadingCell width=20%>Placenta Delivery Time</td>":
                      "<td class=HeadingCell width=15%>Baby UR</td>":
                      "<td class=HeadingCell>Birth Weight (gm)</td>":
                    "</tr>"
.
CBHED999  RETURN
+
.******************************************************************************
.*                      Update Day Procedure Details                          *
.******************************************************************************
UPDDAY00  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RLOPSRG1               * locks the record for updating
          BRANCH    OVRCD,UPDDAY10,UPDDAY92
          GOTO      UPDDAY20
.
UPDDAY10  MATCH     "1",TEAMNUMB
          GOTO      UPDDAY91 IF NOT EQUAL
          MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          CALL      CLOPRSRG
          MOVE      ZERO,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00
          PROC      PREVTIME
          BRANCH    EXIT,UPDDAY90,UPDDAY93
          CALL      WROPSRG1
          IF        STAFFLAG <> 1
            CALL      DFLTTM00
            MOVE      ONE,STAFFLAG          * don't default again
          ENDIF
...       CALL      MBSCHK00
          GOTO      UPDDAY30
.
UPDDAY20  MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          MOVE      ONE,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00                * moving cgi variables to file var
          PROC      PREVTIME
          BRANCH    EXIT,UPDDAY90,UPDDAY93
          CALL      UPOPSRG1                * updating surgical details
.
.         Check if any mbs written to oprpmbs file
.
          CALL      GETMBS00                * Get Theatre MBS Details
...       IF        MBSTOTAL=0
...         CALL      MBSCHK00
...       ENDIF
.
          CALL      UUOPSRG1                * unlock the record
.
UPDDAY30  MOVE      SP70,SAVEANUR
          MOVE      SP70,SAVEADAT
          MOVE      SP70,SAVEATIM
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
            CALL      MVOPAR00
            MOVE      OPDAUNIQ,OPARUNID
            CALL      WROPARD1
          ELSE
            MOVE      OPARANUR,SAVEANUR
.           MOVE      OPSEDATE,SAVEADAT
            MOVE      OPARATIM,SAVEATIM
.
            MOVE      OPARNUD1,SAVENUD1
.           MOVE      OPSEDATE,SAVEDUD1
            MOVE      OPARTIRD,SAVETUD1
.
            MOVE      OPARNUD2,SAVENUD2
.           MOVE      OPSEDATE,SAVEDUD2
            MOVE      OPARTIRD,SAVETUD2
.
            MATCH     SP70,OPARANAS
            IF        !@EQUAL
              MOVE      ONE,STAFFLAG   * default team has already been written
            ENDIF
            CALL      MVOPAR00
            CALL      UPOPARD1
          ENDIF
          IF        STAFFLAG = 2
            CALL      DFLTTM00         * default team as anaesthetic time exists
          ENDIF
.
          MOVE      OPDEA003,OPDAANAE
          MATCH     Z70,OPDEA004
          IF        !@EQUAL
            MOVE      OPDEA004,OPDATYPE
          ENDIF
          MATCH     Z70,OPDEA006
          IF        !@EQUAL
            MOVE      OPDEA006,OPDAUSR1
          ENDIF
          MOVE      OPDEA014,OPDADES1
          MOVE      OPDEA015,OPDADES2
          MOVE      OPDEA016,OPDADES3
.
          MATCH     Z70,OPDEA020
          IF        !@EQUAL
            MOVE      OPDEA020,OPDAPRE1
          ENDIF
.
          MATCH     Z70,OPDEA021
          IF        !@EQUAL
            MOVE      OPDEA021,OPDAPRE2
          ENDIF
.
          MATCH     Z70,OPDEA022
          IF        !@EQUAL
            MOVE      OPDEA022,OPDAPRE3
          ENDIF
.
          MATCH     Z70,OPDEA023
          IF        !@EQUAL
            MOVE      OPDEA023,OPDAPRE4
          ENDIF
.
          MATCH     Z70,OPDEA024
          IF        !@EQUAL
            MOVE      OPDEA024,OPDAPRE5
          ENDIF
.
          MATCH     Z70,OPDEA025
          IF        !@EQUAL
            MOVE      OPDEA025,OPDAPOS1
          ENDIF
.
          MATCH     Z70,OPDEA026
          IF        !@EQUAL
            MOVE      OPDEA026,OPDAPOS2
          ENDIF
.
          MATCH     Z70,OPDEA027
          IF        !@EQUAL
            MOVE      OPDEA027,OPDAPOS3
          ENDIF
.
          MATCH     Z70,OPDEA028
          IF        !@EQUAL
            MOVE      OPDEA028,OPDAPOS4
          ENDIF
.
          MATCH     Z70,OPDEA030
          IF        !@EQUAL
            MOVE      OPDEA030,OPDAKNOW
          ENDIF
.
          MATCH     Z70,OPDEA043
          IF        !@EQUAL
            MOVE      OPDEA043,OPDAPCOM       * Prosthetic items complete
          ENDIF
.
          MATCH     Z70,OPDEA044
          IF        !@EQUAL
            MOVE      OPDEA044,OPDADES4
          ENDIF
          MATCH     Z70,OPDEA045
          IF        !@EQUAL
            MOVE      OPDEA045,OPDADES5
          ENDIF
          MATCH     Z70,OPDEA046
          IF        !@EQUAL
            MOVE      OPDEA046,OPDADES6
          ENDIF
.
          MATCH     Z70,OPDEA049
          IF        !@EQUAL
            MOVE      OPDEA049,OPDAPRV4
          ENDIF
          MATCH     Z70,OPDEA050
          IF        !@EQUAL
            MOVE      OPDEA050,OPDAPRV5
          ENDIF
          MATCH     Z70,OPDEA051
          IF        !@EQUAL
            MOVE      OPDEA051,OPDAPRV6
          ENDIF
.
          CALL      IBACLOCK
          MOVE      CURRDATE,OPDAUDAT
          CLOCK     TIME,OPDAUTIM
          MOVE      USERID,OPDAWEBU
.
          CALL      UPOPDEA1
          MOVE      FIVE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,UPDDAY91
.
          MOVE      OPSES012,OPSETYPE
          MOVE      OPSEDATE,OPSEACDE
.
          MOVE      OPSEDATE,SAVEADAT
          MOVE      OPSEDATE,SAVEDUD1
          MOVE      OPSEDATE,SAVEDUD2
.
. If DATEFLAG=1 then surgery ends on next day else on same day.
.
          MATCH     "1",DATEFLAG
          IF        @EQUAL
            CALL      NXTDAT00
          ENDIF
          CALL      UPOPSES1
.
          CALL      UPCOM000                     * Update Comments
          CALL      UPCMX000
.
          CALL      AUEXDS00                * Add/Update extended Proc Desc
.
          IF        RECOPMIN=ONE
            CALL      ROPMIN00              * Recalculate Actual Op Minutes.
          ENDIF
.
          ENDSET    REDIRECT
          APPEND    TEAMNUMB,REDIRECT
          RESET     REDIRECT
.
          MOVE      ZERO,EXIT
          GOTO      UPDDAY99
.
UPDDAY90  MOVE      "Surgery start time cannot be before previous end time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      UPDDAY99                
. 
UPDDAY91  MOVE      "Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDAY99
.
UPDDAY92  MOVE      "Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDAY99
.
UPDDAY93  MOVE      "Previous end time required.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      UPDDAY99                
. 
UPDDAY99  RETURN
.
.******************************************************************************
.*                 Main Action Routine for Preference Details                 *
.******************************************************************************
OPRPRF00  CALL      VALCAS00                * validation for CASEKEYS
          BRANCH    EXIT,OPRPRF99
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRPRF40 IF EQUAL
.
          MATCH     "U",UPDATETY            
          GOTO      OPRPRF10 IF EQUAL
.
          GOTO      OPRPRF90
.
.******************************************************************************
.*         Write Preference Details                                          *
.******************************************************************************
OPRPRF10  PACK      KEY36,OPDAUNIQ,SP70
          CALL      RSOPREQ1
          CALL      RKOPREQ1
          BRANCH    OVRCD,OPRPRF12
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      OPRPRF12 IF NOT EQUAL
.
          PACK      KEY36,OPRQUNIQ,OPRQTEAM,OPRQDCOD,OPRQCLSS,OPRQTYPE:
                          OPRQITEM,SP70
          CALL      DEOPREQ1
.
          GOTO      OPRPRF10
.
.
.
OPRPRF12  MOVE      ONE,F3
          MOVE      ZERO,EXIT
.
OPRPRF15  MATCH     SP70,PREFTKEY[F3]
          GOTO      OPRPRF99 IF EQUAL
.
.          BRANCH    PREFTFLG[F3],OPRPRF20
...
...         Delete Preference
...
..          PACK      KEY32,PREFTKEY[F3],SP70
..          CALL      RDOPPRF1
..          BRANCH    OVRCD,OPRPRF17
...
..          CALL      DEOPPRF1                
..
.OPRPRF17  UNPACK    PREFTKEY[F3],OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,DIM1
..
.          MATCH     "0",DIM1
.          GOTO      OPRPRF19 IF EQUAL
..
.          PACK      KEY34,OPPRDCOD,OPPRPREF,SP70
.          CALL      RSOPDPF1
.OPRPRF18  CALL      RKOPDPF1
.          BRANCH    OVRCD,OPRPRF19
..
.          MATCH     OPDFCODE,OPPRDCOD
.          GOTO      OPRPRF19 IF NOT EQUAL
..
.          MATCH     OPDFPREF,OPPRPREF
.          GOTO      OPRPRF19 IF NOT EQUAL
..
.          PACK      KEY36,OPPRUNIQ,OPPRTEAM,OPDFCODE,OPDFCLSS,OPDFTYPE,OPDFITEM:
.                          SP70 
.          CALL      RDOPREQ1
.          IF        OVRCD=0
.            MATCH     "1",OPRQCHRG
.            GOTO      OPRPRF18 IF EQUAL
..
.            CALL      DEOPREQ1            
.          ENDIF
..
.          GOTO      OPRPRF18
..
.OPRPRF19  PACK      KEY32,PREFTKEY[F3],SP70
.          CALL      RDOPPRF1
.          IF        OVRCD=0
..
.            MOVE      ZERO,OPPRPQTY
.            CALL      UPOPPRF1
.          ENDIF
..
.          ADD       ONE,F3
.          GOTO      OPRPRF15
.
.         Add/Update Preferences
.
OPRPRF20  PACK      KEY32,PREFTKEY[F3],SP70
          CALL      RDOPPRF1
          IF        OVRCD=0       
.
            UNPACK    PREFTKEY[F3],KEY32,DIM1
.
            MATCH     "0",DIM1
            IF        @EQUAL
              PACK      DIM9,OPPRPREF,SP70
              PACK      KEY18,OPPRDCOD,DIM9,OPDAHOSP,SP70
              CALL      RDOPDPH1
              IF        OVRCD=0
                GOTO      OPRPRF21
              ENDIF
            ENDIF
.
            IF        PREFTFLG[F3]=ZERO
              MOVE      ZERO,OPPRPQTY
            ELSE
              MOVE      PREFTQTY[F3],OPPRPQTY
            ENDIF
.
            CALL      UPOPPRF1
          ELSE
            UNPACK    KEY32,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF
.
            IF        PREFTFLG[F3]=ZERO
              MOVE      ZERO,OPPRPQTY
            ELSE
              MOVE      PREFTQTY[F3],OPPRPQTY
            ENDIF
.
            CALL      WROPPRF1
          ENDIF
.
          UNPACK    PREFTKEY[F3],OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,DIM1
.
OPRPRF21  MATCH     "0",DIM1
          GOTO      OPRPRF30 IF EQUAL       * Not an item
.
          IF        PREFTFLG[F3]=ZERO
            GOTO      OPRPRF30              * not ticked
          ENDIF
.
          PACK      DIM9,OPPRPREF,SP70
          PACK      KEY18,OPPRDCOD,DIM9,OPDAHOSP,SP70
          CALL      RDOPDPH1
          BRANCH    OVRCD,OPRPRF30
.
          PACK      KEY37,OPPRDCOD,OPPRPREF,SP70
          CALL      RSOPDPF1
OPRPRF22  CALL      RKOPDPF1
          BRANCH    OVRCD,OPRPRF25              
.
          MATCH     OPDFCODE,OPPRDCOD
          GOTO      OPRPRF25 IF NOT EQUAL
.
          MATCH     OPDFPREF,OPPRPREF
          GOTO      OPRPRF25 IF NOT EQUAL
.
          PACK      KEY36,OPPRUNIQ,OPPRTEAM,OPDFCODE,OPDFCLSS,OPDFTYPE,OPDFITEM:
                          SP70
          CALL      RDOPREQ1
          IF        OVRCD=0
            MATCH     "1",OPRQCHRG
            GOTO      OPRPRF25 IF EQUAL
.
            MOVE      OPDFQTY,OPRQAMNT
.
            CALL      UPOPREQ1
          ELSE
            MOVE      OPPRUNIQ,OPRQUNIQ
            MOVE      OPPRTEAM,OPRQTEAM
            MOVE      OPDFCLSS,OPRQCLSS
            MOVE      OPDFTYPE,OPRQTYPE
            MOVE      OPDFITEM,OPRQITEM
            MOVE      OPDFQTY,OPRQAMNT
            MOVE      OPDFCODE,OPRQDCOD
            MOVE      ZERO,OPRQCHRG
            MOVE      SP70,OPRQSPAR
.
            CALL      WROPREQ1
          ENDIF
.
          GOTO      OPRPRF22
.
OPRPRF25  PACK      KEY24,OPPRDCOD,OPPRPREF,SP70
          CALL      RSOPPCM1
OPRPRF27  CALL      RKOPPCM1
          BRANCH    OVRCD,OPRPRF30
.
          MATCH     OPPCCODE,OPPRDCOD
          GOTO      OPRPRF30 IF NOT EQUAL
.
          MATCH     OPPCPREF,OPPRPREF
          GOTO      OPRPRF30 IF NOT EQUAL
.
          MOVE      "3",DIM1A
.
          PACK      KEY36,OPPRUNIQ,OPPRTEAM,OPPCCODE,OPPCCLSS,DIM1A,OPPCPREF:
                          SP70
          CALL      RDOPREQ1
          IF        OVRCD=1
            MOVE      OPPRUNIQ,OPRQUNIQ
            MOVE      OPPRTEAM,OPRQTEAM 
            MOVE      OPPCCLSS,OPRQCLSS
            MOVE      DIM1A,OPRQTYPE
            MOVE      OPPCPREF,OPRQITEM
            MOVE      ZERO,OPRQAMNT
            MOVE      OPPCCODE,OPRQDCOD
            MOVE      ZERO,OPRQCHRG
            MOVE      SP70,OPRQSPAR
.
            CALL      WROPREQ1
          ENDIF
.
          GOTO      OPRPRF27
.
OPRPRF30  ADD       ONE,F3
          GOTO      OPRPRF15
.
.
.
.******************************************************************************
.*         Display of Preference Details                                      *
.******************************************************************************
OPRPRF40  MOVE      "Theatre Preference Details",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRPRF99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRPRF99
.******************************************************************************
.*                          ERROR HANDLING                                    *
.******************************************************************************
OPRPRF90  MOVE      "Invalid Form Option",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPRF99
.
OPRPRF91  MOVE      "Preference Record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPRF99
.
OPRPRF92  MOVE      "Preference Record is Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRPRF99
.
OPRPRF99  RETURN
+
.******************************************************************************
.*                 Main Action Routine for Requisitions Details               *
.******************************************************************************
OPRREQ00  CALL      VALCAS00                * validation for CASEKEYS
          BRANCH    EXIT,OPRREQ99
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRREQ80 IF EQUAL
.
          MATCH     "A",UPDATETY
          GOTO      OPRREQ10 IF EQUAL
.
          MATCH     "U",UPDATETY
          GOTO      OPRREQ20 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      OPRREQ30 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      OPRREQ40 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      OPRREQ50 IF EQUAL
.
          GOTO      OPRREQ90
.
.******************************************************************************
.*         Write Requisitions Details                                         *
.******************************************************************************
OPRREQ10  PACK      KEY36,OPREQ001,OPREQ002,OPREQ007,OPREQ003,OPREQ004:
                          OPREQ005,SP70
          CALL      RDOPREQ1
          COMPARE   ZERO,OVRCD
          GOTO      OPRREQ91 IF EQUAL
.
          CALL      MVOREQ00
          CALL      WROPREQ1
.
          MOVE      ZERO,EXIT
          GOTO      OPRREQ99
.
.******************************************************************************
.*         Update Requisitions Details                                        *
.******************************************************************************
OPRREQ20  PACK      KEY36,OPREQ001,OPREQ002,OPREQ007,OPREQ003,OPREQ004:
                          OPREQ005,SP70
          CALL      RDOPREQ1
          BRANCH    OVRCD,OPRREQ92
.
          CALL      MVOREQ00
          CALL      UPOPREQ1
.
          MOVE      ZERO,EXIT
          GOTO      OPRREQ99
.
.******************************************************************************
.*         Delete Requisitions Details                                        *
.******************************************************************************
OPRREQ30  PACK      KEY36,OPREQ001,OPREQ002,OPREQ007,OPREQ003,OPREQ004:
                          OPREQ005,SP70
          CALL      RDOPREQ1
          BRANCH    OVRCD,OPRREQ92
.
          CALL      DEOPREQ1
.
          MOVE      ZERO,EXIT
          GOTO      OPRREQ99
.
.******************************************************************************
.*         Print  Requisitions Details                                        *
.******************************************************************************
OPRREQ40  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRREQ96
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPREQ1
          CALL      RKOPREQ1
          BRANCH    OVRCD,OPRREQ95
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      OPRREQ95 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      OPRREQ95 IF NOT EQUAL
.
          MOVE      PRGNAM,SAVKEY32
          MOVE      "Requisition Report",PRGNAM
          CALL      OPNPRINT
          CALL      OPHTMREQ
          CALL      CLSPRINT
          MOVE      SAVKEY32,PRGNAM
.
          MOVE      ZERO,EXIT
          GOTO      OPRREQ99
.
.******************************************************************************
.*         Add All Doctor Preferences                                         *
.******************************************************************************
OPRREQ50  MOVE      ONE,F3
          MOVE      ZERO,EXIT
.
OPRREQ52  MATCH     SP70,ADDREQDT[F3]
          GOTO      OPRREQ60 IF EQUAL
.
          MOVE      OPDAUNIQ,OPREQ001
          MOVE      TEAMNUMB,OPREQ002
          UNPACK    ADDREQDT[F3],OPREQ007,OPREQ003,OPREQ004,OPREQ005,OPREQ006
.
          PACK      KEY36,OPREQ001,OPREQ002,OPREQ007,OPREQ003,OPREQ004:
                          OPREQ005,SP70
          CALL      RDOPREQ1
          COMPARE   ZERO,OVRCD
          GOTO      OPRREQ59 IF EQUAL
.
          CALL      MVOREQ00
          CALL      WROPREQ1
.
OPRREQ59  MOVE      SP70,ADDREQDT[F3]
          ADD       ONE,F3
          GOTO      OPRREQ52
.
OPRREQ60  PACK      KEY32,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPRF1
OPRREQ61  CALL      RKOPPRF1
          BRANCH    OVRCD,OPRREQ99
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      OPRREQ99 IF NOT EQUAL
.
          MATCH     TEAMNUMB,OPPRTEAM
          GOTO      OPRREQ99 IF NOT EQUAL
.
          COMPARE   ZERO,OPPRPQTY
          GOTO      OPRREQ61 IF EQUAL
.
          PACK      KEY24,OPPRDCOD,OPPRPREF,SP70
          CALL      RSOPPCM1
OPRREQ65  CALL      RKOPPCM1
          BRANCH    OVRCD,OPRREQ67
.
          MATCH     OPPCCODE,OPPRDCOD
          GOTO      OPRREQ67 IF NOT EQUAL
.
          MATCH     OPPCPREF,OPPRPREF
          GOTO      OPRREQ67 IF NOT EQUAL
.
          MOVE      "3",DIM1A
.
          PACK      KEY36,OPPRUNIQ,OPPRTEAM,OPPCCODE,OPPCCLSS,DIM1A,OPPCPREF:
                          SP70
          CALL      RDOPREQ1
          IF        OVRCD=1
            MOVE      OPPRUNIQ,OPRQUNIQ
            MOVE      OPPRTEAM,OPRQTEAM
            MOVE      OPPCCLSS,OPRQCLSS
            MOVE      DIM1A,OPRQTYPE
            MOVE      OPPCPREF,OPRQITEM
            MOVE      ZERO,OPRQAMNT
            MOVE      OPPCCODE,OPRQDCOD
            MOVE      ZERO,OPRQCHRG
            MOVE      SP70,OPRQSPAR
.
            CALL      WROPREQ1
          ENDIF
.
          GOTO      OPRREQ65
.
OPRREQ67  GOTO      OPRREQ61
.
.******************************************************************************
.*         Display of Requisitions Details                                    *
.******************************************************************************
OPRREQ80  PACK      KEY36,OPREQ001,OPREQ002,OPREQ007,OPREQ003,OPREQ004:
                          OPREQ005,SP70
          CALL      RDOPREQ1
          IF        OVRCD=1        
            CALL      CLOREQ00
          ENDIF
.
          MOVE      "Theatre Requisitions Details",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRREQ99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.******************************************************************************
.*                          ERROR HANDLING                                    *
.******************************************************************************
OPRREQ90  MOVE      "Invalid Form Option",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ91  MOVE      "Requisitions Record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ92  MOVE      "Requisitions Record is Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ93  MOVE      "Doctor Preference Record is Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ94  MOVE      "Preference Record is Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ95  MOVE      "No Requisitions to Print.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ96  MOVE      "Session Record is Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREQ99
.
OPRREQ99  RETURN
+
.*************************************************************************
.*                      Process Fields in Body of HTML Template               *
.******************************************************************************
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110,PROFL120,PROFL130,PROFL140,PROFL150:
                             PROFLD99,PROFL170,PROFL180,PROFL190,PROFL200
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      ODET0000      
          GOTO      PROFLD99
.
PROFLD13  CALL      OPSG0000        
          GOTO      PROFLD99
.
PROFLD14  CALL      TDET0000       
          GOTO      PROFLD99
.
PROFLD15  CALL      OSES0000
          GOTO      PROFLD99
.
PROFLD16  CALL      OPAR0000
          GOTO      PROFLD99
.
PROFLD17  CALL      OPCL0000
          GOTO      PROFLD99
.
PROFLD18  CALL      OPSI0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      ODET0000      
          GOTO      PROFLD99
.
PROFLD23  CALL      OPIC0000     
          GOTO      PROFLD99
.
PROFLD24  CALL      CMBS0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      ODET0000    
          GOTO      PROFLD99
.
PROFLD33  CALL      CMBS0000   
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43
          GOTO      PROFLD99

PROFLD41  CALL      MASF0000
          GOTO      PROFLD99

PROFLD42  CALL      ODET0000  
          GOTO      PROFLD99
.
PROFLD43  CALL      OPIE0000 
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD52  CALL      ODET0000
          GOTO      PROFLD99
.
PROFLD53  CALL      EPIT0000
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61
          GOTO      PROFLD99
.
PROFLD61  CALL      THMP0000                * Implant Description Table Routine
          GOTO      PROFLD99
.                           
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD72  CALL      ODET0000 
          GOTO      PROFLD99
.                           
PROFLD73  CALL      PIMD0000
          GOTO      PROFLD99
.                          
PROFLD74  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84,PROFLD85:
                             PROFLD86,PROFLD87,PROFLD88
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000
          GOTO      PROFLD99     
.
PROFLD82  CALL      ODET0000                * Case Details
          GOTO      PROFLD99
.                              
PROFLD83  CALL      OPSG0000                * Surgecal Table Details
          GOTO      PROFLD99
.
PROFLD84  CALL      OTDT0000                * Other Theatre Details
          GOTO      PROFLD99
.
PROFLD85  CALL      OPS20000                * Surgecal Table Details
          GOTO      PROFLD99                * Additional variables
.
PROFLD86  CALL      OPCL0000                * Clinical Details
          GOTO      PROFLD99
.
PROFLD87  CALL      TDET0000 
          GOTO      PROFLD99
.
PROFLD88  CALL      OSES0000
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD92  CALL      ODET0000  
          GOTO      PROFLD99
.                            
PROFLD93  CALL      TNQT0000
          GOTO      PROFLD99
.
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102,PROFL103,PROFL104,PROFL105:
                             PROFL106,PROFL107,PROFL108,PROFL109,PROFL10A
          GOTO      PROFLD99
.
PROFL101  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL102  CALL      ODET0000 
          GOTO      PROFLD99
.                           
PROFL103  CALL      OPAR0000
          GOTO      PROFLD99
.                                           
PROFL104  CALL      OPSG0000
          GOTO      PROFLD99
.                                           
PROFL105  CALL      WTDE0000                * Waiting List (WATDETTM)
          GOTO      PROFLD99
.
PROFL106  CALL      OPRC0000                  * Patient Recovery List
          GOTO      PROFLD99
.                                           
PROFL107  CALL      MISF0000  
          GOTO      PROFLD99
.                                           
PROFL108  CALL      OPRA0000 
          GOTO      PROFLD99
.
PROFL109  CALL      TDET0000
          GOTO      PROFLD99
.
PROFL10A  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113,PROFL114,PROFL115
          GOTO      PROFLD99
.
PROFL111  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL112  CALL      OPTHE000
          GOTO      PROFLD99
.
PROFL113  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL114  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL115  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122,PROFL123,PROFL124,PROFL125:
                             PROFL126,PROFL127,PROFL128,PROFL129,PROFL12A
          GOTO      PROFLD99
.
PROFL121  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL122  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL123  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL124  CALL      TDET0000
          GOTO      PROFLD99
.
PROFL125  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL126  CALL      OPAR0000
          GOTO      PROFLD99
.
PROFL127  CALL      OPSG0000        
          GOTO      PROFLD99
.
PROFL128  CALL      MISF0000        
          GOTO      PROFLD99
.
PROFL129  CALL      OPRA0000
          GOTO      PROFLD99
.
PROFL12A  CALL      OPSI0000
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132,PROFL133,PROFL134
          GOTO      PROFLD99
.
PROFL131  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL132  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL133  CALL      OPRF0000
          GOTO      PROFLD99
.
PROFL134  CALL      PMSC0000
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142,PROFL143,PROFL144
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL142  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL143  CALL      OREQ0000
          GOTO      PROFLD99
.
PROFL144  CALL      PMSC0000
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152,PROFL153,PROFL154
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL152  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL153  CALL      JREG0000 
          GOTO      PROFLD99
.
PROFL154  CALL      OPJR0000 
          GOTO      PROFLD99
.
PROFL170  BRANCH    FLDSETNO,PROFL171,PROFL172,PROFL173,PROFL174,PROFL175:
                             PROFL176,PROFL177,PROFL178,PROFL179
          GOTO      PROFLD99
.
PROFL171  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL172  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL173  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL174  CALL      TDET0000
          GOTO      PROFLD99
.
PROFL175  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL176  CALL      OPAR0000
          GOTO      PROFLD99
.
PROFL177  CALL      OPSG0000
          GOTO      PROFLD99
.
PROFL178  CALL      BREC0000
          GOTO      PROFLD99
.
PROFL179  CALL      BKRX0000
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181,PROFL182,PROFL183,PROFL184
          GOTO      PROFLD99
.
PROFL181  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL182  CALL      ODET0000
          GOTO      PROFLD99
.
PROFL183  CALL      CBTH0000           * Caesarean Birth Details Maintenance
          GOTO      PROFLD99
.
PROFL184  CALL      TDET0000
          GOTO      PROFLD99
.
PROFL190  BRANCH    FLDSETNO,PROFL191,PROFL192
          GOTO      PROFLD99
.
PROFL191  CALL      ORCL0000
          GOTO      PROFLD99
.
PROFL192  CALL      PMSC0000
          GOTO      PROFLD99
.
PROFL200  BRANCH    FLDSETNO,PROFL201,PROFL202
          GOTO      PROFLD99
.
PROFL201  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL202  CALL      PMSC0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.******************************************************************************
.*                      Miscellaneous Tags for PROFL130                        *
.******************************************************************************
PMSC0000  BRANCH    FLDITMNO,PMSC0100,PMSC0200,PMSC0300,PMSC0400,PMSC0500:
                             PMSC0600,PMSC0700,PMSC0800,PMSC0900,PMSC1000:
                             PMSC1100,PMSC1200,PMSC1300,PMSC1400,PMSC1500:
                             PMSC1600,PMSC1700,PMSC1800,PMSC1900,PMSC2000:
                             PMSC2100,PMSC2200,PMSC2300,PMSC2400,PMSC2500:
                             PMSC2600,PMSC2700,PMSC2800,PMSC2900,PMSC3000
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      PMSC9999
.
PMSC0100  WRITE     HTMLFILE;TEAMNUMB;     
          GOTO      PMSC9999
.
PMSC0200  CALL      PRFTAB00
          GOTO      PMSC9999
.
PMSC0300  CALL      FNDSRG00
          GOTO      PMSC9999
.
PMSC0400  CALL      REQTAB00
          GOTO      PMSC9999
.
PMSC0500  MATCH     Z70,OPREQ004
          GOTO      PMSC9999 IF EQUAL
.
          WRITE     HTMLFILE;OPREQ004;   * Item type
          GOTO      PMSC9999
.
PMSC0600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     Z70,OPREQ005
          GOTO      PMSC9999 IF EQUAL
.
          BRANCH    F1,PMSC0610
.
          WRITE     HTMLFILE;OPREQ005;   * Item Code
          GOTO      PMSC9999
.
PMSC0610  MOVE      ZERO,F1
          MOVE      OPREQ004,F1
          BRANCH    F1,PMSC0620,PMSC0630
.
          PACK      KEY18,OPREQ005,SP70
          CALL      RDOPTRA1
          IF        OVRCD=1
            MOVE      "Invalid Tray",OPTHDESC
          ENDIF
          WRITE     HTMLFILE;OPTHDESC;
          GOTO      PMSC9999
.
PMSC0620  PACK      KEY15,OPREQ005,SP70
          CALL      RDOPITE1
          IF        OVRCD=1
            MOVE      "Invalid Item",OPITDESC
          ENDIF
          WRITE     HTMLFILE;OPITDESC;
          GOTO      PMSC9999
.
PMSC0630  PACK      KEY18,OPREQ005,SP70
          CALL      RDOPEQP1
          IF        OVRCD=1
            MOVE      "Invalid Equipment",OPEQDESC
          ENDIF
          WRITE     HTMLFILE;OPEQDESC;
          GOTO      PMSC9999
.
PMSC0700  MATCH     Z70,OPREQ003
          IF        @EQUAL             
            MOVE      SP70,CODE        * Class
          ELSE
            MOVE      OPREQ003,CODE        * Class
          ENDIF
          MOVE      "OG",CATEGORY
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC0800  MATCH     Z70,OPREQ006
          GOTO      PMSC9999 IF EQUAL
.
          WRITE     HTMLFILE;OPREQ006;   * Quantity
          GOTO      PMSC9999
.
PMSC0900  CALL      SELV0000
          GOTO      PMSC9999
.
PMSC1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PMSC9999
.
PMSC1100  CALL      NXTCLS00
          GOTO      PMSC9999
.
PMSC1200  CALL      PRVCLS00
          GOTO      PMSC9999
.
PMSC1300  CALL      RTAB0000                * Recovery closed table
          GOTO      PMSC9999
.
PMSC1400  MOVE      FILTLOCN,CODE           * Location filter
          MOVE      "YD",CATEGORY
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC1500  
.         CALL      GETAN000
.         WRITE     HTMLFILE;ANAENAME;
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,PMSC9999
.
          MOVE      OPSEANAE,DOCTCODE
          CALL      DOCDET00
          GOTO      PMSC9999
.
PMSC1600  UNPACK    MDATE000,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC1700  WRITE     HTMLFILE;INCTY000;
          GOTO      PMSC9999
.
PMSC1800  PACK      PROCE000,PROCE000,SP70
          MATCH     SP70,PROCE000
          GOTO      PMSC1820 IF EQUAL
.
          WRITE     HTMLFILE;PROCE000;
          GOTO      PMSC9999
.
PMSC1820  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPPROC;
          GOTO      PMSC9999
.
PMSC1900  PACK      UNIQU000,UNIQU000,SP70
          MATCH     SP70,UNIQU000
          GOTO      PMSC1920 IF EQUAL
.
          WRITE     HTMLFILE;UNIQU000;
          GOTO      PMSC9999
.
PMSC1920  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPUNIQ;
          GOTO      PMSC9999
.
PMSC2000  MOVE      ONE,SHOWEDIT            * Show the edit icon
          CALL      REQTAC00
          GOTO      PMSC9999
.
PMSC2100  WRITE     HTMLFILE;CASEKEYS;
          GOTO      PMSC9999
.
PMSC2200  WRITE     HTMLFILE;UNIQUEKY;
          GOTO      PMSC9999
.
PMSC2300  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      PMSC9999
.
PMSC2400  CALL      FAVTAC00
          GOTO      PMSC9999
.
PMSC2500  MOVE      SELCOCCG,CODE
          MOVE      "w0",CATEGORY
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC2600  
.         MOVE      SELCFAVG,CODE
.         MOVE      "w4",CATEGORY
.         CALL      CODITM00
.         GOTO      PMSC9999
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PMSC9999
.
          PACK      SELCFAVG,SELCFAVG,SP70
          MOVE      SP70,USERINDC
.
          MATCH     SP70,WBSEOCG
          GOTO      PMSC2650 IF NOT EQUAL
.
          MOVE      SP70,USERINDC
          MOVE      SP70,SAVEFAVG
.
          IF        IBCNMHOS=ONE
            PACK      KEY31,WBSEHOSP,WBSEUID,SP70
          ELSE
            PACK      KEY31,SP3,WBSEUID,SP70
          ENDIF
.
          CALL      RSPMUFI3
PMSC2610  CALL      RKPMUFI3
          BRANCH    OVRCD,PMSC2650
.
          IF        IBCNMHOS=ONE
            MATCH     WBSEHOSP,PMUFHOSP
            GOTO      PMSC2650 IF NOT EQUAL
          ENDIF 
.
          MATCH     WBSEUID,PMUFUSER
          GOTO      PMSC2650 IF NOT EQUAL
.
          MOVE      "1",USERINDC         
.
          MATCH     SAVEFAVG,PMUFFAVG
          GOTO      PMSC2610 IF EQUAL
.
          MOVE      "w4",CATEGORY
          MOVE      PMUFFAVG,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PMSC2610
.
          PACK      KEY60,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,TCINDC22,TCINDC23,TCINDC24,TCINDC25:
                          TCINDC26,TCINDC27,TCINDC28,TCINDC29,TCINDC30:
                          TCINDC31,TCINDC32,TCINDC33,TCINDC34,TCINDC35:
                          TCINDC36,TCINDC37,TCINDC38,TCINDC39,TCINDC40:
                          TCINDC41
.
          MATCH     SELCFAVG,ACODE
          IF        @EQUAL
            IF        CATACTIV=1
              MATCH     "I",PTCOACTV               * Display active only
              GOTO      PMSC2610 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#" selected>":
                               TDESC,"</option>"
          ELSE
            IF        CATACTIV<>2
              MATCH     "I",PTCOACTV
              GOTO      PMSC2610 IF EQUAL
            ENDIF
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,PMSC2610
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#">",TDESC:
                               "</option>"
          ENDIF
.
          MOVE      PMUFFAVG,SAVEFAVG
.
          GOTO      PMSC2610
.
PMSC2650  MATCH     "1",USERINDC
          GOTO      PMSC9999 IF EQUAL
.
          MATCH     SP70,WBSEOCG
          GOTO      PMSC9999 IF EQUAL
          GOTO      PMSC9999 IF EOS
.
          MOVE      SP70,SAVEFAVG 
.
          IF        IBCNMHOS=ONE
            PACK      KEY31,WBSEHOSP,WBSEOCG,SP70
          ELSE
            PACK      KEY31,SP3,WBSEOCG,SP70
          ENDIF
.
          CALL      RSPMUFI2
PMSC2660  CALL      RKPMUFI2
          BRANCH    OVRCD,PMSC9999 
.
          IF        IBCNMHOS=ONE
            MATCH     WBSEHOSP,PMUFHOSP
            GOTO      PMSC9999 IF NOT EQUAL
          ENDIF 
.
          MATCH     WBSEOCG,PMUFUOGR
          GOTO      PMSC9999 IF NOT EQUAL
.
.         MATCH     SP70,PMUFUSER
.         IF        !@EQUAL
.           MATCH     PMUFUSER,WBSEUID
.           GOTO      PMSC2660 IF NOT EQUAL
.         ENDIF
.
          MATCH     SAVEFAVG,PMUFFAVG
          GOTO      PMSC2660 IF EQUAL
.
          MOVE      "w4",CATEGORY
          MOVE      PMUFFAVG,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PMSC2660
.
          PACK      KEY60,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,TCINDC22,TCINDC23,TCINDC24,TCINDC25:
                          TCINDC26,TCINDC27,TCINDC28,TCINDC29,TCINDC30:
                          TCINDC31,TCINDC32,TCINDC33,TCINDC34,TCINDC35:
                          TCINDC36,TCINDC37,TCINDC38,TCINDC39,TCINDC40:
                          TCINDC41
.
          MATCH     SELCFAVG,ACODE
          IF        @EQUAL
            IF        CATACTIV=1
              MATCH     "I",PTCOACTV               * Display active only
              GOTO      PMSC2660 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#" selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     SP70,SELCFAVG
            IF        @EQUAL
              MATCH     "Yes",PMUFFAVD    
              GOTO      PMSC2680 IF NOT EQUAL.
.
PMSC2661      MATCH     "1",DEFAINDC
              GOTO      PMSC2680 IF EQUAL
.
              IF        CATACTIV=1
                MATCH     "I",PTCOACTV               * Display active only
                GOTO      PMSC2660 IF EQUAL
              ENDIF
.
              WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#" selected>":
                                 TDESC,"</option>"
.
              MOVE      PMUFFAVG,SELCFAVG
.
            ELSE
PMSC2680      IF        CATACTIV<>2
                MATCH     "I",PTCOACTV
                GOTO      PMSC2660 IF EQUAL
              ENDIF
.
              IF        IBCNMHOS=1
                MATCH    "1",PTCDHOSS
                IF       @EQUAL
                  PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                  CALL     RDMLCOD1
                  BRANCH   OVRCD,PMSC2660
                ENDIF
              ENDIF
.  
              MATCH     "1",DEFAINDC
              GOTO      PMSC2685 IF EQUAL
.
              CALL      UIW4DF00
              IF        EXIT=1
               WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#" selected>":
                                  TDESC,"</option>"
              ELSE
PMSC2685       WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#">",TDESC:
                                  "</option>"
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PMUFFAVG,SAVEFAVG
.
          GOTO      PMSC2660
.
PMSC2700  WRITE     HTMLFILE;OPDACLIN;
          GOTO      PMSC9999
.
PMSC2800  PACK      PROCDESC,PROCDESC,SP70
          MATCH     SP70,PROCDESC
          GOTO      PMSC2820 IF EQUAL
.
          WRITE     HTMLFILE;PROCDESC;
          GOTO      PMSC9999
.
PMSC2820  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPPDES;
          GOTO      PMSC9999
.
PMSC2900  MOVE      ZERO,SHOWEDIT            * Don't show the edit icon
          CALL      REQTAC00
          GOTO      PMSC9999
.
PMSC3000  WRITE     HTMLFILE;HOSPCODE;
          GOTO      PMSC9999
.
PMSC9999  RETURN
+
.*****************************************************************************
.                    Table of Preferences for this booking
.*****************************************************************************
PRFTAB00  MATCH     SP70,OPDAUNIQ
          GOTO      PRFTAB99 IF EQUAL
.
          MOVE      ZERO,FIELDCNT
.
.         Display Preference (oprdphaf)records from oprprfaf
.
PRFTAB20  PACK      KEY32,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPRF1
PRFTAB25  CALL      RKOPPRF1
          BRANCH    OVRCD,PRFTAB40
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      PRFTAB40 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPRTEAM
          GOTO      PRFTAB40 IF NOT EQUAL
.
          MATCH     SP70,OPPRDCOD
          GOTO      PRFTAB25 IF EQUAL
.
          MATCH     SP70,OPPRPREF
          GOTO      PRFTAB25 IF EQUAL
.
          MOVE      "Invalid Code",PREFDESC
.
          MOVE      OPPRPREF,DIM9       
          PACK      KEY18,OPPRDCOD,DIM9,OPDAHOSP,SP70
          CALL      RDOPDPH1
PRFTAB30  IF        OVRCD=0
            MOVE      OPDHDESC,PREFDESC
          ENDIF
.
          PACK      OPPRPREF,OPPRPREF,SP70
          PACK      SAVKEY33,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,ONE,SP70
.
          ADD       ONE,FIELDCNT
          MOVE      FIELDCNT,DIM3
          REP       " 0",DIM3
.
          WRITE     HTMLFILE;"<tr><td>",OPPRPREF,"</td>":
                             "<td>",PREFDESC,"</td>":
                             "<td align=center><input type=hidden":
                             " name=prkey",DIM3," value=#"",SAVKEY33,"#">"
.
          IF        OPPRPQTY=ZERO
            WRITE     HTMLFILE;"<input type=text name=prqty",DIM3:
                               " class=#"Readonly Integer#" size=4":
                               " maxlength=3 readonly tabindex=-1></td>":
                               "<td align=center><input type=checkbox":
                               " name=prflg",DIM3," value=1 onclick=#"":
                               "checkPref(prqty",DIM3,",this);#"></td>"
          ELSE
            WRITE     HTMLFILE;"<input type=text name=prqty",DIM3:
                             " class=#"Mandatory Integer#" size=4":
                             " maxlength=3 value=#"",OPPRPQTY,"#"></td>":
                             "<td align=center><input type=checkbox":
                             " name=prflg",DIM3," value=1 onclick=#"":
                             "checkPref(prqty",DIM3,",this);#" checked></td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td align=center>":
                             "<a href='javascript:showDocPref(#"",OPPRDCOD:
                             "#",#"",OPPRPREF,"#",#"",OPDAHOSP:
                             "#");'><img src=../images/MaintenanceIcon.gif":
                             " class=Icon hspace=4 border=0 align=absmiddle>":
                             "</a></td>":
                             "</tr>"
.
          GOTO      PRFTAB25
.
.         Display Tray Preference (oprtryaf) records from oprprfaf
.
PRFTAB40  PACK      KEY32,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPRF1
PRFTAB45  CALL      RKOPPRF1
          BRANCH    OVRCD,PRFTAB99
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      PRFTAB99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPRTEAM
          GOTO      PRFTAB99 IF NOT EQUAL
.
          MATCH     SP70,OPPRDCOD
          GOTO      PRFTAB45 IF NOT EQUAL
.
          MOVE      "Invalid Code",PREFDESC
.
          PACK      KEY18,OPPRPREF,OPDAHOSP,SP70
          CALL      RDOPTRA1
          IF        OVRCD=0
            MOVE      OPTHDESC,PREFDESC
          ENDIF
.
          ADD       ONE,FIELDCNT
          MOVE      FIELDCNT,DIM3
          REP       " 0",DIM3
.
          PACK      OPPRPREF,OPPRPREF,SP70
          PACK      SAVKEY33,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,ZERO,SP70
.
          WRITE     HTMLFILE;"<tr><td>",OPPRPREF,"</td>":
                             "<td>",PREFDESC,"</td>":
                             "<td align=center><input type=hidden":
                             " name=prkey",DIM3," value=#"",SAVKEY33,"#">"
.
          IF        OPPRPQTY=ZERO
            WRITE     HTMLFILE;"<input type=text name=prqty",DIM3:
                               " class=#"Readonly Integer#" size=4":
                               " maxlength=3 readonly tabindex=-1></td>":
                               "<td align=center><input type=checkbox":
                               " name=prflg",DIM3," value=1 onclick=#"":
                               "checkPref(prqty",DIM3,",this);#"></td>"
          ELSE
            WRITE     HTMLFILE;"<input type=text name=prqty",DIM3:
                             " class=#"Mandatory Integer#" size=4":
                             " maxlength=3 value=#"",OPPRPQTY,"#"></td>":
                             "<td align=center><input type=checkbox":
                             " name=prflg",DIM3," value=1 onclick=#"":
                             "checkPref(prqty",DIM3,",this);#" checked></td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td align=center>":
                             "<a href='javascript:showTray(#"",OPPRPREF:
                             "#",#"",OPDAHOSP,"#");":
                             "'><img src='../images/MaintenanceIcon.gif'":
                             " class=Icon>":
                             "</a></td>":
                             "</tr>"
.
          GOTO      PRFTAB45
.
PRFTAB99  RETURN
.
.*****************************************************************************
.                    Display Operating Surgeon           
.*****************************************************************************
FNDSRG00  MATCH     SP70,OPDAUNIQ
          GOTO      FNDSRG99 IF EQUAL
.
          MOVE      ZERO,OPTSSIND    * Operating Surgeon
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSSIND,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,FNDSRG10
.
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      FNDSRG10 IF NOT EQUAL
          MATCH     TEAMNUMB,OPTSTMNO
          GOTO      FNDSRG10 IF NOT EQUAL
          COMPARE   ZERO,OPTSSIND
          GOTO      FNDSRG10 IF NOT EQUAL
          MOVE      OPTSSCDE,DOCTCODE
          GOTO      FNDSRG20
.
FNDSRG10  MOVE      OPDACLIN,DOCTCODE
          IF        OPCNCLSU=0
            PACK      KEY6,OPDACLIN,SP70            * clinic
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,DOCTCODE
            ENDIF
          ENDIF
.
FNDSRG20  CALL      DOCDET00
.
FNDSRG99  RETURN
+
.*****************************************************************************
.                    Get Preference Description           
.*****************************************************************************
PRFDSC00  MOVE      SP70,PREFDESC
          MOVE      SP70,PREFTYPE 
          MOVE      ZERO,INVLDITM
.
          BRANCH    SKIPDPRF,PRFDSC10
.
          STRIP     OPPRPREF
          MOVELPTR  OPPRPREF,F2
          IF        F2<TEN
            PACK      DIM9,OPPRPREF,SP70
            PACK      KEY18,OPTSSCDE,DIM9,OPDAHOSP,SP70
            CALL      RDOPDPH1
            IF        OVRCD=0        
              MOVE      OPDHDESC,PREFDESC
              MOVE      THREE,PREFTYPE   * Comments
              MOVE      ONE,INVLDITM
              GOTO      PRFDSC99
            ENDIF
          ENDIF
.
PRFDSC10  PACK      DIM15,OPPRPREF,SP70
          PACK      KEY18,DIM15,OPDAHOSP,SP70
          CALL      RDOPTRA1
          IF        OVRCD=0
            MOVE      OPTHDESC,PREFDESC
            MOVE      ZERO,PREFTYPE      * Tray
            GOTO      PRFDSC99
          ENDIF
.
          PACK      KEY15,OPPRPREF,SP70
          CALL      RDOPITE1
          IF        OVRCD=0
            MOVE      OPITDESC,PREFDESC
            MOVE      ONE,PREFTYPE       * instrument/item
            GOTO      PRFDSC20
          ENDIF
.
          PACK      DIM15,OPPRPREF,SP70
          PACK      KEY18,DIM15,OPDAHOSP,SP70
          CALL      RDOPEQP1
          IF        OVRCD=0
            MOVE      OPEQDESC,PREFDESC
            MOVE      TWO,PREFTYPE       * Equipment
            GOTO      PRFDSC99
          ENDIF
.
          MOVE      "Invalid Code",PREFDESC
.
PRFDSC20  MATCH     "1",ITEMTYPE
          GOTO      PRFDSC99 IF NOT EQUAL    * Not an item/equipment
.
          MOVE      ONE,PREFTYPE
          MATCH     "1",OPCNPTMC
          GOTO      PRFDSC99 IF NOT EQUAL
.
          MOVE      OPPRPREF,DIM9
          CALL      VDAP0000
          BRANCH    EXIT,PRFDSC99
.
          PACK      KEY9,OPPRPREF,SP70
          IF        CFEETYP=FIVE
            CALL      NZPMSC00              * validate item against nzpmchaf
            BRANCH    INVLDITM,PRFDSC99
            IF        NZMCCHGT=1 & NZMCPATP=0
              CALL      NZPAC000                 * Get the item total
            ENDIF
          ELSE
            MOVE      MDATE000,KEY8
            CALL      PTMC0000              * validate item against patmchgf
            BRANCH    INVLDITM,PRFDSC99
          ENDIF
.
          MOVE      CHRITMDS,PREFDESC
          GOTO      PRFDSC99
.
PRFDSC99  RETURN
+
.------------------------------------------------------------
.         Get item amount
.------------------------------------------------------------
ITAM0000  MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      SP70,PTMCGSTA
          MOVE      ZERO,PTMCGSTC
          PACK      KEY9,TEMPITEM,SP70
          IF        CFEETYP=FIVE
            CALL      NZPMSC00              * validate item against nzpmchaf
            BRANCH    INVLDITM,ITAM9999
            IF        NZMCCHGT=1 & NZMCPATP=0
              CALL      NZPAC000                 * Get the item total
              BRANCH    INVLDITM,ITAM9000
            ENDIF
          ELSE
            MOVE      MDATE000,KEY8
            CALL      PTMC0000              * validate item against patmchgf
            BRANCH    INVLDITM,ITAM9000
          ENDIF
          GOTO      ITAM9999
.
ITAM9000  MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      SP70,PTMCGSTC
          MOVE      ZERO,PTMCGSTA
ITAM9999  RETURN
+
.------------------------------------------------------------
.      Get the total item amount for the content of Pack item
.------------------------------------------------------------
NZPAC000  PACK      KEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                          NZMCEFDT,SP70
          PACK      SAVKEY37,KEY37,SP70
          MOVE      ZERO,PPACKITM
          MOVE      ZERO,FPACKITM
          PACK      KEY90,CHRITMDS,SP70,SP70
.
          PACK      KEY40,KEY37,SP70
          CALL      RSNZMXC1
NZPAC100  CALL      RKNZMXC1
          BRANCH    OVRCD,NZPAC800
.
          PACK      DIM37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                              NZMXEFDT,SP70
.
          MATCH     DIM37,SAVKEY37
          GOTO      NZPAC800 IF NOT EQUAL
.
          PACK      MCHARGE,NZMXITMN,SP70       * item code of pack item
          MOVE      MCHARGE,KEY9
          CALL      NZPMSC00
          BRANCH    EXIT,NZPAC100               * invalid misc.item
.
          MOVE      NZMXQNTY,FORM4
          MULT      FORM4,NZMCPATP
          MULT      FORM4,NZMCREBP
          ADD       NZMCPATP,PPACKITM
          ADD       NZMCREBP,FPACKITM
          GOTO      NZPAC100
.
NZPAC800  MOVE      SAVKEY37,KEY37
          CALL      RDNZMCH1                 * reposition to Pack item
.
          PACK      CHRITMDS,KEY90,SP70
          MOVE      PPACKITM,NZMCPATP
          MOVE      FPACKITM,NZMCREBP
          MOVE      PPACKITM,MPATPOR
          MOVE      FPACKITM,MHFPOR
          MOVE      MPATPOR,QIAMT
          ADD       MHFPOR,QIAMT
.
NZPAC999  RETURN
+
.*****************************************************************************
.                    Table of Requisitions for this booking
.*****************************************************************************
REQTAB00  MATCH     SP70,OPDAUNIQ
          GOTO      REQTAB99 IF EQUAL
.
          MOVE      ZERO,OPTSSIND    * Operating Surgeon
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSSIND,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,REQTAB10
.
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      REQTAB10 IF NOT EQUAL
          MATCH     TEAMNUMB,OPTSTMNO
          GOTO      REQTAB10 IF NOT EQUAL
          COMPARE   ZERO,OPTSSIND
          GOTO      REQTAB10 IF NOT EQUAL
.
          GOTO      REQTAB20
.
REQTAB10  MOVE      OPDACLIN,OPTSSCDE
.
.         Display preferences that don't exist on requisition
.
REQTAB20  CALL      SHWPRF00          
.
.         Display All requisitions
.
          MOVE      OPDACLIN,OPTSSCDE
.
          CALL      SHWREQ00
.
REQTAB99  RETURN
+
.*****************************************************************************
.         Display All requisitions
.*****************************************************************************
SHWREQ00  CALL      CRTMP000
.
          MOVE      ZERO,FORM3
          MOVE      ZERO,SHOWHEAD
          WRITE     HTMLFILE;"<tr><td><b>Requisitions</b></td></tr>":
                             "<tr><td><table cellspacing=0 cellpadding=1":
                             " width=95% border=1>":
                             "<tr><td width=15% class=HeadingCell>":
                             "Code / Line No.</td>":
                             "<td width=35% class=HeadingCell>":
                             "Description</td>":
                             "<td width=10% class=HeadingCell>Type</td>":
                             "<td width=15% class=HeadingCell>Class</td>":
                             "<td width=10% class=HeadingCell align=center>":
                             "Quantity</td>":
                             "<td width=10% class=HeadingCell align=center>":
                             "Content</td>":
                             "</tr>"
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,OPTSSCDE,SP70
          CALL      RSOPREQ1
SHWREQ10  CALL      RKOPREQ1
          BRANCH    OVRCD,SHWREQ90
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      SHWREQ90 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      SHWREQ90 IF NOT EQUAL
          MATCH     OPTSSCDE,OPRQDCOD
          GOTO      SHWREQ90 IF NOT EQUAL
.
          MOVE      OPRQTYPE,ITEMTYPE
          MOVE      OPRQITEM,OPPRPREF
          MOVE      ONE,SKIPDPRF
          MOVE      OPDADATE,MDATE000
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,CDATE
          CALL      PRFDSC00
.
          PACK      KEY5,ANSO,ANSG,OPRQCLSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Class",TDESC
          ENDIF
.
          PACK      SAVKEY36,OPRQUNIQ,OPRQTEAM,OPRQDCOD,OPRQCLSS,OPRQTYPE:
                             OPRQITEM,SP70
.
          MOVE      ONE,SHOWHEAD
.
          MOVE      "Unknown",KEY9
          MATCH     "0",OPRQTYPE
          IF        @EQUAL
            MOVE      "Tray",KEY9
          ENDIF
          MATCH     "1",OPRQTYPE
          IF        @EQUAL
            MOVE      "Item",KEY9
          ENDIF
          MATCH     "2",OPRQTYPE
          IF        @EQUAL
            MOVE      "Equipment",KEY9
          ENDIF
.
          MATCH     "3",OPRQTYPE
          IF        @EQUAL
            CALL      SHWCOM00
            GOTO      SHWREQ10
          ENDIF 
.
          MOVE      TCFORM6,TEMPASSC
          RJUSTIFY  TEMPASSC
          MOVE      OPRQTYPE,TEMPTYPE
          MOVE      SAVKEY36,TEMPKY36
          MOVE      OPRQITEM,TEMPITEM
          MOVE      PREFDESC,TEMPPDSC
          MOVE      KEY9,TEMPKEY9
          MOVE      TDESC,TEMPTDSC
          MOVE      OPRQAMNT,TEMPAMNT
          RJUSTIFY  TEMPAMNT
          ADD       ONE,FORM3
          MOVE      FORM3,TEMPCONT
          MOVE      OPRQDCOD,TEMPDOCT
          MOVE      OPRQCLSS,TEMPCLSS
          MOVE      INVLDITM,TEMPVALD
.
          PACK      KEY10,TEMPASSC,TEMPTYPE,TEMPCONT,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
          GOTO      SHWREQ10
.
SHWREQ90  CALL      SHWANA00
          CALL      SHWTRY00
.
          PACK      KEY10,SP70
          CALL      RSTMPRE1
SHWREQ91  CALL      RKTMPRE1
          BRANCH    OVRCD,SHWREQ98
.
          MOVE      "OG",CATEGORY
          MOVE      TEMPCLSS,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"<tr><td nowrap valign=middle>":
                             "<a href='javascript:UpdateReq(#"",TEMPKY36:
                             "#",#"",OPDAHOSP,"#");":
                             "'><img src=../images/EditIcon.gif class=Icon":
                             "></a>&nbsp;":
                             TEMPITEM,"</td>":
                             "<td>",TEMPPDSC,"</td>":
                             "<td>",TEMPKEY9,"</td>":
                             "<td>",PTCDLDES,"</td>":
                             "<td align=center>",TEMPAMNT,"</td>"
 
          MATCH     "0",TEMPTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center>":
                               "<a href='javascript:showTray(#"",TEMPITEM:
                               "#",#"",OPDAHOSP,"#");":
                               "'><img src=../images/MaintenanceIcon.gif":
                               " class=Icon>":
                               "</a></td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "</tr>"
          ENDIF
.
          GOTO      SHWREQ91          
.
SHWREQ98  IF        SHOWHEAD=0
            WRITE     HTMLFILE;"<tr><td colspan=6 align=center":
                               " bgcolor=#FF0000><b>No Requisitions Found</b>":
                               "</td></tr>"
          ENDIF
          WRITE     HTMLFILE;"</table></td></tr>"
.
SHWREQ99  CALL      KTMP0000
          RETURN
+
.*****************************************************************************
.         Show preference not already requisitioned
.*****************************************************************************
SHWPRF00  CALL      CRTM10000
.
          MOVE      ZERO,SHOWHEAD
          MOVE      ZERO,NUMDOCPR
          PACK      KEY32,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPRF1
SHWPRF10  CALL      RKOPPRF1
          BRANCH    OVRCD,SHWPRF27
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      SHWPRF27 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPRTEAM
          GOTO      SHWPRF27 IF NOT EQUAL
.
          MATCH     SP70,OPPRDCOD
          GOTO      SHWPRF10 IF EQUAL
.
          COMPARE   ZERO,OPPRPQTY
          GOTO      SHWPRF10 IF EQUAL
.
          PACK      DIM9,OPPRPREF,SP70
          PACK      KEY18,OPPRDCOD,DIM9,OPDAHOSP,SP70
          CALL      RDOPDPH1
          BRANCH    OVRCD,SHWPRF10
.
          PACK      KEY37,OPDHCODE,OPDHPREF,SP70
          CALL      RSOPDPF1
SHWPRF20  CALL      RKOPDPF1
          BRANCH    OVRCD,SHWPRF24
.
          MATCH     OPDHCODE,OPDFCODE
          GOTO      SHWPRF24 IF NOT EQUAL
          MATCH     OPDHPREF,OPDFPREF
          GOTO      SHWPRF24 IF NOT EQUAL
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,OPDFCODE,OPDFCLSS,OPDFTYPE:
                          OPDFITEM,SP70
          CALL      RDOPREQ1
          IF        OVRCD=0
            GOTO      SHWPRF20
          ENDIF
.
          MOVE      "OG",CATEGORY           * Type Of Implant
          MOVE      OPDFCLSS,CODE
          CALL      GETCOD00         
.
          MOVE      TCFORM6,TEMPASS1
.
          PACK      TEMPKY32,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,SP70
          PACK      TEMPKY34,OPDFCODE,OPDFPREF,OPDFCLSS,OPDFTYPE,OPDFITEM,SP70
.
          PACK      KEY72,TEMPASS1,TEMPKY32,TEMPKY34,SP70
          CALL      RATMPPR1
          IF        OVRCD=1
            CALL      WRTMPPR1
          ENDIF
.
          GOTO     SHWPRF20
.
SHWPRF24  GOTO      SHWPRF10 
.
SHWPRF27  PACK      KEY72,SP70
          CALL      RSTMPPR1
SHWPRF28  CALL      RKTMPPR1
          BRANCH    OVRCD,SHWPRF40
.
          MOVE      TEMPKY32,KEY32
          CALL      RDOPPRF1 
          BRANCH    OVRCD,SHWPRF28
.
          PACK      DIM9,OPPRPREF,SP70
          PACK      KEY18,OPPRDCOD,DIM9,OPDAHOSP,SP70
          CALL      RDOPDPH1
          BRANCH    OVRCD,SHWPRF28
.
          PACK      KEY37,TEMPKY34,SP70
          CALL      RDOPDPF1
          BRANCH    OVRCD,SHWPRF28
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,OPDFCODE,OPDFCLSS,OPDFTYPE:
                          OPDFITEM,SP70
          CALL      RDOPREQ1
          IF        OVRCD=0
            GOTO      SHWPRF28
          ENDIF
.
          IF        SHOWHEAD=ZERO
            WRITE     HTMLFILE;"<tr><td><b>Preferences to be Included</b>":
                               "</td></tr>":
                               "<tr><td><table cellspacing=0 cellpadding=1":
                               " width=100% border=1>":
                               "<tr><td width=15% class=HeadingCell>Code</td>":
                               "<td width=35% class=HeadingCell>":
                               "Description</td>":
                               "<td width=10% class=HeadingCell>Type</td>":
                               "<td width=15% class=HeadingCell>Class</td>":
                               "<td width=10% class=HeadingCell align=center>":
                               "Quantity</td>":
                               "<td width=10% class=HeadingCell align=center>":
                               "Content</td>":
                               "<td width=5% class=HeadingCell align=center>":
                               "&nbsp;</td>":
                               "</tr>"
            MOVE      ONE,SHOWHEAD
          ENDIF
.
          MOVE      OPDFTYPE,ITEMTYPE
          MOVE      OPDFITEM,OPPRPREF
          MOVE      ONE,SKIPDPRF
          MOVE      OPDADATE,MDATE000
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,CDATE
          CALL      PRFDSC00
.
          MOVE      "OG",CATEGORY           * Type Of Implant
          MOVE      OPDFCLSS,CODE
          CALL      GETCOD00
.
          MULT      OPPRPQTY,OPDFQTY
.
          MOVE      "Unknown",KEY9
          MATCH     "0",OPDFTYPE
          IF        @EQUAL
            MOVE      "Tray",KEY9
          ENDIF
          MATCH     "1",OPDFTYPE
          IF        @EQUAL
            MOVE      "Item",KEY9
          ENDIF
          MATCH     "2",OPDFTYPE
          IF        @EQUAL
            MOVE      "Equipment",KEY9
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",OPDFITEM,"</td>":
                             "<td>",PREFDESC,"</td>":
                             "<td>",KEY9,"</td>":
                             "<td>",PTCDLDES,"</td>":
                             "<td align=center>",OPDFQTY,"</td>"
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>"
.
          ADD       ONE,NUMDOCPR
          MOVE      NUMDOCPR,KEY3
          REP       " 0",KEY3
          PACK      KEY28,OPDFCODE,OPDFCLSS,OPDFTYPE,OPDFITEM,OPDFQTY,SP70
          WRITE     HTMLFILE;"<td align=center><input type=button value='Add'":
                             " class=smallbutton onclick='AddPref(#"":
                             OPDFTYPE,"#",#"",OPDFITEM,"#",#"",OPDFCLSS:
                             "#",#"",OPDFQTY,"#",#"",OPDFCODE,"#");'></td>":
                             "<input type=hidden name=addrq",KEY3:
                             " value=#"",KEY28,"#">":
                             "</tr>"
.
.         GOTO      SHWPRF29
.
SHWPRF30  GOTO      SHWPRF28
.
SHWPRF40  CALL      KTM10000
.
          PACK      KEY32,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPRF1
SHWPRF45  CALL      RKOPPRF1
          BRANCH    OVRCD,SHWPRF90
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      SHWPRF90 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPRTEAM
          GOTO      SHWPRF90 IF NOT EQUAL
.
          MATCH     SP70,OPPRDCOD
          GOTO      SHWPRF45 IF NOT EQUAL
.
          COMPARE   ZERO,OPPRPQTY
          GOTO      SHWPRF45 IF EQUAL
.
          PACK      KEY18,OPPRPREF,OPDAHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,SHWPRF45
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,SP6,OPPRPREF,SP70
          CALL      RSOPREQ2
SHWPRF48  CALL      RKOPREQ2
          BRANCH    OVRCD,SHWPRF50
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      SHWPRF50 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      SHWPRF50 IF NOT EQUAL
          MATCH     SP70,OPRQDCOD
          GOTO      SHWPRF50 IF NOT EQUAL
          MATCH     OPPRPREF,OPRQITEM
          GOTO      SHWPRF48 IF NOT EQUAL
          MATCH     "0",OPRQTYPE
          GOTO      SHWPRF48 IF NOT EQUAL

.
          GOTO      SHWPRF45
.
SHWPRF50  IF        SHOWHEAD=ZERO
            WRITE     HTMLFILE;"<tr><td><b>Preferences to be Included</b>":
                               "</td></tr>":
                               "<tr><td><table cellspacing=0 cellpadding=1":
                               " width=100% border=1>":
                               "<tr><td width=15% class=HeadingCell>Code</td>":
                               "<td width=35% class=HeadingCell>":
                               "Description</td>":
                               "<td width=10% class=HeadingCell>Type</td>":
                               "<td width=15% class=HeadingCell>Class</td>":
                               "<td width=10% class=HeadingCell align=center>":
                               "Quantity</td>":
                               "<td width=10% class=HeadingCell align=center>":
                               "Content</td>":
                               "<td width=5% class=HeadingCell align=center>":
                               "&nbsp;</td>":
                               "</tr>"
            MOVE      ONE,SHOWHEAD
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",OPPRPREF,"</td>":
                             "<td>",OPTHDESC,"</td>":
                             "<td>Tray</td>":
                             "<td>&nbsp;</td>":
                             "<td align=center>",OPPRPQTY,"</td>"
.
          WRITE     HTMLFILE;"<td align=center>":
                             "<a href='javascript:showTray(#"",OPPRPREF:
                             "#",#"",OPDAHOSP,"#");":
                             "'><img src='../images/MaintenanceIcon.gif'":
                             " class=Icon>":
                             "</a></td>"
.
          WRITE     HTMLFILE;"<td align=center><input type=button value='Add'":
                             " class=smallbutton onclick='AddPref(#"":
                             ZERO,"#",#"",OPPRPREF,"#",#"",SP10:
                             "#",#"",OPPRPQTY,"#",#"",OPPRDCOD,"#");'></td>":
                             "</tr>"
.
          GOTO      SHWPRF45
.
SHWPRF90  IF        SHOWHEAD=1
            WRITE     HTMLFILE;"</table></td></tr>"
            IF NUMDOCPR>0
              WRITE     HTMLFILE;"<tr><td align=center><br>":
                                 "<input type=button value='Add All Dr Pref'":
                                 " class=button onclick='AddAllPref();'>":
                                 "</td></tr>"
            ENDIF
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td></tr>"
          ENDIF
.
SHWPRF99  RETURN
+
.*****************************************************************************
.                    Rountine For Input Expensive Items   
.*****************************************************************************
OPIE0000  BRANCH    FLDITMNO,OPIE0100
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPIE9999
.
OPIE0100  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      OPIE9999
.
OPIE9999  RETURN                                         
.******************************************************************************
.                     INPUT  CMBS  ITEMS
.******************************************************************************
OPIC0000  BRANCH    FLDITMNO,OPIC0100,OPIC0200,OPIC0300,OPIC0400,OPIC0500:
                             OPIC0600,OPIC0700,OPIC0800,OPIC0900,OPIC1000
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPIC9999
.                                        
OPIC0100  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      OPIC9999
.
OPIC0200  WRITE     HTMLFILE;MBSCHRGD;
          GOTO      OPIC9999
.
OPIC0300  WRITE     HTMLFILE;MBSFCODE;
          GOTO      OPIC9999
.
OPIC0400  WRITE     HTMLFILE;OPDAPROV;
          GOTO      OPIC9999
.
OPIC0500  WRITE     HTMLFILE;ONCOLOGY;
          GOTO      OPIC9999
.
OPIC0600  CALL      GSTA0000                 * GST Applicable
          GOTO      OPIC9999
.
OPIC0700  CALL      KYGC0000                 * GST code
          GOTO      OPIC9999
.
OPIC0800  WRITE     HTMLFILE;BKUNQ001;
          GOTO      OPIC9999
.
OPIC0900  WRITE     HTMLFILE;PMVXMHOS;
          GOTO      OPIC9999
.
OPIC1000  CALL      TITM0000
          WRITE     HTMLFILE;FORM6;
          GOTO      OPIC9999
.
OPIC9999  RETURN
.
.------------------------------------------------------------
. Get number of existing MBS items
.------------------------------------------------------------
TITM0000  MOVE      ZERO,FORM6
          PACK      KEY11,OPDAADMN,SP70
          CALL      RDSMMBS1
TITM1000  CALL      RDKMMBS1
          BRANCH    OVRCD,TITM9999
.
          MATCH     DMMADMN,OPDAADMN         * Same unique number
          GOTO      TITM9999 IF NOT EQUAL
.
          ADD       ONE,FORM6
          GOTO      TITM1000
.
TITM9999  RETURN
+
.------------------------------------------------------------
. GST
.------------------------------------------------------------
GSTA0000  UNPACK   DIM127,D1,KEY1,DIM127
          MOVE     ZERO,F1
          MOVE     KEY1,F1
          BRANCH   F1,GSTA1000,GSTA2000
          WRITE    HTMLFILE;PTGTU001;
          GOTO     GSTA9999
.
GSTA1000  MOVE     "Unknown ",KEY8
          WRITE    HTMLFILE;KEY8;
          GOTO     GSTA9999
.
GSTA2000  WRITE    HTMLFILE;"<option value=2 selected>":
                            "Unknown</option>":
                            "<option value=1>":
                            "Yes</option>":
                            "<option value=0>":
                            "No</option>";
GSTA9999  RETURN
+
.------------------------------------------------------------
.      Keyin GST Code
.------------------------------------------------------------
KYGC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,KYGC1200,KYGC1400
          WRITE     HTMLFILE;PTGTU002;
          GOTO      KYGC9999
.
KYGC1200  PACK      KEY6,PTGTU002
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ELSE
            WRITE     HTMLFILE;PTGTU002;
          ENDIF
          GOTO      KYGC9999
.
.   Display Selection List for GST code
.
KYGC1400  PACK      KEY6,SP70
          CALL      RSIBGS1
KYGC1425  CALL      RKIBGS1
          BRANCH    OVRCD,KYGC9999
.
          MATCH     IBGSCODE,PTGTU002
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      KYGC1425
.
KYGC9999  RETURN
+
.******************************************************************************
.*                  Output Routine for Theatre Details                        *
.******************************************************************************
TDET0000  BRANCH    FLDITMNO,TDET0100,TDET0200,TDET0300,TDET0400,TDET0500:
                             TDET0600,TDET0700,TDET0800,TDET0900,TDET1000:
                             TDET1100,TDET1200,TDET1300,TDET1400,TDET1500:
                             TDET1600,TDET1700,TDET1800,TDET1900,TDET2000:
                             TDET2100,TDET2200,TDET2300,TDET2400,TDET2500:
                             TDET2600,TDET2700,TDET2800,TDET2900,TDET3000:
                             TDET3100,TDET3200,TDET3300,TDET3400,TDET3500:
                             TDET3600,TDET3700,TDET3800,TDET3900,TDET4000:
                             TDET4100,TDET4200,TDET4300,TDET4400,TDET4500:
                             TDET4600,TDET4700,TDET4800,TDET4900,TDET5000:
                             TDET5100,TDET5200,TDET5300,TDET5400,TDET5500:
                             TDET5600,TDET5700,TDET5800,TDET5900,TDET6000:
                             TDET6100,TDET6200,TDET6300,TDET6400,TDET6500:
                             TDET6600,TDET6700,TDET6800,TDET6900
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      TDET9999
.
TDET0100  WRITE     HTMLFILE;OPDATHET;
          GOTO      TDET9999
.
TDET0200  WRITE     HTMLFILE;OPRMDESC;
          GOTO      TDET9999
.
TDET0300  WRITE     HTMLFILE;BKREDEPT;
          GOTO      TDET9999
.
TDET0400  MOVE      BKREDEPT,CODE           * Unit Description
          MOVE      "AC",CATEGORY
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0500  WRITE     HTMLFILE;OPDADES1;
          GOTO      TDET9999
.
TDET0600  MOVE      "Tf",CATEGORY
          PACK      CODE,OPSGUC01,SP70
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0700  MOVE      "Tf",CATEGORY
          PACK      CODE,OPSGUC02,SP70
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0800  MOVE      "Tf",CATEGORY
          PACK      CODE,OPSGUC02,SP70
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0900  MOVE      "Tp",CATEGORY
          PACK      CODE,INFCCONT,SP70
          CALL      CODITM00
          GOTO      TDET9999
.
TDET1000  WRITE     HTMLFILE;OPTSINST;
          GOTO      TDET9999
.
TDET1100  MOVE      SURGCODE,DOCTCODE
          CALL      DOCDET00
          GOTO      TDET9999
.
TDET1200  WRITE     HTMLFILE;SAVKEY01;
          GOTO      TDET9999
.
TDET1300  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      TDET9999
.
TDET1400  WRITE     HTMLFILE;RDIRFLAG;
          GOTO      TDET9999
.
TDET1500
TDET1600
TDET1700  GOTO      TDET9999
.
TDET1800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,TDET1810
          COMPARE   ZERO,OPTSSIND
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=0>":
                               "Operating Surgeon</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=0>Operating Surgeon</option>";
          ENDIF
TDET1810  COMPARE   OPTSSIND,ONE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=1>":
                               "Doctor</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=1>Doctor</option>";
          ENDIF
          COMPARE   OPTSSIND,TWO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=2>Nurse</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=2> Nurse </option>";
          ENDIF
          COMPARE   OPTSSIND,THREE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=3>Other</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=3> Other </option>"
          ENDIF
          GOTO      TDET9999
.
TDET1900  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F2
          MOVE      ANS,F2
          BRANCH    F2,TDET1950
          MOVE      SP70,KEY30
          MOVE      SP70,SURGNAME
          PACK      KEY6,OPTSSCDE,SP70
          IF        OPTSSIND=0|OPTSSIND=1
            CALL      RDDOCT1
            BRANCH    OVRCD,TDET1940
            MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
          ENDIF
          IF        OPTSSIND=2
            MATCH     "1",OPCNURSE        * Use oprnuraf/pmshcpaf for OT Nurse?
            IF        @EQUAL
              PACK      KEY10,OPTSSCDE,SP70
              CALL      RDPMHCP1               * Use pmshcpaf for OT Nurse
              BRANCH    OVRCD,TDET1940
              MOVE      PMHCSNAM,FMTSNAME
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      SP70,FMTTITLE
            ELSE
              CALL      RDOPNUR1               * Use oprnuraf for OT Nurse
              BRANCH    OVRCD,TDET1940
              MOVE      OPNRSNAM,FMTSNAME  
              MOVE      OPNRGNAM,FMTGNAME
              MOVE      SP70,FMTTITLE
            ENDIF
          ENDIF
          IF        OPTSSIND=3
            PACK      KEY10,OPTSSCDE,SP70
            CALL      RDPMHCP1
            BRANCH    OVRCD,TDET1940
            MOVE      PMHCSNAM,FMTSNAME
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCTITL,FMTTITLE
          ENDIF
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME
          GOTO      TDET1940
TDET1940  WRITE     HTMLFILE;KEY30;
          GOTO      TDET9999
TDET1950  WRITE     HTMLFILE;OPTSSCDE;
          GOTO      TDET9999
.
TDET2000  UNPACK    OPTSSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TDET9999
.
TDET2100  WRITE     HTMLFILE;OPTSSTIM;
          GOTO      TDET9999
.
TDET2200  MOVE      ZERO,F2
          MOVE      SP70,MTHNAM3
          UNPACK    OPTSEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TDET9999
.
TDET2300  WRITE     HTMLFILE;OPTSETIM;
          GOTO      TDET9999
.
TDET2400  WRITE     HTMLFILE;OPTSSLEV;
          GOTO      TDET9999
.
TDET2500  MOVE      "OS",CATEGORY
          MOVE      SURGLEVL,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET2600  WRITE     HTMLFILE;OPTSSTYP;
          GOTO      TDET9999
.
TDET2700  MOVE      "OF",CATEGORY
          MOVE      OPTSSTYP,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET2800  CALL      TOUR0000                * output tourniquet table
          GOTO      TDET9999
.
TDET2900  CALL      STAF0000                * output staff members table
          GOTO      TDET9999
.
TDET3000  PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
TDET3050  CALL      RKOPSRG1
          BRANCH    OVRCD,TDET9999
          MATCH     OPSGUNID,OPDAUNIQ
          GOTO      TDET9999 IF NOT EQUAL
.
          MATCH     OPSGTMNO,TEAMNUMB
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OPSGTMNO,"#" selected>":
                               OPSGTMNO,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OPSGTMNO,"#">":
                               OPSGTMNO,"</option>";
          ENDIF
.
          GOTO      TDET3050
.
TDET3100  MOVE      "OP",CATEGORY
          MOVE      OPTSSTYP,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET3200  MOVE      "ON",CATEGORY
          MOVE      OPTSSTYP,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET3300  WRITE     HTMLFILE;CASEKEYS;
          GOTO      TDET9999
.
TDET3400  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      TDET9999
.
TDET3500  WRITE     HTMLFILE;PREPTIME;
          GOTO      TDET9999
.
TDET3600  WRITE     HTMLFILE;DRESTIME;   
          GOTO      TDET9999
.
TDET3700  WRITE     HTMLFILE;SUSTTIME;
          GOTO      TDET9999
.
TDET3800  WRITE     HTMLFILE;SUENTIME;
          GOTO      TDET9999
.
TDET3900  MOVE      "TV",CATEGORY
          MOVE      DELYTIME,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET4000  WRITE     HTMLFILE;COUNTCOR;
          GOTO      TDET9999
.
TDET4100  MOVE      SP70,STAFFNAM
          MATCH     "1",OPCNURSE                 * Use pmshcpaf for OT Nurse?
          GOTO      TDET4110 IF EQUAL            * Yes
.
.         CONTROLF.OPCNURSE=0 - Use oprnuraf for OT Nurse
          PACK      KEY6,OPRTNAME,SP70
          CALL      RDOPNUR1
          BRANCH    OVRCD,TDET9999
          STRIP     OPNRGNAM
          STRIP     OPNRSNAM
          CLEAR     STAFFNAM
          APPEND    OPNRGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    OPNRSNAM,STAFFNAM
          RESET     STAFFNAM
          WRITE     HTMLFILE;STAFFNAM;
          GOTO      TDET9999
.
.         CONTROLF.OPCNURSE=1 - Use pmshcpaf for OT Nurse
TDET4110  PACK      KEY10,OPRTNAME,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,TDET9999
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          CLEAR     STAFFNAM
          APPEND    PMHCGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    PMHCSNAM,STAFFNAM
          RESET     STAFFNAM
          WRITE     HTMLFILE;STAFFNAM;
          GOTO      TDET9999
.
TDET4200  WRITE     HTMLFILE;OPRTNAME;
          GOTO      TDET9999
.
TDET4300  WRITE     HTMLFILE;OPDADES2;
          GOTO      TDET9999
.
TDET4400  WRITE     HTMLFILE;OPDADES3;
          GOTO      TDET9999
.
TDET4500  WRITE     HTMLFILE;OPDAPROV;
          GOTO      TDET9999
.
TDET4600  CALL      GETNZP00
          WRITE     HTMLFILE;NZSPPROC;
          GOTO      TDET9999
.
TDET4700  WRITE     HTMLFILE;PTHVFLAG;
          GOTO      TDET9999
.
TDET4800  MOVE      "OY",CATEGORY
          MOVE      OPDATYPE,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET4900  WRITE     HTMLFILE;OPTSUY01;
          GOTO      TDET9999
.
TDET5000  MOVE      ZERO,F1
          PACK      KEY12,OPDAUNIQ,SP70
          CALL      RSOPCBD1
TDET5010  CALL      RKOPCBD1
          BRANCH    OVRCD,TDET5020
.
          MATCH     OPCBUNIQ,OPDAUNIQ
          GOTO      TDET5020 IF NOT EQUAL
          MATCH     "1",OPCBDELT            * Deleted?
          GOTO      TDET5010 IF EQUAL
.
          MOVE      ONE,F1
TDET5020  WRITE     HTMLFILE;F1;
          GOTO      TDET9999
.
TDET5100  MATCH     SP70,ADATE
          GOTO      TDET9999 IF EQUAL 
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TDET9999
.
TDET5200  WRITE     HTMLFILE;ATIME;
          GOTO      TDET9999
.
TDET5300  PACK      KEY8,OPDAADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
            GOTO      TDET9999
          ENDIF
.
          MATCH     SP70,DDATE
          GOTO      TDET9999 IF EQUAL
          GOTO      TDET9999 IF EOS
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TDET9999
.
TDET5400  PACK      KEY8,OPDAADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
            GOTO      TDET9999
          ENDIF
.
          WRITE     HTMLFILE;DTIME;
          GOTO      TDET9999
.
TDET5500  CALL      BILC0000                * billing comment
          GOTO      TDET9999
.
TDET5600  PACK      KEY11,OPDAUNIQ,FOUR,SP70
          CALL      RDOPPOC1
          BRANCH    OVRCD,TDET9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      TDET9999
.
TDET5700  PACK      KEY11,OPDAUNIQ,FIVE,SP70
          CALL      RDOPPOC1
          BRANCH    OVRCD,TDET9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      TDET9999
.
TDET5800  WRITE     HTMLFILE;COUNTDPS;
          GOTO      TDET9999
.
TDET5900  PACK      KEY11,OPDAUNIQ,SIX,SP70
          CALL      RDOPPOC1
          BRANCH    OVRCD,TDET9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      TDET9999
.
TDET6000  CALL      STFF0000                * output staff members table
          GOTO      TDET9999
.
TDET6100  WRITE     HTMLFILE;JMPHFLAG;
          GOTO      TDET9999
.
TDET6200  WRITE     HTMLFILE;OPDADES4;
          GOTO      TDET9999
.
TDET6300  WRITE     HTMLFILE;OPDADES5;
          GOTO      TDET9999
.
TDET6400  WRITE     HTMLFILE;OPDADES6;
          GOTO      TDET9999
.
TDET6500  WRITE     HTMLFILE;OPSGDCK1;
          GOTO      TDET9999
.
TDET6600  WRITE     HTMLFILE;OPSGDCK2;
          GOTO      TDET9999
.
TDET6700  WRITE     HTMLFILE;OPDAPRV4;
          GOTO      TDET9999
.
TDET6800  WRITE     HTMLFILE;OPDAPRV5;
          GOTO      TDET9999
.
TDET6900  WRITE     HTMLFILE;OPDAPRV6;
          GOTO      TDET9999
.
TDET9999  RETURN
+
.------------------------------------------------------------
.         Check Next invoice billing comments
.------------------------------------------------------------
BILC0000  MOVE      ZERO,F1
          MOVE      "003",KEY3
          PACK      KEY17,ADMISSNO,KEY3,Z70
          CALL      RSVSMDT1
BILC1000  CALL      RPVSMDT1
          BRANCH    OVRCD,BILC9000
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      BILC9000 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      BILC9000 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      BILC1000 IF EQUAL        * Deleted
.
          MOVE      ONE,F1
.
BILC9000  WRITE     HTMLFILE;F1;
BILC9999  RETURN
+
.******************************************************************************
.*                  display tourniquet for theatre details                    *
.******************************************************************************
TOUR0000  PACK      KEY13,OPDAUNIQ,F1,Z70
          CALL      RSOPTQE1
          CALL      RPOPTQE1
          BRANCH    OVRCD,TOUR0200
.
          MATCH     OPTQUNID,OPDAUNIQ
          GOTO      TOUR0200 IF NOT EQUAL
          MOVE      F1,DIM1
          MATCH     OPTQRTYP,DIM1
          GOTO      TOUR0200 IF NOT EQUAL
.
          MATCH     SP70,OPTQRTIM
          GOTO      TOUR9999 IF EQUAL
          MOVE      SP70,OPTQATIM
          GOTO      TOUR9999
.
TOUR0200  CALL      CLOPRTQE
          MOVE      ZERO,OPTQCNTR
          GOTO      TOUR9999
.
TOUR9999  RETURN
.******************************************************************************
.*                  Output Table of Staff Members                             *
.******************************************************************************
STAF0000  MATCH     "0",TEAMNUMB
          IF        @EQUAL
            MOVE      "1",TEAMNUMB
          ENDIF
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPTSM1
STAF0100  CALL      RKOPTSM1
          BRANCH    OVRCD,STAF9999
          MATCH     OPTSUNID,OPDAUNIQ
          GOTO      STAF9999 IF NOT EQUAL
          MATCH     OPTSTMNO,TEAMNUMB
          GOTO      STAF9999 IF NOT EQUAL
.
          MOVE      SP70,STAFFNAM
          MOVE      SP70,OPPTDESC
          IF        OPTSSIND=0
            MOVE      OPTDESC0,OPPTDESC
            GOTO      STAF0150
           ENDIF
          IF        OPTSSIND=1
            MOVE      OPTDESC1,OPPTDESC
            GOTO      STAF0150
           ENDIF
          IF        OPTSSIND=2
            MOVE      OPTDESC2,OPPTDESC
            GOTO      STAF0150
          ENDIF
          IF        OPTSSIND=3
            MOVE      OPTDESC3,OPPTDESC
            GOTO      STAF0150
          ENDIF
.
STAF0150  IF        OPTSSIND=0 | OPTSSIND=1
            GOTO      STAF0151
          ENDIF
          IF        OPTSSIND=2
            GOTO      STAF0152
          ENDIF
          IF        OPTSSIND=3
            GOTO      STAF0155
          ENDIF
          GOTO      STAF0200
.
.         Staff Type: Operating Surgeon(0)/Doctor(1)
STAF0151  PACK      KEY6,OPTSSCDE,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,STAF0200
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,STAFFNAM
          STRIP     STAFFNAM
          GOTO      STAF0200
.
.         Staff Type: Nurse
STAF0152  MATCH     "1",OPCNURSE                 * Use pmshcpaf for OT Nurse?
          GOTO      STAF0153 IF EQUAL            * Yes
.
.         CONTROLF.OPCNURSE = 0 - Use oprnuraf for OT Nurse
          PACK      KEY6,OPTSSCDE,SP70
          CALL      RDOPNUR1
          BRANCH    OVRCD,STAF0200
          STRIP     OPNRGNAM
          STRIP     OPNRSNAM
          CLEAR     STAFFNAM
          APPEND    OPNRGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    OPNRSNAM,STAFFNAM
          RESET     STAFFNAM
          GOTO      STAF0200
.
.         CONTROLF.OPCNURSE = 1 - Use pmshcpaf for OT Nurse
STAF0153  PACK      KEY10,OPTSSCDE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,STAF0200
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          CLEAR     STAFFNAM
          APPEND    PMHCGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    PMHCSNAM,STAFFNAM
          RESET     STAFFNAM
          GOTO      STAF0200
.
.         Staff Type: Other
STAF0155  PACK      KEY10,OPTSSCDE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,STAF0200
          MOVE      PMHCSNAM,FMTSNAME
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCTITL,FMTTITLE
          CALL      DOCNM000
          MOVE      DOCFNAME,STAFFNAM
          STRIP     STAFFNAM
          GOTO      STAF0200
.
STAF0200  MOVE      SP70,DIM19
          MATCH     SP70,OPTSSTYP
          GOTO      STAF2500 IF EQUAL
.
          IF        OPTSSIND=0 | OPTSSIND=1
            MOVE      "OP",CATEGORY
            GOTO      STAF2400
          ENDIF
          IF        OPTSSIND=2
            MOVE      "ON",CATEGORY
            GOTO      STAF2400
          ENDIF
          IF        OPTSSIND=3
            MOVE      "OF",CATEGORY
            GOTO      STAF2400
          ENDIF
          GOTO      STAF2500
.
STAF2400  MOVE      OPTSSTYP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,DIM19
          ENDIF
.
STAF2500  MOVE      "OS",CATEGORY
          MOVE      OPTSSLEV,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
          ENDIF
.
          MOVE      "No",KEY3
          MATCH     "1",OPTSINST
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
.
          MOVE      "No",TIMEOUTD
          MATCH     "1",OPTSUY01
          IF        @EQUAL
            MOVE      "Yes",TIMEOUTD
          ENDIF
.
STAF0300  PACK      KEY35,OPTSUNID,OPTSTMNO,DOPTSSIN,OPTSSCDE:
                          OPTSSDAT,OPTSSTIM,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "','",HTMLLINK
          MOVE      OPTSSIND,DIM2
          SQUEEZE   DIM2
          MOVE      DIM2,DIM1
          APPEND    DIM1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPTSSCDE,HTMLLINK
          APPEND    "','",HTMLLINK
          UNPACK    OPTSSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      OPTSFDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          APPEND    OPTSFDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPTSSTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
..
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPPTDESC,"#",":
                             "#"",STAFFNAM,"#",":
                             "#"",OPTSSTIM,"#",":
                             "#"",OPTSETIM,"#",":
                             "#"",TDESC,"#",":
                             "#"",DIM19,"#",":
                             "#"",KEY3,"#",":
                             "#"","javascript:UpdateEndTime('",KEY35,"')#",":
                             "#"",TIMEOUTD,"#");";
.
          GOTO      STAF0100
.
STAF9999  RETURN
.******************************************************************************
.*                  Patient Implant Details                                   *
.******************************************************************************
PIMD0000  BRANCH    FLDITMNO,PIMD0100,PIMD0200,PIMD0300,PIMD0400,PIMD0500:
                             PIMD0600,PIMD0700,PIMD0800,PIMD0900,PIMD1000:
                             PIMD1100,PIMD1200,PIMD1300,PIMD1400,PIMD1500:
                             PIMD1600,PIMD1700,PIMD1800,PIMD1900,PIMD2000:
                             PIMD2100,PIMD2200,PIMD2300,PIMD2400,PIMD2500:
                             PIMD2600,PIMD2700,PIMD2800,PIMD2900,PIMD3000
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      PIMD9999
.
PIMD0100  WRITE     HTMLFILE;OPDATHET;      * Operating Room Code
          GOTO      PIMD9999
.
PIMD0200  WRITE     HTMLFILE;OPRMDESC;      * Theatre Description
          GOTO      PIMD9999
.
PIMD0300  WRITE     HTMLFILE;BKREDEPT;      * Unit Code
          GOTO      PIMD9999
.
PIMD0400  MOVE      BKREDEPT,CODE           * Unit Description
          MOVE      "AC",CATEGORY
          CALL      CODITM00
          GOTO      PIMD9999
.
PIMD0500  WRITE     HTMLFILE;OPDADES1;      * Operating Description
          GOTO      PIMD9999
.
PIMD0600  WRITE     HTMLFILE;OPSGTMNO;      * Team Number
          GOTO      PIMD9999
.
PIMD0700  WRITE     HTMLFILE;OPSGIDES;      * Implant Description
          GOTO      PIMD9999
.
PIMD0800  WRITE     HTMLFILE;OPPIICDE;      * Implant Code
          GOTO      PIMD9999
.
PIMD0900  WRITE     HTMLFILE;OPPIIQTY;      * Quantity
          GOTO      PIMD9999
.
PIMD1000  WRITE     HTMLFILE;OPPILTSN;      * Lot/Serial Number
          GOTO      PIMD9999
.
PIMD1100  WRITE     HTMLFILE;OPPICOST;      * Cost Code
          GOTO      PIMD9999
.
PIMD1200  MOVE      "Ow",CATEGORY
          MOVE      OPPILOCA,CODE           * Location
          CALL      CODITM00
          GOTO      PIMD9999

PIMD1300  WRITE     HTMLFILE;OPTIDESC;      * Implant description
          GOTO      PIMD9999
.
PIMD1400  MOVE      "OW",CATEGORY           * Type Of Implant
          MOVE      OPTITYIM,CODE
          CALL      CODITM00
          GOTO      PIMD9999
.
PIMD1500  WRITE     HTMLFILE;OPTIMCHG;      * Miscellaneous Charge Code
          GOTO      PIMD9999
.
PIMD1600  WRITE     HTMLFILE;OPTIMANU;      * Manufacture
          GOTO      PIMD9999
.
PIMD1700  WRITE     HTMLFILE;OPTISIZE;      * Size
          GOTO      PIMD9999
.
PIMD1800  WRITE     HTMLFILE;OPTISUPP;      * Supplier Name
          GOTO      PIMD9999
.
PIMD1900  WRITE     HTMLFILE;OPTICOST;      * Cost
          GOTO      PIMD9999
.
PIMD2000  CALL      PIDTAB00                * Table for Patient Implant Tables
          GOTO      PIMD9999                * implant number
.
PIMD2100  WRITE     HTMLFILE;OPPICNTR;      * Implant counter 
          GOTO      PIMD9999
.
PIMD2200  WRITE     HTMLFILE;TRECEIPT;      * I CAR 40412
          GOTO      PIMD9999
.
PIMD2300  WRITE     HTMLFILE;OPPIONUM;      * order number
          GOTO      PIMD9999
.
PIMD2400  WRITE     HTMLFILE;OPPIICOS;      * item cost
          GOTO      PIMD9999
.
PIMD2500  WRITE     HTMLFILE;OPTIREGI;      * Prompt for joint reg
          GOTO      PIMD9999
.
PIMD2600  WRITE     HTMLFILE;OPPIUF01;      * udf 1
          GOTO      PIMD9999
.
PIMD2700  WRITE     HTMLFILE;OPPIUY01;
          GOTO      PIMD9999
.
PIMD2800  MOVE      "oE",CATEGORY
          MOVE      OPPIUC01,CODE
          CALL      CODITM00
          GOTO      PIMD9999
.
PIMD2900  WRITE     HTMLFILE;OPPIBCOD;
          GOTO      PIMD9999
.
PIMD3000  MOVE      "OW",CATEGORY           * Type Of Implant
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      PIMD9999
.
PIMD9999  RETURN
+
.******************************************************************************
.*        Table for Patient Implant Details
.******************************************************************************
PIDTAB00  PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPIM1
PIDTAB10  CALL      RKOPPIM1                * Read Patient Implant Table
          BRANCH    OVRCD,PIDTAB99
.
          MATCH     OPPIUNID,OPDAUNIQ       * Match Unique ID
          GOTO      PIDTAB99 IF NOT EQUAL
          MATCH     OPPITMNO,TEAMNUMB       * Match Team Number
          GOTO      PIDTAB99 IF NOT EQUAL
.
          MOVE      "Ow",CATEGORY           * Location
          MOVE      OPPILOCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MATCH     "1",OPCNSIVB            * Search via barcode
          GOTO      PIDTAB16 IF NOT EQUAL
.
          MATCH     SP70,OPPIICDE
          GOTO      PIDTAB16 IF NOT EQUAL   * EAN number is not blank
.
          PACK      KEY75,OPPIBCOD,SP70
          CALL      RDOPTHI3
          COMPARE   ZERO,OVRCD
          GOTO      PIDTAB18 IF EQUAL       * exist with blank EAN number
.
          PACK      KEY60,OPPIBCOD,SP70
          PACK      KEY75,KEY60,SP70
          CALL      RSOPTHI3                * Read Theatre Implants Table
          CALL      RKOPTHI3
          BRANCH    OVRCD,PIDTAB17
.
          MATCH     KEY60,OPTIBCOD          * Same barcode ?
          GOTO      PIDTAB17 IF NOT EQUAL
          GOTO      PIDTAB18
.
PIDTAB16  PACK      KEY75,OPPIICDE,OPPIBCOD,SP70
          CALL      RDOPTHI1                * Read Theatre Implants Table
          COMPARE   ZERO,OVRCD
          GOTO      PIDTAB18 IF EQUAL
.
PIDTAB17  UNPACK    SP70,OPTITYIM,OPTIDESC,OPTIMCHG,TDESC
          MOVE      "Invalid Implant Code/EAN No.",OPTIDESC
          GOTO      PIDTAB20
.
PIDTAB18  MOVE      "OW",CATEGORY           * Type Of Implant
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
PIDTAB20  WRITE     HTMLFILE;"t.addRow(#"javascript:UpdateLink('":
                                OPPIICDE,"','",OPPICNTR,"','",OPPIBCOD:
                                "')#",#"",OPPIICDE,"#",#"",OPTIDESC,"#",#"":
                                TDESC,"#",#"",OPPILTSN,"#",#"",OPPIIQTY:
                                "#",#"",KEY20:
                                "#",#"",OPTIMCHG:
                                "#",#"",OPPIBCOD,"#");";
.
          GOTO      PIDTAB10
.
PIDTAB99  RETURN
.******************************************************************************
.*                      Reading for Tourniquet Details for Display            *
.******************************************************************************
TNQT0000  BRANCH    FLDITMNO,TNQT0100,TNQT0200,TNQT0300,TNQT0400,TNQT0500:
                             TNQT0600,TNQT0700,TNQT0800,TNQT0900,TNQT1000:
                             TNQT1100,TNQT1200,TNQT1300,TNQT1400,TNQT1500
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      TNQT9999
.
TNQT0100  PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPTQE1                * Doing posiitonal read
.
TNQT0110  CALL      RKOPTQE1                * Doing Sequential read
          BRANCH    OVRCD,TNQT9999
          PACK      KEY10,OPTQUNID,SP70
          MATCH     KEY10,KEY13
          GOTO      TNQT9999 IF NOT EQUAL
          MATCH     " 0",OPTQCNTR
          GOTO      TNQT0110 IF EQUAL
          CALL      RCTYCH00
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPTQRTYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPTQCNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",LIMBTYPE,"#",":
                             "#"",OPTQCNTR,"#",":
                             "#"",OPTQADAT,"#",":
                             "#"",OPTQATIM,"#",":
                             "#"",OPTQRDAT,"#",":
                             "#"",OPTQRTIM,"#"":
                             ")"
          GOTO      TNQT0110
.
TNQT0200  WRITE     HTMLFILE;OPDATHET;      * For Theatre Code
          GOTO      TNQT9999
.
TNQT0300  WRITE     HTMLFILE;OPRMDESC;      * For Theatre Description
          GOTO      TNQT9999
.
TNQT0400  WRITE     HTMLFILE;BKREDEPT;      * For Unit Code
          GOTO      TNQT9999
.
TNQT0500  MOVE      BKREDEPT,CODE           * Unit Description
          MOVE      "AC",CATEGORY
          CALL      CODITM00
          GOTO      TNQT9999
.
TNQT0600  WRITE     HTMLFILE;OPDADES1;      * For Operation Description
          GOTO      TNQT9999
.
TNQT0700
          WRITE     HTMLFILE;OPSGTMNO;
          GOTO      TNQT9999
.
TNQT0800  WRITE     HTMLFILE;OPTQRTYP;      * For record Tyepe
          GOTO      TNQT9999
.
TNQT0900  WRITE     HTMLFILE;OPTQCNTR;      * For Counter
          GOTO      TNQT9999
.
TNQT1000  UNPACK    OPTQADAT,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,OPTQADAT
          GOTO      TNQT9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      TNQT9999
.
TNQT1100  WRITE     HTMLFILE;OPTQATIM;      * For Applied Time
          GOTO      TNQT9999
.
TNQT1200  UNPACK    OPTQRDAT,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,OPTQRDAT
          GOTO      TNQT9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      TNQT9999
.
TNQT1300  WRITE     HTMLFILE;OPTQRTIM;      * For Remove Time
          GOTO      TNQT9999
.
TNQT1400  CALL      RCTYCH00                * For Record Type Description
          WRITE     HTMLFILE;LIMBTYPE;
          GOTO      TNQT9999
.
TNQT1500  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      TNQT9999
.
TNQT9999  RETURN
.*****************************************************************************
.                   Limb Type Format Change                                  *
.*****************************************************************************
RCTYCH00  MATCH     "1",OPTQRTYP
          IF        @EQUAL
            MOVE      "Right Leg",LIMBTYPE
          ENDIF
.                                           *Converts recordtype to recordDesc
          MATCH     "2",OPTQRTYP
          IF        @EQUAL
            MOVE      "Left Leg",LIMBTYPE
          ENDIF
.
          MATCH     "3",OPTQRTYP
          IF        @EQUAL
            MOVE      "Right Arm",LIMBTYPE
          ENDIF
.
          MATCH     "4",OPTQRTYP
          IF        @EQUAL
            MOVE      "Left Arm",LIMBTYPE
          ENDIF
.
          MATCH     "5",OPTQRTYP
          IF        @EQUAL
            MOVE      OPTQCOMM,LIMBTYPE
          ENDIF
.
          MATCH     "6",OPTQRTYP
          IF        @EQUAL
            MOVE      "Carotid",LIMBTYPE
          ENDIF
.
          MATCH     "7",OPTQRTYP
          IF        @EQUAL
            MOVE      "Aorta",LIMBTYPE
          ENDIF
.
          MATCH     SP70,OPTQRTYP
          IF        @EQUAL
            MOVE      SP70,LIMBTYPE
          ENDIF
.
RCTYCH99  RETURN
******************************************************************************
.*                  Output Routine for CMBS  Items                            *
.******************************************************************************
CMBS0000  BRANCH    FLDITMNO,CMBS0100,CMBS0200,CMBS0300,CMBS0400,CMBS0500:
                             CMBS0600,CMBS0700,CMBS0800,CMBS0900,CMBS1000:
                             CMBS1100,CMBS1200,CMBS1300,CMBS1400,CMBS1500:
                             CMBS1600,CMBS1700,CMBS1800,CMBS1900,CMBS2000:
                             CMBS2100,CMBS2200,CMBS2300,CMBS2400,CMBS2500:
                             CMBS2600,CMBS2700
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      CMBS9999
.
CMBS0100  WRITE     HTMLFILE;OPPMTMNO;
          GOTO      CMBS9999
.
CMBS0200  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,CMBS0210
          MOVE      SP70,IDESC
          PACK      KEY9,OPPMCMBS,SP70
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,CMBS9999
          WRITE     HTMLFILE;IDESC;
          GOTO      CMBS9999
.
CMBS0210  WRITE     HTMLFILE;OPPMCMBS;
          GOTO      CMBS9999
.
CMBS0300  WRITE     HTMLFILE;OPPMCNTR;
          GOTO      CMBS9999
.
CMBS0400  CALL      TABCMB00
          GOTO      CMBS9999
.
CMBS0500  WRITE     HTMLFILE;TEAMNUMB;
          GOTO      CMBS9999
.
CMBS0600  WRITE     HTMLFILE;ONCOLOGY;
          GOTO      CMBS9999
.
CMBS0700  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          CALL      TABITM00              * Table of Theatre items
          GOTO      CMBS9999
.
CMBS0800  WRITE     HTMLFILE;IRECTYPE;
          GOTO      CMBS9999
.
CMBS0900  WRITE     HTMLFILE;TRANNUMB;
          GOTO      CMBS9999
.
CMBS1000  WRITE     HTMLFILE;UNIQUEKY;
          GOTO      CMBS9999
.
CMBS1100  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,CMBS1110
          WRITE     HTMLFILE;PMMIDESC;
          GOTO      CMBS9999
.
CMBS1110  WRITE     HTMLFILE;PMMIITEM;
          GOTO      CMBS9999
.
CMBS1200  WRITE     HTMLFILE;PMVXATCP;
          GOTO      CMBS9999
.
CMBS1300  WRITE     HTMLFILE;SHOWPROV;
          GOTO      CMBS9999
.
CMBS1400  MOVE      PMVXTICM,CODE           * Theatre Reason Incomplete
          MOVE      "Rt",CATEGORY
          CALL      CODITM00
          GOTO      CMBS9999
.
CMBS1500  WRITE     HTMLFILE;PMMISERV;
          GOTO      CMBS9999
.
CMBS1600  WRITE     HTMLFILE;PMMIAMTT;
          GOTO      CMBS9999
.
CMBS1700  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0 & AINVPRT<>0
            WRITE     HTMLFILE;"Patient already invoiced";
          ENDIF
          GOTO      CMBS9999
.
CMBS1800  MOVE      ZERO,SORTFLAG
          CALL      EITM0000                * Displaying existing items
          GOTO      CMBS9999
.
CMBS1900  MOVE      ZERO,SORTFLAG
          CALL      IITM0000                * Displaying invoiced items
          GOTO      CMBS9999
.
CMBS2000  MOVE      ONE,SORTFLAG
          CALL      EITM0000                * Sort table existing item
          GOTO      CMBS9999
.
CMBS2100  MOVE      ONE,SORTFLAG
          CALL      IITM0000                * Sort table invoiced item
          GOTO      CMBS9999
.
CMBS2200  WRITE     HTMLFILE;OPDAACPD;      * All theatre charges posted
          GOTO      CMBS9999
.
CMBS2300  MOVE      OPDARICM,CODE           * Reason Incomplete (theatre record)
          MOVE      "Rt",CATEGORY
          CALL      CODITM00
          GOTO      CMBS9999
.
CMBS2400  WRITE     HTMLFILE;JMPHFLAG;
          GOTO      CMBS9999
.
CMBS2500  CALL      TITM0000                * number of existing MBS items
          WRITE     HTMLFILE;FORM6;
          GOTO      CMBS9999
.
CMBS2600  WRITE     HTMLFILE;NOWARNFL;      * No Warning message flag
          GOTO      CMBS9999
.
CMBS2700  WRITE     HTMLFILE;MBSTOTAL;      * Total number of MBS Items all team
          GOTO      MISC9999
.
CMBS9999  RETURN
+
.******************************************************************************
.*                Display Extra MBS Items                                     *
.******************************************************************************
DMBS0000  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
DMBS1000  CALL      RKOPDEA2
          BRANCH    OVRCD,DMBS9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DMBS9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      DMBS1000 IF EQUAL          * Cancelled
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
DMBS2000  CALL      RKOPMBS1
          BRANCH    OVRCD,DMBS1000
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      DMBS1000 IF NOT EQUAL
.
          MOVE      OPMBMBSI,KEY9
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,OPDADATE,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD=1
              MOVE      SP70,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            MOVE      ODESC,IDESC           * Set up description
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td class=DataField>":
                             "<input type=text size=9 maxlength=12 ":
                             "class='Readonly readonly'":
                             " value='",OPMBMBSI,"' </td>":
                             "<td class=DataField>":
                             "<input type=text size=50 maxlength=70 ":
                             "class='Readonly readonly'":
                             " value='",IDESC,"' </td></tr>";
          GOTO      DMBS2000
.
DMBS9999  RETURN
+
.******************************************************************************
.*                Display Routine for CMBS Items Details                      *
.******************************************************************************
TABCMB00  PACK      KEY14,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPMB1                 * Partial Read on oprpmbaf
TABCMB10  CALL      RKOPPMB1                 * Read Next Record on oprpmbaf
          BRANCH    OVRCD,TABCMB99
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      TABCMB99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPMTMNO
          GOTO      TABCMB99 IF NOT EQUAL
.
          PACK      KEY9,OPPMCMBS,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD=1
            MOVE      "Invalid",IDESC
          ENDIF
.
.                                           * get start & end times   *I-207386
          MOVE      "&nbsp;",DIM6A
          MOVE      "&nbsp;",DIM6B
          PACK      KEY20,OPPMCMBS,ADMISSNO,SP20
          CALL      RDSMMBS2
TABCMB20  CALL      RDKMMBS2
          BRANCH    OVRCD,TABCMB40
.
          MATCH     OPPMCMBS,MMCODE
          GOTO      TABCMB40 IF NOT EQUAL
          MATCH     ADMISSNO,DMMADMN
          GOTO      TABCMB40 IF NOT EQUAL
.
          MATCH     OPPMUNID,PTMMOPID
          GOTO      TABCMB20 IF NOT EQUAL
          MATCH     OPPMTMNO,PTMMTMNO
          GOTO      TABCMB20 IF NOT EQUAL
.
          MATCH     "00:00",MMSTIM
          IF        !@EQUAL
            MATCH     SP5,MMSTIM
            IF        !@EQUAL
              PACK      DIM6A,MMSTIM,SP10
            ENDIF
          ENDIF
          MATCH     "00:00",MMETIM
          IF        !@EQUAL
            MATCH     SP5,MMETIM
            IF        !@EQUAL
              PACK      DIM6B,MMETIM,SP10
            ENDIF
          ENDIF
.
TABCMB40  IF        ONCOLOGY=1
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif class=Icon ":
                               "onclick=#"UpdateLink('":
                               ADMISSNO,"','",TEAMNUMB,"','",OPPMCNTR,"');#">":
                               OPPMCMBS,"</td><td>":
                               IDESC,"</td><td>":
                               DIM6A,"</td><td>":
                               DIM6B,"</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif class=Icon ":
                               "onclick=#"UpdateLink('":
                               CASEKEYS,"','",TEAMNUMB,"','",OPPMCNTR,"');#">":
                               OPPMCMBS,"</td><td>":
                               IDESC,"</td><td>":
                               DIM6A,"</td><td>":
                               DIM6B,"</td></tr>";
          ENDIF
          GOTO      TABCMB10 
.
TABCMB99  RETURN
.
.******************************************************************************
.*                Display Routine for Theatre Items Details                   *
.******************************************************************************
TABITM00  MOVE      ADMISSNO,PMMIVISN
          BRANCH    F1,TABITM60
.
          PACK      KEY15,PMMIVISN,SP20
          CALL      RSPMMTI2
TABITM10  CALL      RKPMMTI2
          BRANCH    OVRCD,TABITM60          * no (more) details for admission
.
          MATCH     PMMIVISN,ADMISSNO       * get admission number as form
          GOTO      TABITM60 IF NOT EQUAL   * different admission
.
.         MATCH     PMMIUNIQ,OPDAUNIQ        * Same unique number
.         GOTO      TABITM10 IF NOT EQUAL
.
.         check if the session date matches
.
.         MATCH     PMMITDAT,OPDADATE
.         GOTO      TABITM10 IF NOT EQUAL   * different session
.
          MATCH     "2",PMMIRTYP
          GOTO      TABITM40 IF EQUAL       * Theatre
          MATCH     "3",PMMIRTYP
          GOTO      TABITM10 IF NOT EQUAL   * Misc.Item
.
TABITM40  PACK      KEY10,PMMIUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,TABITM10
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",DISPDATE," at ",OPDATIME,"</td>":
                             "<td>",PMMIUNIQ,"</td>":
                             "<td nowrap>":
                             "<img src=../images/EditIcon.gif class=Icon ";
.
          WRITE     HTMLFILE;"onclick=#"UpdateLink('":
                             CASEKEYS,"','",TEAMNUMB,"','",PMMIUNIQ,"','":
                               PMMIVISN,"','":
                               PMMIRTYP,"','",PMMITRAN,"');#">":
                               PMMIITEM,"</td><td>":
                               PMMIDESC,"</td><td>":
                               PMMISERV,"</td></tr>";
          GOTO      TABITM10
.
TABITM60  PACK      KEY26,CASEKEYS,SP70      * Re read original oprdetaf record
          CALL      RDOPDEA1
          BRANCH    OVRCD,TABITM99
.
          MATCH     "1",SHOWPROV
          GOTO      TABITM99 IF NOT EQUAL    * Not displaying prov.MBS items
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>";
.
            IF        F1=1
              WRITE     HTMLFILE;"<img src=../images/DeleteIcon.gif ":
                               " class=ListIcon onclick='DeleteProv(this);'>";
            ENDIF
.
            WRITE     HTMLFILE;DISPDATE," at ",OPDATIME,"</td>":
                               "<td>",OPDAUNIQ,"</td>":
                               "<td><img src=../images/DietIconTrans.gif ":
                               "class=ListIcon>":
                               OPDAPROV,"</td>":
                               "<td>",OPDADES1,"</td>":
                               "<td>",ONE,"</td></tr>";
          ENDIF
.
          MATCH     SP70,OPDAPRV2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>";
.
            IF        F1=1
              WRITE     HTMLFILE;"<img src=../images/DeleteIcon.gif ":
                               " class=ListIcon onclick='DeleteProv(this);'>";
            ENDIF
.
            WRITE     HTMLFILE;DISPDATE," at ",OPDATIME,"</td>":
                               "<td>",OPDAUNIQ,"</td>":
                               "<td><img src=../images/DietIconTrans.gif ":
                               "class=ListIcon>":
                               OPDAPRV2,"</td>":
                               "<td>",OPDADES2,"</td>":
                               "<td>",ONE,"</td></tr>";
          ENDIF
.
          MATCH     SP70,OPDAPRV3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>";
.
            IF        F1=1
              WRITE     HTMLFILE;"<img src=../images/DeleteIcon.gif ":
                               " class=ListIcon onclick='DeleteProv(this);'>";
            ENDIF
.
            WRITE     HTMLFILE;DISPDATE," at ",OPDATIME,"</td>":
                               "<td>",OPDAUNIQ,"</td>":
                               "<td><img src=../images/DietIconTrans.gif ":
                               "class=ListIcon>":
                               OPDAPRV3,"</td>":
                               "<td>",OPDADES3,"</td>":
                               "<td>",ONE,"</td></tr>"
          ENDIF
.
          CALL      CXMB0000               * Check extra MBS
.
TABITM99  RETURN
.
.******************************************************************************
.         Display Extra provisional MBS
.******************************************************************************
CXMB0000  PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
CXMB1000  CALL      RKOPMBS1
          BRANCH    OVRCD,CXMB9999
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      CXMB9999 IF NOT EQUAL
.
          MATCH     SP70,OPMBMBSI
          GOTO      CXMB1000 IF EQUAL
.
          MOVE      OPMBMBSI,KEY9
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,OPDADATE,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD=1
              MOVE      SP70,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            MOVE      ODESC,IDESC           * Set up description
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>";
.
          IF        F1=1
            WRITE     HTMLFILE;"<img src=../images/DeleteIcon.gif ":
                             " class=ListIcon onclick='DeleteProv(this);'>";
          ENDIF
.
          WRITE     HTMLFILE;DISPDATE," at ",OPDATIME,"</td>":
                             "<td>",OPDAUNIQ,"</td>":
                             "<td><img src=../images/DietIconTrans.gif ":
                             "class=ListIcon>":
                             OPMBMBSI,"</td>":
                             "<td>",IDESC,"</td>":
                             "<td>",ONE,"</td></tr>"
          GOTO      CXMB1000
.
CXMB9999  RETURN
+
.******************************************************************************
.                 Display Existing items
.******************************************************************************
EITM0000  MOVE      SP70,UNIQNUMB
          MATCH     "1",OPCNDMBS            * only display the selected Uniq.ID
          IF        @EQUAL
            MATCH     SP70,CASEKEYS
            IF        !@EQUAL
              PACK      KEY26,CASEKEYS,SP70
              CALL      RDOPDEA1
              IF        OVRCD=0
                MOVE      OPDAUNIQ,UNIQNUMB * save the current Uniq.ID
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY15,ADMISSNO,SP20
          CALL      RSPMMTI2
EITM1000  CALL      RKPMMTI2
          BRANCH    OVRCD,EITM9000          * no (more) details for admission
.
          MATCH     PMMIVISN,ADMISSNO       * get admission number as form
          GOTO      EITM9000 IF NOT EQUAL   * different admission
.
          MATCH     "2",PMMIRTYP
          GOTO      EITM2000 IF EQUAL
          MATCH     "3",PMMIRTYP
          GOTO      EITM1000 IF NOT EQUAL   * Misc.Item
.
EITM2000  PACK      KEY10,PMMIUNIQ,SP70      * Re read original oprdetaf record
          CALL      RDOPDEA3
          BRANCH    OVRCD,EITM1000
.
          PACK      KEY23,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          IF        PMMISERV>1
            MULT      PMMISERV,PMMIAMTP
            MULT      PMMISERV,PMMIRBAT
          ENDIF
.
          MOVE      SP70,DIM8
          MATCH     "1",OPCNCONS
          IF        @EQUAL
            CALL      SCON0000              * Set Consumption type
          ENDIF
.
          MATCH     "1",OPCNDMBS            * only display the selected Uniq.ID
          IF        @EQUAL
            MATCH     SP70,UNIQNUMB
            IF        !@EQUAL
              MATCH     UNIQNUMB,PMMIUNIQ
              GOTO      EITM1000 IF NOT EQUAL   * different Uniq.ID
            ENDIF
          ENDIF
.
          BRANCH    SORTFLAG,EITM4000
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/DeleteIcon.gif class=Icon ":
                             "onclick=#"UpdateLink('":
                             KEY23,"','",TEAMNUMB,"','",PMMIUNIQ,"','":
                             PMMIVISN,"','":
                             PMMIRTYP,"','",PMMITRAN,"');#">":
                             DISPDATE," at ",OPDATIME,"</td>":
                             "<td>",PMMIUNIQ,"</td>":
                             "<td>":
                             PMMIITEM,"</td><td>":
                             PMMIDESC,"</td><td>":
                             "<img src=../images/EditIcon.gif class=Icon ":
                             "onclick=#"UpdateQuantity('":
                             KEY23,"','",TEAMNUMB,"','",PMMIUNIQ,"','":
                             PMMIVISN,"','":
                             PMMIRTYP,"','",PMMITRAN,"');#">":
                             PMMISERV,"</td><td align=right>":
                             PMMIAMTP,"</td><td align=right>":
                             PMMIRBAT,"</td>":
                             DIM8,"</td></tr>";
           GOTO      EITM1000
.
EITM4000
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateLink('",HTMLLINK
          APPEND    KEY23,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TEAMNUMB,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMIUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMIVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMIRTYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMITRAN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK8
          APPEND    "javascript:UpdateQuantity('",HTMLLNK8
          APPEND    KEY23,HTMLLNK8
          APPEND    "','",HTMLLNK8
          APPEND    TEAMNUMB,HTMLLNK8
          APPEND    "','",HTMLLNK8
          APPEND    PMMIUNIQ,HTMLLNK8
          APPEND    "','",HTMLLNK8
          APPEND    PMMIVISN,HTMLLNK8
          APPEND    "','",HTMLLNK8
          APPEND    PMMIRTYP,HTMLLNK8
          APPEND    "','",HTMLLNK8
          APPEND    PMMITRAN,HTMLLNK8
          APPEND    "')",HTMLLNK8
          RESET     HTMLLNK8
.
          CLEAR     KEY20
          APPEND    DISPDATE,KEY20
          APPEND    " at ",KEY20
          APPEND    OPDATIME,KEY20
          APPEND    SP70,KEY20
          RESET     KEY20
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",KEY20,"#",":               * 1
                             "#"",PMMIUNIQ,"#",":            * 2
                             "#"",PMMIITEM,"#",":            * 3
                             "#"",PMMIDESC,"#",":            * 4
                             "#"",PMMISERV,"#",":            * 5
                             "#"",HTMLLNK8,"#",":            * 6
                             "#"",PMMIAMTP,"#",":            * 7
                             "#"",PMMIRBAT,"#",":            * 8
                             "#"",DIM8,"#",":                * 9
                             "#"",SP1,"#");"                 * 10
           GOTO      EITM1000
.
EITM9000  PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
.
          CALL      DCIT0000             * Display theatre consumption type item
.
EITM9999  RETURN
+
.******************************************************************************
.         Setup Consumption type 
.******************************************************************************
SCON0000  MOVE      "&nbsp;  ",DIM8
.
          MATCH     "9",PMMIRTYP
          GOTO      SCON1000 IF EQUAL       * Consumption type item
.
          MATCH     "3",PMMIRTYP
          GOTO      SCON9999 IF NOT EQUAL   * Not a Misc.items
.
SCON1000  MOVE      "Used    ",DIM8      *Default Consumption type is Used
          MATCH     "1",PMMICTYP
          IF        @EQUAL
            MOVE      "Not Used",DIM8
          ELSE
            MATCH     "2",PMMICTYP
            IF        @EQUAL
              MOVE      "Expired ",DIM8
            ENDIF
          ENDIF
SCON9999  RETURN
+
.******************************************************************************
.         Display Theatre Consumption type items
.******************************************************************************
DCIT0000  MATCH     "1",OPCNCONS
          GOTO      DCIT9999 IF NOT EQUAL    * Not using Consumption type items
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPCTY1
DCIT1000  CALL      RKOPCTY1
          BRANCH    OVRCD,DCIT9999
.
          MATCH     OPDAUNIQ,OPCYUNIQ      * Same uniq id ?
          GOTO      DCIT9999 IF NOT EQUAL
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      OPCYITEM,MCHARGE
          CALL      GETMSC00
.
          MOVE      NINE,PMMIRTYP         * flag for Consumption type item
          MOVE      OPCYCTYP,PMMICTYP
          MOVE      SP70,DIM8
          CALL      SCON0000              * Set Consumption type
.
          MULT      OPCYQUAN,MPATPOR
          MULT      OPCYQUAN,MHFPOR
.
          BRANCH    SORTFLAG,DCIT3000
.
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/DeleteIcon.gif class=Icon ":
                             "onclick=#"UpdateLink('":
                             KEY23,"','",TEAMNUMB,"','",OPDAUNIQ,"','":
                             OPDAADMN,"','":
                             PMMIRTYP,"','",OPCYCNTR,"');#">":
                             DISPDATE," at ",OPDATIME,"</td>":
                             "<td>",OPDAUNIQ,"</td>":
                             "<td>":
                             OPCYITEM,"</td><td>":
                             MDESC,"</td><td>":
                             OPCYQUAN,"</td><td align=right>":
                             MPATPOR,"</td><td align=right>":
                             MHFPOR,"</td>":
                             DIM8,"</td></tr>";
          GOTO      DCIT1000
.
DCIT3000
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateLink('",HTMLLINK
          APPEND    KEY23,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TEAMNUMB,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPCYUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPDAADMN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMIRTYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPCYCNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     KEY20
          APPEND    DISPDATE,KEY20
          APPEND    " at ",KEY20
          APPEND    OPDATIME,KEY20
          APPEND    SP70,KEY20
          RESET     KEY20
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",KEY20,"#",":               * 1
                             "#"",OPCYUNIQ,"#",":            * 2
                             "#"",OPCYITEM,"#",":            * 3
                             "#"",MDESC,"#",":               * 4
                             "#"",OPCYQUAN,"#",":            * 5
                             "#"",SP1,"#",":                 * 6
                             "#"",MPATPOR,"#",":             * 7
                             "#"",MHFPOR,"#",":              * 8
                             "#"",DIM8,"#",":                * 9
			     "#"",TWO,"#");"                 * 10
           GOTO      DCIT1000

.
DCIT9999  RETURN
+
.******************************************************************************
.                 Display Invoiced items
.******************************************************************************
IITM0000  PACK      KEY22,ADMISSNO,SP20
          CALL      RDSDTRN1
IITM1000  CALL      RDKDTRN1
          BRANCH    OVRCD,IITM9000          * no (more) details for admission
.
          MATCH     TADMNO,AADMNO
          GOTO      IITM9000 IF NOT EQUAL   * different admission
.
          COMPARE   TWO,TRECTYPE
          GOTO      IITM2000 IF EQUAL
          COMPARE   THREE,TRECTYPE
          GOTO      IITM1000 IF NOT EQUAL   * Misc.Item
.
IITM2000  MATCH     "1",PTDTCRST
          GOTO      IITM1000 IF EQUAL        * Credit note
          MATCH     "2",PTDTCRST
          GOTO      IITM1000 IF EQUAL        * Credit note
          PACK      KEY10,PTDTUNIQ,SP70      * Re read original oprdetaf record
          CALL      RDOPDEA3
          BRANCH    OVRCD,IITM1000
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          BRANCH    SORTFLAG,IITM4000
          WRITE     HTMLFILE;"<tr>":
                             "<td>",DISPDATE," at ",OPDATIME,"</td>":
                             "<td>&nbsp;",OPDAUNIQ,"</td>":
                             "<td>":
                             TITEMNO,"</td><td>":
                             TDDESC,"</td><td>":
                             TSERVS,"</td><td align=right>":
                             TREF,"</td><td align=right>":
                             TPATAMTP,"</td><td align=right>":
                             TREBATE,"</td></tr>";
          GOTO      IITM1000
.
IITM4000  CLEAR     KEY20
          APPEND    DISPDATE,KEY20
          APPEND    " at ",KEY20
          APPEND    OPDATIME,KEY20
          APPEND    SP70,KEY20
          RESET     KEY20
          WRITE     HTMLFILE;"t1.addRow(#"",KEY20,"#",":
                             "#"",OPDAUNIQ,"#",":               * 1
                             "#"",TITEMNO,"#",":
                             "#"",TDDESC,"#",":
                             "#"",TSERVS,"#",":
                             "#"",TREF,"#",":
                             "#"",TPATAMTP,"#",":
                             "#"",TREBATE,"#");"
          GOTO      IITM1000
.
IITM9000  PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
.
IITM9999  RETURN
+
.******************************************************************************
.*        Get MBS Details (patmmbsf); for a corresponding pmsmtiaf record     *
.******************************************************************************
GMBSDT00  MOVE      SP70,DISPDATE
          MOVE      SP70,STRTSTRN
          MOVE      SP70,ENDTSTRN
.
          PACK      KEY20,PMMIITEM,PMMIVISN,SP70
          CALL      RDSMMBS2
GMBSDT10  CALL      RDKMMBS2
          BRANCH    OVRCD,GMBSDT99
.
          MATCH     MMCODE,PMMIITEM         * Matching MBS Code?
          GOTO      GMBSDT99 IF NOT EQUAL
.
          MATCH     DMMADMN,PMMIVISN        * Matching Visit?
          GOTO      GMBSDT99 IF NOT EQUAL
.
          MATCH     PTMMOPID,PMMIUNIQ       * Matching Theatre Unique ID?
          GOTO      GMBSDT10 IF NOT EQUAL
.
          UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      MMSTIM,STRTSTRN
          MOVE      MMETIM,ENDTSTRN
.
GMBSDT99  RETURN
+
.******************************************************************************
.*                Display Routine for Items Details for Oncology              *
.******************************************************************************
TABONC00  MOVE      ZERO,DTRNFLAG
          MOVE      ADMISSNO,PMMIVISN
          PACK      KEY15,PMMIVISN,SP20
          CALL      RSPMMTI2
TABONC10  CALL      RKPMMTI2
          BRANCH    OVRCD,TABONC20          * no (more) details for admission
.
          MATCH     PMMIVISN,ADMISSNO       * get admission number as form
          GOTO      TABONC20 IF NOT EQUAL   * different admission
.
          MATCH     "2",PMMIRTYP
          GOTO      TABONC40 IF EQUAL       * Theatre
          MATCH     "3",PMMIRTYP
          GOTO      TABONC10 IF NOT EQUAL   * Misc.Item
          GOTO      TABONC40
.
.         Check invoiced items
.
TABONC20  MOVE      ONE,DTRNFLAG
          MOVE      ADMISSNO,PMMIVISN
          MOVE      "2",KEY1
          PACK      KEY18,ADMISSNO,KEY1,SP20
          CALL      RDSDTRN3
TABONC30  CALL      RDKDTRN3
          BRANCH    OVRCD,TABONC50          * no (more) details for admission
.
          MATCH     DTADMNO,ADMISSNO        * get admission number as form
          GOTO      TABONC50 IF NOT EQUAL   * different admission
.
          MATCH     "2",DTRECTYP
          GOTO      TABONC32 IF EQUAL       * Theatre
          MATCH     "3",DTRECTYP
          GOTO      TABONC30 IF NOT EQUAL   * Misc.I
.
TABONC32  MOVE      PTDTUNIQ,PMMIUNIQ
          MOVE      DTRECTYP,PMMIRTYP
          MOVE      TTRANSN1,PMMITRAN
          MOVE      TITEMNO,PMMIITEM
          PACK      PMMIDESC,TDDESC,SP70
.
TABONC40  CALL      GMBSDT00
.
          IF        DTRNFLAG=1
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/BlankIcon.gif class=Icon>";
.
          ELSE
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif class=Icon ";
.
            WRITE     HTMLFILE;"onclick=#"UpdateLink('":
                               PMMIUNIQ,"','":
                               PMMIVISN,"','":
                               PMMIRTYP,"','",PMMITRAN,"');#">";
          ENDIF
.
          WRITE     HTMLFILE;PMMIITEM,"</td>":
                               "<td>",PMMIDESC,"</td>":
                               "<td>",DISPDATE,"</td>":
                               "<td>",STRTSTRN,"</td>":
                               "<td>",ENDTSTRN,"</td>":
                               "<td>&nbsp;</td>":
                             "</tr>";
.
          BRANCH    DTRNFLAG,TABONC30
          GOTO      TABONC10
.
.         Checking Linked admission number from Booking/Unique Id table
.
TABONC50  MOVE      ZERO,DTRNFLAG
          PACK      KEY18,ADMISSNO,SP70
          CALL      RSBKUNQ1                * Check for record
          CALL      RKBKUNQ1
          BRANCH    OVRCD,TABONC60
.
          MATCH     ADMISSNO,BKUNVISN
          GOTO      TABONC60 IF NOT EQUAL
.
          MATCH     SP70,BKUNLADM           * Linked Admission Number?
          GOTO      TABONC60 IF EQUAL       * No; skip read of pmsmtiaf
.
          PACK      KEY15,BKUNLADM,SP20
          CALL      RSPMMTI2
TABONC51  CALL      RKPMMTI2
          BRANCH    OVRCD,TABONC54          * no (more) details for admission
.
          MATCH     PMMIVISN,BKUNLADM       * get admission number as form
          GOTO      TABONC54 IF NOT EQUAL   * different admission
.
          MATCH     "2",PMMIRTYP
          GOTO      TABONC58 IF EQUAL       * Theatre
          MATCH     "3",PMMIRTYP
          GOTO      TABONC51 IF NOT EQUAL   * Misc.Item
          GOTO      TABONC58
.
.         Check invoiced items
.
TABONC54  MOVE      ONE,DTRNFLAG
          MOVE      "2",KEY1
          PACK      KEY18,BKUNLADM,KEY1,SP20
          CALL      RDSDTRN3
TABONC56  CALL      RDKDTRN3
          BRANCH    OVRCD,TABONC60          * no (more) details for admission
.
          MATCH     DTADMNO,BKUNLADM        * get admission number as form
          GOTO      TABONC60 IF NOT EQUAL   * different admission
.
          MATCH     "2",DTRECTYP
          GOTO      TABONC57 IF EQUAL       * Theatre
          MATCH     "3",DTRECTYP
          GOTO      TABONC56 IF NOT EQUAL   * Misc.Item
.
TABONC57  MOVE      PTDTUNIQ,PMMIUNIQ
          MOVE      DTRECTYP,PMMIRTYP
          MOVE      TTRANSN1,PMMITRAN
          MOVE      TITEMNO,PMMIITEM
          PACK      PMMIDESC,TDDESC,SP70
.
TABONC58  CALL      GMBSDT00
          IF        DTRNFLAG=1
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/BlankIcon.gif class=Icon>";
          ELSE
            WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif class=Icon ";
.
            WRITE     HTMLFILE;"onclick=#"UpdateLink('":
                               PMMIUNIQ,"','":
                               ADMISSNO,"','":
                               PMMIRTYP,"','",PMMITRAN,"');#">";
          ENDIF
.
          WRITE      HTMLFILE;PMMIITEM,"</td>":
                               "<td>",PMMIDESC,"</td>":
                               "<td>",DISPDATE,"</td>":
                               "<td>",STRTSTRN,"</td>":
                               "<td>",ENDTSTRN,"</td>":
                               "<td>",BKUNLADM,"</td>":
                             "</tr>";
.
          BRANCH    DTRNFLAG,TABONC56
          GOTO      TABONC51
.
TABONC60  MATCH     "1",SHOWPROV
          GOTO      TABONC99 IF NOT EQUAL    * Not displaying prov.MBS items
.
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
TABONC70  CALL      RKPTRGM1
          BRANCH    OVRCD,TABONC99
.
          MATCH     ADMISSNO,PTRGADMN        * Same admission?
          GOTO      TABONC99 IF NOT EQUAL
.
          PACK      KEY13,PTRGREGM,SP70
          CALL      RSPMREG1
TABONC80  CALL      RKPMREG1
          BRANCH    OVRCD,TABONC70
.
          MATCH     PTRGREGM,PMREREGM        * Same Regime code?
          GOTO      TABONC70 IF NOT EQUAL
.
          MATCH     "1",PMREITYP
          GOTO      TABONC84 IF EQUAL        * Misc.Item
          MATCH     "3",PMREITYP
          GOTO      TABONC80 IF NOT EQUAL    * Not MBS
.
TABONC84  WRITE     HTMLFILE;"<tr><td>":
                               "<img src=../images/DietIconTrans.gif ":
                               "class=ListIcon>":
                               PMREITMN,"</td>":
                               "<td>",PMREDESC,"</td></tr>";
          GOTO      TABONC80
.
TABONC99  RETURN
+
.******************************************************************************
.*                  Expensive Item Display                                    *
.******************************************************************************
EPIT0000  BRANCH    FLDITMNO,EPIT0100,EPIT0200,EPIT0300,EPIT0400,EPIT0500:
                             EPIT0600,EPIT0700
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      EPIT9999
.
EPIT0100  WRITE     HTMLFILE;TEAMNUMB;      * Item Number
.          WRITE     HTMLFILE;OPPETMNO;      * Item Number
          GOTO      EPIT9999
.
EPIT0200  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,EPIT0210
          PACK      KEY6,OPPECODE,SP70
          CALL      RDOPEXP1
          BRANCH    OVRCD,EPIT9999
          WRITE     HTMLFILE;OPEXDESC;
          GOTO      EPIT9999
.
EPIT0210  WRITE     HTMLFILE;OPPECODE;      * Expensive Code
          GOTO      EPIT9999
.
EPIT0300  WRITE     HTMLFILE;OPPECNTR;      * Counter
          GOTO      EPIT9999
.
EPIT0400  WRITE     HTMLFILE;OPPEQUAN;      * Quantity
          GOTO      EPIT9999
.
EPIT0500  CALL      EXPTAB00                * Expensive item Table  
          GOTO      EPIT9999
.
EPIT0600  MOVE      "0",KEY1
          MATCH     "1",OPPECHRG
          IF        @EQUAL
            MOVE      "1",KEY1
          ENDIF
          WRITE     HTMLFILE;KEY1;      * No Charge
          GOTO      EPIT9999
.
EPIT0700  MOVE      "0",KEY1
          MATCH     "1",OPPEBROK
          IF        @EQUAL
            MOVE      "1",KEY1
          ENDIF
          WRITE     HTMLFILE;KEY1;      * Broken/Unused
          GOTO      EPIT9999
.
EPIT9999  RETURN
.******************************************************************************
.*                  Expensive Item Table 
.******************************************************************************
EXPTAB00  PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPEI1                 * Theatre System Patient Expensive
EXPTAB10  CALL      RKOPPEI1                 * Item Table 
          BRANCH    OVRCD,EXPTAB99
.
          MATCH     OPDAUNIQ,OPPEUNID
          GOTO      EXPTAB99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPPETMNO
          GOTO      EXPTAB99 IF NOT EQUAL
          PACK      KEY6,OPPECODE,SP70
          CALL      RDOPEXP1                * Theatre Expensive Item Table
          IF        OVRCD=1
            MOVE      "Invalid",OPEXDESC
          ENDIF          
.
          RESET     CASEKEYS
          RESET     TEAMNUMB
.
          MOVE      "No ",KEY3
          MATCH     "1",OPPECHRG
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
.
          MOVE      "No ",D3
          MATCH     "1",OPPEBROK
          IF        @EQUAL
            MOVE      "Yes",D3
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/EditIcon.gif class=Icon ":
                             "onclick=#"UpdateLink('":
                             OPPECODE,"','",OPPECNTR,"');#">":
                             OPPECODE,"</td><td>":
                             OPEXDESC,"</td><td>":
                             OPPEQUAN,"</td><td>":
                             KEY3,"</td><td>":
                             D3,"</td></tr>";
.
          GOTO    EXPTAB10          
.
EXPTAB99  RETURN
*****************************************************************************
.*               Main Routine For Theatre Implant Maintenance                 *
.******************************************************************************
THMP0000  BRANCH    FLDITMNO,THMP0100,THMP0200,THMP0300,THMP0400:
                             THMP0500,THMP0600,THMP0700,THMP0800:
                             THMP0900,THMP1000,THMP1100,THMP1200:
                             THMP1300,THMP1400,THMP1500,THMP1600:
                             THMP1700,THMP1800,THMP1900,THMP2000:
                             THMP2100,THMP2200,THMP2300,THMP2400:
                             THMP2500
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      THMP9999
.
THMP0100  WRITE     HTMLFILE;OPTICODE;      * Implant Code/EAN Number
          GOTO      THMP9999           
.
THMP0200  WRITE     HTMLFILE;OPTIDESC;      * Impant Description
          GOTO      THMP9999
.
THMP0300  MOVE      "OW",CATEGORY           * Type Of Implant
          MOVE      OPTITYIM,CODE
          CALL      CODITM00
          GOTO      THMP9999
.
THMP0400  
          GOTO      THMP9999
.
THMP0500  WRITE     HTMLFILE;OPTIMCHG;
          GOTO      THMP9999
.
THMP0600  MATCH     SP70,OPTIMCHG
          GOTO      THMP9999 IF EQUAL
.
          IF        IBCNMHOS=1
            MOVE      SP10,KEY3
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,THMP9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ENDIF
THMP0610  CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      THMP0650 IF EQUAL
.
THMP0630  IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,THMP9999
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
            GOTO      THMP0610
          ENDIF
          GOTO      THMP9999
.
THMP0650  WRITE     HTMLFILE;MDESC;
          GOTO      THMP9999
.
THMP0700  WRITE     HTMLFILE;OPTIMANU;      * Manufacture
          GOTO      THMP9999
.
THMP0800  WRITE     HTMLFILE;OPTISIZE;      * Size
          GOTO      THMP9999
.
THMP0900  WRITE     HTMLFILE;OPTISUPP;      * Supplier Name
          GOTO      THMP9999
.
THMP1000  MOVE      SP70,IMPCOST
          MOVE      OPTICOST,IMPCOST        * Cost
          SQUEEZE   IMPCOST
          WRITE     HTMLFILE;IMPCOST;
          GOTO      THMP9999
.
THMP1100  WRITE     HTMLFILE;OPTICOPC;      * Commonwealth Prosthetic Code
          GOTO      THMP9999
.
THMP1200  MOVE      ZERO,LNK2PRT
          CALL      IMPTAB00                * Call For Implant Code Talbe
          GOTO      THMP9999
.
THMP1300  CALL      NEXT0000                * Next Set Of Implant Code
          GOTO      THMP9999          
.
THMP1400  CALL      PREV0000                * Previous Set Of Implant Code
          GOTO      THMP9999
.
THMP1500  WRITE     HTMLFILE;OPTISTAT;      * Status
          GOTO      THMP9999
.
THMP1600  MOVE      ONE,LNK2PRT             * Implant Search By Code
          CALL      IMPTAB00                * Call For Implant Code Talbe
          GOTO      THMP9999
.
THMP1700  WRITE     HTMLFILE;STARTKEY;      
          GOTO      THMP9999
.
THMP1800  WRITE     HTMLFILE;NORECORD;     
          GOTO      THMP9999
.
THMP1900  WRITE     HTMLFILE;OPTIREGI;     
          GOTO      THMP9999
.
THMP2000  MOVE      ONE,LNK2PRT             * Implant Search By Description
          CALL      IMPTBD00                * Call For Implant Code Talbe
          GOTO      THMP9999
.
THMP2100  WRITE     HTMLFILE;OPTIBCOD;      * Barcode
          GOTO      THMP9999
.
THMP2200  MOVE      ONE,LNK2PRT             * Implant Search By Code
          CALL      IMPBAR00                * Call For Implant Barcode
          GOTO      THMP9999
.
THMP2300  MOVE      ONE,LNK2PRT             * Implant Search By Description
          CALL      IMPBRD00                * Call For Implant Barcode
          GOTO      THMP9999
.
THMP2400  CALL      ADHOC000                * List of Ad-hoc implants
          GOTO      THMP9999
.
THMP2500  MOVE      TWO,LNK2PRT             * Implant Search By EAN/Barcode
          CALL      IMPTAB00                * Call For Implant Code Table
          GOTO      THMP9999
.
THMP9999  RETURN
.******************************************************************************
.*                      Display Of Implant Code Table By Code                 *
.******************************************************************************
IMPTAB00  IF        LNK2PRT=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            CALL      IMPHED00              * table header (no table sort)
          ENDIF
          IF        LNK2PRT=2
            CALL      IMPHED00              * table header (no table sort)
          ENDIF
.
          IF        NORECORD=0
            MOVE    PTCNNRTD,NORECORD        * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY75,STARTKEY,SP70
          CALL      RSOPTHI1
          IF        OVRCD=0
            CALL      RPOPTHI1              * Reading From Implant Code File
          ENDIF
IMPTAB10  CALL      RKOPTHI1
          BRANCH    OVRCD,IMPTAB90
.
          MOVE      "OW",CATEGORY           * Reading For Departments
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
          MATCH     "1",OPTISTAT            * Is Implant Inactive?
          IF        @EQUAL
            MOVE      "No",STATDESC         * No (1 = Inactive)
          ELSE
            MOVE      "Yes",STATDESC        * Yes (SPACE or 0 = Active)
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      IMPTAB10
          ENDIF
.
          CALL      IMPROW00                * Implant Table Maintenance Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      IMPTAB10 IF NOT EQUAL
          GOTO      IMPTAB99
.
IMPTAB90  CALL      NOMORE00      * Display No More Records Message
.
IMPTAB99  RETURN
.
.******************************************************************************
.*                      Display Of Implant Code Table By Barcode              *
.******************************************************************************
IMPBAR00  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          IF        NORECORD=0
            MOVE    "13",NORECORD           * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY75,STARTKEY,SP70
          CALL      RSOPTHI3
          IF        OVRCD=0
            CALL      RPOPTHI3              * Reading From Implant Code File
          ENDIF
IMPBAR10  CALL      RKOPTHI3
          BRANCH    OVRCD,IMPBAR99
.
          MOVE      "OW",CATEGORY           * Reading For Departments
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
          MATCH     "1",OPTISTAT            * Is Implant Inactive?
          IF        @EQUAL
            MOVE      "No",STATDESC         * No (1 = Inactive)
          ELSE
            MOVE      "Yes",STATDESC        * Yes (SPACE or 0 = Active)
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      IMPBAR10
          ENDIF
.
          CALL      BARROW00                * Implant Barcode Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      IMPBAR10 IF NOT EQUAL
.
IMPBAR99  RETURN
+
.******************************************************************************
.*                      Display Of Implant Code Table By Description          *
.******************************************************************************
IMPTBD00  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          IF        NORECORD=0
            MOVE    "13",NORECORD           * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY75,STARTKEY,SP70
          CALL      RDOPTHI2
          COMPARE   ZERO,OVRCD
          GOTO      IMPTBD12 IF EQUAL
.
IMPTBD10  CALL      RKOPTHI2
          BRANCH    OVRCD,IMPTBD99
.
IMPTBD12  MOVE      "OW",CATEGORY           * Reading For Departments
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
          MATCH     "1",OPTISTAT            * Is Implant Inactive?
          IF        @EQUAL
            MOVE      "No",STATDESC         * No (1 = Inactive)
          ELSE
            MOVE      "Yes",STATDESC        * Yes (SPACE or 0 = Active)
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      IMPTBD10
          ENDIF
.
          CALL      IMPROW00                * Implant Table Maintenance Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      IMPTBD10 IF NOT EQUAL
.
IMPTBD99  RETURN
.
.******************************************************************************
.*                      Display Of Implant Barcode Table By Description       *
.******************************************************************************
IMPBRD00  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          IF        NORECORD=0
            MOVE    "13",NORECORD           * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY75,STARTKEY,SP70
          CALL      RDOPTHI2
          COMPARE   ZERO,OVRCD
          GOTO      IMPBRD12 IF EQUAL
.
IMPBRD10  CALL      RKOPTHI2
          BRANCH    OVRCD,IMPBRD99
.
IMPBRD12  MOVE      "OW",CATEGORY           * Reading For Departments
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
          MATCH     "1",OPTISTAT            * Is Implant Inactive?
          IF        @EQUAL
            MOVE      "No",STATDESC         * No (1 = Inactive)
          ELSE
            MOVE      "Yes",STATDESC        * Yes (SPACE or 0 = Active)
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      IMPBRD10
          ENDIF
.
          CALL      BARROW00                * Implant Barcode Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      IMPBRD10 IF NOT EQUAL
.
IMPBRD99  RETURN
+
.******************************************************************************
.*                     Implant Code Maintenance (TABLE HEADER)                *
.******************************************************************************
IMPHED00  MATCH     "1",OPCNSIVB
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>EAN Number</td>":
                               "<td class=HeadingCell>Barcode</td>";
          ELSE
            WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>EAN Number</td>";
          ENDIF
          WRITE     HTMLFILE;"<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Type of Implant</td>":
                             "<td class=HeadingCell>Miscellaneous Charge</td>":
                             "<td class=HeadingCell>Active</td>":
                             "</tr>"
IMPHED99  RETURN
+
.******************************************************************************
.*                     Implant Code Maintenance (TABLE ROW)                   *
.******************************************************************************
IMPROW00  BRANCH    LNK2PRT,IMPROW10
.
IMPROW01  MATCH     SP70,OPTIMCHG
          GOTO      IMPROW04 IF EQUAL
.
          IF        IBCNMHOS=1
            MOVE      SP10,KEY3
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,IMPROW04
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ENDIF
IMPROW02  CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      IMPROW05 IF EQUAL
.
IMPROW03  IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,IMPROW04
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
            GOTO      IMPROW02
          ENDIF
          GOTO      IMPROW04
.
IMPROW04  MOVE      SP70,MDESC
.
IMPROW05  MATCH     SP70,OPTIMCHG
          IF        @EQUAL
            MOVE      SP70,MCDESD45
            GOTO      IMPROW06
          ENDIF
.
          CLEAR     MCDESD45
          APPEND    OPTIMCHG,MCDESD45
          APPEND    SHYPHENS,MCDESD45
          APPEND    MDESC,MCDESD45
          RESET     MCDESD45
.
IMPROW06  COMPARE   TWO,LNK2PRT
          GOTO      IMPROW20 IF EQUAL       * EAN/Barcode list
.
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon onclick='ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&opthi001=",OPTICODE:
                             "&opthi012=",OPTIBCOD,"#")'>":
                             "&nbsp;",OPTICODE,"</td>";
          MATCH     "1",OPCNSIVB
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>","&nbsp;",OPTIBCOD,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>","&nbsp;",OPTIDESC,"</td>":
                             "<td>","&nbsp;",TDESC,"</td>":
                             "<td>","&nbsp;",MCDESD45,"</td>":        
                             "<td>","&nbsp;",STATDESC,"</td>":
                             "</tr>"
          GOTO      IMPROW99
.             
IMPROW10  REP       "#" #' ",OPTICODE
          REP       "#" #' ",OPTIDESC
          REP       "#" #' ",TDESC
          REP       "#" #' ",STATDESC
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon onclick='updateParent":
                             "(#"",OPTICODE,"#",#"",OPTIDESC,"#")'>":
                             "&nbsp;",OPTICODE,"</td>":
                             "<td>","&nbsp;",OPTIDESC,"</td>":
                             "<td>","&nbsp;",TDESC,"</td>":
                             "<td>","&nbsp;",STATDESC,"</td>":
                             "</tr>"
          GOTO      IMPROW99
.
IMPROW20  REP       "#" #' ",OPTICODE
          REP       "#" #' ",OPTIBCOD
          REP       "#" #' ",OPTIDESC
          REP       "#" #' ",TDESC
          REP       "#" #' ",MCDESD45
          REP       "#" #' ",STATDESC
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon onclick='updateParent":
                             "(#"",OPTICODE,"#",#"",OPTIBCOD,"#")'>":
                             "&nbsp;",OPTICODE,"</td>":
                             "<td>","&nbsp;",OPTIBCOD,"</td>":
                             "<td>","&nbsp;",OPTIDESC,"</td>":
                             "<td>","&nbsp;",TDESC,"</td>":
                             "<td>","&nbsp;",MCDESD45,"</td>":
                             "<td>","&nbsp;",STATDESC,"</td>":
                             "</tr>"
          GOTO      IMPROW99
.
IMPROW99  RETURN
+
.******************************************************************************
.*                     Implant Barcode Maintenance (TABLE ROW)                *
.******************************************************************************
BARROW00  BRANCH    LNK2PRT,BARROW10
.
BARROW01  MATCH     SP70,OPTIMCHG
          GOTO      BARROW04 IF EQUAL
.
          IF        IBCNMHOS=1
            MOVE      SP10,KEY3
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,BARROW04
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
          ENDIF
BARROW02  CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      BARROW05 IF EQUAL
.
BARROW03  IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,BARROW04
            PACK      KEY29,PTHSDCLM,SP6,SP3,OPTIMCHG,CURRDATE,SP10
            GOTO      BARROW02
          ENDIF
          GOTO      BARROW04
.
BARROW04  MOVE      SP70,MDESC
.
BARROW05  MATCH     SP70,OPTIMCHG
          IF        @EQUAL
            MOVE      SP70,MCDESD45
            GOTO      BARROW06
          ENDIF
.
          CLEAR     MCDESD45
          APPEND    OPTIMCHG,MCDESD45
          APPEND    SHYPHENS,MCDESD45
          APPEND    MDESC,MCDESD45
          RESET     MCDESD45
.
BARROW06  WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon onclick='ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&opthi001=",OPTICODE:
                             "&opthi012=",OPTIBCOD,"#")'>":
                             "&nbsp;",OPTIBCOD,"</td>":
                             "<td>","&nbsp;",OPTIDESC,"</td>":
                             "<td>","&nbsp;",TDESC,"</td>":
                             "<td>","&nbsp;",MCDESD45,"</td>":
                             "<td>","&nbsp;",STATDESC,"</td>":
                             "</tr>"
          GOTO      BARROW99
.
BARROW10  REP       "#" #' ",OPTIBCOD
          REP       "#" #' ",OPTICODE
          REP       "#" #' ",OPTIDESC
          REP       "#" #' ",TDESC
          REP       "#" #' ",STATDESC
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon onclick='updateParent":
                             "(#"",OPTICODE,"#",#"",OPTIBCOD,"#")'>":
                             "&nbsp;",OPTIBCOD,"</td>":
                             "<td>","&nbsp;",OPTICODE,"</td>":
                             "<td>","&nbsp;",OPTIDESC,"</td>":
                             "<td>","&nbsp;",TDESC,"</td>":
                             "<td>","&nbsp;",STATDESC,"</td>":
                             "</tr>"
          GOTO      BARROW99
.
BARROW99  RETURN
+
.******************************************************************************
.*        List of Ad-hoc Implants                                             *
.******************************************************************************
ADHOC000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      SP70,CURRBCOD
          MOVE      SP70,CURRIMPL
          MOVE      "1",DIM1A                * Flag for Ad-hoc implant
          PACK      KEY76,DIM1A,SP70
          CALL      RSOPTHI4
ADHOC100  CALL      RKOPTHI4
          BRANCH    OVRCD,ADHOC999
.
          MATCH     DIM1A,OPTIAIMP
          GOTO      ADHOC999 IF NOT EQUAL    * Not an Ad-hoc implant anymore
.
          MOVE      OPTIBCOD,CURRBCOD        * save the barcode
          MOVE      OPTICODE,CURRIMPL        * save the Implant code
.
.         Get patients with the barcode
.
          MOVE      SP70,SAVUNQID           * Save unique ID
          PACK      KEY73,CURRBCOD,SP70
          CALL      RSOPPIM3
ADHOC400  CALL      RKOPPIM3
          BRANCH    OVRCD,ADHOC100
.
          MATCH     CURRBCOD,OPPIBCOD       * Same barcode ?
          GOTO      ADHOC100 IF NOT EQUAL
          MATCH     CURRIMPL,OPPIICDE       * Same implant ?
          GOTO      ADHOC100 IF NOT EQUAL
.
          MATCH     SAVUNQID,OPPIUNID       * Same uniq id ?
          GOTO      ADHOC400 IF EQUAL       * skip record with same Uniq ID
.
          MOVE      OPPIUNID,SAVUNQID       * save the Uniq Id
          PACK      KEY10,SAVUNQID,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,ADHOC400
.
          COMPARE   THREE,OPDASTAT
          GOTO      ADHOC400 IF EQUAL       * Cancelled
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,ADHOC400
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,ADHOC400
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ADHOC400
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADHOC400
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      "010",PATFLDER
          CALL      PATFLD00
          MOVE      KEY3,PATFLDER
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          CALL      PATNAM00
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
.
          IF        PTCNHDPS<>9
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
              GOTO      ADHOC400 IF NOT EQUAL
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:VisitLink('",HTMLLINK
          APPEND    OPDAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPDAADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK5
          APPEND    "javascript:AdhocLink('",HTMLLNK5
          APPEND    OPPIUNID,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    OPPIBCOD,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    OPPITMNO,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    OPPICNTR,HTMLLNK5
          APPEND    "')",HTMLLNK5
          RESET     HTMLLNK5
.
          CALL      PATNAM00
          CALL      GDOC0000                * Get doctor name
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",PATFNAME,"#",":            * 1
                               "#"",PATFLDER,"#",";            * 2
.
          CALL      ASSG0000                * Check for assigned prosthetic?
          BRANCH    EXIT,ADHOC600
.
          REP       " +",OPDAURNO
          REP       " +",OPDAADMN
          WRITE     HTMLFILE;"#"","<img src=../images/DocumentIcon.gif":
                           " onclick=ProsLink('",OPDAURNO,"','",OPDAADMN,"');>";
          REP       "+ ",OPDAURNO
          REP       "+ ",OPDAADMN
          WRITE     HTMLFILE;OPDAADMN,"#",";                   * 3
          GOTO      ADHOC800
.
ADHOC600  WRITE     HTMLFILE;"#"",OPDAADMN,"#",";              * 3
.
ADHOC800  UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          PACK      KEY76,OPPIBCOD,SP1,OPPIICDE,SP70
          WRITE     HTMLFILE;"#"",OPDAUNIQ,"#",":                    * 4
                             "#"",KEY30,"#",":                       * 5
                             "#"",DISPDATE,"#",":                    * 6
                             "#"",OPDAEXPS,"#",":                    * 7
                             "#"",SP1,"#",":                         * 8
                             "#"",HTMLLNK5,"#",":                    * 9
                             "#"",KEY76,"#");"                       * 10
.
          GOTO      ADHOC400                 * get next barcode
.
ADHOC999  RETURN
+
.*****************************************************************************
.         Get Doctor name
.*****************************************************************************
GDOC0000  MOVE      SP70,KEY30
          COMPARE   ZERO,OPCNCLSU
          GOTO      GDOC2000 IF NOT EQUAL   * Checking For The CLinic Status
.
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,GDOC9999
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY30        * For Displaying Clinic Descrition
            MOVE      OPCLDESC,SURGNAME     * For Displaying Clinic Descrition
            GOTO      GDOC9999
          ELSE
            PACK        KEY6,OPCLDOCT,SP70
            GOTO        GDOC2200
          ENDIF
.
GDOC2000  PACK      KEY6,OPDACLIN,SP70
GDOC2200  CALL      RDDOCT1
          BRANCH    OVRCD,GDOC9999
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME

GDOC9999  RETURN
+
.*****************************************************************************
.         Check for assigned prosthetic item
.*****************************************************************************
ASSG0000  PACK      KEY73,OPPIBCOD,OPPIUNID,OPPITMNO,OPPICNTR   * save the key
          PACK      KEY10,OPPIUNID,SP70
.
          PACK      KEY13,KEY10,SP70
          CALL      RSOPPIM1
ASSG1000  CALL      RKOPPIM1
          BRANCH    OVRCD,ASSG8000
          MATCH     KEY10,OPPIUNID
          GOTO      ASSG8000 IF NOT EQUAL        * Different Uniq id
.
.         Check for assigned items
.
          MATCH     "1",OPPIAIMP
          GOTO      ASSG1000 IF EQUAL            * Ad-hoc item
.
ASSG2000  MOVE      ZERO,EXIT
          GOTO      ASSG9000
.
ASSG8000  MOVE      ONE,EXIT                     * No other existing pros.item
.
ASSG9000  CALL      RDOPPIM3                     * reposition to original record
ASSG9999  RETURN
+
.*****************************************************************************
.* Patient Recovery List                                                     *
.*****************************************************************************
OPRC0000  BRANCH    FLDITMNO,OPRC0100,OPRC0200,OPRC0300,OPRC0400,OPRC0500:
                             OPRC0600,OPRC0700,OPRC0800,OPRC0900,OPRC1000:
                             OPRC1100,OPRC1200,OPRC1300,OPRC1400,OPRC1500:
                             OPRC1600,OPRC1700,OPRC1800,OPRC1900,OPRC2000
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPRC9999
.
OPRC0100  CALL      NXTREC00
          GOTO      OPRC9999
.
OPRC0200  CALL      PRVREC00
          GOTO      OPRC9999
.
OPRC0300  CALL      CURSTD00
          GOTO      OPRC9999
.
OPRC0400  CALL      CUREND00
          GOTO      OPRC9999
.
OPRC0500  CALL      CURYR000
          GOTO      OPRC9999
.
OPRC0600  CALL      CURMON00
          GOTO      OPRC9999
.
OPRC0700  CALL      SELV0000
          GOTO      OPRC9999
.
OPRC0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      OPRC9999
.
OPRC0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      OPRC9999
.
OPRC1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      OPRC9999
.
OPRC1100  CALL      RECLST00
          GOTO      OPRC9999
.
OPRC1200  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      OPRC9999
.
OPRC1300  MOVE      "YD",CATEGORY
          MOVE      SURGTYPE,CODE
          CALL      CODITM00
          GOTO      OPRC9999
.
OPRC1400  WRITE     HTMLFILE;RECOVFUL;
          GOTO      OPRC9999
.
OPRC1500  WRITE     HTMLFILE;EXTTODAY;
          GOTO      OPRC9999
.
OPRC1600  WRITE     HTMLFILE;NODRESSG;
          GOTO      OPRC9999
.
OPRC1700  MOVE      SURGTYPE,LOCATION
          CALL      RCLS0000           * Check if recovery is closed
          GOTO      OPRC9999
.
OPRC1800  WRITE     HTMLFILE;INCLEXIT;
          GOTO      OPRC9999
.
OPRC1900  WRITE     HTMLFILE;SHOWADMT;
          GOTO      OPRC9999
.
OPRC2000  WRITE     HTMLFILE;DLYRSNRC; *Trigger Delay in recovery?
          GOTO      OPRC9999
.
OPRC9999  RETURN
.******************************************************************************
. Recovery List
.******************************************************************************
RECLST00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY26,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPDEA1
RECLST10  CALL      RKOPDEA1
          BRANCH    OVRCD,RECLST99
.
          MATCH     WBSEHOSP,OPDAHOSP
          GOTO      RECLST99 IF NOT EQUAL
.
          MATCH     OPDADATE,LASTDATE
          GOTO      RECLST99 IF LESS
.
          COMPARE   THREE,OPDASTAT
          GOTO      RECLST10 IF EQUAL
.
          COMPARE   ONE,SHOWADMT            * Show all admitted
          IF        @EQUAL
            COMPARE   TWO,OPDASTAT          * Admitted only
            GOTO      RECLST10 IF NOT EQUAL
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            IF        OVRCD=1
              CALL      CLOPRARD            * Admitted only may not have 
            ENDIF                           * arrived
.
            PACK      KEY11,OPDAUNIQ,SP70
            CALL      RSOPSRG1
            CALL      RKOPSRG1
            IF        OVRCD=1
              CALL      CLOPRSRG            * Admitted only may not have
            ELSE                            * started surgery
              MATCH     OPSGUNID,OPDAUNIQ
              IF        !@EQUAL    
                CALL      CLOPRSRG
              ENDIF
            ENDIF
.
            GOTO      RECLST20
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,RECLST10
.
          PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          BRANCH    OVRCD,RECLST10
          MATCH     OPSGUNID,OPDAUNIQ
          GOTO      RECLST10 IF NOT EQUAL
.
          MATCH     "004",TEMPLATE
          IF        @EQUAL
            MATCH     SP70,OPSGTISE
            GOTO      RECLST20 IF NOT EQUAL
          ELSE
            MATCH     "1",OPSGUY05
            GOTO      RECLST20 IF EQUAL
. 
            MATCH     "1",NODRESSG *sjog don't collect dressing-set menu option
            GOTO      RECLST20 IF EQUAL
.
            MATCH     SP70,OPSGTIDR
            GOTO      RECLST20 IF NOT EQUAL
          ENDIF
          GOTO      RECLST10
.
RECLST20  MATCH     "1",EXTTODAY
          IF        !@EQUAL
            IF        INCLEXIT<>1
              MATCH     SP70,OPARTETC           * Exit theatre complex time
              GOTO      RECLST10 IF NOT EQUAL
            ENDIF
          ENDIF
.
RECLST21  MATCH     EXTIM002,OPDAUNIQ
          GOTO      RECLST22 IF NOT EQUAL
          MATCH     SP70,EXTIM001
          IF        !@EQUAL
            MOVE      EXTIM001,OPARTETC
            CALL      UPOPARD1
            MOVE      SP70,EXTIM001
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
RECLST22  MATCH     SP70,OPARTIDP           * Ready to depart time
          GOTO      RECLST25 IF NOT EQUAL
.
          MATCH     RDTIM002,OPDAUNIQ
          GOTO      RECLST25 IF NOT EQUAL
.
          MATCH     SP70,RDTIM001
          IF        !@EQUAL
            MOVE      RDTIM001,OPARTIDP
            CALL      UPOPARD1
            MOVE      SP70,RDTIM001
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
RECLST25  MOVE      OPARTIRF,KEY9
          MATCH     SP70,OPARTIRF
          IF        @EQUAL
            MOVE      OPARTIRD,KEY9
          ENDIF
          MATCH     SP70,OPDATHET
          GOTO      RECLST30 IF EQUAL
          MOVE      OPDATHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            MOVE      OPRMDESC,OPERROOM
          ELSE
            MOVE      "INVALID",OPERROOM
          ENDIF
.        
RECLST30  PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,RECLST10
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,RECLST10
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,RECLST10
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,RECLST10
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      "010",PATFLDER
          CALL      PATFLD00
          MOVE      KEY3,PATFLDER
.
          MOVE      SP70,KEY7
          MOVE      BKRXPOWD,KEY7
          MATCH     SP70,KEY7
          IF        @EQUAL
            MOVE      ABED,KEY7
            MATCH     SP70,KEY7
            IF        @EQUAL
              MOVE      AWARD,KEY7
            ELSE
              CLEAR     KEY7
              APPEND    AWARD,KEY7
              APPEND    "/",KEY7
              APPEND    ABED,KEY7
              RESET     KEY7
            ENDIF
          ELSE
            MOVE      BKRXPOBD,KEY7
            MATCH     SP70,KEY7
            IF        @EQUAL
              MOVE      BKRXPOWD,KEY7
            ELSE
              CLEAR     KEY7
              APPEND    BKRXPOWD,KEY7
              APPEND    "/",KEY7
              APPEND    BKRXPOBD,KEY7
              RESET     KEY7
            ENDIF
          ENDIF
.
          MOVE      SP70,OPDAWARD
          MOVE      OPDAPOWD,OPDAWARD
          MATCH     SP70,OPDAWARD
          IF        @EQUAL
            MOVE      ABED,OPDAWARD
            MATCH     SP70,OPDAWARD
            IF        @EQUAL
              MOVE      AWARD,OPDAWARD
            ELSE
              CLEAR     OPDAWARD
              APPEND    AWARD,OPDAWARD
              APPEND    "/",OPDAWARD
              APPEND    ABED,OPDAWARD
              RESET     OPDAWARD
            ENDIF
          ELSE
            MOVE      OPDAPOBD,OPDAWARD
            MATCH     SP70,OPDAWARD
            IF        @EQUAL
              MOVE      OPDAPOWD,OPDAWARD
            ELSE
              CLEAR     OPDAWARD
              APPEND    OPDAPOWD,OPDAWARD
              APPEND    "/",OPDAWARD
              APPEND    OPDAPOBD,OPDAWARD
              RESET     OPDAWARD
            ENDIF
          ENDIF
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          CALL      PATNAM00
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
.
.         IF        PTCNHDPS<>9
.           IF        IBCNMHOS=1
.             MATCH     WBSEHOSP,OPSEHOSP     * Check hospital with user
.             GOTO      RECLST10 IF NOT EQUAL
.           ENDIF
.         ENDIF
.
          MATCH     SP70,SURGTYPE                * Check Surgery Type Filter
          GOTO      RECLST40 IF EQUAL            * Blank, list all types
          MATCH     "ALL",SURGTYPE               * Check Surgery Type Filter
          GOTO      RECLST40 IF EQUAL            * List all types
          MATCH     OPSEDGSI,SURGTYPE            * Match Filter value
          GOTO      RECLST10 IF NOT EQUAL        * No match, get next record
.
RECLST40  CALL      SESDET00
.
          CLEAR     HTMLLINK
          APPEND    "javascript:CaseLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK4
          APPEND    "oprweb01.pbl?reportno=04&template=001&casekeys=",HTMLLNK4
          APPEND    CASEKEYS,HTMLLNK4
          RESET     HTMLLNK4
          REP       " +",HTMLLNK4
.
          PACK      HTMLLNK5,SP70,SP70,SP70
.
          MATCH     SP70,OPARTIDP
          IF        @EQUAL
            CLEAR     HTMLLNK5
            MATCH     "004",TEMPLATE
            IF        @EQUAL
              APPEND    "oprweb06.pbl?reportno=10&template=004",HTMLLNK5
              APPEND    "&nodressg=1&casekeys=",HTMLLNK5
            ELSE
              APPEND    "oprweb06.pbl?reportno=10&template=002",HTMLLNK5
              APPEND     "&nodressg=1&casekeys=",HTMLLNK5
            ENDIF
            APPEND    CASEKEYS,HTMLLNK5
            APPEND    "&viewtype=",HTMLLNK5
            APPEND    VIEWTYPE,HTMLLNK5
            APPEND    "&frstdate=",HTMLLNK5
            APPEND    FRSTDATE,HTMLLNK5
            APPEND    "&lastdate=",HTMLLNK5
            APPEND    LASTDATE,HTMLLNK5
            APPEND    "&rdtim001=",HTMLLNK5
            APPEND    CTIMEIS,HTMLLNK5
            APPEND    "&rdtim002=",HTMLLNK5
            APPEND    OPDAUNIQ,HTMLLNK5
            APPEND    "&urnumber=",HTMLLNK5
            APPEND    PURNO,HTMLLNK5
            APPEND    "&admissno=",HTMLLNK5
            APPEND    ADMISSNO,HTMLLNK5
            RESET     HTMLLNK5
            REP       " +",HTMLLNK5
            RESET     HTMLLNK5
          ENDIF
.
          MOVE      CASEKEYS,KEY22
          CLEAR     HTMLLNK6
          APPEND    "oprweb01.pbl?reportno=03&template=003&nodressg=1&sesskeys=",HTMLLNK6
          APPEND    KEY22,HTMLLNK6
          RESET     HTMLLNK6
          REP       " +",HTMLLNK6
          RESET     HTMLLNK6
.
.         MOVE      "010",PATFLDER
.
          MATCH     SP70,OPARTIDP
          IF        !@EQUAL  
            WRITE     HTMLFILE;"t.addRow(#"",PATFNAME,"#",":
                               "#"",PURNO,"#",":
                               "#"",OPERROOM,"#",":
                               "#"",SURFNAME,"#",":
                               "#"",KEY9,NBSPS888,OPARTIRB,"#",":
                               "#"",HTMLLINK,"#",":
                               "#"",OPARTIDP,"#",":
                               "#"",OPARTETC,"#",";
.
            MATCH     "004",TEMPLATE
            IF        @EQUAL
              MATCH     "1",DLYRSNRC
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","javascript:checkTimeDiff('",OPARTIDP;
                WRITE     HTMLFILE;"','",OPARTETC,"','";
                WRITE     HTMLFILE;"oprweb06.pbl?reportno=10&template=4&nodressg=1&";
              ELSE
                WRITE     HTMLFILE;"#"","oprweb06.pbl?reportno=10&template=004&nodressg=1&";
              ENDIF
            ELSE    
              MATCH     "1",DLYRSNRC
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","javascript:checkTimeDiff('",OPARTIDP;
                WRITE     HTMLFILE;"','",OPARTETC,"','";
                WRITE     HTMLFILE;"oprweb06.pbl?reportno=10&template=2&nodressg=1&";
              ELSE 
                WRITE     HTMLFILE;"#"","oprweb06.pbl?reportno=10&template=2&nodressg=1&";
              ENDIF
            ENDIF   
. 
            WRITE     HTMLFILE;"casekeys=",CASEKEYS:
                               "&viewtype=",VIEWTYPE:
                               "&frstdate=",FRSTDATE:
                               "&lastdate=",LASTDATE:
                               "&extim001=",CTIMEIS;
            MATCH     "1",DLYRSNRC
            IF        @EQUAL
              WRITE     HTMLFILE;"&extim002=",OPDAUNIQ,"')#",";
            ELSE
              WRITE     HTMLFILE;"&extim002=",OPDAUNIQ,"#",";
            ENDIF
            WRITE     HTMLFILE;"#"",KEY7,"#",":
                               "#"",OPARUT11,"#",":
                               "#"",PATFLDER,"#",":
                               "#"",HTMLLNK4,"#",":
                               "#"",HTMLLNK5,"#",":
                               "#"",HTMLLNK6,"#",":
                               "#"",KEY9,"#",";

          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",PATFNAME,"#",":
                               "#"",PURNO,"#",":
                               "#"",OPERROOM,"#",":
                               "#"",SURFNAME,"#",":
                               "#"",KEY9,NBSPS888,OPARTIRB,"#",":
                               "#"",HTMLLINK,"#",":
                               "#"",OPARTIDP,"#",":
                               "#"",OPARTETC,"#",":
                               "#"",SP70,"#",":
                               "#"",KEY7,"#",":
                               "#"",OPARUT11,"#",":
                               "#"",PATFLDER,"#",":
                               "#"",HTMLLNK4,"#",":
                               "#"",HTMLLNK5,"#",":
                               "#"",HTMLLNK6,"#",":
                               "#"",KEY9,"#",";

          ENDIF
.
          WRITE     HTMLFILE;"#"",OPARUT02,"#",":                    * 16
                             "#"",OPARUT02,OPARUT03,"#",";           * 17
.
          MOVE      "od",CATEGORY
          MOVE      OPARUC04,CODE
          CALL      GETCOD00                
.
          MATCH     SP70,TCINDC1
          IF        @EQUAL
            MOVE      "B",TCINDC1
          ENDIF
.
          WRITE     HTMLFILE;"#"",TCINDC1,"#",";                     * 18
.
          MOVE      "Ou",CATEGORY
          MOVE      OPARRDCD,CODE
          CALL      GETCOD00                
.
          MATCH     SP70,OPARRDCD                                    * 19
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"<img src=../images/sadfacelos.gif ": 
                               "title='",TDESC,"'":
                               " class=Icon alt='",TDESC,"'>#",";
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                         
          ENDIF
.
          MOVE      "oc",CATEGORY
          MOVE      OPARUC03,CODE
          CALL      GETCOD00                
.
          REP       " +",CASEKEYS
          MATCH     SP70,TDESC                                       * 20
          IF        @EQUAL
            MATCH     SP70,OPARUNID
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"<img src=../images/EditIcon.gif ":
                                 "class=Icon onclick=#UpdatePACU('":
                                 CASEKEYS,"');>":
                                 "#",";
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"<a href=javascript:UpdatePACU('",CASEKEYS:
                               "');>",TDESC,"</a>#",";
          ENDIF
          REP       "+ ",CASEKEYS
.
          WRITE     HTMLFILE;"#"",OPARUC03,"#",";                    * 21
.
          MOVE      FRSTDATE,SAVFDATE
          MOVE      LASTDATE,SAVLDATE
          CALL      REVW0000           * Check if recovery review required
          MOVE      SAVFDATE,FRSTDATE
          MOVE      SAVLDATE,LASTDATE
.
          WRITE     HTMLFILE;"#"",CELCLASS,"#",";                    * 22
.
.-------- T0869563-start
.-------- WRITE     HTMLFILE;"#"",OPDAWARD,"#");"                    * 23 
          WRITE     HTMLFILE;"#"",OPDAWARD,"#",";                    * 23 
.
          MATCH     SP70,OPARUNID
          IF        !@EQUAL
            CLEAR     HTMLLNK7                                       * 24
            APPEND    "javascript:UpdTIDP('",HTMLLNK7
            APPEND    OPDAUNIQ,HTMLLNK7
            APPEND    "')",HTMLLNK7
            RESET     HTMLLNK7
          ELSE
            MOVE    SP70,HTMLLNK7
          ENDIF
          WRITE     HTMLFILE;"#"",HTMLLNK7,"#");"
.-------- T0869563-end
.
          GOTO      RECLST10
.
RECLST99  RETURN
.
.******************************************************************************
. Check if recovery review required and return class name for cell highlight
.******************************************************************************
REVW0000  MOVE      SP70,CELCLASS
.
          PACK      DIM32,OPARTETC,OPARTICU,OPARTEXP,OPARTIDP,SP70
.
          MATCH     SP70,DIM32                   * Has patient left theatre
          GOTO      REVW9999 IF NOT EQUAL
.
          MATCH     SP70,OPARTIRF                * Exit if not in recovery
          GOTO      REVW9999 IF EQUAL
.
          MOVE      OPSEDATE,WORKDATE            * Date into recovery   
          MATCH     "1",OPSGUY02               
          IF        @EQUAL
            ADD       ONE,WORKDATE               * Add 1 day if overnight
          ENDIF
          MOVE      OPARTIRF,WORKTIME            * Time into recovery
.
          MATCH     SP70,OPARUT02
          IF        !@EQUAL
            MOVE      OPARUT02,WORKDATE          * User last review date 
            MOVE      OPARUT03,WORKTIME
          ENDIF
.
          MOVE      WORKDATE,FIRSTDAT           
          REP       " 0",FIRSTDAT
          UNPACK    WORKTIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTIME
.
          CALL      IBACLOCK                    * Current date and time
          CLOCK     TIME,CTIMEIS
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF                    
          MOVE      CALCTIME,DURATIME
.
          SQUEEZE   OPCNCRRM
          MOVE      ZERO,FORM3
          MOVE      OPCNCRRM,FORM3
          IF        DURATIME > FORM3 & FORM3 > ZERO
            MOVE      "PinkBackground",CELCLASS
          ENDIF
.
REVW9999  RETURN
.******************************************************************************
. Theatre History Enquiry
.******************************************************************************
OPTHE000  BRANCH    FLDITMNO,OPTHE010,OPTHE020,OPTHE030,OPTHE040,OPTHE050:
                             OPTHE060,OPTHE070,OPTHE080
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPTHE999       
.
OPTHE010  CALL      PTHE0000
          GOTO      OPTHE999
.
OPTHE020  CALL      POTAB000
          GOTO      OPTHE999
.
OPTHE030  MATCH     SP70,DDATE
          GOTO      OPTHE999 IF EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      OPTHE999
.
OPTHE040  CALL      THETA000        * Theatre Audit List
          GOTO      OPTHE999
.
OPTHE050  WRITE     HTMLFILE;UNIQUEKY;
          GOTO      OPTHE999
.
OPTHE060  CALL      IMPL0000        * List of patient implants
          GOTO      OPTHE999
.
OPTHE070  CALL      DMBS0000        * List of Patient Extra MBS Codes
          GOTO      OPTHE999
.
OPTHE080  CALL      VTHE0000        * Visit Theatre History Enquiry List
          GOTO      OPTHE999
.
OPTHE999  RETURN
+
.*****************************************************************************
.         Display All unlinked outcomes
.*****************************************************************************
POTAB000  MOVE      ZERO,LINKEDFL
          UNPACK    DIM127,D1,LINKEDFL,DIM127
.
          WRITE     HTMLFILE;"<tr><td><table cellspacing=0 cellpadding=1":
                             " width=100% border=1>":
                             "<tr><td width=15% class=HeadingCell>Outcome</td>":
                             "<td width=25% class=HeadingCell>":
                             "Description</td>":
                             "<td width=10% class=HeadingCell>ACHS</td>":
                             "<td width=10% class=HeadingCell>Grade</td>":
                             "<td width=50% class=HeadingCell>Comments</td>":
                             "</tr>"
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSPMPOD1
POTAB100  CALL      RKPMPOD1
          BRANCH    OVRCD,POTAB900
.
          MATCH     ADMISSNO,PMPOVISN
          GOTO      POTAB900 IF NOT EQUAL
.
          MATCH     "0",LINKEDFL
          IF        @EQUAL
            MATCH     SP70,PMPOUNIQ            * only output unlinked
            GOTO      POTAB100 IF NOT EQUAL
          ELSE
            MATCH     OPDAUNIQ,PMPOUNIQ        * only output linked
            GOTO      POTAB100 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",PMPODELT               * supervisor deleted
          GOTO      POTAB100 IF EQUAL
.
          MOVE      "Invalid Code  ",OUTDESC
          PACK      KEY6,PMPOCODE,SP70
          CALL      RDPMADC1
          IF        OVRCD<>1
            PACK      OUTDESC,PMACDESC,SP70
          ENDIF
.
          MOVE      DNO,DANS
          MATCH     "1",PMACACHS
          IF        @EQUAL
            PACK      DANS,DYES
          ENDIF
. 
          PACK      KEY14,PMPOVISN,PMPOOCNT,SP1,SP1,ONE,SP70
          CALL      RDPMOCM1
          IF        OVRCD=1
            PACK      PMOCLINE,SP70,SP70
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap valign=middle>":
                             "<a href='javascript:UpdateOutcome(#"":
                             PMPOVISN,"#",#"",PMPOOCNT,"#");":
                             "'><img src=../images/EditIcon.gif class=Icon":
                             " hspace=4 border=0 align=absmiddle></a>&nbsp;";
          MATCH      "1",PMPODELT
          IF         @EQUAL
            WRITE      HTMLFILE;"<strike>":
                              PMPOCODE,"</td>":
                             "<td><strike>",OUTDESC,"&nbsp;</td>":
                             "<td><strike>",DANS,"&nbsp;</td>":
                             "<td><strike>",PMPOGRAD,"&nbsp;</td>":
                             "<td><strike>",PMOCLINE,"&nbsp;</td>"
          ELSE
            WRITE      HTMLFILE;PMPOCODE,"</td>":
                             "<td>",OUTDESC,"&nbsp;</td>":
                             "<td>",DANS,"&nbsp;</td>":
                             "<td>",PMPOGRAD,"&nbsp;</td>":
                             "<td>",PMOCLINE,"&nbsp;</td>"
          ENDIF
          GOTO      POTAB100
.
POTAB900
.
POTAB999  RETURN
+
.******************************************************************************
.*                    PATIENT  THEATRE HISTORY ENQUIRY                        *
.******************************************************************************
PTHE0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6                * Reading For the Visit No.
PTHE0010  CALL      RKBKREC6                * Reading From Booking Table
          BRANCH    OVRCD,PTHE9999
          MATCH     URNUMBER,BKREURNO
          GOTO      PTHE9999 IF NOT EQUAL
.
          MOVE      SP70,KEY15
          MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      GETCOD00                * Reading Through PATCODES File
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
PTHE0011  CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,PTHE0010
          MOVE      BKREBOOK,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      PTHE0010 IF NOT EQUAL 
.
          COMPARE   ZERO,OPCNCLSU
          GOTO      PTHE0100 IF NOT EQUAL   * Checking For The CLinic Status
.
          MOVE      SP70,KEY30
          MOVE      SP70,SURGNAME
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,PTHE0200
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY30        * For Displaying Clinic Descrition
            MOVE      OPCLDESC,SURGNAME     * For Displaying Clinic Descrition
            GOTO      PTHE0200
          ELSE
            PACK        KEY6,OPCLDOCT,SP70
            GOTO        PTHE0110
          ENDIF
.
PTHE0100  PACK      KEY6,OPDACLIN,SP70
PTHE0110  CALL      RDDOCT1
          BRANCH    OVRCD,PTHE0200
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME
.
PTHE0200  MOVE      "NO",KEY3
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPPIM1                * Reading Through Patient Implant
          CALL      RKOPPIM1
          BRANCH    OVRCD,PTHE0300
          MATCH     OPDAUNIQ,OPPIUNID
          GOTO      PTHE0300 IF NOT EQUAL
          MOVE      "YES",KEY3
.
PTHE0300  MOVE      "NO",D3
          PACK      KEY19,OPDAUNIQ,SP70
          CALL      RSOPPEI1
          CALL      RKOPPEI1                * Reading Through Patient Expensive
          BRANCH    OVRCD,PTHE0400
          MATCH     OPDAUNIQ,OPPEUNID
          GOTO      PTHE0400 IF NOT EQUAL
          MOVE      "YES",D3
.
PTHE0400  MOVE      SP70,DIM30
.
          COMPARE   "0",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Booked",DIM30
          ENDIF
.
          COMPARE   "1",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Pre-Admitted",DIM30
          ENDIF
.
          COMPARE   "2",OPDASTAT
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
            MOVE      "Admitted",DIM30
          ENDIF
.
          COMPARE   "3",OPDASTAT
          IF        @EQUAL
            MOVE      "cancelled",FHRSTAT
            MOVE      "SC",CATEGORY
            MOVE      OPDACANC,CODE
            CALL      GETCOD00
            MATCH     ANST,TCINDC3
            IF        @EQUAL
              MOVE      "Transferred",DIM30
            ELSE
              MOVE      "Cancelled",DIM30
            ENDIF
            GOTO      PTHE0420
          ENDIF
.
          COMPARE   "4",OPDASTAT
          IF        @EQUAL
            MOVE      "fulfilled",FHRSTAT
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,PTHE0420
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Holding",DIM30
            ENDIF
.           MOVE      "Holding",DIM30
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Anaes",DIM30
            ENDIF
.           MOVE      "Anaes",DIM30
          ENDIF
.
PTHE0410  PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,PTHE0420
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Theatre",DIM30
            ENDIF
.           MOVE      "Theatre",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIDP   
          IF        !@EQUAL
            MOVE      "Ready To Depart",DIM30
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",DIM30
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",DIM30
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,DIM30                 * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",DIM30         * Yes, set to "Deceased".
            ELSE
              MOVE      "RIP - ",DIM6            * No, prefix with "Deceased"
              MOVE      DIM30,KEY15              * Save current status
              PACK      DIM30,DIM6,KEY15         * Build new status desc
            ENDIF
          ENDIF
.
PTHE0420  SQUEEZE   OPDADATE
          SQUEEZE   OPDATIME
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
.
          BRANCH    FHIRTYPE,PTHE1000
          REP       " +",CASEKEYS
          CLEAR     HTMLLINK
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "&urnumber=",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "&admissno=",HTMLLINK
          APPEND    OPDAADMN,HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     KEY100  
          APPEND    "javascript:AuditDetails('",KEY100
          APPEND    OPDAUNIQ,KEY100
          APPEND    "')",KEY100
          RESET     KEY100
.
          WRITE     HTMLFILE;"t.addRow(#"",BKREBOOK,"#",":  * 0
                             "#"",OPDADATE,OPDATIME,"#",":  * 1
                             "#"",HTMLLINK,"#",":           * 2
                             "#"",OPDADES1,"#",":           * 3
                             "#"",KEY30,"#",":              * 4
                             "#"",KEY3,"#",":               * 5
                             "#"",D3,"#",":                 * 6
                             "#"",DIM30,"#",":              * 7
                             "#"",OPDAUNIQ,"#"";            * 8
          MOVE      "OA",CATEGORY           * Anae Type
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OADESC
.
          MOVE      "OY",CATEGORY           * Type
          MOVE      OPDATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OYDESC
.
          MOVE      SP70,IDESC
          PACK      KEY9,OPDAPROV,SP70
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,OPDADATE,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD=1
              MOVE      SP70,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            MOVE      ODESC,IDESC           * Set up description
          ENDIF
.
          CALL      GETAN000
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD = 0
            PACK    KEY3,OPSEHOSP,SP70
            CALL    RDPTHSP1
            IF      OVRCD = 0
              PACK    DIM50,PTHSNAME,SP70
            ELSE
              PACK    DIM50,SP70
            ENDIF 
          ENDIF
. 
          WRITE     HTMLFILE;",":
                           "#"",OADESC,"#",":    * 9
                           "#"",OYDESC,"#",":    * 10
                           "#"",IDESC,"#",":     * 11
                           "#"",KEY100,"#",":    * 12
                           "#"",ANAENAME,"#",":  * 13
                           "#"",DIM50,"#"";      * 14
.
          WRITE     HTMLFILE;");"
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          GOTO      PTHE0011
.
. Ouput FHIR Appointments
.
PTHE1000  CALL      FHRAPP00
          GOTO      PTHE0011
.
PTHE9999  RETURN
+
.******************************************************************************
.*                    VISIT THEATRE HISTORY ENQUIRY                           *
.******************************************************************************
VTHE0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1                * Directly Read Booking Record
          BRANCH    OVRCD,VTHE9999
.
          MOVE      SP70,KEY15
          MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      GETCOD00                * Reading Through PATCODES File
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
VTHE0011  CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,VTHE9999
          MOVE      BKREBOOK,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      VTHE9999 IF NOT EQUAL 
.
          COMPARE   ZERO,OPCNCLSU
          GOTO      VTHE0100 IF NOT EQUAL   * Checking For The Clinic Status
.
          MOVE      SP70,KEY30
          MOVE      SP70,SURGNAME
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,VTHE0200
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY30        * For Displaying Clinic Description
            MOVE      OPCLDESC,SURGNAME     * For Displaying Clinic Description
            GOTO      VTHE0200
          ELSE
            PACK      KEY6,OPCLDOCT,SP70
            GOTO      VTHE0110
          ENDIF
.
VTHE0100  PACK      KEY6,OPDACLIN,SP70
VTHE0110  CALL      RDDOCT1
          BRANCH    OVRCD,VTHE0200
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME
.
VTHE0200  MOVE      "NO",KEY3
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPPIM1                * Reading Through Patient Implant
          CALL      RKOPPIM1
          BRANCH    OVRCD,VTHE0300
          MATCH     OPDAUNIQ,OPPIUNID
          GOTO      VTHE0300 IF NOT EQUAL
          MOVE      "YES",KEY3
.
VTHE0300  MOVE      "NO",D3
          PACK      KEY19,OPDAUNIQ,SP70
          CALL      RSOPPEI1
          CALL      RKOPPEI1                * Reading Through Patient Expensive
          BRANCH    OVRCD,VTHE0400
          MATCH     OPDAUNIQ,OPPEUNID
          GOTO      VTHE0400 IF NOT EQUAL
          MOVE      "YES",D3
.
VTHE0400  MOVE      SP70,DIM30
.
          COMPARE   "0",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Booked",DIM30
          ENDIF
.
          COMPARE   "1",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Pre-Admitted",DIM30
          ENDIF
.
          COMPARE   "2",OPDASTAT
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
            MOVE      "Admitted",DIM30
          ENDIF
.
          COMPARE   "3",OPDASTAT
          IF        @EQUAL
            MOVE      "cancelled",FHRSTAT
            MOVE      "SC",CATEGORY
            MOVE      OPDACANC,CODE
            CALL      GETCOD00
            MATCH     ANST,TCINDC3
            IF        @EQUAL
              MOVE      "Transferred",DIM30
            ELSE
              MOVE      "Cancelled",DIM30
            ENDIF
            GOTO      VTHE0420
          ENDIF
.
          COMPARE   "4",OPDASTAT
          IF        @EQUAL
            MOVE      "fulfilled",FHRSTAT
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,VTHE0420
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Holding",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Anaes",DIM30
            ENDIF
          ENDIF
.
VTHE0410  PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,VTHE0420
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Theatre",DIM30
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIDP   
          IF        !@EQUAL
            MOVE      "Ready To Depart",DIM30
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",DIM30
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",DIM30
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,DIM30                 * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",DIM30         * Yes, set to "Deceased".
            ELSE
              MOVE      "RIP - ",DIM6            * No, prefix with "Deceased"
              MOVE      DIM30,KEY15              * Save current status
              PACK      DIM30,DIM6,KEY15         * Build new status desc
            ENDIF
          ENDIF
.
VTHE0420  SQUEEZE   OPDADATE
          SQUEEZE   OPDATIME
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
.
          BRANCH    FHIRTYPE,VTHE1000
          REP       " +",CASEKEYS
          CLEAR     HTMLLINK
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "&urnumber=",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "&admissno=",HTMLLINK
          APPEND    OPDAADMN,HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     KEY100  
          APPEND    "javascript:AuditDetails('",KEY100
          APPEND    OPDAUNIQ,KEY100
          APPEND    "')",KEY100
          RESET     KEY100
.
          WRITE     HTMLFILE;"t.addRow(#"",BKREBOOK,"#",":  * 0
                             "#"",OPDADATE,OPDATIME,"#",":  * 1
                             "#"",HTMLLINK,"#",":           * 2
                             "#"",OPDADES1,"#",":           * 3
                             "#"",KEY30,"#",":              * 4
                             "#"",KEY3,"#",":               * 5
                             "#"",D3,"#",":                 * 6
                             "#"",DIM30,"#",":              * 7
                             "#"",OPDAUNIQ,"#"";            * 8
          MOVE      "OA",CATEGORY           * Anae Type
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OADESC
.
          MOVE      "OY",CATEGORY           * Type
          MOVE      OPDATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OYDESC
.
          MOVE      SP70,IDESC
          PACK      KEY9,OPDAPROV,SP70
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,OPDADATE,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD=1
              MOVE      SP70,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1              * Read ICD operation file
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            MOVE      ODESC,IDESC           * Set up description
          ENDIF
.
          CALL      GETAN000
.
          WRITE     HTMLFILE;",":
                           "#"",OADESC,"#",":    * 9
                           "#"",OYDESC,"#",":    * 10
                           "#"",IDESC,"#",":     * 11
                           "#"",KEY100,"#",":    * 12
                           "#"",ANAENAME,"#"";   * 13
          WRITE     HTMLFILE;");"
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          GOTO      VTHE0011
.
. Ouput FHIR Appointments
.
VTHE1000  CALL      FHRAPP00
          GOTO      VTHE0011
.
VTHE9999  RETURN
+
.---------------------------------------------------------
. Get Anaethestist Name return as ANAENAME
.---------------------------------------------------------
GETAN000  MOVE      SP70,ANAENAME
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ELSE 
            PACK      KEY6,OPSEANAE,SP70
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,ANAENAME
            ENDIF
          ENDIF
          STRIP     ANAENAME
          RETURN
.******************************************************************************
.*                    Output table of theatre audit History                   *
.******************************************************************************
THETA000  MATCH     SP70,UNIQUEKY
          GOTO      THETA999 IF EQUAL
.
          PACK      KEY39,UNIQUEKY,SP70
          CALL      RSOPADT1
THETA100  CALL      RKOPADT1
          BRANCH    OVRCD,THETA999
.
          MATCH     UNIQUEKY,OPADUNIQ
          GOTO      THETA999 IF NOT EQUAL
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,OPADWEBU
          IF        !@EQUAL
            PACK      KEY10,OPADWEBU,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      OPADWEBU,WBSENAM
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY60
          MOVE      ZERO,F3
          MOVE      OPADATYP,F3
          LOAD      KEY60,F3,THADT001,THADT002,THADT003,THADT004,THADT005:
                             THADT006,THADT007,THADT008,THADT009,THADT010:
                             THADT011,THADT012,THADT013,THADT014,THADT015:
                             THADT016,THADT017,THADT018,THADT019,THADT020:
                             THADT021
.
          WRITE     HTMLFILE;"t.addRow(#"",OPADUNIQ,"#",":
                             "#"",OPADADAT,OPADATIM,"#",":
                             "#"",OPADWEBU,"#",":
                             "#"",OPADATYP,"#",":
                             "#"",OPADORIG,"#",":
                             "#"",OPADURNO,"#",":
                             "#"",OPADVISN,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",KEY60,"#"";
          WRITE     HTMLFILE;");"
.
          GOTO      THETA100
.
THETA999  RETURN
+
.******************************************************************************
.*                    Link To Next Page of Patient Theatre History            *
.******************************************************************************
NEXT0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       " +",CASEKEYS
.
          WRITE     HTMLFILE;"oprweb06.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY: 
                                 "&casekeys=",CASEKEYS:
                                 "&teamnumb=",TEAMNUMB; 
          REP       "+ ",STARTKEY
          REP       "+ ",CASEKEYS
.
NEXT9999  RETURN
.******************************************************************************
.*                     Link To Previous Page of patient Theatre History       *
.******************************************************************************
PREV0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          REP       " +",CASEKEYS
.
          WRITE     HTMLFILE;"oprweb06.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&nodressg=",NODRESSG:
                                 "&startkey=",STARTKEY:
                                 "&casekeys=",CASEKEYS:
                                 "&teamnumb=",TEAMNUMB;  
          REP       "+ ",CASEKEYS
          REP       "+ ",STARTKEY
.
PREV9999  RETURN
+
.******************************************************************************
.         List of Patient Implant
.******************************************************************************
IMPL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
IMPL1000  CALL      RKOPDEA2
          BRANCH    OVRCD,IMPL9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      IMPL9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      IMPL1000 IF EQUAL          * Cancelled
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPPIM1
IMPL2000  CALL      RKOPPIM1
          BRANCH    OVRCD,IMPL1000
.
          MATCH     OPDAUNIQ,OPPIUNID          * Same Uniq id ?
          GOTO      IMPL1000 IF NOT EQUAL
.
          MATCH     "1",OPPIAIMP
          GOTO      IMPL2000 IF EQUAL          * Ad-hoc item
.
          MOVE      "&nbsp;              ",KEY20
          MOVE      "&nbsp;              ",DISPLOCN
.
          PACK      KEY75,OPPIBCOD,OPPIICDE,SP70
          CALL      RDOPTHI3
          BRANCH    OVRCD,IMPL4000
.
          MATCH     SP70,OPTITYIM
          GOTO      IMPL3000 IF EQUAL
.
          MOVE      "Invalid Implant Type",KEY20
          MOVE      "OW",KEY2
          PACK      KEY5,KEY2,OPTITYIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20          * valid type of implant
          ENDIF
.
IMPL3000  MATCH     SP70,OPPILOCA
          GOTO      IMPL4000 IF EQUAL
.
          MOVE      "Ow",KEY2
          PACK      KEY5,KEY2,OPTITYIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DISPLOCN          * valid location
          ENDIF
.
IMPL4000 WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowImplant":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&oppim001=",OPPIICDE:
                             "&oppim010=",OPPIBCOD:
                             "&uniqueky=",OPPIUNID:
                             "&teamnumb=",OPPITMNO:
                             "&icounter=",OPPICNTR,"#")'>":
                             "<img src=../images/MaintenanceIcon1.gif hspace=4":
                             " border=0 align=absmiddle>":
                             "</a>",OPPIICDE,"</td>":
.
                             "<td>",OPPIBCOD,"</td>":
                             "<td>",OPTIDESC,"</td>":
                             "<td>",OPTIMCHG,"</td>":
                             "<td>",KEY20,"</td>":
                             "<td>",OPPILTSN,"</td>":
                             "<td>",OPPIIQTY,"</td>":
                             "<td>",DISPLOCN,"</td>":
                             "</tr>";
          GOTO      IMPL2000
.
IMPL9999  RETURN
+
.******************************************************************************
. Link to Next page of Recovery Patients
.******************************************************************************
NXTREC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          MOVE      "E",UPDATETY
          REP       " +",SURGTYPE
          REP       " +",NODRESSG
.
          WRITE     HTMLFILE;"oprweb06.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&nodressg=",NODRESSG:
                             "&viewtype=",VIEWTYPE:
                             "&updatety=",UPDATETY:
                             "&surgtype=",SURGTYPE:
                             "&inclexit=",INCLEXIT:
                             "&showadmt=",SHOWADMT:
                             "&dlyrsnrc=",DLYRSNRC;
.
          REP       "+ ",SURGTYPE
.
NXTREC99  RETURN
.******************************************************************************
. Link to Previous page of Recovery Patients
.******************************************************************************
PRVREC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          MOVE      "E",UPDATETY
          REP       " +",SURGTYPE
          REP       " +",NODRESSG
.
          WRITE     HTMLFILE;"oprweb06.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&nodressg=",NODRESSG:
                             "&updatety=",UPDATETY:
                             "&surgtype=",SURGTYPE:
                             "&inclexit=",INCLEXIT:
                             "&showadmt=",SHOWADMT:
                             "&dlyrsnrc=",DLYRSNRC;
.
          REP       "+ ",SURGTYPE
.
PRVREC99  RETURN
.******************************************************************************
.*                     Other Theatre Details                                  *
.******************************************************************************
OTDT0000  BRANCH    FLDITMNO,OTDT0100,OTDT0200,OTDT0300,OTDT0400,OTDT0500:
                             OTDT0600,OTDT0700,OTDT0800,OTDT0900,OTDT1000:
                             OTDT1100,OTDT1200,OTDT1300,OTDT1400,OTDT1500:
                             OTDT1600,OTDT1700,OTDT1800,OTDT1900,OTDT2000:
                             OTDT2100,OTDT2200,OTDT2300,OTDT2400,OTDT2500:
                             OTDT2600,OTDT2700,OTDT2800,OTDT2900,OTDT3000:
                             OTDT3100,OTDT3200,OTDT3300,OTDT3400,OTDT3500:
                             OTDT3600,OTDT3700,OTDT3800,OTDT3900,OTDT4000:
                             OTDT4100,OTDT4200,OTDT4300,OTDT4400,OTDT4500:
                             OTDT4600,OTDT4700,OTDT4800,OTDT4900,OTDT5000:
                             OTDT5100,OTDT5200,OTDT5300,OTDT5400,OTDT5500:
                             OTDT5600,OTDT5700,OTDT5800,OTDT5900,OTDT6000:
                             OTDT6100
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OTDT9999
.
OTDT0100  WRITE     HTMLFILE;OPDATHET;      * Theatre Code
          GOTO      OTDT9999
.
OTDT0200  WRITE     HTMLFILE;OPRMDESC;      * Theatre Description
          GOTO      OTDT9999
.
OTDT0300  WRITE     HTMLFILE;BKREDEPT;      * Unit Code
          GOTO      OTDT9999
.
OTDT0400  MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      CODITM00                * Unit Code Description
          GOTO      OTDT9999
.
OTDT0500  WRITE     HTMLFILE;OPDADES1;      * Operating Description
          GOTO      OTDT9999
.
OTDT0600  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT0700  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT0800  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT0900  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT1000  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT1100  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT1200  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT1300  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT1400  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT1500  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT1600  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT1700  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT1800  WRITE     HTMLFILE;OPARANAS;
          GOTO      OTDT9999
.
OTDT1900  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM
          GOTO      OTDT9999
.
OTDT2000  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT2100  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT2200  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT2300  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      OTDT9999
.
OTDT2400  WRITE     HTMLFILE;OPSGCCNT;
          GOTO      OTDT9999
.
OTDT2500  MOVE      SIX,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT2600  MOVE      SEVEN,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      OTDT9999
.
OTDT2700  MOVE      SIX,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT2800  MOVE      SIX,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT2900  MOVE      SEVEN,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      OTDT9999
.
OTDT3000  MOVE      SEVEN,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      OTDT9999
.
OTDT3100  MOVE      ONE,F1
          CALL      TOTT0000
          WRITE     HTMLFILE;FORM4," mins";
          GOTO      OTDT9999
.
OTDT3200  MOVE      TWO,F1
          CALL      TOTT0000
          WRITE     HTMLFILE;FORM4," mins";
          GOTO      OTDT9999
.
OTDT3300  MOVE      THREE,F1
          CALL      TOTT0000
          WRITE     HTMLFILE;FORM4," mins";
          GOTO      OTDT9999
.
OTDT3400  MOVE      FOUR,F1
          CALL      TOTT0000
          WRITE     HTMLFILE;FORM4," mins";
          GOTO      OTDT9999
.
OTDT3500  MOVE      FIVE,F1
          CALL      TOTT0000
          WRITE     HTMLFILE;FORM4," mins";
          GOTO      OTDT9999
.
OTDT3600  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM
          GOTO      OTDT9999
.
OTDT3700  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM
          GOTO      OTDT9999
.
OTDT3800  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM
          GOTO      OTDT9999
.
OTDT3900  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM
          GOTO      OTDT9999
.
OTDT4000  WRITE     HTMLFILE;OPSGDCK1;
          GOTO      OTDT9999
.
OTDT4100  WRITE     HTMLFILE;OPSGDCK2;
          GOTO      OTDT9999
.
OTDT4200  WRITE     HTMLFILE;OPSGUY01;
          GOTO      OTDT9999
.
OTDT4300  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      ONE,OTTYPIND       * Attr Type 1 ('Water')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT4400  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      ONE,OTTYPIND       * Attr Type 1 ('Water')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT4500  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      ONE,OTTYPIND       * Attr Type 1 ('Water')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT4600  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      TWO,OTTYPIND       * Attr Type 2 ('Saline')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT4700  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      TWO,OTTYPIND       * Attr Type 2 ('Saline')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT4800  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      TWO,OTTYPIND       * Attr Type 2 ('Saline')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT4900  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      THREE,OTTYPIND     * Attr Type 3 ('Hartmanns')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5000  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      THREE,OTTYPIND     * Attr Type 3 ('Hartmanns')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5100  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      THREE,OTTYPIND     * Attr Type 3 ('Hartmanns')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT5200  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FOUR,OTTYPIND      * Attr Type 4 ('Glycine')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5300  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FOUR,OTTYPIND      * Attr Type 4 ('Glycine')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5400  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FOUR,OTTYPIND      * Attr Type 4 ('Glycine')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT5500  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FIVE,OTTYPIND      * Attr Type 5 ('Ringers')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5600  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FIVE,OTTYPIND      * Attr Type 5 ('Ringers')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT5700  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      FIVE,OTTYPIND      * Attr Type 5 ('Ringers')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT5800  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      SIX,OTTYPIND       * Attr Type 6 ('Other')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OTDT9999
.
OTDT5900  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      SIX,OTTYPIND       * Attr Type 6 ('Other')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OTDT9999
.
OTDT6000  MATCH     "1",UPDOPATI
          GOTO      OTDT9999 IF NOT EQUAL
.
          MOVE      SIX,OTTYPIND       * Attr Type 6 ('Other')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OTDT9999
.
OTDT6100  WRITE     HTMLFILE;UPDOPATI;
          GOTO      OTDT9999
.
OTDT9999  RETURN
.
.**********************************************************************
.*                              CTEMP000                              *
.*                   Create the Indexed Temp File                     *
.**********************************************************************
CTEMP000  
          CALL      DTEMP000           * kill existing temp file
.
.------ Build new indexed temp file ------
.
          PACK      DESC55,SP30,SP30,SP30
          CLEAR     DESC55
          APPEND    "isbuild ",DESC55
          APPEND    OPRFNAM1,DESC55
          APPEND    " 52 u1-26",DESC55
          RESET     DESC55
.
          EXECUTE   DESC55,TASKID
          OPEN      INPUSETF,OPRFNAM1
.
CTEMP999  RETURN
.**********************************************************************
.*                              DTEMP000                              *
.*                 Kill the Temp file if it already exists            *
.**********************************************************************
DTEMP000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO     * test if file exist if not create it.
          OPEN      INPUSETF,OPRFNAM1
          TRAPCLR   IO
          BRANCH    OVRCD,DTEMP100
          CALL      DEREC000
.
DTEMP100  CLEAR     DESC55
          CLOSE     INPUSETF
          APPEND    "iserase ",DESC55
          APPEND    OPRFNAM1,DESC55
          RESET     DESC55
.
          EXECUTE   DESC55,TASKID
.
DTEMP999  RETURN
.
.*******************************************************************************
DEREC000  PACK      KEY26,SP70
          READ      INPUSETF,KEY26;;        * position at end of file
DEREC100  READKS    INPUSETF;DAMOUNT,DIAMT,PROVITEM,UNIQUE
          GOTO      DEREC999 IF OVER
          RESET     DIAMT
          MATCH     SP70,DIAMT
          GOTO      DEREC999 IF EQUAL
.
          PACK      KEY26,DAMOUNT,DIAMT,PROVITEM,UNIQUE 
          RESET     KEY26
          DELETE    INPUSETF,KEY26
          GOTO      DEREC100
          
DEREC999  RETURN
+
.******************************************************************************
.*                        Check Operation Minutes                             *
.* This procedure checks wheather recalculation of Actual Operation Minutes   *
.* is necessary or not based on the values of Prep Start Time, Dressing Time  *
.* and Overnight Indicator.                                                   *
.*                                                                            *
.* INPUTS:  UPDTMFLG - indicates 'insert' or 'update' of oprsrgaf             *
.*                     ZERO = insert                                          *
.*                     ONE  = update                                          *
.* OUTPUTS: RECOPMIN - indicates whether recalculation of Op Min is required  *
.*                     ZERO = do not recalculate                              *
.*                     ONE  = recalculate                                     *
.******************************************************************************
CHKOPM00  MOVE      ZERO,RECOPMIN           * Reset 'Recalc Op Min' flag
          BRANCH    UPDTMFLG,CHKOPM50
.
.         Inserting first row to oprsrgaf (team number = 1). The calculation of
.         Actaul Op Min is required only if both, Prep Start Time and
.         Dressing Time are populated.

          MATCH     SP70,OPSRG003           * Is 'Prep Start Time' blank?
          IF        !@EQUAL
            MATCH     SP70,OPSRG004         * No, Is 'Dressing Time' blank?
            IF        !@EQUAL
              MOVE      ONE,RECOPMIN        * No, set 'Recalc Op Min' flag
            ENDIF
          ENDIF
.
          GOTO      CHKOPM99
.
.         Updating details for an existing team. The recalculation of Actual
.         Op Min is required when at least one of the times (Prep Start Time or
.         Dressing Time) or Overnight Indicator has changed.
.
CHKOPM50  MATCH     OPSRG003,OPSGTIPS       * Is 'Prep Start Time' the same?
          IF        !@EQUAL
            MOVE      ONE,RECOPMIN          * No, set 'Recalc Op Min' flag
            GOTO      CHKOPM99
          ENDIF
.
          MATCH     OPSRG004,OPSGTIDR       * Is 'Dressing Time' the same?
          IF        !@EQUAL
            MOVE      ONE,RECOPMIN          * No, set 'Recalc Op Min' flag
            GOTO      CHKOPM99
          ENDIF
.
          MATCH     Z70,OPSRG071            * Is 'Overnight Ind' defined on scr
          GOTO      CHKOPM99 IF EQUAL       * No, do not check, go to exit
.
          MATCH     OPSRG071,OPSGUY02       * Is 'Overnight Ind' the same?
          IF        !@EQUAL
            MOVE      ONE,RECOPMIN          * No, set 'Recalc Op Min' flag
            GOTO      CHKOPM99
          ENDIF
.
CHKOPM99  RETURN
.
.******************************************************************************
.*                Recalculate Actual Operation Minutes                        *
.******************************************************************************
ROPMIN00  MOVE      "99:99",MINPREPT        * Initialize work variables
          MOVE      ONE,PREPDIND
          MOVE      SP70,MAXDREST
          MOVE      ZERO,DRESDIND
          MOVE      ZERO,CURRDAY
.         
.         Loop through all surgical teams to determine the earliest 'Prep Start
.         Time' and the latest 'Dressing Time' taking into account the 
.         overnight indicator.
.
          PACK      KEY11,UNIQUEKY,SP70
          CALL      RSOPSRG1
ROPMIN10  CALL      RKOPSRG1
          BRANCH    OVRCD,ROPMIN30
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      ROPMIN30 IF NOT EQUAL
.
          MATCH     SP70,OPSGTIPS           * Is 'Prep Start Time' blank?
          GOTO      ROPMIN20 IF EQUAL       * Yes, skip 'Prep Start Time' check

          COMPARE   PREPDIND,CURRDAY        * Is time found for earlier day?
          IF        @LESS
            MOVE      CURRDAY,PREPDIND      * Yes, CURRDAY < PREPDIND
            MOVE      OPSGTIPS,MINPREPT     * Store new Min day and time
            GOTO      ROPMIN20
          ENDIF
          IF        @EQUAL
            MATCH     MINPREPT,OPSGTIPS     * Same day but is it earlier time?
            IF        @LESS
              MOVE      OPSGTIPS,MINPREPT   * Yes, store new Min time
            ENDIF
          ENDIF
.
ROPMIN20  MATCH     "1",OPSGUY02            * Is 'Overnight Indicator' set?
          IF        @EQUAL
            MOVE      ONE,CURRDAY           * Yes, set CURRDAY to next day
          ENDIF
.
          MATCH     SP70,OPSGTIDR           * Is 'Dressing Time' blank?
          GOTO      ROPMIN10 IF EQUAL       * Yes, skip 'Dressing Time' check
.
          COMPARE   CURRDAY,DRESDIND        * Is time found for later day?
          IF        @LESS
            MOVE      CURRDAY,DRESDIND      * Yes, DRESDIND < CURRDAY
            MOVE      OPSGTIDR,MAXDREST     * Store new Max day and time
            GOTO      ROPMIN10
          ENDIF
          IF        @EQUAL
            MATCH     OPSGTIDR,MAXDREST     * Same day but is it later time?
            IF        @LESS
              MOVE      OPSGTIDR,MAXDREST   * Yes, store new Max time
            ENDIF
          ENDIF
.
          GOTO      ROPMIN10                * Get next team details
.          
.         Calculate the duration in theatre for this patient based on
.         earliest 'Prep Start Time' and latest 'Dressing Time' found.
.
ROPMIN30  MOVE      ZERO,ACDURMIN           * Initalise Act Duration in theatre
          MATCH     "99:99",MINPREPT        
          GOTO      ROPMIN40 IF EQUAL       * No 'Prep Start Time'. Set Dur = 0
          MATCH     SP70,MAXDREST   
          GOTO      ROPMIN40 IF EQUAL       * No 'Dressing Time'. Set Dur = 0
          COMPARE   PREPDIND,DRESDIND
          GOTO      ROPMIN40 IF LESS        * 'Dress Day' < 'Prep Day', Dur = 0
          IF        @EQUAL
            MATCH     MINPREPT,MAXDREST     * Is 'Dress Time' < 'Prep Time'?
            GOTO      ROPMIN40 IF LESS      * Yes, set Dur = 0
          ENDIF
.
          CALL      ACTDUR00                * Calculate Actual Duration 
.
.         Update Theatre Opeartion Detail record with new duration. If the 
.         newly calculated duration is equal to the current duration then no
.         further processing is necessary.
.
ROPMIN40  PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,ROPMIN99       
          COMPARE   ACDURMIN,OPDATDUR       * Has Duration in Theatre changed?
          GOTO      ROPMIN99 IF EQUAL       * No, go to exit.
          MOVE      ACDURMIN,OPDATDUR       * Yes, update with New Duration
          CALL      IBACLOCK
          MOVE      CURRDATE,OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA3
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
.
.         Loop through Operation Details records for the given session and
.         calculate the Actual Operation Minutes for the session.
.         Actual Op Min = Sum of (Patient Duration in theatre + Prep Time/Pat) 
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,ROPMIN99
. 
          MOVE      ZERO,ACDURMIN            * Initalize Session Actual Op Min
          MOVE      TWO,D1                   * Use for status, TWO = Admitted
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,D1,SP70
          CALL      RSOPDEA1                 
ROPMIN50  CALL      RKOPDEA1
          BRANCH    OVRCD,ROPMIN70
          MATCH     OPSEDATE,OPDADATE        * Same Session Date?
          GOTO      ROPMIN70 IF NOT EQUAL    * No, exit loop
          MATCH     OPSETIME,OPDATIME        * Same Session Time?
          GOTO      ROPMIN70 IF NOT EQUAL    * No, exit loop
          MATCH     OPSECLIN,OPDACLIN        * Same Clinic/Surgeon?
          GOTO      ROPMIN70 IF NOT EQUAL    * No, exit loop
          COMPARE   TWO,OPDASTAT             * Is booking status = Admitted?
          GOTO      ROPMIN60 IF EQUAL        * Yes, Add to Actual Op Min
          COMPARE   FOUR,OPDASTAT            * Is booking status = Discharged?
          GOTO      ROPMIN60 IF EQUAL        * Yes, Add to Actual Op Min
.
          GOTO      ROPMIN50                 * Get next record
.
ROPMIN60  IF        (OPDATDUR > ZERO)
            ADD       OPDATDUR,ACDURMIN      * Add patient's duration in theatre
            ADD       OPSEPREP,ACDURMIN      * Add preperation time per patient
          ENDIF
          GOTO      ROPMIN50                 * Get next record
.
ROPMIN70  MOVE      ACDURMIN,OPSEACTD        * Set sessions Actual Op Min
          CALL      UPOPSES1              
.
          PACK      KEY10,UNIQUEKY,SP70      * Re - position on correct
          CALL      RDOPDEA3                 * oprdetaf record after session 
          BRANCH    OVRCD,ROPMIN99           * Actual op min
.     
ROPMIN99  RETURN
.
.******************************************************************************
.*         ACTDUR00 - Calculates the actual duration in theatre               *
.* INPUTS:  MINPREPT - Minimum 'Prep Start Time' (HH:MM)                      *
.*          MAXDREST - Maximum 'Dressing Time'   (HH:MM)                      *
.*          PREPDIND - Day Indicator for 'Prep Start Time'                    *
.*          DRESDIND - Day Indicator for 'Dressing Time'                      *
.*                                                                            *
.* OUTPUTS: ACDURMIN - Time between MINPREPT and MAXDREST in minutes          *
.******************************************************************************
ACTDUR00  MOVE      ZERO,ACDURMIN
          UNPACK    MINPREPT,CHOUR,ANS,CMIN * unpack the prep start time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,PREPTMIN          
          MULT      "60",PREPTMIN           * convert hours to minutes 
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,PREPTMIN          * get the total min of prep time
.
          UNPACK    MAXDREST,CHOUR,ANS,CMIN * unpack the dressing time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,DRESTMIN           
          MULT      "60",DRESTMIN           * convert hours to minutes
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,DRESTMIN          * get the total min of dressing time
. 
.         Check for session going over midnight. The seesion has gone over
.         midnight only if the PREPDIND is ZERO and DRESDIND is ONE.
.
          IF        ((PREPDIND=ZERO) & (DRESDIND=ONE))
.
.         Added this check for the case where the Overnight indicator is set
.         to allow an Exit Theatre Complex time after midnight, but the surgery
.         end time is before midnight.
.
            COMPARE   PREPTMIN,DRESTMIN
            IF        @LESS
              ADD       "1440",DRESTMIN      * Add 24 hours to the 'Dress Time'
            ENDIF
          ENDIF
.
.         Calculate Actaul Duration = ('Dressing Time' - 'Prep Start Time')
.
          ASSIGN    (DRESTMIN - PREPTMIN),ACDURMIN
.
ACTDUR99  RETURN
.
.******************************************************************************
.* SRTMB000 : Sort MBS items into the order required by medical records       *
.******************************************************************************
          DEFPROC   SRTMB000
.
CURCHRGE  FORM      8.2
CURMRECN  FORM      3
.
SWPCHRGE  FORM      8.2
SWPMRECN  FORM      3
.
.         Loop over each of the MBS items in the file, and sort into
.         charge order. This uses a bubble sort.
.
SRTMB000  MOVE      OPDAADMN,MMADMN
          PACK      KEY11,MMADMN,SP2
          CALL      RDSMMBS1
SRTMB100  CALL      RDKMMBS1                 * get next MBS item
          BRANCH    OVRCD,SRTMB999           * finished sort
.
          MATCH     OPDAADMN,MMADMN
          GOTO      SRTMB999 IF NOT EQUAL    * finished sort
.
          MOVE      MMRECN,CURMRECN          * current record number
          MOVE      MMRECN,SWPMRECN          * record number to swap with
.
          MOVE      MMCODE,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,SRTMB200
.
          MOVE      OPDADATE,CEFFDATE
          CALL      GETTHR00                * get theatre fee
          BRANCH    OVRCD,SRTMB200
.
.         Set the charge for this item
.
          MOVE      TFPAT1,CURCHRGE
          ADD       TFHF1,CURCHRGE
          GOTO      SRTMB300
.
.         Missing theatre fee
.
SRTMB200  MOVE      ZERO,CURCHRGE
.
.         Loop through the rest of the MBS procedures to see if there are
.         any with a charge greater than this one.
.
SRTMB300  CALL      RDKMMBS1                 * get next record
          BRANCH    OVRCD,SRTMB800           * check if any thing to swap
.
          MATCH     OPDAADMN,MMADMN             * check for correct admission
          GOTO      SRTMB800 IF NOT EQUAL    * no, finished sub-loop
.
          MOVE      MMCODE,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,SRTMB300
.
          MOVE      OPDADATE,CEFFDATE
          CALL      GETTHR00                * get theatre fee
          BRANCH    OVRCD,SRTMB300
.
.         Set the charge for this item
.
          MOVE      TFPAT1,SWPCHRGE
          ADD       TFHF1,SWPCHRGE
.
          COMPARE   SWPCHRGE,CURCHRGE
          GOTO      SRTMB300 IF NOT LESS
.
.         This item has a higher charge
.
          MOVE      SWPCHRGE,CURCHRGE
          MOVE      MMRECN,SWPMRECN
          GOTO      SRTMB300
.
.         Finished loop. Check if we have to swap items
.
SRTMB800  COMPARE   SWPMRECN,CURMRECN
          GOTO      SRTMB900 IF EQUAL        * do not swap
.
.         Swap the two records found. Use a record number of "-1" as a save
.         area to swap to.
.
          MOVE      OPDAADMN,MMADMN
          PACK      KEY11,MMADMN,CURMRECN     * current record -> temp.
          CALL      RDMMBS1
          BRANCH    OVRCD,SRTMB900
.
          MOVE      "-1",MMRECN              * temporary record number
          CALL      UPMMBS1
.
          PACK      KEY11,MMADMN,SWPMRECN
          CALL      RDMMBS1                  * new record -> current
          BRANCH    OVRCD,SRTMB850
.
          MOVE      CURMRECN,MMRECN
          CALL      UPMMBS1
.
          MOVE      "-1",MMRECN
          PACK      KEY11,MMADMN,MMRECN       * temp -> new record
          CALL      RDMMBS1
.
          MOVE      SWPMRECN,MMRECN
          CALL      UPMMBS1
          GOTO      SRTMB900
.
.         This code should never be executed, but we have it here just in case
.
SRTMB850  MOVE      "-1",MMRECN
          PACK      KEY11,MMADMN,MMRECN
          CALL      RDMMBS1
.
          MOVE      CURMRECN,MMRECN
          CALL      UPMMBS1
.
.         Reposition ready for the next loop
.
SRTMB900  MOVE      OPDAADMN,MMADMN
          PACK      KEY11,MMADMN,CURMRECN
          CALL      RDMMBS1
          GOTO      SRTMB100
.
SRTMB999  ENDPROC
.
.------------------------------------------------------------
.                       PRTREG00
.   Schedule Adhoc List Delete to be run via Program Scheduler
.------------------------------------------------------------
PRTREG00  MATCH     SP70,CASEKEYS
          GOTO      PRTREG99 IF EQUAL
.
          MOVE      "IBAOPR45",SCHDPGID
          MOVE      "Theatre Registration Form",SCHDDESC
          MOVE      CURRDATE,SCHDDATE
          CLOCK     TIME,SCHDTIME
.
          MATCH     SP70,SCHDPRNT
          IF        @EQUAL
            MOVE      "S",SCHDPRNT             * Spool File
          ENDIF 
.
.         Write Keyin parameters for Extract
.
          MOVE      ONE,KEYSTARR[1]          * Option
          MOVE      CASEKEYS,KEYSTARR[2]     * Casekeys
          MOVE      ANSY,KEYSTARR[3]         * Yes to continue
          MOVE      THREE,KEYSTCNT             * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
          MOVE      "IBAOPR45",SETDFPRG
          MOVE      "01",SETDFREP
          PACK      KEY20,SETDFPRG,SETDFREP,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT   * Printer
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
.
PRTREG99  RETURN
+
.******************************************************************************
.*                                 WESE0000                                   *
.*                Write/update wateseaf (episode details)                     *
.******************************************************************************
WESE0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WESE9999
.
          PACK     KEY17,WTWMECNT,SP70
          CALL     RDWTESE1
          IF       OVRCD=0
            GOTO     WESE0500
          ENDIF

          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,WESE9999
.
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      WESE1000 IF NOT EQUAL
.
WESE0500  MATCH     WTEEADAT,ADATE     * admission date already on file
          GOTO      WESE1000 IF NOT EQUAL
.
          MATCH     WTEEINSD,ACLAIM    * claim type already on file
          GOTO      WESE1000 IF NOT EQUAL
.
          MATCH     WTEEREMD,MMDATE    * operation date = removal date 
          GOTO      WESE9999 IF EQUAL
.
WESE1000  PACK      WTEEURNO,WMURNO
          PACK      WTEEADAT,ADATE
          PACK      WTEEINSD,ACLAIM
          PACK      WTEEREMD,MMDATE
          REP       " 0",WTEEREMD
          PACK      WTEEREMD,MMDATE
          REP       " 0",WTEEREMD
          MOVE      SP70,WTEERREM
          PACK      KEY5,ANSW,ANSR,SP70
          CALL      RDSCODE1
WESE1500  CALL      RDKCODE1
          BRANCH    OVRCD,WESE2000
          MATCH     "WR",TCODE
          GOTO      WESE2000 IF NOT EQUAL
.
          MATCH     ANSW,TCINDC3
          IF        @EQUAL
            MOVE      ACODE,WTEERREM
            GOTO      WESE2000
          ENDIF
          GOTO      WESE1500
.
WESE2000  PACK      WTEEEDAT,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          MOVE      ZERO,WTEEMANU
          PACK      WTEEASAS,SP70
.
          CALL      CLWATTX1
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
WESE2100  CALL      RDWTTX11
          BRANCH    OVRCD,WESE2500
.
          MOVE      WTTXASAS,WTEEASAS
.
WESE2500  PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          IF        OVRCD=0
            PACK      WTEEWEBU,USERID,SP70
            CALL      IBACLOCK
            MOVE      CURRDATE,WTEEUDAT
            CLOCK     TIME,WTEEUTIM
            REP       " 0",WTEEUTIM
            CALL      UPWTESE1
          ELSE
            PACK      WTEEWEBC,USERID,SP70
            CALL      IBACLOCK
            MOVE      CURRDATE,WTEECDAT
            CLOCK     TIME,WTEECTIM
            REP       " 0",WTEECTIM
            MOVE      SP70,WTEEWEBU
            MOVE      SP70,WTEEUDAT
            MOVE      SP70,WTEEUTIM
            MOVE      ZERO,WTEEMANU
            CALL      WRWTESE1
          ENDIF
.
WESE9999  RETURN
+
.-----------------------------------------------------------
.         Warning message for theatre system implant Coding
.-----------------------------------------------------------
WARNIM00  CALL      OPENHTML
          BRANCH    EXIT,WARNIM90
.
          MOVE      "Warning: Billing might need to be adjusted.",WEBTITLE
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");",012
.
          CLEAR     REDIRECT
          MATCH     "R",UPDATETY            * Delete Theatre Item (MBS or Misc.)
          IF        @EQUAL
            APPEND    "oprweb06.pbl?reportno=03&template=004&casekeys=",REDIRECT
          ELSE
            APPEND    "oprweb06.pbl?reportno=07&template=001&casekeys=",REDIRECT
          ENDIF
          APPEND    CASEKEYS,REDIRECT
          RESET     REDIRECT
.
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WARNIM99
.
WARNIM90  DISPLAY   "*** Fifo Not Found ***"
WARNIM99  RETURN
+
.*****************************************************************************
.*        Previous visit to theatre indicator                                *
.*****************************************************************************
          DEFPROC   PREVTHET
.
          INC       OPRDEAFD/INC
.
          OPEN      OPRDETA2,"oprdetaf"
.         
PTHV0000  MOVE      ZERO,PTHVFLAG
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
PTHV1000  CALL      RKOPDEA2
          BRANCH    OVRCD,PTHV9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      PTHV9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      PTHV1000 IF EQUAL
.
          MATCH     DIM10,OPDAUNIQ
          GOTO      PTHV2000 IF NOT EQUAL
          GOTO      PTHV1000
.
PTHV2000  MOVE      ONE,PTHVFLAG
          GOTO      PTHV9999
.
          INC       OPRDEAIO/INC
          INC       IBAOVRIO/INC
.
PTHV9999  ENDPROC
.******************************************************************************
.*  Get NZ Procedure details if required                                      *
.******************************************************************************
GETNZP00  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN9;*212,CFEETYP
          COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      GETNZP90 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
GETNZP10  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZP90
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      GETNZP90 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      GETNZP10 IF NOT EQUAL
          GOTO      GETNZP999
.
GETNZP90  CALL      CLNZSP00
.
GETNZP99  RETURN
+
.------------------------------------------------------------
. Clear file variables for NZPSPRFD
.------------------------------------------------------------
CLNZSP00  MOVE      SP70,NZSPADMN
          MOVE      SP70,NZSPCLMN
          MOVE      SP70,NZSPSURG
          MOVE      SP70,NZSPPROC
          MOVE      SP70,NZSPUNIQ
          MOVE      SP70,NZSPCNTR
          MOVE      SP70,NZSPCPRC
          MOVE      ZERO,NZSPPRIM
          MOVE      SP70,NZSPANAE
          MOVE      SP70,NZSPPDES
          MOVE      ZERO,NZSPICAP
          MOVE      ZERO,NZSPPIND
          MOVE      ZERO,NZSPPINS
          MOVE      SP70,NZSPINSR
          MOVE      SP70,NZSPAPRV
          MOVE      ZERO,NZSPAPSI
          MOVE      SP70,NZSPCLNO
          MOVE      SP70,NZSPAPNT
          MOVE      SP70,NZSPCMNT
          MOVE      ZERO,NZSPTDUR
          MOVE      ZERO,NZSPTFEE
          MOVE      SP70,NZSPUDF1
          MOVE      SP70,NZSPUDF2
          MOVE      SP70,NZSPCDAT
          MOVE      SP70,NZSPCTIM
          MOVE      SP70,NZSPCUID
          MOVE      SP70,NZSPUDAT
          MOVE      SP70,NZSPUTIM
          MOVE      SP70,NZSPUUID
          MOVE      SP70,NZSPADTE
          MOVE      ZERO,NZSPHPAY
          MOVE      ZERO,NZSPCPAY
          MOVE      ZERO,NZSPINVD
          MOVE      SP70,NZSPSPAR
.
CLNZSP99  RETURN
+
.******************************************************************************
.*                                 UARD0000                                   *
.* Update arrival and recovery details                                        *
.******************************************************************************
UARD0000  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,UARD9999
.
          CALL      MVOPAR00
          CALL      UPOPARD1
.
UARD9999  RETURN
.
.*****************************************************************************
.*        Check if surgery start is after previous end time (if required)    *
.*****************************************************************************
          DEFPROC   PREVTIME
.
          INC       OPRDEAFD/INC
          INC       OPRSRGFD/INC
.
SAVTHETR  DIM       6
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
.
PREN0000  MOVE      ZERO,EXIT
          MATCH     "1",OPCNSEMP
          GOTO      PREN9999 IF NOT EQUAL
.
          PACK      KEY10,OPSRG001,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,PREN9000
.
          MOVE      OPDATHET,SAVTHETR
          MATCH     OPSRG001,OPDAUNIQ
          GOTO      PREN9000 IF NOT EQUAL
.
          PACK      KEY22,OPDADATE,OPDATIME,OPDACLIN,SP70
          PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,OPDASTAT,SP70
          CALL      RDOPDEA5
PREN1000  CALL      RPOPDEA5
          BRANCH    OVRCD,PREN9000
.
          COMPARE   THREE,OPDASTAT
          GOTO      PREN1000 IF EQUAL
.
          PACK      SAVKEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     SAVKEY22,KEY22
          GOTO      PREN9000 IF NOT EQUAL
.
          MATCH     OPDATHET,SAVTHETR
          GOTO      PREN1000 IF NOT EQUAL
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,PREN2000
.
          MATCH     SP70,OPSGTISE
          GOTO      PREN3000 IF EQUAL
          MATCH     OPSGTISE,OPSRG005
          GOTO      PREN2000 IF LESS
          GOTO      PREN9000
.
PREN2000  MOVE      ONE,EXIT
          GOTO      PREN9999
.
PREN3000  MOVE      TWO,EXIT
          GOTO      PREN9999
.
PREN9000  MOVE      ZERO,EXIT
          GOTO      PREN9999
.
          INC       OPRDEAIO/INC
          INC       OPRSRGIO/INC
          INC       IBAOVRIO/INC
.
PREN9999  ENDPROC
.
.******************************************************************************
.*                 Main Action Routine for Tourniquet Details                 *
.******************************************************************************
OPRREG00  CALL      VALCAS00
          BRANCH    EXIT,OPRREG99
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Check for record
          BRANCH    OVRCD,OPRREG93
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      OPRREG40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Implant Code
          GOTO      OPRREG10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Implant Code
          GOTO      OPRREG20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Implant Code
          GOTO      OPRREG30 IF EQUAL
.
          GOTO      OPRREG90
.
OPRREG10  MOVE      ZERO,F2
          PACK      KEY12,OPJRR001,Z70
          CALL      RSOPJRR1
          CALL      RPOPJRR1
          BRANCH    OVRCD,OPRREG11
.
          MATCH     OPJRR001,OPJRUNIQ
          GOTO      OPRREG11 IF NOT EQUAL
.
          MOVE      OPJRRCNT,F2
.
OPRREG11  ADD       ONE,F2
          MOVE      F2,OPJRR002
.
          CALL      CLOPJR00                * clear file vars
          MOVE      OPJRR001,OPJRUNIQ
          MOVE      OPJRR002,OPJRRCNT
.
          CALL      MVOPJR00                * Move cgi to file vars
.
          CALL      ADDCOM00                * Comments
.
          MOVE      CURRDATE,OPJRCDAT
          CLOCK     TIME,OPJRCTIM
          MOVE      USERID,OPJRCUID
.
          PACK      KEY12,OPJRUNIQ,OPJRRCNT,SP70
          CALL      RAOPJRR1
          IF        OVRCD=1
            CALL      WROPJRR1
          ELSE
            GOTO      OPRREG11
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OPRREG99
.
OPRREG20  PACK      KEY12,OPJRR001,OPJRR002,SP70
          CALL      RDOPJRR1
          BRANCH    OVRCD,OPRREG94
.
          MOVE      OPJRCDAT,SAVECDAT
          MOVE      OPJRCTIM,SAVECTIM
          MOVE      OPJRCUID,SAVECUID
.
          CALL      CLOPJR00                * clear all file vars so only the
.                                           * cgi details that are displayed on
          CALL      MVOPJR00                * tha page are saved
.
          CALL      ADDCOM00                * Comments
.
          MOVE      SAVECDAT,OPJRCDAT
          MOVE      SAVECTIM,OPJRCTIM
          MOVE      SAVECUID,OPJRCUID
.
          MOVE      CURRDATE,OPJRUDAT
          CLOCK     TIME,OPJRUTIM
          MOVE      USERID,OPJRUUID
.
          CALL      UPOPJRR1
.
          MOVE      ZERO,EXIT
          GOTO      OPRREG99
.
OPRREG30  PACK      KEY12,OPJRR001,OPJRR002,SP70
          CALL      RDOPJRR1
          BRANCH    OVRCD,OPRREG94
.
          CALL      CHKI0000                * Check for linked implants
          BRANCH    EXIT,OPRREG95
.
          CALL      DEOPJRR1
.
          MOVE      ZERO,EXIT
          GOTO      OPRREG99
.
OPRREG40  PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,OPRREG91
.
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1
          BRANCH    OVRCD,OPRREG92
.
          PACK      KEY12,OPJRR001,OPJRR002,SP70
          CALL      RDOPJRR1
          IF        OVRCD=1
            CALL      CLOPJR00              * clear file vars
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Joint Replacement Registry Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRREG99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99

OPRREG91  MOVE      "Missing Theatre Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG92  MOVE      "Theatre Operating Room Details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG93  MOVE      "Arrival Details missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG94  MOVE      "Invalid Joint Registry Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG95  MOVE      "Invalid deletion linked implants exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
OPRREG99  CLOSE     REGCOMAF,DELETE
.
          RETURN
.
.******************************************************************************
.*                 Main Action Routine for Day Oncology Usage                 *
.******************************************************************************
DONCU000  CALL      CLOPRDEA
          MATCH     SP70,ADMISSNO
          GOTO      DONCU900 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      DONCU920 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DONCU920
.
          CALL      CLPMSPX2
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,DONCU900
          CALL      RDBKRX11
          BRANCH    OVRCD,DONCU900
.
          PACK      OPDADATE,BKREEDAT
          PACK      KEY18,ADMISSNO,SP70
          CALL      RSBKUNQ1                * Check for record
          CALL      RKBKUNQ1     
          BRANCH    OVRCD,DONCU900
.
          MATCH     ADMISSNO,BKUNVISN
          GOTO      DONCU900 IF NOT EQUAL
.
          MOVE      SP70,ADATE
          PACK      KEY8,ADMISSNO,SP70     * must be admitted or linked to inp
          CALL      RDMISS1
          IF        OVRCD<>1
            IF        ASTAT>1 & ASTAT<5
              GOTO      DONCU020
            ENDIF
          ENDIF
.
          MATCH     BKUNLADM,SP70
          GOTO      DONCU900 IF EQUAL
.
          PACK      KEY8,BKUNLADM,SP70
          CALL      RDMISS1
          IF        OVRCD<>1                
            IF        ASTAT>1 & ASTAT<5
              MATCH     ADATE,OPDADATE        * if Booking is after Admission
              GOTO      DONCU022 IF NOT LESS  * use Booking date
              GOTO      DONCU020
            ENDIF
          ENDIF     
          PACK      OPDAADMN,AADMNO,SP70
          GOTO      DONCU900
.         
DONCU020  MOVE      ADATE,OPDADATE
.
DONCU022  PACK      OPDAUNIQ,BKUNUNIQ,SP70
          MOVE      ONE,ONCOLOGY
.
          PACK      KEY10,BKUNUNIQ,SP70
          CALL      RDOPARD1                 * arrival/recovery details
          IF        OVRCD=1
            CALL      CLOPRARD
          ENDIF
.
          PACK      KEY11,BKUNUNIQ,ONE,SP70
          CALL      RDOPSRG1                 * surgical details
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      SP70,DTIME
          ENDIF
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      DONCU040 IF EQUAL
.
          MATCH     ANSU,UPDATETY
          GOTO      DONCU100 IF EQUAL
.
          MATCH     "P",UPDATETY            * Post Prov.MBS item
          GOTO      DONCU200 IF EQUAL
.
          MATCH     "B",UPDATETY            * Bill Prov.CMBS items
          GOTO      DONCU220 IF EQUAL
.
          GOTO      DONCU910
.
DONCU040  CLEAR     WEBTITLE
          MOVE      "Day Oncology Usage Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,DONCU999
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DONCU999
.
DONCU100  CALL      UPDONC00                * update day oncology usage
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      DONCU999
.
DONCU200  CALL      WRREG000                * Write regimes items to pmsmtiaf
.
DONCU220  MOVE      ZERO,EXIT
          GOTO      DONCU999
.
DONCU900  MOVE      "Invalid visit for day oncology usage",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRREG99
.
DONCU910  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DONCU999
.
DONCU920  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DONCU999
.
DONCU999  RETURN
.
.******************************************************************************
.*        Main Action Routine for Caesarean Birth Details                     *
.******************************************************************************
CSRBTH00  CALL      CLPATMAS                * clear master detils
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLPATMIS                * clear admission details
.
          CALL      VALCAS00
          BRANCH    EXIT,CSRBTH99
.
CSRBTH05  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      CSRBTH40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Caesarean Birth
          GOTO      CSRBTH10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Caesarean Birth
          GOTO      CSRBTH20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Caesarean Birth
          GOTO      CSRBTH30 IF EQUAL
.
          GOTO      CSRBTH98
.
.------------------------------------------------------------
.         ADD Form Action
.------------------------------------------------------------
CSRBTH10  PACK      KEY12,OPCBD001,OPCBD002,SP70
          CALL      RAOPCBD1
.
          IF        OVRCD=1
            CALL      CLOPRCBD
            CALL      SAVCBD00
            MOVE      WBSEUID,OPCBCUID
            MOVE      CURRDATE,OPCBCDAT
            MOVE      CTIMEIS,OPCBCTIM
            TRAP      OVERCOND IF IO
            CALL      WROPCBD1              * Writing record into oprcbdaf table
            TRAPCLR   IO
            BRANCH    OVRCD,CSRBTH99
          ENDIF
.
          GOTO      CSRBTH99
.
.------------------------------------------------------------
.         UPDATE Form Action
.------------------------------------------------------------
CSRBTH20  PACK      KEY12,OPCBD001,OPCBD002,SP70
          CALL      RDOPCBD1
          BRANCH    OVRCD,CSRBTH96
.
          CALL      SAVCBD00
          MOVE      WBSEUID,OPCBUUID
          MOVE      CURRDATE,OPCBUDAT
          MOVE      CTIMEIS,OPCBUTIM
.
          TRAP      OVERCOND IF IO
          CALL      UPOPCBD1
          TRAPCLR   IO
          BRANCH    OVRCD,CSRBTH99
.
          GOTO      CSRBTH99
.
.------------------------------------------------------------
.         DELETE Form Action
.------------------------------------------------------------
CSRBTH30  PACK      KEY12,OPCBD001,OPCBD002,SP70
          CALL      RDOPCBD1
          BRANCH    OVRCD,CSRBTH97
.
          MOVE      ZERO,F1
          MOVE      HARDDELT,F1
          BRANCH    F1,CSRBTH31
.
.         Soft (update) delete...
.
          MOVE      ONE,OPCBDELT
          MOVE      WBSEUID,OPCBDUID
          MOVE      CURRDATE,OPCBDDAT
          MOVE      CTIMEIS,OPCBDTIM
          TRAP      OVERCOND IF IO
          CALL      UPOPCBD1
          TRAPCLR   IO
          BRANCH    OVRCD,CSRBTH99
          GOTO      CSRBTH99
.
.         Hard (real) delete...
.
CSRBTH31  TRAP      OVERCOND IF IO
          CALL      DEOPCBD1
          TRAPCLR   IO
          BRANCH    OVRCD,CSRBTH99
.
.         Now shuffle the records thereafter backwards...
.
CSRBTH32  PACK      KEY12,OPCBUNIQ,OPCBCOUN,SP70
          CALL      RSOPCBD1
          CALL      RKOPCBD1
          BRANCH    OVRCD,CSRBTH99
.
          MATCH     OPDAUNIQ,OPCBUNIQ       * same Theatre Unique ID?
          GOTO      CSRBTH99 IF NOT EQUAL   * no; we're done now
.
          MOVE      OPCBCOUN,COUNT1         * save count of current record
          MOVE      ZERO,F2
          MOVE      OPCBCOUN,F2
          SUB       ONE,F2                  * decrement count
          MOVE      F2,OPCBCOUN
          CALL      WROPCBD1                * add as (new) previous record
.
          PACK      KEY12,OPCBUNIQ,COUNT1,SP70
          CALL      RDOPCBD1
          BRANCH    OVRCD,CSRBTH99
          CALL      DEOPCBD1                * delete current record
          GOTO      CSRBTH32                * get next record
.
.------------------------------------------------------------
.         DISPLAY Form Action
.------------------------------------------------------------
CSRBTH40  MATCH     SP70,CASEKEYS
          GOTO      CSRBTH90 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CSRBTH91
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,CSRBTH92
.
          BRANCH    PCEASE,CSRBTH93         * Patient Deceased
          MATCH     "M",PSEX
          GOTO      CSRBTH94 IF EQUAL
.
          CALL      MOTNAM00                * Format mother's name
.
          PACK      KEY8,PURNO
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY12,OPRCBUNI,OPRCBCNT,SP70
          CALL      RDOPCBD1
.
          CLEAR     WEBTITLE
          MOVE      "Caesarean Birth Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,CSRBTH99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
.------------------------------------------------------------
.         Error Handling
.------------------------------------------------------------
CSRBTH90  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH91  MOVE      "Can't Find Mother's Admission Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH92  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH93  MOVE      "Patient Is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH94  MOVE      "Patient Is Not Female",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH95  MOVE      "Add failed. Invalid record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH96  MOVE      "Update failed. Invalid record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH97  MOVE      "Delete failed. Invalid record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH98  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CSRBTH99
.
CSRBTH99  RETURN
+
.******************************************************************************
.*        Move cgi values to file variables (oprcbdaf)                        *
.******************************************************************************
SAVCBD00  MOVE      OPCBD001,OPCBUNIQ
          MOVE      OPCBD002,OPCBCOUN
          MOVE      OPCBD003,OPCBBSEX
          MOVE      OPCBD004,OPCBBDOB
          MOVE      OPCBD005,OPCBBTME
          MOVE      OPCBD006,OPCBBURN
.
          MOVE      SP70,OPCBBWGT
          MATCH     SP70,OPCBD007
          IF        !@EQUAL
            SQUEEZE    OPCBD007
            IF         !@EOS
              MOVE       ZERO,FORM6
              MOVE       OPCBD007,FORM6
              MOVE       FORM6,OPCBBWGT          * Baby's weight
            ENDIF
          ENDIF
          MOVE      OPCBD008,OPCBPDTM
.
SAVCBD99  RETURN
+
.******************************************************************************
.*        Format Mothers First Name                                           *
.******************************************************************************
MOTNAM00  SCAN      SP1,PGNAME               * Locate the first blank
          GOTO      MOTNAM10 IF NOT EQUAL
.
          BUMP      PGNAME,-1                * go back 1 to end of name
          MOVEFPTR  PGNAME,CCITEM
          RESET     PGNAME                   * reset the form pointer
          SETLPTR   PGNAME,CCITEM            * set logical length to end of name
.
MOTNAM10  PACK      MOTFNAME,PGNAME,SP1,PSNAME
          RESET     PGNAME
.
MOTNAM99  RETURN
+
.******************************************************************************
.*                      Update Day Procedure Details                          *
.******************************************************************************
UPDONC00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDONC99
          MATCH     Z70,PTMSX003
          IF        !@EQUAL
            PACK      PTMXLGA,PTMSX003
            CALL      UPMAST1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,UPDONC99
.
          CALL      MVBKRX00
          CALL      UPBKRX11
.
          MOVE      ONE,TEAMNUMB
          PACK      OPDAUNIQ,BKUNUNIQ,SP70
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1               * locks the record for updating
          BRANCH    OVRCD,UPDONC10
          GOTO      UPDONC20
.
UPDONC10  MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          CALL      CLOPRSRG
          MOVE      ZERO,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00
          CALL      WROPSRG1
          CALL      DFLTTM00
          MATCH     "B",UPDATETY
          IF        @EQUAL
            CALL      MBSCHK00              * write any Provisional MBS Items
          ENDIF
          GOTO      UPDONC30
.
UPDONC20  MOVE      TEAMNUMB,OPSRG002
          MOVE      OPDAUNIQ,OPSRG001
          MOVE      ONE,UPDTMFLG
          CALL      CHKOPM00                * Check for recalculation of Op Min
          CALL      MVOPSG00                * moving cgi variables to file var
          CALL      UPOPSRG1                * updating surgical details
.
.         Check if any mbs written to oprpmbs file
.
          CALL      GETMBS00                * Get Theatre MBS Details
          MATCH     "B",UPDATETY
          IF        @EQUAL
            CALL      MBSCHK00              * write any Provisional MBS Items
          ENDIF
.
...       IF        MBSTOTAL=0
...         CALL      MBSCHK00
...       ENDIF
.
          CALL      UUOPSRG1                * unlock the record
.
UPDONC30  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
            CALL      MVOPAR00
            MOVE      OPDAUNIQ,OPARUNID
            CALL      WROPARD1
          ELSE
            CALL      MVOPAR00
            CALL      UPOPARD1
          ENDIF
.
UPDONC99  RETURN
.
.******************************************************************************
.         Write regime item codes to pmsmtiaf file
.******************************************************************************
WRREG000  PACK      OPDAUNIQ,BKUNUNIQ,SP70
          MATCH     SP70,ADATE
          IF        @EQUAL
            MOVE      BKUNLADM,KEY8          * Use adm.date of linked adm.no
            CALL      RDMISS1
            BRANCH    OVRCD,WRREG999
          ENDIF
          MOVE      ZERO,TOTDTRA
          MOVE      ONE,F1
.
          MOVE      AADMNO,OPDAADMN
          MOVE      ZERO,CMBSFEE
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "1",TCINDC1             * check for overseas
            IF        @EQUAL
              MATCH     "1",TCINDC2           * Use MBS fee amount ?
              IF        @EQUAL
                MOVE      ONE,CMBSFEE
              ENDIF
            ENDIF
          ENDIF
          MOVE      ZERO,TFEEFLAG
.
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            MOVE      OPDAADMN,KEY8
            CALL      RDPMVX11
            MOVE      SP10,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            MATCH     "1",PTHSTFEE
            GOTO      WRREG080 IF NOT EQUAL   * not using theatre fees
          ELSE
            COMPARE   "1",PTCNTFEE
            GOTO      WRREG080 IF NOT EQUAL       * not using theatre fees
          ENDIF
.
.         Create tempfile for getting theatre fees for MBS code, base on most
.         expensive amount
.
          MOVE      ONE,TFEEFLAG
          MOVE      ZERO,MBSCNT             * initialize count and unique
          CALL      CTEMP000                * Create temp file
          MOVE      ONE,FORM3
          MOVE      FORM3,UNIQUE
.
.         Get Regime code for the patient
.
WRREG080  PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
WRREG100  CALL      RKPTRGM1
          BRANCH    OVRCD,WRREG800
.
          MATCH     ADMISSNO,PTRGADMN        * Same admission?
          GOTO      WRREG800 IF NOT EQUAL
.
.         Get the Items codes for the Regime
.
          PACK      KEY13,PTRGREGM,SP70
          CALL      RSPMREG1
WRREG200  CALL      RKPMREG1
          BRANCH    OVRCD,WRREG100
.
          MATCH     PTRGREGM,PMREREGM        * Same Regime code?
          GOTO      WRREG100 IF NOT EQUAL
.
          MATCH     "1",PMREITYP
          GOTO      WRREG400 IF EQUAL        * Misc.Charge item
.
          MATCH     "3",PMREITYP
          GOTO      WRREG200 IF NOT EQUAL    * Not a Misc.Charge item
.
.         MBS Items
.
          UNPACK    PMREITMN,PROVITEM
          UNPACK    PMREITMN,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,WRREG200           * Invalid item
.
          MOVE      SP70,PMMISUNQ
          BRANCH    TFEEFLAG,WRREG300        * Using Theatre fees
.
          MOVE      ZERO,TFPAT1
          MOVE      ZERO,TFHF1
          IF        CMBSFEE=1
            MOVE      QIAMT,TFPAT1
          ENDIF
          MOVE      IDESC,PMMIDESC
          MOVE      SP70,PMMIREFN
          CALL      USRAT000                * calculate rate for item & write
          GOTO      WRREG200                * get next item code
.
WRREG300  MOVE      IAMT,DIAMT
          MOVE      OPDADATE,CEFFDATE
          CALL      GETTHR00                * get theatre fee
          IF        OVRCD=1
            MOVE      ZERO,TFPAT1
            MOVE      ZERO,TFHF1
          ENDIF
.
          MOVE      TFPAT1,AMOUNT           * patient portion of charge
          ADD       TFHF1,AMOUNT            * rebate portion of charge
.
          MOVE      "1",OPPMTMNO
          PACK      DAMOUNT,AMOUNT,SP9      * Amount of charge
          PACK      KEY26,DAMOUNT,DIAMT,PROVITEM,UNIQUE
          MOVE      PTITGSTA,OPPMGSTA
          MOVE      PTITGSTC,OPPMGSTC
          MOVE      SP70,CONSTYPE
          MOVE      SP70,REFNUMBR
          WRITE     INPUSETF,KEY26;KEY26,OPPMTMNO,OPPMGSTA,OPPMGSTC,DOPPMCNT:
                                   CONSTYPE,REFNUMBR
          MOVE      UNIQUE,FORM3            * increment unique
          ADD       ONE,FORM3
          MOVE      FORM3,UNIQUE
          GOTO      WRREG200                * get next item code
.
.         Miscellaneous charges
.
WRREG400  UNPACK    PMREITMN,DIM9
          MOVE      SP70,DTRRE001
          MOVE      ONE,FORM3                * Quantity
......    MOVE      ADATE,OPDADATE
......    MOVE      SP70,OPDAUNIQ
          CALL      MISCHG00                 * Write Misc.charges
.
          GOTO      WRREG200                * get next item code
.
.         Check if we are using Theatre fee file for charging
.
WRREG800  COMPARE   ONE,TFEEFLAG
          GOTO      WRREG999 IF NOT EQUAL
.
          CALL      USCHP000                * charge patient
          CALL      DTEMP000                * delete tempfile
.
WRREG999  RETURN
+
.******************************************************************************
.*                      Reading for Tourniquet Details for Display            *
.******************************************************************************
JREG0000  BRANCH    FLDITMNO,JREG0100,JREG0200,JREG0300,JREG0400,JREG0500:
                             JREG0600,JREG0700,JREG0800,JREG0900
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      JREG9999
.
JREG0100  CALL      JTAB0000                     * Joint Reg Table
          GOTO      JREG9999
.
JREG0200  WRITE     HTMLFILE;OPDATHET;      * For Theatre Code
          GOTO      JREG9999
.
JREG0300  WRITE     HTMLFILE;OPRMDESC;      * For Theatre Description
          GOTO      JREG9999
.
JREG0400  WRITE     HTMLFILE;BKREDEPT;      * For Unit Code
          GOTO      JREG9999
.
JREG0500  MOVE      BKREDEPT,CODE           * Unit Description
          MOVE      "AC",CATEGORY
          CALL      CODITM00
          GOTO      JREG9999
.
JREG0600  WRITE     HTMLFILE;OPDADES1;      * For Operation Description
          GOTO      JREG9999
.
JREG0700  WRITE     HTMLFILE;OPSGTMNO;
          GOTO      JREG9999
.
JREG0800  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      JREG9999
.
JREG0900  CALL      RIDTAB00                * Table for Patient Implant Tables
          GOTO      JREG9999
.
JREG9999  RETURN
.
.******************************************************************************
. Table of Joint Registry Forms
.******************************************************************************
JTAB0000  PACK      KEY12,OPDAUNIQ,SP70
          CALL      RSOPJRR1
JTAB1000  CALL      RKOPJRR1
          BRANCH    OVRCD,JTAB9999
.
          MATCH     OPJRUNIQ,OPDAUNIQ
          GOTO      JTAB9999 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLink('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPJRUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPJRRCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      ZERO,F1
          MOVE      SP70,DIM30
          MOVE      OPJRTYPE,F1
          LOAD      DIM30,F1,FORMTYP1,FORMTYP2,FORMTYP3,FORMTYP4
.
          IF        F1=3
            MOVE      ZERO,F1
            MOVE      OPJRJOIN,F1
            LOAD      DIM30,F1,FORMTY31,FORMTY32,FORMTY33,FORMTY34
          ENDIF
.
          MOVE      SP70,DIM10
          MATCH     "1",OPJRPRIM
          IF        @EQUAL
            MOVE     "Primary",DIM10
          ENDIF
.
          MATCH     "2",OPJRPRIM
          IF        @EQUAL
            MOVE     "Revision",DIM10
          ENDIF
.
          MOVE      SP70,DIM5
          MATCH     "1",OPJRSIDE
          IF        @EQUAL
            MOVE     "Left",DIM5
          ENDIF
.
          MATCH     "2",OPJRSIDE
          IF        @EQUAL
            MOVE     "Right",DIM5
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DIM30,"#",":
                             "#"",DIM10,"#",":
                             "#"",DIM5,"#"":
                             ")"
          GOTO      JTAB1000
.
JTAB9999  RETURN
.
.*******************************************************************************
.                 Get Joint Reg Comments
.*******************************************************************************
GETCOM00  PREP      REGCOMAF,REGCOMNM
.
          MOVE      ONE,F3
          WRITE     REGCOMAF,SEQ;QRYDATA
          MOVE      ONE,REGCOMFL
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCOM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCOM80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETCOM10 IF EQUAL
          GOTO      GETCOM10 IF EOS
          ADD       ONE,F3
          WRITE     REGCOMAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCOM90  MOVE      F3,LASTREGC
          OPEN      REGCOMAF,REGCOMNM
GETCOM99  RETURN
.
.-------------------------------------------------------------------
.   Add joint reg comments
.------------------------------------------------------------------
ADDCOM00  COMPARE   ZERO,REGCOMFL     * No Comments in Update Ignore
          GOTO      ADDCOM99 IF EQUAL
.
          MOVE      ZERO,F3
          MOVE      SP70,OPJRCMT1
          MOVE      SP70,OPJRCMT2
          MOVE      SP70,OPJRCMT3
          MOVE      SP70,OPJRCMT4
          MOVE      SP70,OPJRCMT5
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      REGCOMAF,REGCOMNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADDCOM99
.
ADDCOM10  ADD       ONE,F3
          READ      REGCOMAF,SEQ;DIM70
          GOTO      ADDCOM80 IF OVER
          STORE     DIM70,F3,OPJRR039,OPJRR040,OPJRR041,OPJRR042,OPJRR043
          GOTO      ADDCOM10
.
ADDCOM80  MATCH     Z70,OPJRR039
          IF        !@EQUAL
            MOVE      OPJRR039,OPJRCMT1
          ENDIF
.
          MATCH     Z70,OPJRR040
          IF        !@EQUAL
            MOVE      OPJRR040,OPJRCMT2
          ENDIF
.
          MATCH     Z70,OPJRR041
          IF        !@EQUAL
            MOVE      OPJRR041,OPJRCMT3
          ENDIF
.
          MATCH     Z70,OPJRR042
          IF        !@EQUAL
            MOVE      OPJRR042,OPJRCMT4
          ENDIF
.
          MATCH     Z70,OPJRR043
          IF        !@EQUAL
            MOVE      OPJRR043,OPJRCMT5
          ENDIF
.
ADDCOM99  RETURN
.
.******************************************************************************
.* Joint registry form linked implant details 
.******************************************************************************
RIDTAB00  PACK      KEY12,OPJRR001,OPJRR002,SP70
          CALL      RDOPJRR1
          BRANCH    OVRCD,RIDTAB99
. 
          PACK      KEY13,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPPIM1
RIDTAB10  CALL      RKOPPIM1                * Read Patient Implant Table
          BRANCH    OVRCD,RIDTAB99
.
          MATCH     OPPIUNID,OPDAUNIQ       * Match Unique ID
          GOTO      RIDTAB99 IF NOT EQUAL
          MATCH     OPPITMNO,TEAMNUMB       * Match Team Number
          GOTO      RIDTAB99 IF NOT EQUAL
.
          PACK      KEY75,OPPIICDE,OPPIBCOD,SP70
          CALL      RDOPTHI1                * Read Theatre Implants Table
          BRANCH    OVRCD,RIDTAB10
.
          MOVE      "Ow",CATEGORY           * Location
          MOVE      OPPILOCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MOVE      "OW",CATEGORY           * Type Of Implant
          MOVE      OPTITYIM,CODE
          CALL      GETCOD00
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLink('",HTMLLINK
          APPEND    OPPIICDE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPPICNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY15,OPPIUNID,OPPITMNO,OPPICNTR,OPJRRCNT,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPPIICDE,"#",":
                             "#"",OPTIDESC,"#",":
                             "#"",TDESC,"#",":
                             "#"",OPPILTSN,"#",":
                             "#"",OPPIIQTY,"#",";
.
          MATCH     OPJRRCNT,OPPIRCNT
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=linkimpl checked":
                      " value='",KEY15,"' onClick=UpdateImplant(this);>":
                      "#"";
          ELSE 
            MATCH     SP70,OPPIRCNT
            IF        @EQUAL
              WRITE     HTMLFILE;"#"<input type=checkbox name=linkimpl":
                      " value='",KEY15,"' onClick=UpdateImplant(this);>":
                      "#"";
            ELSE
              WRITE     HTMLFILE;"#"<input type=checkbox name=linkimpl":
                                 " disabled checked>":
                                 "#"";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;")"
          GOTO      RIDTAB10
.
..        WRITE     HTMLFILE;"<tr><td nowrap>":
..                           "<img src=../images/EditIcon.gif class=Icon ":
..                           "onclick=#"UpdateLink('":
..                           CASEKEYS,"','",TEAMNUMB,"','",OPPMCNTR,"');#">":
..                           OPPMCMBS,"</td><td>":
..                           IDESC,"</td></tr>";
.
RIDTAB99  RETURN
.
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
          BRANCH    REMOTENO,REMOTE40
.
          MOVE      ZERO,F1
          MOVE      UPDATETY,F1
          BRANCH    F1,REMOTE10,REMOTE20,REMOTE30
.
          MATCH     "L",UPDATETY
          GOTO      REMOTE50 IF EQUAL
.
          MATCH     "D",UPDATETY       * Update oprardaf.opartidp    *T0869563
          GOTO      REMOTE60 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      REMOTE70 IF EQUAL
.
          MATCH     "T",UPDATETY
          GOTO      REMOTE80 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      LNKI0000                * Link/Unlink Implant 
          GOTO      REMOTE90     
.
REMOTE20  CALL      RECF0000                * Recovery Full
          GOTO      REMOTE90
.
REMOTE30  CALL      VALURN00                * Validate U/R exists
          GOTO      REMOTE90
.
REMOTE40  CALL      UPRS0000                * Update Prosthetic input complete 
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             EXIT,"</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE50  CALL      CHKRWL00      * Check for Referral Waiting List Links
          GOTO      REMOTE90
.
REMOTE60  CALL      UPTIDP00       * Update Ready to Depart time   *T0869563
          GOTO      REMOTE90
.
REMOTE70  CALL      PRTREQ00       * Update Ready to Depart time   *T0869563
          GOTO      REMOTE90
.
REMOTE80  CALL      POTPRV00       * Get Patient Out of Theatre of Prev Patient
          GOTO      REMOTE90
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
+
.******************************************************************************
.  Check for Referral Waiting List Links (allwlnaf)
.******************************************************************************
CHKRWL00  PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,CHKRWL90
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDALWLN1                               * Ref/WL Link record
          BRANCH    OVRCD,CHKRWL90
.
          PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
          CALL      RDATREA1                               * WL record exists?
          BRANCH    OVRCD,CHKRWL90
.
          PACK      KEY8,ALWLVISN,SP70
          CALL      RDALREF1                               * Ref record exists?
          BRANCH    OVRCD,CHKRWL90
.
CHKRWL80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ALREVISN,"|",ALREDEPT:            * Referral number/dept
                    "</RETURN_VALUE>"
          GOTO      CHKRWL99
.
CHKRWL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No Referral Waiting List Link
                    "</RETURN_VALUE>"
          GOTO      CHKRWL99
.
CHKRWL99  RETURN
+
.******************************************************************************
. T0869563
. Update Ready to Depart time (opartidp) with the current time if it is after 
. the Time in Recovery and before Exit Recovery time 
.******************************************************************************
UPTIDP00  PACK      KEY10,OPRARKEY,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,UPTIDP90      * Error - Record not found
.
.-------- Check The order of the Time in Recovery
          MATCH     SP70,OPARTIRF       * Time in Recovery Front entered?
          GOTO      UPTIDP10 IF EQUAL|EOS * No, check opartird
.
          MOVE      OPARTIRF,D8           *Yes,use Time Recovery - Front
          GOTO      UPTIDP40
.
UPTIDP10  MATCH     SP70,OPARTIRD       * Time in Recovery Back entered?
          GOTO      UPTIDP20 IF EQUAL|EOS * No, check opartirb
.
          MOVE      OPARTIRD,D8           * Yes, use Time in Recovery - Back
          GOTO      UPTIDP40
.
UPTIDP20  MATCH     SP70,OPARTIRB       * Time in Recovery - Day Proc entered?
          GOTO      UPTIDP91 IF EQUAL|EOS * No, error
.
          MOVE      OPARTIRB,D8           * Yes, use Time in Recovery 
          GOTO      UPTIDP40              *      Day Procedure
.
.-------- Convert DIM time fields to FORM fields
UPTIDP40  CALL      IBACLOCK                    * Get current time
          UNPACK    CTIMEIS,CHOUR,D1,CMIN,D1,D2
          PACK      D6,CHOUR,CMIN,D2
          MOVE      D6,FORMTIDP                 * Current time
.
          UNPACK    D8,CHOUR,D1,CMIN,D1,D2
          PACK      D6,CHOUR,CMIN,D2
          MOVE      D6,FORMTIRF                 * Time into recovery 
.
          IF        FORMTIRF = 0
            GOTO      UPTIDP91    * Error - Time into Recovery missing
          ENDIF
.
          MATCH     SP70,OPARTETC               * Exit Recovery Time
          IF        @EQUAL | @EOS
            MOVE      ZERO,FORMTETC
          ELSE
            UNPACK    OPARTETC,CHOUR,D1,CMIN,D1,D2
            PACK      D6,CHOUR,CMIN,D2
            MOVE      D6,FORMTETC                 
          ENDIF
.
.-------- Check if Ready to Depart time can be updated with the current time
          IF        (FORMTIRF > 0 & FORMTIDP <= FORMTIRF)
            GOTO      UPTIDP92    * Error - current time before Time in Recovery
          ENDIF
.
          IF        (FORMTETC > 0 & FORMTIDP >= FORMTETC)
            GOTO      UPTIDP93    * Error - current time after Exit Recov Time
          ENDIF
.
.-------- Update Ready to Depart time with the current time
UPTIDP80  MOVE      CTIMEIS,OPARTIDP      * Set Ready to Depart as current time
          CALL      UPOPARD1              * Update oprardaf Table
.
          PACK      KEY10,OPARUNID,SP70
          CALL      RDOPDEA3  
          IF        OVRCD<>1
            MOVE      OPDAADMN,ADMISSNO
            PROC      PMSCURTH           * Update patient header theatre status
          ENDIF
.
          GOTO      UPTIDP99
.
.-------- Return Error Messages
UPTIDP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid oprardaf record ",KEY10:
                    "</RETURN_VALUE>"
          GOTO      UPTIDP99
.
UPTIDP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Time into Recovery needs to be entered first ":
                    "</RETURN_VALUE>"
          GOTO      UPTIDP99
.
UPTIDP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Ready to Depart Time can't be before Time into Recovery ":
                    "</RETURN_VALUE>"
          GOTO      UPTIDP99
.
UPTIDP93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Exit Theatre Complex can't be before Ready to":
                    " Depart Time ":
                    "</RETURN_VALUE>"
          GOTO      UPTIDP99
.
UPTIDP99  RETURN
+
.******************************************************************************
. Link/Unlink an implant to a joint replacement registry form
.******************************************************************************
LNKI0000  PACK      KEY13,IMPLANTK,SP70
          CALL      RDOPPIM1
          BRANCH    OVRCD,LNKI9000
.
          MOVE      LINKREGF,OPPIRCNT       * Link/Unlink Joint Reg form
.
          CALL      UPOPPIM1                * Update Patient Implant Table
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Implant record linked":
                             "</RETURN_VALUE>"
.
          GOTO      LNKI9999
.
LNKI9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid implant detail record",KEY13:
                    "</RETURN_VALUE>"
.
LNKI9999  RETURN
+
.******************************************************************************
. Update recovery full details for cat YD theatre location code
. Update patcodes record HDP with "F" to indicate recovery full
.******************************************************************************
RECF0000  MATCH     Z70,RECOVFUL
          GOTO      RECF9100 IF EQUAL
.
          MATCH     "ALL",SURGTYPE
          IF        @EQUAL
            MOVE      SP70,SURGTYPE
          ENDIF
.
          MATCH     SP70,SURGTYPE
          GOTO      RECF5000 IF EQUAL
.
          PACK      KEY5,CATYD,SURGTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RECF9000
.
          MATCH     "1",RECOVFUL
          IF        @EQUAL
            MOVE      ANSF,THCSCOD
          ELSE
            MOVE      SP70,THCSCOD
          ENDIF
.
          CALL      UPCODE1
          GOTO      RECF8000
.
RECF5000  PACK      KEY5,CATYD,SP70
          CALL      RDSCODE1
RECF5500  CALL      RDKCODE1
          BRANCH    OVRCD,RECF8000
.
          MATCH     CATYD,TCODE
          GOTO      RECF8000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      RECF5500 IF EQUAL

          MATCH     "1",RECOVFUL
          IF        @EQUAL
            MOVE      ANSF,THCSCOD
          ELSE
            MOVE      SP70,THCSCOD
          ENDIF
.
          CALL      UPCODE1
          GOTO      RECF5500
.
RECF8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Ok":
                             "</RETURN_VALUE>"
.
          GOTO      RECF9999
.
RECF9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid location code : ",SURGTYPE:
                    "</RETURN_VALUE>"
.
RECF9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Form Action":
                    "</RETURN_VALUE>"
.
RECF9999  RETURN
+
.******************************************************************************
. Link/Unlink an implant to a joint replacement registry form
.******************************************************************************
VALURN00  MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALURN91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"
          GOTO      VALURN99
.
VALURN91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient UR - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALURN99
.
VALURN99  RETURN
+
.******************************************************************************
. Check if there are any linked implants for this joint registry form
.******************************************************************************
CHKI0000  MOVE      ZERO,EXIT
          PACK      KEY13,OPJRUNIQ,SP70
          CALL      RSOPPIM1
CHKI1000  CALL      RKOPPIM1
          BRANCH    OVRCD,CHKI9999
.
          MATCH     OPJRUNIQ,OPPIUNID
          GOTO      CHKI9999 IF NOT EQUAL
.
          MATCH     OPJRRCNT,OPPIRCNT
          GOTO      CHKI1000 IF NOT EQUAL
.
          MOVE      ONE,EXIT
.
CHKI9999  RETURN
.
.
.------------------------------------------------------------
. Get the appropriate miscellaneous charges record
.------------------------------------------------------------
GETMSC00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9            * (MCHARGE re-use in PATMCHRD)
.
          UNPACK    SP20,PTHFBCAT      * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
.
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,KEY9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - try a blank health fund
.
GETMSC10  PACK      KEY29,ACLAIM,SP6,SP3,KEY9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - last chance, try default claim
.
GETMSC20  IF        IBCNMHOS=1
            MOVE      PTHSDCLM,MCLMCOD
          ELSE
            MOVE      PTCNDCLM,MCLMCOD
          ENDIF
GETMSC30  PACK      KEY29,MCLMCOD,SP6,SP3,KEY9,OPDADATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
.
.                 * EXIT is set - 0=OK, 1=invalid, inactive, not in date range
GETMSC99  RETURN                        * also see WKMCINAC & WKMCXXDT
.
.-------------------------------------------------------------------------
. GETRGC00 - Get Multiple Regime Code for Admission Number
.-------------------------------------------------------------------------
GETRGC00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGC99
.
          WRITE     HTMLFILE;PTRGREGM;
.
GETRGC99  RETURN
.
.-------------------------------------------------------------------------
. GETRGC00 - Get Multiple Regime Description for Admission Number
.-------------------------------------------------------------------------
GETRGD00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGD99
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,GETRGD99
.
          WRITE     HTMLFILE;PMREDESC;
.
GETRGD99  RETURN
+
.-------------------------------------------------------------------------
. UPMMB000 - Update patmmbsf Start/end times
.-------------------------------------------------------------------------
UPMMB000  MOVE      ZERO,TIMEDONE
.                                           * restore Opr Arrival/Recovery times
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Read Arrival/Departure table
          BRANCH    OVRCD,UPMMB999
.
          CALL      RCVT0000                * determine time in recovery
.
.                                           * read thru "patmmbsf" MBS Items
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
UPMMB010  CALL      RDKMMBS1
          BRANCH    OVRCD,UPMMB999
.
          MATCH     ADMISSNO,DMMADMN
          GOTO      UPMMB999 IF NOT EQUAL

          MATCH     PTMMOPID,OPDAUNIQ       * Same unique number      *I-224277
          GOTO      UPMMB010 IF NOT EQUAL                             *I-224277
.
.                                           * set Start Time
          LOAD      DIM5,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                  OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                  OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                  OPARTIDP,OPARTETC
          MATCH     MMSTIM,DIM5                               * start *C-224277
          GOTO      UPMMB020 IF EQUAL
          MOVE      DIM5,MMSTIM
          MOVE      ONE,TIMEDONE                              * end   *C-224277
.                                           * set End Time
UPMMB020  LOAD      DIM5,OPCNTTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                    OPARTIDP,OPARTETC
          MATCH     MMETIM,DIM5                               * start *C-224277
          GOTO      UPMMB030 IF EQUAL
          MOVE      DIM5,MMETIM
          MOVE      ONE,TIMEDONE                              * end   *C-224277
.
UPMMB030  IF        TIMEDONE = 1
            CALL      UPMMBS1
          ENDIF
.
          MOVE      ZERO,TIMEDONE
          GOTO      UPMMB010
.
UPMMB999  RETURN
+
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {"
          COMPARE   ZERO,WARNCNT
          GOTO      ERRLST20 IF EQUAL
.
          MOVE      ONE,F2
ERRLST10  WRITE     HTMLFILE;"    alert(#"",WEBWRN[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,WARNCNT
          GOTO      ERRLST20 IF LESS
          GOTO      ERRLST10
.
ERRLST20  WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      ERRLST98
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST98  MOVE      ZERO,WARNCNT
ERRLST99  RETURN
+
.-------------------------------------------------------------------
.   Add Item Description  text
.------------------------------------------------------------------
ITMDES00  COMPARE   ZERO,ITMDESFL     * No Comments in Update Ignore
          GOTO      ITMDES99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,OPRAA045
          MOVE      SP70,OPRAA046
          MOVE      SP70,OPRAA047
          MOVE      SP70,OPRAA048
          MOVE      SP70,OPRAA049
          MOVE      SP70,OPRAA050
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ITMDESAF,ITMDESNM
          TRAPCLR   IO
          BRANCH    OVRCD,ITMDES99
.
ITMDES10  ADD       ONE,F3
          READ      ITMDESAF,SEQ;ITEMDATA
          GOTO      ITMDES80 IF OVER
          STORE     ITEMDATA,F3,OPRAA045,OPRAA046,OPRAA047,OPRAA048,OPRAA049:
                                OPRAA050
          GOTO      ITMDES10
.
ITMDES80  MOVE      OPRAA045,OPAAOTFD
          MOVE      OPRAA046,OPAAOTF1
          MOVE      OPRAA047,OPAAOTF2
          MOVE      OPRAA048,OPAAOTF3
          MOVE      OPRAA049,OPAAOTF4
          MOVE      OPRAA050,OPAAOTF5
.
ITMDES99  RETURN
+
.------------------------------------------------------------------------------
.         
.------------------------------------------------------------------------------
GETDES00  PREP      ITMDESAF,ITMDESNM
.
          MOVE      ONE,F3
          WRITE     ITMDESAF,SEQ;QRYDATA
          MOVE      ONE,ITMDESFL
.
GETDES10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETDES90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETDES80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETDES20 IF EQUAL
          GOTO      GETDES20 IF EOS

GETDES20  ADD       ONE,F3
          WRITE     ITMDESAF,SEQ;QRYDATA
          GOTO      GETDES10
.
GETDES80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETDES90  MOVE      F3,LASTITEM
          OPEN      ITMDESAF,ITMDESNM
GETDES99  RETURN
+
.-------------------------------------------------------------------------------
.
.-------------------------------------------------------------------------------
ADDOPR00  IF        AAEFLAG=1
            PACK      KEY30,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,ADMISSNO,SP70
            CALL      RDOPAAE1
            IF        OVRCD=1
              CALL      MVOPRA00
              CALL      ITMDES00
              PACK      OPAADATE,OPDADATE
              PACK      OPAATIME,OPDATIME
              PACK      OPAACLIN,OPDACLIN
              PACK      OPAACASE,OPDACASE
              PACK      OPAAADMN,ADMISSNO
              CALL      WROPAAE1
            ELSE
              CALL      MVOPRA00
              CALL      ITMDES00
              CALL      UPOPAAE1
            ENDIF
          ENDIF
.
ADDOPR99  RETURN
+
.-------------------------------------------------------------------------------
.   Ward selection routine (called from WATDETTM) 
.-------------------------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
+
.-------------------------------------------------------------------------------
. RECTIM00 - Validate Recovery Time - Day Procedure
.-------------------------------------------------------------------------------
RECTIM00  MOVE      ZERO,EXIT
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,RECTIM99
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL & !@EOS
            GOTO      RECTIM30
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL & !@EOS
            GOTO      RECTIM30
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL & !@EOS
            GOTO      RECTIM30
          ENDIF
.
          GOTO      RECTIM99
.
RECTIM30  MATCH     SP70,OPARD042
          GOTO      RECTIM90 IF EQUAL
          GOTO      RECTIM90 IF EOS
.
          MATCH     SP70,OPSRG005
          GOTO      RECTIM90 IF EQUAL
          GOTO      RECTIM90 IF EOS
.
          MATCH     SP70,OPSRG006
          GOTO      RECTIM90 IF EQUAL
          GOTO      RECTIM90 IF EOS
.
          GOTO      RECTIM99
.
RECTIM90  MOVE      "Patient in Recovery. Anaesthetic/Surgery times cannot be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECTIM99
.
RECTIM99  RETURN
.
.******************************************************************************
.* Recovery Closed Main Line
.******************************************************************************
RECCLS00  MATCH     SP70,UPDATETY
          GOTO      RECCLS50 IF EQUAL
.
          MATCH     "A",UPDATETY
          GOTO      RECCLS10 IF EQUAL       * Recovery Enquiry List
.
          MATCH     "U",UPDATETY            * Update Recovery Details
          GOTO      RECCLS20 IF EQUAL
.
          GOTO      RECCLS90
.
.******************************************************************************
.* Add Recovery Closed 
.******************************************************************************
RECCLS10  MATCH     SP70,OPRCI001
          IF        @EQUAL
            CALL      ALLCLS00              * Close all recovery locations
            GOTO      RECCLS15
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,OPRCI013
          ELSE
            MOVE      SP70,OPRCHOSP
          ENDIF
.
          PACK      KEY22,OPRCI001,OPRCI002,OPRCI003,OPRCI013,SP70
          CALL      RDOPRCI1
          COMPARE   ONE,OVRCD
          GOTO      RECCLS91 IF NOT EQUAL
.
          PACK      KEY22,OPRCI001,Z70      * Is this location already closed
          CALL      RSOPRCI1
RECCLS13  CALL      RPOPRCI1
          BRANCH    OVRCD,RECCLS14
.
          MATCH     OPRCI001,OPRCLOCN       * Correct location
          GOTO      RECCLS14 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RECCLS13 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RECCLS13 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RECCLS93 IF EQUAL
.
RECCLS14  CALL      CLOPRRCI
.
          PACK      OPRCCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPRCCDAT           * Created date
          CLOCK     TIME,OPRCCTIM           * Created time
          MOVE      USERID,OPRCCSUI         * Created by
.                 
          CALL      MVOPRC00                * Move cgi to file vars
.
          PACK      KEY22,OPRCLOCN,OPRCSDAT,OPRCSTIM,OPRCHOSP,SP70
          CALL      WROPRCI1
.
RECCLS15  CALL      PRTCLS00                * Print recovery closed report
.
          MOVE      ZERO,EXIT
          GOTO      RECCLS99
.
.******************************************************************************
.* Update Recovery Closed 
.******************************************************************************
RECCLS20  PACK      KEY22,OPRCI001,OPRCI002,OPRCI003,OPRCI013,SP70
          CALL      RDOPRCI1
          BRANCH    OVRCD,RECCLS92
.
          MOVE      OPRCEDAT,SAVEEDAT       * Save original end date
.
          CALL      MVOPRC00                * Move cgi to file vars
.
          MATCH     SP70,OPRCEDAT
          IF        @EQUAL
            MOVE      SP70,OPRCCEUI         * Clear close end entered by fields
            MOVE      SP70,OPRCCEDT
            MOVE      SP70,OPRCCETM
          ENDIF
.
          MATCH     SP70,SAVEEDAT           * Update end entered by 
          IF        @EQUAL
            MATCH     SP70,OPRCEDAT
            IF        !@EQUAL
              PACK      OPRCCEDT,CCC,CYY,CMM,CDD
              REP       " 0",OPRCCEDT           * end date entered date
              CLOCK     TIME,OPRCCETM           * end time entered time
              MOVE      USERID,OPRCCEUI         * end by entered by
            ENDIF
          ENDIF
.
          CALL      UPOPRCI1
.
          CALL      PRTCLS00                    * Print recovery closed report
.
          MOVE      ZERO,EXIT
          GOTO      OPRREC99
.
.
.******************************************************************************
.* Display Recovery Closed 
.******************************************************************************
RECCLS50  PACK      KEY22,OPRCI001,OPRCI002,OPRCI003,OPRCI013,SP70
          CALL      RDOPRCI1                 * read recovery closed record
          IF        OVRCD=1
            CALL      CLOPRRCI
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Close Recovery Management",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,OPRREC99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      RECCLS99
.
RECCLS90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECCLS99
.
RECCLS91  MOVE      "Recovery closed record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECCLS99
.
RECCLS92  MOVE      "Invalid recovery closed record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECCLS99
.
RECCLS93  MOVE      "Recovery location is already closed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECCLS99
.
RECCLS99  RETURN
.
.------------------------------------------------------------
. Close all recovery locations
.------------------------------------------------------------
ALLCLS00  PACK      PTCDKEY2,ANSY,ANSD,SP70
          CALL      RDSCODE2
ALLCLS10  CALL      RDKCODE2                   * Read location cat YD
          BRANCH    OVRCD,ALLCLS99
.
          MATCH     "YD",TCODE                 * Correct category
          GOTO      ALLCLS99 IF NOT EQUAL
.
          MATCH     SP70,ACODE                 * Skip category record
          GOTO      ALLCLS10 IF EQUAL
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      ALLCLS10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS              * Check hospital security
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,ALLCLS10
            ENDIF
          ENDIF
.
          PACK      KEY22,ACODE,Z70         * Recovery closed for this location
          CALL      RSOPRCI1
ALLCLS15  CALL      RPOPRCI1
          BRANCH    OVRCD,ALLCLS20
.
          MATCH     ACODE,OPRCLOCN          * Correct location
          GOTO      ALLCLS20 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP     * If Multi Hospital, check Hospital
            GOTO      ALLCLS15 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP          * Blank if Not Multi hospital
            GOTO      ALLCLS15 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      ALLCLS10 IF EQUAL       * Skip location is already closed
.
ALLCLS20  MOVE      ACODE,OPRCI001          * Populate recovery location code
.
          IF        IBCNMHOS=1
            MOVE      OPRCHOSP,OPRCI013
          ELSE
            MOVE      SP70,OPRCI013
          ENDIF

          CALL      CLOPRRCI
.
          PACK      OPRCCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPRCCDAT           * Created date
          CLOCK     TIME,OPRCCTIM           * Created time
          MOVE      USERID,OPRCCSUI         * Created by

          CALL      MVOPRC00                * Move cgi to file vars
.
          PACK      KEY22,OPRCLOCN,OPRCSDAT,OPRCSTIM,OPRCHOSP,SP70
          CALL      WROPRCI1
.
          GOTO      ALLCLS10
.
ALLCLS99  RETURN
.
.------------------------------------------------------------
. Print the recovery closed report via the scheduler
.------------------------------------------------------------
PRTCLS00  COMPARE   ONE,PRINTCLS
          GOTO      PRTCLS99 IF NOT EQUAL
.
          MOVE      "IBAOPR33",SCHDPGID
          MOVE      "Recovery Closed Report",SCHDDESC
          MOVE      CURRDATE,SCHDDATE
          CLOCK     TIME,SCHDTIME
.
          MATCH     SP70,SCHDPRNT
          IF        @EQUAL
            MOVE      "S",SCHDPRNT             * Spool File
          ENDIF
.
.         Write Keyin parameters for Extract
.
          MOVE      ONE,KEYSTARR[1]          * Option
.
          IF        EXPEXCEL=1
            MOVE      ANSY,KEYSTARR[2]       * Export to excel
          ELSE
            MOVE      ANSN,KEYSTARR[2]       * Export to excel
          ENDIF
.
          IF        IBCNMHOS=1 
            MOVE      OPRCI013,KEYSTARR[3]
            MOVE      ANSY,KEYSTARR[4]         * Yes to continue
            MOVE      FOUR,KEYSTCNT            * Number of Keyins
          ELSE
            MOVE      ANSY,KEYSTARR[3]         * Yes to continue
            MOVE      THREE,KEYSTCNT           * Number of Keyins
          ENDIF
.
          CALL      SCHPRO00   * Schedule Extract
.
          MOVE      "IBAOPR33",SETDFPRG
          MOVE      "01",SETDFREP
          PACK      KEY20,SETDFPRG,SETDFREP,USERID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT   * Printer
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
.
PRTCLS99  RETURN
.
.******************************************************************************
.* Check if recovery is closed
.******************************************************************************
RCLS0000  MATCH     SP70,LOCATION           * All locations
          GOTO      RCLS5000 IF EQUAL
.
          MATCH     "ALL",LOCATION          * All locations
          GOTO      RCLS5000 IF EQUAL
.
          PACK      KEY22,LOCATION,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS4000  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS9999
.
          MATCH     LOCATION,OPRCLOCN       * Correct location
          GOTO      RCLS9999 IF NOT EQUAL
.
          IF IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS4000 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS4000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS4000 IF NOT EQUAL
.         GOTO      RCLS9999 IF NOT EQUAL  
.
          WRITE     HTMLFILE;"1";           * Yes recovery closed
          GOTO      RCLS9999
.
RCLS5000  PACK      PTCDKEY2,ANSY,ANSD,SP70
          CALL      RDSCODE2
RCLS6000  CALL      RDKCODE2                   * Read location cat YD
          BRANCH    OVRCD,RCLS9999
.
          MATCH     "YD",TCODE                 * Correct category
          GOTO      RCLS9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE                 * Skip category record
          GOTO      RCLS6000 IF EQUAL
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      RCLS6000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS              * Check hospital security
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,RCLS6000
            ENDIF
          ENDIF
.
          PACK      KEY22,ACODE,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS7000  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS6000
.
          MATCH     ACODE,OPRCLOCN       * Correct location
          GOTO      RCLS6000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS7000 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS7000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS6000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"2";           * Yes a recovery location is closed
.
RCLS9999  RETURN
.
.******************************************************************************
. Link to Next page of recovery closures
.******************************************************************************
NXTCLS00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTLOCN
.
          WRITE     HTMLFILE;"oprweb06.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtlocn=",FILTLOCN;
.
          REP       "+ ",FILTLOCN
.
NXTCLS99  RETURN
.
.******************************************************************************
. Link to Previous page of recovery closured
.******************************************************************************
PRVCLS00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTLOCN
.
          WRITE     HTMLFILE;"oprweb06.pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtlocn=",FILTLOCN;
.
          REP       "+ ",FILTLOCN
.
PRVCLS99  RETURN
.
.******************************************************************************
. Recovery Closure Table
.******************************************************************************
RTAB0000  PACK      KEY22,FRSTDATE,SP70

          CALL      RSOPRCI2
RTAB1000  CALL      RKOPRCI2
          BRANCH    OVRCD,RTAB9999
.
          MATCH     OPRCSDAT,LASTDATE
          GOTO      RTAB9999 IF LESS
.
          MATCH     SP70,FILTLOCN           * Location filter
          IF        !@EQUAL
            MATCH     FILTLOCN,OPRCLOCN
            GOTO      RTAB1000 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP     * Check Hospital for Multi-Hospital
            GOTO      RTAB1000 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP         * Spaces if Not Multi Hospital
            GOTO      RTAB1000 IF NOT EQUAL
          ENDIF
.
          MOVE      "YD",CATEGORY           * Location
          MOVE      OPRCLOCN,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPLOCN
.
          MOVE      "Cr",CATEGORY           * Closure Reason
          MOVE      OPRCREAS,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPREAS
.
          UNPACK    OPRCSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdClosure('",HTMLLINK
          APPEND    OPRCLOCN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPRCSTIM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPRCHOSP,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",OPRCSDAT,OPRCSTIM,"#",":      * 1
                             "#"",OPRCEDAT,OPRCETIM,"#",":      * 2
                             "#"",DISPLOCN,"#",":               * 3
                             "#"",DISPREAS,"#");";              * 4
.
          GOTO      RTAB1000
.
RTAB9999  RETURN
.

.******************************************************************************
.*                  display tourniquet total time  for theatre details        *
.******************************************************************************
TOTT0000  MOVE      ZERO,F4
          MOVE      ZERO,F4A
          MOVE      ZERO,F4B
          MOVE      ZERO,FORM4
.
          PACK      KEY13,OPDAUNIQ,F1,SP70
          CALL      RSOPTQE1
TOTT0010  CALL      RKOPTQE1
          BRANCH    OVRCD,TOTT0200
.
          MATCH     OPTQUNID,OPDAUNIQ
          GOTO      TOTT0200 IF NOT EQUAL
.
          MOVE      F1,DIM1
          MATCH     OPTQRTYP,DIM1
          GOTO      TOTT0200 IF NOT EQUAL
.
          MATCH     SP70,OPTQATIM
          GOTO      TOTT0010 IF EQUAL
.
          MATCH     SP70,OPTQRTIM
          GOTO      TOTT0010 IF EQUAL
.      
          MOVE      ZERO,F4          
          MOVE      ZERO,F4A
          MOVE      ZERO,F4B
.
          UNPACK    OPTQATIM,CHOUR,ANS,CMIN * unpack the applied start time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,F4A
          MULT      "60",F4A                * convert hours to minutes
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,F4A               * get the total min of applied time
.
          UNPACK    OPTQRTIM,CHOUR,ANS,CMIN * unpack the applied start time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,F4B
          MULT      "60",F4B                * convert hours to minutes
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,F4B               * get the total min of applied time
.
          ASSIGN    (F4B - F4A),F4
.
          ADD       F4,FORM4
.
          GOTO      TOTT0010
.
TOTT0200  CALL      CLOPRTQE
          MOVE      ZERO,OPTQCNTR
          GOTO      TOTT9999
.
TOTT9999  RETURN
.
.******************************************************************************
.* Set 3nd Input Comments
.******************************************************************************
YPCOM000  PREP      YPCOMFIL,YPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     YPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     YPCOMFIL,SEQ;QRYDATA
.
YPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      YPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      YPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     YPCOMFIL,SEQ;QRYDATA
          GOTO      YPCOM100
.
YPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
YPCOM999  RETURN
.
.******************************************************************************
.* Update 3nd Comments
.******************************************************************************
UPCMY000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      YPCOMFIL,YPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMY999
.
UPCMY100  READ      YPCOMFIL,SEQ;YPCOMLIN
          GOTO      UPCMY999 IF OVER
          MATCH     "%START:",YPCOMLIN
          IF        @EQUAL
            UNPACK    YPCOMLIN,KEY7,YPCOMTYP
            CALL      CLCYM000
            MOVE      ZERO,YPCOMCNT
            GOTO      UPCMY100
          ENDIF
UPCMY110  ADD       ONE,YPCOMCNT
          PACK      KEY16,OPDAUNIQ,YPCOMTYP,YPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMY110 IF EQUAL
          MOVE      YPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMY100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMY100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMY100
.
UPCMY999  RETURN
.******************************************************************************
.* Clear 3nd Comments
.******************************************************************************
CLCYM000  PACK      KEY16,OPDAUNIQ,YPCOMTYP,SP70
          CALL      RSOPDED1
CLCYM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCYM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCYM999 IF NOT EQUAL
          MATCH     OPDDTYPE,YPCOMTYP
          GOTO      CLCYM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCYM100
CLCYM999  RETURN
.******************************************************************************
.* Set 4nd Input Comments
.******************************************************************************
ZPCOM000  PREP      ZPCOMFIL,ZPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     ZPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     ZPCOMFIL,SEQ;QRYDATA
.
ZPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      ZPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      ZPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     ZPCOMFIL,SEQ;QRYDATA
          GOTO      ZPCOM100
.
ZPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
ZPCOM999  RETURN
.
.******************************************************************************
.* Update 4nd Comments
.******************************************************************************
UPCMZ000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ZPCOMFIL,ZPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMZ999
.
UPCMZ100  READ      ZPCOMFIL,SEQ;ZPCOMLIN
          GOTO      UPCMZ999 IF OVER
          MATCH     "%START:",ZPCOMLIN
          IF        @EQUAL
            UNPACK    ZPCOMLIN,KEY7,ZPCOMTYP
            CALL      CLCZM000
            MOVE      ZERO,ZPCOMCNT
            GOTO      UPCMZ100
          ENDIF
UPCMZ110  ADD       ONE,ZPCOMCNT
          PACK      KEY16,OPDAUNIQ,ZPCOMTYP,ZPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMZ110 IF EQUAL
          MOVE      ZPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMZ100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMZ100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMZ100
.
UPCMZ999  RETURN
.******************************************************************************
.* Clear 4nd Comments
.******************************************************************************
CLCZM000  PACK      KEY16,OPDAUNIQ,ZPCOMTYP,SP70
          CALL      RSOPDED1
CLCZM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCZM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCZM999 IF NOT EQUAL
          MATCH     OPDDTYPE,ZPCOMTYP
          GOTO      CLCZM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCZM100
CLCZM999  RETURN
.******************************************************************************
.* Set 5nd Input Comments
.******************************************************************************
WPCOM000  PREP      WPCOMFIL,WPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     WPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     WPCOMFIL,SEQ;QRYDATA
.
WPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      WPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      WPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     WPCOMFIL,SEQ;QRYDATA
          GOTO      WPCOM100
.
WPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
WPCOM999  RETURN
.
.******************************************************************************
.* Update 5nd Comments
.******************************************************************************
UPCMW000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WPCOMFIL,WPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMW999
.
UPCMW100  READ      WPCOMFIL,SEQ;WPCOMLIN
          GOTO      UPCMW999 IF OVER
          MATCH     "%START:",WPCOMLIN
          IF        @EQUAL
            UNPACK    WPCOMLIN,KEY7,WPCOMTYP
            CALL      CLCWM000
            MOVE      ZERO,WPCOMCNT
            GOTO      UPCMW100
          ENDIF
UPCMW110  ADD       ONE,WPCOMCNT
          PACK      KEY16,OPDAUNIQ,WPCOMTYP,WPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMW110 IF EQUAL
          MOVE      WPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMW100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMW100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMW100
.
UPCMW999  RETURN
.******************************************************************************
.* Clear 5nd Comments
.******************************************************************************
CLCWM000  PACK      KEY16,OPDAUNIQ,WPCOMTYP,SP70
          CALL      RSOPDED1
CLCWM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCWM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCWM999 IF NOT EQUAL
          MATCH     OPDDTYPE,WPCOMTYP
          GOTO      CLCWM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCWM100
CLCWM999  RETURN
.
.------------------------------------------------------------
. Set parameters for Water variables in Theatre Attributes
.------------------------------------------------------------
SWATER00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SWATER01,SWATER02,SWATER03
.
          MOVE      ONE,EXIT
          GOTO      SWATER99
.
SWATER01  PACK      WATER001,QRYDATA,SP70
          GOTO      SWATER99
.
SWATER02  PACK      WATER002,QRYDATA,SP70
          GOTO      SWATER99
.
SWATER03  PACK      WATER003,QRYDATA,SP70
          GOTO      SWATER99
.
SWATER99  RETURN
+
.------------------------------------------------------------
. Set parameters for Saline variables in Theatre Attributes
.------------------------------------------------------------
SSALIN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SSALIN01,SSALIN02,SSALIN03
.
          MOVE      ONE,EXIT
          GOTO      SSALIN99
.
SSALIN01  PACK      SALIN001,QRYDATA,SP70
          GOTO      SSALIN99
.
SSALIN02  PACK      SALIN002,QRYDATA,SP70
          GOTO      SSALIN99
.
SSALIN03  PACK      SALIN003,QRYDATA,SP70
          GOTO      SSALIN99
.
SSALIN99  RETURN
+
.------------------------------------------------------------
. Set parameters for Hartmann's variables in Theatre Attributes
.------------------------------------------------------------
SHAART00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SHAART01,SHAART02,SHAART03
.
          MOVE      ONE,EXIT
          GOTO      SHAART99
.
SHAART01  PACK      HAART001,QRYDATA,SP70
          GOTO      SHAART99
.
SHAART02  PACK      HAART002,QRYDATA,SP70
          GOTO      SHAART99
.
SHAART03  PACK      HAART003,QRYDATA,SP70
          GOTO      SHAART99
.
SHAART99  RETURN
+
.------------------------------------------------------------
. Set parameters for Glycine variables in Theatre Attributes
.------------------------------------------------------------
SGLYCI00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SGLYCI01,SGLYCI02,SGLYCI03
.
          MOVE      ONE,EXIT
          GOTO      SGLYCI99
.
SGLYCI01  PACK      GLYCI001,QRYDATA,SP70
          GOTO      SGLYCI99
.
SGLYCI02  PACK      GLYCI002,QRYDATA,SP70
          GOTO      SGLYCI99
.
SGLYCI03  PACK      GLYCI003,QRYDATA,SP70
          GOTO      SGLYCI99
.
SGLYCI99  RETURN
+
.------------------------------------------------------------
. Set parameters for Ringers variables in Theatre Attributes
.------------------------------------------------------------
SRINGR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SRINGR01,SRINGR02,SRINGR03
.
          MOVE      ONE,EXIT
          GOTO      SRINGR99
.
SRINGR01  PACK      RINGR001,QRYDATA,SP70
          GOTO      SRINGR99
.
SRINGR02  PACK      RINGR002,QRYDATA,SP70
          GOTO      SRINGR99
.
SRINGR03  PACK      RINGR003,QRYDATA,SP70
          GOTO      SRINGR99
.
SRINGR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Other variables in Theatre Attributes
.------------------------------------------------------------
SOTHER00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SOTHER01,SOTHER02,SOTHER03
.
          MOVE      ONE,EXIT
          GOTO      SOTHER99
.
SOTHER01  PACK      OTHER001,QRYDATA,SP70
          GOTO      SOTHER99
.
SOTHER02  PACK      OTHER002,QRYDATA,SP70
          GOTO      SOTHER99
.
SOTHER03  PACK      OTHER003,QRYDATA,SP70
          GOTO      SOTHER99
.
SOTHER99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes
.------------------------------------------------------------
UPOAT000  MATCH     "1",UPDOPATR  
          GOTO      UPOATR99 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      ONE,OTTYPIND                  * Water Y/N 1 
          MOVE      ONE,OTYENIND
          MOVE      WATER001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      ONE,OTTYPIND                  * Water Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      WATER002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      ONE,OTTYPIND                  * Water Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      WATER003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TWO,OTTYPIND                  * Saline Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      SALIN001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWO,OTTYPIND                  * Saline Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      SALIN002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWO,OTTYPIND                  * Saline Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      SALIN003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      THREE,OTTYPIND                  * Hartmann's Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      HAART001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      THREE,OTTYPIND                  * Hartmann's Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      HAART002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      THREE,OTTYPIND                  * Hartmann's Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      HAART003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      FOUR,OTTYPIND                  * Glycine Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      GLYCI001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      FOUR,OTTYPIND                  * Glycine Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      GLYCI002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      FOUR,OTTYPIND                  * Glycine Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      GLYCI003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      FIVE,OTTYPIND                  * Ringers Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      RINGR001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      FIVE,OTTYPIND                  * Ringers Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      RINGR002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      FIVE,OTTYPIND                  * Ringers Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      RINGR003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      SIX,OTTYPIND                  * Other Text 1
          MOVE      ONE,OTTXTIND
          MOVE      OTHER001,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      SIX,OTTYPIND                  * Other Warm Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      OTHER002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      SIX,OTTYPIND                  * Other Volume Value 1
          MOVE      ONE,OTVALIND
          MOVE      OTHER003,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
UPOATR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Diathermy variables in Theatre Attributes
.------------------------------------------------------------
SDIATH00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SDIATH01,SDIATH02,SDIATH03,SDIATH04
.
          MOVE      ONE,EXIT
          GOTO      SDIATH99
.
SDIATH01  PACK      DIATH001,QRYDATA,SP70
          GOTO      SDIATH99
.
SDIATH02  PACK      DIATH002,QRYDATA,SP70
          GOTO      SDIATH99
.
SDIATH03  PACK      DIATH003,QRYDATA,SP70,SP70
          GOTO      SDIATH99
.
SDIATH04  PACK      DIATH004,QRYDATA,SP70,SP70
          GOTO      SDIATH99
.
SDIATH99  RETURN
+
.------------------------------------------------------------
. Set parameters for Wound variables in Theatre Attributes
.------------------------------------------------------------
SWOUND00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SWOUND01,SWOUND02,SWOUND03,SWOUND04,SWOUND05
.
          MOVE      ONE,EXIT
          GOTO      SWOUND99
.
SWOUND01  PACK      WOUND001,QRYDATA,SP70
          GOTO      SWOUND99
.
SWOUND02  PACK      WOUND002,QRYDATA,SP70
          GOTO      SWOUND99
.
SWOUND03  PACK      WOUND003,QRYDATA,SP70
          GOTO      SWOUND99
.
SWOUND04  PACK      WOUND004,QRYDATA,SP70
          GOTO      SWOUND99
.
SWOUND05  PACK      WOUND005,QRYDATA,SP70
          GOTO      SWOUND99
.
SWOUND99  RETURN
+
.------------------------------------------------------------
. Set parameters for Skin Integrity variables in Theatre Attributes
.------------------------------------------------------------
SSKINI00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SSKINI01,SSKINI02,SSKINI03,SSKINI04,SSKINI05
.
          MOVE      ONE,EXIT
          GOTO      SSKINI99
.
SSKINI01  PACK      SKINI001,QRYDATA,SP70
          GOTO      SSKINI99
.
SSKINI02  PACK      SKINI002,QRYDATA,SP70
          GOTO      SSKINI99
.
SSKINI03  PACK      SKINI003,QRYDATA,SP70
          GOTO      SSKINI99
.
SSKINI04  PACK      SKINI004,QRYDATA,SP70
          GOTO      SSKINI99
.
SSKINI05  PACK      SKINI005,QRYDATA,SP70
          GOTO      SSKINI99
.
SSKINI99  RETURN
+
.------------------------------------------------------------
. Set parameters for Patient Positioning variables in Theatre Attributes
.------------------------------------------------------------
SPATPO00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPATPO01,SPATPO02,SPATPO03,SPATPO04,SPATPO05:
                       SPATPO06
.
          MOVE      ONE,EXIT
          GOTO      SPATPO99
.
SPATPO01  PACK      PATPO001,QRYDATA,SP70
          GOTO      SPATPO99
.
SPATPO02  PACK      PATPO002,QRYDATA,SP70
          GOTO      SPATPO99
.
SPATPO03  PACK      PATPO003,QRYDATA,SP70
          GOTO      SPATPO99
.
SPATPO04  PACK      PATPO004,QRYDATA,SP70
          GOTO      SPATPO99
.
SPATPO05  PACK      PATPO005,QRYDATA,SP70
          GOTO      SPATPO99
.
SPATPO06  PACK      PATPO006,QRYDATA,SP70,SP70
          GOTO      SPATPO99
.
SPATPO99  RETURN
+
.------------------------------------------------------------
. Set parameters for Positioning Devices variables in Theatre Attributes
.------------------------------------------------------------
SPOSDE00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPOSDE01,SPOSDE02,SPOSDE03,SPOSDE04,SPOSDE05:
                       SPOSDE06,SPOSDE07,SPOSDE08,SPOSDE09
.
          MOVE      ONE,EXIT
          GOTO      SPOSDE99
.
SPOSDE01  PACK      POSDE001,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE02  PACK      POSDE002,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE03  PACK      POSDE003,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE04  PACK      POSDE004,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE05  PACK      POSDE005,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE06  PACK      POSDE006,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE07  PACK      POSDE007,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE08  PACK      POSDE008,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE09  PACK      POSDE009,QRYDATA,SP70
          GOTO      SPOSDE99
.
SPOSDE99  RETURN
+
.------------------------------------------------------------
. Set parameters for Armboards variables in Theatre Attributes
.------------------------------------------------------------
SARMBO00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SARMBO01,SARMBO02,SARMBO03,SARMBO04,SARMBO05:
                       SARMBO06,SARMBO07,SARMBO08
.
          MOVE      ONE,EXIT
          GOTO      SARMBO99
.
SARMBO01  PACK      ARMBO001,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO02  PACK      ARMBO002,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO03  PACK      ARMBO003,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO04  PACK      ARMBO004,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO05  PACK      ARMBO005,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO06  PACK      ARMBO006,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO07  PACK      ARMBO007,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO08  PACK      ARMBO008,QRYDATA,SP70
          GOTO      SARMBO99
.
SARMBO99  RETURN
+
.------------------------------------------------------------
. Set parameters for Pressure Relieving variables in Theatre Attributes
.------------------------------------------------------------
SPRESR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRESR01,SPRESR02,SPRESR03,SPRESR04,SPRESR05:
                       SPRESR06
.
          MOVE      ONE,EXIT
          GOTO      SPRESR99
.
SPRESR01  PACK      PRESR001,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR02  PACK      PRESR002,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR03  PACK      PRESR003,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR04  PACK      PRESR004,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR05  PACK      PRESR005,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR06  PACK      PRESR006,QRYDATA,SP70
          GOTO      SPRESR99
.
SPRESR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Skin Prep variables in Theatre Attributes
.------------------------------------------------------------
SSKINP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SSKINP01,SSKINP02,SSKINP03,SSKINP04,SSKINP05:
                       SSKINP06
.
          MOVE      ONE,EXIT
          GOTO      SSKINP99
.
SSKINP01  PACK      SKINP001,QRYDATA,SP70
          GOTO      SSKINP99
.
SSKINP02  PACK      SKINP002,QRYDATA,SP70
          GOTO      SSKINP99
.
SSKINP03  PACK      SKINP003,QRYDATA,SP70
          GOTO      SSKINP99
.
SSKINP04  PACK      SKINP004,QRYDATA,SP70
          GOTO      SSKINP99
.
SSKINP05  PACK      SKINP005,QRYDATA,SP70
          GOTO      SSKINP99
.
SSKINP06  PACK      SKINP006,QRYDATA,SP70,SP70
          GOTO      SSKINP99
.
SSKINP99  RETURN
+
.------------------------------------------------------------
. Set parameters for Hair Removal variables in Theatre Attributes
.------------------------------------------------------------
SHAIRR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SHAIRR01,SHAIRR02,SHAIRR03,SHAIRR04
.
          MOVE      ONE,EXIT
          GOTO      SHAIRR99
.
SHAIRR01  PACK      HAIRR001,QRYDATA,SP70
          GOTO      SHAIRR99
.
SHAIRR02  PACK      HAIRR002,QRYDATA,SP70
          GOTO      SHAIRR99
.
SHAIRR03  PACK      HAIRR003,QRYDATA,SP70
          GOTO      SHAIRR99
.
SHAIRR04  PACK      HAIRR004,QRYDATA,SP70,SP70
          GOTO      SHAIRR99
.
SHAIRR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Other Comments variables in Theatre Attributes
.------------------------------------------------------------
SOTHRC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SOTHRC01
.
          MOVE      ONE,EXIT
          GOTO      SOTHRC99
.
SOTHRC01  PACK      OTHRC001,QRYDATA,SP70
          GOTO      SOTHRC99
.
SOTHRC99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Clinical Details
.------------------------------------------------------------
UPOAC000  MATCH     "1",UPDOPATI
          GOTO      UPOAC999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      TWENTY4,OTTYPIND              * Diathermy Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      DIATH001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY4,OTTYPIND              * Diathermy Bipolar  Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      DIATH002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY4,OTTYPIND              * Diathermy Mono Site Text 1
          MOVE      ONE,OTTXTIND
          MOVE      DIATH003,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY4,OTTYPIND              * Diathermy Mono Site Text 2
          MOVE      TWO,OTTXTIND
          MOVE      DIATH004,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN5,OTTYPIND                 * Wound Absorb Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      WOUND001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN5,OTTYPIND                 * Wound Sten Strips Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      WOUND002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN5,OTTYPIND                 * Wound Staples Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      WOUND003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN5,OTTYPIND                 * Wound Non Absorb Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      WOUND004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN5,OTTYPIND                 * Wound Not Applicable Y/N 5
          MOVE      FIVE,OTYENIND
          MOVE      WOUND005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN6,OTTYPIND                 * Skin Integrity Pre Op Cod 1
          MOVE      ONE,OTCODIND
          MOVE      SKINI001,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TEN6,OTTYPIND                 * Skin Integrity Post Op Cod 1
          MOVE      TWO,OTCODIND
          MOVE      SKINI002,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TEN6,OTTYPIND                 * Skin Integrity Pat Rol Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      SKINI003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN6,OTTYPIND                 * Skin Integrity Bony Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      SKINI004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN6,OTTYPIND                 * Skin Integrity Inj Eye Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      SKINI005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND                 * Pat Pos Supine  Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      PATPO001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND                 * Pat Pos Prone`  Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      PATPO002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND                 * Pat Pos Lithotomy`  Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      PATPO003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND               * Pat Pos Left Lateral`  Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      PATPO004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND               * Pat Pos Right Lateral`  Y/N 4
          MOVE      FIVE,OTYENIND
          MOVE      PATPO005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN7,OTTYPIND               * Pat Pos Other Text 1
          MOVE      ONE,OTTXTIND
          MOVE      PATPO006,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Head Ring Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      POSDE001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Poles Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      POSDE002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Yellow Fins Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      POSDE003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Beanbag Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      POSDE004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Anaes Frame Y/N 5
          MOVE      FIVE,OTYENIND
          MOVE      POSDE005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Doig Frame Y/N 6
          MOVE      SIX,OTYENIND
          MOVE      POSDE006,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Moores Support Y/N 7
          MOVE      SEVEN,OTYENIND
          MOVE      POSDE007,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Mayfield Clamp Y/N 8
          MOVE      EIGHT,OTYENIND
          MOVE      POSDE008,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN8,OTTYPIND               * Pos Dev Wedge Y/N 9
          MOVE      NINE,OTYENIND
          MOVE      POSDE009,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Straight L Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      ARMBO001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Straight R Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      ARMBO002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Curved L Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      ARMBO003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Curved R Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      ARMBO004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Right Angle Y/N 5
          MOVE      FIVE,OTYENIND
          MOVE      ARMBO005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Armbar Tab Y/N 6
          MOVE      SIX,OTYENIND
          MOVE      ARMBO006,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Neph Bridge Y/N 7
          MOVE      SEVEN,OTYENIND
          MOVE      ARMBO007,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN9,OTTYPIND               * Armboards Mayfield Y/N 8
          MOVE      EIGHT,OTYENIND
          MOVE      ARMBO008,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Heel Rest Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      PRESR001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Pillows Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      PRESR002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Soft Padding Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      PRESR003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Headrest Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      PRESR004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Sandbag Y/N 5
          MOVE      FIVE,OTYENIND
          MOVE      PRESR005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY,OTTYPIND             * Pres Rel Gelpads Y/N 6
          MOVE      SIX,OTYENIND
          MOVE      PRESR006,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep Povidone Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      SKINP001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep Chlorhex Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      SKINP002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep 1% Iodine Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      SKINP003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep Aqueous Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      SKINP004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep Not Applicable Y/N 5
          MOVE      FIVE,OTYENIND
          MOVE      SKINP005,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY1,OTTYPIND            * Skin Prep Other Text 1
          MOVE      ONE,OTTXTIND
          MOVE      SKINP006,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY2,OTTYPIND            * Hair Rem Clip Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      HAIRR001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY2,OTTYPIND            * Hair Rem Shaved Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      HAIRR002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY2,OTTYPIND            * Hair Rem Not Applicable Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      HAIRR003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TWENTY2,OTTYPIND            * Hair Rem Other Text 1
          MOVE      ONE,OTTXTIND
          MOVE      HAIRR004,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY3,OTTYPIND            * Other Comments Text 1
          MOVE      ONE,OTTXTIND
          MOVE      OTHRC001,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
UPOAC999  RETURN
+
.******************************************************************************
.*                     Clinical Details                                       *
.******************************************************************************
OPCL0000  BRANCH    FLDITMNO,OPCL0100,OPCL0200,OPCL0300,OPCL0400,OPCL0500:
                             OPCL0600,OPCL0700,OPCL0800,OPCL0900,OPCL1000:
                             OPCL1100,OPCL1200,OPCL1300,OPCL1400,OPCL1500:
                             OPCL1600,OPCL1700,OPCL1800,OPCL1900,OPCL2000:
                             OPCL2100,OPCL2200,OPCL2300,OPCL2400,OPCL2500:
                             OPCL2600,OPCL2700,OPCL2800,OPCL2900,OPCL3000:
                             OPCL3100,OPCL3200,OPCL3300,OPCL3400,OPCL3500:
                             OPCL3600,OPCL3700,OPCL3800,OPCL3900,OPCL4000:
                             OPCL4100,OPCL4200,OPCL4300,OPCL4400,OPCL4500:
                             OPCL4600,OPCL4700,OPCL4800,OPCL4900,OPCL5000:
                             OPCL5100,OPCL5200,OPCL5300,OPCL5400,OPCL5500:
                             OPCL5600,OPCL5700,OPCL5800,OPCL5900,OPCL6000:
                             OPCL6100,OPCL6200,OPCL6300,OPCL6400,OPCL6500:
                             OPCL6600,OPCL6700,OPCL6800,OPCL6900,OPCL7000:
                             OPCL7100,OPCL7200,OPCL7300,OPCL7400,OPCL7500:
                             OPCL7600,OPCL7700,OPCL7800,OPCL7900,OPCL8000:
                             OPCL8100,OPCL8200,OPCL8300,OPCL8400,OPCL8500:
                             OPCL8600,OPCL8700,OPCL8800,OPCL8900,OPCL9000:
                             OPCL9100,OPCL9200,OPCL9300,OPCL9400,OPCL9500:
                             OPCL9600,OPCL9700,OPCL9800,OPCL9900
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPCL9999
.
OPCL0100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY4,OTTYPIND   * Attr Type 24 ('Diathermy')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL; 
          GOTO      OPCL9999
.
OPCL0200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY4,OTTYPIND   * Attr Type 24 ('Diathermy')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL0300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY4,OTTYPIND   * Attr Type 24 ('Diathermy')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL0400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY4,OTTYPIND   * Attr Type 24 ('Diathermy')
          MOVE      TWO,OTTXTIND       * Attribute Text Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 2
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL0500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN5,OTTYPIND      * Attr Type 15 ('Wound')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL0600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN5,OTTYPIND      * Attr Type 15 ('Wound')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL0700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN5,OTTYPIND      * Attr Type 15 ('Wound')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL0800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN5,OTTYPIND      * Attr Type 15 ('Wound')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL0900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN5,OTTYPIND      * Attr Type 15 ('Wound')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN6,OTTYPIND      * Attr Type 16 ('Skin Integrity')
          MOVE      ONE,OTCODIND       * Attribute Coded Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 1
.
          MOVE      "si",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00    
          GOTO      OPCL9999
.
OPCL1100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN6,OTTYPIND      * Attr Type 16 ('Skin Integrity')
          MOVE      TWO,OTCODIND       * Attribute Coded Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 2
.
          MOVE      "si",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL1200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN6,OTTYPIND      * Attr Type 16 ('Skin Integrity')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN6,OTTYPIND      * Attr Type 16 ('Skin Integrity')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN6,OTTYPIND      * Attr Type 16 ('Skin Integrity')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL1900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN7,OTTYPIND      * Attr Type 17 ('Patient Pos')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL2100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      SIX,OTYENIND       * Attribute Y/N Field 6
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 6
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      SEVEN,OTYENIND     * Attribute Y/N Field 7
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 7
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      EIGHT,OTYENIND     * Attribute Y/N Field 8
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 8
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL2900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN8,OTTYPIND      * Attr Type 18 ('Pos Devices')
          MOVE      NINE,OTYENIND      * Attribute Y/N Field 9
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 9
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      SIX,OTYENIND       * Attribute Y/N Field 6
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 6
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      SEVEN,OTYENIND     * Attribute Y/N Field 7
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 7
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN9,OTTYPIND      * Attr Type 19 ('Armboards')
          MOVE      EIGHT,OTYENIND     * Attribute Y/N Field 8
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 8
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL3900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY,OTTYPIND    * Attr Type 20 ('Pres Rel')
          MOVE      SIX,OTYENIND       * Attribute Y/N Field 6
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 6
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      FIVE,OTYENIND      * Attribute Y/N Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 5
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL4900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY1,OTTYPIND   * Attr Type 21 ('Skin Prep')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL5000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY2,OTTYPIND   * Attr Type 22 ('Hair Rem')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL5100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY2,OTTYPIND   * Attr Type 22 ('Hair Rem')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL5200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY2,OTTYPIND   * Attr Type 22 ('Hair Rem')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL5300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY2,OTTYPIND   * Attr Type 22 ('Hair Rem')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL5400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY3,OTTYPIND   * Attr Type 23 ('Other Comments')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL5500  PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPTQE1
          CALL      RKOPTQE1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     OPDAUNIQ,OPTQUNID
          GOTO      OPCL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL5600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,ONE,FOUR,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5650 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5650 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT2
          GOTO      OPCL5650 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT3
          GOTO      OPCL5650 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT4
          GOTO      OPCL5650 IF NOT EQUAL
.
          PACK      KEY16,OPDAUNIQ,ZERO,TWO,ONE,SP70
          CALL      RSOPDED1
          CALL      RKOPDED1          
          BRANCH    OVRCD,OPCL9999
.
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      OPCL9999 IF NOT EQUAL
.
          MATCH     "021",OPDDTYPE
          GOTO      OPCL5650 IF EQUAL
          GOTO      OPCL9999          
.
OPCL5650  WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL5700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,TWO,FIVE,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL2
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL3
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT2
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT3
          GOTO      OPCL5750 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT4
          GOTO      OPCL5750 IF NOT EQUAL
.
          GOTO      OPCL9999
.
OPCL5750  WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL5800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,TWO,SIX,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL2
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL3
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT2
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABCOD1
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABCOD2
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABCOD3
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABCOD4
          GOTO      OPCL5850 IF NOT EQUAL
.
          MATCH     SP70,OPABCOD5
          GOTO      OPCL5850 IF NOT EQUAL
.
          GOTO      OPCL9999
.
OPCL5850  WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL5900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,ZERO,SEVEN,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL5910
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5990 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5990 IF NOT EQUAL
.
OPCL5910  PACK      KEY13,OPDAUNIQ,ZERO,ZERO,EIGHT,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL5920
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5990 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5990 IF NOT EQUAL
.
OPCL5920  PACK      KEY13,OPDAUNIQ,ZERO,ZERO,NINE,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL5930
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5990 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5990 IF NOT EQUAL
.
OPCL5930  PACK      KEY13,OPDAUNIQ,ZERO,TEN,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL5940
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5990 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5990 IF NOT EQUAL
.
OPCL5940  PACK      KEY13,OPDAUNIQ,ZERO,TEN1,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL5990 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL5990 IF NOT EQUAL
.
          GOTO      OPCL9999
.
OPCL5990  WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL6000  MATCH     "1",UPDOPCPI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY15,OPDAUNIQ,SP70
          CALL      RSOPCPI1
OPCL6010  CALL      RKOPCPI1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     OPDAUNIQ,OPCIUNIQ
          GOTO      OPCL9999 IF NOT EQUAL
          MATCH     "1",OPCIDELT
          GOTO      OPCL6010 IF EQUAL           * Deleted
.
          WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL6100  MATCH     "1",UPDOPABI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY15,OPDAUNIQ,SP70
          CALL      RSOPABI1
OPCL6110  CALL      RKOPABI1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     OPDAUNIQ,OPAIUNIQ
          GOTO      OPCL9999 IF NOT EQUAL
          MATCH     "1",OPAIDELT
          GOTO      OPCL6110 IF EQUAL           * Deleted
.
          WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL6200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN4,OTTYPIND      * Attr Type 14 ('Specimens')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL6300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN4,OTTYPIND      * Attr Type 14 ('Specimens')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN4,OTTYPIND      * Attr Type 14 ('Specimens')
          MOVE      TWO,OTTXTIND       * Attribute Text Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 2
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN4,OTTYPIND      * Attr Type 14 ('Specimens')
          MOVE      THREE,OTTXTIND     * Attribute Text Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 3
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN4,OTTYPIND      * Attr Type 14 ('Specimens')
          MOVE      FOUR,OTTXTIND      * Attribute Text Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 4
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      TWO,OTTXTIND       * Attribute Text Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 2
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL6900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      THREE,OTTXTIND     * Attribute Text Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 3
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL7000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      FOUR,OTTXTIND      * Attribute Text Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 4
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL7100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL7200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      TWO,OTVALIND       * Attribute Value Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 2
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL7300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY5,OTTYPIND   * Attr Type 25 ('Drains')
          MOVE      THREE,OTVALIND     * Attribute Value Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 3
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL7400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      ONE,OTCODIND       * Attribute Coded Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 1
.
          MOVE      "2A",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL7500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      TWO,OTCODIND       * Attribute Coded Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 2
.
          MOVE      "2a",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL7600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      THREE,OTCODIND     * Attribute Coded Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 3
.
          MOVE      "2B",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL7700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      FOUR,OTCODIND      * Attribute Coded Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 4
.
          MOVE      "2b",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL7800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      FIVE,OTCODIND      * Attribute Coded Field 5
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOCV00           * Get Attribute Coded Field value 5
.
          MOVE      "2C",CATEGORY
          MOVE      OTCODVAL,CODE
          CALL      CODITM00
          GOTO      OPCL9999
.
OPCL7900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      TWO,OTTXTIND       * Attribute Text Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 2
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL8100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      TWO,OTVALIND       * Attribute Value Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 2
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL8200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TWENTY6,OTTYPIND   * Attr Type 26 ('In Dwelling Catheter')
          MOVE      THREE,OTVALIND       * Attribute Value Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 3
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL8300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      SEVEN,OTTYPIND     * Attr Type 7 ('Irrigation 1')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      EIGHT,OTTYPIND     * Attr Type 8 ('Irrigation 2')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      NINE,OTTYPIND      * Attr Type 9 ('Irrigation 3')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN,OTTYPIND       * Attr Type 10 ('Irrigation 4')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN1,OTTYPIND      * Attr Type 11 ('Irrigation 5')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL8800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      SEVEN,OTTYPIND     * Attr Type 7 ('Irrigation 1')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL8900  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      EIGHT,OTTYPIND     * Attr Type 8 ('Irrigation 2')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL9000  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      NINE,OTTYPIND      * Attr Type 9 ('Irrigation 3')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL9100  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN,OTTYPIND       * Attr Type 10 ('Irrigation 4')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL9200  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN1,OTTYPIND      * Attr Type 11 ('Irrigation 5')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          WRITE     HTMLFILE;OTVALVAL;
          GOTO      OPCL9999
.
OPCL9300  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN2,OTTYPIND      * Attr Type 12 ('Dressing Type')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCL9999
.
OPCL9400  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          PACK      KEY13,OPDAUNIQ,ZERO,ONE,THREE,SP70
          CALL      RDOPATR1
          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABYN01
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABYN02
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT1
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABTXT2
          GOTO      OPCL9450 IF NOT EQUAL
.
.          PACK      KEY13,OPDAUNIQ,ZERO,ONE,FIVE,SP70
.          CALL      RDOPATR1
.          BRANCH    OVRCD,OPCL9999
.
          MATCH     SP70,OPABYN03
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABYN04
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL1
          GOTO      OPCL9450 IF NOT EQUAL
.
          MATCH     SP70,OPABVAL2
          GOTO      OPCL9450 IF NOT EQUAL
.
          GOTO      OPCL9999
.
OPCL9450  WRITE     HTMLFILE;ONE;
          GOTO      OPCL9999
.
OPCL9500  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      ONE,OTYENIND       * Attribute Y/N Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 1
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL9600  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      TWO,OTYENIND       * Attribute Y/N Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 2
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL9700  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      THREE,OTYENIND     * Attribute Y/N Field 3
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 3
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL9800  MATCH     "1",UPDOPATI
          GOTO      OPCL9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      FOUR,OTYENIND      * Attribute Y/N Field 4
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOYN00           * Get Attribute Y/N Field value 4
          WRITE     HTMLFILE;OTYENVAL;
          GOTO      OPCL9999
.
OPCL9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO
          CALL      OPCD0000
          GOTO      OPCL9999
.
OPCL9999  RETURN
+
.******************************************************************************
.*                     Clinical Details Extension                             *
.******************************************************************************
OPCD0000  BRANCH    FLDITMNO,OPCD0100,OPCD0200,OPCD0300,OPCD0400,OPCD0500:
                             OPCD0600
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      OPCD9999
.
OPCD0100  MATCH     "1",UPDOPATI
          GOTO      OPCD9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      ONE,OTTXTIND       * Attribute Text Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 1
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCD9999
.
OPCD0200  MATCH     "1",UPDOPATI
          GOTO      OPCD9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      TWO,OTTXTIND       * Attribute Text Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETTFO00           * Get Attribute Text Field value 2
          WRITE     HTMLFILE;OTTXTVAL;
          GOTO      OPCD9999
.
OPCD0300  MATCH     "1",UPDOPATI
          GOTO      OPCD9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      ONE,OTVALIND       * Attribute Value Field 1
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 1
          MATCH     SP70,OTVALVAL
          GOTO      OPCD9999 IF EQUAL
          GOTO      OPCD9999 IF EOS
.
          UNPACK    OTVALVAL,DIM2,DIM2A,DIM2B
          WRITE     HTMLFILE;DIM2,COLON,DIM2A,COLON,DIM2B;
          GOTO      OPCD9999
.
OPCD0400  MATCH     "1",UPDOPATI
          GOTO      OPCD9999 IF NOT EQUAL
.
          MOVE      TEN3,OTTYPIND      * Attr Type 13 ('Count Correct')
          MOVE      TWO,OTVALIND       * Attribute Value Field 2
          MOVE      OPDAUNIQ,OTATR001
          CALL      GETOVV00           * Get Attribute Value Field value 2
          MATCH     SP70,OTVALVAL
          GOTO      OPCD9999 IF EQUAL
          GOTO      OPCD9999 IF EOS
.
          UNPACK    OTVALVAL,DIM2,DIM2A,DIM2B
          WRITE     HTMLFILE;DIM2,COLON,DIM2A,COLON,DIM2B;
          GOTO      OPCD9999
.
OPCD0500  WRITE     HTMLFILE;SAVKEY76;
          GOTO      OPCD9999
.
OPCD0600  WRITE     HTMLFILE;UPDOPSDT;
          GOTO      OPCD9999
.
OPCD9999  RETURN
.------------------------------------------------------------
. Set parameters for Specimens variables in Theatre Attributes
.------------------------------------------------------------
SSPECI00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SSPECI01,SSPECI02,SSPECI03,SSPECI04,SSPECI05
.
          MOVE      ONE,EXIT
          GOTO      SSPECI99
.
SSPECI01  PACK      SPECI001,QRYDATA,SP70
          GOTO      SSPECI99
.
SSPECI02  PACK      SPECI002,QRYDATA,SP70,SP70
          GOTO      SSPECI99
.
SSPECI03  PACK      SPECI003,QRYDATA,SP70,SP70
          GOTO      SSPECI99
.
SSPECI04  PACK      SPECI004,QRYDATA,SP70,SP70
          GOTO      SSPECI99
.
SSPECI05  PACK      SPECI005,QRYDATA,SP70,SP70
          GOTO      SSPECI99
.
SSPECI99  RETURN
+
.------------------------------------------------------------
. Set parameters for Drains variables in Theatre Attributes
.------------------------------------------------------------
SDRAIN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SDRAIN01,SDRAIN02,SDRAIN03,SDRAIN04,SDRAIN05:
                       SDRAIN06,SDRAIN07
.
          MOVE      ONE,EXIT
          GOTO      SDRAIN99
.
SDRAIN01  PACK      DRAIN001,QRYDATA,SP70,SP70
          GOTO      SDRAIN99
.
SDRAIN02  PACK      DRAIN002,QRYDATA,SP70,SP70
          GOTO      SDRAIN99
.
SDRAIN03  PACK      DRAIN003,QRYDATA,SP70,SP70
          GOTO      SDRAIN99
.
SDRAIN04  PACK      DRAIN004,QRYDATA,SP70,SP70
          GOTO      SDRAIN99
.
SDRAIN05  PACK      DRAIN005,QRYDATA,SP70
          GOTO      SDRAIN99
.
SDRAIN06  PACK      DRAIN006,QRYDATA,SP70
          GOTO      SDRAIN99
.
SDRAIN07  PACK      DRAIN007,QRYDATA,SP70
          GOTO      SDRAIN99
.
SDRAIN99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Specimens Details
.------------------------------------------------------------
UPOAS000  MATCH     "1",UPDOPATI
          GOTO      UPOAS999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      TEN4,OTTYPIND                 * Specimens Value 1
          MOVE      ONE,OTVALIND
          MOVE      SPECI001,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TEN4,OTTYPIND                 * Specimens Text 1
          MOVE      ONE,OTTXTIND
          MOVE      SPECI002,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN4,OTTYPIND                 * Specimens Text 2
          MOVE      TWO,OTTXTIND
          MOVE      SPECI003,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN4,OTTYPIND                 * Specimens Text 3
          MOVE      THREE,OTTXTIND
          MOVE      SPECI004,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN4,OTTYPIND                 * Specimens Text 4
          MOVE      FOUR,OTTXTIND
          MOVE      SPECI005,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
UPOAS999  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Drains Details
.------------------------------------------------------------
UPOAD000  MATCH     "1",UPDOPATI
          GOTO      UPOAD999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      TWENTY5,OTTYPIND              * Drains Text 1
          MOVE      ONE,OTTXTIND
          MOVE      DRAIN001,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Text 2
          MOVE      TWO,OTTXTIND
          MOVE      DRAIN002,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Text 3
          MOVE      THREE,OTTXTIND
          MOVE      DRAIN003,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Text 4
          MOVE      FOUR,OTTXTIND
          MOVE      DRAIN004,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Value 1
          MOVE      ONE,OTVALIND
          MOVE      DRAIN005,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Value 2
          MOVE      TWO,OTVALIND
          MOVE      DRAIN006,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TWENTY5,OTTYPIND              * Drains Value 3
          MOVE      THREE,OTVALIND
          MOVE      DRAIN007,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
UPOAD999  RETURN
+
.------------------------------------------------------------
. Set parameters for In Dwelling Catheter variables in Theatre Attributes
.------------------------------------------------------------
SCATHT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SCATHT01,SCATHT02,SCATHT03,SCATHT04,SCATHT05:
                       SCATHT06,SCATHT07,SCATHT08,SCATHT09
.
          MOVE      ONE,EXIT
          GOTO      SCATHT99
.
SCATHT01  PACK      CATHT001,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT02  PACK      CATHT002,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT03  PACK      CATHT003,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT04  PACK      CATHT004,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT05  PACK      CATHT005,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT06  PACK      CATHT006,QRYDATA,SP70,SP70
          GOTO      SCATHT99
.
SCATHT07  PACK      CATHT007,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT08  PACK      CATHT008,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT09  PACK      CATHT009,QRYDATA,SP70
          GOTO      SCATHT99
.
SCATHT99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Catheter Details
.------------------------------------------------------------
UPOAI000  MATCH     "1",UPDOPATI
          GOTO      UPOAI999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Cod 1
          MOVE      ONE,OTCODIND
          MOVE      CATHT001,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Cod 2
          MOVE      TWO,OTCODIND
          MOVE      CATHT002,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Cod 3
          MOVE      THREE,OTCODIND
          MOVE      CATHT003,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Cod 4
          MOVE      FOUR,OTCODIND
          MOVE      CATHT004,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Cod 5
          MOVE      FIVE,OTCODIND
          MOVE      CATHT005,OTCODVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOCV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Text 2
          MOVE      TWO,OTTXTIND
          MOVE      CATHT006,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Value 1
          MOVE      ONE,OTVALIND
          MOVE      CATHT007,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Value 2
          MOVE      TWO,OTVALIND
          MOVE      CATHT008,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TWENTY6,OTTYPIND              * Catheter Value 3
          MOVE      THREE,OTVALIND
          MOVE      CATHT009,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
UPOAI999  RETURN
+
.------------------------------------------------------------
. Set parameters for Irrigation Used variables in Theatre Attributes
.------------------------------------------------------------
SIRRIG00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SIRRIG01,SIRRIG02,SIRRIG03,SIRRIG04,SIRRIG05:
                       SIRRIG06,SIRRIG07,SIRRIG08,SIRRIG09,SIRRIG10
.
          MOVE      ONE,EXIT
          GOTO      SIRRIG99
.
SIRRIG01  PACK      IRRIG001,QRYDATA,SP70,SP70
          GOTO      SIRRIG99
.
SIRRIG02  PACK      IRRIG002,QRYDATA,SP70,SP70
          GOTO      SIRRIG99
.
SIRRIG03  PACK      IRRIG003,QRYDATA,SP70,SP70
          GOTO      SIRRIG99
.
SIRRIG04  PACK      IRRIG004,QRYDATA,SP70,SP70
          GOTO      SIRRIG99
.
SIRRIG05  PACK      IRRIG005,QRYDATA,SP70,SP70
          GOTO      SIRRIG99
.
SIRRIG06  PACK      IRRIG006,QRYDATA,SP70
          GOTO      SIRRIG99
.
SIRRIG07  PACK      IRRIG007,QRYDATA,SP70
          GOTO      SIRRIG99
.
SIRRIG08  PACK      IRRIG008,QRYDATA,SP70
          GOTO      SIRRIG99
.
SIRRIG09  PACK      IRRIG009,QRYDATA,SP70
          GOTO      SIRRIG99
.
SIRRIG10  PACK      IRRIG010,QRYDATA,SP70
          GOTO      SIRRIG99
.
SIRRIG99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Irrigation Details
.------------------------------------------------------------
UPOAG000  MATCH     "1",UPDOPATI
          GOTO      UPOAG999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      SEVEN,OTTYPIND                * Irrigation Text 1 Type 007
          MOVE      ONE,OTTXTIND
          MOVE      IRRIG001,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      EIGHT,OTTYPIND                * Irrigation Text 1 Type 008
          MOVE      ONE,OTTXTIND
          MOVE      IRRIG002,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      NINE,OTTYPIND                 * Irrigation Text 1 Type 009
          MOVE      ONE,OTTXTIND
          MOVE      IRRIG003,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN,OTTYPIND                  * Irrigation Text 1 Type 010
          MOVE      ONE,OTTXTIND
          MOVE      IRRIG004,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN1,OTTYPIND                 * Irrigation Text 1 Type 011
          MOVE      ONE,OTTXTIND
          MOVE      IRRIG005,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      SEVEN,OTTYPIND                * Irrigation Value 1 Type 007
          MOVE      ONE,OTVALIND
          MOVE      IRRIG006,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      EIGHT,OTTYPIND                * Irrigation Value 1 Type 008
          MOVE      ONE,OTVALIND
          MOVE      IRRIG007,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      NINE,OTTYPIND                 * Irrigation Value 1 Type 009
          MOVE      ONE,OTVALIND
          MOVE      IRRIG008,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TEN,OTTYPIND                  * Irrigation Value 1 Type 010
          MOVE      ONE,OTVALIND
          MOVE      IRRIG009,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TEN1,OTTYPIND                 * Irrigation Value 1 Type 011
          MOVE      ONE,OTVALIND
          MOVE      IRRIG010,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
UPOAG999  RETURN
+
.------------------------------------------------------------
. Set parameters for Dressing Type variables in Theatre Attributes
.------------------------------------------------------------
SDRESN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SDRESN01
.
          MOVE      ONE,EXIT
          GOTO      SDRESN99
.
SDRESN01  PACK      DRESN001,QRYDATA,SP70
          GOTO      SDRESN99
.
SDRESN99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Dressing Type Details
.------------------------------------------------------------
UPODT000  MATCH     "1",DRSSNIND
          GOTO      UPODT999 IF NOT EQUAL 
.
          MATCH     "1",UPDOPATI
          GOTO      UPODT999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MOVE      TEN2,OTTYPIND                 * Irrigation Text 1 Type 007
          MOVE      ONE,OTTXTIND
          MOVE      DRESN001,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
UPODT999  RETURN
+
.------------------------------------------------------------
. Set parameters for Count Correct variables in Theatre Attributes
.------------------------------------------------------------
SCOUNC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SCOUNC01,SCOUNC02,SCOUNC03,SCOUNC04,SCOUNC05:
                       SCOUNC06,SCOUNC07,SCOUNC08
.
          MOVE      ONE,EXIT
          GOTO      SCOUNC99
.
SCOUNC01  PACK      COUNC001,QRYDATA,SP70
          GOTO      SCOUNC99
.
SCOUNC02  PACK      COUNC002,QRYDATA,SP70
          GOTO      SCOUNC99
.
SCOUNC03  PACK      COUNC003,QRYDATA,SP70
          GOTO      SCOUNC99
.
SCOUNC04  PACK      COUNC004,QRYDATA,SP70
          GOTO      SCOUNC99
.
SCOUNC05  PACK      COUNC005,QRYDATA,SP70,SP70
          GOTO      SCOUNC99
.
SCOUNC06  PACK      COUNC006,QRYDATA,SP70,SP70
          GOTO      SCOUNC99
.
SCOUNC07  UNPACK    QRYDATA,DIM2,DIM1,DIM2A,DIM1,DIM2B
          PACK      COUNC007,DIM2,DIM2A,DIM2B,SP70
          GOTO      SCOUNC99
.
SCOUNC08  UNPACK    QRYDATA,DIM2,DIM1,DIM2A,DIM1,DIM2B
          PACK      COUNC008,DIM2,DIM2A,DIM2B,SP70
          GOTO      SCOUNC99
.
SCOUNC99  RETURN
+
.------------------------------------------------------------
. Update Theatre Attributes Count Correct Details
.------------------------------------------------------------
UPOAR000  MATCH     "1",UPDOPATI
          GOTO      UPOAR999 IF NOT EQUAL
.
          CALL      CLOPRATR
          CALL      MVOTTATR
.
          MATCH     "2",CNTDTAIL
          GOTO      UPOAR100 IF EQUAL
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Y/N 1
          MOVE      ONE,OTYENIND
          MOVE      COUNC001,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Y/N 2
          MOVE      TWO,OTYENIND
          MOVE      COUNC002,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Text 1
          MOVE      ONE,OTTXTIND
          MOVE      COUNC005,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Text 2
          MOVE      TWO,OTTXTIND
          MOVE      COUNC006,OTTXTVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOTV00
.
UPOAR100  MATCH     "1",CNTDTAIL
          GOTO      UPOAR999 IF EQUAL
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Y/N 3
          MOVE      THREE,OTYENIND
          MOVE      COUNC003,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Y/N 4
          MOVE      FOUR,OTYENIND
          MOVE      COUNC004,OTYENVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOYN00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Value 1
          MOVE      ONE,OTVALIND
          MOVE      COUNC007,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
          MOVE      TEN3,OTTYPIND                 * Count Correct Value 2
          MOVE      TWO,OTVALIND
          MOVE      COUNC008,OTVALVAL
          MOVE      OPDAUNIQ,OTATR001
          CALL      UPDOVV00
.
UPOAR999  RETURN
+
.******************************************************************************
.*                  Output Table of Staff Members                             *
.******************************************************************************
STFF0000  MATCH     "1",UPDOPSDT
          GOTO      STFF9999 IF NOT EQUAL  
.
          MATCH     "0",TEAMNUMB
          IF        @EQUAL
            MOVE      "1",TEAMNUMB
          ENDIF
.
          PACK      KEY89,OPDAUNIQ,TEAMNUMB,SP70,SP70
          CALL      RSOPSDT1
STFF0100  CALL      RKOPSDT1
          BRANCH    OVRCD,STFF9999
          MATCH     OPSDUNIQ,OPDAUNIQ
          GOTO      STFF9999 IF NOT EQUAL
          MATCH     OPSDTNUM,TEAMNUMB
          GOTO      STFF9999 IF NOT EQUAL
.
          MOVE      SP70,STAFFNAM
          MOVE      SP70,OPPTDESC
          MOVE      OPSDSTYP,FORM2
          IF        FORM2=0
            MOVE      OPTDESC0,OPPTDESC
            GOTO      STFF0200
           ENDIF
          IF        FORM2=1
            MOVE      OPTDESC1,OPPTDESC
            GOTO      STFF0200
           ENDIF
          IF        FORM2=2
            MOVE      OPTDESC2,OPPTDESC
            GOTO      STFF0200
          ENDIF
          IF        FORM2=3
            MOVE      OPTDESC3,OPPTDESC
            GOTO      STFF0200
          ENDIF
.
STFF0200  MOVE      SP70,DIM19
          MATCH     SP70,OPSDSTCC
          GOTO      STFF2500 IF EQUAL
.
          IF        FORM2=0 | FORM2=1
            MOVE      "OP",CATEGORY
            GOTO      STFF2400
          ENDIF
          IF        FORM2=2
            MOVE      "ON",CATEGORY
            GOTO      STFF2400
          ENDIF
          IF        FORM2=3
            MOVE      "OF",CATEGORY
            GOTO      STFF2400
          ENDIF
          GOTO      STFF2500
.
STFF2400  MOVE      OPSDSTCC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,DIM19
          ENDIF
.
STFF2500  MOVE      "OS",CATEGORY
          MOVE      OPSDSLEV,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
          ENDIF
.
          MOVE      "No",KEY3
          MATCH     "1",OPSDFICT
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
.
          MOVE      "No",TIMEOUTD
          MATCH     "1",OPSDUYN1
          IF        @EQUAL
            MOVE      "Yes",TIMEOUTD
          ENDIF
.
STFF0300  PACK      KEY89,OPSDUNIQ,OPSDTNUM,OPSDSTYP,OPSDSNAM:
                          	OPSDSDAT,OPSDSTIM,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLinkFF('",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "','",HTMLLINK
          MOVE      OPSDSTYP,DIM2
          SQUEEZE   DIM2
          MOVE      DIM2,DIM1
          APPEND    DIM1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPSDSNAM,HTMLLINK
          APPEND    "','",HTMLLINK
          UNPACK    OPSDSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      OPTSFDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          APPEND    OPTSFDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPSDSTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
..
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OPPTDESC,"#",":
                             "#"",OPSDSNAM,"#",":
                             "#"",OPSDSTIM,"#",":
                             "#"",OPSDETIM,"#",":
                             "#"",TDESC,"#",":
                             "#"",DIM19,"#",":
                             "#"",KEY3,"#",":
                             "#"","javascript:UpdateEndTimeFF('",KEY89,"')#",":
                             "#"",TIMEOUTD,"#");";
.
          GOTO      STFF0100
.
STFF9999  RETURN
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  MATCH     SP70,SETDEFPN
          IF        !@EQUAL
            PACK      KEY20,SETDEFPN,USERID,SP70
            GOTO      UPDEFP10
          ENDIF
          GOTO      UPDEFP99
.
UPDEFP10  UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT
          MOVE      SCHDCOPY,IBPDCOP        * no of copies
          MOVE      STATNCOD,IBPDDOC        * save stat code to document 

          MOVE      SP70,IBPDNUM
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
+
.---------------------------------------------------------
. Write Admitting Nurse to OPRTSM
.---------------------------------------------------------
WOPTSM00   MOVE     SP70,KEY3
.
           PACK     KEY5,ANSO,ANSN,SP70
           CALL     RDSCODE1
WOPTSM10   CALL     RDKCODE1
           BRANCH   OVRCD,WOPTSM20
.
           MATCH    "ON",TCODE
           GOTO     WOPTSM20  IF NOT EQUAL
.
           MATCH    SP70,ACODE
           GOTO     WOPTSM10  IF EQUAL
.
           MATCH    "A",TCINDC1
           GOTO     WOPTSM10  IF NOT EQUAL
.
           MOVE     ACODE,KEY3
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVEANUR,OPTSSCDE
           MOVE     SAVEADAT,OPTSSDAT
           MOVE     SAVEATIM,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARANUR
           GOTO     WOPTSM20  IF EQUAL
           GOTO     WOPTSM20  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARANUR,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARATIM,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUD1 ****
.
WOPTSM20   MOVE     SP70,KEY3
.
           PACK     KEY5,ANSO,ANSN,SP70
           CALL     RDSCODE1
WOPTSM25   CALL     RDKCODE1
           BRANCH   OVRCD,WOPTSM99
.
           MATCH    "ON",TCODE
           GOTO     WOPTSM99  IF NOT EQUAL
.
           MATCH    SP70,ACODE
           GOTO     WOPTSM25  IF EQUAL
.
           MATCH    "R",TCINDC1
           GOTO     WOPTSM25  IF NOT EQUAL
.
           MOVE     ACODE,KEY3
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUD1,OPTSSCDE
           MOVE     SAVEDUD1,OPTSSDAT
           MOVE     SAVETUD1,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUD1
           GOTO     WOPTSM30  IF EQUAL
           GOTO     WOPTSM30  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUD1,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRD,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUD2 ****
.
WOPTSM30   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUD2,OPTSSCDE
           MOVE     SAVEDUD2,OPTSSDAT
           MOVE     SAVETUD2,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUD2
           GOTO     WOPTSM99  IF EQUAL
           GOTO     WOPTSM99  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUD2,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRD,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
WOPTSM99   RETURN
.---------------------------------------------------------
. Write Recovery Nurses to OPRTSM
.---------------------------------------------------------
WOPTSR00   MOVE     SP70,KEY3
.
           PACK     KEY5,ANSO,ANSN,SP70
           CALL     RDSCODE1
WOPTSR10   CALL     RDKCODE1
           BRANCH   OVRCD,WOPTSR99
.
           MATCH    "ON",TCODE
           GOTO     WOPTSR99  IF NOT EQUAL
.
           MATCH    SP70,ACODE
           GOTO     WOPTSR10  IF EQUAL
.
           MATCH    "R",TCINDC1
           GOTO     WOPTSR10  IF NOT EQUAL
.
           MOVE     ACODE,KEY3
.
. **** OPARNUF1 ****
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUF1,OPTSSCDE
           MOVE     SAVEDUF1,OPTSSDAT
           MOVE     SAVETUF1,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUF1
           GOTO     WOPTSR20  IF EQUAL
           GOTO     WOPTSR20  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUF1,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRF,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUF2 ****
.
WOPTSR20   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUF2,OPTSSCDE
           MOVE     SAVEDUF2,OPTSSDAT
           MOVE     SAVETUF2,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUF2
           GOTO     WOPTSR30  IF EQUAL
           GOTO     WOPTSR30  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUF2,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRF,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUB1 ****
.
WOPTSR30   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUB1,OPTSSCDE
           MOVE     SAVEDUB1,OPTSSDAT
           MOVE     SAVETUB1,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUB1
           GOTO     WOPTSR40  IF EQUAL
           GOTO     WOPTSR40  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUB1,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRB,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUB2 ****
.
WOPTSR40   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUB2,OPTSSCDE
           MOVE     SAVEDUB2,OPTSSDAT
           MOVE     SAVETUB2,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUB2
           GOTO     WOPTSR50  IF EQUAL
           GOTO     WOPTSR50  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUB2,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRB,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUD1 ****
.
WOPTSR50   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUD1,OPTSSCDE
           MOVE     SAVEDUD1,OPTSSDAT
           MOVE     SAVETUD1,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUD1
           GOTO     WOPTSR60  IF EQUAL
           GOTO     WOPTSR60  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUD1,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRD,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
. **** OPARNUD2 ****
.
WOPTSR60   CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVENUD2,OPTSSCDE
           MOVE     SAVEDUD2,OPTSSDAT
           MOVE     SAVETUD2,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARNUD2
           GOTO     WOPTSR99  IF EQUAL
           GOTO     WOPTSR99  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARNUD2,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARTIRD,OPTSSTIM
           MOVE     KEY3,OPTSSTYP
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1
           ENDIF
.
WOPTSR99   RETURN
+
.*****************************************************************************
.         Display All comments
.*****************************************************************************
SHWCOM00  MOVE      "Comment",KEY9
          MOVE      OPRQITEM,DIM9 
.
          PACK      KEY24,OPRQDCOD,DIM9,OPRQCLSS,SP70
          CALL      RSOPPCM1
SHWCOM10  CALL      RKOPPCM1
          BRANCH    OVRCD,SHWCOM99 
.
          MATCH     OPRQDCOD,OPPCCODE
          GOTO      SHWCOM99 IF NOT EQUAL
.
          MATCH     OPRQITEM,OPPCPREF
          GOTO      SHWCOM99 IF NOT EQUAL
.
          MATCH     OPRQCLSS,OPPCCLSS
          GOTO      SHWCOM99 IF NOT EQUAL
.
          MOVE      OPPCDESC,PREFDESC
.
          MOVE      ONE,SHOWHEAD
.
          MOVE      TCFORM6,TEMPASSC
          RJUSTIFY  TEMPASSC
          MOVE      OPRQTYPE,TEMPTYPE
          MOVE      SAVKEY36,TEMPKY36
          MOVE      OPPCLINE,TEMPITEM
          MOVE      PREFDESC,TEMPPDSC
          MOVE      KEY9,TEMPKEY9
          MOVE      TDESC,TEMPTDSC
          MOVE      ZERO,TEMPAMNT
          RJUSTIFY  TEMPAMNT
          ADD       ONE,FORM3
          MOVE      FORM3,TEMPCONT
          MOVE      OPRQDCOD,TEMPDOCT
          MOVE      OPRQCLSS,TEMPCLSS
          MOVE      SP70,TEMPVALD
.
          PACK      KEY10,TEMPASSC,TEMPTYPE,TEMPCONT,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
.
.         WRITE     HTMLFILE;"<tr><td nowrap valign=middle>":
.                            "<a href='javascript:UpdateReq(#"",SAVKEY36:
.                            "#");'><img src=../images/EditIcon.gif class=Icon":
.                            " hspace=4 border=0 align=absmiddle></a>&nbsp;":
.                            OPPCLINE,"</td>":
.                            "<td>",PREFDESC,"</td>":
.                            "<td>",KEY9,"</td>":
.                            "<td>",TDESC,"</td>":
.                            "<td>&nbsp;</td>":
.                            "<td>&nbsp;</td>":
.                            "</tr>" 
.
          GOTO      SHWCOM10
.
SHWCOM99  RETURN
+
.*****************************************************************************
.         Display All requisitions for Anaesthetist
.*****************************************************************************
SHWANA00  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,SHWANA99
.
          MOVE      OPSEANAE,OPTSSCDE
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,OPTSSCDE,SP70
          CALL      RSOPREQ1
SHWANA10  CALL      RKOPREQ1
          BRANCH    OVRCD,SHWANA99
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      SHWANA99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      SHWANA99 IF NOT EQUAL
          MATCH     OPTSSCDE,OPRQDCOD
          GOTO      SHWANA99 IF NOT EQUAL
.
          MOVE      OPRQTYPE,ITEMTYPE
          MOVE      OPRQITEM,OPPRPREF
          MOVE      ONE,SKIPDPRF
          CALL      PRFDSC00
.
          PACK      KEY5,ANSO,ANSG,OPRQCLSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Class",TDESC
          ENDIF
.
          PACK      SAVKEY36,OPRQUNIQ,OPRQTEAM,OPRQDCOD,OPRQCLSS,OPRQTYPE:
                             OPRQITEM,SP70
.
          MOVE      ONE,SHOWHEAD
.
          MOVE      "Unknown",KEY9
          MATCH     "0",OPRQTYPE
          IF        @EQUAL
            MOVE      "Tray",KEY9
          ENDIF
          MATCH     "1",OPRQTYPE
          IF        @EQUAL
            MOVE      "Item",KEY9
          ENDIF
          MATCH     "2",OPRQTYPE
          IF        @EQUAL
            MOVE      "Equipment",KEY9
          ENDIF
.
          MATCH     "3",OPRQTYPE
          IF        @EQUAL
            CALL      SHWCOM00
            GOTO      SHWANA10
          ENDIF
.
          MOVE      TCFORM6,TEMPASSC
          RJUSTIFY  TEMPASSC
          MOVE      OPRQTYPE,TEMPTYPE
          MOVE      SAVKEY36,TEMPKY36
          MOVE      OPRQITEM,TEMPITEM
          MOVE      PREFDESC,TEMPPDSC
          MOVE      KEY9,TEMPKEY9
          MOVE      TDESC,TEMPTDSC
          MOVE      OPRQAMNT,TEMPAMNT
          RJUSTIFY  TEMPAMNT
          ADD       ONE,FORM3
          MOVE      FORM3,TEMPCONT
          MOVE      OPRQDCOD,TEMPDOCT
          MOVE      OPRQCLSS,TEMPCLSS
          MOVE      INVLDITM,TEMPVALD
.
          PACK      KEY10,TEMPASSC,TEMPTYPE,TEMPCONT,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
          GOTO      SHWANA10
.
SHWANA99  RETURN
+
.*****************************************************************************
.*        Tempfile I/O Subroutines                                           *
.*****************************************************************************
RATMPRE1  MOVE      ZERO,OVRCD
          RESET     KEY10
          READ      TMPREOR1,KEY10;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPRE1  RESET     KEY10
          READ      TMPREOR1,KEY10;;
          RETURN
.
RDTMPRE1  MOVE      ZERO,OVRCD
          RESET     KEY10
          READ      TMPREOR1,KEY10;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM,TEMPPDSC:
                                   TEMPKEY9,TEMPTDSC,TEMPAMNT,TEMPCONT,TEMPDOCT:
                                   TEMPCLSS,TEMPUNIQ,TEMPTEAM,TEMPVALD
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMPRE1  MOVE      ZERO,OVRCD
          READKS    TMPREOR1;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM,TEMPPDSC:
                             TEMPKEY9,TEMPTDSC,TEMPAMNT,TEMPCONT,TEMPDOCT:
                             TEMPCLSS,TEMPUNIQ,TEMPTEAM,TEMPVALD
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPRE1  MOVE      ZERO,OVRCD
          READKP    TMPREOR1;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM,TEMPPDSC:
                             TEMPKEY9,TEMPTDSC,TEMPAMNT,TEMPCONT,TEMPDOCT:
                             TEMPCLSS,TEMPUNIQ,TEMPTEAM,TEMPVALD
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPRE1  RESET     KEY10
          WRITE     TMPREOR1,KEY10;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM:
                                   TEMPPDSC,TEMPKEY9,TEMPTDSC,TEMPAMNT:
                                   TEMPCONT,TEMPDOCT,TEMPCLSS,TEMPUNIQ:
                                   TEMPTEAM,TEMPVALD
          RETURN
.
DETMPRE1  RESET     KEY10
          DELETE    TMPREOR1,KEY10
          RETURN
.
RSTMPRE2  RESET     KEY13
          READ      TMPREOR2,KEY13;;
          RETURN
.
RKTMPRE2  MOVE      ZERO,OVRCD
          READKS    TMPREOR2;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM,TEMPPDSC:
                             TEMPKEY9,TEMPTDSC,TEMPAMNT,TEMPCONT,TEMPDOCT:
                             TEMPCLSS,TEMPUNIQ,TEMPTEAM,TEMPVALD
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPRE2  MOVE      ZERO,OVRCD
          READKP    TMPREOR2;TEMPASSC,TEMPTYPE,TEMPKY36,TEMPITEM,TEMPPDSC:
                             TEMPKEY9,TEMPTDSC,TEMPAMNT,TEMPCONT,TEMPDOCT:
                             TEMPCLSS,TEMPUNIQ,TEMPTEAM,TEMPVALD
          GOTO      OVERCOND IF OVER
          RETURN
.
.
.*****************************************************************************
.*        Create Tempfile                                                    *
.*****************************************************************************
CRTMP000  CALL      KTMP0000
.
          CLEAR     DIM100
          APPEND    "isbuild ",DIM100
          APPEND    FNAMEA,DIM100
          APPEND    " 205 U1-6,7-7,181-183",DIM100
          APPEND    " U190-192,1-6,7-7,181-183",DIM100
          RESET     DIM100
          EXECUTE   DIM100,TASKID
          OPEN      TMPREOR1,FNAMEA
          OPEN      TMPREOR2,FNAMEA
.
          PACK      KEY10,SP70
          CALL      RSTMPRE1
CRTMP100  CALL      RKTMPRE1
          BRANCH    OVRCD,CRTMP999
.
          CALL      DETMPRE1
          GOTO      CRTMP100
.
CRTMP999  RETURN
.
.*****************************************************************************
.*        Kill Tempfile                                                      *
.*****************************************************************************
KTMP0000  CLOSE     TMPREOR1
          CLOSE     TMPREOR2
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEA,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KTMP9999  RETURN
.
+
.*****************************************************************************
.                    Table of Charge Requisitions for this booking
.*****************************************************************************
REQTAC00  MATCH     SP70,OPDAUNIQ
          GOTO      REQTAC99 IF EQUAL
.
          MOVE      ZERO,OPTSSIND    * Operating Surgeon
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,OPTSSIND,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,REQTAC10
.
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      REQTAC10 IF NOT EQUAL
          MATCH     TEAMNUMB,OPTSTMNO
          GOTO      REQTAC10 IF NOT EQUAL
          COMPARE   ZERO,OPTSSIND
          GOTO      REQTAC10 IF NOT EQUAL
.
          GOTO      REQTAC20
.
REQTAC10  MOVE      OPDACLIN,OPTSSCDE
.
REQTAC20  CALL      SHWREC00
.
REQTAC99  RETURN
+
.*****************************************************************************
.         Display All Charge Requisitions
.*****************************************************************************
SHWREC00  CALL      CRTMP000
.
          MOVE      ZERO,FORM3
          MOVE      ZERO,SHOWHEAD
          WRITE     HTMLFILE;"<tr><td><table cellspacing=0 cellpadding=1":
                             " width=95% border=1>":
                             "<tr><td width=15% class=HeadingCell>":
                             "Code / Line No.</td>":
                             "<td width=35% class=HeadingCell>":
                             "Description</td>":
                             "<td width=10% class=HeadingCell>Type</td>":
                             "<td width=15% class=HeadingCell>Class</td>":
                             "<td width=10% class=HeadingCell align=center>":
                             "Quantity</td>":
                             "<td width=10% class=HeadingCell align=center>":
                             "Charge</td>":
                             "</tr>"
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,OPTSSCDE,SP70
          CALL      RSOPREQ1
SHWREC10  CALL      RKOPREQ1
          BRANCH    OVRCD,SHWREC90
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      SHWREC90 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      SHWREC90 IF NOT EQUAL
          MATCH     OPTSSCDE,OPRQDCOD
          GOTO      SHWREC90 IF NOT EQUAL
.
          MOVE      OPRQTYPE,ITEMTYPE
          MOVE      OPRQITEM,OPPRPREF
          MOVE      ONE,SKIPDPRF
          CALL      PRFDSC00
.
          PACK      KEY5,ANSO,ANSG,OPRQCLSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Class",TDESC
          ENDIF
.
          PACK      SAVKEY36,OPRQUNIQ,OPRQTEAM,OPRQDCOD,OPRQCLSS,OPRQTYPE:
                             OPRQITEM,SP70
.
          MOVE      ONE,SHOWHEAD
.
          MOVE      "Unknown",KEY9
          MATCH     "0",OPRQTYPE
          IF        @EQUAL
            MOVE      "Tray",KEY9
          ENDIF
          MATCH     "1",OPRQTYPE
          IF        @EQUAL
            MOVE      "Item",KEY9
          ENDIF
          MATCH     "2",OPRQTYPE
          IF        @EQUAL
            MOVE      "Equipment",KEY9
          ENDIF
.
          MATCH     "3",OPRQTYPE
          IF        @EQUAL
            CALL      SHWCOM00
            GOTO      SHWREC10
          ENDIF
.
          MOVE      TCFORM6,TEMPASSC
          RJUSTIFY  TEMPASSC
          MOVE      OPRQTYPE,TEMPTYPE
          MOVE      SAVKEY36,TEMPKY36
          MOVE      OPRQITEM,TEMPITEM
          MOVE      PREFDESC,TEMPPDSC
          MOVE      KEY9,TEMPKEY9
          MOVE      TDESC,TEMPTDSC
          MOVE      OPRQAMNT,TEMPAMNT
          RJUSTIFY  TEMPAMNT
          ADD       ONE,FORM3
          MOVE      FORM3,TEMPCONT
          MOVE      OPRQDCOD,TEMPDOCT
          MOVE      OPRQCLSS,TEMPCLSS
          MOVE      OPRQUNIQ,TEMPUNIQ
          MOVE      OPRQTEAM,TEMPTEAM
          MOVE      INVLDITM,TEMPVALD
.
          PACK      KEY10,TEMPASSC,TEMPTYPE,TEMPCONT,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
          GOTO      SHWREC10
.
SHWREC90  CALL      SHWANA00
          CALL      SHWTRY00
.
          MOVE      ZERO,TEMPCNTR
          MOVE      ZERO,TEMPCNT1
          MOVE      SP70,TEMPCNTD
.
          PACK      KEY10,SP70
          CALL      RSTMPRE1
SHWREC91  CALL      RKTMPRE1
          BRANCH    OVRCD,SHWREC98
.
          MATCH     "3",TEMPTYPE
          GOTO      SHWREC91 IF EQUAL
.
          CALL      ITAM0000
.
          ADD       ONE,TEMPCNTR
          MOVE      TEMPCNTR,TEMPCNTD
          REP       " 0",TEMPCNTD
          MOVE      TEMPCNTR,TEMPCNT1
          ADD       HUNDRED,TEMPCNT1
          MOVE      TEMPCNT1,TEMPCND1
          REP       " 0",TEMPCND1 
.
          MOVE      ZERO,INVLDITM
          MOVE      TEMPVALD,INVLDITM
.
          MATCH     "0",TEMPTYPE               * diabled charge for Tray
          IF        @EQUAL
            MOVE      "1",INVLDITM
          ENDIF  
.
          MATCH     "2",TEMPTYPE               * diabled charge for Equipment
          IF        @EQUAL
            MOVE      "1",INVLDITM
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap valign=middle>";
.
          IF        SHOWEDIT=1
            WRITE     HTMLFILE;"<a href='javascript:UpdateReq(#"",TEMPKY36:
                        "#",#"",OPDAHOSP,"#");":
                        "'><img src=../images/EditIcon.gif class=Icon":
                        "></a>&nbsp;";
          ENDIF
.
          WRITE     HTMLFILE;TEMPITEM,"</td>":
                      "<input type=hidden ":
                      "name=crkey",TEMPCND1," id=crkey",TEMPCND1," ":
                      "value=#"",TEMPKY36,TEMPPDSC,"#">":
                      "<td>",TEMPPDSC,"</td>":
                      "<td>",TEMPKEY9,"</td>":
                      "<input type=hidden ":
                      "id=rqtyp",TEMPCND1:
                      " name=rqtyp",TEMPCND1," value=#"",TEMPKEY9,"#">":
                      "<td>",TEMPTDSC,"</td>";
.
          PACK      KEY36,TEMPKY36,SP70
          CALL      RDOPREQ1
          IF        OVRCD=1
.              
            MOVE      TEMPAMNT,DIM3
            LJUSTIFY  DIM3
.           
            WRITE     HTMLFILE;"<td align=center>":
                        "<input type=text maxlength=3 size=5 class=ReadOnly ":
                        "min=0 max=999 readOnly ":
                        "onblur=#"document.AddForm.qunty",TEMPCND1:
                        ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                        " id=crqua",TEMPCND1:
                        " name=crqua",TEMPCND1," value=#"",DIM3,"#">":
                        "<input type=hidden ":
                        "id=itemn",TEMPCND1:
                        " name=itemn",TEMPCND1," value=#"#" >":
                        "</td>"
.            
            WRITE     HTMLFILE;"<td align=center>":
                               "</td>"
            GOTO      SHWREC94
          ENDIF
.           
          MOVE      SP70,CHRGDESC
          MATCH     "1",OPRQCHRG
          IF        @EQUAL
            MOVE      "Charged",CHRGDESC
            GOTO      SHWREC92
          ENDIF
.
          MATCH     "2",OPRQCHRG
          IF        @EQUAL
            MOVE      "Used",CHRGDESC
            GOTO      SHWREC92
          ENDIF
.
          GOTO        SHWREC93
.
SHWREC92  MOVE      TEMPAMNT,DIM3
          LJUSTIFY  DIM3
.             
          WRITE     HTMLFILE;"<td align=center>":
                    "<input type=text maxlength=3 size=5 class=ReadOnly ":
                    "min=0 max=999 readOnly ":
                    "onblur=#"document.AddForm.qunty",TEMPCND1:
                    ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                    " id=crqua",TEMPCND1:
                    " name=crqua",TEMPCND1," value=#"",DIM3,"#">":
                    "<input type=hidden ":
                    "id=itemn",TEMPCND1:
                    " name=itemn",TEMPCND1," value=#"#" >":
                    "</td>"
.               
          WRITE     HTMLFILE;"<td align=center>":
                             "<font color='red'>",CHRGDESC,"</font>":
                             "<input type=hidden ":
                             "name=crchr",TEMPCND1," id=crchr",TEMPCND1," ":
                             "value=1 >":
                             "<input type=hidden ":
                             " id=crchl",TEMPCND1:
                             " name=crchl",TEMPCND1," value=#"charged#" >":
                             "</td>"
          GOTO      SHWREC94
.
SHWREC93  IF        INVLDITM=1
            WRITE     HTMLFILE;"<td align=center>":
                      "<input type=text maxlength=3 size=5 class=disabled ":
                      "document.AddForm.qunty",TEMPCND1:
                      ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                      " id=crqua",TEMPCND1:
                      " name=crqua",TEMPCND1," value=#"",TEMPAMNT,"#">":
                      "<input type=hidden ":
                      "id=itemn",TEMPCND1:
                      " name=itemn",TEMPCND1," value=#"#" >":
                      "</td>"
.               
            WRITE     HTMLFILE;"<td align=center>":
                      "<input type=checkbox ":
                      "name=crchr",TEMPCND1:
                      " id=crchr",TEMPCND1:
                      " disabled>":
                      "<input type=hidden ":
                      " id=crch1",TEMPCND1:
                      " name=crchl",TEMPCND1," value=#"#" >":
                      "</td>"
          ELSE
            WRITE     HTMLFILE;"<td align=center>":
                      "<input type=text maxlength=3 size=5 class=Integer ":
                      "min=0 max=999 ":
        "onblur=#"if (checkInteger(this,this.title))":
        "{ if (trim(this.value)=='0' || isWhitespace(trim(this.value)))":
        "{alert ('Quantity must not be Zero'); this.value='1';} }":
                         "document.AddForm.qunty",TEMPCND1:
                         ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                         " id=crqua",TEMPCND1:
                         " name=crqua",TEMPCND1," value=#"",TEMPAMNT,"#">":
                         "<input type=hidden name=itemn",TEMPCND1:
                         " id=itemn",TEMPCND1:
                         " value=#"",TEMPITEM,"#">":
                         "</td>"
.                             
            WRITE     HTMLFILE;"<td align=center>":
                               "<input type=checkbox ":
                               "name=crchr",TEMPCND1," value=1 ":
                               "id=crchr",TEMPCND1:
                               " onclick=#"if(document.AddForm.crchr":
                               TEMPCND1,".checked==true) {":
                               "document.AddForm.itemn",TEMPCND1:
                               ".value='",TEMPITEM,"';":
                               "} else {":
                               "document.AddForm.itemn",TEMPCND1:
                               ".value='';":
                               "}#" ":
                               "checked>":
                             "</td>"
          ENDIF
.
SHWREC94  WRITE     HTMLFILE;"</tr>"
.
          WRITE     HTMLFILE;"<input type=hidden name=uniqu",TEMPCND1:
                             " id=uniqu",TEMPCND1:
                             " value=#"",UNIQU000,"#">":
                             "<input type=hidden name=mdate",TEMPCND1:
                             " id=mdate",TEMPCND1:
                             " value=#"",MDATE000,"#">":
                             "<input type=hidden name=incty",TEMPCND1:
                             " id=incty",TEMPCND1:
                             " incty",TEMPCND1:
                             " value=#"",INCTY000,"#">":
                             "<input type=hidden name=gstap",TEMPCND1:
                             " value=#"",PTMCGSTA,"#">":
                             "<input type=hidden name=gstcd",TEMPCND1:
                             " value=#"",PTMCGSTC,"#">":
                             "<input type=hidden name=patpr",TEMPCND1:
                             " value=#"",MPATPOR,"#">":
                             "<input type=hidden name=rebpr",TEMPCND1:
                             " value=#"",MHFPOR,"#">":
                             "<input type=hidden name=nzdes",TEMPCND1:
                             " value=#"",TEMPPDSC,"#">":
                             "<input type=hidden name=qunty",TEMPCND1:
                             " id=qunty",TEMPCND1:
                             " value=#"",TEMPAMNT,"#">"
.
          GOTO      SHWREC91
.
SHWREC98  IF        SHOWHEAD=0
            WRITE     HTMLFILE;"<tr><td colspan=6 align=center":
                               " bgcolor=#FF0000><b>No Requisitions Found</b>":
                               "</td></tr>"
          ENDIF
          WRITE     HTMLFILE;"</table></td></tr>"
.
SHWREC99  CALL      KTMP0000
          RETURN
+
.******************************************************************************
.*        Main Action Routine for User Group Favourites                       *
.******************************************************************************
PMSUFI00  CALL      CLPATMAS                * clear master detils
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLPATMIS                * clear admission details
.
PMSUFI05  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      PMSUFI40 IF EQUAL
.
          MATCH     "A",UPDATETY            
          GOTO      PMSUFI10 IF EQUAL
.
          GOTO      PMSUFI98
.
.------------------------------------------------------------
.         ADD Form Action
.------------------------------------------------------------
PMSUFI10  
.
          GOTO      PMSUFI99
.
.------------------------------------------------------------
.         DISPLAY Form Action
.------------------------------------------------------------
PMSUFI40  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PMSUFI91
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PMSUFI92
.
          PACK      KEY8,PURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "User Group Favourites",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,PMSUFI99
.
          CALL      WEBBOD00                
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PMSUFI99
.
.------------------------------------------------------------
.         Error Handling
.------------------------------------------------------------
PMSUFI91  MOVE      "Can't Find Admission Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSUFI99
.
PMSUFI92  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSUFI99
.
PMSUFI98  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSUFI99
.
PMSUFI99  RETURN
+
.*****************************************************************************
.         Display All Charge User Group Favourites
.*****************************************************************************
FAVTAC00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,SHOWHEAD
.
          MOVE      ZERO,TEMPCNTR
          MOVE      ZERO,TEMPCNT1
          MOVE      SP70,TEMPCND1
          MOVE      SP70,SAVEGHED
          MOVE      SP70,SAVEFAVG
.
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1":
                             " width=100% border=1>":
                             "<tr>":
                             "<td width=15% class=HeadingCell>":
                             "Favourite Group</td>":
                             "<td width=15% class=HeadingCell>":
                             "Sub-Group Heading</td>":
                             "<td width=15% class=HeadingCell>":
                             "Code</td>":
                             "<td width=40% class=HeadingCell>":
                             "Description</td>":
                             "<td width=5% class=HeadingCell align=center>":
                             "Quantity</td>":
                             "<td width=5% class=HeadingCell align=center>":
                             "Charge</td>":
                             "</tr></table>"
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,FAVTAC98
.
          CALL      CTMPFV00
          CALL      GFAVG000
.
. loop over temp file to output in associated number order
.
FAVTAC10  MATCH     SP70,WBSEOCG
          IF        @EQUAL
            PACK      KEY111,SP70,SP70
            CALL      RSTMPFV2
          ELSE
            PACK      KEY111,SP70,SP70
            CALL      RSTMPFV1
          ENDIF
.
FAVTAC20  MATCH     SP70,WBSEOCG
          IF        @EQUAL
            CALL      RKTMPFV2
            BRANCH    OVRCD,FAVTAC98        * end of file
          ELSE
            CALL      RKTMPFV1
            BRANCH    OVRCD,FAVTAC98        * end of file
          ENDIF 
.
          PACK      KEY31,TMUFHOSP,TMUFUOGR,TMUFFAVG,TMUFGHED:
                          TMUFUSER,TMUFCODE,SP70
          CALL      RDPMUFI2 
.
          MOVE      ONE,SHOWHEAD
.
          ADD       ONE,TEMPCNTR
          MOVE      TEMPCNTR,TEMPCNT1
          ADD       HUNDRED,TEMPCNT1
          MOVE      TEMPCNT1,TEMPCND1
          REP       " 0",TEMPCND1
.
          MOVE      CURRDATE,CDATE
          CALL      CHGITD00
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1":
                             " width=100% border=1>";
          WRITE     HTMLFILE;"<tr>"
.
          MATCH     SAVEFAVG,PMUFFAVG
          IF        !@EQUAL
            PACK      KEY5,CATw4,PMUFFAVG,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUFFAVG,PTCDLDES
            ENDIF
            WRITE     HTMLFILE;"<td width=15%> &nbsp; ",PTCDLDES,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td width=15%>&nbsp;</td>";
          ENDIF
.
          MOVE      PMUFFAVG,SAVEFAVG
.
          MATCH     SAVEGHED,PMUFGHED
          IF        !@EQUAL
            PACK      KEY5,CATw5,PMUFGHED,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMUFGHED,PTCDLDES
            ENDIF
            WRITE     HTMLFILE;"<td width=15%>",PTCDLDES,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td width=15%>&nbsp;</td>";
          ENDIF
.
          MOVE      PMUFGHED,SAVEGHED
.
          WRITE     HTMLFILE;"<td width=15%>",PMUFCODE,"</td>";
          WRITE     HTMLFILE;"<td width=40%>",PMUFDESC,"</td>";
.
          IF        INVLDITM=1
            WRITE     HTMLFILE;"<td width=5% align=center>":
                      "<input type=text maxlength=3 size=5 class=disabled ":
                      "document.AddForm.qunty",TEMPCND1:
                      ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                      "name=crqua",TEMPCND1:
                      " id=crqua",TEMPCND1:
                      " value=#"",PMUFQUAN,"#">":
                      "</td>"
.
          ELSE
            WRITE     HTMLFILE;"<td width=5% align=center>":
                      "<input type=text maxlength=3 size=5 class=Integer ":
                      "min=0 max=999 ":
.                     "onblur=#"checkInteger(this,this.title);":
        "onblur=#"if (checkInteger(this,this.title))":
        "{ if (trim(this.value)=='0' || isWhitespace(trim(this.value)))":
        "{alert ('Quantity must not be Zero'); this.value='1';} }":
                      "document.AddForm.qunty",TEMPCND1:
                      ".value=document.AddForm.crqua",TEMPCND1,".value;#" ":
                      "name=crqua",TEMPCND1:
                      " id=crqua",TEMPCND1:
                      " value=#"",PMUFQUAN,"#">":
                      "</td>"
          ENDIF
.
FAVTAC30  IF        INVLDITM=1
            WRITE     HTMLFILE;"<td width=5% align=center>":
                      "<input type=checkbox ":
                      "name=crchr",TEMPCND1:
                      " id=crchr",TEMPCND1:
                      " disabled>";
          ELSE
            MATCH     "1",ALRMESFL
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td width=5% align=center>":
                        "<input type=checkbox ":
                        "name=crchr",TEMPCND1," value=1 ":
                        "id=crchr",TEMPCND1:
                        " onclick=#"if(document.AddForm.crchr":
                        TEMPCND1,".checked==true) {":
                        "document.AddForm.itemn",TEMPCND1:
                        ".value='",PMUFCODE,"';":
                        "} else {":
                        "document.AddForm.itemn",TEMPCND1:
                        ".value='';":
                       "}#" ":
                        ">";
            ELSE
              PACK      ALRTTEXT,CALRTXT1,CALRTXT2,SP70       
              WRITE     HTMLFILE;"<td width=5% align=center>":
                        "<input type=checkbox ":
                        "name=crchr",TEMPCND1," value=1 ":
                        "id=crchr",TEMPCND1:
                        " onclick=#"if(document.AddForm.crchr":
                        TEMPCND1,".checked==true) {":
                        "document.AddForm.itemn",TEMPCND1:
                        ".value='';":
                        "ShowNotSavedAlert();":
                        "} else {":
                        "document.AddForm.itemn",TEMPCND1:
                        ".value='';":
                        "}#" ":
                        ">";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</td>"
          WRITE     HTMLFILE;"</tr></table>"
.
          WRITE     HTMLFILE;"<input type=hidden ":
                    " id=crchl",TEMPCND1:
                    " name=crchl",TEMPCND1," value=#"#" >";
.
.
          WRITE     HTMLFILE;"<input type=hidden name=uniqu",TEMPCND1:
                             " id=uniqu",TEMPCND1:
                             " value=#"",UNIQU000,"#">":
                             "<input type=hidden name=mdate",TEMPCND1:
                             " id=mdate",TEMPCND1:
                             " value=#"",MDATE000,"#">":
                             "<input type=hidden name=incty",TEMPCND1:
                             " id=incty",TEMPCND1:
                             " value=#"",INCTY000,"#">":
                             "<input type=hidden name=gstap",TEMPCND1:
                             " id=gstap",TEMPCND1:
                             " value=#"",PTMCGSTA,"#">":
                             "<input type=hidden name=gstcd",TEMPCND1:
                             " id=gstcd",TEMPCND1:
                             " value=#"",PTMCGSTC,"#">":
                             "<input type=hidden name=patpr",TEMPCND1:
                             " id=patpr",TEMPCND1:
                             " value=#"",MPATPOR,"#">":
                             "<input type=hidden name=rebpr",TEMPCND1:
                             " id=rebpr",TEMPCND1:
                             " value=#"",MHFPOR,"#">":
                             "<input type=hidden name=itemn",TEMPCND1:
                             " id=itemn",TEMPCND1,">":
                             " <input type=hidden name=descp",TEMPCND1:
                             " id=descp",TEMPCND1:
                             " value=#"",PMUFDESC,"#">":
                             "<input type=hidden name=nzdes",TEMPCND1:
                             " id=nzdes",TEMPCND1:
                             " value=#"",PMUFDESC,"#">":
                             "<input type=hidden name=qunty",TEMPCND1:
                             " id=qunty",TEMPCND1:
                             " value=#"",PMUFQUAN,"#">"
.
          GOTO      FAVTAC20
.
FAVTAC98  IF        SHOWHEAD=0
            WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1":
                             " width=100% border=1>";
            WRITE     HTMLFILE;"<tr><td colspan=6 align=center":
                               " bgcolor=#FF0000><b>":
                               "No User Group Favourites Found</b>":
                               "</td></tr></table>"
          ENDIF
.
          CALL      DTMPFV00
.
FAVTAC99  RETURN
.
.----------------------------------------------------------------------
. Get User Group Favourite Charge Items and load into the temp file
.----------------------------------------------------------------------
GFAVG000  MATCH     SP70,WBSEOCG
          IF        @EQUAL
            IF        IBCNMHOS=ONE
              PACK      KEY31,WBSEHOSP,WBSEUID,SP70
            ELSE
              PACK      KEY31,SP3,WBSEUID,SP70
            ENDIF
            CALL      RSPMUFI3
          ELSE
            IF        IBCNMHOS=ONE
              PACK      KEY31,WBSEHOSP,WBSEOCG,SP70
            ELSE
              PACK      KEY31,SP3,WBSEOCG,SP70
            ENDIF
            CALL      RSPMUFI2
          ENDIF
.
GFAVG200  MATCH     SP70,WBSEOCG
          IF        @EQUAL
            CALL      RKPMUFI3
          ELSE
            CALL      RKPMUFI2
          ENDIF
          BRANCH    OVRCD,GFAVG999
.
          IF        IBCNMHOS=ONE
            MATCH     WBSEHOSP,PMUFHOSP
            GOTO      GFAVG999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WBSEOCG
          IF        @EQUAL
            MATCH     WBSEUID,PMUFUSER
            GOTO      GFAVG999 IF NOT EQUAL
          ELSE
            MATCH     WBSEOCG,PMUFUOGR
            GOTO      GFAVG999 IF NOT EQUAL
.
            MATCH     SP70,PMUFUSER
            IF        !@EQUAL
              MATCH     WBSEUID,PMUFUSER
              GOTO      GFAVG200 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,SELCOCCG
          IF        !@EQUAL & !@EOS
            MATCH     SELCOCCG,PMUFUOGR
            GOTO      GFAVG200 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SELCFAVG
          IF        !@EQUAL & !@EOS
            MATCH     SELCFAVG,PMUFFAVG
            GOTO      GFAVG200 IF NOT EQUAL
          ENDIF
.
          MOVE      PMUFUOGR,TMUFUOGR   
          MOVE      PMUFUSER,TMUFUSER
          MOVE      PMUFHOSP,TMUFHOSP
          MOVE      PMUFFAVG,TMUFFAVG
          MOVE      PMUFFAVD,TMUFFAVD
          MOVE      PMUFGHED,TMUFGHED
          MOVE      PMUFCODE,TMUFCODE
          MOVE      PMUFQUAN,TMUFQUAN
          UNPACK    PMUFDESC,TMUFDESC,TMUFDES1
.
          MATCH     SP70,WBSEOCG
          PACK      KEY111,TMUFHOSP,TMUFUSER,TMUFFAVG,TMUFGHED:
                           TMUFUOGR,TMUFDESC,TMUFCODE,SP70            
          CALL      WRTMPFV1 
.
          GOTO      GFAVG200
.
GFAVG999  RETURN
.
.*********************************************************************
.*        Create a temp file favourite group                         *
.*********************************************************************
CTMPFV00  CALL      DTMPFV00                 * delete temp file
.
          CLEAR     DIM256
          APPEND    ISBUILD,DIM256
          APPEND    FNAMEFAV,DIM256
          APPEND    " 131 U14-16,1-3,17-19,23-25,41-120,26-34,4-13",DIM256
          APPEND    " U14-16,17-19,23-25,41-120,26-34,4-13,1-3",DIM256
          RESET     DIM256
          EXECUTE   DIM256,TASKID
          OPEN      TMPFAVK1,FNAMEFAV
          OPEN      TMPFAVK2,FNAMEFAV
.
CTMPFV99  RETURN
+
.*********************************************************************
.*        Delete temp file favourite group                           *
.*********************************************************************
DTMPFV00  CLOSE     TMPFAVK1                 * close temp file
          CLOSE     TMPFAVK2
          CLEAR     CMDLINE                  * clear command line
          PACK      CMDLINE,ISERASE,FNAMEFAV * set command line for erase
          RESET     CMDLINE                  * reset FP
          EXECUTE   CMDLINE,TASKID           * delete the temp file
.
DTMPFV99  RETURN
+
.-------------------------------------------------------------------------------
. Retrieve charge item description
.-------------------------------------------------------------------------------
CHGITD00  MOVE      ZERO,INVLDITM
          MOVE      SP70,PTMCGSTC
          MOVE      ZERO,PTMCGSTA
          MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      PMUFCODE,CHRITMDS
          MOVE      "0",ALRMESFL
.
          CALL      VDAT0000
          BRANCH    EXIT,CHGITD80
.
          PACK      KEY9,PMUFCODE,SP70
          IF        CFEETYP=FIVE
            CALL      NZPMSC00              * validate item against nzpmchaf
          ELSE
            CALL      PTMC0000              * validate item against patmchgf
          ENDIF
          GOTO      CHGITD90
.
CHGITD80  MOVE      ONE,INVLDITM
          MOVE      SP70,PTMCGSTC
          MOVE      ZERO,PTMCGSTA
          MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
.
CHGITD90  MOVE      ZERO,EXIT
CHGITD99  RETURN
+
.******************************************************************************
.         Validate Misc.charge
.******************************************************************************
PTMC0000  MOVE      SP10,PTHFBCAT           * convert "Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1                 * find correct "Table Type"
.
          MOVE      CURRDATE,KEY8
.
.         Check for miscellaneous item code
.
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,KEY9,KEY8,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      PTMC8000 IF EQUAL
.
.         No record with health fund details - try a blank health fund
.
          PACK      KEY29,ACLAIM,SP6,SP3,KEY9,KEY8,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      PTMC8000 IF EQUAL
.
.         No record with health fund details - last chance, try default claim
.
          IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,KEY8,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,KEY8,SP10
          ENDIF
.
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      PTMC8000 IF EQUAL

          MOVE      ONE,INVLDITM
          GOTO      PTMC9999
.
PTMC8000  MOVE      MDESC,CHRITMDS
          MOVE      "FI",DIM2
          PACK      KEY5,DIM2,MMSCGRP,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "1",TCINDC9
            IF        @EQUAL
              MOVE      "1",ALRMESFL
            ENDIF
          ENDIF
.
PTMC9999  RETURN
+
.******************************************************************************
.         Validate NZ Private Miscellaneous Item
.******************************************************************************
NZPMSC00  MOVE      ZERO,EXIT
          PACK      UNIQU000,UNIQU000,SP70
          PACK      MDATE000,MDATE000,SP70
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          MATCH     SP70,MDATE000
          IF        !@EQUAL
            MOVE      MDATE000,KEY8
          ENDIF
          REP       " 0",KEY8
.
          MATCH     SP70,UNIQU000
          GOTO      NZPMSC10 IF EQUAL
.
          PACK      KEY11,PVIBILL,UNIQU000,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,NZPMSC10
.
          PACK      ACLAIM,NZSPCLMN,SP70
          PACK      AFUNDH,NZSPCNTR,SP70
          PACK      AFNDTB,SP70
.
NZPMSC10  PACK      KEY29,MSHOSPID,ACLAIM,AFUNDH,AFNDTB,KEY9
          PACK      KEY37,MSHOSPID,ACLAIM,AFUNDH,AFNDTB,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC20
          GOTO      NZPMSC80
.
.         No record with health fund details - try a blank health fund
.
NZPMSC20  PACK      KEY29,MSHOSPID,ACLAIM,SP10,SP2,SP2,KEY9
          PACK      KEY37,MSHOSPID,ACLAIM,SP10,SP2,SP2,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC30
          GOTO      NZPMSC80
.
.         No record with health fund details - try default claim, blank hf
.
NZPMSC30  IF        IBCNMHOS=1
            PACK      KEY29,MSHOSPID,PTHSDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,MSHOSPID,PTHSDCLM,SP10,SP2,SP2,KEY9,KEY8
          ELSE
            PACK      KEY29,MSHOSPID,PTCNDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,MSHOSPID,PTCNDCLM,SP10,SP2,SP2,KEY9,KEY8
          ENDIF
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC40
          GOTO      NZPMSC80
.
.         No record for the hosp.- try with blank hosp,claim,hf
.
NZPMSC40  PACK      KEY29,SP3,ACLAIM,AFUNDH,AFNDTB,KEY9
          PACK      KEY37,SP3,ACLAIM,AFUNDH,AFNDTB,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC50
          GOTO      NZPMSC80
.
.         No record for the hosp.- try with blank hosp,claim,blank hf
.
NZPMSC50  PACK      KEY29,SP3,ACLAIM,SP10,SP2,SP2,KEY9
          PACK      KEY37,SP3,ACLAIM,SP10,SP2,SP2,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC60
          GOTO      NZPMSC80
.
.         No record for the hosp.- try with blank hosp,default claim,blank hf
.
NZPMSC60  IF        IBCNMHOS=1
            PACK      KEY29,SP3,PTHSDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,SP3,PTHSDCLM,SP10,SP2,SP2,KEY9,KEY8
          ELSE
            PACK      KEY29,SP3,PTCNDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,SP3,PTCNDCLM,SP10,SP2,SP2,KEY9,KEY8
          ENDIF
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC90
.
NZPMSC80  MOVE      NZMCDESC,CHRITMDS
.
          MOVE      NZMCPATP,MPATPOR
          MOVE      NZMCREBP,MHFPOR
          MOVE      NZMCGSTA,PTMCGSTA
          MOVE      NZMCGSTC,PTMCGSTC
          MOVE      ZERO,EXIT
          GOTO      NZPMSC99
.
NZPMSC90  MOVE      ONE,INVLDITM
          MOVE      ONE,EXIT
NZPMSC99  RETURN
+
.------------------------------------------------------------
.         Read NZ Misc.charge item file
.------------------------------------------------------------
RDMSC000  CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      RDMSC800 IF NOT EQUAL       * No
          ENDIF
.
RDMSC100  CALL      RPNZMCH1
          BRANCH    OVRCD,RDMSC900
.
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG
          MATCH     KEY29,KEY29A
          GOTO      RDMSC900 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      RDMSC100 IF EQUAL           * Yes
.
          MOVE      NZMCDESC,PREFDESC
.
          MATCH     NZMCEFDT,KEY8           * effective date => serv. date ?
          GOTO      RDMSC900 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     KEY8,NZMCEEDT
            GOTO      RDMSC900 IF LESS
          ENDIF
.
RDMSC800  MOVE      ZERO,EXIT
          GOTO      RDMSC999
.
RDMSC900  MOVE      ONE,EXIT
RDMSC999  RETURN
+
.------------------------------------------------------------
.         VDAT0000 - Validate the item date
.------------------------------------------------------------
VDAT0000  MOVE      ZERO,EXIT
          MOVE      SP10,DDATE
.
          MOVE      SP10,PMVXMHOS
          MOVE      SP10,PTHSDCLM
          IF        IBCNMHOS=1
            MOVE      ADMISSNO,KEY8
            CALL      RDPMVX11
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
          MOVE      PMVXMHOS,MSHOSPID
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VDAT1000
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          COMPARE   ZERO,OVRCD
          GOTO      VDAT2000 IF EQUAL
.
.         Check for Booking
.
VDAT1000  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,VDAT9000
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      VDAT9000 IF NOT EQUAL
.
          MOVE      OPDACTYP,ACLAIM
          UNPACK    SP70,AFUNDH,AFNDTB
. 
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD=0
            MOVE      OPSEHOSP,MSHOSPID
            PACK      KEY3,OPSEHOSP,SP10
            CALL      RDPTHSP1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      VDAT9999
.
VDAT2000  IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,VDAT9000
          ENDIF
.
          MATCH     SP10,DDATE
          GOTO      VDAT8000 IF EQUAL
.
          MATCH     MDATE000,DDATE
          GOTO      VDAT8000 IF NOT LESS  * Item date is before Disc.
          GOTO      VDAT9000
.
.         Commented out allowing entering items 24 hrs after Disharged date
.         as currenly items entered after discharged date will not be on the
.         invoice
.
.         COMPARE   ONE,PCEASE            * if patient is not deceased
.         GOTO      VDAT9000 IF NOT EQUAL * date must be before discharged date
.
.         Only allow entering items after 24 hrs of deceased time
.
.         UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
.         MOVE      CCENT,CC
.         MOVE      CYEAR,YY
.         MOVE      CMON,MM
.         MOVE      CDAY,DD
.         CALL      DMYCON
.         ADD       ONE,JULDAY
.         MOVE      JULDAY,JWKDAY
.         MOVE      JULYR,JWKYER
.         MOVE      JULCC,JWKCC
.         CALL      JULCON
.         PACK      KEY8,CC,YY,MM,DD
.         REP       " 0",KEY8
.         MATCH     MDATE000,KEY8
.         GOTO      VDAT9000 IF LESS     * Date must be before 24hrs after Disc.
.
VDAT8000  MATCH     ADATE,MDATE000      * Item date must be after Adm.date
          GOTO      VDAT9000 IF LESS
          MATCH     MDATE000,CDATE
          GOTO      VDAT9000 IF LESS    * Item date must be before current date
          MOVE      ZERO,EXIT
          GOTO      VDAT9999
.
VDAT9000  MOVE      ONE,EXIT
VDAT9999  RETURN
+
.******************************************************************************
.*                            Page Refresh                                    *
.******************************************************************************
RELOAD00  CALL      OPENHTML
          BRANCH    EXIT,RELOAD90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             "location.reload(); ":
                             "</script>"

          CALL      CLOSHTML
          GOTO      RELOAD99
.
RELOAD90  DISPLAY   "*** Fifo Not Found ***"
.
RELOAD99  RETURN
+
.******************************************************************************
. Get Patient Out of Theatre of Previous Patient Remote Script
.******************************************************************************
POTPRV00  PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,POTPRV91
          PACK      SESSKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
.
          PACK      KEY26,SESSKEYS,OPDACASE,DOPDASTA,SP70
          CALL      RDOPDEA5
          BRANCH    OVRCD,POTPRV91
.
POTPRV10  CALL      RPOPDEA5
          BRANCH    OVRCD,POTPRV99
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
.
          MATCH     SESSKEYS,KEY22
          GOTO      POTPRV99 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA              * skip if Cancelled booking
          GOTO      POTPRV10 IF EQUAL
.
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,POTPRV91
.
          MATCH     SP70,OPDADATE
          GOTO      POTPRV99 IF EQUAL
          MATCH     SP70,OPSGUT02
          GOTO      POTPRV99 IF EQUAL
          MATCH     SP70,OPDAADMN
          GOTO      POTPRV99 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",OPDADATE,OPSGUT02:
                             OPDAADMN,"</RETURN_VALUE>"
          GOTO      POTPRV99
.
POTPRV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Theatre Case":
                             "</RETURN_VALUE>"
          GOTO      POTPRV99
.
POTPRV99  RETURN
+
.******************************************************************************
. Print Requisitions Remote Script
.******************************************************************************
PRTREQ00  CALL      VALCAS00
          BRANCH    EXIT,PRTREQ99
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,PRTREQ91
.
          PACK      KEY36,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPREQ1
          CALL      RKOPREQ1
          BRANCH    OVRCD,PRTREQ99
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      PRTREQ99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      PRTREQ99 IF NOT EQUAL
.
          MOVE      PRGNAM,SAVKEY32
          MOVE      "Requisition Report",PRGNAM
          CALL      OPNPRINT
          CALL      OPHTMREQ
          CALL      CLSPRINT
          MOVE      SAVKEY32,PRGNAM
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"
          GOTO      PRTREQ99
.
PRTREQ91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Theatre Case":
                             "</RETURN_VALUE>"
          GOTO      PRTREQ99
.
PRTREQ99  RETURN
+
.*****************************************************************************
.         Display All requisitions for Trays
.*****************************************************************************
SHWTRY00  PACK      KEY36,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPREQ1
SHWTRY10  CALL      RKOPREQ1
          BRANCH    OVRCD,SHWTRY99
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      SHWTRY99 IF NOT EQUAL
          MATCH     TEAMNUMB,OPRQTEAM
          GOTO      SHWTRY99 IF NOT EQUAL
          MATCH     SP70,OPRQDCOD
          GOTO      SHWTRY99 IF NOT EQUAL
.
          MOVE      OPRQTYPE,ITEMTYPE
          MOVE      OPRQITEM,OPPRPREF
          MOVE      ONE,SKIPDPRF
          CALL      PRFDSC00
.
          PACK      KEY5,ANSO,ANSG,OPRQCLSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Class",TDESC
          ENDIF
.
          PACK      SAVKEY36,OPRQUNIQ,OPRQTEAM,OPRQDCOD,OPRQCLSS,OPRQTYPE:
                             OPRQITEM,SP70
.
          MOVE      ONE,SHOWHEAD
.
          MOVE      "Unknown",KEY9
          MATCH     "0",OPRQTYPE
          IF        @EQUAL
            MOVE      "Tray",KEY9
          ENDIF
          MATCH     "1",OPRQTYPE
          IF        @EQUAL
            MOVE      "Item",KEY9
          ENDIF
          MATCH     "2",OPRQTYPE
          IF        @EQUAL
            MOVE      "Equipment",KEY9
          ENDIF
.
          MOVE      TCFORM6,TEMPASSC
          RJUSTIFY  TEMPASSC
          MOVE      OPRQTYPE,TEMPTYPE
          MOVE      SAVKEY36,TEMPKY36
          MOVE      OPRQITEM,TEMPITEM
          MOVE      PREFDESC,TEMPPDSC
          MOVE      KEY9,TEMPKEY9
          MOVE      TDESC,TEMPTDSC
          MOVE      OPRQAMNT,TEMPAMNT
          RJUSTIFY  TEMPAMNT
          ADD       ONE,FORM3
          MOVE      FORM3,TEMPCONT
          MOVE      OPRQDCOD,TEMPDOCT
          MOVE      OPRQCLSS,TEMPCLSS
          MOVE      INVLDITM,TEMPVALD
.
          PACK      KEY10,TEMPASSC,TEMPTYPE,TEMPCONT,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
          GOTO      SHWTRY10
.
SHWTRY99  RETURN
+
.*****************************************************************************
.         Check Quantities for Theatre, Anaesthetic, Recovery Gases
.*****************************************************************************
CHKGAS00  MATCH     "1",OPCNPTMC
          GOTO      CHKGAS99 IF NOT EQUAL
.
          PACK      KEY15,OPDAADMN,THREE,SP70
          CALL      RSPMMTI2
CHKGAS10  CALL      RKPMMTI2
          BRANCH    OVRCD,CHKGAS99
.
          MATCH     OPDAADMN,PMMIVISN
          GOTO      CHKGAS99 IF NOT EQUAL
.
          MATCH     "3",PMMIRTYP
          GOTO      CHKGAS99 IF NOT EQUAL
.
          COMPARE   ONE,PMMISERV
          GOTO      CHKGAS10 IF NOT EQUAL
.
          MATCH     SP70,PMMIMGRP
          GOTO      CHKGAS10 IF EQUAL
.
          MOVE      "FI",CATEGORY
          MOVE      PMMIMGRP,CODE
          CALL      GETCOD00
.
          MATCH     ANSA,TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS10
.
            MATCH     SP70,OPARANAS
            GOTO      CHKGAS10 IF EQUAL
.
            MATCH     SP70,OPARANAE
            GOTO      CHKGAS10 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARANAS,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARANAE,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",PMMISERV
            ELSE
              MOVE      CALCTIME,PMMISERV
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          MATCH     ANST,TCINDC10
          IF        @EQUAL
.
            IF        CFEETYP=5
.
              PACK      KEY11,OPDAADMN,SP70
              CALL      RSNZSPR1
CHKGAS70      CALL      RKNZSPR1
              BRANCH    OVRCD,CHKGAS80
.
              MATCH     OPDAADMN,NZSPADMN
              GOTO      CHKGAS80 IF NOT EQUAL
.
              MATCH     PMMIITEM,NZSPPROC
              GOTO      CHKGAS70 IF NOT EQUAL
.
              IF        NZSPTDUR>9999
                MOVE      "9999",PMMISERV
              ELSE
                MOVE      NZSPTDUR,PMMISERV
              ENDIF
.
            ELSE
.
CHKGAS80      PACK      KEY11,OPDAUNIQ,ONE,SP70
              CALL      RDOPSRG1
              BRANCH    OVRCD,CHKGAS10
.
              MATCH     SP70,OPSGTISS
              GOTO      CHKGAS10 IF EQUAL
.
              MATCH     SP70,OPSGTISE
              GOTO      CHKGAS10 IF EQUAL
.
.             Calculate new time/amount
.
              MOVE      OPDADATE,FIRSTDAT
              UNPACK    OPSGTISS,HOUR,D1,MIN
              PACK      FIRSTIME,HOUR,MIN
              REP       " 0",FIRSTDAT
              REP       " 0",FIRSTIME
.
              MOVE      OPDADATE,LASTDATE
              REP       " 0",LASTDATE
              UNPACK    OPSGTISE,HOUR,D1,MIN
              PACK      LASTTIME,HOUR,MIN
              REP       " 0",LASTTIME
              CALL      TIMEDIFF
              IF        CALCTIME>9999
                MOVE      "9999",PMMISERV
              ELSE
                MOVE      CALCTIME,PMMISERV
              ENDIF
.
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          MATCH     "R",TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS10
.
            MATCH     SP70,OPARTIRD
            GOTO      CHKGAS10 IF EQUAL
.
            MATCH     SP70,OPARTETC
            GOTO      CHKGAS10 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARTIRD,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARTETC,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
.
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",PMMISERV
            ELSE
              MOVE      CALCTIME,PMMISERV
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          GOTO      CHKGAS10
.
CHKGAS99  RETURN
.
.*****************************************************************************
.          Find User ID Default for Category W4
.*****************************************************************************
UIW4DF00  MOVE      ZERO,EXIT
.
          MOVE      PMUFHOSP,SAVEHOSP
          MOVE      PMUFUOGR,SAVEUOGR
          MOVE      PMUFFAVG,SAVEFAVG
          MOVE      PMUFGHED,SAVEGHED
.
          PACK      SAVKEY31,PMUFHOSP,PMUFUOGR,PMUFFAVG,PMUFGHED,PMUFUSER:
                             PMUFCODE,SP70
.
          PACK      KEY31,PMUFHOSP,PMUFUOGR,PMUFFAVG,PMUFGHED,SP70
          CALL      RSPMUFI2
UIW4DF10  CALL      RKPMUFI2
          BRANCH    OVRCD,UIW4DF90
.
          MATCH     SAVEHOSP,PMUFHOSP
          GOTO      UIW4DF90 IF NOT EQUAL
.
          MATCH     SAVEUOGR,PMUFUOGR
          GOTO      UIW4DF90 IF NOT EQUAL
.
          MATCH     SAVEFAVG,PMUFFAVG
          GOTO      UIW4DF90 IF NOT EQUAL
.
          MATCH     SAVEGHED,PMUFGHED
          GOTO      UIW4DF90 IF NOT EQUAL
.
          MATCH     "Yes",PMUFFAVD
          GOTO      UIW4DF10 IF NOT EQUAL
.
          MATCH     WBSEUID,PMUFUSER
          GOTO      UIW4DF10 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          MOVE      ONE,DEFAINDC
.
UIW4DF90  MOVE      SAVKEY31,KEY31
          CALL      RDPMUFI2
.
UIW4DF99  RETURN
+
.------------------------------------------------------------
.         VDAP0000 - Validate the item date
.------------------------------------------------------------
VDAP0000  MOVE      ZERO,EXIT
          MOVE      SP10,DDATE
.
          MOVE      SP10,PMVXMHOS
          MOVE      SP10,PTHSDCLM
          IF        IBCNMHOS=1
            MOVE      ADMISSNO,KEY8
            CALL      RDPMVX11
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
          MOVE      PMVXMHOS,MSHOSPID
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VDAP1000
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          COMPARE   ZERO,OVRCD
          GOTO      VDAP2000 IF EQUAL
.
.         Check for Booking
.
VDAP1000  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,VDAP9000
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      VDAP9000 IF NOT EQUAL
.
          MOVE      OPDACTYP,ACLAIM
          UNPACK    SP70,AFUNDH,AFNDTB
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD=0
            MOVE      OPSEHOSP,MSHOSPID
            PACK      KEY3,OPSEHOSP,SP10
            CALL      RDPTHSP1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      VDAP9999
.
VDAP2000  IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,VDAP9000
          ENDIF
.
          MATCH     SP10,DDATE
          GOTO      VDAP8000 IF EQUAL
.
          MATCH     MDATE000,DDATE
          GOTO      VDAP8000 IF NOT LESS  * Item date is before Disc.
.
          COMPARE   ONE,PCEASE            * if patient is not deceased
          GOTO      VDAP9000 IF NOT EQUAL * date must be before discharged date
.
.         Only allow entering items after 24 hrs of deceased time
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      KEY8,CC,YY,MM,DD
          REP       " 0",KEY8
          MATCH     MDATE000,KEY8
          GOTO      VDAP9000 IF LESS     * Date must be before 24hrs after Disc.
.
VDAP8000
.         MATCH     ADATE,MDATE000      * Item date must be after Adm.date
.         GOTO      VDAP9000 IF LESS
.         MATCH     MDATE000,CDATE
.         GOTO      VDAP9000 IF LESS    * Item date must be before current date
          MOVE      ZERO,EXIT
          GOTO      VDAP9999
.
VDAP9000  MOVE      ONE,EXIT
VDAP9999  RETURN
+
.*****************************************************************************
.*        Create Tempfile B                                                  *
.*****************************************************************************
CRTM1000  CALL      KTM10000
.
          CLEAR     DIM100
          APPEND    "isbuild ",DIM100
          APPEND    FNAMEB,DIM100
          APPEND    " 73 U1-6,7-38,39-72",DIM100
          RESET     DIM100
          EXECUTE   DIM100,TASKID
          OPEN      TMPPRFR1,FNAMEB
.
          PACK      KEY72,SP70,SP70
          CALL      RSTMPPR1
CRTM1100  CALL      RKTMPPR1
          BRANCH    OVRCD,CRTM1999
.
          CALL      DETMPPR1
          GOTO      CRTM1100
.
CRTM1999  RETURN
.
.*****************************************************************************
.*        Kill Tempfile                                                      *
.*****************************************************************************
KTM10000  CLOSE     TMPPRFR1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEB,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KTM19999  RETURN
+
.*****************************************************************************
.*        Tempfile B I/O Subroutines                                         *
.*****************************************************************************
RATMPPR1  MOVE      ZERO,OVRCD
          RESET     KEY72
          READ      TMPPRFR1,KEY72;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPPR1  RESET     KEY72
          READ      TMPPRFR1,KEY72;;
          RETURN
.
RDTMPPR1  MOVE      ZERO,OVRCD
          RESET     KEY72
          READ      TMPPRFR1,KEY72;TEMPASS1,TEMPKY32,TEMPKY34
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMPPR1  MOVE      ZERO,OVRCD
          READKS    TMPPRFR1;TEMPASS1,TEMPKY32,TEMPKY34
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPPR1  MOVE      ZERO,OVRCD
          READKP    TMPPRFR1;TEMPASS1,TEMPKY32,TEMPKY34
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPPR1  RESET     KEY72
          WRITE     TMPPRFR1,KEY72;TEMPASS1,TEMPKY32,TEMPKY34
          RETURN
.
DETMPPR1  RESET     KEY72
          DELETE    TMPPRFR1,KEY72
          RETURN
+
.*****************************************************************************
.*        Tempfile I/O Subroutines for Favourite group                       *
.*****************************************************************************
RATMPFV1  MOVE      ZERO,OVRCD
          RESET     KEY111
          READ      TMPFAVK1,KEY111;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPFV1  RESET     KEY111
          READ      TMPFAVK1,KEY111;;
          RETURN
.
RDTMPFV1  MOVE      ZERO,OVRCD
          RESET     KEY111
          READ      TMPFAVK1,KEY111;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                                    TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                                    TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMPFV1  MOVE      ZERO,OVRCD
          READKS    TMPFAVK1;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                             TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                             TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPFV1  MOVE      ZERO,OVRCD
          READKP    TMPFAVK1;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                             TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                             TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPFV1  RESET     KEY111
          WRITE     TMPFAVK1,KEY111;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                                    TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                                    TMUFDESC,TMUFDES1
          RETURN
.
DETMPFV1  RESET     KEY111
          DELETE    TMPFAVK1,KEY111
          RETURN
.
RATMPFV2  MOVE      ZERO,OVRCD
          RESET     KEY111
          READ      TMPFAVK2,KEY111;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPFV2  RESET     KEY111
          READ      TMPFAVK2,KEY111;;
          RETURN
.
RDTMPFV2  MOVE      ZERO,OVRCD
          RESET     KEY111
          READ      TMPFAVK2,KEY111;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                                    TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                                    TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMPFV2  MOVE      ZERO,OVRCD
          READKS    TMPFAVK2;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                             TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                             TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPFV2  MOVE      ZERO,OVRCD
          READKP    TMPFAVK2;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                             TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                             TMUFDESC,TMUFDES1
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPFV2  RESET     KEY111
          WRITE     TMPFAVK2,KEY111;TMUFUOGR,TMUFUSER,TMUFHOSP,TMUFFAVG:
                                    TMUFFAVD,TMUFGHED,TMUFCODE,TMUFQUAN:
                                    TMUFDESC,TMUFDES1
          RETURN
.
DETMPFV2  RESET     KEY111
          DELETE    TMPFAVK2,KEY111
          RETURN
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
.
+
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.******************************************************************************
. FHIR Location Resource
.******************************************************************************
RESLOC00  STRIP     OPRMDESC
          CLEAR     KEY16
          APPEND    "Theatre-",KEY16
          APPEND    OPRMROOM,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": #"",OPRMDESC,"#"":
                    " } "
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      DSADD1,PRACNAME       * use hcp details
          MOVE      DSADD2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      DSADD3,PRACADD3
          MOVE      DSADD4,PRACADD4
          MOVE      DSPOST,PRACPOST
          MOVE      PTDOSEML,PRACPEML
          MOVE      DTELES,PRACPTEL
          MOVE      PTDOFAXN,PRACPFAX
          MOVE      DPROV,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,DRTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",DCODE,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",DCODE,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",DTITL,"#" ],":
                    "  #"given#": [ #"",DGNAME,"#" ],":
                    "  #"family#": #"",DSNAME,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PTDOMOBL,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.-----------------------------------------------------------------------------
. Get Comments from input comment TextArea and write them to the temporary
. file for updating to the database
.-----------------------------------------------------------------------------
GTEXDS00  COMPARE   ZERO,EXPCMTFL
          IF        @EQUAL
            PREP      EXPCMTFI,EXPCMTNM
            MOVE      ONE,EXPCMTFL
          ENDIF
.
          MOVE      "024",DIM3
          WRITE     EXPCMTFI,SEQ;"%START:",DIM3
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     EXPCMTFI,SEQ;QRYDATA
.
GTEXDS10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read file sequentially
          GOTO      GTEXDS99 IF OVER             * If end of file
.
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GTEXDS80 IF NOT EQUAL
.
          MATCH     SP70,QRYDATA
          GOTO      GTEXDS10 IF EQUAL            * Do not save blank lines
          GOTO      GTEXDS10 IF EOS              * Do not save blank lines
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     EXPCMTFI,SEQ;QRYDATA
          GOTO      GTEXDS10
.
GTEXDS80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
.
GTEXDS99  RETURN
.
.----------------------------------------------------------------------------
. Update Extend Procedure Descriptions. First delete all existing old data
. and then add the new data
.----------------------------------------------------------------------------
AUEXDS00  COMPARE   ONE,EXPCMTFL
          GOTO      AUEXDS99 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EXPCMTFI,EXPCMTNM
          TRAPCLR   IO
          BRANCH    OVRCD,AUEXDS99
.
AUEXDS10  READ      EXPCMTFI,SEQ;OPCOMLIN
          GOTO      AUEXDS99 IF OVER
.
          MATCH     "%START:",OPCOMLIN
          GOTO      AUEXDS30 IF NOT EQUAL
.
          UNPACK    OPCOMLIN,D7,OPCOMTYP
          CALL      CLEXDS00
.
          MOVE      ZERO,OPCOMCNT
          GOTO      AUEXDS10
.
AUEXDS30  MATCH     SP70,OPDDDATA
          GOTO      AUEXDS10 IF EQUAL       * Do not save blank lines
          GOTO      AUEXDS10 IF EOS         * Do not save blank lines
.
          ADD       ONE,OPCOMCNT
.
          MOVE      OPDAUNIQ,OPDDUNIQ
          MOVE      OPCOMTYP,OPDDTYPE
          MOVE      OPCOMCNT,OPDDLINE
          MOVE      OPCOMLIN,OPDDDATA
          MOVE      SP70,OPDDSPA
.
          CALL      WROPDED1
.
          GOTO      AUEXDS10
.
AUEXDS99  RETURN
.
.----------------------------------------------------------------------------
. Clear oprdedaf Comments
.----------------------------------------------------------------------------
CLEXDS00  PACK      KEY16,OPDAUNIQ,OPCOMTYP,SP70
.
          CALL      RSOPDED1
CLEXDS10  CALL      RKOPDED1
          BRANCH    OVRCD,CLEXDS99
.
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      CLEXDS99 IF NOT EQUAL
.
          MATCH     OPCOMTYP,OPDDTYPE
          GOTO      CLEXDS99 IF NOT EQUAL
.
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
.
          CALL      RSOPDED1
          GOTO      CLEXDS10
.
CLEXDS99  RETURN
+
.*******************************************************************************
          INC       AUTOATYP
          INC       CALCAGE
          INC       CLPMSPX2
          INC       CLOPRATR
          INC       CLOPRCBD
          INC       CLOPRCPI
          INC       CLOPRABI
          INC       CLOPRJRR
          INC       CLOPRDEA
          INC       CLOPRARD
          INC       CLOPRTQE
          INC       CLOPRSRG
          INC       CLOPRPMB 
          INC       CLOPRPEI  
          INC       CLOPRPIM
          INC       CLOPRTHI
          INC       CLOPRTSM
          INC       CLBOKRC1
          INC       DAYOFWEK
          INC       DGCLIITM
          INC       DGCLIS14
          INC       IBAWEBCD
          INC       NAMSTRCD
          INC       IBALPCCD
          INC       BOKRECTM
          INC       BOKRX1TM
          INC       OPRARDTM
          INC       OPRATRTM
          INC       OPRCPITM
          INC       OPRABITM
          INC       OPRCASTM
          INC       OPRJRRTM
          INC       OPRSRGTM
          INC       PATDOCTM
          INC       PATIPERH
          INC       PATMASTM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATVISTM
          INC       PATMCHRD           * Miscellaneous Charges read routine
          INC       PMIGTNID
          INC       PMSPX2TM
          INC       WEBDATCD
          INC       CLNHIMAS
          INC       OPTHCMPL           * Theatre complete (all charges posted)
          INC       CINVPEND
.
          INC       ALLCASIO/INC
          INC       ALLREFIO/INC
          INC       ALLWLNIO/INC
          INC       IBAGSTIO/INC
          INC       IBAPOLIO/INC
          INC       IBALPCIO/INC
          INC       BOKDIAIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       APSMASIO/INC
          INC       BOKRX1IO/INC
          INC       BOKRC1IO/INC
          INC       BOKUNQIO/INC
          INC       MRTMASIO/INC
          INC       OBSPCOIO/INC            * Clinic Notes table
.
          INC       OPRARDIO/INC
          INC       OPRCBDIO/INC            * Caesarean Birth Details
          INC       OPRCLIIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDEBIO/INC
          INC       OPRDECIO/INC
          INC       OPRDEDIO/INC
          INC       OPRADTIO/INC
          INC       OPRATRIO/INC
          INC       OPRCPIIO/INC
          INC       OPRABIIO/INC
          INC       OPRDPHIO/INC
          INC       OPRDPFIO/INC
          INC       OPRPCMIO/INC
          INC       OPREXPIO/INC
          INC       OPREQPIO/INC
          INC       OPRITEIO/INC
          INC       OPRJRRIO/INC
          INC       OPRNURIO/INC
          INC       OPROPRIO/INC
          INC       OPRPOCIO/INC
          INC       OPRRCIIO/INC
          INC       OPRPEIIO/INC
          INC       OPRCTYIO/INC
          INC       OPRPIMIO/INC
          INC       OPRMBSIO/INC
          INC       OPRPMBIO/INC
          INC       OPRPRFIO/INC
          INC       OPRREQIO/INC
          INC       OPRSESIO/INC
          INC       OPRSDTIO/INC
          INC       OPRSRGIO/INC
          INC       OPRTHIIO/INC
          INC       OPRTPSIO/INC
          INC       OPRTQEIO/INC
          INC       OPRTRAIO/INC
          INC       OPRTRBIO/INC
          INC       OPRTSMIO/INC
.
          INC       OUTCTYIO/INC
          INC       OUTSITIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       PATALRIO/INC
          INC       PMSCIDIO/INC            * Contract ID file
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PMSUFIIO/INC
          INC       PATDO1IO/INC
          INC       PATDDHIO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATIKIIO/INC
          INC       PATIN1IO/INC            * patient insurance table
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATNIDIO/INC
          INC       PATSGCIO/INC
          INC       PATTFEIO/INC
          INC       PATCMCIO/INC
          INC       PATCFAIO/INC
          INC       PATDGWIO/INC
          INC       PATMA1IO/INC
          INC       PATICOIO/INC
          INC       PATVADIO/INC
          INC       PATDADIO/INC
          INC       PMSCHAIO/INC
          INC       PATASFIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATMCHIO/INC            * Misc. charges table
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATRGMIO/INC
          INC       PATONHIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
.
          INC       PMSCCDIO/INC            * Concession Card Details
          INC       PMSCEXIO/INC
          INC       PMSMTIIO/INC            * Misc.theatre item table
          INC       PMSPX2IO/INC
          INC       PMSADCIO/INC
          INC       PMSOCMIO/INC
          INC       PMSPODIO/INC
          INC       PMSREGIO/INC
          INC       PATECHIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PMSVX1IO/INC
          INC       PMSPTDIO/INC
          INC       WATMESIO/INC
          INC       WATOPAIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATESEIO/INC
.         INC       SINCICIO/INC
          INC       NZPSPRIO/INC
          INC       WATLETIO/INC
          INC       FHRDATCD
          INC       FHROPRCD
          INC       WATDETTM
          INC       OPRECOVT
          INC       OPRRCITM
          INC       OPRPRFTM
          INC       OPRREQTM
          INC       OPRSESTM
          INC       OPRSDTTM
          INC       OPTHETAT
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       CLOPRRCI
          INC       CLPATDSC
          INC       CLPATMAS
          INC       CLPATMSX
          INC       CLPATMIS
          INC       CLOPRSES
          INC       CLOPRSDT
          INC       CLWATTX1
          INC       RSHWEBCD
          INC       OPPRTREQ
          INC       OPHTMREQ
          INC       PMSCURTH
          INC       PROSTRAK
          INC       CLPMSPTD
          INC       OPRAAEIO/INC
          INC       OPRAAETM
          INC       GETTFEES
          INC       PATDDHRD
          INC       PATECHRD
          INC       GETCNEFF
          INC       VALCONTR
          INC       TFILENAM
