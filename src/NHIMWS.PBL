. V10.03.01 25/02/2013  Ania P        CAR281021
.           Removed unnecessary modification of constants.
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
.           13/06/2000  Katie Nelson - Ported from 5.07
.           24/06/1999  Steve Armstrong - Added Ethnicity2 & 3 on readin NEWHCU
.           13/10/1998  Davin  507 changes
.
          INC       IBAWEBDF
.         INC       STD002FD
          INC       PATCONFD/INC
          INC       NZHISIFD/INC
          INC       PATGSRFD/INC
          INC       PATMA1FD/INC
          INC       PATMWSFD/INC
          INC       PATNHIFD/INC
          INC       PATNIDFD/INC
.         INC       PATCODFD/INC
          INC       NHIMASFD/INC
          INC       NHIDNRFD/INC
          INC       TMPALIFD/INC
.
WRITFLAG   FORM      1
NZARSEVR   DIM       1[15]    * Severity code
NZARDTON   DIM       8[15]    * Date of Onset
NZARWTXT   DIM       70[15]   * MW Text description
NZARMARC   DIM       8[15]    * MARC approval date
NZARWDTU   DIM       8[15]    * MW Date of Last Update
NZARFACC   DIM       4[15]   * Facility code
NZARDOCC   DIM       5[15]    * MW Doctor code
NZARSYSI   DIM       2[15]    * MW Coding System identifier
NZARMWCD   DIM       6[15]    * MW Code
NZARENTM   DIM       14[15]   * MW Entry Time
.
NHIALIA1   IFILE    SQL, FIXED=117, KEY="U1-7,8-10"                             
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
NHALNMPI  DIM       7      7        1     U/R Number                         
NHALLIN   DIM       3      3        9     Line Number                        
NHALSUR   DIM       25     25       12    Surname                            
NHALGV1   DIM       20     20       37    1st Given Name                     
NHALGV2   DIM       20     20       57    2nd Given Name                     
NHALGV3   DIM       20     20       77    3rd Guven Name                     
NHALPRE   DIM       1      1        97    Preferred Given Name               
NHALSPA   DIM       20     20       98    Spare                              
.End of Record                      118  
.
NHIMWSA1   IFILE    SQL, FIXED=174, KEY="U1-7,8-10"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
NHMWNMPI  DIM       7      7        1     U/R Number
NHMWLIN   DIM       3      3        8     Unique counter
NHMWCLSS  DIM       3      3        11    Severity of Warning (Cat VS)
NHMWDATE  DIM       8      8        14    Date of onset
NHMWTEXT  DIM       70     70       22    Text description
NHMWMARC  DIM       8      8        92    MARC approval date (Danger only)
NHMWHOSP  DIM       20     20       100   Facility who reported warning
NHMWDOCT  DIM       5      5        120   National Doctor code (Doctor only)
NHMWSYS   FORM      2      2        125   Coding system being used (Danger only)
NHMWCODE  DIM       9      9        127   Code for warning (danger only)
NHMWLUPD  DIM       14     14       136   Date/Time last updated CCYYMMDDHHMMSS
NHMWWDTU  DIM       8      8        150   Dat Last Updated
NHMWSPAR  DIM       16     16       150   Spare
.
.End of Record                      174  
.
CMD100    DIM       100
.. AUDTSECT  FORM      5     * Sector in Controlf
.. AUDTPOST  FORM      3     * Position in Controlf
.. AUDTFLAG  FORM      1     * On/Off Flag
.. AUDTTYPE  FORM      1     * Type 1=write 2=before change 3=after change 4=delete
.. AUDTSKEY  DIM       19    * Save Key
CONTINUE  FORM      1
NEWHCUNO  FORM      4
STARTNO   DIM       8
RECPROC   FORM      7
ERRPROC   FORM      7
ERRFLAG   FORM      1
ADDFLAG   FORM      1
SAVRESI   DIM       3
SAVETHN   DIM       3
.
NZARNMPI  DIM       7[15]    * NMPI No.
NZARSURN  DIM       25[15]   * Surname/Family name
NZARGIV1  DIM       20[15]   * Given Name 1
NZARGIV2  DIM       20[15]   * Given Name 2
NZARGIV3  DIM       20[15]   * Given Name 3
NZARPRNM  DIM       1[15]    * preferred name indicator
NZARDOB   DIM       8[15]    * Date of Birth
NZARSEX   DIM       1[15]    * Sex/Gender
.
FORM3     FORM      3
COUNT     FORM      2
DIM80     DIM       80
TMPGNAME  DIM       20
NHINUMB   DIM       8
.
DIM8      DIM       8
NMPNUMB   DIM       20
.
PRGID     INIT      "NHIMWS"
PRGNAM    INIT      "National Database Emulation"
VERSION   INIT      "V12.00.00"
.
          CALL      WEBINT00
          CALL      INIT0000
          BRANCH    OVRCD,LOOP9999
.
LOOP1000  DISPLAY   ".";
          MOVE      "1",WRLNGTH              * FIFO record length Read
          READ      NZWFIFA1;ANS;
          MATCH     NZIBSTX,ANS              * Sync at start of Message
          GOTO      LOOP1000 IF NOT EQUAL
.
          MOVE      "30",WRLNGTH              * FIFO record length Read
          READ     NZWFIFA1;NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF;
          CALL     OPENFIFO
          IF       OVRCD=1
            DISPLAY   "Can't Open Reply FIFO",*R
            GOTO      LOOP1000
          ENDIF
          SQUEEZE  NZIBACTN
          MOVE     NZIBACTN,F2
          BRANCH   F2,LOOP1100,LOOP1200,LOOP1300,LOOP1400,LOOP1500:
                      LOOP1600,LOOP1700,LOOP1800,LOOP1900,LOOP2000:
                      LOOP2100,LOOP2200,LOOP2300,LOOP2400
          DISPLAY  "Type ",NZIBACTN," - Invalid",*R
          GOTO     LOOP1000
.
LOOP1100  DISPLAY  "Type 1 - Invalid",*R
          GOTO     LOOP5000
LOOP1200  DISPLAY  "Type 2 - New HCU",*R
          CALL     NEWHCU
          GOTO     LOOP5000
LOOP1300  DISPLAY  "Type 3 - GETHCU",*R
          CALL     GETHCU
          GOTO     LOOP5000
LOOP1400  DISPLAY  "Type 4 - UPDHCU",*R
          CALL     UPDHCU
          GOTO     LOOP5000
LOOP1500  DISPLAY  "Type 5 - SRHHCU",*R
          CALL     SRHHCU
          GOTO     LOOP5000
LOOP1600  DISPLAY  "Type 6 - NXTHCU",*R
          CALL     NXTHCU
          GOTO     LOOP5000
LOOP1700  DISPLAY  "Type 7 - MRGHCU",*R
          CALL     MRGHCU
          GOTO     LOOP5000
LOOP1800  DISPLAY  "Type 8 - Invalid",*R
          GOTO     LOOP5000
LOOP1900  DISPLAY  "Type 9 - GETAKA",*R
          CALL     GETAKA
          GOTO     LOOP5000
LOOP2000  DISPLAY  "Type 10 - GETMWS",*R
          CALL     GETMWS
          GOTO     LOOP5000
LOOP2100  DISPLAY  "Type 11 - GETHCE",*R
          CALL     GETHCE
          GOTO     LOOP5000
LOOP2200  DISPLAY  "Type 12 - GETDNR",*R
          CALL     GETDNR
          GOTO     LOOP5000
LOOP2300  DISPLAY  "Type 13 - UPDMWS",*R
          CALL     UPDMWS
          GOTO     LOOP5000
LOOP2400  DISPLAY  "Type 14 - UPDDNR",*R
          CALL     UPDDNR
          GOTO     LOOP5000
.
LOOP5000  CLOSE    NZRFIFA1       * Close Read Fifo
          GOTO     LOOP1000
.
LOOP9999  STOP
.
. Open Reply FIFO
.
OPENFIFO  PACK      KEY12,NZIBRFIF,DOTPIP     * build reply FIFO
          STRIP     PTCNNHID
          PACK      FULLPATH,PTCNNHID,KEY12
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      NZRFIFA1,FULLPATH              * create reply FIFO
          TRAPCLR   IO
          RETURN
.------------------------------------------------------------
. Initialise
.------------------------------------------------------------
INIT0000  CALL      DISPHEAD
          OPEN      CONTROLF,"controlf"
          MOVE      ONE,PTCNNHII
          MOVE      "1000",NEWHCUNO
.
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      NHIDNRA1,"nhidnraf"
          OPEN      TMPALIA1,"tmpaliaf"
.
          OPEN      NHIALIA1,"nhialiaf"  * Save Files for Alias and Medical 
          OPEN      NHIMWSA1,"nhimwsaf"  * Warnings
.
          READ      CONTROLF,TWENTY1;*139,PTCNNHID,*191,PTCNNHIF
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
. open the file we want to read from
.
          STRIP     PTCNNHID
          STRIP     PTCNNHIF
          PACK      FULLPATH,PTCNNHID,PTCNNHIF,DOTPIP
          MOVE      ZERO,OVRCD                    * valid open
          TRAP      OVERCOND IF IO
          OPEN      NZWFIFA1,FULLPATH
          TRAPCLR   IO
          RETURN
.
. Allocate New Patient Number
.
NEWHCU    MOVE     "624",WRLNGTH              * FIFO record length Read
          READ     NZWFIFA1;NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3:
                   NZIBPRNM,NZIBADD1:
                   NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBPANO,NZIBDOB:
                   NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                   NZIBSEX,NZIBACNT:
                   NZIBALSR[1],NZIBALG1[1],NZIBALG2[1],NZIBALG3[1],NZIBALPN[1]:
                   NZIBALSR[2],NZIBALG1[2],NZIBALG2[2],NZIBALG3[2],NZIBALPN[2]:
                   NZIBALSR[3],NZIBALG1[3],NZIBALG2[3],NZIBALG3[3],NZIBALPN[3]:
                   NZIBALSR[4],NZIBALG1[4],NZIBALG2[4],NZIBALG3[4],NZIBALPN[4]:
                   NZIBSCRB,NZIBDUPL,NZIBUPDT;
.
NEWHCU10  
 DISPLAY  *P1:24,*EL,"NZIBCTRY:",NZIBCTRY;

          MATCH     "TEMP",NZIBCTRY
          GOTO      NEWHCU20 IF EQUAL
.
          MATCH     "DUPLICATE",NZIBSURN
          GOTO      NEWHCU30 IF EQUAL
.
 DISPLAY  *P1:24,*EL,"NEW HCU ID ";
          ADD       "10",NEWHCUNO
          MOVE      "KKK",KEY3
          PACK      KEY7,KEY3,NEWHCUNO
          REP       " 0",KEY7
 DISPLAY  *P1:24,*EL,"KEY7NEWHCUNO:",KEY7;
          CALL      RDNHMAS1
          COMPARE   ZERO,OVRCD
          GOTO      NEWHCU10 IF EQUAL
.
 DISPLAY  *P1:24,*EL,"read master ovrcd:",OVRCD;
          PACK      NZIBERRD,KEY7,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "362",RDLNGTH                 * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                    KEY7,NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                    NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                    NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                    NZIBSEX;
          GOTO      NWHCU999
.
NEWHCU20  MOVE      "NHI OFFLINE TEST",NZIBERRD
          MOVE      "2034",NZIBERRN
          MOVE      "AE",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          GOTO      NWHCU999
.
NEWHCU30  MOVE      "DUPLICATE",NZIBERRD
          MOVE      "2099",NZIBERRN
          MOVE      "AE",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          GOTO      NWHCU999
.
NWHCU999  RETURN
.************************************************************************
.*  UPDHCU  :  Update National database with details from local system  *
.************************************************************************
UPDHCU    MOVE      "280",WRLNGTH                 * FIFO record length (write)
          READ     NZWFIFA1;NZIBNMPI:
                          NZIBNMCF,NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX,NZIBSCRB,NZIBDUPL,NZIBUPDT;
.
          MATCH     "ERROR",NZIBGIV1   * Simulate Error on Donor Update
          GOTO      UPDHCU90 IF EQUAL
.
          SQUEEZE   NZIBNMCF
          MOVE      NZIBNMCF,F3
          BRANCH    F3,UPDHCU10,UPDHCU20,UPDHCU30,UPDHCU40
.
. Update with add to alias
.
UPDHCU10  PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "362",RDLNGTH                 * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMPI:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX;
          GOTO      UPDHCU99
.
. Update with NO Add to alias
.
UPDHCU20  PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "362",RDLNGTH                 * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMPI:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX;
          GOTO      UPDHCU99
.
. Remove Alias
.
UPDHCU30  CALL      REMALI00
          PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "362",RDLNGTH                 * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMPI:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX;
          GOTO      UPDHCU99
.
. Add Alias
.
UPDHCU40  CALL      ADDALI00
          PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "362",RDLNGTH                 * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMPI:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                          NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                          NZIBSEX;
          GOTO      UPDHCU99
.
. Simulate Error on Update
.
UPDHCU90  MOVE      "ERROR POSTING HCU DETAILS - BATCHED",NZIBERRD
          MOVE      "2034",NZIBERRN
          MOVE      "AE",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          GOTO      UPDHCU99
.
UPDHCU99  RETURN
.************************************************************************
.*  MRGHCU  :  Inform the NHI of the merger of two national numbers     *
.************************************************************************
MRGHCU    MOVE      "14",WRLNGTH
          READ      NZWFIFA1;NZIBNMPI,NZIBALNO;
.
          PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
.
          RETURN
+
.******************************************************************************
.*  UPDDNR  :  Update the Donor and Contact details for a patient on Nat. Sys *
.******************************************************************************
UPDDNR    MOVE      "311",WRLNGTH                 * FIFO record length (write)
          READ      NZWFIFA1;NZIBNMPI,NZIBUACT,NZIBSTSU:
                             NZIBPCSN,NZIBPCG1,NZIBPCG2,NZIBPCG3,NZIBPRNM:
                             NZIBPCA1,NZIBPCA2,NZIBPCSB,NZIBPCTW,NZIBPCCT:
                             NZIBRELC,NZIBWKPH,NZIBAHPH;
.
          MATCH     "ERROR",NZIBPCG1   * Simulate Error on Donor Update
          GOTO      UPDDNR10 IF EQUAL
.
          PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          GOTO      UPDDNR99
.
UPDDNR10  MOVE      "ERROR POSTING DONOR DETAILS - BATCHED",NZIBERRD
          MOVE      "2034",NZIBERRN
          MOVE      "AE",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          GOTO      UPDDNR99
.
UPDDNR99  RETURN
+
.****************************************************************************
.*  UPDWMS  :  Update the Medical Warning details for a patient on Nat. Sys *
.****************************************************************************
UPDMWS    MOVE      "126",WRLNGTH                 * FIFO record length (write)
          READ      NZWFIFA1;NZIBNMPI,NZIBUACT,NZIBSEVR:
                             NZIBDTON,NZIBWTXT,NZIBMARC,NZIBFACC:
                             NZIBDOCC,NZIBSYSI,NZIBMWCD,NZIBENTM;
.
          MATCH     "C",NZIBUACT
          GOTO      UPDMWS10 IF EQUAL
          MATCH     "M",NZIBUACT
          GOTO      UPDMWS20 IF EQUAL
          MATCH     "D",NZIBUACT
          GOTO      UPDMWS30 IF EQUAL
          DISPLAY   "INCORRECT TYPE FOUND IN UPDMWS.",*R
          GOTO      UPDMWS50
.
UPDMWS10  CALL      ADDMWS00
          GOTO      UPDMWS50
.
UPDMWS20  CALL      MODMWS00
          GOTO      UPDMWS50
.
UPDMWS30  CALL      REMMWS00
          GOTO      UPDMWS50
.
UPDMWS50  PACK      NZIBERRD,SP70
          PACK      NZIBERRN,SP70
          MOVE      "AA",NZIBAPPC                 * valid read?
          MOVE      "86",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD;
          RETURN
.
.************************************************************************
.*  GETHCU  :  Get the PMI details for a NHI Number                     *
.************************************************************************
GETHCU    MOVE     "7",WRLNGTH                  * FIFO record length (write)
          READ     NZWFIFA1;NZIBNMPI;
.
          CALL     CHKSCH00
          BRANCH   EXIT,GETHCU05
.
          MATCH    "$",NZIBNMPI       * Old Temporary Number
          GOTO     GETHCU95 IF EQUAL  * Should Not be triggered
          MATCH    "T-",NZIBNMPI       * New Temporary Number
          GOTO     GETHCU95 IF EQUAL
.
          PACK     KEY8,SP1,NZIBNMPI,SP70
          CALL     RDMAST1
          MOVE     NZIBNMPI,KEY7
          CALL     RDNHMAS1
          IF       OVRCD=1
            CALL     CHKOVR00
            BRANCH   EXIT,GETHCU90
          ENDIF
.
GETHCU05  CALL     MVNHI000
.
          MOVE     "N",NZIBMERG
          MOVE     SP70,NZIBALID
.
          MOVE     "N",NZIBMWDN     * Donor Flag
          MOVE     NZIBNMPI,KEY7
          CALL     RDNHDNR1
          IF       OVRCD=0
            MOVE     "Y",NZIBMWDN
          ENDIF
.
          MOVE     SP70,NZIBMWST    * Medical Warnings Flag
          PACK     KEY10,NZIBNMPI,SP70
          CALL     RSNHMW1
          CALL     RKNHMW1
          BRANCH   OVRCD,GETHCU10
          MATCH    NZIBNMPI,NHMWNMPI
          GOTO     GETHCU10 IF NOT EQUAL
          MOVE     "Y",NZIBMWST
.
GETHCU10  MOVE     SP70,NZIBALNM     * Alias Flag
          PACK     KEY10,NHMANMPI,SP70
          CALL     RSNHAL1
          CALL     RKNHAL1
          BRANCH   OVRCD,GETHCU20
          MATCH    NHMANMPI,NHALNMPI
          GOTO     GETHCU20 IF NOT EQUAL
          MOVE     "Y",NZIBALNM
.
GETHCU20  PACK     NZIBERRD,SP70
          PACK     NZIBERRN,SP70
          MOVE     "20",NZIBETH2
          MOVE     "AA",NZIBAPPC                 * valid read?
          MOVE     "374",RDLNGTH                * FIFO record length (reply)
          WRITE    NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                           NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                           NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                           NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBETH2:
                           NZIBETH3,NZIBSEX,NZIBALNM,NZIBMWDN,NZIBMWST:
                           NZIBMERG,NZIBALID,NZIBLAST;
          GOTO     GETHCU99
.
GETHCU90  CALL     CLNHI000
          MOVE     "2034",NZIBERRN
          MOVE     "HCU ID NOT FOUND",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE     "362",RDLNGTH                * FIFO record length (reply)
          WRITE    NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                           NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                           NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                           NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBSEX:
                           NZIBALNM,NZIBMWDN,NZIBMWST,NZIBMERG,NZIBALID;
          GOTO     GETHCU99
.
GETHCU95  CALL     CLNHI000
          MOVE     "2034",NZIBERRN
          MOVE     "Temporary HCU ID NOT FOUND",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE     "362",RDLNGTH                * FIFO record length (reply)
          WRITE    NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                           NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM:
                           NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY,NZIBDOB:
                           NZIBDDTH,NZIBDOMC,NZIBRESI,NZIBETHN,NZIBSEX:
                           NZIBALNM,NZIBMWDN,NZIBMWST,NZIBMERG,NZIBALID;
.
GETHCU99  RETURN
.
MVNHI000  MOVE     PSNAME,NZIBSURN
          MOVE     PGNAME,NZIBGIV1
          MOVE     NHMAGIV2,NZIBGIV2
          MOVE     NHMAGIV3,NZIBGIV3
          MOVE     NHMAPREI,NZIBPRNM
          MOVE     NHMAADD1,NZIBADD1
          MOVE     NHMAADD2,NZIBADD2
          MOVE     NHMAADD3,NZIBSUBR
          MOVE     NHMAADD4,NZIBCITY
          MOVE     NHMAADD5,NZIBCTRY
          MOVE     NHMADOB,NZIBDOB
          MOVE     NHMADDTH,NZIBDDTH
          MOVE     NHMADOMC,NZIBDOMC
          MOVE     NHMARES,NZIBRESI
          MOVE     NHMAETH,NZIBETHN
          MOVE     NHMAETH2,NZIBETH2
          MOVE     NHMAETH3,NZIBETH3
          MOVE     NHMASEX,NZIBSEX
          MOVE     NHMADAT,NZIBLAST
          RETURN
.
CLNHI000  MOVE     SP70,NZIBSURN
          MOVE     SP70,NZIBGIV1
          MOVE     SP70,NZIBGIV2
          MOVE     SP70,NZIBGIV3
          MOVE     SP70,NZIBPRNM
          MOVE     SP70,NZIBADD1
          MOVE     SP70,NZIBADD2
          MOVE     SP70,NZIBSUBR
          MOVE     SP70,NZIBCITY
          MOVE     SP70,NZIBCTRY
          MOVE     SP70,NZIBDOB
          MOVE     SP70,NZIBDDTH
          MOVE     SP70,NZIBDOMC
          MOVE     SP70,NZIBRESI
          MOVE     SP70,NZIBETHN
          MOVE     SP70,NZIBSEX
          RETURN
.************************************************************************
.*  CHKSCH00 Simulate selection for National System
.************************************************************************
CHKSCH00  MOVE     ONE,EXIT
          MATCH    "ABC12",NZIBNMPI
          GOTO     CHKSCH10 IF EQUAL
          MATCH    "ABC12",NZIBNMPI
          GOTO     CHKSCH20 IF EQUAL
          MATCH    "LLU12",NZIBNMPI
          GOTO     CHKSCH30 IF EQUAL
          MATCH    "HHU43",NZIBNMPI
          GOTO     CHKSCH40 IF EQUAL
          MATCH    "JKG43",NZIBNMPI
          GOTO     CHKSCH50 IF EQUAL
          GOTO     CHKSCH90
.
CHKSCH10  MOVE     "JJJ1140",KEY7
          CALL     RDNHMAS1
          BRANCH   OVRCD,CHKSCH90
          GOTO     CHKSCH80
.
CHKSCH20  MOVE     "JJJ1150",KEY7
          CALL     RDNHMAS1
          BRANCH   OVRCD,CHKSCH90
          GOTO     CHKSCH80
.
CHKSCH30  MOVE     "JJJ1160",KEY7
          CALL     RDNHMAS1
          BRANCH   OVRCD,CHKSCH90
          GOTO     CHKSCH80
.
CHKSCH40  MOVE     "JJJ1170",KEY7
          CALL     RDNHMAS1
          BRANCH   OVRCD,CHKSCH90
          GOTO     CHKSCH80
.
CHKSCH50  MOVE     "JJJ1180",KEY7
          CALL     RDNHMAS1
          BRANCH   OVRCD,CHKSCH90
          GOTO     CHKSCH80
.
CHKSCH80  GOTO     CHKSCH99
.
CHKSCH90  MOVE     ZERO,EXIT
.
CHKSCH99  RETURN
.************************************************************************
.*  GETHCE  :  Get list of visits on National database for an NHI Number*
.************************************************************************
GETHCE    MOVE      "31",WRLNGTH                  * FIFO record length (write)
          READ      NZWFIFA1;NZIBNMPI,NZIBCPTR,NZIBMXRP;
.
.
. now get the reply (firstly checking for an error)
.
          MOVE      "AA",NZIBAPPC               * valid read?
          MOVE      "1000",NZIBERRN
          MOVE      SP70,NZIBERRD
.
          MOVE      "  4",NZIBNMWF
          MOVE      " 4",NZIBNMWR
          MOVE      SP70,NZIBCPTR
.
          MOVE      "114",RDLNGTH
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBMRGS,NZIBNMWF:
                             NZIBNMWR,NZIBCPTR;
.
          MOVE      "106",RDLNGTH
          MOVE      "19990601",NZARSTDT[1]
          MOVE      "19990604",NZARENDT[1]:
          MOVE      "Test Event Description Event 1",NZAREVND[1]
          MOVE      "Test Facility 1",NZARRPTF[1];
          WRITE     NZRFIFA1;NZARSTDT[1],NZARENDT[1]:
                             NZAREVND[1],NZARRPTF[1];
.
.
          MOVE      "106",RDLNGTH
          MOVE      "19990701",NZARSTDT[1]
          MOVE      "19990704",NZARENDT[1]:
          MOVE      "Test Event Description Event 2",NZAREVND[1]
          MOVE      "Test Facility 2",NZARRPTF[1];
          WRITE     NZRFIFA1;NZARSTDT[1],NZARENDT[1]:
                             NZAREVND[1],NZARRPTF[1];
.
.
          MOVE      "106",RDLNGTH
          MOVE      "19990801",NZARSTDT[1]
          MOVE      "19990804",NZARENDT[1]:
          MOVE      "Test Event Description Event 3",NZAREVND[1]
          MOVE      "Test Facility 3",NZARRPTF[1];
          WRITE     NZRFIFA1;NZARSTDT[1],NZARENDT[1]:
                             NZAREVND[1],NZARRPTF[1];
.
.
          MOVE      "106",RDLNGTH
          MOVE      "19990901",NZARSTDT[1]
          MOVE      "19990904",NZARENDT[1]:
          MOVE      "Test Event Description Event 4",NZAREVND[1]
          MOVE      "Test Facility 4",NZARRPTF[1];
          WRITE     NZRFIFA1;NZARSTDT[1],NZARENDT[1]:
                             NZAREVND[1],NZARRPTF[1];
.
.
GTHCE999  RETURN
.*****************************************************************************
.*  GETDNR  :  Get the Donor and Contact details for a patient from Nat. Sys *
.*****************************************************************************
GETDNR    MOVE      "7",WRLNGTH                  * FIFO record length (write)
          READ      NZWFIFA1;NZIBNMPI;
.
          MOVE     NZIBNMPI,KEY7
          CALL     RDNHDNR1
          BRANCH   OVRCD,GETDNR90
.
          CALL     MVDNR000
. 
          PACK     NZIBERRD,SP70
          PACK     NZIBERRN,SP70
          MOVE     "AA",NZIBAPPC                 * valid read?
          MOVE      "397",RDLNGTH                  * FIFO record length (reply)
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                    NZIBSTSU,NZIBPCSN,NZIBPCG1,NZIBPCG2,NZIBPCG3:
                    NZIBPRNM,NZIBPCA1,NZIBPCA2,NZIBPCSB,NZIBPCTW,NZIBPCCT:
                    NZIBWKPH,NZIBAHPH,NZIBRELC,NZIBDTLU;
          GOTO     GETDNR99
.
GETDNR90  CALL     CLDNR000
          MOVE     "2034",NZIBERRN
          MOVE     "HCU ID DNR NOT FOUND",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE      "397",RDLNGTH                  * FIFO record length (reply)
          WRITE    NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD:
                   NZIBSTSU,NZIBPCSN,NZIBPCG1,NZIBPCG2,NZIBPCG3:
                   NZIBPRNM,NZIBPCA1,NZIBPCA2,NZIBPCSB,NZIBPCTW,NZIBPCCT:
                   NZIBWKPH,NZIBAHPH,NZIBRELC,NZIBDTLU;
.
GETDNR99  RETURN
.
MVDNR000  MOVE      NHDNDONR,NZIBSTSU
          MOVE      NHDNCNSU,NZIBPCSN
          MOVE      NHDNCNG1,NZIBPCG1
          MOVE      NHDNCNG2,NZIBPCG2
          MOVE      NHDNCNG3,NZIBPCG3
          MOVE      NHDNCNPI,NZIBPRNM
          MOVE      NHDNCNA1,NZIBPCA1
          MOVE      NHDNCNA2,NZIBPCA2
          MOVE      NHDNCNA3,NZIBPCSB
          MOVE      NHDNCNA4,NZIBPCTW
          MOVE      NHDNCNA5,NZIBPCCT
          MOVE      NHDNCREL,NZIBRELC
          MOVE      NHDNCWPH,NZIBWKPH
          MOVE      NHDNCAPH,NZIBAHPH
          MOVE      NHDNDAT,NZIBDTLU
          RETURN
.
CLDNR000  MOVE      SP70,NZIBSTSU
          MOVE      SP70,NZIBPCSN
          MOVE      SP70,NZIBPCG1
          MOVE      SP70,NZIBPCG2
          MOVE      SP70,NZIBPCG3
          MOVE      SP70,NZIBPRNM
          MOVE      SP70,NZIBPCA1
          MOVE      SP70,NZIBPCA2
          MOVE      SP70,NZIBPCSB
          MOVE      SP70,NZIBPCTW
          MOVE      SP70,NZIBPCCT
          MOVE      SP70,NZIBRELC
          MOVE      SP70,NZIBWKPH
          MOVE      SP70,NZIBAHPH
          MOVE      SP70,NZIBDTLU
          RETURN
.
NXTHCU
          RETURN
.
SRHHCU    MOVE      "263",WRLNGTH                 * FIFO record length (write)
          READ      NZWFIFA1;NZIBSTYP,NZIBSTIM,NZIBRLIM:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM,NZIBNSTY:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY:
                          NZIBASTY,NZIBMGEN,NZIBMDOB,NZIBMAGE,NZIBMPAG;
.         
          MOVE      "000",NZIBNMRP
          MOVE      "116",RDLNGTH                * FIFO record length (reply)
          MOVE      "AA",NZIBAPPC               * valid read?
          MOVE      "1000",NZIBERRN
          MOVE      SP70,NZIBERRD
.
          MOVE      "6",NZIBNMRP
          MOVE      "6",NZIBNMFN
          MOVE      ZERO,NZIBNMRE
.
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMFN:
                             NZIBNMRE,NZIBNMRP,NZIBCPTR;
.
          MOVE      ZERO,WRITFLAG
          CALL      SPATA000
          CALL      SPATB000
          CALL      SPATC000
          CALL      SPATD000
          CALL      SPATE000
          CALL      SPATF000
          RETURN
.
..... added hard coded values here 
.
SPATA000  MOVE      ONE,NZIBCNT
          MOVE      "JJJ2090",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "ELIZABETH",NZIBGIV1
          MOVE      "SARAH",NZIBGIV2
          MOVE      "1",NZIBPRNM  
          MOVE      "8 TADEMA CRESENT",NZIBADD1
          MOVE      "         ",NZIBADD2  
          MOVE      "ELTHAM",NZIBSUBR  
          MOVE      "         ",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19610606",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "3338",NZIBDOMC   
          MOVE      "M",NZIBSEX
          CALL      WRPAT000
          RETURN
.
SPATB000  MOVE      ONE,NZIBCNT
          MOVE      " 456369",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "SUE",NZIBGIV1
          MOVE      "LYN",NZIBGIV2
          MOVE      "1",NZIBPRNM  
          MOVE      "29 SOUTH RD",NZIBADD1
          MOVE      "         ",NZIBADD2  
          MOVE      "MENTONE",NZIBSUBR  
          MOVE      "         ",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19760823",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "6769",NZIBDOMC   
          MOVE      "F",NZIBSEX
          CALL      WRPAT000
          RETURN
.
SPATC000  MOVE      ONE,NZIBCNT
          MOVE      "KKK1060",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "TAMMY",NZIBGIV1
          MOVE      "JOANNE",NZIBGIV2
          MOVE      "    ",NZIBGIV3
          MOVE      "1",NZIBPRNM  
          MOVE      "3 MOWBRAY CRES",NZIBADD1
          MOVE      "     ",NZIBADD2  
          MOVE      "MELTON SOUTH",NZIBSUBR  
          MOVE      "MELBOURNE",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19970513",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "6923",NZIBDOMC   
          MOVE      "M",NZIBSEX
          CALL      WRPAT000
          RETURN
.
SPATD000  MOVE      ONE,NZIBCNT
          MOVE      "JKJ2349",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "TRACEY",NZIBGIV1
          MOVE      "JANE",NZIBGIV2
          MOVE      "MARY",NZIBGIV3
          MOVE      "1",NZIBPRNM  
          MOVE      "FLAT 24",NZIBADD1
          MOVE      "124 MAIN RD",NZIBADD2  
          MOVE      "BOX HILL",NZIBSUBR  
          MOVE      "         ",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19780210",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "6923",NZIBDOMC   
          MOVE      "F",NZIBSEX
          CALL      WRPAT000
          RETURN
.
SPATE000  MOVE      ONE,NZIBCNT
          MOVE      "PKS5425",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "WENDY",NZIBGIV1
          MOVE      "SUSAN",NZIBGIV2
          MOVE      "     ",NZIBGIV3
          MOVE      "1",NZIBPRNM  
          MOVE      "FLAT 14",NZIBADD1
          MOVE      "124 NORTH RD",NZIBADD2  
          MOVE      "MILL PARK",NZIBSUBR  
          MOVE      "         ",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19750320",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "3674",NZIBDOMC   
          MOVE      "F",NZIBSEX
          CALL      WRPAT000
          RETURN
.
SPATF000  MOVE      ONE,NZIBCNT
          MOVE      "HYS2465",NZIBNMPI
          MOVE      "JOHNSON",NZIBSURN
          MOVE      "WILLMA",NZIBGIV1
          MOVE      "PETA",NZIBGIV2
          MOVE      "     ",NZIBGIV3
          MOVE      "1",NZIBPRNM  
          MOVE      "198 JUNE ST",NZIBADD1
          MOVE      "            ",NZIBADD2  
          MOVE      "SOUTH PARK",NZIBSUBR  
          MOVE      "         ",NZIBCITY  
          MOVE      "AUSTRALIA",NZIBCTRY   
          MOVE      "19720330",NZIBDOB
          MOVE      "        ",NZIBDDTH   
          MOVE      "4234",NZIBDOMC   
          MOVE      "F",NZIBSEX
          CALL      WRPAT000
          RETURN
.
WRPAT000  MOVE      "1",NZIBRESI   
          MOVE      "10",NZIBETHN   
          MOVE      "20",NZIBETH2   
          MOVE      " ",NZIBETH3   
          MOVE      "N",NZIBALNM   
          MOVE      "N",NZIBMWDN   
          MOVE      " ",NZIBMWST   
          MOVE      "N",NZIBMERG   
          IF        WRITFLAG=0
            MOVE      "280",RDLNGTH                * FIFO record length (reply)
            WRITE     NZRFIFA1;NZIBNMPI,NZIBSURN:
                               NZIBGIV1,NZIBGIV2:
                               NZIBGIV3,NZIBPRNM:
                               NZIBADD1,NZIBADD2:
                               NZIBSUBR,NZIBCITY:
                               NZIBCTRY,NZIBDOB:
                               NZIBDDTH,NZIBDOMC:
                               NZIBRESI,NZIBETHN,NZIBETH2,NZIBETH3:
                               NZIBSEX,NZIBALNM:
                               NZIBMWDN,NZIBMWST:
                               NZIBMERG;
          ENDIF
          RETURN
.------------------------------------
. Alias
.------------------------------------
GETAKA    MOVE      "31",WRLNGTH
          READ      NZWFIFA1;NZIBNMPI,NZIBCPTR,NZIBMXRP;
.
          PACK      KEY7,NZIBNMPI
          CALL      RDNHMAS1
          BRANCH    OVRCD,GETAKA95
.
          MOVE      ZERO,CONTINUE    * Continuation Pointer 1=Yes
          UNPACK    NZIBCPTR,KEY1,KEY10,KEY3
          MOVE      KEY1,CONTINUE    * Continuation Pointer 1=Yes
          MOVE      ZERO,F3
.
          BRANCH    CONTINUE,GETAKA05
          PACK      KEY10,NZIBNMPI,SP20
GETAKA05  CALL      RSNHAL1
GETAKA10  CALL      RKNHAL1              * Determine Number of Alias Remaining
          BRANCH    OVRCD,GETAKA20
          MATCH     NZIBNMPI,NHALNMPI
          GOTO      GETAKA20 IF NOT EQUAL
          ADD       ONE,F3
          IF        F3=15
            PACK      KEY10,NHALNMPI,NHALLIN
          ENDIF
          IF        F3<16
            MOVE      NHALSUR,NZARSURN[F3]  * Save First 15 Found
            MOVE      NHALGV1,NZARGIV1[F3]
            MOVE      NHALGV2,NZARGIV2[F3]
            MOVE      NHALGV3,NZARGIV3[F3]
            MOVE      NHALPRE,NZARPRNM[F3]
          ENDIF
          GOTO      GETAKA10
.
GETAKA20  COMPARE   ZERO,F3              * No Alias Remaining
          GOTO      GETAKA90 IF EQUAL
.
          IF        CONTINUE=0
            MOVE      F3,NZIBNMFN        * Not a Continue so count = total
          ELSE
            UNPACK    NZIBCPTR,KEY1,KEY11,KEY3
            MOVE      KEY3,NZIBNMFN      * A Continue so count = Count Passed
          ENDIF
.
          IF        F3>15
            ASSIGN    F3-15,FORM3
            MOVE      FORM3,NZIBNMRE        * Remaining
            MOVE      "15",NZIBNARP        * This Message
            PACK      NZIBCPTR,ONE,KEY10,NZIBNMFN,SP70  * Continuation Pointer
          ELSE
            MOVE      SP70,NZIBCPTR
            MOVE      F3,F2
            MOVE      F2,NZIBNARP
            MOVE      ZERO,F3
            MOVE      F3,NZIBNMRE
          ENDIF
          MOVE      "AA",NZIBAPPC               * valid read?
          MOVE      "1000",NZIBERRN
          MOVE      SP70,NZIBERRD
          MOVE      "116",RDLNGTH
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMFN,NZIBNMRE:
                             NZIBNARP,NZIBCPTR;
.
          MOVE      "86",RDLNGTH
          MOVE      ONE,NZIBCNT
          SQUEEZE   NZIBNARP
          MOVE      NZIBNARP,FORM3
          WHILE     NZIBCNT <= FORM3
            WRITE     NZRFIFA1;NZARSURN[NZIBCNT],NZARGIV1[NZIBCNT]:
                               NZARGIV2[NZIBCNT],NZARGIV3[NZIBCNT]:
                               NZARPRNM[NZIBCNT];
            ADD       ONE,NZIBCNT
          DO
.
          GOTO      GETAKA99
.
GETAKA90  MOVE     "2034",NZIBERRN
          MOVE     "NO ALIAS ON FILE",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE      "116",RDLNGTH
          MOVE      SP70,NZIBNMFN
          MOVE      SP70,NZIBNMRE
          MOVE      SP70,NZIBNARP
          MOVE      SP70,NZIBCPTR
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMFN,NZIBNMRE:
                             NZIBNARP,NZIBCPTR;
          GOTO      GETAKA99
.
.
GETAKA95  MOVE     "2034",NZIBERRN
          MOVE     "HCU ID NOT FOUND",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE      "116",RDLNGTH
          MOVE      SP70,NZIBNMFN
          MOVE      SP70,NZIBNMRE
          MOVE      SP70,NZIBNARP
          MOVE      SP70,NZIBCPTR
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBNMFN,NZIBNMRE:
                             NZIBNARP,NZIBCPTR;
.
GETAKA99  RETURN
.
ADDALI00  MOVE      ZERO,F3
          PACK      KEY10,NZIBNMPI,Z70
          CALL      RSNHAL1
          CALL      RPNHAL1
          BRANCH    OVRCD,ADDALI10
          MATCH     NZIBNMPI,NHALNMPI
          GOTO      ADDALI10 IF NOT EQUAL
          MOVE      NHALLIN,F3
ADDALI10  ADD       ONE,F3
          MOVE      NZIBNMPI,NHALNMPI
          MOVE      F3,NHALLIN
          PACK      KEY10,NHALNMPI,NHALLIN
          MOVE      NZIBSURN,NHALSUR
          MOVE      NZIBGIV1,NHALGV1
          MOVE      NZIBGIV2,NHALGV2
          MOVE      NZIBGIV3,NHALGV3
          MOVE      NZIBPRNM,NHALPRE
          CALL      RANHAL1
          COMPARE   ZERO,OVRCD
          GOTO      ADDALI10 IF EQUAL
          CALL      WRNHAL1
          RETURN
.
REMALI00  PACK      KEY10,NZIBNMPI,SP70
          CALL      RSNHAL1
REMALI10  CALL      RKNHAL1
          BRANCH    OVRCD,REMALI99
          MATCH     NZIBNMPI,NHALNMPI
          GOTO      REMALI99 IF NOT EQUAL
.
          MATCH     NZIBSURN,NHALSUR
          GOTO      REMALI10 IF NOT EQUAL
          MATCH     NZIBGIV1,NHALGV1
          GOTO      REMALI10 IF NOT EQUAL
          MATCH     NZIBGIV2,NHALGV2
          GOTO      REMALI10 IF NOT EQUAL
          MATCH     NZIBGIV3,NHALGV3
          GOTO      REMALI10 IF NOT EQUAL
          MATCH     NZIBPRNM,NHALPRE
          GOTO      REMALI10 IF NOT EQUAL
          PACK      KEY10,NHALNMPI,NHALLIN
          CALL      DENHAL1
          GOTO      REMALI10
.
REMALI99  RETURN
.
          INC       IBAWEBCD
.         INC       STD001IO
          INC       PATMA1IO/INC
.         INC       PATCODIO/INC
          INC       PATMWSIO/INC
          INC       PATNIDIO/INC
          INC       PATNHIIO/INC
          INC       PATGSRIO/INC
          INC       NHIMASIO/INC
          INC       NHIDNRIO/INC
          INC       TMPALIIO/INC
.
. NHIALIIO    
. --------
. Filename     : NHIaliaf.dat
.
RSNHAL1   RESET     KEY10                                                       
          READ      NHIALIA1,KEY10;;                                            
          RETURN
.
RANHAL1   RESET     KEY10                                                       
          MOVE      ZERO,OVRCD
          READ      NHIALIA1,KEY10;ANS                                          
          GOTO      OVERCOND IF OVER
          RETURN
.
RDNHAL1   RESET     KEY10                                                       
          MOVE      ZERO,OVRCD
          READ      NHIALIA1,KEY10;NHALNMPI,NHALLIN,NHALSUR,NHALGV1,NHALGV2:    
                        NHALGV3,NHALPRE,NHALSPA                                 
          GOTO      OVERCOND IF OVER
          RETURN
.
RKNHAL1                                                                         
          MOVE      ZERO,OVRCD
          READKS    NHIALIA1;NHALNMPI,NHALLIN,NHALSUR,NHALGV1,NHALGV2:          
                        NHALGV3,NHALPRE,NHALSPA                                 
          GOTO      OVERCOND IF OVER
          RETURN
.
RPNHAL1                                                                         
          MOVE      ZERO,OVRCD
          READKP    NHIALIA1;NHALNMPI,NHALLIN,NHALSUR,NHALGV1,NHALGV2:          
                        NHALGV3,NHALPRE,NHALSPA                                 
          GOTO      OVERCOND IF OVER
          RETURN
.
UPNHAL1                                                                         
          UPDATE    NHIALIA1;NHALNMPI,NHALLIN,NHALSUR,NHALGV1,NHALGV2:          
                        NHALGV3,NHALPRE,NHALSPA                                 
          RETURN
.
WRNHAL1   RESET     KEY10                                                       
          WRITE     NHIALIA1,KEY10;NHALNMPI,NHALLIN,NHALSUR,NHALGV1,NHALGV2:    
                        NHALGV3,NHALPRE,NHALSPA                                 
          RETURN
.
DENHAL1   RESET     KEY10                                                       
          DELETE    NHIALIA1,KEY10                                              
          RETURN
.
. Include   :  NHIMWSIO.INC
.
. File      :  NHIMWSaf.dat
. Keys      :  KEY10
.
RSNHMW1   RESET     KEY10
          READ      NHIMWSA1,KEY10;;
          RETURN
.
RANHMW1   RESET     KEY10
          MOVE      ZERO,OVRCD
          READ      NHIMWSA1,KEY10;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDNHMW1   RESET     KEY10
          MOVE      ZERO,OVRCD
          READ      NHIMWSA1,KEY10;NHMWNMPI,NHMWLIN,NHMWCLSS,NHMWDATE:
                                  NHMWTEXT,NHMWMARC,NHMWHOSP,NHMWDOCT,NHMWSYS:
                                  NHMWCODE,NHMWLUPD,NHMWWDTU,NHMWSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKNHMW1   MOVE      ZERO,OVRCD
          READKS    NHIMWSA1;NHMWNMPI,NHMWLIN,NHMWCLSS,NHMWDATE:
                                  NHMWTEXT,NHMWMARC,NHMWHOSP,NHMWDOCT,NHMWSYS:
                                  NHMWCODE,NHMWLUPD,NHMWWDTU,NHMWSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RPNHMW1   MOVE      ZERO,OVRCD
          READKP    NHIMWSA1;NHMWNMPI,NHMWLIN,NHMWCLSS,NHMWDATE:
                                  NHMWTEXT,NHMWMARC,NHMWHOSP,NHMWDOCT,NHMWSYS:
                                  NHMWCODE,NHMWLUPD,NHMWWDTU,NHMWSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
UPNHMW1   UPDATE    NHIMWSA1;NHMWNMPI,NHMWLIN,NHMWCLSS,NHMWDATE:
                                  NHMWTEXT,NHMWMARC,NHMWHOSP,NHMWDOCT,NHMWSYS:
                                  NHMWCODE,NHMWLUPD,NHMWWDTU,NHMWSPAR
          RETURN
.
WRNHMW1   RESET     KEY10
          WRITE     NHIMWSA1,KEY10;NHMWNMPI,NHMWLIN,NHMWCLSS,NHMWDATE:
                                  NHMWTEXT,NHMWMARC,NHMWHOSP,NHMWDOCT,NHMWSYS:
                                  NHMWCODE,NHMWLUPD,NHMWWDTU,NHMWSPAR
          RETURN
.
DENHMW1   RESET     KEY10
          DELETE    NHIMWSA1,KEY10
          RETURN
.
ADDMWS00  MOVE      ZERO,F3
          PACK      KEY10,NZIBNMPI,Z70
          CALL      RSNHMW1
          CALL      RPNHMW1
          BRANCH    OVRCD,ADDMWS10
          MATCH     NZIBNMPI,NHMWNMPI
          GOTO      ADDMWS10 IF NOT EQUAL
          MOVE      NHMWLIN,F3
ADDMWS10  ADD       ONE,F3
          MOVE      NZIBNMPI,NHMWNMPI
          MOVE      F3,NHMWLIN
          PACK      KEY10,NHMWNMPI,NHMWLIN
.
          MOVE      NZIBSEVR,NHMWCLSS
          MOVE      NZIBDTON,NHMWDATE
          MOVE      NZIBWTXT,NHMWTEXT
          MOVE      NZIBMARC,NHMWMARC
          MOVE      NZIBFACC,NHMWHOSP
          MOVE      NZIBDOCC,NHMWDOCT
          MOVE      NZIBSYSI,NHMWSYS
          MOVE      NZIBMWCD,NHMWCODE
.
          CALL      IBACLOCK
          CLOCK     TIME,KEY6
          PACK      NHMWLUPD,CCC,CYY,CMM,CDD,KEY6
          PACK      NHMWWDTU,CCC,CYY,CMM,CDD
.
          CALL      RANHMW1
          COMPARE   ZERO,OVRCD
          GOTO      ADDMWS10 IF EQUAL
          CALL      WRNHMW1
          RETURN
.
MODMWS00  PACK      KEY10,NZIBNMPI,SP70
          CALL      RSNHMW1
MODMWS10  CALL      RKNHMW1
          BRANCH    OVRCD,MODMWS99
          MATCH     NZIBNMPI,NHMWNMPI
          GOTO      MODMWS99 IF NOT EQUAL
.
          MATCH     NZIBENTM,NHMWLUPD
          GOTO      MODMWS10 IF NOT EQUAL
.
          MOVE      NZIBSEVR,NHMWCLSS
          MOVE      NZIBDTON,NHMWDATE
          MOVE      NZIBWTXT,NHMWTEXT
          MOVE      NZIBMARC,NHMWMARC
          MOVE      NZIBFACC,NHMWHOSP
          MOVE      NZIBDOCC,NHMWDOCT
          MOVE      NZIBSYSI,NHMWSYS
          MOVE      NZIBMWCD,NHMWCODE
          CALL      IBACLOCK
          PACK      NHMWWDTU,CCC,CYY,CMM,CDD
.
          CALL      UPNHMW1
.
MODMWS99  RETURN
.
REMMWS00  PACK      KEY10,NZIBNMPI,SP70
          CALL      RSNHMW1
REMMWS10  CALL      RKNHMW1
          BRANCH    OVRCD,REMMWS99
          MATCH     NZIBNMPI,NHMWNMPI
          GOTO      REMMWS99 IF NOT EQUAL
.
          MATCH     NZIBENTM,NHMWLUPD
          GOTO      REMMWS10 IF NOT EQUAL
.
          PACK      KEY10,NHMWNMPI,NHMWLIN
          CALL      DENHMW1
.
REMMWS99  RETURN
.
.------------------------------------
. Medical Warnings
.------------------------------------
GETMWS    MOVE      "31",WRLNGTH
          READ      NZWFIFA1;NZIBNMPI,NZIBCPTR,NZIBMXRP;
.
          PACK      KEY7,NZIBNMPI
          CALL      RDNHMAS1
          BRANCH    OVRCD,GETMWS95
.
          MOVE      ZERO,CONTINUE    * Continuation Pointer 1=Yes
          UNPACK    NZIBCPTR,KEY1,KEY10,KEY3
          MOVE      KEY1,CONTINUE    * Continuation Pointer 1=Yes
.
          MOVE      ZERO,F3
          BRANCH    CONTINUE,GETMWS05
          PACK      KEY10,NZIBNMPI,SP20
.
GETMWS05  CALL      RSNHMW1
GETMWS10  CALL      RKNHMW1              * Determine Number of Alias Remaining
          BRANCH    OVRCD,GETMWS20
          MATCH     NZIBNMPI,NHMWNMPI
          GOTO      GETMWS20 IF NOT EQUAL
          ADD       ONE,F3
          IF        F3=15
            PACK      KEY10,NHMWNMPI,NHMWLIN
          ENDIF
          IF        F3<16
            MOVE      NHMWCLSS,NZARSEVR[F3]
            MOVE      NHMWDATE,NZARDTON[F3]
            MOVE      NHMWTEXT,NZARWTXT[F3]
            MOVE      NHMWMARC,NZARMARC[F3]
            MOVE      NHMWWDTU,NZARWDTU[F3]
            MOVE      NHMWHOSP,NZARFACC[F3]
            MOVE      NHMWDOCT,NZARDOCC[F3]
            MOVE      NHMWSYS,NZARSYSI[F3]
            MOVE      NHMWCODE,NZARMWCD[F3]
            MOVE      NHMWLUPD,NZARENTM[F3]
          ENDIF
          GOTO      GETMWS10
.
GETMWS20  COMPARE   ZERO,F3              * No Alias Remaining
          GOTO      GETMWS90 IF EQUAL
.
          IF        CONTINUE=0
            MOVE      F3,NZIBNMWF        * Not a Continue so count = total
          ELSE
            UNPACK    NZIBCPTR,KEY1,KEY11,NZIBNMWF
          ENDIF
.
          IF        F3>15
            MOVE      "15",NZIBNMWR        * This Message
            PACK      NZIBCPTR,ONE,KEY10,NZIBNMWF,SP70  * Continuation Pointer
          ELSE
            MOVE      SP70,NZIBCPTR
            MOVE      F3,F2
            MOVE      F2,NZIBNMWR
          ENDIF
.
          MOVE      "AA",NZIBAPPC               * valid read?
          MOVE      "1000",NZIBERRN
          MOVE      SP70,NZIBERRD
.
          MOVE      "115",RDLNGTH
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBMWDN:
                             NZIBMRGS,NZIBNMWF,NZIBNMWR,NZIBCPTR;
.
          MOVE      ONE,NZIBCNT
          SQUEEZE   NZIBNMWR
          MOVE      NZIBNMWR,FORM2
          MOVE      "126",RDLNGTH
          WHILE     NZIBCNT <= FORM2
            WRITE     NZRFIFA1;NZARSEVR[NZIBCNT],NZARDTON[NZIBCNT]:
                               NZARWTXT[NZIBCNT],NZARMARC[NZIBCNT]:
                               NZARWDTU[NZIBCNT],NZARFACC[NZIBCNT]:
                               NZARDOCC[NZIBCNT],NZARSYSI[NZIBCNT]:
                               NZARMWCD[NZIBCNT],NZARENTM[NZIBCNT];
            ADD       ONE,NZIBCNT
          DO
          GOTO      GETMWS99
.
GETMWS90  MOVE     "2034",NZIBERRN
          MOVE     "NO ALIAS ON FILE",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE      SP70,NZIBNMWR
          MOVE      SP70,NZIBNMWF
          MOVE      SP70,NZIBCPTR
          MOVE      SP70,NZIBMRGS
          MOVE      SP70,NZIBMWDN
          MOVE      "115",RDLNGTH
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBMWDN:
                             NZIBMRGS,NZIBNMWF,NZIBNMWR,NZIBCPTR;
          GOTO      GETMWS99
.
.
GETMWS95  MOVE     "2034",NZIBERRN
          MOVE     "HCU ID NOT FOUND",NZIBERRD
          MOVE     "AE",NZIBAPPC                 * valid read?
          MOVE      SP70,NZIBNMWR
          MOVE      SP70,NZIBNMWF
          MOVE      SP70,NZIBCPTR
          MOVE      SP70,NZIBMRGS
          MOVE      SP70,NZIBMWDN
          MOVE      "115",RDLNGTH
          WRITE     NZRFIFA1;NZIBAPPC,NZIBERRN,NZIBERRD,NZIBMWDN:
                             NZIBMRGS,NZIBNMWF,NZIBNMWR,NZIBCPTR;
.
          GOTO      GETMWS99
GETMWS99  RETURN
.---------------------------------------------------------------------------
. Need to send back valid records for patients without HCU on Local System
.---------------------------------------------------------------------------
CHKOVR00  
          MATCH     "JJJ2090",KEY7
          GOTO      CHKOVR90 IF EQUAL
          MATCH     "AVH6969",KEY7
          GOTO      CHKOVR91 IF EQUAL
          MATCH     "JKJ2349",KEY7
          GOTO      CHKOVR92 IF EQUAL
          MATCH     "PKS5425",KEY7
          GOTO      CHKOVR93 IF EQUAL
          MATCH     "HYS2465",KEY7
          GOTO      CHKOVR94 IF EQUAL
.
          MATCH     "JBA",KEY7
          GOTO      CHKOVR95 IF NOT EQUAL
.
CHKOVR10  PACK      KEY8,SP1,KEY7
          CALL      RDMAST1
          BRANCH    OVRCD,CHKOVR95
.
          MOVE      PSNAME,NHMASURN
          MOVE      PGNAME,NHMAGIV1
          MOVE      SP70,NHMAGIV2
          MOVE      SP70,NHMAGIV3
.
. now get the address into the NZ address fields
.
          MOVE      PADD1,NHMAADD1
          MOVE      SP30,NHMAADD2
          MOVE      PADD2,NHMAADD3
          MOVE      PSUBRB,NHMAADD4
          MOVE      SP30,NHMAADD5
          MOVE      SP7,NZIBPANO
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      NHMADOB,CCENT,CYEAR,CMON,CDAY
          REP       " 0",NHMADOB
.
          MOVE      PDECDTE,NHMADDTH
          MOVE      PPOST,NHMADOMC
          MOVE      PSEX,NHMASEX
          MOVE      "1",NHMAPREI
          MOVE      ZERO,EXIT
          GOTO      CHKOVR99
.
CHKOVR90  MOVE      ONE,WRITFLAG
          CALL      SPATA000
          CALL      MVMAS000
          GOTO      CHKOVR99
.
CHKOVR91  MOVE      ONE,WRITFLAG
          CALL      SPATB000
          CALL      MVMAS000
          GOTO      CHKOVR99
.
CHKOVR92  MOVE      ONE,WRITFLAG
          CALL      SPATD000
          CALL      MVMAS000
          GOTO      CHKOVR99
.
CHKOVR93  MOVE      ONE,WRITFLAG
          CALL      SPATE000
          CALL      MVMAS000
          GOTO      CHKOVR99
.
CHKOVR94  MOVE      ONE,WRITFLAG
          CALL      SPATF000
          CALL      MVMAS000
          GOTO      CHKOVR99
.         
CHKOVR95  MOVE      ONE,EXIT
.
CHKOVR99  RETURN
.
MVMAS000  MOVE     NZIBSURN,NHMASURN
          MOVE     NZIBGIV1,NHMAGIV1
          MOVE     NZIBGIV2,NHMAGIV2
          MOVE     NZIBGIV3,NHMAGIV3
          MOVE     NZIBPRNM,NHMAPREI
          MOVE     NZIBADD1,NHMAADD1
          MOVE     NZIBADD2,NHMAADD2
          MOVE     NZIBSUBR,NHMAADD3
          MOVE     NZIBCITY,NHMAADD4
          MOVE     NZIBCTRY,NHMAADD5
          MOVE     NZIBDOB,NHMADOB
          MOVE     NZIBDDTH,NHMADDTH
          MOVE     NZIBDOMC,NHMADOMC
          MOVE     NZIBRESI,NHMARES
          MOVE     NZIBETHN,NHMAETH
          MOVE     NZIBETH2,NHMAETH2
          MOVE     NZIBETH3,NHMAETH3
          MOVE     NZIBSEX,NHMASEX
          MOVE     NZIBLAST,NHMADAT
          RETURN
.
.---------------------------------------------------------------
. Clear Parameters (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
CLRPAR00  RETURN
.---------------------------------------------------------------
. Set Parameters   (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
SETPAR00  RETURN
.---------------------------------------------------------------
. Process Fields   (NOT USED REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
PROFLD00  RETURN
