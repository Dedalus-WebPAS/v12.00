. *----------------------------------------------------------------------
. * Include Name  :   PMSHPGTM.PBL
. *
. * Function      :   Tags for PMSHPGFD - pmshpgaf.dat
. *----------------------------------------------------------------------
.  Modifications Done :
.
.  V10.03.02  23/11/2012  Jill Parkinson CAR 275193
.             Added update of PMUGSDAT with ADATE if adate is earlier
.  V10.03.01  03/05/2012  Jill Parkinson CAR 257615
.             Changed WIPG0000 to always write to pmsupgaf if pmshpgaf match
.  V10.00.02  08/06/2010  Ebon Clements CAR 207040
.             Fixed health fund test in write of new IP and OP programs
.  V10.00.01  21/05/2010  Ebon Clements CAR 207040
.             Fixed write of new IP and OP programs to ur
.  V9.12.00   18/02/2010  Ebon Clements CAR 207040
.             Created include
. *----------------------------------------------------------------------
.------------------------------------------------------------
. Program Management
.------------------------------------------------------------
PMHP0000  BRANCH    FLDITMNO,PMHP0100,PMHP0200,PMHP0300,PMHP0400,PMHP0500:
                             PMHP0600,PMHP0700,PMHP0800,PMHP0900,PMHP1000:
                             PMHP1100,PMHP1200,PMHP1300,PMHP1400,PMHP1500:
                             PMHP1600
          GOTO      PMHP9999
.
PMHP0100  MOVE      "A ",CATEGORY
          MOVE      PMHPATYP,CODE
          CALL      CODITM00
          GOTO      PMHP9999
.
PMHP0200  MOVE      "CL",CATEGORY
          MOVE      PMHPCLAM,CODE
          CALL      CODITM00
          GOTO      PMHP9999
.
PMHP0300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMHP0310
          WRITE     HTMLFILE;PMHPFUND;
          GOTO      PMHP9999
.
PMHP0310  PACK      KEY14,PMHPFUND,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;PMHPFUND;
          ENDIF
          GOTO      PMHP9999
.
PMHP0400  MOVE      "HT",CATEGORY
          MOVE      PMHPTABT,CODE
          CALL      CODITM00
          GOTO      PMHP9999
.
PMHP0500  MATCH     PMHPEDAT,SP70
          GOTO      PMHP9999 IF EQUAL
.
          UNPACK    PMHPEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMHP9999
.
PMHP0600  WRITE     HTMLFILE;PMHPMAXI;
          GOTO      PMHP9999
.
PMHP0700  WRITE     HTMLFILE;PMHPWARI;
          GOTO      PMHP9999
.
PMHP0800  WRITE     HTMLFILE;PMHPMAXO;
          GOTO      PMHP9999
.
PMHP0900  WRITE     HTMLFILE;PMHPWARO;
          GOTO      PMHP9999
.
PMHP1000  WRITE     HTMLFILE;PMHPBRKO;
          GOTO      PMHP9999
.
PMHP1100  MATCH     PMHPCDAT,SP70
          GOTO      PMHP9999 IF EQUAL
.
          UNPACK    PMHPCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMHP9999
.
PMHP1200  WRITE     HTMLFILE;PMHPCTIM;
          GOTO      PMHP9999
.
PMHP1300  MATCH     SP70,PMHPCUID
          GOTO      PMHP9999 IF EQUAL
.
          PACK      KEY10,PMHPCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMHPCUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMHP9999
.
PMHP1400  MATCH     PMHPUDAT,SP70
          GOTO      PMHP9999 IF EQUAL
.
          UNPACK    PMHPUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMHP9999
.
PMHP1500  WRITE     HTMLFILE;PMHPUTIM;
          GOTO      PMHP9999
.
PMHP1600  MATCH     SP70,PMHPUUID
          GOTO      PMHP9999 IF EQUAL
.
          PACK      KEY10,PMHPUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMHPUUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PMHP9999
.
PMHP9999  RETURN
.
.******************************************************************************
. Write a health fund progam to a patient for an outpatient visit
.******************************************************************************
WOPG0000  COMPARE   ONE,ADDNEWPG                 * Add new program cgi
          GOTO      WOPG9999 IF NOT EQUAL 
.
. Check U/R for a valid program with a matching admission type and claim code
. with a blank health fund and table type.
.
. Check for an program with no expiry date
.
          PACK      KEY31,OBAURNO,OBACLASS,OBACOMP,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      WOPG9999
          ENDIF
.
. Check for a program with an expiry date
.
          PACK      KEY31,OBAURNO,OBACLASS,OBACOMP,SP9:
                          OBADATE,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      WOPG9999
          ENDIF
          CALL      RKPMUPG1
          BRANCH    OVRCD,WOPG0500
.
          MATCH     OBAURNO,PMUGURNO
          GOTO      WOPG0500 IF NOT EQUAL
.
          MATCH     OBACLASS,PMUGATYP
          GOTO      WOPG0500 IF NOT EQUAL
.
          MATCH     OBACOMP,PMUGCLAM
          GOTO      WOPG0500 IF NOT EQUAL
.
          MATCH     SP70,PMUGFUND
          GOTO      WOPG0500 IF NOT EQUAL
.
          MATCH     SP70,PMUGTABT
          GOTO      WOPG0500 IF NOT EQUAL
.
          GOTO      WOPG9999               * Valid program found
.
WOPG0500  MATCH     SP70,OTBBFUND
          IF        @EQUAL
            PACK      KEY14,PFUNDH,PFNDTB,SP70
          ELSE
            PACK      KEY14,OTBBFUND,OTBBTBLE,SP70
          ENDIF
.
          CALL      RDFUND1
          BRANCH    OVRCD,WOPG0900
.
. Check U/R for a valid program with a matching admission type, health fund and
. table type with a blank claim code
.
. Check for an program with no expiry date
.
          PACK      KEY31,OBAURNO,OBACLASS,SP3,HCODE,PTHFBCAT,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      WOPG9999
          ENDIF
.
. Check for a program with an expiry date
.
          PACK      KEY31,OBAURNO,OBACLASS,SP3,HCODE,PTHFBCAT:
                          OBADATE,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            GOTO      WOPG9999
          ENDIF
          CALL      RKPMUPG1
          BRANCH    OVRCD,WOPG0900
.
          MATCH     OBAURNO,PMUGURNO
          GOTO      WOPG0900 IF NOT EQUAL
.
          MATCH     OBACLASS,PMUGATYP
          GOTO      WOPG0900 IF NOT EQUAL
.
          MATCH     SP3,PMUGCLAM
          GOTO      WOPG0900 IF NOT EQUAL
.
          MATCH     HCODE,PMUGFUND
          GOTO      WOPG0900 IF NOT EQUAL
.
          MATCH     PTHFBCAT,PMUGTABT
          GOTO      WOPG0900 IF NOT EQUAL
.
          GOTO      WOPG9999               * Valid program found
.
. No valid program exists for this U/R 
. Check for a valid program with a matching admission type and claim code
. with a blank health fund and table type.
.
WOPG0900  PACK      KEY23,OBACLASS,OBACOMP,SP9,OBADATE,SP70
          CALL      RDPMHPG1
          IF        OVRCD<>1
            GOTO      WOPG6000
          ENDIF
WOPG1000  CALL      RPPMHPG1
          BRANCH    OVRCD,WOPG2000
.
          MATCH     OBACLASS,PMHPATYP
          GOTO      WOPG2000 IF NOT EQUAL
.
          MATCH     OBACOMP,PMHPCLAM
          GOTO      WOPG2000 IF NOT EQUAL
.
          MATCH     SP70,PMHPFUND
          GOTO      WOPG2000 IF NOT EQUAL
.
          MATCH     SP70,PMHPTABT
          GOTO      WOPG2000 IF NOT EQUAL
.
          GOTO      WOPG6000                * Valid program found
.
WOPG2000  MATCH     SP70,OTBBFUND
          IF        @EQUAL
            PACK      KEY14,PFUNDH,PFNDTB,SP70
          ELSE
            PACK      KEY14,OTBBFUND,OTBBTBLE,SP70
          ENDIF
.
          CALL      RDFUND1
          BRANCH    OVRCD,WOPG9999
.
          PACK      KEY23,OBACLASS,SP3,HCODE,PTHFBCAT,OBADATE,SP70
          CALL      RDPMHPG1
          IF        OVRCD<>1
            GOTO      WOPG6000
          ENDIF
WOPG3000  CALL      RPPMHPG1
          BRANCH    OVRCD,WOPG9999
.
          MATCH     OBACLASS,PMHPATYP
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     SP70,PMHPCLAM
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     HCODE,PMHPFUND
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     PTHFBCAT,PMHPTABT
          GOTO      WOPG9999 IF NOT EQUAL
.
WOPG6000  CALL      CLPMSUPG           * Valid program found so write to U/R
.
          MOVE      OBAURNO,PMUGURNO
          MOVE      PMHPATYP,PMUGATYP
          MOVE      PMHPCLAM,PMUGCLAM
          MOVE      PMHPFUND,PMUGFUND
          MOVE      PMHPTABT,PMUGTABT
          MOVE      PMHPMAXI,PMUGMAXI
          MOVE      PMHPWARI,PMUGWARI
          MOVE      PMHPMAXO,PMUGMAXO
          MOVE      PMHPWARO,PMUGWARO
          MOVE      OBADATE,PMUGSDAT
          MOVE      PMHPBRKO,PMUGBRKO
.
          PACK      PMUGCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUGCDAT
          CLOCK     TIME,PMUGCTIM
          MOVE      USERID,PMUGCUID
.
          PACK      KEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RAPMUPG1
          IF        OVRCD=1
            CALL     WRPMUPG1
          ENDIF
.
          MATCH     "1",PMHPBRKO            * Breakdown OP Visits
          GOTO      WOPG9999 IF NOT EQUAL
.
          PACK      KEY26,PMHPATYP,PMHPCLAM,PMHPFUND,PMHPTABT,PMHPEDAT,SP70
          CALL      RSPMHPO1
WOPG7000  CALL      RKPMHPO1
          BRANCH    OVRCD,WOPG9999
.
          MATCH     PMHPATYP,PMHOATYP
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     PMHPCLAM,PMHOCLAM
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     PMHPFUND,PMHOFUND
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     PMHPTABT,PMHOTABT
          GOTO      WOPG9999 IF NOT EQUAL
.
          MATCH     PMHPEDAT,PMHOEDAT
          GOTO      WOPG9999 IF NOT EQUAL
.
          CALL      CLPMSUPO
.
          MOVE      OBAURNO,PMUOURNO
          MOVE      PMHOATYP,PMUOATYP
          MOVE      PMHOCLAM,PMUOCLAM
          MOVE      PMHOFUND,PMUOFUND
          MOVE      PMHOTABT,PMUOTABT
          MOVE      PMHOVTYP,PMUOVTYP
          MOVE      PMHOMAXO,PMUOMAXO
          MOVE      PMHOWARO,PMUOWARO
.
          PACK      PMUOCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUOCDAT
          CLOCK     TIME,PMUOCTIM
          MOVE      USERID,PMUOCUID
.
          PACK      KEY34,PMUOURNO,PMUOATYP,PMUOCLAM,PMUOFUND,PMUOTABT,PMUOEDAT:
                          PMUOVTYP,SP70
          CALL      RAPMUPO1
          IF        OVRCD=1
            CALL      WRPMUPO1
          ENDIF
          GOTO      WOPG7000
.
WOPG9999  RETURN
.
.******************************************************************************
. Write a health fund progam to a patient for an IP visit
.******************************************************************************
. Check U/R for a valid program with a matching admission type and claim code
. with a blank health fund and table type.
.
. Check for an program with no expiry date
.
WIPG0000  MOVE      ZERO,F1
          BRANCH    NOPROGRM,WIPG9999     * program tables don't exist
.
          PACK      KEY31,AURNO,ATYPE,ACLAIM,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            MOVE      ONE,F1      * valid program already exists
            MATCH     PMUGSDAT,ADATE
            IF        @LESS
              PACK      PMUGSDAT,ADATE,SP70
              CALL      UPPMUPG1
              GOTO      WIPG9999
            ENDIF
          ENDIF
.
. Check for a program with an expiry date
.
          PACK      KEY31,AURNO,ATYPE,ACLAIM,SP9:
                          ADATE,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            MOVE      ONE,F1      * valid program already exists
            GOTO      WIPG9999
          ENDIF
          CALL      RKPMUPG1
          BRANCH    OVRCD,WIPG0500
.
          MATCH     AURNO,PMUGURNO
          GOTO      WIPG0500 IF NOT EQUAL
.
          MATCH     ATYPE,PMUGATYP
          GOTO      WIPG0500 IF NOT EQUAL
.
          MATCH     ACLAIM,PMUGCLAM
          GOTO      WIPG0500 IF NOT EQUAL
.
          MATCH     SP70,PMUGFUND
          GOTO      WIPG0500 IF NOT EQUAL
.
          MATCH     SP70,PMUGTABT
          GOTO      WIPG0500 IF NOT EQUAL
.
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            MATCH     ADATE,PMUGEDAT
            GOTO      WIPG0500 IF LESS
          ENDIF
          MOVE      ONE,F1      * valid program already exists

          GOTO      WIPG9999               * Valid program found
.
WIPG0500  PACK      KEY14,AFUNDH,AFNDTB,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,WIPG0900
.
. Check U/R for a valid program with a matching admission type, health fund and
. table type with a blank claim code
.
. Check for an program with no expiry date
.
          PACK      KEY31,AURNO,ATYPE,SP3,HCODE,PTHFBCAT,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            MOVE      ONE,F1      * valid program already exists
            MATCH     PMUGSDAT,ADATE
            IF        @LESS
              PACK      PMUGSDAT,ADATE,SP70
              CALL      UPPMUPG1
              GOTO      WIPG9999
            ENDIF
          ENDIF
.
. Check for a program with an expiry date
.
          PACK      KEY31,AURNO,ATYPE,SP3,HCODE,PTHFBCAT:
                          ADATE,SP70
          CALL      RDPMUPG1
          IF        OVRCD<>1
            MOVE      ONE,F1      * valid program already exists
            GOTO      WIPG9999
          ENDIF
          CALL      RKPMUPG1
          BRANCH    OVRCD,WIPG0900
.
          MATCH     AURNO,PMUGURNO
          GOTO      WIPG0900 IF NOT EQUAL
.
          MATCH     ATYPE,PMUGATYP
          GOTO      WIPG0900 IF NOT EQUAL
.
          MATCH     SP3,PMUGCLAM
          GOTO      WIPG0900 IF NOT EQUAL
.
          MATCH     HCODE,PMUGFUND
          GOTO      WIPG0900 IF NOT EQUAL
.
          MATCH     PTHFBCAT,PMUGTABT
          GOTO      WIPG0900 IF NOT EQUAL
.
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            MATCH     ADATE,PMUGEDAT
            GOTO      WIPG0900 IF LESS
          ENDIF
          MOVE      ONE,F1      * valid program already exists
          GOTO      WIPG9999               * Valid program found
.
. No valid program exists for this U/R 
. Check for a valid program with a matching admission type and claim code
. with a blank health fund and table type.
.
WIPG0900  PACK      KEY23,ATYPE,ACLAIM,SP9,ADATE,SP70
          CALL      RDPMHPG1
          IF        OVRCD<>1
            GOTO      WIPG6000
          ENDIF
WIPG1000  CALL      RPPMHPG1
          BRANCH    OVRCD,WIPG2000
.
          MATCH     ATYPE,PMHPATYP
          GOTO      WIPG2000 IF NOT EQUAL
.
          MATCH     ACLAIM,PMHPCLAM
          GOTO      WIPG2000 IF NOT EQUAL
.
          MATCH     SP70,PMHPFUND
          GOTO      WIPG2000 IF NOT EQUAL
.
          MATCH     SP70,PMHPTABT
          GOTO      WIPG2000 IF NOT EQUAL
.
          GOTO      WIPG6000                * Valid program found
.
WIPG2000  PACK      KEY14,AFUNDH,AFNDTB,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,WIPG9800
.
          PACK      KEY23,ATYPE,SP3,HCODE,PTHFBCAT,ADATE,SP70
          CALL      RDPMHPG1
          IF        OVRCD<>1
            GOTO      WIPG6000
          ENDIF
WIPG3000  CALL      RPPMHPG1
          BRANCH    OVRCD,WIPG9800
.
          MATCH     ATYPE,PMHPATYP
          GOTO      WIPG9800 IF NOT EQUAL
.
          MATCH     SP70,PMHPCLAM
          GOTO      WIPG9800 IF NOT EQUAL
.
          MATCH     HCODE,PMHPFUND
          GOTO      WIPG9800 IF NOT EQUAL
.
          MATCH     PTHFBCAT,PMHPTABT
          GOTO      WIPG9800 IF NOT EQUAL
.
WIPG6000  CALL      CLPMSUPG           * Valid program found so write to U/R
.
          MOVE      AURNO,PMUGURNO
          MOVE      PMHPATYP,PMUGATYP
          MOVE      PMHPCLAM,PMUGCLAM
          MOVE      PMHPFUND,PMUGFUND
          MOVE      PMHPTABT,PMUGTABT
          MOVE      PMHPMAXI,PMUGMAXI
          MOVE      PMHPWARI,PMUGWARI
          MOVE      PMHPMAXO,PMUGMAXO
          MOVE      PMHPWARO,PMUGWARO
          MOVE      ADATE,PMUGSDAT
          MOVE      PMHPBRKO,PMUGBRKO
.
          PACK      PMUGCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUGCDAT
          CLOCK     TIME,PMUGCTIM
          MOVE      USERID,PMUGCUID
.
          PACK      KEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RAPMUPG1
          IF        OVRCD=1
            MOVE     ZERO,F1
            CALL     WRPMUPG1
          ENDIF
.
          MATCH     "1",PMHPBRKO            * Breakdown OP Visits
          GOTO      WIPG9999 IF NOT EQUAL
.
          PACK      KEY26,PMHPATYP,PMHPCLAM,PMHPFUND,PMHPTABT,PMHPEDAT,SP70
          CALL      RSPMHPO1
WIPG7000  CALL      RKPMHPO1
          BRANCH    OVRCD,WIPG9999
.
          MATCH     PMHPATYP,PMHOATYP
          GOTO      WIPG9999 IF NOT EQUAL
.
          MATCH     PMHPCLAM,PMHOCLAM
          GOTO      WIPG9999 IF NOT EQUAL
.
          MATCH     PMHPFUND,PMHOFUND
          GOTO      WIPG9999 IF NOT EQUAL
.
          MATCH     PMHPTABT,PMHOTABT
          GOTO      WIPG9999 IF NOT EQUAL
.
          MATCH     PMHPEDAT,PMHOEDAT
          GOTO      WIPG9999 IF NOT EQUAL
.
          CALL      CLPMSUPO
.
          MOVE      AURNO,PMUOURNO
          MOVE      PMHOATYP,PMUOATYP
          MOVE      PMHOCLAM,PMUOCLAM
          MOVE      PMHOFUND,PMUOFUND
          MOVE      PMHOTABT,PMUOTABT
          MOVE      PMHOVTYP,PMUOVTYP
          MOVE      PMHOMAXO,PMUOMAXO
          MOVE      PMHOWARO,PMUOWARO
.
          PACK      PMUOCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUOCDAT
          CLOCK     TIME,PMUOCTIM
          MOVE      USERID,PMUOCUID
.
          PACK      KEY34,PMUOURNO,PMUOATYP,PMUOCLAM,PMUOFUND,PMUOTABT,PMUOEDAT:
                          PMUOVTYP,SP70
          CALL      RAPMUPO1
          IF        OVRCD=1
            CALL      WRPMUPO1
          ENDIF
          GOTO      WIPG7000
.
WIPG9800  MOVE      TWO,F1
          GOTO      WIPG9999
.
WIPG9999  RETURN
.
+
