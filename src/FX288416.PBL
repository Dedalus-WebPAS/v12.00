.*****************************************************************************
.*    Program      : FX288416                                                *
.*    Description  : Fix it for zero quantity (pmmiserv)                     *
.*                                                                           *
.*    Author       : J.Tan                                                   *
.*    Date         : 08/08/2013                                              *
.*    Modifications: V10.03.01 08/08/2013 J.Tan        CAR 288416            *
.*                            Created fix                                    *
.*****************************************************************************
.
          INC       STD001FD
          INC       PMSMTIFD/INC
.
RECNUM    FORM      8
RECUPD    FORM      8
.
PRGNAM    INIT      "Fix PMSMTIFD"
PRGID     INIT      "FX288416"
VERSION   INIT      "V12.00.00"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
MAIN1000  CALL      READ0000                     * read old records and WRPMMTI1
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
          MOVE      ZERO,RECNUM
          MOVE      ZERO,RECUPD
          OPEN      PMSMTIA3,"pmsmtiaf"
          
INIT9999  RETURN
.
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and WRPTFX11 each record               *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Record No. : ";
          MOVE      ZERO,CPAGENO                  * initialise print variables
          MOVE      ZERO,CNOUNDLN
          CALL      IBACLOCK
.
          CALL      HEAD0000                      * print header
.
          MOVE      "2",KEY1
          PACK      KEY23,KEY1,SP70
          CALL      RSPMMTI3
READ1000  CALL      RKPMMTI3                      * read next record
          BRANCH    OVRCD,READ6000                * no more records
.
          MATCH     "2",PMMIRTYP
          GOTO      READ6000 IF NOT EQUAL
.
          ADD       ONE,RECNUM                    * update record counter
.
          IF        PMMISERV=0
            MOVE      ONE,PMMISERV
            MOVE      PMMIAMTP,PMMIAMTT
            ADD       PMMIRBAT,PMMIAMTT         * set up total
            MULT      PMMISERV,PMMIAMTT
            CALL      UPPMMTI3
            ADD       ONE,RECUPD
            PRINT     *1,PMMIVISN,*15,PMMITRAN,*25,PMMIRTYP
          ENDIF
.
          IF        (RECNUM%1000) = 0
            DISPLAY   *P15:20,*V2LON,RECNUM
          ENDIF
.
          GOTO      READ1000                      * get next record
.
READ6000  CLOSE     PMSMTIA3                      * close new file
.
          PRINT     *1,"No of Records Updated : ",RECUPD
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:20,*EF,"Record updated : ",RECUPD
          DISPLAY   *P1:21,"Ended  : ",CDATE,SP1,CTIMEIS
          CALL      HITENTER
.
READ9999  RETURN
.
+
.****************************************************************************
.*                            HEAD0000                 Called by: PROC0000  *
.*                       Print page heading                       PRIN0000  *
.****************************************************************************
.
HEAD0000  CALL      HEAD132                      * display page header
          CALL      LINE0000                     * draw line across page
.
          PRINT     *1,"Adm Number",*15,"Trans.No",*25,"Rec.Type"
          CALL      LINE0000                     * draw line across page
.
          MOVE      SEVEN,CLNO                   * set line count
.
HEAD9999  RETURN
+
.****************************************************************************
.*                            LINE0000                 Called by: PROC0000  *
.*                      Draw line across page                     HEAD0000  *
.****************************************************************************
.
LINE0000  PRINT     "*-----------------------------------------------":
                    "------------------------------------------------"
.
          ADD       ONE,CLNO                     * increment line count
.
LINE9999  RETURN
+
          INC       PMSMTIIO/INC
          INC       STD001IO
