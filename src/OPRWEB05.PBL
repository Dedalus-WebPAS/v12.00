.-------------------------------------------------------------------------------
. Program       : OPRWEB05 
.
. Function      : Theatre Session Maintenance
.
. Modifications : 
.
.------------------------------------------------------------------------------
. V12.00.01 18/08/2025  Alina Bhari    TSK 0965023
.           Recompiled for changes to OPRSESIO - converted form(OPSESUSP) to
.           DIM (DOPSESUS) for read and write
. V11.03.02 28/07/2023  Ebon Clements  TSK 0935527
.           Recompiled for OPRQUEFD - Theatre booking hospital
. V11.03.01 14/02/2023  Ebon Clements  TSK 0909393
.           Fixed hospital test for operating room schedules - SEMTB000
.           Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
. V11.02.06 26/07/2022  Jacob Jackson  TSK 0914210
.           Remove assignment causing doctor code to appear in opses034
. V11.02.05 22/07/2022  Jacob Jackson  TSK 0914210
.           Remove of unnecessary tags, along with removal of assigning Extra
.           Doctor values to tags
. V11.02.04 27/05/2022  Jacob Jackson  TSK 0914210
.           When Extra Doctor is set for a session, it is added to the Theatre 
.           Case Team Detail. It also checks OPCNUSAN to determine to use the
.           extra doctor & OPCNPCOT to set the operating personnel.
. V11.02.03 20/05/2022  J.Tan          Task 0912047
.           Mod to update OPSETYD2 (Cat OP) for Anaesthetic code
. V11.02.02 20.05.2022  DA Sarkies     Task 0918394
.           RAdded a read call to prevent duplicate error
. V11.02.01 02/03/2022  Jill Parkinson Task 0916836
.           Changed SESTAB00 - session maintenance list to chech correct
.           session before checking if correct hospital
. V11.01.06 19/11/2021  Davin         TSK 0912295
.           Don't send HL7 S14 (hl7trgid=1) for cancelled bookings (UPEXDT00)
. V11.01.05 03/09/2021  Davin         TSK 0900165
.           Recompile for OPRSESTM - Allow zero for prep time in opses010
. V11.01.04 17/06/2021  Ebon Clements  TSK 0907503 0863524
.           Disable different theatre checkbox if the session masters theatre
.           is different to the open session - SESSTA00
.           Only delete sessions that are from the same theatre as
.           the session master - DELSES00
. V11.01.03 16/06/2021  Ebon Clements  TSK 0907503 0863524
.           Set different theatre flag and make the checkbox disabled
.           if open session is for a different hospital - SESSTA00 - DIFFHOSP
.           Only delete sessions that are from the same hospital as
.           the session master - DELSES00
. V11.01.02 19/05/2021  Ebon Clements  TSK 0905705
.           Added operating room test to update future session comments -
.           UPDSES00
. V11.01.01 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
.------------------------------------------------------------------------------
. V11.00.03 10/11/2020  Ebon Clements  TSK 0894803
.           Update bookings theatre when doing a global update of the sessions
.           theatre - GLUSES00, GLUDET00
. V11.00.02 20/10/2020  Thanh T        TSK 0887468
.           Added STSES085, DFTTMA00 for Updating arrival cases with default
.           team  
. V11.00.01 28/04/2020  Ebon Clements  TSK 0850105
.           Added procedure calls PMSCURTH - Theatre status in patient header
. V10.15.02 11/12/2019  Ebon Clements  TSK 0862534
.           Added hospital test to open session edit when deleting a session
.           master - SESDTE00
. V10.15.01 12/11/2019  Richa Phogat   TSK 0881200
.           Added condition to check OPRMSTAT under OSEL0000 to aviod displaying
.           inactive theatre
.           Added option OPSLST30 under OPSLST00
. V10.14.10 18/09/2019  Richa Phogat   TSK 0880667
.           Added condition under DYCM0000 to check for multi hospital
. V10.14.09 16/09/2019  Peter Vela     TSK 0878355
.           Update OPSEDCC2 in UPDSES00 if Update into Future indicator is set
. V10.14.08 11/09/2019  Ebon Clements  Task 0877464 
.           Added cgi teamupdt to stop the update default case team screen
.           from updating the theatre bookings operating room - UPEXDT00
. V10.14.07 19/07/2019  Ebon Clements  Task 0878246 
.           Removed xxxxx from OPROPN94 WEBERROR
. V10.14.06 11/07/2019  Ebon Clements  Task 0877807 
.           Added SESMTHET SEMSHOSP cgi vars for session maintenance - OPRSEM00
. V10.14.05 08/07/2019  Ebon Clements  Task 0877807 
.           Changed OPSLST00 to not output a selection list when
.           using a .1 tag for the code and the code is blank
. V10.14.04 28/06/2019  Jill Parkinson Task 0863524 0877410 0877409
.           Removed changes made in 10.13.04
. V10.14.03 04/06/2019  Jill Parkinson Task 0875972 
.           Added theatre and hospital to next year/prev year links
. V10.14.02 28/03/2019  Peter Vela       TSK 0839663
.           Recompiled for OPRSESTM
. V10.13.06 05/12/2018  Don Nguyen     TSK 0838558
.           Removed comments temp file (COMFILAF) creation from server startup
. V10.13.05 28/08/2018  Ebon Clements   TSK 0853101
.           Fixed day comment save and display  - DYCM0000 and DYCMN00
. V10.13.04 23/08/2018  Thanh T         TSK 0861676
.           Fixed issue with updating theatre to defaulted theatre when
.           theatre case team details is updated. Removed UPOPDEA1 call
.           from UPEXDT00
. V10.13.03 21/08/2018  Ania P          TSK 0861832
.           Overwrite default move of OPSES009 to OPSEBRKT
. V10.13.02  16/08/2018  Ebon Clements  TSK 0853101
.            Fixed hospital test for day comments - DYCM0000
. V10.13.01  02/08/2018  Ebon Clements  TSK 0853101
.            Added hospital to theatre comments key - oprcomaf
. V10.12.06 02/07/2018  Steve Armstrong TSK 0851661
.           - Mods to HL7 Trigger id "2" to ignore for cancelled bookings
.             (TOPALL00).
.           - Mods to HL7 Trigger id "4" to ignore for cancelled bookings
.             (MPST0000).
.           - Mods to trigger an S14 message if the anaesthetist code has
.             changed via "Default Team" changes (UPEXDT00).
.           - Mods to load OPSEANAE using a PACK instead of a MOVE so it's
.             padded with trailing spaces (ANAGET00).
. V10.12.05 23/05/2018  Steve Armstrong TSK 0854797
.           Mods to HL7 Trigger id "4" to ignore for cancelled bookings.
. V10.12.04 11/05/2018  Thanh T.        TSK 0856216
.           Changed OPRSES88 to fix the issue with displaying the incorrect
.           message when the operating room is changed to the one that is
.           already occupied
. V10.12.03 20/03/2018  Peter Vela     TSK 0842991
.           Recompiled for OPRSESTM
. V10.12.02 05/02/2018  Ebon Clements   TSK 0851690
.           Increase case number if case number exists in new session - MPST0000
. V10.12.01 11/01/2018  Tracey Nguyen   TSK 0825792
.           Modified NURDET00 to read pmshcpaf if OPCNURSE = 1
.-------------------------------------------------------------------------------
. V10.11.01 01/09/2017  Ebon Clements   TSK 0844533
.           Fixed display of session type code if OPCNCLSU = 0 - OPDUSL00
.-------------------------------------------------------------------------------
. V10.10.01 29/05/2017  Peter Vela      TSK 0838854
.           Added overbooking calculation in OPRSES25
. V10.08.01 02/08/2016  Ebon Clements   TSK 0319867
.           Added Adhoc session test to SAVSES00 & OPRSES75
. V10.07.02 18/12/2015  Peter Vela      CAR 323846
.           Added OPSES072 OPSES073 to SAVSES00
. V10.07.01 14/10/2015  Ebon Clements  CAR 316629
.           Added hospital to holiday file key  - OUTPHOFD
. V10.06.03 21/08/2015  Peter Vela      CAR 307795
.           Only update OPDATHET if OPSETHET is not spaces UPEXDT00
. V10.06.02 24/06/2015  Don Nguyen     CAR 318454
.           Modified OPRSES22 for case where 'Default Team Completed' (OPSES078)
.           flag is not passed in (i.e. Change Theatre).
.           Recompiled for OPRSESTM - Added OPSES078 in MOVSES00
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.-------------------------------------------------------------------------------
. V10.05.04 06/11/2014  Don Nguyen     CAR 304059
.           Added vars OPSES078-OPSES084 for Default Team Completed.
.           Updated SAVSES00 & OPRSES00 for Default Team Completed fields.
. V10.05.03 04.09.2014  Ania P         CAR 298084
.           Recompiled for OPRSESTM
. V10.05.02 12/08/2014 Peter Vela     CAR 283302
.           Added new fields in OPRSESFD for Cancel Session (CANSES00)
. V10.05.01 22/07/2014 Jill Parkinson CAR 302416
.           Added call to CLRSEM00 in OPRSES40 (tags use values without reading)
. V10.04.02 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.01 16/12/2013  Peter Vela     CAR 156094
.           Added OPRSES67 - Reset Finalised Session back to Provisional
.-------------------------------------------------------------------------------
. V10.03.08 09/12/2013  Ebon Clements  CAR 291924
.           Added status column and filter to theatre schedule - SEMTB000
. V10.03.07 29/10/2013  Ebon Clements  CAR 241091
.           Fixed unpack of STARTIME in ENDT0000
. V10.03.06 04/10/2013  Patrick Adair  CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.05 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.04 03/05/2013  Ebon Clements    CAR 261630
.           Removed port number from temp file name
. V10.03.03 21/02/2013  Ania P           CAR 281021
.           Removed unnecessary modification of constants.
. V10.03.02 18/05/2011  Ebon Clements    CAR 263844
.           Update default team anaesthetist on global update -  GLUSES00
. V10.03.01 06/03/2012  Peter McMullen   CAR 259587
.           Remove references to file patyear1       
. V10.02.03 04/11/2011  Steve Armstrong  CAR 254751
.           Recompiled for changes to OPRQUEFD
. V10.02.02 27/06/2011  Jill Parkinson CAR 241091
.           Changed MPST0000 to use oprdetaf index 5 instead of index 1
. V10.02.01 1R506/2011  Peter McMullen    CAR 235359
.           Added tag OPRWEB05.xx.025 for wbsehosp or opsmhosp name             
. V10.00.02 18/06/2010  Ebon Clements     CAR 214022
.           Added OPCNCLSU test to operating surgeon - SAVSES00 ad-hoc session
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.03  11/12/2009  Ebon Clements  CAR 210196
.           Recompiled for OPRSESTM - Default start/end time for duration
. V9.12.02  07/12/2009  Peter McMullen CAR 210130
.           replace DOCNAM00 calls with DOCNM000 (paramterer driven version)   
. V9.12.01  03/09/2009  Ebon Clements  CAR 182655
.           Added clear of session file fields before open sessions - SAVMON00
. V9.11.02  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.01  13/10/2008 Peter Vela     CAR 174334
.           Added HDIREC00 parent redirect
. V9.10.04  03/09/2008  Davin         CAR 147323
.           Send hl7 message for upd bookings (added call DGCLIS14)
. V9.10.03  16/07/2008  Jill Habasque  CAR 172219
.           Fixed theatovercell output (again), time checking
. V9.10.02  11/07/2008  Jill Habasque  CAR 172219
.           Fixed theatovercell output
. V9.10.01  13/05/2008  Jill Habasque  CAR 168290
.           Populate doctor code with session doctor if OPCNCLSU=0 (Clinic) 
.           when looking for doctors leave when opening sessions
. V9.09.11  17/04/2008  Ebon Clements  CAR 164037
.           Populate default team surgeon with session doctor
.           if OPCNCLSU=0 (Clinic) when opening sessions
. V9.09.10  17/03/2008  Jill Habasque  CAR 141579
.           Added output of TheatOverCell in SESROW00
. V9.09.09  23/01/2008  Ebon Clements  CAR 141907
.           Fixed update session comments at OPRSES25 - UPDCOM00
. V9.09.08  20/12/2007  Jill Habasque  CAR 126282
.           Added update of update date/time for oprdetaf
. V9.09.07  28/11/2007  Jill Habasque  CAR 155003
.           Commented out update of oprsesaf at MPST9000
. V9.09.06  07/11/2007  Jill Habasque  CAR 152156
.           Changed to update cancelled bookings in MPST0000
. V9.09.05  11/10/2007  Peter Vela     CAR 138153
.           Added Global Change for Theatre Sessions
. V9.09.04  20/07/2007  Ebon Clements  CAR 145544
.           Allow theatres with no hospital to be used by all hospitals/users
. V9.09.03  10/07/2007  Jill Habasque  CAR 144736
.           Added check for new key before updating oprsemaf
. V9.09.02  02/07/2007  Ebon Clements CAR 144158 
.           Recompiled for OPRSESTM - hospital name tag
. V9.09.01  18/06/2007  Ebon Clements CAR 142317
.           Changed SEMTB000 to show sessions for the users current hospital
. V9.08.04  04/05/2007  Ebon Clements CAR 124639
.           Added read of session file at SBCMN000 to fix comments write
. V9.08.03  01/11/2006  Peter Vela    CAR 122810
.           Added GETANA00. Get anaesthetist fromlive post of default team
.           details (oprweb0502007.html) @ OPRSES22
. V9.08.02  25/10/2006  Peter Vela    CAR 116254
.           Added update of anaesthetist in UPDSES00
. V9.08.01  27/09/2006  Ebon Clements CAR 119988
.           Added multi hospital functionality to theatre session maintenance
. V9.07.01  20/09/2006  Peter Vela CAR 118228
.           Added functionality for reallocated ad hoc theatre sessions
. V9.06.01  25/05/2006  J.Tan
.           Mods for Day Comments
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.12 01/09/2005  Ebon Clements  CAR 73209
.          Removed OPCNFTYP,OPCNFTTM,OPCNTTYP,OPCNTTTM as they are not used
.          Recompiled for OPRSESTM - Session usage default times
. V9.04.11 03/08/2005  Jill Habasque  CAR 70378
.          Added check for OPDASTAT in CHKTHE00
. V9.04.10 31/03/2005  Peter Vela     CAR 59737
.          Changed testing of session startime and endtime in SEMTME00 to allow
.          session cross midnight when adding ad-hoc sessions
. V9.04.09 14/06/2005  Jill Habasque  CAR 61176     
.          Changed to always use doctor code when validating to pmsdunaf
. V9.04.08 12/05/2005  Jill Habasque  CAR 61176     
.          Changed to check OPCNCLSU in OPDUSL00 
. V9.04.07 17/03/2005  Guomin Fu      CAR 59532
.          Recompiled for OPRSESTM
. V9.04.06 02/03/2005  Lina Vo        CAR 56404
.          Added Finalise Session functionality to OPRSES00.                    
. V9.04.05 13/01/2005  Sandra Barcham car 56519
.          At label OPRSES75 pack key19 before reading session table
. V9.04.04 15/10/2004  Lina Vo    CAR 54316
.          Changed update session maintenance to also update existing oprdetaf
.          records with new operating room.
. V9.04.03 04/10/2004  Lina Vo    CAR 54012
.          Make Hospital Id Field on Theatre Session Mandatory
. V9.04.02 13/09/2004  Lina Vo    CAR 53228	
.          Fixed Session Master to use OPSMDAYI instead DOPSMDAY
.          24/09/2004  Lina Vo       CAR 53753
.          Changed SESSAV00(Open Session) & SAVSES00(Add Adhoc Session)
.          to write Operating Surgeon and Anaethetist to Default team
. V9.04.01 19/08/2004  Lina Vo    CAR 52746
.          Added Multi-Hospital to Session Master                
. V9.03.10 10/08/2004  Peter Vela CAR 50678
.          Added tag for OPCNSCOM - Using Session Based Comments?
.          Added OPRCOMFD and OPRCOMIO
.          Added update of session based comments
.          Added display of session based comments
.          Added tag for red button session based comments indicator
. V9.03.09 04.08.2004  Lina Vo   CAR 52288	
.          Recompiled for OPRSESTM                                           
. V9.03.08 22.07.2004  Lina Vo   CAR 49985	
.          Changed OPRSES60 to ignore Cancelled booking and allow Session to 
.          be Cancelled.
. V9.03.07 25.05.2004  Ebon Clements   CAR 50104
.          Added OPRSES75 reinstate cancelled theatre session
. V9.03.06 14.04.2004  Sylvek Litewka  CAR 47592
.          Modified procedure SESHED00 to display buttons for months
.          instead of plain text month names. This allows to open or delete 
.          all sessions within a given month.
. V9.03.05 23.10.2003  Sylvek Litewka  CAR 44159
.          Added MISC0000 procedure under option 2.
. V9.03.04 15.10.2003  Sylvek Litewka  CAR 43963
.          Recompiled for changes made to 'OPRSESTM.PBL'.
. V9.03.03 12.09.2003  Sandra Barcham      43010
.          Remove prefix from open of outpreaf & outphoaf
. V9.03.02 08.08.2003  Sylvek Litewka  CAR 23803
.          Modified OPRSES00 to call ACTDUR00 only when 
.          TEMPLATE = "006" (Input Actuals screen).
.          07.08.2003  Jill Habasque CAR 41815           
.          Changed matched for OPDASTA
. V9.03.01 17.07.2003  Sylvek Litewka CAR 38345          
.          Added processing for new fields oprsemaf.OPSMDGSI
.          and oprsesaf.OPSEDGSI (Day/General Surgery Indicator)
. -----------------------------------------------------------------------------
. V9.02.16 09.01.2003  Sylvek Litewka SRF 35105          
.          Changed OPSEM004 from FORM 3 to FORM 4.
. V9.02.15 05.12.2002  Lina Vo        SRF 22709          
.          Added OPNOUT00 to open outpatient file          
. V9.02.14 21.11.2002  Sylvek Litewka SRF 23803          
.          Added ACTDUR00 to calculate the Actual Duration 
.          of a session.
. V9.02.13 16.08.2002  Ebon Clements SRF 21035          
.          Changed OPRSES00 to not allow you to delete a session
.          if it has bookings.
. V9.02.12 15.07.2002  Ebon Clements SRF 19444 17829
.          Changed MPST0000 to use SAVKEY19 not KEY19      
. V9.02.11 15.07.2002  Ebon Clements SRF 19444 17829
.          Added MPST0000 to allow changes to the session
.          start time for an existing session with booings.
. V9.02.10 26.06.2002  Jill Habasque 
.          Fixed update of session master                       
. V9.02.09 25.06.2002  Jill Habasque SRF 18976
.          Changed to use OPSEM003 instead of SESMTIME          
. V9.02.08 03.06.2002  Jill Habasque SRF 18286
.          Fixed doctor name in error message                   
. V9.02.07 20.05.2002  Jill Habasque SRF 17643
.          Fixed error message when changing theatre            
. V9.02.06 01.05.2002  Bronko Sosic
.          Changed SESSTIME to a CGI  defect - 3643             
. V9.02.05 28.02.2002  Ashwin
.          Display Cancelled Sessions and Status
. V9.02.04 14.02.2002  Kuldeep Singh
.          Modify for Doctor/Unit combination
. V9.02.03 05.02.2002  Ashwin
.          Add Delete Session Functionality
. V9.02.02 24.01.2002  Ashwin
.          Update Session Maintenance Start time
. V9.02.01 03.01.2002  Ashwin
.          Update Session Master Start Time
. V9.01.02 16/08/2001  HPS-ODC
.          Modified UPDSES00 
. V9.01.01 13/08/2001  HPS -ODC
.          Changes for Input actual session & default team.
. V9.00.02 01/08/2001  Jill Habasque
.                          Removed check for mandatory "Time for Breaks"
.                          and "Prep Time".
.-------------------------------------------------------------------------------
.                 V5.07.03 09/07/2001 Jagat Pathak/Sachin Dangui
.                          Modified SEMHD000 and SEMRW000 for adding session
.                          type column to "Table of Session Schedules"
.                          Added New fields to "Theatre Session Schedule Mtsc."
.                          Modified SAVSES00,CLRSES00,SESSAV00 for Input Actuals
.                          and Default Team Allocation Screens.
.                          Modified OPRSESTM for the same screens.
.                 V5.07.02 16/03/2000 Pat Dirito   
.                          Added fixed Table display for SESTAB00
.                 V5.07.01 10/03/2000 Pat Dirito   
.                          Added added Instances for ShowDetail
.                 V5.07.00 06.11.1999 Pat Dirito
.                          Created Program                                      
.                    
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       OPROPRFD/INC   * Operating Room File
          INC       OPRCONFD/INC   * Operating Room - Control File
          INC       OPRCLIFD/INC   * Operating Room - Clinic File
          INC       OPRCOMFD/INC   * Session Based Comments File       *I-50678
          INC       OPRDEAFD/INC   * Operating Room - Session Details
          INC       OPRTSMFD/INC
          INC       OPRRALFD/INC
          INC       OPRSEMFD/INC   * Operating Room - Session Master(Schedule) 
          INC       OPRSESFD/INC   * Operating Room - Session Details 
          INC       OPRSESTD/INC   * Operating Room - Session Details 
          INC       OPRNURFD/INC   * Operating Room - Nurses File
          INC       OPRUAVFD/INC   * Operating Room - Unavailable Theatre file
          INC       OPRDLVFD/INC   * Doctors Leave
          INC       OUTPHOFD/INC   * Outpatients    - Public Holiday File
          INC       PATCONFD/INC   * Control File 
          INC       PATDO1FD/INC   * Doctor File
          INC       PATHSPFD/INC   * Multi-hospital File
          INC       PATMA1FD/INC
          INC       PATNIDFD/INC
          INC       PMSHCPFD/INC   * C-0825792 HCP File
          INC       PMSPX2FD/INC
          INC       NHIMASFD/INC
          INC       OPR001FD/INC   * HPS Added
          INC       OPRDECFD/INC   * HPS Added
          INC       PMSDUNFD/INC
          INC       OPRSRGFD/INC
          INC       OPRARDFD/INC
          INC       TFILEVAR/INC
.
.---------------------------------------------------------------------------
.  CGI Variables
.
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
SHOWFLAG  FORM      1       * Show flag for filter defaults
SHOWYEAR  DIM       4       * Year of Dates to Show (Leave/Sessions etc)
RESPNVAR  FORM      1       * Extra Session Clashers indicator
SESSEND   DIM       5
SPECUPDT  FORM      1
.AUDIFLAG  FORM      1      * HPS Comment
.
OPSEM001  DIM       6       * Clinic/Surgeon
OPSEM002  DIM       1       * Day Indicator  Mon...Sun
OPSEM003  DIM       5       * Start time
OPSEM004  FORM      4       * Duration
OPSEM005  DIM       3       * Time Period (Category SP)
OPSEM006  DIM       3       * Session Type (Category ST)
OPSEM007  DIM       6       * Operating Room Code
OPSEM008  DIM       5       * End Time of Session 
OPSEM009  FORM      3       * Time for Breaks (min)
OPSEM010  FORM      2       * Preperation Time for patients
OPSEM011  DIM       6       * Anaesthetist
OPSEM012  DIM       6       * Extra Doctor
OPSEM013  FORM      1       * Status 0=Active 1=Inactive 
.
.                                           * HPS Code Starts Here
OPSEM014  DIM       50      * Special Instructions 1
OPSEM015  DIM       50      * Special Instructions 2
OPSEM016  DIM       2       * Number of days to lock session
OPSEM017  DIM       3       * Session Type
.                                           * HPS Code Ends Here
OPSEM018  DIM       3       * Day/General Surgery Indicator
OPSEM019  DIM       3       * Multi-Hospital ID
.
.
MTHDTE    DIM       8[12][5]  * Session Dates    Months & Weekno contains Date
.
. Variable Declarations  
.
ACTVFILT  DIM       1       * Active/Inactive Filter
AVAITIME  DIM       4       * Available Time 
ANAEFLAG  FORM      1       * Anaesthetist change flag
.                              0 = anaesthetist code changed
.                              1 = anaesthetist code not changed
ANAETHET  DIM       6       * Anaethetist
ANAETH    DIM       6       * Anaethetist
BOOKTIME  FORM      4                  * calculated actual book
CFILEPRE  DIM       3       * site prefix
CLINCODE  DIM       6       * Clinic/Surgeon
CLINDESC  DIM       35      * Clinic/Surgeon Description 
COMFILAF  FILE      ASCII, FIXED=127                                   *I-50678
COMFILNM  DIM       8                                                  *I-50678
CHECKED   DIM       17      * Checked and diabled value
DAYDESC   DIM       10      * Day of Week Description
DATE      DIM       8       * Date Displayed to HTML
DATECGI   DIM       8       * Date cgi parameter
DAYNO     FORM      2       * Day Number
DIFFTHET  DIM       1
DIFFHOSP  DIM       1
DIM3      DIM       3       
DIM5      DIM       5
DIM6      DIM       6
DIM22     DIM       22
.DOCTCODE  DIM       6       * Doctor Code   (Commented by HPS)
DOCT      DIM       6       * Doctor Code
DOCTOR    DIM       30      * Doctor formatted name
DISPCOL   FORM      2       * Last Column in Session Date Table
ENDTIME   DIM       5       * END TIME of clinic booked 
FINSHTME  FORM      4       * Finish Booking Time
FIRSTDAY  FORM      1       * First day of the year eg Mon=1.....Sun=7
FROMDATE  DIM       8
FROMDTE   FORM      8       * Date in Form Format
GLOBINDC  DIM       1
ID        DIM       11      * id=checked html output
KEY19A    DIM       19
KEY22A    DIM       22
LABEL     DIM       2       * Screen Labels
LASTITEM  FORM      3                                                  *I-50678
LNK2PRT   FORM      1
LOOKDAY   FORM      1       * Day to be searched
MONDESC   DIM       10      * Month of Year Description
MONTHNO   FORM      2       * Actual month no eg; Jan=1.....Dec=12
MONTHROW  DIM       2       * Actual month no eg; Jan=01.....Dec=12
MONTHTOT  FORM      2       * Total No of days in a month
MONTH     DIM       2       * Month no
MIN       DIM       2       * Minutes Variable
DELSES    FORM      1       * Delete Form Sessions Display indicator
DESCACTV  DIM       8       * Active/Inactive display
OVERLAPE  DIM       5                  * overlap end time
OVERRID1  FORM      1       * Override Warning Message passed in CGI var
OVERRID2  FORM      1       * Override Warning Message passed in CGI var
OVERRID3  FORM      1       * Override Warning Message passed in CGI var
OVERRID4  FORM      1       * Override Warning Message passed in CGI var
OVERRID5  FORM      1       * Override Warning Message passed in CGI var
OVERRID6  FORM      1       * Override Warning Message passed in CGI var
SESMHOSP  DIM       3       * Session hospital
SESMTHET  DIM       6       * Session operating room code
SESMTIME  DIM       5       * Session Start Time
SESSTIME  DIM       5       * Session Start Time
SAVEANAE  DIM       6
SAVTHET   DIM       6
SAVKEY12  DIM       12      * Save key 19
SAVKEY19  DIM       19      * Save key 19
SAVKEY20  DIM       20
SAVKEY22  DIM       22
SAVKEY21  DIM       21      * Save key 21
SAVKEY30  DIM       30
SAVEDEA   DIM       26      * save the DEA record
SAVESESS  DIM       22      * Save the session key
SOVLAPS   DIM       5                  * save overlap start time
SOVLAPE   DIM       5                  * save overlap end time
TEAMUPDT  DIM       1       * Default case team screen posted
TOTMINS   FORM      5       * TOTal MINuteS used to calculate endtime
.NURSCODE  DIM       6      * HPS Comment 
.
OPRWEBSR  FORM      1       * Set to 0 for OPRWEB05, used in OPRSESTM as        .                           * OPRWEB01 uses doctor/surgeon & and OPRWEB05 
.                           * may use Clinic Code.
.
.
SAVETHET  DIM       6
SAVEETIM  DIM       5
SAVESTIM  DIM       5
SCHDLDAY  FORM      1       * Day Indicator
SESSKEYS  DIM       22
SKEY19    DIM       19
STARTIME  FORM      4       * Session Start Time
STARTIM1  DIM       5
THETCODE  DIM       6       * Theatre Code 
THEATRE   DIM       6       * Theatre Code 
TODTE     FORM      8       * Date in Form Format
TOEDDATE  DIM       8
WEEKNO    FORM      2       * Actual week no. in each month
FORM4C    FORM      4
FORM4D    FORM      4       * HPS Added
DGSUPFLG  FORM      1       * Update Flag for Day/General Surgery Indicator
NMPNUMB   DIM       20
.
SAVEDATE  DIM       8       * date save variable                       *I-50678
SAVETIME  DIM       5       * start time save variable                 *I-50678
SAVECLIN  DIM       6       * clinic / surgeon save variable           *I-50678
SAVELINE  FORM      3       * line number save variable                *I-50678
SAVETEXT  DIM       70      * text save variable                       *I-50678
SAVEHOSP  DIM       3       * hospital
.
UPDTFLAG  FORM      1       * Update flag
STAFTYPE  FORM      2
TEAMNUMB  DIM       1       * Team number
.
SECONDS   INIT      ":00"
.
.---------------------------------------------------------------------------
PRGID     INIT      "OPRWEB05"
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Theatre Session Maintenance"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      OPRSEM00   * Theatre Session Maintenance
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      OPRSES00   * Existing Session Details Maintenance
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      OPROPN00   * New/Open Session Details Maintenance
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  MOVE      SP70,UPDTTYPE
          CALL      OPROPN00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      HDIREC00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
.  Redirect URL
.------------------------------------------------------------
HDIREC00  CALL      OPENHTML
          BRANCH    EXIT,HDIREC99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      HDIREC99
.
HDIREC90  DISPLAY   "*** Fifo Not Found ***"
.
HDIREC99  RETURN
.------------------------------------------------------------
. Output HTML Error File
.------------------------------------------------------------
WEBRSP00  CALL      OPENHTML
          BRANCH    EXIT,WEBRSP95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "   alert(#"",WEBTITLE,"#"); ":
                             "   reloadParentFrame();}":
                             " else { ":
                             "   window.history.go(-1);":
                             "   self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBRSP99
.
WEBRSP95  DISPLAY   "*** Fifo Not Found ***"
.
WEBRSP99  RETURN
.
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCOMA1,"oprcomaf"
          OPEN      OPRCOMA2,"oprcomaf" 
          OPEN      OPRSEMA1,"oprsemaf"
          OPEN      OPRSEMA2,"oprsemaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSESA4,"oprsesaf"
          OPEN      OPRAUDSM,"opraudsm"
          OPEN      PMSDUNA1,"pmsdunaf"
          OPEN      OPRAUDSE,"opraudse"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      OPRUAVA1,"opruavaf"
          OPEN      OPRDLVA1,"oprdlvaf"
          OPEN      PATDO1A1,"patdo1af"      * Doctor File
          OPEN      PATHSPA1,"pathspaf"      * Multi-Hospital File
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      OPRDETC1,"oprdetcf"      * HPS Code
          OPEN      OPRRALA1,"oprralaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      PMSHCPA1,"pmshcpaf"      * HCP file
.
          OPEN      CONTROLF,"controlf"      * Control File
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,FORTY;*44,OPCNAUDB,*55,OPCNAUDM:
                                   *61,OPCNAUDS,*111,OPCNCLSU
          READ      CONTROLF,FORTY2;*28,OPCNFULL,*71,OPCNUSAN,*87,OPCNPCOT:
                                    *93,OPCNCLSH,*241,OPCNSCOM,*235,OPCNFTIM:
                                    *237,OPCNTTIM
.                                           * Above Read Routine-Modified by HPS
          READ      CONTROLF,SIXTY8;*241,OPCNSTCT,*245,OPCNDSAS,*247,OPCNDSAE
          READ      CONTROLF,HUND13;*51,OPCNURSE:
                                    *60,OPCNAIPS
.
          IF        OPCNAUDB<>1
            OPEN      OPRAUDDA,"opraudda"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      ZERO,OPRWEBSR      * Assigned to 0 = OPRWEB05 
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
.         PREP      COMFILAF,COMFILNM                                  *I-50678
.
INIT9999  RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  OPEN      OUTPHOA1,"outphoaf"    
OPNOUT99  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM
          MOVE      ZERO,SPECUPDT
          MOVE      ZERO,NORECORD
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER 
          MOVE      SP70,SHOWYEAR
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      ZERO,SCHDLDAY
          MOVE      SP70,FRSTDATE
          MOVE      SP70,FROMDATE
          MOVE      "~~~~~~~~",LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,RESPNVAR
          MOVE      SP70,ACTVFILT
          MOVE      ZERO,SHOWFLAG
.
          MOVE      SP70,OPSEM001 
          MOVE      SP70,OPSEM002 
          MOVE      SP70,OPSEM003 
          MOVE      ZERO,OPSEM004 
          MOVE      SP70,OPSEM005 
          MOVE      SP70,OPSEM006 
          MOVE      SP70,OPSEM007  
          MOVE      SP70,OPSEM008  
          MOVE      ZERO,OPSEM009 
          MOVE      ZERO,OPSEM010  
          MOVE      SP70,OPSEM011
          MOVE      SP70,OPSEM012 
          MOVE      ZERO,OPSEM013 
.
.                                           * HPS Code Starts Here
          MOVE      SP70,OPSEM014    * Special Instructions1
          MOVE      SP70,OPSEM015    * Special Instructions2
          MOVE      SP70,OPSEM016    * Number of daysto lock session
          MOVE      SP70,OPSEM017    * Session Type(Category TU)
.                                           * HPS Code Ends Here
          MOVE      SP70,OPSEM018
          MOVE      SP70,OPSEM019
.
.
          MOVE      SP70,OPSES001  
          MOVE      SP70,OPSES002 
          MOVE      SP70,OPSES003 
          MOVE      SP70,OPSES004 
          MOVE      ZERO,OPSES005 
          MOVE      SP70,OPSES006 
          MOVE      SP70,OPSES007 
          MOVE      ZERO,OPSES008 
          MOVE      ZERO,OPSES009 
          MOVE      ZERO,OPSES010 
          MOVE      SP70,OPSES011 
          MOVE      SP70,OPSES012 
          MOVE      SP70,OPSES013 
          MOVE      SP70,OPSES014 
          MOVE      SP70,OPSES015 
          MOVE      ZERO,OPSES016 
          MOVE      ZERO,OPSES017 
          MOVE      SP70,OPSES018 
          MOVE      SP70,OPSES019 
          MOVE      ZERO,OPSES020 
          MOVE      SP70,OPSES021 
          MOVE      SP70,OPSES022 
          MOVE      SP70,OPSES023 
          MOVE      SP70,OPSES024 
          MOVE      SP70,OPSES025 
          MOVE      SP70,OPSES026 
          MOVE      SP70,OPSES027 
          MOVE      SP70,OPSES028 
          MOVE      SP70,OPSES029
          MOVE      SP70,OPSES030 
          MOVE      SP70,OPSES031 
          MOVE      SP70,OPSES032 
          MOVE      SP70,OPSES033 
          MOVE      SP70,OPSES034 
          MOVE      SP70,OPSES035 
          MOVE      SP70,OPSES036
          MOVE      SP70,OPSES037 
          MOVE      SP70,OPSES038 
          MOVE      SP70,OPSES039 
          MOVE      SP70,OPSES040 
          MOVE      SP70,OPSES041 
          MOVE      SP70,OPSES042 
          MOVE      SP70,OPSES043 
          MOVE      SP70,OPSES044 
          MOVE      SP70,OPSES045 
          MOVE      SP70,OPSES046 
          MOVE      SP70,OPSES047 
          MOVE      SP70,OPSES048 
          MOVE      SP70,OPSES049 
          MOVE      SP70,OPSES050 
          MOVE      SP70,OPSES051 
          MOVE      SP70,OPSES052 
          MOVE      SP70,OPSES053 
          MOVE      SP70,OPSES054 
          MOVE      SP70,OPSES055 
          MOVE      SP70,OPSES056 
          MOVE      SP70,OPSES057 
          MOVE      SP70,OPSES058 
          MOVE      SP70,OPSES059 
          MOVE      SP70,OPSES060 
          MOVE      SP70,OPSES061 
          MOVE      SP70,OPSES062 
          MOVE      SP70,OPSES063 
          MOVE      SP70,OPSES064 
.                                           * HPS Code Starts Here
          MOVE      SP70,OPSES065
          MOVE      SP70,OPSES066
          MOVE      SP70,OPSES067
          MOVE      SP70,OPSES068
          MOVE      SP70,OPSES069
          MOVE      SP70,OPSES070
.                                           * HPS Code Ends Here
          MOVE      SP70,OPSES071
          MOVE      SP70,OPSES072
          MOVE      SP70,OPSES073
          MOVE      SP70,OPSES074
          MOVE      SP70,OPSES075
          MOVE      SP70,OPSES076
          MOVE      SP70,OPSES077
          MOVE      SP70,OPSES078
          MOVE      SP70,OPSES079
          MOVE      SP70,OPSES080
          MOVE      SP70,OPSES081
          MOVE      SP70,OPSES082
          MOVE      SP70,OPSES083
          MOVE      SP70,OPSES084
          MOVE      SP70,OPSES085
.
          MOVE      SP70,MTHDTE[1][1]
          MOVE      SP70,MTHDTE[1][2]
          MOVE      SP70,MTHDTE[1][3]
          MOVE      SP70,MTHDTE[1][4]
          MOVE      SP70,MTHDTE[1][5]
.
          MOVE      SP70,MTHDTE[2][1]
          MOVE      SP70,MTHDTE[2][2]
          MOVE      SP70,MTHDTE[2][3]
          MOVE      SP70,MTHDTE[2][4]
          MOVE      SP70,MTHDTE[2][5]
.
          MOVE      SP70,MTHDTE[3][1]
          MOVE      SP70,MTHDTE[3][2]
          MOVE      SP70,MTHDTE[3][3]
          MOVE      SP70,MTHDTE[3][4]
          MOVE      SP70,MTHDTE[3][5]
.
          MOVE      SP70,MTHDTE[4][1]
          MOVE      SP70,MTHDTE[4][2]
          MOVE      SP70,MTHDTE[4][3]
          MOVE      SP70,MTHDTE[4][4]
          MOVE      SP70,MTHDTE[4][5]
.
          MOVE      SP70,MTHDTE[5][1]
          MOVE      SP70,MTHDTE[5][2]
          MOVE      SP70,MTHDTE[5][3]
          MOVE      SP70,MTHDTE[5][4]
          MOVE      SP70,MTHDTE[5][5]
.
          MOVE      SP70,MTHDTE[6][1]
          MOVE      SP70,MTHDTE[6][2]
          MOVE      SP70,MTHDTE[6][3]
          MOVE      SP70,MTHDTE[6][4]
          MOVE      SP70,MTHDTE[6][5]
.
          MOVE      SP70,MTHDTE[7][1]
          MOVE      SP70,MTHDTE[7][2]
          MOVE      SP70,MTHDTE[7][3]
          MOVE      SP70,MTHDTE[7][4]
          MOVE      SP70,MTHDTE[7][5]
.
          MOVE      SP70,MTHDTE[8][1]
          MOVE      SP70,MTHDTE[8][2]
          MOVE      SP70,MTHDTE[8][3]
          MOVE      SP70,MTHDTE[8][4]
          MOVE      SP70,MTHDTE[8][5]
.
          MOVE      SP70,MTHDTE[9][1]
          MOVE      SP70,MTHDTE[9][2]
          MOVE      SP70,MTHDTE[9][3]
          MOVE      SP70,MTHDTE[9][4]
          MOVE      SP70,MTHDTE[9][5]
.
          MOVE      SP70,MTHDTE[10][1]
          MOVE      SP70,MTHDTE[10][2]
          MOVE      SP70,MTHDTE[10][3]
          MOVE      SP70,MTHDTE[10][4]
          MOVE      SP70,MTHDTE[10][5]
.
          MOVE      SP70,MTHDTE[11][1]
          MOVE      SP70,MTHDTE[11][2]
          MOVE      SP70,MTHDTE[11][3]
          MOVE      SP70,MTHDTE[11][4]
          MOVE      SP70,MTHDTE[11][5]
.
          MOVE      SP70,MTHDTE[12][1]
          MOVE      SP70,MTHDTE[12][2]
          MOVE      SP70,MTHDTE[12][3]
          MOVE      SP70,MTHDTE[12][4]
          MOVE      SP70,MTHDTE[12][5]
.
          MOVE      SP70,SESSTIME
          MOVE      SP70,SESMHOSP
          MOVE      SP70,SESMTHET
          MOVE      SP70,SESMTIME
.
          MOVE      ZERO,LASTITEM                                      *I-50678
.
          MOVE      ZERO,OVERRID1
          MOVE      ZERO,OVERRID2
          MOVE      ZERO,OVERRID3
          MOVE      ZERO,OVERRID4
          MOVE      ZERO,OVERRID5
          MOVE      ZERO,OVERRID6
.
          MOVE      SP70,TOEDDATE
          MOVE      Z70,TEAMUPDT
.
          MOVE      ONE,TEAMNUMB
.
CLRPAR99  RETURN
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "specupdt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SPECUPDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showyear=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWYEAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fromdate=",QRYNAME
          IF        @EQUAL
.           MOVE      QRYDATA,FROMDATE
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      FROMDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",FROMDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "respnvar=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESPNVAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesstime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesmthet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESMTHET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesmhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESMHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesmtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESMTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opsem",QRYNAME
          IF        @EQUAL
            CALL      STSEM000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "opses",QRYNAME
          IF        @EQUAL
            CALL      STSES000
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "date",QRYNAME       * Will contain a date
          IF        @EQUAL
            CALL      STMON000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbcommnt=",QRYNAME                                *I-50678
          IF        @EQUAL
            CALL      GETSBC00           * Get session based comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID5
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "overrid6=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRID6
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "toeddate=",QRYNAME
          IF        @EQUAL
.           MOVE      QRYDATA,TOEDDATE
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      TOEDDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",TOEDDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actvfilt=",QRYNAME
          IF        @EQUAL
            PACK      ACTVFILT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "teamupdt=",QRYNAME
          IF        @EQUAL
            PACK      TEAMUPDT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 1 - Session Schedule Maintenance 
.-------------------------------------------------------------------------------
STSEM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STSEM001,STSEM002,STSEM003,STSEM004,STSEM005,STSEM006:
                       STSEM007,STSEM008,STSEM009,STSEM010,STSEM011,STSEM012:
                       STSEM013,STSEM014,STSEM015,STSEM016,STSEM017,STSEM018:
                       STSEM019
.                                           * STSEM014-017 ADDED BY HPS
          GOTO      STSEM999
.
STSEM001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,OPSEM001
          PACK      OPSEM001,OPSEM001,SP70
          GOTO      STSEM999
.
STSEM002  MOVE      QRYDATA,OPSEM002
          PACK      OPSEM002,OPSEM002,SP70
          GOTO      STSEM999
STSEM003  MOVE      QRYDATA,OPSEM003
          PACK      OPSEM003,OPSEM003,SP70
          GOTO      STSEM999
STSEM004  MOVE      QRYDATA,OPSEM004
          GOTO      STSEM999
STSEM005  MOVE      QRYDATA,OPSEM005
          GOTO      STSEM999
STSEM006  MOVE      QRYDATA,OPSEM006
          GOTO      STSEM999
STSEM007  MOVE      QRYDATA,OPSEM007
          PACK      OPSEM007,OPSEM007,SP70
          GOTO      STSEM999
STSEM008  MOVE      QRYDATA,OPSEM008
          GOTO      STSEM999
STSEM009  MOVE      QRYDATA,OPSEM009
          GOTO      STSEM999
STSEM010  MOVE      QRYDATA,OPSEM010
          GOTO      STSEM999
STSEM011  MOVE      QRYDATA,OPSEM011
          GOTO      STSEM999
STSEM012  MOVE      QRYDATA,OPSEM012
          GOTO      STSEM999
STSEM013  MOVE      QRYDATA,OPSEM013
          GOTO      STSEM999
.                                           * HPS Code Starts Here
STSEM014  MOVE      QRYDATA,OPSEM014
          GOTO      STSEM999
.
STSEM015  MOVE      QRYDATA,OPSEM015
          GOTO      STSEM999
.
STSEM016  MOVE      QRYDATA,OPSEM016
          GOTO      STSEM999
.
STSEM017  MOVE      QRYDATA,OPSEM017
          GOTO      STSEM999
.                                           * HPS Code Ends Here
STSEM018  MOVE      QRYDATA,OPSEM018
          GOTO      STSEM999
.                                           * HPS Code Ends Here
STSEM019  MOVE      QRYDATA,OPSEM019
          PACK      OPSEM019,OPSEM019,SP70
          GOTO      STSEM999
.                                          
STSEM999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 2 - Existing Session Details     
.-------------------------------------------------------------------------------
STSES000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STSES001,STSES002,STSES003,STSES004,STSES005,STSES006:
                       STSES007,STSES008,STSES009,STSES010,STSES011,STSES012:
                       STSES013,STSES014,STSES015,STSES016,STSES017,STSES018:
                       STSES019,STSES020,STSES021,STSES022,STSES023,STSES024:
                       STSES025,STSES026,STSES027,STSES028,STSES029,STSES030:
                       STSES031,STSES032,STSES033,STSES034,STSES035,STSES036:
                       STSES037,STSES038,STSES039,STSES040,STSES041,STSES042:
                       STSES043,STSES044,STSES045,STSES046,STSES047,STSES048:
                       STSES049,STSES050,STSES051,STSES052,STSES053,STSES054:
                       STSES055,STSES056,STSES057,STSES058,STSES059,STSES060:
                       STSES061,STSES062,STSES063,STSES064:
.                                           * HPS Code Starts Here
                       STSES065,STSES066,STSES067,STSES068,STSES069,STSES070:
.                                           * HPS Code Ends Here
                       STSES071,STSES072,STSES073,STSES074,STSES075,STSES076:
                       STSES077,STSES078,STSES079,STSES080,STSES081,STSES082:
                       STSES083,STSES084,STSES085
.
          GOTO      STSES999
.
STSES001  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3         * Date in the correct format CCYYMMDD
          IF        @EQUAL
            MOVE      QRYDATA,OPSES001
          ELSE
            MOVE      QRYDATA,KEY11
            PACK      KEY11,KEY11,SP70 * Date in format...eg: (10 Jun 1999)
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPSES001,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPSES001 * Date format changed back to 0000,00,00
            ENDIF
          ENDIF
          GOTO      STSES999  
.
STSES002  MOVE      QRYDATA,OPSES002
          GOTO      STSES999
STSES003  MOVE      QRYDATA,OPSES003
          PACK      OPSES003,OPSES003,SP70
          GOTO      STSES999
STSES004  MOVE      QRYDATA,OPSES004
          GOTO      STSES999
STSES005  MOVE      QRYDATA,OPSES005
          GOTO      STSES999
.
STSES006  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3         * Date in the correct format CCYYMMDD
          IF        @EQUAL
            MOVE      QRYDATA,OPSES006
          ELSE
            MOVE      QRYDATA,KEY11
            PACK      KEY11,KEY11,SP70 * Date in format...eg: (10 Jun 1999)
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPSES006,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPSES006 * Date format changed back to 0000,00,00
            ENDIF
          ENDIF
          GOTO      STSES999
.
STSES007  MOVE      QRYDATA,OPSES007
          GOTO      STSES999
STSES008  MOVE      QRYDATA,OPSES008
          GOTO      STSES999
STSES009  MOVE      QRYDATA,OPSES009
          GOTO      STSES999
STSES010  MOVE      QRYDATA,OPSES010
          GOTO      STSES999
STSES011  MOVE      QRYDATA,OPSES011
          GOTO      STSES999
STSES012  MOVE      QRYDATA,OPSES012
          GOTO      STSES999
STSES013  MOVE      QRYDATA,OPSES013
          PACK      OPSES013,OPSES013,SP70
          GOTO      STSES999
STSES014  MOVE      QRYDATA,OPSES014
          GOTO      STSES999
STSES015  MOVE      QRYDATA,OPSES015
          GOTO      STSES999
STSES016  MOVE      QRYDATA,OPSES016
          GOTO      STSES999
STSES017  MOVE      QRYDATA,OPSES017
          GOTO      STSES999
STSES018  MOVE      QRYDATA,OPSES018
          GOTO      STSES999
STSES019  MOVE      QRYDATA,OPSES019
          GOTO      STSES999
STSES020  MOVE      QRYDATA,OPSES020
          GOTO      STSES999
STSES021  MOVE      QRYDATA,OPSES021
          GOTO      STSES999
STSES022  MOVE      QRYDATA,OPSES022
          GOTO      STSES999
STSES023  MOVE      QRYDATA,OPSES023
          GOTO      STSES999
STSES024  MOVE      QRYDATA,OPSES024
          GOTO      STSES999
STSES025  MOVE      QRYDATA,OPSES025
          GOTO      STSES999
STSES026  MOVE      QRYDATA,OPSES026
          GOTO      STSES999
STSES027  MOVE      QRYDATA,OPSES027
          GOTO      STSES999
STSES028  MOVE      QRYDATA,OPSES028
          GOTO      STSES999
STSES029  MOVE      QRYDATA,OPSES029
          GOTO      STSES999
STSES030  MOVE      QRYDATA,OPSES030
          GOTO      STSES999
STSES031  MOVE      QRYDATA,OPSES031
          GOTO      STSES999
STSES032  MOVE      QRYDATA,OPSES032
          GOTO      STSES999
STSES033  MOVE      QRYDATA,OPSES033
          GOTO      STSES999
STSES034  MOVE      QRYDATA,OPSES034
          GOTO      STSES999
STSES035  MOVE      QRYDATA,OPSES035
          GOTO      STSES999
STSES036  MOVE      QRYDATA,OPSES036
          GOTO      STSES999
STSES037  MOVE      QRYDATA,OPSES037
          GOTO      STSES999
STSES038  MOVE      QRYDATA,OPSES038
          GOTO      STSES999
STSES039  MOVE      QRYDATA,OPSES039
          GOTO      STSES999
STSES040  MOVE      QRYDATA,OPSES040
          GOTO      STSES999
STSES041  MOVE      QRYDATA,OPSES041
          GOTO      STSES999
STSES042  MOVE      QRYDATA,OPSES042
          GOTO      STSES999
STSES043  MOVE      QRYDATA,OPSES043
          GOTO      STSES999
STSES044  MOVE      QRYDATA,OPSES044
          GOTO      STSES999
STSES045  MOVE      QRYDATA,OPSES045
          GOTO      STSES999
STSES046  MOVE      QRYDATA,OPSES046
          GOTO      STSES999
STSES047  MOVE      QRYDATA,OPSES047
          GOTO      STSES999
STSES048  MOVE      QRYDATA,OPSES048
          GOTO      STSES999
STSES049  MOVE      QRYDATA,OPSES049
          GOTO      STSES999
STSES050  MOVE      QRYDATA,OPSES050
          GOTO      STSES999
STSES051  MOVE      QRYDATA,OPSES051
          GOTO      STSES999
STSES052  MOVE      QRYDATA,OPSES052
          GOTO      STSES999
STSES053  MOVE      QRYDATA,OPSES053
          GOTO      STSES999
STSES054  MOVE      QRYDATA,OPSES054
          GOTO      STSES999
STSES055  MOVE      QRYDATA,OPSES055
          GOTO      STSES999
STSES056  MOVE      QRYDATA,OPSES056
          GOTO      STSES999
STSES057  MOVE      QRYDATA,OPSES057
          GOTO      STSES999
STSES058  MOVE      QRYDATA,OPSES058
          GOTO      STSES999
STSES059  MOVE      QRYDATA,OPSES059
          GOTO      STSES999
STSES060  MOVE      QRYDATA,OPSES060
          GOTO      STSES999
STSES061  MOVE      QRYDATA,OPSES061
          GOTO      STSES999
STSES062  MOVE      QRYDATA,OPSES062
          GOTO      STSES999
STSES063  MOVE      QRYDATA,OPSES063
          GOTO      STSES999
STSES064  MOVE      QRYDATA,OPSES064
          GOTO      STSES999
.
.                                           * HPS Code Starts Here
STSES065  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3         * Date in the correct format CCYYMMDD
          IF        @EQUAL
            MOVE      QRYDATA,OPSES065
          ELSE
            MOVE      QRYDATA,KEY11
            PACK      KEY11,KEY11,SP70 * Date in format...eg: (10 Jun 1999)
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPSES065,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPSES065 * Date format changed back to 0000,00,00
            ENDIF
          ENDIF
          GOTO      STSES999
.
STSES066  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3         * Date in the correct format CCYYMMDD
          IF        @EQUAL
            MOVE      QRYDATA,OPSES066
          ELSE
            MOVE      QRYDATA,KEY11
            PACK      KEY11,KEY11,SP70 * Date in format...eg: (10 Jun 1999)
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPSES066,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPSES066 * Date format changed back to 0000,00,00
            ENDIF
          ENDIF
          GOTO      STSES999
.
STSES067  MOVE      QRYDATA,OPSES067
          GOTO      STSES999
.
STSES068  MOVE      QRYDATA,OPSES068
          GOTO      STSES999
.
STSES069  MOVE      QRYDATA,OPSES069
          GOTO      STSES999
.
STSES070  MOVE      QRYDATA,OPSES070
          GOTO      STSES999
.                                           * HPS Code Ends Here
STSES071  MOVE      QRYDATA,OPSES071
          GOTO      STSES999
.                                          
STSES072  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      OPSES072,CCENT,CYEAR,CMON,CDAY
          GOTO      STSES999
.
STSES073  MOVE      QRYDATA,OPSES073
          GOTO      STSES999
.                                          
STSES074  PACK      OPSES074,QRYDATA,SP70
          GOTO      STSES999
.
STSES075  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      OPSES075,CCENT,CYEAR,CMON,CDAY
          GOTO      STSES999
.
STSES076  MOVE      QRYDATA,OPSES076
          GOTO      STSES999           
.
STSES077  MOVE      QRYDATA,OPSES077
          GOTO      STSES999
.                                          
STSES078  MOVE      QRYDATA,OPSES078
          GOTO      STSES999
.                                          
STSES079  MOVE      QRYDATA,OPSES079
          GOTO      STSES999
.                                          
STSES080  MOVE      QRYDATA,OPSES080
          GOTO      STSES999
.                                          
STSES081  MOVE      QRYDATA,OPSES081
          GOTO      STSES999
.                                          
STSES082  MOVE      QRYDATA,OPSES082
          GOTO      STSES999
.                                          
STSES083  MOVE      QRYDATA,OPSES083
          GOTO      STSES999
.                                          
STSES084  MOVE      QRYDATA,OPSES084
          GOTO      STSES999
.
STSES085  MOVE      QRYDATA,OPSES085
          GOTO      STSES999
.                                          
STSES999  RETURN
.------------------------------------------------------------
. Set Parameters for Option 3: Theatre New/Open Session Details
.           ******* January...December ********
.------------------------------------------------------------
STMON000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY4,MONTH,KEY2
          MOVE      MONTH,MONTHNO
          MOVE      KEY2,F2
          PACK      MTHDTE[MONTHNO][F2],QRYDATA,SP70
.
STMON999  RETURN
.----------------------------------------------------------------
. Operating Room - Session Schedule: Display,Add,Update,Delete
.----------------------------------------------------------------
OPRSEM00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      OPRSEM40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      OPRSEM10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      OPRSEM20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      OPRSEM30 IF EQUAL
.
          MATCH     "G",UPDTTYPE    * Global Change
          GOTO      OPRSEM50 IF EQUAL
.
          GOTO      OPRSEM93
.
.         ************ ADD FORMACTION ***********
.
OPRSEM10  CALL      CHKSEM00      * Checks mandatory fields
          BRANCH    EXIT,OPRSEM99
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          CALL      RDOPSEM1
          COMPARE   ZERO,OVRCD
          GOTO      OPRSEM92 IF EQUAL
.
          CALL      SEMTME00      * Check Session Times
          BRANCH    EXIT,OPRSEM99
.
          CALL      SAVSEM00      * Moves input variables to file variables
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          CALL      WROPSEM1      * Writes away the data
.
          MOVE      "A",KEY1      * Set Add Parameter for SEMAUD00    
          CALL      SEMAUD00      * Write Audit File if Needed    
.
          MOVE      ZERO,EXIT
          GOTO      OPRSEM99
.
.         ************ UPDATE FORMACTION **********
.
OPRSEM20  PACK      KEY21,SESMHOSP,OPSEM001,OPSEM002,SESMTIME,SESMTHET,SP70
          CALL      RDOPSEM1
          BRANCH    OVRCD,OPRSEM91
          PACK      SAVKEY21,KEY21
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          MATCH     KEY21,SAVKEY21
          IF        !@EQUAL
            CALL      RAOPSEM1
            IF        OVRCD<>1
              GOTO      OPRSEM96
            ENDIF
          ENDIF
          PACK      KEY21,SESMHOSP,OPSEM001,OPSEM002,SESMTIME,SESMTHET,SP70
          CALL      RDOPSEM1
          BRANCH    OVRCD,OPRSEM91
          CALL      CHKSEM00      * Checks mandatory fields
          BRANCH    EXIT,OPRSEM99
.
          CALL      SEMTME00      * Check Session Times
          BRANCH    EXIT,OPRSEM99
.
          MOVE      "B",KEY1      * Set Before Changes Parameter for SEMAUD00 
          CALL      SEMAUD00      * Write Audit File if Needed  
.
          MOVE      ZERO,DGSUPFLG      * Reset Day/General Surg. update flag
          MATCH     OPSEM018,OPSMDGSI  * Same Day/General Surgery Ind?
          IF        !@EQUAL
            MOVE      ONE,DGSUPFLG     * No, set update flag for UPDSES00
          ENDIF
         
          CALL      SAVSEM00      * Moves input variables to file variables
          CALL      UPOPSEM1      * Writes away the data
.
          MOVE      "C",KEY1      * Set After Changes Parameter for SEMAUD00    
          CALL      SEMAUD00      * Write Audit File if Needed  
.
          CALL      UPDSES00      * Update Open Session for Instructions
.
          MOVE      ZERO,EXIT
          GOTO      OPRSEM99
.
.         ************ DELETE FORMACTION **********
.
OPRSEM30  PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          CALL      RDOPSEM1
          BRANCH    OVRCD,OPRSEM91
.
          CALL      SESDTE00      * Checks if any Session Dates exist?
          BRANCH    EXIT,OPRSEM99
.
          CALL      DEOPSEM1
.
          MOVE      "D",KEY1      * Set Delete Parameter for SEMAUD00    
          CALL      SEMAUD00      * Write Audit File if Needed   
.
          MOVE      ZERO,EXIT
          GOTO      OPRSEM99
.
.         ************ DISPLAY FORMACTION **********
.
OPRSEM40  IF        OPCNCLSU = 1 
            PACK      KEY6,OPSEM001    * Using Doctor Code
            CALL      RDDOCT1
            BRANCH    OVRCD,OPRSEM94
            MOVE      DCODE,CLINCODE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,CLINDESC
          ELSE
            PACK      KEY6,OPSEM001    * Using Session Clinic Code
            CALL      RDOPCLI1
            BRANCH    OVRCD,OPRSEM95           
            MOVE      OPCLCLIN,CLINCODE
            MOVE      OPCLDESC,CLINDESC
          ENDIF 
.
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          CALL      RDOPSEM1
          IF        OVRCD=1
            CALL      CLRSEM00  * Clear all the file variables
          ENDIF
          MOVE      OPSMTIME,SESMTIME
          MOVE      OPSMTHET,SESMTHET
          MOVE      OPSMHOSP,SESMHOSP
.
          CLEAR     WEBTITLE
          MOVE      "Theatre Session Schedule Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,OPRSEM99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
.         ************ GLOBAL CHANGE **********
.
OPRSEM50  CALL      GLUSES00
.
          MOVE      ZERO,EXIT
          GOTO      OPRSEM99
.
OPRSEM91  MOVE      "Session Schedule record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM92  MOVE      "Session Schedule record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM94  MOVE      "Invalid Doctor Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM95  MOVE      "Invalid Clinic.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM96  MOVE      "Session already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSEM99
.
OPRSEM99  RETURN
.----------------------------------------------------------------------------
. Update any Open Sessions with Instructions and/or 
. Day/General Surgery Indicator from Session Master.
. If both SPECUPDT and DGSUPFLG are ZERO, update is not performed.
.
. INPUTS: SPECUPDT - Flag for update Instructions, ZERO = don't update.
.         DGSUPFLG - Flag for update Day/Gen Surg Ind, ZERO = don't update
.----------------------------------------------------------------------------
UPDSES00  COMPARE   ZERO,SPECUPDT           * Update Instructions? 
          GOTO      UPDSES10 IF NOT EQUAL   * Not ZERO = Yes, go to update
.                                         
          COMPARE   ZERO,DGSUPFLG           * Update Day/General Surgery Ind?
          GOTO      UPDSES99 IF EQUAL       * No, both falgs ZERO - go to exit.
.
UPDSES10  PACK      KEY8,CCC,CYY,CMM,CDD
          REPLACE   " 0",KEY8
.
          PACK      KEY22,OPSMCLIN,OPSMHOSP,KEY8,SP70
          CALL      RSOPSES2
UPDSES20  CALL      RKOPSES2
          BRANCH    OVRCD,UPDSES99
.
          MATCH     OPSECLIN,OPSMCLIN
          GOTO      UPDSES99 IF NOT EQUAL
.
          MATCH     OPSEHOSP,OPSMHOSP
          GOTO      UPDSES99 IF NOT EQUAL
.
          COMPARE   OPSEDAY,OPSMDAYI
          GOTO      UPDSES20 IF NOT EQUAL
.
          MATCH     OPSETIME,OPSMTIME
          GOTO      UPDSES20 IF NOT EQUAL
.
          MATCH     OPSETHET,OPSMTHET       * Operating room
          GOTO      UPDSES20 IF NOT EQUAL
.
          COMPARE   ZERO,SPECUPDT           * Update Instructions?
          GOTO      UPDSES30 IF EQUAL       * No, do not set Instruction fields
.
          MOVE      OPSMSPI1,OPSESPI1
          MOVE      OPSMSPI2,OPSESPI2
          MOVE      OPSMANAE,OPSEANAE       * Update Anaesthetist
          MOVE      OPSMANAE,OPSEDCC2
          MOVE      OPSMXDOC,OPSEXDOC
.
UPDSES30  COMPARE   ZERO,DGSUPFLG           * Update Day/Gen Surg Ind?
          GOTO      UPDSES40 IF EQUAL       * No, do not set Day/Gen Surg Ind.
.
          MOVE      OPSMDGSI,OPSEDGSI
.
UPDSES40  CALL      UPOPSES2
          GOTO      UPDSES20 
.
UPDSES99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRSEM00  MOVE      SP70,OPSMCLIN    * Clinic/Surgeon
          MOVE      ZERO,OPSMDAYI    * Day Indicator Mon...Sun
          MOVE      SP70,OPSMTIME    * Start Time
          MOVE      ZERO,OPSMFTYP    * Frequency Type  0=Month 1=Year
          MOVE      SP70,OPSMMRFQ    * Month Frequency
          MOVE      SP70,OPSMYRFQ    * Year Frequency
          MOVE      ZERO,OPSMDURA    * Duration
          MOVE      SP70,OPSMTPER    * Time Period (Category SP)
          MOVE      SP70,OPSMTYPE    * Session Type (Category ST)
          MOVE      SP70,OPSMTHET    * Operating Room Code
          MOVE      SP70,OPSMENDT    * End Time of Session
          MOVE      ZERO,OPSMBRKT    * Time for Breaks (min)
          MOVE      ZERO,OPSMPREP    * Preparation time /patient
          MOVE      SP70,OPSMANAE    * Usual Anaesthetic
          MOVE      SP70,OPSMXDOC    * Extra doctor for team
          MOVE      ZERO,OPSMSTAT    * Status   0 = Active 1 = Inactive
.                                      HPS Code Starts Here
          MOVE      SP70,OPSMSPI1    * Special Instructions1
          MOVE      SP70,OPSMSPI2    * Special Instructions2
          MOVE      SP70,OPSMNDLK    * Number of daysto lock session
          MOVE      SP70,OPSMSTYP    * Session Type(Category TU)
.                                      HPS Code Ends Here
          MOVE      SP70,OPSMDGSI    * Day/General Surgery Indicator
          MOVE      SP70,OPSMHOSP    * Spare
          MOVE      SP70,OPSMSPAR    * Spare
.
CLRSEM99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
SAVSEM00  MOVE      OPSEM001,OPSMCLIN    * Clinic/Surgeon
          MOVE      OPSEM002,OPSMDAYI    * Day Indicator Mon...Sun
          MOVE      OPSEM003,OPSMTIME    * Start Time
          MOVE      ZERO,OPSMFTYP    * Frequency Type  0=Month 1=Year
          MOVE      SP70,OPSMMRFQ    * Month Frequency
          MOVE      SP70,OPSMYRFQ    * Year Frequency
          MOVE      OPSEM004,OPSMDURA    * Duration
          MOVE      OPSEM005,OPSMTPER    * Time Period (Category SP)
          MOVE      OPSEM006,OPSMTYPE    * Session Type (Category ST)
          MOVE      OPSEM007,OPSMTHET    * Operating Room Code
          MOVE      OPSEM008,OPSMENDT    * End Time of Session
          MOVE      OPSEM009,OPSMBRKT    * Time for Breaks (min)
          MOVE      OPSEM010,OPSMPREP    * Preparation time /patient
          MOVE      OPSEM011,OPSMANAE    * Usual Anaesthetic
          MOVE      OPSEM012,OPSMXDOC    * Extra doctor for team
.
          COMPARE   TWO,OPSEM013         * Status 0 = Active 1 = Non-Active
          IF        @EQUAL
            MOVE      ZERO,OPSMSTAT   
          ELSE 
            MOVE      ONE,OPSMSTAT
          ENDIF
.
.                                           * HPS Code Starts Here
          MOVE      OPSEM014,OPSMSPI1       * Special Instruction 1
          MOVE      OPSEM015,OPSMSPI2       * Special Instruction 2
          MOVE      OPSEM016,OPSMNDLK       * Number of days to lock session
          MOVE      OPSEM017,OPSMSTYP       * Session Type
.                                           * HPS Code Ends Here
          MOVE      OPSEM018,OPSMDGSI       * Day/General Surgery Indicator
          MOVE      OPSEM019,OPSMHOSP       * Multi-Hospital Id
          MOVE      SP70,OPSMSPAR        * Spare
.
SAVSEM99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKSEM00  RESET     OPSEM001
          MATCH     SP70,OPSEM001
          GOTO      CHKSEM80 IF EQUAL
.
          RESET     OPSEM002
          MATCH     SP70,OPSEM002
          GOTO      CHKSEM81 IF EQUAL
.
          RESET     OPSEM003
          MATCH     SP70,OPSEM003
          GOTO      CHKSEM82 IF EQUAL
.
          RESET     OPSEM008
          MATCH     SP70,OPSEM008
          GOTO      CHKSEM83 IF EQUAL
.
          COMPARE   ZERO,OPSEM004
          GOTO      CHKSEM84 IF EQUAL
.
          RESET     OPSEM005
          MATCH     SP70,OPSEM005
          GOTO      CHKSEM87 IF EQUAL
.
          RESET     OPSEM006
          MATCH     SP70,OPSEM006
          GOTO      CHKSEM88 IF EQUAL
.
          GOTO      CHKSEM98
.
CHKSEM80  MOVE      "Clinic Surgeon is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM81  MOVE      "Day of week is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM82  MOVE      "Start Time is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM83  MOVE      "End Time is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM84  MOVE      "Time Duration is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM87  MOVE      "Time Period is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.
CHKSEM88  MOVE      "Unit is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.                                           * HPS Code Starts Here
CHKSEM89  MOVE      "Session Type is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEM99
.                                           * HPS Code Ends Here
CHKSEM98  MOVE      ZERO,EXIT
CHKSEM99  RETURN
.--------------------------------------------------------------------
.                         SEMTME00
. Make Sure End Time > Start time & Duration > Rest Time & Prep Time
.                                                called by: OPRSEM00
.--------------------------------------------------------------------
SEMTME00  UNPACK    OPSEM003,KEY2,KEY1,MIN   * Start Time (HH:MM)
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,STARTIME            * Change to a form (HHMM)
.
          UNPACK    OPSEM008,KEY2,KEY1,MIN   * Session End Time (HH:MM)
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,FINSHTME            * Change to a form (HHMM)
.
          IF        FINSHTME < STARTIME
            GOTO      SEMTME90
          ENDIF
.
          IF        OPSEM004 < OPSEM009     
            GOTO      SEMTME91               * Duration > Time for Breaks
          ENDIF
.
          IF        OPSEM004 < OPSEM010     
            GOTO      SEMTME92               * Duration > Prep Time
          ENDIF
.
          GOTO      SEMTME98
.
SEMTME90  MOVE      "End Session Time must be after Session ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Start Time!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SEMTME99
.
SEMTME91  MOVE      "Time for breaks must be less than Duration ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SEMTME99
.
SEMTME92  MOVE      "Prep Time must be less than Duration ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SEMTME99
.
SEMTME98  MOVE      ZERO,EXIT
SEMTME99  RETURN
.----------------------------------------------------------------------
.                            SESDTE00
.    Checks whether an open sessions date/s exist for the schedule.
.    IF yes the moves 1 to EXIT else move ZERO to EXIT
.----------------------------------------------------------------------
SESDTE00  PACK      KEY22,OPSEM001,OPSEM019,SP70
          CALL      RSOPSES2
SESDTE10  CALL      RKOPSES2
          BRANCH    OVRCD,SESDTE98
.
          MATCH     OPSEM001,OPSECLIN      * Match on Clinic/Doctor 
          GOTO      SESDTE98 IF NOT EQUAL
.
          MATCH     OPSEM019,OPSEHOSP      * Check Hospital
          GOTO      SESDTE10 IF NOT EQUAL
.
          MOVE      OPSEDAY,KEY1
          MATCH     OPSEM002,KEY1          * Match on Day of Week
          GOTO      SESDTE10 IF NOT EQUAL
.
          MATCH     OPSEM003,OPSETIME      * Match on Start Time
          GOTO      SESDTE10 IF NOT EQUAL
.
SESDTE90  MOVE      "Cannot Perform Delete as a Open Session Date/s ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Exists!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SESDTE99
.
SESDTE98  MOVE      ZERO,EXIT
SESDTE99  RETURN
.---------------------------------------------------------------------
. Writes Operating Room - Schedule Audit
.    Parameters :   KEY1 - Set Record Type
.---------------------------------------------------------------------
SEMAUD00  BRANCH    OPCNAUDM,SEMAUD99  * Check if audit needs to be written
.
          CALL      IBACLOCK
          PACK      OPSMAUDD,CCC,CYY,CMM,CDD     * Date
          REP       " 0",OPSMAUDD
          MOVE      CTIMEIS,OPSMAUDT
          MOVE      PORT,OPSMAUDP                * Port
          MOVE      KEY1,OPSMAUDR                * Record Type
          MOVE      ONE,OPSMAUDS                 * Not Printed
          MOVE      PASSCODE,OPSMAUDO            * Operator
.
          PACK      KEY19,OPSMAUDD,OPSMAUDT,OPSMAUDP,OPSMAUDR
          CALL      AWOPSEM                      * Write Audit File
.
SEMAUD99  RETURN
.---------------------------------------------------------------------
. Existing Session Details: Display,Add,Update,Delete
.---------------------------------------------------------------------
OPRSES00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      OPRSES40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      OPRSES10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      OPRSES20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      OPRSES30 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Cancel Session formaction
          GOTO      OPRSES60 IF EQUAL
.
          MATCH     "F",UPDTTYPE    * Finalise Session formaction
          GOTO      OPRSES65 IF EQUAL
.
          MATCH     "P",UPDTTYPE    * Reset Finalised session back to Prov forma
          GOTO      OPRSES67 IF EQUAL
.
          MATCH     "M",UPDTTYPE    * Move Session formaction
          GOTO      OPRSES70 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Reinstate session
          GOTO      OPRSES75 IF EQUAL
.
          MATCH     "S",UPDTTYPE    * Session Based Comments
          GOTO      OPRSES80 IF EQUAL
.
          MATCH     "T",UPDTTYPE    * Day Comments
          GOTO      OPRSES81 IF EQUAL
.
          GOTO      OPRSES93
.
.         ************ ADD FORMACTION ***********
.
OPRSES10  CALL      CHKSES00      * Checks mandatory fields
          BRANCH    EXIT,OPRSES99
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          COMPARE   ZERO,OVRCD
          GOTO      OPRSES92 IF EQUAL
.
          CALL      SESTME00      * Check Session Times  
          BRANCH    EXIT,OPRSES99
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003 
.                                                    * get entered key data
          UNPACK    KEY22,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          MOVE      OPSES013,OPSETHET       * the theatre code
          MOVE      OPSES007,OPSEENDT        * the end time
          CALL      OPRCLASH
          BRANCH    EXIT,OPRSES99
.
          CALL      CLRDEF00
          CALL      SAVSES00      * Moves input variables to file variables
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      WROPSES1      * Writes away the data
.
          MOVE      "A",KEY1      * Set Add Parameter for SESAUD00    
          CALL      SESAUD00      * Write Audit File if Needed    
.
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.         ************ UPDATE FORMACTION **********
.
OPRSES20  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          PACK      SAVKEY22,OPSES074,OPSES001,SESSTIME,OPSES003,SP70
.
          MATCH     KEY22,SAVKEY22
          GOTO      OPRSES22 IF EQUAL
.
          CALL      RDOPSES1      * Check to see if new session details exist
          COMPARE   ZERO,OVRCD
          GOTO      OPRSES92 IF EQUAL
.
OPRSES22  PACK      KEY22,OPSES074,OPSES001,SESSTIME,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          CALL      CHKSES00      * Checks mandatory fields
          BRANCH    EXIT,OPRSES99
.
          CALL      SESTME00      * Check Session Times  
          BRANCH    EXIT,OPRSES99
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003 
.                                                     * get entered key data
          UNPACK    KEY22,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          MOVE      OPSES013,OPSETHET       * the theatre code
          MOVE      OPSES007,OPSEENDT        * the end time
          CALL      OPRCLASH
          BRANCH    EXIT,OPRSES99
.
          PACK      KEY22,SAVKEY22,SP70
          CALL      RDOPSES1
.
          MOVE      "B",KEY1      * Set Before Changes Parameter for SESAUD00 
          CALL      SESAUD00      * Write Audit File if Needed  
.
          MATCH     "1",OPSEDTCM  * Default Team already completed?
          IF        @EQUAL
            MOVE      ONE,UPDTFLAG
          ELSE
            MOVE      ZERO,UPDTFLAG
          ENDIF
.
.         Save the current Anaesthetist code so we can check later if this
.         has been changed (Task: 0851661 - HL7TRGID = 5)
.
          MOVE      OPSEANAE,SAVEANAE
.
          CALL      MOVSES00           * Moves input variables to file variables
.
          PACK      OPSEDCC2,OPSEDCC2,SP70
          PACK      OPSETYD2,OPSETYD2,SP70
          MATCH     SP70,OPSEDCC2
          IF        !@EQUAL
            MATCH      OPSEANAE,OPSEDCC2
            IF         @EQUAL
              MATCH      SP70,OPSETYD2
              IF         @EQUAL
                CALL       GTANAE00         * Get Anaethetist code
                MOVE       ACODE,OPSETYD2   *             # 2 (Category OP)
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      OPSES009,OPSEBRKT  * Overwrite default move behaviour
.
          MATCH     SP70,OPSES078      * Not setting 'Default Team Completed'?
          GOTO      OPRSES24 IF EQUAL
.
          MATCH     "0",OPSES078
          IF          @EQUAL
            CALL      CLRDEF00         * Clear Default Team Completed fields
          ELSE
            COMPARE   ONE,UPDTFLAG
            IF        @EQUAL
              MOVE      WBSEUID,OPSEUUDT    * User who updated Default Team
              PACK      OPSEDUDT,CCC,CYY,CMM,CDD * Date Default Team Updated
              REP       " 0",OPSEDUDT
              CLOCK     TIME,OPSETUDT            * Time Default Team Updated
            ELSE
              MOVE      WBSEUID,OPSEUCDT    * User who completed Default Team
              PACK      OPSEDCDT,CCC,CYY,CMM,CDD * Date Default Team completed
              REP       " 0",OPSEDCDT
              CLOCK     TIME,OPSETCDT            * Time Default Team completed
            ENDIF
          ENDIF
.
OPRSES24  CALL      GETANA00      * Gets anaesthetist code from default team
.                                 * details if available
          MATCH     "006",TEMPLATE
          IF        @EQUAL
            CALL      ACTDUR00      * Calculate Actual Session Duration
          ENDIF
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      UPOPSES1      * Writes away the data
.
          MATCH     KEY22,SAVKEY22
          IF        @EQUAL
            CALL      UPEXDT00      * Update existing oprdetaf with new opr room
          ELSE
            MOVE      SAVKEY22,KEY22 * Restore original session key
            CALL      MPST0000       * Update bookings if session start time
.                                    * has changed
          ENDIF
.
OPRSES25  MOVE      "C",KEY1      * Set After Changes Parameter for SESAUD00    
          CALL      SESAUD00      * Write Audit File if Needed  
.
          CALL      UPDCOM00      * Update Session Based Comments      *I-50678
.
          MATCH     "1",OPSES085 
          IF        @EQUAL
            CALL      DFTTMA00 
          ENDIF
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      OPCHKFUL           * check if session is full
          BRANCH    EXIT,OPRSES28      * exit=1 session is not full
.
          CALL      OPSUSPND           * suspend session
          GOTO      OPRSES29
.
OPRSES28  CALL      OPUNSPND           * unsuspend session
.
OPRSES29  MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.         ************ DELETE FORMACTION **********
.
OPRSES30  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          CALL      BOKCHK00      * Check if there are bookings
          BRANCH    EXIT,OPRSES87
.
          CALL      DEOPSES1
.
          MOVE      "D",KEY1      * Set Delete Parameter for SESAUD00    
          CALL      SESAUD00      * Write Audit File if Needed   
.
          CALL      CNRAL000
.
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.         ************ DISPLAY FORMACTION **********
.
OPRSES40  CALL      CLRSEM00
          MATCH     "010",TEMPLATE
          IF        @EQUAL
            UNPACK    SP70,OPSES002,OPSES003,OPSETIME,OPSECLIN
            MOVE      OPSES001,OPSEDATE
            MATCH     SP70,OPSES074
            IF        @EQUAL
              MOVE      WBSEHOSP,OPSES074
            ENDIF
            MOVE      OPSES074,OPSEHOSP
            GOTO      OPRSES42           * Day Comments
          ENDIF
.
          IF        OPCNCLSU = 1 
            PACK      KEY6,OPSES003    * Using Doctor Code
            CALL      RDDOCT1
            BRANCH    OVRCD,OPRSES94
            MOVE      DCODE,CLINCODE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,CLINDESC
          ELSE
            PACK      KEY6,OPSES003    * Using Session Clinic Code
            CALL      RDOPCLI1
            BRANCH    OVRCD,OPRSES95           
            MOVE      OPCLCLIN,CLINCODE
            MOVE      OPCLDESC,CLINDESC
          ENDIF 
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES  * Clear all the file variables
          ENDIF
          MOVE      OPSETIME,SESSTIME
.
OPRSES42  MATCH     SP70,FRSTDATE
          IF        @EQUAL
            MATCH     SP70,VYEARMTH
            IF        @EQUAL
              PACK      FRSTDATE,CCC,CYY,CMM,ZERO,ONE
              REP       " 0",FRSTDATE
              PACK      LASTDATE,CCC,CYY,CMM,THREE,ONE
              REP       " 0",LASTDATE
            ELSE
              PACK      FRSTDATE,VYEARMTH,ZERO,ONE
              REP       " 0",FRSTDATE
              PACK      LASTDATE,VYEARMTH,THREE,ONE
              REP       " 0",LASTDATE
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Existing Session Details Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,OPRSES99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
. Cancel Theatre  ( New Theatre in opses013 )
.
OPRSES60  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          PACK      SESSKEYS,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          MATCH     SP70,OPSES023
          GOTO      OPRSES90 IF EQUAL
          MOVE      "OC",CATEGORY
          PACK      KEY5,CATEGORY,OPSES023
          CALL      RDCODE1
          BRANCH    OVRCD,OPRSES90
          PACK      KEY26,SESSKEYS,SP70
          CALL      RSOPDEA1                * read the first case
OPRSES62  CALL      RKOPDEA1                * read next operation record
          IF        OVRCD=0
            PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
            MATCH     SESSKEYS,KEY22
            IF        @EQUAL
              COMPARE   THREE,OPDASTAT      * Ignore Cancelled Bookings
              GOTO      OPRSES62 IF EQUAL
              GOTO      OPRSES89 
            ENDIF
          ENDIF
.
          CALL      CANSES00
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.         ************ FINALISE FORMACTION **********
.
OPRSES65  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1      
          BRANCH    OVRCD,OPRSES91
.
          MOVE      OPSES072,OPSEFIND
          MOVE      OPSES073,OPSEFINT
          CALL      UPOPSES1
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.         ************ RESET BACK TO PROVISIONAL  FORMACTION **********
.
OPRSES67  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          MOVE      SP70,OPSEFIND
          MOVE      SP70,OPSEFINT
          CALL      UPOPSES1
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
.
. Move Theatre  ( New Theatre in opses013 )
.
OPRSES70  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          MOVE      OPSES013,KEY6
          CALL      RDOPOPR1
          BRANCH    OVRCD,OPRSES96
.
          COMPARE   ONE,OPRMSTAT
          GOTO      OPRSES97 IF EQUAL
.
          CALL      CHKTHE00
          BRANCH    EXIT,OPRSES88
.
          CALL      TOPALL00
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
. Reinstate cancelled session
.
OPRSES75  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,OPRSES91
.
          COMPARE   ZERO,OPSESTAT
          GOTO      OPRSES86 IF NOT EQUAL
.
          MOVE      "B",KEY1      * Set Before Changes Parameter for SESAUD00
          CALL      SESAUD00      * Write Audit File if Needed
.
          MATCH     "1",OPSEADTS  * Adhoc session
          IF        @EQUAL
            MOVE      TWO,OPSESTAT  * set to Extra session
          ELSE
            MOVE      ONE,OPSESTAT  * set to booked
          ENDIF
.
          MOVE      SP3,OPSECANC  * clear cancellation reason
.
          CALL      UPOPSES1
.
          MOVE      "C",KEY1      * Set Before Changes Parameter for SESAUD00
          CALL      SESAUD00      * Write Audit File if Needed
.
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
OPRSES80  CALL      SBCMN000                                           *I-50678
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
OPRSES81  CALL      DYCMN000
          MOVE      ZERO,EXIT
          GOTO      OPRSES99
.
OPRSES86  MOVE      "Session is not cancelled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES87  MOVE      "Session has Bookings. Can't Delete Session.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES88  MOVE      "New theatre already in use by ",WEBTITLE
          ENDSET    WEBTITLE
          IF        OPCNCLSU=1
            MOVE      OPSECLIN,DOCTCODE  * Using Doc
            PACK      KEY6,DOCTCODE,SP70 * Using Doctor Code
            CALL      RDDOCT1
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            APPEND    DOCFNAME,WEBTITLE
          ELSE
            MOVE      OPSECLIN,KEY6      * Using Clinic File for Session
            CALL      RDOPCLI1
            MOVE      OPCLDOCT,DOCTCODE  * Using Clinic Code
            APPEND    OPCLDESC,WEBTITLE
          ENDIF
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES89  MOVE      "Session has Bookings. Can't Cancel Session.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES90  MOVE      "Cancellation Reason Invalid.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES91  MOVE      "Session Details record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES92  MOVE      "Session Details record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES94  MOVE      "Invalid Doctor Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES95  MOVE      "Invalid Clinic.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES96  MOVE      "New Operating Room Invalid.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES97  MOVE      "New Operating Room Inactive.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES98  MOVE      "New Operating Room Conflicts.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRSES99
.
OPRSES99  CLOSE     COMFILAF,DELETE
          RETURN
.
.------------------------------------------------------------
. Default teams for all arrival patients in a session 
.------------------------------------------------------------
DFTTMA00  PACK      KEY26,SAVKEY22,SP70
          CALL      RSOPDEA1                * read the first case
DFTTMA20  CALL      RKOPDEA1                * read next operation record
          BRANCH    OVRCD,DFTTMA99
. 
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     SAVKEY22,KEY22
          GOTO      DFTTMA99 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT          * Ignore Cancelled Bookings
          GOTO      DFTTMA20 IF EQUAL
.
          PACK      KEY10,OPDAUNIQ          * Ignore patient not arrived
          CALL      RDOPARD1
          BRANCH    OVRCD,DFTTMA20 
.
          MATCH     SP70,OPARATIM           * Ignore blank arrival time 
          GOTO      DFTTMA20 IF EQUAL
.
          CALL      DLOPTM00
          CALL      DFLTTM00 
.
          GOTO      DFTTMA20
.
DFTTMA99  RETURN
.
.------------------------------------------------------------
. Delete all theatre team members for unqiue number (visit) 
.------------------------------------------------------------
DLOPTM00  PACK      KEY35,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,DLOPTM99
.
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      DLOPTM99 IF NOT EQUAL
.
          MATCH     TEAMNUMB,OPTSTMNO              * Match team number       
          GOTO      DLOPTM99 IF NOT EQUAL
.
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT,OPTSSTIM
          CALL      DEOPTSM1        
.
          GOTO      DLOPTM00
.
DLOPTM99  RETURN
.
.***************************************************************************
. Write Default Team members from Session filei for . If no default team
. specified then default Consultatnt as Operating Surgeon.
.***************************************************************************
DFLTTM00  PACK      KEY22,SAVKEY22
          CALL      RDOPSES1
          BRANCH    OVRCD,DFLTTM99
.
          MATCH     SP70,OPSEDCC1           * Default team empty?
          GOTO      DFLTTM90 IF EQUAL       * Yes, default Cons as Op.Surgeon
.
          CALL      CLOPRTSM
          MOVE      ZERO,STAFTYPE           * Set Staff Type (Operating Surg)
          MOVE      OPSEDCC1,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD1,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
          MATCH     SP70,OPSETYD2           * Second default doctor type blank?
          GOTO      DFLTTM10 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC2           * Second default doctor code blank?
          GOTO      DFLTTM10 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC2,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD2,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM10  MATCH     SP70,OPSETYD3           * Next default doctor type blank?
          GOTO      DFLTTM15 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC3           * Next default doctor code blank?
          GOTO      DFLTTM15 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC3,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD3,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM15  MATCH     SP70,OPSETYD4           * Next default doctor type blank?
          GOTO      DFLTTM20 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC4           * Next default doctor code blank?
          GOTO      DFLTTM20 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC4,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD4,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM20  MATCH     SP70,OPSETYD5           * Next default doctor type blank?
          GOTO      DFLTTM25 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC5           * Next default doctor code blank?
          GOTO      DFLTTM25 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC5,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD5,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM25  MATCH     SP70,OPSETYD6           * Next default doctor type blank?
          GOTO      DFLTTM30 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC6           * Next default doctor code blank?
          GOTO      DFLTTM30 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC6,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD6,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM30  MATCH     SP70,OPSETYD7           * Next default doctor type blank?
          GOTO      DFLTTM35 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC7           * Next default doctor code blank?
          GOTO      DFLTTM35 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC7,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD7,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM35  MATCH     SP70,OPSETYD8           * Next default doctor type blank?
          GOTO      DFLTTM40 IF EQUAL       * Yes, skip this doctor
          MATCH     SP70,OPSEDCC8           * Next default doctor code blank?
          GOTO      DFLTTM40 IF EQUAL       * Yes, skip this doctor
.
          CALL      CLOPRTSM
          MOVE      ONE,STAFTYPE            * Set Staff Type (Doctor)
          MOVE      OPSEDCC8,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYD8,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM40  MATCH     SP70,OPSETYN1           * First default nurse type blank?
          GOTO      DFLTTM45 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC1           * First default nurse code blank?
          GOTO      DFLTTM45 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC1,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN1,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM45  MATCH     SP70,OPSETYN2           * Next default nurse type blank?
          GOTO      DFLTTM50 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC2           * Next default nurse code blank?
          GOTO      DFLTTM50 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC2,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN2,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM50  MATCH     SP70,OPSETYN3           * Next default nurse type blank?
          GOTO      DFLTTM55 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC3           * Next default nurse code blank?
          GOTO      DFLTTM55 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC3,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN3,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM55  MATCH     SP70,OPSETYN4           * Next default nurse type blank?
          GOTO      DFLTTM60 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC4           * Next default nurse code blank?
          GOTO      DFLTTM60 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC4,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN4,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM60  MATCH     SP70,OPSETYN5           * Next default nurse type blank?
          GOTO      DFLTTM65 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC5           * Next default nurse code blank?
          GOTO      DFLTTM65 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC5,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN5,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
.
DFLTTM65  MATCH     SP70,OPSETYN6           * Next default nurse type blank?
          GOTO      DFLTTM99 IF EQUAL       * Yes, skip this nurse
          MATCH     SP70,OPSENUC6           * Next default nurse code blank?
          GOTO      DFLTTM99 IF EQUAL       * Yes, skip this nurse
.
          CALL      CLOPRTSM
          MOVE      TWO,STAFTYPE            * Set Staff Type (Nurse)
          MOVE      OPSENUC6,OPTSSCDE       * Set Staff Code
          MOVE      OPSETYN6,OPTSSTYP       * Set Staff Category Code
          CALL      SAVDFL00                * Write Staff Member
          GOTO      DFLTTM99
.
DFLTTM90  CALL      CLOPRTSM
          CALL      SAVSUR00                * Write Cons as Operating Surgeon
.
DFLTTM99  RETURN
.
.*****************************************************************************
.                  Save (Write) Deafult Team Member
.*****************************************************************************
SAVDFL00  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      STAFTYPE,OPTSSIND
          MOVE      OPDADATE,OPTSSDAT
          PACK      OPTSSTIM,OPDAEXPS,SECONDS
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
.         
          CALL      RDOPTSM1
          COMPARE   ZERO,OVRCD
          GOTO      SAVDFL99 IF EQUAL
.
          CALL      WROPTSM1
.
SAVDFL99  RETURN
.
.*************************************************************************
. Default Consultant as Operating Surgeon in Staff Member List
. CLOPRTSM should be called before this routine to clear the fields
.*************************************************************************
SAVSUR00  MOVE      OPDAUNIQ,OPTSUNID
          MOVE      TEAMNUMB,OPTSTMNO
          MOVE      ZERO,OPTSSIND
          MOVE      OPDACLIN,OPTSSCDE
          MOVE      OPDADATE,OPTSSDAT
          MOVE      OPCNSTCT,OPTSSTYP
          PACK      OPTSSTIM,OPDAEXPS,SECONDS
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
.
          CALL      RDOPTSM1
          COMPARE   ZERO,OVRCD
          GOTO      SAVSRG99 IF EQUAL
.
          CALL      WROPTSM1
.
SAVSRG99  RETURN
.
.------------------------------------------------------------
. Update Existing Operaton details
.------------------------------------------------------------
UPEXDT00  MATCH     SP70,OPSETHET
          GOTO      UPEXDT99 IF EQUAL
.
.         Check if the Anaesthetist code has changed,as we may need to
.         trigger a HL7 S14 message if there was no theatre code change
.         (Task: 0851661)
.
          MATCH     "1",OPCNAIPS            * sending anaesthetist in HL7 ?
          IF        @EQUAL
            MOVE      ONE,ANAEFLAG          * yes-set flag for no anaes. change
            MATCH     SAVEANAE,OPSEANAE     * same anaesthetist code ?
            IF        !@EQUAL
              MOVE      ZERO,ANAEFLAG       * no - set flag for anaes. change
            ENDIF
          ENDIF
.
          MOVE      SP6,OPDATHET            * Clear theatre for booking
          PACK      KEY26,KEY22,SP70                                           
          CALL      RSOPDEA1                * read the first case
UPEXDT10  CALL      RKOPDEA1                * read next operation record
          BRANCH    OVRCD,UPEXDT99
.
          PACK      KEY22A,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          MATCH     KEY22A,KEY22
          GOTO      UPEXDT99 IF NOT EQUAL
.
.         If the theatre has changed, then trigger a HL7 S14 message and write
.         the appropriate before and after audit records.
.         Otherwise, if only the anaesthetist code has changed, then simply
.         trigger a HL7 S14 message.  (Task: 0851661)
.         Either way the S14 gets triggered, the anaeasthetist will be sent.
.
          MATCH     OPSETHET,OPDATHET       * same theatre code ?
          IF        @EQUAL
            MATCH     "1",OPCNAIPS          * yes - send anaesthetist in HL7 ?
            IF        @EQUAL
              BRANCH    ANAEFLAG,UPEXDT10   * same anaesthetist still - finished
.
              IF        OPDASTAT <> 3
                MOVE      FIVE,HL7TRGID     * anaesthetist has changed
                MOVE      SP8,HL7INCLD
                PROC      DGCLIS14          * send update booking message
              ENDIF
            ENDIF
            GOTO      UPEXDT10              * get next record
          ENDIF
.
          MOVE      TWO,AUDIFLAG            * before change audit
          CALL      AUDEA000                * write audit
.
          MATCH     "1",TEAMUPDT            * Don't update operating room when
          GOTO      UPEXDT15 IF EQUAL       * default case team screen posted
.
          MOVE      OPSETHET,OPDATHET       * alter theatre code
.
UPEXDT15  CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1                * update theatre code
.
          MOVE      OPDAADMN,ADMISSNO
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      THREE,AUDIFLAG          * after change audit
          CALL      AUDEA000                * write audit
          IF        OPDASTAT <> 3
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14              * send update booking message
          ENDIF
          GOTO      UPEXDT10
.
UPEXDT99  RETURN
+
.------------------------------------------------------------
. Cancel Session
.------------------------------------------------------------
CANSES00  PACK      KEY22,SESSKEYS,SP20  * Key for session
          CALL      RDOPSES1            * Get the session record
          IF        OVRCD=0
            MOVE      "B",KEY1      * Set Before Changes Parameter for SESAUD00
            CALL      SESAUD00      * Write Audit File if Needed
            MOVE      OPSES023,OPSECANC      * Cancellation reason
            MOVE      OPSES075,OPSECNDT      * Date Cancellation Notified
            MOVE      OPSES076,OPSECNTM      * Time Cancellation Notified
.
            MATCH     SP70,OPSECNID
            IF        @EQUAL | @EOS
              MOVE      WBSEUID,OPSECNID       * User ID who Cancelled the 
.                                                session
            ENDIF
.
            MOVE      ZERO,OPSESTAT          * Change status to "Cancelled"
            CALL      UPOPSES1
            MOVE      "C",KEY1      * Set Before Changes Parameter for SESAUD00
            CALL      SESAUD00      * Write Audit File if Needed
          ENDIF
.
CANSES99  RETURN
.------------------------------------------------------------
. Check for Conflicts on Move of Theatre Operating Room
.------------------------------------------------------------
CHKTHE00  MOVE      OPSEENDT,SESSEND
          MOVE      ZERO,EXIT
.
          PACK      KEY22,OPSES074,OPSES001,SP70
          CALL      RSOPSES1
CHKTHE10  CALL      RKOPSES1
          BRANCH    OVRCD,CHKTHE99
.
          MATCH     OPSEHOSP,OPSES074
          GOTO      CHKTHE99 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPSES001
          GOTO      CHKTHE99 IF NOT EQUAL
.
          MATCH     OPSETIME,SESSEND
          GOTO      CHKTHE99 IF LESS
.
          MATCH     OPSES002,OPSEENDT
          GOTO      CHKTHE10 IF LESS
.
          COMPARE   ZERO,OPSESTAT           * don't include cancelled
          GOTO      CHKTHE10 IF EQUAL
.
          MATCH     OPSES013,OPSETHET
          GOTO      CHKTHE90 IF EQUAL
          GOTO      CHKTHE10
.
CHKTHE90  MOVE      ONE,EXIT
CHKTHE99  RETURN
.------------------------------------------------------------
. Move Theatre Room 
.------------------------------------------------------------
TOPALL00  PACK      SESSKEYS,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          MOVE      SP6,OPDATHET            * Clear theatre for booking
.
          PACK      KEY26,SESSKEYS,SP70
          CALL      RSOPDEA1                * read the first case
TOPALL10  CALL      RKOPDEA1                * read next operation record
          BRANCH    OVRCD,TOPALL40
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          MATCH     SESSKEYS,KEY22
          GOTO      TOPALL40 IF NOT EQUAL
.
TOPALL20  MOVE      TWO,AUDIFLAG            * before change audit
          CALL      AUDEA000                * write audit
          MOVE      OPSES013,OPDATHET         * alter theatre code
          MATCH     OPSETHET,OPDATHET       * keyin theatre = default theatre ?
          GOTO      TOPALL30 IF NOT EQUAL   * no
          MOVE      SP6,OPDATHET            * update oprdetaf with blank theatre
.
TOPALL30  CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1                * update theatre code
          MOVE      THREE,AUDIFLAG          * after change audit
          CALL      AUDEA000                * write audit
.
          MOVE      OPDAADMN,ADMISSNO
          PROC      PMSCURTH           * Update patient header theatre status
.
          IF        OPDASTAT <> 3
            MOVE      TWO,HL7TRGID          * no - send HL8 message
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14                * send update booking message
          ENDIF
          GOTO      TOPALL10
. 
. HPS Code Starts Here
TOPALL40  PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          MOVE      OPSES013,OPSETHET
          CALL      UPOPSES1
. HPS Code Ends Here
.
TOPALL90  MOVE      ZERO,EXIT
.
TOPALL99  RETURN
.
AUDEA000  BRANCH    OPCNAUDB,AUDEA999
          PACK      TDESC,KEY19,SP1      * save key19
          COMPARE   FIVE,AUDIFLAG        * test to delete B audit
          GOTO      AUDEA600 IF EQUAL
.
          COMPARE   THREE,AUDIFLAG       * is it an after change audit?
          GOTO      AUDEA100 IF EQUAL    * Yes. So don't change time
.
          CALL      IBACLOCK             * get current date
          PACK      OPDAAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OPDAAUDD
          MOVE      CTIMEIS,OPDAAUDT     * clock current time
.
AUDEA100  MOVE      ONE,OPDAAUDS         * not printed
          MOVE      PASSCODE,OPDAAUDO    * get user id
          MOVE      PORT,OPDAAUDP        * get port number
.
          MOVE      AUDIFLAG,OPDAAUDR
          REPLACE   "1A2B3C4D",OPDAAUDR
          PACK      KEY19,OPDAAUDD,OPDAAUDT,OPDAAUDP,OPDAAUDR
          CALL      AWOPDEA              * write audit record
          GOTO      AUDEA995
.
.         now delete B audit
.
AUDEA600  PACK      KEY19,OPDAAUDD,OPDAAUDT,OPDAAUDP,ANSB
          CALL      ADOPDEA              * delete audit record
.
AUDEA995  UNPACK    TDESC,KEY19          * restore key19
.
AUDEA999  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
SAVSES00  MOVE      OPSES001,OPSEDATE  * Session Date (CCYYMMDD)
          MOVE      OPSES002,OPSETIME  * Start Time (HH:MM)
          MOVE      OPSES003,OPSECLIN  * Clinic/Surgeon
          MOVE      TWO,OPSESUSP       * Booking session suspended ? 1=yes 2=No

          UNPACK    OPSES001,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          MOVE      WEEKDAY,OPSEDAY   * Day Indicator same as OPRSEMFD

          PACK      OPSEBOOK,CCC,CYY,CMM,CDD  * Booking Date (CCYYMMDD)
          REP       " 0",OPSEBOOK
          MOVE      OPSES007,OPSEENDT  * Expected End of session (HH:MM)
          MOVE      OPSES008,OPSEDURA  * Expected Duration (min)
          MOVE      OPSES009,OPSEBRKT  * Time for Breaks   (min)
          MOVE      OPSES010,OPSEPREP  * Preparation time/patient (min)
          MOVE      OPSES011,OPSETPER  * Time Period (cat SP)
          MOVE      OPSES012,OPSETYPE  * Session Type (Category ST)
          MOVE      OPSES013,OPSETHET  * Default Operating Room Code
          MOVE      OPSES014,OPSECORD  * Session co-ordinator
          MOVE      OPSES015,OPSEANAE  * Anaesthetist
          MOVE      TWO,OPSESTAT       * Session Status 0=Cancl 1=Active-Booked
.                                      *                2=Active-Extra session
          MOVE      ONE,OPSEADTS       * Adhoc Theatre Session - 1=yes
          MOVE      OPSES017,OPSETIMB  * Total time currently booked

          MOVE      OPSES018,OPSEACTS  * Actual Start Time   (HH:MM)
          MOVE      OPSES019,OPSEACTE  * Actual End Time     (HH:MM)
          MOVE      OPSES020,OPSEACTD  * Actual Duration     (mins)
          MOVE      OPSES021,OPSEOVER  * Overtime Code       (Category OO)
          MOVE      OPSES022,OPSEDELA  * Delay Code          (Category OD)
          MOVE      OPSES023,OPSECANC  * Cancellation Reason (Category OC)
.
          MOVE      OPSES024,OPSETYD1  * Doctor Type # 1 (Category OP)
          MATCH     SP10,OPSETYD1
          IF        @EQUAL
            MOVE      OPCNSTCT,OPSETYD1
          ENDIF
.
          MOVE      OPSES025,OPSETYD2  *             # 2 (Category OP)
          MATCH     SP10,OPSETYD2
          IF        @EQUAL
            MATCH     SP10,OPSEANAE
            IF        !@EQUAL
              CALL      GTANAE00
              MOVE      ACODE,OPSETYD2
            ENDIF
          ENDIF
.
          MOVE      OPSES026,OPSETYD3  *             # 3 (Category OP)
          MOVE      OPSES027,OPSETYD4  *             # 4 (Category OP)
          MOVE      OPSES028,OPSETYD5  *             # 5 (Category OP)
          MOVE      OPSES029,OPSETYD6  *             # 6 (Category OP)
          MOVE      OPSES030,OPSETYD7  *             # 7 (Category OP)
          MOVE      OPSES031,OPSETYD8  *             # 8 (Category OP)
.
          MOVE      OPSES032,OPSEDCC1  * Doctor Code # 1
.
          MATCH     SP10,OPSEDCC1
          IF        @EQUAL
            MOVE      OPSECLIN,OPSEDCC1
.
            IF        OPCNCLSU=0
              PACK      KEY6,OPSECLIN,SP70    * If using Clinic then populate
              CALL      RDOPCLI1              * the surgeon with doctor code
              IF        OVRCD=0
                MATCH     SP70,OPCLDOCT
                IF        !@EQUAL
                  MOVE      OPCLDOCT,OPSEDCC1
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      OPSES033,OPSEDCC2  *             # 2
          MATCH     SP10,OPSEDCC2
          IF        @EQUAL
            MOVE      OPSEANAE,OPSEDCC2
          ENDIF
.
          MOVE      OPSES034,OPSEDCC3  *             # 3  
          MOVE      OPSES035,OPSEDCC4  *             # 4
          MOVE      OPSES036,OPSEDCC5  *             # 5
          MOVE      OPSES037,OPSEDCC6  *             # 6
          MOVE      OPSES038,OPSEDCC7  *             # 7
          MOVE      OPSES039,OPSEDCC8  *             # 8
.
          MOVE      OPSES040,OPSELVD1  * Supervision Level # 1 (Cat OS)
          MOVE      OPSES041,OPSELVD2  *                   # 2 (Cat OS)
          MOVE      OPSES042,OPSELVD3  *                   # 3 (Cat OS)
          MOVE      OPSES043,OPSELVD4  *                   # 4 (Cat OS)
          MOVE      OPSES044,OPSELVD5  *                   # 5 (Cat OS)
          MOVE      OPSES045,OPSELVD6  *                   # 6 (Cat OS)
          MOVE      OPSES046,OPSELVD7  *                   # 7 (Cat OS)
          MOVE      OPSES047,OPSELVD8  *                   # 8 (Cat OS)
.
          MOVE      OPSES048,OPSETYN1  * Nurse Type # 1 (Category ON)
          MOVE      OPSES049,OPSETYN2  *            # 2 (Category ON)
          MOVE      OPSES050,OPSETYN3  *            # 3 (Category ON)
          MOVE      OPSES051,OPSETYN4  *            # 4 (Category ON)
          MOVE      OPSES052,OPSETYN5  *            # 5 (Category ON)
          MOVE      OPSES053,OPSETYN6  *            # 6 (Category ON)
.
          MOVE      OPSES054,OPSENUC1  * Nurse Code # 1
          MOVE      OPSES055,OPSENUC2  *            # 2
          MOVE      OPSES056,OPSENUC3  *            # 3
          MOVE      OPSES057,OPSENUC4  *            # 4
          MOVE      OPSES058,OPSENUC5  *            # 5
          MOVE      OPSES059,OPSENUC6  *            # 6
.
          MOVE      OPSES060,OPSEUSR1  * User Defined 1 (Category Q6)
          MOVE      OPSES061,OPSEUSR2  *              2 (Category Q7)
          MOVE      OPSES062,OPSEUSR3  *              3 (Category Q8)
          MOVE      OPSES063,OPSEUSR4  *              4 (Category Q9)
.
          MOVE      OPSES064,OPSEXDOC  * Extra doctor for team
.
.                                           * HPS Code Starts Here
          MOVE      OPSES065,OPSEACDS  * Actual Start Date
          MOVE      OPSES066,OPSEACDE  * Actual End Date
          MOVE      OPSES067,OPSESPI1  * Special Instructions 1
          MOVE      OPSES068,OPSESPI2  * Special Instructions 2
          MOVE      OPSES069,OPSENDLK  * Number of Days to Lock
          MOVE      OPSES070,OPSESTYP  * Session Type (category TU)
.                                           * HPS Code Ends Here
          MOVE      OPSES071,OPSEDGSI  * Day/General Surgery Ind (cat YD)
          MOVE      OPSES072,OPSEFIND
          MOVE      OPSES073,OPSEFINT
          MOVE      OPSES074,OPSEHOSP  * Hospital
.
          MOVE      OPSES075,OPSECNDT  * Date Cancellation Notified
          MOVE      OPSES076,OPSECNTM  * Time Cancellation Notified
          MOVE      OPSES077,OPSECNID  * User ID who Cancelled the session
.
          MOVE      OPSES078,OPSEDTCM  * Default Team Completed
          MATCH     "1",OPSES078
          IF        @EQUAL
            MOVE      WBSEUID,OPSEUCDT      * User who Completed Default Team
            PACK      OPSEDCDT,CCC,CYY,CMM,CDD
            REP       " 0",OPSEDCDT         * Date Default Team Completed
            CLOCK     TIME,OPSETCDT         * Time Default Team Completed
          ENDIF
.
          MOVE      SP70,OPSESPAR      * Spare
.
SAVSES99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKSES00  RESET     OPSES001
          MATCH     SP70,OPSES001
          GOTO      CHKSES80 IF EQUAL
.
          RESET     OPSES002
          MATCH     SP70,OPSES002
          GOTO      CHKSES81 IF EQUAL
.
          RESET     OPSES003
          MATCH     SP70,OPSES003
          GOTO      CHKSES82 IF EQUAL
.
          RESET     OPSES007
          MATCH     SP70,OPSES007
          GOTO      CHKSES83 IF EQUAL
.
          COMPARE   OPSES008,ZERO
          GOTO      CHKSES84 IF EQUAL
.
          RESET     OPSES011
          MATCH     SP70,OPSES011
          GOTO      CHKSES87 IF EQUAL
.
          RESET     OPSES012
          MATCH     SP70,OPSES012
          GOTO      CHKSES88 IF EQUAL
.
          GOTO      CHKSES98
.
CHKSES80  MOVE      "Session Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES81  MOVE      "Start Time mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES82  MOVE      "Clinic/Surgeon is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES83  MOVE      "End Time is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES84  MOVE      "Duration is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES87  MOVE      "Time Period is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES88  MOVE      "Session Type is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSES99
.
CHKSES98  MOVE      ZERO,EXIT
CHKSES99  RETURN
.--------------------------------------------------------------------
.                         SESTME00
. Make Sure End Time > Start time & Duration > Rest Time & Prep Time
.                                                called by: OPRSES00
.--------------------------------------------------------------------
SESTME00  UNPACK    OPSES002,KEY2,KEY1,MIN   * Start Time (HH:MM)
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,STARTIME            * Change to a form (HHMM)
.
          UNPACK    OPSES007,KEY2,KEY1,MIN   * Session End Time (HH:MM)
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,FINSHTME            * Change to a form (HHMM)
.
          IF        OPSES008 < 0
            GOTO      SESTME90
          ENDIF
.
          IF        OPSES008 < OPSES009     
            GOTO      SESTME91               * Duration > Time for Breaks
          ENDIF
.
          IF        OPSES008 < OPSES010     
            GOTO      SESTME92               * Duration > Prep Time
          ENDIF
.
          GOTO      SESTME98
.
SESTME90  MOVE      "End Session Time must be after Session ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Start Time!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SESTME99
.
SESTME91  MOVE      "Time for breaks must be less than Duration ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SESTME99
.
SESTME92  MOVE      "Prep Time must be less than Duration ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SESTME99
.
SESTME98  MOVE      ZERO,EXIT
SESTME99  RETURN
.---------------------------------------------------------------------
.         ACTDUR00 - Calculates the actual duration of the session
.---------------------------------------------------------------------
ACTDUR00  UNPACK    OPSEACTE,CHOUR,ANS,CMIN * unpack the end time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,FORM4D            * get in work variable
          MULT      "60",FORM4D             * get the minutes of full hours
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,FORM4D            * get the total min of end time
          MOVE      FORM4D,OPSEACTD         * save the minutes
.
          UNPACK    OPSEACTS,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CHOUR,FORM2             * set up hours as a form
          MOVE      FORM2,FORM4B            * get in work variable
          MULT      "60",FORM4B             * get the minutes of full hours
          MOVE      CMIN,FORM2              * set up minutes as a form
          ADD       FORM2,FORM4B            * get the total min of start time
.
.         Check for a possible negative duration. ie. The session has gone over
.         midnight.
.
          MOVE      OPSEACDS,CDYSFDTE       * Actual start of session date
          MOVE      OPSEACDE,CDYSTDTE       * Actual end of session date
          CALL      CALCDAYS
          MOVE      CDYSDAYS,FORM4          * no of days between the two dates
          SUB       ONE,FORM4
.
          MOVE      "1440",FORM4C           * 1440 minutes in 24 hours
          MULT      FORM4,FORM4C
.
          MOVE      OPSEACTD,FORM4A         
          ADD       FORM4C,FORM4A
          SUB       FORM4B,FORM4A           * duration = min.end - min.start
          MOVE      FORM4A,OPSEACTD         * set the actual duration
.
ACTDUR99  RETURN
.---------------------------------------------------------------------
. Writes Operating Room - Existing Session Details Audit
.    Parameters :   KEY1 - Set Record Type
.---------------------------------------------------------------------
SESAUD00  BRANCH    OPCNAUDS,SESAUD99  * Check if audit needs to be written
.
          CALL      IBACLOCK
          PACK      OPSEAUDD,CCC,CYY,CMM,CDD     * Date
          REP       " 0",OPSEAUDD
          MOVE      CTIMEIS,OPSEAUDT
          MOVE      PORT,OPSEAUDP                * Port
          MOVE      KEY1,OPSEAUDR                * Record Type
          MOVE      ONE,OPSEAUDS                 * Not Printed
          MOVE      PASSCODE,OPSEAUDO            * Operator
.
          PACK      KEY19,OPSEAUDD,OPSEAUDT,OPSEAUDP,OPSEAUDR
          CALL      AWOPSES                      * Write Audit File
.
SESAUD99  RETURN
.---------------------------------------------------------------------
. New/Open Session Details: Display,Add,Update,Delete
.---------------------------------------------------------------------
OPROPN00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      OPROPN30 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      OPROPN10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      OPROPN20 IF EQUAL
.
          GOTO      OPROPN93
.
.         ************ ADD FORMACTION ***********
.
OPROPN10  CALL      SAVMON00      * Loop through months and save Sessions   
          BRANCH    EXIT,OPROPN99
.
          MOVE      ZERO,EXIT
          GOTO      OPROPN99
.
.         ************ DELETE FORMACTION **********
.
OPROPN20  CALL      DELSES00
          MOVE      ZERO,EXIT
          GOTO      OPROPN99
.
.         ************ DISPLAY FORMACTION **********
.
OPROPN30  IF        OPCNCLSU = 1 
            PACK      KEY6,OPSEM001    * Using Doctor Code
            CALL      RDDOCT1
            BRANCH    OVRCD,OPROPN91
            MOVE      DCODE,CLINCODE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,CLINDESC
          ELSE
            PACK      KEY6,OPSEM001    * Using Session Clinic Code
            CALL      RDOPCLI1
            BRANCH    OVRCD,OPROPN92           
            MOVE      OPCLCLIN,CLINCODE
            MOVE      OPCLDESC,CLINDESC
          ENDIF 
.
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70
          CALL      RDOPSEM1
          BRANCH    OVRCD,OPROPN94
          IF        OPCNCLSU = 1 
            MOVE      OPSMCLIN,DOCTCODE   * Surgeon
          ELSE
            MOVE      SP70,DOCTCODE
          ENDIF
          MOVE      OPSMANAE,ANAETHET     * Anaethetist
          MOVE      OPSMTHET,THETCODE     * Theatre/Operating Room Code
.
          CLEAR     WEBTITLE
          MOVE      "New/Open Session Details Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,OPROPN99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN91  MOVE      "Invalid Doctor Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN92  MOVE      "Invalid Clinic.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN93  MOVE      "Invalid Clinic/Surgeon Schedule.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN94  MOVE      "Invalid Clinic/Surgeon Schedule.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99
.
OPROPN99  RETURN
.------------------------------------------------------------------------
.                 ******  SAVMON00  ******
.            Loop through months and save sessions.
.            Set and save session details for each month.
.                                                     called by: OPROPN00
.------------------------------------------------------------------------
SAVMON00  MOVE      ZERO,EXIT
          PACK      KEY21,OPSEM019,OPSEM001,OPSEM002,OPSEM003,OPSEM007,SP70 
          CALL      RDOPSEM1
          BRANCH    OVRCD,SAVMON90     
.
          CALL      CLOPRSES                          * Clear session file
.
          MOVE      ONE,MONTHNO  
          MOVE      ONE,WEEKNO
          WHILE     (MONTHNO<=12)
            WHILE     (WEEKNO<=5)
              MATCH     SP70,MTHDTE[MONTHNO][WEEKNO]  * = corresponding date
              IF        !@EQUAL
                PACK      KEY22,OPSEM019,MTHDTE[MONTHNO][WEEKNO],OPSEM003:
                                OPSEM001,SP70
                CALL      RAOPSES1
                IF        OVRCD=1
                  CALL      SESSAV00  * Save Variables for Clinic Open Session
                  PACK      KEY22,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
                  CALL      WROPSES1
                  MOVE      "A",KEY1  * Set Add Parameter for SESAUD00
                  CALL      SESAUD00  * Write Audit File if Needed
                ENDIF
              ENDIF
              ADD       ONE,WEEKNO
            DO
          ADD       ONE,MONTHNO
          MOVE      ONE,WEEKNO
          DO
          GOTO      SAVMON99 
.
SAVMON90  MOVE      "Invalid read on Clinic/Surgeon Schedule",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    " before write to Session Details!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPROPN99 
.
SAVMON99  RETURN
.----------------------------------------------------------------
. Save routine - Move schedule variables into session variables  
.----------------------------------------------------------------
SESSAV00  MOVE      MTHDTE[MONTHNO][WEEKNO],OPSEDATE  * Session Date (CCYYMMDD)
          MOVE      OPSMTIME,OPSETIME  * Start Time (HH:MM)
          MOVE      OPSMCLIN,OPSECLIN  * Clinic/Surgeon
          MOVE      TWO,OPSESUSP       * Booking session suspended ? 1=yes 2=No

          MOVE      OPSMDAYI,OPSEDAY   * Day Indicator 
.
          PACK      OPSEBOOK,CCC,CYY,CMM,CDD  * Booking Date (CCYYMMDD)
          REP       " 0",OPSEBOOK
.
          MOVE      OPSMENDT,OPSEENDT  * Expected End of session (HH:MM)
          MOVE      OPSMDURA,OPSEDURA  * Expected Duration (min)
          MOVE      OPSMBRKT,OPSEBRKT  * Time for Breaks   (min)
          MOVE      OPSMPREP,OPSEPREP  * Preparation time/patient (min)
          MOVE      OPSMTPER,OPSETPER  * Time Period (cat SP)
          MOVE      OPSMTYPE,OPSETYPE  * Session Type (Category ST)
          MOVE      OPSMTHET,OPSETHET  * Default Operating Room Code
          MOVE      SP70,OPSECORD      * Session co-ordinator
          MOVE      OPSMANAE,OPSEANAE  * Anaesthetist
          MOVE      ONE,OPSESTAT       * Session Status 0=Cancl 1=Active-Booked
.                                      *                2=Active-Extra session
          MOVE      ZERO,OPSETIMB      * Total time currently booked
          MOVE      SP70,OPSEACTS      * Actual Start Time   (HH:MM)
          MOVE      SP70,OPSEACTE      * Actual End Time     (HH:MM)
          MOVE      ZERO,OPSEACTD      * Actual Duration     (mins)
          MOVE      SP70,OPSEOVER      * Overtime Code       (Category OO)
          MOVE      SP70,OPSEDELA      * Delay Code          (Category OD)
          MOVE      SP70,OPSECANC      * Cancellation Reason (Category OC)
.
.         Write Default team
.
..        MOVE      SP70,OPSETYD1      * Doctor Type # 1 (Category OP)
          MOVE      OPCNSTCT,OPSETYD1  * Doctor Type # 1 (Category OP)
.
          MOVE      SP70,OPSETYD2      *             # 2 (Category OP)
          MATCH     SP10,OPSMANAE
          IF        !@EQUAL
            CALL      GTANAE00         * Get Anaethetist code
            MOVE      ACODE,OPSETYD2   *             # 2 (Category OP)
          ENDIF
.
          MOVE      SP70,OPSETYD3      *             # 3 (Category OP)
          MOVE      SP70,OPSETYD4  *             # 4 (Category OP)
          MOVE      SP70,OPSETYD5  *             # 5 (Category OP)
          MOVE      SP70,OPSETYD6  *             # 6 (Category OP)
          MOVE      SP70,OPSETYD7  *             # 7 (Category OP)
          MOVE      SP70,OPSETYD8  *             # 8 (Category OP)
.
..        MOVE      SP70,OPSEDCC1      * Doctor Code # 1
          MOVE      OPSMCLIN,OPSEDCC1  * Doctor Code # 1
.
          IF        OPCNCLSU=0
            PACK      KEY6,OPSMCLIN,SP70    * If using Clinic then populate
            CALL      RDOPCLI1              * the surgeon with doctor code
            IF        OVRCD=0
              MATCH     SP70,OPCLDOCT
              IF        !@EQUAL
                MOVE      OPCLDOCT,OPSEDCC1
              ENDIF
            ENDIF
          ENDIF
.
..        MOVE      SP70,OPSEDCC2      *             # 2
          MOVE      OPSMANAE,OPSEDCC2  *             # 2
.
          MOVE      SP70,OPSEDCC3  *             # 3          
          MOVE      SP70,OPSEDCC4  *             # 4
          MOVE      SP70,OPSEDCC5  *             # 5
          MOVE      SP70,OPSEDCC6  *             # 6
          MOVE      SP70,OPSEDCC7  *             # 7
          MOVE      SP70,OPSEDCC8  *             # 8
.
          MOVE      SP70,OPSELVD1  * Supervision Level # 1 (Cat OS)
          MOVE      SP70,OPSELVD2  *                   # 2 (Cat OS)
          MOVE      SP70,OPSELVD3  *                   # 3 (Cat OS)
          MOVE      SP70,OPSELVD4  *                   # 4 (Cat OS)
          MOVE      SP70,OPSELVD5  *                   # 5 (Cat OS)
          MOVE      SP70,OPSELVD6  *                   # 6 (Cat OS)
          MOVE      SP70,OPSELVD7  *                   # 7 (Cat OS)
          MOVE      SP70,OPSELVD8  *                   # 8 (Cat OS)
.
          MOVE      SP70,OPSETYN1  * Nurse Type # 1 (Category ON)
          MOVE      SP70,OPSETYN2  *            # 2 (Category ON)
          MOVE      SP70,OPSETYN3  *            # 3 (Category ON)
          MOVE      SP70,OPSETYN4  *            # 4 (Category ON)
          MOVE      SP70,OPSETYN5  *            # 5 (Category ON)
          MOVE      SP70,OPSETYN6  *            # 6 (Category ON)
.
          MOVE      SP70,OPSENUC1  * Nurse Code # 1
          MOVE      SP70,OPSENUC2  *            # 2
          MOVE      SP70,OPSENUC3  *            # 3
          MOVE      SP70,OPSENUC4  *            # 4
          MOVE      SP70,OPSENUC5  *            # 5
          MOVE      SP70,OPSENUC6  *            # 6
.
          MOVE      SP70,OPSEUSR1  * User Defined 1 (Category Q6)
          MOVE      SP70,OPSEUSR2  *              2 (Category Q7)
          MOVE      SP70,OPSEUSR3  *              3 (Category Q8)
          MOVE      SP70,OPSEUSR4  *              4 (Category Q9)
.
          MOVE      OPSMXDOC,OPSEXDOC  * Extra doctor for team
.
.                                           * HPS Code Starts Here
          MOVE      SP70,OPSEACDS      * Actual Start Date
          MOVE      SP70,OPSEACDE      * Actual End Date
          MOVE      OPSMSPI1,OPSESPI1  * Special Instructions 1
          MOVE      OPSMSPI2,OPSESPI2  * Special Instructions 2
          MOVE      OPSMNDLK,OPSENDLK  * Number of Days to Lock
          MOVE      OPSMSTYP,OPSESTYP  * Session Type (category TU)
.                                           * HPS Code Ends Here 
          MOVE      OPSMDGSI,OPSEDGSI  * Day/General Surgery Indicator
          MOVE      OPSMHOSP,OPSEHOSP  * Hospital
          MOVE      SP70,OPSESPAR      * Spare
.
SESSAV99  RETURN
+
.-----------------------------------------------------------------------
. Get Anaethetist Code
.-----------------------------------------------------------------------
GTANAE00  PACK      KEY5,ANSO,ANSP,SP10
          CALL      RDSCODE1
GTANAE10  CALL      RDKCODE1
          BRANCH    OVRCD,GTANAE90
.
          MATCH     "OP",TCODE
          GOTO      GTANAE90 IF NOT EQUAL
.
          MATCH     SP10,ACODE
          GOTO      GTANAE10 IF EQUAL
.
          CMATCH    ANSN,TCINDC1            * Anaethetists
          GOTO      GTANAE99 IF EQUAL
          GOTO      GTANAE10
.
GTANAE90  MOVE      SP10,ACODE
GTANAE99  RETURN
+
.-----------------------------------------------------------------------
. Delete Session Procedure
.-----------------------------------------------------------------------
DELSES00  PACK      KEY22,OPSEM001,OPSEM019,SHOWYEAR,SP70
          CALL      RSOPSES2
DELSES10  CALL      RKOPSES2
          BRANCH    OVRCD,DELSES99
.
          MATCH     OPSEM001,OPSECLIN      * Match on Clinic/Doctor
          GOTO      DELSES99 IF NOT EQUAL
.
          MATCH     OPSEHOSP,OPSEM019      * Correct Hospital
          GOTO      DELSES99 IF NOT EQUAL
.
          UNPACK    OPSEDATE,KEY4            * Check that Deleting for selected
          MATCH     KEY4,SHOWYEAR           * year....
          GOTO      DELSES99 IF NOT EQUAL
.
          MOVE      OPSEDAY,KEY1
          MATCH     OPSEM002,KEY1          * Match on Day of Week
          GOTO      DELSES10 IF NOT EQUAL
.
          MATCH     OPSEM003,OPSETIME      * Match on Start Time
          GOTO      DELSES10 IF NOT EQUAL
.
          MATCH     OPSETHET,OPSEM007      * Correct Theatre
          GOTO      DELSES10 IF NOT EQUAL
.
          CALL      SESDET00
          BRANCH    EXIT,DELSES10
.
          CALL      BOKCHK00
          BRANCH    EXIT,DELSES10
.
          CALL      SESDEL00    * Delete Session Record
.
          GOTO      DELSES10    * Read Next Date.
.
DELSES99  RETURN
.-----------------------------------------------------------------------
. Check Session dates(cgi dates checked) for Deletion
.-----------------------------------------------------------------------
SESDET00  MOVE      ZERO,EXIT
          MOVE      ONE,MONTHNO
          MOVE      ONE,WEEKNO
          WHILE     (MONTHNO<=12)
            WHILE     (WEEKNO<=5)
              MATCH     SP70,MTHDTE[MONTHNO][WEEKNO]   * = corresponding date
              IF        !@EQUAL
                MATCH     OPSEDATE,MTHDTE[MONTHNO][WEEKNO]
                IF        @EQUAL
                  MOVE      ONE,EXIT
                  GOTO      SESDET99
                ENDIF
              ENDIF
              ADD       ONE,WEEKNO
            DO
          ADD       ONE,MONTHNO
          MOVE      ONE,WEEKNO
          DO
.
SESDET99  RETURN
.-----------------------------------------------------------------------
. Delete Session
.-----------------------------------------------------------------------
SESDEL00  PACK      KEY22,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,SESDEL99
.
          CALL      DEOPSES1
.
SESDEL99  RETURN
.------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30
          GOTO      PROFLD99
.
.      Operating Room - Schedule Maintenance 
.
PROFLD10  CALL      OPRS0000       * Operating Room - Schedule Maintenance 
          GOTO      PROFLD99
.
.      Operating Room - Theatre Session Maintenance
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24
          GOTO      PROFLD99
.
PROFLD21  CALL      OPRS0000       * Operating Room - Schedule Maintenance 
          GOTO      PROFLD99
.
PROFLD22  CALL      OSES0000       * Theatre Session Details
          GOTO      PROFLD99
.
PROFLD23  CALL      SLST0000       * Theatre Session Tables
          GOTO      PROFLD99
.
PROFLD24  CALL      MISC0000
          GOTO      PROFLD99
.
.      Operating Room - Clinic/Surgeon Session Details
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      OPRS0000       * Operating Room - Schedule Maintenance  
          GOTO      PROFLD99
.
PROFLD32  CALL      SESD0000       * Session Dates
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-----------------------------------------------------------
. Option 1 - Operating Room - Schedule Maintenance
.-----------------------------------------------------------
OPRS0000  BRANCH    FLDITMNO,OPRS0100,OPRS0200,OPRS0300,OPRS0400,OPRS0500:
                             OPRS0600,OPRS0700,OPRS0800,OPRS0900,OPRS1000:
                             OPRS1100,OPRS1200,OPRS1300,OPRS1400,OPRS1500:
                             OPRS1600,OPRS1700,OPRS1800,OPRS1900,OPRS2000:
                             OPRS2100,OPRS2200,OPRS2300,OPRS2400,OPRS2500:
                             OPRS2600,OPRS2700,OPRS2800
.                                           * OPRS1700-2000 ADDED BY HPS
          GOTO      OPRS9999
.
OPRS0100  WRITE     HTMLFILE;CLINCODE;  * Clinic        
          GOTO      OPRS9999
.
OPRS0200  WRITE     HTMLFILE;CLINDESC;  * Clinic/Surgeon Description
          GOTO      OPRS9999
.
OPRS0300  CALL      SETDAY00            * Outputs day no. or day description  
          GOTO      OPRS9999
.
OPRS0400  WRITE     HTMLFILE;OPSMTIME;  * Start Time                
          GOTO      OPRS9999
.
OPRS0500  WRITE     HTMLFILE;OPSMDURA;  * Duration                      
          GOTO      OPRS9999
.
OPRS0600  MOVE      "SP",CATEGORY 
          MOVE      OPSMTPER,CODE       * Time Period (Category SP)    
          CALL      CODITM00
          GOTO      OPRS9999
.
OPRS0700  CALL      OPDUSL00            * Session Unit 
.          MOVE      "ST",CATEGORY
.          MOVE      OPSMTYPE,CODE       * Session Type (Category ST)  
.          CALL      CODITM00
          GOTO      OPRS9999
.
OPRS0800  CALL      OPSLST00            * Operating Room Selection List 
          GOTO      OPRS9999
.
OPRS0900  MATCH     SP70,OPSMENDT       * End Time
          GOTO      OPRS9999 IF EQUAL
          WRITE     HTMLFILE;OPSMENDT;      
          GOTO      OPRS9999
.
OPRS1000  COMPARE   ZERO,OPSMBRKT
          GOTO      OPRS9999 IF EQUAL
          WRITE     HTMLFILE;OPSMBRKT;  * Time for Breaks (min)          
          GOTO      OPRS9999
.
OPRS1100  COMPARE   ZERO,OPSMPREP
          GOTO      OPRS9999 IF EQUAL
          WRITE     HTMLFILE;OPSMPREP;  * Preparation time / patient   
          GOTO      OPRS9999
.
OPRS1200  MOVE      OPSMANAE,DOCTCODE   * Usual Anaesthetist             
          CALL      DOCDET00            * Doctor Details 
          GOTO      OPRS9999
.
OPRS1300  MOVE      OPSMXDOC,DOCTCODE   * Extra Doctor for Team 
          CALL      DOCDET00            * Doctor Details 
          GOTO      OPRS9999
.
OPRS1400  COMPARE   ZERO,OPSMSTAT
          IF        @EQUAL 
            WRITE     HTMLFILE;OPSMSTAT;  * Status 0=Active 1=Inactive 
          ELSE
            WRITE     HTMLFILE;"1";
          ENDIF
          GOTO      OPRS9999
.
OPRS1500  CALL      SEMTB000     * Table of Operating Rooms - Schedules
          GOTO      OPRS9999
.
OPRS1600  CALL      LNKSER00     * Link to another program 
          GOTO      OPRS9999
.
.                                           * HPS Code Starts Here
OPRS1700  WRITE     HTMLFILE;OPSMSPI1;      * Special Instructions1
          GOTO      OPRS9999
.
OPRS1800  WRITE     HTMLFILE;OPSMSPI2;      * Special Instructions2
          GOTO      OPRS9999
.
OPRS1900  WRITE     HTMLFILE;OPSMNDLK;      * Number of days to lock session
          GOTO      OPRS9999
.
OPRS2000  MOVE      "TU",CATEGORY
          MOVE      OPSMSTYP,CODE           * Session Type (Category TU)
          CALL      CODITM00
          GOTO      OPRS9999
.                                           * HPS Code Ends Here
OPRS2100  MOVE      "YD",CATEGORY
          MOVE      OPSMDGSI,CODE           * Day/General Surgery Ind (Cat YD)
          CALL      CODITM00
          GOTO      OPRS9999
.                                          
OPRS2200  WRITE     HTMLFILE;OPCNSCOM;      * Using Session Based Comments?
          GOTO      OPRS9999                                           *I-50678
.
OPRS2300  CALL      DSCM0000                * Display Session Based Comments
          GOTO      OPRS9999                                           *I-50678
.
OPRS2400  COMPARE   ONE,IBCNMHOS
          GOTO      OPRS9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=DataLabel>Hospital</td>":
                             "<td><select name=opsem019 title='Hospital' ":
                             "class=Mandatory onchange=GetOpr();>":
                             "<option></option>"
          MOVE      OPSMHOSP,DIM3
          CALL      HSEL0000
          WRITE     HTMLFILE;"</select></td></tr>";
          GOTO      OPRS9999                                           *I-50678
.
OPRS2500  UNPACK    DIM127,D1,KEY1,DIM127 
          PACK      KEY3,WBSEHOSP
          MATCH     "1",KEY1
          GOTO      OPRS2510 IF EQUAL  
          PACK      KEY3,OPSMHOSP
OPRS2510  MATCH     SP70,KEY3
          GOTO      OPRS9999 IF EQUAL
          CALL      RDPTHSP1
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      OPRS9999                                           *I-50678
.
OPRS2600  WRITE     HTMLFILE;OPSMHOSP;      * This session hospital    *235359
          GOTO      OPRS9999                                           *I-50678
.
OPRS2700  IF        SHOWFLAG=0
            MOVE      ZERO,ACTVFILT         * Actice default
          ENDIF
.
          WRITE     HTMLFILE;ACTVFILT;      * Active / inactive filter
          GOTO      OPRS9999              
.
OPRS2800  CALL      DYCM0000                * Display Day Comments
          GOTO      OPRS9999 
.
OPRS9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     DIM3,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
+
.------------------------------------------------------------
. Option 2 : Theatre Session Dates by Month 
.------------------------------------------------------------
SLST0000  BRANCH    FLDITMNO,SLST0100,SLST0200,SLST0300,SLST0400
          GOTO      SLST9999
.
SLST0100  CALL      SESTAB00     * Table of Session Dates by month
          GOTO      SLST9999
.
SLST0200  CALL      MTHOPT00     * Month Selection List    
          GOTO      SLST9999
.
SLST0300  CALL      NEXT0000     * Next Month
          GOTO      SLST9999
.
SLST0400  CALL      LAST0000     * Previous Month
          GOTO      SLST9999
.
SLST9999  RETURN
.
.------------------------------------------------------------
. Option 2 : Miscellaneous Fields  
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600
          GOTO      MISC9999
.
MISC0100  WRITE     HTMLFILE;OPCNSTCT;
          GOTO      MISC9999
.
MISC0200  COMPARE   ZERO,OPCNCLSU           * Using clinic
          GOTO      MISC9999 IF NOT EQUAL
.
          PACK      KEY6,CLINCODE,SP70      * Using Doctor Code
          CALL      RDOPCLI1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;OPCLDOCT;
          GOTO      MISC9999
.
MISC0300  COMPARE   ZERO,OPCNCLSU           * Using clinic
          GOTO      MISC9999 IF NOT EQUAL
.
          PACK      KEY6,CLINCODE,SP70 
          CALL      RDOPCLI1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY6,OPCLDOCT,SP70      * Using Doctor Code
          CALL      RDDOCT1
          BRANCH    OVRCD,MISC9999
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      MISC9999
.
MISC0400  WRITE     HTMLFILE;OPCNPCOT;
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;OPSEXDOC;
          GOTO      MISC9999
.
MISC0600  COMPARE   ONE,OPCNUSAN            * Check for Extra Session Doctor
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     SP6,OPSEXDOC            * Check Personnel Code
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY6,OPSEXDOC,SP70      
          CALL      RDDOCT1
          BRANCH    OVRCD,MISC9999
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      MISC9999
.
MISC9999  RETURN
.
.------------------------------------------------------------------
.  Option 3 : Clinic/Surgeon Session Dates
.------------------------------------------------------------------
SESD0000  BRANCH    FLDITMNO,SESD0100,SESD0200,SESD0300,SESD0400,SESD0500
          GOTO      SESD9999
.
SESD0100  MOVE      ZERO,DELSES
          CALL      SESTBL00   * For Open Session    
          GOTO      SESD9999
.
SESD0200  CALL      SETYR000   * Sets current year Depending Next or Prev Page
          GOTO      SESD9999
.
SESD0300  CALL      NEXTYR00   * Link to Next Year
          GOTO      SESD9999
.
SESD0400  CALL      PREVYR00   * Link to Previous Year
          GOTO      SESD9999
.
SESD0500  MOVE      ONE,DELSES
          CALL      SESTBL00   * For Delete Sessions
          GOTO      SESD9999
.
SESD9999  RETURN
.-----------------------------------------------------------
. Sets Year to current or to next or prev
.-----------------------------------------------------------
SETYR000  RESET     SHOWYEAR
          MATCH     SP70,SHOWYEAR
          GOTO      SETYR100 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      SHOWYEAR,CCC,CYY
          REP       " 0",SHOWYEAR
          WRITE     HTMLFILE;SHOWYEAR;
          GOTO      SETYR999
.
SETYR100  WRITE     HTMLFILE;SHOWYEAR;  * Year set to Next or Previous Year
.
SETYR999  RETURN
.-----------------------------------------------------------
. Link to Next Years
.-----------------------------------------------------------
NEXTYR00  UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          MOVE      SHOWYEAR,F4
          ASSIGN    F4+ONE,F4
          MOVE      F4,KEY4
          REP       " +",OPSMCLIN
.
          WRITE     HTMLFILE;"oprweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&opsem001=",OPSMCLIN:
                                 "&opsem002=",OPSMDAYI:
                                 "&opsem003=",OPSMTIME:
                                 "&opsem007=",OPSMTHET:
                                 "&opsem019=",OPSMHOSP:
                                 "&showyear=",KEY4;
.
          REP       "+ ",OPSMCLIN
.
NEXTYR99  RETURN
.-------------------------------------------------------------
. Link to Prev Years
.-------------------------------------------------------------
PREVYR00  UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          MOVE      SHOWYEAR,F4
          ASSIGN    F4-ONE,F4
          MOVE      F4,KEY4
          REP       " +",OPSMCLIN
.
          WRITE     HTMLFILE;"oprweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&opsem001=",OPSMCLIN:
                                 "&opsem002=",OPSMDAYI:
                                 "&opsem003=",OPSMTIME:
                                 "&opsem007=",OPSMTHET:
                                 "&opsem019=",OPSMHOSP:
                                 "&showyear=",KEY4;
.
          REP       "+ ",OPSMCLIN
.
PREVYR99  RETURN
.---------------------------------------------------------------------
.                           SESTBL00
.     Table of Operating Room/Theatre Session Details Dates
.     Outputs occurances of a particular Day. eg; Mondays for the Year
.                                                  called by: SESD0000
.---------------------------------------------------------------------
SESTBL00  RESET     SHOWYEAR
          MATCH     SP70,SHOWYEAR
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      SHOWYEAR,CCC,CYY   * Set to current year
            REP       " 0",SHOWYEAR
          ENDIF
.
          MOVE      OPSEM002,LOOKDAY     * Day to Searched
.
          MOVE      SHOWYEAR,KEY4        * Get first day of year
          CALL      DOFYR000
          BRANCH    EXIT,SESTBL90
          MOVE      FSTDAY,FIRSTDAY
.
.  Set months(no. of days) and call display routine
.
          MOVE      ONE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * January
          CALL      SESDAT00
.
          MOVE      TWO,MONTHNO             * February
          CALL      LEAPYR00                * Check if Leap Year
          CALL      SESDAT00
.
          MOVE      THREE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * March
          CALL      SESDAT00
.
          MOVE      FOUR,MONTHNO
          MOVE      THIRTY,MONTHTOT         * April
          CALL      SESDAT00
.
          MOVE      FIVE,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * May
          CALL      SESDAT00
.
          MOVE      SIX,MONTHNO
          MOVE      THIRTY,MONTHTOT         * June
          CALL      SESDAT00
.
          MOVE      SEVEN,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * July
          CALL      SESDAT00
.
          MOVE      EIGHT,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * August
          CALL      SESDAT00
.
          MOVE      NINE,MONTHNO
          MOVE      THIRTY,MONTHTOT         * September
          CALL      SESDAT00
.
          MOVE      TEN,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * October
          CALL      SESDAT00
.
          MOVE      TEN1,MONTHNO
          MOVE      THIRTY,MONTHTOT         * November
          CALL      SESDAT00
.
          MOVE      TEN2,MONTHNO
          MOVE      THIRTY1,MONTHTOT        * December
          CALL      SESDAT00
.
          GOTO      SESTBL99
.
.
.  Error must be displayed this way, as within profields
.
SESTBL90  WRITE     HTMLFILE;"<tr>":
                             "<td align=center><br><b>First day of year not ":
                             "set!</td></tr>";
.
SESTBL99  RETURN
.----------------------------------------------------------------
.  If Leap Year, set Febuary to 29 days else set to 28
.                                             called by: SESTBL00
.----------------------------------------------------------------
LEAPYR00  MOVE      SHOWYEAR,F4
          ASSIGN    F4%FOUR,F2
          COMPARE   ZERO,F2
          IF        @EQUAL
            MOVE      TWENTY9,MONTHTOT   * Leap Year Feb has 29 days
          ELSE
            MOVE      TWENTY8,MONTHTOT   * Not a Leap Year Feb has 28 days
          ENDIF   
.
LEAPYR99  RETURN
.-----------------------------------------------------------------
. Outputs occurances of a particula Day. eg; Mondays for the Year
.       INPUTS: LOOKDAY,MONTHNO,MONTHTOT       called by: SESTBL00
.-----------------------------------------------------------------
SESDAT00  MOVE      ONE,DAYNO      * Day of month
          MOVE      ZERO,DISPCOL   * Number of columns to be displayed.
.
          CALL      SESHED00       * Diplay Month Heading
.                                  * Loops through Month
          WHILE     (DAYNO<=MONTHTOT)
            IF        LOOKDAY = FIRSTDAY
              ADD       ONE,DISPCOL
              CALL      SESROW00     * Display Date & CheckBox
            ENDIF
            ADD       ONE,FIRSTDAY
            IF        FIRSTDAY>7
              MOVE      ONE,FIRSTDAY   * Reset Day to 1=Monday
            ENDIF
            ADD       ONE,DAYNO
          DO
          IF          DISPCOL<5
            CALL        SESBLK00   * Last Column in table must be set to "&nbsp"
          ENDIF
.
          WRITE       HTMLFILE;"<tr>" * Close Row
.
SESDAT99  RETURN
.----------------------------------------------------------------------
.                               SESHED00
.  Displays Month left justified. Odd months are assigned a color and
.  vice versa for even months. 
.                                                   called by: SESDAT00
.----------------------------------------------------------------------
SESHED00  LOAD      MONDESC,MONTHNO,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                    OCT,NOV,DEC
.
          MOVE      MONTHNO,MONTHROW
          REP       " 0",MONTHROW
          ASSIGN    MONTHNO%2,F2    * Check if Odd or Even
          COMPARE   ZERO,F2
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr class=MonthRowEven><td>";
          ELSE
            WRITE     HTMLFILE;"<tr class=MonthRowOdd><td>";
          ENDIF
          IF        DELSES=1
            WRITE     HTMLFILE;"<input type=button class=button value=":
                               MONDESC:
                               " onclick=DeleteRow03(",MONTHROW,")></td>"
          ELSE
            WRITE     HTMLFILE;"<input type=button class=button value=":
                               MONDESC:
                               " onclick=UpdateRow03(",MONTHROW,")></td>"
          ENDIF
.
SESHED99  RETURN
.----------------------------------------------------------------------
.  Display Date & CheckBox row column               called by: SESDAT00
.  Variables Passed IN:
.                DOCTCODE - Surgeon
.                ANAETHET - Anaethetist
.                THETCODE - Theatre/Operating Room Code 
.                MONTHNO  - Month No.
.                DISPCOL  - Column No
.                DAYNO    - Day of month 
.----------------------------------------------------------------------
SESROW00  MOVE      "date",KEY4
          MOVE      MONTHNO,KEY2
          REP       " 0",KEY2
          MOVE      DISPCOL,LABEL
          REP       " 0",LABEL
          PACK       DATECGI,KEY4,KEY2,LABEL     * format = "date0101"
.
          MOVE      DAYNO,LABEL                   
          REP       " 0",LABEL
          PACK      DATE,SHOWYEAR,KEY2,LABEL     * Set session Date
.
.      Below: if not a session record then variables are assigned the
.            Session Schedule values. Else Session values assigned!
.
          CALL      SESSTA00
.
          IF        OPCNCLSU=0
            PACK      KEY6,OPSEM001,SP70    * If using Clinic then populate
            CALL      RDOPCLI1              * the surgeon with doctor code
            IF        OVRCD=0
              MATCH     SP70,OPCLDOCT
              IF        !@EQUAL
                MOVE      OPCLDOCT,DOCT
              ENDIF
            ENDIF
          ENDIF
          PACK      KEY11,DATE       * Check for Public Holiday
          CALL      RDPHOA1
          IF        OVRCD=1
            IF        IBCNMHOS=1
              PACK      KEY11,DATE,OPSMHOSP,SP70  * Check for Public Holiday
              CALL      RDPHOA1                   * for the clinics hospital
              BRANCH    OVRCD,SESROW10
            ELSE
              GOTO      SESROW10
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right class=HolidayCell width=5%>":
                             DAYNO,"</td><td class=HolidayCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE," id=HolidayCell":
                             CHECKED,"></td>"
          GOTO      SESROW99
.
SESROW10  PACK      KEY19,THEATRE,DATE,SP70  * Check for Unavailable Theatre 
          CALL      RSOPUAV1
          CALL      RKOPUAV1
          BRANCH    OVRCD,SESROW20  * Not Unavailable Theatre Date
          MATCH     THEATRE,OPUATHET
          GOTO      SESROW20 IF NOT EQUAL 
          MATCH     DATE,OPUADATE
          GOTO      SESROW20 IF NOT EQUAL 
.
          WRITE     HTMLFILE;"<td align=right class=TheatUsedCell width=5%>":
                             DAYNO,"</td><td class=TheatUsedCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE," id=TheatUsedCell":
                             CHECKED,"></td>"
          GOTO      SESROW99
.
SESROW20  PACK      KEY14,DOCT,DATE,SP70  * Check for Surgeon Leave Dates
          CALL      RDOPDLV1
          BRANCH    OVRCD,SESROW30      * Not found do positional read
          GOTO      SESROW40            * Record found output row
.
SESROW30  PACK      KEY14,DOCT,DATE,Z70  * Check for Surgeon Leave Dates
          CALL      RSOPDLV1
          CALL      RPOPDLV1
          BRANCH    OVRCD,SESROW50
          MATCH     DOCT,OPDVDOCT
          GOTO      SESROW50 IF NOT EQUAL
.
          MOVE      DATE,F8               * Move variables to forms...
          MOVE      OPDVFDTE,FROMDTE
          MOVE      OPDVTDTE,TODTE
.                                       * Check if date within leave dates
          IF        F8 >= FROMDTE & F8 <= TODTE
            GOTO      SESROW40          * Output Surgeon Leave color to html
          ELSE
            GOTO      SESROW50          * Check for Anaethetist Leave  
          ENDIF
.
SESROW40  WRITE     HTMLFILE;"<td align=right class=LeaveCell width=5%>":
                             DAYNO,"</td><td class=LeaveCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE," id=LeaveCell":
                             CHECKED,"></td>"
          GOTO      SESROW99
.
SESROW50  PACK      KEY14,ANAETH,DATE,SP70 * Check for Anaethetist Leave Dates
          CALL      RDOPDLV1
          BRANCH    OVRCD,SESROW60      * Not found do positional read
          GOTO      SESROW70            * Record found output row
.
SESROW60  PACK      KEY14,ANAETH,DATE,Z70  * Check for Anaethetist Leave Dates
          CALL      RSOPDLV1
          CALL      RPOPDLV1
          BRANCH    OVRCD,SESROW80
          MATCH     ANAETH,OPDVDOCT
          GOTO      SESROW80 IF NOT EQUAL
.
          MOVE      DATE,F8               * Move variables to forms...
          MOVE      OPDVFDTE,FROMDTE
          MOVE      OPDVTDTE,TODTE
.                                       * Check if date within leave dates
          IF        F8 >= FROMDTE & F8 <= TODTE
            GOTO      SESROW70          * Output Anaethetist Leave color to html
          ELSE
            GOTO      SESROW80          * Go on and Display Row 
          ENDIF
.
SESROW70  WRITE     HTMLFILE;"<td align=right class=AnaethLeaveCell width=5%>":
                             DAYNO,"</td><td class=AnaethLeaveCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE," id=AnaethLeaveCell":
                             CHECKED,"></td>"
          GOTO      SESROW99
.
SESROW80  MATCH     SP70,OPSMTHET
          GOTO      SESROW90 IF EQUAL
.
          MOVE      OPSMTIME,SAVESTIM
          MOVE      OPSMENDT,SAVEETIM
.
          MOVE      OPSMTHET,SAVETHET
          PACK      KEY28,OPSMHOSP,DATE,OPSMTHET,SP70
          CALL      RSOPSES4
SESROW85  CALL      RKOPSES4
          BRANCH    OVRCD,SESROW90
.
          PACK      KEY22,OPSMHOSP,DATE,SAVESTIM,OPSEM001,SP70
          PACK      SKEY22,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
          MATCH     KEY22,SKEY22
          GOTO      SESROW85 IF EQUAL
.
          MATCH     DATE,OPSEDATE
          GOTO      SESROW90 IF NOT EQUAL
.
          MATCH     OPSETHET,SAVETHET
          GOTO      SESROW90 IF NOT EQUAL
.
          MATCH     OPSETIME,SAVESTIM
          GOTO      SESROW86 IF LESS
.
          MATCH     OPSEENDT,SAVESTIM
          GOTO      SESROW89 IF LESS
.
          MATCH     OPSEENDT,SAVEETIM
          GOTO      SESROW85 IF NOT LESS
          GOTO      SESROW85 IF NOT EQUAL
          GOTO      SESROW89
.
SESROW86  MATCH     OPSETIME,SAVEETIM
          GOTO      SESROW89 IF NOT LESS
.
          MATCH     OPSEENDT,SAVEETIM
          GOTO      SESROW85 IF LESS
.
SESROW89  WRITE     HTMLFILE;"<td align=right class=TheatOverCell width=5%>":
                             DAYNO,"</td><td class=TheatOverCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE:
                             CHECKED,ID,"></td>"
          GOTO      SESROW99
.
SESROW90  MATCH     "1",DIFFTHET
          IF        @EQUAL
            WRITE   HTMLFILE;"<td align=right class=OtherTheatreCell width=5%>":
                             DAYNO,"</td><td class=OtherTheatreCell":
                             "><input type=checkbox name=":
                             DATECGI," value=",DATE:
                             CHECKED,ID,"></td>"
              GOTO     SESROW99
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right width=5%>":
                             DAYNO,"</td><td><input type=checkbox name=":
                             DATECGI," value=",DATE,CHECKED,ID,"></td>"
.
SESROW99  RETURN
.------------------------------------------------------------
. Determine Checked/Disable Status
.------------------------------------------------------------
SESSTA00  MOVE      SP70,CHECKED
          MOVE      SP70,DIFFTHET
          MOVE      SP70,DIFFHOSP
          MOVE      SP70,ID
.
          PACK      KEY22,OPSEM019,DATE,OPSEM003,OPSEM001,SP70
          CALL      RDOPSES1     * Check if Session date allready set
          BRANCH    OVRCD,SESSTA30
.
          IF        OPCNCLSU = 1
            MOVE      OPSECLIN,DOCT   * Using Doctor Code Not Clinic
          ENDIF
          MOVE      OPSEANAE,ANAETH     * Anaethetist
          MOVE      OPSETHET,THEATRE    * Operating Room/Theatre
.
          MATCH     OPSETHET,OPSEM007
          IF        !@EQUAL
            MOVE      ONE,DIFFTHET      * Different Theatre
          ENDIF
.
          CALL      BOKCHK00   * Returns whether there is a booking or not!
          BRANCH    EXIT,SESSTA20
.
          IF        DELSES=1
            MATCH     "1",DIFFHOSP      * Different Hospital
            IF        @EQUAL
              MOVE      " disabled checked",CHECKED
            ELSE
              MATCH     "1",DIFFTHET    * Different Theatre
              IF        @EQUAL
                MOVE      " disabled checked",CHECKED
              ELSE
                MOVE      " checked",CHECKED
              ENDIF
            ENDIF
          ELSE
            MOVE      " disabled checked",CHECKED
          ENDIF
          MOVE      " id=checked",ID
          MOVE      ZERO,EXIT
          GOTO      SESSTA99
.
SESSTA20  MOVE      " disabled checked",CHECKED
          MOVE      " id=checked",ID
          MOVE      ZERO,EXIT
          GOTO      SESSTA99
.
SESSTA30  IF        OPCNCLSU = 1
            MOVE      DOCTCODE,DOCT   * Using Doctor Code Not Clinic
          ENDIF
          MOVE      ANAETHET,ANAETH     * Anaethetist
          MOVE      THETCODE,THEATRE    * Operating Room/Theatre
          GOTO      SESSTA99
.
SESSTA99  RETURN
.----------------------------------------------------------------------
.  Display row column with Blanks
.  And Output cgi parameter for Javascript Column 5 ticks. As date__05
.  must be present else Javascript error is raised.
.                                                   called by: SESDAT00
.----------------------------------------------------------------------
SESBLK00  MOVE      "&nbsp;",KEY6
.
          MOVE      "date",KEY4
          MOVE      MONTHNO,KEY2
          REP       " 0",KEY2
          ADD       ONE,DISPCOL
          MOVE      DISPCOL,LABEL
          REP       " 0",LABEL
          PACK       DATECGI,KEY4,KEY2,LABEL * format = "date0101"
.
          WRITE     HTMLFILE;"<td align=right width=5%>":
                             KEY6,"</td><td><input type=hidden name=":
                             DATECGI,">",KEY6,"</td>"
.
SESBLK99  RETURN
.--------------------------------------------------------------------
. Check for booking in the session
.--------------------------------------------------------------------
BOKCHK00  PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,ZERO,SP70
          CALL      RSOPDEA1
BOKCHK10  CALL      RKOPDEA1
          BRANCH    OVRCD,BOKCHK98
.
          MATCH     OPDAHOSP,OPSEHOSP
          GOTO      BOKCHK98 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE
          GOTO      BOKCHK98 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSETIME
          GOTO      BOKCHK98 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSECLIN
          GOTO      BOKCHK98 IF NOT EQUAL
.
          COMPARE   "3",OPDASTAT
          GOTO      BOKCHK10 IF EQUAL
.
          MOVE      ONE,EXIT
          GOTO      BOKCHK99
.
BOKCHK98  MOVE      ZERO,EXIT
          GOTO      BOKCHK99
.
BOKCHK99  RETURN
.------------------------------------------------------------
. Next Month
.------------------------------------------------------------
NEXT0000  UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          ADD       ONE,F2
          IF        F2>12
            MOVE      ONE,F2
            ADD       ONE,F4
          ENDIF
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
          WRITE     HTMLFILE;KEY6;
.
NEXT9999  RETURN
.------------------------------------------------------------
. Last Month
.------------------------------------------------------------
LAST0000  UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          SUB       ONE,F2
          IF        F2<1
            MOVE      "12",F2
            SUB       ONE,F4
          ENDIF
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
          WRITE     HTMLFILE;KEY6;
.
LAST9999  RETURN
.------------------------------------------------------------
. Output Options for Month Selection
.------------------------------------------------------------
MTHOPT00  UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<0
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
MTHOPT10  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY8,F4,F2
          REP       " 0",KEY8
          MATCH     KEY8,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               MTHNAM,SP1,F4,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">":
                               MTHNAM,SP1,F4,"</option>"
          ENDIF
          ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      MTHOPT10 IF NOT EQUAL
.
MTHOPT99  RETURN
.------------------------------------------------------------
. Displays Day No. or Day Description
.               0 = Description
.               1 = Code 
.------------------------------------------------------------
SETDAY00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SETDAY10
.
          LOAD      DAYDESC,OPSMDAYI,MON,TUE,WED,THU,FRI,SAT,SUN
          WRITE     HTMLFILE;DAYDESC;   * Day Desc eg "Monday" 
          GOTO      SETDAY99
.
SETDAY10  WRITE     HTMLFILE;OPSMDAYI;  * Day Number 
.
SETDAY99  RETURN
.------------------------------------------------------------
. Operating Room/Theatre Selection List
.      0 = Description
.      1 = Code
.      2 = Selection List
.      3 = Active/Inactive Status
.------------------------------------------------------------
OPSLST00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY6,OPSMTHET,SP70
          CALL      RDOPOPR1
          IF        OVRCD=1 
            IF        F1=0  
              WRITE     HTMLFILE;"&nbsp";   * Output Blank Description
              GOTO      OPSLST99 
            ELSE 
              MOVE      OPSMTHET,OPRMROOM
            ENDIF
          ENDIF 
.
          BRANCH    F1,OPSLST10,OPSLST20,OPSLST30
.
          CLEAR     DISPNAME
          PACK      NAME35,OPRMDESC,SP70    * 0 = Description
          CALL      NAMSTR00             * Formatted
          RESET     DISPNAME
          MOVE      DISPNAME,KEY30
          WRITE     HTMLFILE;KEY30;
          GOTO      OPSLST99
.
OPSLST10  WRITE     HTMLFILE;OPRMROOM;
          GOTO      OPSLST99
.
OPSLST20  CALL      OSEL0000
          GOTO      OPSLST99
.
OPSLST30  WRITE     HTMLFILE;OPRMSTAT;
          GOTO      OPSLST99
.
OPSLST99  RETURN
.------------------------------------------------------------
. Operating Room/Theatre Code Selection
.------------------------------------------------------------
OSEL0000  PACK      KEY6,SP70
          CALL      RSOPOPR1
OSEL0100  CALL      RKOPOPR1
          BRANCH    OVRCD,OSEL9999
.
          MOVE      OPRMDESC,KEY35
          PACK      KEY8,QUOTE,OPRMROOM,QUOTE
.
.         Only display Active record selection list
.
          COMPARE   ZERO,OPRMSTAT
          GOTO      OSEL0100 IF NOT EQUAL
.
          MATCH     OPSMTHET,OPRMROOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               KEY35,"</option>"
          ELSE
.
            IF        IBCNMHOS=1
              MATCH     SP70,OPRMHOSP
              IF        !@EQUAL
                MATCH     OPRMHOSP,OPSMHOSP        * Same hospital as session
                GOTO      OSEL0100 IF NOT EQUAL
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY8,">",KEY35,"</option>"
          ENDIF
          GOTO      OSEL0100
.
OSEL9999  RETURN
.------------------------------------------------------------
. Doctor/Unit Selection List
.------------------------------------------------------------
OPDUSL00  PACK      KEY9,OPCLDOCT,SP70
          MATCH     SP70,KEY9       * no doctor, output all units
          IF        @EQUAL
            MOVE      "ST",CATEGORY
            MOVE      OPSMTYPE,CODE       * Session Type (Category ST)
            CALL      CODITM00
            GOTO      OPDUSL99
          ENDIF
.
          MOVE      SP70,KEY1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,OPDUSL05,OPDUSL09
.
          MOVE      "ST",CATEGORY
          MOVE      OPSMTYPE,CODE       * Session Type (Category ST)
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;     *.0 description
          GOTO      OPDUSL999
.
OPDUSL05  WRITE     HTMLFILE;OPSMTYPE;  *.1 Code
          GOTO      OPDUSL999
.
OPDUSL09  CALL      RSPMDUN1
OPDUSL10  CALL      RKPMDUN1            *.2 selection list
          BRANCH    OVRCD,OPDUSL99
.
          MATCH     OPCLDOCT,PMDUDOCT
          GOTO      OPDUSL99 IF NOT EQUAL
.
          MOVE      "ST",CATEGORY
          PACK      KEY5,CATEGORY,PMDUUNIT
          CALL      RDCODE1
.
          MATCH     "I",PTCOACTV
          GOTO      OPDUSL10 IF EQUAL
.
          MATCH     OPSMTYPE,PMDUUNIT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",PMDUUNIT," selected>":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",PMDUUNIT,">",TDESC,"</option>"
          ENDIF
          GOTO      OPDUSL10
.
OPDUSL99  RETURN
.-----------------------------------------------------------
. Link to for Redirect 
.-----------------------------------------------------------
LNKSER00  UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
.
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                   "&template=",FLDPARA;
.
.
LNKSER99  RETURN
.-----------------------------------------------------------
. Link to Next Group Codes           
.-----------------------------------------------------------
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"oprweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
NEXTPR99  RETURN
.-----------------------------------------------------------
. Link to Prev Group Codes           
.-----------------------------------------------------------
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"oprweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2; 
.
.
PREVPR99  RETURN
.------------------------------------------------------------
. Table of Operating Rooms - Schedules  
.------------------------------------------------------------
SEMTB000  MOVE      SP70,GLOBINDC
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,GLOBINDC,DIM127
.
          CALL      SEMHD000      * Output Table Heading
.
          PACK      KEY21,OPSEM001,SP70
          CALL      RSOPSEM2
SEMTB100  CALL      RKOPSEM2
          BRANCH    OVRCD,SEMTB999
.
          MATCH     OPSEM001,OPSMCLIN          * same Clinic/Surgeon
          GOTO      SEMTB999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPSMHOSP
            GOTO      SEMTB100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ACTVFILT              * Show all Sessions
          GOTO      SEMTB200 IF EQUAL
.
          MATCH     "1",ACTVFILT
          IF        @EQUAL
            COMPARE   ONE,OPSMSTAT
            GOTO      SEMTB100 IF NOT EQUAL    * Only show InActive Sessions
          ENDIF
.
          MATCH     "0",ACTVFILT
          IF        @EQUAL
            COMPARE   ONE,OPSMSTAT
            GOTO      SEMTB100 IF EQUAL        * Only show Active Sessions
          ENDIF
.
SEMTB200  CALL      SEMRW000      * Display Schedule Table Details Row
          GOTO      SEMTB100 
.
SEMTB999  RETURN
.------------------------------------------------------------
. Operating Room - Schedule Table Details (TABLE HEADING)
.------------------------------------------------------------
SEMHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "Day of Week</td>":
                               "<td class=HeadingCell width=20%>":
                               "Time</td>";
.
          MATCH     "1",GLOBINDC
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>":
                                 "Global Change</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                               "Unit</td>":
                               "<td class=HeadingCell width=20%>":
                               "Theatre</td>":
                               "<td class=HeadingCell width=20%>":
                               "Session Type</td>";
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td class=HeadingCell width=25%>":
                               "Hospital</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "</tr>"
.                                           * SEMHD000 CHANGED BY HPS
.                                      
SEMHD999  RETURN
.------------------------------------------------------------
. Operating Room - Schedule Table (TABLE ROW)
.------------------------------------------------------------
SEMRW000  COMPARE   SCHDLDAY,OPSMDAYI    * Check if day is the same 
          IF        @EQUAL
            MOVE      "&nbsp;",DAYDESC
          ELSE
            LOAD      DAYDESC,OPSMDAYI,MON,TUE,WED,THU,FRI,SAT,SUN
            MOVE      OPSMDAYI,SCHDLDAY
          ENDIF
.                                           * HPS Code Starts Here
          MOVE      "TU",CATEGORY           * Session Type (Category TU)
          MOVE      OPSMSTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.                                           * HPS Code Ends Here
.
          MOVE      "ST",CATEGORY       * Unit (Category ST)
          MOVE      OPSMTYPE,CODE
          CALL      GETCOD00  
.
          PACK      KEY6,OPSMTHET,SP70   * Get Theatre
          CALL      RDOPOPR1
          IF        OVRCD = 1
            MOVE      "&nbsp;",KEY35
          ELSE
            MOVE      OPRMDESC,KEY35    
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      SP70,PTHSNAME
            MATCH     SP70,OPSMHOSP
            IF        !@EQUAL
              PACK      KEY3,OPSMHOSP,SP10        * Multi Hospital
              CALL      RDPTHSP1
              IF        OVRCD=1
                MOVE      OPSMHOSP,PTHSNAME
              ENDIF
            ENDIF
          ENDIF
.
          IF        OPSMSTAT=0
            MOVE      "Active",DESCACTV
          ELSE
            MOVE      "Inactive",DESCACTV
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap>",DAYDESC,"</td>";
.
          MATCH     "1",GLOBINDC
          IF        @EQUAL
       WRITE     HTMLFILE;"<td><A HREF='javascript:ShowDetail01(#"oprweb05.pbl":
                               "?reportno=",LINKREP:
                               "&template=004":
                               "&opsem001=",CLINCODE:
                               "&opsem002=",OPSMDAYI:
                               "&opsem007=",OPSMTHET:
                               "&opsem019=",OPSMHOSP:
                               "&opsem003=",OPSMTIME,"#")'>":
                               "<img src=#"../images/MaintenanceIcon.gif#"":
                               " hspace=4 border=0 align=absmiddle></a>":
                               OPSMTIME," to ",OPSMENDT,"</td>";
          ELSE
           WRITE     HTMLFILE;"<td><A HREF='javascript:ShowDetail01(#"":
                                LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&opsem001=",CLINCODE:
                               "&opsem002=",OPSMDAYI:
                               "&opsem007=",OPSMTHET:
                               "&opsem019=",OPSMHOSP:
                               "&opsem003=",OPSMTIME,"#")'>":
                               "<img src=#"../images/MaintenanceIcon.gif#"":
                               " hspace=4 border=0 align=absmiddle></a>":
                               OPSMTIME," to ",OPSMENDT,"</td>":
                     "<td><A HREF='javascript:ShowDetail01(#"oprweb05.pbl":
                               "?reportno=",LINKREP:
                               "&template=004":
                               "&opsem001=",CLINCODE:
                               "&opsem002=",OPSMDAYI:
                               "&opsem007=",OPSMTHET:
                               "&opsem019=",OPSMHOSP:
                               "&opsem003=",OPSMTIME,"#")'>":
                               "<img src=#"../images/EditIcon.gif#"":
                               " hspace=4 border=0 align=absmiddle></a>":
                               "</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp</td><td>",KEY35,"</td>":
                             "<td>",KEY20,"&nbsp</td>";
.
         IF         IBCNMHOS=1
           WRITE      HTMLFILE;"<td>",PTHSNAME,"&nbsp;</td>";
         ENDIF
.
         WRITE      HTMLFILE;"<td>",DESCACTV,"&nbsp;</td>":
                             "</tr>" 
.
SEMRW999  RETURN
.--------------------------------------------------------------
. Table of Theatre Sessions                 called by: SLST0000 
.--------------------------------------------------------------
SESTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      SESHD000      * Display Table Heading
.
SESTAB05  PACK      KEY22,OPSES003,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPSES2
SESTAB10  CALL      RKOPSES2
          BRANCH    OVRCD,SESTAB99
.
          MATCH     OPSECLIN,OPSES003   * Match Clinic/Surgeon
          GOTO      SESTAB99 IF NOT EQUAL 
.
          MATCH     OPSEHOSP,WBSEHOSP   * Match Hospital
          GOTO      SESTAB99 IF NOT EQUAL 
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      SESTAB99 IF LESS
.
SESTAB20  CALL      SESRW000     * Display Table Row
          GOTO      SESTAB10
.
SESTAB99  RETURN
.-----------------------------------------------------------------------
.  Session Details (TABLE HEADING)
.-----------------------------------------------------------------------
SESHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>":
                             "Day</td>":
                             "<td class=HeadingCell>":
                             "Time</td>":
                             "<td class=HeadingCell>Theatre</TD>":
                             "<td class=HeadingCell>Unit</td>":
                             "<td class=HeadingCell>Status</td>":
                             "</tr>"
.
SESHD999  RETURN
.-----------------------------------------------------------------------
.  Session Details (TABLE ROW)
.-----------------------------------------------------------------------
SESRW000  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYDESC,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      "ST",CATEGORY        * Session Type (Category ST)
          MOVE      OPSETYPE,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        @EQUAL
            MOVE      "&nbsp;",TDESC
          ENDIF
.
          MOVE      SP70,KEY10
          COMPARE   ZERO,OPSESTAT
          IF        @EQUAL
            MOVE      "Cancelled",KEY10
          ELSE
            MOVE      "&nbsp;",KEY10
          ENDIF
.
          PACK      KEY6,OPSETHET,SP70   * Get Theatre
          CALL      RDOPOPR1
          IF        OVRCD = 1
            MOVE      "&nbsp;",KEY35
          ELSE
            MOVE      OPRMDESC,KEY35
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&opses074=",OPSEHOSP:
                             "&opses001=",OPSEDATE:
                             "&opses002=",OPSETIME:
                             "&opses003=",OPSECLIN,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             "<b>",CDAY,"</b> ",DAYDESC,"</td>":
                             "<td>",OPSETIME," to ",OPSEENDT,"</td>":
                             "<td>",KEY35,"</td><td>",TDESC,"</td>":
                             "<td>",KEY10,"</td></tr>"
.
SESRW999  RETURN
.
NURDET00  UNPACK    DIM127,D1,ANS,DIM127  
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,NURDET10,NURDET20
          MATCH     SP70,NURSCODE
          GOTO      NURDET99 IF EQUAL
.
.         C-0825792 CONTROL.OPCNURSE - Use oprnuraf/pmshcpaf for OT Nurse
          MATCH     "1",OPCNURSE                 * Use pmshcpaf for OT Nurse?
          GOTO      NURDET05 IF EQUAL            * Yes
.
          MOVE      NURSCODE,KEY6
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;DISPNAME;
          ENDIF
          GOTO      NURDET99
.
.         C-0825792 CONTROL.OPCNURSE=1 - Use pmshcpaf for OT Nurse
NURDET05  PACK      KEY10,NURSCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,NURDET99
          CLEAR     DISPNAME
          SQUEEZE   PMHCGNAM
          SQUEEZE   PMHCSNAM
          PACK      DISPNAME,PMHCGNAM,SP1,PMHCSNAM
          WRITE     HTMLFILE;DISPNAME;
          GOTO      NURDET99
.
NURDET10  MATCH     SP70,NURSCODE
          GOTO      NURDET99 IF EQUAL
          WRITE     HTMLFILE;NURSCODE;
          GOTO      NURDET99
.
.         C-0825792 CONTROL.OPCNURSE - Use oprnuraf/pmshcpaf for OT Nurse
NURDET20  MATCH     "1",OPCNURSE                 * Use pmshcpaf for OT Nurse?
          GOTO      NURDET30 IF EQUAL            * Yes
.
          PACK      KEY36,SP70
          CALL      RSOPNUR2
NURDET25  CALL      RKOPNUR2
          BRANCH    OVRCD,NURDET99
          BRANCH    OPNRSTAT,NURDET25
          MOVE      OPNRGNAM,ANS
          MATCH     OPNRCODE,NURSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OPNRCODE,"#" selected>":
                               OPNRSNAM,COMMA,ANS,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OPNRCODE,"#">":
                               OPNRSNAM,COMMA,ANS,"</option>"
          ENDIF
          GOTO      NURDET25
.
.         CONTROL.OPCNURSE=1 - Use pmshcpaf for OT Nurse
NURDET30  PACK      KEY10,SP70
          CALL      RSPMHCP1
NURDET35  CALL      RKPMHCP1
          BRANCH    OVRCD,NURDET99            * Exit at EOF
.
          MATCH     SP70,PMHCSTTS
          GOTO      NURDET35 IF EQUAL         * Ignore inactive
                                              
          IF  (PMHCHCST = 14 | PMHCHCST =15)
              GOTO NURDET38                   * List Nurse/Nurse & Other
          ELSE
              GOTO NURDET35                   * Ignore all non-nurse statuses
          ENDIF
.
NURDET38  MOVE      PMHCGNAM,ANS
          MATCH     PMHCHCPC,NURSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PMHCHCPC,"#" selected>":
                               PMHCSNAM,COMMA,ANS,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PMHCHCPC,"#">":
                               PMHCSNAM,COMMA,ANS,"</option>"
          ENDIF
          GOTO      NURDET35

NURDET99  RETURN
.
+
.******************************************************************************
.*                  MPST0000                    Called by : MODF7000  
.*        Update the session record with the changes                  
.*        Also have to check if the details file has to be updated    
.*                                                                    
.*        Check the details file for any operations scheduled for original sess.
.*        If the Clinic or Start time or Patient preparation time are changed,
.*        have to loop through the details file using the original session
.*        and change the expected start times on the details file.
.*        Then change the total time currently booked on the session file.
.******************************************************************************
.
MPST0000  MOVE      ZERO,BOOKTIME           * clear the actual booking time
          PACK      KEY26,KEY22,SP70        * key for positional read
          CALL      RSOPDEA5                * positional read details file
.
MPST1000  CALL      RKOPDEA5                * next read
          BRANCH    OVRCD,MPST9000          * end of file, update session file
.
          PACK      DIM22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN 
.                                                    * part of key to match
.
          MATCH     DIM22,KEY22
          GOTO      MPST9000 IF NOT EQUAL   * different session so done
.
....      COMPARE   THREE,OPDASTAT
....      GOTO      MPST1000 IF EQUAL       * different session so done
.
.         have the first details file record
.
          PACK      SAVEDEA,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDACASE:
                            OPDASTAT
          MOVE      "2",AUDIFLAG            * before change audit
          MOVE      KEY22,SAVESESS          * save session key
          CALL      ADEA0000                * write audit record
.
          MOVE      OPSES003,OPDACLIN       * the clinic
          MOVE      OPSES002,OPDATIME       * the session start time
          MOVE      OPSES002,OPDAEXPS       * the exp start time
          ADD       OPDAEXPD,BOOKTIME       * add exp duration to booking time
          MOVE      OPSES010,FORM2          * set up as a form
          MOVE      OPSETHET,OPDATHET       * the operating room
          ADD       FORM2,BOOKTIME          * add pat prep time to booking time
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
MPST1500  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      UPOPDEA5                * update first record
          TRAPCLR   IO
          COMPARE   ZERO,OVRCD
          GOTO      MPST1600 IF EQUAL
.
          MOVE      OPDAADMN,ADMISSNO
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,F3                 * Increase case number by 1
          MOVE      OPDACASE,F3             * if the new case already
          ADD       ONE,F3                  * exists in the new session.
          MOVE      F3,OPDACASE             * This should only happen for
          GOTO      MPST1500                * cancelled bookings
.
MPST1600  MOVE      "3",AUDIFLAG            * after change audit
          CALL      ADEA0000                * write audit record
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
          MOVE      SAVESESS,KEY22          * restore session key
.
.         loop through the details file and change the other records
.
MPST3000  MOVE      SAVEDEA,KEY26
          CALL      RDOPDEA5
MPST4000  CALL      RKOPDEA5                * read next record
          BRANCH    OVRCD,MPST9000          * no more records
.
          PACK      DIM22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN 
.                                           * part of key to match
.
          MATCH     DIM22,KEY22
          GOTO      MPST9000 IF NOT EQUAL   * different session so done
.
....      COMPARE   THREE,OPDASTAT
....      GOTO      MPST4000 IF EQUAL       * not a booking
.
.         have a valid record so update the expected start time and booking time
.
          PACK      SAVEDEA,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDACASE:
                            OPDASTAT
          MOVE      "2",AUDIFLAG            * before change audit
          MOVE      KEY22,SAVESESS          * save session key
          CALL      ADEA0000                * write audit record
.
          MOVE      OPSES003,OPDACLIN       * the clinic
          MOVE      OPSES002,OPDATIME       * the session start time
          MOVE      BOOKTIME,DURATION       * the booking time as duration
          CALL      ENDT0000                * calculate time after session start
          MOVE      ENDTIME,OPDAEXPS        * the expected start time
          COMPARE   THREE,OPDASTAT
          IF        !@EQUAL
            ADD       OPDAEXPD,BOOKTIME       * add exp duration to booking time
            MOVE      OPSES010,FORM2          * set up as a form
            ADD       FORM2,BOOKTIME          * add prep time to booking time
          ENDIF
          MOVE      OPSETHET,OPDATHET       * the operating room
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
MPST4500  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      UPOPDEA5                * update details file
          TRAPCLR   IO
          COMPARE   ZERO,OVRCD
          GOTO      MPST4600 IF EQUAL
.
          MOVE      OPDAADMN,ADMISSNO
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,F3                 * Increase case number by 1
          MOVE      OPDACASE,F3             * if the new case already
          ADD       ONE,F3                  * exists in the new session.
          MOVE      F3,OPDACASE             * This should only happen for
          GOTO      MPST4500                * cancelled bookings
.
MPST4600  MOVE      "3",AUDIFLAG            * after change audit
          CALL      ADEA0000                * write audit record
          IF        OPDASTAT <> 3
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14              * send update booking message
          ENDIF
.
          MOVE      SAVESESS,KEY22          * restore session key
          GOTO      MPST3000
.
. ----------------------------------------------
. ------- update the session file record -------
. ----------------------------------------------
MPST9000  
...       MOVE      OPSETIME,STARTIME       * the exp. start time
...       MOVE      OPSEDURA,DURATION       * the duration
...       CALL      ENDT0000                * calculate end time
...       MOVE      ENDTIME,OPSEENDT        * the end time
.
...       CALL      UPOPSES1                * update session file
          MOVE      ZERO,EXIT
          GOTO      MPST9999
.
MPST9900  MOVE      ONE,EXIT               * invalid session
.
MPST9999  RETURN
.
+
.*********************************************************************
.*                  ADEA0000                    Called by : MPST2000 *
.*        Audit routines for OPRDEAFD                                *
.*        Para's  : AUDIFLAG      which audit to do                  *
.*********************************************************************
ADEA0000  BRANCH    OPCNAUDB,ADEA9999
.
          COMPARE   THREE,AUDIFLAG       * is it an after change audit?
          GOTO      ADEA1000 IF EQUAL    * Yes. So don't change time
.
          CALL      IBACLOCK             * get current date
          PACK      OPDAAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OPDAAUDD
          MOVE      CTIMEIS,OPDAAUDT     * clock current time
.
ADEA1000  MOVE      ONE,OPDAAUDS         * not printed
          MOVE      PASSCODE,OPDAAUDO    * get user id
          MOVE      PORT,OPDAAUDP        * get port number
.
          MOVE      AUDIFLAG,OPDAAUDR
          REPLACE   "1A2B3C4D",OPDAAUDR
          PACK      KEY19,OPDAAUDD,OPDAAUDT,OPDAAUDP,OPDAAUDR
          CALL      AWOPDEA              * write audit record
.
ADEA9999  RETURN
+
.*****************************************************************************
.                   ENDT0000
.         Calculate the end time by adding the duration to the start time
.         Para's  : DURATION      the duration
.                   STARTIME      the start time
.         Returns : ENDTIME       the new endtime
.*****************************************************************************
ENDT0000  UNPACK    STARTIME,CHOUR,CMIN
          MOVE      CHOUR,CCOL2        * get the start time hours in CCOL2
          MOVE      CMIN,TOTMINS
          MOVE      DURATION,OPSMDURA  * get the duration as a form
.
          ADD       OPSMDURA,TOTMINS   * add duration to the startime minutes
          MOVE      TOTMINS,FORM4      * save the total minutes
          DIV       "60",TOTMINS       * divide total minutes to get extra hours
          ADD       TOTMINS,CCOL2      * add extra hours to startime hours
          COMPARE   "24",CCOL2         * test if greater than 12pm night
          GOTO      ENDT5555 IF LESS
          SUB       "24",CCOL2         * reset time to morning hours
ENDT5555
          MULT      "60",TOTMINS       * work out the remaining minutes
          SUB       TOTMINS,FORM4
          MOVE      FORM4,CCOL1
          PACK      ENDTIME,CCOL2,COLON,CCOL1
          REPLACE   " 0",ENDTIME
ENDT9999  RETURN
+
.------------------------------------------------------------
. GETSBC00 - Get session based comments                                *I-50678
.------------------------------------------------------------
GETSBC00  PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETSBC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETSBC90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETSBC80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETSBC10
.
GETSBC80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETSBC90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
GETSBC99  RETURN
+
.------------------------------------------------------------
.  Session Based comments                                              *I-50678
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
SBCMN000  MATCH     "010",TEMPLATE          * Exit if day comments template
          GOTO      SBCMN999 IF EQUAL
.
          PACK      KEY22,OPSES074,OPSES001,OPSES002,OPSES003,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            MOVE      OPSES001,OPSEDATE
            MOVE      OPSES002,OPSETIME
            MOVE      OPSES003,OPSECLIN
            MOVE      OPSES074,OPSEHOSP
          ENDIF
.
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM1
SBCMN400  CALL      RKOPCOM1
          BRANCH    OVRCD,SBCMN500          * end of file
.
          MATCH     OPSEDATE,OPCMDATE       * same date 
          GOTO      SBCMN500 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME       * same time?
          GOTO      SBCMN500 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN       * same clini / surgeon?
          GOTO      SBCMN500 IF NOT EQUAL
.
          MATCH     OPSEHOSP,OPCMHOSP       * same clini hospital
          GOTO      SBCMN400 IF NOT EQUAL
.
          PACK      KEY25,OPCMDATE,OPCMTIME,OPCMCLIN,OPCMLINE,OPCMHOSP,SP70
          CALL      DEOPCOM1
          GOTO      SBCMN400
.
.         now write the new comments back
.
SBCMN500  MOVE      ZERO,F3
.
SBCMN510  ADD       ONE,F3
          READ      COMFILAF,SEQ;OPCMTEXT
.
          MATCH     SP70,OPCMTEXT
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      SBCMN999
            ELSE
              GOTO      SBCMN510
            ENDIF
          ENDIF
.
          MOVE      F3,OPCMLINE
          MOVE      OPSEDATE,OPCMDATE
          MOVE      OPSETIME,OPCMTIME
          MOVE      OPSECLIN,OPCMCLIN
          MOVE      OPSEHOSP,OPCMHOSP
          MOVE      SP70,OPCMSPAR
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,OPCMLINE,OPCMHOSP
          CALL      RAOPCOM1
          IF        OVRCD=1
            CALL      WROPCOM1
          ENDIF
          IF        F3>=LASTITEM
            GOTO      SBCMN999
          ENDIF
          GOTO      SBCMN510
.
SBCMN999  RETURN
.
.------------------------------------------------------------
.  Day Based comments 
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
DYCMN000  MATCH     "010",TEMPLATE
          GOTO      DYCMN999 IF NOT EQUAL
.
. Delete any Pre V10.13 Day Comment with a blank hospital id
.
          MOVE      OPSES001,OPSEDATE
.
          PACK      KEY25,SP3,OPSEDATE,SP70
          CALL      RSOPCOM2
DYCMN100  CALL      RKOPCOM2
          BRANCH    OVRCD,DYCMN300          * end of file
.
          MATCH     SP3,OPCMHOSP             * same hospital
          GOTO      DYCMN300 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DYCMN300 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME           * same time?
          GOTO      DYCMN300 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN           * same clini / surgeon?
          GOTO      DYCMN300 IF NOT EQUAL
.
          PACK      KEY25,OPCMHOSP,OPCMDATE,OPCMTIME,OPCMCLIN,OPCMLINE
          CALL      DEOPCOM2
          GOTO      DYCMN100
.
DYCMN300  UNPACK    SP70,OPSETIME,OPSECLIN
          MOVE      OPSES001,OPSEDATE
          MATCH     SP70,OPSES074
          IF        @EQUAL
            MOVE      WBSEHOSP,OPSES074
          ENDIF
          MOVE      OPSES074,OPSEHOSP
.
          PACK      KEY25,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM2
DYCMN400  CALL      RKOPCOM2
          BRANCH    OVRCD,DYCMN500          * end of file
.
          MATCH     OPSEHOSP,OPCMHOSP       * same hospital
          GOTO      DYCMN500 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DYCMN500 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME       * same time?
          GOTO      DYCMN500 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN       * same clini / surgeon?
          GOTO      DYCMN500 IF NOT EQUAL
.
          PACK      KEY25,OPCMHOSP,OPCMDATE,OPCMTIME,OPCMCLIN,OPCMLINE
          CALL      DEOPCOM2
          GOTO      DYCMN400
.
.         now write the new comments back
.
DYCMN500  MOVE      ZERO,F3
.
DYCMN510  ADD       ONE,F3
          READ      COMFILAF,SEQ;OPCMTEXT
.
          MATCH     SP70,OPCMTEXT
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      DYCMN999
            ELSE
              GOTO      DYCMN510
            ENDIF
          ENDIF
.
          MOVE      F3,OPCMLINE
          MOVE      OPSEDATE,OPCMDATE
          MOVE      OPSETIME,OPCMTIME
          MOVE      OPSECLIN,OPCMCLIN
          MOVE      OPSEHOSP,OPCMHOSP
          MOVE      SP70,OPCMSPAR
          PACK      KEY25,OPCMHOSP,OPSEDATE,OPSETIME,OPSECLIN,OPCMLINE
          CALL      WROPCOM2
          IF        F3>=LASTITEM
            GOTO      DYCMN999
          ENDIF
          GOTO      DYCMN510
.
DYCMN999  RETURN
+
.------------------------------------------------------------
. Display Session Based Comments                                       *I-50678
.------------------------------------------------------------
DSCM0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM1
DSCM1000  CALL      RKOPCOM1
          BRANCH    OVRCD,DSCM9000          * end of file
.
          MATCH     OPSEDATE,OPCMDATE       * same date 
          GOTO      DSCM9000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME       * same time?
          GOTO      DSCM9000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN       * same clinic / surgeon?
          GOTO      DSCM9000 IF NOT EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MOVE      ONE,F1
            WRITE     HTMLFILE;F1;
            GOTO      DSCM9999
          ENDIF
.
          WRITE     HTMLFILE;OPCMTEXT
          GOTO      DSCM1000
.
DSCM9000  MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;F1;
          ENDIF
.
DSCM9999  RETURN
+
.------------------------------------------------------------
. Display Day Comments
.------------------------------------------------------------
DYCM0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
.
          PACK      KEY25,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM2
DYCM1000  CALL      RKOPCOM2
          BRANCH    OVRCD,DYCM5000          * end of file
.
          MATCH     OPSEHOSP,OPCMHOSP       * same date
          GOTO      DYCM5000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DYCM5000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME       * same time?
          GOTO      DYCM5000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN       * same clinic / surgeon?
          GOTO      DYCM5000 IF NOT EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MOVE      ONE,F1
            WRITE     HTMLFILE;F1;
            GOTO      DYCM9999
          ENDIF
.
          WRITE     HTMLFILE;OPCMTEXT
          GOTO      DYCM1000
.
. Check for Pre V10.13 Day comments with a blank hospital code
. Skip below section if it is not a multi hospital
.
DYCM5000  COMPARE   ONE,IBCNMHOS            * Using multi hospital
          GOTO      DYCM9000 IF NOT EQUAL
.
          PACK      KEY25,SP3,OPSEDATE,SP70
          CALL      RSOPCOM2
DYCM5100  CALL      RKOPCOM2
          BRANCH    OVRCD,DYCM9000          * end of file
.
          MATCH     SP3,OPCMHOSP            * same hospital
          GOTO      DYCM9000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DYCM9000 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME       * same time?
          GOTO      DYCM9000 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN       * same clinic / surgeon?
          GOTO      DYCM9000 IF NOT EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MOVE      ONE,F1
            WRITE     HTMLFILE;F1;
            GOTO      DYCM9999
          ENDIF
.
          WRITE     HTMLFILE;OPCMTEXT
          GOTO      DYCM5100 
.
DYCM9000  MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;F1;
          ENDIF
.
DYCM9999  RETURN
+
.------------------------------------------------------------
. Update Session Based Comments during session master update           *I-50678
.------------------------------------------------------------
UPDCOM00  MATCH     OPSES002,SESSTIME       * Exit if start time not changed
          GOTO      UPDCOM99 IF EQUAL
.
          MATCH     SP70,OPSES074
          IF        @EQUAL
            MOVE      OPSEHOSP,OPSES074
          ENDIF
.
          PACK      KEY25,OPSES001,OPSES002,OPSES003,SP70
          CALL      RSOPCOM1
UPDCOM02  CALL      RKOPCOM1
          BRANCH    OVRCD,UPDCOM08          * end of file
.
          MATCH     OPSES001,OPCMDATE       * same date
          GOTO      UPDCOM08 IF NOT EQUAL
.
          MATCH     OPSES002,OPCMTIME       * same time?
          GOTO      UPDCOM08 IF NOT EQUAL
.
          MATCH     OPSES003,OPCMCLIN       * same clini / surgeon?
          GOTO      UPDCOM08 IF NOT EQUAL
.
          MATCH     OPSES074,OPCMHOSP       * same hospital?
          GOTO      UPDCOM02 IF NOT EQUAL
.
          PACK      KEY25,OPCMDATE,OPCMTIME,OPCMCLIN,OPCMLINE,OPCMHOSP
          CALL      DEOPCOM1
          GOTO      UPDCOM02
.
UPDCOM08  PACK      KEY25,OPSES001,SESSTIME,OPSES003,SP70
          CALL      RSOPCOM1
UPDCOM10  CALL      RKOPCOM1
          BRANCH    OVRCD,UPDCOM99
.
          MATCH     OPSES001,OPCMDATE
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MATCH     SESSTIME,OPCMTIME
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MATCH     OPSES003,OPCMCLIN
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MOVE      OPCMDATE,SAVEDATE
          MOVE      OPCMTIME,SAVETIME
          MOVE      OPCMCLIN,SAVECLIN
          MOVE      OPCMLINE,SAVELINE
          MOVE      OPCMTEXT,SAVETEXT
          MOVE      OPCMHOSP,SAVEHOSP
.
          PACK      KEY25,OPSES001,OPSES002,OPSES003,OPCMLINE,OPSES074
          CALL      RDOPCOM1
          IF        OVRCD=ONE
            MOVE      OPSES001,OPCMDATE
            MOVE      OPSES002,OPCMTIME
            MOVE      OPSES003,OPCMCLIN
            MOVE      SAVELINE,OPCMLINE
            MOVE      SAVETEXT,OPCMTEXT
            MOVE      OPSES074,OPCMHOSP
            MOVE      SP70,OPCMSPAR
            CALL      WROPCOM1
          ELSE
            MOVE      SAVETEXT,OPCMTEXT
            CALL      UPOPCOM1
          ENDIF
.
          PACK     KEY25,SAVEDATE,SAVETIME,SAVECLIN,SAVELINE,SAVEHOSP
          CALL     RDOPCOM1

          GOTO     UPDCOM10
.
UPDCOM99  RETURN
+
.*********************************************************************
.         calculate default start time
.*********************************************************************
CALDEF00  PACK      KEY26,SESNHOSP,SESNDATE,SESNTIME,SESNCODE,Z70
          UNPACK    SESNTIME,CHOUR,ANS,CMIN
.
          CALL      RSOPDEA5
CALDEF01  CALL      RPOPDEA5
          BRANCH    OVRCD,CALDEF99
.
          MATCH     OPDAHOSP,SESNHOSP
          GOTO      CALDEF90 IF NOT EQUAL
.
          MATCH     OPDADATE,SESNDATE
          GOTO      CALDEF90 IF NOT EQUAL
.
          MATCH     OPDATIME,SESNTIME
          GOTO      CALDEF90 IF NOT EQUAL
.
          MATCH     OPDACLIN,SESNCODE
          GOTO      CALDEF90 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT                 * must be booked status
          GOTO      CALDEF01 IF EQUAL
.
.         we have found the last booking in the session
.
          UNPACK    OPDAEXPS,CHOUR,ANS,CMIN
          MOVE      CHOUR,FORM4        * FORM4 will be totmins
          MOVE      CMIN,FORM2
.
          MULT      "60",FORM4         * convert hours to minutes
          ADD       FORM2,FORM4        * add the minutes
          ADD       OPDAEXPD,FORM4     * add the duration for total mins
          ADD       OPSEPREP,FORM4
          IF        OPDAEXPD=0
            ADD       ONE,FORM4
          ENDIF
.
CALDEF33  COMPARE   "1440",FORM4       * test if added or subtracted
          GOTO      CALDEF44 IF LESS
          SUB       "1440",FORM4       * add a day from totmins
          GOTO      CALDEF33
.
CALDEF44  MOVE      FORM4,SAVEF10      * save the new total mins
          DIV       "60",FORM4
          MOVE      FORM4,FORM2
          MOVE      FORM2,CHOUR        * save the new hours
.
          MULT      "60",FORM4         * calculate remaining minutes
          SUB       FORM4,SAVEF10
          MOVE      SAVEF10,FORM2
          MOVE      FORM2,CMIN         * save the new minutes
.
          REP       " 0",CHOUR
          REP       " 0",CMIN
          GOTO      CALDEF99
.
CALDEF90  UNPACK    SESNTIME,CHOUR,ANS,CMIN

CALDEF99  RETURN
.**********************************************************************
.*  CNRAL000  :  Cancel any reallocations found for this session      *
.**********************************************************************
CNRAL000
.         MATCH    SP6,OPSETHET                   * must have a theatre
.         GOTO     CNRAL999 IF EQUAL
.
          OPEN     OPRRALA1,"oprralaf"
          OPEN     OPRRALA2,"oprralaf"
.
          PACK     KEY30,OPSEDATE,OPSETIME,OPSECLIN,SP30
          CALL     RSOPRAL1
CNRAL100  CALL     RKOPRAL1
          BRANCH   OVRCD,CNRAL500
.
          MATCH    OPSEDATE,OPRLDATE              * same date?
          GOTO     CNRAL500 IF NOT EQUAL
          MATCH    OPSETIME,OPRLSTOR              * same time?
          GOTO     CNRAL500 IF NOT EQUAL
          MATCH    OPSECLIN,OPRLSUOR              * same clinic?
          GOTO     CNRAL500 IF NOT EQUAL
.
          PACK     KEY30,OPRLDATE,OPRLSTOR,OPRLSUOR,OPRLSTNW,OPRLSUNW
          CALL     DEOPRAL1
          GOTO     CNRAL000
.
. try session as a new session
.
CNRAL500  PACK     KEY30,OPSEDATE,OPSETIME,OPSECLIN,SP30
          CALL     RSOPRAL2
          CALL     RKOPRAL2
          BRANCH   OVRCD,CNRAL900
.
          MATCH    OPSEDATE,OPRLDATE              * same date?
          GOTO     CNRAL900 IF NOT EQUAL
          MATCH    OPSETIME,OPRLSTNW              * same time?
          GOTO     CNRAL900 IF NOT EQUAL
          MATCH    OPSECLIN,OPRLSUNW              * same clinic?
          GOTO     CNRAL900 IF NOT EQUAL
.
          PACK     KEY30,OPRLDATE,OPRLSTNW,OPRLSUNW,OPRLSTOR,OPRLSUOR
          CALL     DEOPRAL2
          GOTO     CNRAL500
.
CNRAL900  CLOSE    OPRRALA1
          CLOSE    OPRRALA2
.
CNRAL999  RETURN
.
.*********************************************************************
.                   CENDTIME
.         Calculate an end time given a start time and duration
.         Para's  : STARTIM1      the start time
.                   DURATION      the duration
.         Returns : ENDTIME       the end time
.*********************************************************************
.
          DEFPROC   CENDTIME
.
.         variables
.
CCOL1     FORM      2         * ends up as the new hours
CCOL2     FORM      3         * ends up as the new minutes
FORM4     FORM      4
FORM4A    FORM      4
.
.    example of logic
.    10:35 + 90 minutes
.    = 10 hours + 125 minutes
.    = 10 hours + (2 hours + 5 minutes)
.    = 12 hours + 5 mins
.    = 12:05
.
ENDTIM00 
.>>>>>>>  KEYIN     *P1:1,*EF,"Enter the start time -> ",STARTIM1
.>>>>>>>  KEYIN     *P1:2,"Enter the duration   -> ",DURATION
.
          UNPACK    STARTIM1,CHOUR,ANS,CMIN
          REP       " 0",CHOUR
          REP       " 0",CMIN
          MOVE      CHOUR,CCOL1             * the hours
          MOVE      CMIN,FORM2              * the minutes
          MOVE      DURATION,FORM4          * the duration work var 1
.
          ADD       FORM2,FORM4             * total minutes
          MOVE      FORM4,FORM4A            * total minutes save variable
.
          DIV       "60",FORM4              * total minutes as whole hours
          ADD       FORM4,CCOL1             * set up the hours
.
          MULT      "60",FORM4              * actual whole hours added as mins
          SUB       FORM4,FORM4A            * minutes left to add
          MOVE      FORM4A,CCOL2            * the actual minutes to add
.
.         check hours aren't over 23
.
ENDTIM50  COMPARE   "24",CCOL1
          GOTO      ENDTIM70 IF LESS        * hours not over 24
.
          SUB       "24",CCOL1
          GOTO      ENDTIM50
.
ENDTIM70  MOVE      CCOL2,FORM2             * the minutes
          PACK      ENDTIME,CCOL1,COLON,FORM2
          REP       " 0",ENDTIME
.
ENDTIM99  ENDPROC
+
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
WEBOV100  CALL      OPENHTML
          BRANCH    EXIT,WEBOV195
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
          "  var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                   "  if (confirm(#"",WEBTITLE,"#")) {":
                   "    parent.AddForm.overrid1.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ":
                   "    parent.AddForm.submit(); }":
                   "  else {":
                   "    if (PopUpScreen) {":
                   "      PopUpScreen.style.display='none';} ":
                   "    else {":  
                   "      history.go(-1);  }}":
                   "}":
                   "</script>"
.
          CALL      CLOSHTML
          GOTO      WEBOV199
.
WEBOV195  DISPLAY   "*** Fifo Not Found ***"
.
WEBOV199  RETURN
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
WEBOV200  CALL      OPENHTML
          BRANCH    EXIT,WEBOV295
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  if (confirm(#"",WEBTITLE,"#")) {;":
                   "    parent.AddForm.overrid2.value=#"1#"; ":
                   "    parent.AddForm.overrid3.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ":
                   "    parent.AddForm.submit(); }":
                   "  else {":
                   "    parent.AddForm.overrid2.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ":
                   "    parent.AddForm.submit(); }":
                   "}":
                   "</script>"
.
          CALL      CLOSHTML
          GOTO      WEBOV299
.
WEBOV295  DISPLAY   "*** Fifo Not Found ***"
.
WEBOV299  RETURN
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
WEBOV400  CALL      OPENHTML
          BRANCH    EXIT,WEBOV495
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
          "  var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                   "  if (confirm(#"",WEBTITLE,"#")) {":
                   "    parent.AddForm.overrid4.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ":
                   "    parent.AddForm.submit(); }":
                   "  else {":
                   "    if (PopUpScreen) {":
                   "       PopUpScreen.style.display='none'; } ":
                   "    else {":
                   "       history.go(-1);  }}":
                   "}":
                   "</script>"
.
          CALL      CLOSHTML
          GOTO      WEBOV499
.
WEBOV495  DISPLAY   "*** Fifo Not Found ***"
.
WEBOV499  RETURN
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
WEBOV500  CALL      OPENHTML
          BRANCH    EXIT,WEBOV595
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  if (confirm(#"",WEBTITLE,"#")) {;":
                   "    parent.AddForm.overrid5.value=#"1#"; ":
                   "    parent.AddForm.overrid6.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ": 
                   "    parent.AddForm.submit(); }":
                   "  else {":
                   "    parent.AddForm.overrid5.value=#"1#"; ":
                   "    parent.AddForm.target=#"PopUpFrame#"; ":
                   "    parent.AddForm.submit(); }":
                   "}":
                   "</script>"
.
          CALL      CLOSHTML
          GOTO      WEBOV599
.
WEBOV595  DISPLAY   "*** Fifo Not Found ***"
.
WEBOV599  RETURN
.------------------------------------------------------------
. Gets anaesthetist from default team details if available
.------------------------------------------------------------
GETANA00  MOVE     SP70,DIM3
          MOVE     SP70,DIM6
.         
          MOVE     OPSES031,DIM3
          MOVE     OPSES039,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES030,DIM3
          MOVE     OPSES038,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES029,DIM3
          MOVE     OPSES037,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES028,DIM3
          MOVE     OPSES036,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES027,DIM3
          MOVE     OPSES035,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES026,DIM3
          MOVE     OPSES034,DIM6
          CALL     ANAGET00
.
          MOVE     OPSES025,DIM3
          MOVE     OPSES033,DIM6
          CALL     ANAGET00
.
GETANA99  RETURN
+
.----------------------------------------------------
. Get Anaesthetist subroutine
. Parameters: DIM3 - Operating Personnel code
.             DIM6 - Doctor Code
.----------------------------------------------------
ANAGET00  MATCH    DIM3,SP70                       * Checks for anaesthetist
          GOTO     ANAGET90 IF EQUAL               * in default team operating
          GOTO     ANAGET90 IF EOS                 * personnel field X
.
          PACK     KEY5,ANSO,ANSP,DIM3,SP70
          CALL     RDCODE1
          BRANCH   OVRCD,ANAGET90
.
          MATCH    "A",TCINDC2
          GOTO     ANAGET90 IF NOT EQUAL
.
          MATCH    DIM6,SP70
          GOTO     ANAGET90 IF EQUAL
          GOTO     ANAGET90 IF EOS
.
          PACK     OPSEANAE,DIM6,SP6
.
ANAGET90  MOVE     SP70,DIM3
          MOVE     SP70,DIM6
.
ANAGET99  RETURN
.
.------------------------------------------------------------
. Global Change Theatre Sessions
.------------------------------------------------------------
GLUSES00  PACK      KEY22,OPSEM001,OPSEM019,FROMDATE,SP70
          CALL      RSOPSES2
GLUSES20  CALL      RKOPSES2
          BRANCH    OVRCD,GLUSES99
.
          MATCH     OPSECLIN,OPSEM001
          GOTO      GLUSES99 IF NOT EQUAL
.
          MATCH     OPSEHOSP,OPSEM019
          GOTO      GLUSES99 IF NOT EQUAL
.
          MATCH     OPSEDATE,TOEDDATE
          GOTO      GLUSES99 IF LESS
.
          MOVE      ZERO,FORM1
          MOVE      OPSEM002,FORM1
          COMPARE   OPSEDAY,FORM1
          GOTO      GLUSES20 IF NOT EQUAL
          MATCH     OPSETIME,OPSEM003
          GOTO      GLUSES20 IF NOT EQUAL
.
          MOVE      OPSEM007,OPSETHET
          MOVE      OPSEM005,OPSETPER
          MOVE      OPSEM006,OPSETYPE
.
          MOVE      OPSEM011,OPSEANAE
          MOVE      OPSEM011,OPSEDCC2
.
          MOVE      OPSEM012,OPSEXDOC
          MOVE      OPSEM017,OPSESTYP
          MOVE      OPSEM018,OPSEDGSI
          MOVE      OPSEM014,OPSESPI1
          MOVE      OPSEM015,OPSESPI2
.
GLUSES40  CALL      UPOPSES2
.
          CALL      GLUDET00                * Update oprdetaf theatre
          GOTO      GLUSES20
.
GLUSES99  RETURN
.
.------------------------------------------------------------
. Global Change Theatre Sessions
.------------------------------------------------------------
GLUDET00  PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
GLUDET10  CALL      RKOPDEA1
          BRANCH    OVRCD,GLUDET99
.
          MATCH     OPSEHOSP,OPDAHOSP        * Same Hospital?
          GOTO      GLUDET99 IF NOT EQUAL    * No, exit loop
.
          MATCH     OPSEDATE,OPDADATE        * Same Session Date?
          GOTO      GLUDET99 IF NOT EQUAL    * No, exit loop
.
          MATCH     OPSETIME,OPDATIME        * Same Session Time?
          GOTO      GLUDET99 IF NOT EQUAL    * No, exit loop
.
          MATCH     OPSECLIN,OPDACLIN        * Same Clinic/Surgeon?
          GOTO      GLUDET99 IF NOT EQUAL    * No, exit loop
.
          MOVE      OPSETHET,OPDATHET        * Update bookings theatre
.
          CALL      UPOPDEA1
          GOTO      GLUDET10
.
GLUDET99  RETURN
.
.*******************************************************************************
.                   OPCHKFUL
.*******************************************************************************
OPCHKFUL  CALL      RDOPSES1                * get session details
          COMPARE   ZERO,OPCNFULL
          GOTO      CHKFUL44 IF NOT EQUAL   * using the system parameter
.
          SUB       OPSEBRKT,OPSEDURA       * Duration -= breaktime
          COMPARE   OPSETIMB,OPSEDURA       * test duration is < than book time
          GOTO      CHKFUL80 IF LESS        * duration is less -> full
          GOTO      CHKFUL90                * session is not full
.
.         check against the system parameter
.
CHKFUL44  MOVE      OPSETIMB,FORM6P2   * Set up time booked in session
          SUB       OPSEBRKT,OPSEDURA  * Duration -= breaktime
          DIV       OPSEDURA,FORM6P2   * Time book = time book/duration
          MULT      "100",FORM6P2      * convert to a percentage
.
          MOVE      FORM6P2,FORM3      * Get rid of fractions
          COMPARE   OPCNFULL,FORM3     * test percentage full against sys param
          GOTO      CHKFUL90 IF LESS
.
.         session is full
.
CHKFUL80  MOVE      ZERO,EXIT          * Signal session is full
          GOTO      CHKFUL99
.
.         session is not full
.
CHKFUL90  MOVE      ONE,EXIT           * signal session is not full
.
CHKFUL99  RETURN
.*******************************************************************************
.                   OPSUSPND
.*******************************************************************************
OPSUSPND  CALL      RDOPSES1           * get session details
          BRANCH    OVRCD,SUSPND99
.
          MOVE      "2",AUDIFLAG       * before change audit
          CALL      AUSES000           * write audit record
          MOVE      ONE,OPSESUSP       * suspend session
          CALL      UPOPSES1           * update record
          MOVE      "3",AUDIFLAG       * after change audit
          CALL      AUSES000           * write audit record
.
          MOVE      ZERO,EXIT
          GOTO      SUSPND99
.
SUSPND99  RETURN
.
.*******************************************************************************
.                   OPUNSPND
.*******************************************************************************
OPUNSPND  CALL      RDOPSES1           * get session details
          BRANCH    OVRCD,UNSPND99
.
          MOVE      "2",AUDIFLAG       * before change audit
          CALL      AUSES000           * write audit record
          MOVE      TWO,OPSESUSP       * Unsuspend session
          CALL      UPOPSES1           * update record
          MOVE      "3",AUDIFLAG       * after change audit
          CALL      AUSES000           * write audit record
.
UNSPND80  MOVE      ZERO,EXIT
          GOTO      UNSPND99
.
UNSPND99  RETURN
+
.-----------------------------------------------------------------------
AUSES000  BRANCH    OPCNAUDS,AUSES999
          PACK      SAVKEY20,KEY19,SP1      * save key19 on entry
.
          COMPARE   FIVE,AUDIFLAG        * test to delete B audit
          GOTO      AUSES600 IF EQUAL
.
          COMPARE   THREE,AUDIFLAG       * is it an after change audit?
          GOTO      AUSES100 IF EQUAL    * Yes. So don't change time
.
          CALL      IBACLOCK             * get current date
          PACK      OPSEAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OPSEAUDD
          MOVE      CTIMEIS,OPSEAUDT     * clock current time
.
AUSES100  MOVE      ONE,OPSEAUDS         * not printed
          MOVE      PASSCODE,OPSEAUDO    * get user id
          MOVE      PORT,OPSEAUDP        * get port number
.
          MOVE      AUDIFLAG,OPSEAUDR
          REPLACE   "1A2B3C4D",OPSEAUDR
          PACK      KEY19,OPSEAUDD,OPSEAUDT,OPSEAUDP,OPSEAUDR
          CALL      AWOPSES              * write audit record
          GOTO      AUSES995
.
.         now delete B audit
.
AUSES600  PACK      KEY19,OPSEAUDD,OPSEAUDT,OPSEAUDP,ANSB
          CALL      ADOPSES              * delete audit record
AUSES995  UNPACK    SAVKEY20,KEY19,ANS      * restore the key19
.
AUSES999  RETURN
.-----------------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       CLOPRSES
          INC       OPRDEAIO/INC   * Operating Room - Session Details
          INC       OPRTSMIO/INC
          INC       OPROPRIO/INC   * Operating Room I/O
          INC       OPRCLIIO/INC   * Operating Room - Clinic File
          INC       OPRCOMIO/INC   * Session based comments File       *I-50678
          INC       OPRRALIO/INC
          INC       OPRSEMIO/INC   * Operating Room - Session Master(Schedule) 
          INC       OPRSESIO/INC   * Operating Room - Session Details 
          INC       OPRNURIO/INC   * Operating Room - Nurses File
          INC       OPRUAVIO/INC   * Operating Room - Unavailable Theatre file
          INC       OPRDLVIO/INC   * Doctors Leave
          INC       OUTPHOIO/INC   * Outpatients - Public Holiday File
          INC       PATDO1IO/INC   * Doctor File
          INC       PATHSPIO/INC   * Multi-hospital File
          INC       PATMA1IO/INC
          INC       PMSHCPIO/INC   * C-0825792 HCP File
          INC       PMSPX2IO/INC
          INC       PATNIDIO/INC
          INC       NHIMASIO/INC   
          INC       OPRDECIO/INC   * HPS Added
          INC       PMSDUNIO/INC
          INC       OPRSRGIO/INC
          INC       OPRARDIO/INC
          INC       CLPMSPX2
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PMIGTNID
          INC       PMSCURTH
          INC       OPRSESTM
          INC       OPRCLASH
          INC       DAYOFWEK
          INC       DGCLIS14
          INC       NAMSTRCD
          INC       TFILENAM
          INC       CLOPRTSM
          INC       WEBDATCD
.
