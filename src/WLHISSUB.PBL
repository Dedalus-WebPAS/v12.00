.******************************************************************************
.* Common Routines for the Waiting List History                               *
.******************************************************************************
.*  Routines      : SAVHIS00 - Save the History Variables                     *
.*                : WRTHIS00 - Write to Waiting List History                  *
.*                : GETRSC00 - Get Reason for Change of Sched Adm Date        *
.*  Parameters    :                                                           *
.*                  NBRFLAG  - 0=Not Required for NBRS                        *
.*                             1=Add Record                                   *
.*                             2=Change Record                                *
.*                             3=Delete Record                                *
.*                             4=Erase Record                                 *
.*                  ADDWLFLG - Set effective date to the date on list         *
.*                             Should only be used for Add W/List Records     *
.*                             0=No 1=Yes                                     *
.*  Modifications :                                                           *
.*       V10.14.01  19/09/2019  Richa Phogat   TSK  0867693                   *
.*                  Added condition under WRTHIS70, if WTHIBSCD=05 then make  *
.*                  WTHIDBFT blank                                            *
.*       V10.13.01  20/11/2018  Jill Parkinson Task 0865808                   *
.*                  Added check for WTCNBRSR=0 to use wtwmsrcr                *
.*       V10.03.01  28/10/2013 Patrick Adair CAR 201234                       *
.*                  Remove status code check before writing new booking number*
.*        V9.10.01  01/05/2008 Jill Habasque CAR 166097                       *
.*                  Added WTHIASSR                                            *
.*        V9.08.02  10/07/2007 Jill Habasque CAR 144382                       *
.*                  Added match of WMDATE2 in WRTHIS95                        *
.*        V9.08.01  27/04/2007 Jill Habasque CAR 137931                       *
.*                  Added move of WMDATE1,WTHIRCDT when adding to wl          *
.*        V9.05.B01 30/09/2005 Mike Laming   CAR 52354                        *
.*                  Correct IF statement for WTWMCSST at WRTHSS00             *
.*        V9.04.01  30/09/2005 Mike Laming   CAR 52354                        *
.*                  Add Consent History WTHICSST and WTHICSDT                 *
.*        V9.03.03  28/05/2004 Jill Habasque CAR 50240                        *
.*                  Fixed clearing of user id                                 *
.*        V9.03.02  22/07/2003 Jill Habasque CAR 34660                        *
.*                  Added nbrflag 3 and 4                                     *
.*        V9.03.01  23/06/2003 Ebon Clements CAR 40610                        *
.*                  Added save of new variable SAVEDTAD                       *
.*        V9.02.09  10/04/2003 Jill Habasque SRF 22674                        *
.*                  Added move of SAVEBCAN to WTHIBCAN                        * 
.*        V9.02.08  12/03/2003 Jill Habasque SRF 23436                        *
.*                  Changed to save previous booking number for removed bookings
.*        V9.02.07  29.11.2002 Jill Habasque                                  *
.*                  Changed to move CTIMEIS to WTHIATIM (instead of WBSEUID)  *
.*        V9.02.06  09.07.2002 Ebon Clements SRF 17676                        *
.*                  Added update of WTHIBCAN,WTHISTA,WTHIUNIT,WTHIDAT1        *
.*        V9.02.05  02.07.2002 Jill Habasque                                  *
.*                  Added 32 for Unremove in history screen                   *
.*        V9.02.04  28.06.2002 Ebon Clements SRF 17676 17694 17700            *
.*                  Added new function to write non NBRS data to the          *
.*                  history file WRTHSS00                                     *
.*        V9.02.03  01.02.2002 Ebon Clements                                  *
.*                  Added set of effective date to cgi variable WATHI002      *
.*        V9.02.02  24.01.2002 Ebon Clements                                  *
.*                  Added test for ADDWLFLG to set the effective date in the  *
.*                  history file to the date on list when a waiting list      *
.*                  entry is created                                          *
.*        V9.02.01  15.11.2001 B.G.Ackland                                    *
.*                  Remove Check on PTCNURHA for History File                 *
.*        V9.02.01  13/09/2001 Rahul Gupta HPS                                *
.*                  Checked for Alteration Date                               * 
.*        V9.00.B01 22.07.2001 HPS Bangalore                                  *
.*                  Modified for Bug fixing                                   *
.*        V5.09.B01 01/02/2001  Greg Horvat                                   *
.*                  Replaced Z variables with Z70                             *
.*                  26/07/2000  Jill Habasque                                 *
.*                  Added WRTNBR00 - write to watnbraf                        *
.*                  11/07/2000  Jill Habasque                                 *
.*                  Added WTHIRCDT - rank change date                         *
.*                  08/06/2000  Tonii Tang                                    *
.*                  Mods to save and check for changes in Booking Status Code *
.******************************************************************************

.******************************************************************************
.* SAVHIS00 - Save the History Variables
.******************************************************************************
SAVHIS00  MOVE      WMPTY,SAVEPRIO
          MOVE      WTWMRANK,SAVERANK
          MOVE      WMDATE2,SAVEDAT2  
          MOVE      WMDATE3,SAVEDAT3  
          MOVE      WTWMBSCD,SAVEBSCD     * Save Booking Status Code
          MOVE      SP10,SAVERDT3
          MOVE      WMBOOK,SAVEBOOK
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      SAVEBRSR,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      SAVEBRSR,WTWMSRCR
          ENDIF
          MOVE      WTWMDRSA,SAVEDRSA
          MOVE      WTWMDOSA,SAVEDOSA
          MOVE      WTWMPHSP,SAVEPHSP
          MOVE      WMPCAT,SAVEPCAT
          MOVE      WTWMDTAD,SAVEDTAD
          MOVE      WTWMCSST,SAVECSST
          MOVE      WTWMCSDT,SAVECSDT
          MOVE      WTWMASSR,SAVEASSR
.
SAVHIS99  RETURN
.******************************************************************************
.* WRTHIS00 - Write to the Waiting List History
.******************************************************************************
WRTHIS00  MATCH     SAVEBSCD,WTWMBSCD
          GOTO      WRTHIS50 IF NOT EQUAL
.
          MATCH     SAVEPRIO,WMPTY
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50 
          ENDIF
.
          MATCH     SAVERANK,WTWMRANK
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50 
          ENDIF
.
          MATCH     SAVEDAT2,WMDATE2
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50 
          ENDIF
.
          MATCH     SAVEDAT3,WMDATE3
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50 
          ENDIF
.
          LOAD      WTHIBRSR,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                  WMUDEF6,WMUDEF7,WMUDEF8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      WTHIBRSR,WTWMSRCR
          ENDIF
          MATCH     SAVEBRSR,WTHIBRSR
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50 
          ENDIF
.
          MATCH     SAVEDRSA,WTWMDRSA
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVEDOSA,WTWMDOSA
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVEPHSP,WTWMPHSP
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVEPCAT,WMPCAT
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVECSST,WTWMCSST
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVECSDT,WTWMCSDT
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          MATCH     SAVEASSR,WTWMASSR
          IF        !@EQUAL
            MOVE      TWO,NBRFLAG
            GOTO      WRTHIS50
          ENDIF
.
          GOTO      WRTHIS99          * No Changes
.
. ------- write a history record -----------------------
.
WRTHIS50  OPEN      WATHISA1,"wathisaf" 
.
          PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          IF        OVRCD=1
            PACK      SAVRCDT,CCC,CYY,CMM,CDD
            REP       " 0",SAVRCDT
          ELSE
            MATCH     WMURNO,WTHIURNO
            GOTO      WRTHIS53 IF NOT EQUAL
.
            MATCH     WMCODE,WTHIPROC
            GOTO      WRTHIS53 IF NOT EQUAL
.
            COMPARE   WMCNT,WTHIPCNT
            GOTO      WRTHIS53 IF NOT EQUAL
.
            PACK      SAVRCDT,WTHIRCDT
            GOTO      WRTHIS55
          ENDIF
.
WRTHIS53  PACK      SAVRCDT,CCC,CYY,CMM,CDD
          REP       " 0",SAVRCDT
.
WRTHIS55  PACK      KEY8,CCC,CYY,CMM,CDD,SP10
          MATCH     Z70,WATHI002
          IF        !@EQUAL
            MATCH     SP70,WATHI002
            IF        !@EQUAL
              MOVE      WATHI002,KEY8         * Set effective date to cgi       
            ENDIF
          ENDIF
          REP       " 0",KEY8
.
          IF        ADDWLFLG = 1
            MOVE     WMDATE1,KEY8            * Set effective date to date on
            MOVE     WMDATE1,WTHIRCDT        * list when a waiting list entry
            MOVE     SP70,WTHIDBFT
          ENDIF                              * is created
.
          PACK      KEY31,WMURNO,WMCODE,WMCNT,KEY8,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,WRTHIS60
.
          MATCH     WMURNO,WTHIURNO
          GOTO      WRTHIS60 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      WRTHIS60 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      WRTHIS60 IF NOT EQUAL
.
          MATCH     KEY8,WTHIEDAT
          GOTO      WRTHIS60 IF NOT EQUAL
.
          ADD       ONE,WTHIUCNT
          GOTO      WRTHIS70
.
WRTHIS60  MOVE      WMURNO,WTHIURNO
          MOVE      WMCODE,WTHIPROC
          MOVE      WMCNT,WTHIPCNT
.
          MATCH     Z70,WATHI002
          IF        !@EQUAL
            MOVE     WATHI002,WTHIEDAT       * Set effective date to cgi      
          ELSE
            PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          ENDIF
          REP       " 0",WTHIEDAT
.
          PACK      WTHIRCDT,SP8
          IF        ADDWLFLG = 1
            MOVE     WMDATE1,WTHIEDAT        * Set effective date to date on
            MOVE     WMDATE1,WTHIRCDT        * list when a waiting list entry
            MOVE     SP70,WTHIDBFT
          ENDIF                              * is created
.
          MOVE      ONE,WTHIUCNT
          MOVE      WBSEUID,WTHIWEBI
.
WRTHIS70  CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WTHIETIM
          MOVE      WMPTY,WTHIPRIO
          MOVE      WTWMRANK,WTHIRANK
          MOVE      WTWMDTAD,WTHIDCGV
          MOVE      WMDATE2,WTHIDAT2  
          MOVE      WMDATE3,WTHIDAT3  
          MOVE      SAVERDT3,WTHIRDT3
          PACK      WTHISPAR,SP20,SP20,SP20
          MOVE      WTWMBSCD,WTHIBSCD
.
          MOVE      ANSN,WTHIRECS
.
          MATCH     SAVERANK,WTWMRANK
          IF        !@EQUAL
            MATCH     SAVEDAT2,WMDATE2
            IF        !@EQUAL
              PACK      WTHIRCDT,WMDATE2
              REP       " 0",WTHIRCDT
            ENDIF
          ENDIF
.
          PACK      WTHIADTE,SP70
          PACK      WTHIADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTHIADTE
.         PACK      WTCAATIM,CTIMEIS          * set alteration time
          MOVE      CTIMEIS,WTHIATIM
          MOVE      SAVEBOOK,WTHIBOOK
.
          MOVE      WMUNIT,WTHIUNIT
          MOVE      SP70,WTHIPLST
          MOVE      WMSTAT,WTHISTAT
          MOVE      WMDATE1,WTHIDAT1
          MOVE      WTWMDTAD,WTHIDTAD
          MOVE      SP70,WTHICODT
          MOVE      WMPCAT,WTHIPCHS
          MOVE      SAVEBOKC,WTHIBOKC
          MOVE      SAVEBCAN,WTHIBCAN
          MOVE      WTWMASSR,WTHIASSR
          LOAD      WTHIBRSR,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                  WMUDEF6,WMUDEF7,WMUDEF8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      WTHIBRSR,WTWMSRCR
          ENDIF
          MOVE      WTWMCSST,WTHICSST
          MOVE      WTWMCSDT,WTHICSDT
.
          MATCH     SP8,SAVBMDT
          IF        !@EQUAL
            MOVE      SAVBMDT,WTHIBMDT
          ELSE
            MOVE      SP70,WTHIBMDT
          ENDIF
.
          MATCH     SP8,SAVDBFT
          IF        !@EQUAL
            MOVE      SAVDBFT,WTHIDBFT
          ENDIF
.
          MATCH     "05",WTHIBSCD
          IF        @EQUAL
            PACK      WTHIDBFT,SP70
          ENDIF
.
          MOVE      SP70,WTHIRTYP
          IF        NBRFLAG=1
            MOVE      ANSA,WTHIRTYP
          ENDIF 
.
          IF        NBRFLAG=2
            MOVE      ANSC,WTHIRTYP
          ENDIF 
.
          IF        NBRFLAG=3
            MOVE      ANSD,WTHIRTYP
          ENDIF
.
          IF        NBRFLAG=4
            MOVE      ANSE,WTHIRTYP
            MOVE      WTWMUNIQ,WTHIBOOK
          ENDIF
.
          MOVE      WMDOCTOR,WTHIDOCT
.
          MOVE      WTWMDRSA,WTHIDRSA
          MOVE      WTWMDOSA,WTHIDOSA
          MOVE      WTWMPHSP,WTHIPHSP
          MOVE      SP70,WTHITRAG
          OPEN      WATPROA1,"watproaf"
          PACK      KEY9,WMCODE
          CALL      RDPROA1
          IF        OVRCD<>1
            MOVE      WTWPHDPE,WTHIBPRO
          ENDIF
.
          PACK      KEY5,ANSW,ANSU,WMUNIT
          CALL      RDCODE1
          MATCH     ANSN,TCINDC2
          IF        @EQUAL
            MOVE      SP1,WTHIRTYP
          ENDIF
.
          MATCH     "     0",WTWMRANK
          GOTO      WRTHIS80 IF EQUAL
.
          MATCH     SAVERANK,WTWMRANK
          GOTO      WRTHIS95 IF EQUAL
.
          GOTO      WRTHIS90
.
WRTHIS80  MATCH     SAVEPRIO,WMPTY
          GOTO      WRTHIS95 IF EQUAL
.
          PACK      KEY5,ANST,ANSP,WMPTY
          CALL      RDCODE1
          MATCH     ANST,TCINDC4
          GOTO      WRTHIS95 IF EQUAL
          MATCH     ANSP,TCINDC4
          GOTO      WRTHIS95 IF EQUAL
          MATCH     ANSC,TCINDC4
          GOTO      WRTHIS95 IF EQUAL
.
WRTHIS90  MATCH     SAVEDAT2,WMDATE2
          IF        !@EQUAL
            PACK      WTHIRCDT,WMDATE2
          ELSE
            PACK      WTHIRCDT,WTHIEDAT
          ENDIF
.
WRTHIS95  MATCH     SP8,WTHIRCDT
          IF        @EQUAL
            PACK      WTHIRCDT,SAVRCDT
          ENDIF
          MATCH     SAVEDAT2,WMDATE2
          IF        !@EQUAL
            PACK      WTHIRCDT,WMDATE2
          ENDIF
.
.  WTHIEDAT is set above here to stop duplicate records for WTHIUCNT
.
          PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP20
          CALL      RAWTHIS1
          IF        OVRCD=1
            MOVE      WBSEUID,WTHIWEBI
            MOVE      SP70,WTHIHIDE
            MOVE      SP70,WTHIOLDP
            MOVE      SP70,WTHIPCHG
            CALL      WRWTHIS1
          ENDIF
.
WRTHIS99  MOVE      ZERO,NBRFLAG
          RETURN
.
.******************************************************************************
.* GETRSC00 - Get Reason for Change of Sched Adm Date                         *
.******************************************************************************
GETRSC00  MOVE      SAVERDT3,SAVERCSD  * Check if Sched Adm Date has changed
          MATCH     SAVESCHA,WMDATE3
          GOTO      GETRSC90 IF EQUAL
.
          MOVE      SP10,SAVERDT3
          MATCH     SAVEDAT3,WMDATE3
          GOTO      GETRSC90 IF EQUAL
.
          DISPLAY   *P1:24,*EL,"Reason for Change of Scheduled Admission Date :"
.
          MOVE      "WD",CODE              * category
          MOVE      SP3,CKYIDEF3
          MOVE      ONE,CKYIMAND
          MOVE      "49",ECOL
          MOVE      "24",EVERT
.
          CALL      PATCODKY                * keyin a codes field
          BRANCH    EXIT,GETRSC95,GETRSC95
.
          MOVE      ACODE,SAVERDT3
.
          MATCH     SAVERCSD,SAVERDT3
          IF        !@EQUAL
            MOVE      ONE,NBRFLAG
          ENDIF
.
GETRSC90  MOVE      ZERO,EXIT
          GOTO      GETRSC99
.
GETRSC95  MOVE      ONE,EXIT                * EXITCHAR
GETRSC99  RETURN
+
.******************************************************************************
.* SAVHSS00 - Save the History Variables
.******************************************************************************
SAVHSS00  MOVE      WMDOCTOR,SAVDOCTR     * Doctor   
          MOVE      WTWMBSCD,SAVEBSCD     * Save Booking Status Code
          MOVE      WMUNIT,SAVEUNIT       * Unit
          MOVE      WMSTAT,SAVESTAT       * Status Changed 
          MOVE      WMBOOK,SAVEBOOK       * Booking Number
.
SAVHSS99  RETURN
.
.******************************************************************************
.* WRTHSS00 - Write to the Waiting List History
.******************************************************************************
WRTHSS00  MATCH     "32",WTWMBSCD
          IF        @EQUAL
            CALL      WRITSS00                   * Unremove
            GOTO      WRTHSS99
          ENDIF
.
          MATCH     "34",WTWMBSCD
          IF        @EQUAL
            CALL      WRITSS00                   * Unremove
            GOTO      WRTHSS99
          ENDIF
.
          MATCH     SAVECSST,WTWMCSST
          IF        !@EQUAL
.                                                *       (was @EQUAL)  *C-87093
            MOVE      "35",WTWMBSCD
            CALL      WRITSS00
          ENDIF
.
          MATCH     SAVDOCTR,WMDOCTOR            * Doctor Change
          IF        !@EQUAL
            MOVE      "31",WTWMBSCD
            CALL      WRITSS00
            CALL      CHGHIS00                   * Update all history record
          ENDIF
.
          MATCH     SAVEUNIT,WMUNIT              * Unit Changed   
          IF        !@EQUAL
            MOVE      "22",WTWMBSCD
            CALL      WRITSS00
            CALL      CHGHIS00                   * Update all history record
          ENDIF
.
          COMPARE   SAVESTAT,WMSTAT              * Status Changed 
          IF        !@EQUAL
            MOVE      "21",WTWMBSCD
            CALL      WRITSS00
          ENDIF
.
.
WRTHSS99  RETURN 
.
. ------- write a history record -----------------------
.
WRITSS00  OPEN      WATHISA1,"wathisaf"
.
          PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          IF        OVRCD=1
            PACK      SAVRCDT,CCC,CYY,CMM,CDD
            REP       " 0",SAVRCDT
          ELSE
            MATCH     WMURNO,WTHIURNO
            GOTO      WRITSS53 IF NOT EQUAL
.
            MATCH     WMCODE,WTHIPROC
            GOTO      WRITSS53 IF NOT EQUAL
.
            COMPARE   WMCNT,WTHIPCNT
            GOTO      WRITSS53 IF NOT EQUAL
.
            PACK      SAVRCDT,WTHIRCDT
            GOTO      WRITSS55
          ENDIF
.
WRITSS53  PACK      SAVRCDT,CCC,CYY,CMM,CDD
          REP       " 0",SAVRCDT
.
WRITSS55  MATCH     Z70,WATHI002
          IF        !@EQUAL
            MOVE     WATHI002,KEY8           * Set effective date to cgi
          ELSE
            PACK      KEY8,CCC,CYY,CMM,CDD,SP10
          ENDIF
          REP       " 0",KEY8
.
          IF        ADDWLFLG = 1
            MOVE     WMDATE1,KEY8            * Set effective date to date on
            MOVE     WMDATE1,WTHIRCDT        * list when a waiting list entry
            MOVE     SP70,WTHIDBFT
          ENDIF                              * is created
.
          PACK      KEY31,WMURNO,WMCODE,WMCNT,KEY8,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,WRITSS60
.
          MATCH     WMURNO,WTHIURNO
          GOTO      WRITSS60 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      WRITSS60 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      WRITSS60 IF NOT EQUAL
.
          MATCH     KEY8,WTHIEDAT
          GOTO      WRITSS60 IF NOT EQUAL
.
          ADD       ONE,WTHIUCNT
          GOTO      WRITSS70
.
WRITSS60  MOVE      WMURNO,WTHIURNO
          MOVE      WMCODE,WTHIPROC
          MOVE      WMCNT,WTHIPCNT
.
          MATCH     Z70,WATHI002
          IF        !@EQUAL
            MOVE     WATHI002,WTHIEDAT       * Set effective date to cgi
          ELSE
            PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          ENDIF
          REP       " 0",WTHIEDAT
.
          PACK      WTHIRCDT,SP8
          IF        ADDWLFLG = 1
            MOVE     WMDATE1,WTHIEDAT        * Set effective date to date on
            MOVE     WMDATE1,WTHIRCDT        * list when a waiting list entry
          ENDIF                              * is created
.
          MOVE      ONE,WTHIUCNT
          MOVE      WBSEUID,WTHIWEBI
.
WRITSS70  CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WTHIETIM
          MOVE      WMPTY,WTHIPRIO
          MOVE      WTWMRANK,WTHIRANK
          MOVE      WTWMDTAD,WTHIDCGV
          MOVE      WMDATE2,WTHIDAT2
          MOVE      WMDATE3,WTHIDAT3
          MOVE      SAVERDT3,WTHIRDT3
          PACK      WTHISPAR,SP20,SP20,SP20
          MOVE      WTWMBSCD,WTHIBSCD
          MOVE      ANSY,WTHIRECS
.
          PACK      WTHIADTE,SP70
          PACK      WTHIADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTHIADTE
.         PACK      WTCAATIM,CTIMEIS          * set alteration time
.         MATCH     "21",WTWMBSCD
.         IF        !@EQUAL
            MOVE      SAVEBOOK,WTHIBOOK
.         ENDIF
          MOVE      CTIMEIS,WTHIATIM
          MOVE      SAVEBCAN,WTHIBCAN
          MOVE      SAVEBOKC,WTHIBOKC
.
          MOVE      WMUNIT,WTHIUNIT
          MOVE      SP70,WTHIPLST
          MOVE      WMSTAT,WTHISTAT
          MOVE      WMDATE1,WTHIDAT1
          MOVE      WTWMDTAD,WTHIDTAD
          MOVE      WTWMDABD,WTHIPODT
          MOVE      WTWMDABD,WTHIPODT
          MOVE      SP70,WTHICODT
          MOVE      WTWMDRSA,WTHIDRSA
          MOVE      WTWMDOSA,WTHIDOSA
          MOVE      WTWMPHSP,WTHIPHSP
          MOVE      WTWMASSR,WTHIASSR
          MOVE      SP70,WTHITRAG
          MOVE      WMPCAT,WTHIPCHS
          OPEN      WATPROA1,"watproaf"
          PACK      KEY9,WMCODE
          CALL      RDPROA1
          IF        OVRCD<>1
            MOVE      WTWPHDPE,WTHIBPRO
          ENDIF
          MOVE      BKREADAT,WTHIDTEC
          MOVE      WMPTY,WTHISPFL
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      WTHIBRSR,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                  WMUDEF6,WMUDEF7,WMUDEF8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      WTHIBRSR,WTWMSRCR
          ENDIF
          MATCH     SP8,SAVBMDT
          IF        !@EQUAL
            MOVE      SAVBMDT,WTHIBMDT
          ELSE
            MOVE      SP70,WTHIBMDT
          ENDIF
.
          MATCH     SP8,SAVDBFT
          IF        !@EQUAL
            MOVE      SAVDBFT,WTHIDBFT
          ENDIF
.
          MOVE      SP1,WTHIRTYP
.
          MOVE      WMDOCTOR,WTHIDOCT
.
          PACK      KEY5,ANSW,ANSU,WMUNIT
          CALL      RDCODE1
          MATCH     ANSN,TCINDC2
          IF        @EQUAL
            MOVE      SP1,WTHIRTYP
          ENDIF
.
          MATCH     "     0",WTWMRANK
          GOTO      WRITSS80 IF EQUAL
.
          MATCH     SAVERANK,WTWMRANK
          GOTO      WRITSS95 IF EQUAL
.
          GOTO      WRITSS90
.
WRITSS80  MATCH     SAVEPRIO,WMPTY
          GOTO      WRITSS95 IF EQUAL
.
          PACK      KEY5,ANST,ANSP,WMPTY
          CALL      RDCODE1
          MATCH     ANST,TCINDC4
          GOTO      WRITSS95 IF EQUAL
          MATCH     ANSP,TCINDC4
          GOTO      WRITSS95 IF EQUAL
          MATCH     ANSC,TCINDC4
          GOTO      WRITSS95 IF EQUAL
.
WRITSS90  PACK      WTHIRCDT,WTHIEDAT
.
WRITSS95  MATCH     SP8,WTHIRCDT
          IF        @EQUAL
            PACK      WTHIRCDT,SAVRCDT
          ENDIF
.
.  WTHIEDAT is set above here to stop duplicate records for WTHIUCNT
.
          PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP20
          CALL      RAWTHIS1
          IF        OVRCD=1
            MOVE      WBSEUID,WTHIWEBI
            MOVE      SP70,WTHIHIDE
            MOVE      SAVEOLDP,WTHIOLDP
            MOVE      SAVEPCHG,WTHIPCHG
            CALL      WRWTHIS1
          ENDIF
.
WRITSS99  MOVE      ZERO,NBRFLAG
          MOVE      SAVEBSCD,WTWMBSCD            * Restore Booking Status Code
          RETURN
.
.******************************************************************************
.* CHGHIS00 - Update history records if changes are backdated
.******************************************************************************
CHGHIS00  MATCH     Z70,WATHI002
          IF        !@EQUAL
            MOVE     WATHI002,WTHIEDAT       * Set effective date to cgi
          ELSE
            PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          ENDIF
          REP       " 0",WTHIEDAT
.
          PACK      KEY31,WMURNO,WMCODE,WMCNT,WTHIEDAT,SP70
          CALL      RSWTHIS1
CHGHIS10  CALL      RKWTHIS1
          BRANCH    OVRCD,CHGHIS99
.
          MATCH     WMURNO,WTHIURNO
          GOTO      CHGHIS99 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      CHGHIS99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      CHGHIS99 IF NOT EQUAL
.
          MATCH     SAVDOCTR,WMDOCTOR            * Doctor Change
          IF        !@EQUAL
            MOVE      WMDOCTOR,WTHIDOCT
          ENDIF
.
          MATCH     SAVEUNIT,WMUNIT              * Unit Changed
          IF        !@EQUAL
            MOVE      WMUNIT,WTHIUNIT
          ENDIF
.
          CALL      UPWTHIS1
          GOTO      CHGHIS10

CHGHIS99  RETURN
