.******************************************************************************
.*                                                                            *
.* Include Name     : VALDIOPS.PBL                                            *
.*                                                                            *
.* Description      : Routines to validate and return errors for Disease      *
.*                    & Procedure codes.                                      *
.*                                                                            *
.* Author           : Pat Dirito   16/10/2000                                 *
.*                                                                            *
.* REQUIRED!!       : Valid read on patma1af & patdschf                       *
.*                    Valid read on patmisaf(if packing AGEDATE with ADATE)   *
.*                    Call to CALCAGE!                                        *
.******************************************************************************
. V11.05.01 17/03/2025  Davin           TSK 0956210
.           Added ICD10 Ed.13 - Go-live Date check; PTCNGDX3 (Sect.130 Pos.86)
. V11.02.01 29/03/2022  Davin           TSK 0917793
.           Added ICD10 Ed.12 - Go-live Date check; PTCNGDX2 (Sect.128 Pos.231)
. V10.14.01 19/03/2019  Don Nguyen      TSK 0869412
.           Added ICD10 Ed.11 - Go-live Date check; PTCNGDX1 (Sect.117 Pos.220)
. V10.10.01 08/03/2017  Davin           TSK 0833093     HDP 2017/2018
.           Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
.           Increased ICDRDVER and ICDPRVED to FORM 2 for ICD10 Ed.10
.           Allow for day ranges in age group edits (DAGEGP/OAGEGP)
. V10.06.02 01/07/2015  Don Nguyen      CAR 317693
.           Removed Area checks '3' & '4' in VOPCD200; replaced with new edit
.           type '3' - Reject if Care Type not 10 (Posthumous Organ Procurement)
. V10.06.01 17/03/2015  Davin           CAR 311669      HDP 2015/2016
.           Add ICD10 Ed.9 - Go-live Date PTCNGDV9 (Sect.110 Pos.77)
. V10.05.02 25/09/2014  Don Nguyen      CAR 303179
.           Modified VDSCD000 to output new error messages for sex checks
. V10.05.01 11/09/2014  Don Nguyen      CAR 303179
.           Modified VDSCD000 to call VEXSX000 for extra validation of sex 
.           11/09/2014  Don Nguyen      CAR 302792
.           Modified VDSCD700 to handle PT0DACRQ="W"
. V10.03.02 23/04/2013  Davin           CAR 284420      HDP 2013/2014
.           Add ICD10 Ed.8 - Go-live Date PTCNGDV8 (Sect.110 Pos.69)
. V10.03.01 22/11/2011  Mike Laming     CAR 253821
.           Add PT0DSAC2 (replaces PT0DSACD from ICD10 Ed.4 onward)
. V10.02.03 27/10/2011  Mike Laming    CAR 245178 
.           Added MRCNECOD indicator to eventually replace PTCECODE           
. V10.02.02 25/07/2011  Peter McMullen CAR 246439 
.           Remove hard-coded values from VDSCDA00                            
. V10.02.01 24/03/2011  Mike Laming   CAR 240107
.           Change length of Indexes for PATECDaf and PATECOaf - file change
. V10.00.03 20/05/2010  Mike Laming     CAR 219246      HDP 2010
.           Missed DPT0DV7C (PTCNGDV7) in VDSCD010 & DISHED20 
. V10.00.02 27/04/2010  Mike Laming     CAR 219246      HDP 2010
.           Missed DPT0OV7C (PT0OV7CD) in VOPCD010 & OPRHED20 
. V10.00.01 06/04/2010  Mike Laming     CAR 219246      HDP 2010
.           Add ICD10 Ed.7 - Go-live Date PTCNGDV7 (Sect.110 Pos.61)
. V9.12.02  04/02/2010  Mike Laming     CAR 208570
.           Fix the Morphology Required message that TB stuffed up
. V9.12.01  23/11/2009  Mike Laming     CAR 208570
.           Add test for Secondary Cancers - Morphology not required
. V9.10.02  26/08/2008  Mike Laming     CAR 176293                
.           Correct "Posting" test at VOPCD050, VDSCD050, DISHED40
.           and OPRHED40
. V9.10.01  09/07/2008  Mike Laming     CAR 173199                
.           Re-worked ICD10 Edition edits at VOPCD000 & VDSCD000  
.           Moved DISHED00 & OPRHED00 from MRTWEB02 to here.
. V9.09.02  19/03/2008  Mike Laming     CAR 163918    HDP 2008
.           Add ICD10 Ed.6 - Go-live Date PTCNGDV6 (Sec.112 Pos.239)
. V9.09.01  13/09/2007  Ebon Clements CAR 100599
.           Added OUTPFLAG to ignore some diagnosis edits for
.           outpatient visits
. V9.08.01  01/03/2007  Jill Habasque   CAR 125126
.           Added gender error messages (instead of fatal error)
. V9.07.01  17/07/2006  Peter Vela      CAR 112753
.           Fixed sex edit in VDSC0000
. V9.06.01  09/05/2006  Mike Laming     CAR 105244
.           Added 2006 ICD10 Ed5 - go-live Date PTCNGDV5
. V9.04.04  28/04/2005  J.Tan                    CAR 61122
.           Fixed unacceptable error message
. V9.04.03  08/09/2004  Henry Son                CAR 52585
.           Add Indeterminate check.
. V9.04.02  21/06/2004  Henry Son                CAR 49037
.           Add ICD Edition 4 changes.
. V9.04.01  22.12.2003  Sylvek Litewka           CAR 45685
.           2003 changes - ICD10v3 changes.
.           Moved to V9.03 functionality implemented in V9.02 under
.           defect 43219 - added procedure VEXSX000. 
.           03.12.2003  Sylvek Litewka           CAR 20222
.           Modified procedures VDSCD000 and VOPCD000 to read ICD
.           files using common IO's RDPTICD1 and RDPTICO1.
.------------------------------------------------------------------------------
. V9.02.09  28.06.2002  Pat Dirito               SRF 19126
.           Changes for ICD10 V1 & V2 Header Codes  
. V9.02.08  18.06.2002  Ebon Clements            SRF 18831
.           Added a reset to error display variables
. V9.02.07  06.06.2002  Pat Dirito               SRF 18489 
.           Added check for ICD10 V3 - PTCNGDV3  
. V9.02.06  05.01.2002  Pat Dirito  
.           Replaced PSAGE with PSAGEYRS calculated from CALCAGE
. V9.02.05  21.11.2001  Pat Dirito  
.           PRGID was not being reset after SCAN and before a GOTO!
. V9.02.04  08.11.2001  Davin
.           Replaced PTCNVOGU with PTCNDGPV
. V9.02.03  27.10.2001  Pat Dirito  
.           PRGID was not being reset after SCAN. Now fixed.
. V9.02.02  18.10.2001  Pat Dirito  
.           Fixed Duplicate IF STATEMENT at label VDSCD610        
. V9.02.01  09.10.2001  Ashwin - HPS
.           Included OUTWEB02 for ICD10 Validation
. V9.02.02  21.10.2001  B.G.Ackland
.           Fix Above Changes for OUTWEB02
.******************************************************************************
.*                                  VOPCD000              Called by: KOPCD000 *
.*                         Validate The Operation Code             & SWAPI000 *
.******************************************************************************
VOPCD000  MOVE      ZERO,WARNCNT
          PACK      KEY9,OPCOD
          CALL      RDPTICO1                * Read an ICD operation file recd
          BRANCH    OVRCD,VOPCD600 
          COMPARE   ONE,ICDRDVER            * is Code read an ICD9?       
          GOTO      VOPCD600 IF EQUAL
.
          MOVE      "1",ICDPRVED        * set default Previous Valid ICD Ed.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.                                       * ICDRDVER cotains the Edition No. of
.                                       * the ICD10 code read - now find the
.                                       * Edition No. of the Previous valid
.                                       * ICD10 codes into ICDPRVED
.
          MATCH     CURRDATE,PTCNGDV2       * is Ed.2 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 2
            MOVE      "2",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV3       * is Ed.3 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 3
            MOVE      "3",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV4       * is Ed.4 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 4
            MOVE      "4",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV5       * is Ed.5 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 5
            MOVE      "5",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV6       * is Ed.6 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 6
            MOVE      "6",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV7       * is Ed.7 alive & active  *I-219246
          IF        (@EQUAL | @LESS) & ICDRDVER > 7
            MOVE      "7",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV8       * is Ed.8 alive & active  *I-284420
          IF        (@EQUAL | @LESS) & ICDRDVER > 8
            MOVE      "8",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV9       * is Ed.9 alive & active  *I-311669
          IF        (@EQUAL | @LESS) & ICDRDVER > 9
            MOVE      "9",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDVX       * is Ed.10 alive & active *I-0833093
          IF        (@EQUAL | @LESS) & ICDRDVER > 10
            MOVE      "10",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX1       * is Ed.11 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 11
            MOVE      "11",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX2       * is Ed.12 alive & active *I-0917793
          IF        (@EQUAL | @LESS) & ICDRDVER > 12
            MOVE      "12",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX3       * is Ed.13 alive & active *I-0956210
          IF        (@EQUAL | @LESS) & ICDRDVER > 13
            MOVE      "13",ICDPRVED
          ENDIF
.
.                                    * get Go-live Date for current ICD10 Codes
          LOAD      KEY8,ICDRDVER,PTCNI10D,PTCNGDV2,PTCNGDV3,PTCNGDV4:
                                  PTCNGDV5,PTCNGDV6,PTCNGDV7,PTCNGDV8:*C-284420
                                  PTCNGDV9,PTCNGDVX,PTCNGDX1,PTCNGDX2:*C-0917793
                                  PTCNGDX3                            *C-0956210
.
          MATCH     SP8,DDATE
          GOTO      VOPCD010 IF EQUAL          * just in case
.                                    * now match the DDATE against the Current 
.                                    * valid ICD10 Edn. Golive date
          MATCH     KEY8,DDATE       * check if DDATE is in Previous Edn. range
          IF        @LESS
            LOAD      KEY1,ICDPRVED,DPT0OV1C,DPT0OV2C,DPT0OV3C,DPT0OV4C:
                                    DPT0OV5C,DPT0OV6C,DPT0OV7C,DPT0OV8C:*C284420
                                    DPT0OV9C,DPT0OVXC,DPT0OVX1,DPT0OVX2:*0917793
                                    DPT0OVX3                            *0956210
            MATCH     "1",KEY1       * valid code for this Edition ?
            GOTO      VOPCD620 IF NOT EQUAL
            GOTO      VOPCD050
          ENDIF
.
VOPCD010  LOAD      KEY1,ICDRDVER,DPT0OV1C,DPT0OV2C,DPT0OV3C,DPT0OV4C:
                                  DPT0OV5C,DPT0OV6C,DPT0OV7C,DPT0OV8C:*C284420
                                  DPT0OV9C,DPT0OVXC,DPT0OVX1,DPT0OVX2:*C0917793
                                  DPT0OVX3                            *C0956210
          MATCH     "1",KEY1         * valid code for this Edition ?
          GOTO      VOPCD620 IF NOT EQUAL
.
.         ---------------------             * check for valid posting code
.
VOPCD050  COMPARE   "3",ICDRDVER            * is Edition 3 or greater ?
          GOTO      VOPCD100 IF LESS
          CMATCH    "P",OFLAG               * Only check for Ed3 & above Codes
          GOTO      VOPCD650 IF NOT EQUAL   * Not a posting operation code
          GOTO      VOPCD100
.
.         ---------------------             * process the valid ICD10 code
. ----- Perform sex checks -----
.
VOPCD100  MOVE      ZERO,FORM1
          MOVE      OSEX,FORM1              * Sex restraint
.
          BRANCH    FORM1,VOPCD110,VOPCD120,VOPCD130,VOPCD140,VOPCD150:
                          VOPCD160
          GOTO      VOPCD200
.
VOPCD110  CMATCH    ANSM,PSEX
          GOTO      VOPCD605 IF EQUAL       * Fatal error
          GOTO      VOPCD200
.
VOPCD120  CMATCH    ANSM,PSEX               * Warn if Male
          GOTO      VOPCD190 IF EQUAL       * Sex warning
          CMATCH    ANSI,PSEX               * Warn if Indeter.         *I-52585
          GOTO      VOPCD190 IF EQUAL       * Sex warning              *I-52585
          GOTO      VOPCD200
.
VOPCD130  CMATCH    ANSF,PSEX
          GOTO      VOPCD605 IF EQUAL       * Fatal error
          GOTO      VOPCD200
.
VOPCD140  CMATCH    ANSF,PSEX               * Warn if Female
          GOTO      VOPCD190 IF EQUAL       * Sex warning
          CMATCH    ANSI,PSEX               * Warn if Indeter.         *I-52585
          GOTO      VOPCD190 IF EQUAL       * Sex warning              *I-52585
          GOTO      VOPCD200
.
VOPCD150  CALL      VEXSX000                * check for Ass. Cond?    
          IF        FOUNDFLG=0
            CMATCH    ANSF,PSEX                                        
            GOTO      VOPCD170 IF EQUAL     * Female and no Male code. 
          ENDIF                                                  
          GOTO      VOPCD200                                  
.
VOPCD160  CALL      VEXSX000                * check for Ass. Cond?     
          IF        FOUNDFLG=0
            CMATCH    ANSM,PSEX                                       
            GOTO      VOPCD180 IF EQUAL     * Male and no Female code. 
          ENDIF                                                 
          GOTO      VOPCD200                              
.
VOPCD170  SCAN      "WEB",PRGID                                  
          IF        @EQUAL
            MOVE      "Female with no associated explanation code.",WEBERR
          ELSE                                                
            MATCH     "IBAMRT53",PRGID                     
            IF        @EQUAL
              PRINT     *23,"Reject: Female with no ":                
                           "associated explanation code.  "       
            ENDIF                                              
          ENDIF                                              
          RESET     PRGID                                
          GOTO      VOPCD950                          
.
VOPCD180  SCAN      "WEB",PRGID                     
          IF        @EQUAL
            MOVE      "Male with no associated explanation code.",WEBERR
          ELSE                                                      
            MATCH     "IBAMRT53",PRGID                             
            IF        @EQUAL
              PRINT     *23,"Reject: Male with no ":              
                           "associated explanation code.  "      
            ENDIF                                               
          ENDIF                                              
          RESET     PRGID                                 
          GOTO      VOPCD950                               
.
VOPCD190  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Operation code gender warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Operation code gender warning.  "
            ENDIF
          ENDIF
          RESET     PRGID
.
. ----- Perform area checks -----
.
VOPCD200  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          MOVE      ZERO,FORM1
          MOVE      OAREA,FORM1             * Area restraint
.
          COMPARE   ONE,FORM1
          GOTO      VOPCD610 IF EQUAL       * Fatal error
.
          COMPARE   TWO,FORM1
          GOTO      VOPCD210 IF EQUAL       * Area warning
.
          COMPARE   THREE,PTCNHDPS          * Victoria state?
          GOTO      VOPCD205 IF NOT EQUAL
.
          COMPARE   THREE,FORM1             * Area edit type '3' ?
          GOTO      VOPCD205 IF NOT EQUAL
.
          OPEN      PATMI1A1,"patmi1af"
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VOPCD205
.
          PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          BRANCH    OVRCD,VOPCD205
.
          MATCH     "10",THCSCOD
          GOTO      VOPCD615 IF NOT EQUAL   * Reject if Care Type not 10
                                            * (Posthumous Organ Procurement)
.
VOPCD205  GOTO      VOPCD300
.
VOPCD210  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Operation code area warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Operation code area warning.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD300
.
.
. ----- Perform age checks -----
.
VOPCD300  MOVE      ZERO,F2
          MOVE      OAGEGP,F2               * 1st age restraint
          MATCH     SP70,OAGEGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",OAGEGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",OAGEGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",OAGEGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      OLOW,F3A                * 1st age low limit
          MOVE      OHIGH,F3B               * 1st age high limit
          IF        ICDRDVER > 9
            MOVE      PTXOALL1,F3A          * 1st age low limit ed.10 onwards
            MOVE      PTXOAHL1,F3B          * 1st age high limit ed.10 onwards
          ENDIF
.
          COMPARE   "9",CODTYP
          GOTO      VOPCD310 IF EQUAL       * Using ICD9
.
          MOVE      ZERO,FORM2
          MOVE      ZERO,F2
          MOVE      PT0O2AGP,F2             * 2nd age restraint
          MATCH     SP70,PT0O2AGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",PT0O2AGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",PT0O2AGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",PT0O2AGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      PT0O2ALL,F3A            * 2nd age low limit
          MOVE      PT0O2AHL,F3B            * 2nd age high limit
          IF        ICDRDVER > 9
            MOVE      PTXOALL2,F3A          * 2nd age low limit ed.10 onwards
            MOVE      PTXOAHL2,F3B          * 2nd age high limit ed.10 onwards
          ENDIF
.
VOPCD310  BRANCH    F2,VOPCD320,VOPCD330,VOPCD340,VOPCD350,VOPCD360:
                       VOPCD370,VOPCD380,VOPCD390,VOPCD392,VOPCD394:
                       VOPCD396,VOPCD398
          GOTO      VOPCD410
.
VOPCD320  COMPARE   PSAGEMNT,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD610                * Fatal - within month range
.
VOPCD330  COMPARE   PSAGEMNT,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD400                * Warning - within month range
.
VOPCD340  COMPARE   PSAGEYRS,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD610                * Fatal - within year range
.
VOPCD350  COMPARE   PSAGEYRS,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD400                * Warning - within year range
.
VOPCD360  COMPARE   PSAGEYRS,F3B
          GOTO      VOPCD610 IF LESS        * Fatal - outside year range
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VOPCD610 IF LESS        * Fatal - outside year range
          GOTO      VOPCD410        
.
VOPCD370  COMPARE   PSAGEYRS,F3B
          GOTO      VOPCD400 IF LESS        * Warning - outside year range
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VOPCD400 IF LESS        * Warning - outside year range
          GOTO      VOPCD410
.
VOPCD380  COMPARE   PSAGEMNT,F3B
          GOTO      VOPCD610 IF LESS        * Fatal - outside month range
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VOPCD610 IF LESS        * Fatal - outside month range
          GOTO      VOPCD410
.
VOPCD390  COMPARE   PSAGEMNT,F3B
          GOTO      VOPCD400 IF LESS        * Warning - outside month range
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VOPCD400 IF LESS        * Warning - outside month range
          GOTO      VOPCD410
.
VOPCD392  COMPARE   PSAGEDAY,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD610                * Fatal - within day range
.
VOPCD394  COMPARE   PSAGEDAY,F3B
          GOTO      VOPCD410 IF LESS
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VOPCD410 IF LESS
          GOTO      VOPCD400                * Warning - within day range
.
VOPCD396  COMPARE   PSAGEDAY,F3B
          GOTO      VOPCD610 IF LESS        * Fatal - outside day range
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VOPCD610 IF LESS        * Fatal - outside day range
          GOTO      VOPCD410
.
VOPCD398  COMPARE   PSAGEDAY,F3B
          GOTO      VOPCD400 IF LESS        * Warning - outside day range
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VOPCD400 IF LESS        * Warning - outside day range
          GOTO      VOPCD410
.
VOPCD400  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Operation code age warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Operation code age warning.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD500
.
VOPCD410  COMPARE   "9",CODTYP
          GOTO      VOPCD500 IF EQUAL       * Using ICD9
.
          ADD       ONE,FORM2
          MOVE      ZERO,F2
          MOVE      OAGEGP,F2               * 1st age restraint
          MATCH     SP70,OAGEGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",OAGEGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",OAGEGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",OAGEGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      OLOW,F3A                * 1st age low limit
          MOVE      OHIGH,F3B               * 1st age high limit
          IF        ICDRDVER > 9
            MOVE      PTXOALL1,F3A          * 1st age low limit ed.10 onwards
            MOVE      PTXOAHL1,F3B          * 1st age high limit ed.10 onwards
          ENDIF
          BRANCH    FORM2,VOPCD310          * 2nd pass
.
VOPCD500  GOTO      VOPCD900
.
. ----- Display all error messages -----
.
VOPCD600  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Invalid operation code.",WEBERR         
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Invalid operation code.  "
            ENDIF
          ENDIF 
          RESET     PRGID
          GOTO      VOPCD950
.
VOPCD605  SCAN      "WEB",PRGID
          IF        @EQUAL
            MOVE    "Operation code fatal gender error",WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT   *23,"Operation code FATAL gender error"
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD950
.
VOPCD610  SCAN      "WEB",PRGID     
          IF        @EQUAL
            MOVE      "Operation code fatal error for this patient.",WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Operation code FATAL error for this patient.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD950
.
VOPCD615  SCAN      "WEB",PRGID
          IF        @EQUAL
            MOVE      "Care Type not a Posthumous Organ Procurement.",WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Care Type not a Posthumous Organ Procurement.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD950
.
VOPCD620  SCAN      "WEB",PRGID     
          IF        @EQUAL
            MOVE      OPCODE,WEBERR
            ENDSET    WEBERR 
            APPEND    " is not a valid ICD10-AM - Ed.",WEBERR
            APPEND    ICDRDVER,WEBERR
            APPEND    " Code.",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,OPCODE," is not a valid ICD10-AM - Ed.",ICDRDVER:
                        " Code."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD950
.
.
VOPCD650  SCAN      "WEB",PRGID     
          IF        @EQUAL
            MOVE      OPCODE,WEBERR
            ENDSET    WEBERR 
            APPEND    " is not a valid Posting Code.",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,OPCODE," is not a valid Posting Code."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VOPCD950
.
.
VOPCD900  MOVE      ZERO,EXIT
          GOTO      VOPCD999
.
VOPCD950  MOVE      ONE,EXIT
VOPCD999  RETURN
+
.******************************************************************************
.*                                  VEXSX000              Called by: VOPCD160 *
.*                    Validate Extra Sex Disease code checks                  *
.******************************************************************************
VEXSX000  MOVE      ZERO,FOUNDFLG
.
          MATCH     PTCNGDV3,DDATE    * Is Discharge date < ICD10v3 golive date
          GOTO      VEXSX999 IF LESS  * Exit, these edits apply to ICD10V3 only!
.
          MATCH     "IBAMRT53",PRGID
          GOTO      VEXSX999 IF EQUAL       * Only for online capture  
.
.         Record coding via mrtweb0201001.html - initial coding.
.         (There are no records on patecdaf at this stage so CGI parameter used)
.         Parameter SEXASSCD indicates whether a Sex Associated code has been
.         entered on the screen. If it has then set the FOUNDFLG and exit.
.
          IF        SEXASSCD = 1
            MOVE      ONE,FOUNDFLG
            GOTO      VEXSX999
          ENDIF
.
.         Check codes already entered for this patient on patecdaf.
.
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RSPTECD1              * Episode disease file
VEXSX100  CALL      RKPTECD1
          BRANCH    OVRCD,VEXSX999
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      VEXSX999 IF NOT EQUAL
.
          MATCH     "E25.0",PTEDCODE        * check against extra
          GOTO      VEXSX910 IF EQUAL       * Associated conditions
.
          MATCH     "E25.8",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "E29.1",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "E34.5",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "F64.0",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q56.0",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q56.1",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q56.2",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q56.3",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q56.4",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q99.0",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          MATCH     "Q99.1",PTEDCODE
          GOTO      VEXSX910 IF EQUAL
.
          GOTO      VEXSX100
.
VEXSX910  MOVE      ONE,FOUNDFLG
VEXSX999  RETURN
+
.******************************************************************************
.*                                  VDSCD000              Called by: KDSCD000 *
.*                          Validate The Disease Code              & SWAPI000 *
.******************************************************************************
VDSCD000  PACK      KEY9,DSCOD
          CALL      RDPTICD1               * Read an ICD disease file record
          BRANCH    OVRCD,VDSCD800
          COMPARE   ONE,ICDRDVER           * ICD9?
          GOTO      VDSCD800 IF EQUAL      
.                                          * Ignore edits if outpatients
          IF        OUTPFLAG=1
            MOVE      SP70,PT0DADTP        * Astrix/dagger type
            MOVE      SP70,PT0DPRFX        * Diagnosis code prefix
            MOVE      SP70,DDAGGER         * Astrix/dagger edit   
            MOVE      SP70,PT0DCPRA        * Code practices edit
            MOVE      SP70,PT0DACRQ        * Additional code req edit
          ENDIF  
.
          MOVE      "1",ICDPRVED        * set default Previous Valid ICD Ed.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.                                       * ICDRDVER cotains the Edition No. of
.                                       * the ICD10 code read - now find the
.                                       * Edition No. of the Previous valid
.                                       * ICD10 codes into ICDPRVED
.
          MATCH     CURRDATE,PTCNGDV2       * is Ed.2 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 2
            MOVE      "2",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV3       * is Ed.3 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 3
            MOVE      "3",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV4       * is Ed.4 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 4
            MOVE      "4",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV5       * is Ed.5 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 5
            MOVE      "5",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV6       * is Ed.6 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 6
            MOVE      "6",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV7       * is Ed.7 alive & active  *I-219246
          IF        (@EQUAL | @LESS) & ICDRDVER > 7
            MOVE      "7",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV8       * is Ed.8 alive & active  *I-284420
          IF        (@EQUAL | @LESS) & ICDRDVER > 8
            MOVE      "8",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV9       * is Ed.9 alive & active  *I-311669
          IF        (@EQUAL | @LESS) & ICDRDVER > 9
            MOVE      "9",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDVX       * is Ed.10 alive & active *I-0833093
          IF        (@EQUAL | @LESS) & ICDRDVER > 10
            MOVE      "10",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX1       * is Ed.11 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 11
            MOVE      "11",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX2       * is Ed.12 alive & active *I-0917793
          IF        (@EQUAL | @LESS) & ICDRDVER > 12
            MOVE      "12",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX3       * is Ed.13 alive & active *I-0956210
          IF        (@EQUAL | @LESS) & ICDRDVER > 13
            MOVE      "13",ICDPRVED
          ENDIF
.
.
          STRIP     DPCODE
.
.                                    * get Golive Date for current ICD10 Codes
          LOAD      KEY8,ICDRDVER,PTCNI10D,PTCNGDV2,PTCNGDV3,PTCNGDV4:
                                  PTCNGDV5,PTCNGDV6,PTCNGDV7,PTCNGDV8:*C-284420
                                  PTCNGDV9,PTCNGDVX,PTCNGDX1,PTCNGDX2:*C-0917793
                                  PTCNGDX3                            *C-0956210
.
          MATCH     SP8,DDATE
          GOTO      VDSCD010 IF EQUAL          * just in case
.                                    * now match the DDATE against the Current 
.                                    * valid ICD10 Edn. Golive date
          MATCH     KEY8,DDATE       * check if DDATE is in Previous Edn. range
          IF        @LESS
            LOAD      KEY1,ICDPRVED,DPT0DV1C,DPT0DV2C,DPT0DV3C,DPT0DV4C:
                                    DPT0DV5C,DPT0DV6C,DPT0DV7C,DPT0DV8C:*C284420
                                    DPT0DV9C,DPT0DVXC,DPT0DVX1,DPT0DVX2:*0917793
                                    DPT0DVX3                            *0956210
            MATCH     "1",KEY1       * valid code for this Edition ?
            GOTO      VDSCD820 IF NOT EQUAL
            GOTO      VDSCD040
          ENDIF
.
VDSCD010  LOAD      KEY1,ICDRDVER,DPT0DV1C,DPT0DV2C,DPT0DV3C,DPT0DV4C:
                                  DPT0DV5C,DPT0DV6C,DPT0DV7C,DPT0DV8C:*C284420
                                  DPT0DV9C,DPT0DVXC,DPT0DVX1,DPT0DVX2:*C0917793
                                  DPT0DVX3                            *C0956210
          MATCH     "1",KEY1         * valid code for this Edition ?
          GOTO      VDSCD820 IF NOT EQUAL
.
.         ---------------------             * check for valid posting code
.
VDSCD040  COMPARE   "3",ICDRDVER            * is Edition 3 or greater ?
          GOTO      VDSCD050 IF LESS
          CMATCH    "P",DFLAG               * Only check for Ed3 & above Codes
          GOTO      VDSCD850 IF NOT EQUAL   * Not a posting operation code
          GOTO      VDSCD050
.
.         -----------------------           * process the valid ICD10 code
.
VDSCD050  COMPARE   "9",CODTYP
          GOTO      VDSCD060 IF EQUAL       * Using ICD9
.
          MATCH     ANSM,DSCODPFX
          GOTO      VDSCD060 IF NOT EQUAL   * Morphology prefix not keyed in
.
          MATCH     "4",PT0DACRQ
          GOTO      VDSCD060 IF EQUAL       * Morphology code keyed in
.
          SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: This code must be a morphology",WEBWRN[WARNCNT]
            ENDSET     WEBWRN[WARNCNT]
            APPEND    " code.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: This code must be a morphology code.  "
            ENDIF
          ENDIF
          RESET     PRGID
.
VDSCD060  IF        CODTYP=9
            PACK      KEY9,DSCOD
            CALL      RDPTCAN1              * Read a cancer code file record
            IF        OVRCD<>1
              SCAN      "WEB",PRGID     
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Warning: This is a cancer code. ",WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  PRINT     *23,"Warning: This is a cancer code.  "
                ENDIF
              ENDIF
              RESET     PRGID
            ENDIF
          ENDIF
.
          COMPARE   TWO,MRCNUCRG
          GOTO      VDSCD080 IF NOT EQUAL   * Not using NZ cancer reg validation
.
          IF        CODTYP=9
            MATCH     ANSM,DSCOD
            GOTO      VDSCD080 IF NOT EQUAL * Not a M code
          ELSE
            MOVE      ZERO,FORM2
            MOVE      PT0DACRQ,FORM2
            COMPARE   FOUR,FORM2
            GOTO      VDSCD080 IF NOT EQUAL * Not a M code
          ENDIF
.
          MATCH     SP9,SDSCNCD
          GOTO      VDSCD080 IF NOT EQUAL   * Cancer code, no error
.
VDSCD070  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Morphology codes must be ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    "preceded by a cancer code. ",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Morphology codes must be preceded by a":
                        " cancer code.  "
            ENDIF
          ENDIF
          RESET     PRGID
.
VDSCD080  COMPARE   "9",CODTYP
          GOTO      VDSCD100 IF NOT EQUAL   * Not using ICD9
.
          MOVE      ZERO,F1                                           *I-245178
          MOVE      MRCNECOD,F1                                       *I-245178
.
          MOVE      DSCOD,KEY1
          MOVE      ZERO,FORM1
          MOVE      KEY1,FORM1
          IF        FORM1=9 | FORM1=8
            IF        PTCECODE=1 | F1=1
              SCAN      "WEB",PRGID     
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "An 'E' code must also be coded.",WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  PRINT     *23,"An 'E' code must also be coded.  "
                ENDIF
              ENDIF
              RESET     PRGID
            ELSE
              SCAN      "WEB",PRGID     
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Warning: An 'E' code must also be ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    "coded.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  PRINT     *23,"Warning: An 'E' code must also be coded.  "
                ENDIF
              ENDIF
              RESET     PRGID
            ENDIF
          ENDIF
.
. ----- Perform sex checks -----
.
VDSCD100  MOVE      ZERO,FORM1
          MOVE      DSEX,FORM1              * Sex restraint
.
          BRANCH    FORM1,VDSCD110,VDSCD120,VDSCD130,VDSCD140,VDSCD150:
                          VDSCD160
          GOTO      VDSCD200
.
VDSCD110  CMATCH    ANSM,PSEX
          GOTO      VDSCD805 IF EQUAL       * Fatal gender error
          GOTO      VDSCD200
.
VDSCD120  CMATCH    ANSM,PSEX               * Warn if Male
          GOTO      VDSCD190 IF EQUAL       * Sex warning
          CMATCH    ANSI,PSEX               * Warn if Indeter.         *I-52585
          GOTO      VDSCD190 IF EQUAL       * Sex warning              *I-52585
          GOTO      VDSCD200
.
VDSCD130  CMATCH    ANSF,PSEX
          GOTO      VDSCD805 IF EQUAL       * Fatal gender error
          GOTO      VDSCD200
.
VDSCD140  CMATCH    ANSF,PSEX               * Warn if Female
          GOTO      VDSCD190 IF EQUAL       * Sex warning
          CMATCH    ANSI,PSEX               * Warn if Indeter.         *I-52585
          GOTO      VDSCD190 IF EQUAL       * Sex warning              *I-52585
          GOTO      VDSCD200
.
VDSCD150  CALL      VEXSX000                * check for Ass. Cond?
          IF        FOUNDFLG=0
            CMATCH    ANSF,PSEX
            GOTO      VDSCD170 IF EQUAL     * Female and no Male code.
          ENDIF
          GOTO      VDSCD200
.
VDSCD160  CALL      VEXSX000                * check for Ass. Cond?
          IF        FOUNDFLG=0
            CMATCH    ANSM,PSEX
            GOTO      VDSCD180 IF EQUAL     * Male and no Female code.
          ENDIF
          GOTO      VDSCD200
.
VDSCD170  SCAN      "WEB",PRGID
          IF        @EQUAL
            MOVE      "Female with no associated explanation code.",WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Reject: Female with no ":
                            "associated explanation code.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
VDSCD180  SCAN      "WEB",PRGID
          IF        @EQUAL
            MOVE      "Male with no associated explanation code.",WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Reject: Male with no ":
                            "associated explanation code.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
VDSCD190  SCAN      "WEB",PRGID     
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Disease code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " gender warning for ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    AADMNO,WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Disease code ",DPCODE: 
                        " gender warning. "
            ENDIF
          ENDIF
          RESET     PRGID
.
. ----- Perform area checks -----
.
VDSCD200  MOVE      ZERO,FORM1
          MOVE      DAREA,FORM1             * Area restraint
.
          COMPARE   ONE,FORM1
          GOTO      VDSCD810 IF EQUAL       * Fatal error
.
          COMPARE   TWO,FORM1
          GOTO      VDSCD210 IF EQUAL       * Area warning
.
          MATCH     PTCNGDV3,DDATE    * Is Discharge date < ICD10v3 golive date
          GOTO      VDSCD300 IF LESS  * Yes, skip follwing V3 Edits
. 
          COMPARE   THREE,FORM1                                      
          GOTO      VDSCD220 IF EQUAL       * Notify Disease      
.
          COMPARE   FOUR,FORM1                                   
          GOTO      VDSCD230 IF EQUAL       * Notify Rare Disease    
.
          GOTO      VDSCD300
.
VDSCD210  SCAN      "WEB",PRGID
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Disease code area warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Disease code area warning.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD300
.
VDSCD220  SCAN      "WEB",PRGID                                   
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Notify: Infectious Disease code area warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Notify: Infectious Disease code ":
                            "area warning."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD300
.
VDSCD230  SCAN      "WEB",PRGID                                       
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Notify: Infectious Rare Disease code area warning.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Notify: Infectious Rare Disease code ":
                            "area warning."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD300
.
. ----- Perform dagger checks -----
.
VDSCD300  COMPARE   "9",CODTYP
          GOTO      VDSCD380 IF NOT EQUAL   * Not using ICD9
.
          MOVE      ZERO,FORM1
          MOVE      DDAGGER,FORM1           * Dagger restraint
.
          IF        PTCNCDRS=1
            BRANCH    FORM1,VDSCD400,VDSCD310,VDSCD320,VDSCD400,VDSCD370:
                            VDSCD330,VDSCD340,VDSCD350,VDSCD360
          ELSE
            COMPARE   TWO,FORM1
            GOTO      VDSCD400 IF NOT EQUAL * Perform age checks
.
            CMATCH    CMDISP,DSCODPFX
            GOTO      VDSCD810 IF EQUAL     * Fatal error
          ENDIF
          GOTO      VDSCD400
.
VDSCD310  COMPARE   ONE,DSCODNO
          GOTO      VDSCD810 IF EQUAL       * Fatal error for 1st code
          GOTO      VDSCD400
.
VDSCD320  COMPARE   ONE,DSCODNO
          GOTO      VDSCD810 IF EQUAL       * Fatal error for 1st code
          GOTO      VDSCD400
.
VDSCD330  COMPARE   ONE,DSCODNO
          GOTO      VDSCD370 IF EQUAL       * Coding warning for 1st code
          GOTO      VDSCD400
.
VDSCD340  CMATCH    ANSE,DSCOD
          GOTO      VDSCD400 IF NOT EQUAL   * Not an 'E' code
.
          COMPARE   ONE,ECODECNT
          GOTO      VDSCD810 IF EQUAL       * Fatal error for 1st 'E' code
          GOTO      VDSCD400
.
VDSCD350  COMPARE   ONE,DSCODNO
          GOTO      VDSCD370 IF EQUAL       * Coding warning for 1st code
          GOTO      VDSCD400
.
VDSCD360  COMPARE   ONE,DSCODNO
          GOTO      VDSCD370 IF EQUAL       * Coding warning for 1st code
          GOTO      VDSCD400
.
VDSCD370  SCAN      "WEB",PRGID
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Disease code coding restraint ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    "warning. ",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Disease code coding restraint warning.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD400
.
VDSCD380  MATCH     ANSD,PT0DADTP
          GOTO      VDSCD390 IF NOT EQUAL   * Dagger code
.
          MOVE      ZERO,FORM1
          MOVE      DDAGGER,FORM1           * Dagger restraint
          IF        FORM1=1
.                                           * use PT0DSACD or PT0DSAC2 C-253821
            IF      ICDRDVER < 4
              MOVE      PT0DSACD,KEY9
            ELSE
              PACK      KEY9,PT0DSAC2,SP10
            ENDIF
            MATCH     SP9,KEY9                                 * end  *C-253821
            IF        @EQUAL
              SCAN      "WEB",PRGID
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Full time dagger code. The Following",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    " code must be an asterisk code.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  PRINT     *23,"Full time dagger code.The following code must":
                                " be an asterisk code."
                ENDIF
              ENDIF
              RESET     PRGID
            ELSE
              SCAN      "WEB",PRGID
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Full time dagger code.  ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                IF        ICDRDVER < 4
                  APPEND    PT0DSACD,WEBWRN[WARNCNT]
                ELSE
                  APPEND    PT0DSAC2,WEBWRN[WARNCNT]
                ENDIF
                ENDSET    WEBWRN[WARNCNT]
                APPEND    " must follow this code.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  IF        ICDRDVER < 4
                    PRINT     *23,"Full time dagger code.  ",PT0DSACD:
                              " must follow this code.  "
                  ELSE
                    PRINT     *23,"Full time dagger code.  ",PT0DSAC2:
                              " must follow this code.  "
                  ENDIF                                         * end *C-253821
                ENDIF
              ENDIF
              RESET     PRGID
            ENDIF
          ENDIF
.
          IF        FORM1=2
.                                           * use PT0DSACD or PT0DSAC2 C-253821
            IF      ICDRDVER < 4
              MOVE      PT0DSACD,KEY9
            ELSE
              PACK      KEY9,PT0DSAC2,SP10
            ENDIF
            MATCH     SP9,KEY9                                 * end  *C-253821
            IF        @EQUAL
              SCAN      "WEB",PRGID
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Warning: Part time dagger code. The ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    "following code needs to be an ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                APPEND    "asterisk code. ",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  PRINT     *23,"Warning: Part time dagger code.The ":
                          "following code needs to be an asterisk code."
                ENDIF
              ENDIF
              RESET     PRGID
            ELSE
              SCAN      "WEB",PRGID
              IF        @EQUAL
                ADD       ONE,WARNCNT
                MOVE      "Warning: Part time dagger code. ",WEBWRN[WARNCNT]
                ENDSET    WEBWRN[WARNCNT]
                IF        ICDRDVER < 4
                  APPEND    PT0DSACD,WEBWRN[WARNCNT]
                ELSE
                  APPEND    PT0DSAC2,WEBWRN[WARNCNT]
                ENDIF                                           * end *C-253821
                ENDSET    WEBWRN[WARNCNT]
                APPEND    " needs to follow.",WEBWRN[WARNCNT]
                RESET     WEBWRN[WARNCNT]
              ELSE
                MATCH     "IBAMRT53",PRGID
                IF        @EQUAL
                  IF        ICDRDVER < 4
                    PRINT     *23,"Warning: Part time dagger code.  ":
                              PT0DSACD," needs to follow.  "
                  ELSE
                    PRINT     *23,"Warning: Part time dagger code.  ":
                              PT0DSAC2," needs to follow.  "
                  ENDIF
                ENDIF
              ENDIF
              RESET     PRGID
            ENDIF
          ENDIF
.
VDSCD390  MATCH     ANSA,PT0DADTP
          GOTO      VDSCD400 IF NOT EQUAL   * Asterisk code
.
          MATCH     "3",DDAGGER
          GOTO      VDSCD400 IF NOT EQUAL   * Not a mandatory asterisk code
.
          MATCH     SP9,SDSDGCD
          IF        @EQUAL
            SCAN      "WEB",PRGID
            IF        @EQUAL
              ADD       ONE,WARNCNT
              MOVE      "Asterisk code. The previous code must ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    "be a dagger code.",WEBWRN[WARNCNT]
              RESET     WEBWRN[WARNCNT]
            ELSE
              MATCH     "IBAMRT53",PRGID
              IF        @EQUAL
                PRINT     *23,"Asterisk code.  The previous code must be a":
                          " dagger code."
              ENDIF
            ENDIF
            RESET     PRGID
          ELSE
            SCAN      "WEB",PRGID      
            IF        @EQUAL
              ADD       ONE,WARNCNT
              MOVE      "Asterisk code. The previous dagger ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    "code must be ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    SDSDGCD,WEBWRN[WARNCNT]
              RESET     WEBWRN[WARNCNT]
            ELSE
              MATCH     "IBAMRT53",PRGID
              IF        @EQUAL
                PRINT     *23,"Asterisk code. The previous dagger ":
                          "code must be ",SDSDGCD,".  "
              ENDIF
            ENDIF
            RESET     PRGID
          ENDIF
.
. ----- Perform age checks -----
.
VDSCD400  MOVE      ZERO,F2
          MOVE      DAGEGP,F2               * 1st age restraint
          MATCH     SP70,DAGEGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",DAGEGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",DAGEGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",DAGEGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      DLOW,F3A                * 1st age low limit
          MOVE      DHIGH,F3B               * 1st age high limit
          IF        ICDRDVER > 9
            MOVE      PTXDALL1,F3A          * 1st age low limit ed.10 onwards
            MOVE      PTXDAHL1,F3B          * 1st age high limit ed.10 onwards
          ENDIF
.
          COMPARE   "9",CODTYP
          GOTO      VDSCD410 IF EQUAL       * Using ICD9
.
          MOVE      ZERO,FORM2
          MOVE      ZERO,F2
          MOVE      PT0D2AGP,F2             * 2nd age restraint
          MATCH     SP70,PT0D2AGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",PT0D2AGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",PT0D2AGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",PT0D2AGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      PT0D2ALL,F3A            * 2nd age low limit
          MOVE      PT0D2AHL,F3B            * 2nd age high limit
          IF        ICDRDVER > 9
            MOVE      PTXDALL2,F3A          * 2nd age low limit ed.10 onwards
            MOVE      PTXDAHL2,F3B          * 2nd age high limit ed.10 onwards
          ENDIF
.
VDSCD410  BRANCH    F2,VDSCD420,VDSCD430,VDSCD440,VDSCD450,VDSCD460:
                       VDSCD470,VDSCD480,VDSCD490,VDSCD492,VDSCD494:
                       VDSCD496,VDSCD498
          GOTO      VDSCD510
.
VDSCD420  COMPARE   PSAGEMNT,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD810                * Fatal - within month range
.
VDSCD430  COMPARE   PSAGEMNT,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD500                * Warning - within month range
.
VDSCD440  COMPARE   PSAGEYRS,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD810                * Fatal - within year range
.
VDSCD450  COMPARE   PSAGEYRS,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD500                * Warning - within year range
.
VDSCD460  COMPARE   PSAGEYRS,F3B
          GOTO      VDSCD810 IF LESS        * Fatal - outside year range
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VDSCD810 IF LESS        * Fatal - outside year range
          GOTO      VDSCD510        
.
VDSCD470  COMPARE   PSAGEYRS,F3B
          GOTO      VDSCD500 IF LESS        * Warning - outside year range
.
          COMPARE   F3A,PSAGEYRS
          GOTO      VDSCD500 IF LESS        * Warning - outside year range
          GOTO      VDSCD510
.
VDSCD480  COMPARE   PSAGEMNT,F3B
          GOTO      VDSCD810 IF LESS        * Fatal - outside month range
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VDSCD810 IF LESS        * Fatal - outside month range
          GOTO      VDSCD510
.
VDSCD490  COMPARE   PSAGEMNT,F3B
          GOTO      VDSCD500 IF LESS        * Warning - outside month range
.
          COMPARE   F3A,PSAGEMNT
          GOTO      VDSCD500 IF LESS        * Warning - outside month range
          GOTO      VDSCD510
.
VDSCD492  COMPARE   PSAGEDAY,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD810                * Fatal - within day range
.
VDSCD494  COMPARE   PSAGEDAY,F3B
          GOTO      VDSCD510 IF LESS
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VDSCD510 IF LESS
          GOTO      VDSCD500                * Warning - within day range
.
VDSCD496  COMPARE   PSAGEDAY,F3B
          GOTO      VDSCD810 IF LESS        * Fatal - outside day range
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VDSCD810 IF LESS        * Fatal - outside day range
          GOTO      VDSCD510
.
VDSCD498  COMPARE   PSAGEDAY,F3B
          GOTO      VDSCD500 IF LESS        * Warning - outside day range
.
          COMPARE   F3A,PSAGEDAY
          GOTO      VDSCD500 IF LESS        * Warning - outside day range
          GOTO      VDSCD510
.
VDSCD500  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Disease code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DSCOD,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " age warning for ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    AADMNO,WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Disease code ",DSCOD," age warning."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD600
.
VDSCD510  COMPARE   "9",CODTYP
          GOTO      VDSCD600 IF EQUAL       * Using ICD9
.
          ADD       ONE,FORM2
          MOVE      ZERO,F2
          MOVE      DAGEGP,F2               * 1st age restraint
          MATCH     SP70,DAGEGP
          IF        @EQUAL
            MOVE      ZERO,F2
          ENDIF
          MATCH     "A",DAGEGP
          IF        @EQUAL
            MOVE      "10",F2
          ENDIF
          MATCH     "B",DAGEGP
          IF        @EQUAL
            MOVE      "11",F2
          ENDIF
          MATCH     "C",DAGEGP
          IF        @EQUAL
            MOVE      "12",F2
          ENDIF
          MOVE      DLOW,F3A                * 1st age low limit
          MOVE      DHIGH,F3B               * 1st age high limit
          IF        ICDRDVER > 9
            MOVE      PTXDALL1,F3A          * 1st age low limit ed.10 onwards
            MOVE      PTXDAHL1,F3B          * 1st age high limit ed.10 onwards
          ENDIF
          BRANCH    FORM2,VDSCD410          * 2nd pass
.
. ----- Coding practice errors & warnings -----
.
VDSCD600  COMPARE   "9",CODTYP
          GOTO      VDSCD900 IF EQUAL       * Using ICD9
.
          MOVE      ZERO,FORM1
          MOVE      PT0DCPRA,FORM1
          BRANCH    FORM1,VDSCD610,VDSCD620,VDSCD630,VDSCD640
          GOTO      VDSCD700
.
VDSCD610  IF        DSCODNO=0 | DSCODNO=1
            SCAN      "WEB",PRGID      
            IF        @EQUAL
.             ADD       ONE,WARNCNT
.             MOVE      "Unacceptable 1st Disease Code  ",WEBWRN[WARNCNT]
.             ENDSET    WEBWRN[WARNCNT]
.             APPEND    DPCODE,WEBWRN[WARNCNT]
.             RESET     WEBWRN[WARNCNT]
.
              MOVE      "Unacceptable 1st Disease Code",WEBERR
              ENDSET    WEBERR
              APPEND    DPCODE,WEBERR
              RESET     WEBERR
            ELSE
              MATCH     "IBAMRT53",PRGID
              IF        @EQUAL
                PRINT     *23,"Unacceptable 1st disease code ",DPCODE,".  "
              ENDIF
            ENDIF
            RESET     PRGID
            GOTO      VDSCD950
          ENDIF
          GOTO      VDSCD700
.
VDSCD620  MATCH     "031",PTCNDGPV
          GOTO      VDSCD700 IF NOT EQUAL   * Not using v3.1 of the grouper
.
          MATCH     CMDISP,DSCODPFX
          GOTO      VDSCD700 IF NOT EQUAL   * Not a principal diagnosis
.
          IF        DSCODNO=0 | DSCODNO=1
            SCAN      "WEB",PRGID      
            IF        @EQUAL
              ADD       ONE,WARNCNT
              MOVE      "Warning: Questionable principal ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    "diagnosis (V3.1) ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    DPCODE,WEBWRN[WARNCNT]
              RESET     WEBWRN[WARNCNT]
            ELSE
              MATCH     "IBAMRT53",PRGID
              IF        @EQUAL
                PRINT     *23,"Warning: Questionable principal ":
                          "diagnosis (V3.1) ",DPCODE,".  "
              ENDIF
            ENDIF
            RESET     PRGID
          ENDIF
          GOTO      VDSCD700
.
VDSCD630  MATCH     "031",PTCNDGPV
          GOTO      VDSCD700 IF NOT EQUAL   * Not using v3.1 of the grouper
.
          MATCH     CMDISP,DSCODPFX
          GOTO      VDSCD700 IF NOT EQUAL   * Not a principal diagnosis
.
          IF        DSCODNO=0 | DSCODNO=1
            SCAN      "WEB",PRGID      
            IF        @EQUAL
              ADD       ONE,WARNCNT
              MOVE      "Warning: Non specific principal ",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    " diagnosis.  More info required.",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    " Check with MO (V3.1)",WEBWRN[WARNCNT]
              ENDSET    WEBWRN[WARNCNT]
              APPEND    DPCODE,WEBWRN[WARNCNT]
              RESET     WEBWRN[WARNCNT]
            ELSE
              MATCH     "IBAMRT53",PRGID
              IF        @EQUAL
                PRINT     *23,"Warning: Non specific principal ":
                          "diagnosis.  More info required.":
                          "Check with MO (V3.1)",DPCODE,".  "
              ENDIF
            ENDIF
            RESET     PRGID
          ENDIF
          GOTO      VDSCD700
.
VDSCD640  PACK      KEY8,AADMNO
          CALL      RDPTICU1                * Read an ICU file record
          BRANCH    OVRCD,VDSCD700
.
          COMPARE   "24",PTICUMEC
          GOTO      VDSCD700 IF NOT LESS    * CMV >= 24 hours
.
          SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Do not code CMV for < 24 hours.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning:Do not code CMV for <24 hours. "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD700
.
. ----- Additional code requirements -----
.
VDSCD700  TYPE      PT0DACRQ
          IF        !@EQUAL
            MATCH     "W",PT0DACRQ          * Warning message needed?
            GOTO      VDSCD705 IF EQUAL
          ENDIF
.
          MOVE      ZERO,FORM1
          MOVE      PT0DACRQ,FORM1
          BRANCH    FORM1,VDSCD710,VDSCD900,VDSCD730,VDSCD900,VDSCD900:
                          VDSCD760,VDSCD770,VDSCD780
          GOTO      VDSCDA00                                           *C-49037
.
VDSCD705  SCAN      "WEB",PRGID
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            APPEND    " requires an external cause code.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: ",DPCODE:
                        " requires an external cause code."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCDA00
.
VDSCD710  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Requires an external cause code to ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    "follow this code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " in the coding.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Requires an external cause code to follow":
                        "this code ",DPCODE," in the coding."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCDA00                                           *C-49037
.
VDSCD730  MOVE      ZERO,F1
....      MOVE      "C77.0    ",KEY9        * bypass Secondary Cancer *I-208570
....      MATCH     KEY9,DPCODE
....      IF        !@LESS
....        MOVE      "C79.88   ",KEY9
....        MATCH     DPCODE,KEY9
....        GOTO      VDSCDA00 IF NOT LESS
....      ENDIF                                                * end  *I-208570
.
          SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: A cancer code, requires a  ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    "morphology code to follow ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " in the coding. ",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: A cancer code.  Requires a ":
                        "morphology code to follow ",DPCODE:
                        "in the coding.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCDA00                                           *C-49037
.
VDSCD760  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "External cause code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " requires a placement code.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT    *23,"External cause code ",DPCODE:
                       " requires a placement code.  "
            ENDIF
          ENDIF 
          RESET     PRGID
          GOTO      VDSCDA00                                           *C-49037
.
VDSCD770  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "External cause code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " requires an activity code.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT    *23,"External cause code ",DPCODE:
                       " requires an activity code.  "
            ENDIF
          ENDIF 
          RESET     PRGID
          GOTO      VDSCDA00                                           *C-49037
.
VDSCD780  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "External cause code ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DPCODE,WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    " requires both activity & ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    "placement codes.",WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT    *23,"External cause code ",DPCODE:
                       " requires both activity & placement codes.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCDA00                                           *C-49037
.
. ----- Check disease Prefix       -----                               *I-49037
.
VDSCDA00  READ      CONTROLF,TEN;*235,CMDISP:
                                 *237,CMDISC,CMDISA
          MATCH     CMDISA,DSCODPFX           * IF prefix is 'Associated'?
          IF        @EQUAL
            GOTO      VDSCDA10
          ENDIF
.
          MATCH     CMDISC,DSCODPFX           * IF prefix is 'Complication'?
          IF        @EQUAL
            GOTO      VDSCDA20
          ENDIF
.
          MATCH     CMDISP,DSCODPFX           * IF prefix is 'Primary'?
          IF        @EQUAL
            GOTO      VDSCDA30
          ENDIF
.
          GOTO      VDSCD900
.
VDSCDA10  MOVE      ZERO,FORM2
          MOVE      PT0DPRFX,FORM2
          IF        FORM2 = 1 | FORM2 = 4 | FORM2 = 13
            GOTO      VDSCDA80              * codes 1, 4, 13
          ENDIF                             * NOTIFY
.
          IF        FORM2 = 6 | FORM2 = 9 | FORM2 = 12
            GOTO      VDSCDA90              * codes 6, 9, 12
          ENDIF                             * WARNING
          GOTO     VDSCD900
.
VDSCDA20  MOVE      ZERO,FORM2
          MOVE      PT0DPRFX,FORM2
          IF        FORM2 = 2 | FORM2 = 4 | FORM2 = 5 | FORM2 = 11 | FORM2 = 12
            GOTO      VDSCDA80              * codes 2, 4, 5, 11,12
          ENDIF                             * NOTIFY
.
          IF        FORM2 = 7 | FORM2 = 9 | FORM2 = 10 | FORM2 = 13
            GOTO      VDSCDA90              * codes 7, 9, 10, 13
          ENDIF                             * WARNING
          GOTO     VDSCD900
.
VDSCDA30  MOVE      ZERO,FORM2
          MOVE      PT0DPRFX,FORM2
          IF        FORM2 = 3 | FORM2 = 5
            GOTO      VDSCDA80              * codes 3, 5
          ENDIF                             * NOTIFY
.
          IF        FORM2 = 8 | FORM2 = 10 | FORM2 = 11
            GOTO      VDSCDA90              * codes 8, 10, 11
          ENDIF                             * WARNING
          GOTO     VDSCD900
.
VDSCDA80  SCAN      "WEB",PRGID
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Notify: Prefix is ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DSCODPFX,WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Notify: Prefix is ",DSCODPFX
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD900
.
VDSCDA90  SCAN      "WEB",PRGID
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Warning: Prefix is ",WEBWRN[WARNCNT]
            ENDSET    WEBWRN[WARNCNT]
            APPEND    DSCODPFX,WEBWRN[WARNCNT]
            RESET     WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Warning: Prefix is ",DSCODPFX
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD900
.
. ----- Display all error messages -----
.
VDSCD800  SCAN      "WEB",PRGID      
          IF        @EQUAL
            ADD       ONE,WARNCNT
            MOVE      "Invalid disease code.",WEBWRN[WARNCNT]
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Invalid disease code.  "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
VDSCD805  SCAN      "WEB",PRGID
          IF        @EQUAL
            MOVE      "Disease code ",WEBERR
            ENDSET    WEBERR
            APPEND    DPCODE,WEBERR
            ENDSET    WEBERR
            APPEND    " fatal gender error",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Disease code ",DPCODE:
                        " fatal gender error"
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
VDSCD810  SCAN      "WEB",PRGID      
          IF        @EQUAL
            MOVE      "Disease code ",WEBERR
            ENDSET    WEBERR
            APPEND    DPCODE,WEBERR
            ENDSET    WEBERR
            APPEND    " fatal error for this patient.",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,"Disease code ",DPCODE:
                        " fatal error for this patient. "
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
VDSCD820  SCAN      "WEB",PRGID     
          IF        @EQUAL
            MOVE      DPCODE,WEBERR
            ENDSET    WEBERR 
            APPEND    " is not a valid ICD10-AM - Ed.",WEBERR
            APPEND    ICDRDVER,WEBERR
            APPEND    " Code.",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,DPCODE," is not a valid ICD10-AM - Ed.",ICDRDVER:
                        " Code."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
.
VDSCD850  SCAN      "WEB",PRGID     
          IF        @EQUAL
            MOVE      DPCODE,WEBERR
            ENDSET    WEBERR 
            APPEND    " is not a valid Posting Code.",WEBERR
            RESET     WEBERR
          ELSE
            MATCH     "IBAMRT53",PRGID
            IF        @EQUAL
              PRINT     *23,DPCODE," is not a valid Posting Code."
            ENDIF
          ENDIF
          RESET     PRGID
          GOTO      VDSCD950
.
.
VDSCD900  MOVE      ZERO,EXIT
          GOTO      VDSCD999
.
VDSCD950  MOVE      ONE,EXIT
VDSCD999  RETURN
+
.*****************************************************************************
.*        DISHED00   - Validate Code for ICD10 Version [N] (moved from MRTWEB02)
.*****************************************************************************
DISHED00  MOVE      ZERO,EXIT
.
          MOVE      "1",ICDPRVED        * set default Previous Valid ICD Ed.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.                                       * ICDRDVER cotains the Edition No. of
.                                       * the ICD10 code read - now find the
.                                       * Edition No. of the Previous valid
.                                       * ICD10 codes into ICDPRVED
          MATCH     CURRDATE,PTCNGDV2       * is Ed.2 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 2
            MOVE      "2",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV3       * is Ed.3 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 3
            MOVE      "3",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV4       * is Ed.4 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 4
            MOVE      "4",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV5       * is Ed.5 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 5
            MOVE      "5",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV6       * is Ed.6 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 6
            MOVE      "6",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV7       * is Ed.7 alive & active  *I-219246
          IF        (@EQUAL | @LESS) & ICDRDVER > 7
            MOVE      "7",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV8       * is Ed.8 alive & active  *I-284420
          IF        (@EQUAL | @LESS) & ICDRDVER > 8
            MOVE      "8",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV9       * is Ed.9 alive & active  *I-311669
          IF        (@EQUAL | @LESS) & ICDRDVER > 9
            MOVE      "9",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDVX       * is Ed.10 alive & active *I-0833093
          IF        (@EQUAL | @LESS) & ICDRDVER > 10
            MOVE      "10",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX1       * is Ed.11 alive & active
          IF        (@EQUAL | @LESS) & ICDRDVER > 11
            MOVE      "11",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX2       * is Ed.12 alive & active *I-0917793
          IF        (@EQUAL | @LESS) & ICDRDVER > 12
            MOVE      "12",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX3       * is Ed.13 alive & active *I-0956210
          IF        (@EQUAL | @LESS) & ICDRDVER > 13
            MOVE      "13",ICDPRVED
          ENDIF
.
.
.                                    * get Golive Date for current ICD10 Codes
          LOAD      KEY8,ICDRDVER,PTCNI10D,PTCNGDV2,PTCNGDV3,PTCNGDV4:
                                  PTCNGDV5,PTCNGDV6,PTCNGDV7,PTCNGDV8:*C-284420
                                  PTCNGDV9,PTCNGDVX,PTCNGDX1,PTCNGDX2:*C-0917793
                                  PTCNGDX3                            *C-0956210
.
          MATCH     SP8,DDATE
          GOTO      DISHED20 IF EQUAL          * just in case
.                                    * now match the DDATE against the Current
.                                    * valid ICD10 Edn. Golive date
          MATCH     KEY8,DDATE       * check if DDATE is in Previous Edn. range
          IF        @LESS
            LOAD      KEY1,ICDPRVED,DPT0DV1C,DPT0DV2C,DPT0DV3C,DPT0DV4C:
                                    DPT0DV5C,DPT0DV6C,DPT0DV7C,DPT0DV8C:*C284420
                                    DPT0DV9C,DPT0DVXC,DPT0DVX1,DPT0DVX2:*0917793
                                    DPT0DVX3                            *0956210
            MATCH     "1",KEY1       * valid code for this Edition ?
            GOTO      DISHED80 IF NOT EQUAL
            GOTO      DISHED40
          ENDIF
.
DISHED20  LOAD      KEY1,ICDRDVER,DPT0DV1C,DPT0DV2C,DPT0DV3C,DPT0DV4C:
                                  DPT0DV5C,DPT0DV6C,DPT0DV7C,DPT0DV8C:*C-284420
                                  DPT0DV9C,DPT0DVXC,DPT0DVX1,DPT0DVX2:*C-0917793
                                  DPT0DVX3                            *C-0956210
          MATCH     "1",KEY1         * valid code for this Edition ?
          GOTO      DISHED80 IF NOT EQUAL
.
.         ---------------------             * check for valid posting code
.
DISHED40  COMPARE   "3",ICDRDVER            * is Edition 3 or greater ?
          GOTO      DISHED99 IF LESS
          CMATCH    "P",DFLAG               * Only check for Ed3 & above Codes
          GOTO      DISHED85 IF NOT EQUAL   * Not a posting operation code
          GOTO      DISHED99
.
.
DISHED80  MOVE      DIACODES[COUNT],WEBTITLE
...       MOVE      DPCODE,WEBTITLE                            * future fix
          ENDSET    WEBTITLE 
          APPEND    " is not a valid ICD10-AM - Ed.",WEBTITLE
          APPEND    KEY1,WEBTITLE
          APPEND    " code.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISHED99
.
DISHED85  MOVE      DIACODES[COUNT],WEBTITLE
...       MOVE      DPCODE,WEBTITLE                            * future fix
          ENDSET    WEBTITLE
          APPEND    " is not a valid Posting Code.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISHED99
.
DISHED99  RETURN
+
.*****************************************************************************
.*        OPRHED00   - Validate Code for ICD10 Version [N] (moved from MRTWEB02)
.*****************************************************************************
OPRHED00  MOVE      ZERO,EXIT
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      "1",ICDPRVED        * set default Previous Valid ICD Ed.
.                                       * ICDRDVER cotains the Edition No. of
.                                       * the ICD10 code read - now find the
.                                       * Edition No. of the Previous valid
.                                       * ICD10 codes into ICDPRVED
.
          MATCH     CURRDATE,PTCNGDV2       * is Ed.2 alive & active ?
          IF        (@EQUAL | @LESS) & ICDRDVER > 2
            MOVE      "2",ICDPRVED
          ENDIF

          MATCH     CURRDATE,PTCNGDV3       * is Ed.3 alive & active ?
          IF        (@EQUAL | @LESS) & ICDRDVER > 3
            MOVE      "3",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV4       * is Ed.4 alive & active ?
          IF        (@EQUAL | @LESS) & ICDRDVER > 4
            MOVE      "4",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV5       * is Ed.5 alive & active ?
          IF        (@EQUAL | @LESS) & ICDRDVER > 5
            MOVE      "5",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV6       * is Ed.6 alive & active ?
          IF        (@EQUAL | @LESS) & ICDRDVER > 6
            MOVE      "6",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV7       * is Ed.7 alive & active? *I-219246
          IF        (@EQUAL | @LESS) & ICDRDVER > 7
            MOVE      "7",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV8       * is Ed.8 alive & active? *I-284420
          IF        (@EQUAL | @LESS) & ICDRDVER > 8
            MOVE      "8",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDV9       * is Ed.9 alive & active? *I-311669
          IF        (@EQUAL | @LESS) & ICDRDVER > 9
            MOVE      "9",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDVX       * is Ed.10 alive & active? I-0833093
          IF        (@EQUAL | @LESS) & ICDRDVER > 10
            MOVE      "10",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX1       * is Ed.11 alive & active?
          IF        (@EQUAL | @LESS) & ICDRDVER > 11
            MOVE      "11",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX2       * is Ed.12 alive & active? I-0917793
          IF        (@EQUAL | @LESS) & ICDRDVER > 12
            MOVE      "12",ICDPRVED
          ENDIF
          MATCH     CURRDATE,PTCNGDX3       * is Ed.13 alive & active? I-0956210
          IF        (@EQUAL | @LESS) & ICDRDVER > 13
            MOVE      "13",ICDPRVED
          ENDIF
.
.
.                                    * get Golive Date for current ICD10 Codes
          LOAD      KEY8,ICDRDVER,PTCNI10D,PTCNGDV2,PTCNGDV3,PTCNGDV4:
                                  PTCNGDV5,PTCNGDV6,PTCNGDV7,PTCNGDV8:*C-284420
                                  PTCNGDV9,PTCNGDVX,PTCNGDX1,PTCNGDX2:*C-0917793
                                  PTCNGDX3                            *C-0956210
.
          MATCH     SP8,DDATE
          GOTO      OPRHED20 IF EQUAL          * just in case
.                                    * now match the DDATE against the Current
.                                    * valid ICD10 Edn. Golive date
          MATCH     KEY8,DDATE       * check if DDATE is in Previous Edn. range
          IF        @LESS
            LOAD      KEY1,ICDPRVED,DPT0OV1C,DPT0OV2C,DPT0OV3C,DPT0OV4C:
                                    DPT0OV5C,DPT0OV6C,DPT0OV7C,DPT0OV8C:*C284420
                                    DPT0OV9C,DPT0OVXC,DPT0OVX1,DPT0OVX2:*0917793
                                    DPT0OVX3                            *0956210
            MATCH     "1",KEY1       * valid code for this Edition ?
            GOTO      OPRHED80 IF NOT EQUAL
            GOTO      OPRHED40
          ENDIF
.
OPRHED20  LOAD      KEY1,ICDRDVER,DPT0OV1C,DPT0OV2C,DPT0OV3C,DPT0OV4C:
                                  DPT0OV5C,DPT0OV6C,DPT0OV7C,DPT0OV8C:*C-284420
                                  DPT0OV9C,DPT0OVXC,DPT0OVX1,DPT0OVX2:*C-0917793
                                  DPT0OVX3                            *C-0956210
          MATCH     "1",KEY1         * valid code for this Edition ?
          GOTO      OPRHED80 IF NOT EQUAL
.
.         ---------------------             * check for valid posting code
.
OPRHED40  COMPARE   "3",ICDRDVER            * is Edition 3 or greater ?
          GOTO      OPRHED99 IF LESS
          CMATCH    "P",OFLAG               * Only check for Ed3 & above Codes
          GOTO      OPRHED85 IF NOT EQUAL   * Not a posting operation code
          GOTO      OPRHED99
.
.
OPRHED80  MOVE      PROCODES[COUNT],WEBTITLE
...       MOVE      OPCODE,WEBTITLE                            * future fix
          ENDSET    WEBTITLE 
          APPEND    " is not a valid ICD10-AM - Ed.",WEBTITLE            
          APPEND    KEY1,WEBTITLE
          APPEND    " code.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRHED99
.
OPRHED85  MOVE      PROCODES[COUNT],WEBTITLE
...       MOVE      OPCODE,WEBTITLE                            * future fix
          ENDSET    WEBTITLE 
          APPEND    " is not a valid Posting Code.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OPRHED99
.
OPRHED99  RETURN
