.
.        This include produces the body of the next invoice for the current
.        NZ Private patient. PROGFLAG is used to determine if the invoice is 
.        to be displayed, printed, or just have the total calculated.
.
.---------------------------------------------------------------------------
.         
.        IF PROGFLAG = 1  THEN WORK OUT THE AMOUNT TO BE INVOICED 
.                   
.        IF PROGFLAG = 2  THEN DISPLAY NEXT INVOICE
.        
.        IF PROGFLAG = 3  THEN PRINT NEXT INVOICE
.
.        IF PROGFLAG = 4  THEN UPDATE PATFINS WITH AMOUNTS TO BE INVOICED
.
.        VERSION  :
.

.----------------------------------------------------------------------------
. V12.00.01 19/05/2025 Thanh T         TSK 0955096
.           Changed for alphanumeric visit number
.----------------------------------------------------------------------------
. V11.05.03 21/02/2025  J.Tan   TSK 0955356
.           Added FININVN,FINADMN,FINURNO
. V11.05.02 09.12.2024  DA Sarkies     TSK 0951086
.           Increased size of LOS fields for 3 to 4
. V11.05.01 29/11/2024  Thanh T        TSK 0939466
.           Added Distance in kms field
.----------------------------------------------------------------------------
.       V11.04.01 18/03/2024  J.Tan          TSK 0943949
.                 Mod checking procedure Rev.Breakdown for FFS with Win/Loss
.       V11.04.02 20/02/2024  J.Tan          TSK 0942976
.                 Mod PPFE0000 - set the co-payment for Pat invoice PRFA funder
.       V11.04.01 17/01/2024  J.Tan          TSK 0941108
.                 Mod checking Inactive Theatre Fee and fixed W/L amount
.       V11.03.03 15/11/2023  J.Tan          TSK 0939498     
.                 Fixed adding Adjustment amount to Win/Loss amount
.       V11.03.02 21/03/2023  Ebon Clements  TSK 0909393     
.                 Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes    
.       V11.03.01 12/01/2023  J.Tan          TSK 0900145
.                 Mod Win/Loss for each procedure
.       V11.01.02 18/02/2021  J.Tan          TSK 0914045
.                 Mod CNTF0000 - to check next valid Contract funding
.       V11.01.01 18/02/2021  J.Tan          TSK 0888639
.                 Added PMMITMNO - Theatre Team no
.       V11.00.03 31/08/2020  J.Tan          TSK 0895840
.                 Fixed Keyin Amount 'Include in Contract' Items
.       V11.00.02 25/08/2020  J.Tan          TSK 0896164
.                 Fixed saving KEY17 Contract Procedure (CPRC6000)
.       V11.00.01 10/03/2020  J.Tan          TSK 0838262
.                  Added Effective from and to date to MBS Item file
.       V10.14.03  19/02/2020  J.Tan            TSK 0884937
.                  Mod to check for PMMIITYP =3
.       V10.14.02  05/06/2019  J.Tan            TSK 0867131
.                  Mod to check for PMMIITYP - not to validate Misc.charge
.       V10.14.01  21/03/2019  J.Tan            TSK 0857392
.                  Changed RCP Transaction count from DIM3 to DIM5
.       V10.13.02  23/10/2018  Tracey Nguyen  TSK 0859743 
.                  Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
.       V10.13.01  19/09/2018  J.Tan          TSK 0863727
.                  Added Restrictive Override code
.       V10.12.02  05/06/2019  J.Tan            TSK 0867131
.                  Mod to check for PMMIITYP - not to validate Misc.charge
.       V10.12.01  15.01.2018  J.Tan   TSK 0848146
.                  Added CACCFEE=5 - Accumulation FI by Claim code
.       V10.11.0l  31/08/2017  J.Tan TSK 0837479
.                  Added PMMICTYP - Consumption Type
.       V10.08.01  07/09/2016 J.Tan  TSK 0823259
.                  Mods KTFE0000 to use Contract (Claim/AFUND) from nzpspraf
.       V10.07.03  15/02/2016 J.Tan  CAR 0812936
.                  Mods to initialise TOTDAYS
.       V10.07.02  29/01/2016  J.Tan         CAR 303942
.                  Mods for Payment types
.       V10.07.01  18/11/2015  J.Tan         CAR 303942
.                  Added new payment types
.       V10.05.03  29/09/2014 J.Tan  CAR 305654
.                  Mods to save GROSSTOT to SUMACC prior calculating Win/Loss
.       V10.05.02 19/09/2014 J.Tan  CAR 305963
.                  Added CLPATDTR prior CHFFS000 (Charge FFS amount)
.       V10.05.01 05/08/2014 Peter Vela     CAR 302164
.                 Added PMMIRBRS - Rebate Reason CAT Rr
.       V10.04.11 10/06/2014 Jill Parkinson CAR 301639
.                 Removed call to TFILENAM - should be called in INIT0000   
.       V10.04.10 07/05/2014 J.Tan  CAR 300260
.                  Mods checking previous record after finding Inactive Item
.       V10.04.09  22/04/2014 J.Tan  CAR 300260
.                  Mods checking for Active/Inactive NZ Misc.items
.       V10.04.08  29/04/2013 J.Tan  CAR 261630
.                  Removed port number from temp file name
.       V10.04.07  01/04/2014 J.Tan  CAR 298449
.                  Fixed checking blank Effective todate for SX Misc.items
.       V10.04.06  12/03/2014 J.Tan  CAR 298449
.                  Fixed checking quantity for packed item
.       V10.04.05  25/02/2014 J.Tan  CAR 297463
.                  Fixed to save nzspcprc before NZMS0000 in GSXM3000
.                  Removed checking zero quantity of items
.       V10.04.04  19/02/2014 J.Tan  CAR 297372
.                  Fixed CHKAMT00 - checking List of Items from Procedure Matrix
.       V10.04.03  24/01/2014 J.Tan  CAR 296422
.                  Mods to set TCLAIM=2 for Misc.Item not incl.in Win/Loss Calc.
.       V10.04.02  17/01/2014  J.Tan        CAR 295008
.                  Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.                  20/01/2014  J.Tan        CAR 249828
.                  Added PMMIPMBS,PTDTPMBS - Patient MBS Team and Counter
.       V10.04.01  09/12/2013 J.Tan  CAR 293928
.                  Fixed Items(Inc.to Contract & Bill to Pat) from Second proc.
.       V10.03.10  17/09/2013 J.Tan  CAR 259879
.                  Mods checking Eff.date for Inactive SX Misc.Items (NZGMC000)
.       V10.03.09  13/09/2013 J.Tan  CAR 287793
.                  Fixed WRTM0000 to read nzpspraf before checking nzspclm indc7
.       V10.03.08  19/06/2013 J.Tan  CAR 286676
.                  Fixed printing Pack item with invalid Misc.charge
.       V10.03.07  10/05/2013 J.Tan CAR 284175
.                  Fixed Accommodation description
.       V10.03.06  19/07/2012 J.Tan  CAR 257771
.                  Mods SX invoice to print Theatre duration column
.       V10.03.05  05/06/2012 J.Tan  CAR 246586
.                  Fixed to set Session of Theatre charges
.       V10.03.04  07/05/2012 J.Tan  CAR 264075
.                  Mods Patient Contract to have stepdown
.       V10.03.03  07/03/2012 J.Tan  CAR 250477
.                  Mods for Packed items
.       V10.03.02  06/02/2012 J.Tan  CAR 259172
.                  Fixed I*I on nzprdtaf file
.       V10.03.01  27/10/2011 J.Tan  CAR 235425
.                  Mods to display quantity on invoice screen
.       V10.02.02  12/09/2011 J.Tan  CAR 249478
.                  Fixed Extrating G/L interface for Patient with claim Indic7=P
.       V10.02.01  04/05/2011 J.Tan  CAR 238819
.                  Mods Fixed fee adjustment for claim code tcindc7=P
.                  02/05/2011 J.Tan  CAR 239526
.                  Fixed Invoice breakdown for total amount of zero
.       V10.01.03  07/02/2011 J.Tan  CAR 235602
.                  Fixed checking procedures for funder invoice
.       V10.01.02  08/12/2010 J.Tan  CAR 229956
.                  Fixed printing item group on multiple pages
.                  08/12/2010 J.Tan  CAR 231058
.                  Fixed writing admission number of nzpivbaf
.       V10.01.01  30/11/2010 Peter Vela    CAR 233148
.                  Update PTTRUCID and PTTRUUID before update to pattranf
.       V10.00.07  15/10/2010 J.Tan         CAR  231326
.                  Mods to display Adjustment on invoice for ALL
.       V10.00.06  30/09/2010 J.Tan         CAR  230735
.                  Mods to save SX adjustment fees to PTDTADPT
.       V10.00.05  18/08/2010 J.Tan         CAR 222031
.                  Mods to set PMMIDUPD and PMMITUPD
.       V10.00.04  18/05/2010 J.Tan         CAR  183677
.                  Fixed Effective date for accommodation desc.
.       V10.00.03  10/05/2010 J.Tan         CAR  218766
.                  Mods to print Total payment
.                  19/04/2010 J.Tan         CAR  221434
.                  Mods checking invoice of Items only for Win/Loss
.       V10.00.01  19/04/2010 J.Tan         CAR  219792
.                  Mods checking for Primary funder invoice of Items only 
.        V9.12.05  01/10/2009 J.Tan         CAR  204960
.                  Fixed Contract admission billed to Patient invoice
.        V9.12.04  03/09/2009 J.Tan         CAR  202803
.                  Fixed fincode for Co-payment
.        V9.12.03  19/08/2009  J.Tan             CAR 187486
.                  Mods to print/display the payer for SX invoice
.        V9.12.02  19/06/2009 J.Tan         CAR  183323
.                  Mods to generate Primary procedure first 
.        V9.12.01  19/06/2009 J.Tan         CAR  198713
.                  Fixed receipt amount
.        V9.11.06  28/04/2009  J.Tan             CAR 195596
.                  Added fields PTDTADPT PTDTADRB
.        V9.11.05  12/02/2009 J.Tan         CAR  183138
.                  Fixed printing From Funder Contribution for Patient Invoice
.        V9.11.04  20/01/2009 J.Tan         CAR  187842
.                  Changed maxline to 28 instead of 38
.        V9.11.03  14/01/2009 J.Tan         CAR  187463
.                  Fixed printing accom.for summary invoice
.        V9.11.02  28/11/2008 J.Tan         CAR  184638
.                  Fixed stepdown funder invoice (after pat.invoice raised)
.        V9.11.01  11/11/2008 J.Tan         CAR  183242
.                  Fixed CHFFS00 to set IDATEF to ADATE
.        V9.10.04  05/08/2008 J.Tan         CAR  175079
.                  Mods to All Misc.items to have actual price (no stepdown)
.                  Fixed generating bed fees with discount
.        V9.10.03  14/07/2008 J.Tan         CAR 163654
.                  Fixed generating bed fees
.        V9.10.02  11/07/2008 J.Tan         CAR 168769
.                  Fixed Win/Loss amount
.        V9.10.01  16/05/2008 J.Tan         CAR 168168
.                  Fixed to use Misc./Procedure date to get the charges
.        V9.09.19  10/04/2008 J.Tan         CAR 163760
.                  Mods to initialise PTDTBTCH - for Co-payment dtr record
.        V9.09.18  08/04/2008 J.Tan         CAR 164844
.                  Fixed printing patient invoice with Invoice breakdown
.        V9.09.17  04/04/2008 J.Tan         CAR 164844
.                  Mods for Fixed fee Patient Invoice to write to Rev.Breakdown
.                  Set fixed fee amt to Lumpsum amount for Patient Invoice (G/L)
.        V9.09.16  27/02/2008 Ebon Clements CAR 162564
.                  Populated PINVNO with CNEXTINV in WRPRV000
.        V9.09.15  08/02/2008 J.Tan         CAR 160638
.                  Fixed deposit should be only for patient invoice
.        V9.09.14  23/01/2008 J.Tan         CAR 159848
.                  Mods only update nzpspraf file when printing invoice
.        V9.09.13  28/11/2007 J.Tan         CAR 155292
.                  Fixed printing Theatre charge for Primary description
.        V9.09.12  26/10/2007 J.Tan         CAR 153442
.                  When printing a patient invoice and no other Funder invoice
.                  then set Invoiced flag(nzspinvd) to 'All Invoice raised'
.        V9.09.11  19/10/2007 J.Tan         CAR 152586
.                  Fixed getting Revenue breakdown field from nzppfeaf for
.                  procedure with no contract proc.
.        V9.09.10  08/10/2007 J.Tan         CAR 151472
.                  Fixed Keyin Misc.item amt for Contract with Max.contr.
.                  (FFS for win/loss)
.        V9.09.09  03/10/2007 J.Tan         CAR 151472
.                  Fixed FFS for win/loss
.        V9.09.08  28/09/2007 J.Tan         CAR 151225
.                  Mods printing invoice to have same info as re-print invoice
.        V9.09.07  25/09/2007 J.Tan         CAR 140282
.                  Fixed keyin price item for Win/Loss amount
.        V9.09.06  21/09/2007 J.Tan         CAR 149966
.                  Mods printing amount for Summary invoice
.        V9.09.05  21/09/2007 J.Tan         CAR 140282
.                  Assigned FFS Win/Loos to Primary funder invoice
.        V9.09.04  11/09/2007 J.Tan         CAR 147032
.                  Fixed funder contribution stepdown percentage and sub-theatre
.        V9.09.03  31/07/2007 J.Tan         CAR 140282
.                  Mods for FFS Win/Loss
.        V9.09.02  17/07/2007 J.Tan         CAR 140282
.                  Mods for Revenue breakdown
.        V9.09.01  11/07/2007 Jill Habasque CAR 144946
.                  Removed NZED0000 - get nzpmchaf effective date - not required
.        V9.08.05  08/06/2007 J.Tan         CAR 141539
.                  Fixed displaying all invoice
.        V9.08.04  23/04/2007 J.Tan         CAR 132272
.                  Mods for Credit notes
.        V9.08.03  20/03/2007  J.Tan     CAR 120014
.                  Fixed checking for eff.date of NZ Bed fees
.        V9.08.02  27/02/07 J.Tan        CAR 120014
.                  Mods checking for Contract funding with blank proc.code
.        V9.08.01  23/02/07 J.Tan        CAR 120014
.                  Mods for patient fixed fee and max.contribution
.
.*******************************************************************************
.         This is the main section of this include - it does the actual
.         work of calculating the body of the invoice
.*******************************************************************************
NZINV000  MOVE      ZERO,STALLW
          MOVE      ZERO,STDISC
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEH
          MOVE      ZERO,SPTTRLSP            * patient lumpsum
          MOVE      ZERO,SPTTRLSR            * rebate lumpsum
          MOVE      ZERO,GROSSTOT
          MOVE      ZERO,REBTOT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,GSTAMNT
          MOVE      ZERO,SPERCENT
          MOVE      ZERO,FFEEAMNT
          MOVE       "28",MAXLINE
          MOVE      ZERO,PRIMFLAG      * Primary procedure/funder with Contract
          MOVE      ZERO,FFSFLAG
          MOVE      ZERO,WNLFLAG       * Flag for Rev.Invoice with FFS Win/Loss
          MOVE      ZERO,ERDTFLAG      * G/L Extract from DTR file
          MOVE      ZERO,WRDTFLAG      * flag for Win/Loss and No Inv.raised
          MOVE      ZERO,CBFLAG 
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CALCFFS
          MOVE      ZERO,PAYMTTOT
          MOVE      ZERO,TOTDAYS
          MOVE      ZERO,PRFACNTR
.
          MOVE      CDD,CRDAY
          MOVE      CMM,CRMON
          MOVE      CCC,CRCENT
          MOVE      CYY,CRYEAR
          REP       " 0",CRDAY
          REP       " 0",CRMON
          REP       " 0",CRCENT
          REP       " 0",CRYEAR
.
          CALL      CRWL0000          * Create a tempfile to Win/Loss procedure
          CALL      CPRI0000          * Set primary funder
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1   
.
          MOVE      SP70,PMVXMHOS
          OPEN      PMSVX1A1,"pmsvx1af"
          PACK      KEY8,AADMNO
          CALL      RDPMVX11
.
          MOVE      AADMNO,TADMN   
          PACK      IDATEF WITH FCENT,FYEAR,FMON,FDAY
          REP       " 0",IDATEF
          PACK      SIDATET,SP20
          PACK      IDATET,SP20
          OPEN      NZPIBRA1,"nzpibraf"
          OPEN      NZPIVBA1,"nzpivbaf"
          OPEN      NZPRBRA1,"nzprbraf"
          OPEN      NZPRVBA1,"nzprvbaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      NZPRDTA1,"nzprdtaf"
.
. ----- Get GST stuff -----
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          CALL      AGST0000                * Get GST Accommodation if applicabl
          MOVE      IBGEAMNT,GSTPCEN        * Save GST accommodation rate
.
.       PINVFLAG=0 Display All invoices
.       PINVFLAG=1 Display Patient invoice
.       PINVFLAG=2 Display Funder invoice
.
          MOVE      ZERO,OVERPFL
          MOVE      ZERO,TRNFLAG
.
          BRANCH    PROGFLAG,NZINV100,NZINV100
          GOTO      NZINV600
.
NZINV100  MATCH     "ALL",EXPPAYER
          GOTO      NZINV200 IF NOT EQUAL
.
          MOVE      ZERO,PINVFLAG          * All Invoices flag
          GOTO      NZINV600
.
NZINV200  MATCH     SP70,EXPPAYER
          GOTO      NZINV400 IF EQUAL
          MATCH     "PRFA  ",EXPPAYER
          GOTO      NZINV400 IF EQUAL     * patient
.
          MOVE      TWO,PINVFLAG          * display Contract Invoice flag
          GOTO      NZINV600
.
NZINV400  MOVE      ONE,PINVFLAG          * display Patient Invoice flag
.
.         Processing Fees for Service
.
NZINV600  CALL      CHRFFS00              * Check for FFS
          BRANCH    F1,NZINV900           * No FFS or had already been charged
.
          CALL      CLPATDTR
          CALL      CHFFS000              * Charge FFS amount
          MOVE      ONE,FFSFLAG
.
.         Processing Procedure fees
.
NZINV900  CALL      CWNL0000             * Check if primary proc.for FFS/WinLoss
          CALL      CPRC0000             * Check for any contract procedure
.
.         If this is the first invoice raised, we need to calculate FFS Win/Loss
.         now, before the files get updated and flaged for being invoiced
.
          MOVE      ZERO,WRDTFLAG         * flag for Win/Loss and No Inv.raised
          COMPARE   THREE,PROGFLAG
          GOTO      NZINV940 IF NOT EQUAL
.
          IF        WNLFLAG=1
            CALL      UPWNL000            * Update FFS and Win/Loss file
          ENDIF
.
.         IF        MULTCNTR=1 & PRPATINV=1
.           MOVE      ZERO,ERDTFLAG
.         ENDIF
.
          IF        ERDTFLAG=1
            CALL      WRMSC000            * Write Misc.items to nzprdtaf file
          ENDIF
.
NZINV940  MOVE      ZERO,WRDTFLAG
          CALL      CTHE0000              * Get Theatre fees 
          MOVE      ZERO,CBFLAG
          CALL      GSXM0000              * Get Misc.items
.
          CALL      UPDTR000              * Update Batch details for Win/Loss
.
          MOVE      ZERO,WNLFLAG
          MOVE      ZERO,ERDTFLAG
          IF        PROGFLAG=2
            MOVE      GROSSTOT,SUMACC     * Save GROSSTOT amount
            CALL      WNLS0000            * Display Win/Loss amount
            MOVE      SUMACC,GROSSTOT
          ENDIF
.
          CALL      UPSPR000            * Update invoice flag for nzpspraf
.
NZINV999  RETURN
+
.*******************************************************************************
.         check if patient has multiple procedures
.*******************************************************************************
CPRI0000  OPEN      NZPPFEA1,"nzppfeaf"
.
          MOVE      ZERO,MULTCNTR
          MOVE      ZERO,F1
          MOVE      SP70,KEY6
          PACK      KEY17 WITH AADMNO,SP70
          CALL      RSNZSPR2
CPRI1000  CALL      RKNZSPR2
          BRANCH    OVRCD OF CPRI2000
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      CPRI2000 IF NOT EQUAL
.
          IF        F1=0
            MOVE      NZSPUNTH,KEY10
            CALL      RDOPDEA3
            IF        OVRCD=0
              CALL      FFSW0000       * Check Rev.breakdown for FFS with W/L
            ENDIF
          ENDIF
.
          COMPARE   ONE,NZSPPIND
          GOTO      CPRI1000 IF NOT EQUAL        * Not performed
.
          COMPARE   ONE,NZSPPRIM
          GOTO      CPRI1000 IF NOT EQUAL        * Not a primary
.
          MATCH     SP70,NZSPCPRC
          GOTO      CPRI9999 IF EQUAL
.
          MOVE      NZSPCNTR,PRIMFUND       * Primary funder
          MOVE      NZSPCPRC,PRIMMBS
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,CPRI1000
.
          CMATCH    "P",TCINDC7
          IF        !@EQUAL
            MATCH     "F",TCINDC7
            GOTO      CPRI1000 IF NOT EQUAL
          ENDIF
.
          MOVE      NZSPCNTR,KEY6           * Contract primary funder
          GOTO      CPRI1000
.
.         Check for other subsequence procedures
.
CPRI2000  COMPARE   ZERO,F1
          GOTO      CPRI9999 IF EQUAL       * No FFS with Win/Loss
          MATCH     SP70,KEY6
          GOTO      CPRI9999 IF EQUAL
.
          PACK      KEY17 WITH AADMNO,SP70
          CALL      RSNZSPR2
CPRI3000  CALL      RKNZSPR2
          BRANCH    OVRCD OF CPRI9999
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      CPRI9999 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND
          GOTO      CPRI3000 IF NOT EQUAL        * Not performed
.
          COMPARE   ONE,NZSPPRIM
          GOTO      CPRI3000 IF EQUAL            * Skip primary
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,CPRI3000
.
          CMATCH    "P",TCINDC7
          IF        !@EQUAL
            MATCH     "F",TCINDC7
            GOTO      CPRI3000 IF NOT EQUAL
          ENDIF
.
          MATCH     NZSPCNTR,KEY6                * Contract Primary funder
          GOTO      CPRI3000 IF EQUAL
.
          MOVE      ONE,MULTCNTR            * multiple contract procedure
          PROC      EXPY0000          * Check record in the Expected payer
.
CPRI9999  RETURN
+
.******************************************************************************
.         Check Reveneue Breakdown for Win and Loss
.******************************************************************************
FFSW0000  MOVE      ZERO,USEDEF
          PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,NZSPCNTR,SP8,NZSPCPRC,SP70
          PACK      KEY37,KEY29,OPDADATE,SP70
FFSW1000  CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      FFSW8000 IF EQUAL
.
          CALL      RPNZPFE1                  * check for previous record
          BRANCH    OVRCD,FFSW9999
.
          PACK      DIM29 WITH NZPFHOSP,NZPFCLMC,NZPFCNTR,NZPFFTAB,NZPFCPRC:
                               SP70
          MATCH     DIM29,KEY29
          GOTO      FFSW8000 IF EQUAL
.
          ADD       ONE,USEDEF
          BRANCH    USEDEF,FFSW3000,FFSW4000,FFSW5000
          GOTO      FFSW9999
.
FFSW3000  PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,SP6,SP8,NZSPCPRC,SP70
          GOTO      FFSW1000
.
FFSW4000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000        * Check Hospital claim code charging
          PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,NZSPCNTR,SP8,NZSPCPRC,SP70
          GOTO      FFSW1000
.
FFSW5000  PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,SP6,SP8,NZSPCPRC,SP70
          GOTO      FFSW1000
.
FFSW8000  COMPARE   TWO,NZPFRBRK              * FFS and Win/Loss
          GOTO      FFSW9999 IF NOT EQUAL
          MOVE      ONE,F1                  * found a procedure with W/L
.
FFSW9999  RETURN
+
.*******************************************************************************
.         Update batch details in patdtraf for FFS with Win/Loss
.         as  we don't want contract proc./Misc/Theatre to be extracted for G/L 
.*******************************************************************************
UPDTR000  COMPARE   THREE,PROGFLAG
          GOTO      UPDTR999 IF NOT EQUAL
.
.         If the primary procedure is using FFS with win/loss, then Extract 
.         data will be getting from nzprdtaf file (not from patdtraf)
.
          COMPARE   ONE,ERDTFLAG
          GOTO      UPDTR999 IF NOT EQUAL
.
          MOVE      CNEXTINV TO TREF
          PACK      KEY22 WITH AADMNO,TREF,SP70
          CALL      RDSDTRN1
UPDTR100  CALL      RDKDTRN1
          BRANCH    OVRCD,UPDTR999
.
          MATCH     AADMNO,TADMNO
          GOTO      UPDTR999 IF NOT EQUAL     * Different admission
          MOVE      CNEXTINV,KEY8
          MATCH     KEY8,TREF
          GOTO      UPDTR999 IF NOT EQUAL     * Different invoice
.
          MATCH     "9999999999999999",PTDTBTCH
          GOTO      UPDTR100 IF EQUAL
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      UPDTR400 IF NOT EQUAL
.
          PACK      SKEY22 WITH TADMNO,TREF,TTRANSN1,SP70
.
.         We need to copy rounding to extract file as it was not done until
.         invoice printed
.
UPDTR200  PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RANZRDT1
          IF        OVRCD=0
            CALL      NXTTRAN1      * Get the next transaction number
            GOTO      UPDTR200
          ENDIF
          CALL      WRNZRDT1        * Write to FFS with Win/Loss
.
          MOVE      SKEY22,KEY22    * reposition
          CALL      RDDTRN1
.
UPDTR400  MOVE      "9999999999999999",PTDTBTCH
          CALL      UPDTRN1
          GOTO      UPDTR100
.
UPDTR999  RETURN
+
.*******************************************************************************
.         Charge FFS 
.*******************************************************************************
CHFFS000  MOVE      ZERO,BDAYSCNT
          MOVE      ZERO,SUMDAYS
          MOVE      ZERO,GROSSTOT
          ADD       ADYHOSP,BDAYSCNT
          ADD       BDAYSCNT,SUMDAYS
          MOVE      ADATE,IDATEF
          UNPACK    IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
          PACK      KEY30 WITH AADMNO,SP70
          CALL      RDSTRAN2
CHFFS100  CALL      RDKTRAN2
          BRANCH    OVRCD OF CHFFS600
.
          MATCH     TADMN,AADMNO
          GOTO      CHFFS600 IF NOT EQUAL
.
          PACK      SKEY30 WITH TADMN,TDATE,TTIME,TWARD,TBED 
.
          MATCH     ANSC,TMOVE
          GOTO      CHFFS120 IF NOT EQUAL
.
.         Ignore any Doctor Change record in Transfer file
.         as Changing doctor should not change rates
.
          MATCH     TADOCT,STADOCT
          IF        !@EQUAL
            MOVE      TADOCT,STADOCT
            GOTO      CHFFS100              * Ignore doctor change record
          ENDIF
.
CHFFS120  CALL      STEPDOWN
.
CHFFS140  MOVE      TDATE,IDATET
.
.         If this is the Admission record, then just save the details
.
          CMATCH    "A",TMOVE
          GOTO      CHFFS400 IF EQUAL
.
.         If this is not a Change record, then write/display a record
.
          CMATCH    "C",TMOVE
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the ward or bed has changed, then write/display a record
.
          MATCH     TWARD,STWARD
          GOTO      CHFFS200 IF NOT EQUAL
.
          MATCH     TBED,STBED
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the rate amount has changed, then write/display a record
.
          MOVE      TRATEF,NEWRATE
          ADD       TRATEH,NEWRATE
          SUB       TALLW,NEWRATE
          SUB       TDISC,NEWRATE
.
.         Compare the old and new rates
.
          COMPARE   LSTRATE,NEWRATE
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the rebate rate has changed, then write/display a record
.
          COMPARE   TRATEH,STRATEH
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the end day of rate is changed
.
          COMPARE   TRBEND,STRBEND
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the bed type is changed
.
          MATCH     TRBTYP,STRBTYP
          GOTO      CHFFS200 IF NOT EQUAL
.
.         If the Admission type has altered then write/display a record
.
          MATCH     TATYPE,STATYPE
          GOTO      CHFFS100 IF EQUAL
.
.         If this records date is greater than or equal to the starting date,
.         then generate an accommodation record.
.
CHFFS200  MOVE      IDATET,SIDATET
.
          IF        BDTEFLAG=1
            MOVE      BACKDATE,DIM8
            MATCH     SP10,DDATE
            IF        !@EQUAL
              MATCH     DDATE,BACKDATE
              IF        !@LESS
                MOVE      DDATE,DIM8
              ENDIF
            ENDIF
.
            MATCH     IDATET,DIM8
            IF        @LESS
              MOVE      DIM8,IDATET
            ENDIF
          ENDIF
.
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS
.
.         If this is the discharge record, then we have finished
.
          CMATCH    "D",TMOVE
          GOTO      CHFFS300 IF NOT EQUAL
.
.         Update the discharged record with the new bed fee, only when
.         printing invoice
.
          COMPARE   THREE,PROGFLAG
          GOTO      CHFFS999 IF NOT EQUAL
.
          COMPARE   ONE,CSTDOWN
          GOTO      CHFFS999 IF NOT EQUAL
.
          MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2                                            *C-90221
          IF        OVRCD=0
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      SPTTRADP,PTTRADPT
            MOVE      SPTTRADR,PTTRADRB
            MOVE      SPTTRITF,PTTRITFS
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ENDIF
          GOTO      CHFFS999
.
.         If this is a Leave record, then zero the rate data
.
CHFFS300  CMATCH    "L",TMOVE
          GOTO      CHFFS320 IF EQUAL
.
.         If this not a Return record, add up the number of days
.         of hospitalization
.
          CMATCH    "R",TMOVE
          GOTO      CHFFS340 IF EQUAL
.
CHFFS320  MOVE      ZERO,CALDAYS
          MATCH     STDATE,TDATE
          IF        !@EQUAL
            DAYSEP    STDATE,TDATE,CALDAYS
          ENDIF
          ADD       CALDAYS,NBRDAYS
          ADD       CALDAYS,BDAYSCNT
.
          CMATCH    "L",TMOVE
          GOTO      CHFFS500 IF EQUAL
.
CHFFS340  MATCH     STATYPE,TATYPE           * Check for a change in adm type
          GOTO      CHFFS400 IF EQUAL
.
          MOVE      ZERO,BDAYSCNT            * Reset day count
          MOVE      ZERO,SUMDAYS
.
.         Save the rate and ward/bed information
.
CHFFS400  MOVE      TWARD,STWARD
          MOVE      TBED,STBED
          MOVE      TRATEF,STRATEF
          MOVE      TRATEG,STRATEG
          MOVE      TDISC,STDISC
          MOVE      TALLW,STALLW
          MOVE      TATYPE,STATYPE
          MOVE      TADOCT,STADOCT
          MOVE      TRBTYP,STRBTYP
          MOVE      TDATE,STDATE
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      TMOVE,STMOVE
.
.         Calculate the rate amount for this record
.
          MOVE      TRATEH,STRATEH
          MOVE      TRATEF,LSTRATE
          ADD       TRATEH,LSTRATE
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
.
          COMPARE   THREE,PROGFLAG
          GOTO      CHFFS100 IF NOT EQUAL      * not printing invoice
.
          BRANCH    OVERPFL,CHFFS100
          MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2
          IF        OVRCD=0
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      SPTTRADP,PTTRADPT
            MOVE      SPTTRADR,PTTRADRB
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ENDIF
          GOTO      CHFFS100
.
.         Save values for on-leave
.
CHFFS500  MOVE      SP3,STWARD
          MOVE      SP3,STBED
.
          MATCH     "1",PTCNCHGL
          GOTO      CHFFS100 IF EQUAL         * Charge on leave, keep values
.
          MOVE      ZERO,STEXTRA
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEG
          MOVE      ZERO,STRATEH
          MOVE      ZERO,STDISC
          MOVE      ZERO,STALLW
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,SPTTRADP
          MOVE      ZERO,SPTTRADR
          MOVE      ZERO,SPTTRITF
.
          MATCH     TATYPE,STATYPE
          GOTO      CHFFS100 IF EQUAL
.
          MOVE      ZERO,BDAYSCNT
          MOVE      ZERO,SUMDAYS
          GOTO      CHFFS100
.
.         End of this admissions records in transfer file. No Discharge record
.
CHFFS600  PACK      IDATET WITH TCENT,TYEAR,TMON,TDAY
          REP       " 0",IDATET
          MOVE      ONE,OVERPFL
.
          MOVE      ZERO,TRNFLAG
.
.         Check if a stepdown is required
.
          COMPARE   ONE,CSTDOWN
          GOTO      CHFFS700 IF NOT EQUAL
.
          MOVE      IDATET,TDATE
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBTYP,SAVBTYP
          MOVE      STRBEND,TRBEND
          CALL      STEPDOWN
          BRANCH    NOFEE,CHFFS700
.
.         Check if s stepdown was indicated = shown by a new TDATE
.
          MATCH     TDATE,IDATET
          GOTO      CHFFS140 IF NOT EQUAL
.
.         No stepdown indicated - process up to the end date
.
CHFFS700  MOVE      IDATET,SIDATET
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS
.
CHFFS999  RETURN
+
.*******************************************************************************
.         Check if the primary procedure is using FFS with Win/Loss
.*******************************************************************************
CWNL0000  MOVE      ZERO,WNLFLAG
          MOVE      SP70,PRIMFUND
          MOVE      SP70,PRIMMBS
          MOVE      ZERO,ERDTFLAG 
          BRANCH    FFSFLAG,CWNL9999
.
          BRANCH    MULTCNTR,CWNL3000
.
          MOVE      AADMNO,DAADMNO
          COMPARE   THREE,PROGFLAG
          GOTO      CWNL9999 IF NOT EQUAL        * Not printing invoice
.
.         BRANCH    PRPATINV,CWNL9999            * Printing patient invoice
.
          PACK      KEY17 WITH AADMNO,SP70
          CALL      RSNZSPR2
CWNL1000  CALL      RKNZSPR2
          BRANCH    OVRCD OF CWNL9999
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      CWNL9999 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND
          GOTO      CWNL1000 IF NOT EQUAL        * Not performed
.
          COMPARE   ONE,NZSPPRIM
          GOTO      CWNL1000 IF NOT EQUAL        * Not primary
.
          MATCH     SP70,NZSPCPRC
          GOTO      CWNL9999 IF EQUAL            * No contract
.
          MOVE      NZSPCNTR,PRIMFUND            * Primary funder
          MOVE      NZSPCPRC,PRIMMBS
          CALL      GPFE0000                     * Get procedure fee
          COMPARE   TWO,NZPFRBRK
          GOTO      CWNL9999 IF NOT EQUAL
.
.         Check if this is a Contract admission which are billed for Patient
.         instead of a Funder (ie Claim code INDIC7=P)
.
          MOVE      ZERO,F1
          IF        PRPATINV=1
            PACK      KEY5,ANSC,ANSL,NZSPCLMN
            CALL      RDCODE1
            BRANCH    OVRCD,CWNL9999
            CMATCH    "P",TCINDC7
            GOTO      CWNL9999 IF NOT EQUAL
            MOVE      ONE,F1
            GOTO      CWNL2000
          ENDIF
.
.         Check if we raising a primary funder invoice
.
          MATCH     EXPPAYER,PRIMFUND
          GOTO      CWNL9999 IF NOT EQUAL
.
.         Check if invoice raised for primary funder
.
CWNL2000  PACK      KEY16,AADMNO,SP70
          CALL      RDSINV3
CWNL2200  CALL      RDKINV3
          BRANCH    OVRCD,CWNL3000
          MOVE      PINVADM,KEY8
          MATCH     PINVADM,AADMNO
          GOTO      CWNL3000 IF NOT EQUAL      * no invoice raised yet
.
          MATCH     "1",PTINCRST               * Fully credited?
          GOTO      CWNL2200 IF EQUAL
.
.         Make sure this invoice does not only for items that are
.         'Bill to Patient' or/and 'Extra to Contract'
.
          CALL      CHIN0000                   * Check invoice
          COMPARE   ZERO,EXIT
          GOTO      CWNL2200 IF EQUAL          * invoice with no contrat
.
          BRANCH    F1,CWNL9999                * printing patient invoice
.
.         If the primary funder invoice is raised, then no ffs
.
          MATCH     PTINHFND,PRIMFUND
          GOTO      CWNL9999 IF EQUAL
          GOTO      CWNL2200
.
CWNL3000  MOVE      ONE,ERDTFLAG               * Extract from nzprdtaf
          MOVE      ONE,WNLFLAG                * Flag for FFS and Win/Loss
CWNL9999  RETURN
+
.*******************************************************************************
.         Check for any Contract Procedure fee
.*******************************************************************************
CPRC0000  OPEN      NZPSPRA2,"nzpspraf"
          OPEN      NZPCFNA1,"nzpcfnaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          MOVE      ZERO,ADMFLAG
.
          MOVE      AADMNO,DAADMNO
          PACK      KEY17 WITH AADMNO,SP70
.
          COMPARE   FOUR,PROGFLAG
          GOTO      CPRC0100 IF EQUAL          * Update patfinsf
.
          COMPARE   THREE,PROGFLAG
          GOTO      CPRC0200 IF NOT EQUAL      * Display invoice
.
.         Printing invoice prpatinv=0 for funder invoice
.                          prpatinv=1 for patient invoice
.         If printing for funder invoice, position read on the funder
.
CPRC0100  COMPARE   ZERO,PRPATINV
          GOTO      CPRC0300 IF EQUAL          * printing funder
          GOTO      CPRC0400
.
.         Displaying invoice pinvflag=0 for All Invoice
.                            pinvflag=1 for Patient Invoice
.                            pinvflag=2 for Funder Invoice
.
CPRC0200  BRANCH    PINVFLAG,CPRC0400,CPRC0300
          GOTO      CPRC0400
.
CPRC0300  PACK      KEY17 WITH AADMNO,EXPPAYER,SP70
CPRC0400  CALL      GPRIM000                * Generate the primary first
          BRANCH    EXIT,CPRC0600           * No primary procedure
          MOVE      ONE,ADMFLAG
          GOTO      CPRC1005
.
CPRC0600  CALL      RSNZSPR2
CPRC1000  IF        ADMFLAG=1
            CALL      RSNZSPR2
            MOVE      ZERO,ADMFLAG
          ENDIF
          CALL      RKNZSPR2
          BRANCH    OVRCD OF CPRC9999
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      CPRC9999 IF NOT EQUAL
.
          BRANCH    NZSPPRIM,CPRC1000       * Skip primary
.
.         Check claim code indicator for Procedure code with contract
.
CPRC1005  MATCH     SP70,NZSPCLMN
          GOTO      CPRC1000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,CPRC1000
          CMATCH    "P",TCINDC7
          GOTO      CPRC1010 IF EQUAL       * goes to patient invoice
          MATCH     "F",TCINDC7
          GOTO      CPRC1000 IF NOT EQUAL
.
CPRC1010  MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
          MOVE      ZERO,PAYMTTOT
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,HFAMT
          MOVE      SP70,CNTRKEY
.
          COMPARE   ONE,NZSPPIND
          GOTO      CPRC1000 IF NOT EQUAL        * Not performed
.
          MATCH     "3",NZSPINVD                 * All Invoiced printed?
          GOTO      CPRC1000 IF EQUAL            * Yes
.
          MATCH     SP70,NZSPCPRC
          GOTO      CPRC1000 IF EQUAL            * Yes
.
.         IF        CALCFFS=1
.           COMPARE   "1",NZSPPRIM
.           GOTO      CPRC1000 IF NOT EQUAL      * Not a primary procedure
.         ENDIF
.
          CALL      GPFE0000                     * Get procedure fee
.
          BRANCH    PROGFLAG,CPRC1100,CPRC1100,CPRC1020
.
CPRC1020  BRANCH    PRPATINV,CPRC2000            * Printing patient invoice
          GOTO      CPRC3000
.
.         PINVFLAG 0=All 1=Patient 2=Contract
.
CPRC1100  BRANCH    PINVFLAG,CPRC2000,CPRC3000
.
.         All invoices doesn't need to show Funder contribution amount
.
          MATCH     "1",NZSPCONT                 * Funder contribution
          GOTO      CPRC6000 IF EQUAL
.
          MATCH     "2",NZSPINVD
          GOTO      CPRC1200 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "P",TCINDC7
            GOTO      CPRC1800 IF EQUAL        * Funder invoice not required
          ENDIF
.
.         Funder invoice has already been raised
.
          IF        PROGFLAG=3
            COMPARE   ZERO,PRPATINV
            GOTO      CPRC1000 IF EQUAL        * skip if printing funder inv.
          ENDIF
.
          MOVE      NZSPHPAY,PAYMTTOT          * Funder invoice raised
          ADD       NZSPHADJ,PAYMTTOT
          MULT      "-1",PAYMTTOT
          GOTO       CPRC1800
.
CPRC1200  MATCH     "1",NZSPINVD
          GOTO      CPRC1800 IF NOT EQUAL
.
.         Patient invoice has already been raised
.
          IF        PROGFLAG=3
            BRANCH    PRPATINV,CPRC1000      * skip if printing patient inv.
          ENDIF
.
          MOVE      NZSPCPAY,PAYMTTOT        * Patient invoice raised
          ADD       NZSPCADJ,PAYMTTOT
          MULT      "-1",PAYMTTOT
.
CPRC1800  MOVE      NZSPFFEE,LINETOT         * Fixed fee
          MOVE      NZSPFADJ,TOTAMT          * Adjustment
.
          GOTO      CPRC6000
.
.         Patient Invoice
.
CPRC2000  MATCH     "1",NZSPINVD
          GOTO      CPRC1000 IF EQUAL            * invoice already printed 
.
          MOVE      ZERO,LINETOT
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
            MOVE      NZSPFFEE,LINETOT           * Fixed amount
          ELSE
            PACK      KEY5,ANSC,ANSL,NZSPCLMN
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              GOTO      CPRC1000 IF EQUAL      * No contr.for patient invoice
            ENDIF
          ENDIF
.
          MOVE      NZSPHPAY,PAYMTTOT            * Funder portion
          MULT      "-1",PAYMTTOT
.
          MOVE      NZSPFADJ,TOTAMT              * Fixed Adjustment
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              GOTO      CPRC6000 IF EQUAL        *  No funder invoice
            ENDIF
          ENDIF
          MOVE      NZSPHADJ,HFAMT               * Funder Adjustment
.
          GOTO      CPRC6000
.
.         Funder Invoice
.
CPRC3000  MATCH     EXPPAYER,NZSPCNTR
          GOTO      CPRC9999 IF NOT EQUAL        * different funder
.
          MATCH     "2",NZSPINVD
          GOTO      CPRC1000 IF EQUAL            * invoice already printed 
.
.
          MOVE      ZERO,LINETOT
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
.
.         Check for Patient contract fee
.
            PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              CMATCH    "P",TCINDC7
              GOTO      CPRC1000 IF EQUAL        * No funder invoice
            ENDIF
            MOVE      NZSPFFEE,LINETOT           * Fixed amount
          ENDIF
.
          MOVE      NZSPCPAY,PAYMTTOT            * Patient Co-payment
          MULT      "-1",PAYMTTOT
.
          MOVE      NZSPFADJ,TOTAMT              * Fixed Adjustment
          MOVE      NZSPCADJ,HFAMT               * Patient Co-payment Adjustment
.
CPRC6000  PACK      DIM19,KEY17,SP70             * save the key
          CALL      PPFE0000                     * Display Procedure fee
          UNPACK    DIM19,KEY17                  * restore
.
          GOTO      CPRC1000
.
.         Display message for No Contract Procedure code
.
CPRC8000  COMPARE   TWO,PROGFLAG  
          GOTO      CPRC1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr bgcolor=#cccccc><td>&nbsp;":
                             "</td><td><font color=#FF0000><b>":
                             "No Contract Procedure Code</font></b>":
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td></tr>"
          GOTO      CPRC1000
.
CPRC9999  RETURN
+
.*******************************************************************************
.         Get Primary procedure
.         Displaying invoice pinvflag=0 for All Invoice
.                            pinvflag=1 for Patient Invoice
.                            pinvflag=2 for Funder Invoice
.
.*******************************************************************************
GPRIM000  CALL      RSNZSPR2
GPRIM100  CALL      RKNZSPR2
          BRANCH    OVRCD OF GPRIM900
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      GPRIM900 IF NOT EQUAL
.
.
          IF        PINVFLAG=2
            MATCH     EXPPAYER,NZSPCNTR     * same funder?
            GOTO      GPRIM900 IF NOT EQUAL
          ENDIF
.
          COMPARE   ONE,NZSPPRIM            * Primary procedure
          GOTO      GPRIM100 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      GPRIM999
.
GPRIM900  MOVE      ONE,EXIT
GPRIM999  RETURN
+
.*******************************************************************************
.         Initialize the description
.*******************************************************************************
NZACM000  MOVE      SP30,TDDESC
          MOVE      SP30,TEDESC
.
.         Check if this is an on-leave period
.
          MATCH     SP3,STWARD
          GOTO      NZACM100 IF NOT EQUAL
.
.         Description for on-leave
.
          MOVE      "PATIENT ON LEAVE         ",TDDESC
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
          MATCH     "1",PTCNCHGL
          GOTO      NZACM720 IF NOT EQUAL     * on leave - no charge
          GOTO      NZACM700
.
.         Normal Accommodation record
.
NZACM100  OPEN      NZPBFEA1,"nzpbfeaf"
          MOVE      ZERO,USEDEF
          MATCH     SP3,STRBTYP
          GOTO      NZACM120 IF NOT EQUAL
.
          PACK      KEY6 WITH STWARD,STBED
          CALL      RDWARD1
          BRANCH    OVRCD OF NZACM500
.
          MOVE      WEFRBT,STRBTYP
.
NZACM120  PACK      KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,SP8,STATYPE,STRBTYP
.
NZACM130  CALL      EFFD0000                * Get the current effective date
          MATCH     SP70,EFTDATE
          GOTO      NZACM500 IF EQUAL
.
.         Read in the description
.
NZACM200  BRANCH    SPTTREPS,NZACM220       * manual stepdown
.
          MATCH     IDATEF,ADATE
          IF        @EQUAL
            COMPARE   ZERO,ADYHOSP
            GOTO      NZACM300 IF NOT EQUAL
          ENDIF
.
NZACM220  COMPARE   ZERO,STRBEND
          GOTO      NZACM300 IF EQUAL
.
          PACK      KEY37 WITH KEY26,EFTDATE,STRBEND,SP70
          CALL      RDNZBFE1
          COMPARE   ZERO,OVRCD
          GOTO      NZACM600 IF EQUAL
.
NZACM300  PACK      KEY34,KEY26,EFTDATE,SP70
          PACK      KEY37,KEY34,SP70
          CALL      RSNZBFE1
NZACM320  CALL      RKNZBFE1
          BRANCH    OVRCD OF NZACM500
.
          PACK      DIM34A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,NZBFEFDT,SP70
.
          MATCH     KEY34,DIM34A
          GOTO      NZACM500 IF NOT EQUAL
.
.         If this not a daycase, ignore the BFENDDY=0 record
.
          MOVE      ZERO,FORM4
          MOVE      NZBFEDAY,FORM4
          COMPARE   ZERO,FORM4
          GOTO      NZACM340 IF NOT EQUAL
.
          COMPARE   ZERO,BDAYSCNT
          GOTO      NZACM400 IF NOT EQUAL
.
          BRANCH    ACDAYCS OF NZACM600
          GOTO      NZACM320
.
NZACM340  COMPARE   ONE,ACDAYCS
          GOTO      NZACM400 IF NOT EQUAL       * not a daycase
          COMPARE   BDAYSCNT,ADYHOSP
          GOTO      NZACM400 IF NOT EQUAL
.
          COMPARE   BDAYSCNT,FORM4
          GOTO      NZACM320 IF LESS
          GOTO      NZACM600
.
.         Check the number of days
.
NZACM400  COMPARE   FORM3,BDAYSCNT
          GOTO      NZACM600 IF LESS
.
          GOTO      NZACM320
.
NZACM500  BRANCH    USEDEF OF NZACM520,NZACM620
.
          PACK      KEY26 WITH PMVXMHOS,ACLAIM,SP6,SP8,STATYPE,STRBTYP
          MOVE      ONE,USEDEF
          GOTO      NZACM130
.
NZACM520  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000        * Check Hospital claim code charging
.
          PACK      KEY26 WITH PMVXMHOS,PTCNDCLM,SP6,SP8,STATYPE,STRBTYP
          MOVE      TWO,USEDEF
          GOTO      NZACM130
.
.         We have found the description
.
NZACM600  MOVE      NZBFRATE,LSTRATE
          ADD       NZBFREBA,LSTRATE
          SUB       STALLW,LSTRATE
          SUB       STDISC,LSTRATE
          MOVE      NZBFDESC,TDDESC
          RESET     TDDESC,20
          PACK      PTDTDES2,SP20,SP20
.
.         Add the ward/bed to the description
.
NZACM620  IF        !(PROGFLAG=3 & PTCNPRWD=1)
            APPEND    "(",TDDESC
            APPEND    STWARD,TDDESC
            APPEND    SLASH,TDDESC
            APPEND    STBED,TDDESC
            APPEND    ")",TDDESC
          ENDIF
          RESET     TDDESC
.
.         Calculate the amount for the accommodation line
.
NZACM700  MOVE      LSTRATE,LINETOT
          MULT      NODAYS,LINETOT
.
.         Add up the total number of days
.
          ADD       NODAYS,TOTDAYS
.
.         Add up Gross total and Accommodation total
.
          ADD       LINETOT,GROSSTOT
.
.         Get rid of leading zero's for date display
.
NZACM720  MOVE      FDAY1,DD
          MOVE      FMON1,MM
          MOVE      FYEAR1,YY
          MOVE      FCENT1,CC
          MOVE      DD,FDAY1
          MOVE      MM,FMON1
          MOVE      YY,FYEAR1
          REP       " 0",FYEAR1
          MOVE      CC,FCENT1
.
          MOVE      TDAY1,DD
          MOVE      TMON1,MM
          MOVE      TYEAR1,YY
          MOVE      TCENT1,CC
          MOVE      DD,TDAY1
          MOVE      MM,TMON1
          MOVE      YY,TYEAR1
          REP       " 0",TYEAR1
          MOVE      CC,TCENT1
NZACM999  RETURN
+
.*******************************************************************************
.         PPFE0000 - Process Procedure fee
.*******************************************************************************
PPFE0000  MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=1
            MOVE      SP70,OPDADATE
          ENDIF
          PACK      TDDESC,NZPFDES1,SP70
.
          BRANCH    PROGFLAG OF PPFE1000,PPFE2000,PPFE5000
.
.         Set up key for a call to PATCALF
.
          PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
          GOTO      PPFE8200
.
PPFE1000  ADD       LINETOT,GROSSTOT
          ADD       TOTAMT,GROSSTOT
.
.         Calculate FFS for Win/Loss, don't include co-payment
.
          BRANCH    CALCFFS,PPFE1200
          ADD       PAYMTTOT,GROSSTOT
.
PPFE1200  MULT      "-1",HFAMT
          ADD       HFAMT,GROSSTOT
.
          MOVE      "1",KEY1               * Contract amount
          PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
          MOVE      NZSPFFEE,FORM12X2
          CALL      WRWL0000               * Write to Win/Loss tempfile
.
          IF        NZSPFADJ<>0
            PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
            MOVE      NZSPFADJ,FORM12X2    * Fixed Adjustment
            CALL      WRWL0000               * Write to Win/Loss tempfile
          ENDIF
.
          IF        NZSPCADJ<>0
            PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
            MOVE      NZSPCADJ,FORM12X2    * Patient Co-payment Adjustment
            MULT      "-1",FORM12X2
            CALL      WRWL0000               * Write to Win/Loss tempfile
          ENDIF
.
          GOTO      PPFE9999
.
.         Display Contract Procedure fee
.
PPFE2000  MOVE      ZERO,PCFLAG
.
          BRANCH    PINVFLAG,PPFE2200,PPFE2400
.
          MATCH     "1",NZSPINVD             * Check if patient invoice raised
          GOTO      PPFE2400 IF EQUAL        * yes, so display funder invoice
          MATCH     "2",NZSPINVD             * Check if funder invoice raised
          GOTO      PPFE2200 IF EQUAL        * yes, so display patient invoice
.
          MATCH     "3",NZSPINVD
          GOTO      PPFE9999 IF EQUAL        * All invoices raised
.
          ADD       NZSPFFEE,GROSSTOT
          ADD       NZSPFADJ,GROSSTOT
          MOVE      ONE,PCFLAG               * flag for All
          CALL      DFND0000                 * Display invoices
          GOTO      PPFE9999
.
PPFE2200  ADD       NZSPCPAY,GROSSTOT
          ADD       NZSPCADJ,GROSSTOT
.
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              CMATCH    "P",TCINDC7
              IF        @EQUAL
                ADD       NZSPHADJ,GROSSTOT
              ENDIF
            ENDIF
          ENDIF
.
          CALL      DPAT0000                 * Display Patient invoice
          GOTO      PPFE9999
.
PPFE2400  ADD       NZSPHPAY,GROSSTOT
          ADD       NZSPHADJ,GROSSTOT
          CALL      DFND0000                 * Display funder invoice
          GOTO      PPFE9999
.
.         Print Invoice
.
PPFE5000  MATCH     "1",NZSPCONT        * check for no hf contribution
          IF        !@EQUAL
            CALL      WRTBR000           * Write to Invoice breakdown file
            CALL      WRRBR000           * Write to Revenue breakdown file
          ENDIF
          CALL      SDTR0000             * Set DTR record
.
          IF        PINVFLAG=1 | PRPATINV=1
            MOVE      TPATAMTP,TPATAMTT   * patient invoice
            MOVE      ZERO,TREBATE
            MOVE      ONE,PTDTDTYP        * Patient invoice
            MATCH     "1",NZSPCONT
            IF        @EQUAL
              MOVE      "From Funder Contribution    ",TDDESC
            ELSE
              PACK      KEY5,ANSC,ANSL,NZSPCLMN
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "P",TCINDC7
                IF        @EQUAL
                  MOVE      TREBATE,PTDTLSRB    * save fixed fee amount
                  MOVE      TPATAMTP,PTDTLSPT   * for patient invoice
.
                  ADD       NZSPHADJ,TPATAMTT   * fixed fee adjustment
                  MOVE      NZSPHADJ,PTDTADPT   * include adjustment
                  GOTO      PPFE8040
                ENDIF
              ENDIF
              COMPARE   ZERO,TPATAMTT
              GOTO      PPFE8400 IF EQUAL
              MOVE      "Patient Co-Payment          ",TDDESC
            ENDIF
.
.           Set the Co-payment for Patient invoice using PRFA funder
.
            IF        MULTCNTR=1
              IF        ERDTFLAG=1
                IF        PRFACNTR<>0
                  MOVE      ONE,F1
                  MOVE      PRFACODE[F1],PTDTCNTR    * Funder for PRFA
                ENDIF
                GOTO      PPFE7300
              ENDIF
            ENDIF
.
            GOTO      PPFE8000
          ENDIF
.
          MOVE      TWO,PTDTDTYP          * Funder invoice
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "Funder Contribution       ",TDDESC
            MOVE      TREBATE,TPATAMTT    * funder invoice
            MOVE      ZERO,TPATAMTP
            GOTO      PPFE8000
          ENDIF
.
.         If no funder contribution then for Funder invoice
.         write two records for fixed fee and co-payment
.
          MOVE      "Fixed Fee                   ",TDDESC
          MATCH     SP70,NZSPPDES
          IF        !@EQUAL
            MOVE      NZSPPDES,TDDESC
          ENDIF
          MOVE      NZSPFFEE,TPATAMTT   * fixed fee
          ADD       NZSPFADJ,TPATAMTT   * fixed fee adjustment
          MOVE      ZERO,TPATAMTP 
          MOVE      TPATAMTT,TREBATE    * Funder to pay
          MOVE      NZSPFADJ,PTDTADPT   * Save fixed fee adjustment
.
          MOVE      NZSPFFEE,PTDTLSRB    * save fixed fee amount
          MOVE      TPATAMTP,PTDTLSPT
.
PPFE7000  CALL      NXTTRAN1
          MOVE      CNEXTINV,TREF
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RDADTRN1
          COMPARE   ZERO,OVRCD
          GOTO      PPFE7000 IF EQUAL     * Try the next transaction number
.
          MOVE      TITEMNO,KEY9
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY,SP70
          REP       " 0",KEY8
          PACK      KEY17,KEY9,KEY8,SP70
          CALL      PATITMRD
          IF        OVRCD=0
            MOVE      IMISGRP,TMISGRP
          ENDIF
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      WRDTRN1
.
          MOVE      ZERO,PTDTADPT
          COMPARE   ZERO,NZSPCPAY
          GOTO      PPFE7200 IF NOT EQUAL
          COMPARE   ZERO,NZSPCADJ
          GOTO      PPFE8100 IF EQUAL   * print fixed fee, no patient Co-payment
.
PPFE7200  MOVE      "Patient Co-Payment          ",TDDESC
          MOVE      NZSPCPAY,TPATAMTT   * Patient Co-payment
          ADD       NZSPCADJ,TPATAMTT   * Adjust.for Co-payment
          MULT      "-1",TPATAMTT
          MOVE      TPATAMTT,TREBATE    * Funder to pay
          COMPARE   ZERO,ERDTFLAG
          GOTO      PPFE8000 IF EQUAL   * Write to patdtraf
.
.         We need to write co/payment to funder invoice
.
PPFE7300  CALL      NXTTRAN1
          MOVE      CNEXTINV,TREF
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RANZRDT1
          COMPARE   ZERO,OVRCD
          GOTO      PPFE7300 IF EQUAL     * Try the next transaction number
.
          MOVE      TITEMNO,KEY9
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY,SP70
          REP       " 0",KEY8
          PACK      KEY17,KEY9,KEY8,SP70
          CALL      PATITMRD
          IF        OVRCD=0
            MOVE      IMISGRP,TMISGRP
          ENDIF
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTLSPT
          CALL      WRNZRDT1              * write co-payment for funder invoice
          GOTO      PPFE8050
.
PPFE8000  MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTLSPT
.
PPFE8040  CALL      NXTTRAN1
          MOVE      CNEXTINV,TREF
PPFE8050  PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RDADTRN1
          COMPARE   ZERO,OVRCD
          GOTO      PPFE8040 IF EQUAL     * Try the next transaction number
.
          MOVE      TITEMNO,KEY9
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY,SP70
          REP       " 0",KEY8
          PACK      KEY17,KEY9,KEY8,SP70
          CALL      PATITMRD
          IF        OVRCD=0
            MOVE      IMISGRP,TMISGRP
          ENDIF
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      WRDTRN1
          MOVE      ZERO,PTDTADPT
.
PPFE8100  CALL      WRPRV000             * Write record to Related provider
PPFE8200  CALL      PRFE0000             * Print procedure fee
          GOTO      PPFE9999
.
PPFE8400  CALL      WRPRV000             * Write record to Related provider
PPFE9999  RETURN
+
.*******************************************************************************
.         Patient invoice
.*******************************************************************************
DPAT0000  MOVE      ZERO,ADYFLAG
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "From Funder Contribution",KEY55
          ELSE
            PACK      KEY5,ANSC,ANSL,NZSPCLMN
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              IF        @EQUAL
                MOVE      ONE,ADYFLAG
              ENDIF
            ENDIF
.
            IF        ADYFLAG=1
              MOVE      NZSPPDES,KEY55
              CALL      INVBR000                * Display using Inv.Breakdown
              BRANCH    F1,DPAT2000
              GOTO      DPAT1000
            ENDIF
.
            COMPARE   ZERO,NZSPCPAY
            GOTO      DPAT2000 IF EQUAL
            MOVE      "Patient Co-Payment",KEY55
          ENDIF
.
DPAT1000  UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC;
.
          IF        NZSPPIND=1 & NZSPPRIM<>2
            WRITE     HTMLFILE;"</td><td>&nbsp;",NZSPTDUR;
          ELSE
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZSPCPAY:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZSPCPAY:
                             "</td></tr>"
.
DPAT2000  IF        ADYFLAG=1
            IF        NZSPHADJ<>0
              MOVE      NZSPHADJ,FORM12D2
              MOVE      "Fixed Fee Adjustment",KEY55
              GOTO      DPAT4000
            ENDIF
          ENDIF
.
          COMPARE   ZERO,NZSPCADJ
          GOTO      DPAT9999 IF EQUAL         * no adjustment
.
          MOVE      NZSPCADJ,FORM12D2
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "Funder Contribution Adjustment",KEY55
          ELSE
            MOVE      "Patient Co-Payment Adjustment",KEY55
          ENDIF
.
DPAT4000
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td></tr>"
.
DPAT9999  RETURN
+
.*******************************************************************************
.         Health fund invoice
.*******************************************************************************
DFND0000  MATCH     "1",NZSPCONT
          GOTO      DFND1000 IF NOT EQUAL 
.
          COMPARE   ONE,PCFLAG
          GOTO      DFND3000 IF NOT EQUAL     * no fixed fee
.
.         Display fixed fee
.
DFND1000  CALL      INVBR000                  * Display using Inv.Breakdown
          BRANCH    F1,DFND2000               * found inv.breakdown
.
          MOVE      "Fixed Fee",KEY55
          MATCH     SP70,NZSPPDES
          IF        !@EQUAL
            MOVE      NZSPPDES,KEY55
          ENDIF
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC;
.
          IF        NZSPPIND=1 & NZSPPRIM<>2
            WRITE     HTMLFILE;"</td><td>&nbsp;",NZSPTDUR;
          ELSE
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZSPFFEE:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZSPFFEE:
                             "</td></tr>"
.
.         Check for any Fixed fee adjustment
.
DFND2000  COMPARE   ZERO,NZSPFADJ
          GOTO      DFND3000 IF EQUAL         * No adjustment
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          MOVE      "Fixed Fee Adjustment",KEY55
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>&nbsp;":
                             "</td><td align=right>",NZSPFADJ:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZSPFADJ:
                             "</td></tr>"
.
.         Display Patient Co-payment
.
DFND3000  BRANCH    PCFLAG,DFND4000            * Display fixed fees only
.
          MOVE      NZSPCPAY,FORM12D2
          MULT      "-1",FORM12D2
.
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "Funder Contribution",KEY55
          ELSE
            COMPARE   ZERO,FORM12D2
            GOTO      DFND4000 IF EQUAL        * no co-payment
            MOVE      "Patient Co-Payment",KEY55
          ENDIF
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td></tr>"
.
DFND4000  COMPARE   ZERO,NZSPCADJ
          GOTO      DFND9999 IF EQUAL         * no adjustment
.
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "Funder Contribution Adjustment",KEY55
          ELSE
            MOVE      "Patient Co-Payment Adjustment",KEY55
          ENDIF
          MOVE      NZSPCADJ,FORM12D2
          MULT      "-1",FORM12D2
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td></tr>"
.
          COMPARE   ONE,PCFLAG                     * Display ALL invoice ?
          GOTO      DFND9999 IF NOT EQUAL
.
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            COMPARE   ZERO,NZSPHADJ
            GOTO      DFND9999 IF EQUAL         * no adjustment
            MOVE      "Funder Contribution Adjustment",KEY55
            MOVE      NZSPHADJ,FORM12D2
            MULT      "-1",FORM12D2
          ELSE
.           COMPARE   ZERO,NZSPCADJ
.           GOTO      DFND9999 IF EQUAL         * no adjustment
.           MOVE      "Patient Co-Payment Adjustment",KEY55
.           MOVE      NZSPCADJ,FORM12D2
.           MULT      "-1",FORM12D2
            GOTO      DFND9999
          ENDIF
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td><td>&nbsp;",KEY55:
                             "</td><td>&nbsp;",NZSPPROC:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12D2:
                             "</td></tr>"
.
DFND9999  RETURN
+
.*******************************************************************************
.         Write record to Related provider invoice contract
.*******************************************************************************
WRPRV000  CALL      CLNZPI00
          CALL      CNTF0000              * Get Contract Funding record
          BRANCH    EXIT,WRPRV999
          MATCH     "1",NZCFRPRO
          GOTO      WRPRV999 IF NOT EQUAL   * No Related Prov.invoice info.
.
          MOVE      AADMNO,DTADMNO
          MOVE      AADMNO,NZPIADMN
          MOVE      CNEXTINV,PINVNO
          MOVE      PINVNO,NZPIINVN
          MOVE      ZERO,FORM6
          MOVE      FORM6,NZPIUNIQ
.
          PACK      KEY16,NZPIADMN,NZPIINVN,SP70
          PACK      KEY22,NZPIADMN,NZPIINVN,NZPIUNIQ,SP70
          CALL      RDNZPIC1
          COMPARE   ZERO,OVRCD
          GOTO      WRPRV200 IF EQUAL         * Header record already exist
.
.         Write a header record
.
          MOVE      AADMNO,NZPIADMN
          MOVE      PINVNO,NZPIINVN
          MOVE      FORM6,NZPIUNIQ
          MOVE      AURNO,NZPIURNO
          MOVE      NZSPCNTR,NZPICNTR
          MOVE      NZSPCLMN,NZPICLMN
          MOVE      NZSPSURG,NZPISURG
          MOVE      "0",NZPIFPAY
          MOVE      "0",NZPIEXPT
.
          PACK      NZPICDAT,CCC,CYY,CMM,CDD
          REP       " 0",NZPICDAT
          MOVE      CTIMEIS,NZPICTIM
          PACK      NZSPCUID,WBSEUID,SP70
          UNPACK    SP70,NZPIUDAT,NZPIUTIM,NZPIUUID
          MOVE      NZSPANAE,NZPIANAE
.
          PACK      KEY22,NZPIADMN,NZPIINVN,NZPIUNIQ,SP70
          CALL      WRNZPIC1
          GOTO      WRPRV300
.
.         Get the last unique number
.
WRPRV200  PACK      KEY22,KEY16,Z70
          CALL      RSNZPIC1
          CALL      RPNZPIC1
          BRANCH    OVRCD,WRPRV300
.
          MATCH     NZPIADMN,DTADMNO
          GOTO      WRPRV300 IF NOT EQUAL
.
          MATCH     NZPIINVN,PINVNO
          GOTO      WRPRV300 IF NOT EQUAL
          MOVE      NZPIUNIQ,FORM6
.
WRPRV300  ADD       ONE,FORM6
          MOVE      FORM6,NZPIUNIQ
.
          MOVE      NZSPCPRC,NZPICPRC
.
          MOVE      NZSPCDAT,NZPIPDAT
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            MOVE      OPDADATE,NZPIPDAT
          ENDIF
.
          PACK      KEY22,KEY16,NZPIUNIQ,SP70
          CALL      WRNZPIC1
.
WRPRV999  RETURN
+
.*******************************************************************************
.         Display Invoice breakdown
.*******************************************************************************
INVBR000  MOVE      ZERO,F1
          MOVE      NZSPPDES,KEY25
          PACK      KEY40,CNTRKEY,SP70
          CALL      RSNZIBR1
INVBR100  CALL      RKNZIBR1
          BRANCH    OVRCD,INVBR9999
.
          PACK  KEY37,NZIBHOSP,NZIBCLMC,NZIBCNTR,NZIBFTAB,NZIBCPRC,NZIBEFDT,SP70
          MATCH     KEY37,CNTRKEY
          GOTO      INVBR999 IF NOT EQUAL
.
          IF        SPERCENT<>0
            MULT      SPERCENT,NZIBAMNT
            DIV       "100",NZIBAMNT
          ENDIF
.
          PACK      KEY5,ANSF,ANSI,NZIBBRCD
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Breakdown Code",TDESC
          ENDIF
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             "</td><td>&nbsp;",KEY25,"-",TDESC:
                             "</td><td>&nbsp;",NZSPPROC;
.
          IF        NZSPPIND=1 & NZSPPRIM<>2
            WRITE     HTMLFILE;"</td><td>&nbsp;",NZSPTDUR;
          ELSE
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>&nbsp;":
                             "</td><td>&nbsp;",NZSPCNTR:
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZIBAMNT:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",NZIBAMNT:
                             "</td></tr>"
          MOVE      ONE,F1
          GOTO      INVBR1000
.
INVBR999  RETURN
+
.*******************************************************************************
.         Write Invoice breakdown for Patient and Funder invoice 
.*******************************************************************************
WRTBR000  
.         BRANCH    PRPATINV,WRTBR9999      * Printing Patient Invoice
.         COMPARE   ZERO,NZSPFFEE
.         GOTO      WRTBR999 IF EQUAL       * No fixed fee
.
.         Check if total revenue amount equals to fix
.
          CALL      RBRK0000               * Check amount
          BRANCH    EXIT,WRTBR999          * not balanced
.
          PACK      KEY40,CNTRKEY,SP70
          CALL      RSNZIBR1
WRTBR100  CALL      RKNZIBR1
          BRANCH    OVRCD,WRTBR999
.
          PACK  KEY37,NZIBHOSP,NZIBCLMC,NZIBCNTR,NZIBFTAB,NZIBCPRC,NZIBEFDT,SP70
          MATCH     KEY37,CNTRKEY
          GOTO      WRTBR999 IF NOT EQUAL
.
          MOVE      AADMNO,NZIVADMN
          MOVE      CNEXTINV,NZIVINVN
          MOVE      NZSPUNIQ,NZIVSUNQ
          MOVE      NZIBBRCD,NZIVBRCD
          MOVE      NZIBAMNT,NZIVAMNT
          IF        SPERCENT<>0
            MULT      SPERCENT,NZIVAMNT
            DIV       "100",NZIVAMNT
          ENDIF
          MOVE      ZERO,NZIVGAMN
          MOVE      SP70,NZIVSPAR
.
          PACK      KEY22,NZIVADMN,NZIVINVN,NZIVSUNQ,NZIVBRCD,SP70
          CALL      RANZIVB1
          IF        OVRCD=1
            CALL      WRNZIVB1
          ELSE
            CALL      UPNZIVB1
          ENDIF
.
          MOVE      SP70,KEY27
          PACK      KEY5,ANSF,ANSI,NZIBBRCD
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY27
          ENDIF
          GOTO      WRTBR100
.
WRTBR999  RETURN
+
.*******************************************************************************
.         Check if Invoice breakdown amount equals to total fees
.*******************************************************************************
RBRK0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM12D2
          PACK      KEY40,CNTRKEY,SP70
          CALL      RSNZIBR1
RBRK1000  CALL      RKNZIBR1
          BRANCH    OVRCD,RBRK8000
.
          PACK  KEY37,NZIBHOSP,NZIBCLMC,NZIBCNTR,NZIBFTAB,NZIBCPRC,NZIBEFDT,SP70
          MATCH     KEY37,CNTRKEY
          GOTO      RBRK8000 IF NOT EQUAL
.
          ADD       NZIBAMNT,FORM12D2
          GOTO      RBRK1000
.
RBRK8000  COMPARE   ZERO,FORM12D2
          GOTO      RBRK8800 IF NOT EQUAL
.
          COMPARE   ZERO,NZSPFFEE
          GOTO      RBRK9999 IF EQUAL
.
RBRK8800
          IF        SPERCENT<>0
            MULT      SPERCENT,FORM12D2
            DIV       "100",FORM12D2
          ENDIF
.
          COMPARE   FORM12D2,NZSPFFEE
          GOTO      RBRK9999 IF EQUAL
.
RBRK9000  MOVE      ONE,EXIT
RBRK9999  RETURN
+
.*******************************************************************************
.        Fixed fee -Write Revenue breakdown for both Patient and Funder invoice 
.*******************************************************************************
WRRBR000  
.         BRANCH    PRPATINV,WRRBR9999      * Printing Patient Invoice
.         COMPARE   ZERO,NZSPFFEE
.         GOTO      WRRBR999 IF EQUAL       * No fixed fee
.
.         Check if total revenue amount equals to fix
.
          CALL      CBRK0000               * Check amount
          BRANCH    EXIT,WRRBR999          * not balanced
.
          PACK      KEY40,CNTRKEY,SP70
          CALL      RSNZRBR1
WRRBR100  CALL      RKNZRBR1
          BRANCH    OVRCD,WRRBR999
.
          PACK  KEY37,NZRBHOSP,NZRBCLMC,NZRBCNTR,NZRBFTAB,NZRBCPRC,NZRBEFDT,SP70
          MATCH     KEY37,CNTRKEY
          GOTO      WRRBR999 IF NOT EQUAL
.
          MOVE      AADMNO,NZRVADMN
          MOVE      CNEXTINV,NZRVINVN
          MOVE      NZSPUNIQ,NZRVSUNQ
          MOVE      NZRBBRCD,NZRVBRCD
          MOVE      NZRBAMNT,NZRVAMNT
          IF        SPERCENT<>0
            MULT      SPERCENT,NZRVAMNT
            DIV       "100",NZRVAMNT
          ENDIF
          MOVE      ZERO,NZRVGAMN
          MOVE      SP70,NZRVSPAR
.
          PACK      KEY22,NZRVADMN,NZRVINVN,NZRVSUNQ,NZRVBRCD,SP70
          CALL      RANZRVB1
          IF        OVRCD=1
            CALL      WRNZRVB1
          ELSE
            CALL      UPNZRVB1
          ENDIF
.
          MOVE      SP70,KEY27
          PACK      KEY5,ANSF,ANSI,NZRBBRCD
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY27
          ENDIF
          GOTO      WRRBR100
.
WRRBR999  RETURN
+
.*******************************************************************************
.         Check if rev.breakdown amount equals to total fees
.*******************************************************************************
CBRK0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM12D2
          PACK      KEY40,CNTRKEY,SP70
          CALL      RSNZRBR1
CBRK1000  CALL      RKNZRBR1
          BRANCH    OVRCD,CBRK8000
.
          PACK  KEY37,NZRBHOSP,NZRBCLMC,NZRBCNTR,NZRBFTAB,NZRBCPRC,NZRBEFDT,SP70
          MATCH     KEY37,CNTRKEY
          GOTO      CBRK8000 IF NOT EQUAL
.
          ADD       NZRBAMNT,FORM12D2
          GOTO      CBRK1000
.
CBRK8000  COMPARE   ZERO,FORM12D2
          GOTO      CBRK8800 IF NOT EQUAL
.
          COMPARE   ZERO,NZSPFFEE
          GOTO      CBRK9999 IF EQUAL
.
CBRK8800
          IF        SPERCENT<>0
            MULT      SPERCENT,FORM12D2
            DIV       "100",FORM12D2
          ENDIF
.
          COMPARE   FORM12D2,NZSPFFEE
          GOTO      CBRK9999 IF EQUAL
.
CBRK9000  MOVE      ONE,EXIT
CBRK9999  RETURN
+
.*******************************************************************************
.         Print Invoice breakdown for Funder Invoice only
.*******************************************************************************
PRNBR000  MOVE      ONE,F1
          COMPARE   THREE,PROGFLAG
          GOTO      PRNBR999 IF NOT EQUAL     * Not printing invoice
.
          PACK      KEY22,AADMNO,TREF,NZSPUNIQ,SP70
          CALL      RSNZIVB1
PRNBR100  CALL      RKNZIVB1
          BRANCH    OVRCD,PRNBR999
.
          MOVE      NZIVADMN,DIM8VISN
          MATCH     AADMNO,DIM8VISN
          GOTO      PRNBR999 IF NOT EQUAL      * different admission no
          MATCH     TREF,NZIVINVN
          GOTO      PRNBR999 IF NOT EQUAL      * different invoice no
          MATCH     NZSPUNIQ,NZIVSUNQ
          GOTO      PRNBR999 IF NOT EQUAL      * different Sub.uniq.no
.
          MOVE      SP70,KEY27
          PACK      KEY5,ANSF,ANSI,NZIVBRCD
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY27
          ENDIF
          MOVE      NZIVAMNT,FORM7P2
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PRNBR400 IF EQUAL
          MATCH     "1",PTCNPPRC              * print procedure code?
          GOTO      PRNBR800 IF NOT EQUAL
.
          PRINT     *14,NZSPPROC,*34,KEY27,*70,FORM7P2  * Details
          GOTO      PRNBR900
.
PRNBR400  PRINT     *14,NZSPPROC,*34,KEY27,*115,FORM7P2  * Details
          GOTO      PRNBR900
.
PRNBR800  PRINT     *18,NZSPPROC,*30,KEY27,*70,FORM7P2
.
PRNBR900  ADD       ONE,COUNT
          MOVE      ZERO,F1
          GOTO      PRNBR100
.
PRNBR999  RETURN
+
.*******************************************************************************
.         Calculate GST Amount
.*******************************************************************************
IVGST000  MOVE      ZERO,TOTGST
          MOVE      ZERO,GSTAMNT
          MOVE      GROSSTOT,GSTAMNT
          MULT      GSTPCEN,GSTAMNT     * GST amount
          DIV       "100.00",GSTAMNT    * Divide by 100 to get wanted fig.
          COMPARE   ZERO,GSTAMNT
          GOTO      IVGST999 IF EQUAL   * No GST
          MOVE      GSTAMNT,TOTGST
.
          COMPARE   THREE,PROGFLAG
          GOTO      IVGST9999 IF NOT EQUAL    * Not printing invoice
.
          PACK      FININVN,CNEXTINV,SP70
          MOVE      AADMNO,FINADMN
          MOVE      AURNO,FINURNO
.
          MOVE      ONE,FGSTFLAG
          MOVE      "A",FINTYPE
          PACK      FINCODE WITH ANSA,SP70
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
.
          MOVE      GSTAMNT,FINAMT
          CALL      PATCALF
.
IVGST999  RETURN
+
.*******************************************************************************
.         Print Procedure fee
.*******************************************************************************
PRFE0000  MOVE      SP70,KEY27
          MOVE      ONE,F1              * Default to 'No' Invoice breakdown
          MOVE      ZERO,ADYFLAG
          PACK      FINCODE,ANSD,NZSPCNTR,NZSPCPRC,SP70
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              IF        @EQUAL
                MOVE      ONE,ADYFLAG
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    PRPATINV,PRFE4000   * Print Patient Inv. 
          GOTO      PRFE6000
.
.         Patient Invoice
.
PRFE4000  MOVE      TWO,PINVTYP           * Patient invoice
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "From Funder Contribution",KEY27
            PACK      FINCODE,ANSC,NZSPCNTR,NZSPCPRC,SP70
          ELSE
            COMPARE   ZERO,NZSPCPAY
            GOTO      PRFE4200 IF NOT EQUAL
            COMPARE   ZERO,NZSPCADJ
            GOTO      PRFE4200 IF NOT EQUAL
.
.         Include adjustment to patient invoice if Catg CL indic7=P
.
            IF        ADYFLAG=1
              COMPARE   ZERO,NZSPHADJ
              GOTO      PRFE4200 IF NOT EQUAL
            ENDIF
            GOTO      PRFE9999
.
PRFE4200    MOVE      ONE,F1
            IF        ADYFLAG=1
              MOVE      NZSPPDES,KEY27
              CALL      PRNBR000              * Print invoice breakdown
              GOTO      PRFE5000
            ENDIF
            MOVE      "Patient Co-Payment",KEY27
          ENDIF
.
PRFE5000  MOVE      NZSPCPAY,FORM12P2
          ADD       NZSPCADJ,FORM12P2
          MOVE      FORM12P2,FORM7P2
.
.         Set up key for a call to PATCALF
.
          MOVE      "A",FINTYPE
          MOVE      FORM12P2,FINAMT
          MOVE      ZERO,FGSTFLAG
          CALL      WRFN0000                * Write a record to patfinsf
.
          BRANCH    F1,PRFE8000             * No Invoice Breakdown
          GOTO      PRFE8200                * printed invoice breakdown - exit
.
.         Funder Invoice
.
PRFE6000  MOVE      ONE,PINVTYP           * Funder invoice
          MATCH     "1",NZSPCONT
          GOTO      PRFE7000 IF EQUAL     * Funder contribution - No fixed fee
.
          COMPARE   THREE,PROGFLAG
          GOTO      PRFE6800 IF NOT EQUAL * Not Printing invoice
.
          MATCH     SP70,CNTRKEY
          GOTO      PRFE6800 IF EQUAL
.
          MOVE      "A",FINTYPE
          MOVE      NZSPFFEE,FINAMT
          PACK      FINCODE,ANSD,NZSPCNTR,NZSPCPRC,SP70
          OPEN      NZPRFNA1,"nzprfnaf"
          MOVE      TWO,FGSTFLAG          * write to nzprfnaf
          CALL      WRFN0000              * Write fixed fee amt to patfinsf
.
          IF        NZSPFADJ<>0
            MOVE      NZSPFADJ,FINAMT
            PACK      FINCODE,ANSE,NZSPCNTR,NZSPCPRC,SP70
            MOVE      TWO,FGSTFLAG        * write to nzprfnaf
            CALL      WRFN0000            * Write fixed fee amt to patfinsf
          ENDIF
.
          CALL      PRNBR000              * Print invoice breakdown
          BRANCH    F1,PRFE6800           * No invoice breakdown
.
.         Write to nzpfinsaf for fixed fee and adjustment
.
          MOVE      "A",FINTYPE
          MOVE      NZSPFFEE,FINAMT
          ADD       NZSPFADJ,FINAMT
          MOVE      ZERO,FGSTFLAG
          PACK      FINCODE,ANSB,NZSPCNTR,NZSPCPRC,SP70
          CALL      WRFN0000                * Write a record to patfinsf
.
          COMPARE   ZERO,NZSPFADJ
          GOTO      PRFE7000 IF EQUAL     * no adjustment
.
          MOVE      "Fixed Fee Adjustment",KEY27
          MOVE      NZSPFADJ,FORM7P2
          GOTO      PRFE6900
.
.
PRFE6800  MOVE      "Fixed Fee",KEY27
          MATCH     SP70,NZSPPDES
          IF        !@EQUAL
            MOVE      NZSPPDES,KEY27
          ENDIF
          MOVE      NZSPFFEE,FORM7P2
          ADD       NZSPFADJ,FORM7P2
.
.         Write to nzpfinsaf for fixed fee and adjustment
.
          MOVE      "A",FINTYPE
          MOVE      NZSPFFEE,FINAMT
          ADD       NZSPFADJ,FINAMT
          MOVE      ZERO,FGSTFLAG
          PACK      FINCODE,ANSB,NZSPCNTR,NZSPCPRC,SP70
          CALL      WRFN0000                * Write a record to patfinsf
.
PRFE6900  COMPARE   THREE,PROGFLAG
          GOTO      PRFE7000 IF NOT EQUAL     * not printing invoice
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MATCH     "1",PTCNPITM                         * print long item desc?
          GOTO      PRFE6960 IF EQUAL
          MATCH     "1",PTCNPPRC                         * print procedure code?
          GOTO      PRFE6980 IF NOT EQUAL
.
          PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *70,FORM7P2
          ADD       ONE,COUNT
          GOTO      PRFE7000
.
PRFE6960  PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *115,FORM7P2
          ADD       ONE,COUNT
          GOTO      PRFE7000
.
PRFE6980  PRINT     *3,CPCDATE,*18,NZSPPROC,*30,KEY27:
                    *70,FORM7P2
          ADD       ONE,COUNT
.
PRFE7000  MOVE      "A",FINTYPE
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      "Funder Contribution",KEY27
            MOVE      NZSPHPAY,FORM7P2
            ADD       NZSPHADJ,FORM7P2
            MOVE      FORM7P2,FINAMT
            PACK      FINCODE,ANSF,NZSPCNTR,NZSPCPRC,SP70
          ELSE
            COMPARE   ZERO,NZSPCPAY
            GOTO      PRFE7200 IF NOT EQUAL
            COMPARE   ZERO,NZSPCADJ
            GOTO      PRFE9999 IF EQUAL     * No patient co-payment
.
PRFE7200    MOVE      "Patient Co-Payment",KEY27
            MOVE      NZSPCPAY,FORM7P2
            ADD       NZSPCADJ,FORM7P2
            MULT      "-1",FORM7P2
.
            MOVE      NZSPCPAY,FINAMT
            ADD       NZSPCADJ,FINAMT
            MULT      "-1",FINAMT           * Funder Co-payment adjustment
            PACK      FINCODE,ANSG,NZSPCNTR,NZSPCPRC,SP70
          ENDIF
          MOVE      ZERO,FGSTFLAG
          CALL      WRFN0000                * Write a record to patfinsf
.
PRFE8000  COMPARE   THREE,PROGFLAG
          GOTO      PRFE9999 IF NOT EQUAL   * Not printing invoice
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MATCH     "1",PTCNPITM                         * print long item desc?
          GOTO      PRFE8120 IF EQUAL
          MATCH     "1",PTCNPPRC                         * print procedure code?
          GOTO      PRFE8180 IF NOT EQUAL
.
          PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *70,FORM7P2
          ADD       ONE,COUNT
          GOTO      PRFE8200
.
PRFE8120  PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *115,FORM7P2
          ADD       ONE,COUNT
          GOTO      PRFE8200
.
PRFE8180  PRINT     *3,CPCDATE,*18,NZSPPROC,*30,KEY27:
                    *70,FORM7P2
          ADD       ONE,COUNT
.
PRFE8200  COMPARE   ONE,ADYFLAG
          GOTO      PRFE9999 IF NOT EQUAL
          COMPARE   ZERO,NZSPHADJ
          GOTO      PRFE9999 IF EQUAL
. 
          MOVE      NZSPHADJ,FORM7P2
          MOVE      "Fixed Fee Adjustment       ",KEY27
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MATCH     "1",PTCNPITM                 * print long item desc?
          GOTO      PRFE8260 IF EQUAL
          MATCH     "1",PTCNPPRC                 * print procedure code?
          GOTO      PRFE8280 IF NOT EQUAL
.
          PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *70,FORM7P2
          GOTO      PRFE9000
.
PRFE8260  PRINT     *3,CPCDATE,*14,NZSPPROC,*34,KEY27:
                    *115,FORM7P2
          GOTO      PRFE9000
.
PRFE8280  PRINT     *3,CPCDATE,*18,NZSPPROC,*30,KEY27:
                    *70,FORM7P2
.
PRFE9000  ADD       ONE,COUNT
PRFE9999  RETURN
+
.*******************************************************************************
.         Write to patfinsf
.*******************************************************************************
WRFN0000  COMPARE   FIVE,PROGFLAG
          GOTO      WRFN9999 IF EQUAL         * Print only - no update
.
          COMPARE   ZERO,FINAMT
          GOTO      WRFN9999 IF EQUAL
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
WRFN9999  RETURN
+
.*******************************************************************************
.        Write Misc.item to nzpfin
.*******************************************************************************
WNZF0000 COMPARE   FIVE,PROGFLAG
         GOTO      WNZF9999 IF EQUAL    * Print only
.
         UNPACK    SP70,FININVN,FINADMN,FINURNO
         IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
         ENDIF

         MOVE      "A",FINTYPE
         MOVE      "M",ANS
.
         IF        PTCNMFEE = 1
           PACK      FINCODE WITH ANS,ACLAIM,TMISGRP,SP20
         ELSE
           PACK      FINCODE WITH ANS,TMISGRP,TITEMNO,SP20
         ENDIF
.
         UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
         PACK      FINDATE,CCC,CYY,CMM,CDD
         REP       " 0",FINDATE
         MOVE      THREE,FINSYS
         MOVE      SP6,FINSITE
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
.
WNZF9999 RETURN
+
.*******************************************************************************
.         Set DTR record
.*******************************************************************************
SDTR0000  MOVE      AADMNO,TADMNO
          MOVE      AADMNO,DTADMNO
          MOVE      NZSPCNTR,PTDTCNTR
          MOVE      NZSPCPRC,PTDTCPRC
.
          UNPACK    SP70,TDCODE,TTYPEDEB,TTYPE
          MOVE      EIGHT,TRECTYPE      (8 = Procedure)
          MOVE      ZERO,TCLAIM 
.
          MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTI
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TREBATE 
          MOVE      ZERO,PTDTLSPT
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,TPATAMTH 
          MOVE      ZERO,PTDTGSTM 
          MOVE      SP70,PTDTGSTC
          MOVE      ZERO,PTDTDTYP         * All Invoice
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      SP10,PTDTGSTC
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MOVE      ZERO,PTDTGSTL
.
          MATCH     "1",NZSPCONT
          GOTO      SDTR2000 IF NOT EQUAL * No funder contribution
.
          MOVE      NZSPCPAY,TPATAMTP     * Patient amt. from Funder contr.
          ADD       NZSPCADJ,TPATAMTP     * Adjust.
          MOVE      NZSPHPAY,TREBATE      * Funder to pay
          ADD       NZSPHADJ,TREBATE      * Adjust.for Funder to pay
.
          GOTO      SDTR3000
.
.         No funder contribution
.
SDTR2000  MOVE      NZSPFFEE,TPATAMTT   * fixed fee
          ADD       NZSPFADJ,TPATAMTT   * fixed fee adjustment
.
          MOVE      NZSPCPAY,TPATAMTP   * Patient Co-payment
          ADD       NZSPCADJ,TPATAMTP   * Adjust.for Co-payment
.
          MOVE      NZSPHPAY,TREBATE    * Funder to pay
          ADD       NZSPHADJ,TREBATE    * Adjust.for Funder to pay
.
SDTR3000  MOVE      ZERO,TPATAMTG
          MOVE      ZERO,PTDTGSTL
.
          MOVE      ZERO,TTCENT
          MOVE      ZERO,TTYEAR
          MOVE      ZERO,TTMONTH
          MOVE      ZERO,TTDAY
          UNPACK    SP70,TDWARD,TADMTYP,TDOCTA,TDOCTO,TSESSION,TMISGRP
          UNPACK    SP70,TDEPTYP,TBATCHN,PTDTBTYP
.
          UNPACK    NZSPCDAT,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            UNPACK    OPDADATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          ENDIF
.
          MOVE      DTFCENT,TFCENT
          MOVE      DTFYEAR,TFYEAR
          MOVE      DTFMONTH,TFMONTH
          MOVE      DTFDAY,TFDAY
          MOVE      NZSPPROC,TITEMNO
          MOVE      TITEMNO,KEY9
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY,SP70
          REP       " 0",KEY8
          PACK      KEY17,KEY9,KEY8,SP70
          CALL      PATITMRD
          IF        OVRCD=0
            MOVE      IMISGRP,TMISGRP
          ENDIF
          MOVE      ZERO,TPAYTYPE
          MOVE      SP70,TRECEIPT
          UNPACK    NZSPPDES,TDDESC
          MOVE      ONE,TINVPRT
          MOVE      ZERO,TNODAYS
          MOVE      ZERO,TCLAIM
.
          MOVE      ONE,TNINVS
          MOVE      ONE,TSERVS
          MOVE      NZSPCLMN,TCLMTYP
          MOVE      SP70,PTDTDES2
          MOVE      ZERO,PTDTCCU         * no additional charges
          PACK      PTDTEFFD,PINVDTE    * Effective date to fees invoiced
          UNPACK    SP70,PTDTTIME,PTDTCRST,PTDTUNIQ
          MOVE      NZSPCONT,PTDTCONT
.
.         Workout the total invoice amount
.
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,FORM12D2
.
          IF        PINVFLAG=1 | PRPATINV=1
            MOVE      NZSPCPAY,FORM12P2
            ADD       NZSPCADJ,FORM12P2
.
.         If claim code has INDIC7=P, any adjustment will be added to patient
.         invoice
.
            MATCH     "1",NZSPCONT
            IF        !@EQUAL
              PACK      KEY5,ANSC,ANSL,NZSPCLMN
              CALL      RDCODE1
              IF        OVRCD=0
                CMATCH    "P",TCINDC7
                IF        @EQUAL
                  ADD       NZSPHADJ,FORM12P2
                ENDIF
              ENDIF
            ENDIF
            MOVE      ZERO,FORM12D2   
          ELSE
            MOVE      NZSPHPAY,FORM12P2
            ADD       NZSPHADJ,FORM12P2
            MOVE      FORM12P2,FORM12D2
          ENDIF
          ADD       FORM12P2,GROSSTOT
          ADD       FORM12D2,REBTOT
.
          MOVE      NZSPUNIQ,PTDTSUNQ
          MOVE      SP70,PTDTBTCH
          MOVE      SP70,PTDTTMNO
          MOVE      SP70,PTDTPMBS
          MOVE      SP70,PTDTPCOD
          GOTO      SDTR9999
.
SDTR9999  RETURN
+
.*******************************************************************************
.         GPFE0000 - Get procedure fee 
.*******************************************************************************
GPFE0000  MOVE      ZERO,EXIT
          MOVE      SP70,MISCDATE
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            MOVE      OPDADATE,MISCDATE
          ENDIF
.
          MOVE      ZERO,USEDEF
          MOVE      SP70,CNTRKEY
          PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,NZSPCNTR,SP8,NZSPCPRC,SP70
.
GPFE1000  CALL      PEFD0000                * Get effective date
          MATCH     SP70,EFTDATE
          GOTO      GPFE2000 IF EQUAL
.
          PACK      KEY37,KEY29,EFTDATE,SP70
          CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      GPFE6000 IF EQUAL       * found the valid proc.fee record
GPFE2000  ADD       ONE,USEDEF
          BRANCH    USEDEF,GPFE3000,GPFE4000,GPFE5000
          MOVE      SP70,NZPFDES1
.
          MATCH     "0",NZSPINVD
          GOTO      GPFE9999 IF NOT EQUAL
          GOTO      GPFE8000
.
GPFE3000  PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,SP6,SP8,NZSPCPRC,SP70
          GOTO      GPFE1000
.
GPFE4000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000        * Check Hospital claim code charging
          PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,NZSPCNTR,SP8,NZSPCPRC,SP70
          GOTO      GPFE1000
.
GPFE5000  PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,SP6,SP8,NZSPCPRC,SP70
          GOTO      GPFE1000
.
.         Only save key for Funder Invoice/Revenue breakdown with No-Contrib.
.
GPFE6000  IF        NZPFCONT<>1
            MOVE      KEY37,CNTRKEY           * save for breakup fixed fee
          ENDIF
.
.         Only Update procedure fee if no invoice raised
.
          IF        NZSPPRIM=1
            MOVE      ONE,PRIMFLAG    * Flag for Primary Funder with Contract
          ENDIF
.         MATCH     "0",NZSPINVD
.         GOTO      GPFE9999 IF NOT EQUAL
.
          MATCH     "0",NZSPINVD
          GOTO      GPFE7000 IF EQUAL         * no invoice raised
          MATCH     "1",NZSPINVD
          GOTO      GPFE9999 IF NOT EQUAL     * funder invoice raised
.
GPFE7000  BRANCH    NZPFCONT,GPFE7600         * funder contribution
.
          MATCH     SP70,NZSPCLMN
          GOTO      GPFE7700 IF EQUAL
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GPFE7700
          CMATCH    SP70,TCINDC7
          GOTO      GPFE7700 IF EQUAL
.
          CMATCH    "P",TCINDC7
          GOTO      GPFE7600 IF NOT EQUAL
.
          CALL      SDWN0000                * Check a stepdown percentage
          BRANCH    EXIT,GPFE8000
.
.         Charge fix fees to patient invoice only
.
          MOVE      NZPFHPOR,NZSPFFEE
          MOVE      NZPFHPOR,NZSPCPAY
          MOVE      ZERO,NZSPHPAY
          MOVE      "2",NZSPINVD              * No funder invoice
          GOTO      GPFE7700
.
GPFE7600  IF        NZPFCONT=1
            CALL      SDWN0000                * Check a stepdown percentage
            MOVE      ZERO,NZSPFFEE
            MOVE      NZPFPPOR,NZSPHPAY       * funder contribution
            MOVE      NZPFPPOR,NZSPCPAY
            MULT      "-1",NZSPCPAY
          ELSE
            CALL      SDWN0000                * Check a stepdown percentage
            BRANCH    EXIT,GPFE8000
            MOVE      NZPFHPOR,NZSPFFEE       * total fee
            MOVE      NZPFPPOR,NZSPCPAY       * co-payment
            MOVE      NZPFHPOR,NZSPHPAY
            SUB       NZPFPPOR,NZSPHPAY
          ENDIF
.
GPFE7700  MOVE      NZPFCONT,NZSPCONT
          IF        PROGFLAG=3
            CALL      UPNZSPR2                * update if printing invoice
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GPFE9999
.
.         No procedure fee found
.
GPFE8000  MOVE      ZERO,NZSPFFEE
          MOVE      ZERO,NZSPHPAY
          MOVE      ZERO,NZSPCPAY
          IF        PROGFLAG=3
            CALL      UPNZSPR2                * update if printing invoice
          ENDIF
          MOVE      ONE,EXIT
.
GPFE9999  RETURN
+
.*******************************************************************************
.         PEFD0000 - Get Procedure fee effective date
.*******************************************************************************
PEFD0000  MOVE      SP70,EFTDATE
          MATCH     SP8,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD
          ENDIF
          REP       " 0",MISCDATE
          PACK      KEY37,KEY29,MISCDATE,SP70
          CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      PEFD4000 IF EQUAL
.
          CALL      RPNZPFE1                  * check for previous record
          BRANCH    OVRCD,PEFD9999
.
          PACK      DIM29 WITH NZPFHOSP,NZPFCLMC,NZPFCNTR,NZPFFTAB,NZPFCPRC:
                               SP70
          MATCH     DIM29,KEY29
          GOTO      PEFD9999 IF NOT EQUAL
.
PEFD4000  MOVE      NZPFEFDT,EFTDATE         * Save the effective date
PEFD9999  RETURN
+
.*******************************************************************************
.         Check a stepdown percentage
.*******************************************************************************
SDWN0000  MOVE      ZERO,EXIT
          BRANCH    NZSPPRIM,SDWN9000     * Charge 100% for Primary
          CALL      CNTF0000              * Get Contract Funding record
          BRANCH    EXIT,SDWN9999
.
          MATCH     NZSPCNTR,AFUNDH
          GOTO      SDWN1000 IF EQUAL     * Secondary funder same as prim funder
.
          COMPARE   ZERO,SPERCENT
          GOTO      SDWN9999 IF EQUAL
.
.         Calculate percentage for Secondary funder diff.from primary funder
.
          MOVE      NZCFDPRI,SPERCENT
.
          MULT      SPERCENT,NZPFHPOR
          DIV       "100",NZPFHPOR
          MULT      SPERCENT,NZPFPPOR
          DIV       "100",NZPFPPOR
          GOTO      SDWN9999
.
.         Calculate percentage for Secondary funder same as primary funder
.
SDWN1000  MOVE      NZCFSPRI,SPERCENT
.
          MULT      SPERCENT,NZPFHPOR
          DIV       "100",NZPFHPOR
          MULT      SPERCENT,NZPFPPOR
          DIV       "100",NZPFPPOR
          GOTO      SDWN9999
.
SDWN9000  MOVE      ONE,PRIMFLAG       * Flag for Primary Funder with Contract
.         MOVE      NZPFHPOR,FFEEAMNT  * Save primary contract fee
SDWN9999  RETURN
+
.******************************************************************************
. ----- Check the Contract Funding file ------
.******************************************************************************
CNTF0000  MOVE      PMVXMHOS,KEY3
.
CNTF1000  MOVE      ZERO,FORM1
          PACK      SKEY21,KEY3,NZSPCLMN,NZSPCNTR,NZSPCPRC,SP70
.
CNTF2000  MOVE      ONE,NZCFSTYP           * default start type
          PACK      KEY30,SKEY21,NZCFSTYP,ADATE,SP70
          CALL      RDNZCFN1
          COMPARE   ZERO,OVRCD
          GOTO      CNTF5000 IF EQUAL
.
CNTF2100  CALL      RPNZCFN1
          BRANCH    OVRCD,CNTF2200
          PACK      KEY21,NZCFHOSP,NZCFCLMC,NZCFCNTR,NZCFCPRC,SP70
.
          MATCH     KEY21,SKEY21
          GOTO      CNTF5000 IF EQUAL        * check the start and enddate
.
CNTF2200  IF        FORM1=3
            MATCH     SP70,KEY3
            IF        !@EQUAL
              MOVE      SP70,KEY3               * try with a blank hosp.code
              GOTO      CNTF1000
            ENDIF
          ENDIF
          BRANCH    FORM1,CNTF2300,CNTF2400,CNTF9000
.
.         Try with blank contract proc code
.
          PACK      SKEY21,KEY3,NZSPCLMN,NZSPCNTR,SP70
          ADD       ONE,FORM1
          GOTO      CNTF2000
.
.         Try with blank Health fund
.
CNTF2300  PACK      SKEY21,KEY3,NZSPCLMN,SP6,NZSPCPRC,SP70
          ADD       ONE,FORM1
          GOTO      CNTF2000
.
.         Try with blank health fund and blank contract proc.code
.
CNTF2400  PACK      SKEY21,KEY3,NZSPCLMN,SP70
          ADD       ONE,FORM1
          GOTO      CNTF2000
.
.         Check the admission date/discharge date
.
CNTF5000  REP       " 0",ADATE
.
.         If patient admitted/discharged before the start date, No Contract
.
          MATCH     NZCFSDAT,ADATE          * Admit./disc.before start date?
          GOTO      CNTF2100 IF LESS        * Yes, invalid
.
          MATCH     SP70,NZCFEDAT
          GOTO      CNTF7000 IF EQUAL       * No end date, so it's valid
.
          MATCH     ADATE,NZCFEDAT           * Check End date
          GOTO      CNTF2100 IF LESS        * Date is after end date, invalid
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          COMPARE   ONE,IBCNMHOS
          GOTO      CNTF8000 IF NOT EQUAL
.
.         Check if this is for a specific Doctor
.
CNTF7000  MATCH     "1",NZCFDOCS
          GOTO      CNTF8000 IF NOT EQUAL   * Not for a specific doctor
.
          PACK      KEY40,NZCFHOSP,NZCFCLMC,NZCFCNTR:
                          NZCFCPRC,NZCFSTYP,NZCFSDAT,NZSPSURG
          CALL      RDMLCFN1
          BRANCH    OVRCD,CNTF2100          * not valid for this hospital
.
CNTF8000  MOVE      ZERO,EXIT
          GOTO      CNTF9999
.
CNTF9000  MOVE      ONE,EXIT
CNTF9999  RETURN
+
.*******************************************************************************
.         SXAC0000 - Display/write accommodation record depends on the
.                    program flag
.*******************************************************************************
SXAC0000  MOVE      LSTRATE,XLSTRATE
          MOVE      LINETOT,XLINETOT
          BRANCH    PROGFLAG OF SXAC8000,SXAC2000,SXAC5000,SXAC4000
.
.         Display accommodation record
.
SXAC2000  
          MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3A,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL:
                              NAUG,NSEP,NOCT,NNOV,NDEC
.
          IF        NODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          MOVE      LINETOT,FORM12P2
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4:
                             " to ";
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;TDAY1,SP1,MTHNAM3A,SP1,KEY4;
.
          COMPARE   ONE,PARTFLAG
          GOTO      SXAC2824 IF NOT EQUAL      * Not partial charges
.
          MOVE      NODAYS,FORM41
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TYEAR1,CYEAR
          MOVE      TCENT1,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     DDATE,KEY8
          IF        @EQUAL
            ADD       "0.5",FORM41
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          IF        PTCNIDES = 1
            WRITE     HTMLFILE;"</td><td>",FORM41,SP1,DAYFORMT,SP1,TDDESC:
                               "<br>",PTDTDES2;
          ELSE
            WRITE     HTMLFILE;"</td><td>",FORM41,SP1,DAYFORMT,SP1,TDDESC;
          ENDIF
          GOTO      SXAC2828
.
SXAC2824  IF        PTCNIDES = 1
            WRITE     HTMLFILE;"</td><td>",NODAYS,SP1,DAYFORMT,SP1,TDDESC:
                               "<br>",PTDTDES2;
          ELSE
            WRITE     HTMLFILE;"</td><td>",NODAYS,SP1,DAYFORMT,SP1,TDDESC;
          ENDIF
.
SXAC2828  WRITE     HTMLFILE;"</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td>&nbsp;":
                             "</td><td align=right>",LSTRATE:
                             "</td><td align=right>",LINETOT:
                             "</td><td align=right>&nbsp;":
                             "</td><td align=right>",FORM12P2;
.
          WRITE     HTMLFILE;"</td></tr>"
          GOTO      SXAC8000
.
.         Set up key for a call to PATCALF
.
SXAC4000  PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
          GOTO      SXAC6000
.
SXAC5000  CALL     PXAC0000               * Print Southern Cross Accommodation
.
.         Set up DTRAN record ready for writing
.
SXAC5200  MOVE      "P" TO TTYPEDEB
          MOVE      ONE,TRECTYPE      (1 = ACCOMMODATION)
          MOVE      ZERO,TCLAIM      *** set up as not yet claimed 3/9/86
          PACK      PTDTCPRC,PRIMMBS,SP70  * set to primary Procedure code
.
          MOVE      LINETOT,TPATAMTT
          MOVE      LSTRATE,TPATAMTI
          MOVE      ZERO,TPATAMTP  
.
          MOVE      STRATEF,TPATAMTH         *** save original rate
          MOVE      STRATEH,TREBATE
          MOVE      ZERO,PTDTLSRB
          MOVE      ZERO,PTDTLSPT
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTL
          MOVE      SP10,PTDTGSTC
          MULT      NODAYS,TREBATE
.
          MOVE      ZERO,TPATAMTG
          MOVE      NODAYS,TNODAYS
.
          MOVE      STWARD,TDWARD          * set up new DTRAN variables
          MOVE      STATYPE,TADMTYP        * when printing invoice
          MOVE      ACLAIM,TCLMTYP
          MOVE      STRBTYP,PTDTBTYP
          MOVE      ZERO,PTDTCCU         * no additional charges
          MOVE      SP70,PTDTBTCH
.
          CALL      WRITETRN
          BRANCH    WRDTFLAG,SXAC9999
.
.         Set up key for a call to PATCALF
.
SXAC6000  MOVE      LINETOT,FINAMT
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      ANSA,FINTYPE
          BRANCH    CACCFEE,SXAC6400:                * ward/bed claim
                            SXAC6600:                * ward/adm. type
                            SXAC6800:               * ward/claim/adm.type
                            SXAC6900:               * ward/adm.type/claim
                            SXAC6920                * claim
          PACK      FINCODE WITH ANSA,STATYPE,SP20
          GOTO      SXAC7000
.
SXAC6400  PACK      FINCODE WITH ANSA,STWARD,ACLAIM,SP20
          GOTO      SXAC7000
.
SXAC6600  PACK      FINCODE,ANSA,STWARD,STATYPE,SP20
          GOTO      SXAC7000
.
SXAC6800  PACK      FINCODE,ANSA,STWARD,ACLAIM,STATYPE,SP20
          GOTO      SXAC7000
.
SXAC6900  PACK      FINCODE,ANSA,STWARD,STATYPE,ACLAIM,SP20
          GOTO      SXAC7000
.
SXAC6920  PACK      FINCODE WITH ANSA,ACLAIM,SP20
.
SXAC7000  MOVE      ZERO,FGSTFLAG
          CALL      WRFN0000                * Write a record to patfinsf
.
SXAC8000  CALL      MTDNFD00                * Move to date to next from date
          BRANCH    WRDTFLAG,SXAC5200       * Write record to nzprdtaf file
.
SXAC9999  RETURN
+
.******************************************************************************
.*                                  PXAC0000                                  *
.*                     Print Southern Cross Accommodation line                *
.******************************************************************************
PXAC0000  MOVE      ZERO,TPAYTYPE
          MOVE      NODAYS,FORM41
          IF        NODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          COMPARE   ONE,PARTFLAG
          GOTO      PXAC1000 IF NOT EQUAL       * Not partial charges
.
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TYEAR1,CYEAR
          MOVE      TCENT1,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     DDATE,KEY8
          IF        @EQUAL
            ADD       "0.5",FORM41
            MOVE      NINE,TPAYTYPE             * flag for half day charge
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
PXAC1000  PACK      KEY25,SP70
          MOVE      LSTRATE,XLSTRATE
          CLEAR     KEY25
          APPEND    "@",KEY25
          APPEND    XLSTRATE,KEY25
          APPEND    " for",KEY25
          APPEND    NODAYS,KEY25
          APPEND    " ",KEY25
          APPEND    DAYFORMT,KEY25
          APPEND    SP1,KEY25
          APPEND    SP70,KEY25
          RESET     KEY25
.
          MOVE      LINETOT,FORM7P2
          MATCH     "1",PTCNPITM                         * print long item desc?
          GOTO      PXAC8000 IF NOT EQUAL
.
          PRINT     *3,TDDESC,*33,KEY25,*115,FORM7P2      * Details
          GOTO      PXAC9000
.
PXAC8000  PRINT     *3,TDDESC,*33,KEY25,*70,FORM7P2
.
PXAC9000  ADD       ONE,COUNT
          ADD       LINETOT,TOTAMNT
.
PXAC9999  RETURN
+
.******************************************************************************
.* GSXM0000 : Get Misc.item for Southern Cross
.******************************************************************************
GSXM0000  MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
          MOVE      ZERO,TOTDISC
          MOVE      ZERO,DOCTTOT
          MOVE      SP70,SAVGCOD
          MOVE      SP70,SAVADOC
.
          MOVE      ZERO,COMPFLG
          MOVE      ZERO,PRITFLG
          MOVE      AADMNO,TADMNO
          MOVE      AADMNO,DTADMNO
.
          CALL      CRTM0000          * Create a tempfile to sort items by proc.
          CALL      WRTM0000          * Write items to tempfile
.
          OPEN      PMSMTIA1,"pmsmtiaf"
.
          UNPACK    SP70,KEY19,KEY25
          BRANCH    PROGFLAG,GSXM0300,GSXM0300
.
          BRANCH    PRPATINV,GSXM0800        * Printing patient invoice
          GOTO      GSXM0400
.
.         Displaying invoice pinvflag=0 for All Invoice
.                            pinvflag=1 for Patient Invoice
.                            pinvflag=2 for Funder Invoice
.
GSXM0300  BRANCH    PINVFLAG,GSXM0800,GSXM0400
          MOVE      SP70,KEY19
          GOTO      GSXM0800
.
GSXM0400  PACK      KEY25,EXPPAYER,SP70
GSXM0800  IF        PINVFLAG=0
            CALL      RSTMMSX1
          ELSE
            CALL      RSTMMSX2
          ENDIF
GSXM1000  IF        PINVFLAG=0
            CALL      RKTMMSX1
          ELSE
            CALL      RKTMMSX2
          ENDIF
          BRANCH    OVRCD,GSXM8200
.
          MOVE      ZERO,LRECFLAG
          PACK      KEY14,AADMNO,PMMITRAN,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,GSXM1000
.
          PACK      KEY11,PMMIVISN,PMMISUNQ,SP70
          CALL      RDNZSPR1
.
          MOVE      PMMITRAN,SAVTRNNO
          CALL      MTDT0000               * Move pmsitm to dtraf fields
          MOVE      ZERO,PTDTEPSD
.
          MOVE      NZSPCPRC,PTDTCPRC      * Set Prcoedure code for Misc.item
.
          COMPARE   TWO,TRECTYPE
          GOTO      GSXM5100 IF EQUAL      * MBS item
          COMPARE   SEVEN,TRECTYPE
          GOTO      GSXM5100 IF EQUAL      * Discount
.
          IF        PROGFLAG=3
            COMPARE   ZERO,PRITFLG
            GOTO      GSXM3000 IF EQUAL      * first record for printing itm
          ELSE
            COMPARE   ZERO,COMPFLG
            GOTO      GSXM3000 IF EQUAL      * first record for displaying itm
          ENDIF
.
.         Misc.Charge are grouped by category FI
.
          MATCH     SP70,PMMIMGRP
          GOTO      GSXM3000 IF EQUAL      * No group code
.
          MATCH     SAVGCOD,PMMIMGRP
          GOTO      GSXM3000 IF EQUAL
.
.         Display/Print total item for the group
.
          MOVE      SP70,TDESC
          CALL      GRFI0000             * Get item group description
          ADD       MISCTOT,TOTAMNT
.
          BRANCH    PROGFLAG,GSXM3000,GSXM1600,GSXM1800,GSXM3000,GSXM1800
          GOTO      GSXM3000
.
GSXM1600  MOVE      MISCTOT,FORM12P2
          ADD       MISCGST,FORM12P2
          CALL      DIGR0000              * Display item group
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
          GOTO      GSXM3000
.
.         Print the Item category description
.
GSXM1800  CALL      PRGR0000              * Print item group
.
.         Processing Misc.item
.----------------------------------------------------------------------------
.
GSXM3000  MOVE      SP70,SAVKEY37
          MOVE      PMMITDAT,MISCDATE
          MOVE      ZERO,OVRCD
.
          MATCH     "3",PMMIITYP
          IF        @EQUAL
            MOVE      "Y",NZMCKPRI     * Set as Keyin Price
            MOVE      ZERO,NZMCINDC
            GOTO      GSXM3100         * Misc.item with no Validation
          ENDIF
.
          MOVE      TITEMNO,KEY9
          MOVE      NZSPCPRC,SAVECPRC    * save Contract Procedure code
.
          MOVE      ACLAIM,D3            * save original claim code
          MOVE      AFUNDH,D6            * save original funder
          IF        MULTCNTR=1
            MOVE      NZSPCLMN,ACLAIM
            MOVE      NZSPCNTR,AFUNDH
          ENDIF
          CALL      NZMS0000             * recalculate NZ misc.
          MOVE      D6,AFUNDH            * restore claim code
          MOVE      D3,ACLAIM            * restore funder
.
          MOVE      SAVECPRC,NZSPCPRC    * restore Contract Procedure code
          BRANCH    OVRCD,GSXM3100
.
          COMPARE   ONE,NZMCCHGT
          GOTO      GSXM3080 IF NOT EQUAL   * not exploding charge
.
.         If it's an exploding item  and the price is zero,
.         we need to recalculate individual items
.
          PACK      SAVKEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                             NZMCEFDT,SP70
          COMPARE   ZERO,NZMCPATP
          GOTO      GSXM3080 IF NOT EQUAL
          CALL      EXPL0000             * Calculate exploding items
          MOVE      "1",PTDTEPSD         * Pack item
.
GSXM3080  MATCH     "Y",NZMCKPRI
          GOTO      GSXM3100 IF EQUAL    * Keyin item
.
          MOVE      NZMCPATP,PMMIAMTP
          MOVE      NZMCREBP,PMMIRBAT
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
GSXM3100  IF        CBFLAG<>1
            MATCH     "3",PMMIRTYP
            GOTO      GSXM3160 IF NOT EQUAL
          ENDIF
.
.         MATCH     "2",PMMIINCT          * Extra to contract
.         GOTO      GSXM3160 IF EQUAL     * no stepdown
.
.         MOVE      SP70,NZSPCPRC
.         BRANCH    CBFLAG,GSXM3160
.
.         Check if this is for primary procedure
.
.         PACK      KEY11,PMMIVISN,PMMISUNQ,SP70
.         CALL      RDNZSPR1
.         BRANCH    OVRCD,GSXM3160
.         MATCH     SP70,NZSPCPRC
.         GOTO      GSXM3160 IF EQUAL     * No contract
.         BRANCH    NZSPPRIM,GSXM3160     * Primary procedure - no stepdown
.
.         CALL      CNTF0000              * Get Contract Funding record
.         BRANCH    EXIT,GSXM3160
.
.         MOVE      ZERO,SPERCENT
.         MATCH     NZSPCNTR,AFUNDH
.         IF        @EQUAL
.           MOVE      NZCFSPRI,SPERCENT   * Same to primary
.         ELSE
.           MOVE      NZCFDPRI,SPERCENT   * Different to primary
.         ENDIF
.
.         IF        SPERCENT<>0
.           MULT      SPERCENT,PMMIAMTT
.           DIV       "100",PMMIAMTT
.           MULT      SPERCENT,PMMIAMTP
.           DIV       "100",PMMIAMTP       * patient portion
.           MOVE      PMMIAMTT,PMMIRBAT
.           SUB       PMMIAMTP,PMMIRBAT    * rebate portion
.         ENDIF
.
GSXM3160  MOVE      PMMIAMTP,TPATAMTP
          MOVE      PMMIRBAT,TREBATE
          MOVE      PMMISERV,TSERVS
.
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MULT      TSERVS,TPATAMTT
          MOVE      TPATAMTT,PMMIAMTT
.
          MATCH     SP70,NZSPCPRC
          GOTO      GSXM3170 IF EQUAL        * No contract proc.- normal charge
          MATCH     "1",NZSPCONT
          GOTO      GSXM3170 IF EQUAL        * There is max contr.-normal chrg.
.
          MATCH     "0",PMMIINCT
          GOTO      GSXM3200 IF NOT EQUAL    * Override Contract rule
.
          CALL      CHKAMT00                 * Check for Contract rule
          GOTO      GSXM3400 
.
.         If this is for FFS Win/Loss and if it's an item for Inc.in Contract
.         and it's a keyin price item, then use amount from PMMIAMTG (Keyin amt)
.
GSXM3170  COMPARE   ONE,CBFLAG
          GOTO      GSXM3400 IF NOT EQUAL
.
.         IF        FINFLAG=1 & ERDTFLAG=1
            MATCH     "0",PMMIINCT
            IF        @EQUAL
.
.             IF        CBFLAG<>1
.               MATCH     "3",PMMIITYP
.               IF        @EQUAL
.                 MOVE      PMMIAMTG,TREBATE
.                 MOVE      ZERO,TPATAMTP
.                 MOVE      TREBATE,TPATAMTT
.                 MULT      TSERVS,TPATAMTT
.                 MOVE      ZERO,TPATAMTG
.               ENDIF
.
.             ENDIF
              MATCH     "Y",NZMCKPRI
              IF        @EQUAL
                MOVE      PMMIAMTG,TREBATE
                MOVE      ZERO,TPATAMTP
                MOVE      TREBATE,TPATAMTT
                MULT      TSERVS,TPATAMTT
                MOVE      ZERO,TPATAMTG
              ENDIF
            ENDIF
.         ENDIF
.
          GOTO      GSXM3400               * FFS Win/Loss - normal charge
.
.  PMMIINCT: 0=Use Contract Rule 1=Bill to Patient 2=Extra to Contract
.
GSXM3200  MATCH     "1",PMMIINCT             * bill to patient
          IF        @EQUAL
            MOVE      ZERO,TREBATE           * zero rebate
            MOVE      TPATAMTP,TPATAMTT
          ENDIF
.
          MATCH     "2",PMMIINCT             * extra to contract
          IF        @EQUAL
            MATCH     "3",PMMIITYP           * check No Validation item code
            IF        !@EQUAL
              MATCH     "Y",NZMCKPRI
              IF        !@EQUAL
                MOVE      TPATAMTP,TREBATE
              ENDIF
              MOVE      ZERO,TPATAMTP
              MOVE      TREBATE,TPATAMTT
            ENDIF
          ELSE
.
.         If this is not extra to contract and
.         there is a max.contr. misc.item charge goes to patient invoice
.
            MATCH     "1",NZSPCONT
            IF        @EQUAL
              MOVE      ZERO,TREBATE           * zero rebate
              MOVE      TPATAMTP,TPATAMTT
            ENDIF
          ENDIF
.
GSXM3400  MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MULT      TSERVS,TPATAMTT
.
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
.
          IF        PROGFLAG=3
            PACK      PMMIDUPD,CCC,CYY,CMM,CDD
            REP       " 0",PMMIDUPD
            CALL      IBACLOCK
            MOVE      CTIMEIS,PMMITUPD
            MOVE      WBSEUID,PMMIWUSR
            CALL      UPPMMTI1        * update new item amount
          ENDIF
.
GSXM5100  IF        TRECTYPE=7
            MOVE      TPATAMTT,LINETOT       * discount - no GST
            MOVE      ZERO,LINEGST
            MOVE      TPATAMTT,TPATAMTP
            GOTO      GSXM5300
          ENDIF
          MOVE      TPATAMTT,LINETOT
.
.         Save group and record type for Misc.record
.
          IF        TRECTYPE=3 
            MOVE      PMMIMGRP,SAVGCOD
            IF        PROGFLAG<>3
              MOVE      ONE,COMPFLG
            ENDIF
          ENDIF
.
          COMPARE   TWO,TRECTYPE
          GOTO      GSXM5220 IF EQUAL           * MBS includes to gross total
          ADD       LINETOT,MISCTOT
.
.         LRECFLAG=1 - Charge Misc.charge on invoice, NOT include in Win/Loss
.         LRECFLAG=2 - No Misc.charge on invoice, but include in Win/Loss
.
GSXM5220  IF        PROGFLAG=1 & TRECTYPE=3 & CBFLAG=1
            IF        LRECFLAG=1
              MOVE      TWO,TCLAIM      * Not included in Win/Loss calculation
            ELSE
              IF        LRECFLAG=2
                ADD       NLWAMT,GROSSTOT     * Add the original amt to Win/Loss
                MOVE      "4",KEY1            * Misc.item
                PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
                MOVE      NLWAMT,FORM12X2
                CALL      WRWL0000               * Write to Win/Loss tempfile
              ENDIF
            ENDIF
            GOTO      GSXM5300
          ENDIF
          ADD       LINETOT,GROSSTOT
.
.----------------------------------------------------------------------------
GSXM5300  BRANCH    PROGFLAG,GSXM5800,GSXM6000,GSXM7000,GSXM8000,GSXM7000
          GOTO      GSXM1000
.
GSXM5800  IF        FINFLAG=1 & ERDTFLAG=1
            CALL      NXTTRAN1      * Get the next transaction number
            PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
            CALL      RANZRDT1
            IF        OVRCD=0
              GOTO      GSXM5800
            ENDIF
            IF        LRECFLAG=2
              MOVE      NLWAMT,TPATAMTT     * Restore amt for nzprdtaf
              MOVE      NLWAMT,TPATAMTP
              IF        TSERVS<>1
                DIV       TSERVS,TPATAMTP
              ENDIF
              MOVE      ZERO,TREBATE
            ENDIF
            CALL      WRNZRDT1           * Write to nzprdtaf
          ENDIF
          MOVE      ZERO,TCLAIM
.
          GOTO      GSXM1000
.
.         Display miscellaneous item
.
GSXM6000  CALL      DSIT0000                * Display item
          GOTO      GSXM1000
.
.        Print miscellaneous item
.
GSXM7000 CALL      PRIT0000                * Print item
.
.        Update the Fees Invoiced Summary file
.
GSXM8000 MOVE      ZERO,LINEGST
         MOVE      LINETOT,FINAMT
         MOVE      ZERO,FGSTFLAG
         CALL      WNZF0000             * write to patfinsf
.
         GOTO      GSXM1000
.
.----------------------------------------------------------------------------
GSXM8200 IF        PROGFLAG=3
           COMPARE   ZERO,PRITFLG
           GOTO      GSXM8600 IF EQUAL
         ELSE
           COMPARE   ZERO,COMPFLG
           GOTO      GSXM8600 IF EQUAL
         ENDIF
.
         MOVE      SP70,TDESC
         CALL      GRFI0000             * Get item group description
         ADD       MISCTOT,TOTAMNT
.
         BRANCH    PROGFLAG,GSXM9000,GSXM8300,GSXM8500,GSXM9000,GSXM8500
.
GSXM8300 MOVE      MISCTOT,FORM12P2
         ADD       MISCGST,FORM12P2
         CALL      DIGR0000              * Display item group
         GOTO      GSXM9000
.
GSXM8500 CALL      PRGR0000              * Print item group
.
GSXM8600 COMPARE   FIVE,PROGFLAG
         GOTO      GSXM8700 IF EQUAL     * print invoice
         COMPARE   THREE,PROGFLAG
         GOTO      GSXM9000 IF NOT EQUAL
.
GSXM8700 CALL      PTTL0000              * Print total charges
         GOTO      GSXM9900
.
.        End of this invoice's details
.
GSXM9000 MOVE      GROSSTOT,NETTOT
.
GSXM9900 CALL      SXED0000
GSXM9999 RETURN
+
.******************************************************************************
.         Display Item group
.******************************************************************************
DIGR0000  IF        INVTYPE=1
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>",TDESC,"</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>",MISCTOT,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",FORM12P2,"</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td><b>",TDESC,"</b></td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>",FORM12P2,"</td>":
                               "</tr>"
          ENDIF
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
DIGR9999  RETURN
+
.******************************************************************************
.         Print item group
.******************************************************************************
PRGR0000  COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
          MOVE      SP70,TDESC
          CALL      GRFI0000             * Get item group description
          MOVE      MISCTOT,FORM7P2
.
          COMPARE   ZERO,FORM7P2
          GOTO      PRGR2000 IF NOT EQUAL
.
          BRANCH    INVTYPE,PRGR8000       * Summary invoice
.
PRGR2000  MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PRGR4000 IF EQUAL
          MATCH     "1",PTCNPPRC              * print procedure code?
          GOTO      PRGR6000 IF NOT EQUAL
.
          PRINT     *34,TDESC,*70,FORM7P2
          GOTO      PRGR7000
.
PRGR4000  PRINT     *34,TDESC,*115,FORM7P2
          GOTO      PRGR7000
.
PRGR6000  PRINT     *30,TDESC,*70,FORM7P2
PRGR7000  ADD       ONE,COUNT
.
PRGR8000  MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
PRGR9999  RETURN
+
.******************************************************************************
.         Get Item group description
.******************************************************************************
GRFI0000  MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSI,SAVGCOD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
GRFI9999  RETURN
+
.******************************************************************************
.         Display item
.******************************************************************************
DSIT0000  MATCH     "7",PMMIRTYP
          GOTO      DSPI9999 IF EQUAL       * display discount later
.
          IF        TRECTYPE=3 
            BRANCH    INVTYPE,DSPI9999      * Print items by group
          ENDIF
.
          PACK      DIM30,TDDESC,SP70
          PACK      DIM35,PTDTDES2,SP70
          MOVE      TFMONTH,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                       NSEP,NOCT,NNOV,NDEC
          MOVE      LINETOT,FORM12P2
          PACK      KEY4,TFCENT,TFYEAR
          REP       " 0",KEY4
.
          MOVE      "0",KEY1              * Set 'No' to Change item desc.
          IF        TRECTYPE=3
            COMPARE   ONE,NZMCINDC
            IF        @EQUAL
              MOVE      "1",KEY1          * Set 'Yes' to Change item desc.
            ENDIF
          ENDIF
          MOVE      "0",ANS               * Set 'No' to Change item amount
          IF        TRECTYPE=3
            MATCH     "Y",NZMCKPRI
            IF        @EQUAL
              MOVE      "1",ANS           * Set 'Yes' to Change item amount
            ENDIF
          ENDIF
.
          MOVE      "Incl   ",KEY7
          MATCH     "1",PMMIINCT
          IF        @EQUAL
            MOVE      "Patient",KEY7
          ENDIF
          MATCH     "2",PMMIINCT
          IF        @EQUAL
            MOVE      "Extra  ",KEY7
          ENDIF
.
          MOVE      SP70,NZSPCPRC
          PACK      KEY11,AADMNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
.
          WRITE     HTMLFILE;"<tr><td>",TFDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                            "<td>",DIM30,DIM35,"</td>":
                            "<td>&nbsp;",NZSPPROC,"</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;",KEY7,"</td>":
                            "<td>&nbsp;",NZSPCNTR,"</td>":
                            "<td><img src=../images/EditIcon.gif ":
                            " class=ListIcon onclick='DeleteItem(#"":
                               AURNO,"#",#"":
                               AADMNO,"#",#"":
                               PMMITRAN,"#",#"":
                               KEY1,"#",#"":
                               ANS,"#",#"",PMMIRTYP,"#")'>":
                               TITEMNO,"</td>";
.
          WRITE     HTMLFILE;"<td align=center>",PMMISERV,"</td>";
          IF        PMMISERV<>0
            MOVE      PMMIAMTP,FORM12D2
            ADD       PMMIRBAT,FORM12D2
            WRITE     HTMLFILE;"<td align=right>",FORM12D2,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",LINETOT,"</td>":
                            "<td align=right>&nbsp;</td>";
.
          IF        TRECTYPE=3 
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
          ENDIF
.
DSIT9000  WRITE     HTMLFILE;"</tr>"
DSIT9999  RETURN
+
.******************************************************************************
.         Print Item
.******************************************************************************
PRIT0000  COMPARE   ZERO,LINETOT
          GOTO      PRIT0200 IF NOT EQUAL
.
.         If item amount is zero and it's 'Include in the Contract' then don't
.         print
.
          MATCH     "0",PMMIINCT
          GOTO      PRIT0200 IF NOT EQUAL   * Not 'Include in Contract' item
.
          BRANCH    INVTYPE,PRIT4000        * Summary
.
PRIT0200  IF        TRECTYPE=3
            MOVE      ONE,PRITFLG
            BRANCH    INVTYPE,PRIT4000      * Print items by group
          ENDIF
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      PRIT4000 IF EQUAL       * Print discount later
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      LINETOT,FORM7P2
.
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          MOVE      TFMONTH,CMON
          MOVE      TFDAY,CDAY
          CALL      PACDATE
          MOVE      TDDESC,KEY20
.
          MOVE      SP70,NZSPCPRC
          PACK      KEY11,AADMNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PRIT1000 IF EQUAL
          MATCH     "1",PTCNPPRC              * print procedure code?
          GOTO      PRIT2000 IF NOT EQUAL
.
          PRINT     *3,CPCDATE,*14,NZSPPROC,*24,TITEMNO:
                    *34,KEY20,*54,TSERVS,*60,FORM7P2
          GOTO      PRIT3000
.
PRIT1000  PRINT     *3,CPCDATE;
          MATCH     "1",PTCNPPRC            * print procedure code?
          IF        @EQUAL
            PRINT     *14,NZSPPROC;
          ENDIF
          PRINT     *24,TITEMNO:
                    *34,TDDESC,*64,PTDTDES2,*100,TSERVS,*105,FORM7P2
          GOTO      PRIT3000
.
PRIT2000
.         PRINT     *3,ESCCHR,CHARG,TITEMNO,ESCCHR,CHARH:
          PRINT     *3,CPCDATE,*18,TITEMNO;
          PRINT    *30,KEY20,*52,TSERVS,*60,FORM7P2
.
PRIT3000  ADD       ONE,COUNT
          MOVE      ONE,PRITFLG
.
.         Print contents of pack item if we are printing detailed invoice
.
          IF        INVTYPE=2 & TRECTYPE=3
            MATCH     SP70,SAVKEY37
            IF        !@EQUAL
              CALL      PPAC0000                * print contents of Pack item
            ENDIF
          ENDIF
.
PRIT4000  COMPARE   FIVE,PROGFLAG
          GOTO      PRIT9999 IF EQUAL   * Print only
.
          PACK      DIM23 WITH TADMNO,TREF,TRECTYPE,TTRANSN1,SP70
.                                             * Save the key of this rec
.
.         Add the invoice number and invoice date to the DTRAN record
.
          MOVE      CNEXTINV TO TREF
          MOVE      ONE,TINVPRT
          PACK      PTDTEFFD,PINVDTE    * Effective date to fees invoiced
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTL
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MATCH     "3",PMMIITYP
          IF        @EQUAL
            MOVE      "3  ",PTDTPCOD      * Not validating Misc.item
          ENDIF
.
PRIT6000  CALL      NXTTRAN1      * Get the next transaction number
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RDADTRN1
          COMPARE   ZERO,OVRCD
          GOTO      PRIT6000 IF EQUAL    * Try the next transaction number
          CALL      WRDTRN1              * Write Misc.Charge
.
          PACK      KEY24,TADMNO,PMMICNTR,PMMIRTYP,PMMIMGRP,SAVTRNNO,SP70
          PACK      KEY14,TADMNO,SAVTRNNO
          CALL      DEPMMTI1             * remove item pending record
.
PRIT9999  RETURN
+
.******************************************************************************
.* PPAC0000 : Print Content of Pack item
.******************************************************************************
PPAC0000  OPEN      NZPMXCA1,"nzpmxcaf"
          PACK      KEY40,SAVKEY37,SP70
          CALL      RSNZMXC1
PPAC1000  CALL      RKNZMXC1
          BRANCH    OVRCD,PPAC9999
.
          PACK      KEY37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                          NZMXEFDT,SP70
          MATCH     SAVKEY37,KEY37
          GOTO      PPAC9999 IF NOT EQUAL
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      NZMXITMN,KEY9
          CALL      NZMS0000             * recalculate NZ misc.
          BRANCH    OVRCD,PPAC1000
.
          PACK      KEY20,NZMCDESC
          MOVE      ZERO,FORM3
          MOVE      NZMXQNTY,FORM3
.         IF        PMMISERV<>0
            MULT      PMMISERV,FORM3
.         ENDIF
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PPAC6000 IF EQUAL
          MATCH     "1",PTCNPPRC              * print procedure code?
          GOTO      PPAC7000 IF NOT EQUAL
.
          PRINT     *3,"     Incl.";
.         PRINT     *14,NZSPPROC;
          PRINT     *24,NZMXITMN:
                    *34,KEY20,*56,FORM3
          GOTO      PPAC8000
.
PPAC6000  PRINT     *3,"     Incl.";
.         MATCH     "1",PTCNPPRC            * print procedure code?
.         IF        @EQUAL
.           PRINT     *14,NZSPPROC;
.         ENDIF
          UNPACK    NZMCDESC,KEY30,KEY35
          PRINT     *24,NZMXITMN:
                    *34,KEY30,*64,KEY35,*102,FORM3
          GOTO      PPAC8000
.
PPAC7000  PRINT     *3,"     Incl.",*18,NZMXITMN:
                    *30,KEY20,*54,FORM3
.
PPAC8000  ADD       ONE,COUNT
          GOTO      PPAC1000
.
PPAC9999  RETURN
+
.******************************************************************************
.* SXED0000 : Print End of Southern Cross invoice
.******************************************************************************
SXED0000 MOVE      FDAY,CDAY
         MOVE      FMON,CMON
         MOVE      FCENT,CCENT
         MOVE      FYEAR,CYEAR
         CALL      PACDATE
.
         BRANCH    PROGFLAG,SXED1100
         MOVE      GROSSTOT,FORM12P2
         MOVE      GROSSTOT,GSTAMNT
         MULT      GSTPCEN,GSTAMNT     * GST amount
         DIV       "100.00",GSTAMNT    * Divide by 100 to get wanted fig.
.
         BRANCH    PROGFLAG OF SXED1100,SXED1000,SXED4000,SXED9999
         GOTO      SXED9999
.
SXED1000 MOVE      GROSSTOT,FORM12P2
         WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                "<td><b>Total Charges</b></td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td align=right><b>",GROSSTOT,"</b></td>":
                                "<td align=right>&nbsp;</b></td>":
                                "<td align=right><b>",FORM12P2,"</b></td>":
                                "</tr>"
.
SXED1100 CALL      DSDSC000              * Display discount if any
         COMPARE   TWO,PROGFLAG
         GOTO      SXED1150 IF NOT EQUAL    * not displaying invoice
.
         ADD       GSTAMNT,FORM12P2
         ADD       GSTAMNT,NETTOT
         WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "<td>&nbsp;</td>":
                                  "</tr>":
                                "<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                                "<td><b>Invoice Total</b></td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td align=right><b>",GROSSTOT,"</b></td>":
                                "<td align=right><b>",GSTAMNT,"</b></td>":
                                "<td align=right><b>",FORM12P2,"</b></td>":
                                "</tr>"
         ADD       GSTAMNT,GROSSTOT
.
SXED1150 BRANCH    PROGFLAG OF SXED9999,SXED1200
         GOTO      SXED9999
.
.        If there is no cash to be invoiced, don't display cash.
.        Only All or Patient invoice will show cash
.
SXED1200 COMPARE   TWO,PINVFLAG
         GOTO      SXED2000 IF EQUAL    * Funder invoice
.
         COMPARE   ZERO,CASHFLAG
         GOTO      SXED1800 IF NOT EQUAL
         COMPARE   ZERO,NBNKAMNT
         GOTO      SXED2000 IF EQUAL
.
.        Display cash total
.
SXED1800 ADD       NBNKAMNT,CSAMT
         SUB       CSAMT FROM NETTOT
         CALL      DCSH0000           * Display Cash/Non-banked Deposit
.
.        Display balance payable
.
SXED2000 MOVE      NETTOT,FORM12P2
         CALL      SRND0000                 * Work out the rounding adjustment
         WRITE      HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                               "<td><b>Balance Payable</b></td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right><b>",FORM12P2,"</b></td></tr>"
         GOTO      SXED9999
.
SXED4000 MOVE      GROSSTOT,NETTOT
         ADD       GSTAMNT,NETTOT
         MOVE      NETTOT,INVCTOTL            * for tail template
.
.        Cash Deposit goes to Patient invoice only
.
         IF        PRPATINV=1
           SUB       CASHTOT,NETTOT
         ENDIF
.
         MOVE      NETTOT,FORM7P2
.
.        Check if the invoice total need to be rounded
.
         MATCH     SP70,PTCNRDWN
         GOTO      SXED8000 IF EQUAL        * Not set
.
         MOVE      NETTOT,FORM12P2
         CALL      SRND0000                 * Work out the rounding adjustment
         COMPARE   FORM12P2,NETTOT
         GOTO      SXED8000 IF EQUAL
         MOVE      FORM12P2,FORM7P2
.
         SUB       NETTOT,FORM12P2
         CALL      WRID0000                 * Write rounding adj.to dtr file
         MOVE      FORM12P2,ROUNDAMT
         ADD       FORM12P2,GROSSTOT
.
         COMPARE   FIVE,PROGFLAG
         GOTO      SXED8000 IF EQUAL        * Print only
.
         UNPACK    SP70,FININVN,FINADMN,FINURNO
         IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
         ENDIF
.
         MOVE      FORM12P2,FINAMT
         MULT      "-1",FINAMT              * Rounding adjustment
.
         MOVE      "A",FINTYPE
         MOVE      "M",ANS
         IF        PTCNMFEE = 1
           PACK      FINCODE WITH ANS,ACLAIM,PTCNROUN,SP70
         ELSE
           PACK      FINCODE WITH ANS,PTCNROUN,SP70
         ENDIF
.
         MOVE      ZERO,FGSTFLAG
         PACK      FINDATE,CCC,CYY,CMM,CDD
         REP       " 0",FINDATE
         MOVE      THREE,FINSYS
         MOVE      SP6,FINSITE
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
.
         BRANCH    PROGFLAG,SXED9999,SXED9999,SXED8000,SXED9999
.
SXED8000 MOVE      MAXLINE,FORM2
         SUB       "2",FORM2
         COMPARE   FORM2,COUNT               * Check For A Full Page
         CALL      TAIL IF NOT LESS
.
         MATCH     "1",PTCNPITM              * print long item desc?
         GOTO      SXED8200 IF NOT EQUAL
.
         PRINT     *115,"----------":
                   *N,*3,"BALANCE PAYABLE",*115,FORM7P2:
                   *N,*115,"=========="
         GOTO      SXED9000
.
SXED8200 PRINT     *70,"----------":
                   *N,*3,"BALANCE PAYABLE",*70,FORM7P2:
                   *N,*70,"=========="
.
SXED9000 ADD       THREE,COUNT
.
         WHILE     COUNT<MAXLINE
           PRINT     *N;
           ADD       ONE,COUNT
         DO
         CALL      SINVT000                 * set up tail stationery code
         MOVE      ZERO,MPGEFLAG
         ADD       ONE,CPAGENO
         MOVE      FORM7P2,NETTOT           * nettot for inv.balance on inv.tail
         MOVE      ZERO,FORM62              * receipt amount
         IF        PRPATINV=1
           MOVE      CASHTOT,FORM62
         ENDIF
         CALL      PRTINVTL                 * print templated invoice tail
         PRINT     *N;
SXED9999 RETURN
.
.******************************************************************************
.         Print total charges
.******************************************************************************
PTTL0000  COMPARE   THREE,PROGFLAG
          GOTO      PTTL1000 IF NOT EQUAL
.
          MOVE      MAXLINE,FORM2
          SUB       TWO,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      GROSSTOT,FORM7P2
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PTTL0800 IF NOT EQUAL
.
          PRINT     *N,*115,"----------":
                    *N,*3,"Total Charges",*115,FORM7P2
          ADD       THREE,COUNT
          GOTO      PTTL1000
.
PTTL0800  PRINT     *N,*70,"----------":
                    *N,*3,"Total Charges",*70,FORM7P2
          ADD       THREE,COUNT
.
PTTL1000  CALL      IVGST000            * Calculate GST amount
          COMPARE   ZERO,GSTAMNT
          GOTO      PTTL2000 IF EQUAL
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          MOVE      GSTAMNT,FORM7P2
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          OPEN      IBAGSTA1,"ibagstaf"
          PACK      KEY6,PTCNAGST,SP70
          CALL      RDIBGS1
          IF        OVRCD=1
            MOVE      "GST                     ",IBGSDESC
          ENDIF
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PTTL1200 IF NOT EQUAL
.
          PRINT     *3,"Add ",IBGSDESC,*115,FORM7P2:
                    *N,*115,"----------"
          GOTO      PTTL1400
.
PTTL1200  PRINT     *3,"Add ",IBGSDESC,*70,FORM7P2:
                    *N,*70,"----------"
PTTL1400  ADD       TWO,COUNT
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      GROSSTOT,FORM12P2
          ADD       GSTAMNT,FORM12P2
          MOVE      FORM12P2,FORM7P2
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PTTL1800 IF NOT EQUAL
.
          PRINT     *3,"TOTAL CHARGE (INCLUSIVE OF GST)",*115,FORM7P2:
                    *N
          ADD       TWO,COUNT
          GOTO      PTTL2000
.
PTTL1800  PRINT     *3,"TOTAL CHARGE (INCLUSIVE OF GST)",*70,FORM7P2:
                    *N
          ADD       TWO,COUNT
.
PTTL2000  MOVE      GROSSTOT,NETTOT
          ADD       GSTAMNT,NETTOT
.
.         Only Patient Invoice will print Cash
.
          COMPARE   ZERO,PRPATINV
          GOTO      PTTL9999 IF EQUAL      * Printing funder invoice
.
          MOVE      CSAMT,CASHTOT
          ADD       NBNKAMNT,CASHTOT
.
          COMPARE   ZERO,CASHTOT
          GOTO      PTTL9999 IF EQUAL
.
          CALL      XCDE0000               * Print Cash/Non-banked Dep. details
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      CASHTOT,FORM7P2
          MULT      "-1",FORM7P2
.
          MATCH     "1",PTCNPITM              * print long item desc?
          GOTO      PTTL3000 IF NOT EQUAL
.
          PRINT     *115,"----------":
                    *N,*3,"Total Payments",*115,FORM7P2
          ADD       TWO,COUNT
          GOTO      PTTL9999
.
PTTL3000  PRINT     *70,"----------":
                    *N,*3,"Total Payments",*70,FORM7P2
          ADD       TWO,COUNT
.
PTTL9999  RETURN
+
.******************************************************************************
.         Subroutine to get the appropriate NZ miscellaneous charges record
.******************************************************************************
NZMS0000  OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPSPRA1,"nzpspraf"
.
.         Check if this item belongs to a procedure.
.
          MOVE      SP70,NZSPCPRC
          MOVE      ZERO,F1
          MOVE      PMVXMHOS,KEY3
.
NZMS1000  PACK      KEY29 WITH KEY3,ACLAIM,AFUNDH,SP8,KEY9,SP70
          MOVE      ACLAIM,NZSPCLMN
          MOVE      SP70,NZSPCPRC
.
          BRANCH    CBFLAG,NZMS2000
.
          PACK      KEY11,PMMIVISN,PMMISUNQ,SP70
          CALL      RDNZSPR1
          IF        OVRCD=0
            PACK      KEY29 WITH KEY3,NZSPCLMN,NZSPCNTR,SP8,KEY9,SP70
          ELSE
            MOVE      SP70,NZSPCPRC
          ENDIF
.
NZMS2000  CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      NZMS9999 IF EQUAL
.
.         No record with health fund details - try a blank health fund
.
          PACK      KEY29 WITH KEY3,NZSPCLMN,SP6,SP8,KEY9,SP70
          CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      NZMS9999 IF EQUAL
.
.         No record with health fund details - last chance, try default claim
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000        * Check Hospital claim code charging
          MOVE      PTCNDCLM,NZMCCLMC
          IF        F1=1
            MOVE      SP70,KEY3
          ENDIF
          PACK      KEY29 WITH KEY3,NZMCCLMC,SP6,SP8,KEY9,SP70
          CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      NZMS9999 IF EQUAL
.
.         Try with blank hospital code
.
          BRANCH    F1,NZMS9999
          ADD       ONE,F1
          MOVE      SP70,KEY3 
          GOTO      NZMS1000
.
NZMS9999  RETURN
+
.------------------------------------------------------------------------
.                   NZGMC000
.        Subroutine to get NZ miscellaneous charge
.------------------------------------------------------------------------
NZGMC000  MATCH     SP8,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD
          ENDIF
          REP       " 0",MISCDATE
.
          PACK      KEY37,KEY29,MISCDATE,SP70
.
          CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      NZGMC900 IF NOT EQUAL       * No
          ENDIF
.
NZGMC010  CALL      RPNZMCH1
          BRANCH    OVRCD,NZGMC990
.
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG,SP70
          MATCH     KEY29,KEY29A
          GOTO      NZGMC990 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      NZGMC010 IF EQUAL           * Yes
.
          MATCH     NZMCEFDT,MISCDATE       * effective date => serv. date ?
          GOTO      NZGMC990 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     MISCDATE,NZMCEEDT
            GOTO      NZGMC990 IF LESS
          ENDIF
.
NZGMC900  MOVE      ZERO,OVRCD
          GOTO      NZGMC999
.
NZGMC990  MOVE      ONE,OVRCD
          MOVE      ZERO,NZMCPATP
          MOVE      ZERO,NZMCREBP
NZGMC999  RETURN
+
.------------------------------------------------------------
.         Get the last effective date
.------------------------------------------------------------
EFFD0000  MOVE      SP70,EFTDATE
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     SP70,DDATE
          IF        !@EQUAL
            PACK      KEY8,DDATE,SP70
          ENDIF
.
          PACK      KEY34,KEY26,KEY8,SP70
          PACK      KEY37,KEY34,SP70
          CALL      RSNZBFE1
          CALL      RKNZBFE1
          BRANCH    OVRCD,EFFD2000
          PACK      DIM34A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,NZBFEFDT,SP70
          MATCH     DIM34A,KEY34
          GOTO      EFFD4000 IF EQUAL
.
EFFD2000  CALL      RPNZBFE1                  * check for previous record
          BRANCH    OVRCD,EFFD9999
.
          PACK      DIM26A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,SP70
          MATCH     DIM26A,KEY26
          GOTO      EFFD9999 IF NOT EQUAL
.
EFFD4000  MOVE      NZBFEFDT,EFTDATE         * Save the effective date
EFFD9999  RETURN
+
.******************************************************************************
.         Get all exploding items
.******************************************************************************
EXPL0000  MOVE      ZERO,FORM12P2
          OPEN      NZPMXCA1,"nzpmxcaf"
.
          PACK      KEY40,SAVKEY37,SP70
          CALL      RSNZMXC1
EXPL1000  CALL      RKNZMXC1
          BRANCH    OVRCD,EXPL8000
.
          PACK      KEY37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                          NZMXEFDT,SP70
          MATCH     KEY37,SAVKEY37
          GOTO      EXPL8000 IF NOT EQUAL
.
          MOVE      NZSPCPRC,SAVECPRC    * save Contract Procedure code
          MOVE      NZMXITMN,KEY9
          CALL      NZMS0000
          MOVE      SAVECPRC,NZSPCPRC    * restore Contract Procedure code
          BRANCH    OVRCD,EXPL1000
.
          MOVE      ZERO,FORM3
          MOVE      NZMXQNTY,FORM3
.         IF        FORM3<>0
            MULT      FORM3,NZMCPATP
.         ENDIF
	  ADD       NZMCPATP,FORM12P2
          GOTO      EXPL1000
.
EXPL8000  MOVE      FORM12P2,NZMCPATP
          MOVE      ZERO,NZMCREBP
EXPL9999  RETURN
+
.------------------------------------------------------------------------------
.* Check for included/excluded miscellaneous items if NZ Private billing
.------------------------------------------------------------------------------
CHKAMT00  MOVE      ZERO,EXIT
          MOVE      ZERO,F1
          MOVE      ZERO,FORM3
          MOVE      ZERO,FORM1
          MOVE      ZERO,LRECFLAG
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPMCHA2,"nzpmchaf"
          PACK      KEY26,NZSPCPRC,NZSPCLMN,NZSPCNTR,ANSE,ONE,SP70
          CALL      RSNZCMT2
CHKAMT10  CALL      RKNZCMT2
          BRANCH    OVRCD,CHKAMT50
.
          MATCH     NZSPCPRC,NZCMCPRC
          GOTO      CHKAMT50 IF NOT EQUAL
.
          MATCH     NZSPCLMN,NZCMCLMC
          GOTO      CHKAMT50 IF NOT EQUAL
.
          BRANCH    F1,CHKAMT12
          MATCH     NZSPCNTR,NZCMCNTR
          GOTO      CHKAMT50 IF NOT EQUAL
.
CHKAMT12  MATCH     ANSE,NZCMRTYP
          GOTO      CHKAMT50 IF NOT EQUAL
.
          MATCH     "1",NZCMITYP
          GOTO      CHKAMT50 IF NOT EQUAL   * Not a misc.item record
.
          COMPARE   ZERO,NZCMCCNT           * header record?
          GOTO      CHKAMT15 IF NOT EQUAL
.
          MOVE      ONE,FORM3               * Found a header record
          MOVE      NZCMFTYP,FORM1
          GOTO      CHKAMT10
.
CHKAMT15  COMPARE   ZERO,NZCMFTYP
          GOTO      CHKAMT45 IF NOT EQUAL
.
.         Item not to be charged on invoice, but included in Win/Loss
.
          MATCH     SP70,NZCMPROC
          IF        !@EQUAL
            MATCH     TITEMNO,NZCMPROC     * excluded from contract
            GOTO      CHKAMT17 IF EQUAL    * item Not to be charged
          ELSE
            MATCH     TMISGRP,NZCMMIGP     * group excluded from contract
            GOTO      CHKAMT17 IF EQUAL    * item Not to be charged
          ENDIF
          GOTO      CHKAMT10
.
CHKAMT17  MOVE      TWO,LRECFLAG           * to be included in Win/Loss
          MOVE      TPATAMTT,NLWAMT        * Save the orginal amnt for Win/Loss
.
          MATCH     "3",PMMIITYP
          IF        @EQUAL
            MOVE      TPATAMTG,NLWAMT
            MULT      TSERVS,NLWAMT
          ENDIF
          MATCH     "Y",NZMCKPRI
          IF        @EQUAL
            MOVE      TPATAMTG,NLWAMT
            MULT      TSERVS,NLWAMT
          ENDIF
          GOTO      CHKAMT80
.
.         Item to be charged, but not included in Win/Loss
.
CHKAMT45  MATCH     SP70,NZCMPROC
          IF        !@EQUAL
            MATCH     TITEMNO,NZCMPROC     * included in contract
            GOTO      CHKAMT47 IF EQUAL    * item to be charged
          ELSE
            MATCH     TMISGRP,NZCMMIGP     * group included in contract
            GOTO      CHKAMT47 IF EQUAL    * item to be charged
          ENDIF
          GOTO      CHKAMT10
.
CHKAMT47  MOVE      ONE,LRECFLAG           * not to be included in Win/Loss
          GOTO      CHKAMT92
.
.         Check if a header record is found
.
CHKAMT50  COMPARE   ONE,FORM3
          GOTO      CHKAMT60 IF NOT EQUAL
.
.   If a header record is found (with no other record) and 
.             if FORM1 (Field type) =0 - Charge Item
.             if FORM1 (Field type) =1 - No Charge
.
          IF        FORM1=1
            MOVE      TWO,LRECFLAG   * No charge on invoice, but inc.in Win/Loss
            MOVE      TPATAMTT,NLWAMT * Save the orginal amount for Win/Loss
.
            MATCH     "3",PMMIITYP
            IF        @EQUAL
              MOVE      TPATAMTG,NLWAMT
              MULT      TSERVS,NLWAMT
            ENDIF
            MATCH     "Y",NZMCKPRI
            IF        @EQUAL
              MOVE      TPATAMTG,NLWAMT
              MULT      TSERVS,NLWAMT
            ENDIF
            GOTO      CHKAMT80
          ENDIF
          MOVE      ONE,LRECFLAG     * not tobe included in Win/Loss
          GOTO      CHKAMT99
.
.         Try with default
.
CHKAMT60  MOVE      ZERO,FORM3
          ADD       ONE,F1
          BRANCH    F1,CHKAMT70            * try with blank contract
          GOTO      CHKAMT90
.
.         Blank Contract
.
CHKAMT70  PACK      KEY26,NZSPCPRC,NZSPCLMN,SP6,ANSE,ONE,SP70
          CALL      RSNZCMT2
          GOTO      CHKAMT10
.
CHKAMT80  MOVE      ONE,EXIT               * item included in contract
CHKAMT90  MOVE      ZERO,TPATAMTT
          MOVE      ZERO,TPATAMTP
          MOVE      ZERO,TREBATE
          GOTO      CHKAMT99
.
CHKAMT92  MATCH     "3",PMMIITYP
          GOTO      CHKAMT99 IF EQUAL      * No validation
.
          MATCH     "Y",NZMCKPRI
          GOTO      CHKAMT99 IF EQUAL
.
          MOVE      NZMCPATP,TPATAMTP
          MOVE      ZERO,TREBATE
CHKAMT99  RETURN
+
.******************************************************************************
.*  Set flag for charging FFS                                                 *
.*  Check if there is a procedure with no contract
.******************************************************************************
CHRFFS00  MOVE      "1",F1                  * Default to No FFS charge
          MOVE      ZERO,F2
          MATCH     "Y",PTMICMXP
          IF        @EQUAL
            IF        ASTAT=3
              GOTO      CHRFFS99            * already been charged
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CHRFFS99
.         MATCH     ANSF,TCINDC7
.         GOTO      CHRFFS10 IF EQUAL      * Contract fee
.
.         MATCH     ANSP,TCINDC7           * Patient contract?
.         GOTO      CHRFFS40 IF NOT EQUAL
.
.         Check if Bed fees to charged for primary procedure
.
CHRFFS10  PACK      KEY11,AADMNO,SP70
          CALL      RSNZSPR1
CHRFFS20  CALL      RKNZSPR1
          BRANCH    OVRCD,CHRFFS99
          MATCH     DAADMNO,NZSPADMN
          GOTO      CHRFFS99 IF NOT EQUAL
          COMPARE   ONE,NZSPPRIM
          GOTO      CHRFFS20 IF NOT EQUAL  * Not primary procedure
.
          MATCH     SP70,NZSPCPRC
          GOTO      CHRFFS22 IF EQUAL      * No contract
.
          MATCH     "1",NZSPCONT           * Max funder contribution?
          GOTO      CHRFFS20 IF NOT EQUAL
          GOTO      CHRFFS24               * charge FFS to patient
.
.         Charge FFS
.
CHRFFS22  MATCH     ANSP,TCINDC7
          GOTO      CHRFFS40 IF NOT EQUAL  * goes to primary funder
.
.         Charge FFS to patient for contract with max contribution
.
CHRFFS24  IF        PROGFLAG=1 | PROGFLAG=2
            COMPARE   ZERO,PINVFLAG
            GOTO      CHRFFS90 IF EQUAL    * displaying All invoices
            COMPARE   ONE,PINVFLAG
            GOTO      CHRFFS90 IF EQUAL    * displaying Patient invoice
          ELSE
            BRANCH    PRPATINV,CHRFFS90    * printing patient invoice
          ENDIF
          GOTO      CHRFFS99
.
.         Charge FFS to primary funder
.
CHRFFS40  BRANCH    PROGFLAG,CHRFFS60,CHRFFS60
.
          BRANCH    PRPATINV,CHRFFS70  * printing patient invoice
          GOTO      CHRFFS80
.
.     PINVFLAG 1=patient inv, 2=contract inv, 0=all invoices
.
CHRFFS60  BRANCH    PINVFLAG,CHRFFS70,CHRFFS80
          GOTO      CHRFFS90
.
CHRFFS70  MATCH     SP70,NZSPCNTR      * check for blank contract
          GOTO      CHRFFS99 IF NOT EQUAL
          GOTO      CHRFFS90
.
CHRFFS80  MATCH     EXPPAYER,NZSPCNTR
          GOTO      CHRFFS99 IF NOT EQUAL
.
CHRFFS90  MOVE      "0",F1                 * charge FFS
CHRFFS99  RETURN
.
.******************************************************************************
.*  Display Win/Loss Amount for Primary and Secondary Funder (if required)    *
.******************************************************************************
WNLS0000  
          IF        MULTCNTR=0
            COMPARE   ONE,PRIMFLAG
            GOTO      WNLS9999 IF NOT EQUAL   * Primary funder with No Contract
          ENDIF
.
.         Check if this has FFS charge 
.
          BRANCH    FFSFLAG,WNLS9999
.
.         Check if we are displaying ALL Invoice and primary funder not raised
.
          PACK      KEY16,AADMNO,SP70
          CALL      RDSINV3
WNLS2000  CALL      RDKINV3
          BRANCH    OVRCD,WNLS6000
          MOVE      PINVADM,KEY8
          MATCH     PINVADM,AADMNO
          GOTO      WNLS6000 IF NOT EQUAL      * no invoice raised yet
.
          MATCH     "1",PTINCRST               * Fully credited?
          GOTO      WNLS2000 IF EQUAL
.
.         Make sure this invoice does not only for items that are
.         'Bill to Patient' or/and 'Extra to Contract'
.
          CALL      CHIN0000                   * Check invoice
          COMPARE   ZERO,EXIT
          GOTO      WNLS2000 IF EQUAL          * invoice with no contrat
.
.         If the primary funder invoice is raised, then no ffs primary
.
          IF        MULTCNTR=0
            MATCH     PTINHFND,PRIMFUND
            GOTO      WNLS9999 IF EQUAL
          ENDIF
.
          GOTO      WNLS2000
.
.         Primary funder invoice not raised yet
.
WNLS6000  MOVE      EXPPAYER,SXPPAYER
          IF        MULTCNTR=0
            MATCH     "ALL",EXPPAYER
            GOTO      WNLS7000 IF EQUAL 
.
            MOVE      "ALL",EXPPAYER
          ENDIF
.
.         Calculate contract amount
.
WNLS7000  MOVE      ZERO,GROSSTOT
          MOVE      ONE,PROGFLAG              * Set to work out amt tobe inv'd
          MOVE      ZERO,PINVFLAG
          MOVE      ONE,CALCFFS
          CALL      CPRC0000                  * Check for any contract procedure
          MOVE      ZERO,CALCFFS
          MOVE      GROSSTOT,LUMPAT           * save grosstot for contract amt
.
          MOVE      ZERO,GROSSTOT
          MOVE      ONE,PROGFLAG              * Set to work out amt tobe inv'd
.
          CALL      CHFFS000                  * Charge FFS amount
.
          MOVE      "2",KEY1                  * FFS amount
          PACK      KEY15,PRIMFUND,PRIMMBS,SP70
          MOVE      GROSSTOT,FORM12X2
          CALL      WRWL0000                  * Write to Win/Loss tempfile
.
WNLS8200  MOVE      ONE,FINFLAG               * Flag to get total only
          CALL      CTHE0000                  * Get Theatre fees for FFS
          MOVE      ZERO,FINFLAG
.
          MOVE      ONE,CBFLAG                * Set for no contract
          CALL      GSXM0000                  * Get Misc.items 
.
          MOVE      SXPPAYER,EXPPAYER
.
          CALL      DWNL0000                  * Display Win/loss
.
.         Win/Loss= Contract fee - FFS
.
.         MOVE      LUMPAT,FORM12P2
.         SUB       GROSSTOT,FORM12P2         * Win/Loss 
.
          MOVE      LUMPAT,GROSSTOT           * restore
          MOVE      TWO,PROGFLAG              * Set back to display next invoice
.
WNLS9999  RETURN
+
.******************************************************************************
.         Display Win/Loss for each procedures
.******************************************************************************
DWNL0000  COMPARE   ZERO,SUMACC
          GOTO      DWNL9999 IF EQUAL
.
          MOVE      SP70,KEY6
          MOVE      ZERO,FORM12P2
.
          MOVE      ZERO,F1
          PACK      KEY16,SP70
          CALL      RSTMWNL1
DWNL1000  CALL      RKTMWNL1
          BRANCH    OVRCD,DWNL9999
.
          MATCH     "ALL",EXPPAYER
          GOTO      DWNL2000 IF NOT EQUAL
.
          CALL      CINR0000               * check if invoice raised by Funder
          BRANCH    EXIT,DWNL1000
.
          GOTO      DWNL4000
.
DWNL2000  MATCH     "PRFA",EXPPAYER
          IF        @EQUAL
            IF        MULTCNTR=1
              MOVE      NZPRCNTR,KEY6
              CALL      PCNT0000             * Check if this contract is PRFA
              BRANCH    EXIT,DWNL1000        * No
            ENDIF
          ELSE
            MATCH     EXPPAYER,NZPRCNTR
            GOTO      DWNL1000 IF NOT EQUAL
          ENDIF
.
DWNL4000  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF><td>&nbsp;</td>";
          IF        NZAMOUNT<0
            WRITE     HTMLFILE;"<td><b>Loss on this Contract ":
                               "- ",NZPRCNTR," - ",NZPRCPRC,"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Win on this Contract ":
                               "- ",NZPRCNTR," - ",NZPRCPRC,"</b></td>";
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right><b>",NZAMOUNT,"</b></td></tr>"
.
          GOTO      DWNL1000
.
DWNL9999  RETURN
+
.******************************************************************************
.         Check if invoice has already been raised for this Funder
.******************************************************************************
CINR0000  MOVE      ZERO,EXIT
          PACK      KEY16,AADMNO,SP70
          CALL      RDSINV3
CINR1000  CALL      RDKINV3
          BRANCH    OVRCD,CINR9999
          MOVE      PINVADM,KEY8
          MATCH     PINVADM,AADMNO
          GOTO      CINR9999 IF NOT EQUAL      * no invoice raised yet
.
          MATCH     "1",PTINCRST               * Fully credited?
          GOTO      CINR1000 IF EQUAL
.
          MATCH     NZPRCNTR,PTINHFND
          GOTO      CINR1000 IF NOT EQUAL      * not same funder
.
          MOVE      ONE,EXIT
.
CINR9999  RETURN
+
.******************************************************************************
.         Check PRFA contract
.******************************************************************************
PCNT0000  MOVE      ZERO,EXIT
          COMPARE   ZERO,PRFACNTR
          GOTO      PCNT9000 IF EQUAL
.
          MOVE      ZERO,F1
PCNT1000  ADD       ONE,F1
          COMPARE   F1,PRFACNTR
          GOTO      PCNT9000 IF LESS
.
          MATCH     KEY6,PRFACODE[F1]
          GOTO      PCNT1000 IF NOT EQUAL
.
          GOTO      PCNT9999
.
PCNT9000  MOVE      ONE,EXIT
PCNT9999  RETURN
+
.******************************************************************************
.         Check if this invoice has items that are
.         'Bill to Patient' or/and 'Extra to Contract' only (No contract)
.******************************************************************************
CHIN0000  OPEN      PATDTRA5,"patdtraf"
          PACK      KEY23,PINVNO,SP70
          CALL      RDSDTRN5
CHIN1000  CALL      RDKDTRN5
          BRANCH    OVRCD,CHIN9000
.
          MATCH     TREF,PINVNO
          GOTO      CHIN9000 IF NOT EQUAL
.
          COMPARE   EIGHT,TRECTYPE
          GOTO      CHIN8000 IF EQUAL
.
          COMPARE   THREE,TRECTYPE
          GOTO      CHIN2000 IF EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      CHIN1000 IF NOT EQUAL     * MBS item
          GOTO      CHIN8000
.
CHIN2000  BRANCH    PTDTCCU,CHIN1000,CHIN1000
CHIN8000  MOVE      ONE,EXIT
          GOTO      CHIN9999
.
CHIN9000  MOVE      ZERO,EXIT
CHIN9999  RETURN
+
.******************************************************************************
.*  Calculate Theatre Fee                                                     *
.******************************************************************************
CTHE0000  OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      NZPTFEA1,"nzptfeaf"
.
          MOVE      SP70,PRIMFUND
          MOVE      SP70,PRIMMBS
          CALL      GTPRI000              * Get primary procedure
.
          PACK      KEY31,DAADMNO,SP70
          CALL      RSOPDEA2
CTHE0200  CALL      RKOPDEA2
          BRANCH    OVRCD,CTHE9999
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      CTHE9999 IF NOT EQUAL
.
          MOVE      SP70,OPSESTYP
          PACK      KEY22,PMVXMHOS,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,CTHE0200
.
          COMPARE   THREE,OPDASTAT
          GOTO      CTHE0200 IF EQUAL         * Cancelled
.
          PACK      DIM9,ACLAIM,AFUNDH,SP70
.
          MOVE      ZERO,ACCCOUNT
          MOVE      ZERO,FORM12P2
          CALL      TDUR0000                   * Get total theatre duration
          COMPARE   ONE,FORM1
          GOTO      CTHE0200 IF NOT EQUAL      * No theatre charge
          COMPARE   ZERO,FORM8
          GOTO      CTHE0200 IF EQUAL          * No duration
          MOVE      FORM8,THEADURN             * Save total theatre duration
.
.         CALL      GSES0000                   * Get session type
          CALL      KTFE0000                   * Get the KEY for theatre fee
          BRANCH    EXIT,CTHE0200              * Theatre fee not setup
.
          MOVE      THEADURN,REMNDURN          * Setup the remaining duration
          PACK      KEY33,KEY31,SP70
          CALL      RSNZTFE1
CTHE1000  CALL      RKNZTFE1
          BRANCH    OVRCD,CTHE4000
.
         PACK  SKEY31,NZTFHOSP,NZTFSEST,NZTFCLAM,NZTFFUND,NZTFFTAB,NZTFEDAT,SP70
          MATCH     KEY31,SKEY31
          GOTO      CTHE4000 IF NOT EQUAL
.
          MATCH     "1",NZTFACTV
          GOTO      CTHE1000 IF EQUAL           * Inactive
.
          MOVE      NZTFMAXU,FORM8A             * max unit
          MULT      NZTFMUNI,FORM8A             * minutes per unit
.
          COMPARE   REMNDURN,FORM8A             * compare with duration
          GOTO      CTHE2000 IF NOT LESS
.
          SUB       FORM8A,REMNDURN             * Setup the new remaining durn.
.
          MOVE      NZTFUNTP,FORM12F2           * unit price
          MULT      NZTFMAXU,FORM12F2           * max unit
          ADD       FORM12F2,FORM12P2           * total price
.
          GOTO      CTHE1000
.
.         Total maximum minutes is greater than Remaining duration
.
CTHE2000  MOVE      REMNDURN,FORM8              * workout no of units
          DIV       NZTFMUNI,FORM8              * required for the rem.duration
.
.         Check if we need to add one more unit
.
          MOVE      NZTFMUNI,FORM12F2           * minutes per unit 
          MULT      FORM8,FORM12F2
          COMPARE   REMNDURN,FORM12F2
          GOTO      CTHE3000 IF NOT LESS
          ADD       ONE,FORM8                   * remaining duration
.
.         Check with the minimum no of units
.
CTHE3000  IF        FORM8<NZTFMINU
            MOVE      NZTFMINU,FORM8
          ENDIF
.
          MOVE      NZTFUNTP,FORM12F2           * unit price
          MULT      FORM8,FORM12F2
.
          ADD       FORM12F2,FORM12P2           * total price
.         ADD       FORM12P2,GROSSTOT
.
.         Check if there is any subsequent procedures
.
CTHE4000  
          COMPARE   ZERO,SUBQPROC
          GOTO      CTHE8000 IF EQUAL           * No
.
          CALL      SUBP0000              * Display/Print subsequent procedures
          SUB       BATAMTM,FORM12P2      * Theatre Charge for Primary proc.
.
.         BRANCH    FINFLAG,CTHE8100      * just get the total price
.
.         Display/Print Primary Procedure
.
CTHE8000  COMPARE   ONE,NPDAYFLG
          GOTO      CTHE0200 IF NOT EQUAL * Primary procedure had been charged
.
          CALL      GTPRI000              * Get primary procedure
          BRANCH    EXIT,CTHE0200
.
          BRANCH    FINFLAG,CTHE8100      * calculate ffs only for no contract
          BRANCH    WRDTFLAG,CTHE8100
.
          MATCH     SP70,NZSPCPRC         * Not contract procedure
          GOTO      CTHE8002 IF EQUAL
.
          MATCH     "1",NZSPCONT
          GOTO      CTHE0200 IF NOT EQUAL * Fixed fee no theatre fee
.
.
CTHE8002  MATCH     "ALL",EXPPAYER
          GOTO      CTHE8010 IF NOT EQUAL * All invoices
.
          MATCH     "3",NZSPINVD
          GOTO      CTHE0200 IF EQUAL     * All Invoices already raised
.
          MATCH     "1",NZSPINVD
          GOTO      CTHE8006 IF EQUAL     * Patient invoice reaised
.
          MATCH     "2",NZSPINVD
          GOTO      CTHE8100 IF NOT EQUAL * No invoice raised yet
.         
.         Funder Invoice has already been raised
.         Check if any patient invoice charges need to raised
.
          GOTO      CTHE8012
.
.         Patient Invoice has already been raised
.         Check if any funder invoice charges need to raised
.
CTHE8006  MATCH     "1",NZSPCONT
          GOTO      CTHE0200 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70   * check claim code
          CALL      RDCODE1
          BRANCH    OVRCD,CTHE8100
.
          MATCH     "P",TCINDC7
          GOTO      CTHE0200 IF EQUAL       * already Included in pat.invoice
          MATCH     SP70,TCINDC7
          GOTO      CTHE0200 IF EQUAL       * already Included in pat.invoice
.
          GOTO      CTHE8100
.
.         Printing individual invoice
.
CTHE8010  MATCH     "PRFA  ",EXPPAYER
          GOTO      CTHE8020 IF NOT EQUAL
.
          MATCH     "1",NZSPINVD
          GOTO      CTHE0200 IF EQUAL     * Patient Invoice raised
.
CTHE8012  MATCH     SP70,AFUNDH
          GOTO      CTHE8100 IF EQUAL
.
.         If there is max.contr. theatre time goes to patient invoice
.
          MATCH     "1",NZSPCONT
          GOTO      CTHE8100 IF EQUAL       * Include in patient invoice
.
.         Check for claim code
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTHE8100
.
          MATCH     "P",TCINDC7
          GOTO      CTHE8100 IF EQUAL       * Include in patient invoice
          MATCH     SP70,TCINDC7
          GOTO      CTHE8100 IF EQUAL       * Include in patient invoice
          GOTO      CTHE0200
.
.         Printing/displaying funder invoice
.         If this max contr., theatre time goes to patient invoice not funder
.
CTHE8020  MATCH     "1",NZSPCONT
          GOTO      CTHE0200 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70   * check claim code
          CALL      RDCODE1
          BRANCH    OVRCD,CTHE8030
.
          MATCH     "P",TCINDC7
          GOTO      CTHE0200 IF EQUAL       * Include in patient invoice
          MATCH     SP70,TCINDC7
          GOTO      CTHE0200 IF EQUAL       * Include in patient invoice
.
CTHE8030  MATCH     EXPPAYER,AFUNDH
          GOTO      CTHE0200 IF NOT EQUAL
.
          MATCH     "2",NZSPINVD
          GOTO      CTHE0200 IF EQUAL       * Funder invoice raised
.
CTHE8100  IF        FINFLAG=1
            IF        MULTCNTR=0
              MATCH     NZSPCNTR,PRIMFUND
              GOTO      CTHE8120 IF NOT EQUAL
            ENDIF
            MOVE      "3",KEY1                * Theatre
            PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
            MOVE      FORM12P2,FORM12X2
            CALL      WRWL0000               * Write to Win/Loss tempfile
          ENDIF
          ADD       FORM12P2,GROSSTOT
.
CTHE8120  MOVE      SP70,IDESC
          MOVE      SP70,IMISGRP
          MOVE      AMBS,KEY9
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
.
.         MOVE      NZSPUNTH,KEY10
.         CALL      RDOPDEA3
.         IF        OVRCD=1
.           MOVE      SP70,OPDADATE
.         ENDIF
.
          BRANCH    PROGFLAG,CTHE9000,CTHE8200,CTHE8400,CTHE8600
          GOTO      CTHE0200
.
CTHE8200  UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                              CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td>Theatre Charge for Primary Procedure</td>":
                             "<td>&nbsp;",AMBS,"</td>";
.
          IF        NZSPPIND=1 & NZSPPRIM<>2
            WRITE     HTMLFILE;"<td>&nbsp;",NZSPTDUR,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;",AFUNDH,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",FORM12P2,"</b></td></tr>"
.
          MOVE      FORM12P2,FORM12D2
          MOVE      "Theatre Charge for Primary  ",DIM30
          MOVE      SP70,DIM35
          CALL      RTHE0000                   * write to pmsmtiaf
          GOTO      CTHE0200
.
CTHE8400  
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      FORM12P2,FORM7P2
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
.         PRINT     *3,ESCCHR,CHARG,AMBS,ESCCHR,CHARH:
          PRINT     *3,CPCDATE;
.
.         MOVE     IDESC,KEY35
          MOVE     "Theatre Charge for Primary         ",KEY35
          ADD       FORM12P2,TOTAMNT
.
          MATCH     "1",PTCNPITM                         * print long item desc?
          GOTO      CTHE8410 IF EQUAL
          MATCH     "1",PTCNPPRC                         * print procedure code?
          GOTO      CTHE8420 IF NOT EQUAL
.
          PRINT     *14,AMBS,*34,KEY35,*70,FORM7P2
          ADD       ONE,COUNT
          GOTO      CTHE8500
.
CTHE8410  PRINT     *14,AMBS,*34,KEY35,*115,FORM7P2
          ADD       ONE,COUNT
          GOTO      CTHE8500
.
CTHE8420  PRINT     *18,AMBS,*30,KEY35,*70,FORM7P2             * Details
          ADD       ONE,COUNT
.
CTHE8500  MOVE      FORM12P2,SAVPAT
          CALL      CLPATDTR
          MOVE      "Theatre Charge for Primary    ",TDDESC
          MOVE      AFUNDH,PTDTCNTR
.         MOVE      NZSPPROC,PTDTCPRC
          MOVE      NZSPCPRC,PTDTCPRC
.
          MOVE      NZSPUNIQ,PTDTSUNQ
          CALL      WPRC0000                 * Write procedure to DTR
          BRANCH    WRDTFLAG,CTHE0200
.
.         Write record to patfinsf
.
CTHE8600  MOVE      FORM12P2,FINAMT
          CALL      WPFI0000             * write to patfinsf
          GOTO      CTHE0200
.
CTHE9000 
          IF        MULTCNTR=0
            BRANCH    WRDTFLAG,CTHE8500  * Write record to nzprdtaf
          ELSE

            IF        WRDTFLAG=1
              MATCH     "ALL",EXPPAYER
              GOTO      CTHE8500 IF EQUAL
.
              MATCH     "PRFA",EXPPAYER
              IF        @EQUAL
                MOVE      PRIMFUND,KEY6    * check if Primary funder is PRFA
                CALL      PCNT0000
                COMPARE   ZERO,EXIT
                GOTO      CTHE8500 IF EQUAL * yes
              ELSE
                MATCH     EXPPAYER,AFUNDH
                GOTO      CTHE0200 IF NOT EQUAL
                GOTO      CTHE8500
              ENDIF
            ENDIF
          ENDIF
          GOTO      CTHE0200
.
CTHE9999  RETURN
+
.******************************************************************************
.         Check primary procedure
.******************************************************************************
GTPRI000  MOVE      ZERO,EXIT
          PACK      KEY11,DAADMNO,SP70
          CALL      RSNZSPR1
GTPRI100  CALL      RKNZSPR1
          BRANCH    OVRCD,GTPRI900
.
          MATCH     DAADMNO,NZSPADMN
          GOTO      GTPRI900 IF NOT EQUAL
          COMPARE   ONE,NZSPPRIM
          GOTO      GTPRI100 IF NOT EQUAL   * Not primary
          MOVE      NZSPCNTR,PRIMFUND
          MOVE      NZSPCPRC,PRIMMBS
.
          COMPARE   ONE,NZSPPIND            * Performed?
          GOTO      GTPRI900 IF NOT EQUAL
.
          MATCH     "3",NZSPINVD            * All Invoice raised?
          GOTO      GTPRI999 IF NOT EQUAL   * No
.
GTPRI900  MOVE      ONE,EXIT
GTPRI999  RETURN
+
.******************************************************************************
.         Add Theatre charge to the DTRAN record
.******************************************************************************
WPRC0000  MOVE      AADMNO,TADMNO
          MOVE      SAVPAT,TPATAMTT
          MOVE      SAVPAT,TPATAMTP
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY    * use booking date
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          MOVE      KEY9,TITEMNO
          MOVE      CNEXTINV TO TREF
          MOVE      ONE,TINVPRT
          PACK      PTDTEFFD,PINVDTE    * Effective date to fees invoiced
          MOVE      TWO,TRECTYPE        * for theatre fee
          MOVE      ONE,TSERVS
          MOVE      "P",TTYPEDEB
          MOVE      IMISGRP,TMISGRP
          MOVE      " 1",TSESSION
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MOVE      ZERO,PTDTGSTL
.
WPRC1000  CALL      NXTTRAN1      * Get the next transaction number
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          IF        WRDTFLAG=1
            CALL      RANZRDT1
            COMPARE   ZERO,OVRCD
            GOTO      WPRC1000 IF EQUAL    * Try the next transaction number
            CALL      WRNZRDT1           * Write to FFS with Win/Loss
          ELSE
            CALL      RDADTRN1
            COMPARE   ZERO,OVRCD
            GOTO      WPRC1000 IF EQUAL    * Try the next transaction number
            CALL      WRDTRN1            * Write Procedure record
          ENDIF
.
.         Delete theatre charges record from pmsmtiaf file
.
          OPEN      PMSMTIA2,"pmsmtiaf"
          MOVE      TADMNO,DTADMNO
          MOVE      "2",PMMIRTYP
          PACK      KEY15,DTADMNO,PMMIRTYP,SP70
WPRC2000  CALL      RSPMMTI2
WPRC2200  CALL      RKPMMTI2
          BRANCH    OVRCD,WPRC9999
.
          MATCH     DTADMNO,PMMIVISN
          GOTO      WPRC9999 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      WPRC9999 IF NOT EQUAL   * Not a theatre char
.
          MATCH     PMMICNTR,NZSPCNTR
          GOTO      WPRC2200 IF NOT EQUAL
.
          MATCH     PMMISUNQ,NZSPUNIQ       * check uniq no
          GOTO      WPRC2200 IF NOT EQUAL
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
.
          GOTO      WPRC2000
.
WPRC9999  RETURN
+
.******************************************************************************
.         Get the key for Theatre fees
.******************************************************************************
KTFE0000  PACK      KEY23,PMVXMHOS,OPSESTYP,DIM9,SP70
          CALL      GEFFD0000
          MATCH     SP70,EFTDATE
          GOTO      KTFE4000 IF NOT EQUAL
.
.         Try with blank Contract
.
          UNPACK    DIM9,KEY3
          PACK      KEY23,PMVXMHOS,OPSESTYP,KEY3,SP70
          CALL      GEFFD0000
          MATCH     SP70,EFTDATE
          GOTO      KTFE4000 IF NOT EQUAL
.
          PACK      KEY23,PMVXMHOS,OPSESTYP,SP70
          CALL      GEFFD0000
          MATCH     SP70,EFTDATE
          GOTO      KTFE4000 IF NOT EQUAL
.
          PACK      KEY23,PMVXMHOS,SP70
          CALL      GEFFD0000
          MATCH     SP70,EFTDATE
          GOTO      KTFE9000 IF EQUAL
.
KTFE4000  PACK      KEY31,KEY23,EFTDATE,SP70
          MOVE      ZERO,EXIT
          GOTO      KTFE9999
.
KTFE9000  MOVE      ONE,EXIT
KTFE9999  RETURN
.
.******************************************************************************
.*  Get the most current effective date                                       *
.******************************************************************************
GEFFD000  MOVE      SP70,EFTDATE
          PACK      KEY8,OPDADATE,SP70
          REP       " 0",KEY8
          MOVE      " 1",NZTFISEQ
          PACK      KEY33,KEY23,KEY8,NZTFISEQ,SP70
          CALL      RDNZTFE1
          COMPARE   ZERO,OVRCD
          GOTO      GEFFD800 IF EQUAL
.
          CALL      RPNZTFE1
          BRANCH    OVRCD,GEFFD999
.
          PACK      SKEY23,NZTFHOSP,NZTFSEST,NZTFCLAM,NZTFFUND,NZTFFTAB,SP70
          MATCH     KEY23,SKEY23
          GOTO      GEFFD999 IF NOT EQUAL
.
GEFFD800  MOVE      NZTFEDAT,EFTDATE            * Save the effective date
GEFFD999  RETURN
+
.******************************************************************************
.*  Get total duration of all procedures                                      *
.******************************************************************************
TDUR0000  MOVE      ZERO,FORM8
          MOVE      ZERO,SUBQPROC           * number of subsequent procedures
          MOVE      ZERO,FORM1
          MOVE      ZERO,NPDAYFLG           * invoice primary procedure flag
.
          OPEN      NZPSPRA1,"nzpspraf"
          PACK      KEY11,DAADMNO,SP70
          CALL      RSNZSPR1
TDUR1000  CALL      RKNZSPR1
          BRANCH    OVRCD,TDUR9999
.
          MATCH     DAADMNO,NZSPADMN
          GOTO      TDUR9999 IF NOT EQUAL
.
          MATCH     NZSPUNTH,OPDAUNIQ
          GOTO      TDUR1000 IF NOT EQUAL   * Only include duration for the uniq
.
          COMPARE   ONE,NZSPPIND            * Performed?
          GOTO      TDUR1000 IF NOT EQUAL   * No
.
          PACK      DIM9,NZSPCLMN,NZSPCNTR,SP70
          ADD       NZSPTDUR,FORM8
.         MATCH     "3",NZSPINVD            * All Invoice raised?
.         GOTO      TDUR1000 IF EQUAL       * Yes - skip
.         MATCH     "1",NZSPINVD            * Patient Invoice raised?
.         GOTO      TDUR1000 IF EQUAL       * Yes - skip
.
          MOVE      ONE,FORM1               * found a theatre charge
          COMPARE   ONE,NZSPPRIM
          GOTO      TDUR2000 IF NOT EQUAL   * not primary
.
          MOVE      ONE,NPDAYFLG            * Primary procedure tobe invoiced
          GOTO      TDUR1000                * don't include primary procedure
.
TDUR2000  ADD       ONE,SUBQPROC            * Number of performed seq.procedures
.
          GOTO      TDUR1000
.
TDUR9999  RETURN
.
.******************************************************************************
.         Display theatre fees for subsequent procedures
.******************************************************************************
SUBP0000  MOVE      ZERO,BATAMTM
          MOVE      ZERO,FORM12D2
          PACK      KEY11,DAADMNO,SP70
          CALL      RSNZSPR1
SUBP1000  CALL      RKNZSPR1
          BRANCH    OVRCD,SUBP9999

          MATCH     DAADMNO,NZSPADMN
          GOTO      SUBP9999 IF NOT EQUAL
.
          MATCH     NZSPUNTH,OPDAUNIQ
          GOTO      SUBP1000 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND            * Performed?
          GOTO      SUBP1000 IF NOT EQUAL
.
          MATCH     "3",NZSPINVD            * All Invoice raised?
          GOTO      SUBP1010 IF EQUAL       * Yes - skip
.
.         Leave primary procedure last
.
          IF        NZSPPRIM=1
            MOVE      ONE,NPDAYFLG          * Primary procedure tobe invoiced
            GOTO      SUBP1000
          ENDIF
.
.         Calculate the Subsequent procedure amount
.
SUBP1010  MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=1
            MOVE      SP70,OPDADATE
          ENDIF
.
          MOVE      FORM12P2,FORM12D2       * total procedure fees
          MULT      NZSPTDUR,FORM12D2       * procedure duration
          DIV       THEADURN,FORM12D2       * total duration
.
          ADD       FORM12D2,BATAMTM        * total duration for all sub-proc.
.
          MATCH     "3",NZSPINVD            * All Invoice raised?
          GOTO      SUBP1000 IF EQUAL       * Yes - skip
.
          BRANCH    FINFLAG,SUBP1800
          BRANCH    WRDTFLAG,SUBP1800       * Calculate Theatre fees for FFS
.
          MATCH     "ALL",EXPPAYER
          GOTO      SUBP1020 IF NOT EQUAL   * Not All Invoices
.
          MATCH     "0",NZSPINVD
          GOTO      SUBP1600 IF EQUAL       * no invoice raised
          MATCH     "1",NZSPINVD
          GOTO      SUBP1100 IF EQUAL       * patient invoice raised
          MATCH     "2",NZSPINVD
          GOTO      SUBP1040 IF EQUAL       * funder invoice raised
          GOTO      SUBP1000
.
SUBP1020  MATCH     "PRFA  ",EXPPAYER
          GOTO      SUBP1100 IF NOT EQUAL
.
          MATCH     "0",NZSPINVD
          GOTO      SUBP1600 IF EQUAL
.
          MATCH     "1",NZSPINVD
          GOTO      SUBP1000 IF EQUAL     * Patient Invoice raised
.
SUBP1040  MATCH     SP70,NZSPCNTR
          GOTO      SUBP1600 IF EQUAL
.
.         If there is max.contr. theatre time goes to patient invoice
.
          MATCH     "1",NZSPCONT
          GOTO      SUBP1600 IF EQUAL       * Include in patient invoice
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70    * check claim code
          CALL      RDCODE1
          BRANCH    OVRCD,SUBP1600
.
          MATCH     "P",TCINDC7
          GOTO      SUBP1600 IF EQUAL       * Include in patient invoice
          MATCH     SP70,TCINDC7
          GOTO      SUBP1600 IF EQUAL       * Include in patient invoice
          GOTO      SUBP1000
.
.         Printing/displaying sub-sequence procedure
.         If this max contr., theatre time goes to patient invoice not funder
.
SUBP1100  MATCH     "1",NZSPCONT
          GOTO      SUBP1000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70    * check claim code
          CALL      RDCODE1
          BRANCH    OVRCD,SUBP1200
.
          MATCH     "P",TCINDC7
          GOTO      SUBP1000 IF EQUAL       * Include in patient invoice
.
          MATCH     SP70,TCINDC7
          GOTO      SUBP1000 IF EQUAL       * Include in patient invoice
.
SUBP1200  MATCH     EXPPAYER,NZSPCNTR
          GOTO      SUBP1000 IF NOT EQUAL
.
          MATCH     "2",NZSPINVD
          GOTO      SUBP1000 IF EQUAL       * Funder invoice raised
.
.         No theatre charges for Fixed cost

.
SUBP1600  MATCH     SP70,NZSPCPRC
          IF        !@EQUAL
            MATCH     "1",NZSPCONT
            GOTO      SUBP1000 IF NOT EQUAL
.
            MATCH     NZSPCNTR,NZSPCPRC
            IF        @EQUAL
              IF        NZCFSPRI<>0
                MULT      NZCFSPRI,FORM12D2         * percentage for contract
                DIV       "100",FORM12D2            * same as primary
              ENDIF
            ELSE
              IF        NZCFSPRI<>0
                MULT      NZCFDPRI,FORM12D2        * percentage for contract
                DIV       "100",FORM12D2           * different to primary
              ENDIF
            ENDIF
          ENDIF
.
SUBP1800  MOVE      SP70,IDESC
          MOVE      SP70,IMISGRP
          MOVE      NZSPPROC,KEY9           * procedure item
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
.
.         BRANCH    FINFLAG,SUBP9000
.         ADD       FORM12D2,GROSSTOT
.         IF        FINFLAG=1
.           IF        ERDTFLAG=1
.             ADD       FORM12D2,GROSSTOT
.           ENDIF
.           GOTO  SUBP9000
.         ENDIF
.
          IF        FINFLAG=1
            IF        MULTCNTR=0
              MATCH     NZSPCNTR,PRIMFUND
              IF        @EQUAL
                ADD       FORM12D2,GROSSTOT
              ENDIF
            ENDIF
            MOVE      "3",KEY1                * Theatre
            PACK      KEY15,NZSPCNTR,NZSPCPRC,SP70
            MOVE      FORM12D2,FORM12X2
            CALL      WRWL0000               * Write to Win/Loss tempfile
.
            GOTO      SUBP9000
          ENDIF
          ADD       FORM12D2,GROSSTOT
.
          BRANCH    PROGFLAG,SUBP9000,SUBP2000,SUBP4000,SUBP6000
          GOTO      SUBP9999
.
SUBP2000  UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td>Theatre Charge</td>":
                             "<td>&nbsp;",NZSPPROC,"</td>";
.
          IF        NZSPPIND=1 & NZSPPRIM<>2
            WRITE     HTMLFILE;"<td>&nbsp;",NZSPTDUR,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;",NZSPCNTR,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",FORM12D2,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",FORM12D2,"</b></td></tr>"
.
          MOVE      "Theatre Charge             ",DIM30
          MOVE      SP70,DIM35
          CALL      RTHE0000                   * write to pmsmtiaf
          GOTO      SUBP1000
.
SUBP4000  COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      FORM12D2,FORM7P2
          PACK      KEY40,SP70
          CLEAR     KEY40
          APPEND    "Theatre Charge",KEY40
          APPEND    SP70,KEY40
          RESET     KEY40
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.         PRINT     *3,ESCCHR,CHARG,NZSPPROC,ESCCHR,CHARH:
.
          PRINT     *3,CPCDATE;
.
          MOVE      KEY40,KEY35
          MATCH     "1",PTCNPITM                         * print long item desc?
          GOTO      SUBP4600 IF EQUAL
          MATCH     "1",PTCNPPRC                         * print procedure code?
          GOTO      SUBP4800 IF NOT EQUAL
.
          PRINT     *14,NZSPPROC,*34,KEY35,*70,FORM7P2
          ADD       ONE,COUNT
          GOTO      SUBP5000
.
SUBP4600  PRINT     *14,NZSPPROC,*34,KEY35,*115,FORM7P2
          ADD       ONE,COUNT
          GOTO      SUBP5000
.
SUBP4800  PRINT     *18,NZSPPROC,*30,KEY35,*70,FORM7P2             * Details
          ADD       ONE,COUNT
.
SUBP5000  ADD       FORM12D2,TOTAMNT
          MOVE      FORM12D2,SAVPAT
          CALL      CLPATDTR
          MOVE      "Theatre Charge           ",TDDESC
          MOVE      NZSPCNTR,PTDTCNTR
.         MOVE      NZSPPROC,PTDTCPRC
          MOVE      NZSPCPRC,PTDTCPRC
          MOVE      NZSPUNIQ,PTDTSUNQ
          CALL      WPRC0000                 * Write procedure to DTR
          BRANCH    WRDTFLAG,SUBP1000
.
.         Write record to patfinsf
.
SUBP6000  MOVE      FORM12D2,FINAMT
          CALL      WPFI0000             * write to patfinsf
.
          GOTO      SUBP1000
.
SUBP9000  BRANCH    WRDTFLAG,SUBP9200    * write record to nzprdtaf
          GOTO      SUBP1000
.
SUBP9200  
          MATCH     SP70,NZSPCNTR
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSL,ACLAIM,SP70   * check claim code
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              GOTO      SUBP5000 IF EQUAL       * Include in patient invoice
            ENDIF
          ENDIF
.
          IF        MULTCNTR=1
            MATCH     "ALL",EXPPAYER
            IF        !@EQUAL
              MATCH     "PRFA",EXPPAYER
              IF        @EQUAL
                MOVE      NZPRCNTR,KEY6
                CALL      PCNT0000             * Check if this contract is PRFA
                BRANCH    EXIT,SUBP9300
              ELSE
                MATCH     EXPPAYER,NZSPCNTR
                GOTO      SUBP9300 IF NOT EQUAL
              ENDIF
            ENDIF
            GOTO      SUBP5000                  * include in multiple funder
          ENDIF
.
SUBP9300  MATCH     NZSPCNTR,PRIMFUND
          GOTO      SUBP5000 IF EQUAL
          GOTO      SUBP1000
.
SUBP9999  RETURN
+
.******************************************************************************
.         Remove theatre charges from pmsmtiaf
.         and re write a new theatre charge as the duration might have
.         changed
.******************************************************************************
RTHE0000  OPEN      PMSMTIA2,"pmsmtiaf"
.
          MOVE      "2",PMMIRTYP
          PACK      KEY15,DAADMNO,PMMIRTYP,SP70
RTHE1000  CALL      RSPMMTI2
RTHE2000  CALL      RKPMMTI2
          BRANCH    OVRCD,RTHE9000
.
          MATCH     DAADMNO,PMMIVISN
          GOTO      RTHE9000 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      RTHE9000 IF NOT EQUAL   * Not a theatre charges
.
          IF        ACCCOUNT=0
            MOVE      PMMITRAN,ACCCOUNT     * save the transaction number
          ENDIF
.
          MATCH     PMMICNTR,NZSPCNTR
          GOTO      RTHE2000 IF NOT EQUAL
.
          MATCH     PMMISUNQ,NZSPUNIQ       * check uniq no
          GOTO      RTHE2000 IF NOT EQUAL
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
.
          GOTO      RTHE1000
.
RTHE9000  CALL      WMTI0000                 * Write theatre charges to pmsmtiaf
.
RTHE9999  RETURN
+
.******************************************************************************
.         Write theatre charges to pmsmtiaf
.******************************************************************************
WMTI0000  MOVE      AADMNO,PMMIVISN
          MOVE      AURNO,PMMIURNO
          MOVE      "3",PMMISYST
          MOVE      KEY9,PMMIITEM
          PACK      PMMIDESC,DIM30,SP70
          PACK      PMMIDES2,DIM35,SP70
          MOVE      OPDADATE,PMMITDAT
          MOVE      SP70,PMMITDOC
          MOVE      SP70,PMMIODOC
          MOVE      " 1",PMMISESS
          MOVE      TWO,PMMIRTYP        * for theatre fee
          MOVE      SP70,PMMIREFN
          MOVE      FORM12D2,PMMIAMTT
          MOVE      FORM12D2,PMMIAMTP
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      ZERO,PMMIRBAT
          MOVE      ONE,PMMISERV
          MOVE      IMISGRP,PMMIMGRP
          UNPACK    SP70,PMMIBTCH,PMMIDUPD,PMMITUPD,PMMIWUSR
          UNPACK    SP70,PMMISUBN,PMMIEDAD,PMMISVTM
          MOVE      ZERO,PMMIINVN
          MOVE      ZERO,PMMIGSTA
          MOVE      SP70,PMMIGSTC
          MOVE      ZERO,PMMIGSTM
          MOVE      SP70,PMMIUNIQ
          MOVE      NZSPCNTR,PMMICNTR
          MOVE      NZSPUNIQ,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      DAADMNO,KEY8
.
          IF        ACCCOUNT<>0
            MOVE      ACCCOUNT,PMMITRAN   * try use the deleted transaction no.
            GOTO      WMTI2200
          ENDIF
.
.         Get the next transaction number
.
          CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
.
WMTI2200  PACK      KEY14,DAADMNO,PMMITRAN,SP70
          CALL      RAPMMTI1
          IF        OVRCD=0
            MOVE      ZERO,FORM6
            MOVE      PMMITRAN,FORM6
            ADD       ONE,FORM6
            MOVE      FORM6,PMMITRAN
            GOTO      WMTI2200
          ENDIF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          PACK      KEY14,DAADMNO,PMMITRAN,SP70
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
          CALL      WRPMMTI1
.
WMTI9999  RETURN
+
.******************************************************************************
.         Get the session type
.******************************************************************************
GSES0000  PACK      KEY31,DAADMNO,SP70
          CALL      RSOPDEA2
GSES1000  CALL      RKOPDEA2
          BRANCH    OVRCD,GSES9000
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      GSES9000 IF NOT EQUAL
.
          PACK      KEY22,PMVXMHOS,OPDADATE,OPDATIME,OPDACLIN,SP70    
          CALL      RDOPSES1
          BRANCH    OVRCD,GSES1000
.
          COMPARE   THREE,OPDASTAT
          GOTO      GSES1000 IF EQUAL         * Cancelled
          GOTO      GSES9999
.
GSES9000  MOVE      SP70,OPSESTYP
GSES9999  RETURN
+
.******************************************************************************
.         Write to patfinsf for Theatre fee
.******************************************************************************
WPFI0000  COMPARE   FIVE,PROGFLAG
          GOTO      WPFI9999 IF EQUAL    * Print only
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          MOVE      ZERO,FGSTFLAG
          MOVE      "A",FINTYPE
          IF        PTCNMFEE = 1
            PACK      FINCODE WITH ANSM,ACLAIM,IMISGRP,KEY9,SP70
          ELSE
            PACK      FINCODE WITH ANSM,IMISGRP,KEY9,SP70
          ENDIF
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
WPFI9999  RETURN
+
.******************************************************************************
.         Update invoice flag
.******************************************************************************
UPSPR000  COMPARE   THREE,PROGFLAG
          GOTO      UPSPR999 IF NOT EQUAL
.
          PACK      KEY17,DAADMNO,SP70
          IF        PRPATINV=0
            PACK      KEY17,DAADMNO,EXPPAYER,SP70
          ENDIF
          CALL      RSNZSPR2
UPSPR100  CALL      RKNZSPR2
          BRANCH    OVRCD,UPSPR999

          MATCH     DAADMNO,NZSPADMN
          GOTO      UPSPR999 IF NOT EQUAL
.
.         Check claim code
.
          MOVE      ZERO,ADYFLAG
          MATCH     "1",NZSPCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC7
              IF        @EQUAL
                MOVE      ONE,ADYFLAG
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ZERO,PRPATINV
          GOTO      UPSPR300 IF NOT EQUAL      * Not printing funder
.
.         Check claim code
.
          MATCH     "1",NZSPCONT
          GOTO      UPSPR220 IF EQUAL          * funder contribution
.
          BRANCH    ADYFLAG,UPSPR300
.
UPSPR220  MATCH     EXPPAYER,NZSPCNTR
          GOTO      UPSPR999 IF NOT EQUAL    * different funder
.
UPSPR300  COMPARE   ONE,NZSPPIND               * Performed?
          GOTO      UPSPR100 IF NOT EQUAL
.
          MATCH     "3",NZSPINVD               * All Invoiced printed?
          GOTO      UPSPR100 IF EQUAL          * Yes
.
          COMPARE   ONE,PRPATINV               * Print Patient Inv.
          GOTO      UPSPR600 IF NOT EQUAL
.
          IF        ADYFLAG=1
            MOVE      "2",NZSPINVD             * No funder invoice for INDC7=P
          ENDIF
.
          MATCH     "2",NZSPINVD               * check if funder inv.raised
          IF        @EQUAL
            MOVE      "3",NZSPINVD             * All Invoice raised
          ELSE
            MOVE      "1",NZSPINVD             * Flag for patient inv.raised
          ENDIF
          GOTO      UPSPR800
.
UPSPR600  MATCH     "1",NZSPINVD               * check if patient inv.raised
          IF        @EQUAL
            MOVE      "3",NZSPINVD             * All Invoice raised
          ELSE
            MOVE      "2",NZSPINVD             * Flag for Funder inv.raised
          ENDIF
.
UPSPR800  CALL      UPNZSPR2             * Update invoiced flag
          GOTO      UPSPR100
.
UPSPR999  RETURN
+
.******************************************************************************
.         Update FFS with Win/Loss
.******************************************************************************
UPWNL000  MOVE      GROSSTOT,LUMPAT           * save grosstot
          MOVE      ONE,WRDTFLAG              * Flag to write to nzprdtaf
          MOVE      ZERO,GROSSTOT
          MOVE      ONE,PROGFLAG              * Set to work out amt tobe inv'd
.
          CALL      GTPRI000                  * Get primary procedure
          COMPARE   ONE,MULTCNTR
          GOTO      UPWNL100 IF NOT EQUAL
.
          MATCH     "ALL",EXPPAYER
          GOTO      UPWNL100 IF EQUAL
.
          MATCH     "PRFA",EXPPAYER
          IF        @EQUAL
            MOVE       PRIMFUND,KEY6          * check if Primary funder is PRFA
            CALL       PCNT0000
            BRANCH     EXIT,UPWNL200          * No
          ELSE
            MATCH     EXPPAYER,PRIMFUND
            GOTO      UPWNL200 IF NOT EQUAL
          ENDIF
.
UPWNL100  CALL      CHFFS000                  * Charge FFS amount
.
UPWNL200  CALL      CTHE0000                  * Get Theatre fees 
.
          MOVE      ZERO,WRDTFLAG
          MOVE      LUMPAT,GROSSTOT           * restore
          MOVE      THREE,PROGFLAG
UPWNL999  RETURN
+
.******************************************************************************
.         Write Misc. to nzprdtaf file
.******************************************************************************
WRMSC000  MOVE      GROSSTOT,LUMPAT           * save grosstot
          MOVE      ONE,PROGFLAG              * Set to work out amt tobe inv'd
          MOVE      ONE,CBFLAG                * Set for no contract
          MOVE      ONE,FINFLAG               * Flag to write to nzprdtaf
          MOVE      CNEXTINV TO TREF
          CALL      GSXM0000                  * Get Misc.items 
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CBFLAG
          MOVE      LUMPAT,GROSSTOT           * restore
          MOVE      THREE,PROGFLAG
WRMSC999  RETURN
+
.***************************************************************************
.        Check if any deposit details are to be printed
.***************************************************************************
XCDE0000  OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          MOVE      AADMNO,DAADMNO
          MOVE      "0",CMDESTAT
          MOVE      ZERO,FINDFLG
          PACK      KEY26,AADMNO,CMDESTAT,SP70
          CALL      RSCMDEP2
XCDE1000  CALL      RKCMDEP2
          BRANCH    OVRCD OF XCDE2000
.
          MATCH     DAADMNO,CMDEADMN
          GOTO      XCDE2000 IF NOT EQUAL
.
          MATCH     "0",CMDESTAT                   * Deposit held?
          GOTO      XCDE2000 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,XCDE1000
.
          IF        IPATFLAG=1
            MATCH     "9",RCDTSFLG
            GOTO      XCDE1000 IF NOT EQUAL        * Not included
          ENDIF
.
          MOVE      ONE,FINDFLG
          GOTO      XCDE6000
.
XCDE2000  PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
XCDE3000  CALL      RKRCDTE6
          BRANCH    OVRCD,XCDE9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      XCDE9999 IF NOT EQUAL
.
          MATCH     SP10,RCDTINVN          * Invoice number must be blank
          GOTO      XCDE3000 IF NOT EQUAL
          MATCH     SP10,RCDTRELD
          GOTO      XCDE3000 IF NOT EQUAL   * has been released
.
          IF        IPATFLAG=1
            MATCH     "9",RCDTSFLG
            GOTO      XCDE3000 IF NOT EQUAL        * Not included
          ENDIF
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,XCDE3000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      XCDE3000 IF EQUAL
.
          MOVE      TWO,FINDFLG
.
.        Read Receipt bank details to get the payee details
.
XCDE6000  PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,XCDE8000
.
          MATCH     RCDTRECN,RCBDRECN
          GOTO      XCDE8000 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          CALL      GCSHP000
.
          UNPACK    RCBDTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MOVE      SP70,KEY1
          IF        FINDFLG=2
            ENDSET    DIM14
            APPEND    "*",DIM14             * Non-banked
            APPEND    SP70,DIM14
            RESET     DIM14
          ENDIF
          IF        F2=2
            MOVE      RCBDDRAW,RCBDPAYD     * Cheque - use the drawer as payee
          ENDIF
.
          MOVE      RCDTAMNT,FORM12P2
          MULT      SEQ,FORM12P2
.
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      FORM12P2,FORM7P2
          MOVE      RCBDPAYD,KEY39
          PRINT     *3,"RECEIPT ##",RCDTRECN,*25,"Payer:",KEY39,*70,FORM7P2
          ADD       ONE,COUNT
.
XCDE8000  BRANCH    FINDFLG,XCDE1000,XCDE3000
.
XCDE9999  RETURN
+
.**********************************************************************
.*                            GCSHP000                                *
.*                       Get Payment type description                 *
.**********************************************************************
GCSHP000  MOVE      SP70,DIM14
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,RCBDPCOD
          CALL      RDCODE1
          BRANCH    OVRCD,GCSHP999
          SQUEEZE   PTCDNHCP
          MOVE      PTCDNHCP,F2
          PACK      DIM14,TDESC
GCSHP999  RETURN
+
.*******************************************************************************
.         Create misc item tempfile
.*******************************************************************************
CRTM0000  
...       CALL      TFILENAM                * Get temp file name
...       MOVE      TFILNAME,FNAMEY
.
          CALL      KLTM0000
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEY,CMDLINE
         APPEND    " 26 UC1-1,2-4,5-13,14-19 UC20-25,1-1,2-4,5-13,14-19",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPSXMA1,FNAMEY         * open file pointer
          OPEN      TMPSXMA2,FNAMEY
          RETURN
+
.*******************************************************************************
.         Kill misc item tempfile
.*******************************************************************************
KLTM0000  CLOSE     TMPSXMA1
          CLOSE     TMPSXMA2
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEY,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.*******************************************************************************
.         Create tempfile to store Win/Loss value for each procedure
.*******************************************************************************
CRWL0000  CALL      KLWL0000
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEQ,CMDLINE
          APPEND    " 30 UC1-1,2-7,8-16",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPWNLA1,FNAMEQ
          RETURN
+
.*******************************************************************************
.         Kill misc item tempfile
.*******************************************************************************
KLWL0000  CLOSE     TMPWNLA1
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEQ,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.*******************************************************************************
.         Write Items to temp file to sort by procedures
.*******************************************************************************
WRTM0000  OPEN      PMSMTIA4,"pmsmtiaf"
          OPEN      PMSMTIA5,"pmsmtiaf"
.
          PACK      KEY24,AADMNO,SP70
          BRANCH    PROGFLAG,WRTM0300,WRTM0300
.
          BRANCH    PRPATINV,WRTM0800        * Printing patient invoice
          GOTO      WRTM0400
.
.         Displaying invoice pinvflag=0 for All Invoice
.                            pinvflag=1 for Patient Invoice
.                            pinvflag=2 for Funder Invoice
.
WRTM0300  BRANCH    PINVFLAG,WRTM0800,WRTM0400
          PACK      KEY18,AADMNO,SP70
          GOTO      WRTM0800
.
WRTM0400  PACK      KEY24,AADMNO,EXPPAYER,SP70
WRTM0800  IF        PINVFLAG=0
            CALL      RSPMMTI4
          ELSE
            CALL      RSPMMTI5
          ENDIF
WRTM1000  IF        PINVFLAG=0
            CALL      RKPMMTI4
          ELSE
            CALL      RKPMMTI5
          ENDIF
          BRANCH    OVRCD,WRTM9999
.
          MATCH     DTADMNO,PMMIVISN
          GOTO      WRTM9999 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      WRTM1000 IF EQUAL      * Skip theatre charges
.
          BRANCH    PROGFLAG,WRTM1200,WRTM1200,WRTM1100,WRTM1100
          GOTO      WRTM1200
.
.         Check if we are currently printing patient or funder invoice
.
WRTM1100  BRANCH    PRPATINV,WRTM1220      * printing patient invoice
          GOTO      WRTM1240
.
WRTM1200  BRANCH    PINVFLAG,WRTM1220,WRTM1240
.
.         Display all items on the screen
.
          GOTO      WRTM1400
.
WRTM1220  MATCH     SP70,PMMICNTR
          GOTO      WRTM9999 IF NOT EQUAL  * Not for Patient Invoice
          GOTO      WRTM1400
.
WRTM1240  MATCH     EXPPAYER,PMMICNTR      * Same Contract/Health fund?
          GOTO      WRTM9999 IF NOT EQUAL
.
WRTM1400  MATCH     PMMITDAT,BACKDATE      * check with the Invoice Todate
          GOTO      WRTM1000 IF LESS
.
          PACK      KEY11,AADMNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
          IF        OVRCD=1
            MOVE      SP70,NZSPCPRC
            MOVE      SP70,NZSPPROC
            MOVE      SP70,NZSPPRIM
            MOVE      SP70,NZSPCLMN
          ENDIF
.
          COMPARE   ONE,CBFLAG
          GOTO      WRTM1500 IF NOT EQUAL
.
.         Do not include in Win and Loss calculation for the following items
.
          MATCH     "1",PMMIINCT             * Bill to patient
          IF        @EQUAL
            COMPARE   ONE,ERDTFLAG
            GOTO      WRTM1000 IF NOT EQUAL
.
            BRANCH    MULTCNTR,WRTM1500
            COMPARE   "1",NZSPPRIM
            GOTO      WRTM1500 IF NOT EQUAL  * not from primary procedure
          ENDIF
.
.         Check if item is not for Primary procedure and it's Extra to Contract
.
          MATCH     "2",PMMIINCT             * Extra to contract
          IF        @EQUAL
            COMPARE   ONE,ERDTFLAG
            GOTO      WRTM1000 IF NOT EQUAL
.
            BRANCH    MULTCNTR,WRTM1500
            COMPARE   "1",NZSPPRIM
            GOTO      WRTM1500 IF NOT EQUAL  * not from primary procedure
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "P",TCINDC7
            GOTO      WRTM1500 IF EQUAL
          ENDIF
.
          IF        MULTCNTR=0
            MATCH     PRIMFUND,PMMICNTR
            GOTO      WRTM1500 IF EQUAL
          ENDIF
.
          MATCH     "0",PMMIINCT             * include in contract
          IF        @EQUAL
            IF        MULTCNTR=0
              COMPARE   ONE,ERDTFLAG
              GOTO      WRTM1000 IF NOT EQUAL
            ENDIF
            GOTO      WRTM1500
          ENDIF
          GOTO      WRTM1000
.
WRTM1500  PACK      KEY22,PMVXMHOS,PMMIRTYP,PMMIMGRP,NZSPPROC,PMMITRAN,SP70
          CALL      WRTMMSX1
.
          GOTO      WRTM1000
.
WRTM9999  RETURN
+
.*******************************************************************************
.         Write to Win/Loss tempfile
.*******************************************************************************
WRWL0000  UNPACK    KEY15,KEY6,KEY9
          MATCH     SP70,KEY9
          GOTO      WRWL9999 IF EQUAL         * blank procedure code
.
          MOVE      SP70,D1
          MATCH     PRIMMBS,KEY9
          IF        !@EQUAL
            MOVE      ONE,D1                  * Not a primary procedure
          ENDIF
          PACK      KEY16,D1,KEY15
.
.         KEY1 : 1 = Contract, 2 = Bed fees, 3 = Theatre, 4= Misc.item
.
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,WRWL7000               * Contract
.
.         Bed Fees/Misc.Item/Theatre
.
          MULT      "-1",FORM12X2
          GOTO      WRWL7000
.
WRWL7000  CALL      RDTMWNL1
          BRANCH    OVRCD,WRWL8000
.
          ADD       FORM12X2,NZAMOUNT         * Amount
          CALL      UPTMWNL1
          GOTO      WRWL9999
.
WRWL8000  MOVE      D1,NZPRPRIM               * blank for Primary procedure
          MOVE      KEY6,NZPRCNTR             * Contract code
          MOVE      KEY9,NZPRCPRC             * Contract Procedure code
          MOVE      SP70,NZSPARES
          MOVE      FORM12X2,NZAMOUNT         * Amount
.
          PACK      KEY16,D1,KEY6,KEY9,SP70
          CALL      WRTMWNL1
.
WRWL9999  RETURN
+
.*******************************************************************************
.        I/O for Win/Loss tempfile
.*******************************************************************************
RKTMWNL1  MOVE      ZERO,OVRCD
          READKS    TMPWNLA1;NZPRPRIM,NZPRCNTR,NZPRCPRC:
                             NZAMOUNT,NZSPARES
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMWNL1  MOVE      ZERO,OVRCD
          READKP    TMPWNLA1;NZPRPRIM,NZPRCNTR,NZPRCPRC:
                             NZAMOUNT,NZSPARES
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTMWNL1  MOVE      ZERO,OVRCD
          READ      TMPWNLA1,KEY16;NZPRPRIM,NZPRCNTR,NZPRCPRC:
                             NZAMOUNT,NZSPARES
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMWNL1  MOVE      ZERO,OVRCD
          RESET     KEY16
          READ      TMPWNLA1,KEY16;;
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMWNL1  RESET     KEY16
          WRITE     TMPWNLA1,KEY16;NZPRPRIM,NZPRCNTR,NZPRCPRC:
                                   NZAMOUNT,NZSPARES
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTMWNL1  MOVE      ZERO,OVRCD
          UPDATE    TMPWNLA1;NZPRPRIM,NZPRCNTR,NZPRCPRC:
                             NZAMOUNT,NZSPARES
          RETURN
.
+
.*******************************************************************************
.        I/O for misc item tempfile
.*******************************************************************************
RKTMMSX1  MOVE      ZERO,OVRCD
          READKS    TMPSXMA1;PMMIRTYP,PMMIMGRP,NZSPPROC,PMMITRAN,PMMICNTR
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMMSX1  MOVE      ZERO,OVRCD
          RESET     KEY19
          READ      TMPSXMA1,KEY19;;
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMMSX1  RESET     KEY19
          WRITE     TMPSXMA1,KEY19;PMMIRTYP,PMMIMGRP,NZSPPROC,PMMITRAN,PMMICNTR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMMSX2  MOVE      ZERO,OVRCD
          READKS    TMPSXMA2;PMMIRTYP,PMMIMGRP,NZSPPROC,PMMITRAN,PMMICNTR
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMMSX2  MOVE      ZERO,OVRCD
          RESET     KEY25
          READ      TMPSXMA2,KEY25;;
          GOTO      OVERCOND IF OVER
          RETURN
.
.*******************************************************************************
.        Check if there is record in the Expected payer
.*******************************************************************************
          DEFPROC   EXPY0000
.
          INC       VISPAYFD/INC
.
          MOVE      ZERO,F2
          MOVE      ZERO,PRFACNTR        * Contract/funder for PRFA
.
          MOVE      ONE,F2
          WHILE     F2<=9
            MOVE      SP70,PRFACODE[F2]
            ADD       ONE,F2
          DO
.
          OPEN      VISPAYA1,"vispayaf"
          PACK      KEY17 WITH AADMNO,SP70
          CALL      RSNZSPR2
EXPY1000  CALL      RKNZSPR2
          BRANCH    OVRCD,EXPY9999
.
          MATCH     NZSPADMN,DAADMNO
          GOTO      EXPY9999 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND
          GOTO      EXPY1000 IF NOT EQUAL        * Not performed
.
          PACK      KEY14,AADMNO,NZSPCNTR,SP70
          CALL      RDVSPAY1
          COMPARE   ZERO,OVRCD
          GOTO      EXPY1000 IF EQUAL            * funder payer/NOT PRFA
.
.         Contract/Funder code for PRFA
.
          ADD       ONE,PRFACNTR
          MOVE      NZSPCNTR,PRFACODE[PRFACNTR]
          GOTO      EXPY1000
.
EXPY9999  GOTO      NEXPY999
.
          INC       VISPAYIO/INC
          INC       IBAOVRIO/INC
.
NEXPY999  ENDPROC
.
