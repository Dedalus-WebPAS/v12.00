.*******************************************************************************
.                                 OPWEBCAN
.    Cancel a operation booking 
.
.******************************************************************************
.    Modifications:
.    V12.00.02 31/07/2025  Ebon Clements  TSK 0964747
.              Fixed wattx1af read for ASA score
.    V12.00.01 29/05/2025  Bella Turco    TSK 0955096
.              Alphanumeric changes                                            
.    V11.03.03 10/08/2023  Nikitha B      TSK 0935669
.              Added WTEEMANU,WTEEPTWT,WTEESGID,WTEERADT,WTEETCMP at CLRWTESE 
.    V11.03.02 03/08/2023  Ebon Clements  TSK 0935730
.              Pack KEY22 before call to OPMVSBOK - CANDEA15 
.    V11.03.01 06/03/2023  Ebon Clements  TSK 0909393
.              Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
.    V11.02.01 22/08/2022  Jacob Jackson  TSK 0923405
.              Added TRAP for patunaaf write
.    V11.01.01 25/08/2021  Ebon Clements  TSK 0898459
.              Don't populate the bookings pre assessment date and time 
.              when cancelling a booking - CANREC25 - BKREPDAT, BKREPTIM
.    V10.15.01 11/02/2020  Jill Parkinson Task 0885010
.              Added write of 16 as well as 05 to watchaaf for  removals
.    V10.14.02 25/02/2019  Jill Parkinson Task 0870828
.              Added write of watchaaf type 05 for waiting list removals
.    V10.13.01 31/10/2018  Richa Phogat   TSK 0864240
.              Commented out clear of BKREATIM under CANREC25
.    V10.12.02 26/06/2018  Ebon Clements  TSK 0845295
.              Added update of eReferral WL booking number - ERVS0000
.    V10.12.01 02/05/2018  Jill Parkinson TSK 0848170 
.              Added write to watchaaf when cancelling wl booking
.    V10.11.01 09/08/2017  Ebon Clements   TSK 0843373
.              Check record exists prior to update of oprsesaf
.    V10.06.01 28/08/2015  Steve Armstrong CAR 311864   
.              Added trigger for DGCLICPA to cancel a pre-admission
.              associated with a theatre booking cancellation.
.-------------------------------------------------------------------------------
.    V10.05.01 15/08/2014  Jill Parkinson CAR 299980   
.              Mods to write to theatre audit 
.-------------------------------------------------------------------------------
.    V10.03.02 25/11/2013  Ebon Clements     CAR 293746
.              Added write of cancel pre admission patunaaf record - CPUNA000
.    V10.03.01 17/07/2012  Peter Vela        CAR 263394
.              Clear PMVXPOWD and PMVXPOBD on Theatre Cancel
.-------------------------------------------------------------------------------
.    V10.02.03 21/10/2011  Jill Parkinson CAR 253673    
.              Removed delete of pmsvx1af when cancelling     
.    V10.02.02 13/07/2011  Steve Armstrong   CAR 240722
.              Further mods to cater for second given name as
.              part of PATGSRFD keys
.    V10.02.01 22/06/2011  Steve Armstrong   CAR 240722
.              Mods to cater for changes to PATGSRFD:
.                   - GSRSNAM & GSRGNAM extended to 30 chars.
.                   - PTGSGNM2 added.
.                   - all indexes changed in length.
.-------------------------------------------------------------------------------
.    V10.00.01   19/03/2010  Steve Armstrong   CAR 135505
.                Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
.    V9.10.03    03/09/2008  Davin         CAR 147323
.                Send hl7 message for cancel bookings (added call DGCLIS15)
.    V9.10.02    13/08/2008  Jill Habasque CAR 175727
.                Mods to only update WTENEVDT if after bkreedat in UPESCN00
.    V9.10.01    01/05/2008  Jill Habasque CAR 166097
.                Mods to populate WTHIASSR
.    V9.09.03    23/01/2008  Jill Habasque CAR 159264
.                Added SAVEPREV in WESE0000 to stop wteeprev getting cleared
.    V9.09.02    07/11/2007  Jill Habasque CAR 152619
.                Added UPESCN00
.    V9.09.01    22/08/2007  Jill Habasque CAR 148317
.                Added calls to GETSET00
.    V9.05.B01   31/01/2006  Peter Vela    CAR 89644
.                Added updates to BKRXLUPD,BKRXLUPT,BKRXWEBU at CANREC25
.    V9.04.09    29/11/2005  Ebon Clements CAR 86062
.                Set manually added record to no for esis episode file
.    V9.04.08    28/11/2005  Jill Habasque CAR 86409
.                Added update of WTEEADAT with WMDATE4 in WESE0000
.    V9.04.07    23/09/2005  Peter Vela    CAR 76782
.                Enabled update of theatre booking cancellation date CANDEA10
.    V9.04.06    20/09/2005  Jill Habasque CAR 76240
.                Added WESE0000
.    V9.04.05    15/09/2005  Jill Habasque CAR 70497
.                Added GETDAT00
.    V9.04.04    07/09/2005  Jill Habasque CAR 71547
.                Fixed event dates for ESIS cancellations             
.    V9.04.03    16/08/2005  Jill Habasque CAR 70633
.                Added check for WL patient before calling WSAD0000
.    V9.04.02    19/01/2005  Jill Habasque CAR 56541
.                Added check for Z70 in patcanad
.    V9.04.01    08/11/2004  Lina Vo       SRF 54900 
.                Moved check for ADJSTART flag to OPMVSBOK so case numbers
.                are still resequenced.
.    V9.03.02    30/09/2003  Jill Habasque SRF 42868 
.                Fixed cancellation of bokrc1af
.                SRF 42939 - Added read of oprdetaf after OPMVSBOK
.    V9.03.01    06/05/2003  Jill Habasque SRF 37661 
.                Added delete of patvisaf when cancelling preadmission
.    V9.02.15    07/04/2003  Jill Habasque SRF 37850 
.                Added write to watrtdaf  
.    V9.02.14    03/02/2003  Jill Habasque SRF 34660 
.                Changed to call WRTHIS00
.    V9.02.13    13/12/2002  Sylvek Litewka SRF 34523
.                Added processing for CPADM008 (Waiting List Removal Date)
.    V9.02.12    13/11/2002  Jill Habasque SRF 23893
.                Commented out clear of BKREEDAT and BKREADAT
.    V9.02.11    18/05/2002  J.Tan              
.                Commented out check for oprdetc file 
.    V9.02.10    19/04/2002  Jill Habasque  3573
.                Commented out check for tcindc1=D and fixed check for DESURN00
.    V9.02.09    09/04/2002  Ashwin
.                Change waiting list status if BKRESTAT is booked
.    V9.02.08    14/03/2002  Ashwin
.                Proposed Admn date not to be cleared while cancelling
.    V9.02.07    06/02/2002  Ebon Clements 
.                Clear Expected assesment time in cancel booking 
.    V9.02.06    13/12/2001  Ebon Clements 
.                Clear Procedure date when booking is cancelled BKREADAT
.                Clear Due date when booking is cancelled BKREEDAT
.    V9.02.05    30/10/2001  Ashwin
.                Clear Scheduled admission date when booking cancelled
.    V9.02.04    04/10/2001  Ashwin - HPS
.                Fixed to update WATTR1 as Unscheduled when theatre
.                Booking cancelled
.    V9.02.03    14/09/2001  Mike Laming   RCH/SVHM
.                Activate Datagate API (see below V9.02.01)
.    V9.02.02    09/09/2001  Sandra Barcham
.                Add DOB & SEX to patgsurf
.    V9.02.01    03/09/2001  Mike Laming
.                Add Datagate API Cancel Booking (DGCLICCB)                 
.    V.10.B01    Glenn Saunders
.                Remove processing relating to PATSUR/patsurnf (s/name file)
.                Add processing which was missing (bug) to update PATSGR.
.
.******************************************************************************
.**********************************************************************
.*  DEAREC00  :  Delete booking from all files?                       *
.**********************************************************************
.DEAREC00  MOVE      ZERO,EXIT
.         MATCH     ANSD,TCINDC1            * 1st indicator 'D' ?
.         GOTO      DEAREC99 IF NOT EQUAL
.
.. delete all traces of this booking
..
.          PACK      KEY23,CURSESS,ZERO,CURCASE
.          CALL      RDOPDEA1                * get existing data
.          BRANCH    OVRCD,DEAREC99
.          MOVE      TWO,AUDIFLAG            * before change audit
.          CALL      AUDEA000                * write audit
.          CALL      DEOPDEA1                * cancel operation record
.          MOVE      FOUR,AUDIFLAG           * delete audit
.          CALL      AUDEA000                * write audit
..
. delete from oprdebaf
..
..          PACK      KEY11,OPDAUNIQ,SP20
.          CALL      RSOPDEB1
.DEAREC10  CALL      RKOPDEB1
.          BRANCH    OVRCD,DEAREC20
..
.          MATCH     OPDAUNIQ,OPDBUNIQ
.          GOTO      DEAREC20 IF NOT EQUAL
..
.          PACK      KEY11,OPDBUNIQ,OPDBTEAM
.          CALL      DEOPDEB1
.          MOVE      FOUR,AUDIFLAG           * delete audit
.          CALL      AUDEB000                * write audit
.          PACK      KEY11,OPDBUNIQ,OPDBTEAM
.          CALL      RSOPDEB1
.          GOTO      DEAREC10
..
.. delete from oprdecaf
...
.DEAREC20  PACK      KEY11,OPDAUNIQ,SP20
.          CALL      RSOPDEC1
.DEAREC25  CALL      RKOPDEC1
..          BRANCH    OVRCD,DEAREC30
..
.          MATCH     OPDAUNIQ,OPDCUNIQ
.          GOTO      DEAREC30 IF NOT EQUAL
..
.          PACK      KEY11,OPDCUNIQ,OPDCTEAM
.          CALL      DEOPDEC1
.          MOVE      FOUR,AUDIFLAG           * delete audit
.          CALL      AUDEC000                * write audit
.          PACK      KEY11,OPDCUNIQ,OPDCTEAM
.          CALL      RSOPDEC1
.          GOTO      DEAREC25
..
..    After cancelling a booking the session durations and start times must
..    be updated.  Also release suspended sessions.
..
.DEAREC30  PACK      KEY19,CURSESS,SP20
.          CALL      RDOPSES1                * get session details
.          MOVE      TWO,AUDIFLAG            * before change audit
.          CALL      AUSES000                * write audit
.          SUB       OPDAEXPD,OPSETIMB       * subtract patient operation durat'n
.          SUB       OPSEPREP,OPSETIMB       * subtract patient prep time
.          CALL      UPOPSES1
.          MOVE      THREE,AUDIFLAG          * after change audit
.          CALL      AUSES000                * write audit
..
.          COMPARE   ONE,OPSESUSP            * test if session was suspended
.          GOTO      DEAREC40 IF NOT EQUAL
.          CALL      OPCHKFUL                * check if session is still full
.          COMPARE   ONE,EXIT                * exit=1 if session not full
.          GOTO      DEAREC40 IF NOT EQUAL
.          CALL      OPUNSPND                * un-suspend session
..
..    Adjust the case numbers and start times by calling OPMVSBOK if a cases
..    exist after the cancelled case.
..
.DEAREC40  MOVE      CURCASE,FORM3
.          ADD       ONE,FORM3
.          PACK      KEY23,CURSESS,ZERO,FORM3
.          CALL      RDOPDEA1                * get session details
.          BRANCH    OVRCD,DEAREC90
..
.          PACK      KEY19,CURSESS,SP20
.          MOVE      CURCASE,CASETO          * set parameters for OPMVSBOK to
.          MOVE      CURCASE,CASEFROM          cancel
.          CALL      OPMVSBOK                * read just casenum and start times
..
.DEAREC90  MOVE      ONE,EXIT
..
.DEAREC99  RETURN
.*********************************************************************
.*                  CANREC00                    Called by : POSCAN20 *
.*        When cancel a booking, see if want to cancel admission bk. *
.*        Para's  : SAVADMN       the admission number               *
.*********************************************************************
CANREC00  MATCH     Z70,PATCANAD
          GOTO      CANREC99 IF EQUAL
.
          MATCH     SP70,PATCANAD
          GOTO      CANREC99 IF EQUAL
.
          MOVE      ZERO,EXIT
          MOVE      SAVADMN,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,CANREC99          * no booking record
          COMPARE   ZERO,BKRESTAT
          GOTO      CANREC25 IF EQUAL
.         MATCH     "1",CANADMIS            * Cancel Admission
.         GOTO      CANREC99 IF NOT EQUAL
.
          MOVE      SAVADMN,KEY8  
          CALL      RDMISS1
          BRANCH    OVRCD,CANREC25
.
.         COMPARE   TWO,ASTAT 
.         IF        @EQUAL
.           MOVE     "Current Admission, Cannot Cancel Admission. ",WEBTITLE
.           CALL     WEBERR00
.           GOTO     CANREC90
.         ENDIF
.
.         COMPARE   THREE,ASTAT 
.         IF        @EQUAL
.           MOVE     "Patient Discharged, Cannot Cancel Admission. ",WEBTITLE
.           CALL     WEBERR00
.           GOTO     CANREC90
.         ENDIF
.
.         COMPARE   FOUR,ASTAT 
.         IF        @EQUAL
.           MOVE     "Patient On Leave, Cannot Cancel Admission. ",WEBTITLE
.           CALL     WEBERR00
.           GOTO     CANREC90
.         ENDIF
.
.         Check if this patient has any deposits
.
.         OPEN      PATCASH1,"patcashf"
.         PACK      KEY9,AADMNO,SP3
.         CALL      RDSCASH1
.         CALL      RDKCASH1
.         CLOSE     PATCASH1
.         BRANCH    OVRCD,CANREC25
.         MATCH     CSHADMN,AADMNO
.         IF        @EQUAL
.           MOVE     "Patient has a Deposit, Cannot Cancel Admission. ",WEBTITLE
.           CALL     WEBERR00
.           GOTO     CANREC90
.         ENDIF
.
CANREC25  MOVE      PATCANAD,BKRECANC
          MOVE      TWO,BKRESTAT            * set status
.         MOVE      SP70,BKREADAT           * Clear expected procedure date
.         MOVE      SP70,BKREEDAT           * Clear expected due date
.         MOVE      SP70,BKREATIM           * Clear expected assesment time
          CALL      UPBKREC1                * update booking record
.
          MOVE      ONE,HL7TRGID
          MOVE      "OPWEBCAN",HL7INCLD
          PROC      DGCLICCB                * DG API Cancel Booking    *I-90201
.
          MOVE      SAVADMN,KEY8
          CALL      RDBKRX11
          IF        OVRCD=0
            CALL      IBACLOCK
            PACK      BKRXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",BKRXLUPD
            CLOCK     TIME,BKRXLUPT
            MOVE      WBSEUID,BKRXWEBU
            CALL      UPBKRX11
          ENDIF
.
.         update patmi1af
.
          MATCH     "Y",PREAD002
          GOTO      CANREC28 IF NOT EQUAL
.
          MOVE      SAVADMN,KEY8  
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      FIVE,ASTAT
            MOVE      PREAD003,ACANCEL
            CALL      UPMISS1
.
.           Get PMI and Visit details for HL7 Cancel Pre-admission message (A27)
.           (CAR 311864)
.
            MOVE      AURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,CANREC26
.
            CALL      CLPMSPX2
            MOVE      AURNO,KEY8
            CALL      RDPMPX21
.
            CALL      CLPMSVX1
            MOVE      AADMNO,KEY8
            CALL      RDPMVX11
.
            CALL      CLPATDSC
            CALL      CLPATRE1
.
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THREE,HL7TRGID
            MOVE      "OPWEBCAN",HL7INCLD
            PROC      DGCLICPA              * DG API Cancel Pre-Admiss (311864)
.
. delete record from the Visit file as the U/R Number exist
.
CANREC26    MOVE      PURNO,PVIURNO
            PACK      PVIDATE,ADATE
            REP       " 0",PVIDATE
            MOVE      AADMNO,PVIBILL
.
            MOVE      PVIBILL,KEY8
.....       CALL      DEVISA1
.
            PACK      KEY8,AADMNO,SP70
            CALL      RAPMVX11
            BRANCH    OVRCD,CANREC30
.....       CALL      DEPMVX11
.
            CALL      CPUNA000              * Write cancel pre adm record
          ENDIF
.
CANREC28  PACK      KEY8,SAVADMN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CANREC30
.
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
.
          CALL      UPPMVX11
.
. HPS Code starts here - Update WATTR1 if it is waiting list booking
.
CANREC30  MATCH     SP70,OPDAPROC
          GOTO      CANREC40 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CANREC40
          CALL      SAVHIS00                * write to Waiting List History
          MOVE      "05",WTWMBSCD
          MOVE      ONE,NBRFLAG
.
          MATCH     "Y",CPADM002
          IF        @EQUAL
            CALL      WRCHJ000           * write wl cancel booking
            MOVE      "1",WMSTAT
            CALL      GENBOKNO           * generate booking number
            CALL      ERVV0000           * Update eReferral
          ELSE
            CALL      WRCHJ000           * write wl cancel booking
            MOVE      CPADM003,WMREMOVE
            MOVE      CPADM008,WMDATE4
            MOVE      "6",WMSTAT
            MOVE      "20",WTWMBSCD
            CALL      WRCHR000           * write removal from wl
          ENDIF
.
          CALL      UPTREA1
          CALL      WESE0000
.
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
          REP       " 0",WTENEVDT
          PACK      WTENEVAL,OPDACANC,SP70
          MOVE      ANSP,WTENETYP
          PACK      WTENSADI,OPDAUNIQ,SP70
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          PACK      WTENEVAL,OPDACANC,SP70
          PACK      KEY5,ANSS,ANSC,OPDACANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        !@EQUAL
              IF        UPCANBOK<>1
                CALL      WSAD0000
              ENDIF
            ENDIF
          ELSE
            IF        UPCANBOK<>1
              CALL      WSAD0000
            ENDIF
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF         OVRCD=1
            MOVE      SP70,WTRTREFR
            MOVE      SP70,WTRTTDES
          ENDIF
.
          UNPACK    KEY19,WTRTURNO,WTRTPROC,WTRTPCNT
          MATCH     Z70,CPADM004
          IF        !@EQUAL
            MATCH     SP70,CPADM004
            IF        !@EQUAL
              MOVE      CPADM004,WTRTTDES
            ENDIF
          ENDIF
          PACK      WTRTSPAR,SP70
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RAWTRTD1
          IF        OVRCD=1
            CALL      WRWTRTD1       * referral & transfer destination
          ELSE
            CALL      UPWTRTD1
          ENDIF
.
          MOVE      BKRECANC,SAVEBCAN
          CALL      WRTHIS00                * write to Waiting List History
.         CALL      WLHIS000
.
. HPS Code Ends here
.
.         If zero U/R booking, delete record from the Surname file
.
CANREC40  MATCH     "       0",PURNO
          IF        @EQUAL
            CALL      DESURN00
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      CANREC99
CANREC90  MOVE      ONE,EXIT
CANREC99  RETURN
.
.*********************************************************************
. Write Field Change Audit for Cancel Booking
.------------------------------------------------------------
WRCHJ000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          MOVE      "16",WTCHUPTY
          MOVE      BKRECANC,WTCHREAS
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,BKREEDAT,BKREATIM,SP70
          MOVE      SP70,WTCHCVAL
.
WRCHJ200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHJ999  RETURN
.
.*********************************************************************
. Write Field Change Audit for Remove from wl
.------------------------------------------------------------
WRCHR000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          MOVE      "05",WTCHUPTY
          MOVE      WMREMOVE,WTCHREAS
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,BKREEDAT,BKREATIM,SP70
          MOVE      SP70,WTCHCVAL
.
WRCHR200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHR999  RETURN
.
.*********************************************************************
. Write a cancel pre admission records to patunaaf
.*********************************************************************
CPUNA000  MOVE      "5",PTUNTYPE
          MOVE      ADATE,PTUNODTE
          MOVE      SP70,PTUNHOSP
          MOVE      SP70,PTUNOPRD
.
          MOVE      AADMNO,PTUNADMN
          CALL      IBACLOCK
          PACK      PTUNDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTUNDATE
          MOVE      CTIMEIS,PTUNTIME
          REP       " 0",PTUNTIME
          MOVE      USERID,PTUNAUID
          PACK      PTUNCANC,PREAD003,SP70
.
          MOVE      SP70,PTUNOTTM
          MOVE      ZERO,PTUNSENT
          MOVE      SP70,PTUNDTYP           * Discharge status
.
          PACK      KEY25,PTUNADMN,PTUNDATE,PTUNTIME,PTUNTYPE,SP70
          CALL      RDAUNAA1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRUNAA1
            TRAPCLR   IO
          ENDIF
.
CPUNA999  RETURN
.
WLHIS000  PACK      KEY8,CCC,CYY,CMM,CDD,SP10
          REP       " 0",KEY8
          PACK      KEY31,WMURNO,WMCODE,WMCNT,KEY8,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,WLHIS100
          PACK      WTHIADTE,SP70
          PACK      WTHIADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTHIADTE
          MATCH     WMURNO,WTHIURNO
          GOTO      WLHIS100 IF NOT EQUAL
          MATCH     WMCODE,WTHIPROC
          GOTO      WLHIS100 IF NOT EQUAL
          COMPARE   WMCNT,WTHIPCNT
          GOTO      WLHIS100 IF NOT EQUAL
          MATCH     KEY8,WTHIEDAT
          GOTO      WLHIS100 IF NOT EQUAL
          ADD       ONE,WTHIUCNT
          GOTO      WLHIS200
.
WLHIS100  MOVE      WMURNO,WTHIURNO
          MOVE      WMCODE,WTHIPROC
          MOVE      WMCNT,WTHIPCNT
          PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",WTHIEDAT
          PACK      WTHIRCDT,SP8
          MOVE      ONE,WTHIUCNT
WLHIS200  MOVE      WBSEUID,WTHIWEBI
          MOVE      CTIMEIS,WTHIETIM
          MOVE      WMPTY,WTHIPRIO
          MOVE      WTWMRANK,WTHIRANK
          MOVE      WTWMDTAD,WTHIDCGV
          MOVE      WMDATE2,WTHIDAT2
          MOVE      WMDATE3,WTHIDAT3
          MOVE      WTWMASSR,WTHIASSR
          MOVE      "30",WTHIBSCD
          MOVE      BKRECANC,WTHIBCAN
.
          PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP20
          CALL      RAWTHIS1
          IF        OVRCD=1
            CALL      WRWTHIS1
          ENDIF
          RETURN
.******************************************************************************
.*                           DESURN00                    Called by : CANREC00 *
.*            DElete record from SURName file                                 *
.******************************************************************************
.
DESURN00  OPEN      PATGSRN1,"patgsrnf"
          MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          PACK      KEY115,PURNO,SAVADMN,GSRSNAM,GSRGNAM,PTGSGNM2,PBDATE,PSEX:
                           SP70,SP70
          CALL      RAPTGSR1
          BRANCH    OVRCD,DESURN99
          CALL      DEPTGSR1
.
DESURN99  RETURN
+
.******************************************************************************
.                                 CANDEA00
.    Cancel a operation booking.
.    CURSESS : current session date time clinic/doctor
.    CURCASE : cancel case number
.******************************************************************************
.    Get last cancelled case number
.
CANDEA00  MOVE      OPDAUNIQ,SAVUNIQ
          MOVE      ONE,FORM3               * set cancelled casenum to first
          PACK      KEY26,CURSESS,THREE,Z70
          CALL      RSOPDEA1                * position form pointer
          CALL      RPOPDEA1                * get last cancelled case no. in
          BRANCH    OVRCD,CANDEA10            session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          MATCH     KEY22,CURSESS           * test same session 
          GOTO      CANDEA10 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT          * test for cancelled status
          GOTO      CANDEA10 IF NOT EQUAL
          MOVE      OPDACASE,FORM3
          ADD       ONE,FORM3               * set next cancelled casenum
.
CANDEA10  PACK      KEY26,CURSESS,CURSTAT,CURCASE
          CALL      RDOPDEA1                * get existing data
          BRANCH    OVRCD,CANDEA90
.
          MOVE      TWO,AUDIFLAG            * before change audit
          CALL      AUDEA000                * write audit
          MOVE      FORM3,OPDACASE          * set cancelled casenum
          MOVE      REPLY,OPDACANC          * set cancellation code
          MOVE      THREE,OPDASTAT          * set cancelled status
          MOVE      DIM8,OPDACDAT           * set cancellation date
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1                * cancel operation record
          MOVE      "003",TADTTYPE
          PROC      OPTHETAT                * write to theatre audit
.
          MOVE      THREE,AUDIFLAG          * after change audit
.
          MOVE      TWO,HL7TRGID
          MOVE      "OPWEBCAN",HL7INCLD
          PROC      DGCLIS15                * send cancel booking message
.
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode
          REP       " 0",WTENEVDT
          MATCH     SP70,OPDAPROC
          GOTO      CANDEA15 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CANDEA15
          COMPARE   ONE,UPCANBOK
          IF        @EQUAL
            CALL      GETDAT00
          ENDIF
          PACK      WTENEVAL,OPDACANC,SP70
          MOVE      ANSP,WTENETYP
          PACK      WTENSADI,OPDAUNIQ,SP70
          CALL      IBACLOCK
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          PACK      WTENEVAL,OPDACANC,SP70
          PACK      KEY5,ANSS,ANSC,OPDACANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        @EQUAL
              CALL      GETSET00
              GOTO      CANDEA15
            ENDIF
          ENDIF
          IF        UPCANBOK=1
            CALL      UPESCN00
          ELSE
            CALL      WSAD0000
          ENDIF
.
CANDEA15  CALL      AUDEA000                * write audit
.
.    After cancelling a booking the session durations and start times must
.    be updated.  Also release suspended sessions.
.
          PACK      KEY22,CURSESS,SP20
          CALL      RDOPSES1                * get session details
          IF        OVRCD=0
            MOVE      TWO,AUDIFLAG          * before change audit
            CALL      AUSES000              * write audit
            SUB       OPDAEXPD,OPSETIMB     * subtract patient operation durat'n
            SUB       OPSEPREP,OPSETIMB     * subtract patient prep time
            CALL      UPOPSES1
            MOVE      THREE,AUDIFLAG        * after change audit
            CALL      AUSES000              * write audit
          ENDIF
.
          COMPARE   ONE,OPSESUSP            * test if session was suspended
          GOTO      CANDEA20 IF NOT EQUAL
          CALL      OPCHKFUL                * check if session is still full
          COMPARE   ONE,EXIT                * exit=1 if session not full
          GOTO      CANDEA20 IF NOT EQUAL
          CALL      OPUNSPND                * un-suspend session
.
.    Adjust the case numbers and start times by calling OPMVSBOK if a cases
.    exist after the cancelled case.
.
CANDEA20  
.
.         Moved check to OPMVSBOK to skip Start time Adjustment but still
.         do Case number Adjustments.
..          COMPARE   ONE,ADJSTART
..          GOTO      CANDEA80 IF NOT EQUAL
.
          MOVE      CURCASE,FORM3
          ADD       ONE,FORM3
          PACK      KEY26,CURSESS,FORM3,SP70
          CALL      RSOPDEA5                * get session details
          CALL      RKOPDEA5                * get session details
          BRANCH    OVRCD,CANDEA80
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          MATCH     KEY22,CURSESS           * test same session
          GOTO      CANDEA80 IF NOT EQUAL
.
          MOVE      FORM3,DIM3
          MATCH     DIM3,OPDACASE 
          GOTO      CANDEA80 IF NOT EQUAL
.
          PACK      KEY22,CURSESS,SP20      * parameter to OPMVSBOK
          MOVE      CURCASE,CASETO          * set parameters for OPMVSBOK to
          MOVE      CURCASE,CASEFROM          cancel
          CALL      OPMVSBOK                * read just case no. & start times
          PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,CANDEA90
.
CANDEA80  MOVE      ZERO,EXIT
          GOTO      CANDEA99
.
CANDEA90  MOVE      ONE,EXIT
.
CANDEA99  PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          RETURN
. ------------------------
. ------- OPRDEBFD -------
. ------------------------
.
AUDEB000  BRANCH    OPCNAUDD,AUDEB999 
.
          PACK      TDESC,KEY19,SP1      * save key19 on entry
.
          COMPARE   FIVE,AUDIFLAG        * test to delete B audit
          GOTO      AUDEB600 IF EQUAL
.
          COMPARE   THREE,AUDIFLAG       * is it an after change audit?
          GOTO      AUDEB100 IF EQUAL    * Yes. So don't change time
.
          CALL      IBACLOCK             * get current date
          PACK      OPDBAUDD,CCC,CYY,CMM,CDD
          REP       " 0",OPDBAUDD
          MOVE      CTIMEIS,OPDBAUDT     * clock current time
.
AUDEB100  MOVE      ONE,OPDBAUDS         * not printed[
          MOVE      PASSCODE,OPDBAUDO    * get user id
          MOVE      PORT,OPDBAUDP        * get port number
.
          MOVE      AUDIFLAG,OPDBAUDR
          REPLACE   "1A2B3C4D",OPDBAUDR
          PACK      KEY19,OPDBAUDD,OPDBAUDT,OPDBAUDP,OPDBAUDR
          CALL      AWOPDEB              * write audit record
          GOTO      AUDEB995
.
.         now delete B audit
.
AUDEB600  PACK      KEY19,OPDBAUDD,OPDBAUDT,OPDBAUDP,ANSB
          CALL      ADOPDEB              * delete audit record
.
AUDEB995  UNPACK    TDESC,KEY19,ANS      * restore the key19
.
AUDEB999  RETURN
.
. ------------------------
. ------- OPRDECFD -------
.. ------------------------
..
.AUDEC000  BRANCH    OPCNAUDF,AUDEC999 
..
.          PACK      TDESC,KEY19,SP1      * save key19 on entry
..
.          COMPARE   FIVE,AUDIFLAG        * test to delete B audit
.          GOTO      AUDEC600 IF EQUAL
..
.          COMPARE   THREE,AUDIFLAG       * is it an after change audit?
.          GOTO      AUDEC100 IF EQUAL    * Yes. So don't change time
.
.          CALL      IBACLOCK             * get current date
.          PACK      OPDCAUDD,CCC,CYY,CMM,CDD
.          REP       " 0",OPDCAUDD
.          MOVE      CTIMEIS,OPDCAUDT     * clock current time
..
.AUDEC100  MOVE      ONE,OPDCAUDS         * not printed
.          MOVE      PASSCODE,OPDCAUDO    * get user id
.          MOVE      PORT,OPDCAUDP        * get port number
..
.          MOVE      AUDIFLAG,OPDCAUDR
.          REPLACE   "1A2B3C4D",OPDCAUDR
.          PACK      KEY19,OPDCAUDD,OPDCAUDT,OPDCAUDP,OPDCAUDR
.          CALL      AWOPDEC              * write audit record
.          GOTO      AUDEC995
..
..         now delete B audit
..
.AUDEC600  PACK      KEY19,OPDCAUDD,OPDCAUDT,OPDCAUDP,ANSB
.          CALL      ADOPDEC              * delete audit record
..
.AUDEC995  UNPACK    TDESC,KEY19,ANS      * restore the key19
.
.AUDEC999  RETURN
.
GETDAT00  OPEN      WATESNA1,"watesnaf"
          PACK      KEY36,WTWMECNT,ANSP,Z70
          CALL      RSWTESN1
GETDAT10  CALL      RPWTESN1
          BRANCH    OVRCD,GETDAT90
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      GETDAT90 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP
          GOTO      GETDAT90 IF NOT EQUAL
.
          MATCH     WTENSADI,OPDAUNIQ
          GOTO      GETDAT10 IF NOT EQUAL
          GOTO      GETDAT99
.
GETDAT90  MOVE      SP70,WTENEVDT
.
GETDAT99  RETURN
+
.******************************************************************************
.*                                 WESE0000                                   *
.*                Write/update wateseaf (episode details)                     *
.******************************************************************************
WESE0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS 
.         
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.         
          MOVE      SP70,SAVEPREV
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,WESE1000
.         
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      WESE1000 IF NOT EQUAL
.
          MOVE      WTEEPREV,SAVEPREV
          CALL      CHKESE00
          BRANCH    EXIT,WESE1000   * no changes
          GOTO      WESE2000
.
WESE1000  CALL      CLRWTESE
.
WESE2000  PACK      WTEEUNIQ,WTWMECNT,SP70
          PACK      WTEEEDAT,SP70
          PACK      WTEEURNO,WMURNO,SP70
.
          PACK      WTEEDEST,SP70
.
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      WTEESREF,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD<>1
            PACK      WTEEDEST,WTRTTDES,SP70
          ENDIF
          IF        WTCNUSXB=0
            UNPACK    WMSTAY,DIM2,WTEEPLOS
          ELSE
            PACK      WTEEPLOS,WTTXIDYC,SP70
          ENDIF
.
          COMPARE   SIX,WMSTAT
          GOTO      WESE3000 IF NOT EQUAL
.
          PACK      KEY5,ANSW,ANSR,WMREMOVE
          CALL      RDCODE1               * Read a codes file record
          BRANCH    OVRCD,WESE3000
.
          MATCH     ANSX,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSS,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSM,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSW,TCINDC3
          GOTO      WESE2500 IF EQUAL
          GOTO      WESE3000
.
WESE2400  PACK      WTEEADAT,WMDATE4 
WESE2500  PACK      WTEEINSD,WTTXCTYP
.
WESE3000  PACK      WTEEPROC,WMCODE,SP70
          PACK      WTEEPDES,WMDESC,SP70
          PACK      WTEERREM,WMREMOVE,SP70
          PACK      WTEERDAT,WMDATE1,SP70
          REP       " 0",WTEERDAT
          PACK      WTEEREMD,WMDATE4,SP70
          MATCH     SP70,WTEEADAT
          IF        !@EQUAL
            MOVE      WTEEADAT,WTEEREMD
          ENDIF
          PACK      WTEEARDT,WMKEYDT,SP70
          REP       " 0",WTEEARDT
          PACK      WTEEPREV,SAVEPREV,SP70
          PACK      WTEEREFR,SP70
          PACK      WTEESSPC,WMUNIT,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          MOVE      ZERO,WTEEMANU
          MOVE      ZERO,WTEEMANU
          PACK      WTEEASAS,SP70
.
          CALL      CLWATTX1
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
WESE3100  CALL      RDWTTX11
          BRANCH    OVRCD,WESE3500
.
          MOVE      WTTXASAS,WTEEASAS
.
WESE3500  PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          IF        OVRCD=0
            PACK      WTEEWEBU,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEEUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEEUDAT
            CLOCK     TIME,WTEEUTIM
            REP       " 0",WTEEUTIM
            CALL      UPWTESE1
          ELSE
            PACK      WTEEWEBC,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEECDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEECDAT
            CLOCK     TIME,WTEECTIM
            REP       " 0",WTEECTIM
            CALL      WRWTESE1
          ENDIF
.
WESE9999  RETURN
+
.******************************************************************************
.*                                 CHKESE00                                   *
.*                Check if any wateseaf details have changed                  *
.******************************************************************************
CHKESE00  MOVE      ZERO,EXIT
.
          MATCH     WTEEURNO,WMURNO
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEDEST,WTRTTDES
          GOTO      CHKESE90 IF NOT EQUAL
.
          IF        WTCNUSXB=0
            MOVE      WTEEPLOS,F3
            COMPARE   F3,WMSTAY
            GOTO      CHKESE90 IF NOT EQUAL
          ELSE
            MATCH     WTTXIDYC,WTEEPLOS
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.
          MATCH     WTEEPROC,WMCODE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEPDES,WMDESC
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEERREM,WMREMOVE
          GOTO      CHKESE90 IF NOT EQUAL
.
          IF        WMSTAT=6
            MATCH     WTEEINSD,WTTXCTYP
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.
          MATCH     WTEERDAT,WMDATE1
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEREMD,WMDATE4
          GOTO      CHKESE90 IF NOT EQUAL
.
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      CODE,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          MATCH     WTEESREF,CODE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEESSPC,WMUNIT
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEREFR,WTRTREFR
          GOTO      CHKESE90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESE90  GOTO      CHKESE99
.
CHKESE99  RETURN
.
CLRWTESE  PACK      WTEEUNIQ,SP70
          PACK      WTEEURNO,SP70
          PACK      WTEEADAT,SP70
          PACK      WTEEDEST,SP70
          PACK      WTEEINSD,SP70
          PACK      WTEEPLOS,SP70
          PACK      WTEEPROC,SP70
          PACK      WTEEPDES,SP70
          PACK      WTEERREM,SP70
          PACK      WTEERDAT,SP70
          PACK      WTEEREMD,SP70
          PACK      WTEESREF,SP70
          PACK      WTEESSPC,SP70
          PACK      WTEEWEBC,SP70
          PACK      WTEECDAT,SP70
          PACK      WTEECTIM,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          PACK      WTEEARDT,SP70
          PACK      WTEESPAR,SP70
          PACK      WTEEMANU,SP70
          PACK      WTEEPTWT,SP70
          PACK      WTEESGID,SP70
          PACK      WTEERADT,SP70
          PACK      WTEETCMP,SP70
.
          RETURN
.******************************************************************************
.*                                 GETSET00                                   *
.*     Write delete for watesnaf if cancelling without informing the patient  *
.******************************************************************************
GETSET00  PACK      KEY36,WTWMECNT,ANSS,OPDAUNIQ,SP70
          CALL      RSWTESN5
          CALL      RKWTESN5
          BRANCH    OVRCD,GETSET50
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      GETSET50 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP
          GOTO      GETSET50 IF NOT EQUAL
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      GETSET50 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          IF        @EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
            CALL      DEWTESN5
            GOTO      GETSET50
          ENDIF
.
          MOVE      DELESN,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,USERID
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
. *** remove previous postponement record if required ***
GETSET50  PACK      KEY36,WTWMECNT,ANSP,OPDAUNIQ,SP70
          CALL      RSWTESN5
          CALL      RKWTESN5
          BRANCH    OVRCD,GETSET99
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          IF        @EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
            CALL      DEWTESN5
            GOTO      GETSET99
          ENDIF
.
          MOVE      DELESN,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,USERID
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
GETSET99  RETURN
+
.*****************************************************************************
.*        Update ESIS details when updating cancellation                     *
.*****************************************************************************
UPESCN00  COMPARE   ONE,UPCANBOK
          GOTO      UPESCN99 IF NOT EQUAL
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      UPESCN99 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROC
          GOTO      UPESCN99 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UPESCN99
.
.*** check for a set SAD that has not been sent and update with new SAD ***
.
          PACK      KEY36,WTWMECNT,ANSP,OPDAUNIQ,SP70
          CALL      RSWTESN5
UPESCN10  CALL      RKWTESN5
          BRANCH    OVRCD,UPESCN90
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      UPESCN90 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP
          GOTO      UPESCN90 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      UPESCN10 IF NOT EQUAL
.
          PACK      SAVEVDT,WTENEVDT
          PACK      WTENEVDT,CCC,CYY,CMM,CDD
          REP       " 0",WTENEVDT
.
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          MOVE      OPDACANC,WTENEVAL
          MATCH     SAVEVDT,WTENEVDT
          IF        !@EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
            CALL      RAWTESN1
            IF        OVRCD=1
              CALL      UPWTESN5
            ENDIF
          ELSE
            CALL      UPWTESN5
          ENDIF
          GOTO      UPESCN99
.
.*** check for a set SAD that HAS been sent and update with new SAD ***
.
UPESCN90  PACK      KEY36,WTWMECNT,ANSP,OPDAUNIQ,SP70
          CALL      RSWTESN5
UPESCN95  CALL      RKWTESN5
          BRANCH    OVRCD,UPESCN99
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      UPESCN99 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP
          GOTO      UPESCN99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      UPESCN95 IF EQUAL
.
          MOVE      DELESN,WTENEVAL
          MOVE      SP70,WTENEDAT

          PACK      WTENWEBC,USERID
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
          MOVE      OPDACANC,WTENEVAL
          MOVE      SP70,WTENEDAT
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD
          REP       " 0",WTENEVDT
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
UPESCN99  RETURN
+
.******************************************************************************
.*                                  ERVV0000                                  *
.*  Update eReferral visit number                                             *
.******************************************************************************
ERVV0000  MATCH     "1",PTCNEPIS
          GOTO      ERVV9999 IF NOT EQUAL
.
          OPEN      COMERHA3,"comerhaf"
.
          PACK      KEY38,WMURNO,SP70
          CALL      RSCMERH3
ERVV1000  CALL      RKCMERH3
          BRANCH    OVRCD,ERVV9990
.
          MATCH     WMURNO,CMRHURNO
          GOTO      ERVV9990 IF NOT EQUAL
.
          MATCH     WMCODE,CMRHPCOD
          GOTO      ERVV1000 IF NOT EQUAL
.
          MOVE      WMCNT,D2
          MATCH     D2,CMRHPCNT
          GOTO      ERVV1000 IF NOT EQUAL
.
          MOVE      WMBOOK,CMRHVISN
.
          CALL      UPCMERH3
.
ERVV9990  CLOSE     COMERHA3
.
ERVV9999  RETURN

